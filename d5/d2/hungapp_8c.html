<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: hungapp.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>hungapp.c File Reference</h1><code>#include "<a class="el" href="../../d1/d3/w32_2ntuser_2kernel_2precomp_8h-source.html">precomp.h</a>"</code><br>

<p>
<a href="../../d6/d1/hungapp_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d2/hungapp_8c.html#a0">CHRLINCR</a>&nbsp;&nbsp;&nbsp;10</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d2/hungapp_8c.html#a1">SetHungFlag</a> (<a class="el" href="../../d6/d9/structtagWND.html">PWND</a> pwnd, WORD wFlag)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d2/hungapp_8c.html#a2">ClearHungFlag</a> (<a class="el" href="../../d6/d9/structtagWND.html">PWND</a> pwnd, WORD wFlag)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d2/hungapp_8c.html#a3">FHungApp</a> (<a class="el" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti, <a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwTimeFromLastRead)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d2/hungapp_8c.html#a4">xxxRedrawHungWindowFrame</a> (<a class="el" href="../../d6/d9/structtagWND.html">PWND</a> pwnd, BOOL fActive)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d2/hungapp_8c.html#a5">xxxRedrawHungWindow</a> (<a class="el" href="../../d6/d9/structtagWND.html">PWND</a> pwnd, HRGN hrgnFullDrag)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d2/hungapp_8c.html#a6">xxxHungAppDemon</a> (<a class="el" href="../../d6/d9/structtagWND.html">PWND</a> pwnd, UINT message, UINT_PTR nID, LPARAM lParam)</td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a0" doxytag="hungapp.c::CHRLINCR" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CHRLINCR&nbsp;&nbsp;&nbsp;10          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d1/hungapp_8c-source.html#l00024">24</a> of file <a class="el" href="../../d6/d1/hungapp_8c-source.html">hungapp.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d1/hungapp_8c-source.html#l00026">SetHungFlag()</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a2" doxytag="hungapp.c::ClearHungFlag" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID ClearHungFlag           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d6/d9/structtagWND.html">PWND</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pwnd</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>WORD&nbsp;</td>
          <td class="mdname" nowrap> <em>wFlag</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d1/hungapp_8c-source.html#l00057">57</a> of file <a class="el" href="../../d6/d1/hungapp_8c-source.html">hungapp.c</a>.
<p>
References <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02557">ClrWF</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00477">gpvwplHungRedraw</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02555">TestWF</a>, <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>, <a class="el" href="../../d5/d4/rare_8c-source.html#l04002">VWPLRemove()</a>, and <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02300">WFANYHUNGREDRAW</a>.
<p>
Referenced by <a class="el" href="../../d9/d8/update_8c-source.html#l00784">InternalInvalidate3()</a>, <a class="el" href="../../d0/d2/paint_8c-source.html#l00310">xxxBeginPaint()</a>, <a class="el" href="../../d2/d4/caption_8c-source.html#l00986">xxxDrawCaptionBar()</a>, <a class="el" href="../../d5/d7/createw_8c-source.html#l02218">xxxFreeWindow()</a>, <a class="el" href="../../d6/d1/hungapp_8c-source.html#l00446">xxxHungAppDemon()</a>, <a class="el" href="../../d6/d1/hungapp_8c-source.html#l00135">xxxRedrawHungWindow()</a>, and <a class="el" href="../../d0/d2/paint_8c-source.html#l00740">xxxSimpleDoSyncPaint()</a>.
<p>
<pre class="fragment"><div>00060 {
00061     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fInRedrawList = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, WFANYHUNGREDRAW);
00062 
00063     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a733">ClrWF</a>(pwnd, wFlag);
00064     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, WFANYHUNGREDRAW) &amp;&amp; fInRedrawList) {
00065         <span class="comment">/*</span>
00066 <span class="comment">         * Remove the window from the redraw list and possibly compact it.</span>
00067 <span class="comment">         */</span>
00068         <a class="code" href="../../d4/d1/userk_8h.html#a1871">VWPLRemove</a>(&amp;gpvwplHungRedraw, pwnd);
00069     }
00070 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="hungapp.c::FHungApp" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOL FHungApp           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pti</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>dwTimeFromLastRead</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d1/hungapp_8c-source.html#l00080">80</a> of file <a class="el" href="../../d6/d1/hungapp_8c-source.html">hungapp.c</a>.
<p>
References <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l03043">tagCLIENTTHREADINFO::fsWakeMask</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02348">GET_TIME_LAST_READ</a>, <a class="el" href="../../d0/d5/gettickc_8c-source.html#l00026">NtGetTickCount()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03325">tagTHREADINFO::pcti</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03319">tagTHREADINFO::ppi</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d6/d2/ntuser_2kernel_2input_8c-source.html#l05120">IdleTimerProc()</a>, <a class="el" href="../../d2/d1/hooks_8c-source.html#l00339">InterQueueMsgCleanup()</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l09643">NtUserQueryWindow()</a>, <a class="el" href="../../d7/d7/ntinput_8c-source.html#l00472">xxxButtonEvent()</a>, <a class="el" href="../../d2/d1/hooks_8c-source.html#l01288">xxxCallHook2()</a>, <a class="el" href="../../d0/d6/desktop_8c-source.html#l00114">xxxDesktopThread()</a>, <a class="el" href="../../d0/d6/desktop_8c-source.html#l00883">xxxDesktopWndProc()</a>, <a class="el" href="../../d6/d1/hungapp_8c-source.html#l00446">xxxHungAppDemon()</a>, <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l01296">xxxInterSendMsgEx()</a>, <a class="el" href="../../d7/d2/queue_8c-source.html#l05901">xxxQueryInformationThread()</a>, <a class="el" href="../../d6/d1/hungapp_8c-source.html#l00135">xxxRedrawHungWindow()</a>, <a class="el" href="../../d4/d5/kernel_2sendmsg_8c-source.html#l00764">xxxSendMessageTimeout()</a>, <a class="el" href="../../d4/d5/focusact_8c-source.html#l01342">xxxSetForegroundWindow2()</a>, and <a class="el" href="../../d0/d2/paint_8c-source.html#l00740">xxxSimpleDoSyncPaint()</a>.
<p>
<pre class="fragment"><div>00083 {
00084 
00085     <span class="comment">/*</span>
00086 <span class="comment">     * An app is considered hung if it isn't waiting for input, isn't in</span>
00087 <span class="comment">     * startup processing, and hasn't called PeekMessage() within the</span>
00088 <span class="comment">     * specified timeout.</span>
00089 <span class="comment">     */</span>
00090     <span class="keywordflow">if</span> (((<a class="code" href="../../d9/d5/gettickc_8c.html#a0">NtGetTickCount</a>() - <a class="code" href="../../d4/d1/userk_8h.html#a258">GET_TIME_LAST_READ</a>(pti)) &gt; dwTimeFromLastRead) &amp;&amp;
00091             !((pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o5">pcti</a>-&gt;<a class="code" href="../../d4/d0/structtagCLIENTTHREADINFO.html#o4">fsWakeMask</a> &amp; QS_INPUT) &amp;&amp; (pti-&gt;pEThread-&gt;Tcb.FreezeCount == 0)) &amp;&amp;
00092             !(pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>-&gt;W32PF_Flags &amp; W32PF_APPSTARTING)) {
00093         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00094     }
00095 
00096     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00097 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="hungapp.c::SetHungFlag" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID SetHungFlag           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d6/d9/structtagWND.html">PWND</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pwnd</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>WORD&nbsp;</td>
          <td class="mdname" nowrap> <em>wFlag</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d1/hungapp_8c-source.html#l00026">26</a> of file <a class="el" href="../../d6/d1/hungapp_8c-source.html">hungapp.c</a>.
<p>
References <a class="el" href="../../d6/d1/hungapp_8c-source.html#l00024">CHRLINCR</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00477">gpvwplHungRedraw</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02790">PWNDDESKTOP</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02556">SetWF</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01745">tagWND::spwndParent</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02555">TestWF</a>, <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>, <a class="el" href="../../d5/d4/rare_8c-source.html#l03916">VWPLAdd()</a>, and <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02300">WFANYHUNGREDRAW</a>.
<p>
Referenced by <a class="el" href="../../d9/d8/update_8c-source.html#l00784">InternalInvalidate3()</a>, and <a class="el" href="../../d4/d5/focusact_8c-source.html#l01342">xxxSetForegroundWindow2()</a>.
<p>
<pre class="fragment"><div>00029 {
00030     <span class="comment">/*</span>
00031 <span class="comment">     * If the window has no hung redraw bits set and it's a top-level</span>
00032 <span class="comment">     * window, add it to the redraw list.</span>
00033 <span class="comment">     */</span>
00034     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, WFANYHUNGREDRAW) &amp;&amp; pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o3">spwndParent</a> == <a class="code" href="../../d4/d1/userk_8h.html#a322">PWNDDESKTOP</a>(pwnd)) {
00035         <span class="comment">/*</span>
00036 <span class="comment">         * Add pwnd to the Hung Redraw Volatile Window Pointer List.</span>
00037 <span class="comment">         */</span>
00038         <a class="code" href="../../d4/d1/userk_8h.html#a1870">VWPLAdd</a>(&amp;gpvwplHungRedraw, pwnd, CHRLINCR);
00039     }
00040 
00041     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a732">SetWF</a>(pwnd, wFlag);
00042 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="hungapp.c::xxxHungAppDemon" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID xxxHungAppDemon           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d6/d9/structtagWND.html">PWND</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pwnd</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>UINT&nbsp;</td>
          <td class="mdname" nowrap> <em>message</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>UINT_PTR&nbsp;</td>
          <td class="mdname" nowrap> <em>nID</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>LPARAM&nbsp;</td>
          <td class="mdname" nowrap> <em>lParam</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d1/hungapp_8c-source.html#l00446">446</a> of file <a class="el" href="../../d6/d1/hungapp_8c-source.html">hungapp.c</a>.
<p>
References <a class="el" href="../../d7/d9/usercli_8h-source.html#l00361">CheckLock</a>, <a class="el" href="../../d6/d1/hungapp_8c-source.html#l00057">ClearHungFlag()</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l03506">CMSHUNGAPPTIMEOUT</a>, <a class="el" href="../../d1/d4/perfuser_8c-source.html#l00052">DWORD</a>, <a class="el" href="../../d6/d1/hungapp_8c-source.html#l00080">FHungApp()</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01547">GETPTI</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00477">gpvwplHungRedraw</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00456">grpdeskRitInput</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00194">gtimeStartCursorHide</a>, <a class="el" href="../../d6/d2/ntuser_2kernel_2input_8c-source.html#l05120">IdleTimerProc()</a>, <a class="el" href="../../d0/d5/gettickc_8c-source.html#l00026">NtGetTickCount()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02644">tagDESKTOP::pDeskInfo</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02156">tagDESKTOPINFO::spwnd</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02555">TestWF</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02571">TestwndFrameOn</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00362">ThreadLock</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00366">ThreadUnlock</a>, <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>, <a class="el" href="../../d5/d4/rare_8c-source.html#l04083">VWPLNext()</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02299">WFREDRAWFRAMEIFHUNG</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02298">WFREDRAWIFHUNG</a>, <a class="el" href="../../d6/d1/hungapp_8c-source.html#l00135">xxxRedrawHungWindow()</a>, <a class="el" href="../../d6/d1/hungapp_8c-source.html#l00107">xxxRedrawHungWindowFrame()</a>, and <a class="el" href="../../d7/d2/queue_8c-source.html#l00591">zzzCalcStartCursorHide()</a>.
<p>
Referenced by <a class="el" href="../../d5/d1/timers_8c-source.html#l00722">StartTimers()</a>.
<p>
<pre class="fragment"><div>00451 {
00452     <a class="code" href="../../d5/d1/struct__TL.html">TL</a>      tlpwnd;
00453 <span class="preprocessor">#if DBG</span>
00454 <span class="preprocessor"></span>    <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>    pwndT;
00455 <span class="preprocessor">#endif</span>
00456 <span class="preprocessor"></span>    <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> nPwndHungRedraw;
00457     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>  pwndHungRedraw;
00458 
00459 
00460 
00461     UNREFERENCED_PARAMETER(message);
00462     UNREFERENCED_PARAMETER(nID);
00463 
00464     UNREFERENCED_PARAMETER(lParam);
00465     UNREFERENCED_PARAMETER(pwnd);
00466     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwnd);
00467 
00468     <span class="comment">/*</span>
00469 <span class="comment">     * See if we should start the screen saver.</span>
00470 <span class="comment">     */</span>
00471     <a class="code" href="../../d4/d1/userk_8h.html#a1635">IdleTimerProc</a>();
00472 
00473     <span class="comment">/*</span>
00474 <span class="comment">     * If it is time to hide the app starting cursor, do it.</span>
00475 <span class="comment">     */</span>
00476     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d5/gettickc_8c.html#a0">NtGetTickCount</a>() &gt;= <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a74">gtimeStartCursorHide</a>) {
00477         <span class="comment">/*</span>
00478 <span class="comment">         * No need to DeferWinEventNotify()</span>
00479 <span class="comment">         */</span>
00480         <a class="code" href="../../d4/d1/userk_8h.html#a1490">zzzCalcStartCursorHide</a>(NULL, 0);
00481     }
00482 
00483     <span class="comment">/*</span>
00484 <span class="comment">     * Now check to see if there are any top-level</span>
00485 <span class="comment">     * windows that need redrawing.</span>
00486 <span class="comment">     */</span>
00487     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a176">grpdeskRitInput</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o2">spwnd</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00488         <span class="keywordflow">return</span>;
00489 
00490     <span class="comment">/*</span>
00491 <span class="comment">     * Walk down the list of redraw-if-hung windows.  Loop</span>
00492 <span class="comment">     * until we hit the end of the array or find a NULL.</span>
00493 <span class="comment">     */</span>
00494     nPwndHungRedraw = 0;
00495     pwndHungRedraw = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00496     <span class="keywordflow">while</span> (pwndHungRedraw = <a class="code" href="../../d4/d1/userk_8h.html#a1872">VWPLNext</a>(gpvwplHungRedraw, pwndHungRedraw, &amp;nPwndHungRedraw)) {
00497         <span class="comment">/*</span>
00498 <span class="comment">         * See if the app is hung.  If so, do the appropriate</span>
00499 <span class="comment">         * redrawing.</span>
00500 <span class="comment">         */</span>
00501         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1650">FHungApp</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwndHungRedraw), CMSHUNGAPPTIMEOUT)) {
00502             <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(pwndHungRedraw, &amp;tlpwnd);
00503             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndHungRedraw, WFREDRAWFRAMEIFHUNG)) {
00504 
00505                 <span class="comment">/*</span>
00506 <span class="comment">                 * WFREDRAWFRAMEIFHUNG will be cleared in the process</span>
00507 <span class="comment">                 * of drawing the frame, no need to clear it here.</span>
00508 <span class="comment">                 */</span>
00509                 <a class="code" href="../../d4/d1/userk_8h.html#a1652">xxxRedrawHungWindowFrame</a>(pwndHungRedraw, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a743">TestwndFrameOn</a>(pwndHungRedraw));
00510             }
00511 
00512             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndHungRedraw, WFREDRAWIFHUNG)) {
00513                 <a class="code" href="../../d4/d1/userk_8h.html#a1126">ClearHungFlag</a>(pwndHungRedraw, WFREDRAWIFHUNG);
00514                 <a class="code" href="../../d4/d1/userk_8h.html#a1651">xxxRedrawHungWindow</a>(pwndHungRedraw, NULL);
00515             }
00516 <span class="preprocessor">            #if DBG</span>
00517 <span class="preprocessor"></span>                pwndT =
00518 <span class="preprocessor">            #endif</span>
00519 <span class="preprocessor"></span>
00520             <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwnd);
00521         }
00522     }
00523 
00524     <span class="keywordflow">return</span>;
00525 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="hungapp.c::xxxRedrawHungWindow" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID xxxRedrawHungWindow           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d6/d9/structtagWND.html">PWND</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pwnd</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>HRGN&nbsp;</td>
          <td class="mdname" nowrap> <em>hrgnFullDrag</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d1/hungapp_8c-source.html#l00135">135</a> of file <a class="el" href="../../d6/d1/hungapp_8c-source.html">hungapp.c</a>.
<p>
References <a class="el" href="../../d9/d2/dc_8c-source.html#l00608">_GetDCEx()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l05797">_GetWindowLong</a>, <a class="el" href="../../d9/d2/dc_8c-source.html#l00183">_ReleaseDC()</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l01738">tagCLS::atomClassName</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l01838">BEGINATOMICCHECK</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l01833">CheckCritIn</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00361">CheckLock</a>, <a class="el" href="../../d6/d1/hungapp_8c-source.html#l00057">ClearHungFlag()</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l03506">CMSHUNGAPPTIMEOUT</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l00243">CopyRect</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02217">CopyRgn</a>, <a class="el" href="../../d4/d5/visrgn_8c-source.html#l00057">CreateEmptyRgn()</a>, <a class="el" href="../../d1/d4/perfuser_8c-source.html#l00052">DWORD</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l01842">ENDATOMICCHECK</a>, <a class="el" href="../../d6/d1/hungapp_8c-source.html#l00080">FHungApp()</a>, <a class="el" href="../../d0/d1/rtl_2draw_8c-source.html#l00061">FillRect()</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00767">gatomConsoleClass</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l00092">GetCurrentProcessId</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01547">GETPTI</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00296">ghbrHungApp</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00491">ghrgnInv2</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l01827">tagWND::head</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l03064">HRGN_FULL</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01757">tagWND::hrgnUpdate</a>, <a class="el" href="../../d4/d5/rect_8c-source.html#l00191">IntersectRect()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02219">IntersectRgn</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d4/d5/rect_8c-source.html#l00139">OffsetRect()</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l01843">tagWND::pcls</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l02790">PWNDDESKTOP</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l01838">tagWND::rcWindow</a>, <a class="el" href="../../d4/d5/visrgn_8c-source.html#l00040">SetRectRgnIndirect()</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02556">SetWF</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01746">tagWND::spwndChild</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01744">tagWND::spwndNext</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l00212">SYSHBR</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l00236">SYSHBRUSH</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02555">TestWF</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02571">TestwndFrameOn</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00362">ThreadLock</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l01342">ThreadLockExchangeAlways()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l01247">ThreadLockNever</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00366">ThreadUnlock</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d0/d5/ndismain_8h-source.html#l00026">UINT</a>, <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02416">WFCLIPCHILDREN</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02417">WFCLIPSIBLINGS</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02304">WFDESTROYED</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02282">WFDIALOGWINDOW</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02298">WFREDRAWIFHUNG</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02270">WFSENDERASEBKGND</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02272">WFSENDNCPAINT</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02307">WFSTARTPAINT</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02274">WFUPDATEDIRTY</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02419">WFVISIBLE</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02319">WFWIN40COMPAT</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l02070">WINDOW</a>, <a class="el" href="../../d0/d2/calcclrc_8c-source.html#l00021">xxxCalcClientRect()</a>, <a class="el" href="../../d2/d1/drawfrm_8c-source.html#l00076">xxxDrawWindowFrame()</a>, <a class="el" href="../../d9/d8/update_8c-source.html#l01302">xxxInternalInvalidate()</a>, and <a class="el" href="../../d2/d2/dtbitmap_8c-source.html#l01615">xxxInternalPaintDesktop()</a>.
<p>
Referenced by <a class="el" href="../../d6/d1/hungapp_8c-source.html#l00446">xxxHungAppDemon()</a>, <a class="el" href="../../d0/d2/paint_8c-source.html#l00740">xxxSimpleDoSyncPaint()</a>, and <a class="el" href="../../d9/d2/movesize_8c-source.html#l01485">xxxUpdateOtherThreadsWindows()</a>.
<p>
<pre class="fragment"><div>00138 {
00139     HDC     hdc;
00140     HBRUSH  hbr;
00141     HRGN    hrgnUpdate;
00142     RECT    rc;
00143     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwnd; <span class="comment">// should remove (IanJa)</span>
00144     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>    flags;
00145     W32PID  sid;
00146     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>   dwColor;
00147     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>    pwndDesk;
00148     <a class="code" href="../../d5/d1/struct__TL.html">TL</a>      tlpwndDesk;
00149 
00150     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
00151     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwnd);
00152 
00153     <span class="keywordflow">if</span> (pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o11">hrgnUpdate</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00154         <span class="keywordflow">return</span>;
00155     }
00156 
00157 <span class="preprocessor">#ifdef HUNGAPP_GHOSTING</span>
00158 <span class="preprocessor"></span>
00159     <span class="comment">/*</span>
00160 <span class="comment">     * Don't bother doing anything here when the window isn't even visible.</span>
00161 <span class="comment">     */</span>
00162     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, WFVISIBLE)) {
00163         <span class="keywordflow">return</span>;
00164     }
00165 
00166     <span class="comment">/*</span>
00167 <span class="comment">     * This function can be called from the full-drag code to quick redraw</span>
00168 <span class="comment">     * windows that aren't hung. In that case check if that thread is hung.</span>
00169 <span class="comment">     */</span>
00170     <span class="keywordflow">if</span> ((hrgnFullDrag == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) || (hrgnFullDrag != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp;
00171             <a class="code" href="../../d4/d1/userk_8h.html#a1650">FHungApp</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd), CMSHUNGAPPTIMEOUT))) {
00172         SignalGhost(pwnd);
00173     }
00174 
00175 <span class="preprocessor">#endif // HUNGAPP_GHOSTING</span>
00176 <span class="preprocessor"></span>
00177     <span class="comment">/*</span>
00178 <span class="comment">     * First calculate hrgnUpdate.</span>
00179 <span class="comment">     */</span>
00180     <span class="keywordflow">if</span> (pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o11">hrgnUpdate</a> &gt; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a877">HRGN_FULL</a>) {
00181         hrgnUpdate = <a class="code" href="../../d4/d1/userk_8h.html#a1162">CreateEmptyRgn</a>();
00182         <span class="keywordflow">if</span> (hrgnUpdate == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00183             hrgnUpdate = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a877">HRGN_FULL</a>;
00184 
00185         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a227">CopyRgn</a>(hrgnUpdate, pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o11">hrgnUpdate</a>) == ERROR) {
00186             GreDeleteObject(hrgnUpdate);
00187             hrgnUpdate = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a877">HRGN_FULL</a>;
00188         }
00189 
00190     } <span class="keywordflow">else</span> {
00191 
00192         <span class="comment">/*</span>
00193 <span class="comment">         * For our purposes, we need a real hrgnUpdate, so try and</span>
00194 <span class="comment">         * create one if even if the entire window needs updating.</span>
00195 <span class="comment">         */</span>
00196         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a33">CopyRect</a>(&amp;rc, &amp;pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>);
00197         hrgnUpdate = GreCreateRectRgnIndirect(&amp;rc);
00198         <span class="keywordflow">if</span> (hrgnUpdate == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00199             hrgnUpdate = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a877">HRGN_FULL</a>;
00200         }
00201     }
00202 
00203     <span class="comment">/*</span>
00204 <span class="comment">     * If we're redrawing because we're full dragging and if the window's</span>
00205 <span class="comment">     * update region does not intersect with the Full drag</span>
00206 <span class="comment">     * update region, don't erase the hung window again. This is to prevent</span>
00207 <span class="comment">     * flickering when a window has been invalidated by another window doing</span>
00208 <span class="comment">     * full drag and hasn't received the paint message yet.</span>
00209 <span class="comment">     * This way, only if there is a new region that has been invalidated will</span>
00210 <span class="comment">     * we redraw the hung window.</span>
00211 <span class="comment">     */</span>
00212     <span class="keywordflow">if</span> (hrgnFullDrag &amp;&amp; hrgnUpdate != <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a877">HRGN_FULL</a> &amp;&amp;
00213             <a class="code" href="../../d4/d1/userk_8h.html#a228">IntersectRgn</a>(hrgnUpdate, hrgnUpdate, hrgnFullDrag) == NULLREGION) {
00214         GreDeleteObject(hrgnUpdate);
00215         <span class="keywordflow">return</span>;
00216     }
00217 
00218     <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(pwnd, &amp;tlpwnd); <span class="comment">// should remove (IanJa)</span>
00219 
00220     hdc = <a class="code" href="../../d4/d1/userk_8h.html#a1695">_GetDCEx</a>(pwnd, hrgnUpdate, DCX_USESTYLE | DCX_WINDOW |
00221             DCX_INTERSECTRGN | DCX_NODELETERGN | DCX_LOCKWINDOWUPDATE);
00222     <a class="code" href="../../d4/d1/userk_8h.html#a1443">xxxDrawWindowFrame</a>(pwnd, hdc, TRUE, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a743">TestwndFrameOn</a>(pwnd));
00223     <a class="code" href="../../d4/d1/userk_8h.html#a1697">_ReleaseDC</a>(hdc);
00224 
00225     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a33">CopyRect</a>(&amp;rc, &amp;pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>);
00226     <a class="code" href="../../d4/d1/userk_8h.html#a1531">xxxCalcClientRect</a>(pwnd, &amp;rc, TRUE);
00227     <a class="code" href="../../d3/d6/visrgn_8c.html#a9">SetRectRgnIndirect</a>(ghrgnInv2, &amp;rc);
00228 
00229     <span class="keywordflow">if</span> (hrgnUpdate &gt; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a877">HRGN_FULL</a>) {
00230         <span class="keywordflow">switch</span> (<a class="code" href="../../d4/d1/userk_8h.html#a228">IntersectRgn</a>(hrgnUpdate, hrgnUpdate, ghrgnInv2)) {
00231 
00232         <span class="keywordflow">case</span> ERROR:
00233             GreDeleteObject(hrgnUpdate);
00234             hrgnUpdate = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a877">HRGN_FULL</a>;
00235             <span class="keywordflow">break</span>;
00236 
00237         <span class="keywordflow">case</span> NULLREGION:
00238             <span class="comment">/*</span>
00239 <span class="comment">             * There is nothing in the client area to repaint.</span>
00240 <span class="comment">             * Blow the region away, and decrement the paint count</span>
00241 <span class="comment">             * if possible.</span>
00242 <span class="comment">             */</span>
00243             GreDeleteObject(hrgnUpdate);
00244             hrgnUpdate = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00245             <span class="keywordflow">break</span>;
00246         }
00247     }
00248 
00249     <span class="comment">/*</span>
00250 <span class="comment">     * Erase the rest of the window.</span>
00251 <span class="comment">     * When pwnd isn't WFCLIPCHILDREN, make sure valid children bits</span>
00252 <span class="comment">     * don't get overwritten if the child is in the middle of BeginPaint</span>
00253 <span class="comment">     * or just completed it's painting and it's hrgnUpdate is NULL.</span>
00254 <span class="comment">     */</span>
00255     <span class="keywordflow">if</span> (hrgnUpdate != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, WFCLIPCHILDREN)) {
00256         RECT rcT;
00257         <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndT;
00258 
00259         <span class="keywordflow">if</span> (hrgnUpdate == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a877">HRGN_FULL</a>) {
00260             rc = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>;
00261         } <span class="keywordflow">else</span> {
00262             GreGetRgnBox(hrgnUpdate, &amp;rc);
00263         }
00264 
00265         <span class="keywordflow">for</span> (pwndT = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o4">spwndChild</a>; pwndT != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00266                 pwndT = pwndT-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o2">spwndNext</a>) {
00267 
00268             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndT, WFVISIBLE) &amp;&amp;
00269                     (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndT, WFSTARTPAINT) || pwndT-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o11">hrgnUpdate</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
00270                     <a class="code" href="../../d3/d6/rect_8c.html#a8">IntersectRect</a>(&amp;rcT, &amp;rc, &amp;pwndT-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>)) {
00271 
00272                 <span class="comment">/*</span>
00273 <span class="comment">                 * This invalidate call won't leave the critial section. In</span>
00274 <span class="comment">                 * reality the entire xxxRedrawHungWindow must not leave</span>
00275 <span class="comment">                 * the critical section.</span>
00276 <span class="comment">                 */</span>
00277                 <a class="code" href="../../d4/d1/userk_8h.html#a159">BEGINATOMICCHECK</a>();
00278                 <a class="code" href="../../d4/d1/userk_8h.html#a1681">xxxInternalInvalidate</a>(pwndT, hrgnUpdate, RDW_INVALIDATE |
00279                         RDW_FRAME | RDW_ERASE | RDW_ALLCHILDREN);
00280                 <a class="code" href="../../d4/d1/userk_8h.html#a163">ENDATOMICCHECK</a>();
00281             }
00282         }
00283     }
00284 
00285     <span class="comment">/*</span>
00286 <span class="comment">     * Get a window dc so that the menu and scroll bar areas are erased</span>
00287 <span class="comment">     * appropriately. But make sure it is clipped so that the children</span>
00288 <span class="comment">     * get clipped out correctly! If we don't do this, this we could erase</span>
00289 <span class="comment">     * children that aren't invalid.</span>
00290 <span class="comment">     *</span>
00291 <span class="comment">     * Note: DCX_WINDOW and DCX_USESTYLE will never clip out children.</span>
00292 <span class="comment">     * Need to pass the clipping styles in directly, instead of passing</span>
00293 <span class="comment">     * DCX_USESTYLE.</span>
00294 <span class="comment">     */</span>
00295     flags = DCX_INTERSECTRGN | DCX_WINDOW | DCX_CACHE;
00296     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, WFCLIPSIBLINGS))
00297         flags |= DCX_CLIPSIBLINGS;
00298     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, WFCLIPCHILDREN))
00299         flags |= DCX_CLIPCHILDREN;
00300 
00301     hdc = <a class="code" href="../../d4/d1/userk_8h.html#a1695">_GetDCEx</a>(pwnd, hrgnUpdate, flags);
00302 
00303     <span class="keywordflow">if</span> (pwnd == pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o0">head</a>.rpdesk-&gt;pDeskInfo-&gt;spwndBkGnd) {
00304         pwndDesk = <a class="code" href="../../d4/d1/userk_8h.html#a322">PWNDDESKTOP</a>(pwnd);
00305         <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(pwndDesk, &amp;tlpwndDesk);
00306         <a class="code" href="../../d4/d1/userk_8h.html#a1444">xxxInternalPaintDesktop</a>(<a class="code" href="../../d4/d1/userk_8h.html#a322">PWNDDESKTOP</a>(pwnd), hdc, TRUE);
00307         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndDesk);
00308 
00309     } <span class="keywordflow">else</span> {
00310 
00311          rc = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>;
00312 
00313          <a class="code" href="../../d3/d6/rect_8c.html#a6">OffsetRect</a>(&amp;rc, -pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.left, -pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.top);
00314 
00315          <span class="comment">/*</span>
00316 <span class="comment">          * Erase the rest of the window using the window' class background</span>
00317 <span class="comment">          * brush.</span>
00318 <span class="comment">          */</span>
00319          <span class="keywordflow">if</span> ((hbr = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o9">pcls</a>-&gt;hbrBackground) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00320              <span class="keywordflow">if</span> (hbr &lt;= (HBRUSH)COLOR_ENDCOLORS + 1)
00321                  hbr = <a class="code" href="../../d1/d0/inc_2user_8h.html#a15">SYSHBRUSH</a>((ULONG_PTR)hbr - 1);
00322          } <span class="keywordflow">else</span> {
00323              <span class="comment">/*</span>
00324 <span class="comment">              * Use the window brush for windows and 3.x dialogs,</span>
00325 <span class="comment">              * Use the COLOR3D brush for 4.x dialogs.</span>
00326 <span class="comment">              */</span>
00327              <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, WFDIALOGWINDOW) &amp;&amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, WFWIN40COMPAT))
00328                  hbr = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a22">SYSHBR</a>(3DFACE);
00329              <span class="keywordflow">else</span>
00330                  hbr = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a22">SYSHBR</a>(WINDOW);
00331          }
00332 
00333         <span class="comment">/*</span>
00334 <span class="comment">         * If the window's class background brush is public, use it.</span>
00335 <span class="comment">         */</span>
00336         sid = (W32PID)GreGetObjectOwner((HOBJ)hbr, BRUSH_TYPE);
00337         <span class="keywordflow">if</span> (sid == (W32PID)(ULONG_PTR)<a class="code" href="../../d4/d1/userk_8h.html#a19">GetCurrentProcessId</a>() || sid == OBJECT_OWNER_PUBLIC) {
00338 
00339             <a class="code" href="../../d9/d1/rtl_2draw_8c.html#a3">FillRect</a>(hdc, &amp;rc, hbr);
00340 
00341         } <span class="keywordflow">else</span> {
00342 
00343             <span class="comment">/*</span>
00344 <span class="comment">             * The window's class background brush is not public.</span>
00345 <span class="comment">             * We get its color and set the color of our own public brush and use</span>
00346 <span class="comment">             * that for the background brush.</span>
00347 <span class="comment">             */</span>
00348 
00349             <span class="comment">/*</span>
00350 <span class="comment">             * If the window is a console window, get the console background brush.</span>
00351 <span class="comment">             * This brush will be different than the console class brush if the user</span>
00352 <span class="comment">             * changed the console background color.</span>
00353 <span class="comment">             */</span>
00354             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a281">gatomConsoleClass</a> == pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o9">pcls</a>-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o1">atomClassName</a>) {
00355 
00356                 dwColor = <a class="code" href="../../d4/d1/userk_8h.html#a589">_GetWindowLong</a>(pwnd, GWL_CONSOLE_BKCOLOR);
00357 
00358             } <span class="keywordflow">else</span> {
00359 
00360                 <span class="keywordflow">if</span> ((dwColor = GreGetBrushColor(hbr)) == -1)
00361                     dwColor = GreGetBrushColor(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a22">SYSHBR</a>(WINDOW));
00362             }
00363 
00364             GreSetSolidBrush(ghbrHungApp, dwColor);
00365 
00366             <a class="code" href="../../d9/d1/rtl_2draw_8c.html#a3">FillRect</a>(hdc, &amp;rc, ghbrHungApp);
00367         }
00368     }
00369     <a class="code" href="../../d4/d1/userk_8h.html#a1697">_ReleaseDC</a>(hdc);
00370 
00371     <span class="comment">/*</span>
00372 <span class="comment">     * The window has been erased and framed. It only did this because the</span>
00373 <span class="comment">     * app hasn't done it yet:</span>
00374 <span class="comment">     *</span>
00375 <span class="comment">     * - the app hasn't erased and frame yet.</span>
00376 <span class="comment">     * - the app is in the middle of erasing and framing.</span>
00377 <span class="comment">     *</span>
00378 <span class="comment">     * The app could not of completed erasing and framing, because the</span>
00379 <span class="comment">     * WFREDRAWIFHUNG bit is cleared when this successfully completes.</span>
00380 <span class="comment">     *</span>
00381 <span class="comment">     * Given that the app may be in the middle of erasing and framing, we</span>
00382 <span class="comment">     * need to set both the erase and frame bits *again* so it erasing and</span>
00383 <span class="comment">     * frames over again (if we don't, it never will). If the app hasn't</span>
00384 <span class="comment">     * done any erasing/framing yet, this is a nop.</span>
00385 <span class="comment">     */</span>
00386     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a732">SetWF</a>(pwnd, WFSENDNCPAINT);
00387     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a732">SetWF</a>(pwnd, WFSENDERASEBKGND);
00388 
00389     <span class="comment">/*</span>
00390 <span class="comment">     * Always set WFUPDATEDIRTY: we don't want the app to draw, then stop</span>
00391 <span class="comment">     * and have the hung app thread draw, and then allow the app to validate</span>
00392 <span class="comment">     * itself: Mark the update region dirty - cannot be validated until the</span>
00393 <span class="comment">     * app calls a painting function and acknowledges the update region.</span>
00394 <span class="comment">     */</span>
00395     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a732">SetWF</a>(pwnd, WFUPDATEDIRTY);
00396 
00397 <span class="preprocessor">#ifdef WIN95DOESTHIS</span>
00398 <span class="preprocessor"></span>    <span class="comment">/*</span>
00399 <span class="comment">     * Go through all the children and redraw hung ones too.</span>
00400 <span class="comment">     */</span>
00401     <span class="keywordflow">if</span> (hrgnFullDrag != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00402         <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>    pwndT;
00403         <a class="code" href="../../d5/d1/struct__TL.html">TL</a>      tlpwndT;
00404 
00405         pwndT = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o4">spwndChild</a>;
00406         <a class="code" href="../../d4/d1/userk_8h.html#a115">ThreadLockNever</a>(&amp;tlpwndT);
00407         <span class="keywordflow">while</span> (pwndT) {
00408 
00409             <span class="keywordflow">if</span> (    <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndT, WFREDRAWIFHUNG) &amp;&amp;
00410                     <a class="code" href="../../d4/d1/userk_8h.html#a1650">FHungApp</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwndT), CMSHUNGAPPTIMEOUT)) {
00411 
00412                 <a class="code" href="../../d4/d1/userk_8h.html#a1126">ClearHungFlag</a>(pwndT, WFREDRAWIFHUNG);
00413                 <a class="code" href="../../d4/d1/userk_8h.html#a983">ThreadLockExchangeAlways</a>(pwndT, &amp;tlpwndT);
00414                 <a class="code" href="../../d4/d1/userk_8h.html#a1651">xxxRedrawHungWindow</a>(pwndT, NULL);
00415             }
00416 
00417             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndT, WFDESTROYED)) {
00418                 <span class="keywordflow">break</span>;
00419             }
00420 
00421             pwndT = pwndT-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o2">spwndNext</a>;
00422         }
00423 
00424         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwndT);
00425     }
00426 <span class="preprocessor">#endif</span>
00427 <span class="preprocessor"></span>
00428     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwnd); <span class="comment">// should remove (IanJa)</span>
00429 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="hungapp.c::xxxRedrawHungWindowFrame" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID xxxRedrawHungWindowFrame           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d6/d9/structtagWND.html">PWND</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pwnd</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>BOOL&nbsp;</td>
          <td class="mdname" nowrap> <em>fActive</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d1/hungapp_8c-source.html#l00107">107</a> of file <a class="el" href="../../d6/d1/hungapp_8c-source.html">hungapp.c</a>.
<p>
References <a class="el" href="../../d9/d2/dc_8c-source.html#l00608">_GetDCEx()</a>, <a class="el" href="../../d9/d2/dc_8c-source.html#l00183">_ReleaseDC()</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00361">CheckLock</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d0/d5/ndismain_8h-source.html#l00026">UINT</a>, <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>, and <a class="el" href="../../d2/d4/caption_8c-source.html#l00986">xxxDrawCaptionBar()</a>.
<p>
Referenced by <a class="el" href="../../d6/d1/hungapp_8c-source.html#l00446">xxxHungAppDemon()</a>, and <a class="el" href="../../d4/d5/focusact_8c-source.html#l01342">xxxSetForegroundWindow2()</a>.
<p>
<pre class="fragment"><div>00110 {
00111     HDC hdc;
00112     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> wFlags = DC_NC | DC_NOSENDMSG;
00113 
00114     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwnd);
00115 
00116     <span class="keywordflow">if</span> (fActive)
00117         wFlags |= DC_ACTIVE;
00118 
00119     hdc = <a class="code" href="../../d4/d1/userk_8h.html#a1695">_GetDCEx</a>(pwnd, NULL, DCX_USESTYLE | DCX_WINDOW);
00120     <a class="code" href="../../d4/d1/userk_8h.html#a1438">xxxDrawCaptionBar</a>(pwnd, hdc, wFlags);
00121     <a class="code" href="../../d4/d1/userk_8h.html#a1697">_ReleaseDC</a>(hdc);
00122 }
</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:44:06 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
