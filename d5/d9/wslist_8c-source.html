<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: wslist.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>wslist.c</h1><a href="../../d4/d0/wslist_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">   wslist.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module contains routines which operate on the working</span>
00012 <span class="comment">    set list structure.</span>
00013 <span class="comment"></span>
00014 <span class="comment">Author:</span>
00015 <span class="comment"></span>
00016 <span class="comment">    Lou Perazzoli (loup) 10-Apr-1989</span>
00017 <span class="comment">    Landy Wang (landyw) 02-Jun-1997</span>
00018 <span class="comment"></span>
00019 <span class="comment">Revision History:</span>
00020 <span class="comment"></span>
00021 <span class="comment">--*/</span>
00022 
00023 <span class="preprocessor">#include "<a class="code" href="../../d4/d8/mi_8h.html">mi.h</a>"</span>
00024 
00025 <span class="preprocessor">#pragma alloc_text(INIT, MiInitializeSessionWsSupport)</span>
00026 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, MmAssignProcessToJob)</span>
00027 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEHYDRA, MiSessionInitializeWorkingSetList)</span>
00028 <span class="preprocessor"></span>
<a name="l00029"></a><a class="code" href="../../d4/d0/wslist_8c.html#a0">00029</a> <span class="preprocessor">#define MM_SYSTEM_CACHE_THRESHOLD ((1024*1024) / PAGE_SIZE)</span>
00030 <span class="preprocessor"></span>
<a name="l00031"></a><a class="code" href="../../d4/d0/wslist_8c.html#a2">00031</a> <span class="keyword">extern</span> ULONG <a class="code" href="../../d0/d9/miglobal_8c.html#a137">MmMaximumWorkingSetSize</a>;
00032 
<a name="l00033"></a><a class="code" href="../../d4/d0/wslist_8c.html#a3">00033</a> ULONG <a class="code" href="../../d4/d0/wslist_8c.html#a3">MmFaultsTakenToGoAboveMaxWs</a> = 100;
<a name="l00034"></a><a class="code" href="../../d4/d0/wslist_8c.html#a4">00034</a> ULONG <a class="code" href="../../d4/d0/wslist_8c.html#a4">MmFaultsTakenToGoAboveMinWs</a> = 16;
00035 
<a name="l00036"></a><a class="code" href="../../d4/d0/wslist_8c.html#a5">00036</a> ULONG <a class="code" href="../../d6/d8/sysinfo_8c.html#a9">MmSystemCodePage</a>;
<a name="l00037"></a><a class="code" href="../../d4/d0/wslist_8c.html#a6">00037</a> ULONG <a class="code" href="../../d6/d8/sysinfo_8c.html#a10">MmSystemCachePage</a>;
<a name="l00038"></a><a class="code" href="../../d4/d0/wslist_8c.html#a7">00038</a> ULONG <a class="code" href="../../d6/d8/sysinfo_8c.html#a11">MmPagedPoolPage</a>;
<a name="l00039"></a><a class="code" href="../../d4/d0/wslist_8c.html#a8">00039</a> ULONG <a class="code" href="../../d6/d8/sysinfo_8c.html#a12">MmSystemDriverPage</a>;
00040 
00041 <span class="preprocessor">#ifdef _MI_USE_CLAIMS_</span>
00042 <span class="preprocessor"></span><span class="keyword">extern</span> BOOLEAN MiReplacing;
00043 <span class="preprocessor">#endif</span>
00044 <span class="preprocessor"></span>
<a name="l00045"></a><a class="code" href="../../d4/d0/wslist_8c.html#a1">00045</a> <span class="preprocessor">#define MM_RETRY_COUNT 2</span>
00046 <span class="preprocessor"></span>
<a name="l00047"></a><a class="code" href="../../d4/d0/wslist_8c.html#a9">00047</a> <span class="keyword">extern</span> ULONG <a class="code" href="../../d6/d8/sysinfo_8c.html#a22">MmTransitionSharedPages</a>;
<a name="l00048"></a><a class="code" href="../../d4/d0/wslist_8c.html#a10">00048</a> ULONG <a class="code" href="../../d6/d8/sysinfo_8c.html#a23">MmTransitionSharedPagesPeak</a>;
00049 
<a name="l00050"></a><a class="code" href="../../d4/d0/wslist_8c.html#a11">00050</a> <span class="keyword">extern</span> LOGICAL <a class="code" href="../../d9/d3/dynmem_8c.html#a2">MiTrimRemovalPagesOnly</a>;
00051 
00052 ULONG
00053 <a class="code" href="../../d4/d0/wslist_8c.html#a12">MiDoReplacement</a>(
00054     IN <a class="code" href="../../d3/d6/struct__MMSUPPORT.html">PMMSUPPORT</a> WsInfo,
00055     IN BOOLEAN MustReplace
00056     );
00057 
00058 <span class="preprocessor">#ifdef _MI_USE_CLAIMS_</span>
00059 <span class="preprocessor"></span><a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00060 MiReplaceWorkingSetEntryUsingClaim(
00061     IN <a class="code" href="../../d3/d6/struct__MMSUPPORT.html">PMMSUPPORT</a> WsInfo,
00062     IN BOOLEAN MustReplace
00063     );
00064 <span class="preprocessor">#else</span>
00065 <span class="preprocessor"></span><a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00066 <a class="code" href="../../d4/d0/wslist_8c.html#a13">MiReplaceWorkingSetEntryUsingFaultInfo</a>(
00067     IN <a class="code" href="../../d3/d6/struct__MMSUPPORT.html">PMMSUPPORT</a> WsInfo,
00068     IN BOOLEAN MustReplace
00069     );
00070 <span class="preprocessor">#endif</span>
00071 <span class="preprocessor"></span>
00072 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00073 <a class="code" href="../../d7/d0/wstree_8c.html#a5">MiCheckWsleHash</a> (
00074     IN <a class="code" href="../../d0/d8/struct__MMWSL.html">PMMWSL</a> WorkingSetList
00075     );
00076 
00077 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00078 <a class="code" href="../../d4/d0/wslist_8c.html#a15">MiEliminateWorkingSetEntry</a> (
00079     IN ULONG WorkingSetIndex,
00080     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte,
00081     IN <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn,
00082     IN <a class="code" href="../../d1/d8/struct__MMWSLE.html">PMMWSLE</a> Wsle
00083     );
00084 
00085 ULONG
00086 <a class="code" href="../../d4/d0/wslist_8c.html#a16">MiAddWorkingSetPage</a> (
00087     IN <a class="code" href="../../d3/d6/struct__MMSUPPORT.html">PMMSUPPORT</a> WsInfo
00088     );
00089 
00090 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00091 <a class="code" href="../../d4/d0/wslist_8c.html#a17">MiRemoveWorkingSetPages</a> (
00092     IN <a class="code" href="../../d0/d8/struct__MMWSL.html">PMMWSL</a> WorkingSetList,
00093     IN <a class="code" href="../../d3/d6/struct__MMSUPPORT.html">PMMSUPPORT</a> WsInfo
00094     );
00095 
00096 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00097 <a class="code" href="../../d4/d0/wslist_8c.html#a18">MiCheckNullIndex</a> (
00098     IN <a class="code" href="../../d0/d8/struct__MMWSL.html">PMMWSL</a> WorkingSetList
00099     );
00100 
00101 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00102 <a class="code" href="../../d4/d0/wslist_8c.html#a19">MiDumpWsleInCacheBlock</a> (
00103     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> CachePte
00104     );
00105 
00106 ULONG
00107 <a class="code" href="../../d4/d0/wslist_8c.html#a20">MiDumpPteInCacheBlock</a> (
00108     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte
00109     );
00110 
00111 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00112 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGELK, MmAdjustWorkingSetSize)</span>
00113 <span class="preprocessor"></span><span class="preprocessor">#endif // ALLOC_PRAGMA</span>
00114 <span class="preprocessor"></span>
00115 
00116 <a class="code" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a>
<a name="l00117"></a><a class="code" href="../../d4/d0/wslist_8c.html#a21">00117</a> <a class="code" href="../../d4/d0/wslist_8c.html#a21">MiLocateAndReserveWsle</a> (
00118     IN <a class="code" href="../../d3/d6/struct__MMSUPPORT.html">PMMSUPPORT</a> WsInfo
00119     )
00120 
00121 <span class="comment">/*++</span>
00122 <span class="comment"></span>
00123 <span class="comment">Routine Description:</span>
00124 <span class="comment"></span>
00125 <span class="comment">    This function examines the Working Set List for the current</span>
00126 <span class="comment">    process and locates an entry to contain a new page.  If the</span>
00127 <span class="comment">    working set is not currently at its quota, the new page is</span>
00128 <span class="comment">    added without removing a page, if the working set is at its</span>
00129 <span class="comment">    quota a page is removed from the working set and the new</span>
00130 <span class="comment">    page added in its place.</span>
00131 <span class="comment"></span>
00132 <span class="comment">Arguments:</span>
00133 <span class="comment"></span>
00134 <span class="comment">    None.</span>
00135 <span class="comment"></span>
00136 <span class="comment">Return Value:</span>
00137 <span class="comment"></span>
00138 <span class="comment">    Returns the working set index which is now reserved for the</span>
00139 <span class="comment">    next page to be added.</span>
00140 <span class="comment"></span>
00141 <span class="comment">Environment:</span>
00142 <span class="comment"></span>
00143 <span class="comment">    Kernel mode, APCs disabled, working set lock.  PFN lock NOT held.</span>
00144 <span class="comment"></span>
00145 <span class="comment">--*/</span>
00146 
00147 {
00148     <a class="code" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a> WorkingSetIndex;
00149     <a class="code" href="../../d0/d8/struct__MMWSL.html">PMMWSL</a> WorkingSetList;
00150     <a class="code" href="../../d1/d8/struct__MMWSLE.html">PMMWSLE</a> Wsle;
00151     ULONG QuotaIncrement;
00152     BOOLEAN MustReplace;
00153 
00154     MustReplace = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00155     WorkingSetList = WsInfo-&gt;VmWorkingSetList;
00156     Wsle = WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o5">Wsle</a>;
00157 
00158     <span class="comment">//</span>
00159     <span class="comment">// Update page fault counts.</span>
00160     <span class="comment">//</span>
00161 
00162     WsInfo-&gt;PageFaultCount += 1;
00163     <a class="code" href="../../d2/d1/mm_8h.html#a145">MmInfoCounters</a>.<a class="code" href="../../d3/d2/struct__MMINFO__COUNTERS.html#o0">PageFaultCount</a> += 1;
00164 
00165     <span class="comment">//</span>
00166     <span class="comment">// Determine if a page should be removed from the working set to make</span>
00167     <span class="comment">// room for the new page.  If so, remove it.  In addition, determine</span>
00168     <span class="comment">// the size of the QuotaIncrement if the size needs to be boosted.</span>
00169     <span class="comment">//</span>
00170 
00171 retry_replacement:
00172 
00173     QuotaIncrement = <a class="code" href="../../d4/d0/wslist_8c.html#a12">MiDoReplacement</a>(WsInfo, MustReplace);
00174 
00175     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (WsInfo-&gt;WorkingSetSize &lt;= WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o0">Quota</a>);
00176     WsInfo-&gt;WorkingSetSize += 1;
00177 
00178     <span class="keywordflow">if</span> (WsInfo-&gt;WorkingSetSize &gt; WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o0">Quota</a>) {
00179 
00180         <span class="comment">//</span>
00181         <span class="comment">// Increment the quota and check boundary conditions.</span>
00182         <span class="comment">//</span>
00183 
00184         WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o0">Quota</a> += QuotaIncrement;
00185 
00186         WsInfo-&gt;LastTrimFaultCount = WsInfo-&gt;PageFaultCount;
00187 
00188         <span class="keywordflow">if</span> (WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o0">Quota</a> &gt; WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o7">LastInitializedWsle</a>) {
00189 
00190             <span class="comment">//</span>
00191             <span class="comment">// Add more pages to the working set list structure.</span>
00192             <span class="comment">//</span>
00193 
00194             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/wslist_8c.html#a16">MiAddWorkingSetPage</a> (WsInfo) == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00195                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (WsInfo-&gt;WorkingSetSize &lt;= WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o0">Quota</a>);
00196             }
00197             <span class="keywordflow">else</span> {
00198 
00199                 <span class="comment">//</span>
00200                 <span class="comment">// No page was added to the working set list structure.</span>
00201                 <span class="comment">// We must replace a page within this working set.</span>
00202                 <span class="comment">//</span>
00203 
00204                 WsInfo-&gt;WorkingSetSize -= 1;
00205                 MustReplace = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00206                 <span class="keywordflow">goto</span> retry_replacement;
00207             }
00208         }
00209     }
00210 
00211     <span class="comment">//</span>
00212     <span class="comment">// Get the working set entry from the free list.</span>
00213     <span class="comment">//</span>
00214 
00215     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o1">FirstFree</a> &lt;= WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o7">LastInitializedWsle</a>);
00216 
00217     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o1">FirstFree</a> &gt;= WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>);
00218 
00219     WorkingSetIndex = WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o1">FirstFree</a>;
00220     WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o1">FirstFree</a> = (<a class="code" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a>)(Wsle[WorkingSetIndex].<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.Long &gt;&gt; <a class="code" href="../../d4/d8/mi_8h.html#a9">MM_FREE_WSLE_SHIFT</a>);
00221 
00222     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o1">FirstFree</a> &lt;= WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o7">LastInitializedWsle</a>) ||
00223             (WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o1">FirstFree</a> == <a class="code" href="../../d4/d8/mi_8h.html#a10">WSLE_NULL_INDEX</a>));
00224 
00225     <span class="keywordflow">if</span> (WsInfo-&gt;WorkingSetSize &gt; WsInfo-&gt;MinimumWorkingSetSize) {
00226         <a class="code" href="../../d4/d8/mi_8h.html#a590">MmPagesAboveWsMinimum</a> += 1;
00227     }
00228 
00229     <span class="keywordflow">if</span> (WsInfo-&gt;WorkingSetSize &gt; WsInfo-&gt;PeakWorkingSetSize) {
00230         WsInfo-&gt;PeakWorkingSetSize = WsInfo-&gt;WorkingSetSize;
00231     }
00232 
00233     <span class="keywordflow">if</span> (WsInfo == &amp;<a class="code" href="../../d6/d8/sysinfo_8c.html#a21">MmSystemCacheWs</a>) {
00234         <span class="keywordflow">if</span> (WsInfo-&gt;WorkingSetSize + <a class="code" href="../../d6/d8/sysinfo_8c.html#a22">MmTransitionSharedPages</a> &gt; <a class="code" href="../../d6/d8/sysinfo_8c.html#a23">MmTransitionSharedPagesPeak</a>) {
00235             <a class="code" href="../../d6/d8/sysinfo_8c.html#a23">MmTransitionSharedPagesPeak</a> = WsInfo-&gt;WorkingSetSize + <a class="code" href="../../d6/d8/sysinfo_8c.html#a22">MmTransitionSharedPages</a>;
00236         }
00237     }
00238 
00239     <span class="keywordflow">if</span> (WorkingSetIndex &gt; WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o3">LastEntry</a>) {
00240         WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o3">LastEntry</a> = WorkingSetIndex;
00241     }
00242 
00243     <span class="comment">//</span>
00244     <span class="comment">// The returned entry is guaranteed to be available at this point.</span>
00245     <span class="comment">//</span>
00246 
00247     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Wsle[WorkingSetIndex].u1.<a class="code" href="../../d1/d8/struct__MMWSLE.html#o2">e1</a>.<a class="code" href="../../d4/d8/struct__MMWSLENTRY.html#o0">Valid</a> == 0);
00248 
00249     <span class="keywordflow">return</span> WorkingSetIndex;
00250 }
00251 
00252 
00253 ULONG
<a name="l00254"></a><a class="code" href="../../d4/d0/wslist_8c.html#a12">00254</a> <a class="code" href="../../d4/d0/wslist_8c.html#a12">MiDoReplacement</a>(
00255     IN <a class="code" href="../../d3/d6/struct__MMSUPPORT.html">PMMSUPPORT</a> WsInfo,
00256     IN BOOLEAN MustReplace
00257     )
00258 
00259 <span class="comment">/*++</span>
00260 <span class="comment"></span>
00261 <span class="comment">Routine Description:</span>
00262 <span class="comment"></span>
00263 <span class="comment">    This function determines whether the working set should be</span>
00264 <span class="comment">    grown or if a page should be replaced.  Replacement is</span>
00265 <span class="comment">    done here if deemed necessary.</span>
00266 <span class="comment"></span>
00267 <span class="comment">Arguments:</span>
00268 <span class="comment"></span>
00269 <span class="comment">    WsInfo - Supplies the working set information structure to replace within.</span>
00270 <span class="comment"></span>
00271 <span class="comment">    MustReplace - Supplies TRUE if replacement must succeed.</span>
00272 <span class="comment"></span>
00273 <span class="comment">Return Value:</span>
00274 <span class="comment"></span>
00275 <span class="comment">    Quota increment if growth is necessary.</span>
00276 <span class="comment"></span>
00277 <span class="comment">Environment:</span>
00278 <span class="comment"></span>
00279 <span class="comment">    Kernel mode, APCs disabled, working set lock.  PFN lock NOT held.</span>
00280 <span class="comment"></span>
00281 <span class="comment">--*/</span>
00282 
00283 {
00284     <a class="code" href="../../d0/d8/struct__MMWSL.html">PMMWSL</a> WorkingSetList;
00285     ULONG CurrentSize;
00286     LARGE_INTEGER CurrentTime;
00287 <span class="preprocessor">#if defined(_ALPHA_) &amp;&amp; !defined(_AXP64_)</span>
00288 <span class="preprocessor"></span>    KIRQL OldIrql;
00289 <span class="preprocessor">#endif</span>
00290 <span class="preprocessor"></span>    ULONG QuotaIncrement;
00291     PFN_NUMBER AvailablePageThreshold;
00292 <span class="preprocessor">#ifdef _MI_USE_CLAIMS_</span>
00293 <span class="preprocessor"></span>    <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> ProcessToTrim;
00294     ULONG Dummy1;
00295     ULONG Dummy2;
00296     ULONG Trim;
00297     ULONG TrimAge;
00298 <span class="preprocessor">#endif</span>
00299 <span class="preprocessor"></span>
00300     WorkingSetList = WsInfo-&gt;VmWorkingSetList;
00301 
00302     <span class="keywordflow">if</span> (WsInfo == &amp;<a class="code" href="../../d6/d8/sysinfo_8c.html#a21">MmSystemCacheWs</a>) {
00303         <a class="code" href="../../d4/d8/mi_8h.html#a147">MM_SYSTEM_WS_LOCK_ASSERT</a>();
00304         AvailablePageThreshold = <a class="code" href="../../d4/d0/wslist_8c.html#a0">MM_SYSTEM_CACHE_THRESHOLD</a>;
00305     }
00306 
00307     <span class="comment">//</span>
00308     <span class="comment">// Determine the number of pages that need to be available to</span>
00309     <span class="comment">// grow the working set and how much the quota should be</span>
00310     <span class="comment">// boosted if the working set grows over it.</span>
00311     <span class="comment">//</span>
00312     <span class="comment">// If below the Minimum use the defaults.</span>
00313     <span class="comment">//</span>
00314 
00315 recheck:
00316 
00317     AvailablePageThreshold = 0;
00318     QuotaIncrement = 1;
00319 
00320     <span class="keywordflow">if</span> (WsInfo-&gt;WorkingSetSize &gt;= WsInfo-&gt;MinimumWorkingSetSize) {
00321 
00322         <span class="keywordflow">if</span> (WsInfo-&gt;AllowWorkingSetAdjustment == <a class="code" href="../../d4/d8/mi_8h.html#a31">MM_FORCE_TRIM</a>) {
00323 
00324             <span class="comment">//</span>
00325             <span class="comment">// The working set manager cannot attach to this process</span>
00326             <span class="comment">// to trim it.  Force a trim now and update the working</span>
00327             <span class="comment">// set manager's fields properly to indicate a trim occurred.</span>
00328             <span class="comment">//</span>
00329 
00330 <span class="preprocessor">#ifdef _MI_USE_CLAIMS_</span>
00331 <span class="preprocessor"></span>
00332             Trim = WsInfo-&gt;Claim &gt;&gt;
00333                             ((WsInfo-&gt;MemoryPriority == <a class="code" href="../../d1/d9/ps_8h.html#a3">MEMORY_PRIORITY_FOREGROUND</a>)
00334                                 ? <a class="code" href="../../d4/d8/mi_8h.html#a206">MI_FOREGROUND_CLAIM_AVAILABLE_SHIFT</a>
00335                                 : <a class="code" href="../../d4/d8/mi_8h.html#a207">MI_BACKGROUND_CLAIM_AVAILABLE_SHIFT</a>);
00336 
00337             <span class="keywordflow">if</span> (WsInfo == &amp;<a class="code" href="../../d6/d8/sysinfo_8c.html#a21">MmSystemCacheWs</a>) {
00338                 ProcessToTrim = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00339             }
00340             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (WsInfo-&gt;u.Flags.SessionSpace == 0) {
00341                 ProcessToTrim = CONTAINING_RECORD(WsInfo, <a class="code" href="../../d0/d4/struct__EPROCESS.html">EPROCESS</a>, Vm);
00342             }
00343             <span class="keywordflow">else</span> {
00344                 ProcessToTrim = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;       <span class="comment">// Hydra session.</span>
00345             }
00346 
00347             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> &lt; 100) {
00348                 <span class="keywordflow">if</span> (WsInfo-&gt;WorkingSetSize &gt; WsInfo-&gt;MinimumWorkingSetSize) {
00349                     Trim = (WsInfo-&gt;WorkingSetSize - WsInfo-&gt;MinimumWorkingSetSize) &gt;&gt; 2;
00350                 }
00351                 TrimAge = <a class="code" href="../../d4/d8/mi_8h.html#a204">MI_PASS4_TRIM_AGE</a>;
00352             }
00353             <span class="keywordflow">else</span> {
00354                 TrimAge = <a class="code" href="../../d4/d8/mi_8h.html#a200">MI_PASS0_TRIM_AGE</a>;
00355             }
00356 
00357             <a class="code" href="../../d4/d0/wslist_8c.html#a34">MiTrimWorkingSet</a> (Trim, WsInfo, TrimAge);
00358 
00359             MiAgeAndEstimateAvailableInWorkingSet (WsInfo,
00360                                                    <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00361                                                    &amp;Dummy1,
00362                                                    &amp;Dummy2
00363                                                    );
00364 <span class="preprocessor">#else</span>
00365 <span class="preprocessor"></span>            <a class="code" href="../../d4/d0/wslist_8c.html#a34">MiTrimWorkingSet</a>(20, WsInfo, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00366 <span class="preprocessor">#endif</span>
00367 <span class="preprocessor"></span>
00368             <a class="code" href="../../d7/d0/ke_2miscc_8c.html#a3">KeQuerySystemTime</a> (&amp;CurrentTime);
00369             WsInfo-&gt;LastTrimTime = CurrentTime;
00370             WsInfo-&gt;LastTrimFaultCount = WsInfo-&gt;PageFaultCount;
00371 <span class="preprocessor">#if defined(_ALPHA_) &amp;&amp; !defined(_AXP64_)</span>
00372 <span class="preprocessor"></span>            <a class="code" href="../../d4/d8/mi_8h.html#a142">LOCK_EXPANSION_IF_ALPHA</a> (OldIrql);
00373 <span class="preprocessor">#endif</span>
00374 <span class="preprocessor"></span>            WsInfo-&gt;AllowWorkingSetAdjustment = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00375 <span class="preprocessor">#if defined(_ALPHA_) &amp;&amp; !defined(_AXP64_)</span>
00376 <span class="preprocessor"></span>            <a class="code" href="../../d4/d8/mi_8h.html#a143">UNLOCK_EXPANSION_IF_ALPHA</a> (OldIrql);
00377 <span class="preprocessor">#endif</span>
00378 <span class="preprocessor"></span>
00379             <span class="comment">//</span>
00380             <span class="comment">// Set the quota to the current size.</span>
00381             <span class="comment">//</span>
00382 
00383             WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o0">Quota</a> = WsInfo-&gt;WorkingSetSize;
00384             <span class="keywordflow">if</span> (WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o0">Quota</a> &lt; WsInfo-&gt;MinimumWorkingSetSize) {
00385                 WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o0">Quota</a> = WsInfo-&gt;MinimumWorkingSetSize;
00386             }
00387 
00388             <span class="keywordflow">goto</span> recheck;
00389         }
00390 
00391         CurrentSize = WsInfo-&gt;WorkingSetSize;
00392         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (CurrentSize &lt;= (WorkingSetList-&gt;LastInitializedWsle + 1));
00393 
00394         <span class="keywordflow">if</span> ((WsInfo-&gt;u.Flags.WorkingSetHard) &amp;&amp; (CurrentSize &gt;= WsInfo-&gt;MaximumWorkingSetSize)) {
00395 
00396             <span class="comment">//</span>
00397             <span class="comment">// This is an enforced working set maximum triggering a replace.</span>
00398             <span class="comment">//</span>
00399 
00400 <span class="preprocessor">#ifdef _MI_USE_CLAIMS_</span>
00401 <span class="preprocessor"></span>            MiReplaceWorkingSetEntryUsingClaim (WsInfo, MustReplace);
00402 <span class="preprocessor">#else</span>
00403 <span class="preprocessor"></span>            <a class="code" href="../../d4/d0/wslist_8c.html#a13">MiReplaceWorkingSetEntryUsingFaultInfo</a> (WsInfo, MustReplace);
00404 <span class="preprocessor">#endif</span>
00405 <span class="preprocessor"></span>            <span class="keywordflow">return</span> 0;
00406         }
00407 
00408 <span class="preprocessor">#ifdef _MI_USE_CLAIMS_</span>
00409 <span class="preprocessor"></span>
00410         <span class="comment">//</span>
00411         <span class="comment">// If using claims, don't grow if</span>
00412         <span class="comment">//      - we're over the max</span>
00413         <span class="comment">//      - there aren't any pages to take</span>
00414         <span class="comment">//      - or if we are growing too much in this</span>
00415         <span class="comment">//        time interval and there isn't much</span>
00416         <span class="comment">//        memory available</span>
00417         <span class="comment">//</span>
00418 
00419         <span class="keywordflow">if</span> (CurrentSize &gt; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a70">MM_MAXIMUM_WORKING_SET</a> || <a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> == 0 || MustReplace == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00420 
00421             <span class="comment">//</span>
00422             <span class="comment">// Can't grow this one.</span>
00423             <span class="comment">//</span>
00424 
00425             AvailablePageThreshold = 0xffffffff;
00426             MiReplacing = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00427         }
00428 <span class="preprocessor">#if defined (_X86PAE_)</span>
00429 <span class="preprocessor"></span>        <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((WsInfo-&gt;u.Flags.SessionSpace == 1) &amp;&amp; (CurrentSize &gt; <a class="code" href="../../d4/d8/mi_8h.html#a340">MI_SESSION_MAXIMUM_WORKING_SET</a>)) {
00430 
00431             <span class="comment">//</span>
00432             <span class="comment">// Can't grow this one.</span>
00433             <span class="comment">//</span>
00434 
00435             AvailablePageThreshold = 0xffffffff;
00436             MiReplacing = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00437         }
00438 <span class="preprocessor">#endif</span>
00439 <span class="preprocessor"></span>        <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> &lt; 10000 &amp;&amp; <a class="code" href="../../d4/d8/mi_8h.html#a216">MI_WS_GROWING_TOO_FAST</a>(WsInfo)) {
00440 
00441             <span class="comment">//</span>
00442             <span class="comment">// Can't grow this one either.</span>
00443             <span class="comment">//</span>
00444 
00445             AvailablePageThreshold = 0xffffffff;
00446             MiReplacing = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00447         }
00448 <span class="preprocessor">#else</span>
00449 <span class="preprocessor"></span>        <span class="comment">//</span>
00450         <span class="comment">// Not using claims, base the growth on how much faulting</span>
00451         <span class="comment">// the process is doing.</span>
00452         <span class="comment">//</span>
00453 
00454         <span class="keywordflow">if</span> (MustReplace == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00455             AvailablePageThreshold = 0xffffffff;
00456         }
00457         <span class="keywordflow">if</span> (CurrentSize &lt; WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o0">Quota</a>) {
00458 
00459             <span class="comment">//</span>
00460             <span class="comment">// Working set is below quota, allow it to grow with few pages</span>
00461             <span class="comment">// available.</span>
00462             <span class="comment">//</span>
00463 
00464             AvailablePageThreshold = 10;
00465             QuotaIncrement = 1;
00466         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (CurrentSize &lt; WsInfo-&gt;MaximumWorkingSetSize) {
00467 
00468             <span class="comment">//</span>
00469             <span class="comment">// Working set is between min and max.  Allow it to grow if enough</span>
00470             <span class="comment">// faults have been taken since last adjustment.</span>
00471             <span class="comment">//</span>
00472 
00473             <span class="keywordflow">if</span> ((WsInfo-&gt;PageFaultCount - WsInfo-&gt;LastTrimFaultCount) &lt;
00474                     <a class="code" href="../../d4/d0/wslist_8c.html#a4">MmFaultsTakenToGoAboveMinWs</a>) {
00475                 AvailablePageThreshold = <a class="code" href="../../d4/d8/mi_8h.html#a588">MmMoreThanEnoughFreePages</a> + 200;
00476                 <span class="keywordflow">if</span> (WsInfo-&gt;MemoryPriority == <a class="code" href="../../d1/d9/ps_8h.html#a3">MEMORY_PRIORITY_FOREGROUND</a>) {
00477                     AvailablePageThreshold -= 250;
00478                 }
00479             } <span class="keywordflow">else</span> {
00480                 AvailablePageThreshold = <a class="code" href="../../d4/d8/mi_8h.html#a595">MmWsAdjustThreshold</a>;
00481             }
00482             QuotaIncrement = (ULONG)<a class="code" href="../../d4/d8/mi_8h.html#a593">MmWorkingSetSizeIncrement</a>;
00483         } <span class="keywordflow">else</span> {
00484 
00485             <span class="comment">//</span>
00486             <span class="comment">// Working set is above max.</span>
00487             <span class="comment">//</span>
00488 
00489             <span class="keywordflow">if</span> ((WsInfo-&gt;PageFaultCount - WsInfo-&gt;LastTrimFaultCount) &lt;
00490                     (CurrentSize &gt;&gt; 3))
00491             {
00492                 AvailablePageThreshold = <a class="code" href="../../d4/d8/mi_8h.html#a588">MmMoreThanEnoughFreePages</a> + 200;
00493                 <span class="keywordflow">if</span> (WsInfo-&gt;MemoryPriority == <a class="code" href="../../d1/d9/ps_8h.html#a3">MEMORY_PRIORITY_FOREGROUND</a>) {
00494                     AvailablePageThreshold -= 250;
00495                 }
00496             } <span class="keywordflow">else</span> {
00497                 AvailablePageThreshold += <a class="code" href="../../d4/d8/mi_8h.html#a596">MmWsExpandThreshold</a>;
00498             }
00499             QuotaIncrement = (ULONG)<a class="code" href="../../d4/d8/mi_8h.html#a594">MmWorkingSetSizeExpansion</a>;
00500 
00501             <span class="keywordflow">if</span> (CurrentSize &gt; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a70">MM_MAXIMUM_WORKING_SET</a>) {
00502                 AvailablePageThreshold = 0xffffffff;
00503                 QuotaIncrement = 1;
00504             }
00505 <span class="preprocessor">#if defined (_X86PAE_)</span>
00506 <span class="preprocessor"></span>            <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((WsInfo-&gt;u.Flags.SessionSpace == 1) &amp;&amp; (CurrentSize &gt; <a class="code" href="../../d4/d8/mi_8h.html#a340">MI_SESSION_MAXIMUM_WORKING_SET</a>)) {
00507                 AvailablePageThreshold = 0xffffffff;
00508                 QuotaIncrement = 1;
00509             }
00510 <span class="preprocessor">#endif</span>
00511 <span class="preprocessor"></span>        }
00512 <span class="preprocessor">#endif</span>
00513 <span class="preprocessor"></span>    }
00514 
00515     <span class="comment">//</span>
00516     <span class="comment">// If there isn't enough memory to allow growth, find a good page</span>
00517     <span class="comment">// to remove and remove it.</span>
00518     <span class="comment">//</span>
00519 
00520     <span class="keywordflow">if</span> (WsInfo-&gt;AddressSpaceBeingDeleted == 0 &amp;&amp; AvailablePageThreshold != 0) {
00521         <span class="keywordflow">if</span> ((<a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> &lt;= AvailablePageThreshold) ||
00522              (WsInfo-&gt;WorkingSetExpansionLinks.Flink == <a class="code" href="../../d4/d8/mi_8h.html#a20">MM_NO_WS_EXPANSION</a>)) {
00523 
00524 <span class="preprocessor">#ifdef _MI_USE_CLAIMS_</span>
00525 <span class="preprocessor"></span>            MiReplaceWorkingSetEntryUsingClaim (WsInfo, MustReplace);
00526 <span class="preprocessor">#else</span>
00527 <span class="preprocessor"></span>            <a class="code" href="../../d4/d0/wslist_8c.html#a13">MiReplaceWorkingSetEntryUsingFaultInfo</a> (WsInfo, MustReplace);
00528 <span class="preprocessor">#endif</span>
00529 <span class="preprocessor"></span>        }
00530         <span class="keywordflow">else</span> {
00531             WsInfo-&gt;GrowthSinceLastEstimate += 1;
00532         }
00533     }
00534     <span class="keywordflow">else</span> {
00535         WsInfo-&gt;GrowthSinceLastEstimate += 1;
00536     }
00537 
00538     <span class="keywordflow">return</span> QuotaIncrement;
00539 }
00540 
00541 
00542 LOGICAL
<a name="l00543"></a><a class="code" href="../../d4/d0/wslist_8c.html#a22">00543</a> <a class="code" href="../../d4/d0/wslist_8c.html#a22">MmEnforceWorkingSetLimit</a>(
00544     IN <a class="code" href="../../d3/d6/struct__MMSUPPORT.html">PMMSUPPORT</a> WsInfo,
00545     IN LOGICAL Enable
00546     )
00547 
00548 <span class="comment">/*++</span>
00549 <span class="comment"></span>
00550 <span class="comment">Routine Description:</span>
00551 <span class="comment"></span>
00552 <span class="comment">    This function enables hard enforcement of the working set maximum for</span>
00553 <span class="comment">    the specified WsInfo.</span>
00554 <span class="comment"></span>
00555 <span class="comment">Arguments:</span>
00556 <span class="comment"></span>
00557 <span class="comment">    WsInfo - Supplies the working set info pointer.</span>
00558 <span class="comment"></span>
00559 <span class="comment">    Enable - Supplies TRUE if enabling hard enforcement, FALSE if not.</span>
00560 <span class="comment"></span>
00561 <span class="comment">Return Value:</span>
00562 <span class="comment"></span>
00563 <span class="comment">    The previous state of the working set enforcement.</span>
00564 <span class="comment"></span>
00565 <span class="comment">Environment:</span>
00566 <span class="comment"></span>
00567 <span class="comment">    Kernel mode, APCs disabled.  The working set lock must NOT be held.</span>
00568 <span class="comment">    The caller guarantees that the target WsInfo cannot go away.</span>
00569 <span class="comment"></span>
00570 <span class="comment">--*/</span>
00571 
00572 {
00573     KIRQL OldIrql;
00574 
00575     LOGICAL PreviousWorkingSetEnforcement;
00576 
00577     <a class="code" href="../../d4/d8/mi_8h.html#a139">LOCK_EXPANSION</a> (OldIrql);
00578 
00579     PreviousWorkingSetEnforcement = WsInfo-&gt;u.Flags.WorkingSetHard;
00580 
00581     WsInfo-&gt;u.Flags.WorkingSetHard = Enable;
00582 
00583     <a class="code" href="../../d4/d8/mi_8h.html#a140">UNLOCK_EXPANSION</a> (OldIrql);
00584 
00585 <span class="preprocessor">#if 0</span>
00586 <span class="preprocessor"></span>
00587     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> CurrentProcess;
00588 
00589     <span class="comment">//</span>
00590     <span class="comment">// Get the working set lock and disable APCs.</span>
00591     <span class="comment">// The working set could be trimmed at this point if it is excessive.</span>
00592     <span class="comment">//</span>
00593     <span class="comment">// The working set lock cannot be acquired at this point without updating</span>
00594     <span class="comment">// ps in order to avoid deadlock.</span>
00595     <span class="comment">//</span>
00596 
00597     <span class="keywordflow">if</span> (WsInfo == &amp;<a class="code" href="../../d6/d8/sysinfo_8c.html#a21">MmSystemCacheWs</a>) {
00598         <a class="code" href="../../d4/d8/mi_8h.html#a144">LOCK_SYSTEM_WS</a> (OldIrql2);
00599         <a class="code" href="../../d4/d8/mi_8h.html#a145">UNLOCK_SYSTEM_WS</a> (OldIrql2);
00600     }
00601     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (WsInfo-&gt;u.Flags.SessionSpace == 0) {
00602         CurrentProcess = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a> ();
00603         <a class="code" href="../../d4/d8/mi_8h.html#a154">LOCK_WS</a> (CurrentProcess);
00604 
00605         <a class="code" href="../../d4/d8/mi_8h.html#a158">UNLOCK_WS</a> (CurrentProcess);
00606     }
00607 <span class="preprocessor">#endif</span>
00608 <span class="preprocessor"></span>
00609     <span class="keywordflow">return</span> PreviousWorkingSetEnforcement;
00610 }
00611 
00612 <span class="preprocessor">#ifdef _MI_USE_CLAIMS_</span>
00613 <span class="preprocessor"></span>
00614 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00615 MiReplaceWorkingSetEntryUsingClaim(
00616     IN <a class="code" href="../../d3/d6/struct__MMSUPPORT.html">PMMSUPPORT</a> WsInfo,
00617     IN BOOLEAN MustReplace
00618     )
00619 
00620 <span class="comment">/*++</span>
00621 <span class="comment"></span>
00622 <span class="comment">Routine Description:</span>
00623 <span class="comment"></span>
00624 <span class="comment">    This function tries to find a good working set entry to replace.</span>
00625 <span class="comment"></span>
00626 <span class="comment">Arguments:</span>
00627 <span class="comment"></span>
00628 <span class="comment">    WsInfo - Supplies the working set info pointer.</span>
00629 <span class="comment"></span>
00630 <span class="comment">    MustReplace - Supplies TRUE if replacement must succeed.</span>
00631 <span class="comment"></span>
00632 <span class="comment">Return Value:</span>
00633 <span class="comment"></span>
00634 <span class="comment">    None</span>
00635 <span class="comment"></span>
00636 <span class="comment">Environment:</span>
00637 <span class="comment"></span>
00638 <span class="comment">    Kernel mode, APCs disabled, working set lock.  PFN lock NOT held.</span>
00639 <span class="comment"></span>
00640 <span class="comment">--*/</span>
00641 
00642 {
00643     ULONG WorkingSetIndex;
00644     ULONG FirstDynamic;
00645     ULONG LastEntry;
00646     <a class="code" href="../../d0/d8/struct__MMWSL.html">PMMWSL</a> WorkingSetList;
00647     <a class="code" href="../../d1/d8/struct__MMWSLE.html">PMMWSLE</a> Wsle;
00648     ULONG NumberOfCandidates;
00649     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
00650     ULONG TheNextSlot;
00651     ULONG OldestWorkingSetIndex;
00652     LONG OldestAge;
00653 
00654     WorkingSetList = WsInfo-&gt;VmWorkingSetList;
00655     Wsle = WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o5">Wsle</a>;
00656 
00657     <span class="comment">//</span>
00658     <span class="comment">// Toss a page out of the working set.</span>
00659     <span class="comment">//</span>
00660 
00661     LastEntry = WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o3">LastEntry</a>;
00662     FirstDynamic = WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>;
00663     WorkingSetIndex = WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o4">NextSlot</a>;
00664     <span class="keywordflow">if</span> (WorkingSetIndex &gt; LastEntry || WorkingSetIndex &lt; FirstDynamic) {
00665         WorkingSetIndex = FirstDynamic;
00666     }
00667     TheNextSlot = WorkingSetIndex;
00668     NumberOfCandidates = 0;
00669 
00670     OldestWorkingSetIndex = <a class="code" href="../../d4/d8/mi_8h.html#a10">WSLE_NULL_INDEX</a>;
00671 
00672     <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00673 
00674         <span class="comment">//</span>
00675         <span class="comment">// Keep track of the oldest page along the way in case we</span>
00676         <span class="comment">// don't find one that's &gt;= MI_IMMEDIATE_REPLACEMENT_AGE</span>
00677         <span class="comment">// before we've looked at MM_WORKING_SET_LIST_SEARCH</span>
00678         <span class="comment">// entries.</span>
00679         <span class="comment">//</span>
00680 
00681         <span class="keywordflow">while</span> (Wsle[WorkingSetIndex].<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Valid == 0) {
00682             WorkingSetIndex += 1;
00683             <span class="keywordflow">if</span> (WorkingSetIndex &gt; LastEntry) {
00684                 WorkingSetIndex = FirstDynamic;
00685             }
00686             <span class="keywordflow">if</span> (WorkingSetIndex == TheNextSlot &amp;&amp; MustReplace == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00687     
00688                 <span class="comment">//</span>
00689                 <span class="comment">// Entire working set list has been searched, increase</span>
00690                 <span class="comment">// the working set size.</span>
00691                 <span class="comment">//</span>
00692     
00693                 WsInfo-&gt;GrowthSinceLastEstimate += 1;
00694                 <span class="keywordflow">return</span>;
00695             }
00696         }
00697 
00698         <span class="keywordflow">if</span> (OldestWorkingSetIndex == <a class="code" href="../../d4/d8/mi_8h.html#a10">WSLE_NULL_INDEX</a>) {
00699 
00700             <span class="comment">//</span>
00701             <span class="comment">// First time through, so initialize the OldestWorkingSetIndex</span>
00702             <span class="comment">// to the first valid WSLE.  As we go along, this will be repointed</span>
00703             <span class="comment">// at the oldest candidate we come across.</span>
00704             <span class="comment">//</span>
00705 
00706             OldestWorkingSetIndex = WorkingSetIndex;
00707             OldestAge = -1;
00708         }
00709 
00710         PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(Wsle[WorkingSetIndex].u1.VirtualAddress);
00711 
00712         <span class="keywordflow">if</span> (MustReplace == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> ||
00713             ((<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a138">MI_GET_ACCESSED_IN_PTE</a>(PointerPte) == 0) &amp;&amp;
00714             (OldestAge &lt; (LONG) <a class="code" href="../../d4/d8/mi_8h.html#a213">MI_GET_WSLE_AGE</a>(PointerPte, &amp;Wsle[WorkingSetIndex])))) {
00715 
00716             <span class="comment">//</span>
00717             <span class="comment">// This one is not used and it's older.</span>
00718             <span class="comment">//</span>
00719 
00720             OldestAge = <a class="code" href="../../d4/d8/mi_8h.html#a213">MI_GET_WSLE_AGE</a>(PointerPte, &amp;Wsle[WorkingSetIndex]);
00721             OldestWorkingSetIndex = WorkingSetIndex;
00722         }
00723 
00724         <span class="comment">//</span>
00725         <span class="comment">// If it's old enough or we've searched too much then use this entry.</span>
00726         <span class="comment">//</span>
00727 
00728         <span class="keywordflow">if</span> (MustReplace == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> ||
00729             OldestAge &gt;= <a class="code" href="../../d4/d8/mi_8h.html#a198">MI_IMMEDIATE_REPLACEMENT_AGE</a> ||
00730             NumberOfCandidates &gt; <a class="code" href="../../d4/d8/mi_8h.html#a14">MM_WORKING_SET_LIST_SEARCH</a>) {
00731 
00732             <a class="code" href="../../d2/d1/mm_8h.html#a81">PERFINFO_PAGE_INFO_REPLACEMENT_DECL</a>();
00733 
00734             <span class="keywordflow">if</span> (OldestWorkingSetIndex != WorkingSetIndex) {
00735                 WorkingSetIndex = OldestWorkingSetIndex;
00736                 PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(Wsle[WorkingSetIndex].u1.VirtualAddress);
00737             }
00738 
00739             <a class="code" href="../../d2/d1/mm_8h.html#a54">PERFINFO_GET_PAGE_INFO_REPLACEMENT</a>(PointerPte);
00740 
00741             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/wslist_8c.html#a26">MiFreeWsle</a>(WorkingSetIndex, WsInfo, PointerPte)) {
00742 
00743                 <a class="code" href="../../d2/d1/mm_8h.html#a75">PERFINFO_LOG_WS_REPLACEMENT</a>(WsInfo);
00744 
00745                 <span class="comment">//</span>
00746                 <span class="comment">// This entry was removed.</span>
00747                 <span class="comment">//</span>
00748 
00749                 WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o4">NextSlot</a> = WorkingSetIndex + 1;
00750                 <span class="keywordflow">break</span>;
00751             }
00752 
00753             <span class="comment">//</span>
00754             <span class="comment">// We failed to remove a page, try the next one.</span>
00755             <span class="comment">//</span>
00756             <span class="comment">// Clear the OldestWorkingSetIndex so that</span>
00757             <span class="comment">// it gets set to the next valid entry above like the</span>
00758             <span class="comment">// first time around.</span>
00759             <span class="comment">//</span>
00760 
00761             WorkingSetIndex = OldestWorkingSetIndex + 1;
00762 
00763             OldestWorkingSetIndex = <a class="code" href="../../d4/d8/mi_8h.html#a10">WSLE_NULL_INDEX</a>;
00764         }
00765         <span class="keywordflow">else</span> {
00766             WorkingSetIndex += 1;
00767         }
00768 
00769         <span class="keywordflow">if</span> (WorkingSetIndex &gt; LastEntry) {
00770             WorkingSetIndex = FirstDynamic;
00771         }
00772 
00773         NumberOfCandidates += 1;
00774 
00775         <span class="keywordflow">if</span> (WorkingSetIndex == TheNextSlot &amp;&amp; MustReplace == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00776 
00777             <span class="comment">//</span>
00778             <span class="comment">// Entire working set list has been searched, increase</span>
00779             <span class="comment">// the working set size.</span>
00780             <span class="comment">//</span>
00781 
00782             WsInfo-&gt;GrowthSinceLastEstimate += 1;
00783             <span class="keywordflow">break</span>;
00784         }
00785     }
00786 }
00787 <span class="preprocessor">#else</span>
00788 <span class="preprocessor"></span>
00789 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00790"></a><a class="code" href="../../d4/d0/wslist_8c.html#a13">00790</a> <a class="code" href="../../d4/d0/wslist_8c.html#a13">MiReplaceWorkingSetEntryUsingFaultInfo</a>(
00791     IN <a class="code" href="../../d3/d6/struct__MMSUPPORT.html">PMMSUPPORT</a> WsInfo,
00792     IN BOOLEAN MustReplace
00793     )
00794 
00795 <span class="comment">/*++</span>
00796 <span class="comment"></span>
00797 <span class="comment">Routine Description:</span>
00798 <span class="comment"></span>
00799 <span class="comment">    This function tries to find a reasonable working set entry to replace.</span>
00800 <span class="comment"></span>
00801 <span class="comment">Arguments:</span>
00802 <span class="comment"></span>
00803 <span class="comment">    WsInfo - Supplies the working set info pointer.</span>
00804 <span class="comment"></span>
00805 <span class="comment">    MustReplace - Supplies TRUE if replacement must succeed.</span>
00806 <span class="comment"></span>
00807 <span class="comment">Return Value:</span>
00808 <span class="comment"></span>
00809 <span class="comment">    None</span>
00810 <span class="comment"></span>
00811 <span class="comment">Environment:</span>
00812 <span class="comment"></span>
00813 <span class="comment">    Kernel mode, APCs disabled, working set lock.  PFN lock NOT held.</span>
00814 <span class="comment"></span>
00815 <span class="comment">--*/</span>
00816 
00817 {
00818     ULONG WorkingSetIndex;
00819     ULONG FirstDynamic;
00820     ULONG LastEntry;
00821     <a class="code" href="../../d0/d8/struct__MMWSL.html">PMMWSL</a> WorkingSetList;
00822     <a class="code" href="../../d1/d8/struct__MMWSLE.html">PMMWSLE</a> Wsle;
00823     ULONG NumberOfCandidates;
00824     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
00825     ULONG TheNextSlot;
00826 
00827     WorkingSetList = WsInfo-&gt;VmWorkingSetList;
00828     Wsle = WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o5">Wsle</a>;
00829 
00830     <span class="comment">//</span>
00831     <span class="comment">// Toss a page out of the working set.</span>
00832     <span class="comment">//</span>
00833 
00834     LastEntry = WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o3">LastEntry</a>;
00835     FirstDynamic = WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>;
00836     WorkingSetIndex = WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o4">NextSlot</a>;
00837 
00838     <span class="keywordflow">if</span> ((WorkingSetIndex &gt; LastEntry) || (WorkingSetIndex &lt; FirstDynamic)) {
00839         WorkingSetIndex = FirstDynamic;
00840     }
00841 
00842     TheNextSlot = WorkingSetIndex;
00843     NumberOfCandidates = 0;
00844 
00845     <span class="keywordflow">do</span> {
00846 
00847         <span class="comment">//</span>
00848         <span class="comment">// Find a valid entry within the set.</span>
00849         <span class="comment">//</span>
00850 
00851         <span class="keywordflow">if</span> (Wsle[WorkingSetIndex].<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Valid != 0) {
00852 
00853             PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (
00854                               Wsle[WorkingSetIndex].u1.<a class="code" href="../../d1/d8/struct__MMWSLE.html#o0">VirtualAddress</a>);
00855 
00856             <span class="keywordflow">if</span> ((<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a138">MI_GET_ACCESSED_IN_PTE</a>(PointerPte) == 0) ||
00857                 (NumberOfCandidates &gt; <a class="code" href="../../d4/d8/mi_8h.html#a14">MM_WORKING_SET_LIST_SEARCH</a>)) {
00858 
00859                 <a class="code" href="../../d2/d1/mm_8h.html#a81">PERFINFO_PAGE_INFO_REPLACEMENT_DECL</a>();
00860                 <a class="code" href="../../d2/d1/mm_8h.html#a54">PERFINFO_GET_PAGE_INFO_REPLACEMENT</a>(PointerPte);
00861 
00862                 <span class="comment">//</span>
00863                 <span class="comment">// Don't pick the same entry we replaced the last time</span>
00864                 <span class="comment">// unless we're under extreme pressure.</span>
00865                 <span class="comment">//</span>
00866 
00867                 <span class="keywordflow">if</span> ((WorkingSetIndex != TheNextSlot || MustReplace == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) &amp;&amp;
00868                     <a class="code" href="../../d4/d0/wslist_8c.html#a26">MiFreeWsle</a> (WorkingSetIndex, WsInfo, PointerPte)) {
00869 
00870                     <a class="code" href="../../d2/d1/mm_8h.html#a75">PERFINFO_LOG_WS_REPLACEMENT</a>(WsInfo);
00871 
00872                     <span class="comment">//</span>
00873                     <span class="comment">// This entry was removed.</span>
00874                     <span class="comment">//</span>
00875 
00876                     WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o4">NextSlot</a> = WorkingSetIndex + 1;
00877                     <span class="keywordflow">break</span>;
00878                 }
00879             }
00880             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a137">MI_SET_ACCESSED_IN_PTE</a> (PointerPte, 0);
00881             NumberOfCandidates += 1;
00882         }
00883 
00884         WorkingSetIndex += 1;
00885         <span class="keywordflow">if</span> (WorkingSetIndex &gt; LastEntry) {
00886             WorkingSetIndex = FirstDynamic;
00887         }
00888 
00889     } <span class="keywordflow">while</span> (WorkingSetIndex != TheNextSlot || MustReplace == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00890 
00891     <span class="comment">//</span>
00892     <span class="comment">// Entire working set list has been searched.  If an entry wasn't</span>
00893     <span class="comment">// removed, our caller can increase the working set size.</span>
00894     <span class="comment">//</span>
00895 }
00896 <span class="preprocessor">#endif</span>
00897 <span class="preprocessor"></span>
00898 ULONG
<a name="l00899"></a><a class="code" href="../../d4/d0/wslist_8c.html#a23">00899</a> <a class="code" href="../../d4/d0/wslist_8c.html#a23">MiRemovePageFromWorkingSet</a> (
00900     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte,
00901     IN <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1,
00902     IN <a class="code" href="../../d3/d6/struct__MMSUPPORT.html">PMMSUPPORT</a> WsInfo
00903     )
00904 
00905 <span class="comment">/*++</span>
00906 <span class="comment"></span>
00907 <span class="comment">Routine Description:</span>
00908 <span class="comment"></span>
00909 <span class="comment">    This function removes the page mapped by the specified PTE from</span>
00910 <span class="comment">    the process's working set list.</span>
00911 <span class="comment"></span>
00912 <span class="comment">Arguments:</span>
00913 <span class="comment"></span>
00914 <span class="comment">    PointerPte - Supplies a pointer to the PTE mapping the page to</span>
00915 <span class="comment">                 be removed from the working set list.</span>
00916 <span class="comment"></span>
00917 <span class="comment">    Pfn1 - Supplies a pointer to the PFN database element referred to</span>
00918 <span class="comment">           by the PointerPte.</span>
00919 <span class="comment"></span>
00920 <span class="comment">Return Value:</span>
00921 <span class="comment"></span>
00922 <span class="comment">    Returns TRUE if the specified page was locked in the working set,</span>
00923 <span class="comment">    FALSE otherwise.</span>
00924 <span class="comment"></span>
00925 <span class="comment">Environment:</span>
00926 <span class="comment"></span>
00927 <span class="comment">    Kernel mode, APCs disabled, working set mutex held.</span>
00928 <span class="comment"></span>
00929 <span class="comment">--*/</span>
00930 
00931 {
00932     <a class="code" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a> WorkingSetIndex;
00933     PVOID VirtualAddress;
00934     <a class="code" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a> Entry;
00935     PVOID SwapVa;
00936     <a class="code" href="../../d4/d8/struct__MMWSLENTRY.html">MMWSLENTRY</a> Locked;
00937     <a class="code" href="../../d0/d8/struct__MMWSL.html">PMMWSL</a> WorkingSetList;
00938     <a class="code" href="../../d1/d8/struct__MMWSLE.html">PMMWSLE</a> Wsle;
00939     KIRQL OldIrql;
00940 
00941     WorkingSetList = WsInfo-&gt;VmWorkingSetList;
00942     Wsle = WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o5">Wsle</a>;
00943 
00944     VirtualAddress = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPte);
00945     WorkingSetIndex = <a class="code" href="../../d7/d0/wstree_8c.html#a7">MiLocateWsle</a> (VirtualAddress,
00946                                     WorkingSetList,
00947                                     Pfn1-&gt;u1.WsIndex);
00948 
00949     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (WorkingSetIndex != <a class="code" href="../../d4/d8/mi_8h.html#a10">WSLE_NULL_INDEX</a>);
00950     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00951     <a class="code" href="../../d4/d0/wslist_8c.html#a15">MiEliminateWorkingSetEntry</a> (WorkingSetIndex,
00952                                 PointerPte,
00953                                 Pfn1,
00954                                 Wsle);
00955 
00956     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00957 
00958     <span class="comment">//</span>
00959     <span class="comment">// Check to see if this entry is locked in the working set</span>
00960     <span class="comment">// or locked in memory.</span>
00961     <span class="comment">//</span>
00962 
00963     Locked = Wsle[WorkingSetIndex].<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1;
00964     <a class="code" href="../../d7/d0/wstree_8c.html#a8">MiRemoveWsle</a> (WorkingSetIndex, WorkingSetList);
00965 
00966     <span class="comment">//</span>
00967     <span class="comment">// Add this entry to the list of free working set entries</span>
00968     <span class="comment">// and adjust the working set count.</span>
00969     <span class="comment">//</span>
00970 
00971     <a class="code" href="../../d4/d0/wslist_8c.html#a24">MiReleaseWsle</a> ((<a class="code" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a>)WorkingSetIndex, WsInfo);
00972 
00973     <span class="keywordflow">if</span> ((Locked.<a class="code" href="../../d4/d8/struct__MMWSLENTRY.html#o1">LockedInWs</a> == 1) || (Locked.<a class="code" href="../../d4/d8/struct__MMWSLENTRY.html#o2">LockedInMemory</a> == 1)) {
00974 
00975         <span class="comment">//</span>
00976         <span class="comment">// This entry is locked.</span>
00977         <span class="comment">//</span>
00978 
00979         WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a> -= 1;
00980 
00981         <span class="keywordflow">if</span> (WorkingSetIndex != WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>) {
00982 
00983             SwapVa = Wsle[WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>].u1.VirtualAddress;
00984             SwapVa = <a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a> (SwapVa);
00985 
00986             PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (SwapVa);
00987             Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PointerPte-&gt;u.Hard.PageFrameNumber);
00988 <span class="preprocessor">#if 0</span>
00989 <span class="preprocessor"></span>            Entry = MiLocateWsleAndParent (SwapVa,
00990                                            &amp;Parent,
00991                                            WorkingSetList,
00992                                            Pfn1-&gt;u1.WsIndex);
00993 
00994             <span class="comment">//</span>
00995             <span class="comment">// Swap the removed entry with the last locked entry</span>
00996             <span class="comment">// which is located at first dynamic.</span>
00997             <span class="comment">//</span>
00998 
00999             <a class="code" href="../../d7/d0/wstree_8c.html#a9">MiSwapWslEntries</a> (Entry, Parent, WorkingSetIndex, WorkingSetList);
01000 <span class="preprocessor">#endif //0</span>
01001 <span class="preprocessor"></span>
01002             Entry = <a class="code" href="../../d7/d0/wstree_8c.html#a7">MiLocateWsle</a> (SwapVa, WorkingSetList, Pfn1-&gt;u1.WsIndex);
01003 
01004             <a class="code" href="../../d7/d0/wstree_8c.html#a9">MiSwapWslEntries</a> (Entry, WorkingSetIndex, WsInfo);
01005 
01006         }
01007         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01008     } <span class="keywordflow">else</span> {
01009         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (WorkingSetIndex &gt;= WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>);
01010     }
01011     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01012 }
01013 
01014 
01015 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01016"></a><a class="code" href="../../d4/d0/wslist_8c.html#a24">01016</a> <a class="code" href="../../d4/d0/wslist_8c.html#a24">MiReleaseWsle</a> (
01017     IN WSLE_NUMBER WorkingSetIndex,
01018     IN <a class="code" href="../../d3/d6/struct__MMSUPPORT.html">PMMSUPPORT</a> WsInfo
01019     )
01020 
01021 <span class="comment">/*++</span>
01022 <span class="comment"></span>
01023 <span class="comment">Routine Description:</span>
01024 <span class="comment"></span>
01025 <span class="comment">    This function releases a previously reserved working set entry to</span>
01026 <span class="comment">    be reused.  A release occurs when a page fault is retried due to</span>
01027 <span class="comment">    changes in PTEs and working sets during an I/O operation.</span>
01028 <span class="comment"></span>
01029 <span class="comment">Arguments:</span>
01030 <span class="comment"></span>
01031 <span class="comment">    WorkingSetIndex - Supplies the index of the working set entry to</span>
01032 <span class="comment">                      release.</span>
01033 <span class="comment"></span>
01034 <span class="comment">Return Value:</span>
01035 <span class="comment"></span>
01036 <span class="comment">    None.</span>
01037 <span class="comment"></span>
01038 <span class="comment">Environment:</span>
01039 <span class="comment"></span>
01040 <span class="comment">    Kernel mode, APCs disabled, working set lock held and PFN lock held.</span>
01041 <span class="comment"></span>
01042 <span class="comment">--*/</span>
01043 
01044 {
01045     <a class="code" href="../../d0/d8/struct__MMWSL.html">PMMWSL</a> WorkingSetList;
01046     <a class="code" href="../../d1/d8/struct__MMWSLE.html">PMMWSLE</a> Wsle;
01047 
01048     WorkingSetList = WsInfo-&gt;VmWorkingSetList;
01049     Wsle = WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o5">Wsle</a>;
01050 <span class="preprocessor">#if DBG</span>
01051 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (WsInfo == &amp;<a class="code" href="../../d6/d8/sysinfo_8c.html#a21">MmSystemCacheWs</a>) {
01052         <a class="code" href="../../d4/d8/mi_8h.html#a147">MM_SYSTEM_WS_LOCK_ASSERT</a>();
01053     }
01054 <span class="preprocessor">#endif //DBG</span>
01055 <span class="preprocessor"></span>
01056     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (WorkingSetIndex &lt;= WorkingSetList-&gt;LastInitializedWsle);
01057 
01058     <span class="comment">//</span>
01059     <span class="comment">// Put the entry on the free list and decrement the current</span>
01060     <span class="comment">// size.</span>
01061     <span class="comment">//</span>
01062 
01063     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o1">FirstFree</a> &lt;= WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o7">LastInitializedWsle</a>) ||
01064             (WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o1">FirstFree</a> == <a class="code" href="../../d4/d8/mi_8h.html#a10">WSLE_NULL_INDEX</a>));
01065     Wsle[WorkingSetIndex].<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.Long = WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o1">FirstFree</a> &lt;&lt; <a class="code" href="../../d4/d8/mi_8h.html#a9">MM_FREE_WSLE_SHIFT</a>;
01066     WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o1">FirstFree</a> = WorkingSetIndex;
01067     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o1">FirstFree</a> &lt;= WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o7">LastInitializedWsle</a>) ||
01068             (WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o1">FirstFree</a> == <a class="code" href="../../d4/d8/mi_8h.html#a10">WSLE_NULL_INDEX</a>));
01069     <span class="keywordflow">if</span> (WsInfo-&gt;WorkingSetSize &gt; WsInfo-&gt;MinimumWorkingSetSize) {
01070         <a class="code" href="../../d4/d8/mi_8h.html#a590">MmPagesAboveWsMinimum</a> -= 1;
01071     }
01072     WsInfo-&gt;WorkingSetSize -= 1;
01073     <span class="keywordflow">return</span>;
01074 
01075 }
01076 
01077 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01078"></a><a class="code" href="../../d4/d0/wslist_8c.html#a25">01078</a> <a class="code" href="../../d4/d0/wslist_8c.html#a25">MiUpdateWsle</a> (
01079     IN OUT <a class="code" href="../../d4/d8/mi_8h.html#a436">PWSLE_NUMBER</a> DesiredIndex,
01080     IN PVOID VirtualAddress,
01081     <a class="code" href="../../d0/d8/struct__MMWSL.html">PMMWSL</a> WorkingSetList,
01082     IN <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn
01083     )
01084 
01085 <span class="comment">/*++</span>
01086 <span class="comment"></span>
01087 <span class="comment">Routine Description:</span>
01088 <span class="comment"></span>
01089 <span class="comment">    This routine updates a reserved working set entry to place it into</span>
01090 <span class="comment">    the valid state.</span>
01091 <span class="comment"></span>
01092 <span class="comment">Arguments:</span>
01093 <span class="comment"></span>
01094 <span class="comment">    DesiredIndex - Supplies the index of the working set entry to update.</span>
01095 <span class="comment"></span>
01096 <span class="comment">    VirtualAddress - Supplies the virtual address which the working set</span>
01097 <span class="comment">                     entry maps.</span>
01098 <span class="comment"></span>
01099 <span class="comment">    WsInfo - Supplies a pointer to the working set info block for the</span>
01100 <span class="comment">             process (or system cache).</span>
01101 <span class="comment"></span>
01102 <span class="comment">    Pfn - Supplies a pointer to the PFN element for the page.</span>
01103 <span class="comment"></span>
01104 <span class="comment">Return Value:</span>
01105 <span class="comment"></span>
01106 <span class="comment">    None.</span>
01107 <span class="comment"></span>
01108 <span class="comment">Environment:</span>
01109 <span class="comment"></span>
01110 <span class="comment">    Kernel mode, APCs disabled, working set lock held and PFN lock held.</span>
01111 <span class="comment"></span>
01112 <span class="comment">--*/</span>
01113 
01114 {
01115     <a class="code" href="../../d1/d8/struct__MMWSLE.html">PMMWSLE</a> Wsle;
01116     <a class="code" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
01117     <a class="code" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a> WorkingSetIndex;
01118 <span class="preprocessor">#if PFN_CONSISTENCY</span>
01119 <span class="preprocessor"></span>    KIRQL OldIrql;
01120 <span class="preprocessor">#endif</span>
01121 <span class="preprocessor"></span>
01122     WorkingSetIndex = *DesiredIndex;
01123     Wsle = WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o5">Wsle</a>;
01124 
01125     <span class="keywordflow">if</span> (WorkingSetList == <a class="code" href="../../d4/d8/mi_8h.html#a657">MmSystemCacheWorkingSetList</a>) {
01126 
01127         <span class="comment">//</span>
01128         <span class="comment">// This assert doesn't hold for NT64 as we can be adding page</span>
01129         <span class="comment">// directories and page tables for the system cache WSLE hash tables.</span>
01130         <span class="comment">//</span>
01131 
01132         <a class="code" href="../../d4/d8/mi_8h.html#a0">ASSERT32</a> ((VirtualAddress &lt; (PVOID)PTE_BASE) ||
01133                   (VirtualAddress &gt;= (PVOID)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a11">MM_SYSTEM_SPACE_START</a>));
01134     } <span class="keywordflow">else</span> {
01135         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((VirtualAddress &lt; (PVOID)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a11">MM_SYSTEM_SPACE_START</a>) ||
01136                (<a class="code" href="../../d4/d8/mi_8h.html#a354">MI_IS_SESSION_ADDRESS</a> (VirtualAddress)));
01137     }
01138 
01139     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (WorkingSetIndex &gt;= WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>);
01140 
01141     <span class="keywordflow">if</span> (WorkingSetList == <a class="code" href="../../d4/d8/mi_8h.html#a657">MmSystemCacheWorkingSetList</a>) {
01142 
01143         <a class="code" href="../../d4/d8/mi_8h.html#a147">MM_SYSTEM_WS_LOCK_ASSERT</a>();
01144 
01145         <span class="comment">//</span>
01146         <span class="comment">// count system space inserts and removals.</span>
01147         <span class="comment">//</span>
01148 
01149 <span class="preprocessor">#if defined(_X86_)</span>
01150 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a196">MI_IS_SYSTEM_CACHE_ADDRESS</a>(VirtualAddress)) {
01151             <a class="code" href="../../d6/d8/sysinfo_8c.html#a10">MmSystemCachePage</a> += 1;
01152         } <span class="keywordflow">else</span>
01153 <span class="preprocessor">#endif</span>
01154 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (VirtualAddress &lt; <a class="code" href="../../d8/d5/kddata_8c.html#a11">MmSystemCacheStart</a>) {
01155             <a class="code" href="../../d6/d8/sysinfo_8c.html#a9">MmSystemCodePage</a> += 1;
01156         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (VirtualAddress &lt; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a21">MM_PAGED_POOL_START</a>) {
01157             <a class="code" href="../../d6/d8/sysinfo_8c.html#a10">MmSystemCachePage</a> += 1;
01158         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (VirtualAddress &lt; <a class="code" href="../../d8/d5/kddata_8c.html#a22">MmNonPagedSystemStart</a>) {
01159             <a class="code" href="../../d6/d8/sysinfo_8c.html#a11">MmPagedPoolPage</a> += 1;
01160         } <span class="keywordflow">else</span> {
01161             <a class="code" href="../../d6/d8/sysinfo_8c.html#a12">MmSystemDriverPage</a> += 1;
01162         }
01163     }
01164 
01165     <span class="comment">//</span>
01166     <span class="comment">// Make the wsle valid, referring to the corresponding virtual</span>
01167     <span class="comment">// page number.</span>
01168     <span class="comment">//</span>
01169 
01170     <span class="comment">//</span>
01171     <span class="comment">// The value 0 is invalid.  This is due to the fact that the working</span>
01172     <span class="comment">// set lock is a process wide lock and two threads in different</span>
01173     <span class="comment">// processes could be adding the same physical page to their working</span>
01174     <span class="comment">// sets.  Each one could see the WsIndex field in the PFN as 0, and</span>
01175     <span class="comment">// set the direct bit.  To solve this, the WsIndex field is set to</span>
01176     <span class="comment">// the current thread pointer.</span>
01177     <span class="comment">//</span>
01178 
01179     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn-&gt;u1.WsIndex != 0);
01180 
01181 <span class="preprocessor">#if DBG</span>
01182 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (Pfn-&gt;u1.WsIndex &lt;= WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o7">LastInitializedWsle</a>) {
01183         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((<a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a>(VirtualAddress) !=
01184                 <a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a>(Wsle[Pfn-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.WsIndex].u1.VirtualAddress)) ||
01185                 (Wsle[Pfn-&gt;u1.WsIndex].u1.e1.Valid == 0));
01186     }
01187 <span class="preprocessor">#endif //DBG</span>
01188 <span class="preprocessor"></span>
01189     Wsle[WorkingSetIndex].<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.VirtualAddress = VirtualAddress;
01190     Wsle[WorkingSetIndex].<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.Long &amp;= ~(<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1);
01191     Wsle[WorkingSetIndex].<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Valid = 1;
01192 
01193     <span class="keywordflow">if</span> ((ULONG_PTR)Pfn-&gt;u1.Event == (ULONG_PTR)<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()) {
01194 
01195         <span class="comment">//</span>
01196         <span class="comment">// Directly index into the WSL for this entry via the PFN database</span>
01197         <span class="comment">// element.</span>
01198         <span class="comment">//</span>
01199 
01200         <a class="code" href="../../d4/d8/mi_8h.html#a121">CONSISTENCY_LOCK_PFN</a> (OldIrql);
01201 
01202 <span class="preprocessor">#if defined(_WIN64)</span>
01203 <span class="preprocessor"></span>
01204         <span class="comment">//</span>
01205         <span class="comment">// The entire working set index union must be zeroed on Win64 systems.</span>
01206         <span class="comment">//</span>
01207 
01208         <a class="code" href="../../d4/d8/mi_8h.html#a190">MI_ZERO_WSINDEX</a> (Pfn);
01209 
01210 <span class="preprocessor">#endif</span>
01211 <span class="preprocessor"></span>
01212         Pfn-&gt;u1.WsIndex = WorkingSetIndex;
01213 
01214         <a class="code" href="../../d4/d8/mi_8h.html#a122">CONSISTENCY_UNLOCK_PFN</a> (OldIrql);
01215 
01216         Wsle[WorkingSetIndex].<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Direct = 1;
01217 
01218         <span class="keywordflow">return</span>;
01219 
01220     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o9">HashTable</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01221 
01222         <span class="comment">//</span>
01223         <span class="comment">// Try to insert at WsIndex.</span>
01224         <span class="comment">//</span>
01225 
01226         <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = Pfn-&gt;u1.WsIndex;
01227 
01228         <span class="keywordflow">if</span> ((<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o7">LastInitializedWsle</a>) &amp;&amp;
01229             (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &gt; WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>) &amp;&amp;
01230             (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> != WorkingSetIndex)) {
01231 
01232             <span class="keywordflow">if</span> (Wsle[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Valid) {
01233 
01234                 <span class="keywordflow">if</span> (Wsle[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Direct) {
01235 
01236                     <span class="comment">//</span>
01237                     <span class="comment">// Only move direct indexed entries.</span>
01238                     <span class="comment">//</span>
01239 
01240                     <a class="code" href="../../d3/d6/struct__MMSUPPORT.html">PMMSUPPORT</a> WsInfo;
01241 
01242                     <span class="keywordflow">if</span> (Wsle == <a class="code" href="../../d4/d8/mi_8h.html#a673">MmWsle</a>) {
01243                         WsInfo = &amp;<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;Vm;
01244                     }
01245                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Wsle == <a class="code" href="../../d4/d8/mi_8h.html#a658">MmSystemCacheWsle</a>) {
01246                         WsInfo = &amp;<a class="code" href="../../d6/d8/sysinfo_8c.html#a21">MmSystemCacheWs</a>;
01247                     }
01248                     <span class="keywordflow">else</span> {
01249                         WsInfo = &amp;<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>;
01250                     }
01251 
01252                     <a class="code" href="../../d7/d0/wstree_8c.html#a9">MiSwapWslEntries</a> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>, WorkingSetIndex, WsInfo);
01253                     WorkingSetIndex = <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
01254                 }
01255             } <span class="keywordflow">else</span> {
01256 
01257                 <span class="comment">//</span>
01258                 <span class="comment">// On free list, try to remove quickly without walking</span>
01259                 <span class="comment">// all the free pages.</span>
01260                 <span class="comment">//</span>
01261 
01262                 ULONG FreeIndex;
01263                 <a class="code" href="../../d1/d8/struct__MMWSLE.html">MMWSLE</a> Temp;
01264 
01265                 FreeIndex = 0;
01266 
01267                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o1">FirstFree</a> &gt;= WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>);
01268                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (WorkingSetIndex &gt;= WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>);
01269 
01270                 <span class="keywordflow">if</span> (WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o1">FirstFree</a> == <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>) {
01271                     WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o1">FirstFree</a> = WorkingSetIndex;
01272                     Temp = Wsle[WorkingSetIndex];
01273                     Wsle[WorkingSetIndex] = Wsle[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>];
01274                     Wsle[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>] = Temp;
01275                     WorkingSetIndex = <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
01276                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (((Wsle[WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o1">FirstFree</a>].u1.Long &gt;&gt; <a class="code" href="../../d4/d8/mi_8h.html#a9">MM_FREE_WSLE_SHIFT</a>)
01277                                      &lt;= WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o7">LastInitializedWsle</a>) ||
01278                             ((Wsle[WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o1">FirstFree</a>].u1.Long &gt;&gt; <a class="code" href="../../d4/d8/mi_8h.html#a9">MM_FREE_WSLE_SHIFT</a>)
01279                                     == <a class="code" href="../../d4/d8/mi_8h.html#a10">WSLE_NULL_INDEX</a>));
01280                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Wsle[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> - 1].<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Valid == 0) {
01281                     <span class="keywordflow">if</span> ((Wsle[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> - 1].<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.Long &gt;&gt; <a class="code" href="../../d4/d8/mi_8h.html#a9">MM_FREE_WSLE_SHIFT</a>) == <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>) {
01282                         FreeIndex = <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> - 1;
01283                     }
01284                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Wsle[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> + 1].<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Valid == 0) {
01285                     <span class="keywordflow">if</span> ((Wsle[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> + 1].<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.Long &gt;&gt; <a class="code" href="../../d4/d8/mi_8h.html#a9">MM_FREE_WSLE_SHIFT</a>) == <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>) {
01286                         FreeIndex = <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> + 1;
01287                     }
01288                 }
01289                 <span class="keywordflow">if</span> (FreeIndex != 0) {
01290 
01291                     <span class="comment">//</span>
01292                     <span class="comment">// Link the Wsle into the free list.</span>
01293                     <span class="comment">//</span>
01294 
01295                     Temp = Wsle[WorkingSetIndex];
01296                     Wsle[FreeIndex].<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.Long = WorkingSetIndex &lt;&lt; <a class="code" href="../../d4/d8/mi_8h.html#a9">MM_FREE_WSLE_SHIFT</a>;
01297                     Wsle[WorkingSetIndex] = Wsle[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>];
01298                     Wsle[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>] = Temp;
01299                     WorkingSetIndex = <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
01300 
01301                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (((Wsle[FreeIndex].u1.Long &gt;&gt; <a class="code" href="../../d4/d8/mi_8h.html#a9">MM_FREE_WSLE_SHIFT</a>)
01302                                      &lt;= WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o7">LastInitializedWsle</a>) ||
01303                             ((Wsle[FreeIndex].u1.Long &gt;&gt; <a class="code" href="../../d4/d8/mi_8h.html#a9">MM_FREE_WSLE_SHIFT</a>)
01304                                     == <a class="code" href="../../d4/d8/mi_8h.html#a10">WSLE_NULL_INDEX</a>));
01305                 }
01306 
01307             }
01308             *DesiredIndex = WorkingSetIndex;
01309 
01310             <span class="keywordflow">if</span> (WorkingSetIndex &gt; WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o3">LastEntry</a>) {
01311                 WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o3">LastEntry</a> = WorkingSetIndex;
01312             }
01313         }
01314     }
01315 
01316     <span class="comment">//</span>
01317     <span class="comment">// Insert the valid WSLE into the working set list.</span>
01318     <span class="comment">//</span>
01319 
01320     <a class="code" href="../../d7/d0/wstree_8c.html#a6">MiInsertWsle</a> (WorkingSetIndex, WorkingSetList);
01321     <span class="keywordflow">return</span>;
01322 }
01323 
01324 
01325 ULONG
<a name="l01326"></a><a class="code" href="../../d4/d0/wslist_8c.html#a26">01326</a> <a class="code" href="../../d4/d0/wslist_8c.html#a26">MiFreeWsle</a> (
01327     IN WSLE_NUMBER WorkingSetIndex,
01328     IN <a class="code" href="../../d3/d6/struct__MMSUPPORT.html">PMMSUPPORT</a> WsInfo,
01329     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte
01330     )
01331 
01332 <span class="comment">/*++</span>
01333 <span class="comment"></span>
01334 <span class="comment">Routine Description:</span>
01335 <span class="comment"></span>
01336 <span class="comment">    This routine frees the specified WSLE and decrements the share</span>
01337 <span class="comment">    count for the corresponding page, putting the PTE into a transition</span>
01338 <span class="comment">    state if the share count goes to 0.</span>
01339 <span class="comment"></span>
01340 <span class="comment">Arguments:</span>
01341 <span class="comment"></span>
01342 <span class="comment">    WorkingSetIndex - Supplies the index of the working set entry to free.</span>
01343 <span class="comment"></span>
01344 <span class="comment">    WsInfo - Supplies a pointer to the working set structure (process or</span>
01345 <span class="comment">             system cache).</span>
01346 <span class="comment"></span>
01347 <span class="comment">    PointerPte - Supplies a pointer to the PTE for the working set entry.</span>
01348 <span class="comment"></span>
01349 <span class="comment">Return Value:</span>
01350 <span class="comment"></span>
01351 <span class="comment">    Returns TRUE if the WSLE was removed, FALSE if it was not removed.</span>
01352 <span class="comment">        Pages with valid PTEs are not removed (i.e. page table pages</span>
01353 <span class="comment">        that contain valid or transition PTEs).</span>
01354 <span class="comment"></span>
01355 <span class="comment">Environment:</span>
01356 <span class="comment"></span>
01357 <span class="comment">    Kernel mode, APCs disabled, working set lock.  PFN lock NOT held.</span>
01358 <span class="comment"></span>
01359 <span class="comment">--*/</span>
01360 
01361 {
01362     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
01363     <a class="code" href="../../d0/d8/struct__MMWSL.html">PMMWSL</a> WorkingSetList;
01364     <a class="code" href="../../d1/d8/struct__MMWSLE.html">PMMWSLE</a> Wsle;
01365     KIRQL OldIrql;
01366 
01367     WorkingSetList = WsInfo-&gt;VmWorkingSetList;
01368     Wsle = WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o5">Wsle</a>;
01369 
01370 <span class="preprocessor">#if DBG</span>
01371 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (WsInfo == &amp;<a class="code" href="../../d6/d8/sysinfo_8c.html#a21">MmSystemCacheWs</a>) {
01372         <a class="code" href="../../d4/d8/mi_8h.html#a147">MM_SYSTEM_WS_LOCK_ASSERT</a>();
01373     }
01374 <span class="preprocessor">#endif //DBG</span>
01375 <span class="preprocessor"></span>
01376     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Wsle[WorkingSetIndex].u1.<a class="code" href="../../d1/d8/struct__MMWSLE.html#o2">e1</a>.<a class="code" href="../../d4/d8/struct__MMWSLENTRY.html#o0">Valid</a> == 1);
01377 
01378     <span class="comment">//</span>
01379     <span class="comment">// Check to see if the located entry is eligible for removal.</span>
01380     <span class="comment">//</span>
01381 
01382     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte-&gt;u.Hard.Valid == 1);
01383 
01384     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (WorkingSetIndex &gt;= WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>);
01385 
01386     <span class="comment">//</span>
01387     <span class="comment">// Check to see if this is a page table with valid PTEs.</span>
01388     <span class="comment">//</span>
01389     <span class="comment">// Note, don't clear the access bit for page table pages</span>
01390     <span class="comment">// with valid PTEs as this could cause an access trap fault which</span>
01391     <span class="comment">// would not be handled (it is only handled for PTEs not PDEs).</span>
01392     <span class="comment">//</span>
01393 
01394     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PointerPte-&gt;u.Hard.PageFrameNumber);
01395 
01396     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
01397 
01398     <span class="comment">//</span>
01399     <span class="comment">// If the PTE is a page table page with non-zero share count or</span>
01400     <span class="comment">// within the system cache with its reference count greater</span>
01401     <span class="comment">// than 0, don't remove it.</span>
01402     <span class="comment">//</span>
01403 
01404     <span class="keywordflow">if</span> (WsInfo == &amp;<a class="code" href="../../d6/d8/sysinfo_8c.html#a21">MmSystemCacheWs</a>) {
01405         <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount &gt; 1) {
01406             <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
01407             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01408         }
01409     } <span class="keywordflow">else</span> {
01410         <span class="keywordflow">if</span> ((Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount &gt; 1) &amp;&amp;
01411             (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PrototypePte == 0)) {
01412 
01413 <span class="preprocessor">#if DBG</span>
01414 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (WsInfo-&gt;u.Flags.SessionSpace == 1) {
01415                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a354">MI_IS_SESSION_ADDRESS</a> (Wsle[WorkingSetIndex].u1.<a class="code" href="../../d1/d8/struct__MMWSLE.html#o0">VirtualAddress</a>));
01416             }
01417             <span class="keywordflow">else</span> {
01418                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((Wsle[WorkingSetIndex].u1.<a class="code" href="../../d1/d8/struct__MMWSLE.html#o0">VirtualAddress</a> &gt;= (PVOID)PTE_BASE) &amp;&amp;
01419                  (Wsle[WorkingSetIndex].<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.VirtualAddress&lt;= (PVOID)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a5">PDE_TOP</a>));
01420             }
01421 <span class="preprocessor">#endif</span>
01422 <span class="preprocessor"></span>
01423             <span class="comment">//</span>
01424             <span class="comment">// Don't remove page table pages from the working set until</span>
01425             <span class="comment">// all transition pages have exited.</span>
01426             <span class="comment">//</span>
01427 
01428             <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
01429             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01430         }
01431     }
01432 
01433     <span class="comment">//</span>
01434     <span class="comment">// Found a candidate, remove the page from the working set.</span>
01435     <span class="comment">//</span>
01436 
01437     <a class="code" href="../../d4/d0/wslist_8c.html#a15">MiEliminateWorkingSetEntry</a> (WorkingSetIndex,
01438                                 PointerPte,
01439                                 Pfn1,
01440                                 Wsle);
01441 
01442     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
01443 
01444     <span class="comment">//</span>
01445     <span class="comment">// Remove the working set entry from the working set.</span>
01446     <span class="comment">//</span>
01447 
01448     <a class="code" href="../../d7/d0/wstree_8c.html#a8">MiRemoveWsle</a> (WorkingSetIndex, WorkingSetList);
01449 
01450     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o1">FirstFree</a> &gt;= WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>);
01451 
01452     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (WorkingSetIndex &gt;= WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>);
01453 
01454     <span class="comment">//</span>
01455     <span class="comment">// Put the entry on the free list and decrement the current</span>
01456     <span class="comment">// size.</span>
01457     <span class="comment">//</span>
01458 
01459     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o1">FirstFree</a> &lt;= WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o7">LastInitializedWsle</a>) ||
01460             (WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o1">FirstFree</a> == <a class="code" href="../../d4/d8/mi_8h.html#a10">WSLE_NULL_INDEX</a>));
01461     Wsle[WorkingSetIndex].<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.Long = WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o1">FirstFree</a> &lt;&lt; <a class="code" href="../../d4/d8/mi_8h.html#a9">MM_FREE_WSLE_SHIFT</a>;
01462     WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o1">FirstFree</a> = WorkingSetIndex;
01463     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o1">FirstFree</a> &lt;= WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o7">LastInitializedWsle</a>) ||
01464             (WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o1">FirstFree</a> == <a class="code" href="../../d4/d8/mi_8h.html#a10">WSLE_NULL_INDEX</a>));
01465 
01466     <span class="keywordflow">if</span> (WsInfo-&gt;WorkingSetSize &gt; WsInfo-&gt;MinimumWorkingSetSize) {
01467         <a class="code" href="../../d4/d8/mi_8h.html#a590">MmPagesAboveWsMinimum</a> -= 1;
01468     }
01469     WsInfo-&gt;WorkingSetSize -= 1;
01470 
01471 <span class="preprocessor">#if 0</span>
01472 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ((WsInfo == &amp;<a class="code" href="../../d6/d8/sysinfo_8c.html#a21">MmSystemCacheWs</a>) &amp;&amp;
01473        (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.Modified == 1))  {
01474         <a class="code" href="../../d4/d0/wslist_8c.html#a19">MiDumpWsleInCacheBlock</a> (PointerPte);
01475     }
01476 <span class="preprocessor">#endif //0</span>
01477 <span class="preprocessor"></span>    <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01478 }
01479 
01480 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01481"></a><a class="code" href="../../d4/d0/wslist_8c.html#a27">01481</a> <a class="code" href="../../d4/d0/wslist_8c.html#a27">MiInitializeWorkingSetList</a> (
01482     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> CurrentProcess
01483     )
01484 
01485 <span class="comment">/*++</span>
01486 <span class="comment"></span>
01487 <span class="comment">Routine Description:</span>
01488 <span class="comment"></span>
01489 <span class="comment">    This routine initializes a process's working set to the empty</span>
01490 <span class="comment">    state.</span>
01491 <span class="comment"></span>
01492 <span class="comment">Arguments:</span>
01493 <span class="comment"></span>
01494 <span class="comment">    CurrentProcess - Supplies a pointer to the process to initialize.</span>
01495 <span class="comment"></span>
01496 <span class="comment">Return Value:</span>
01497 <span class="comment"></span>
01498 <span class="comment">    None.</span>
01499 <span class="comment"></span>
01500 <span class="comment">Environment:</span>
01501 <span class="comment"></span>
01502 <span class="comment">    Kernel mode, APCs disabled.</span>
01503 <span class="comment"></span>
01504 <span class="comment">--*/</span>
01505 
01506 {
01507     ULONG i;
01508     <a class="code" href="../../d1/d8/struct__MMWSLE.html">PMMWSLE</a> WslEntry;
01509     ULONG CurrentEntry;
01510     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
01511     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
01512     <a class="code" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a> NumberOfEntriesMapped;
01513     ULONG_PTR CurrentVa;
01514     PFN_NUMBER WorkingSetPage;
01515     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
01516     KIRQL OldIrql;
01517 
01518     WslEntry = <a class="code" href="../../d4/d8/mi_8h.html#a673">MmWsle</a>;
01519 
01520     <span class="comment">//</span>
01521     <span class="comment">// Initialize the temporary double mapping portion of hyperspace, if</span>
01522     <span class="comment">// it has not already been done.</span>
01523     <span class="comment">//</span>
01524     <span class="comment">// Initialize the working set list control cells.</span>
01525     <span class="comment">//</span>
01526 
01527     <a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o3">LastEntry</a> = CurrentProcess-&gt;Vm.MinimumWorkingSetSize;
01528     <a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o0">Quota</a> = <a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o3">LastEntry</a>;
01529     <a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o11">WaitingForImageMapping</a> = (<a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01530     <a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o9">HashTable</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01531     <a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o10">HashTableSize</a> = 0;
01532     <a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o5">Wsle</a> = <a class="code" href="../../d4/d8/mi_8h.html#a673">MmWsle</a>;
01533     <a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o12">HashTableStart</a> = 
01534        (PVOID)((PCHAR)<a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a> (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a673">MmWsle</a>[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a70">MM_MAXIMUM_WORKING_SET</a>]) + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
01535 
01536     <a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o13">HighestPermittedHashAddress</a> = (PVOID)(<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a26">HYPER_SPACE_END</a> + 1);
01537 
01538     <span class="comment">//</span>
01539     <span class="comment">// Fill in the reserved slots.  Start with the page directory page.</span>
01540     <span class="comment">//</span>
01541 
01542 <span class="preprocessor">#if !defined (_X86PAE_)</span>
01543 <span class="preprocessor"></span>
01544     WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.Long = PDE_BASE;
01545     WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Valid = 1;
01546     WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.LockedInWs = 1;
01547     WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Direct = 1;
01548 
01549     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.VirtualAddress);
01550     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber);
01551 
01552     <a class="code" href="../../d4/d8/mi_8h.html#a121">CONSISTENCY_LOCK_PFN</a> (OldIrql);
01553 
01554 <span class="preprocessor">#if !defined (_WIN64)</span>
01555 <span class="preprocessor"></span>    Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Event = (PVOID)CurrentProcess;
01556 <span class="preprocessor">#endif</span>
01557 <span class="preprocessor"></span>
01558     <a class="code" href="../../d4/d8/mi_8h.html#a122">CONSISTENCY_UNLOCK_PFN</a> (OldIrql);
01559 
01560 <span class="preprocessor">#else</span>
01561 <span class="preprocessor"></span>
01562     <span class="comment">//</span>
01563     <span class="comment">// Fill in all the page directory entries.</span>
01564     <span class="comment">//</span>
01565 
01566     <span class="keywordflow">for</span> (i = 0; i &lt; PD_PER_SYSTEM; i += 1) {
01567 
01568         WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.VirtualAddress = (PVOID)(PDE_BASE + i * <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
01569         WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Valid = 1;
01570         WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.LockedInWs = 1;
01571         WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Direct = 1;
01572 
01573         PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.VirtualAddress);
01574         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber);
01575     
01576         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.WsIndex == 0);
01577     
01578         <a class="code" href="../../d4/d8/mi_8h.html#a121">CONSISTENCY_LOCK_PFN</a> (OldIrql);
01579     
01580         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.WsIndex = (<a class="code" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a>)(WslEntry - <a class="code" href="../../d4/d8/mi_8h.html#a673">MmWsle</a>);
01581     
01582         <a class="code" href="../../d4/d8/mi_8h.html#a122">CONSISTENCY_UNLOCK_PFN</a> (OldIrql);
01583 
01584         WslEntry += 1;
01585     }
01586     WslEntry -= 1;
01587 
01588 <span class="preprocessor">#endif</span>
01589 <span class="preprocessor"></span>
01590 
01591 <span class="preprocessor">#if defined (_WIN64)</span>
01592 <span class="preprocessor"></span>
01593     <span class="comment">//</span>
01594     <span class="comment">// Fill in the entry for the page directory parent page.</span>
01595     <span class="comment">//</span>
01596 
01597     WslEntry += 1;
01598 
01599     WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.Long = PDE_TBASE;
01600     WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Valid = 1;
01601     WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.LockedInWs = 1;
01602     WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Direct = 1;
01603 
01604     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.VirtualAddress);
01605     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber);
01606 
01607     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.WsIndex == 0);
01608 
01609     <a class="code" href="../../d4/d8/mi_8h.html#a121">CONSISTENCY_LOCK_PFN</a> (OldIrql);
01610 
01611     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.WsIndex = (<a class="code" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a>)(WslEntry - <a class="code" href="../../d4/d8/mi_8h.html#a673">MmWsle</a>);
01612 
01613     <a class="code" href="../../d4/d8/mi_8h.html#a122">CONSISTENCY_UNLOCK_PFN</a> (OldIrql);
01614 
01615     <span class="comment">//</span>
01616     <span class="comment">// Fill in the entry for the hyper space page directory page.</span>
01617     <span class="comment">//</span>
01618 
01619     WslEntry += 1;
01620 
01621     WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.VirtualAddress = (PVOID)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a63">HYPER_SPACE</a>);
01622     WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Valid = 1;
01623     WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.LockedInWs = 1;
01624     WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Direct = 1;
01625 
01626     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.VirtualAddress);
01627     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber);
01628 
01629     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.WsIndex == 0);
01630 
01631     <a class="code" href="../../d4/d8/mi_8h.html#a121">CONSISTENCY_LOCK_PFN</a> (OldIrql);
01632 
01633     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.WsIndex = (<a class="code" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a>)(WslEntry - <a class="code" href="../../d4/d8/mi_8h.html#a673">MmWsle</a>);
01634 
01635     <a class="code" href="../../d4/d8/mi_8h.html#a122">CONSISTENCY_UNLOCK_PFN</a> (OldIrql);
01636 
01637 <span class="preprocessor">#if defined (_IA64_)</span>
01638 <span class="preprocessor"></span>
01639     <span class="comment">//</span>
01640     <span class="comment">// Fill in the entry for the session space page directory parent page.</span>
01641     <span class="comment">//</span>
01642 
01643     WslEntry += 1;
01644 
01645     WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.VirtualAddress = (PVOID)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a150">MiGetPpeAddress</a> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a14">MM_SESSION_SPACE_DEFAULT</a>);
01646     WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Valid = 1;
01647     WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.LockedInWs = 1;
01648     WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Direct = 1;
01649 
01650     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.VirtualAddress);
01651     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber);
01652 
01653     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.WsIndex == 0);
01654 
01655     <a class="code" href="../../d4/d8/mi_8h.html#a121">CONSISTENCY_LOCK_PFN</a> (OldIrql);
01656 
01657     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.WsIndex = (<a class="code" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a>)(WslEntry - <a class="code" href="../../d4/d8/mi_8h.html#a673">MmWsle</a>);
01658 
01659     <a class="code" href="../../d4/d8/mi_8h.html#a122">CONSISTENCY_UNLOCK_PFN</a> (OldIrql);
01660     
01661 <span class="preprocessor">#endif</span>
01662 <span class="preprocessor"></span>
01663 <span class="preprocessor">#endif</span>
01664 <span class="preprocessor"></span>
01665     <span class="comment">//</span>
01666     <span class="comment">// Fill in the entry for the page table page which maps hyper space.</span>
01667     <span class="comment">//</span>
01668 
01669     WslEntry += 1;
01670 
01671     WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.VirtualAddress = (PVOID)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a63">HYPER_SPACE</a>);
01672     WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Valid = 1;
01673     WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.LockedInWs = 1;
01674     WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Direct = 1;
01675 
01676     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.VirtualAddress);
01677     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber);
01678 
01679     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.WsIndex == 0);
01680 
01681     <a class="code" href="../../d4/d8/mi_8h.html#a121">CONSISTENCY_LOCK_PFN</a> (OldIrql);
01682 
01683     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.WsIndex = (<a class="code" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a>)(WslEntry - <a class="code" href="../../d4/d8/mi_8h.html#a673">MmWsle</a>);
01684 
01685     <a class="code" href="../../d4/d8/mi_8h.html#a122">CONSISTENCY_UNLOCK_PFN</a> (OldIrql);
01686 
01687 <span class="preprocessor">#if defined (_X86PAE_)</span>
01688 <span class="preprocessor"></span>
01689     <span class="comment">//</span>
01690     <span class="comment">// Fill in the entry for the second page table page which maps hyper space.</span>
01691     <span class="comment">//</span>
01692 
01693     WslEntry += 1;
01694 
01695     WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.VirtualAddress = (PVOID)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (HYPER_SPACE2);
01696     WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Valid = 1;
01697     WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.LockedInWs = 1;
01698     WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Direct = 1;
01699 
01700     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.VirtualAddress);
01701     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber);
01702 
01703     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.WsIndex == 0);
01704 
01705     <a class="code" href="../../d4/d8/mi_8h.html#a121">CONSISTENCY_LOCK_PFN</a> (OldIrql);
01706 
01707     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.WsIndex = (<a class="code" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a>)(WslEntry - <a class="code" href="../../d4/d8/mi_8h.html#a673">MmWsle</a>);
01708 
01709     <a class="code" href="../../d4/d8/mi_8h.html#a122">CONSISTENCY_UNLOCK_PFN</a> (OldIrql);
01710 
01711 <span class="preprocessor">#endif</span>
01712 <span class="preprocessor"></span>
01713     <span class="comment">//</span>
01714     <span class="comment">// Fill in the entry for the page which contains the working set list.</span>
01715     <span class="comment">//</span>
01716 
01717     WslEntry += 1;
01718 
01719     WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.VirtualAddress = (PVOID)<a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>;
01720     WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Valid = 1;
01721     WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.LockedInWs = 1;
01722     WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Direct = 1;
01723 
01724     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.VirtualAddress);
01725     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber);
01726 
01727     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.WsIndex == 0);
01728 
01729     <a class="code" href="../../d4/d8/mi_8h.html#a121">CONSISTENCY_LOCK_PFN</a> (OldIrql);
01730 
01731     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.WsIndex = (<a class="code" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a>)(WslEntry - <a class="code" href="../../d4/d8/mi_8h.html#a673">MmWsle</a>);
01732 
01733     <a class="code" href="../../d4/d8/mi_8h.html#a122">CONSISTENCY_UNLOCK_PFN</a> (OldIrql);
01734 
01735     CurrentEntry = (<a class="code" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a>)((WslEntry - <a class="code" href="../../d4/d8/mi_8h.html#a673">MmWsle</a>) + 1);
01736 
01737     <span class="comment">//</span>
01738     <span class="comment">// Check to see if more pages are required in the working set list</span>
01739     <span class="comment">// to map the current maximum working set size.</span>
01740     <span class="comment">//</span>
01741 
01742     NumberOfEntriesMapped = (<a class="code" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a>)(((<a class="code" href="../../d1/d8/struct__MMWSLE.html">PMMWSLE</a>)((PCHAR)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a69">WORKING_SET_LIST</a> + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>)) -
01743                                 <a class="code" href="../../d4/d8/mi_8h.html#a673">MmWsle</a>);
01744 
01745     <span class="keywordflow">if</span> (CurrentProcess-&gt;Vm.MaximumWorkingSetSize &gt;= NumberOfEntriesMapped) {
01746 
01747         PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a673">MmWsle</a>[0]);
01748 
01749         CurrentVa = (ULONG_PTR)<a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a> + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
01750 
01751         <span class="comment">//</span>
01752         <span class="comment">// The working set requires more than a single page.</span>
01753         <span class="comment">//</span>
01754 
01755         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
01756 
01757         <span class="keywordflow">do</span> {
01758 
01759             <a class="code" href="../../d7/d5/pfnlist_8c.html#a13">MiEnsureAvailablePageOrWait</a> (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01760 
01761             PointerPte += 1;
01762             WorkingSetPage = <a class="code" href="../../d7/d5/pfnlist_8c.html#a14">MiRemoveZeroPage</a> (
01763                                     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a127">MI_PAGE_COLOR_PTE_PROCESS</a> (PointerPte,
01764                                               &amp;CurrentProcess-&gt;NextPageColor));
01765             PointerPte-&gt;u.Long = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a95">MM_DEMAND_ZERO_WRITE_PTE</a>;
01766 
01767             <a class="code" href="../../d8/d2/pagfault_8c.html#a22">MiInitializePfn</a> (WorkingSetPage, PointerPte, 1);
01768 
01769             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a105">MI_MAKE_VALID_PTE</a> (TempPte,
01770                                WorkingSetPage,
01771                                <a class="code" href="../../d4/d8/mi_8h.html#a39">MM_READWRITE</a>,
01772                                PointerPte );
01773 
01774             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a112">MI_SET_PTE_DIRTY</a> (TempPte);
01775 
01776             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a109">MI_SET_PTE_IN_WORKING_SET</a> (&amp;TempPte, CurrentEntry);
01777 
01778             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a> (PointerPte, TempPte);
01779 
01780             WslEntry += 1;
01781 
01782             WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.Long = CurrentVa;
01783             WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Valid = 1;
01784             WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.LockedInWs = 1;
01785             WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Direct = 1;
01786 
01787             Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PointerPte-&gt;u.Hard.PageFrameNumber);
01788 
01789             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.WsIndex == 0);
01790             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.WsIndex = CurrentEntry;
01791 
01792             <span class="comment">// MiInsertWsle(CurrentEntry, MmWorkingSetList);</span>
01793 
01794             CurrentEntry += 1;
01795             CurrentVa += <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
01796 
01797             NumberOfEntriesMapped += <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> / <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d8/struct__MMWSLE.html">MMWSLE</a>);
01798 
01799         } <span class="keywordflow">while</span> (CurrentProcess-&gt;Vm.MaximumWorkingSetSize &gt;= NumberOfEntriesMapped);
01800 
01801         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
01802     }
01803 
01804     CurrentProcess-&gt;Vm.WorkingSetSize = CurrentEntry;
01805     <a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o1">FirstFree</a> = CurrentEntry;
01806     <a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a> = CurrentEntry;
01807     <a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o4">NextSlot</a> = CurrentEntry;
01808 
01809     <span class="comment">//</span>
01810     <span class="comment">// Initialize the following slots as free.</span>
01811     <span class="comment">//</span>
01812 
01813     i = CurrentEntry + 1;
01814     <span class="keywordflow">do</span> {
01815 
01816         <span class="comment">//</span>
01817         <span class="comment">// Build the free list, note that the first working</span>
01818         <span class="comment">// set entries (CurrentEntry) are not on the free list.</span>
01819         <span class="comment">// These entries are reserved for the pages which</span>
01820         <span class="comment">// map the working set and the page which contains the PDE.</span>
01821         <span class="comment">//</span>
01822 
01823         WslEntry += 1;
01824         WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.Long = i &lt;&lt; <a class="code" href="../../d4/d8/mi_8h.html#a9">MM_FREE_WSLE_SHIFT</a>;
01825         i += 1;
01826     } <span class="keywordflow">while</span> (i &lt;= NumberOfEntriesMapped);
01827 
01828     WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.Long = <a class="code" href="../../d4/d8/mi_8h.html#a10">WSLE_NULL_INDEX</a> &lt;&lt; <a class="code" href="../../d4/d8/mi_8h.html#a9">MM_FREE_WSLE_SHIFT</a>;  <span class="comment">// End of list.</span>
01829 
01830     <a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o7">LastInitializedWsle</a> =
01831                                 NumberOfEntriesMapped - 1;
01832 
01833     <span class="keywordflow">if</span> (CurrentProcess-&gt;Vm.MaximumWorkingSetSize &gt; ((1536*1024) &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>)) {
01834 
01835         <span class="comment">//</span>
01836         <span class="comment">// The working set list consists of more than a single page.</span>
01837         <span class="comment">//</span>
01838 
01839         <a class="code" href="../../d4/d0/wslist_8c.html#a33">MiGrowWsleHash</a> (&amp;CurrentProcess-&gt;Vm);
01840     }
01841 
01842     <span class="keywordflow">return</span>;
01843 }
01844 
01845 
01846 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01847"></a><a class="code" href="../../d4/d0/wslist_8c.html#a28">01847</a> <a class="code" href="../../d4/d0/wslist_8c.html#a28">MiInitializeSessionWsSupport</a>(
01848     VOID
01849     )
01850 
01851 <span class="comment">/*++</span>
01852 <span class="comment"></span>
01853 <span class="comment">Routine Description:</span>
01854 <span class="comment"></span>
01855 <span class="comment">    This routine initializes the session space working set support.</span>
01856 <span class="comment"></span>
01857 <span class="comment">Arguments:</span>
01858 <span class="comment"></span>
01859 <span class="comment">    None.</span>
01860 <span class="comment"></span>
01861 <span class="comment">Return Value:</span>
01862 <span class="comment"></span>
01863 <span class="comment">    None.</span>
01864 <span class="comment"></span>
01865 <span class="comment">Environment:</span>
01866 <span class="comment"></span>
01867 <span class="comment">    Kernel mode, APC_LEVEL or below, no mutexes held.</span>
01868 <span class="comment"></span>
01869 <span class="comment">--*/</span>
01870 
01871 {
01872     <span class="comment">//</span>
01873     <span class="comment">// This is the list of all session spaces ordered in a working set list.</span>
01874     <span class="comment">//</span>
01875 
01876     InitializeListHead (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a761">MiSessionWsList</a>);
01877 }
01878 
01879 
01880 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01881"></a><a class="code" href="../../d4/d0/wslist_8c.html#a29">01881</a> <a class="code" href="../../d4/d0/wslist_8c.html#a29">MiSessionInitializeWorkingSetList</a> (
01882     VOID
01883     )
01884 
01885 <span class="comment">/*++</span>
01886 <span class="comment"></span>
01887 <span class="comment">Routine Description:</span>
01888 <span class="comment"></span>
01889 <span class="comment">    This function initializes the working set for the session space and adds</span>
01890 <span class="comment">    it to the list of session space working sets.</span>
01891 <span class="comment"></span>
01892 <span class="comment">Arguments:</span>
01893 <span class="comment"></span>
01894 <span class="comment">    None.</span>
01895 <span class="comment"></span>
01896 <span class="comment">Return Value:</span>
01897 <span class="comment"></span>
01898 <span class="comment">    NT_SUCCESS if success or STATUS_NO_MEMORY on failure.</span>
01899 <span class="comment"></span>
01900 <span class="comment">Environment:</span>
01901 <span class="comment"></span>
01902 <span class="comment">    Kernel mode, APC_LEVEL or below, no mutexes held.</span>
01903 <span class="comment"></span>
01904 <span class="comment">--*/</span>
01905 
01906 {
01907     ULONG i;
01908     KIRQL OldIrql;
01909     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
01910     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPde;
01911     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>  TempPte;
01912     <a class="code" href="../../d1/d8/struct__MMWSLE.html">PMMWSLE</a> WslEntry;
01913     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
01914     ULONG PageColor;
01915     PFN_NUMBER ResidentPages;
01916     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
01917     PFN_NUMBER PageFrameIndex;
01918     ULONG CurrentEntry;
01919     ULONG NumberOfEntriesMapped;
01920     ULONG_PTR AdditionalBytes;
01921     ULONG NumberOfEntriesMappedByFirstPage;
01922     ULONG WorkingSetMaximum;
01923     <a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html">PMM_SESSION_SPACE</a> SessionGlobal;
01924     LOGICAL AllocatedPageTable;
01925 
01926     <span class="comment">//</span>
01927     <span class="comment">// Use the global address for pointer references by</span>
01928     <span class="comment">// MmWorkingSetManager before it attaches to the address space.</span>
01929     <span class="comment">//</span>
01930 
01931     SessionGlobal = <a class="code" href="../../d4/d8/mi_8h.html#a356">SESSION_GLOBAL</a> (<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>);
01932 
01933     <span class="comment">//</span>
01934     <span class="comment">// Set up the working set variables.</span>
01935     <span class="comment">//</span>
01936 
01937     WorkingSetMaximum = <a class="code" href="../../d4/d8/mi_8h.html#a403">MI_SESSION_SPACE_WORKING_SET_MAXIMUM</a>;
01938 
01939     <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o7">VmWorkingSetList</a> = (<a class="code" href="../../d0/d8/struct__MMWSL.html">PMMWSL</a>)<a class="code" href="../../d4/d8/mi_8h.html#a348">MI_SESSION_SPACE_WS</a>;
01940 <span class="preprocessor">#if defined (_WIN64)</span>
01941 <span class="preprocessor"></span>    <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o31">Wsle</a> = (<a class="code" href="../../d1/d8/struct__MMWSLE.html">PMMWSLE</a>)(<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o7">VmWorkingSetList</a> + 1);
01942 <span class="preprocessor">#else</span>
01943 <span class="preprocessor"></span>    <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o31">Wsle</a> =
01944             (<a class="code" href="../../d1/d8/struct__MMWSLE.html">PMMWSLE</a>)(&amp;<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o7">VmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o16">UsedPageTableEntries</a>[0]);
01945 <span class="preprocessor">#endif</span>
01946 <span class="preprocessor"></span>
01947     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o36">WorkingSetLockOwner</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01948     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;WorkingSetLockOwnerCount == 0);
01949 
01950     <span class="comment">//</span>
01951     <span class="comment">// Build the PDE entry for the working set - note that the global bit</span>
01952     <span class="comment">// must be turned off.</span>
01953     <span class="comment">//</span>
01954 
01955     PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o7">VmWorkingSetList</a>);
01956 
01957     <span class="comment">//</span>
01958     <span class="comment">// The page table page for the working set and its first data page</span>
01959     <span class="comment">// are charged against MmResidentAvailablePages and for commitment.</span>
01960     <span class="comment">//</span>
01961 
01962     <span class="keywordflow">if</span> (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1) {
01963 
01964         <span class="comment">//</span>
01965         <span class="comment">// The page directory entry for the working set is the same</span>
01966         <span class="comment">// as for another range in the session space.  Share the PDE.</span>
01967         <span class="comment">//</span>
01968 
01969 <span class="preprocessor">#ifndef _IA64_</span>
01970 <span class="preprocessor"></span>        <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Global == 0);
01971 <span class="preprocessor">#endif</span>
01972 <span class="preprocessor"></span>        AllocatedPageTable = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01973         ResidentPages = 1;
01974     }
01975     <span class="keywordflow">else</span> {
01976         AllocatedPageTable = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01977         ResidentPages = 2;
01978     }
01979 
01980 
01981     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o7">VmWorkingSetList</a>);
01982 
01983     <span class="comment">//</span>
01984     <span class="comment">// The data pages needed to map up to maximum working set size are also</span>
01985     <span class="comment">// charged against MmResidentAvailablePages and for commitment.</span>
01986     <span class="comment">//</span>
01987 
01988     NumberOfEntriesMappedByFirstPage = (<a class="code" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a>)(
01989         ((<a class="code" href="../../d1/d8/struct__MMWSLE.html">PMMWSLE</a>)((ULONG_PTR)<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o7">VmWorkingSetList</a> + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>)) -
01990             <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o31">Wsle</a>);
01991 
01992     <span class="keywordflow">if</span> (WorkingSetMaximum &gt; NumberOfEntriesMappedByFirstPage) {
01993         AdditionalBytes = (WorkingSetMaximum - NumberOfEntriesMappedByFirstPage) * <span class="keyword">sizeof</span> (<a class="code" href="../../d1/d8/struct__MMWSLE.html">MMWSLE</a>);
01994         ResidentPages += <a class="code" href="../../d2/d1/mm_8h.html#a5">BYTES_TO_PAGES</a> (AdditionalBytes);
01995     }
01996 
01997     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d1/mmquota_8c.html#a17">MiChargeCommitment</a> (ResidentPages, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01998 <span class="preprocessor">#if DBG</span>
01999 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"MiSessionInitializeWorkingSetList: No commit for %d pages\n"</span>,
02000             ResidentPages);
02001 
02002 <span class="preprocessor">#endif</span>
02003 <span class="preprocessor"></span>        <a class="code" href="../../d4/d8/mi_8h.html#a396">MM_BUMP_SESSION_FAILURES</a> (<a class="code" href="../../d4/d8/mi_8h.html#a387">MM_SESSION_FAILURE_NO_COMMIT</a>);
02004         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
02005     }
02006 
02007     <a class="code" href="../../d4/d8/mi_8h.html#a254">MM_TRACK_COMMIT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a283">MM_DBG_COMMIT_SESSION_WS_INIT</a>, ResidentPages);
02008 
02009     <span class="comment">//</span>
02010     <span class="comment">// Use the global address for resources since they are linked</span>
02011     <span class="comment">// into the global system wide resource list.</span>
02012     <span class="comment">//</span>
02013 
02014     <a class="code" href="../../d5/d8/ex_8h.html#a68">ExInitializeResource</a> (&amp;SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o32">WsLock</a>);
02015 
02016     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02017 
02018     <span class="comment">//</span>
02019     <span class="comment">// Check to make sure the physical pages are available.</span>
02020     <span class="comment">//</span>
02021 
02022     <span class="keywordflow">if</span> ((SPFN_NUMBER)ResidentPages &gt; <a class="code" href="../../d4/d8/mi_8h.html#a323">MI_NONPAGABLE_MEMORY_AVAILABLE</a>() - 20) {
02023 <span class="preprocessor">#if DBG</span>
02024 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"MiSessionInitializeWorkingSetList: No Resident Pages %d, Need %d\n"</span>,
02025             <a class="code" href="../../d8/d5/kddata_8c.html#a42">MmResidentAvailablePages</a>,
02026             ResidentPages);
02027 <span class="preprocessor">#endif</span>
02028 <span class="preprocessor"></span>        <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02029 
02030         <a class="code" href="../../d6/d1/mmquota_8c.html#a19">MiReturnCommitment</a> (ResidentPages);
02031         <a class="code" href="../../d4/d8/mi_8h.html#a254">MM_TRACK_COMMIT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a310">MM_DBG_COMMIT_RETURN_SESSION_WSL_FAILURE</a>, ResidentPages);
02032         <a class="code" href="../../d5/d8/ex_8h.html#a73">ExDeleteResource</a> (&amp;SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o32">WsLock</a>);
02033         <a class="code" href="../../d4/d8/mi_8h.html#a396">MM_BUMP_SESSION_FAILURES</a> (<a class="code" href="../../d4/d8/mi_8h.html#a388">MM_SESSION_FAILURE_NO_RESIDENT</a>);
02034         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
02035     }
02036 
02037     <a class="code" href="../../d8/d5/kddata_8c.html#a42">MmResidentAvailablePages</a> -= ResidentPages;
02038 
02039     <a class="code" href="../../d4/d8/mi_8h.html#a322">MM_BUMP_COUNTER</a>(50, ResidentPages);
02040 
02041     <span class="keywordflow">if</span> (AllocatedPageTable == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
02042 
02043         <a class="code" href="../../d4/d8/mi_8h.html#a384">MM_BUMP_SESS_COUNTER</a> (<a class="code" href="../../d4/d8/mi_8h.html#a365">MM_DBG_SESSION_WS_PAGETABLE_ALLOC</a>, 1);
02044 
02045         <a class="code" href="../../d7/d5/pfnlist_8c.html#a13">MiEnsureAvailablePageOrWait</a> (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02046 
02047         PageColor = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a125">MI_GET_PAGE_COLOR_FROM_VA</a> (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02048 
02049         PageFrameIndex = <a class="code" href="../../d4/d8/mi_8h.html#a243">MiRemoveZeroPageIfAny</a> (PageColor);
02050         <span class="keywordflow">if</span> (PageFrameIndex == 0) {
02051             PageFrameIndex = <a class="code" href="../../d7/d5/pfnlist_8c.html#a15">MiRemoveAnyPage</a> (PageColor);
02052             <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02053             <a class="code" href="../../d0/d2/mmsup_8c.html#a14">MiZeroPhysicalPage</a> (PageFrameIndex, PageColor);
02054             <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02055         }
02056 
02057         <span class="comment">//</span>
02058         <span class="comment">// The global bit is masked off since we need to make sure the TB entry</span>
02059         <span class="comment">// is flushed when we switch to a process in a different session space.</span>
02060         <span class="comment">//</span>
02061 
02062         TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = <a class="code" href="../../d4/d2/datalpha_8c.html#a8">ValidKernelPdeLocal</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long;
02063         TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber = PageFrameIndex;
02064         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a> (PointerPde, TempPte);
02065 
02066 <span class="preprocessor">#if !defined (_WIN64)</span>
02067 <span class="preprocessor"></span>
02068         <span class="comment">//</span>
02069         <span class="comment">// Add this to the session structure so other processes can fault it in.</span>
02070         <span class="comment">//</span>
02071 
02072         <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = <a class="code" href="../../d4/d8/mi_8h.html#a409">MiGetPdeSessionIndex</a> (<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o7">VmWorkingSetList</a>);
02073 
02074         <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o16">PageTables</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>] = TempPte;
02075 
02076 <span class="preprocessor">#endif</span>
02077 <span class="preprocessor"></span>
02078         <span class="comment">//</span>
02079         <span class="comment">// This page frame references the session space page table page.</span>
02080         <span class="comment">//</span>
02081 
02082         <a class="code" href="../../d8/d2/pagfault_8c.html#a27">MiInitializePfnForOtherProcess</a> (PageFrameIndex,
02083                                         PointerPde,
02084                                         <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o5">SessionPageDirectoryIndex</a>);
02085 
02086         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a189">MiFillMemoryPte</a> (PointerPte, <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>, <a class="code" href="../../d4/d2/datalpha_8c.html#a1">ZeroKernelPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long);
02087 
02088         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
02089 
02090         <span class="comment">//</span>
02091         <span class="comment">// This page is never paged, ensure that its WsIndex stays clear so the</span>
02092         <span class="comment">// release of the page will be handled correctly.</span>
02093         <span class="comment">//</span>
02094 
02095         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.WsIndex == 0);
02096 
02097         KeFillEntryTb ((PHARDWARE_PTE) PointerPde, PointerPte, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02098     }
02099 
02100     <a class="code" href="../../d7/d5/pfnlist_8c.html#a13">MiEnsureAvailablePageOrWait</a> (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02101 
02102     PageColor = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a125">MI_GET_PAGE_COLOR_FROM_VA</a> (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02103 
02104     PageFrameIndex = <a class="code" href="../../d4/d8/mi_8h.html#a243">MiRemoveZeroPageIfAny</a> (PageColor);
02105     <span class="keywordflow">if</span> (PageFrameIndex == 0) {
02106         PageFrameIndex = <a class="code" href="../../d7/d5/pfnlist_8c.html#a15">MiRemoveAnyPage</a> (PageColor);
02107         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02108         <a class="code" href="../../d0/d2/mmsup_8c.html#a14">MiZeroPhysicalPage</a> (PageFrameIndex, PageColor);
02109         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02110     }
02111 
02112     <a class="code" href="../../d4/d8/mi_8h.html#a384">MM_BUMP_SESS_COUNTER</a> (<a class="code" href="../../d4/d8/mi_8h.html#a368">MM_DBG_SESSION_WS_PAGE_ALLOC</a>, ResidentPages - 1);
02113 
02114 <span class="preprocessor">#if DBG</span>
02115 <span class="preprocessor"></span>    Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
02116     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.WsIndex == 0);
02117 <span class="preprocessor">#endif</span>
02118 <span class="preprocessor"></span>
02119     <span class="comment">//</span>
02120     <span class="comment">// The global bit is masked off since we need to make sure the TB entry</span>
02121     <span class="comment">// is flushed when we switch to a process in a different session space.</span>
02122     <span class="comment">//</span>
02123 
02124     TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = <a class="code" href="../../d4/d2/datalpha_8c.html#a3">ValidKernelPteLocal</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long;
02125     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a112">MI_SET_PTE_DIRTY</a> (TempPte);
02126     TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber = PageFrameIndex;
02127 
02128     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a> (PointerPte, TempPte);
02129 
02130     <a class="code" href="../../d8/d2/pagfault_8c.html#a22">MiInitializePfn</a> (PageFrameIndex, PointerPte, 1);
02131 
02132 <span class="preprocessor">#if DBG</span>
02133 <span class="preprocessor"></span>    Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
02134     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.WsIndex == 0);
02135 <span class="preprocessor">#endif</span>
02136 <span class="preprocessor"></span>
02137     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02138 
02139     KeFillEntryTb ((PHARDWARE_PTE) PointerPte,
02140                    (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o7">VmWorkingSetList</a>,
02141                    <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02142 
02143     <span class="comment">//</span>
02144     <span class="comment">// Fill in the reserved slots starting with the session data page.</span>
02145     <span class="comment">//</span>
02146 
02147     WslEntry = <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o31">Wsle</a>;
02148 
02149     WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.VirtualAddress = (PVOID)<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>;
02150     WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Valid = 1;
02151     WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.LockedInWs = 1;
02152     WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Direct = 1;
02153 
02154     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.VirtualAddress)-&gt;u.Hard.PageFrameNumber);
02155 
02156     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.WsIndex == 0);
02157 
02158     <span class="comment">//</span>
02159     <span class="comment">// The next reserved slot is for the page table page mapping</span>
02160     <span class="comment">// the session data page.</span>
02161     <span class="comment">//</span>
02162 
02163     WslEntry += 1;
02164 
02165     WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.VirtualAddress = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>);
02166     WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Valid = 1;
02167     WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.LockedInWs = 1;
02168     WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Direct = 1;
02169 
02170     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.VirtualAddress)-&gt;u.Hard.PageFrameNumber);
02171 
02172     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.WsIndex == 0);
02173 
02174     <a class="code" href="../../d4/d8/mi_8h.html#a121">CONSISTENCY_LOCK_PFN</a> (OldIrql);
02175 
02176     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.WsIndex = (<a class="code" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a>)(WslEntry - <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o31">Wsle</a>);
02177 
02178     <a class="code" href="../../d4/d8/mi_8h.html#a122">CONSISTENCY_UNLOCK_PFN</a> (OldIrql);
02179 
02180     <span class="comment">//</span>
02181     <span class="comment">// The next reserved slot is for the working set page.</span>
02182     <span class="comment">//</span>
02183 
02184     WslEntry += 1;
02185 
02186     WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.VirtualAddress = <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o7">VmWorkingSetList</a>;
02187     WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Valid = 1;
02188     WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.LockedInWs = 1;
02189     WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Direct = 1;
02190 
02191     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
02192 
02193     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.WsIndex == 0);
02194 
02195     <a class="code" href="../../d4/d8/mi_8h.html#a121">CONSISTENCY_LOCK_PFN</a> (OldIrql);
02196 
02197     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.WsIndex = (<a class="code" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a>)(WslEntry - <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o31">Wsle</a>);
02198 
02199     <a class="code" href="../../d4/d8/mi_8h.html#a122">CONSISTENCY_UNLOCK_PFN</a> (OldIrql);
02200 
02201     <span class="keywordflow">if</span> (AllocatedPageTable == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
02202 
02203         <span class="comment">//</span>
02204         <span class="comment">// The next reserved slot is for the page table page</span>
02205         <span class="comment">// mapping the working set page.</span>
02206         <span class="comment">//</span>
02207 
02208         WslEntry += 1;
02209 
02210         WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.VirtualAddress = (PVOID)PointerPte;
02211         WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Valid = 1;
02212         WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.LockedInWs = 1;
02213         WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Direct = 1;
02214 
02215         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.VirtualAddress)-&gt;u.Hard.PageFrameNumber);
02216 
02217         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.WsIndex == 0);
02218 
02219         <a class="code" href="../../d4/d8/mi_8h.html#a121">CONSISTENCY_LOCK_PFN</a> (OldIrql);
02220 
02221         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.WsIndex = (<a class="code" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a>)(WslEntry - <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o31">Wsle</a>);
02222 
02223         <a class="code" href="../../d4/d8/mi_8h.html#a122">CONSISTENCY_UNLOCK_PFN</a> (OldIrql);
02224     }
02225 
02226     <span class="comment">//</span>
02227     <span class="comment">// The next reserved slot is for the page table page</span>
02228     <span class="comment">// mapping the first session paged pool page.</span>
02229     <span class="comment">//</span>
02230 
02231     WslEntry += 1;
02232 
02233     WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.VirtualAddress = (PVOID)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o18">PagedPoolStart</a>);
02234     WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Valid = 1;
02235     WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.LockedInWs = 1;
02236     WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Direct = 1;
02237 
02238     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.VirtualAddress)-&gt;u.Hard.PageFrameNumber);
02239 
02240     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.WsIndex == 0);
02241 
02242     <a class="code" href="../../d4/d8/mi_8h.html#a121">CONSISTENCY_LOCK_PFN</a> (OldIrql);
02243 
02244     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.WsIndex = (<a class="code" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a>)(WslEntry - <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o31">Wsle</a>);
02245 
02246     <a class="code" href="../../d4/d8/mi_8h.html#a122">CONSISTENCY_UNLOCK_PFN</a> (OldIrql);
02247 
02248     CurrentEntry = (<a class="code" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a>)(WslEntry + 1 - <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o31">Wsle</a>);
02249 
02250     <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.SessionSpace = 1;
02251     <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o5">MinimumWorkingSetSize</a> = <a class="code" href="../../d4/d8/mi_8h.html#a402">MI_SESSION_SPACE_WORKING_SET_MINIMUM</a>;
02252     <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o6">MaximumWorkingSetSize</a> = WorkingSetMaximum;
02253 
02254     <span class="comment">//</span>
02255     <span class="comment">// Don't trim from this session till we're finished setting up and</span>
02256     <span class="comment">// it's got some pages in it...</span>
02257     <span class="comment">//</span>
02258 
02259     <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o9">AllowWorkingSetAdjustment</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02260 
02261     <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o7">VmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o3">LastEntry</a> = <a class="code" href="../../d4/d8/mi_8h.html#a402">MI_SESSION_SPACE_WORKING_SET_MINIMUM</a>;
02262     <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o7">VmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o0">Quota</a> = <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o7">VmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o3">LastEntry</a>;
02263     <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o7">VmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o9">HashTable</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02264     <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o7">VmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o10">HashTableSize</a> = 0;
02265     <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o7">VmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o5">Wsle</a> = <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o31">Wsle</a>;
02266 
02267     <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o7">VmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o12">HashTableStart</a> =
02268        (PVOID)((PCHAR)<a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a> (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o31">Wsle</a>[<a class="code" href="../../d4/d8/mi_8h.html#a340">MI_SESSION_MAXIMUM_WORKING_SET</a>]) + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
02269 
02270 <span class="preprocessor">#if defined (_X86PAE_)</span>
02271 <span class="preprocessor"></span>
02272     <span class="comment">//</span>
02273     <span class="comment">// One less page table page is needed on PAE systems.</span>
02274     <span class="comment">//</span>
02275 
02276     <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o7">VmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o13">HighestPermittedHashAddress</a> =
02277         (PVOID)(<a class="code" href="../../d4/d8/mi_8h.html#a349">MI_SESSION_VIEW_START</a> - <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a50">MM_VA_MAPPED_BY_PDE</a>);
02278 <span class="preprocessor">#else</span>
02279 <span class="preprocessor"></span>    <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o7">VmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o13">HighestPermittedHashAddress</a> =
02280         (PVOID)<a class="code" href="../../d4/d8/mi_8h.html#a349">MI_SESSION_VIEW_START</a>;
02281 <span class="preprocessor">#endif</span>
02282 <span class="preprocessor"></span>
02283     NumberOfEntriesMapped = (<a class="code" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a>)(((<a class="code" href="../../d1/d8/struct__MMWSLE.html">PMMWSLE</a>)((ULONG_PTR)<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o7">VmWorkingSetList</a> +
02284                                 <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>)) - <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o31">Wsle</a>);
02285 
02286     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02287 
02288     <span class="keywordflow">while</span> (NumberOfEntriesMapped &lt; WorkingSetMaximum) {
02289 
02290         PointerPte += 1;
02291 
02292         <a class="code" href="../../d7/d5/pfnlist_8c.html#a13">MiEnsureAvailablePageOrWait</a> (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
02293 
02294         PageFrameIndex = <a class="code" href="../../d7/d5/pfnlist_8c.html#a14">MiRemoveZeroPage</a>(<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a125">MI_GET_PAGE_COLOR_FROM_VA</a> (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>));
02295 
02296         PointerPte-&gt;u.Long = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a95">MM_DEMAND_ZERO_WRITE_PTE</a>;
02297 
02298         <a class="code" href="../../d8/d2/pagfault_8c.html#a22">MiInitializePfn</a> (PageFrameIndex, PointerPte, 1);
02299 
02300         TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber = PageFrameIndex;
02301 
02302         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a109">MI_SET_PTE_IN_WORKING_SET</a> (&amp;TempPte, CurrentEntry);
02303 
02304         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a> (PointerPte, TempPte);
02305 
02306         WslEntry += 1;
02307 
02308         WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.VirtualAddress = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPte);
02309         WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Valid = 1;
02310         WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.LockedInWs = 1;
02311         WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Direct = 1;
02312 
02313         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PointerPte-&gt;u.Hard.PageFrameNumber);
02314 
02315         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.WsIndex == 0);
02316         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.WsIndex = CurrentEntry;
02317 
02318         <span class="comment">// MiInsertWsle(CurrentEntry, MmWorkingSetList);</span>
02319 
02320         CurrentEntry += 1;
02321 
02322         NumberOfEntriesMapped += <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> / <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d8/struct__MMWSLE.html">MMWSLE</a>);
02323     }
02324 
02325     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02326 
02327     <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o4">WorkingSetSize</a> = CurrentEntry;
02328     <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o7">VmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o1">FirstFree</a> = CurrentEntry;
02329     <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o7">VmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a> = CurrentEntry;
02330     <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o7">VmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o4">NextSlot</a> = CurrentEntry;
02331 
02332     <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o13">NonPagablePages</a> += ResidentPages;
02333     <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o14">CommittedPages</a> += ResidentPages;
02334 
02335     <span class="comment">//</span>
02336     <span class="comment">// Initialize the following slots as free.</span>
02337     <span class="comment">//</span>
02338 
02339     WslEntry = <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o31">Wsle</a> + CurrentEntry;
02340 
02341     <span class="keywordflow">for</span> (i = CurrentEntry + 1; i &lt; NumberOfEntriesMapped; i += 1) {
02342 
02343         <span class="comment">//</span>
02344         <span class="comment">// Build the free list, note that the first working</span>
02345         <span class="comment">// set entries (CurrentEntry) are not on the free list.</span>
02346         <span class="comment">// These entries are reserved for the pages which</span>
02347         <span class="comment">// map the working set and the page which contains the PDE.</span>
02348         <span class="comment">//</span>
02349 
02350         WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.Long = i &lt;&lt; <a class="code" href="../../d4/d8/mi_8h.html#a9">MM_FREE_WSLE_SHIFT</a>;
02351         WslEntry += 1;
02352     }
02353 
02354     WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.Long = <a class="code" href="../../d4/d8/mi_8h.html#a10">WSLE_NULL_INDEX</a> &lt;&lt; <a class="code" href="../../d4/d8/mi_8h.html#a9">MM_FREE_WSLE_SHIFT</a>;  <span class="comment">// End of list.</span>
02355 
02356     <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o7">VmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o7">LastInitializedWsle</a> = NumberOfEntriesMapped - 1;
02357 
02358     <span class="keywordflow">if</span> (WorkingSetMaximum &gt; ((1536*1024) &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>)) {
02359 
02360         <span class="comment">//</span>
02361         <span class="comment">// The working set list consists of more than a single page.</span>
02362         <span class="comment">//</span>
02363 
02364         <a class="code" href="../../d4/d0/wslist_8c.html#a33">MiGrowWsleHash</a> (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>);
02365     }
02366 
02367     <span class="comment">//</span>
02368     <span class="comment">// Put this session's working set in lists using its global address.</span>
02369     <span class="comment">//</span>
02370 
02371     <a class="code" href="../../d4/d8/mi_8h.html#a139">LOCK_EXPANSION</a> (OldIrql);
02372 
02373     InsertTailList (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a761">MiSessionWsList</a>, &amp;SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o33">WsListEntry</a>);
02374 
02375     <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o3">u</a>.Flags.HasWsLock = 1;
02376 
02377     <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o3">u</a>.Flags.SessionListInserted = 1;
02378 
02379     <a class="code" href="../../d4/d8/mi_8h.html#a140">UNLOCK_EXPANSION</a> (OldIrql);
02380 
02381     <span class="keywordflow">return</span> STATUS_SUCCESS;
02382 }
02383 
02384 
02385 LOGICAL
<a name="l02386"></a><a class="code" href="../../d4/d0/wslist_8c.html#a30">02386</a> <a class="code" href="../../d4/d0/wslist_8c.html#a30">MmAssignProcessToJob</a> (
02387     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process
02388     )
02389 
02390 <span class="comment">/*++</span>
02391 <span class="comment"></span>
02392 <span class="comment">Routine Description:</span>
02393 <span class="comment"></span>
02394 <span class="comment">    This routine acquires the working set lock so a consistent snapshot of</span>
02395 <span class="comment">    the argument process' commit charges and working set size can be used</span>
02396 <span class="comment">    when adding this process to a job.</span>
02397 <span class="comment"></span>
02398 <span class="comment">Arguments:</span>
02399 <span class="comment"></span>
02400 <span class="comment">    Process - Supplies a pointer to the process to operate upon.</span>
02401 <span class="comment"></span>
02402 <span class="comment">Return Value:</span>
02403 <span class="comment"></span>
02404 <span class="comment">    TRUE if the process is allowed to join the job, FALSE otherwise.</span>
02405 <span class="comment"></span>
02406 <span class="comment">    Note that FALSE cannot be returned without changing the code in ps.</span>
02407 <span class="comment"></span>
02408 <span class="comment">Environment:</span>
02409 <span class="comment"></span>
02410 <span class="comment">    Kernel mode, IRQL APC_LEVEL or below.  The caller provides protection</span>
02411 <span class="comment">    from the target process going away.</span>
02412 <span class="comment"></span>
02413 <span class="comment">--*/</span>
02414 
02415 {
02416     LOGICAL Attached;
02417     LOGICAL <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02418 
02419     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a> ();
02420 
02421     Attached = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02422 
02423     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>() != Process) {
02424         <a class="code" href="../../d3/d5/procobj_8c.html#a4">KeAttachProcess</a> (&amp;Process-&gt;Pcb);
02425         Attached = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02426     }
02427 
02428     <a class="code" href="../../d4/d8/mi_8h.html#a161">LOCK_WS_AND_ADDRESS_SPACE</a> (Process);
02429 
02430     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d1/psjob_8c.html#a20">PsChangeJobMemoryUsage</a> (Process-&gt;CommitCharge);
02431 
02432     <span class="comment">//</span>
02433     <span class="comment">// Join the job unconditionally.  If the process is over any limits, it</span>
02434     <span class="comment">// will be caught on its next request.</span>
02435     <span class="comment">//</span>
02436 
02437     Process-&gt;JobStatus |= <a class="code" href="../../d1/d9/ps_8h.html#a13">PS_JOB_STATUS_REPORT_COMMIT_CHANGES</a>;
02438 
02439     <a class="code" href="../../d4/d8/mi_8h.html#a162">UNLOCK_WS_AND_ADDRESS_SPACE</a> (Process);
02440 
02441     <span class="keywordflow">if</span> (Attached) {
02442         <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
02443     }
02444 
02445     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02446 }
02447 
02448 
02449 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l02450"></a><a class="code" href="../../d4/d0/wslist_8c.html#a31">02450</a> <a class="code" href="../../d4/d0/wslist_8c.html#a31">MmAdjustWorkingSetSize</a> (
02451     IN SIZE_T WorkingSetMinimumInBytes,
02452     IN SIZE_T WorkingSetMaximumInBytes,
02453     IN ULONG SystemCache
02454     )
02455 
02456 <span class="comment">/*++</span>
02457 <span class="comment"></span>
02458 <span class="comment">Routine Description:</span>
02459 <span class="comment"></span>
02460 <span class="comment">    This routine adjusts the current size of a process's working set</span>
02461 <span class="comment">    list.  If the maximum value is above the current maximum, pages</span>
02462 <span class="comment">    are removed from the working set list.</span>
02463 <span class="comment"></span>
02464 <span class="comment">    An exception is raised if the limit cannot be granted.  This</span>
02465 <span class="comment">    could occur if too many pages were locked in the process's</span>
02466 <span class="comment">    working set.</span>
02467 <span class="comment"></span>
02468 <span class="comment">    Note: if the minimum and maximum are both (SIZE_T)-1, the working set</span>
02469 <span class="comment">          is purged, but the default sizes are not changed.</span>
02470 <span class="comment"></span>
02471 <span class="comment">Arguments:</span>
02472 <span class="comment"></span>
02473 <span class="comment">    WorkingSetMinimumInBytes - Supplies the new minimum working set size in</span>
02474 <span class="comment">                               bytes.</span>
02475 <span class="comment"></span>
02476 <span class="comment">    WorkingSetMaximumInBytes - Supplies the new maximum working set size in</span>
02477 <span class="comment">                               bytes.</span>
02478 <span class="comment"></span>
02479 <span class="comment">    SystemCache - Supplies TRUE if the system cache working set is being</span>
02480 <span class="comment">                  adjusted, FALSE for all other working sets.</span>
02481 <span class="comment"></span>
02482 <span class="comment">Return Value:</span>
02483 <span class="comment"></span>
02484 <span class="comment">    NTSTATUS.</span>
02485 <span class="comment"></span>
02486 <span class="comment">Environment:</span>
02487 <span class="comment"></span>
02488 <span class="comment">    Kernel mode, IRQL APC_LEVEL or below.</span>
02489 <span class="comment"></span>
02490 <span class="comment">--*/</span>
02491 
02492 
02493 {
02494     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> CurrentProcess;
02495     ULONG Entry;
02496     ULONG LastFreed;
02497     <a class="code" href="../../d1/d8/struct__MMWSLE.html">PMMWSLE</a> Wsle;
02498     KIRQL OldIrql;
02499     KIRQL OldIrql2;
02500     SPFN_NUMBER i;
02501     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
02502     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> ReturnStatus;
02503     LONG PagesAbove;
02504     LONG NewPagesAbove;
02505     ULONG FreeTryCount;
02506     <a class="code" href="../../d3/d6/struct__MMSUPPORT.html">PMMSUPPORT</a> WsInfo;
02507     <a class="code" href="../../d0/d8/struct__MMWSL.html">PMMWSL</a> WorkingSetList;
02508     <a class="code" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a> WorkingSetMinimum;
02509     <a class="code" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a> WorkingSetMaximum;
02510 
02511     <a class="code" href="../../d2/d1/mm_8h.html#a80">PERFINFO_PAGE_INFO_DECL</a>();
02512 
02513     FreeTryCount = 0;
02514 
02515     <span class="keywordflow">if</span> (SystemCache) {
02516         WsInfo = &amp;<a class="code" href="../../d6/d8/sysinfo_8c.html#a21">MmSystemCacheWs</a>;
02517     } <span class="keywordflow">else</span> {
02518         CurrentProcess = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a> ();
02519         WsInfo = &amp;CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>;
02520     }
02521 
02522     <span class="keywordflow">if</span> ((WorkingSetMinimumInBytes == (SIZE_T)-1) &amp;&amp;
02523         (WorkingSetMaximumInBytes == (SIZE_T)-1)) {
02524         <span class="keywordflow">return</span> <a class="code" href="../../d4/d0/wslist_8c.html#a35">MiEmptyWorkingSet</a> (WsInfo, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02525     }
02526 
02527     <span class="keywordflow">if</span> (WorkingSetMinimumInBytes == 0) {
02528         WorkingSetMinimum = WsInfo-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o5">MinimumWorkingSetSize</a>;
02529     }
02530     <span class="keywordflow">else</span> {
02531         WorkingSetMinimum = (<a class="code" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a>)(WorkingSetMinimumInBytes &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
02532     }
02533 
02534     <span class="keywordflow">if</span> (WorkingSetMaximumInBytes == 0) {
02535         WorkingSetMaximum = WsInfo-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o6">MaximumWorkingSetSize</a>;
02536     }
02537     <span class="keywordflow">else</span> {
02538         WorkingSetMaximum = (<a class="code" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a>)(WorkingSetMaximumInBytes &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
02539     }
02540 
02541     <span class="keywordflow">if</span> (WorkingSetMinimum &gt; WorkingSetMaximum) {
02542         <span class="keywordflow">return</span> STATUS_BAD_WORKING_SET_LIMIT;
02543     }
02544 
02545     <a class="code" href="../../d5/d6/iosup_8c.html#a76">MmLockPagableSectionByHandle</a>(<a class="code" href="../../d5/d8/ex_8h.html#a166">ExPageLockHandle</a>);
02546 
02547     ReturnStatus = STATUS_SUCCESS;
02548 
02549     <span class="comment">//</span>
02550     <span class="comment">// Get the working set lock and disable APCs.</span>
02551     <span class="comment">//</span>
02552 
02553     <span class="keywordflow">if</span> (SystemCache) {
02554         <a class="code" href="../../d4/d8/mi_8h.html#a144">LOCK_SYSTEM_WS</a> (OldIrql2);
02555     } <span class="keywordflow">else</span> {
02556         <a class="code" href="../../d4/d8/mi_8h.html#a154">LOCK_WS</a> (CurrentProcess);
02557 
02558         <span class="keywordflow">if</span> (CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o27">AddressSpaceDeleted</a> != 0) {
02559             ReturnStatus = STATUS_PROCESS_IS_TERMINATING;
02560             <span class="keywordflow">goto</span> Returns;
02561         }
02562     }
02563 
02564     <span class="keywordflow">if</span> (WorkingSetMaximum &gt; <a class="code" href="../../d0/d9/miglobal_8c.html#a137">MmMaximumWorkingSetSize</a>) {
02565         WorkingSetMaximum = <a class="code" href="../../d0/d9/miglobal_8c.html#a137">MmMaximumWorkingSetSize</a>;
02566         ReturnStatus = STATUS_WORKING_SET_LIMIT_RANGE;
02567     }
02568 
02569     <span class="keywordflow">if</span> (WorkingSetMinimum &gt; <a class="code" href="../../d0/d9/miglobal_8c.html#a137">MmMaximumWorkingSetSize</a>) {
02570         WorkingSetMinimum = <a class="code" href="../../d0/d9/miglobal_8c.html#a137">MmMaximumWorkingSetSize</a>;
02571         ReturnStatus = STATUS_WORKING_SET_LIMIT_RANGE;
02572     }
02573 
02574     <span class="keywordflow">if</span> (WorkingSetMinimum &lt; <a class="code" href="../../d4/d8/mi_8h.html#a741">MmMinimumWorkingSetSize</a>) {
02575         WorkingSetMinimum = (ULONG)<a class="code" href="../../d4/d8/mi_8h.html#a741">MmMinimumWorkingSetSize</a>;
02576         ReturnStatus = STATUS_WORKING_SET_LIMIT_RANGE;
02577     }
02578 
02579     <span class="comment">//</span>
02580     <span class="comment">// Make sure that the number of locked pages will not</span>
02581     <span class="comment">// make the working set not fluid.</span>
02582     <span class="comment">//</span>
02583 
02584     <span class="keywordflow">if</span> ((WsInfo-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o7">VmWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a> + <a class="code" href="../../d4/d8/mi_8h.html#a15">MM_FLUID_WORKING_SET</a>) &gt;=
02585          WorkingSetMaximum) {
02586         ReturnStatus = STATUS_BAD_WORKING_SET_LIMIT;
02587         <span class="keywordflow">goto</span> Returns;
02588     }
02589 
02590     WorkingSetList = WsInfo-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o7">VmWorkingSetList</a>;
02591     Wsle = WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o5">Wsle</a>;
02592 
02593     <span class="comment">//</span>
02594     <span class="comment">// Check to make sure ample resident physical pages exist for</span>
02595     <span class="comment">// this operation.</span>
02596     <span class="comment">//</span>
02597 
02598     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02599 
02600     i = WorkingSetMinimum - WsInfo-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o5">MinimumWorkingSetSize</a>;
02601 
02602     <span class="keywordflow">if</span> (i &gt; 0) {
02603 
02604         <span class="comment">//</span>
02605         <span class="comment">// New minimum working set is greater than the old one.  Ensure that</span>
02606         <span class="comment">// we don't allow this process' working set minimum to increase to</span>
02607         <span class="comment">// a point where subsequent nonpaged pool allocations could cause</span>
02608         <span class="comment">// us to run out of pages.  Additionally, leave 100 extra pages around</span>
02609         <span class="comment">// so the user can later bring up tlist and kill processes if necessary.</span>
02610         <span class="comment">//</span>
02611 
02612         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> &lt; (20 + (i / (<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> / <span class="keyword">sizeof</span> (<a class="code" href="../../d1/d8/struct__MMWSLE.html">MMWSLE</a>))))) {
02613             <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02614             ReturnStatus = STATUS_INSUFFICIENT_RESOURCES;
02615             <span class="keywordflow">goto</span> Returns;
02616         }
02617 
02618         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a323">MI_NONPAGABLE_MEMORY_AVAILABLE</a>() - 100 &lt; i) {
02619             <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02620             ReturnStatus = STATUS_INSUFFICIENT_RESOURCES;
02621             <span class="keywordflow">goto</span> Returns;
02622         }
02623     }
02624 
02625     <span class="comment">//</span>
02626     <span class="comment">// Adjust the number of resident pages up or down dependent on</span>
02627     <span class="comment">// the size of the new minimum working set size versus the previous</span>
02628     <span class="comment">// minimum size.</span>
02629     <span class="comment">//</span>
02630 
02631     <a class="code" href="../../d8/d5/kddata_8c.html#a42">MmResidentAvailablePages</a> -= i;
02632     <a class="code" href="../../d4/d8/mi_8h.html#a322">MM_BUMP_COUNTER</a>(27, i);
02633 
02634     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02635 
02636     <span class="keywordflow">if</span> (WsInfo-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o9">AllowWorkingSetAdjustment</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
02637         <a class="code" href="../../d4/d5/procsup_8c.html#a43">MmAllowWorkingSetExpansion</a> ();
02638     }
02639 
02640     <span class="keywordflow">if</span> (WorkingSetMaximum &gt; WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o7">LastInitializedWsle</a>) {
02641 
02642          <span class="keywordflow">do</span> {
02643 
02644             <span class="comment">//</span>
02645             <span class="comment">// The maximum size of the working set is being increased, check</span>
02646             <span class="comment">// to ensure the proper number of pages are mapped to cover</span>
02647             <span class="comment">// the complete working set list.</span>
02648             <span class="comment">//</span>
02649 
02650             <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d0/wslist_8c.html#a16">MiAddWorkingSetPage</a> (WsInfo)) {
02651                 WorkingSetMaximum = WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o7">LastInitializedWsle</a> - 1;
02652                 <span class="keywordflow">break</span>;
02653             }
02654         } <span class="keywordflow">while</span> (WorkingSetMaximum &gt; WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o7">LastInitializedWsle</a>);
02655 
02656     } <span class="keywordflow">else</span> {
02657 
02658         <span class="comment">//</span>
02659         <span class="comment">// The new working set maximum is less than the current working set</span>
02660         <span class="comment">// maximum.</span>
02661         <span class="comment">//</span>
02662 
02663         <span class="keywordflow">if</span> (WsInfo-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o4">WorkingSetSize</a> &gt; WorkingSetMaximum) {
02664 
02665             <span class="comment">//</span>
02666             <span class="comment">// Remove some pages from the working set.</span>
02667             <span class="comment">//</span>
02668 
02669             <span class="comment">//</span>
02670             <span class="comment">// Make sure that the number of locked pages will not</span>
02671             <span class="comment">// make the working set not fluid.</span>
02672             <span class="comment">//</span>
02673 
02674             <span class="keywordflow">if</span> ((WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a> + <a class="code" href="../../d4/d8/mi_8h.html#a15">MM_FLUID_WORKING_SET</a>) &gt;=
02675                  WorkingSetMaximum) {
02676 
02677                 ReturnStatus = STATUS_BAD_WORKING_SET_LIMIT;
02678 
02679                 <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02680 
02681                 <a class="code" href="../../d8/d5/kddata_8c.html#a42">MmResidentAvailablePages</a> += i;
02682                 <a class="code" href="../../d4/d8/mi_8h.html#a322">MM_BUMP_COUNTER</a>(54, i);
02683 
02684                 <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02685 
02686                 <span class="keywordflow">goto</span> Returns;
02687             }
02688 
02689             <span class="comment">//</span>
02690             <span class="comment">// Attempt to remove the pages from the Maximum downward.</span>
02691             <span class="comment">//</span>
02692 
02693             LastFreed = WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o3">LastEntry</a>;
02694             <span class="keywordflow">if</span> (WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o3">LastEntry</a> &gt; WorkingSetMaximum) {
02695 
02696                 <span class="keywordflow">while</span> (LastFreed &gt;= WorkingSetMaximum) {
02697 
02698                     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(
02699                                         Wsle[LastFreed].u1.<a class="code" href="../../d1/d8/struct__MMWSLE.html#o0">VirtualAddress</a>);
02700 
02701                     <a class="code" href="../../d2/d1/mm_8h.html#a53">PERFINFO_GET_PAGE_INFO</a>(PointerPte);
02702 
02703                     <span class="keywordflow">if</span> ((Wsle[LastFreed].<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Valid != 0) &amp;&amp;
02704                         (!<a class="code" href="../../d4/d0/wslist_8c.html#a26">MiFreeWsle</a> (LastFreed,
02705                                       WsInfo,
02706                                       PointerPte))) {
02707 
02708                         <span class="comment">//</span>
02709                         <span class="comment">// This LastFreed could not be removed.</span>
02710                         <span class="comment">//</span>
02711 
02712                         <span class="keywordflow">break</span>;
02713                     }
02714                     <a class="code" href="../../d2/d1/mm_8h.html#a74">PERFINFO_LOG_WS_REMOVAL</a>(PERFINFO_LOG_TYPE_OUTWS_ADJUSTWS, WsInfo);
02715                     LastFreed -= 1;
02716                 }
02717                 WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o3">LastEntry</a> = LastFreed;
02718             }
02719 
02720             <span class="comment">//</span>
02721             <span class="comment">// Remove pages.</span>
02722             <span class="comment">//</span>
02723 
02724             Entry = WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>;
02725 
02726             <span class="keywordflow">while</span> (WsInfo-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o4">WorkingSetSize</a> &gt; WorkingSetMaximum) {
02727                 <span class="keywordflow">if</span> (Wsle[Entry].<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Valid != 0) {
02728                     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (
02729                                             Wsle[Entry].u1.<a class="code" href="../../d1/d8/struct__MMWSLE.html#o0">VirtualAddress</a>);
02730                     <a class="code" href="../../d2/d1/mm_8h.html#a53">PERFINFO_GET_PAGE_INFO</a>(PointerPte);
02731 
02732                     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/wslist_8c.html#a26">MiFreeWsle</a>(Entry, WsInfo, PointerPte)) {
02733                         <a class="code" href="../../d2/d1/mm_8h.html#a74">PERFINFO_LOG_WS_REMOVAL</a>(PERFINFO_LOG_TYPE_OUTWS_ADJUSTWS,
02734                                               WsInfo);
02735                     }
02736                 }
02737                 Entry += 1;
02738                 <span class="keywordflow">if</span> (Entry &gt; LastFreed) {
02739                     FreeTryCount += 1;
02740                     <span class="keywordflow">if</span> (FreeTryCount &gt; <a class="code" href="../../d4/d0/wslist_8c.html#a1">MM_RETRY_COUNT</a>) {
02741 
02742                         <span class="comment">//</span>
02743                         <span class="comment">// Page table pages are not becoming free, give up</span>
02744                         <span class="comment">// and return an error.</span>
02745                         <span class="comment">//</span>
02746 
02747                         ReturnStatus = STATUS_BAD_WORKING_SET_LIMIT;
02748 
02749                         <span class="keywordflow">break</span>;
02750                     }
02751                     Entry = WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>;
02752                 }
02753             }
02754 
02755             <span class="keywordflow">if</span> (FreeTryCount &lt;= <a class="code" href="../../d4/d0/wslist_8c.html#a1">MM_RETRY_COUNT</a>) {
02756                 WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o0">Quota</a> = WorkingSetMaximum;
02757             }
02758         }
02759     }
02760 
02761     <span class="comment">//</span>
02762     <span class="comment">// Adjust the number of pages above the working set minimum.</span>
02763     <span class="comment">//</span>
02764 
02765     PagesAbove = (LONG)WsInfo-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o4">WorkingSetSize</a> -
02766                                (LONG)WsInfo-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o5">MinimumWorkingSetSize</a>;
02767     NewPagesAbove = (LONG)WsInfo-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o4">WorkingSetSize</a> -
02768                                (LONG)WorkingSetMinimum;
02769 
02770     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02771     <span class="keywordflow">if</span> (PagesAbove &gt; 0) {
02772         <a class="code" href="../../d4/d8/mi_8h.html#a590">MmPagesAboveWsMinimum</a> -= (ULONG)PagesAbove;
02773     }
02774     <span class="keywordflow">if</span> (NewPagesAbove &gt; 0) {
02775         <a class="code" href="../../d4/d8/mi_8h.html#a590">MmPagesAboveWsMinimum</a> += (ULONG)NewPagesAbove;
02776     }
02777     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02778 
02779     <span class="keywordflow">if</span> (FreeTryCount &lt;= <a class="code" href="../../d4/d0/wslist_8c.html#a1">MM_RETRY_COUNT</a>) {
02780         WsInfo-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o6">MaximumWorkingSetSize</a> = WorkingSetMaximum;
02781         WsInfo-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o5">MinimumWorkingSetSize</a> = WorkingSetMinimum;
02782 
02783         <span class="keywordflow">if</span> (WorkingSetMinimum &gt;= WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o0">Quota</a>) {
02784             WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o0">Quota</a> = WorkingSetMinimum;
02785         }
02786     }
02787     <span class="keywordflow">else</span> {
02788         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02789 
02790         <a class="code" href="../../d8/d5/kddata_8c.html#a42">MmResidentAvailablePages</a> += i;
02791         <a class="code" href="../../d4/d8/mi_8h.html#a322">MM_BUMP_COUNTER</a>(55, i);
02792 
02793         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02794     }
02795 
02796 
02797     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o1">FirstFree</a> &lt;= WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o7">LastInitializedWsle</a>) ||
02798             (WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o1">FirstFree</a> == <a class="code" href="../../d4/d8/mi_8h.html#a10">WSLE_NULL_INDEX</a>));
02799 
02800     <span class="keywordflow">if</span> ((WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o9">HashTable</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
02801         (WsInfo-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o6">MaximumWorkingSetSize</a> &gt; ((1536*1024) &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>))) {
02802 
02803         <span class="comment">//</span>
02804         <span class="comment">// The working set list consists of more than a single page.</span>
02805         <span class="comment">//</span>
02806 
02807         <a class="code" href="../../d4/d0/wslist_8c.html#a33">MiGrowWsleHash</a> (WsInfo);
02808     }
02809 
02810 Returns:
02811 
02812     <span class="keywordflow">if</span> (SystemCache) {
02813         <a class="code" href="../../d4/d8/mi_8h.html#a145">UNLOCK_SYSTEM_WS</a> (OldIrql2);
02814     } <span class="keywordflow">else</span> {
02815         <a class="code" href="../../d4/d8/mi_8h.html#a158">UNLOCK_WS</a> (CurrentProcess);
02816     }
02817 
02818     <a class="code" href="../../d5/d6/iosup_8c.html#a81">MmUnlockPagableImageSection</a>(<a class="code" href="../../d5/d8/ex_8h.html#a166">ExPageLockHandle</a>);
02819 
02820     <span class="keywordflow">return</span> ReturnStatus;
02821 }
02822 
02823 ULONG
<a name="l02824"></a><a class="code" href="../../d4/d0/wslist_8c.html#a16">02824</a> <a class="code" href="../../d4/d0/wslist_8c.html#a16">MiAddWorkingSetPage</a> (
02825     IN <a class="code" href="../../d3/d6/struct__MMSUPPORT.html">PMMSUPPORT</a> WsInfo
02826     )
02827 
02828 <span class="comment">/*++</span>
02829 <span class="comment"></span>
02830 <span class="comment">Routine Description:</span>
02831 <span class="comment"></span>
02832 <span class="comment">    This function grows the working set list above working set</span>
02833 <span class="comment">    maximum during working set adjustment.  At most one page</span>
02834 <span class="comment">    can be added at a time.</span>
02835 <span class="comment"></span>
02836 <span class="comment">Arguments:</span>
02837 <span class="comment"></span>
02838 <span class="comment">    None.</span>
02839 <span class="comment"></span>
02840 <span class="comment">Return Value:</span>
02841 <span class="comment"></span>
02842 <span class="comment">    Returns FALSE if no working set page could be added.</span>
02843 <span class="comment"></span>
02844 <span class="comment">Environment:</span>
02845 <span class="comment"></span>
02846 <span class="comment">    Kernel mode, APCs disabled, working set mutexes held.</span>
02847 <span class="comment"></span>
02848 <span class="comment">--*/</span>
02849 
02850 {
02851     ULONG SwapEntry;
02852     ULONG CurrentEntry;
02853     <a class="code" href="../../d1/d8/struct__MMWSLE.html">PMMWSLE</a> WslEntry;
02854     ULONG i;
02855     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
02856     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPde;
02857     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> Va;
02858     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
02859     <a class="code" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a> NumberOfEntriesMapped;
02860     PFN_NUMBER WorkingSetPage;
02861     <a class="code" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a> WorkingSetIndex;
02862     <a class="code" href="../../d0/d8/struct__MMWSL.html">PMMWSL</a> WorkingSetList;
02863     <a class="code" href="../../d1/d8/struct__MMWSLE.html">PMMWSLE</a> Wsle;
02864     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
02865     KIRQL OldIrql;
02866     LOGICAL PageTablePageAllocated;
02867 
02868     WorkingSetList = WsInfo-&gt;VmWorkingSetList;
02869     Wsle = WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o5">Wsle</a>;
02870 
02871 <span class="preprocessor">#if DBG</span>
02872 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (WsInfo == &amp;<a class="code" href="../../d6/d8/sysinfo_8c.html#a21">MmSystemCacheWs</a>) {
02873         <a class="code" href="../../d4/d8/mi_8h.html#a147">MM_SYSTEM_WS_LOCK_ASSERT</a>();
02874     }
02875 <span class="preprocessor">#endif //DBG</span>
02876 <span class="preprocessor"></span>
02877     <span class="comment">//</span>
02878     <span class="comment">// The maximum size of the working set is being increased, check</span>
02879     <span class="comment">// to ensure the proper number of pages are mapped to cover</span>
02880     <span class="comment">// the complete working set list.</span>
02881     <span class="comment">//</span>
02882 
02883     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (&amp;Wsle[WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o7">LastInitializedWsle</a>]);
02884 
02885     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1);
02886 
02887     PointerPte += 1;
02888 
02889     Va = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPte);
02890 
02891     <span class="keywordflow">if</span> ((PVOID)Va &gt;= WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o12">HashTableStart</a>) {
02892 
02893         <span class="comment">//</span>
02894         <span class="comment">// Adding this entry would overrun the hash table.  The caller</span>
02895         <span class="comment">// must replace instead.</span>
02896         <span class="comment">//</span>
02897 
02898         WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o0">Quota</a> = WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o7">LastInitializedWsle</a>;
02899         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02900     }
02901 
02902     PageTablePageAllocated = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02903 
02904 <span class="preprocessor">#if defined (_WIN64)</span>
02905 <span class="preprocessor"></span>    PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPte);
02906     <span class="keywordflow">if</span> (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) {
02907 
02908         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (WsInfo-&gt;u.Flags.SessionSpace == 0);
02909 
02910         <span class="comment">//</span>
02911         <span class="comment">// Map in a new working set page.</span>
02912         <span class="comment">//</span>
02913     
02914         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02915         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> &lt; 21) {
02916     
02917             <span class="comment">//</span>
02918             <span class="comment">// No pages are available, set the quota to the last</span>
02919             <span class="comment">// initialized WSLE and return.</span>
02920             <span class="comment">//</span>
02921     
02922             WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o0">Quota</a> = WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o7">LastInitializedWsle</a>;
02923             <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02924             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02925         }
02926     
02927         PageTablePageAllocated = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02928         WorkingSetPage = <a class="code" href="../../d7/d5/pfnlist_8c.html#a14">MiRemoveZeroPage</a> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a124">MI_GET_PAGE_COLOR_FROM_PTE</a> (PointerPde));
02929         PointerPde-&gt;u.Long = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a95">MM_DEMAND_ZERO_WRITE_PTE</a>;
02930         <a class="code" href="../../d8/d2/pagfault_8c.html#a22">MiInitializePfn</a> (WorkingSetPage, PointerPde, 1);
02931         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02932     
02933         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a105">MI_MAKE_VALID_PTE</a> (TempPte,
02934                            WorkingSetPage,
02935                            <a class="code" href="../../d4/d8/mi_8h.html#a39">MM_READWRITE</a>,
02936                            PointerPde);
02937     
02938         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a112">MI_SET_PTE_DIRTY</a> (TempPte);
02939         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a> (PointerPde, TempPte);
02940     
02941         <span class="comment">//</span>
02942         <span class="comment">// Further down in this routine (once an actual working set page</span>
02943         <span class="comment">// has been allocated) the quota will be increased by 1 to reflect</span>
02944         <span class="comment">// the working set size entry for the new page table page.</span>
02945         <span class="comment">// The page table page will be put in a working set entry which will</span>
02946         <span class="comment">// be locked into the working set.</span>
02947         <span class="comment">//</span>
02948     }
02949 <span class="preprocessor">#endif</span>
02950 <span class="preprocessor"></span>
02951     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0);
02952 
02953     NumberOfEntriesMapped = (<a class="code" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a>)(((<a class="code" href="../../d1/d8/struct__MMWSLE.html">PMMWSLE</a>)((PCHAR)Va + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>)) - Wsle);
02954 
02955     <span class="comment">//</span>
02956     <span class="comment">// Map in a new working set page.</span>
02957     <span class="comment">//</span>
02958 
02959     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02960     <span class="keywordflow">if</span> ((PageTablePageAllocated == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) &amp;&amp; (<a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> &lt; 20)) {
02961 
02962         <span class="comment">//</span>
02963         <span class="comment">// No pages are available, set the quota to the last</span>
02964         <span class="comment">// initialized WSLE and return.</span>
02965         <span class="comment">//</span>
02966 
02967         WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o0">Quota</a> = WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o7">LastInitializedWsle</a>;
02968         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02969         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02970     }
02971 
02972     WorkingSetPage = <a class="code" href="../../d7/d5/pfnlist_8c.html#a14">MiRemoveZeroPage</a> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a124">MI_GET_PAGE_COLOR_FROM_PTE</a> (PointerPte));
02973     PointerPte-&gt;u.Long = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a95">MM_DEMAND_ZERO_WRITE_PTE</a>;
02974     <a class="code" href="../../d8/d2/pagfault_8c.html#a22">MiInitializePfn</a> (WorkingSetPage, PointerPte, 1);
02975     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02976 
02977     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a105">MI_MAKE_VALID_PTE</a> (TempPte,
02978                        WorkingSetPage,
02979                        <a class="code" href="../../d4/d8/mi_8h.html#a39">MM_READWRITE</a>,
02980                        PointerPte);
02981 
02982     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a112">MI_SET_PTE_DIRTY</a> (TempPte);
02983     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a> (PointerPte, TempPte);
02984 
02985     <span class="keywordflow">if</span> (WsInfo-&gt;u.Flags.SessionSpace == 1) {
02986         <a class="code" href="../../d4/d8/mi_8h.html#a384">MM_BUMP_SESS_COUNTER</a> (<a class="code" href="../../d4/d8/mi_8h.html#a369">MM_DBG_SESSION_WS_PAGE_ALLOC_GROWTH</a>, 1);
02987         <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o13">NonPagablePages</a> += 1;
02988         <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o14">CommittedPages</a> += 1;
02989         <a class="code" href="../../d6/d1/mmquota_8c.html#a18">MiChargeCommitmentCantExpand</a> (1, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02990         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02991         <a class="code" href="../../d4/d8/mi_8h.html#a322">MM_BUMP_COUNTER</a> (48, 1);
02992         <a class="code" href="../../d8/d5/kddata_8c.html#a42">MmResidentAvailablePages</a> -= 1;
02993         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02994         <a class="code" href="../../d4/d8/mi_8h.html#a254">MM_TRACK_COMMIT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a284">MM_DBG_COMMIT_SESSION_ADDITIONAL_WS_PAGES</a>, 1);
02995     }
02996 
02997     CurrentEntry = WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o7">LastInitializedWsle</a> + 1;
02998 
02999     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (NumberOfEntriesMapped &gt; CurrentEntry);
03000 
03001     WslEntry = &amp;Wsle[CurrentEntry - 1];
03002 
03003     <span class="keywordflow">for</span> (i = CurrentEntry; i &lt; NumberOfEntriesMapped; i += 1) {
03004 
03005         <span class="comment">//</span>
03006         <span class="comment">// Build the free list, note that the first working</span>
03007         <span class="comment">// set entries (CurrentEntry) are not on the free list.</span>
03008         <span class="comment">// These entries are reserved for the pages which</span>
03009         <span class="comment">// map the working set and the page which contains the PDE.</span>
03010         <span class="comment">//</span>
03011 
03012         WslEntry += 1;
03013         WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.Long = (i + 1) &lt;&lt; <a class="code" href="../../d4/d8/mi_8h.html#a9">MM_FREE_WSLE_SHIFT</a>;
03014     }
03015 
03016     WslEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.Long = WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o1">FirstFree</a> &lt;&lt; <a class="code" href="../../d4/d8/mi_8h.html#a9">MM_FREE_WSLE_SHIFT</a>;
03017 
03018     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (CurrentEntry &gt;= WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>);
03019 
03020     WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o1">FirstFree</a> = CurrentEntry;
03021 
03022     WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o7">LastInitializedWsle</a> = (NumberOfEntriesMapped - 1);
03023 
03024     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o1">FirstFree</a> &lt;= WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o7">LastInitializedWsle</a>) ||
03025             (WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o1">FirstFree</a> == <a class="code" href="../../d4/d8/mi_8h.html#a10">WSLE_NULL_INDEX</a>));
03026 
03027     <span class="comment">//</span>
03028     <span class="comment">// As we are growing the working set, make sure the quota is</span>
03029     <span class="comment">// above the working set size by adding 1 to the quota.</span>
03030     <span class="comment">//</span>
03031 
03032     WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o0">Quota</a> += 1;
03033 
03034     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PointerPte-&gt;u.Hard.PageFrameNumber);
03035 
03036     <a class="code" href="../../d4/d8/mi_8h.html#a121">CONSISTENCY_LOCK_PFN</a> (OldIrql);
03037 
03038     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Event = (PVOID)<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
03039 
03040     <a class="code" href="../../d4/d8/mi_8h.html#a122">CONSISTENCY_UNLOCK_PFN</a> (OldIrql);
03041 
03042     <span class="comment">//</span>
03043     <span class="comment">// Get a working set entry.</span>
03044     <span class="comment">//</span>
03045 
03046     WsInfo-&gt;WorkingSetSize += 1;
03047 
03048     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o1">FirstFree</a> != <a class="code" href="../../d4/d8/mi_8h.html#a10">WSLE_NULL_INDEX</a>);
03049     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o1">FirstFree</a> &gt;= WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>);
03050 
03051     WorkingSetIndex = WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o1">FirstFree</a>;
03052     WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o1">FirstFree</a> = (<a class="code" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a>)(Wsle[WorkingSetIndex].u1.Long &gt;&gt; <a class="code" href="../../d4/d8/mi_8h.html#a9">MM_FREE_WSLE_SHIFT</a>);
03053     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o1">FirstFree</a> &lt;= WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o7">LastInitializedWsle</a>) ||
03054             (WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o1">FirstFree</a> == <a class="code" href="../../d4/d8/mi_8h.html#a10">WSLE_NULL_INDEX</a>));
03055 
03056     <span class="keywordflow">if</span> (WsInfo-&gt;WorkingSetSize &gt; WsInfo-&gt;MinimumWorkingSetSize) {
03057         <a class="code" href="../../d4/d8/mi_8h.html#a590">MmPagesAboveWsMinimum</a> += 1;
03058     }
03059     <span class="keywordflow">if</span> (WorkingSetIndex &gt; WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o3">LastEntry</a>) {
03060         WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o3">LastEntry</a> = WorkingSetIndex;
03061     }
03062 
03063     <a class="code" href="../../d4/d0/wslist_8c.html#a25">MiUpdateWsle</a> (&amp;WorkingSetIndex, Va, WorkingSetList, Pfn1);
03064 
03065     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a109">MI_SET_PTE_IN_WORKING_SET</a> (PointerPte, WorkingSetIndex);
03066 
03067     <span class="comment">//</span>
03068     <span class="comment">// Lock any created page table pages into the working set.</span>
03069     <span class="comment">//</span>
03070 
03071     <span class="keywordflow">if</span> (WorkingSetIndex &gt;= WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>) {
03072 
03073         SwapEntry = WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>;
03074 
03075         <span class="keywordflow">if</span> (WorkingSetIndex != WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>) {
03076 
03077             <span class="comment">//</span>
03078             <span class="comment">// Swap this entry with the one at first dynamic.</span>
03079             <span class="comment">//</span>
03080 
03081             <a class="code" href="../../d7/d0/wstree_8c.html#a9">MiSwapWslEntries</a> (WorkingSetIndex, SwapEntry, WsInfo);
03082         }
03083 
03084         WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a> += 1;
03085 
03086         Wsle[SwapEntry].u1.e1.LockedInWs = 1;
03087         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Wsle[SwapEntry].u1.e1.Valid == 1);
03088     }
03089 
03090 <span class="preprocessor">#if defined (_WIN64)</span>
03091 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (PageTablePageAllocated == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
03092     
03093         <span class="comment">//</span>
03094         <span class="comment">// As we are growing the working set, make sure the quota is</span>
03095         <span class="comment">// above the working set size by adding 1 to the quota.</span>
03096         <span class="comment">//</span>
03097     
03098         WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o0">Quota</a> += 1;
03099     
03100         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber);
03101     
03102         <a class="code" href="../../d4/d8/mi_8h.html#a121">CONSISTENCY_LOCK_PFN</a> (OldIrql);
03103     
03104         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Event = (PVOID)<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
03105     
03106         <a class="code" href="../../d4/d8/mi_8h.html#a122">CONSISTENCY_UNLOCK_PFN</a> (OldIrql);
03107     
03108         <span class="comment">//</span>
03109         <span class="comment">// Get a working set entry.</span>
03110         <span class="comment">//</span>
03111     
03112         WsInfo-&gt;WorkingSetSize += 1;
03113     
03114         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o1">FirstFree</a> != <a class="code" href="../../d4/d8/mi_8h.html#a10">WSLE_NULL_INDEX</a>);
03115         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o1">FirstFree</a> &gt;= WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>);
03116     
03117         WorkingSetIndex = WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o1">FirstFree</a>;
03118         WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o1">FirstFree</a> = (<a class="code" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a>)(Wsle[WorkingSetIndex].u1.Long &gt;&gt; <a class="code" href="../../d4/d8/mi_8h.html#a9">MM_FREE_WSLE_SHIFT</a>);
03119         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o1">FirstFree</a> &lt;= WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o7">LastInitializedWsle</a>) ||
03120                 (WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o1">FirstFree</a> == <a class="code" href="../../d4/d8/mi_8h.html#a10">WSLE_NULL_INDEX</a>));
03121     
03122         <span class="keywordflow">if</span> (WsInfo-&gt;WorkingSetSize &gt; WsInfo-&gt;MinimumWorkingSetSize) {
03123             <a class="code" href="../../d4/d8/mi_8h.html#a590">MmPagesAboveWsMinimum</a> += 1;
03124         }
03125         <span class="keywordflow">if</span> (WorkingSetIndex &gt; WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o3">LastEntry</a>) {
03126             WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o3">LastEntry</a> = WorkingSetIndex;
03127         }
03128     
03129         <a class="code" href="../../d4/d0/wslist_8c.html#a25">MiUpdateWsle</a> (&amp;WorkingSetIndex, PointerPte, WorkingSetList, Pfn1);
03130     
03131         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a109">MI_SET_PTE_IN_WORKING_SET</a> (PointerPde, WorkingSetIndex);
03132     
03133         <span class="comment">//</span>
03134         <span class="comment">// Lock the created page table page into the working set.</span>
03135         <span class="comment">//</span>
03136     
03137         <span class="keywordflow">if</span> (WorkingSetIndex &gt;= WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>) {
03138     
03139             SwapEntry = WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>;
03140     
03141             <span class="keywordflow">if</span> (WorkingSetIndex != WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>) {
03142     
03143                 <span class="comment">//</span>
03144                 <span class="comment">// Swap this entry with the one at first dynamic.</span>
03145                 <span class="comment">//</span>
03146     
03147                 <a class="code" href="../../d7/d0/wstree_8c.html#a9">MiSwapWslEntries</a> (WorkingSetIndex, SwapEntry, WsInfo);
03148             }
03149     
03150             WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a> += 1;
03151     
03152             Wsle[SwapEntry].u1.e1.LockedInWs = 1;
03153             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Wsle[SwapEntry].u1.e1.Valid == 1);
03154         }
03155     }
03156 <span class="preprocessor">#endif</span>
03157 <span class="preprocessor"></span>
03158     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(&amp;Wsle[WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o7">LastInitializedWsle</a>]))-&gt;u.Hard.Valid == 1);
03159 
03160     <span class="keywordflow">if</span> ((WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o9">HashTable</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
03161         (<a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> &gt; 20)) {
03162 
03163         <span class="comment">//</span>
03164         <span class="comment">// Add a hash table to support shared pages in the working set to</span>
03165         <span class="comment">// eliminate costly lookups.</span>
03166         <span class="comment">//</span>
03167 
03168         <a class="code" href="../../d4/d8/mi_8h.html#a142">LOCK_EXPANSION_IF_ALPHA</a> (OldIrql);
03169         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (WsInfo-&gt;AllowWorkingSetAdjustment != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
03170         WsInfo-&gt;AllowWorkingSetAdjustment = <a class="code" href="../../d4/d8/mi_8h.html#a32">MM_GROW_WSLE_HASH</a>;
03171         <a class="code" href="../../d4/d8/mi_8h.html#a143">UNLOCK_EXPANSION_IF_ALPHA</a> (OldIrql);
03172     }
03173 
03174     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (WsInfo-&gt;WorkingSetSize &lt;= WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o0">Quota</a>);
03175     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03176 }
03177 
03178 LOGICAL
<a name="l03179"></a><a class="code" href="../../d4/d0/wslist_8c.html#a32">03179</a> <a class="code" href="../../d4/d0/wslist_8c.html#a32">MiAddWsleHash</a> (
03180     IN <a class="code" href="../../d3/d6/struct__MMSUPPORT.html">PMMSUPPORT</a> WsInfo,
03181     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte
03182     )
03183 
03184 <span class="comment">/*++</span>
03185 <span class="comment"></span>
03186 <span class="comment">Routine Description:</span>
03187 <span class="comment"></span>
03188 <span class="comment">    This function adds a page directory, page table or actual mapping page</span>
03189 <span class="comment">    for hash table creation (or expansion) for the current process.</span>
03190 <span class="comment"></span>
03191 <span class="comment">Arguments:</span>
03192 <span class="comment"></span>
03193 <span class="comment">    WsInfo - Supplies a pointer to the working set info block for the</span>
03194 <span class="comment">             process (or system cache).</span>
03195 <span class="comment"></span>
03196 <span class="comment">    PointerPte - Supplies a pointer to the PTE to be filled.</span>
03197 <span class="comment"></span>
03198 <span class="comment">Return Value:</span>
03199 <span class="comment"></span>
03200 <span class="comment">    None.</span>
03201 <span class="comment"></span>
03202 <span class="comment">Environment:</span>
03203 <span class="comment"></span>
03204 <span class="comment">    Kernel mode, APCs disabled, working set lock held.</span>
03205 <span class="comment"></span>
03206 <span class="comment">--*/</span>
03207 {
03208     KIRQL OldIrql;
03209     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
03210     ULONG SwapEntry;
03211     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
03212     PVOID Va;
03213     <a class="code" href="../../d1/d8/struct__MMWSLE.html">PMMWSLE</a> Wsle;
03214     PFN_NUMBER WorkingSetPage;
03215     <a class="code" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a> WorkingSetIndex;
03216     <a class="code" href="../../d0/d8/struct__MMWSL.html">PMMWSL</a> WorkingSetList;
03217 
03218     WorkingSetList = WsInfo-&gt;VmWorkingSetList;
03219     Wsle = WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o5">Wsle</a>;
03220 
03221     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte-&gt;u.Hard.Valid == 0);
03222 
03223     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
03224 
03225     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> &lt; 10) {
03226         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
03227         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03228     }
03229 
03230     WorkingSetPage = <a class="code" href="../../d7/d5/pfnlist_8c.html#a14">MiRemoveZeroPage</a> (
03231                                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a124">MI_GET_PAGE_COLOR_FROM_PTE</a> (PointerPte));
03232 
03233     PointerPte-&gt;u.Long = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a95">MM_DEMAND_ZERO_WRITE_PTE</a>;
03234     <a class="code" href="../../d8/d2/pagfault_8c.html#a22">MiInitializePfn</a> (WorkingSetPage, PointerPte, 1);
03235 
03236     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a105">MI_MAKE_VALID_PTE</a> (TempPte,
03237                        WorkingSetPage,
03238                        <a class="code" href="../../d4/d8/mi_8h.html#a39">MM_READWRITE</a>,
03239                        PointerPte );
03240 
03241     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a112">MI_SET_PTE_DIRTY</a> (TempPte);
03242     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a> (PointerPte, TempPte);
03243 
03244     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
03245 
03246     <span class="comment">//</span>
03247     <span class="comment">// As we are growing the working set, we know that quota</span>
03248     <span class="comment">// is above the current working set size.  Just take the</span>
03249     <span class="comment">// next free WSLE from the list and use it.</span>
03250     <span class="comment">//</span>
03251 
03252     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PointerPte-&gt;u.Hard.PageFrameNumber);
03253 
03254     <a class="code" href="../../d4/d8/mi_8h.html#a121">CONSISTENCY_LOCK_PFN</a> (OldIrql);
03255 
03256     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Event = (PVOID)<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
03257 
03258     <a class="code" href="../../d4/d8/mi_8h.html#a122">CONSISTENCY_UNLOCK_PFN</a> (OldIrql);
03259 
03260     Va = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPte);
03261 
03262     WorkingSetIndex = <a class="code" href="../../d4/d0/wslist_8c.html#a21">MiLocateAndReserveWsle</a> (WsInfo);
03263     <a class="code" href="../../d4/d0/wslist_8c.html#a25">MiUpdateWsle</a> (&amp;WorkingSetIndex, Va, WorkingSetList, Pfn1);
03264     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a109">MI_SET_PTE_IN_WORKING_SET</a> (PointerPte, WorkingSetIndex);
03265 
03266     <span class="comment">//</span>
03267     <span class="comment">// Lock any created page table pages into the working set.</span>
03268     <span class="comment">//</span>
03269 
03270     <span class="keywordflow">if</span> (WorkingSetIndex &gt;= WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>) {
03271 
03272         SwapEntry = WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>;
03273 
03274         <span class="keywordflow">if</span> (WorkingSetIndex != WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>) {
03275 
03276             <span class="comment">//</span>
03277             <span class="comment">// Swap this entry with the one at first dynamic.</span>
03278             <span class="comment">//</span>
03279 
03280             <a class="code" href="../../d7/d0/wstree_8c.html#a9">MiSwapWslEntries</a> (WorkingSetIndex, SwapEntry, WsInfo);
03281         }
03282 
03283         WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a> += 1;
03284 
03285         Wsle[SwapEntry].<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.LockedInWs = 1;
03286         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Wsle[SwapEntry].u1.<a class="code" href="../../d1/d8/struct__MMWSLE.html#o2">e1</a>.<a class="code" href="../../d4/d8/struct__MMWSLENTRY.html#o0">Valid</a> == 1);
03287     }
03288 
03289     <span class="keywordflow">if</span> (WsInfo-&gt;u.Flags.SessionSpace == 1) {
03290         <a class="code" href="../../d4/d8/mi_8h.html#a384">MM_BUMP_SESS_COUNTER</a> (<a class="code" href="../../d4/d8/mi_8h.html#a375">MM_DBG_SESSION_WS_HASHPAGE_ALLOC</a>, 1);
03291         <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o13">NonPagablePages</a> += 1;
03292         <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o14">CommittedPages</a> += 1;
03293         <a class="code" href="../../d6/d1/mmquota_8c.html#a18">MiChargeCommitmentCantExpand</a> (1, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
03294         <a class="code" href="../../d4/d8/mi_8h.html#a254">MM_TRACK_COMMIT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a285">MM_DBG_COMMIT_SESSION_ADDITIONAL_WS_HASHPAGES</a>, 1);
03295     }
03296     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03297 }
03298 
03299 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l03300"></a><a class="code" href="../../d4/d0/wslist_8c.html#a33">03300</a> <a class="code" href="../../d4/d0/wslist_8c.html#a33">MiGrowWsleHash</a> (
03301     IN <a class="code" href="../../d3/d6/struct__MMSUPPORT.html">PMMSUPPORT</a> WsInfo
03302     )
03303 
03304 <span class="comment">/*++</span>
03305 <span class="comment"></span>
03306 <span class="comment">Routine Description:</span>
03307 <span class="comment"></span>
03308 <span class="comment">    This function grows (or adds) a hash table to the working set list</span>
03309 <span class="comment">    to allow direct indexing for WSLEs than cannot be located via the</span>
03310 <span class="comment">    PFN database WSINDEX field.</span>
03311 <span class="comment"></span>
03312 <span class="comment">    The hash table is located AFTER the WSLE array and the pages are</span>
03313 <span class="comment">    locked into the working set just like standard WSLEs.</span>
03314 <span class="comment"></span>
03315 <span class="comment">    Note that the hash table is expanded by setting the hash table</span>
03316 <span class="comment">    field in the working set to NULL, but leaving the size as non-zero.</span>
03317 <span class="comment">    This indicates that the hash should be expanded and the initial</span>
03318 <span class="comment">    portion of the table zeroed.</span>
03319 <span class="comment"></span>
03320 <span class="comment">Arguments:</span>
03321 <span class="comment"></span>
03322 <span class="comment">    WsInfo - Supplies a pointer to the working set info block for the</span>
03323 <span class="comment">             process (or system cache).</span>
03324 <span class="comment"></span>
03325 <span class="comment">Return Value:</span>
03326 <span class="comment"></span>
03327 <span class="comment">    None.</span>
03328 <span class="comment"></span>
03329 <span class="comment">Environment:</span>
03330 <span class="comment"></span>
03331 <span class="comment">    Kernel mode, APCs disabled, working set lock held.</span>
03332 <span class="comment"></span>
03333 <span class="comment">--*/</span>
03334 {
03335     LONG <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
03336     <a class="code" href="../../d1/d8/struct__MMWSLE.html">PMMWSLE</a> Wsle;
03337     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> StartPte;
03338     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> EndPte;
03339     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
03340     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPde;
03341     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPpe;
03342     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> AllocatedPde;
03343     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> AllocatedPpe;
03344     ULONG First;
03345     ULONG Hash;
03346     ULONG NewSize;
03347     <a class="code" href="../../d3/d8/struct__MMWSLE__HASH.html">PMMWSLE_HASH</a> Table;
03348     <a class="code" href="../../d3/d8/struct__MMWSLE__HASH.html">PMMWSLE_HASH</a> OriginalTable;
03349     ULONG j;
03350     <a class="code" href="../../d0/d8/struct__MMWSL.html">PMMWSL</a> WorkingSetList;
03351     KIRQL OldIrql;
03352     ULONG <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>;
03353     LOGICAL LoopStart;
03354     PVOID EntryHashTableEnd;
03355     PVOID TempVa;
03356     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> CurrentProcess;
03357 
03358     WorkingSetList = WsInfo-&gt;VmWorkingSetList;
03359     Wsle = WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o5">Wsle</a>;
03360 
03361     Table = WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o9">HashTable</a>;
03362     OriginalTable = WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o9">HashTable</a>;
03363 
03364     First = WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o10">HashTableSize</a>;
03365 
03366     <span class="keywordflow">if</span> (Table == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03367 
03368         NewSize = PtrToUlong(<a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a> (((1 + WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o8">NonDirectCount</a>) *
03369                             2 * <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d8/struct__MMWSLE__HASH.html">MMWSLE_HASH</a>)) + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1));
03370 
03371         <span class="comment">//</span>
03372         <span class="comment">// Note that the Table may be NULL and the HashTableSize/PTEs nonzero</span>
03373         <span class="comment">// in the case where the hash has been contracted.</span>
03374         <span class="comment">//</span>
03375 
03376         j = First * <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d8/mi_8h.html#a444">MMWSLE_HASH</a>);
03377 
03378         <span class="comment">//</span>
03379         <span class="comment">// Don't try for additional hash pages if we already have</span>
03380         <span class="comment">// the right amount (or too many).</span>
03381         <span class="comment">//</span>
03382 
03383         <span class="keywordflow">if</span> ((j + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> &gt; NewSize) &amp;&amp; (j != 0)) {
03384             <span class="keywordflow">return</span>;
03385         }
03386 
03387         Table = (<a class="code" href="../../d3/d8/struct__MMWSLE__HASH.html">PMMWSLE_HASH</a>)(WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o12">HashTableStart</a>);
03388         EntryHashTableEnd = &amp;Table[WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o10">HashTableSize</a>];
03389 
03390         WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o10">HashTableSize</a> = 0;
03391 
03392     } <span class="keywordflow">else</span> {
03393 
03394         <span class="comment">//</span>
03395         <span class="comment">// Attempt to add 4 pages, make sure the working set list has</span>
03396         <span class="comment">// 4 free entries.</span>
03397         <span class="comment">//</span>
03398 
03399         <span class="keywordflow">if</span> ((WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o7">LastInitializedWsle</a> + 5) &gt; WsInfo-&gt;WorkingSetSize) {
03400             NewSize = <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> * 4;
03401         } <span class="keywordflow">else</span> {
03402             NewSize = <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
03403         }
03404         EntryHashTableEnd = &amp;Table[WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o10">HashTableSize</a>];
03405     }
03406 
03407     <span class="keywordflow">if</span> ((PCHAR)EntryHashTableEnd + NewSize &gt; (PCHAR)WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o13">HighestPermittedHashAddress</a>) {
03408         NewSize =
03409             (ULONG)((PCHAR)(WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o13">HighestPermittedHashAddress</a>) -
03410                 ((PCHAR)EntryHashTableEnd));
03411         <span class="keywordflow">if</span> (NewSize == 0) {
03412             <span class="keywordflow">if</span> (OriginalTable == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03413                 WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o10">HashTableSize</a> = First;
03414             }
03415             <span class="keywordflow">return</span>;
03416         }
03417     }
03418 
03419     <a class="code" href="../../d4/d8/mi_8h.html#a1">ASSERT64</a> ((<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a150">MiGetPpeAddress</a>(EntryHashTableEnd)-&gt;u.Hard.Valid == 0) ||
03420               (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a>(EntryHashTableEnd)-&gt;u.Hard.Valid == 0) ||
03421               (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(EntryHashTableEnd)-&gt;u.Hard.Valid == 0));
03422 
03423     <a class="code" href="../../d4/d8/mi_8h.html#a0">ASSERT32</a> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(EntryHashTableEnd)-&gt;u.Hard.Valid == 0);
03424 
03425     <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = NewSize;
03426     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (EntryHashTableEnd);
03427     StartPte = PointerPte;
03428     EndPte = PointerPte + (NewSize &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
03429 
03430 <span class="preprocessor">#if defined (_WIN64)</span>
03431 <span class="preprocessor"></span>    LoopStart = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03432     AllocatedPde = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03433     AllocatedPpe = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03434 <span class="preprocessor">#endif</span>
03435 <span class="preprocessor"></span>
03436     <span class="keywordflow">do</span> {
03437 
03438 <span class="preprocessor">#if defined (_WIN64)</span>
03439 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (LoopStart == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> || <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a167">MiIsPteOnPdeBoundary</a>(PointerPte)) {
03440 
03441             PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a>(PointerPte);
03442             PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(PointerPte);
03443 
03444             <span class="keywordflow">if</span> (PointerPpe-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) {
03445                 <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/wslist_8c.html#a32">MiAddWsleHash</a> (WsInfo, PointerPpe) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
03446                     <span class="keywordflow">break</span>;
03447                 }
03448                 AllocatedPpe = PointerPpe;
03449             }
03450 
03451             <span class="keywordflow">if</span> (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) {
03452                 <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/wslist_8c.html#a32">MiAddWsleHash</a> (WsInfo, PointerPde) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
03453                     <span class="keywordflow">break</span>;
03454                 }
03455                 AllocatedPde = PointerPde;
03456             }
03457 
03458             LoopStart = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03459         }
03460         <span class="keywordflow">else</span> {
03461             AllocatedPde = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03462             AllocatedPpe = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03463         }
03464 <span class="preprocessor">#endif</span>
03465 <span class="preprocessor"></span>
03466         <span class="keywordflow">if</span> (PointerPte-&gt;u.Hard.Valid == 0) {
03467             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/wslist_8c.html#a32">MiAddWsleHash</a> (WsInfo, PointerPte) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
03468                 <span class="keywordflow">break</span>;
03469             }
03470         }
03471 
03472         PointerPte += 1;
03473         <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> -= <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
03474     } <span class="keywordflow">while</span> (<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> &gt; 0);
03475 
03476     <span class="comment">//</span>
03477     <span class="comment">// If MiAddWsleHash was unable to allocate memory above, then roll back</span>
03478     <span class="comment">// any extra PPEs &amp; PDEs that may have been created.  Note NewSize must</span>
03479     <span class="comment">// be recalculated to handle the fact that memory may have run out.</span>
03480     <span class="comment">//</span>
03481 
03482 <span class="preprocessor">#if !defined (_WIN64)</span>
03483 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (PointerPte == StartPte) {
03484         <span class="keywordflow">if</span> (OriginalTable == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03485             WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o10">HashTableSize</a> = First;
03486         }
03487         <span class="keywordflow">return</span>;
03488     }
03489 <span class="preprocessor">#else</span>
03490 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (PointerPte != EndPte) {
03491 
03492         <span class="comment">//</span>
03493         <span class="comment">// Clean up the last allocated PPE/PDE as they are not needed.</span>
03494         <span class="comment">// Note that the system cache and the session space working sets</span>
03495         <span class="comment">// have no current process (which MiDeletePte requires) which is</span>
03496         <span class="comment">// needed for WSLE and PrivatePages adjustments.</span>
03497         <span class="comment">//</span>
03498 
03499         <span class="keywordflow">if</span> (WsInfo != &amp;<a class="code" href="../../d6/d8/sysinfo_8c.html#a21">MmSystemCacheWs</a> &amp;&amp; WsInfo-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.SessionSpace == 0) {
03500             CurrentProcess = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>();
03501     
03502             <span class="keywordflow">if</span> (AllocatedPde != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03503                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (AllocatedPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1);
03504                 TempVa = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a>(AllocatedPde);
03505                 <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
03506                 <a class="code" href="../../d4/d8/mi_8h.html#a886">MiDeletePte</a> (AllocatedPde,
03507                              TempVa,
03508                              <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
03509                              CurrentProcess,
03510                              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
03511                              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
03512                 <span class="comment">//</span>
03513                 <span class="comment">// Add back in the private page MiDeletePte subtracted.</span>
03514                 <span class="comment">//</span>
03515 
03516                 CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o41">NumberOfPrivatePages</a> += 1;
03517                 <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
03518             }
03519     
03520             <span class="keywordflow">if</span> (AllocatedPpe != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03521                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (AllocatedPpe-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1);
03522                 TempVa = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a>(AllocatedPpe);
03523                 <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
03524                 <a class="code" href="../../d4/d8/mi_8h.html#a886">MiDeletePte</a> (AllocatedPpe,
03525                              TempVa,
03526                              <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
03527                              CurrentProcess,
03528                              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
03529                              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
03530                 <span class="comment">//</span>
03531                 <span class="comment">// Add back in the private page MiDeletePte subtracted.</span>
03532                 <span class="comment">//</span>
03533 
03534                 CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o41">NumberOfPrivatePages</a> += 1;
03535                 <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
03536             }
03537         }
03538 
03539         <span class="keywordflow">if</span> (PointerPte == StartPte) {
03540             <span class="keywordflow">if</span> (OriginalTable == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03541                 WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o10">HashTableSize</a> = First;
03542             }
03543         }
03544 
03545         <span class="keywordflow">return</span>;
03546     }
03547 <span class="preprocessor">#endif</span>
03548 <span class="preprocessor"></span>
03549     NewSize = (ULONG)((PointerPte - StartPte) &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
03550 
03551     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a>(PointerPte) == WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o13">HighestPermittedHashAddress</a>) ||
03552             (PointerPte-&gt;u.Hard.Valid == 0));
03553 
03554     WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o10">HashTableSize</a> = First + NewSize / <span class="keyword">sizeof</span> (<a class="code" href="../../d3/d8/struct__MMWSLE__HASH.html">MMWSLE_HASH</a>);
03555     WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o9">HashTable</a> = Table;
03556 
03557     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((&amp;Table[WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o10">HashTableSize</a>] == WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o13">HighestPermittedHashAddress</a>) ||
03558         (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(&amp;Table[WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o10">HashTableSize</a>])-&gt;u.Hard.Valid == 0));
03559 
03560     <span class="keywordflow">if</span> (First != 0) {
03561         RtlZeroMemory (Table, First * <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d8/struct__MMWSLE__HASH.html">MMWSLE_HASH</a>));
03562     }
03563 
03564     <span class="comment">//</span>
03565     <span class="comment">// Fill hash table</span>
03566     <span class="comment">//</span>
03567 
03568     j = 0;
03569     <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> = WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o8">NonDirectCount</a>;
03570 
03571     <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o10">HashTableSize</a>;
03572 
03573     <span class="keywordflow">do</span> {
03574         <span class="keywordflow">if</span> ((Wsle[j].<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Valid == 1) &amp;&amp;
03575             (Wsle[j].<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Direct == 0)) {
03576 
03577             <span class="comment">//</span>
03578             <span class="comment">// Hash this.</span>
03579             <span class="comment">//</span>
03580 
03581             <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> -= 1;
03582 
03583             Hash = <a class="code" href="../../d4/d8/mi_8h.html#a191">MI_WSLE_HASH</a>(Wsle[j].u1.<a class="code" href="../../d1/d8/struct__MMWSLE.html#o1">Long</a>, WorkingSetList);
03584 
03585             <span class="keywordflow">while</span> (Table[Hash].Key != 0) {
03586                 Hash += 1;
03587                 <span class="keywordflow">if</span> (Hash &gt;= (ULONG)<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>) {
03588                     Hash = 0;
03589                 }
03590             }
03591 
03592             Table[Hash].Key = Wsle[j].<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.Long &amp; ~(<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1);
03593             Table[Hash].Index = j;
03594 <span class="preprocessor">#if DBG</span>
03595 <span class="preprocessor"></span>            PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(Wsle[j].u1.<a class="code" href="../../d1/d8/struct__MMWSLE.html#o0">VirtualAddress</a>);
03596             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte-&gt;u.Hard.Valid);
03597 <span class="preprocessor">#endif //DBG</span>
03598 <span class="preprocessor"></span>
03599         }
03600         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (j &lt;= WorkingSetList-&gt;LastEntry);
03601         j += 1;
03602     } <span class="keywordflow">while</span> (<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>);
03603 
03604 <span class="preprocessor">#if DBG</span>
03605 <span class="preprocessor"></span>    <a class="code" href="../../d7/d0/wstree_8c.html#a5">MiCheckWsleHash</a> (WorkingSetList);
03606 <span class="preprocessor">#endif //DBG</span>
03607 <span class="preprocessor"></span>    <span class="keywordflow">return</span>;
03608 }
03609 
03610 
03611 ULONG
<a name="l03612"></a><a class="code" href="../../d4/d0/wslist_8c.html#a34">03612</a> <a class="code" href="../../d4/d0/wslist_8c.html#a34">MiTrimWorkingSet</a> (
03613     ULONG Reduction,
03614     IN <a class="code" href="../../d3/d6/struct__MMSUPPORT.html">PMMSUPPORT</a> WsInfo,
03615     IN ULONG ForcedReductionOrTrimAge
03616     )
03617 
03618 <span class="comment">/*++</span>
03619 <span class="comment"></span>
03620 <span class="comment">Routine Description:</span>
03621 <span class="comment"></span>
03622 <span class="comment">    This function reduces the working set by the specified amount.</span>
03623 <span class="comment"></span>
03624 <span class="comment">Arguments:</span>
03625 <span class="comment"></span>
03626 <span class="comment">    Reduction - Supplies the number of pages to remove from the working</span>
03627 <span class="comment">                set.</span>
03628 <span class="comment"></span>
03629 <span class="comment">    WsInfo - Supplies a pointer to the working set information for the</span>
03630 <span class="comment">             process (or system cache) to trim.</span>
03631 <span class="comment"></span>
03632 <span class="comment">    ForcedReductionOrTrimAge - If using fault-based trimming, this is set to</span>
03633 <span class="comment">                               TRUE if the reduction is being done to free up</span>
03634 <span class="comment">                               pages in which case we should try to reduce</span>
03635 <span class="comment">                               working set pages as well.  Set to FALSE when</span>
03636 <span class="comment">                               the reduction is trying to increase the fault</span>
03637 <span class="comment">                               rates in which case the policy should be more</span>
03638 <span class="comment">                               like locate and reserve.</span>
03639 <span class="comment"></span>
03640 <span class="comment">                               If using claim-based trimming, this is the age</span>
03641 <span class="comment">                               value to use - ie: pages of this age or older</span>
03642 <span class="comment">                               will be removed.</span>
03643 <span class="comment"></span>
03644 <span class="comment">Return Value:</span>
03645 <span class="comment"></span>
03646 <span class="comment">    Returns the actual number of pages removed.</span>
03647 <span class="comment"></span>
03648 <span class="comment">Environment:</span>
03649 <span class="comment"></span>
03650 <span class="comment">    Kernel mode, APCs disabled, working set lock.  PFN lock NOT held.</span>
03651 <span class="comment"></span>
03652 <span class="comment">--*/</span>
03653 
03654 {
03655     ULONG TryToFree;
03656     ULONG StartEntry;
03657     ULONG LastEntry;
03658     <a class="code" href="../../d0/d8/struct__MMWSL.html">PMMWSL</a> WorkingSetList;
03659     <a class="code" href="../../d1/d8/struct__MMWSLE.html">PMMWSLE</a> Wsle;
03660     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
03661     ULONG NumberLeftToRemove;
03662     ULONG LoopCount;
03663     ULONG EndCount;
03664     BOOLEAN StartFromZero;
03665 
03666     NumberLeftToRemove = Reduction;
03667     WorkingSetList = WsInfo-&gt;VmWorkingSetList;
03668     Wsle = WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o5">Wsle</a>;
03669 
03670 <span class="preprocessor">#if DBG</span>
03671 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (WsInfo == &amp;<a class="code" href="../../d6/d8/sysinfo_8c.html#a21">MmSystemCacheWs</a>) {
03672         <a class="code" href="../../d4/d8/mi_8h.html#a147">MM_SYSTEM_WS_LOCK_ASSERT</a>();
03673     }
03674 <span class="preprocessor">#endif //DBG</span>
03675 <span class="preprocessor"></span>
03676     LastEntry = WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o3">LastEntry</a>;
03677 
03678     TryToFree = WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o4">NextSlot</a>;
03679     <span class="keywordflow">if</span> (TryToFree &gt; LastEntry || TryToFree &lt; WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>) {
03680         TryToFree = WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>;
03681     }
03682 
03683     StartEntry = TryToFree;
03684 
03685 <span class="preprocessor">#ifdef _MI_USE_CLAIMS_</span>
03686 <span class="preprocessor"></span>
03687     <span class="keywordflow">while</span> (NumberLeftToRemove != 0) {
03688         <span class="keywordflow">if</span> (Wsle[TryToFree].<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Valid == 1) {
03689             PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (Wsle[TryToFree].u1.<a class="code" href="../../d1/d8/struct__MMWSLE.html#o0">VirtualAddress</a>);
03690 
03691             <span class="keywordflow">if</span> ((ForcedReductionOrTrimAge == 0) ||
03692                 ((<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a138">MI_GET_ACCESSED_IN_PTE</a> (PointerPte) == 0) &amp;&amp;
03693                 (<a class="code" href="../../d4/d8/mi_8h.html#a213">MI_GET_WSLE_AGE</a>(PointerPte, &amp;Wsle[TryToFree]) &gt;= ForcedReductionOrTrimAge))) {
03694 
03695                 <a class="code" href="../../d2/d1/mm_8h.html#a55">PERFINFO_GET_PAGE_INFO_WITH_DECL</a>(PointerPte);
03696 
03697                 <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/wslist_8c.html#a26">MiFreeWsle</a> (TryToFree, WsInfo, PointerPte)) {
03698                     <a class="code" href="../../d2/d1/mm_8h.html#a74">PERFINFO_LOG_WS_REMOVAL</a>(PERFINFO_LOG_TYPE_OUTWS_VOLUNTRIM, WsInfo);
03699                     NumberLeftToRemove -= 1;
03700                 }
03701             }
03702         }
03703         TryToFree += 1;
03704 
03705         <span class="keywordflow">if</span> (TryToFree &gt; LastEntry) {
03706             TryToFree = WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>;
03707         }
03708 
03709         <span class="keywordflow">if</span> (TryToFree == StartEntry) {
03710             <span class="keywordflow">break</span>;
03711         }
03712     }
03713 
03714 <span class="preprocessor">#else</span>
03715 <span class="preprocessor"></span>
03716     LoopCount = 0;
03717 
03718     <span class="keywordflow">if</span> (ForcedReductionOrTrimAge) {
03719         EndCount = 4;
03720     } <span class="keywordflow">else</span> {
03721         EndCount = 1;
03722     }
03723 
03724     StartFromZero = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03725 
03726     <span class="keywordflow">while</span> (NumberLeftToRemove != 0 &amp;&amp; LoopCount != EndCount) {
03727         <span class="keywordflow">while</span> ((NumberLeftToRemove != 0) &amp;&amp; (TryToFree &lt;= LastEntry)) {
03728 
03729             <span class="keywordflow">if</span> (Wsle[TryToFree].<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Valid == 1) {
03730                 PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (Wsle[TryToFree].u1.<a class="code" href="../../d1/d8/struct__MMWSLE.html#o0">VirtualAddress</a>);
03731                 <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a138">MI_GET_ACCESSED_IN_PTE</a> (PointerPte)) {
03732 
03733                     <span class="comment">//</span>
03734                     <span class="comment">// If accessed bit is set, clear it.  If accessed</span>
03735                     <span class="comment">// bit is clear, remove from working set.</span>
03736                     <span class="comment">//</span>
03737 
03738                     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a137">MI_SET_ACCESSED_IN_PTE</a> (PointerPte, 0);
03739                 } <span class="keywordflow">else</span> {
03740                     <a class="code" href="../../d2/d1/mm_8h.html#a55">PERFINFO_GET_PAGE_INFO_WITH_DECL</a>(PointerPte);
03741                     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/wslist_8c.html#a26">MiFreeWsle</a> (TryToFree, WsInfo, PointerPte)) {
03742                         <a class="code" href="../../d2/d1/mm_8h.html#a74">PERFINFO_LOG_WS_REMOVAL</a>(PERFINFO_LOG_TYPE_OUTWS_VOLUNTRIM, WsInfo);
03743                         NumberLeftToRemove -= 1;
03744                     }
03745                 }
03746             }
03747             TryToFree += 1;
03748 
03749             <span class="keywordflow">if</span> (StartFromZero == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> &amp;&amp; EndCount == 1 &amp;&amp; TryToFree &gt;= StartEntry) {
03750                 LoopCount = EndCount;
03751                 <span class="keywordflow">if</span> (TryToFree &gt; LastEntry) {
03752                     TryToFree = WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>;
03753                 }
03754                 <span class="keywordflow">break</span>;
03755             }
03756         }
03757 
03758         <span class="keywordflow">if</span> (TryToFree &gt; LastEntry) {
03759             TryToFree = WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>;
03760             <span class="keywordflow">if</span> (StartFromZero == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
03761 
03762                 <span class="comment">//</span>
03763                 <span class="comment">// We've already wrapped once but didn't get back to</span>
03764                 <span class="comment">// the StartEntry.  Use the first dynamic as our base now.</span>
03765                 <span class="comment">//</span>
03766 
03767                 StartEntry = TryToFree;
03768             }
03769             <span class="keywordflow">else</span> {
03770                 StartFromZero = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03771             }
03772 
03773             <span class="keywordflow">if</span> (TryToFree &gt;= StartEntry) {
03774 
03775                 <span class="comment">//</span>
03776                 <span class="comment">// We've wrapped. If this is not a forced trim, then bail</span>
03777                 <span class="comment">// now so we don't cannibalize entries we just cleared the</span>
03778                 <span class="comment">// access bit for because they haven't had a fair chance to</span>
03779                 <span class="comment">// be re-accessed yet.</span>
03780                 <span class="comment">//</span>
03781 
03782                 LoopCount += 1;
03783                 StartFromZero = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03784             }
03785         }
03786     }
03787 
03788 <span class="preprocessor">#endif</span>
03789 <span class="preprocessor"></span>
03790     WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o4">NextSlot</a> = TryToFree;
03791 
03792     <span class="comment">//</span>
03793     <span class="comment">// If this is not the system cache or a session working set, see if the</span>
03794     <span class="comment">// working set list can be contracted.</span>
03795     <span class="comment">//</span>
03796 
03797     <span class="keywordflow">if</span> (WsInfo != &amp;<a class="code" href="../../d6/d8/sysinfo_8c.html#a21">MmSystemCacheWs</a> &amp;&amp; WsInfo-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.SessionSpace == 0) {
03798 
03799         <span class="comment">//</span>
03800         <span class="comment">// Make sure we are at least a page above the working set maximum.</span>
03801         <span class="comment">//</span>
03802 
03803         <span class="keywordflow">if</span> (WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a> == WsInfo-&gt;WorkingSetSize) {
03804                 <a class="code" href="../../d4/d0/wslist_8c.html#a17">MiRemoveWorkingSetPages</a> (WorkingSetList, WsInfo);
03805         } <span class="keywordflow">else</span> {
03806 
03807             <span class="keywordflow">if</span> ((WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o0">Quota</a> + 15 + (<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> / <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d8/struct__MMWSLE.html">MMWSLE</a>))) &lt;
03808                                                     WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o3">LastEntry</a>) {
03809                 <span class="keywordflow">if</span> ((WsInfo-&gt;MaximumWorkingSetSize + 15 + (<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> / <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d8/struct__MMWSLE.html">MMWSLE</a>))) &lt;
03810                      WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o3">LastEntry</a> ) {
03811                     <a class="code" href="../../d4/d0/wslist_8c.html#a17">MiRemoveWorkingSetPages</a> (WorkingSetList, WsInfo);
03812                 }
03813             }
03814         }
03815     }
03816     <span class="keywordflow">return</span> Reduction - NumberLeftToRemove;
03817 }
03818 
03819 <span class="preprocessor">#if 0 //COMMENTED OUT.</span>
03820 <span class="preprocessor"></span><a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
03821 <a class="code" href="../../d2/d1/mm_8h.html#a260">MmPurgeWorkingSet</a> (
03822      IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process,
03823      IN PVOID BaseAddress,
03824      IN ULONG RegionSize
03825      )
03826 
03827 <span class="comment">/*++</span>
03828 <span class="comment"></span>
03829 <span class="comment">Routine Description:</span>
03830 <span class="comment"></span>
03831 <span class="comment">    This function removes any valid pages with a reference count</span>
03832 <span class="comment">    of 1 within the specified address range of the specified process.</span>
03833 <span class="comment"></span>
03834 <span class="comment">    If the address range is within the system cache, the process</span>
03835 <span class="comment">    parameter is ignored.</span>
03836 <span class="comment"></span>
03837 <span class="comment">Arguments:</span>
03838 <span class="comment"></span>
03839 <span class="comment">    Process - Supplies a pointer to the process to operate upon.</span>
03840 <span class="comment"></span>
03841 <span class="comment">    BaseAddress - Supplies the base address of the range to operate upon.</span>
03842 <span class="comment"></span>
03843 <span class="comment">    RegionSize - Supplies the size of the region to operate upon.</span>
03844 <span class="comment"></span>
03845 <span class="comment">Return Value:</span>
03846 <span class="comment"></span>
03847 <span class="comment">    None.</span>
03848 <span class="comment"></span>
03849 <span class="comment">Environment:</span>
03850 <span class="comment"></span>
03851 <span class="comment">    Kernel mode, APC_LEVEL or below.</span>
03852 <span class="comment"></span>
03853 <span class="comment">--*/</span>
03854 
03855 {
03856     <a class="code" href="../../d3/d6/struct__MMSUPPORT.html">PMMSUPPORT</a> WsInfo;
03857     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
03858     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPde;
03859     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastPte;
03860     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
03861     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> PteContents;
03862     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> CurrentProcess;
03863     PVOID EndingAddress;
03864     ULONG SystemCache;
03865     KIRQL OldIrql;
03866 
03867     <span class="comment">//</span>
03868     <span class="comment">// Determine if the specified base address is within the system</span>
03869     <span class="comment">// cache and if so, don't attach, the working set lock is still</span>
03870     <span class="comment">// required to "lock" paged pool pages (proto PTEs) into the</span>
03871     <span class="comment">// working set.</span>
03872     <span class="comment">//</span>
03873 
03874     CurrentProcess = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a> ();
03875 
03876     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (RegionSize != 0);
03877 
03878     EndingAddress = (PVOID)((PCHAR)BaseAddress + RegionSize - 1);
03879 
03880     <span class="keywordflow">if</span> ((BaseAddress &lt;= MM_HIGHEST_USER_ADDRESS) ||
03881         ((BaseAddress &gt;= (PVOID)PTE_BASE) &amp;&amp;
03882          (BaseAddress &lt; (PVOID)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a11">MM_SYSTEM_SPACE_START</a>)) ||
03883         ((BaseAddress &gt;= <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a21">MM_PAGED_POOL_START</a>) &amp;&amp;
03884          (BaseAddress &lt;= <a class="code" href="../../d8/d5/kddata_8c.html#a26">MmPagedPoolEnd</a>))) {
03885 
03886         SystemCache = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03887 
03888         <span class="comment">//</span>
03889         <span class="comment">// Attach to the specified process.</span>
03890         <span class="comment">//</span>
03891 
03892         <a class="code" href="../../d3/d5/procobj_8c.html#a4">KeAttachProcess</a> (&amp;Process-&gt;Pcb);
03893 
03894         WsInfo = &amp;Process-&gt;Vm,
03895 
03896         <a class="code" href="../../d4/d8/mi_8h.html#a154">LOCK_WS</a> (Process);
03897     } <span class="keywordflow">else</span> {
03898 
03899         SystemCache = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03900         Process = CurrentProcess;
03901         WsInfo = &amp;<a class="code" href="../../d6/d8/sysinfo_8c.html#a21">MmSystemCacheWs</a>;
03902     }
03903 
03904     PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (BaseAddress);
03905     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (BaseAddress);
03906     LastPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (EndingAddress);
03907 
03908     <span class="keywordflow">while</span> (!<a class="code" href="../../d0/d2/mmsup_8c.html#a6">MiDoesPdeExistAndMakeValid</a>(PointerPde, Process, FALSE)) {
03909 
03910         <span class="comment">//</span>
03911         <span class="comment">// No page table page exists for this address.</span>
03912         <span class="comment">//</span>
03913 
03914         PointerPde += 1;
03915 
03916         PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPde);
03917 
03918         <span class="keywordflow">if</span> (PointerPte &gt; LastPte) {
03919             <span class="keywordflow">break</span>;
03920         }
03921     }
03922 
03923     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
03924 
03925     <span class="keywordflow">while</span> (PointerPte &lt;= LastPte) {
03926 
03927         PteContents = *PointerPte;
03928 
03929         <span class="keywordflow">if</span> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1) {
03930 
03931             <span class="comment">//</span>
03932             <span class="comment">// Remove this page from the working set.</span>
03933             <span class="comment">//</span>
03934 
03935             Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber);
03936 
03937             <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 1) {
03938                 <a class="code" href="../../d4/d0/wslist_8c.html#a23">MiRemovePageFromWorkingSet</a> (PointerPte, Pfn1, WsInfo);
03939             }
03940         }
03941 
03942         PointerPte += 1;
03943 
03944         <span class="keywordflow">if</span> (((ULONG_PTR)PointerPte &amp; (<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1)) == 0) {
03945 
03946             PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPte);
03947 
03948             <span class="keywordflow">while</span> ((PointerPte &lt;= LastPte) &amp;&amp;
03949                    (!<a class="code" href="../../d0/d2/mmsup_8c.html#a6">MiDoesPdeExistAndMakeValid</a>(PointerPde, Process, TRUE))) {
03950 
03951                 <span class="comment">//</span>
03952                 <span class="comment">// No page table page exists for this address.</span>
03953                 <span class="comment">//</span>
03954 
03955                 PointerPde += 1;
03956 
03957                 PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPde);
03958             }
03959         }
03960     }
03961 
03962     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
03963 
03964     <span class="keywordflow">if</span> (!SystemCache) {
03965 
03966         <a class="code" href="../../d4/d8/mi_8h.html#a158">UNLOCK_WS</a> (Process);
03967         <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
03968     }
03969     <span class="keywordflow">return</span>;
03970 }
03971 <span class="preprocessor">#endif //0</span>
03972 <span class="preprocessor"></span>
03973 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l03974"></a><a class="code" href="../../d4/d0/wslist_8c.html#a15">03974</a> <a class="code" href="../../d4/d0/wslist_8c.html#a15">MiEliminateWorkingSetEntry</a> (
03975     IN ULONG WorkingSetIndex,
03976     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte,
03977     IN <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn,
03978     IN <a class="code" href="../../d1/d8/struct__MMWSLE.html">PMMWSLE</a> Wsle
03979     )
03980 
03981 <span class="comment">/*++</span>
03982 <span class="comment"></span>
03983 <span class="comment">Routine Description:</span>
03984 <span class="comment"></span>
03985 <span class="comment">    This routine removes the specified working set list entry</span>
03986 <span class="comment">    from the working set, flushes the TB for the page, decrements</span>
03987 <span class="comment">    the share count for the physical page, and, if necessary turns</span>
03988 <span class="comment">    the PTE into a transition PTE.</span>
03989 <span class="comment"></span>
03990 <span class="comment">Arguments:</span>
03991 <span class="comment"></span>
03992 <span class="comment">    WorkingSetIndex - Supplies the working set index to remove.</span>
03993 <span class="comment"></span>
03994 <span class="comment">    PointerPte - Supplies a pointer to the PTE corresponding to the virtual</span>
03995 <span class="comment">                 address in the working set.</span>
03996 <span class="comment"></span>
03997 <span class="comment">    Pfn - Supplies a pointer to the PFN element corresponding to the PTE.</span>
03998 <span class="comment"></span>
03999 <span class="comment">    Wsle - Supplies a pointer to the first working set list entry for this</span>
04000 <span class="comment">           working set.</span>
04001 <span class="comment"></span>
04002 <span class="comment">Return Value:</span>
04003 <span class="comment"></span>
04004 <span class="comment">    None.</span>
04005 <span class="comment"></span>
04006 <span class="comment">Environment:</span>
04007 <span class="comment"></span>
04008 <span class="comment">    Kernel mode, Working set lock and PFN lock held, APCs disabled.</span>
04009 <span class="comment"></span>
04010 <span class="comment">--*/</span>
04011 
04012 {
04013     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> ContainingPageTablePage;
04014     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
04015     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> PreviousPte;
04016     PFN_NUMBER PageFrameIndex;
04017     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
04018     PVOID VirtualAddress;
04019 
04020     <span class="comment">//</span>
04021     <span class="comment">// Remove the page from the working set.</span>
04022     <span class="comment">//</span>
04023 
04024     <a class="code" href="../../d4/d8/mi_8h.html#a136">MM_PFN_LOCK_ASSERT</a> ();
04025 
04026     TempPte = *PointerPte;
04027     PageFrameIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (&amp;TempPte);
04028 
04029 <span class="preprocessor">#ifdef _X86_</span>
04030 <span class="preprocessor"></span><span class="preprocessor">#if DBG</span>
04031 <span class="preprocessor"></span><span class="preprocessor">#if !defined(NT_UP)</span>
04032 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Writable == 1) {
04033         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Dirty == 1);
04034     }
04035     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Accessed == 1);
04036 <span class="preprocessor">#endif //NTUP</span>
04037 <span class="preprocessor"></span><span class="preprocessor">#endif //DBG</span>
04038 <span class="preprocessor"></span><span class="preprocessor">#endif //X86</span>
04039 <span class="preprocessor"></span>
04040     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a172">MI_MAKING_VALID_PTE_INVALID</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
04041 
04042     <span class="keywordflow">if</span> (Pfn-&gt;u3.e1.PrototypePte) {
04043 
04044         <span class="comment">//</span>
04045         <span class="comment">// This is a prototype PTE.  The PFN database does not contain</span>
04046         <span class="comment">// the contents of this PTE it contains the contents of the</span>
04047         <span class="comment">// prototype PTE.  This PTE must be reconstructed to contain</span>
04048         <span class="comment">// a pointer to the prototype PTE.</span>
04049         <span class="comment">//</span>
04050         <span class="comment">// The working set list entry contains information about</span>
04051         <span class="comment">// how to reconstruct the PTE.</span>
04052         <span class="comment">//</span>
04053 
04054         <span class="keywordflow">if</span> (Wsle[WorkingSetIndex].u1.e1.SameProtectAsProto == 0) {
04055 
04056             <span class="comment">//</span>
04057             <span class="comment">// The protection for the prototype PTE is in the</span>
04058             <span class="comment">// WSLE.</span>
04059             <span class="comment">//</span>
04060 
04061             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Wsle[WorkingSetIndex].u1.e1.Protection != 0);
04062 
04063             <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d8/mi_8h.html#a352">MI_IS_SESSION_IMAGE_ADDRESS</a> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a>(PointerPte))) {
04064                 TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = 0;
04065                 TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection =
04066                     <a class="code" href="../../d4/d8/mi_8h.html#a192">MI_GET_PROTECTION_FROM_WSLE</a> (&amp;Wsle[WorkingSetIndex]);
04067                 TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.PageFileHigh = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a181">MI_PTE_LOOKUP_NEEDED</a>;
04068             }
04069             <span class="keywordflow">else</span> {
04070 
04071                 <span class="comment">//</span>
04072                 <span class="comment">// The session PTE protection must be carefully preserved.</span>
04073                 <span class="comment">//</span>
04074     
04075                 TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a145">MiProtoAddressForPte</a> (Pfn-&gt;PteAddress);
04076             }
04077         } <span class="keywordflow">else</span> {
04078 
04079             <span class="comment">//</span>
04080             <span class="comment">// The protection is in the prototype PTE.</span>
04081             <span class="comment">//</span>
04082 
04083             TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a145">MiProtoAddressForPte</a> (Pfn-&gt;PteAddress);
04084 
04085             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a352">MI_IS_SESSION_IMAGE_ADDRESS</a> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a>(PointerPte))) {
04086     
04087                 <span class="comment">//</span>
04088                 <span class="comment">// The session PTE protection must be carefully preserved.</span>
04089                 <span class="comment">//</span>
04090     
04091                 TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Proto.ReadOnly = 1;
04092             }
04093         }
04094     
04095         TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Proto.Prototype = 1;
04096 
04097         <span class="comment">//</span>
04098         <span class="comment">// Decrement the share count of the containing page table</span>
04099         <span class="comment">// page as the PTE for the removed page is no longer valid</span>
04100         <span class="comment">// or in transition</span>
04101         <span class="comment">//</span>
04102 
04103         ContainingPageTablePage = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPte);
04104 <span class="preprocessor">#if defined (_WIN64)</span>
04105 <span class="preprocessor"></span>        <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ContainingPageTablePage-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1);
04106 <span class="preprocessor">#else</span>
04107 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (ContainingPageTablePage-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) {
04108             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d4/d8/mi_8h.html#a836">MiCheckPdeForPagedPool</a> (PointerPte))) {
04109                 <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (MEMORY_MANAGEMENT,
04110                               0x61940, 
04111                               (ULONG_PTR)PointerPte,
04112                               (ULONG_PTR)ContainingPageTablePage-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long,
04113                               (ULONG_PTR)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a>(PointerPte));
04114             }
04115         }
04116 <span class="preprocessor">#endif</span>
04117 <span class="preprocessor"></span>        <a class="code" href="../../d4/d8/mi_8h.html#a242">MiDecrementShareAndValidCount</a> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (ContainingPageTablePage));
04118 
04119     } <span class="keywordflow">else</span> {
04120 
04121         <span class="comment">//</span>
04122         <span class="comment">// This is a private page, make it transition.</span>
04123         <span class="comment">//</span>
04124 
04125         <span class="comment">//</span>
04126         <span class="comment">// Assert that the share count is 1 for all user mode pages.</span>
04127         <span class="comment">//</span>
04128 
04129         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((Pfn-&gt;u2.ShareCount == 1) ||
04130                 (Wsle[WorkingSetIndex].u1.VirtualAddress &gt;
04131                         (PVOID)MM_HIGHEST_USER_ADDRESS));
04132 
04133         <span class="comment">//</span>
04134         <span class="comment">// Set the working set index to zero.  This allows page table</span>
04135         <span class="comment">// pages to be brought back in with the proper WSINDEX.</span>
04136         <span class="comment">//</span>
04137 
04138         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn-&gt;u1.WsIndex != 0);
04139         <a class="code" href="../../d4/d8/mi_8h.html#a190">MI_ZERO_WSINDEX</a> (Pfn);
04140         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a106">MI_MAKE_VALID_PTE_TRANSITION</a> (TempPte,
04141                                       Pfn-&gt;OriginalPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection);
04142     }
04143 
04144     <span class="keywordflow">if</span> (Wsle == <a class="code" href="../../d4/d8/mi_8h.html#a673">MmWsle</a>) {
04145         PreviousPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Flush = <a class="code" href="../../d0/d6/ppc_2flushtb_8c.html#a2">KeFlushSingleTb</a> (
04146                                     Wsle[WorkingSetIndex].u1.VirtualAddress,
04147                                     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
04148                                     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
04149                                     (PHARDWARE_PTE)PointerPte,
04150                                     TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Flush);
04151     }
04152     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Wsle == <a class="code" href="../../d4/d8/mi_8h.html#a658">MmSystemCacheWsle</a>) {
04153 
04154         <span class="comment">//</span>
04155         <span class="comment">// Must be the system cache.</span>
04156         <span class="comment">//</span>
04157 
04158         PreviousPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Flush = <a class="code" href="../../d0/d6/ppc_2flushtb_8c.html#a2">KeFlushSingleTb</a> (
04159                                     Wsle[WorkingSetIndex].u1.VirtualAddress,
04160                                     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
04161                                     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
04162                                     (PHARDWARE_PTE)PointerPte,
04163                                     TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Flush);
04164     }
04165     <span class="keywordflow">else</span> {
04166 
04167         <span class="comment">//</span>
04168         <span class="comment">// Must be a session space.</span>
04169         <span class="comment">//</span>
04170 
04171         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a199">MI_FLUSH_SINGLE_SESSION_TB</a> (Wsle[WorkingSetIndex].u1.VirtualAddress,
04172                                     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
04173                                     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
04174                                     (PHARDWARE_PTE)PointerPte,
04175                                     TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Flush,
04176                                     PreviousPte);
04177     }
04178 
04179     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PreviousPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1);
04180 
04181     <span class="comment">//</span>
04182     <span class="comment">// A page is being removed from the working set, on certain</span>
04183     <span class="comment">// hardware the dirty bit should be ORed into the modify bit in</span>
04184     <span class="comment">// the PFN element.</span>
04185     <span class="comment">//</span>
04186 
04187     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a177">MI_CAPTURE_DIRTY_BIT_TO_PFN</a> (&amp;PreviousPte, Pfn);
04188 
04189     <span class="comment">//</span>
04190     <span class="comment">// If the PTE indicates the page has been modified (this is different</span>
04191     <span class="comment">// from the PFN indicating this), then ripple it back to the write watch</span>
04192     <span class="comment">// bitmap now since we are still in the correct process context.</span>
04193     <span class="comment">//</span>
04194 
04195     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a495">MiActiveWriteWatch</a> != 0) {
04196         <span class="keywordflow">if</span> ((Pfn-&gt;u3.e1.PrototypePte == 0) &amp;&amp;
04197             (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a114">MI_IS_PTE_DIRTY</a>(PreviousPte))) {
04198 
04199             Process = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>();
04200 
04201             <span class="keywordflow">if</span> (Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.WriteWatch == 1) {
04202 
04203                 <span class="comment">//</span>
04204                 <span class="comment">// This process has (or had) write watch VADs.  Search now</span>
04205                 <span class="comment">// for a write watch region encapsulating the PTE being</span>
04206                 <span class="comment">// invalidated.</span>
04207                 <span class="comment">//</span>
04208 
04209                 VirtualAddress = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPte);
04210                 <a class="code" href="../../d4/d8/mi_8h.html#a772">MiCaptureWriteWatchDirtyBit</a> (Process, VirtualAddress);
04211             }
04212         }
04213     }
04214 
04215     <span class="comment">//</span>
04216     <span class="comment">// Flush the translation buffer and decrement the number of valid</span>
04217     <span class="comment">// PTEs within the containing page table page.  Note that for a</span>
04218     <span class="comment">// private page, the page table page is still needed because the</span>
04219     <span class="comment">// page is in transition.</span>
04220     <span class="comment">//</span>
04221 
04222     <a class="code" href="../../d6/d5/pfndec_8c.html#a1">MiDecrementShareCount</a> (PageFrameIndex);
04223 
04224     <span class="keywordflow">return</span>;
04225 }
04226 
04227 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l04228"></a><a class="code" href="../../d4/d8/mi_8h.html#a862">04228</a> <a class="code" href="../../d4/d0/wslist_8c.html#a17">MiRemoveWorkingSetPages</a> (
04229     IN <a class="code" href="../../d0/d8/struct__MMWSL.html">PMMWSL</a> WorkingSetList,
04230     IN <a class="code" href="../../d3/d6/struct__MMSUPPORT.html">PMMSUPPORT</a> WsInfo
04231     )
04232 
04233 <span class="comment">/*++</span>
04234 <span class="comment"></span>
04235 <span class="comment">Routine Description:</span>
04236 <span class="comment"></span>
04237 <span class="comment">    This routine compresses the WSLEs into the front of the working set</span>
04238 <span class="comment">    and frees the pages for unneeded working set entries.</span>
04239 <span class="comment"></span>
04240 <span class="comment">Arguments:</span>
04241 <span class="comment"></span>
04242 <span class="comment">    WorkingSetList - Supplies a pointer to the working set list to compress.</span>
04243 <span class="comment"></span>
04244 <span class="comment">Return Value:</span>
04245 <span class="comment"></span>
04246 <span class="comment">    None.</span>
04247 <span class="comment"></span>
04248 <span class="comment">Environment:</span>
04249 <span class="comment"></span>
04250 <span class="comment">    Kernel mode, Working set lock held, APCs disabled.</span>
04251 <span class="comment"></span>
04252 <span class="comment">--*/</span>
04253 
04254 {
04255     <a class="code" href="../../d1/d8/struct__MMWSLE.html">PMMWSLE</a> FreeEntry;
04256     <a class="code" href="../../d1/d8/struct__MMWSLE.html">PMMWSLE</a> LastEntry;
04257     <a class="code" href="../../d1/d8/struct__MMWSLE.html">PMMWSLE</a> Wsle;
04258     ULONG FreeIndex;
04259     ULONG LastIndex;
04260     ULONG LastInvalid;
04261     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastPte;
04262     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
04263     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPde;
04264     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPpe;
04265     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> WsPte;
04266     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
04267     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> CurrentProcess;
04268     <a class="code" href="../../d9/d4/struct__MMPTE__FLUSH__LIST.html">MMPTE_FLUSH_LIST</a> PteFlushList;
04269     ULONG NewSize;
04270     <a class="code" href="../../d3/d8/struct__MMWSLE__HASH.html">PMMWSLE_HASH</a> Table;
04271     KIRQL OldIrql;
04272 
04273     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (WsInfo != &amp;<a class="code" href="../../d6/d8/sysinfo_8c.html#a21">MmSystemCacheWs</a> &amp;&amp; WsInfo-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.SessionSpace == 0);
04274 
04275     PteFlushList.<a class="code" href="../../d9/d4/struct__MMPTE__FLUSH__LIST.html#o0">Count</a> = 0;
04276     CurrentProcess = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>();
04277 
04278 <span class="preprocessor">#if DBG</span>
04279 <span class="preprocessor"></span>    <a class="code" href="../../d4/d0/wslist_8c.html#a18">MiCheckNullIndex</a> (WorkingSetList);
04280 <span class="preprocessor">#endif //DBG</span>
04281 <span class="preprocessor"></span>
04282     <span class="comment">//</span>
04283     <span class="comment">// Check to see if the wsle hash table should be contracted.</span>
04284     <span class="comment">//</span>
04285 
04286     <span class="keywordflow">if</span> (WorkingSetList-&gt;HashTable) {
04287 
04288         Table = WorkingSetList-&gt;HashTable;
04289 
04290 <span class="preprocessor">#if DBG</span>
04291 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ((PVOID)(&amp;Table[WorkingSetList-&gt;HashTableSize]) &lt; WorkingSetList-&gt;HighestPermittedHashAddress) {
04292             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(&amp;Table[WorkingSetList-&gt;HashTableSize])-&gt;u.Hard.Valid == 0);
04293         }
04294 <span class="preprocessor">#endif</span>
04295 <span class="preprocessor"></span>
04296         <span class="keywordflow">if</span> (WsInfo-&gt;WorkingSetSize &lt; 200) {
04297             NewSize = 0;
04298         }
04299         <span class="keywordflow">else</span> {
04300             NewSize = PtrToUlong(<a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a> ((WorkingSetList-&gt;NonDirectCount * 2 *
04301                                        <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d8/struct__MMWSLE__HASH.html">MMWSLE_HASH</a>)) + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1));
04302     
04303             NewSize = NewSize / <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d8/mi_8h.html#a444">MMWSLE_HASH</a>);
04304         }
04305 
04306         <span class="keywordflow">if</span> (NewSize &lt; WorkingSetList-&gt;HashTableSize) {
04307 
04308 <span class="preprocessor">#if defined(_ALPHA_) &amp;&amp; !defined(_AXP64_)</span>
04309 <span class="preprocessor"></span>            <a class="code" href="../../d4/d8/mi_8h.html#a142">LOCK_EXPANSION_IF_ALPHA</a> (OldIrql);
04310 <span class="preprocessor">#endif</span>
04311 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (NewSize &amp;&amp; WsInfo-&gt;AllowWorkingSetAdjustment) {
04312                 WsInfo-&gt;AllowWorkingSetAdjustment = <a class="code" href="../../d4/d8/mi_8h.html#a32">MM_GROW_WSLE_HASH</a>;
04313             }
04314 <span class="preprocessor">#if defined(_ALPHA_) &amp;&amp; !defined(_AXP64_)</span>
04315 <span class="preprocessor"></span>            <a class="code" href="../../d4/d8/mi_8h.html#a143">UNLOCK_EXPANSION_IF_ALPHA</a> (OldIrql);
04316 <span class="preprocessor">#endif</span>
04317 <span class="preprocessor"></span>
04318             <span class="comment">//</span>
04319             <span class="comment">// Remove pages from hash table.</span>
04320             <span class="comment">//</span>
04321 
04322             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (((ULONG_PTR)&amp;WorkingSetList-&gt;HashTable[NewSize] &amp;
04323                                                     (<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1)) == 0);
04324 
04325             PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (&amp;WorkingSetList-&gt;HashTable[NewSize]);
04326 
04327             LastPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (WorkingSetList-&gt;HighestPermittedHashAddress);
04328             <span class="comment">//</span>
04329             <span class="comment">// Set the hash table to null indicating that no hashing</span>
04330             <span class="comment">// is going on.</span>
04331             <span class="comment">//</span>
04332 
04333             WorkingSetList-&gt;HashTable = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04334             WorkingSetList-&gt;HashTableSize = NewSize;
04335 
04336             <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
04337             <span class="keywordflow">while</span> ((PointerPte &lt; LastPte) &amp;&amp; (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1)) {
04338 
04339                 <a class="code" href="../../d4/d8/mi_8h.html#a886">MiDeletePte</a> (PointerPte,
04340                              <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPte),
04341                              <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
04342                              CurrentProcess,
04343                              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
04344                              &amp;PteFlushList);
04345 
04346                 <span class="comment">//</span>
04347                 <span class="comment">// Add back in the private page MiDeletePte subtracted.</span>
04348                 <span class="comment">//</span>
04349 
04350                 CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o41">NumberOfPrivatePages</a> += 1;
04351 
04352                 PointerPte += 1;
04353 
04354 <span class="preprocessor">#if defined (_WIN64)</span>
04355 <span class="preprocessor"></span>                <span class="comment">//</span>
04356                 <span class="comment">// If all the entries have been removed from the previous page</span>
04357                 <span class="comment">// table page, delete the page table page itself.  Likewise with</span>
04358                 <span class="comment">// the page directory page.</span>
04359                 <span class="comment">//</span>
04360     
04361                 <span class="keywordflow">if</span> ((<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a167">MiIsPteOnPdeBoundary</a>(PointerPte)) ||
04362                     ((<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a>(PointerPte))-&gt;u.Hard.Valid == 0) ||
04363                     ((<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(PointerPte))-&gt;u.Hard.Valid == 0) ||
04364                     (PointerPte-&gt;u.Hard.Valid == 0)) {
04365     
04366                     <a class="code" href="../../d4/d8/mi_8h.html#a888">MiFlushPteList</a> (&amp;PteFlushList, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d4/d2/datalpha_8c.html#a0">ZeroPte</a>);
04367 
04368                     PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPte - 1);
04369     
04370                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1);
04371     
04372                     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (PointerPde));
04373     
04374                     <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount == 1 &amp;&amp; Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 1)
04375                     {
04376                         <a class="code" href="../../d4/d8/mi_8h.html#a886">MiDeletePte</a> (PointerPde,
04377                                      PointerPte - 1,
04378                                      <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
04379                                      CurrentProcess,
04380                                      <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
04381                                      <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
04382 
04383                         <span class="comment">//</span>
04384                         <span class="comment">// Add back in the private page MiDeletePte subtracted.</span>
04385                         <span class="comment">//</span>
04386         
04387                         CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o41">NumberOfPrivatePages</a> += 1;
04388                     }
04389                 
04390                     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a166">MiIsPteOnPpeBoundary</a>(PointerPte)) {
04391         
04392                         PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPde);
04393         
04394                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPpe-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1);
04395         
04396                         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (PointerPpe));
04397         
04398                         <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount == 1 &amp;&amp; Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 1)
04399                         {
04400                             <a class="code" href="../../d4/d8/mi_8h.html#a886">MiDeletePte</a> (PointerPpe,
04401                                          PointerPde,
04402                                          <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
04403                                          CurrentProcess,
04404                                          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
04405                                          <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
04406 
04407                             <span class="comment">//</span>
04408                             <span class="comment">// Add back in the private page MiDeletePte subtracted.</span>
04409                             <span class="comment">//</span>
04410             
04411                             CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o41">NumberOfPrivatePages</a> += 1;
04412                         }
04413                     }
04414                     PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPte);
04415                     PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (PointerPte);
04416                     <span class="keywordflow">if</span> ((PointerPpe-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) ||
04417                         (PointerPde-&gt;u.Hard.Valid == 0)) {
04418                             <span class="keywordflow">break</span>;
04419                     }
04420                 }
04421 <span class="preprocessor">#endif</span>
04422 <span class="preprocessor"></span>            }
04423             <a class="code" href="../../d4/d8/mi_8h.html#a888">MiFlushPteList</a> (&amp;PteFlushList, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d4/d2/datalpha_8c.html#a0">ZeroPte</a>);
04424 
04425             <span class="keywordflow">if</span> (WsInfo-&gt;u.Flags.SessionSpace == 1) {
04426         
04427                 <span class="comment">//</span>
04428                 <span class="comment">// Session space has no ASN - flush the entire TB.</span>
04429                 <span class="comment">//</span>
04430             
04431                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a200">MI_FLUSH_ENTIRE_SESSION_TB</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
04432             }
04433         
04434             <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
04435         }
04436 <span class="preprocessor">#if defined (_WIN64)</span>
04437 <span class="preprocessor"></span>
04438         <span class="comment">//</span>
04439         <span class="comment">// For 64-bit NT, the page tables and page directories are also</span>
04440         <span class="comment">// deleted during contraction.</span>
04441         <span class="comment">//</span>
04442 
04443         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a150">MiGetPpeAddress</a>(&amp;Table[WorkingSetList-&gt;HashTableSize])-&gt;u.Hard.Valid == 0) ||
04444                 (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a>(&amp;Table[WorkingSetList-&gt;HashTableSize])-&gt;u.Hard.Valid == 0) ||
04445                 (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(&amp;Table[WorkingSetList-&gt;HashTableSize])-&gt;u.Hard.Valid == 0));
04446 
04447 <span class="preprocessor">#else</span>
04448 <span class="preprocessor"></span>
04449         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(&amp;Table[WorkingSetList-&gt;HashTableSize])-&gt;u.Hard.Valid == 0);
04450 
04451 <span class="preprocessor">#endif</span>
04452 <span class="preprocessor"></span>    }
04453 
04454     <span class="comment">//</span>
04455     <span class="comment">// If the only pages in the working set are locked pages (that</span>
04456     <span class="comment">// is all pages are BEFORE first dynamic, just reorganize the</span>
04457     <span class="comment">// free list).</span>
04458     <span class="comment">//</span>
04459 
04460     Wsle = WorkingSetList-&gt;Wsle;
04461     <span class="keywordflow">if</span> (WorkingSetList-&gt;FirstDynamic == WsInfo-&gt;WorkingSetSize) {
04462 
04463         LastIndex = WorkingSetList-&gt;FirstDynamic;
04464         LastEntry = &amp;Wsle[LastIndex];
04465 
04466     } <span class="keywordflow">else</span> {
04467 
04468         <span class="comment">//</span>
04469         <span class="comment">// Start from the first dynamic and move towards the end looking</span>
04470         <span class="comment">// for free entries.  At the same time start from the end and</span>
04471         <span class="comment">// move towards first dynamic looking for valid entries.</span>
04472         <span class="comment">//</span>
04473 
04474         LastInvalid = 0;
04475         FreeIndex = WorkingSetList-&gt;FirstDynamic;
04476         FreeEntry = &amp;Wsle[FreeIndex];
04477         LastIndex = WorkingSetList-&gt;LastEntry;
04478         LastEntry = &amp;Wsle[LastIndex];
04479 
04480         <span class="keywordflow">while</span> (FreeEntry &lt; LastEntry) {
04481             <span class="keywordflow">if</span> (FreeEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Valid == 1) {
04482                 FreeEntry += 1;
04483                 FreeIndex += 1;
04484             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (LastEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Valid == 0) {
04485                 LastEntry -= 1;
04486                 LastIndex -= 1;
04487             } <span class="keywordflow">else</span> {
04488 
04489                 <span class="comment">//</span>
04490                 <span class="comment">// Move the WSLE at LastEntry to the free slot at FreeEntry.</span>
04491                 <span class="comment">//</span>
04492 
04493                 LastInvalid = 1;
04494                 *FreeEntry = *LastEntry;
04495                 PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (LastEntry-&gt;u1.VirtualAddress);
04496 
04497                 <span class="keywordflow">if</span> (LastEntry-&gt;u1.e1.Direct) {
04498 
04499                     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber);
04500 
04501                     <a class="code" href="../../d4/d8/mi_8h.html#a121">CONSISTENCY_LOCK_PFN</a> (OldIrql);
04502 
04503                     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.WsIndex = FreeIndex;
04504 
04505                     <a class="code" href="../../d4/d8/mi_8h.html#a122">CONSISTENCY_UNLOCK_PFN</a> (OldIrql);
04506 
04507                 } <span class="keywordflow">else</span> {
04508 
04509                     <span class="comment">//</span>
04510                     <span class="comment">// This entry is in the working set.  Remove it</span>
04511                     <span class="comment">// and then add the entry add the free slot.</span>
04512                     <span class="comment">//</span>
04513 
04514                     <a class="code" href="../../d7/d0/wstree_8c.html#a8">MiRemoveWsle</a> (LastIndex, WorkingSetList);
04515                     <a class="code" href="../../d7/d0/wstree_8c.html#a6">MiInsertWsle</a> (FreeIndex, WorkingSetList);
04516                 }
04517 
04518                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a109">MI_SET_PTE_IN_WORKING_SET</a> (PointerPte, FreeIndex);
04519                 LastEntry-&gt;u1.Long = 0;
04520                 LastEntry -= 1;
04521                 LastIndex -= 1;
04522                 FreeEntry += 1;
04523                 FreeIndex += 1;
04524             }
04525         }
04526 
04527         <span class="comment">//</span>
04528         <span class="comment">// If no entries were freed, just return.</span>
04529         <span class="comment">//</span>
04530 
04531         <span class="keywordflow">if</span> (LastInvalid == 0) {
04532 <span class="preprocessor">#if DBG</span>
04533 <span class="preprocessor"></span>            <a class="code" href="../../d4/d0/wslist_8c.html#a18">MiCheckNullIndex</a> (WorkingSetList);
04534 <span class="preprocessor">#endif //DBG</span>
04535 <span class="preprocessor"></span>            <span class="keywordflow">return</span>;
04536         }
04537     }
04538 
04539     <span class="comment">//</span>
04540     <span class="comment">// Reorganize the free list.  Make last entry the first free.</span>
04541     <span class="comment">//</span>
04542 
04543     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((LastEntry - 1)-&gt;u1.e1.Valid == 1);
04544 
04545     <span class="keywordflow">if</span> (LastEntry-&gt;<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Valid == 1) {
04546         LastEntry += 1;
04547         LastIndex += 1;
04548     }
04549 
04550     WorkingSetList-&gt;LastEntry = LastIndex - 1;
04551     WorkingSetList-&gt;FirstFree = LastIndex;
04552 
04553     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((LastEntry - 1)-&gt;u1.e1.Valid == 1);
04554     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((LastEntry)-&gt;u1.e1.Valid == 0);
04555 
04556     <span class="comment">//</span>
04557     <span class="comment">// Point free entry to the first invalid page.</span>
04558     <span class="comment">//</span>
04559 
04560     FreeEntry = LastEntry;
04561 
04562     <span class="keywordflow">while</span> (LastIndex &lt; WorkingSetList-&gt;LastInitializedWsle) {
04563 
04564         <span class="comment">//</span>
04565         <span class="comment">// Put the remainder of the WSLEs on the free list.</span>
04566         <span class="comment">//</span>
04567 
04568         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (LastEntry-&gt;u1.e1.Valid == 0);
04569         LastIndex += 1;
04570         LastEntry-&gt;u1.Long = LastIndex &lt;&lt; <a class="code" href="../../d4/d8/mi_8h.html#a9">MM_FREE_WSLE_SHIFT</a>;
04571         LastEntry += 1;
04572     }
04573 
04574     <span class="comment">//LastEntry-&gt;u1.Long = WSLE_NULL_INDEX &lt;&lt; MM_FREE_WSLE_SHIFT;  // End of list.</span>
04575 
04576     <span class="comment">//</span>
04577     <span class="comment">// Delete the working set pages at the end.</span>
04578     <span class="comment">//</span>
04579 
04580     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (&amp;Wsle[WorkingSetList-&gt;LastInitializedWsle]);
04581     <span class="keywordflow">if</span> (&amp;Wsle[WsInfo-&gt;MinimumWorkingSetSize] &gt; FreeEntry) {
04582         FreeEntry = &amp;Wsle[WsInfo-&gt;MinimumWorkingSetSize];
04583     }
04584 
04585     WsPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (FreeEntry);
04586 
04587 <span class="preprocessor">#if 0</span>
04588 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (FreeEntry) != <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (FreeEntry + 1)) {
04589         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"MiRemoveWorkingSetPages caught boundary case %x\n"</span>, FreeEntry);
04590         DbgBreakPoint();
04591 
04592         WsPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (FreeEntry + 1);
04593     }
04594 <span class="preprocessor">#endif</span>
04595 <span class="preprocessor"></span>
04596     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (WorkingSetList-&gt;FirstFree &gt;= WorkingSetList-&gt;FirstDynamic);
04597 
04598     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
04599     <span class="keywordflow">while</span> (PointerPte &gt; WsPte) {
04600         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1);
04601 
04602         <a class="code" href="../../d4/d8/mi_8h.html#a886">MiDeletePte</a> (PointerPte,
04603                      <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPte),
04604                      <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
04605                      CurrentProcess,
04606                      <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
04607                      &amp;PteFlushList);
04608 
04609         <span class="comment">//</span>
04610         <span class="comment">// Add back in the private page MiDeletePte subtracted.</span>
04611         <span class="comment">//</span>
04612 
04613         CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o41">NumberOfPrivatePages</a> += 1;
04614 
04615 <span class="preprocessor">#if defined (_WIN64)</span>
04616 <span class="preprocessor"></span>        <span class="comment">//</span>
04617         <span class="comment">// If all the entries have been removed from the previous page</span>
04618         <span class="comment">// table page, delete the page table page itself.  Likewise with</span>
04619         <span class="comment">// the page directory page.</span>
04620         <span class="comment">//</span>
04621 
04622         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a167">MiIsPteOnPdeBoundary</a>(PointerPte)) {
04623 
04624             PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPte);
04625 
04626             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1);
04627 
04628             Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (PointerPde));
04629 
04630             <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount == 1 &amp;&amp; Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 1) {
04631 
04632                 <a class="code" href="../../d4/d8/mi_8h.html#a888">MiFlushPteList</a> (&amp;PteFlushList, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d4/d2/datalpha_8c.html#a0">ZeroPte</a>);
04633 
04634                 <a class="code" href="../../d4/d8/mi_8h.html#a886">MiDeletePte</a> (PointerPde,
04635                              PointerPte,
04636                              <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
04637                              CurrentProcess,
04638                              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
04639                              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
04640 
04641                 <span class="comment">//</span>
04642                 <span class="comment">// Add back in the private page MiDeletePte subtracted.</span>
04643                 <span class="comment">//</span>
04644 
04645                 CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o41">NumberOfPrivatePages</a> += 1;
04646             }
04647         
04648             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a166">MiIsPteOnPpeBoundary</a>(PointerPte)) {
04649 
04650                 PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPde);
04651 
04652                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPpe-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1);
04653 
04654                 Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (PointerPpe));
04655 
04656                 <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount == 1 &amp;&amp; Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 1)
04657                 {
04658 
04659                     <a class="code" href="../../d4/d8/mi_8h.html#a888">MiFlushPteList</a> (&amp;PteFlushList, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d4/d2/datalpha_8c.html#a0">ZeroPte</a>);
04660 
04661                     <a class="code" href="../../d4/d8/mi_8h.html#a886">MiDeletePte</a> (PointerPpe,
04662                                  PointerPde,
04663                                  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
04664                                  CurrentProcess,
04665                                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
04666                                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
04667 
04668                     <span class="comment">//</span>
04669                     <span class="comment">// Add back in the private page MiDeletePte subtracted.</span>
04670                     <span class="comment">//</span>
04671     
04672                     CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o41">NumberOfPrivatePages</a> += 1;
04673                 }
04674             }
04675         }
04676 <span class="preprocessor">#endif</span>
04677 <span class="preprocessor"></span>
04678         PointerPte -= 1;
04679     }
04680 
04681     <a class="code" href="../../d4/d8/mi_8h.html#a888">MiFlushPteList</a> (&amp;PteFlushList, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d4/d2/datalpha_8c.html#a0">ZeroPte</a>);
04682 
04683     <span class="keywordflow">if</span> (WsInfo-&gt;u.Flags.SessionSpace == 1) {
04684 
04685         <span class="comment">//</span>
04686         <span class="comment">// Session space has no ASN - flush the entire TB.</span>
04687         <span class="comment">//</span>
04688     
04689         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a200">MI_FLUSH_ENTIRE_SESSION_TB</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
04690     }
04691 
04692     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
04693 
04694     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (WorkingSetList-&gt;FirstFree &gt;= WorkingSetList-&gt;FirstDynamic);
04695 
04696     <span class="comment">//</span>
04697     <span class="comment">// Mark the last PTE in the list as free.</span>
04698     <span class="comment">//</span>
04699 
04700     LastEntry = (<a class="code" href="../../d1/d8/struct__MMWSLE.html">PMMWSLE</a>)((PCHAR)(<a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a>(FreeEntry)) + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
04701     LastEntry -= 1;
04702 
04703     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (LastEntry-&gt;u1.e1.Valid == 0);
04704     LastEntry-&gt;u1.Long = <a class="code" href="../../d4/d8/mi_8h.html#a10">WSLE_NULL_INDEX</a> &lt;&lt; <a class="code" href="../../d4/d8/mi_8h.html#a9">MM_FREE_WSLE_SHIFT</a>; <span class="comment">//End of List.</span>
04705     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (LastEntry &gt; &amp;Wsle[0]);
04706     WorkingSetList-&gt;LastInitializedWsle = (<a class="code" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a>)(LastEntry - &amp;Wsle[0]);
04707     WorkingSetList-&gt;NextSlot = WorkingSetList-&gt;FirstDynamic;
04708 
04709     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (WorkingSetList-&gt;LastEntry &lt;= WorkingSetList-&gt;LastInitializedWsle);
04710 
04711     <span class="keywordflow">if</span> (WorkingSetList-&gt;Quota &lt; WorkingSetList-&gt;LastInitializedWsle) {
04712         WorkingSetList-&gt;Quota = WorkingSetList-&gt;LastInitializedWsle;
04713     }
04714 
04715     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(&amp;Wsle[WorkingSetList-&gt;LastInitializedWsle]))-&gt;u.Hard.Valid == 1);
04716     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((WorkingSetList-&gt;FirstFree &lt;= WorkingSetList-&gt;LastInitializedWsle) ||
04717             (WorkingSetList-&gt;FirstFree == <a class="code" href="../../d4/d8/mi_8h.html#a10">WSLE_NULL_INDEX</a>));
04718 <span class="preprocessor">#if DBG</span>
04719 <span class="preprocessor"></span>    <a class="code" href="../../d4/d0/wslist_8c.html#a18">MiCheckNullIndex</a> (WorkingSetList);
04720 <span class="preprocessor">#endif //DBG</span>
04721 <span class="preprocessor"></span>    <span class="keywordflow">return</span>;
04722 }
04723 
04724 
04725 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l04726"></a><a class="code" href="../../d4/d0/wslist_8c.html#a35">04726</a> <a class="code" href="../../d4/d0/wslist_8c.html#a35">MiEmptyWorkingSet</a> (
04727     IN <a class="code" href="../../d3/d6/struct__MMSUPPORT.html">PMMSUPPORT</a> WsInfo,
04728     IN LOGICAL WaitOk
04729     )
04730 
04731 <span class="comment">/*++</span>
04732 <span class="comment"></span>
04733 <span class="comment">Routine Description:</span>
04734 <span class="comment"></span>
04735 <span class="comment">    This routine frees all pages from the working set.</span>
04736 <span class="comment"></span>
04737 <span class="comment">Arguments:</span>
04738 <span class="comment"></span>
04739 <span class="comment">    WsInfo - Supplies the working set information entry to trim.</span>
04740 <span class="comment"></span>
04741 <span class="comment">    WaitOk - Supplies TRUE if the caller can wait, FALSE if not.</span>
04742 <span class="comment"></span>
04743 <span class="comment">Return Value:</span>
04744 <span class="comment"></span>
04745 <span class="comment">    Status of operation.</span>
04746 <span class="comment"></span>
04747 <span class="comment">Environment:</span>
04748 <span class="comment"></span>
04749 <span class="comment">    Kernel mode. No locks.  For session operations, the caller is responsible</span>
04750 <span class="comment">    for attaching into the proper session.</span>
04751 <span class="comment"></span>
04752 <span class="comment">--*/</span>
04753 
04754 {
04755     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
04756     KIRQL OldIrql;
04757     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
04758     ULONG Entry;
04759     ULONG <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>;
04760     ULONG LastFreed;
04761     <a class="code" href="../../d0/d8/struct__MMWSL.html">PMMWSL</a> WorkingSetList;
04762     <a class="code" href="../../d1/d8/struct__MMWSLE.html">PMMWSLE</a> Wsle;
04763     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
04764     PFN_NUMBER PageFrameIndex;
04765     ULONG Last;
04766     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
04767     <a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html">PMM_SESSION_SPACE</a> SessionSpace;
04768 
04769     <span class="keywordflow">if</span> (WsInfo == &amp;<a class="code" href="../../d6/d8/sysinfo_8c.html#a21">MmSystemCacheWs</a>) {
04770         <span class="keywordflow">if</span> (WaitOk == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
04771             <a class="code" href="../../d4/d8/mi_8h.html#a144">LOCK_SYSTEM_WS</a> (OldIrql);
04772         }
04773         <span class="keywordflow">else</span> {
04774             <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>, &amp;OldIrql);
04775             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d8/ex_8h.html#a272">ExTryToAcquireResourceExclusiveLite</a> (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a688">MmSystemWsLock</a>)) {
04776 
04777                 <span class="comment">//</span>
04778                 <span class="comment">// System working set lock was not granted, don't trim</span>
04779                 <span class="comment">// the system cache.</span>
04780                 <span class="comment">//</span>
04781 
04782                 <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a> (OldIrql);
04783                 <span class="keywordflow">return</span> STATUS_SUCCESS;
04784             }
04785 
04786             <a class="code" href="../../d4/d8/mi_8h.html#a434">MmSystemLockOwner</a> = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
04787         }
04788     }
04789     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (WsInfo-&gt;u.Flags.SessionSpace == 0) {
04790         Process = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a> ();
04791         <span class="keywordflow">if</span> (WaitOk == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
04792             <a class="code" href="../../d4/d8/mi_8h.html#a154">LOCK_WS</a> (Process);
04793         }
04794         <span class="keywordflow">else</span> {
04795             <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> = 0;
04796             <span class="keywordflow">do</span> {
04797                 <span class="keywordflow">if</span> (ExTryToAcquireFastMutex(&amp;Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o22">WorkingSetLock</a>) != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
04798                     <span class="keywordflow">break</span>;
04799                 }
04800                 <a class="code" href="../../d1/d7/wait_8c.html#a2">KeDelayExecutionThread</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, &amp;<a class="code" href="../../d4/d8/mi_8h.html#a420">MmShortTime</a>);
04801                 <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> += 1;
04802                 <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> == 5) {
04803 
04804                     <span class="comment">//</span>
04805                     <span class="comment">// Could not get the lock, don't trim this process.</span>
04806                     <span class="comment">//</span>
04807 
04808                     <span class="keywordflow">return</span> STATUS_SUCCESS;
04809                 }
04810             } <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
04811         }
04812         <span class="keywordflow">if</span> (Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o27">AddressSpaceDeleted</a> != 0) {
04813             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_PROCESS_IS_TERMINATING;
04814             <span class="keywordflow">goto</span> Deleted;
04815         }
04816     }
04817     <span class="keywordflow">else</span> {
04818         <span class="keywordflow">if</span> (WaitOk == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
04819             <a class="code" href="../../d4/d8/mi_8h.html#a407">LOCK_SESSION_SPACE_WS</a> (OldIrql);
04820         }
04821         <span class="keywordflow">else</span> {
04822             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a581">MiHydra</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
04823             SessionSpace = CONTAINING_RECORD(WsInfo,
04824                                              <a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html">MM_SESSION_SPACE</a>,
04825                                              Vm);
04826 
04827             <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>, &amp;OldIrql);
04828 
04829             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d8/ex_8h.html#a272">ExTryToAcquireResourceExclusiveLite</a> (&amp;SessionSpace-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o32">WsLock</a>)) {
04830 
04831                 <span class="comment">//</span>
04832                 <span class="comment">// This session space's working set lock was not</span>
04833                 <span class="comment">// granted, don't trim it.</span>
04834                 <span class="comment">//</span>
04835 
04836                 <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a> (OldIrql);
04837                 <span class="keywordflow">return</span> STATUS_SUCCESS;
04838             }
04839 
04840             <a class="code" href="../../d4/d8/mi_8h.html#a404">MM_SET_SESSION_RESOURCE_OWNER</a>();
04841         }
04842     }
04843 
04844     WorkingSetList = WsInfo-&gt;VmWorkingSetList;
04845     Wsle = WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o5">Wsle</a>;
04846 
04847     <span class="comment">//</span>
04848     <span class="comment">// Attempt to remove the pages starting at the bottom.</span>
04849     <span class="comment">//</span>
04850 
04851     LastFreed = WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o3">LastEntry</a>;
04852     <span class="keywordflow">for</span> (Entry = WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>; Entry &lt;= LastFreed; Entry += 1) {
04853 
04854         <span class="keywordflow">if</span> (Wsle[Entry].<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Valid != 0) {
04855             <a class="code" href="../../d2/d1/mm_8h.html#a80">PERFINFO_PAGE_INFO_DECL</a>();
04856 
04857             PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (Wsle[Entry].u1.<a class="code" href="../../d1/d8/struct__MMWSLE.html#o0">VirtualAddress</a>);
04858 
04859             <a class="code" href="../../d2/d1/mm_8h.html#a53">PERFINFO_GET_PAGE_INFO</a>(PointerPte);
04860 
04861             <span class="keywordflow">if</span> (<a class="code" href="../../d9/d3/dynmem_8c.html#a2">MiTrimRemovalPagesOnly</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
04862                 PageFrameIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (PointerPte);
04863                 Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
04864                 <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.RemovalRequested == 0) {
04865                     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a>);
04866                     <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.RemovalRequested == 0) {
04867 <span class="preprocessor">#if defined (_WIN64)</span>
04868 <span class="preprocessor"></span>                        Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a>);
04869                         <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.RemovalRequested == 0) {
04870                             <span class="keywordflow">continue</span>;
04871                         }
04872 <span class="preprocessor">#else</span>
04873 <span class="preprocessor"></span>                        <span class="keywordflow">continue</span>;
04874 <span class="preprocessor">#endif</span>
04875 <span class="preprocessor"></span>                    }
04876                 }
04877             }
04878 
04879             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/wslist_8c.html#a26">MiFreeWsle</a> (Entry, WsInfo, PointerPte)) {
04880                 <a class="code" href="../../d2/d1/mm_8h.html#a74">PERFINFO_LOG_WS_REMOVAL</a>(PERFINFO_LOG_TYPE_OUTWS_EMPTYQ, WsInfo);
04881             }
04882         }
04883     }
04884 
04885     <span class="keywordflow">if</span> (WsInfo != &amp;<a class="code" href="../../d6/d8/sysinfo_8c.html#a21">MmSystemCacheWs</a> &amp;&amp; WsInfo-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.SessionSpace == 0) {
04886         <a class="code" href="../../d4/d0/wslist_8c.html#a17">MiRemoveWorkingSetPages</a> (WorkingSetList,WsInfo);
04887     }
04888     WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o0">Quota</a> = WsInfo-&gt;WorkingSetSize;
04889     WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o4">NextSlot</a> = WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>;
04890 
04891     <span class="comment">//</span>
04892     <span class="comment">// Attempt to remove the pages from the front to the end.</span>
04893     <span class="comment">//</span>
04894 
04895     <span class="comment">//</span>
04896     <span class="comment">// Reorder the free list.</span>
04897     <span class="comment">//</span>
04898 
04899     Last = 0;
04900     Entry = WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>;
04901     LastFreed = WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o7">LastInitializedWsle</a>;
04902     <span class="keywordflow">while</span> (Entry &lt;= LastFreed) {
04903         <span class="keywordflow">if</span> (Wsle[Entry].<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.Valid == 0) {
04904             <span class="keywordflow">if</span> (Last == 0) {
04905                 WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o1">FirstFree</a> = Entry;
04906             } <span class="keywordflow">else</span> {
04907                 Wsle[Last].<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.Long = Entry &lt;&lt; <a class="code" href="../../d4/d8/mi_8h.html#a9">MM_FREE_WSLE_SHIFT</a>;
04908             }
04909             Last = Entry;
04910         }
04911         Entry += 1;
04912     }
04913     <span class="keywordflow">if</span> (Last != 0) {
04914         Wsle[Last].<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.Long = <a class="code" href="../../d4/d8/mi_8h.html#a10">WSLE_NULL_INDEX</a> &lt;&lt; <a class="code" href="../../d4/d8/mi_8h.html#a9">MM_FREE_WSLE_SHIFT</a>;  <span class="comment">// End of list.</span>
04915     }
04916     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
04917 Deleted:
04918 
04919     <span class="keywordflow">if</span> (WsInfo == &amp;<a class="code" href="../../d6/d8/sysinfo_8c.html#a21">MmSystemCacheWs</a>) {
04920         <a class="code" href="../../d4/d8/mi_8h.html#a145">UNLOCK_SYSTEM_WS</a> (OldIrql);
04921     }
04922     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (WsInfo-&gt;u.Flags.SessionSpace == 0) {
04923         <a class="code" href="../../d4/d8/mi_8h.html#a158">UNLOCK_WS</a> (Process);
04924     }
04925     <span class="keywordflow">else</span> {
04926         <a class="code" href="../../d4/d8/mi_8h.html#a408">UNLOCK_SESSION_SPACE_WS</a> (OldIrql);
04927     }
04928 
04929     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
04930 }
04931 
04932 <span class="preprocessor">#if 0</span>
04933 <span class="preprocessor"></span>
04934 <span class="preprocessor">#define x256k_pte_mask (((256*1024) &gt;&gt; (PAGE_SHIFT - PTE_SHIFT)) - (sizeof(MMPTE)))</span>
04935 <span class="preprocessor"></span>
04936 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
04937 <a class="code" href="../../d4/d0/wslist_8c.html#a19">MiDumpWsleInCacheBlock</a> (
04938     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> CachePte
04939     )
04940 
04941 <span class="comment">/*++</span>
04942 <span class="comment"></span>
04943 <span class="comment">Routine Description:</span>
04944 <span class="comment"></span>
04945 <span class="comment">    The routine checks the prototype PTEs adjacent to the supplied</span>
04946 <span class="comment">    PTE and if they are modified, in the system cache working set,</span>
04947 <span class="comment">    and have a reference count of 1, removes it from the system</span>
04948 <span class="comment">    cache working set.</span>
04949 <span class="comment"></span>
04950 <span class="comment">Arguments:</span>
04951 <span class="comment"></span>
04952 <span class="comment">    CachePte - Supplies a pointer to the cache PTE.</span>
04953 <span class="comment"></span>
04954 <span class="comment">Return Value:</span>
04955 <span class="comment"></span>
04956 <span class="comment">    None.</span>
04957 <span class="comment"></span>
04958 <span class="comment">Environment:</span>
04959 <span class="comment"></span>
04960 <span class="comment">    Kernel mode, Working set lock and PFN lock held, APCs disabled.</span>
04961 <span class="comment"></span>
04962 <span class="comment">--*/</span>
04963 
04964 {
04965     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LoopPte;
04966     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
04967 
04968     LoopPte = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)((ULONG_PTR)CachePte &amp; ~x256k_pte_mask);
04969     PointerPte = CachePte - 1;
04970 
04971     <span class="keywordflow">while</span> (PointerPte &gt;= LoopPte ) {
04972 
04973         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/wslist_8c.html#a20">MiDumpPteInCacheBlock</a> (PointerPte) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
04974             <span class="keywordflow">break</span>;
04975         }
04976         PointerPte -= 1;
04977     }
04978 
04979     PointerPte = CachePte + 1;
04980     LoopPte = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)((ULONG_PTR)CachePte | x256k_pte_mask);
04981 
04982     <span class="keywordflow">while</span> (PointerPte &lt;= LoopPte ) {
04983 
04984         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/wslist_8c.html#a20">MiDumpPteInCacheBlock</a> (PointerPte) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
04985             <span class="keywordflow">break</span>;
04986         }
04987         PointerPte += 1;
04988     }
04989     <span class="keywordflow">return</span>;
04990 }
04991 
04992 ULONG
04993 <a class="code" href="../../d4/d0/wslist_8c.html#a20">MiDumpPteInCacheBlock</a> (
04994     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte
04995     )
04996 
04997 {
04998     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
04999     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> PteContents;
05000     ULONG WorkingSetIndex;
05001 
05002     PteContents = *PointerPte;
05003 
05004     <span class="keywordflow">if</span> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1) {
05005 
05006         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber);
05007 
05008         <span class="comment">//</span>
05009         <span class="comment">// If the PTE is valid and dirty (or pfn indicates dirty)</span>
05010         <span class="comment">// and the Wsle is direct index via the pfn wsindex element</span>
05011         <span class="comment">// and the reference count is one, then remove this page from</span>
05012         <span class="comment">// the cache manager's working set list.</span>
05013         <span class="comment">//</span>
05014 
05015         <span class="keywordflow">if</span> ((Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 1) &amp;&amp;
05016             ((Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.Modified == 1) ||
05017                 (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a114">MI_IS_PTE_DIRTY</a> (PteContents))) &amp;&amp;
05018                 (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (
05019                     MmSystemCacheWsle[Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.WsIndex].u1.VirtualAddress) ==
05020                     PointerPte)) {
05021 
05022             <span class="comment">//</span>
05023             <span class="comment">// Found a candidate, remove the page from the working set.</span>
05024             <span class="comment">//</span>
05025 
05026             WorkingSetIndex = Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.WsIndex;
05027             <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
05028             <a class="code" href="../../d4/d0/wslist_8c.html#a15">MiEliminateWorkingSetEntry</a> (WorkingSetIndex,
05029                                         PointerPte,
05030                                         Pfn1,
05031                                         MmSystemCacheWsle);
05032             <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
05033 
05034             <span class="comment">//</span>
05035             <span class="comment">// Remove the working set entry from the working set.</span>
05036             <span class="comment">//</span>
05037 
05038             <a class="code" href="../../d7/d0/wstree_8c.html#a8">MiRemoveWsle</a> (WorkingSetIndex, MmSystemCacheWorkingSetList);
05039 
05040             <span class="comment">//</span>
05041             <span class="comment">// Put the entry on the free list and decrement the current</span>
05042             <span class="comment">// size.</span>
05043             <span class="comment">//</span>
05044 
05045             <a class="code" href="../../d4/d8/mi_8h.html#a658">MmSystemCacheWsle</a>[WorkingSetIndex].<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.Long =
05046                   <a class="code" href="../../d4/d8/mi_8h.html#a657">MmSystemCacheWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o1">FirstFree</a> &lt;&lt; <a class="code" href="../../d4/d8/mi_8h.html#a9">MM_FREE_WSLE_SHIFT</a>;
05047             <a class="code" href="../../d4/d8/mi_8h.html#a657">MmSystemCacheWorkingSetList</a>-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o1">FirstFree</a> = WorkingSetIndex;
05048 
05049             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d8/sysinfo_8c.html#a21">MmSystemCacheWs</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o4">WorkingSetSize</a> &gt; <a class="code" href="../../d6/d8/sysinfo_8c.html#a21">MmSystemCacheWs</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o5">MinimumWorkingSetSize</a>) {
05050                 <a class="code" href="../../d4/d8/mi_8h.html#a590">MmPagesAboveWsMinimum</a> -= 1;
05051             }
05052             <a class="code" href="../../d6/d8/sysinfo_8c.html#a21">MmSystemCacheWs</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o4">WorkingSetSize</a> -= 1;
05053             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
05054         }
05055     }
05056     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05057 }
05058 <span class="preprocessor">#endif //0</span>
05059 <span class="preprocessor"></span>
05060 <span class="preprocessor">#if DBG</span>
05061 <span class="preprocessor"></span><a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
05062 <a class="code" href="../../d4/d0/wslist_8c.html#a18">MiCheckNullIndex</a> (
05063     IN <a class="code" href="../../d0/d8/struct__MMWSL.html">PMMWSL</a> WorkingSetList
05064     )
05065 
05066 {
05067     <a class="code" href="../../d1/d8/struct__MMWSLE.html">PMMWSLE</a> Wsle;
05068     ULONG j;
05069     ULONG Nulls = 0;
05070 
05071     Wsle = WorkingSetList-&gt;Wsle;
05072     <span class="keywordflow">for</span> (j = 0;j &lt;= WorkingSetList-&gt;LastInitializedWsle; j += 1) {
05073         <span class="keywordflow">if</span> ((((Wsle[j].<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.Long)) &gt;&gt; <a class="code" href="../../d4/d8/mi_8h.html#a9">MM_FREE_WSLE_SHIFT</a>) == <a class="code" href="../../d4/d8/mi_8h.html#a10">WSLE_NULL_INDEX</a>) {
05074             Nulls += 1;
05075         }
05076     }
05077     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Nulls == 1);
05078     <span class="keywordflow">return</span>;
05079 }
05080 
05081 <span class="preprocessor">#endif //DBG</span>
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:42:28 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
