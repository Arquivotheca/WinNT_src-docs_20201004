<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: restart.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>restart.c File Reference</h1><code>#include "<a class="el" href="../../d1/d3/lfsprocs_8h-source.html">lfsprocs.h</a>"</code><br>

<p>
<a href="../../d6/d8/restart_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d9/restart_8c.html#a0">Dbg</a>&nbsp;&nbsp;&nbsp;(DEBUG_TRACE_RESTART)</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d9/restart_8c.html#a1">LfsSetBaseLsnPriv</a> (IN <a class="el" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb, IN <a class="el" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html">PLFS_CLIENT_RECORD</a> ClientRecord, IN <a class="el" href="../../d6/d3/lfs_8h.html#a10">LSN</a> BaseLsn)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d9/restart_8c.html#a2">LfsReadRestartArea</a> (IN <a class="el" href="../../d6/d3/lfs_8h.html#a23">LFS_LOG_HANDLE</a> LogHandle, IN OUT PULONG BufferLength, IN PVOID <a class="el" href="../../d8/d6/ttri_8c.html#a3">Buffer</a>, OUT <a class="el" href="../../d6/d3/lfs_8h.html#a11">PLSN</a> Lsn)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d9/restart_8c.html#a3">LfsWriteRestartArea</a> (IN <a class="el" href="../../d6/d3/lfs_8h.html#a23">LFS_LOG_HANDLE</a> LogHandle, IN ULONG BufferLength, IN PVOID <a class="el" href="../../d8/d6/ttri_8c.html#a3">Buffer</a>, OUT <a class="el" href="../../d6/d3/lfs_8h.html#a11">PLSN</a> Lsn)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d9/restart_8c.html#a4">LfsSetBaseLsn</a> (IN <a class="el" href="../../d6/d3/lfs_8h.html#a23">LFS_LOG_HANDLE</a> LogHandle, IN <a class="el" href="../../d6/d3/lfs_8h.html#a10">LSN</a> BaseLsn)</td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a0" doxytag="restart.c::Dbg" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define Dbg&nbsp;&nbsp;&nbsp;(DEBUG_TRACE_RESTART)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d8/restart_8c-source.html#l00028">28</a> of file <a class="el" href="../../d6/d8/restart_8c-source.html">restart.c</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a2" doxytag="restart.c::LfsReadRestartArea" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS LfsReadRestartArea           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d6/d3/lfs_8h.html#a23">LFS_LOG_HANDLE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>LogHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>BufferLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Buffer</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d6/d3/lfs_8h.html#a11">PLSN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Lsn</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d8/restart_8c-source.html#l00046">46</a> of file <a class="el" href="../../d6/d8/restart_8c-source.html">restart.c</a>.
<p>
References <a class="el" href="../../d3/d6/notify_8c-source.html#l00236">Add2Ptr</a>, <a class="el" href="../../d7/d1/rtqkey_8c-source.html#l00042">Buffer</a>, <a class="el" href="../../d3/d8/pinsup_8c-source.html#l01000">CcUnpinData()</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00436">_LFCB::ClientArray</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00163">_LCH::ClientArrayByteOffset</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00092">_LFS_RECORD_HEADER::ClientDataLength</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00373">_LFS_CLIENT_RECORD::ClientRestartLsn</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d9/d2/lfsdata_8h-source.html#l00187">DebugUnwind</a>, <a class="el" href="../../d1/d3/ex_2alpha_2raisests_8c-source.html#l00157">ExRaiseStatus()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00142">_LCH::Lfcb</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00517">LfsAcquireLch</a>, <a class="el" href="../../d8/d1/lfs_2cachesup_8c-source.html#l00339">LfsCopyReadLogRecord()</a>, <a class="el" href="../../d8/d2/lfsdata_8c-source.html#l00058">LfsExceptionFilter()</a>, <a class="el" href="../../d8/d1/lfs_2cachesup_8c-source.html#l00248">LfsPinOrMapLogRecordHeader()</a>, <a class="el" href="../../d6/d8/restart_8c-source.html#l00046">LfsReadRestartArea()</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00520">LfsReleaseLch</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00512">LfsReleaseLfcb</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00593">LfsValidateClientId</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00584">LfsValidateLch</a>, <a class="el" href="../../d7/d2/lfs_8h-source.html#l00147">LfsZeroLsn</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00073">_LFS_RECORD_HEADER::ThisLsn</a>, and <a class="el" href="../../d6/d4/cc_8h-source.html#l02154">try_return</a>.
<p>
Referenced by <a class="el" href="../../d6/d8/restart_8c-source.html#l00046">LfsReadRestartArea()</a>.
<p>
<pre class="fragment"><div>00055                    :
00056 
00057     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client when he wishes to read his restart
00058     area in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
00059 
00060 Arguments:
00061 
00062     LogHandle - Pointer to <span class="keyword">private</span> Lfs structure used to identify <span class="keyword">this</span>
00063                 client.
00064 
00065     BufferLength - On entry <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user buffer.  On <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>
00066                    <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data stored in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer.
00067 
00068     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer where <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client restart data <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be
00069              copied.
00070 
00071     Lsn - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Lsn <span class="keywordflow">for</span> client restart area.
00072 
00073 Return Value:
00074 
00075     None
00076 
00077 --*/
00078 
00079 {
00080     <span class="keyword">volatile</span> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00081 
00082     BOOLEAN UsaError;
00083 
00084     <a class="code" href="../../d6/d9/struct__LCH.html">PLCH</a> Lch;
00085 
00086     <a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html">PLFS_CLIENT_RECORD</a> ClientRecord;
00087 
00088     <a class="code" href="../../d8/d0/struct__LFS__RECORD__HEADER.html">PLFS_RECORD_HEADER</a> RecordHeader;
00089     <a class="code" href="../../d4/d3/struct__BCB.html">PBCB</a> RecordHeaderBcb;
00090 
00091     <a class="code" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb;
00092     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> RetStatus = STATUS_SUCCESS;
00093 
00094 
00095     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00096 
00097     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"LfsReadRestartArea:  Entered\n"</span>, 0 );
00098     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Log Handle    -&gt; %08lx\n"</span>, LogHandle );
00099     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Buffer Length -&gt; %08lx\n"</span>, *BufferLength );
00100     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Buffer        -&gt; %08lx\n"</span>, Buffer );
00101 
00102     RecordHeaderBcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00103 
00104     Lch = (<a class="code" href="../../d6/d9/struct__LCH.html">PLCH</a>) LogHandle;
00105 
00106     <span class="comment">//</span>
00107     <span class="comment">//  Check that the structure is a valid log handle structure.</span>
00108     <span class="comment">//</span>
00109 
00110     <a class="code" href="../../d0/d4/lfsprocs_8h.html#a32">LfsValidateLch</a>( Lch );
00111 
00112     <span class="comment">//</span>
00113     <span class="comment">//  Use a try-except to catch errors.</span>
00114     <span class="comment">//</span>
00115 
00116     <span class="keywordflow">try</span> {
00117 
00118         <span class="comment">//</span>
00119         <span class="comment">//  Use a try-finally to facilitate cleanup.</span>
00120         <span class="comment">//</span>
00121 
00122         <span class="keywordflow">try</span> {
00123 
00124             <span class="comment">//</span>
00125             <span class="comment">//  Acquire the log file control block for this log file.</span>
00126             <span class="comment">//</span>
00127 
00128             <a class="code" href="../../d0/d4/lfsprocs_8h.html#a30">LfsAcquireLch</a>( Lch );
00129             Lfcb = Lch-&gt;<a class="code" href="../../d6/d9/struct__LCH.html#o3">Lfcb</a>;
00130 
00131             <span class="comment">//</span>
00132             <span class="comment">//  If the Log file has been closed then refuse access.</span>
00133             <span class="comment">//</span>
00134 
00135             <span class="keywordflow">if</span> (Lfcb == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00136 
00137                 <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( STATUS_ACCESS_DENIED );
00138             }
00139 
00140             <span class="comment">//</span>
00141             <span class="comment">//  Check that the client Id is valid.</span>
00142             <span class="comment">//</span>
00143 
00144             <a class="code" href="../../d0/d4/lfsprocs_8h.html#a33">LfsValidateClientId</a>( Lfcb, Lch );
00145 
00146             ClientRecord = <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o31">ClientArray</a>,
00147                                     Lch-&gt;<a class="code" href="../../d6/d9/struct__LCH.html#o6">ClientArrayByteOffset</a>,
00148                                     <a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html">PLFS_CLIENT_RECORD</a> );
00149 
00150             <span class="comment">//</span>
00151             <span class="comment">//  If the client doesn't have a restart area, go ahead and exit</span>
00152             <span class="comment">//  now.</span>
00153             <span class="comment">//</span>
00154 
00155             <span class="keywordflow">if</span> ( ClientRecord-&gt;<a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html#o1">ClientRestartLsn</a>.QuadPart == 0 ) {                                                      <span class="comment">//**** xxEqlZero( ClientRecord-&gt;ClientRestartLsn )</span>
00156 
00157                 <span class="comment">//</span>
00158                 <span class="comment">//  We show there is no restart area by returning a length</span>
00159                 <span class="comment">//  of zero.  We also set the Lsn value to zero so that</span>
00160                 <span class="comment">//  we can catch it if the user tries to use the Lsn.</span>
00161                 <span class="comment">//</span>
00162 
00163                 <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( 0, Dbg, <span class="stringliteral">"No client restart area exists\n"</span>, 0 );
00164 
00165                 *BufferLength = 0;
00166                 *Lsn = <a class="code" href="../../d6/d3/lfs_8h.html#a12">LfsZeroLsn</a>;
00167 
00168                 <a class="code" href="../../d5/d5/cc_8h.html#a90">try_return</a>( NOTHING );
00169             }
00170 
00171             <span class="comment">//</span>
00172             <span class="comment">//  Release the Lfcb as we won't be modifying any fields in it.</span>
00173             <span class="comment">//</span>
00174 
00175             <a class="code" href="../../d0/d4/lfsprocs_8h.html#a29">LfsReleaseLfcb</a>( Lfcb );
00176 
00177             <span class="comment">//</span>
00178             <span class="comment">//  Pin the log record for this Lsn.</span>
00179             <span class="comment">//</span>
00180 
00181             <a class="code" href="../../d0/d4/lfsprocs_8h.html#a49">LfsPinOrMapLogRecordHeader</a>( Lfcb,
00182                                         ClientRecord-&gt;<a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html#o1">ClientRestartLsn</a>,
00183                                         FALSE,
00184                                         FALSE,
00185                                         &amp;UsaError,
00186                                         &amp;RecordHeader,
00187                                         &amp;RecordHeaderBcb );
00188 
00189             <span class="comment">//</span>
00190             <span class="comment">//  If the Lsn values don't match, then the disk is corrupt.</span>
00191             <span class="comment">//</span>
00192 
00193             <span class="keywordflow">if</span> ( ClientRecord-&gt;<a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html#o1">ClientRestartLsn</a>.QuadPart != RecordHeader-&gt;<a class="code" href="../../d8/d0/struct__LFS__RECORD__HEADER.html#o0">ThisLsn</a>.QuadPart ) {                         <span class="comment">//**** xxNeq( ClientRecord-&gt;ClientRestartLsn, RecordHeader-&gt;ThisLsn )</span>
00194 
00195                 <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( STATUS_DISK_CORRUPT_ERROR );
00196             }
00197 
00198 
00199             <span class="comment">//</span>
00200             <span class="comment">//  Check that the user's buffer is big enough to hold the restart</span>
00201             <span class="comment">//  data.  We raise an error status for this error.</span>
00202             <span class="comment">//</span>
00203 
00204             <span class="keywordflow">if</span> (RecordHeader-&gt;<a class="code" href="../../d8/d0/struct__LFS__RECORD__HEADER.html#o3">ClientDataLength</a> &gt; *BufferLength) {
00205 
00206                 <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( 0, Dbg, <span class="stringliteral">"Client buffer is too small\n"</span>, 0 );
00207                 *BufferLength = RecordHeader-&gt;<a class="code" href="../../d8/d0/struct__LFS__RECORD__HEADER.html#o3">ClientDataLength</a>;
00208                 *Lsn = <a class="code" href="../../d6/d3/lfs_8h.html#a12">LfsZeroLsn</a>;
00209                 <a class="code" href="../../d5/d5/cc_8h.html#a90">try_return</a>( RetStatus = STATUS_BUFFER_TOO_SMALL );
00210             }
00211 
00212 
00213             <span class="comment">//</span>
00214             <span class="comment">//  Use the cache manager to copy the data into the user's buffer.</span>
00215             <span class="comment">//</span>
00216 
00217             <a class="code" href="../../d0/d4/lfsprocs_8h.html#a50">LfsCopyReadLogRecord</a>( Lfcb,
00218                                   RecordHeader,
00219                                   Buffer );
00220 
00221             <span class="comment">//</span>
00222             <span class="comment">//  Pass the length and the Lsn of the restart area back to the</span>
00223             <span class="comment">//  caller.</span>
00224             <span class="comment">//</span>
00225 
00226             *BufferLength = RecordHeader-&gt;<a class="code" href="../../d8/d0/struct__LFS__RECORD__HEADER.html#o3">ClientDataLength</a>;
00227             *Lsn = RecordHeader-&gt;<a class="code" href="../../d8/d0/struct__LFS__RECORD__HEADER.html#o0">ThisLsn</a>;
00228 
00229         try_exit: NOTHING;
00230         } finally {
00231 
00232             <a class="code" href="../../d8/d3/lfsdata_8h.html#a3">DebugUnwind</a>( LfsReadRestartArea );
00233 
00234             <span class="comment">//</span>
00235             <span class="comment">//  Release the log file control block if held.</span>
00236             <span class="comment">//</span>
00237 
00238             <a class="code" href="../../d0/d4/lfsprocs_8h.html#a31">LfsReleaseLch</a>( Lch );
00239 
00240             <span class="comment">//</span>
00241             <span class="comment">//  Unpin the log record header for the client restart if pinned.</span>
00242             <span class="comment">//</span>
00243 
00244             <span class="keywordflow">if</span> (RecordHeaderBcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00245 
00246                 <a class="code" href="../../d4/d2/cache_8h.html#a92">CcUnpinData</a>( RecordHeaderBcb );
00247             }
00248 
00249             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Lsn (Low)     -&gt; %08lx\n"</span>, Lsn-&gt;LowPart );
00250             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Lsn (High)    -&gt; %08lx\n"</span>, Lsn-&gt;HighPart );
00251             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Buffer Length -&gt; %08lx\n"</span>, *BufferLength );
00252             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"LfsReadRestartArea:  Exit\n"</span>, 0 );
00253         }
00254 
00255     } except (<a class="code" href="../../d0/d4/lfsprocs_8h.html#a56">LfsExceptionFilter</a>( GetExceptionInformation() )) {
00256 
00257         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00258     }
00259 
00260     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_SUCCESS) {
00261 
00262         <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( Status );
00263     }
00264 
00265     <span class="keywordflow">return</span> RetStatus;
00266 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="restart.c::LfsSetBaseLsn" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID LfsSetBaseLsn           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d6/d3/lfs_8h.html#a23">LFS_LOG_HANDLE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>LogHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d6/d3/lfs_8h.html#a10">LSN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>BaseLsn</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d8/restart_8c-source.html#l00447">447</a> of file <a class="el" href="../../d6/d8/restart_8c-source.html">restart.c</a>.
<p>
References <a class="el" href="../../d3/d6/notify_8c-source.html#l00236">Add2Ptr</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00436">_LFCB::ClientArray</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00163">_LCH::ClientArrayByteOffset</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d9/d2/lfsdata_8h-source.html#l00187">DebugUnwind</a>, <a class="el" href="../../d1/d3/ex_2alpha_2raisests_8c-source.html#l00157">ExRaiseStatus()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00142">_LCH::Lfcb</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00517">LfsAcquireLch</a>, <a class="el" href="../../d8/d2/lfsdata_8c-source.html#l00058">LfsExceptionFilter()</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00520">LfsReleaseLch</a>, <a class="el" href="../../d6/d8/restart_8c-source.html#l00447">LfsSetBaseLsn()</a>, <a class="el" href="../../d6/d8/restart_8c-source.html#l00582">LfsSetBaseLsnPriv()</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00593">LfsValidateClientId</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00584">LfsValidateLch</a>, <a class="el" href="../../d8/d9/rstrtsup_8c-source.html#l00036">LfsWriteLfsRestart()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00444">_LFCB::RestartAreaSize</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
Referenced by <a class="el" href="../../d6/d8/restart_8c-source.html#l00447">LfsSetBaseLsn()</a>.
<p>
<pre class="fragment"><div>00454                    :
00455 
00456     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client to notify <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log service of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00457     oldest Lsn he expects to need during restart.  The Lfs <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> allowed to
00458     reuse any part of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> circular log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> which logically precedes
00459     <span class="keyword">this</span> Lsn.  <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> client may <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> specify a Lsn which follows <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> previous
00460     Lsn specified by <span class="keyword">this</span> client.
00461 
00462 Arguments:
00463 
00464     LogHandle - Pointer to <span class="keyword">private</span> Lfs structure used to identify <span class="keyword">this</span>
00465                 client.
00466 
00467     BaseLsn - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> oldest Lsn <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client may require during a
00468               restart.
00469 
00470 Return Value:
00471 
00472     None
00473 
00474 --*/
00475 
00476 {
00477     <span class="keyword">volatile</span> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00478 
00479     <a class="code" href="../../d6/d9/struct__LCH.html">PLCH</a> Lch;
00480 
00481     <a class="code" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb;
00482 
00483     <a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html">PLFS_CLIENT_RECORD</a> ClientRecord;
00484 
00485     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00486 
00487     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"LfsSetBaseLsn:  Entered\n"</span>, 0 );
00488     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Log Handle        -&gt; %08lx\n"</span>, LogHandle );
00489     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Base Lsn (Low)    -&gt; %08lx\n"</span>, BaseLsn.LowPart );
00490     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Base Lsn (High)   -&gt; %08lx\n"</span>, BaseLsn.HighPart );
00491 
00492     Lch = (<a class="code" href="../../d6/d9/struct__LCH.html">PLCH</a>) LogHandle;
00493 
00494     <span class="comment">//</span>
00495     <span class="comment">//  Check that the structure is a valid log handle structure.</span>
00496     <span class="comment">//</span>
00497 
00498     <a class="code" href="../../d0/d4/lfsprocs_8h.html#a32">LfsValidateLch</a>( Lch );
00499 
00500     <span class="comment">//</span>
00501     <span class="comment">//  Use a try-except to catch errors.</span>
00502     <span class="comment">//</span>
00503 
00504     <span class="keywordflow">try</span> {
00505 
00506         <span class="comment">//</span>
00507         <span class="comment">//  Use a try-finally to facilitate cleanup.</span>
00508         <span class="comment">//</span>
00509 
00510         <span class="keywordflow">try</span> {
00511 
00512             <span class="comment">//</span>
00513             <span class="comment">//  Acquire the log file control block for this log file.</span>
00514             <span class="comment">//</span>
00515 
00516             <a class="code" href="../../d0/d4/lfsprocs_8h.html#a30">LfsAcquireLch</a>( Lch );
00517             Lfcb = Lch-&gt;<a class="code" href="../../d6/d9/struct__LCH.html#o3">Lfcb</a>;
00518 
00519             <span class="comment">//</span>
00520             <span class="comment">//  If the Log file has been closed then refuse access.</span>
00521             <span class="comment">//</span>
00522 
00523             <span class="keywordflow">if</span> (Lfcb == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00524 
00525                 <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( STATUS_ACCESS_DENIED );
00526             }
00527 
00528             <span class="comment">//</span>
00529             <span class="comment">//  Check that the client Id is valid.</span>
00530             <span class="comment">//</span>
00531 
00532             <a class="code" href="../../d0/d4/lfsprocs_8h.html#a33">LfsValidateClientId</a>( Lfcb, Lch );
00533 
00534             ClientRecord = <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o31">ClientArray</a>,
00535                                     Lch-&gt;<a class="code" href="../../d6/d9/struct__LCH.html#o6">ClientArrayByteOffset</a>,
00536                                     <a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html">PLFS_CLIENT_RECORD</a> );
00537 
00538             <span class="comment">//</span>
00539             <span class="comment">//  We simply call the worker routine to advance the base lsn.</span>
00540             <span class="comment">//  If we moved forward in the file, we will put our restart area in the</span>
00541             <span class="comment">//  queue.</span>
00542             <span class="comment">//</span>
00543 
00544             <a class="code" href="../../d5/d9/restart_8c.html#a1">LfsSetBaseLsnPriv</a>( Lfcb,
00545                                ClientRecord,
00546                                BaseLsn );
00547 
00548             <a class="code" href="../../d7/d0/rstrtsup_8c.html#a1">LfsWriteLfsRestart</a>( Lfcb, Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o34">RestartAreaSize</a>, FALSE );
00549 
00550         } finally {
00551 
00552             <a class="code" href="../../d8/d3/lfsdata_8h.html#a3">DebugUnwind</a>( LfsSetBaseLsn );
00553 
00554             <span class="comment">//</span>
00555             <span class="comment">//  Release the log file control block if held.</span>
00556             <span class="comment">//</span>
00557 
00558             <a class="code" href="../../d0/d4/lfsprocs_8h.html#a31">LfsReleaseLch</a>( Lch );
00559 
00560             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"LfsSetBaseLsn:  Exit\n"</span>, 0 );
00561         }
00562 
00563     } except (<a class="code" href="../../d0/d4/lfsprocs_8h.html#a56">LfsExceptionFilter</a>( GetExceptionInformation() )) {
00564 
00565         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00566     }
00567 
00568     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_SUCCESS) {
00569 
00570         <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( Status );
00571     }
00572 
00573     <span class="keywordflow">return</span>;
00574 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="restart.c::LfsSetBaseLsnPriv" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID LfsSetBaseLsnPriv           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d0/struct__LFCB.html">PLFCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Lfcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html">PLFS_CLIENT_RECORD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ClientRecord</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d6/d3/lfs_8h.html#a10">LSN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>BaseLsn</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d8/restart_8c-source.html#l00582">582</a> of file <a class="el" href="../../d6/d8/restart_8c-source.html">restart.c</a>.
<p>
References <a class="el" href="../../d6/d4/cc_8h-source.html#l00509">ClearFlag</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00604">LFCB_NO_OLDEST_LSN</a>, <a class="el" href="../../d8/d4/lfs_2verfysup_8c-source.html#l00412">LfsFindCurrentAvail()</a>, <a class="el" href="../../d8/d9/rstrtsup_8c-source.html#l00189">LfsFindOldestClientLsn()</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00302">LfsLsnToFileOffset</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d6/d8/restart_8c-source.html#l00447">LfsSetBaseLsn()</a>, and <a class="el" href="../../d6/d8/restart_8c-source.html#l00270">LfsWriteRestartArea()</a>.
<p>
<pre class="fragment"><div>00590                    :
00591 
00592     This worker routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called internally by Lfs to modify <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00593     oldest Lsn a client expects to need during restart.  The Lfs <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> allowed to
00594     reuse any part of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> circular log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> which logically precedes
00595     <span class="keyword">this</span> Lsn.  <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> client may <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> specify a Lsn which follows <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> previous
00596     Lsn specified by <span class="keyword">this</span> client.
00597 
00598 Arguments:
00599 
00600     Lfcb - Log context block <span class="keywordflow">for</span> <span class="keyword">this</span> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
00601 
00602     ClientRecord - For <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client whose base Lsn <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being modified.
00603 
00604     BaseLsn - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> oldest Lsn <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client may require during a
00605               restart.
00606 
00607 Return Value:
00608 
00609     None.
00610 
00611 --*/
00612 
00613 {
00614     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00615 
00616     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"LfsSetBaseLsn:  Entered\n"</span>, 0 );
00617     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Lfcb              -&gt; %08lx\n"</span>, Lfcb );
00618     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Base Lsn (Low)    -&gt; %08lx\n"</span>, BaseLsn.LowPart );
00619     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Base Lsn (High)   -&gt; %08lx\n"</span>, BaseLsn.HighPart );
00620 
00621     <span class="comment">//</span>
00622     <span class="comment">//  We only proceed if the client is moving forward in the file.</span>
00623     <span class="comment">//</span>
00624 
00625     <span class="keywordflow">if</span> ( BaseLsn.QuadPart &gt; Lfcb-&gt;OldestLsn.QuadPart ) {                                                               <span class="comment">//**** xxGtr( BaseLsn, Lfcb-&gt;OldestLsn )</span>
00626 
00627         <span class="keywordflow">if</span> ( BaseLsn.QuadPart &gt; ClientRecord-&gt;OldestLsn.QuadPart ) {                                                   <span class="comment">//**** xxGtr( BaseLsn, ClientRecord-&gt;OldestLsn )</span>
00628 
00629             ClientRecord-&gt;OldestLsn = BaseLsn;
00630         }
00631 
00632         Lfcb-&gt;OldestLsn = BaseLsn;
00633 
00634         <span class="comment">//</span>
00635         <span class="comment">//  We walk through all the active clients and find the new</span>
00636         <span class="comment">//  oldest Lsn for the log file.</span>
00637         <span class="comment">//</span>
00638 
00639         <a class="code" href="../../d7/d0/rstrtsup_8c.html#a2">LfsFindOldestClientLsn</a>( Lfcb-&gt;RestartArea,
00640                                 Lfcb-&gt;ClientArray,
00641                                 &amp;Lfcb-&gt;OldestLsn );
00642 
00643         Lfcb-&gt;OldestLsnOffset = <a class="code" href="../../d0/d4/lfsprocs_8h.html#a12">LfsLsnToFileOffset</a>( Lfcb, Lfcb-&gt;OldestLsn );
00644         <a class="code" href="../../d5/d5/cc_8h.html#a61">ClearFlag</a>( Lfcb-&gt;Flags, LFCB_NO_OLDEST_LSN );
00645 
00646         <a class="code" href="../../d7/d5/lfs_2verfysup_8c.html#a2">LfsFindCurrentAvail</a>( Lfcb );
00647     }
00648 
00649     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"LfsSetBaseLsnPriv:  Exit\n"</span>, 0 );
00650 
00651     <span class="keywordflow">return</span>;
00652 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="restart.c::LfsWriteRestartArea" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID LfsWriteRestartArea           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d6/d3/lfs_8h.html#a23">LFS_LOG_HANDLE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>LogHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>BufferLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Buffer</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d6/d3/lfs_8h.html#a11">PLSN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Lsn</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d8/restart_8c-source.html#l00270">270</a> of file <a class="el" href="../../d6/d8/restart_8c-source.html">restart.c</a>.
<p>
References <a class="el" href="../../d3/d6/notify_8c-source.html#l00236">Add2Ptr</a>, <a class="el" href="../../d7/d2/lfs_8h-source.html#l00210">_LFS_WRITE_ENTRY::Buffer</a>, <a class="el" href="../../d7/d1/rtqkey_8c-source.html#l00042">Buffer</a>, <a class="el" href="../../d7/d2/lfs_8h-source.html#l00211">_LFS_WRITE_ENTRY::ByteLength</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00436">_LFCB::ClientArray</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00163">_LCH::ClientArrayByteOffset</a>, <a class="el" href="../../d0/d3/lfsdisk_8h-source.html#l00373">_LFS_CLIENT_RECORD::ClientRestartLsn</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d9/d2/lfsdata_8h-source.html#l00187">DebugUnwind</a>, <a class="el" href="../../d1/d3/ex_2alpha_2raisests_8c-source.html#l00157">ExRaiseStatus()</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00142">_LCH::Lfcb</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00517">LfsAcquireLch</a>, <a class="el" href="../../d6/d3/lfs_8h.html#a62a32">LfsClientRestart</a>, <a class="el" href="../../d8/d2/lfsdata_8c-source.html#l00058">LfsExceptionFilter()</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00520">LfsReleaseLch</a>, <a class="el" href="../../d6/d8/restart_8c-source.html#l00582">LfsSetBaseLsnPriv()</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00593">LfsValidateClientId</a>, <a class="el" href="../../d1/d3/lfsprocs_8h-source.html#l00584">LfsValidateLch</a>, <a class="el" href="../../d8/d9/rstrtsup_8c-source.html#l00036">LfsWriteLfsRestart()</a>, <a class="el" href="../../d8/d4/logrcsup_8c-source.html#l00055">LfsWriteLogRecordIntoLogPage()</a>, <a class="el" href="../../d6/d8/restart_8c-source.html#l00270">LfsWriteRestartArea()</a>, <a class="el" href="../../d7/d2/lfs_8h-source.html#l00147">LfsZeroLsn</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d3/lfsstruc_8h-source.html#l00444">_LFCB::RestartAreaSize</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d6/d8/restart_8c-source.html#l00270">LfsWriteRestartArea()</a>.
<p>
<pre class="fragment"><div>00279                    :
00280 
00281     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client to write a restart area to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00282     disk.  This routine will not <span class="keywordflow">return</span> to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller until <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client
00283     restart area and all prior Lsn's have been flushed and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Lfs
00284     restart area on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> disk has been updated.
00285 
00286     On <span class="keywordflow">return</span>, all log records up to and including 'Lsn' have been flushed
00287     to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> disk.
00288 
00289 Arguments:
00290 
00291     LogHandle - Pointer to <span class="keyword">private</span> Lfs structure used to identify <span class="keyword">this</span>
00292                 client.
00293 
00294     BufferLength - On entry <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user buffer.
00295 
00296     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer where <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client restart data resides.
00297 
00298     Lsn - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Lsn <span class="keywordflow">for</span> <span class="keyword">this</span> write operation.  On input, <span class="keyword">this</span> will be <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00299           <span class="keyword">new</span> Base Lsn <span class="keywordflow">for</span> <span class="keyword">this</span> client.
00300 
00301           ****  This was used to prevent adding an interface change to
00302                 <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Beta release.
00303 
00304 Return Value:
00305 
00306     None
00307 
00308 --*/
00309 
00310 {
00311     <span class="keyword">volatile</span> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00312 
00313     <a class="code" href="../../d6/d9/struct__LCH.html">PLCH</a> Lch;
00314 
00315     <a class="code" href="../../d1/d0/struct__LFCB.html">PLFCB</a> Lfcb;
00316 
00317     <a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html">PLFS_CLIENT_RECORD</a> ClientRecord;
00318 
00319     <a class="code" href="../../d6/d1/struct__LFS__WRITE__ENTRY.html">LFS_WRITE_ENTRY</a> WriteEntry;
00320 
00321     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00322 
00323     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( +1, Dbg, <span class="stringliteral">"LfsWriteRestartArea:  Entered\n"</span>, 0 );
00324     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Log Handle    -&gt; %08lx\n"</span>, LogHandle );
00325     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Buffer Length -&gt; %08lx\n"</span>, BufferLength );
00326     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Buffer        -&gt; %08lx\n"</span>, Buffer );
00327 
00328     Lch = (<a class="code" href="../../d6/d9/struct__LCH.html">PLCH</a>) LogHandle;
00329 
00330     <span class="comment">//</span>
00331     <span class="comment">//  Check that the structure is a valid log handle structure.</span>
00332     <span class="comment">//</span>
00333 
00334     <a class="code" href="../../d0/d4/lfsprocs_8h.html#a32">LfsValidateLch</a>( Lch );
00335 
00336     <span class="comment">//</span>
00337     <span class="comment">//  Use a try-except to catch errors.</span>
00338     <span class="comment">//</span>
00339 
00340     <span class="keywordflow">try</span> {
00341 
00342         <span class="comment">//</span>
00343         <span class="comment">//  Use a try-finally to facilitate cleanup.</span>
00344         <span class="comment">//</span>
00345 
00346         <span class="keywordflow">try</span> {
00347 
00348             <span class="comment">//</span>
00349             <span class="comment">//  Acquire the log file control block for this log file.</span>
00350             <span class="comment">//</span>
00351 
00352             <a class="code" href="../../d0/d4/lfsprocs_8h.html#a30">LfsAcquireLch</a>( Lch );
00353             Lfcb = Lch-&gt;<a class="code" href="../../d6/d9/struct__LCH.html#o3">Lfcb</a>;
00354 
00355             <span class="comment">//</span>
00356             <span class="comment">//  If the Log file has been closed then refuse access.</span>
00357             <span class="comment">//</span>
00358 
00359             <span class="keywordflow">if</span> (Lfcb == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00360 
00361                 <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( STATUS_ACCESS_DENIED );
00362             }
00363 
00364             <span class="comment">//</span>
00365             <span class="comment">//  Check that the client Id is valid.</span>
00366             <span class="comment">//</span>
00367 
00368             <a class="code" href="../../d0/d4/lfsprocs_8h.html#a33">LfsValidateClientId</a>( Lfcb, Lch );
00369 
00370             ClientRecord = <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o31">ClientArray</a>,
00371                                     Lch-&gt;<a class="code" href="../../d6/d9/struct__LCH.html#o6">ClientArrayByteOffset</a>,
00372                                     <a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html">PLFS_CLIENT_RECORD</a> );
00373 
00374             <span class="comment">//</span>
00375             <span class="comment">//  Go ahead and update the Base Lsn in the client area if the value</span>
00376             <span class="comment">//  given is not zero.</span>
00377             <span class="comment">//</span>
00378 
00379             <span class="keywordflow">if</span> ( Lsn-&gt;QuadPart != 0 ) {                                                                                <span class="comment">//**** xxNeqZero( *Lsn )</span>
00380 
00381                 <a class="code" href="../../d5/d9/restart_8c.html#a1">LfsSetBaseLsnPriv</a>( Lfcb,
00382                                    ClientRecord,
00383                                    *Lsn );
00384             }
00385 
00386             <span class="comment">//</span>
00387             <span class="comment">//  Write this restart area as a log record into a log page.</span>
00388             <span class="comment">//</span>
00389 
00390             WriteEntry.<a class="code" href="../../d6/d1/struct__LFS__WRITE__ENTRY.html#o0">Buffer</a> = <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
00391             WriteEntry.<a class="code" href="../../d6/d1/struct__LFS__WRITE__ENTRY.html#o1">ByteLength</a> = BufferLength;
00392 
00393             <a class="code" href="../../d7/d5/logrcsup_8c.html#a3">LfsWriteLogRecordIntoLogPage</a>( Lfcb,
00394                                           Lch,
00395                                           1,
00396                                           &amp;WriteEntry,
00397                                           LfsClientRestart,
00398                                           NULL,
00399                                           LfsZeroLsn,
00400                                           LfsZeroLsn,
00401                                           0,
00402                                           TRUE,
00403                                           Lsn );
00404 
00405             <span class="comment">//</span>
00406             <span class="comment">//  Update the restart area for the client.</span>
00407             <span class="comment">//</span>
00408 
00409             ClientRecord-&gt;<a class="code" href="../../d4/d0/struct__LFS__CLIENT__RECORD.html#o1">ClientRestartLsn</a> = *Lsn;
00410 
00411             <span class="comment">//</span>
00412             <span class="comment">//  Write the restart area to the disk.</span>
00413             <span class="comment">//</span>
00414 
00415             <a class="code" href="../../d7/d0/rstrtsup_8c.html#a1">LfsWriteLfsRestart</a>( Lfcb, Lfcb-&gt;<a class="code" href="../../d1/d0/struct__LFCB.html#o34">RestartAreaSize</a>, TRUE );
00416 
00417         } finally {
00418 
00419             <a class="code" href="../../d8/d3/lfsdata_8h.html#a3">DebugUnwind</a>( LfsWriteRestartArea );
00420 
00421             <span class="comment">//</span>
00422             <span class="comment">//  Release the log file control block if still held.</span>
00423             <span class="comment">//</span>
00424 
00425             <a class="code" href="../../d0/d4/lfsprocs_8h.html#a31">LfsReleaseLch</a>( Lch );
00426 
00427             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Lsn (Low)     -&gt; %08lx\n"</span>, Lsn-&gt;LowPart );
00428             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(  0, Dbg, <span class="stringliteral">"Log (High)    -&gt; %08lx\n"</span>, Lsn-&gt;HighPart );
00429             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( -1, Dbg, <span class="stringliteral">"LfsWriteRestartArea:  Exit\n"</span>, 0 );
00430         }
00431 
00432     } except (<a class="code" href="../../d0/d4/lfsprocs_8h.html#a56">LfsExceptionFilter</a>( GetExceptionInformation() )) {
00433 
00434         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00435     }
00436 
00437     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_SUCCESS) {
00438 
00439         <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( Status );
00440     }
00441 
00442     <span class="keywordflow">return</span>;
00443 }

</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:45:29 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
