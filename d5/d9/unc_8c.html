<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: unc.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>unc.c File Reference</h1><code>#include "<a class="el" href="../../d4/d7/fsrtlp_8h-source.html">fsrtlp.h</a>"</code><br>
<code>#include &lt;zwapi.h&gt;</code><br>
<code>#include &lt;ntddmup.h&gt;</code><br>
<code>#include &lt;ntddnull.h&gt;</code><br>

<p>
<a href="../../d6/d8/unc_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d9/unc_8c.html#a0">MODULE_POOL_TAG</a>&nbsp;&nbsp;&nbsp;('nuSF')</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d9/unc_8c.html#a1">DISABLE_DFS_VALUE_NAME</a>&nbsp;&nbsp;&nbsp;L"DisableDfs"</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d9/unc_8c.html#a13">FsRtlpRegisterProviderWithMUP</a> (IN HANDLE mupHandle, IN PUNICODE_STRING <a class="el" href="../../d5/d9/unc_8c.html#a8">RedirDevName</a>, IN BOOLEAN <a class="el" href="../../d5/d9/unc_8c.html#a9">MailslotsSupported</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d9/unc_8c.html#a14">FsRtlpOpenDev</a> (IN OUT PHANDLE <a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a29">Handle</a>, IN LPWSTR DevNameStr)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d9/unc_8c.html#a15">FsRtlpSetSymbolicLink</a> (IN PUNICODE_STRING DevName OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d9/unc_8c.html#a16">FsRtlpIsDfsEnabled</a> ()</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d9/unc_8c.html#a17">FsRtlRegisterUncProvider</a> (IN OUT PHANDLE <a class="el" href="../../d5/d9/unc_8c.html#a6">MupHandle</a>, IN PUNICODE_STRING <a class="el" href="../../d5/d9/unc_8c.html#a8">RedirDevName</a>, IN BOOLEAN <a class="el" href="../../d5/d9/unc_8c.html#a9">MailslotsSupported</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d9/unc_8c.html#a18">FsRtlDeregisterUncProvider</a> (IN HANDLE <a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a29">Handle</a>)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>WCHAR&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d9/unc_8c.html#a2">MupRegKey</a> [] = L"\\Registry\\Machine\\System\\CurrentControlSet\\Services\\Mup"</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>WCHAR&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d9/unc_8c.html#a3">UNCSymbolicLink</a> [] = L"\\DosDevices\\UNC"</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>WCHAR&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d9/unc_8c.html#a4">DevNull</a> [] = L"\\Device\\Null"</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>WCHAR&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d9/unc_8c.html#a5">DevMup</a> [] = DD_MUP_DEVICE_NAME</td></tr>

<tr><td class="memItemLeft" nowrap>struct {</td></tr>

<tr><td class="memItemLeft" nowrap>&nbsp;&nbsp;&nbsp;HANDLE&nbsp;&nbsp;&nbsp;<a class="el" href="../../d5/d9/unc_8c.html#a6">MupHandle</a></td></tr>

<tr><td class="memItemLeft" nowrap>&nbsp;&nbsp;&nbsp;HANDLE&nbsp;&nbsp;&nbsp;<a class="el" href="../../d5/d9/unc_8c.html#a7">ReturnedHandle</a></td></tr>

<tr><td class="memItemLeft" nowrap>&nbsp;&nbsp;&nbsp;UNICODE_STRING&nbsp;&nbsp;&nbsp;<a class="el" href="../../d5/d9/unc_8c.html#a8">RedirDevName</a></td></tr>

<tr><td class="memItemLeft" nowrap>&nbsp;&nbsp;&nbsp;BOOLEAN&nbsp;&nbsp;&nbsp;<a class="el" href="../../d5/d9/unc_8c.html#a9">MailslotsSupported</a></td></tr>

<tr><td class="memItemLeft" nowrap valign=top>}&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d9/unc_8c.html#a10">FsRtlpDRD</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d8/d7/struct__KSEMAPHORE.html">KSEMAPHORE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d9/unc_8c.html#a11">FsRtlpUncSemaphore</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d9/unc_8c.html#a12">FsRtlpRedirs</a> = 0</td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a1" doxytag="unc.c::DISABLE_DFS_VALUE_NAME" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define DISABLE_DFS_VALUE_NAME&nbsp;&nbsp;&nbsp;L"DisableDfs"          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d6/d8/unc_8c-source.html#l00487">FsRtlpIsDfsEnabled()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="unc.c::MODULE_POOL_TAG" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define MODULE_POOL_TAG&nbsp;&nbsp;&nbsp;('nuSF')          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d8/unc_8c-source.html#l00043">43</a> of file <a class="el" href="../../d6/d8/unc_8c-source.html">unc.c</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a18" doxytag="unc.c::FsRtlDeregisterUncProvider" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID FsRtlDeregisterUncProvider           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Handle</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d8/unc_8c-source.html#l00418">418</a> of file <a class="el" href="../../d6/d8/unc_8c-source.html">unc.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d9/unc_8c.html#a10">FsRtlpDRD</a>, <a class="el" href="../../d6/d8/unc_8c-source.html#l00099">FsRtlpRedirs</a>, <a class="el" href="../../d6/d8/unc_8c-source.html#l00231">FsRtlpSetSymbolicLink()</a>, <a class="el" href="../../d6/d8/unc_8c-source.html#l00094">FsRtlpUncSemaphore</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00091">Handle</a>, <a class="el" href="../../d2/d5/semphobj_8c-source.html#l00118">KeReleaseSemaphore()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
<pre class="fragment"><div>00424                    :
00425 
00426     This routine deregisters a redir as a UNC provider.
00427 
00428 Arguments:
00429 
00430     <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Multiple UNC router, returned by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00431         registration call.
00432 
00433 Return Value:
00434 
00435     None.
00436 
00437 --*/
00438 
00439 {
00440     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00441 
00442     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00443 
00444     <span class="keywordflow">if</span>( <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> == (HANDLE)-1 || <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> )
00445         <span class="keywordflow">return</span>;
00446 
00447     status = ZwClose( Handle );
00448 
00449     <span class="keywordflow">if</span>( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status ) ) {
00450         <span class="keywordflow">return</span>;
00451     }
00452 
00453     <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>(&amp;FsRtlpUncSemaphore, Executive, KernelMode, FALSE, NULL );
00454 
00455     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( FsRtlpRedirs &gt; 0 );
00456 
00457     <span class="keywordflow">if</span>( <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> == <a class="code" href="../../d5/d9/unc_8c.html#a10">FsRtlpDRD</a>.ReturnedHandle ) {
00458 
00459         <span class="comment">//</span>
00460         <span class="comment">// The first redir in the system is closing.  Release the state we saved</span>
00461         <span class="comment">//  for it, and pass the close on to the MUP if necessary</span>
00462         <span class="comment">//</span>
00463 
00464         <span class="keywordflow">if</span>( <a class="code" href="../../d5/d9/unc_8c.html#a10">FsRtlpDRD</a>.RedirDevName.Buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00465             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( <a class="code" href="../../d5/d9/unc_8c.html#a10">FsRtlpDRD</a>.RedirDevName.Buffer );
00466             <a class="code" href="../../d5/d9/unc_8c.html#a10">FsRtlpDRD</a>.RedirDevName.Buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00467         }
00468 
00469         <span class="keywordflow">if</span>( <a class="code" href="../../d5/d9/unc_8c.html#a10">FsRtlpDRD</a>.MupHandle != (HANDLE)-1 ) {
00470             ZwClose( <a class="code" href="../../d5/d9/unc_8c.html#a10">FsRtlpDRD</a>.MupHandle );
00471             <a class="code" href="../../d5/d9/unc_8c.html#a10">FsRtlpDRD</a>.MupHandle = (HANDLE)-1;
00472         }
00473 
00474         <a class="code" href="../../d5/d9/unc_8c.html#a10">FsRtlpDRD</a>.ReturnedHandle = (HANDLE)-1;
00475 
00476     }
00477 
00478     <span class="keywordflow">if</span>( --<a class="code" href="../../d5/d9/unc_8c.html#a12">FsRtlpRedirs</a> == 0 ) {
00479         <a class="code" href="../../d5/d9/unc_8c.html#a15">FsRtlpSetSymbolicLink</a>( (PUNICODE_STRING)NULL );
00480     }
00481 
00482     <a class="code" href="../../d1/d6/semphobj_8c.html#a3">KeReleaseSemaphore</a>(&amp;FsRtlpUncSemaphore, 0, 1, FALSE );
00483 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a16" doxytag="unc.c::FsRtlpIsDfsEnabled" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN FsRtlpIsDfsEnabled           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d8/unc_8c-source.html#l00487">487</a> of file <a class="el" href="../../d6/d8/unc_8c-source.html">unc.c</a>.
<p>
References <a class="el" href="../../d7/d1/rtqkey_8c-source.html#l00042">Buffer</a>, <a class="el" href="../../d5/d9/unc_8c.html#a1">DISABLE_DFS_VALUE_NAME</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d8/unc_8c-source.html#l00033">MupRegKey</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d6/d8/unc_8c-source.html#l00247">FsRtlRegisterUncProvider()</a>.
<p>
<pre class="fragment"><div>00491                    :
00492 
00493     This routine checks a registry key to see <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Dfs client <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> enabled.
00494     The client <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> assumed to be enabled by <span class="keywordflow">default</span>, and disabled <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> <span class="keywordflow">if</span> there
00495     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a registry value indicating that <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> should be disabled.
00496 
00497 Arguments:
00498 
00499     None
00500 
00501 Return Value:
00502 
00503     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> Dfs client <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> enabled, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise.
00504 
00505 --*/
00506 
00507 {
00508     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00509     HANDLE mupRegHandle;
00510     OBJECT_ATTRIBUTES objectAttributes;
00511     ULONG valueSize;
00512     BOOLEAN dfsEnabled = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00513 
00514     UNICODE_STRING mupRegKey = {
00515         <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d9/unc_8c.html#a2">MupRegKey</a>) - <span class="keyword">sizeof</span>(WCHAR),
00516         <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d9/unc_8c.html#a2">MupRegKey</a>),
00517         <a class="code" href="../../d5/d9/unc_8c.html#a2">MupRegKey</a>};
00518 
00519 <span class="preprocessor">#define DISABLE_DFS_VALUE_NAME  L"DisableDfs"</span>
00520 <span class="preprocessor"></span>
00521     UNICODE_STRING disableDfs = {
00522         <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d9/unc_8c.html#a1">DISABLE_DFS_VALUE_NAME</a>) - <span class="keyword">sizeof</span>(WCHAR),
00523         <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d9/unc_8c.html#a1">DISABLE_DFS_VALUE_NAME</a>),
00524         <a class="code" href="../../d5/d9/unc_8c.html#a1">DISABLE_DFS_VALUE_NAME</a>};
00525 
00526     <span class="keyword">struct </span>{
00527         KEY_VALUE_PARTIAL_INFORMATION Info;
00528         ULONG <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
00529     } disableDfsValue;
00530 
00531 
00532     InitializeObjectAttributes(
00533         &amp;objectAttributes,
00534         &amp;mupRegKey,
00535         OBJ_CASE_INSENSITIVE,
00536         0,
00537         NULL
00538         );
00539 
00540     status = ZwOpenKey(&amp;mupRegHandle, KEY_READ, &amp;objectAttributes);
00541 
00542     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00543 
00544         status = ZwQueryValueKey(
00545                     mupRegHandle,
00546                     &amp;disableDfs,
00547                     KeyValuePartialInformation,
00548                     (PVOID) &amp;disableDfsValue,
00549                     <span class="keyword">sizeof</span>(disableDfsValue),
00550                     &amp;valueSize);
00551 
00552         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) &amp;&amp; disableDfsValue.Info.Type == REG_DWORD) {
00553 
00554             <span class="keywordflow">if</span> ( (*((PULONG) disableDfsValue.Info.Data)) == 1 )
00555                 dfsEnabled = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00556 
00557         }
00558 
00559         ZwClose( mupRegHandle );
00560 
00561     }
00562 
00563     <span class="keywordflow">return</span>( dfsEnabled );
00564 
00565 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a14" doxytag="unc.c::FsRtlpOpenDev" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS FsRtlpOpenDev           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT PHANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>Handle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN LPWSTR&nbsp;</td>
          <td class="mdname" nowrap> <em>DevNameStr</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d8/unc_8c-source.html#l00183">183</a> of file <a class="el" href="../../d6/d8/unc_8c-source.html">unc.c</a>.
<p>
References <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00091">Handle</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, and <a class="el" href="../../d7/d8/restrfil_8c-source.html#l00418">ZwCreateFile()</a>.
<p>
Referenced by <a class="el" href="../../d6/d8/unc_8c-source.html#l00247">FsRtlRegisterUncProvider()</a>.
<p>
<pre class="fragment"><div>00187 {
00188     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00189     UNICODE_STRING DevName;
00190     OBJECT_ATTRIBUTES objectAttributes;
00191     IO_STATUS_BLOCK ioStatusBlock;
00192 
00193     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00194 
00195     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;DevName, DevNameStr );
00196 
00197     InitializeObjectAttributes(
00198         &amp;objectAttributes,
00199         &amp;DevName,
00200         0,
00201         0,
00202         NULL
00203         );
00204 
00205     status = <a class="code" href="../../d6/d9/restrfil_8c.html#a31">ZwCreateFile</a>(
00206                  Handle,
00207                  GENERIC_WRITE,
00208                  &amp;objectAttributes,
00209                  &amp;ioStatusBlock,
00210                  NULL,
00211                  FILE_ATTRIBUTE_NORMAL,
00212                  FILE_SHARE_READ | FILE_SHARE_WRITE,
00213                  FILE_OPEN,
00214                  0,
00215                  NULL,
00216                  0
00217                  );
00218 
00219     <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status ) ) {
00220         status = ioStatusBlock.Status;
00221     }
00222 
00223     <span class="keywordflow">if</span>( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status ) ) {
00224         *<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> = (HANDLE)-1;
00225     }
00226 
00227     <span class="keywordflow">return</span> status;
00228 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a13" doxytag="unc.c::FsRtlpRegisterProviderWithMUP" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS FsRtlpRegisterProviderWithMUP           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>mupHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>RedirDevName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>MailslotsSupported</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d8/unc_8c-source.html#l00104">104</a> of file <a class="el" href="../../d6/d8/unc_8c-source.html">unc.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d6/d8/unc_8c-source.html#l00088">MailslotsSupported</a>, <a class="el" href="../../d2/d2/dbcsname_8c-source.html#l00069">MODULE_POOL_TAG</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d9/d6/io_2fsctrl_8c-source.html#l00034">NtFsControlFile()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d2/d1/obwait_8c-source.html#l00282">NtWaitForSingleObject()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d6/d8/unc_8c-source.html#l00087">RedirDevName</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d6/d8/unc_8c-source.html#l00247">FsRtlRegisterUncProvider()</a>.
<p>
<pre class="fragment"><div>00111                    :
00112 
00113     This <span class="keyword">private</span> routine does <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> FSCTL to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> MUP to tell <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> about
00114         a <span class="keyword">new</span> redir
00115 
00116 Arguments:
00117 
00118     mupHandle - <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> MUP
00119 
00120     <a class="code" href="../../d5/d9/unc_8c.html#a8">RedirDevName</a> - The device name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> redir.
00121 
00122     <a class="code" href="../../d5/d9/unc_8c.html#a9">MailslotsSupported</a> - If <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, <span class="keyword">this</span> redir supports mailslots.
00123 
00124 Return Value:
00125 
00126     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - The status of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation.
00127 
00128 --*/
00129 {
00130     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00131     IO_STATUS_BLOCK ioStatusBlock;
00132     ULONG paramLength;
00133     PREDIRECTOR_REGISTRATION params;
00134 
00135     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00136 
00137     paramLength = <span class="keyword">sizeof</span>( REDIRECTOR_REGISTRATION ) +
00138                       <a class="code" href="../../d5/d9/unc_8c.html#a8">RedirDevName</a>-&gt;Length;
00139 
00140     params = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( NonPagedPool, paramLength, MODULE_POOL_TAG );
00141     <span class="keywordflow">if</span>( params == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> )
00142         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00143 
00144     params-&gt;DeviceNameOffset = <span class="keyword">sizeof</span>( REDIRECTOR_REGISTRATION );
00145     params-&gt;DeviceNameLength = <a class="code" href="../../d5/d9/unc_8c.html#a8">RedirDevName</a>-&gt;Length;
00146     params-&gt;MailslotsSupported = <a class="code" href="../../d5/d9/unc_8c.html#a9">MailslotsSupported</a>;
00147 
00148     RtlMoveMemory(
00149         (PCHAR)params + params-&gt;DeviceNameOffset,
00150         <a class="code" href="../../d5/d9/unc_8c.html#a8">RedirDevName</a>-&gt;Buffer,
00151         <a class="code" href="../../d5/d9/unc_8c.html#a8">RedirDevName</a>-&gt;Length
00152         );
00153 
00154     status = <a class="code" href="../../d8/d7/io_2fsctrl_8c.html#a0">NtFsControlFile</a>(
00155                  mupHandle,
00156                  0,
00157                  NULL,
00158                  NULL,
00159                  &amp;ioStatusBlock,
00160                  FSCTL_MUP_REGISTER_UNC_PROVIDER,
00161                  params,
00162                  paramLength,
00163                  NULL,
00164                  0
00165                  );
00166 
00167     <span class="keywordflow">if</span> ( status == STATUS_PENDING ) {
00168         status = <a class="code" href="../../d1/d2/obwait_8c.html#a4">NtWaitForSingleObject</a>( mupHandle, TRUE, NULL );
00169     }
00170 
00171     <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status ) ) {
00172         status = ioStatusBlock.Status;
00173     }
00174 
00175     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status ) );
00176 
00177     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( params );
00178 
00179     <span class="keywordflow">return</span> status;
00180 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a15" doxytag="unc.c::FsRtlpSetSymbolicLink" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID FsRtlpSetSymbolicLink           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PUNICODE_STRING DevName&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>OPTIONAL</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d8/unc_8c-source.html#l00231">231</a> of file <a class="el" href="../../d6/d8/unc_8c-source.html">unc.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l05675">IoCreateSymbolicLink()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l06227">IoDeleteSymbolicLink()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d6/d8/unc_8c-source.html#l00034">UNCSymbolicLink</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
Referenced by <a class="el" href="../../d6/d8/unc_8c-source.html#l00418">FsRtlDeregisterUncProvider()</a>, and <a class="el" href="../../d6/d8/unc_8c-source.html#l00247">FsRtlRegisterUncProvider()</a>.
<p>
<pre class="fragment"><div>00232 {
00233     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00234     UNICODE_STRING UncSymbolicName;
00235 
00236     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00237 
00238     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;UncSymbolicName, UNCSymbolicLink );
00239     (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>)<a class="code" href="../../d4/d6/iosubs_8c.html#a57">IoDeleteSymbolicLink</a>( &amp;UncSymbolicName );
00240     <span class="keywordflow">if</span>( ARGUMENT_PRESENT( DevName ) ) {
00241         status = <a class="code" href="../../d4/d6/iosubs_8c.html#a50">IoCreateSymbolicLink</a>( &amp;UncSymbolicName, DevName );
00242         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status ) );
00243     }
00244 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a17" doxytag="unc.c::FsRtlRegisterUncProvider" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS FsRtlRegisterUncProvider           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT PHANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>MupHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>RedirDevName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>MailslotsSupported</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d8/unc_8c-source.html#l00247">247</a> of file <a class="el" href="../../d6/d8/unc_8c-source.html">unc.c</a>.
<p>
References <a class="el" href="../../d6/d8/unc_8c-source.html#l00036">DevMup</a>, <a class="el" href="../../d6/d8/unc_8c-source.html#l00035">DevNull</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d9/unc_8c.html#a10">FsRtlpDRD</a>, <a class="el" href="../../d6/d8/unc_8c-source.html#l00487">FsRtlpIsDfsEnabled()</a>, <a class="el" href="../../d6/d8/unc_8c-source.html#l00183">FsRtlpOpenDev()</a>, <a class="el" href="../../d6/d8/unc_8c-source.html#l00099">FsRtlpRedirs</a>, <a class="el" href="../../d6/d8/unc_8c-source.html#l00104">FsRtlpRegisterProviderWithMUP()</a>, <a class="el" href="../../d6/d8/unc_8c-source.html#l00231">FsRtlpSetSymbolicLink()</a>, <a class="el" href="../../d6/d8/unc_8c-source.html#l00094">FsRtlpUncSemaphore</a>, <a class="el" href="../../d2/d5/semphobj_8c-source.html#l00118">KeReleaseSemaphore()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d6/d8/unc_8c-source.html#l00088">MailslotsSupported</a>, <a class="el" href="../../d2/d2/dbcsname_8c-source.html#l00069">MODULE_POOL_TAG</a>, <a class="el" href="../../d6/d8/unc_8c-source.html#l00085">MupHandle</a>, <a class="el" href="../../d6/d8/unc_8c-source.html#l00033">MupRegKey</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d6/d8/unc_8c-source.html#l00087">RedirDevName</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>, and <a class="el" href="../../d7/d7/fs__rec_8h.html#a37">ZwLoadDriver()</a>.
<p>
<pre class="fragment"><div>00254                    :
00255 
00256     This routine registers a redir as a UNC provider.
00257 
00258 Arguments:
00259 
00260     <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> - Pointer to a handle.  The handle <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> routine
00261         to be used when calling <a class="code" href="../../d5/d9/unc_8c.html#a18">FsRtlDeregisterUncProvider</a>.
00262         It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> valid <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a24">routines</a> returns STATUS_SUCCESS.
00263 
00264     <a class="code" href="../../d5/d9/unc_8c.html#a8">RedirDevName</a> - The device name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> redir.
00265 
00266     <a class="code" href="../../d5/d9/unc_8c.html#a9">MailslotsSupported</a> - If <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, <span class="keyword">this</span> redir supports mailslots.
00267 
00268 Return Value:
00269 
00270     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - The status of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation.
00271 
00272 --*/
00273 {
00274     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00275     HANDLE mupHandle = (HANDLE)-1;
00276     UNICODE_STRING mupDriverName;
00277     BOOLEAN dfsEnabled;
00278 
00279     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00280 
00281     <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>(&amp;FsRtlpUncSemaphore, Executive, KernelMode, FALSE, NULL );
00282 
00283     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d9/unc_8c.html#a12">FsRtlpRedirs</a> == 0) {
00284 
00285         dfsEnabled = <a class="code" href="../../d5/d9/unc_8c.html#a16">FsRtlpIsDfsEnabled</a>();
00286 
00287         <span class="keywordflow">if</span> (dfsEnabled) {
00288             <a class="code" href="../../d5/d9/unc_8c.html#a12">FsRtlpRedirs</a> = 1;
00289             RtlZeroMemory((PVOID) &amp;FsRtlpDRD, <span class="keyword">sizeof</span>(FsRtlpDRD));
00290         }
00291 
00292     }
00293 
00294     <span class="keywordflow">switch</span>( <a class="code" href="../../d5/d9/unc_8c.html#a12">FsRtlpRedirs</a> ) {
00295     <span class="keywordflow">case</span> 0:
00296         <span class="comment">//</span>
00297         <span class="comment">// Ok, the MUP isn't there and we don't need to use the</span>
00298         <span class="comment">//   MUP for the first redir.</span>
00299         <span class="comment">//</span>
00300         <span class="comment">// We need to return a handle, but we're not really using the MUP yet.</span>
00301         <span class="comment">//   And we may never use it (if there's only 1 redir).  Return</span>
00302         <span class="comment">//   a handle to the NULL device object, since we're committed to returning</span>
00303         <span class="comment">//   a handle to our caller.  Our caller isn't supposed to do anything with</span>
00304         <span class="comment">//   the handle except to call FsRtlDeregisterUncProvider() with it.</span>
00305         <span class="comment">//</span>
00306         status = <a class="code" href="../../d5/d9/unc_8c.html#a14">FsRtlpOpenDev</a>( &amp;mupHandle, DevNull );
00307 
00308         <span class="keywordflow">if</span>( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status ) )
00309             <span class="keywordflow">break</span>;
00310 
00311         <span class="comment">//</span>
00312         <span class="comment">// Save up enough state to allow us to call the MUP later with</span>
00313         <span class="comment">// this registration info if necessary.</span>
00314         <span class="comment">//</span>
00315         <a class="code" href="../../d5/d9/unc_8c.html#a10">FsRtlpDRD</a>.RedirDevName.Buffer = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( NonPagedPool, 
00316                                                                <a class="code" href="../../d5/d9/unc_8c.html#a8">RedirDevName</a>-&gt;MaximumLength, 
00317                                                                MODULE_POOL_TAG );
00318 
00319         <span class="keywordflow">if</span>( <a class="code" href="../../d5/d9/unc_8c.html#a10">FsRtlpDRD</a>.RedirDevName.Buffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00320             status =  STATUS_INSUFFICIENT_RESOURCES;
00321             <span class="keywordflow">break</span>;
00322         }
00323 
00324         <a class="code" href="../../d5/d9/unc_8c.html#a10">FsRtlpDRD</a>.RedirDevName.Length = <a class="code" href="../../d5/d9/unc_8c.html#a8">RedirDevName</a>-&gt;Length;
00325         <a class="code" href="../../d5/d9/unc_8c.html#a10">FsRtlpDRD</a>.RedirDevName.MaximumLength = <a class="code" href="../../d5/d9/unc_8c.html#a8">RedirDevName</a>-&gt;MaximumLength;
00326 
00327         RtlMoveMemory(
00328                 (PCHAR)<a class="code" href="../../d5/d9/unc_8c.html#a10">FsRtlpDRD</a>.RedirDevName.Buffer,
00329                 <a class="code" href="../../d5/d9/unc_8c.html#a8">RedirDevName</a>-&gt;Buffer,
00330                 <a class="code" href="../../d5/d9/unc_8c.html#a8">RedirDevName</a>-&gt;MaximumLength
00331         );
00332 
00333         <a class="code" href="../../d5/d9/unc_8c.html#a10">FsRtlpDRD</a>.MailslotsSupported = <a class="code" href="../../d5/d9/unc_8c.html#a9">MailslotsSupported</a>;
00334         <a class="code" href="../../d5/d9/unc_8c.html#a10">FsRtlpDRD</a>.ReturnedHandle = mupHandle;
00335         <a class="code" href="../../d5/d9/unc_8c.html#a10">FsRtlpDRD</a>.MupHandle = (HANDLE)-1;
00336 
00337         <span class="comment">//</span>
00338         <span class="comment">// Set the UNC symbolic link to point to the redir we just loaded</span>
00339         <span class="comment">//</span>
00340         <a class="code" href="../../d5/d9/unc_8c.html#a15">FsRtlpSetSymbolicLink</a>( RedirDevName );
00341 
00342         <span class="keywordflow">break</span>;
00343 
00344     <span class="keywordflow">default</span>:
00345         <span class="comment">//</span>
00346         <span class="comment">// This is the second or later redir load -- MUST use the MUP</span>
00347         <span class="comment">//</span>
00348         status = <a class="code" href="../../d5/d9/unc_8c.html#a14">FsRtlpOpenDev</a>( &amp;mupHandle, DevMup );
00349 
00350         <span class="keywordflow">if</span>( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status ) ) {
00351 
00352             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;mupDriverName, MupRegKey );
00353 
00354             (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>)<a class="code" href="../../d7/d7/fs__rec_8h.html#a37">ZwLoadDriver</a>( &amp;mupDriverName );
00355 
00356             status = <a class="code" href="../../d5/d9/unc_8c.html#a14">FsRtlpOpenDev</a>( &amp;mupHandle, DevMup );
00357             <span class="keywordflow">if</span>( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status ) )
00358                 <span class="keywordflow">break</span>;
00359         }
00360 
00361         <span class="comment">//</span>
00362         <span class="comment">// See if we need to tell the MUP about the first redir that registered</span>
00363         <span class="comment">//</span>
00364         <span class="keywordflow">if</span>( <a class="code" href="../../d5/d9/unc_8c.html#a10">FsRtlpDRD</a>.RedirDevName.Buffer ) {
00365 
00366             status = <a class="code" href="../../d5/d9/unc_8c.html#a13">FsRtlpRegisterProviderWithMUP</a>( mupHandle,
00367                     &amp;<a class="code" href="../../d5/d9/unc_8c.html#a10">FsRtlpDRD</a>.RedirDevName,
00368                     <a class="code" href="../../d5/d9/unc_8c.html#a10">FsRtlpDRD</a>.MailslotsSupported );
00369 
00370             <span class="keywordflow">if</span>( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status ) )
00371                 <span class="keywordflow">break</span>;
00372 
00373             <a class="code" href="../../d5/d9/unc_8c.html#a10">FsRtlpDRD</a>.MupHandle = mupHandle;
00374 
00375             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( <a class="code" href="../../d5/d9/unc_8c.html#a10">FsRtlpDRD</a>.RedirDevName.Buffer );
00376             <a class="code" href="../../d5/d9/unc_8c.html#a10">FsRtlpDRD</a>.RedirDevName.Buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00377 
00378             <span class="comment">//</span>
00379             <span class="comment">// Set the UNC symbolic link to point to the MUP</span>
00380             <span class="comment">//</span>
00381             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(  &amp;mupDriverName, DevMup );
00382             <a class="code" href="../../d5/d9/unc_8c.html#a15">FsRtlpSetSymbolicLink</a>( &amp;mupDriverName );
00383 
00384             status = <a class="code" href="../../d5/d9/unc_8c.html#a14">FsRtlpOpenDev</a>( &amp;mupHandle, DevMup );
00385 
00386             <span class="keywordflow">if</span>( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status ) )
00387                 <span class="keywordflow">break</span>;
00388         }
00389 
00390         <span class="comment">//</span>
00391         <span class="comment">//  Pass the request to the MUP for this redir</span>
00392         <span class="comment">//</span>
00393         status = <a class="code" href="../../d5/d9/unc_8c.html#a13">FsRtlpRegisterProviderWithMUP</a>( mupHandle,
00394                         RedirDevName,
00395                         MailslotsSupported );
00396         <span class="keywordflow">break</span>;
00397 
00398     }
00399 
00400     <span class="keywordflow">if</span>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status ) ) {
00401         <a class="code" href="../../d5/d9/unc_8c.html#a12">FsRtlpRedirs</a>++;
00402         *<a class="code" href="../../d5/d9/unc_8c.html#a6">MupHandle</a> = mupHandle;
00403 
00404     } <span class="keywordflow">else</span> {
00405         <span class="keywordflow">if</span>( mupHandle != (HANDLE)-1 &amp;&amp; mupHandle != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00406             ZwClose( mupHandle );
00407         }
00408 
00409         *<a class="code" href="../../d5/d9/unc_8c.html#a6">MupHandle</a> = (HANDLE)-1;
00410     }
00411 
00412     <a class="code" href="../../d1/d6/semphobj_8c.html#a3">KeReleaseSemaphore</a>(&amp;FsRtlpUncSemaphore, 0, 1, FALSE );
00413     <span class="keywordflow">return</span> status;
00414 }

</div></pre>    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a5" doxytag="unc.c::DevMup" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> WCHAR <a class="el" href="../../d5/d9/unc_8c.html#a5">DevMup</a>[] = DD_MUP_DEVICE_NAME<code> [static]</code>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d8/unc_8c-source.html#l00036">36</a> of file <a class="el" href="../../d6/d8/unc_8c-source.html">unc.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d8/unc_8c-source.html#l00247">FsRtlRegisterUncProvider()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="unc.c::DevNull" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> WCHAR <a class="el" href="../../d5/d9/unc_8c.html#a4">DevNull</a>[] = L"\\Device\\Null"<code> [static]</code>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d8/unc_8c-source.html#l00035">35</a> of file <a class="el" href="../../d6/d8/unc_8c-source.html">unc.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d8/unc_8c-source.html#l00247">FsRtlRegisterUncProvider()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="unc.c::FsRtlpDRD" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> struct { ... }   <a class="el" href="../../d5/d9/unc_8c.html#a10">FsRtlpDRD</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d6/d8/unc_8c-source.html#l00418">FsRtlDeregisterUncProvider()</a>, and <a class="el" href="../../d6/d8/unc_8c-source.html#l00247">FsRtlRegisterUncProvider()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a12" doxytag="unc.c::FsRtlpRedirs" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d5/d9/unc_8c.html#a12">FsRtlpRedirs</a> = 0          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d8/unc_8c-source.html#l00099">99</a> of file <a class="el" href="../../d6/d8/unc_8c-source.html">unc.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d8/unc_8c-source.html#l00418">FsRtlDeregisterUncProvider()</a>, and <a class="el" href="../../d6/d8/unc_8c-source.html#l00247">FsRtlRegisterUncProvider()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="unc.c::FsRtlpUncSemaphore" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d8/d7/struct__KSEMAPHORE.html">KSEMAPHORE</a> <a class="el" href="../../d5/d9/unc_8c.html#a11">FsRtlpUncSemaphore</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d8/unc_8c-source.html#l00094">94</a> of file <a class="el" href="../../d6/d8/unc_8c-source.html">unc.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d8/unc_8c-source.html#l00418">FsRtlDeregisterUncProvider()</a>, <a class="el" href="../../d5/d7/fsrtlpc_8c-source.html#l00215">FsRtlInitSystem()</a>, and <a class="el" href="../../d6/d8/unc_8c-source.html#l00247">FsRtlRegisterUncProvider()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="unc.c::MailslotsSupported" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN <a class="el" href="../../d5/d9/unc_8c.html#a9">MailslotsSupported</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d8/unc_8c-source.html#l00088">88</a> of file <a class="el" href="../../d6/d8/unc_8c-source.html">unc.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d8/unc_8c-source.html#l00104">FsRtlpRegisterProviderWithMUP()</a>, and <a class="el" href="../../d6/d8/unc_8c-source.html#l00247">FsRtlRegisterUncProvider()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="unc.c::MupHandle" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> HANDLE <a class="el" href="../../d5/d9/unc_8c.html#a6">MupHandle</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d8/unc_8c-source.html#l00085">85</a> of file <a class="el" href="../../d6/d8/unc_8c-source.html">unc.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d8/unc_8c-source.html#l00247">FsRtlRegisterUncProvider()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="unc.c::MupRegKey" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> WCHAR <a class="el" href="../../d5/d9/unc_8c.html#a2">MupRegKey</a>[] = L"\\Registry\\Machine\\System\\CurrentControlSet\\Services\\Mup"<code> [static]</code>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d8/unc_8c-source.html#l00033">33</a> of file <a class="el" href="../../d6/d8/unc_8c-source.html">unc.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d8/unc_8c-source.html#l00487">FsRtlpIsDfsEnabled()</a>, and <a class="el" href="../../d6/d8/unc_8c-source.html#l00247">FsRtlRegisterUncProvider()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="unc.c::RedirDevName" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> UNICODE_STRING <a class="el" href="../../d5/d9/unc_8c.html#a8">RedirDevName</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d8/unc_8c-source.html#l00087">87</a> of file <a class="el" href="../../d6/d8/unc_8c-source.html">unc.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d8/unc_8c-source.html#l00104">FsRtlpRegisterProviderWithMUP()</a>, and <a class="el" href="../../d6/d8/unc_8c-source.html#l00247">FsRtlRegisterUncProvider()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="unc.c::ReturnedHandle" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> HANDLE <a class="el" href="../../d5/d9/unc_8c.html#a7">ReturnedHandle</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d8/unc_8c-source.html#l00086">86</a> of file <a class="el" href="../../d6/d8/unc_8c-source.html">unc.c</a>.
<p>
Referenced by <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l00091">IopCreateMadeupNode()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="unc.c::UNCSymbolicLink" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> WCHAR <a class="el" href="../../d5/d9/unc_8c.html#a3">UNCSymbolicLink</a>[] = L"\\DosDevices\\UNC"<code> [static]</code>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d8/unc_8c-source.html#l00034">34</a> of file <a class="el" href="../../d6/d8/unc_8c-source.html">unc.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d8/unc_8c-source.html#l00231">FsRtlpSetSymbolicLink()</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:45:52 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
