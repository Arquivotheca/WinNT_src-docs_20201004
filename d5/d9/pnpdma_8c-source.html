<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: pnpdma.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>pnpdma.c</h1><a href="../../d4/d0/pnpdma_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 
00002 <span class="comment">/*++</span>
00003 <span class="comment"></span>
00004 <span class="comment">Copyright (c) 1997  Microsoft Corporation</span>
00005 <span class="comment"></span>
00006 <span class="comment">Module Name:</span>
00007 <span class="comment"></span>
00008 <span class="comment">    pnpirq.c</span>
00009 <span class="comment"></span>
00010 <span class="comment">Abstract:</span>
00011 <span class="comment"></span>
00012 <span class="comment">    Root DMA arbiter</span>
00013 <span class="comment"></span>
00014 <span class="comment">Author:</span>
00015 <span class="comment"></span>
00016 <span class="comment">    Andy Thornton (andrewth) 04/17/97</span>
00017 <span class="comment"></span>
00018 <span class="comment">Revision History:</span>
00019 <span class="comment"></span>
00020 <span class="comment">--*/</span>
00021 
00022 <span class="preprocessor">#include "<a class="code" href="../../d0/d6/iop_8h.html">iop.h</a>"</span>
00023 <span class="preprocessor">#pragma hdrstop</span>
00024 <span class="preprocessor"></span>
00025 <span class="comment">//</span>
00026 <span class="comment">// Constants</span>
00027 <span class="comment">//</span>
00028 
00029 
<a name="l00030"></a><a class="code" href="../../d4/d0/pnpdma_8c.html#a0">00030</a> <span class="preprocessor">#define MAX_ULONGLONG           ((ULONGLONG) -1)</span>
00031 <span class="preprocessor"></span>
00032 <span class="comment">//</span>
00033 <span class="comment">// Prototypes</span>
00034 <span class="comment">//</span>
00035 
00036 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00037 <a class="code" href="../../d9/d0/pnpiop_8h.html#a368">IopDmaInitialize</a>(
00038     VOID
00039     );
00040 
00041 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00042 <a class="code" href="../../d4/d0/pnpdma_8c.html#a2">IopDmaUnpackRequirement</a>(
00043     IN PIO_RESOURCE_DESCRIPTOR Descriptor,
00044     OUT PULONGLONG Minimum,
00045     OUT PULONGLONG Maximum,
00046     OUT PULONG Length,
00047     OUT PULONG Alignment
00048     );
00049 
00050 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00051 <a class="code" href="../../d4/d0/pnpdma_8c.html#a3">IopDmaPackResource</a>(
00052     IN PIO_RESOURCE_DESCRIPTOR Requirement,
00053     IN ULONGLONG Start,
00054     OUT PCM_PARTIAL_RESOURCE_DESCRIPTOR Descriptor
00055     );
00056 
00057 LONG
00058 <a class="code" href="../../d4/d0/pnpdma_8c.html#a4">IopDmaScoreRequirement</a>(
00059     IN PIO_RESOURCE_DESCRIPTOR Descriptor
00060     );
00061 
00062 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00063 <a class="code" href="../../d4/d0/pnpdma_8c.html#a5">IopDmaUnpackResource</a>(
00064     IN PCM_PARTIAL_RESOURCE_DESCRIPTOR Descriptor,
00065     OUT PULONGLONG Start,
00066     OUT PULONG Length
00067     );
00068 
00069 
00070 BOOLEAN
00071 <a class="code" href="../../d4/d0/pnpdma_8c.html#a6">IopDmaOverrideConflict</a>(
00072     IN <a class="code" href="../../d9/d8/arbiter_8h.html#a39">PARBITER_INSTANCE</a> Arbiter,
00073     IN <a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html">PARBITER_ALLOCATION_STATE</a> State
00074     );
00075 
00076 <span class="comment">//</span>
00077 <span class="comment">// Make everything pageable</span>
00078 <span class="comment">//</span>
00079 
00080 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00081 <span class="preprocessor"></span>
00082 <span class="preprocessor">#pragma alloc_text(PAGE, IopDmaInitialize)</span>
00083 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopDmaUnpackRequirement)</span>
00084 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopDmaPackResource)</span>
00085 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopDmaScoreRequirement)</span>
00086 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopDmaUnpackResource)</span>
00087 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopDmaOverrideConflict)</span>
00088 <span class="preprocessor"></span><span class="preprocessor">#endif // ALLOC_PRAGMA</span>
00089 <span class="preprocessor"></span>
00090 <span class="comment">//</span>
00091 <span class="comment">// Implementation</span>
00092 <span class="comment">//</span>
00093 
00094 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00095"></a><a class="code" href="../../d4/d0/pnpdma_8c.html#a1">00095</a> <a class="code" href="../../d9/d0/pnpiop_8h.html#a368">IopDmaInitialize</a>(
00096     VOID
00097     )
00098 
00099 <span class="comment">/*++</span>
00100 <span class="comment"></span>
00101 <span class="comment">Routine Description:</span>
00102 <span class="comment"></span>
00103 <span class="comment">    This routine initializes the arbiter</span>
00104 <span class="comment"></span>
00105 <span class="comment">Parameters:</span>
00106 <span class="comment"></span>
00107 <span class="comment">    None</span>
00108 <span class="comment">        </span>
00109 <span class="comment">Return Value:</span>
00110 <span class="comment"></span>
00111 <span class="comment">    None</span>
00112 <span class="comment"></span>
00113 <span class="comment">--*/</span>
00114 
00115 {
00116     
00117     <a class="code" href="../../d1/d0/pnpdata_8c.html#a32">IopRootDmaArbiter</a>.<a class="code" href="../../d8/d7/struct__ARBITER__INSTANCE.html#o12">UnpackRequirement</a> = <a class="code" href="../../d4/d0/pnpdma_8c.html#a2">IopDmaUnpackRequirement</a>;
00118     <a class="code" href="../../d1/d0/pnpdata_8c.html#a32">IopRootDmaArbiter</a>.<a class="code" href="../../d8/d7/struct__ARBITER__INSTANCE.html#o13">PackResource</a> = <a class="code" href="../../d4/d0/pnpdma_8c.html#a3">IopDmaPackResource</a>;
00119     <a class="code" href="../../d1/d0/pnpdata_8c.html#a32">IopRootDmaArbiter</a>.<a class="code" href="../../d8/d7/struct__ARBITER__INSTANCE.html#o14">UnpackResource</a> = <a class="code" href="../../d4/d0/pnpdma_8c.html#a5">IopDmaUnpackResource</a>;
00120     <a class="code" href="../../d1/d0/pnpdata_8c.html#a32">IopRootDmaArbiter</a>.<a class="code" href="../../d8/d7/struct__ARBITER__INSTANCE.html#o15">ScoreRequirement</a> = <a class="code" href="../../d4/d0/pnpdma_8c.html#a4">IopDmaScoreRequirement</a>;
00121     <a class="code" href="../../d1/d0/pnpdata_8c.html#a32">IopRootDmaArbiter</a>.<a class="code" href="../../d8/d7/struct__ARBITER__INSTANCE.html#o31">OverrideConflict</a> = <a class="code" href="../../d4/d0/pnpdma_8c.html#a6">IopDmaOverrideConflict</a>;
00122 
00123     <span class="keywordflow">return</span> <a class="code" href="../../d9/d8/arbiter_8h.html#a67">ArbInitializeArbiterInstance</a>(&amp;<a class="code" href="../../d1/d0/pnpdata_8c.html#a32">IopRootDmaArbiter</a>,
00124                                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00125                                         CmResourceTypeDma,
00126                                         <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"RootDMA"</span>,
00127                                         <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Root"</span>,
00128                                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>    <span class="comment">// no translation of DMA</span>
00129                                        );
00130 }
00131 
00132 <span class="comment">//</span>
00133 <span class="comment">// Arbiter callbacks</span>
00134 <span class="comment">//</span>
00135 
00136 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00137"></a><a class="code" href="../../d4/d0/pnpdma_8c.html#a2">00137</a> <a class="code" href="../../d4/d0/pnpdma_8c.html#a2">IopDmaUnpackRequirement</a>(
00138     IN PIO_RESOURCE_DESCRIPTOR Descriptor,
00139     OUT PULONGLONG Minimum,
00140     OUT PULONGLONG Maximum,
00141     OUT PULONG Length,
00142     OUT PULONG Alignment
00143     )
00144 
00145 <span class="comment">/*++</span>
00146 <span class="comment"></span>
00147 <span class="comment">Routine Description:</span>
00148 <span class="comment"></span>
00149 <span class="comment">    This routine unpacks an resource requirement descriptor.</span>
00150 <span class="comment">    </span>
00151 <span class="comment">Arguments:</span>
00152 <span class="comment"></span>
00153 <span class="comment">    Descriptor - The descriptor describing the requirement to unpack.</span>
00154 <span class="comment">    </span>
00155 <span class="comment">    Minimum - Pointer to where the minimum acceptable start value should be </span>
00156 <span class="comment">        unpacked to.</span>
00157 <span class="comment">    </span>
00158 <span class="comment">    Maximum - Pointer to where the maximum acceptable end value should be </span>
00159 <span class="comment">        unpacked to.</span>
00160 <span class="comment">    </span>
00161 <span class="comment">    Length - Pointer to where the required length should be unpacked to.</span>
00162 <span class="comment">    </span>
00163 <span class="comment">    Minimum - Pointer to where the required alignment should be unpacked to.</span>
00164 <span class="comment"></span>
00165 <span class="comment">Return Value:</span>
00166 <span class="comment"></span>
00167 <span class="comment">    Returns the status of this operation.</span>
00168 <span class="comment"></span>
00169 <span class="comment">--*/</span>
00170 
00171 {
00172     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Descriptor);
00173     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Descriptor-&gt;Type == CmResourceTypeDma);
00174 
00175     <a class="code" href="../../d9/d8/arbiter_8h.html#a1">ARB_PRINT</a>(2,
00176                 (<span class="stringliteral">"Unpacking DMA requirement %p =&gt; 0x%I64x-0x%I64x\n"</span>,
00177                 Descriptor,
00178                 (ULONGLONG) Descriptor-&gt;u.Dma.MinimumChannel,
00179                 (ULONGLONG) Descriptor-&gt;u.Dma.MaximumChannel
00180                 ));
00181 
00182     *Minimum = (ULONGLONG) Descriptor-&gt;u.Dma.MinimumChannel;
00183     *Maximum = (ULONGLONG) Descriptor-&gt;u.Dma.MaximumChannel;
00184     *Length = 1;
00185     *Alignment = 1;
00186 
00187     <span class="keywordflow">return</span> STATUS_SUCCESS;
00188 
00189 }
00190 
00191 LONG
<a name="l00192"></a><a class="code" href="../../d4/d0/pnpdma_8c.html#a4">00192</a> <a class="code" href="../../d4/d0/pnpdma_8c.html#a4">IopDmaScoreRequirement</a>(
00193     IN PIO_RESOURCE_DESCRIPTOR Descriptor
00194     )
00195 
00196 <span class="comment">/*++</span>
00197 <span class="comment"></span>
00198 <span class="comment">Routine Description:</span>
00199 <span class="comment"></span>
00200 <span class="comment">    This routine scores a requirement based on how flexible it is.  The least</span>
00201 <span class="comment">    flexible devices are scored the least and so when the arbitration list is</span>
00202 <span class="comment">    sorted we try to allocate their resources first.</span>
00203 <span class="comment">    </span>
00204 <span class="comment">Arguments:</span>
00205 <span class="comment"></span>
00206 <span class="comment">    Descriptor - The descriptor describing the requirement to score.</span>
00207 <span class="comment">    </span>
00208 <span class="comment"></span>
00209 <span class="comment">Return Value:</span>
00210 <span class="comment"></span>
00211 <span class="comment">    The score.</span>
00212 <span class="comment"></span>
00213 <span class="comment">--*/</span>
00214 
00215 {
00216     LONG score;
00217     
00218     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Descriptor);
00219     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Descriptor-&gt;Type == CmResourceTypeDma);
00220     
00221     score = Descriptor-&gt;u.Dma.MaximumChannel - Descriptor-&gt;u.Dma.MinimumChannel;
00222     
00223     <a class="code" href="../../d9/d8/arbiter_8h.html#a1">ARB_PRINT</a>(2,
00224                 (<span class="stringliteral">"Scoring DMA resource %p =&gt; %i\n"</span>,
00225                 Descriptor,
00226                 score
00227                 ));
00228 
00229     <span class="keywordflow">return</span> score;
00230 }
00231 
00232 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00233"></a><a class="code" href="../../d4/d0/pnpdma_8c.html#a3">00233</a> <a class="code" href="../../d4/d0/pnpdma_8c.html#a3">IopDmaPackResource</a>(
00234     IN PIO_RESOURCE_DESCRIPTOR Requirement,
00235     IN ULONGLONG Start,
00236     OUT PCM_PARTIAL_RESOURCE_DESCRIPTOR Descriptor
00237     )
00238 
00239 <span class="comment">/*++</span>
00240 <span class="comment"></span>
00241 <span class="comment">Routine Description:</span>
00242 <span class="comment"></span>
00243 <span class="comment">    This routine packs an resource descriptor.</span>
00244 <span class="comment">    </span>
00245 <span class="comment">Arguments:</span>
00246 <span class="comment"></span>
00247 <span class="comment">    Requirement - The requirement from which this resource was chosen.</span>
00248 <span class="comment">    </span>
00249 <span class="comment">    Start - The start value of the resource.</span>
00250 <span class="comment">    </span>
00251 <span class="comment">    Descriptor - Pointer to the descriptor to pack into.</span>
00252 <span class="comment">    </span>
00253 <span class="comment">Return Value:</span>
00254 <span class="comment"></span>
00255 <span class="comment">    Returns the status of this operation.</span>
00256 <span class="comment"></span>
00257 <span class="comment">--*/</span>
00258 
00259 {
00260     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Descriptor);
00261     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a> &lt; ((ULONG)-1));
00262     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Requirement);
00263     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Requirement-&gt;Type == CmResourceTypeDma);
00264 
00265     <a class="code" href="../../d9/d8/arbiter_8h.html#a1">ARB_PRINT</a>(2,
00266                 (<span class="stringliteral">"Packing DMA resource %p =&gt; 0x%I64x\n"</span>,
00267                 Descriptor,
00268                 <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>
00269                 ));
00270     
00271     Descriptor-&gt;Type = CmResourceTypeDma;
00272     Descriptor-&gt;ShareDisposition = Requirement-&gt;ShareDisposition;
00273     Descriptor-&gt;Flags = Requirement-&gt;Flags; <span class="comment">// BUGBUG - is this correct?</span>
00274     Descriptor-&gt;u.Dma.Channel = (ULONG) <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>;
00275     Descriptor-&gt;u.Dma.Port = 0;
00276 
00277     <span class="keywordflow">return</span> STATUS_SUCCESS;
00278 }
00279 
00280 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00281"></a><a class="code" href="../../d4/d0/pnpdma_8c.html#a5">00281</a> <a class="code" href="../../d4/d0/pnpdma_8c.html#a5">IopDmaUnpackResource</a>(
00282     IN PCM_PARTIAL_RESOURCE_DESCRIPTOR Descriptor,
00283     OUT PULONGLONG Start,
00284     OUT PULONG Length
00285     )
00286 
00287 <span class="comment">/*++</span>
00288 <span class="comment"></span>
00289 <span class="comment">Routine Description:</span>
00290 <span class="comment"></span>
00291 <span class="comment">    This routine unpacks an resource descriptor.</span>
00292 <span class="comment">    </span>
00293 <span class="comment">Arguments:</span>
00294 <span class="comment"></span>
00295 <span class="comment">    Descriptor - The descriptor describing the resource to unpack.</span>
00296 <span class="comment">    </span>
00297 <span class="comment">    Start - Pointer to where the start value should be unpacked to.</span>
00298 <span class="comment">    </span>
00299 <span class="comment">    Length - Pointer to where the length value should be unpacked to.</span>
00300 <span class="comment">    </span>
00301 <span class="comment">Return Value:</span>
00302 <span class="comment"></span>
00303 <span class="comment">    Returns the status of this operation.</span>
00304 <span class="comment"></span>
00305 <span class="comment">--*/</span>
00306 
00307 {
00308 
00309     *<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a> = Descriptor-&gt;u.Dma.Channel;
00310     *Length = 1;
00311     
00312     <a class="code" href="../../d9/d8/arbiter_8h.html#a1">ARB_PRINT</a>(2,
00313                 (<span class="stringliteral">"Unpacking DMA resource %p =&gt; 0x%I64x\n"</span>,
00314                 Descriptor,
00315                 *<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>
00316                 ));
00317     
00318     <span class="keywordflow">return</span> STATUS_SUCCESS;
00319 
00320 }
00321 
00322 
00323 BOOLEAN
<a name="l00324"></a><a class="code" href="../../d4/d0/pnpdma_8c.html#a6">00324</a> <a class="code" href="../../d4/d0/pnpdma_8c.html#a6">IopDmaOverrideConflict</a>(
00325     IN PARBITER_INSTANCE Arbiter,
00326     IN <a class="code" href="../../d5/d7/struct__ARBITER__ALLOCATION__STATE.html">PARBITER_ALLOCATION_STATE</a> State
00327     )
00328 
00329 <span class="comment">/*++</span>
00330 <span class="comment"></span>
00331 <span class="comment">Routine Description:</span>
00332 <span class="comment"></span>
00333 <span class="comment">    Just say no.</span>
00334 <span class="comment"></span>
00335 <span class="comment">Arguments:</span>
00336 <span class="comment"></span>
00337 <span class="comment">    Arbiter - The instance data of the arbiter who was called.</span>
00338 <span class="comment"></span>
00339 <span class="comment">    State - The state of the current arbitration.</span>
00340 <span class="comment"></span>
00341 <span class="comment">Return Value:</span>
00342 <span class="comment"></span>
00343 <span class="comment">    TRUE if the conflict is allowable, false otherwise</span>
00344 <span class="comment"></span>
00345 <span class="comment">--*/</span>
00346 
00347 {
00348     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00349     
00350     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00351 }
00352 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:16 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
