<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: misc.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>misc.c</h1><a href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    misc.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">        This file implements the NT console server font routines.</span>
00012 <span class="comment"></span>
00013 <span class="comment">Author:</span>
00014 <span class="comment"></span>
00015 <span class="comment">    Therese Stowell (thereses) 22-Jan-1991</span>
00016 <span class="comment"></span>
00017 <span class="comment">Revision History:</span>
00018 <span class="comment"></span>
00019 <span class="comment">--*/</span>
00020 
00021 <span class="preprocessor">#include "<a class="code" href="../../d6/d3/w32_2ntcon_2server_2precomp_8h.html">precomp.h</a>"</span>
00022 <span class="preprocessor">#pragma hdrstop</span>
00023 <span class="preprocessor"></span>
00024 <span class="preprocessor">#ifdef DEBUG_PRINT</span>
00025 <span class="preprocessor"></span>ULONG gDebugFlag;
00026 <span class="comment">//ULONG gDebugFlag = _DBGOUTPUT | _DBGCHARS | _DBGFONTS | _DBGFONTS2 ;</span>
00027 <span class="preprocessor">#endif</span>
00028 <span class="preprocessor"></span>
<a name="l00029"></a><a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a5">00029</a> ULONG <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a5">NumberOfMouseButtons</a>;
00030 
<a name="l00031"></a><a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a6">00031</a> <a class="code" href="../../d5/d9/struct__FONT__INFO.html">PFONT_INFO</a> <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a1">FontInfo</a>;
<a name="l00032"></a><a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a7">00032</a> ULONG <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a7">FontInfoLength</a>;
<a name="l00033"></a><a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a8">00033</a> ULONG <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a27">NumberOfFonts</a>;
00034 
<a name="l00035"></a><a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a9">00035</a> WCHAR <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a9">DefaultFaceName</a>[LF_FACESIZE];
<a name="l00036"></a><a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a10">00036</a> COORD <a class="code" href="../../d0/d3/dbcs_8h.html#a14">DefaultFontSize</a>;
<a name="l00037"></a><a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a11">00037</a> <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>  <a class="code" href="../../d0/d3/dbcs_8h.html#a15">DefaultFontFamily</a>;
<a name="l00038"></a><a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a12">00038</a> ULONG <a class="code" href="../../d0/d3/dbcs_8h.html#a13">DefaultFontIndex</a> = 0;
00039 
<a name="l00040"></a><a class="code" href="../../d8/d9/struct__FONTENUMDC.html">00040</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d8/d9/struct__FONTENUMDC.html">_FONTENUMDC</a> {
<a name="l00041"></a><a class="code" href="../../d8/d9/struct__FONTENUMDC.html#o0">00041</a>     HDC <a class="code" href="../../d8/d9/struct__FONTENUMDC.html#o0">hDC</a>;
<a name="l00042"></a><a class="code" href="../../d8/d9/struct__FONTENUMDC.html#o1">00042</a>     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d8/d9/struct__FONTENUMDC.html#o1">bFindFaces</a>;
<a name="l00043"></a><a class="code" href="../../d8/d9/struct__FONTENUMDC.html#o2">00043</a>     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> <a class="code" href="../../d8/d9/struct__FONTENUMDC.html#o2">TTPointSize</a>;
<a name="l00044"></a><a class="code" href="../../d8/d9/struct__FONTENUMDC.html#o3">00044</a>     ULONG <a class="code" href="../../d8/d9/struct__FONTENUMDC.html#o3">ulFE</a>;
00045 } <a class="code" href="../../d8/d9/struct__FONTENUMDC.html">FONTENUMDC</a>, *<a class="code" href="../../d8/d9/struct__FONTENUMDC.html">PFONTENUMDC</a>;
00046 
00047 <span class="comment">/*</span>
00048 <span class="comment"> * Custom CP for glyph translations</span>
00049 <span class="comment"> */</span>
<a name="l00050"></a><a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a15">00050</a> CPTABLEINFO <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a15">GlyphCP</a>;
<a name="l00051"></a><a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a16">00051</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a16">GlyphTable</a>[256];
00052 
00053 
<a name="l00054"></a><a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a0">00054</a> <span class="preprocessor">#define FONT_BUFFER_SIZE 12</span>
00055 <span class="preprocessor"></span>
<a name="l00056"></a><a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a1">00056</a> <span class="preprocessor">#define FE_ABANDONFONT 1</span>
<a name="l00057"></a><a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a2">00057</a> <span class="preprocessor"></span><span class="preprocessor">#define FE_FONTOK      2</span>
00058 <span class="preprocessor"></span>
00059 <span class="comment">/*</span>
00060 <span class="comment"> * Initial default fonts and face names</span>
00061 <span class="comment"> */</span>
<a name="l00062"></a><a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a17">00062</a> <a class="code" href="../../d9/d4/structtagFACENODE.html">PFACENODE</a> <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a17">gpFaceNames</a>;
00063 
00064 
00065 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00066"></a><a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a18">00066</a> <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a18">GetMouseButtons</a>(
00067     PULONG NumButtons
00068     )
00069 {
00070     *NumButtons = <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a5">NumberOfMouseButtons</a>;
00071     <span class="keywordflow">return</span> STATUS_SUCCESS;
00072 }
00073 
00074 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00075"></a><a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a19">00075</a> <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a19">InitializeMouseButtons</a>( VOID )
00076 {
00077     <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a5">NumberOfMouseButtons</a> = <a class="code" href="../../d3/d9/client_2wow_8c.html#a16">GetSystemMetrics</a>(SM_CMOUSEBUTTONS);
00078 }
00079 
<a name="l00080"></a><a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a20">00080</a> <a class="code" href="../../d9/d4/structtagFACENODE.html">PFACENODE</a> <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a20">AddFaceNode</a>(<a class="code" href="../../d9/d4/structtagFACENODE.html">PFACENODE</a> *ppStart, LPWSTR pwsz) {
00081     <a class="code" href="../../d9/d4/structtagFACENODE.html">PFACENODE</a> pNew;
00082     <a class="code" href="../../d9/d4/structtagFACENODE.html">PFACENODE</a> *ppTmp;
00083     <span class="keywordtype">int</span> cb;
00084 
00085     <span class="comment">/*</span>
00086 <span class="comment">     * Is it already here?</span>
00087 <span class="comment">     */</span>
00088     <span class="keywordflow">for</span> (ppTmp = ppStart; *ppTmp; ppTmp = &amp;((*ppTmp)-&gt;pNext)) {
00089         <span class="keywordflow">if</span> (wcscmp(((*ppTmp)-&gt;awch), pwsz) == 0) {
00090             <span class="comment">// already there !</span>
00091             <span class="keywordflow">return</span> *ppTmp;
00092         }
00093     }
00094 
00095     cb = (wcslen(pwsz) + 1) * <span class="keyword">sizeof</span>(WCHAR);
00096     pNew = (<a class="code" href="../../d9/d4/structtagFACENODE.html">PFACENODE</a>)<a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( <a class="code" href="../../d8/d5/consrv_8h.html#a19">FONT_TAG</a> ),<span class="keyword">sizeof</span>(<a class="code" href="../../d9/d4/structtagFACENODE.html">FACENODE</a>) + cb);
00097     <span class="keywordflow">if</span> (pNew == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00098         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00099     }
00100 
00101     pNew-&gt;<a class="code" href="../../d9/d4/structtagFACENODE.html#o0">pNext</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00102     pNew-&gt;<a class="code" href="../../d9/d4/structtagFACENODE.html#o1">dwFlag</a> = 0;
00103     wcscpy(pNew-&gt;<a class="code" href="../../d9/d4/structtagFACENODE.html#o2">awch</a>, pwsz);
00104     *ppTmp = pNew;
00105     <span class="keywordflow">return</span> pNew;
00106 }
00107 
00108 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00109"></a><a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a21">00109</a> <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a21">InitializeFonts</a>( VOID )
00110 {
00111     WCHAR FontName[<a class="code" href="../../d8/d5/consrv_8h.html#a6">CONSOLE_MAX_FONT_NAME_LENGTH</a>];
00112     <span class="keywordtype">int</span> i;
00113     <span class="keyword">static</span> CONST LPWSTR FontList[] = {<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"woafont"</span>,
00114                                       <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"ega80woa.fon"</span>,
00115                                       <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"ega40woa.fon"</span>,
00116                                       <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"cga80woa.fon"</span>,
00117                                       <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"cga40woa.fon"</span>};
00118 
00119     <span class="comment">//</span>
00120     <span class="comment">// Read software.ini to get the values for "woafont",</span>
00121     <span class="comment">// "ega80woa.fon", "ega40woa.fon", "cga80woa.fon", and</span>
00122     <span class="comment">// "cga40woa.fon", respectively, to pass to AddFontResource.</span>
00123     <span class="comment">//</span>
00124     <span class="comment">// If any of the entries are empty or non-existent,</span>
00125     <span class="comment">// GetPrivateProfileString will return a NULL (empty) string.</span>
00126     <span class="comment">// If such is the case, the call to AddPermanentFontResource will</span>
00127     <span class="comment">// simply fail.</span>
00128     <span class="comment">//</span>
00129 
00130     OpenProfileUserMapping();
00131 
00132     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d2/d3/tnlsxlat_8c.html#a0">NELEM</a>(FontList); i++) {
00133         GetPrivateProfileString(<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"386enh"</span>, FontList[i], <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">""</span>,
00134                 FontName, <a class="code" href="../../d2/d3/tnlsxlat_8c.html#a0">NELEM</a>(FontName), <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"system.ini"</span>);
00135         GdiAddFontResourceW(FontName, AFRW_ADD_LOCAL_FONT,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00136     }
00137 
00138     CloseProfileUserMapping();
00139 }
00140 
00141 <span class="comment">/*</span>
00142 <span class="comment"> * Returns bit combination</span>
00143 <span class="comment"> *  FE_ABANDONFONT  - do not continue enumerating this font</span>
00144 <span class="comment"> *  FE_FONTOK       - font was created and added to cache or already there</span>
00145 <span class="comment"> */</span>
00146 
00147 <span class="comment">/*</span>
00148 <span class="comment"></span>
00149 <span class="comment"></span>
00150 <span class="comment">*/</span>
00151 <span class="keywordtype">int</span> CALLBACK
<a name="l00152"></a><a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a22">00152</a> <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a22">FontEnum</a>(
00153     LPENUMLOGFONTW lpLogFont,
00154     LPNEWTEXTMETRICW lpTextMetric,
00155     <span class="keywordtype">int</span> nFontType,
00156     LPARAM lParam
00157     )
00158 
00159 <span class="comment">/*++</span>
00160 <span class="comment"></span>
00161 <span class="comment">    Is called exactly once by GDI for each font in the system.  This</span>
00162 <span class="comment">    routine is used to store the FONT_INFO structure.</span>
00163 <span class="comment"></span>
00164 <span class="comment">--*/</span>
00165 
00166 {
00167     <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a14">PFONTENUMDC</a> pfed = (<a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a14">PFONTENUMDC</a>)lParam;
00168     HDC hDC = pfed-&gt;<a class="code" href="../../d8/d9/struct__FONTENUMDC.html#o0">hDC</a>;
00169     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> bFindFaces = pfed-&gt;<a class="code" href="../../d8/d9/struct__FONTENUMDC.html#o1">bFindFaces</a>;
00170     HFONT hFont;
00171     TEXTMETRICW tmi;
00172     LONG nFont;
00173     LONG nFontNew;
00174     COORD SizeToShow;
00175     COORD SizeActual;
00176     COORD SizeWant;
00177     <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> tmFamily;
00178     SIZE <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
00179     LPWSTR pwszFace = lpLogFont-&gt;elfLogFont.lfFaceName;
00180     <a class="code" href="../../d9/d4/structtagFACENODE.html">PFACENODE</a> pFN;
00181 
00182     <a class="code" href="../../d8/d5/consrv_8h.html#a0">DBGFONTS</a>((<span class="stringliteral">"  FontEnum \"%ls\" (%d,%d) weight 0x%lx(%d) -- %s\n"</span>,
00183             pwszFace,
00184             lpLogFont-&gt;elfLogFont.lfWidth, lpLogFont-&gt;elfLogFont.lfHeight,
00185             lpLogFont-&gt;elfLogFont.lfWeight, lpLogFont-&gt;elfLogFont.lfWeight,
00186             bFindFaces ? <span class="stringliteral">"Finding Faces"</span> : <span class="stringliteral">"Creating Fonts"</span>));
00187 
00188     <span class="comment">//</span>
00189     <span class="comment">// reject variable width and italic fonts, also tt fonts with neg ac</span>
00190     <span class="comment">//</span>
00191 
00192     <span class="keywordflow">if</span>
00193     (
00194       !(lpLogFont-&gt;elfLogFont.lfPitchAndFamily &amp; FIXED_PITCH) ||
00195       (lpLogFont-&gt;elfLogFont.lfItalic)                        ||
00196       !(lpTextMetric-&gt;ntmFlags &amp; NTM_NONNEGATIVE_AC)
00197     )
00198     {
00199         <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d3/dbcs_8h.html#a48">IsAvailableTTFont</a>(pwszFace))
00200         {
00201             <a class="code" href="../../d8/d5/consrv_8h.html#a0">DBGFONTS</a>((<span class="stringliteral">"    REJECT  face (variable pitch, italic, or neg a&amp;c)\n"</span>));
00202             <span class="keywordflow">return</span> bFindFaces ? <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> : <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;  <span class="comment">// unsuitable font</span>
00203         }
00204     }
00205 
00206     <span class="keywordflow">if</span> (nFontType == TRUETYPE_FONTTYPE) {
00207         lpLogFont-&gt;elfLogFont.lfHeight = pfed-&gt;<a class="code" href="../../d8/d9/struct__FONTENUMDC.html#o2">TTPointSize</a>;
00208         lpLogFont-&gt;elfLogFont.lfWidth  = 0;
00209         lpLogFont-&gt;elfLogFont.lfWeight = FW_NORMAL;
00210     }
00211 
00212     <span class="comment">/*</span>
00213 <span class="comment">     * reject TT fonts for whoom family is not modern, that is do not use</span>
00214 <span class="comment">     * FF_DONTCARE    // may be surprised unpleasantly</span>
00215 <span class="comment">     * FF_DECORATIVE  // likely to be symbol fonts</span>
00216 <span class="comment">     * FF_SCRIPT      // cursive, inappropriate for console</span>
00217 <span class="comment">     * FF_SWISS OR FF_ROMAN // variable pitch</span>
00218 <span class="comment">     */</span>
00219 
00220     <span class="keywordflow">if</span> ((nFontType == TRUETYPE_FONTTYPE) &amp;&amp;
00221             ((lpLogFont-&gt;elfLogFont.lfPitchAndFamily &amp; 0xf0) != FF_MODERN)) {
00222         <a class="code" href="../../d8/d5/consrv_8h.html#a0">DBGFONTS</a>((<span class="stringliteral">"    REJECT  face (TT but not FF_MODERN)\n"</span>));
00223         <span class="keywordflow">return</span> bFindFaces ? <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> : <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;  <span class="comment">// unsuitable font</span>
00224     }
00225 
00226     <span class="comment">/*</span>
00227 <span class="comment">     * reject non-TT fonts that aren't OEM</span>
00228 <span class="comment">     */</span>
00229     <span class="keywordflow">if</span> ((nFontType != TRUETYPE_FONTTYPE) &amp;&amp;
00230 <span class="preprocessor">#if defined(FE_SB)</span>
00231 <span class="preprocessor"></span>            (!<a class="code" href="../../d8/d5/consrv_8h.html#a32">CONSOLE_IS_DBCS_ENABLED</a>() ||
00232             !IS_ANY_DBCS_CHARSET(lpLogFont-&gt;elfLogFont.lfCharSet)) &amp;&amp;
00233 <span class="preprocessor">#endif</span>
00234 <span class="preprocessor"></span>            (lpLogFont-&gt;elfLogFont.lfCharSet != OEM_CHARSET)) {
00235         <a class="code" href="../../d8/d5/consrv_8h.html#a0">DBGFONTS</a>((<span class="stringliteral">"    REJECT  face (not TT nor OEM)\n"</span>));
00236         <span class="keywordflow">return</span> bFindFaces ? <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> : <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;  <span class="comment">// unsuitable font</span>
00237     }
00238 
00239     <span class="comment">/*</span>
00240 <span class="comment">     * reject non-TT fonts that are virtical font</span>
00241 <span class="comment">     */</span>
00242     <span class="keywordflow">if</span> ((nFontType != TRUETYPE_FONTTYPE) &amp;&amp;
00243             (pwszFace[0] == <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'@'</span>)) {
00244         <a class="code" href="../../d8/d5/consrv_8h.html#a0">DBGFONTS</a>((<span class="stringliteral">"    REJECT  face (not TT and TATEGAKI)\n"</span>));
00245         <span class="keywordflow">return</span> bFindFaces ? <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> : <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;  <span class="comment">// unsuitable font</span>
00246     }
00247 
00248     <span class="comment">/*</span>
00249 <span class="comment">     * reject non-TT fonts that aren't Terminal</span>
00250 <span class="comment">     */</span>
00251     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/consrv_8h.html#a32">CONSOLE_IS_DBCS_ENABLED</a>() &amp;&amp;
00252         (nFontType != TRUETYPE_FONTTYPE) &amp;&amp;
00253             (wcscmp(pwszFace, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Terminal"</span>) != 0)) {
00254         <a class="code" href="../../d8/d5/consrv_8h.html#a0">DBGFONTS</a>((<span class="stringliteral">"    REJECT  face (not TT nor Terminal)\n"</span>));
00255         <span class="keywordflow">return</span> bFindFaces ? <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> : <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;  <span class="comment">// unsuitable font</span>
00256     }
00257 
00258     <span class="comment">/*</span>
00259 <span class="comment">     * reject Far East TT fonts that aren't Far East charset.</span>
00260 <span class="comment">     */</span>
00261     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d3/dbcs_8h.html#a48">IsAvailableTTFont</a>(pwszFace) &amp;&amp;
00262         !IS_ANY_DBCS_CHARSET(lpLogFont-&gt;elfLogFont.lfCharSet) &amp;&amp;
00263         !<a class="code" href="../../d0/d3/dbcs_8h.html#a49">IsAvailableTTFontCP</a>(pwszFace,0)
00264        ) {
00265         <a class="code" href="../../d8/d5/consrv_8h.html#a0">DBGFONTS</a>((<span class="stringliteral">"    REJECT  face (Far East TT and not Far East charset)\n"</span>));
00266         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;    <span class="comment">// should be enumerate next charset.</span>
00267     }
00268 
00269     <span class="comment">/*</span>
00270 <span class="comment">     * Add or find the facename</span>
00271 <span class="comment">     */</span>
00272     pFN = <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a20">AddFaceNode</a>(&amp;<a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a17">gpFaceNames</a>, pwszFace);
00273     <span class="keywordflow">if</span> (pFN == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00274         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00275     }
00276 
00277     <span class="keywordflow">if</span> (bFindFaces) {
00278         <span class="keywordflow">if</span> (nFontType == TRUETYPE_FONTTYPE) {
00279             <a class="code" href="../../d8/d5/consrv_8h.html#a0">DBGFONTS</a>((<span class="stringliteral">"NEW TT FACE %ls\n"</span>, pwszFace));
00280             pFN-&gt;<a class="code" href="../../d9/d4/structtagFACENODE.html#o1">dwFlag</a> |= <a class="code" href="../../d8/d5/consrv_8h.html#a54">EF_TTFONT</a>;
00281         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (nFontType == RASTER_FONTTYPE) {
00282             <a class="code" href="../../d8/d5/consrv_8h.html#a0">DBGFONTS</a>((<span class="stringliteral">"NEW OEM FACE %ls\n"</span>,pwszFace));
00283             pFN-&gt;<a class="code" href="../../d9/d4/structtagFACENODE.html#o1">dwFlag</a> |= <a class="code" href="../../d8/d5/consrv_8h.html#a53">EF_OEMFONT</a>;
00284         }
00285         <span class="keywordflow">return</span> 0;
00286     }
00287 
00288 
00289     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d6/font_8h.html#a3">IS_BOLD</a>(lpLogFont-&gt;elfLogFont.lfWeight)) {
00290         <a class="code" href="../../d8/d5/consrv_8h.html#a1">DBGFONTS2</a>((<span class="stringliteral">"    A bold font (weight %d)\n"</span>, lpLogFont-&gt;elfLogFont.lfWeight));
00291         <span class="comment">// return 0;</span>
00292     }
00293 
00294     <span class="comment">/* get font info */</span>
00295     SizeWant.Y = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)lpLogFont-&gt;elfLogFont.lfHeight;
00296     SizeWant.X = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)lpLogFont-&gt;elfLogFont.lfWidth;
00297 CreateBoldFont:
00298     lpLogFont-&gt;elfLogFont.lfQuality = NONANTIALIASED_QUALITY;
00299     hFont = CreateFontIndirectW(&amp;lpLogFont-&gt;elfLogFont);
00300     <span class="keywordflow">if</span> (!hFont) {
00301         <a class="code" href="../../d8/d5/consrv_8h.html#a0">DBGFONTS</a>((<span class="stringliteral">"    REJECT  font (can't create)\n"</span>));
00302         RIPMSG0(RIP_WARNING, <span class="stringliteral">"FontEnum: CreateFontIndirectW returned NULL hFont."</span>);
00303         <span class="keywordflow">return</span> 0;  <span class="comment">// same font in other sizes may still be suitable</span>
00304     }
00305 
00306     <a class="code" href="../../d8/d5/consrv_8h.html#a1">DBGFONTS2</a>((<span class="stringliteral">"    hFont = %lx\n"</span>, hFont));
00307 
00308     <span class="comment">//</span>
00309     <span class="comment">// for reasons unbeknownst to me, removing this code causes GDI</span>
00310     <span class="comment">// to yack, claiming that the font is owned by another process.</span>
00311     <span class="comment">//</span>
00312 
00313     SelectObject(hDC,hFont);
00314     <span class="keywordflow">if</span> (!GetTextMetricsW(hDC, &amp;tmi)) {
00315         tmi = *((LPTEXTMETRICW)lpTextMetric);
00316     }
00317 
00318     <span class="keywordflow">if</span> (GetTextExtentPoint32W(hDC, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"0"</span>, 1, &amp;<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>)) {
00319         SizeActual.X = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>.cx;
00320     } <span class="keywordflow">else</span> {
00321         SizeActual.X = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(tmi.tmMaxCharWidth);
00322     }
00323     SizeActual.Y = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(tmi.tmHeight + tmi.tmExternalLeading);
00324     <a class="code" href="../../d8/d5/consrv_8h.html#a1">DBGFONTS2</a>((<span class="stringliteral">"    actual size %d,%d\n"</span>, SizeActual.X, SizeActual.Y));
00325     tmFamily = tmi.tmPitchAndFamily;
00326     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d6/font_8h.html#a2">TM_IS_TT_FONT</a>(tmFamily) &amp;&amp; (SizeWant.Y &gt;= 0)) {
00327         SizeToShow = SizeWant;
00328         <span class="keywordflow">if</span> (SizeWant.X == 0) {
00329             <span class="comment">// Asking for zero width height gets a default aspect-ratio width</span>
00330             <span class="comment">// It's better to show that width rather than 0.</span>
00331             SizeToShow.X = SizeActual.X;
00332         }
00333     } <span class="keywordflow">else</span> {
00334         SizeToShow = SizeActual;
00335     }
00336     <a class="code" href="../../d8/d5/consrv_8h.html#a1">DBGFONTS2</a>((<span class="stringliteral">"    SizeToShow = (%d,%d), SizeActual = (%d,%d)\n"</span>,
00337             SizeToShow.X, SizeToShow.Y, SizeActual.X, SizeActual.Y));
00338 
00339     <span class="comment">// there's a GDI bug - this assert fails occasionally</span>
00340     <span class="comment">//ASSERT (tmi.tmw.tmMaxCharWidth == lpTextMetric-&gt;tmMaxCharWidth);</span>
00341 
00342     <span class="comment">/*</span>
00343 <span class="comment">     * NOW, determine whether this font entry has already been cached</span>
00344 <span class="comment">     * LATER : it may be possible to do this before creating the font, if</span>
00345 <span class="comment">     * we can trust the dimensions &amp; other info from lpTextMetric.</span>
00346 <span class="comment">     * Sort by size:</span>
00347 <span class="comment">     *  1) By pixelheight (negative Y values)</span>
00348 <span class="comment">     *  2) By height (as shown)</span>
00349 <span class="comment">     *  3) By width (as shown)</span>
00350 <span class="comment">     */</span>
00351     <span class="keywordflow">for</span> (nFont = 0; nFont &lt; (LONG)<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a27">NumberOfFonts</a>; ++nFont) {
00352         COORD SizeShown;
00353 
00354         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a1">FontInfo</a>[nFont].<a class="code" href="../../d5/d9/struct__FONT__INFO.html#o0">hFont</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00355             <a class="code" href="../../d8/d5/consrv_8h.html#a0">DBGFONTS</a>((<span class="stringliteral">"!   Font %x has a NULL hFont\n"</span>, nFont));
00356             <span class="keywordflow">continue</span>;
00357         }
00358 
00359 
00360         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a1">FontInfo</a>[nFont].<a class="code" href="../../d5/d9/struct__FONT__INFO.html#o2">SizeWant</a>.X &gt; 0) {
00361             SizeShown.X = <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a1">FontInfo</a>[nFont].<a class="code" href="../../d5/d9/struct__FONT__INFO.html#o2">SizeWant</a>.X;
00362         } <span class="keywordflow">else</span> {
00363             SizeShown.X = <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a1">FontInfo</a>[nFont].<a class="code" href="../../d5/d9/struct__FONT__INFO.html#o1">Size</a>.X;
00364         }
00365 
00366         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a1">FontInfo</a>[nFont].<a class="code" href="../../d5/d9/struct__FONT__INFO.html#o2">SizeWant</a>.Y &gt; 0) {
00367             <span class="comment">// This is a font specified by cell height.</span>
00368             SizeShown.Y = <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a1">FontInfo</a>[nFont].<a class="code" href="../../d5/d9/struct__FONT__INFO.html#o2">SizeWant</a>.Y;
00369         } <span class="keywordflow">else</span> {
00370             SizeShown.Y = <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a1">FontInfo</a>[nFont].<a class="code" href="../../d5/d9/struct__FONT__INFO.html#o1">Size</a>.Y;
00371             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a1">FontInfo</a>[nFont].<a class="code" href="../../d5/d9/struct__FONT__INFO.html#o2">SizeWant</a>.Y &lt; 0) {
00372                 <span class="comment">// This is a TT font specified by character height.</span>
00373                 <span class="keywordflow">if</span> (SizeWant.Y &lt; 0 &amp;&amp; SizeWant.Y &gt; <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a1">FontInfo</a>[nFont].<a class="code" href="../../d5/d9/struct__FONT__INFO.html#o2">SizeWant</a>.Y) {
00374                     <span class="comment">// Requested pixelheight is smaller than this one.</span>
00375                     <a class="code" href="../../d8/d5/consrv_8h.html#a0">DBGFONTS</a>((<span class="stringliteral">"INSERT %d pt at %x, before %d pt\n"</span>,
00376                             -SizeWant.Y, nFont, -<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a1">FontInfo</a>[nFont].<a class="code" href="../../d5/d9/struct__FONT__INFO.html#o2">SizeWant</a>.Y));
00377                     nFontNew = nFont;
00378                     <span class="keywordflow">goto</span> InsertNewFont;
00379                 }
00380             }
00381         }
00382 
00383         <span class="comment">// DBGFONTS(("    SizeShown(%x) = (%d,%d)\n",nFont,SizeShown.X,SizeShown.Y));</span>
00384 
00385         <span class="keywordflow">if</span> (<a class="code" href="../../d7/d6/font_8h.html#a4">SIZE_EQUAL</a>(SizeShown, SizeToShow) &amp;&amp;
00386                 <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a1">FontInfo</a>[nFont].<a class="code" href="../../d5/d9/struct__FONT__INFO.html#o5">Family</a> == tmFamily &amp;&amp;
00387                 <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a1">FontInfo</a>[nFont].<a class="code" href="../../d5/d9/struct__FONT__INFO.html#o3">Weight</a> == tmi.tmWeight &amp;&amp;
00388                 wcscmp(<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a1">FontInfo</a>[nFont].FaceName, pwszFace) == 0) {
00389             <span class="comment">/*</span>
00390 <span class="comment">             * Already have this font</span>
00391 <span class="comment">             */</span>
00392             <a class="code" href="../../d8/d5/consrv_8h.html#a1">DBGFONTS2</a>((<span class="stringliteral">"    Already have the font\n"</span>));
00393             DeleteObject(hFont);
00394             pfed-&gt;<a class="code" href="../../d8/d9/struct__FONTENUMDC.html#o3">ulFE</a> |= <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a2">FE_FONTOK</a>;
00395             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00396         }
00397 
00398 
00399         <span class="keywordflow">if</span> ((SizeToShow.Y &lt; SizeShown.Y) ||
00400                 (SizeToShow.Y == SizeShown.Y &amp;&amp; SizeToShow.X &lt; SizeShown.X)) {
00401             <span class="comment">/*</span>
00402 <span class="comment">             * This new font is smaller than nFont</span>
00403 <span class="comment">             */</span>
00404             <a class="code" href="../../d8/d5/consrv_8h.html#a0">DBGFONTS</a>((<span class="stringliteral">"INSERT at %x, SizeToShow = (%d,%d)\n"</span>, nFont,
00405                     SizeToShow.X,SizeToShow.Y));
00406             nFontNew = nFont;
00407             <span class="keywordflow">goto</span> InsertNewFont;
00408         }
00409     }
00410 
00411     <span class="comment">/*</span>
00412 <span class="comment">     * The font we are adding should be appended to the list,</span>
00413 <span class="comment">     * since it is bigger (or equal) to the last one.</span>
00414 <span class="comment">     */</span>
00415     nFontNew = (LONG)<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a27">NumberOfFonts</a>;
00416 
00417 InsertNewFont: <span class="comment">// at nFontNew</span>
00418 
00419 <span class="comment">//  ASSERT ((lpTextMetric-&gt;tmPitchAndFamily &amp; 1) == 0);</span>
00420     <span class="comment">/* If we have to grow our font table, do it */</span>
00421 
00422     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a27">NumberOfFonts</a> == <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a7">FontInfoLength</a>) {
00423         <a class="code" href="../../d5/d9/struct__FONT__INFO.html">PFONT_INFO</a> Temp;
00424 
00425         <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a7">FontInfoLength</a> += <a class="code" href="../../d7/d6/font_8h.html#a1">FONT_INCREMENT</a>;
00426         Temp = (<a class="code" href="../../d5/d9/struct__FONT__INFO.html">PFONT_INFO</a>)<a class="code" href="../../d8/d5/consrv_8h.html#a37">ConsoleHeapReAlloc</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( <a class="code" href="../../d8/d5/consrv_8h.html#a19">FONT_TAG</a> ),<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a1">FontInfo</a>,<span class="keyword">sizeof</span>(<a class="code" href="../../d5/d9/struct__FONT__INFO.html">FONT_INFO</a>) * <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a7">FontInfoLength</a>);
00427         <span class="keywordflow">if</span> (Temp == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00428             RIPMSG0(RIP_WARNING, <span class="stringliteral">"FontEnum: failed to allocate PFONT_INFO"</span>);
00429             <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a7">FontInfoLength</a> -= <a class="code" href="../../d7/d6/font_8h.html#a1">FONT_INCREMENT</a>;
00430             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00431         }
00432         <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a1">FontInfo</a> = Temp;
00433     }
00434 
00435     <span class="keywordflow">if</span> (nFontNew &lt; (LONG)<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a27">NumberOfFonts</a>) {
00436         RtlMoveMemory(&amp;<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a1">FontInfo</a>[nFontNew+1],
00437                 &amp;<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a1">FontInfo</a>[nFontNew],
00438                 <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d9/struct__FONT__INFO.html">FONT_INFO</a>)*(<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a27">NumberOfFonts</a> - nFontNew));
00439         <span class="comment">//</span>
00440         <span class="comment">// Fix up DefaultFontIndex if nFontNew less than DefaultFontIndex.</span>
00441         <span class="comment">//</span>
00442         <span class="keywordflow">if</span> (nFontNew &lt; (LONG)<a class="code" href="../../d0/d3/dbcs_8h.html#a13">DefaultFontIndex</a> &amp;&amp;
00443             <a class="code" href="../../d0/d3/dbcs_8h.html#a13">DefaultFontIndex</a>+1 &lt; <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a27">NumberOfFonts</a>) {
00444             <a class="code" href="../../d0/d3/dbcs_8h.html#a13">DefaultFontIndex</a>++;
00445         }
00446     }
00447 
00448     <span class="comment">/*</span>
00449 <span class="comment">     * Store the font info</span>
00450 <span class="comment">     */</span>
00451     <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a1">FontInfo</a>[nFontNew].<a class="code" href="../../d5/d9/struct__FONT__INFO.html#o0">hFont</a> = hFont;
00452     <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a1">FontInfo</a>[nFontNew].<a class="code" href="../../d5/d9/struct__FONT__INFO.html#o5">Family</a> = tmFamily;
00453     <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a1">FontInfo</a>[nFontNew].<a class="code" href="../../d5/d9/struct__FONT__INFO.html#o1">Size</a> = SizeActual;
00454     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d6/font_8h.html#a2">TM_IS_TT_FONT</a>(tmFamily)) {
00455         <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a1">FontInfo</a>[nFontNew].<a class="code" href="../../d5/d9/struct__FONT__INFO.html#o2">SizeWant</a> = SizeWant;
00456     } <span class="keywordflow">else</span> {
00457         <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a1">FontInfo</a>[nFontNew].<a class="code" href="../../d5/d9/struct__FONT__INFO.html#o2">SizeWant</a>.X = 0;
00458         <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a1">FontInfo</a>[nFontNew].<a class="code" href="../../d5/d9/struct__FONT__INFO.html#o2">SizeWant</a>.Y = 0;
00459     }
00460     <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a1">FontInfo</a>[nFontNew].<a class="code" href="../../d5/d9/struct__FONT__INFO.html#o3">Weight</a> = tmi.tmWeight;
00461     <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a1">FontInfo</a>[nFont].<a class="code" href="../../d5/d9/struct__FONT__INFO.html#o4">FaceName</a> = pFN-&gt;<a class="code" href="../../d9/d4/structtagFACENODE.html#o2">awch</a>;
00462 <span class="preprocessor">#if defined(FE_SB)</span>
00463 <span class="preprocessor"></span>    <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a1">FontInfo</a>[nFontNew].tmCharSet = tmi.tmCharSet;
00464 <span class="preprocessor">#endif</span>
00465 <span class="preprocessor"></span>
00466     ++<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a27">NumberOfFonts</a>;
00467 
00468     <span class="keywordflow">if</span> (nFontType == TRUETYPE_FONTTYPE &amp;&amp; !<a class="code" href="../../d7/d6/font_8h.html#a3">IS_BOLD</a>(<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a1">FontInfo</a>[nFontNew].Weight)) {
00469           lpLogFont-&gt;elfLogFont.lfWeight = FW_BOLD;
00470           <span class="keywordflow">goto</span> CreateBoldFont;
00471     }
00472 
00473     pfed-&gt;<a class="code" href="../../d8/d9/struct__FONTENUMDC.html#o3">ulFE</a> |= <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a2">FE_FONTOK</a>;  <span class="comment">// and continue enumeration</span>
00474     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00475 }
00476 
00477 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
<a name="l00478"></a><a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a23">00478</a> <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a23">DoFontEnum</a>(
00479     HDC hDC,
00480     LPWSTR pwszFace,
00481     SHORT TTPointSize)
00482 {
00483     ULONG ulFE = 0;
00484     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> bDeleteDC = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00485     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> bFindFaces = (pwszFace == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00486     <a class="code" href="../../d8/d9/struct__FONTENUMDC.html">FONTENUMDC</a> fed;
00487     LOGFONTW LogFont;
00488 
00489     <a class="code" href="../../d8/d5/consrv_8h.html#a0">DBGFONTS</a>((<span class="stringliteral">"DoFontEnum \"%ls\"\n"</span>, pwszFace));
00490     <span class="keywordflow">if</span> (hDC == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00491         hDC = CreateDCW(<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"DISPLAY"</span>,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00492         bDeleteDC = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00493     }
00494 
00495     fed.<a class="code" href="../../d8/d9/struct__FONTENUMDC.html#o0">hDC</a> = hDC;
00496     fed.<a class="code" href="../../d8/d9/struct__FONTENUMDC.html#o1">bFindFaces</a> = bFindFaces;
00497     fed.<a class="code" href="../../d8/d9/struct__FONTENUMDC.html#o3">ulFE</a> = 0;
00498     fed.<a class="code" href="../../d8/d9/struct__FONTENUMDC.html#o2">TTPointSize</a> = TTPointSize;
00499     RtlZeroMemory(&amp;LogFont, <span class="keyword">sizeof</span>(LOGFONT));
00500     LogFont.lfCharSet = DEFAULT_CHARSET;
00501     <span class="keywordflow">if</span> (pwszFace)
00502         wcscpy(LogFont.lfFaceName, pwszFace);
00503     <span class="comment">/*</span>
00504 <span class="comment">     * EnumFontFamiliesEx function enumerates one font in every face in every character set.</span>
00505 <span class="comment">     */</span>
00506     EnumFontFamiliesExW(hDC, &amp;LogFont, (FONTENUMPROC)<a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a22">FontEnum</a>, (LPARAM)&amp;fed, 0);
00507     <span class="keywordflow">if</span> (bDeleteDC) {
00508         DeleteDC(hDC);
00509     }
00510     <span class="keywordflow">return</span> (fed.ulFE &amp; <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a2">FE_FONTOK</a>) != 0;
00511 }
00512 
00513 
00514 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00515"></a><a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a24">00515</a> <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a24">EnumerateFonts</a>(
00516     DWORD Flags)
00517 {
00518     TEXTMETRIC tmi;
00519     HDC hDC;
00520     <a class="code" href="../../d9/d4/structtagFACENODE.html">PFACENODE</a> pFN;
00521     ULONG ulOldEnumFilter;
00522     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> FontIndex;
00523     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwFontType = 0;
00524 
00525     <a class="code" href="../../d8/d5/consrv_8h.html#a0">DBGFONTS</a>((<span class="stringliteral">"EnumerateFonts %lx\n"</span>, Flags));
00526 
00527     dwFontType = (<a class="code" href="../../d8/d5/consrv_8h.html#a54">EF_TTFONT</a>|<a class="code" href="../../d8/d5/consrv_8h.html#a53">EF_OEMFONT</a>|<a class="code" href="../../d8/d5/consrv_8h.html#a55">EF_DEFFACE</a>) &amp; Flags;
00528 
00529     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a1">FontInfo</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00530         <span class="comment">//</span>
00531         <span class="comment">// allocate memory for the font array</span>
00532         <span class="comment">//</span>
00533         <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a27">NumberOfFonts</a> = 0;
00534 
00535         <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a1">FontInfo</a> = (<a class="code" href="../../d5/d9/struct__FONT__INFO.html">PFONT_INFO</a>)<a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( <a class="code" href="../../d8/d5/consrv_8h.html#a19">FONT_TAG</a> ),<span class="keyword">sizeof</span>(<a class="code" href="../../d5/d9/struct__FONT__INFO.html">FONT_INFO</a>) * <a class="code" href="../../d7/d6/font_8h.html#a0">INITIAL_FONTS</a>);
00536         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a1">FontInfo</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00537             <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00538         <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a7">FontInfoLength</a> = <a class="code" href="../../d7/d6/font_8h.html#a0">INITIAL_FONTS</a>;
00539     }
00540 
00541     hDC = CreateDCW(<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"DISPLAY"</span>,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00542 
00543     <span class="comment">// Before enumeration, turn off font enumeration filters.</span>
00544     ulOldEnumFilter = SetFontEnumeration(0);
00545     <span class="comment">// restore all the other flags</span>
00546     SetFontEnumeration(ulOldEnumFilter &amp; ~FE_FILTER_TRUETYPE);
00547 
00548     <span class="keywordflow">if</span> (Flags &amp; <a class="code" href="../../d8/d5/consrv_8h.html#a55">EF_DEFFACE</a>) {
00549         SelectObject(hDC,GetStockObject(OEM_FIXED_FONT));
00550 
00551         <span class="keywordflow">if</span> (GetTextMetricsW(hDC, &amp;tmi)) {
00552             <a class="code" href="../../d0/d3/dbcs_8h.html#a14">DefaultFontSize</a>.X = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(tmi.tmMaxCharWidth);
00553             <a class="code" href="../../d0/d3/dbcs_8h.html#a14">DefaultFontSize</a>.Y = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(tmi.tmHeight+tmi.tmExternalLeading);
00554             <a class="code" href="../../d0/d3/dbcs_8h.html#a15">DefaultFontFamily</a> = tmi.tmPitchAndFamily;
00555 <span class="preprocessor">#if defined(FE_SB)</span>
00556 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (IS_ANY_DBCS_CHARSET(tmi.tmCharSet))
00557                 <a class="code" href="../../d0/d3/dbcs_8h.html#a14">DefaultFontSize</a>.X /= 2;
00558 <span class="preprocessor">#endif</span>
00559 <span class="preprocessor"></span>        }
00560         GetTextFaceW(hDC, LF_FACESIZE, <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a9">DefaultFaceName</a>);
00561 <span class="preprocessor">#if defined(FE_SB)</span>
00562 <span class="preprocessor"></span>        <a class="code" href="../../d8/d5/consrv_8h.html#a0">DBGFONTS</a>((<span class="stringliteral">"Default (OEM) Font %ls (%d,%d) CharSet 0x%02X\n"</span>, <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a9">DefaultFaceName</a>,
00563                 <a class="code" href="../../d0/d3/dbcs_8h.html#a14">DefaultFontSize</a>.X, <a class="code" href="../../d0/d3/dbcs_8h.html#a14">DefaultFontSize</a>.Y,
00564                 tmi.tmCharSet));
00565 <span class="preprocessor">#else</span>
00566 <span class="preprocessor"></span>        <a class="code" href="../../d8/d5/consrv_8h.html#a0">DBGFONTS</a>((<span class="stringliteral">"Default (OEM) Font %ls (%d,%d)\n"</span>, <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a9">DefaultFaceName</a>,
00567                 <a class="code" href="../../d0/d3/dbcs_8h.html#a14">DefaultFontSize</a>.X, <a class="code" href="../../d0/d3/dbcs_8h.html#a14">DefaultFontSize</a>.Y));
00568 <span class="preprocessor">#endif</span>
00569 <span class="preprocessor"></span>
00570         <span class="comment">// Make sure we are going to enumerate the OEM face.</span>
00571         pFN = <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a20">AddFaceNode</a>(&amp;<a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a17">gpFaceNames</a>, <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a9">DefaultFaceName</a>);
00572         pFN-&gt;<a class="code" href="../../d9/d4/structtagFACENODE.html#o1">dwFlag</a> |= <a class="code" href="../../d8/d5/consrv_8h.html#a55">EF_DEFFACE</a> | <a class="code" href="../../d8/d5/consrv_8h.html#a53">EF_OEMFONT</a>;
00573     }
00574 
00575     <span class="comment">// Use DoFontEnum to get all fonts from the system.  Our FontEnum</span>
00576     <span class="comment">// proc puts just the ones we want into an array</span>
00577     <span class="comment">//</span>
00578     <span class="keywordflow">for</span> (pFN = <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a17">gpFaceNames</a>; pFN; pFN = pFN-&gt;<a class="code" href="../../d9/d4/structtagFACENODE.html#o0">pNext</a>) {
00579         <a class="code" href="../../d8/d5/consrv_8h.html#a0">DBGFONTS</a>((<span class="stringliteral">"\"%ls\" is %s%s%s%s%s%s\n"</span>, pFN-&gt;<a class="code" href="../../d9/d4/structtagFACENODE.html#o2">awch</a>,
00580             pFN-&gt;<a class="code" href="../../d9/d4/structtagFACENODE.html#o1">dwFlag</a> &amp; <a class="code" href="../../d8/d5/consrv_8h.html#a50">EF_NEW</a>        ? <span class="stringliteral">"NEW "</span>        : <span class="stringliteral">" "</span>,
00581             pFN-&gt;<a class="code" href="../../d9/d4/structtagFACENODE.html#o1">dwFlag</a> &amp; <a class="code" href="../../d8/d5/consrv_8h.html#a51">EF_OLD</a>        ? <span class="stringliteral">"OLD "</span>        : <span class="stringliteral">" "</span>,
00582             pFN-&gt;<a class="code" href="../../d9/d4/structtagFACENODE.html#o1">dwFlag</a> &amp; <a class="code" href="../../d8/d5/consrv_8h.html#a52">EF_ENUMERATED</a> ? <span class="stringliteral">"ENUMERATED "</span> : <span class="stringliteral">" "</span>,
00583             pFN-&gt;<a class="code" href="../../d9/d4/structtagFACENODE.html#o1">dwFlag</a> &amp; <a class="code" href="../../d8/d5/consrv_8h.html#a53">EF_OEMFONT</a>    ? <span class="stringliteral">"OEMFONT "</span>    : <span class="stringliteral">" "</span>,
00584             pFN-&gt;<a class="code" href="../../d9/d4/structtagFACENODE.html#o1">dwFlag</a> &amp; <a class="code" href="../../d8/d5/consrv_8h.html#a54">EF_TTFONT</a>     ? <span class="stringliteral">"TTFONT "</span>     : <span class="stringliteral">" "</span>,
00585             pFN-&gt;<a class="code" href="../../d9/d4/structtagFACENODE.html#o1">dwFlag</a> &amp; <a class="code" href="../../d8/d5/consrv_8h.html#a55">EF_DEFFACE</a>    ? <span class="stringliteral">"DEFFACE "</span>    : <span class="stringliteral">" "</span>));
00586 
00587         <span class="keywordflow">if</span> ((pFN-&gt;<a class="code" href="../../d9/d4/structtagFACENODE.html#o1">dwFlag</a> &amp; dwFontType) == 0) {
00588             <span class="comment">// not the kind of face we want</span>
00589             <span class="keywordflow">continue</span>;
00590         }
00591         <span class="keywordflow">if</span> (pFN-&gt;<a class="code" href="../../d9/d4/structtagFACENODE.html#o1">dwFlag</a> &amp; <a class="code" href="../../d8/d5/consrv_8h.html#a52">EF_ENUMERATED</a>) {
00592             <span class="comment">// we already enumerated this face</span>
00593             <span class="keywordflow">continue</span>;
00594         }
00595 
00596         <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a23">DoFontEnum</a>(hDC, pFN-&gt;<a class="code" href="../../d9/d4/structtagFACENODE.html#o2">awch</a>, <a class="code" href="../../d0/d3/dbcs_8h.html#a14">DefaultFontSize</a>.Y);
00597         pFN-&gt;<a class="code" href="../../d9/d4/structtagFACENODE.html#o1">dwFlag</a> |= <a class="code" href="../../d8/d5/consrv_8h.html#a52">EF_ENUMERATED</a>;
00598     }
00599 
00600 
00601     <span class="comment">// After enumerating fonts, restore the font enumeration filter.</span>
00602     SetFontEnumeration(ulOldEnumFilter);
00603 
00604     DeleteDC(hDC);
00605 
00606     <span class="comment">// Make sure the default font is set correctly</span>
00607     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a27">NumberOfFonts</a> &gt; 0 &amp;&amp; <a class="code" href="../../d0/d3/dbcs_8h.html#a14">DefaultFontSize</a>.X == 0 &amp;&amp; <a class="code" href="../../d0/d3/dbcs_8h.html#a14">DefaultFontSize</a>.Y == 0) {
00608         <a class="code" href="../../d0/d3/dbcs_8h.html#a14">DefaultFontSize</a>.X = <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a1">FontInfo</a>[0].<a class="code" href="../../d5/d9/struct__FONT__INFO.html#o1">Size</a>.X;
00609         <a class="code" href="../../d0/d3/dbcs_8h.html#a14">DefaultFontSize</a>.Y = <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a1">FontInfo</a>[0].<a class="code" href="../../d5/d9/struct__FONT__INFO.html#o1">Size</a>.Y;
00610         <a class="code" href="../../d0/d3/dbcs_8h.html#a15">DefaultFontFamily</a> = <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a1">FontInfo</a>[0].<a class="code" href="../../d5/d9/struct__FONT__INFO.html#o5">Family</a>;
00611     }
00612 
00613     <span class="keywordflow">for</span> (FontIndex = 0; FontIndex &lt; <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a27">NumberOfFonts</a>; FontIndex++) {
00614         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a1">FontInfo</a>[FontIndex].<a class="code" href="../../d5/d9/struct__FONT__INFO.html#o1">Size</a>.X == <a class="code" href="../../d0/d3/dbcs_8h.html#a14">DefaultFontSize</a>.X &amp;&amp;
00615             <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a1">FontInfo</a>[FontIndex].<a class="code" href="../../d5/d9/struct__FONT__INFO.html#o1">Size</a>.Y == <a class="code" href="../../d0/d3/dbcs_8h.html#a14">DefaultFontSize</a>.Y &amp;&amp;
00616             <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a1">FontInfo</a>[FontIndex].<a class="code" href="../../d5/d9/struct__FONT__INFO.html#o5">Family</a> == <a class="code" href="../../d0/d3/dbcs_8h.html#a15">DefaultFontFamily</a>) {
00617 <span class="preprocessor">#if defined(FE_SB)</span>
00618 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/consrv_8h.html#a32">CONSOLE_IS_DBCS_ENABLED</a>() &amp;&amp;
00619                 !IS_ANY_DBCS_CHARSET(<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a1">FontInfo</a>[FontIndex].tmCharSet))
00620             {
00621                 <span class="keywordflow">continue</span> ;
00622             }
00623 <span class="preprocessor">#endif</span>
00624 <span class="preprocessor"></span>            <span class="keywordflow">break</span>;
00625         }
00626     }
00627     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(FontIndex &lt; <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a27">NumberOfFonts</a>);
00628     <span class="keywordflow">if</span> (FontIndex &lt; <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a27">NumberOfFonts</a>) {
00629         <a class="code" href="../../d0/d3/dbcs_8h.html#a13">DefaultFontIndex</a> = FontIndex;
00630     } <span class="keywordflow">else</span> {
00631         <a class="code" href="../../d0/d3/dbcs_8h.html#a13">DefaultFontIndex</a> = 0;
00632     }
00633     <a class="code" href="../../d8/d5/consrv_8h.html#a0">DBGFONTS</a>((<span class="stringliteral">"EnumerateFonts : DefaultFontIndex = %ld\n"</span>, <a class="code" href="../../d0/d3/dbcs_8h.html#a13">DefaultFontIndex</a>));
00634 
00635     <span class="keywordflow">return</span> STATUS_SUCCESS;
00636 }
00637 
00638 
00639 <span class="comment">/*</span>
00640 <span class="comment"> * Get the font index for a new font</span>
00641 <span class="comment"> * If necessary, attempt to create the font.</span>
00642 <span class="comment"> * Always return a valid FontIndex (even if not correct)</span>
00643 <span class="comment"> * Family:   Find/Create a font with of this Family</span>
00644 <span class="comment"> *           0    - don't care</span>
00645 <span class="comment"> * pwszFace: Find/Create a font with this face name.</span>
00646 <span class="comment"> *           NULL or L""  - use DefaultFaceName</span>
00647 <span class="comment"> * Size:     Must match SizeWant or actual Size.</span>
00648 <span class="comment"> */</span>
00649 <span class="keywordtype">int</span>
<a name="l00650"></a><a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a25">00650</a> <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a25">FindCreateFont</a>(
00651     DWORD Family,
00652     LPWSTR pwszFace,
00653     COORD Size,
00654     LONG Weight,
00655     UINT CodePage)
00656 {
00657 <span class="preprocessor">#define NOT_CREATED_NOR_FOUND -1</span>
00658 <span class="preprocessor"></span><span class="preprocessor">#define CREATED_BUT_NOT_FOUND -2</span>
00659 <span class="preprocessor"></span>
00660     <span class="keywordtype">int</span> i;
00661     <span class="keywordtype">int</span> FontIndex = <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a3">NOT_CREATED_NOR_FOUND</a>;
00662     <span class="keywordtype">int</span> BestMatch = <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a3">NOT_CREATED_NOR_FOUND</a>;
00663     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> bFontOK;
00664     WCHAR AltFaceName[LF_FACESIZE];
00665     COORD AltFontSize;
00666     <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>  AltFontFamily;
00667     ULONG AltFontIndex = 0;
00668     LPWSTR pwszAltFace = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00669 
00670     <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> CharSet = <a class="code" href="../../d0/d3/dbcs_8h.html#a45">CodePageToCharSet</a>(CodePage);
00671 
00672     <a class="code" href="../../d8/d5/consrv_8h.html#a0">DBGFONTS</a>((<span class="stringliteral">"FindCreateFont Family=%x %ls (%d,%d) %d %d %x\n"</span>,
00673             Family, pwszFace, <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>.X, <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>.Y, Weight, CodePage, CharSet));
00674 
00675     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/consrv_8h.html#a32">CONSOLE_IS_DBCS_ENABLED</a>() &amp;&amp;
00676         !IS_ANY_DBCS_CHARSET(CharSet))
00677     {
00678         <a class="code" href="../../d0/d3/dbcs_8h.html#a43">MakeAltRasterFont</a>(CodePage, <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a1">FontInfo</a>[<a class="code" href="../../d0/d3/dbcs_8h.html#a13">DefaultFontIndex</a>].<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>,
00679                           &amp;AltFontSize, &amp;AltFontFamily, &amp;AltFontIndex, AltFaceName);
00680 
00681         <span class="keywordflow">if</span> (pwszFace == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || *pwszFace == <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>) {
00682             pwszFace = AltFaceName;
00683         }
00684         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>.Y == 0) {
00685             <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>.X = AltFontSize.X;
00686             <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>.Y = AltFontSize.Y;
00687         }
00688     }
00689     <span class="keywordflow">else</span> {
00690         <span class="keywordflow">if</span> (pwszFace == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || *pwszFace == <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>) {
00691             pwszFace = <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a9">DefaultFaceName</a>;
00692         }
00693         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>.Y == 0) {
00694             <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>.X = <a class="code" href="../../d0/d3/dbcs_8h.html#a14">DefaultFontSize</a>.X;
00695             <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>.Y = <a class="code" href="../../d0/d3/dbcs_8h.html#a14">DefaultFontSize</a>.Y;
00696         }
00697     }
00698 
00699     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d3/dbcs_8h.html#a48">IsAvailableTTFont</a>(pwszFace)) {
00700         pwszAltFace = <a class="code" href="../../d0/d3/dbcs_8h.html#a50">GetAltFaceName</a>(pwszFace);
00701     }
00702     <span class="keywordflow">else</span> {
00703         pwszAltFace = pwszFace;
00704     }
00705 
00706     <span class="comment">/*</span>
00707 <span class="comment">     * Try to find the exact font</span>
00708 <span class="comment">     */</span>
00709 TryFindExactFont:
00710     <span class="keywordflow">for</span> (i=0; i &lt; (<span class="keywordtype">int</span>)<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a27">NumberOfFonts</a>; i++) {
00711         <span class="comment">/*</span>
00712 <span class="comment">         * If looking for a particular Family, skip non-matches</span>
00713 <span class="comment">         */</span>
00714         <span class="keywordflow">if</span> ((Family != 0) &amp;&amp;
00715                 ((<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>)Family != <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a1">FontInfo</a>[i].<a class="code" href="../../d5/d9/struct__FONT__INFO.html#o5">Family</a>)) {
00716             <span class="keywordflow">continue</span>;
00717         }
00718 
00719         <span class="comment">/*</span>
00720 <span class="comment">         * Skip non-matching sizes</span>
00721 <span class="comment">         */</span>
00722         <span class="keywordflow">if</span> ((<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a1">FontInfo</a>[i].<a class="code" href="../../d5/d9/struct__FONT__INFO.html#o2">SizeWant</a>.Y != <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>.Y) &amp;&amp;
00723              !<a class="code" href="../../d7/d6/font_8h.html#a4">SIZE_EQUAL</a>(<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a1">FontInfo</a>[i].<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>, <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>)) {
00724             <span class="keywordflow">continue</span>;
00725         }
00726 
00727         <span class="comment">/*</span>
00728 <span class="comment">         * Skip non-matching weights</span>
00729 <span class="comment">         */</span>
00730         <span class="keywordflow">if</span> ((Weight != 0) &amp;&amp; (Weight != <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a1">FontInfo</a>[i].<a class="code" href="../../d5/d9/struct__FONT__INFO.html#o3">Weight</a>)) {
00731             <span class="keywordflow">continue</span>;
00732         }
00733 <span class="preprocessor">#if defined(FE_SB)</span>
00734 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (!<a class="code" href="../../d7/d6/font_8h.html#a2">TM_IS_TT_FONT</a>(<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a1">FontInfo</a>[i].Family) &amp;&amp;
00735                 <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a1">FontInfo</a>[i].tmCharSet != CharSet) {
00736             <span class="keywordflow">continue</span>;
00737         }
00738 <span class="preprocessor">#endif</span>
00739 <span class="preprocessor"></span>
00740         <span class="comment">/*</span>
00741 <span class="comment">         * Size (and maybe Family) match.</span>
00742 <span class="comment">         *  If we don't care about the name, or if it matches, use this font.</span>
00743 <span class="comment">         *  Else if name doesn't match and it is a raster font, consider it.</span>
00744 <span class="comment">         */</span>
00745         <span class="keywordflow">if</span> ((pwszFace == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) || (pwszFace[0] == <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>) ||
00746                 wcscmp(<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a1">FontInfo</a>[i].FaceName, pwszFace) == 0 ||
00747                 wcscmp(<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a1">FontInfo</a>[i].FaceName, pwszAltFace) == 0
00748            ) {
00749             FontIndex = i;
00750             <span class="keywordflow">goto</span> FoundFont;
00751         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!<a class="code" href="../../d7/d6/font_8h.html#a2">TM_IS_TT_FONT</a>(<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a1">FontInfo</a>[i].Family)) {
00752             BestMatch = i;
00753         }
00754     }
00755 
00756     <span class="comment">/*</span>
00757 <span class="comment">     * Didn't find the exact font, so try to create it</span>
00758 <span class="comment">     */</span>
00759     <span class="keywordflow">if</span> (FontIndex == <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a3">NOT_CREATED_NOR_FOUND</a>) {
00760         ULONG ulOldEnumFilter;
00761         ulOldEnumFilter = SetFontEnumeration(0);
00762         <span class="comment">// restore all the other flags</span>
00763         SetFontEnumeration(ulOldEnumFilter &amp; ~FE_FILTER_TRUETYPE);
00764         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>.Y &lt; 0) {
00765             <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>.Y = -<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>.Y;
00766         }
00767         bFontOK = <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a23">DoFontEnum</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, pwszFace, <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>.Y);
00768         SetFontEnumeration(ulOldEnumFilter);
00769         <span class="keywordflow">if</span> (bFontOK) {
00770             <a class="code" href="../../d8/d5/consrv_8h.html#a0">DBGFONTS</a>((<span class="stringliteral">"FindCreateFont created font!\n"</span>));
00771             FontIndex = <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a4">CREATED_BUT_NOT_FOUND</a>;
00772             <span class="keywordflow">goto</span> TryFindExactFont;
00773         } <span class="keywordflow">else</span> {
00774             <a class="code" href="../../d8/d5/consrv_8h.html#a0">DBGFONTS</a>((<span class="stringliteral">"FindCreateFont failed to create font!\n"</span>));
00775         }
00776     }
00777 
00778     <span class="comment">/*</span>
00779 <span class="comment">     * Failed to find exact match, but we have a close Raster Font</span>
00780 <span class="comment">     * fit - only the name doesn't match.</span>
00781 <span class="comment">     */</span>
00782     <span class="keywordflow">if</span> (BestMatch &gt;= 0) {
00783         FontIndex = BestMatch;
00784         <span class="keywordflow">goto</span> FoundFont;
00785     }
00786 
00787     <span class="comment">/*</span>
00788 <span class="comment">     * Failed to find exact match, even after enumeration, so now try</span>
00789 <span class="comment">     * to find a font of same family and same size or bigger</span>
00790 <span class="comment">     */</span>
00791     <span class="keywordflow">for</span> (i=0; i &lt; (<span class="keywordtype">int</span>)<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a27">NumberOfFonts</a>; i++) {
00792 <span class="preprocessor">#if defined(FE_SB)</span>
00793 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/consrv_8h.html#a32">CONSOLE_IS_DBCS_ENABLED</a>()) {
00794             <span class="keywordflow">if</span> ((Family != 0) &amp;&amp;
00795                     ((<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>)Family != <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a1">FontInfo</a>[i].<a class="code" href="../../d5/d9/struct__FONT__INFO.html#o5">Family</a>)) {
00796                 <span class="keywordflow">continue</span>;
00797             }
00798 
00799             <span class="keywordflow">if</span> (!<a class="code" href="../../d7/d6/font_8h.html#a2">TM_IS_TT_FONT</a>(<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a1">FontInfo</a>[i].Family) &amp;&amp;
00800                     <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a1">FontInfo</a>[i].tmCharSet != CharSet) {
00801                 <span class="keywordflow">continue</span>;
00802             }
00803         }
00804         <span class="keywordflow">else</span> {
00805 <span class="preprocessor">#endif</span>
00806 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ((<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>)Family != <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a1">FontInfo</a>[i].<a class="code" href="../../d5/d9/struct__FONT__INFO.html#o5">Family</a>) {
00807             <span class="keywordflow">continue</span>;
00808         }
00809 <span class="preprocessor">#if defined(FE_SB)</span>
00810 <span class="preprocessor"></span>        }
00811 <span class="preprocessor">#endif</span>
00812 <span class="preprocessor"></span>
00813         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a1">FontInfo</a>[i].<a class="code" href="../../d5/d9/struct__FONT__INFO.html#o1">Size</a>.Y &gt;= <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>.Y &amp;&amp;
00814                 <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a1">FontInfo</a>[i].<a class="code" href="../../d5/d9/struct__FONT__INFO.html#o1">Size</a>.X &gt;= <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>.X) {
00815             <span class="comment">// Same family, size &gt;= desired.</span>
00816             FontIndex = i;
00817             <span class="keywordflow">break</span>;
00818         }
00819     }
00820 
00821     <span class="keywordflow">if</span> (FontIndex &lt; 0) {
00822         <a class="code" href="../../d8/d5/consrv_8h.html#a0">DBGFONTS</a>((<span class="stringliteral">"FindCreateFont defaults!\n"</span>));
00823 <span class="preprocessor">#if defined(FE_SB)</span>
00824 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/consrv_8h.html#a32">CONSOLE_IS_DBCS_ENABLED</a>() &amp;&amp;
00825             !<a class="code" href="../../d0/d3/dbcs_8h.html#a46">IsAvailableFarEastCodePage</a>(CodePage))
00826         {
00827             FontIndex = AltFontIndex;
00828         }
00829         <span class="keywordflow">else</span>
00830 <span class="preprocessor">#endif</span>
00831 <span class="preprocessor"></span>        FontIndex = <a class="code" href="../../d0/d3/dbcs_8h.html#a13">DefaultFontIndex</a>;
00832     }
00833 
00834 FoundFont:
00835     <a class="code" href="../../d8/d5/consrv_8h.html#a0">DBGFONTS</a>((<span class="stringliteral">"FindCreateFont returns %x : %ls (%d,%d)\n"</span>, FontIndex,
00836             <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a1">FontInfo</a>[FontIndex].FaceName,
00837             <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a1">FontInfo</a>[FontIndex].<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>.X, <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a1">FontInfo</a>[FontIndex].<a class="code" href="../../d5/d9/struct__FONT__INFO.html#o1">Size</a>.Y));
00838     <span class="keywordflow">return</span> FontIndex;
00839 
00840 <span class="preprocessor">#undef NOT_CREATED_NOR_FOUND</span>
00841 <span class="preprocessor"></span><span class="preprocessor">#undef CREATED_BUT_NOT_FOUND</span>
00842 <span class="preprocessor"></span>}
00843 
00844 
00845 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00846"></a><a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a26">00846</a> <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a26">FindTextBufferFontInfo</a>(
00847     IN <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo,
00848     IN UINT CodePage,
00849     OUT <a class="code" href="../../d7/d0/struct__TEXT__BUFFER__FONT__INFO.html">PTEXT_BUFFER_FONT_INFO</a> TextFontInfo
00850     )
00851 
00852 <span class="comment">/*++</span>
00853 <span class="comment"></span>
00854 <span class="comment">Routine Description:</span>
00855 <span class="comment"></span>
00856 <span class="comment">    This routine find a font information which correspond to code page value.</span>
00857 <span class="comment"></span>
00858 <span class="comment">Arguments:</span>
00859 <span class="comment"></span>
00860 <span class="comment">Return Value:</span>
00861 <span class="comment"></span>
00862 <span class="comment">--*/</span>
00863 
00864 {
00865     <a class="code" href="../../d7/d0/struct__TEXT__BUFFER__FONT__INFO.html">PTEXT_BUFFER_FONT_INFO</a> CurrentFont;
00866 
00867     CurrentFont = ScreenInfo-&gt;BufferInfo.TextInfo.ListOfTextBufferFont;
00868 
00869     <span class="keywordflow">while</span> (CurrentFont != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00870         <span class="keywordflow">if</span> (CurrentFont-&gt;<a class="code" href="../../d7/d0/struct__TEXT__BUFFER__FONT__INFO.html#o6">FontCodePage</a> == CodePage) {
00871             *TextFontInfo = *CurrentFont;
00872             <span class="keywordflow">return</span> STATUS_SUCCESS;
00873         }
00874         CurrentFont = CurrentFont-&gt;<a class="code" href="../../d7/d0/struct__TEXT__BUFFER__FONT__INFO.html#o0">NextTextBufferFont</a>;
00875     }
00876 
00877     <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
00878 }
00879 
00880 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00881"></a><a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a27">00881</a> <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a27">StoreTextBufferFontInfo</a>(
00882     IN <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo,
00883     IN ULONG FontIndex,
00884     IN COORD FontSize,
00885     IN BYTE  FontFamily,
00886     IN LONG  FontWeight,
00887     IN LPWSTR FaceName,
00888     IN UINT CodePage
00889     )
00890 
00891 <span class="comment">/*++</span>
00892 <span class="comment"></span>
00893 <span class="comment">Routine Description:</span>
00894 <span class="comment"></span>
00895 <span class="comment">    This routine store a font information in CurrentTextBufferFont and ListOfTextBufferFont.</span>
00896 <span class="comment">    If specified code page does not exist in ListOfTextBufferFont, then create new list.</span>
00897 <span class="comment"></span>
00898 <span class="comment">Arguments:</span>
00899 <span class="comment"></span>
00900 <span class="comment">Return Value:</span>
00901 <span class="comment"></span>
00902 <span class="comment">--*/</span>
00903 
00904 {
00905     <a class="code" href="../../d7/d0/struct__TEXT__BUFFER__FONT__INFO.html">PTEXT_BUFFER_FONT_INFO</a> CurrentFont, PrevFont;
00906 
00907     CurrentFont = ScreenInfo-&gt;BufferInfo.TextInfo.ListOfTextBufferFont;
00908 
00909     <span class="keywordflow">while</span> (CurrentFont != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00910         <span class="keywordflow">if</span> (CurrentFont-&gt;<a class="code" href="../../d7/d0/struct__TEXT__BUFFER__FONT__INFO.html#o6">FontCodePage</a> == CodePage) {
00911             CurrentFont-&gt;<a class="code" href="../../d7/d0/struct__TEXT__BUFFER__FONT__INFO.html#o2">FontNumber</a>   = FontIndex;
00912             CurrentFont-&gt;<a class="code" href="../../d7/d0/struct__TEXT__BUFFER__FONT__INFO.html#o1">FontSize</a>     = FontSize;
00913             CurrentFont-&gt;<a class="code" href="../../d7/d0/struct__TEXT__BUFFER__FONT__INFO.html#o5">Family</a>       = FontFamily;
00914             CurrentFont-&gt;<a class="code" href="../../d7/d0/struct__TEXT__BUFFER__FONT__INFO.html#o4">Weight</a>       = FontWeight;
00915             <span class="comment">// CurrentFont-&gt;FontCodePage = CodePage; // Redundant</span>
00916             wcscpy(CurrentFont-&gt;<a class="code" href="../../d7/d0/struct__TEXT__BUFFER__FONT__INFO.html#o3">FaceName</a>, FaceName);
00917             <span class="keywordflow">break</span>;
00918         }
00919         PrevFont    = CurrentFont;
00920         CurrentFont = CurrentFont-&gt;<a class="code" href="../../d7/d0/struct__TEXT__BUFFER__FONT__INFO.html#o0">NextTextBufferFont</a>;
00921     }
00922 
00923     <span class="keywordflow">if</span> (CurrentFont == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00924         CurrentFont = <a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( <a class="code" href="../../d8/d5/consrv_8h.html#a19">FONT_TAG</a> ), <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d0/struct__TEXT__BUFFER__FONT__INFO.html">TEXT_BUFFER_FONT_INFO</a>));
00925         <span class="keywordflow">if</span> (CurrentFont == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00926             <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00927         }
00928 
00929         CurrentFont-&gt;<a class="code" href="../../d7/d0/struct__TEXT__BUFFER__FONT__INFO.html#o0">NextTextBufferFont</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00930         CurrentFont-&gt;<a class="code" href="../../d7/d0/struct__TEXT__BUFFER__FONT__INFO.html#o2">FontNumber</a>   = FontIndex;
00931         CurrentFont-&gt;<a class="code" href="../../d7/d0/struct__TEXT__BUFFER__FONT__INFO.html#o1">FontSize</a>     = FontSize;
00932         CurrentFont-&gt;<a class="code" href="../../d7/d0/struct__TEXT__BUFFER__FONT__INFO.html#o5">Family</a>       = FontFamily;
00933         CurrentFont-&gt;<a class="code" href="../../d7/d0/struct__TEXT__BUFFER__FONT__INFO.html#o4">Weight</a>       = FontWeight;
00934         CurrentFont-&gt;<a class="code" href="../../d7/d0/struct__TEXT__BUFFER__FONT__INFO.html#o6">FontCodePage</a> = CodePage;
00935         wcscpy(CurrentFont-&gt;<a class="code" href="../../d7/d0/struct__TEXT__BUFFER__FONT__INFO.html#o3">FaceName</a>, FaceName);
00936 
00937         <span class="keywordflow">if</span> (ScreenInfo-&gt;BufferInfo.TextInfo.ListOfTextBufferFont == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00938             ScreenInfo-&gt;BufferInfo.TextInfo.ListOfTextBufferFont = CurrentFont;
00939         }
00940         <span class="keywordflow">else</span> {
00941             PrevFont-&gt;<a class="code" href="../../d7/d0/struct__TEXT__BUFFER__FONT__INFO.html#o0">NextTextBufferFont</a> = CurrentFont;
00942         }
00943     }
00944 
00945     ScreenInfo-&gt;BufferInfo.TextInfo.CurrentTextBufferFont = *CurrentFont;
00946     ScreenInfo-&gt;BufferInfo.TextInfo.CurrentTextBufferFont.<a class="code" href="../../d7/d0/struct__TEXT__BUFFER__FONT__INFO.html#o0">NextTextBufferFont</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00947 
00948     <span class="keywordflow">return</span> STATUS_SUCCESS;
00949 }
00950 
00951 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00952"></a><a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a28">00952</a> <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a28">RemoveTextBufferFontInfo</a>(
00953     IN <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo
00954     )
00955 
00956 <span class="comment">/*++</span>
00957 <span class="comment"></span>
00958 <span class="comment">Routine Description:</span>
00959 <span class="comment"></span>
00960 <span class="comment">    This routine all remove a font information in ListOfTextBufferFont.</span>
00961 <span class="comment"></span>
00962 <span class="comment">Arguments:</span>
00963 <span class="comment"></span>
00964 <span class="comment">Return Value:</span>
00965 <span class="comment"></span>
00966 <span class="comment">--*/</span>
00967 
00968 {
00969     <a class="code" href="../../d7/d0/struct__TEXT__BUFFER__FONT__INFO.html">PTEXT_BUFFER_FONT_INFO</a> CurrentFont;
00970 
00971     CurrentFont = ScreenInfo-&gt;BufferInfo.TextInfo.ListOfTextBufferFont;
00972 
00973     <span class="keywordflow">while</span> (CurrentFont != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00974         <a class="code" href="../../d7/d0/struct__TEXT__BUFFER__FONT__INFO.html">PTEXT_BUFFER_FONT_INFO</a> NextFont;
00975 
00976         NextFont = CurrentFont-&gt;<a class="code" href="../../d7/d0/struct__TEXT__BUFFER__FONT__INFO.html#o0">NextTextBufferFont</a>;
00977         <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(CurrentFont);
00978 
00979         CurrentFont = NextFont;
00980     }
00981 
00982     ScreenInfo-&gt;BufferInfo.TextInfo.ListOfTextBufferFont = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00983 
00984     <span class="keywordflow">return</span> STATUS_SUCCESS;
00985 }
00986 
00987 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00988"></a><a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a29">00988</a> <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a29">GetNumFonts</a>(
00989     OUT PULONG NumFonts
00990     )
00991 {
00992     *NumFonts = <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a27">NumberOfFonts</a>;
00993     <span class="keywordflow">return</span> STATUS_SUCCESS;
00994 }
00995 
00996 
00997 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00998"></a><a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a30">00998</a> <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a30">GetAvailableFonts</a>(
00999     IN <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo,
01000     IN BOOLEAN MaximumWindow,
01001     OUT PVOID Buffer,
01002     IN OUT PULONG NumFonts
01003     )
01004 {
01005     PCONSOLE_FONT_INFO BufPtr;
01006     ULONG i;
01007     COORD WindowSize;
01008     <a class="code" href="../../d0/d9/struct__WINDOW__LIMITS.html">WINDOW_LIMITS</a> WindowLimits;
01009 
01010     <span class="comment">//</span>
01011     <span class="comment">// if the buffer is too small to return all the fonts, return</span>
01012     <span class="comment">// the number that will fit.</span>
01013     <span class="comment">//</span>
01014 
01015     *NumFonts = (*NumFonts &gt; <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a27">NumberOfFonts</a>) ? <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a27">NumberOfFonts</a> : *NumFonts;
01016 
01017     <span class="comment">//</span>
01018     <span class="comment">// convert font size in pixels to font size in rows/columns</span>
01019     <span class="comment">//</span>
01020 
01021     BufPtr = (PCONSOLE_FONT_INFO)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
01022 
01023     <span class="keywordflow">if</span> (MaximumWindow) {
01024         <a class="code" href="../../d6/d2/output_8c.html#a39">GetWindowLimits</a>(ScreenInfo, &amp;WindowLimits);
01025         WindowSize = WindowLimits.<a class="code" href="../../d0/d9/struct__WINDOW__LIMITS.html#o1">MaximumWindowSize</a>;
01026     }
01027     <span class="keywordflow">else</span> {
01028         WindowSize.X = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)<a class="code" href="../../d7/d2/output_8h.html#a17">CONSOLE_WINDOW_SIZE_X</a>(ScreenInfo);
01029         WindowSize.Y = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)<a class="code" href="../../d7/d2/output_8h.html#a18">CONSOLE_WINDOW_SIZE_Y</a>(ScreenInfo);
01030     }
01031     <span class="keywordflow">for</span> (i=0;i&lt;*NumFonts;i++,BufPtr++) {
01032         BufPtr-&gt;nFont = i;
01033         BufPtr-&gt;dwFontSize.X = WindowSize.X * <a class="code" href="../../d8/d5/consrv_8h.html#a66">SCR_FONTSIZE</a>(ScreenInfo).X / <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a1">FontInfo</a>[i].<a class="code" href="../../d5/d9/struct__FONT__INFO.html#o1">Size</a>.X;
01034         BufPtr-&gt;dwFontSize.Y = WindowSize.Y * <a class="code" href="../../d8/d5/consrv_8h.html#a66">SCR_FONTSIZE</a>(ScreenInfo).Y / <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a1">FontInfo</a>[i].<a class="code" href="../../d5/d9/struct__FONT__INFO.html#o1">Size</a>.Y;
01035     }
01036 
01037     <span class="keywordflow">return</span> STATUS_SUCCESS;
01038 }
01039 
01040 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01041"></a><a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a31">01041</a> <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a31">GetFontSize</a>(
01042     IN DWORD  FontIndex,
01043     OUT PCOORD FontSize
01044     )
01045 {
01046     <span class="keywordflow">if</span> (FontIndex &gt;= <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a27">NumberOfFonts</a>)
01047         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
01048     *FontSize = <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a1">FontInfo</a>[FontIndex].<a class="code" href="../../d5/d9/struct__FONT__INFO.html#o1">Size</a>;
01049     <span class="keywordflow">return</span> STATUS_SUCCESS;
01050 }
01051 
01052 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01053"></a><a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a32">01053</a> <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a32">GetCurrentFont</a>(
01054     IN <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo,
01055     IN BOOLEAN MaximumWindow,
01056     OUT PULONG FontIndex,
01057     OUT PCOORD FontSize
01058     )
01059 {
01060     COORD WindowSize;
01061     <a class="code" href="../../d0/d9/struct__WINDOW__LIMITS.html">WINDOW_LIMITS</a> WindowLimits;
01062 
01063     <span class="keywordflow">if</span> (MaximumWindow) {
01064         <a class="code" href="../../d6/d2/output_8c.html#a39">GetWindowLimits</a>(ScreenInfo, &amp;WindowLimits);
01065         WindowSize = WindowLimits.<a class="code" href="../../d0/d9/struct__WINDOW__LIMITS.html#o1">MaximumWindowSize</a>;
01066     }
01067     <span class="keywordflow">else</span> {
01068         WindowSize.X = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)<a class="code" href="../../d7/d2/output_8h.html#a17">CONSOLE_WINDOW_SIZE_X</a>(ScreenInfo);
01069         WindowSize.Y = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)<a class="code" href="../../d7/d2/output_8h.html#a18">CONSOLE_WINDOW_SIZE_Y</a>(ScreenInfo);
01070     }
01071     *FontIndex = <a class="code" href="../../d8/d5/consrv_8h.html#a64">SCR_FONTNUMBER</a>(ScreenInfo);
01072     *FontSize = WindowSize;
01073     <span class="keywordflow">return</span> STATUS_SUCCESS;
01074 }
01075 
01076 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01077"></a><a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a33">01077</a> <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a33">SetScreenBufferFont</a>(
01078     IN <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo,
01079     IN ULONG FontIndex,
01080     IN UINT CodePage
01081     )
01082 {
01083     COORD FontSize;
01084     <a class="code" href="../../d0/d9/struct__WINDOW__LIMITS.html">WINDOW_LIMITS</a> WindowLimits;
01085     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01086     ULONG ulFlagPrev;
01087     <a class="code" href="../../d8/d5/consrv_8h.html#a0">DBGFONTS</a>((<span class="stringliteral">"SetScreenBufferFont %lx %x\n"</span>, ScreenInfo, FontIndex));
01088 
01089     <span class="keywordflow">if</span> (ScreenInfo == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01090         <span class="comment">/* If shutdown occurs with font dlg up */</span>
01091         <span class="keywordflow">return</span> STATUS_SUCCESS;
01092     }
01093 
01094     <span class="comment">/*</span>
01095 <span class="comment">     * Don't try to set the font if we're not in text mode</span>
01096 <span class="comment">     */</span>
01097     <span class="keywordflow">if</span> (!(ScreenInfo-&gt;Flags &amp; <a class="code" href="../../d7/d2/output_8h.html#a0">CONSOLE_TEXTMODE_BUFFER</a>)) {
01098         <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
01099     }
01100 
01101     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a31">GetFontSize</a>(FontIndex, &amp;FontSize);
01102     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01103         <span class="keywordflow">return</span>((ULONG) <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
01104     }
01105 
01106     ulFlagPrev = ScreenInfo-&gt;Flags;
01107     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d6/font_8h.html#a2">TM_IS_TT_FONT</a>(<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a1">FontInfo</a>[FontIndex].Family)) {
01108         ScreenInfo-&gt;Flags &amp;= ~<a class="code" href="../../d7/d2/output_8h.html#a2">CONSOLE_OEMFONT_DISPLAY</a>;
01109     } <span class="keywordflow">else</span> {
01110         ScreenInfo-&gt;Flags |= <a class="code" href="../../d7/d2/output_8h.html#a2">CONSOLE_OEMFONT_DISPLAY</a>;
01111     }
01112 
01113     <span class="comment">/*</span>
01114 <span class="comment">     * Convert from UnicodeOem to Unicode or vice-versa if necessary</span>
01115 <span class="comment">     */</span>
01116     <span class="keywordflow">if</span> ((ulFlagPrev &amp; <a class="code" href="../../d7/d2/output_8h.html#a2">CONSOLE_OEMFONT_DISPLAY</a>) != (ScreenInfo-&gt;Flags &amp; <a class="code" href="../../d7/d2/output_8h.html#a2">CONSOLE_OEMFONT_DISPLAY</a>)) {
01117         <span class="keywordflow">if</span> (ulFlagPrev &amp; <a class="code" href="../../d7/d2/output_8h.html#a2">CONSOLE_OEMFONT_DISPLAY</a>) {
01118             <span class="comment">/*</span>
01119 <span class="comment">             * Must convert from UnicodeOem to real Unicode</span>
01120 <span class="comment">             */</span>
01121             <a class="code" href="../../d8/d5/consrv_8h.html#a2">DBGCHARS</a>((<span class="stringliteral">"SetScreenBufferFont converts UnicodeOem to Unicode\n"</span>));
01122             <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a43">FalseUnicodeToRealUnicode</a>(
01123                     ScreenInfo-&gt;BufferInfo.TextInfo.TextRows,
01124                     ScreenInfo-&gt;ScreenBufferSize.X * ScreenInfo-&gt;ScreenBufferSize.Y,
01125                     ScreenInfo-&gt;Console-&gt;OutputCP);
01126         } <span class="keywordflow">else</span> {
01127             <span class="comment">/*</span>
01128 <span class="comment">             * Must convert from real Unicode to UnicodeOem</span>
01129 <span class="comment">             */</span>
01130             <a class="code" href="../../d8/d5/consrv_8h.html#a2">DBGCHARS</a>((<span class="stringliteral">"SetScreenBufferFont converts Unicode to UnicodeOem\n"</span>));
01131             <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a42">RealUnicodeToFalseUnicode</a>(
01132                     ScreenInfo-&gt;BufferInfo.TextInfo.TextRows,
01133                     ScreenInfo-&gt;ScreenBufferSize.X * ScreenInfo-&gt;ScreenBufferSize.Y,
01134                     ScreenInfo-&gt;Console-&gt;OutputCP);
01135         }
01136     }
01137 
01138     <span class="comment">/*</span>
01139 <span class="comment">     * Store font properties</span>
01140 <span class="comment">     */</span>
01141     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a27">StoreTextBufferFontInfo</a>(ScreenInfo,
01142                                      FontIndex,
01143                                      FontSize,
01144                                      <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a1">FontInfo</a>[FontIndex].Family,
01145                                      <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a1">FontInfo</a>[FontIndex].Weight,
01146                                      <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a1">FontInfo</a>[FontIndex].FaceName,
01147                                      CodePage);
01148     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01149         <span class="keywordflow">return</span>((ULONG) <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
01150     }
01151 
01152     <span class="comment">//</span>
01153     <span class="comment">// set font</span>
01154     <span class="comment">//</span>
01155     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a34">SetFont</a>(ScreenInfo);
01156     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01157         <span class="keywordflow">return</span>((ULONG) <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
01158     }
01159 
01160     <span class="comment">//</span>
01161     <span class="comment">// if window is growing, make sure it's not bigger than the screen.</span>
01162     <span class="comment">//</span>
01163 
01164     <a class="code" href="../../d6/d2/output_8c.html#a39">GetWindowLimits</a>(ScreenInfo, &amp;WindowLimits);
01165     <span class="keywordflow">if</span> (WindowLimits.<a class="code" href="../../d0/d9/struct__WINDOW__LIMITS.html#o1">MaximumWindowSize</a>.X &lt; <a class="code" href="../../d7/d2/output_8h.html#a17">CONSOLE_WINDOW_SIZE_X</a>(ScreenInfo)) {
01166         ScreenInfo-&gt;Window.Right -= <a class="code" href="../../d7/d2/output_8h.html#a17">CONSOLE_WINDOW_SIZE_X</a>(ScreenInfo) - WindowLimits.<a class="code" href="../../d0/d9/struct__WINDOW__LIMITS.html#o1">MaximumWindowSize</a>.X;
01167         ScreenInfo-&gt;WindowMaximizedX = (ScreenInfo-&gt;Window.Left == 0 &amp;&amp;
01168                                         (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(ScreenInfo-&gt;Window.Right+1) == ScreenInfo-&gt;ScreenBufferSize.X);
01169     }
01170     <span class="keywordflow">if</span> (WindowLimits.<a class="code" href="../../d0/d9/struct__WINDOW__LIMITS.html#o1">MaximumWindowSize</a>.Y &lt; <a class="code" href="../../d7/d2/output_8h.html#a18">CONSOLE_WINDOW_SIZE_Y</a>(ScreenInfo)) {
01171         ScreenInfo-&gt;Window.Bottom -= <a class="code" href="../../d7/d2/output_8h.html#a18">CONSOLE_WINDOW_SIZE_Y</a>(ScreenInfo) - WindowLimits.<a class="code" href="../../d0/d9/struct__WINDOW__LIMITS.html#o1">MaximumWindowSize</a>.Y;
01172         <span class="keywordflow">if</span> (ScreenInfo-&gt;BufferInfo.TextInfo.CursorPosition.Y &gt; ScreenInfo-&gt;Window.Bottom) {
01173             ScreenInfo-&gt;Window.Top += ScreenInfo-&gt;BufferInfo.TextInfo.CursorPosition.Y - ScreenInfo-&gt;Window.Bottom;
01174             ScreenInfo-&gt;Window.Bottom += ScreenInfo-&gt;BufferInfo.TextInfo.CursorPosition.Y - ScreenInfo-&gt;Window.Bottom;
01175         }
01176         ScreenInfo-&gt;WindowMaximizedY = (ScreenInfo-&gt;Window.Top == 0 &amp;&amp;
01177                                         (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(ScreenInfo-&gt;Window.Bottom+1) == ScreenInfo-&gt;ScreenBufferSize.Y);
01178     }
01179     <span class="keywordflow">if</span> (WindowLimits.<a class="code" href="../../d0/d9/struct__WINDOW__LIMITS.html#o0">MinimumWindowSize</a>.X &gt; <a class="code" href="../../d7/d2/output_8h.html#a17">CONSOLE_WINDOW_SIZE_X</a>(ScreenInfo)) {
01180         <span class="keywordflow">if</span> (WindowLimits.<a class="code" href="../../d0/d9/struct__WINDOW__LIMITS.html#o0">MinimumWindowSize</a>.X &gt; ScreenInfo-&gt;ScreenBufferSize.X) {
01181             COORD NewBufferSize;
01182 
01183             NewBufferSize.X = WindowLimits.<a class="code" href="../../d0/d9/struct__WINDOW__LIMITS.html#o0">MinimumWindowSize</a>.X;
01184             NewBufferSize.Y = ScreenInfo-&gt;ScreenBufferSize.Y;
01185             <a class="code" href="../../d6/d2/output_8c.html#a58">ResizeScreenBuffer</a>(ScreenInfo,
01186                                NewBufferSize,
01187                                <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
01188                               );
01189         }
01190         <span class="keywordflow">if</span> ((ScreenInfo-&gt;Window.Left+WindowLimits.<a class="code" href="../../d0/d9/struct__WINDOW__LIMITS.html#o0">MinimumWindowSize</a>.X) &gt; ScreenInfo-&gt;ScreenBufferSize.X) {
01191             ScreenInfo-&gt;Window.Left = 0;
01192             ScreenInfo-&gt;Window.Right = WindowLimits.<a class="code" href="../../d0/d9/struct__WINDOW__LIMITS.html#o0">MinimumWindowSize</a>.X-1;
01193         } <span class="keywordflow">else</span> {
01194             ScreenInfo-&gt;Window.Right = ScreenInfo-&gt;Window.Left+WindowLimits.<a class="code" href="../../d0/d9/struct__WINDOW__LIMITS.html#o0">MinimumWindowSize</a>.X-1;
01195         }
01196         ScreenInfo-&gt;WindowMaximizedX = (ScreenInfo-&gt;Window.Left == 0 &amp;&amp;
01197                                         (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(ScreenInfo-&gt;Window.Right+1) == ScreenInfo-&gt;ScreenBufferSize.X);
01198     }
01199 
01200     <a class="code" href="../../d0/d3/dbcs_8h.html#a29">SetLineChar</a>(ScreenInfo);
01201     {
01202         COORD WindowedWindowSize;
01203 
01204         WindowedWindowSize.X = <a class="code" href="../../d7/d2/output_8h.html#a17">CONSOLE_WINDOW_SIZE_X</a>(ScreenInfo);
01205         WindowedWindowSize.Y = <a class="code" href="../../d7/d2/output_8h.html#a18">CONSOLE_WINDOW_SIZE_Y</a>(ScreenInfo);
01206 
01207 
01208 <span class="preprocessor">#if defined(FE_IME)</span>
01209 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (CONSOLE_IS_DBCS_OUTPUTCP(ScreenInfo-&gt;Console))
01210         {
01211             PCONVERSIONAREA_INFORMATION ConvAreaInfo;
01212 
01213             ConvAreaInfo = ScreenInfo-&gt;Console-&gt;ConsoleIme.ConvAreaRoot;
01214             <span class="keywordflow">while</span> (ConvAreaInfo) {
01215 
01216                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a27">StoreTextBufferFontInfo</a>(ConvAreaInfo-&gt;ScreenBuffer,
01217                                                  <a class="code" href="../../d8/d5/consrv_8h.html#a64">SCR_FONTNUMBER</a>(ScreenInfo),
01218                                                  <a class="code" href="../../d8/d5/consrv_8h.html#a66">SCR_FONTSIZE</a>(ScreenInfo),
01219                                                  <a class="code" href="../../d8/d5/consrv_8h.html#a63">SCR_FAMILY</a>(ScreenInfo),
01220                                                  <a class="code" href="../../d8/d5/consrv_8h.html#a67">SCR_FONTWEIGHT</a>(ScreenInfo),
01221                                                  <a class="code" href="../../d8/d5/consrv_8h.html#a65">SCR_FACENAME</a>(ScreenInfo),
01222                                                  <a class="code" href="../../d8/d5/consrv_8h.html#a68">SCR_FONTCODEPAGE</a>(ScreenInfo));
01223                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01224                     <span class="keywordflow">return</span>((ULONG) <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
01225                 }
01226 
01227                 ConvAreaInfo-&gt;ScreenBuffer-&gt;Window = ScreenInfo-&gt;Window;
01228                 ConvAreaInfo-&gt;ScreenBuffer-&gt;BufferInfo.TextInfo.ModeIndex = ScreenInfo-&gt;BufferInfo.TextInfo.ModeIndex;
01229 
01230                 ConvAreaInfo = ConvAreaInfo-&gt;ConvAreaNext;
01231             }
01232         }
01233 <span class="preprocessor">#endif // FE_IME</span>
01234 <span class="preprocessor"></span>    }
01235 
01236     <span class="comment">//</span>
01237     <span class="comment">// resize window.  this will take care of the scroll bars too.</span>
01238     <span class="comment">//</span>
01239 
01240     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d2/output_8h.html#a12">ACTIVE_SCREEN_BUFFER</a>(ScreenInfo)) {
01241         <a class="code" href="../../d6/d2/output_8c.html#a68">SetWindowSize</a>(ScreenInfo);
01242     }
01243 
01244     <span class="comment">//</span>
01245     <span class="comment">// adjust cursor size.</span>
01246     <span class="comment">//</span>
01247 
01248     <a class="code" href="../../d6/d1/ntcon_2server_2cursor_8c.html#a4">SetCursorInformation</a>(ScreenInfo,
01249                          ScreenInfo-&gt;BufferInfo.TextInfo.CursorSize,
01250                          (BOOLEAN)ScreenInfo-&gt;BufferInfo.TextInfo.CursorVisible
01251                         );
01252 
01253     <a class="code" href="../../d6/d8/dispatch_8h.html#a4">WriteToScreen</a>(ScreenInfo,
01254                   &amp;ScreenInfo-&gt;Window);
01255     <span class="keywordflow">return</span> STATUS_SUCCESS;
01256 }
01257 
01258 
01259 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01260"></a><a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a34">01260</a> <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a34">SetFont</a>(
01261     IN OUT <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo
01262     )
01263 {
01264     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d2/output_8h.html#a12">ACTIVE_SCREEN_BUFFER</a>(ScreenInfo)) {
01265         <span class="keywordtype">int</span> FontIndex = <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a25">FindCreateFont</a>(<a class="code" href="../../d8/d5/consrv_8h.html#a63">SCR_FAMILY</a>(ScreenInfo),
01266                                        <a class="code" href="../../d8/d5/consrv_8h.html#a65">SCR_FACENAME</a>(ScreenInfo),
01267                                        <a class="code" href="../../d8/d5/consrv_8h.html#a66">SCR_FONTSIZE</a>(ScreenInfo),
01268                                        <a class="code" href="../../d8/d5/consrv_8h.html#a67">SCR_FONTWEIGHT</a>(ScreenInfo),
01269                                        <a class="code" href="../../d8/d5/consrv_8h.html#a68">SCR_FONTCODEPAGE</a>(ScreenInfo));
01270         <span class="keywordflow">if</span> (SelectObject(ScreenInfo-&gt;Console-&gt;hDC,<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a1">FontInfo</a>[FontIndex].<a class="code" href="../../d5/d9/struct__FONT__INFO.html#o0">hFont</a>)==0)
01271             <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
01272 
01273         <span class="keywordflow">if</span> ((<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)FontIndex != <a class="code" href="../../d8/d5/consrv_8h.html#a64">SCR_FONTNUMBER</a>(ScreenInfo)) {
01274             <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01275             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a27">StoreTextBufferFontInfo</a>(ScreenInfo,
01276                                              FontIndex,
01277                                              <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a1">FontInfo</a>[FontIndex].<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>,
01278                                              <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a1">FontInfo</a>[FontIndex].Family,
01279                                              <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a1">FontInfo</a>[FontIndex].Weight,
01280                                              <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a1">FontInfo</a>[FontIndex].FaceName,
01281                                              ScreenInfo-&gt;Console-&gt;OutputCP);
01282             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01283                 <span class="keywordflow">return</span>((ULONG) <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
01284             }
01285         }
01286 
01287         <span class="comment">// hack to get text realized into DC.  this is to force the</span>
01288         <span class="comment">// attribute cache to get flushed to the server side, since</span>
01289         <span class="comment">// we select the font with a client side DC and call ExtTextOut</span>
01290         <span class="comment">// with a server side DC.</span>
01291         <span class="comment">// we then need to reset the text color, since the incorrect</span>
01292         <span class="comment">// client side color has been flushed to the server.</span>
01293         {
01294         TEXTMETRIC tmi;
01295 
01296         GetTextMetricsW( ScreenInfo-&gt;Console-&gt;hDC, &amp;tmi);
01297         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((tmi.tmPitchAndFamily &amp; 1) == 0);
01298         ScreenInfo-&gt;Console-&gt;LastAttributes = ScreenInfo-&gt;Attributes;
01299         SetTextColor(ScreenInfo-&gt;Console-&gt;hDC,<a class="code" href="../../d8/d5/consrv_8h.html#a43">ConvertAttrToRGB</a>(ScreenInfo-&gt;Console, <a class="code" href="../../d5/d9/ntrtlp_8h.html#a4">LOBYTE</a>(ScreenInfo-&gt;Attributes)));
01300         SetBkColor(ScreenInfo-&gt;Console-&gt;hDC,<a class="code" href="../../d8/d5/consrv_8h.html#a43">ConvertAttrToRGB</a>(ScreenInfo-&gt;Console, <a class="code" href="../../d5/d9/ntrtlp_8h.html#a4">LOBYTE</a>(ScreenInfo-&gt;Attributes &gt;&gt; 4)));
01301         }
01302     }
01303     <span class="keywordflow">return</span> STATUS_SUCCESS;
01304 }
01305 
01306 <span class="keywordtype">int</span>
<a name="l01307"></a><a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a35">01307</a> <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a35">ConvertToOem</a>(
01308     IN UINT Codepage,
01309     IN LPWSTR Source,
01310     IN <span class="keywordtype">int</span> SourceLength,    <span class="comment">// in chars</span>
01311     OUT LPSTR Target,
01312     IN <span class="keywordtype">int</span> TargetLength     <span class="comment">// in chars</span>
01313     )
01314 {
01315     <a class="code" href="../../d8/d5/consrv_8h.html#a2">DBGCHARS</a>((<span class="stringliteral">"ConvertToOem U-&gt;%d %.*ls\n"</span>, Codepage,
01316             SourceLength &gt; 10 ? 10 : SourceLength, Source));
01317     <span class="keywordflow">if</span> (Codepage == <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a2">OEMCP</a>) {
01318         ULONG Length;
01319         <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01320 
01321         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d6/nlsxlat_8c.html#a39">RtlUnicodeToOemN</a>(Target,
01322                                   TargetLength,
01323                                   &amp;Length,
01324                                   Source,
01325                                   SourceLength * <span class="keyword">sizeof</span>(WCHAR)
01326                                  );
01327         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01328             <span class="keywordflow">return</span> 0;
01329         } <span class="keywordflow">else</span> {
01330             <span class="keywordflow">return</span> Length;
01331         }
01332     } <span class="keywordflow">else</span> {
01333         <span class="keywordflow">return</span> WideCharToMultiByte(Codepage,
01334                                    0,
01335                                    Source,
01336                                    SourceLength,
01337                                    Target,
01338                                    TargetLength,
01339                                    <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01340                                    <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01341     }
01342 }
01343 
01344 <span class="keywordtype">int</span>
<a name="l01345"></a><a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a36">01345</a> <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a36">ConvertInputToUnicode</a>(
01346     IN UINT Codepage,
01347     IN LPSTR Source,
01348     IN <span class="keywordtype">int</span> SourceLength,    <span class="comment">// in chars</span>
01349     OUT LPWSTR Target,
01350     IN <span class="keywordtype">int</span> TargetLength     <span class="comment">// in chars</span>
01351     )
01352 <span class="comment">/*</span>
01353 <span class="comment">    data in the output buffer is the true unicode value</span>
01354 <span class="comment">*/</span>
01355 {
01356     <a class="code" href="../../d8/d5/consrv_8h.html#a2">DBGCHARS</a>((<span class="stringliteral">"ConvertInputToUnicode %d-&gt;U %.*s\n"</span>, Codepage,
01357             SourceLength &gt; 10 ? 10 : SourceLength, Source));
01358     <span class="keywordflow">if</span> (Codepage == <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a2">OEMCP</a>) {
01359         ULONG Length;
01360         <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01361 
01362         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d6/nlsxlat_8c.html#a34">RtlOemToUnicodeN</a>(Target,
01363                                   TargetLength * <span class="keyword">sizeof</span>(WCHAR),
01364                                   &amp;Length,
01365                                   Source,
01366                                   SourceLength
01367                                  );
01368         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01369             <span class="keywordflow">return</span> 0;
01370         } <span class="keywordflow">else</span> {
01371             <span class="keywordflow">return</span> Length / <span class="keyword">sizeof</span>(WCHAR);
01372         }
01373     } <span class="keywordflow">else</span> {
01374         <span class="keywordflow">return</span> MultiByteToWideChar(Codepage,
01375                                    0,
01376                                    Source,
01377                                    SourceLength,
01378                                    Target,
01379                                    TargetLength);
01380     }
01381 }
01382 
01383 <span class="keywordtype">int</span>
<a name="l01384"></a><a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a37">01384</a> <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a37">ConvertOutputToUnicode</a>(
01385     IN UINT Codepage,
01386     IN LPSTR Source,
01387     IN <span class="keywordtype">int</span> SourceLength,    <span class="comment">// in chars</span>
01388     OUT LPWSTR Target,
01389     IN <span class="keywordtype">int</span> TargetLength     <span class="comment">// in chars</span>
01390     )
01391 <span class="comment">/*</span>
01392 <span class="comment">    output data is always translated via the ansi codepage</span>
01393 <span class="comment">    so glyph translation works.</span>
01394 <span class="comment">*/</span>
01395 
01396 {
01397     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01398     ULONG Length;
01399     <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> StackBuffer[<a class="code" href="../../d1/d7/server_8h.html#a95">STACK_BUFFER_SIZE</a>];
01400     LPSTR pszT;
01401 
01402     <a class="code" href="../../d8/d5/consrv_8h.html#a2">DBGCHARS</a>((<span class="stringliteral">"ConvertOutputToUnicode %d-&gt;U %.*s\n"</span>, Codepage,
01403             SourceLength &gt; 10 ? 10 : SourceLength, Source));
01404     <span class="keywordflow">if</span> (Codepage == <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a2">OEMCP</a>) {
01405         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d6/nlsxlat_8c.html#a42">RtlCustomCPToUnicodeN</a>(&amp;<a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a15">GlyphCP</a>,
01406                            Target,
01407                            TargetLength * <span class="keyword">sizeof</span>(WCHAR),
01408                            &amp;Length,
01409                            Source,
01410                            SourceLength
01411                           );
01412         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01413             <span class="keywordflow">return</span> 0;
01414         } <span class="keywordflow">else</span> {
01415             <span class="keywordflow">return</span> Length / <span class="keyword">sizeof</span>(WCHAR);
01416         }
01417     }
01418 
01419     <span class="keywordflow">if</span> (TargetLength &gt; <a class="code" href="../../d1/d7/server_8h.html#a95">STACK_BUFFER_SIZE</a>) {
01420         pszT = (LPSTR)<a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( <a class="code" href="../../d8/d5/consrv_8h.html#a9">TMP_TAG</a> ),SourceLength);
01421         <span class="keywordflow">if</span> (pszT == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01422             <span class="keywordflow">return</span> 0;
01423         }
01424     } <span class="keywordflow">else</span> {
01425         pszT = StackBuffer;
01426     }
01427     RtlCopyMemory(pszT, Source, SourceLength);
01428     Length = MultiByteToWideChar(Codepage, MB_USEGLYPHCHARS,
01429             pszT, SourceLength, Target, TargetLength);
01430     <span class="keywordflow">if</span> (pszT != StackBuffer) {
01431         <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(pszT);
01432     }
01433     <span class="keywordflow">return</span> Length;
01434 }
01435 
01436 <span class="preprocessor">#if defined(FE_SB)</span>
01437 <span class="preprocessor"></span>WCHAR
01438 SB_CharToWcharGlyph(
01439     IN UINT Codepage,
01440     IN <span class="keywordtype">char</span> Ch)
01441 #<span class="keywordflow">else</span>
01442 WCHAR
<a name="l01443"></a><a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a38">01443</a> <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a38">CharToWcharGlyph</a>(
01444     IN UINT Codepage,
01445     IN <span class="keywordtype">char</span> Ch)
01446 #endif
01447 {
01448     WCHAR wch;
01449     <span class="keywordflow">if</span> (Codepage == <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a2">OEMCP</a>) {
01450         <a class="code" href="../../d9/d6/nlsxlat_8c.html#a42">RtlCustomCPToUnicodeN</a>(&amp;<a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a15">GlyphCP</a>, &amp;wch, <span class="keyword">sizeof</span>(wch), <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, &amp;Ch, <span class="keyword">sizeof</span>(Ch));
01451     } <span class="keywordflow">else</span> {
01452         MultiByteToWideChar(Codepage, MB_USEGLYPHCHARS, &amp;Ch, 1, &amp;wch, 1);
01453     }
01454 <span class="preprocessor">#ifdef DEBUG_PRINT</span>
01455 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (Ch &gt; 0x7F) {
01456         <a class="code" href="../../d8/d5/consrv_8h.html#a2">DBGCHARS</a>((<span class="stringliteral">"CharToWcharGlyph %d 0x%02x -&gt; 0x%04x\n"</span>,Codepage,(UCHAR)Ch,wch));
01457     }
01458 <span class="preprocessor">#endif</span>
01459 <span class="preprocessor"></span>    <span class="keywordflow">return</span> wch;
01460 }
01461 
01462 <span class="preprocessor">#if defined(FE_SB)</span>
01463 <span class="preprocessor"></span>WCHAR
01464 SB_CharToWchar(
01465     IN UINT Codepage,
01466     IN <span class="keywordtype">char</span> Ch)
01467 #<span class="keywordflow">else</span>
01468 WCHAR
<a name="l01469"></a><a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a39">01469</a> <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a39">CharToWchar</a>(
01470     IN UINT Codepage,
01471     IN <span class="keywordtype">char</span> Ch)
01472 #endif
01473 {
01474     WCHAR wch;
01475     <span class="keywordflow">if</span> (Codepage == <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a2">OEMCP</a>) {
01476         <a class="code" href="../../d9/d6/nlsxlat_8c.html#a34">RtlOemToUnicodeN</a>(&amp;wch, <span class="keyword">sizeof</span>(wch), <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, &amp;Ch, <span class="keyword">sizeof</span>(Ch));
01477     } <span class="keywordflow">else</span> {
01478         MultiByteToWideChar(Codepage, 0, &amp;Ch, 1, &amp;wch, 1);
01479     }
01480 <span class="preprocessor">#ifdef DEBUG_PRINT</span>
01481 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (Ch &gt; 0x7F) {
01482         <a class="code" href="../../d8/d5/consrv_8h.html#a2">DBGCHARS</a>((<span class="stringliteral">"CharToWchar %d 0x%02x -&gt; 0x%04x\n"</span>,Codepage,(UCHAR)Ch,wch));
01483     }
01484 <span class="preprocessor">#endif</span>
01485 <span class="preprocessor"></span>    <span class="keywordflow">return</span> wch;
01486 }
01487 
01488 <span class="keywordtype">char</span>
<a name="l01489"></a><a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a40">01489</a> <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a40">WcharToChar</a>(
01490     IN UINT Codepage,
01491     IN WCHAR Wchar)
01492 {
01493     <span class="keywordtype">char</span> ch;
01494     <span class="keywordflow">if</span> (Codepage == <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a2">OEMCP</a>) {
01495         <a class="code" href="../../d9/d6/nlsxlat_8c.html#a39">RtlUnicodeToOemN</a>(&amp;ch, <span class="keyword">sizeof</span>(ch), <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, &amp;Wchar, <span class="keyword">sizeof</span>(Wchar));
01496     } <span class="keywordflow">else</span> {
01497         WideCharToMultiByte(Codepage, 0, &amp;Wchar, 1, &amp;ch, 1, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01498     }
01499 <span class="preprocessor">#ifdef DEBUG_PRINT</span>
01500 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (Wchar &gt; 0x007F) {
01501         <a class="code" href="../../d8/d5/consrv_8h.html#a2">DBGCHARS</a>((<span class="stringliteral">"WcharToChar %d 0x%04x -&gt; 0x%02x\n"</span>,Codepage,Wchar,(UCHAR)ch));
01502     }
01503 <span class="preprocessor">#endif</span>
01504 <span class="preprocessor"></span>    <span class="keywordflow">return</span> ch;
01505 }
01506 
01507 <span class="keywordtype">int</span>
<a name="l01508"></a><a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a41">01508</a> <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a41">ConvertOutputToOem</a>(
01509     IN UINT Codepage,
01510     IN LPWSTR Source,
01511     IN <span class="keywordtype">int</span> SourceLength,    <span class="comment">// in chars</span>
01512     OUT LPSTR Target,
01513     IN <span class="keywordtype">int</span> TargetLength     <span class="comment">// in chars</span>
01514     )
01515 <span class="comment">/*</span>
01516 <span class="comment">    Converts SourceLength Unicode characters from Source into</span>
01517 <span class="comment">    not more than TargetLength Codepage characters at Target.</span>
01518 <span class="comment">    Returns the number characters put in Target. (0 if failure)</span>
01519 <span class="comment">*/</span>
01520 
01521 {
01522     <span class="keywordflow">if</span> (Codepage == <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a2">OEMCP</a>) {
01523         <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01524         ULONG Length;
01525         <span class="comment">// Can do this in place</span>
01526         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d6/nlsxlat_8c.html#a39">RtlUnicodeToOemN</a>(Target,
01527                                   TargetLength,
01528                                   &amp;Length,
01529                                   Source,
01530                                   SourceLength * <span class="keyword">sizeof</span>(WCHAR)
01531                                  );
01532         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01533             <span class="keywordflow">return</span> Length;
01534         } <span class="keywordflow">else</span> {
01535             <span class="keywordflow">return</span> 0;
01536         }
01537     } <span class="keywordflow">else</span> {
01538         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Source != (LPWSTR)Target);
01539 <span class="preprocessor">#ifdef SOURCE_EQ_TARGET</span>
01540 <span class="preprocessor"></span>        LPSTR pszDestTmp;
01541         <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> StackBuffer[<a class="code" href="../../d1/d7/server_8h.html#a95">STACK_BUFFER_SIZE</a>];
01542 
01543         <a class="code" href="../../d8/d5/consrv_8h.html#a2">DBGCHARS</a>((<span class="stringliteral">"ConvertOutputToOem U-&gt;%d %.*ls\n"</span>, Codepage,
01544                 SourceLength &gt; 10 ? 10 : SourceLength, Source));
01545 
01546         <span class="keywordflow">if</span> (TargetLength &gt; <a class="code" href="../../d1/d7/server_8h.html#a95">STACK_BUFFER_SIZE</a>) {
01547             pszDestTmp = (LPSTR)<a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( <a class="code" href="../../d8/d5/consrv_8h.html#a9">TMP_TAG</a> ),TargetLength);
01548             <span class="keywordflow">if</span> (pszDestTmp == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01549                 <span class="keywordflow">return</span> 0;
01550             }
01551         } <span class="keywordflow">else</span> {
01552             pszDestTmp = StackBuffer;
01553         }
01554         TargetLength = WideCharToMultiByte(Codepage, 0,
01555                 Source, SourceLength,
01556                 pszDestTmp, TargetLength, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01557 
01558         RtlCopyMemory(Target, pszDestTmp, TargetLength);
01559         <span class="keywordflow">if</span> (pszDestTmp != StackBuffer) {
01560             <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(pszDestTmp);
01561         }
01562         <span class="keywordflow">return</span> TargetLength;
01563 <span class="preprocessor">#else</span>
01564 <span class="preprocessor"></span>        <a class="code" href="../../d8/d5/consrv_8h.html#a2">DBGCHARS</a>((<span class="stringliteral">"ConvertOutputToOem U-&gt;%d %.*ls\n"</span>, Codepage,
01565                 SourceLength &gt; 10 ? 10 : SourceLength, Source));
01566         <span class="keywordflow">return</span> WideCharToMultiByte(Codepage, 0,
01567                 Source, SourceLength, Target, TargetLength, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01568 <span class="preprocessor">#endif</span>
01569 <span class="preprocessor"></span>    }
01570 }
01571 
01572 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01573"></a><a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a42">01573</a> <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a42">RealUnicodeToFalseUnicode</a>(
01574     IN OUT LPWSTR Source,
01575     IN <span class="keywordtype">int</span> SourceLength,     <span class="comment">// in chars</span>
01576     IN UINT Codepage
01577     )
01578 
01579 <span class="comment">/*</span>
01580 <span class="comment"></span>
01581 <span class="comment">    this routine converts a unicode string into the correct characters</span>
01582 <span class="comment">    for an OEM (cp 437) font.  this code is needed because the gdi glyph</span>
01583 <span class="comment">    mapper converts unicode to ansi using codepage 1252 to index</span>
01584 <span class="comment">    font.  this is how the data is stored internally.</span>
01585 <span class="comment"></span>
01586 <span class="comment">*/</span>
01587 
01588 {
01589     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01590     LPSTR Temp;
01591     ULONG TempLength;
01592     ULONG Length;
01593     <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> StackBuffer[<a class="code" href="../../d1/d7/server_8h.html#a95">STACK_BUFFER_SIZE</a>];
01594     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> NormalChars;
01595     <span class="keywordtype">int</span> i;
01596 
01597     <a class="code" href="../../d8/d5/consrv_8h.html#a2">DBGCHARS</a>((<span class="stringliteral">"RealUnicodeToFalseUnicode U-&gt;%d:ACP-&gt;U %.*ls\n"</span>, Codepage,
01598             SourceLength &gt; 10 ? 10 : SourceLength, Source));
01599 <span class="preprocessor">#if defined(FE_SB)</span>
01600 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a2">OEMCP</a> == <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a3">WINDOWSCP</a> &amp;&amp; Codepage == <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a3">WINDOWSCP</a>)
01601         <span class="keywordflow">return</span> STATUS_SUCCESS;
01602     <span class="keywordflow">if</span> (SourceLength == 0 )
01603         <span class="keywordflow">return</span> STATUS_SUCCESS;
01604 <span class="preprocessor">#endif</span>
01605 <span class="preprocessor"></span>    NormalChars = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01606     <span class="keywordflow">for</span> (i=0;i&lt;SourceLength;i++) {
01607         <span class="keywordflow">if</span> (Source[i] &gt; 0x7f) {
01608             NormalChars = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01609             <span class="keywordflow">break</span>;
01610         }
01611     }
01612     <span class="keywordflow">if</span> (NormalChars) {
01613         <span class="keywordflow">return</span> STATUS_SUCCESS;
01614     }
01615     TempLength = SourceLength;
01616     <span class="keywordflow">if</span> (TempLength &gt; <a class="code" href="../../d1/d7/server_8h.html#a95">STACK_BUFFER_SIZE</a>) {
01617         Temp = (LPSTR)<a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( <a class="code" href="../../d8/d5/consrv_8h.html#a9">TMP_TAG</a> ),TempLength);
01618         <span class="keywordflow">if</span> (Temp == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01619             <span class="keywordflow">return</span> STATUS_NO_MEMORY;
01620         }
01621     } <span class="keywordflow">else</span> {
01622         Temp = StackBuffer;
01623     }
01624     <span class="keywordflow">if</span> (Codepage == <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a2">OEMCP</a>) {
01625         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d6/nlsxlat_8c.html#a39">RtlUnicodeToOemN</a>(Temp,
01626                                   TempLength,
01627                                   &amp;Length,
01628                                   Source,
01629                                   SourceLength * <span class="keyword">sizeof</span>(WCHAR)
01630                                  );
01631     } <span class="keywordflow">else</span> {
01632         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = WideCharToMultiByte(Codepage,
01633                                    0,
01634                                    Source,
01635                                    SourceLength,
01636                                    Temp,
01637                                    TempLength,
01638                                    <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01639                                    <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01640     }
01641     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01642         <span class="keywordflow">if</span> (TempLength &gt; <a class="code" href="../../d1/d7/server_8h.html#a95">STACK_BUFFER_SIZE</a>) {
01643             <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(Temp);
01644         }
01645         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01646     }
01647 
01648     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/consrv_8h.html#a32">CONSOLE_IS_DBCS_ENABLED</a>()) {
01649         MultiByteToWideChar(<a class="code" href="../../d0/d3/dbcs_8h.html#a5">USACP</a>,
01650                         0,
01651                         Temp,
01652                         TempLength,
01653                         Source,
01654                         SourceLength
01655                        );
01656     } <span class="keywordflow">else</span> {
01657         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d6/nlsxlat_8c.html#a33">RtlMultiByteToUnicodeN</a>(Source,
01658                            SourceLength * <span class="keyword">sizeof</span>(WCHAR),
01659                            &amp;Length,
01660                            Temp,
01661                            TempLength
01662                           );
01663     }
01664 
01665     <span class="keywordflow">if</span> (TempLength &gt; <a class="code" href="../../d1/d7/server_8h.html#a95">STACK_BUFFER_SIZE</a>) {
01666         <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(Temp);
01667     }
01668     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01669         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01670     } <span class="keywordflow">else</span> {
01671         <span class="keywordflow">return</span> STATUS_SUCCESS;
01672     }
01673 }
01674 
01675 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01676"></a><a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a43">01676</a> <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a43">FalseUnicodeToRealUnicode</a>(
01677     IN OUT LPWSTR Source,
01678     IN <span class="keywordtype">int</span> SourceLength,     <span class="comment">// in chars</span>
01679     IN UINT Codepage
01680     )
01681 
01682 <span class="comment">/*</span>
01683 <span class="comment"></span>
01684 <span class="comment">    this routine converts a unicode string from the internally stored</span>
01685 <span class="comment">    unicode characters into the real unicode characters.</span>
01686 <span class="comment"></span>
01687 <span class="comment">*/</span>
01688 
01689 {
01690     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01691     LPSTR Temp;
01692     ULONG TempLength;
01693     ULONG Length;
01694     <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> StackBuffer[<a class="code" href="../../d1/d7/server_8h.html#a95">STACK_BUFFER_SIZE</a>];
01695     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> NormalChars;
01696     <span class="keywordtype">int</span> i;
01697 
01698     <a class="code" href="../../d8/d5/consrv_8h.html#a2">DBGCHARS</a>((<span class="stringliteral">"UnicodeAnsiToUnicodeAnsi U-&gt;ACP:%d-&gt;U %.*ls\n"</span>, Codepage,
01699             SourceLength &gt; 10 ? 10 : SourceLength, Source));
01700 <span class="preprocessor">#if defined(FE_SB)</span>
01701 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a2">OEMCP</a> == <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a3">WINDOWSCP</a> &amp;&amp; Codepage == <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a3">WINDOWSCP</a>)
01702         <span class="keywordflow">return</span> STATUS_SUCCESS;
01703     <span class="keywordflow">if</span> (SourceLength == 0 )
01704         <span class="keywordflow">return</span> STATUS_SUCCESS;
01705 <span class="preprocessor">#endif</span>
01706 <span class="preprocessor"></span>    NormalChars = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01707     <span class="comment">/*</span>
01708 <span class="comment">     * Test for characters &lt; 0x20 or &gt;= 0x7F.  If none are found, we don't have</span>
01709 <span class="comment">     * any conversion to do!</span>
01710 <span class="comment">     */</span>
01711     <span class="keywordflow">for</span> (i=0;i&lt;SourceLength;i++) {
01712         <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(Source[i] - 0x20) &gt; 0x5e) {
01713             NormalChars = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01714             <span class="keywordflow">break</span>;
01715         }
01716     }
01717     <span class="keywordflow">if</span> (NormalChars) {
01718         <span class="keywordflow">return</span> STATUS_SUCCESS;
01719     }
01720 
01721     TempLength = SourceLength;
01722     <span class="keywordflow">if</span> (TempLength &gt; <a class="code" href="../../d1/d7/server_8h.html#a95">STACK_BUFFER_SIZE</a>) {
01723         Temp = (LPSTR)<a class="code" href="../../d8/d5/consrv_8h.html#a36">ConsoleHeapAlloc</a>(<a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( <a class="code" href="../../d8/d5/consrv_8h.html#a9">TMP_TAG</a> ),TempLength);
01724         <span class="keywordflow">if</span> (Temp == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01725             <span class="keywordflow">return</span> STATUS_NO_MEMORY;
01726         }
01727     } <span class="keywordflow">else</span> {
01728         Temp = StackBuffer;
01729     }
01730     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/consrv_8h.html#a32">CONSOLE_IS_DBCS_ENABLED</a>()) {
01731         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = WideCharToMultiByte(<a class="code" href="../../d0/d3/dbcs_8h.html#a5">USACP</a>,
01732                                  0,
01733                                  Source,
01734                                  SourceLength,
01735                                  Temp,
01736                                  TempLength,
01737                                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01738                                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01739     } <span class="keywordflow">else</span> {
01740         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d6/nlsxlat_8c.html#a37">RtlUnicodeToMultiByteN</a>(Temp,
01741                                     TempLength,
01742                                     &amp;Length,
01743                                     Source,
01744                                     SourceLength * <span class="keyword">sizeof</span>(WCHAR)
01745                                    );
01746     }
01747 
01748     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01749         <span class="keywordflow">if</span> (TempLength &gt; <a class="code" href="../../d1/d7/server_8h.html#a95">STACK_BUFFER_SIZE</a>) {
01750             <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(Temp);
01751         }
01752         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01753     }
01754     <span class="keywordflow">if</span> (Codepage == <a class="code" href="../../d6/d6/ntcon_2server_2globals_8h.html#a2">OEMCP</a>) {
01755         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d6/nlsxlat_8c.html#a42">RtlCustomCPToUnicodeN</a>(&amp;<a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a15">GlyphCP</a>,
01756                                   Source,
01757                                   SourceLength * <span class="keyword">sizeof</span>(WCHAR),
01758                                   &amp;Length,
01759                                   Temp,
01760                                   TempLength
01761                                  );
01762     } <span class="keywordflow">else</span> {
01763         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = MultiByteToWideChar(Codepage,
01764                                    MB_USEGLYPHCHARS,
01765                                    Temp,
01766                                    TempLength*<span class="keyword">sizeof</span>(WCHAR),
01767                                    Source,
01768                                    SourceLength);
01769     }
01770 <span class="preprocessor">#if defined(FE_SB)</span>
01771 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (SourceLength &gt; <a class="code" href="../../d1/d7/server_8h.html#a95">STACK_BUFFER_SIZE</a>) {
01772         <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(Temp);
01773     }
01774 <span class="preprocessor">#else</span>
01775 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (TempLength &gt; <a class="code" href="../../d1/d7/server_8h.html#a95">STACK_BUFFER_SIZE</a>) {
01776         <a class="code" href="../../d8/d5/consrv_8h.html#a38">ConsoleHeapFree</a>(Temp);
01777     }
01778 <span class="preprocessor">#endif</span>
01779 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01780         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01781     } <span class="keywordflow">else</span> {
01782         <span class="keywordflow">return</span> STATUS_SUCCESS;
01783     }
01784 }
01785 
01786 
<a name="l01787"></a><a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a44">01787</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a44">InitializeCustomCP</a>() {
01788     PPEB pPeb;
01789 
01790     pPeb = NtCurrentPeb();
01791     <span class="keywordflow">if</span> ((pPeb == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) || (pPeb-&gt;OemCodePageData == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
01792         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01793     }
01794 
01795     <span class="comment">/*</span>
01796 <span class="comment">     * Fill in the CPTABLEINFO struct</span>
01797 <span class="comment">     */</span>
01798     <a class="code" href="../../d9/d6/nlsxlat_8c.html#a45">RtlInitCodePageTable</a>(pPeb-&gt;OemCodePageData, &amp;<a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a15">GlyphCP</a>);
01799 
01800     <span class="comment">/*</span>
01801 <span class="comment">     * Make a copy of the MultiByteToWideChar table</span>
01802 <span class="comment">     */</span>
01803     RtlCopyMemory(<a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a16">GlyphTable</a>, <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a15">GlyphCP</a>.MultiByteTable, 256 * <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>));
01804 
01805     <span class="comment">/*</span>
01806 <span class="comment">     * Modify the first 0x20 bytes so that they are glyphs.</span>
01807 <span class="comment">     */</span>
01808     MultiByteToWideChar(CP_OEMCP, MB_USEGLYPHCHARS,
01809             <span class="stringliteral">"\x20\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0A\x0B\x0C\x0D\x0E\x0F"</span>
01810             <span class="stringliteral">"\x10\x11\x12\x13\x14\x15\x16\x17\x18\x19\x1A\x1B\x1C\x1D\x1E\x1F"</span>,
01811             0x20, <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a16">GlyphTable</a>, 0x20);
01812     MultiByteToWideChar(CP_OEMCP, MB_USEGLYPHCHARS,
01813             <span class="stringliteral">"\x7f"</span>, 1, &amp;<a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a16">GlyphTable</a>[0x7f], 1);
01814 
01815 
01816     <span class="comment">/*</span>
01817 <span class="comment">     * Point the Custom CP at the glyph table</span>
01818 <span class="comment">     */</span>
01819     <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a15">GlyphCP</a>.MultiByteTable = <a class="code" href="../../d4/d0/w32_2ntcon_2server_2misc_8c.html#a16">GlyphTable</a>;
01820 
01821 <span class="preprocessor">#if defined(FE_SB) &amp;&amp; defined(i386)</span>
01822 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (ISNECPC98(gdwMachineId)) {
01823         InitializeNEC_OS2_CP();
01824     }
01825 <span class="preprocessor">#endif</span>
01826 <span class="preprocessor"></span>    <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01827 }
01828 
01829 <span class="preprocessor">#if defined(FE_SB)</span>
01830 <span class="preprocessor"></span><a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
01831 SetConsoleCPInfo(
01832     IN <a class="code" href="../../d1/d3/struct__CONSOLE__INFORMATION.html">PCONSOLE_INFORMATION</a> Console,
01833     IN BOOL Output
01834     )
01835 {
01836     <span class="keywordflow">if</span> (Output) {
01837         <span class="keywordflow">if</span> (! GetCPInfo(Console-&gt;OutputCP,
01838                         &amp;Console-&gt;OutputCPInfo)) {
01839             Console-&gt;OutputCPInfo.LeadByte[0] = 0;
01840         }
01841     }
01842     <span class="keywordflow">else</span> {
01843         <span class="keywordflow">if</span> (! GetCPInfo(Console-&gt;CP,
01844                         &amp;Console-&gt;CPInfo)) {
01845             Console-&gt;CPInfo.LeadByte[0] = 0;
01846         }
01847     }
01848 }
01849 
01850 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
01851 CheckBisectStringW(
01852     IN <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo,
01853     IN DWORD CodePage,
01854     IN PWCHAR Buffer,
01855     IN DWORD NumWords,
01856     IN DWORD NumBytes
01857     )
01858 
01859 <span class="comment">/*++</span>
01860 <span class="comment"></span>
01861 <span class="comment">Routine Description:</span>
01862 <span class="comment"></span>
01863 <span class="comment">    This routine check bisected on Unicode string end.</span>
01864 <span class="comment"></span>
01865 <span class="comment">Arguments:</span>
01866 <span class="comment"></span>
01867 <span class="comment">    ScreenInfo - Pointer to screen information structure.</span>
01868 <span class="comment"></span>
01869 <span class="comment">    CodePage - Value of code page.</span>
01870 <span class="comment"></span>
01871 <span class="comment">    Buffer - Pointer to Unicode string buffer.</span>
01872 <span class="comment"></span>
01873 <span class="comment">    NumWords - Number of Unicode string.</span>
01874 <span class="comment"></span>
01875 <span class="comment">    NumBytes - Number of bisect position by byte counts.</span>
01876 <span class="comment"></span>
01877 <span class="comment">Return Value:</span>
01878 <span class="comment"></span>
01879 <span class="comment">    TRUE - Bisected character.</span>
01880 <span class="comment"></span>
01881 <span class="comment">    FALSE - Correctly.</span>
01882 <span class="comment"></span>
01883 <span class="comment">--*/</span>
01884 
01885 {
01886     <span class="keywordflow">while</span>(NumWords &amp;&amp; NumBytes) {
01887         <span class="keywordflow">if</span> (IsConsoleFullWidth(ScreenInfo-&gt;Console-&gt;hDC,CodePage,*Buffer)) {
01888             <span class="keywordflow">if</span> (NumBytes &lt; 2)
01889                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01890             <span class="keywordflow">else</span> {
01891                 NumWords--;
01892                 NumBytes -= 2;
01893                 <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>++;
01894             }
01895         }
01896         <span class="keywordflow">else</span> {
01897             NumWords--;
01898             NumBytes--;
01899             <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>++;
01900         }
01901     }
01902     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01903 }
01904 
01905 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>
01906 CheckBisectProcessW(
01907     IN <a class="code" href="../../d7/d8/struct__SCREEN__INFORMATION.html">PSCREEN_INFORMATION</a> ScreenInfo,
01908     IN DWORD CodePage,
01909     IN PWCHAR Buffer,
01910     IN DWORD NumWords,
01911     IN DWORD NumBytes,
01912     IN SHORT OriginalXPosition,
01913     IN BOOL Echo
01914     )
01915 
01916 <span class="comment">/*++</span>
01917 <span class="comment"></span>
01918 <span class="comment">Routine Description:</span>
01919 <span class="comment"></span>
01920 <span class="comment">    This routine check bisected on Unicode string end.</span>
01921 <span class="comment"></span>
01922 <span class="comment">Arguments:</span>
01923 <span class="comment"></span>
01924 <span class="comment">    ScreenInfo - Pointer to screen information structure.</span>
01925 <span class="comment"></span>
01926 <span class="comment">    CodePage - Value of code page.</span>
01927 <span class="comment"></span>
01928 <span class="comment">    Buffer - Pointer to Unicode string buffer.</span>
01929 <span class="comment"></span>
01930 <span class="comment">    NumWords - Number of Unicode string.</span>
01931 <span class="comment"></span>
01932 <span class="comment">    NumBytes - Number of bisect position by byte counts.</span>
01933 <span class="comment"></span>
01934 <span class="comment">    Echo - TRUE if called by Read (echoing characters)</span>
01935 <span class="comment"></span>
01936 <span class="comment">Return Value:</span>
01937 <span class="comment"></span>
01938 <span class="comment">    TRUE - Bisected character.</span>
01939 <span class="comment"></span>
01940 <span class="comment">    FALSE - Correctly.</span>
01941 <span class="comment"></span>
01942 <span class="comment">--*/</span>
01943 
01944 {
01945     WCHAR Char;
01946     ULONG TabSize;
01947 
01948     <span class="keywordflow">if</span> (ScreenInfo-&gt;OutputMode &amp; ENABLE_PROCESSED_OUTPUT) {
01949         <span class="keywordflow">while</span>(NumWords &amp;&amp; NumBytes) {
01950             Char = *<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
01951             <span class="keywordflow">if</span> (Char &gt;= (WCHAR)<span class="charliteral">' '</span>) {
01952                 <span class="keywordflow">if</span> (IsConsoleFullWidth(ScreenInfo-&gt;Console-&gt;hDC,CodePage,Char)) {
01953                     <span class="keywordflow">if</span> (NumBytes &lt; 2)
01954                         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01955                     <span class="keywordflow">else</span> {
01956                         NumWords--;
01957                         NumBytes -= 2;
01958                         <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>++;
01959                         OriginalXPosition += 2;
01960                     }
01961                 }
01962                 <span class="keywordflow">else</span> {
01963                     NumWords--;
01964                     NumBytes--;
01965                     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>++;
01966                     OriginalXPosition++;
01967                 }
01968             }
01969             <span class="keywordflow">else</span> {
01970                 NumWords--;
01971                 <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>++;
01972                 <span class="keywordflow">switch</span> (Char) {
01973                     <span class="keywordflow">case</span> <a class="code" href="../../d4/d5/conimep_8h.html#a55">UNICODE_BELL</a>:
01974                         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d1/xcpt4_8c.html#a6">Echo</a>)
01975                             <span class="keywordflow">goto</span> CtrlChar;
01976                         <span class="keywordflow">break</span>;
01977                     <span class="keywordflow">case</span> <a class="code" href="../../d4/d5/conimep_8h.html#a51">UNICODE_BACKSPACE</a>:
01978                     <span class="keywordflow">case</span> <a class="code" href="../../d4/d5/conimep_8h.html#a54">UNICODE_LINEFEED</a>:
01979                     <span class="keywordflow">case</span> <a class="code" href="../../d4/d5/conimep_8h.html#a53">UNICODE_CARRIAGERETURN</a>:
01980                         <span class="keywordflow">break</span>;
01981                     <span class="keywordflow">case</span> <a class="code" href="../../d9/d5/verifier_8c.html#a3">UNICODE_TAB</a>:
01982                         TabSize = <a class="code" href="../../d9/d3/input_8h.html#a11">NUMBER_OF_SPACES_IN_TAB</a>(OriginalXPosition);
01983                         OriginalXPosition = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(OriginalXPosition + TabSize);
01984                         <span class="keywordflow">if</span> (NumBytes &lt; TabSize)
01985                             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01986                         NumBytes -= TabSize;
01987                         <span class="keywordflow">break</span>;
01988                     <span class="keywordflow">default</span>:
01989                         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d1/xcpt4_8c.html#a6">Echo</a>) {
01990                     CtrlChar:
01991                             <span class="keywordflow">if</span> (NumBytes &lt; 2)
01992                                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01993                             NumBytes -= 2;
01994                             OriginalXPosition += 2;
01995                         } <span class="keywordflow">else</span> {
01996                             NumBytes--;
01997                             OriginalXPosition++;
01998                         }
01999                 }
02000             }
02001         }
02002         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02003     }
02004     <span class="keywordflow">else</span> {
02005         <span class="keywordflow">return</span> CheckBisectStringW(ScreenInfo,
02006                                   CodePage,
02007                                   Buffer,
02008                                   NumWords,
02009                                   NumBytes);
02010     }
02011 }
02012 <span class="preprocessor">#endif // FE_SB</span>
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:49 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
