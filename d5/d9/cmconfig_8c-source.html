<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: cmconfig.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>cmconfig.c</h1><a href="../../d4/d0/cmconfig_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1990, 1991  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment"></span>
00006 <span class="comment">Module Name:</span>
00007 <span class="comment"></span>
00008 <span class="comment">    cmconfig.c</span>
00009 <span class="comment"></span>
00010 <span class="comment">Abstract:</span>
00011 <span class="comment"></span>
00012 <span class="comment">    This module is responsible to build the hardware tree of the</span>
00013 <span class="comment">    registry data base.</span>
00014 <span class="comment"></span>
00015 <span class="comment">Author:</span>
00016 <span class="comment"></span>
00017 <span class="comment">    Shie-Lin Tzong (shielint) 23-Jan-1992</span>
00018 <span class="comment"></span>
00019 <span class="comment"></span>
00020 <span class="comment">Environment:</span>
00021 <span class="comment"></span>
00022 <span class="comment">    Kernel mode.</span>
00023 <span class="comment"></span>
00024 <span class="comment">Revision History:</span>
00025 <span class="comment"></span>
00026 <span class="comment">--*/</span>
00027 
00028 <span class="preprocessor">#include "<a class="code" href="../../d1/d2/cmp_8h.html">cmp.h</a>"</span>
00029 
00030 <span class="comment">//</span>
00031 <span class="comment">// Title Index - Never used for Product 1, set to 0 for now.</span>
00032 <span class="comment">//</span>
00033 
<a name="l00034"></a><a class="code" href="../../d4/d0/cmconfig_8c.html#a0">00034</a> <span class="preprocessor">#define TITLE_INDEX_VALUE 0</span>
00035 <span class="preprocessor"></span>
00036 
<a name="l00037"></a><a class="code" href="../../d4/d0/cmconfig_8c.html#a3">00037</a> <span class="keyword">extern</span> ULONG <a class="code" href="../../d4/d0/cmconfig_8c.html#a3">CmpTypeCount</a>[];
00038 
00039 
<a name="l00040"></a><a class="code" href="../../d4/d0/cmconfig_8c.html#a1">00040</a> <span class="preprocessor">#define EISA_ADAPTER_INDEX EisaAdapter</span>
<a name="l00041"></a><a class="code" href="../../d4/d0/cmconfig_8c.html#a2">00041</a> <span class="preprocessor"></span><span class="preprocessor">#define TURBOCHANNEL_ADAPTER_INDEX TcAdapter</span>
00042 <span class="preprocessor"></span>
00043 <span class="comment">//</span>
00044 <span class="comment">// The following variables are used to cross-reference multifunction</span>
00045 <span class="comment">// adapters to their corresponding NT interface type.</span>
00046 <span class="comment">//</span>
00047 
00048 <span class="keyword">extern</span> <span class="keyword">struct </span>{
<a name="l00049"></a><a class="code" href="../../d4/d0/cmconfig_8c.html#a4">00049</a>     PUCHAR  <a class="code" href="../../d4/d0/cmconfig_8c.html#a4">AscString</a>;
<a name="l00050"></a><a class="code" href="../../d4/d0/cmconfig_8c.html#a5">00050</a>     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>  <a class="code" href="../../d4/d0/cmconfig_8c.html#a5">InterfaceType</a>;
<a name="l00051"></a><a class="code" href="../../d4/d0/cmconfig_8c.html#a6">00051</a>     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>  <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>;
00052 } <a class="code" href="../../d4/d0/cmconfig_8c.html#a7">CmpMultifunctionTypes</a>[];
00053 
<a name="l00054"></a><a class="code" href="../../d4/d0/cmconfig_8c.html#a8">00054</a> <span class="keyword">extern</span> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> <a class="code" href="../../d4/d0/cmconfig_8c.html#a8">CmpUnknownBusCount</a>;
00055 
00056 
00057 <span class="comment">//</span>
00058 <span class="comment">// CmpConfigurationData - A pointer to the area reserved for the purpose</span>
00059 <span class="comment">//     of reconstructing Configuration Data.</span>
00060 <span class="comment">//</span>
00061 <span class="comment">// CmpConfigurationAreaSize - Record the size of the Configuration Data</span>
00062 <span class="comment">//     area.</span>
00063 
<a name="l00064"></a><a class="code" href="../../d4/d0/cmconfig_8c.html#a9">00064</a> <span class="keyword">extern</span> ULONG <a class="code" href="../../d4/d0/cmconfig_8c.html#a9">CmpConfigurationAreaSize</a>;
<a name="l00065"></a><a class="code" href="../../d4/d0/cmconfig_8c.html#a10">00065</a> <span class="keyword">extern</span> PCM_FULL_RESOURCE_DESCRIPTOR <a class="code" href="../../d4/d0/cmconfig_8c.html#a10">CmpConfigurationData</a>;
00066 
00067 <span class="comment">//</span>
00068 <span class="comment">// Function prototypes for internal erferences</span>
00069 <span class="comment">//</span>
00070 
00071 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00072 <a class="code" href="../../d4/d0/cmconfig_8c.html#a11">CmpSetupConfigurationTree</a>(
00073      IN <a class="code" href="../../d5/d8/struct__CONFIGURATION__COMPONENT__DATA.html">PCONFIGURATION_COMPONENT_DATA</a> CurrentEntry,
00074      IN HANDLE ParentHandle,
00075      IN INTERFACE_TYPE InterfaceType,
00076      IN ULONG <a class="code" href="../../d2/d7/hal_8h.html#a75">BusNumber</a>
00077      );
00078 
00079 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00080 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,CmpInitializeHardwareConfiguration)</span>
00081 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,CmpSetupConfigurationTree)</span>
00082 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT,CmpInitializeRegistryNode)</span>
00083 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00084 <span class="preprocessor"></span>
00085 
00086 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00087"></a><a class="code" href="../../d1/d2/cmp_8h.html#a272">00087</a> <a class="code" href="../../d1/d2/cmp_8h.html#a272">CmpInitializeHardwareConfiguration</a>(
00088     IN <a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a> LoaderBlock
00089     )
00090 <span class="comment">/*++</span>
00091 <span class="comment"></span>
00092 <span class="comment">Routine Description:</span>
00093 <span class="comment"></span>
00094 <span class="comment">    This routine creates \\Registry\Machine\Hardware node in</span>
00095 <span class="comment">    the registry and calls SetupTree routine to put the hardware</span>
00096 <span class="comment">    information to the registry.</span>
00097 <span class="comment"></span>
00098 <span class="comment">Arguments:</span>
00099 <span class="comment"></span>
00100 <span class="comment">    LoaderBlock - supplies a pointer to the LoaderBlock passed in from the</span>
00101 <span class="comment">                  OS Loader.</span>
00102 <span class="comment"></span>
00103 <span class="comment">Returns:</span>
00104 <span class="comment"></span>
00105 <span class="comment">    NTSTATUS code for sucess or reason of failure.</span>
00106 <span class="comment"></span>
00107 <span class="comment">--*/</span>
00108 {
00109     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00110     OBJECT_ATTRIBUTES <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>;
00111     HANDLE BaseHandle;
00112     <a class="code" href="../../d5/d8/struct__CONFIGURATION__COMPONENT__DATA.html">PCONFIGURATION_COMPONENT_DATA</a> ConfigurationRoot;
00113     ULONG Disposition;
00114 
00115     ConfigurationRoot = (<a class="code" href="../../d5/d8/struct__CONFIGURATION__COMPONENT__DATA.html">PCONFIGURATION_COMPONENT_DATA</a>)LoaderBlock-&gt;ConfigurationRoot;
00116     <span class="keywordflow">if</span> (ConfigurationRoot) {
00117 
00118 <span class="preprocessor">#ifdef _X86_</span>
00119 <span class="preprocessor"></span>
00120         <span class="comment">//</span>
00121         <span class="comment">//  The following strings found in the registry identify obscure,</span>
00122         <span class="comment">//  yet market dominant, non PC/AT compatible i386 machine in Japan.</span>
00123         <span class="comment">//</span>
00124 
00125 <span class="preprocessor">#define MACHINE_TYPE_FUJITSU_FMR_NAME_A    "FUJITSU FMR-"</span>
00126 <span class="preprocessor"></span><span class="preprocessor">#define MACHINE_TYPE_NEC_PC98_NAME_A       "NEC PC-98"</span>
00127 <span class="preprocessor"></span>
00128         {
00129             <a class="code" href="../../d5/d8/struct__CONFIGURATION__COMPONENT__DATA.html">PCONFIGURATION_COMPONENT_DATA</a> SystemNode;
00130             ULONG JapanMachineId;
00131 
00132             <span class="comment">//</span>
00133             <span class="comment">// For Japan, we have to special case some non PC/AT machines, so</span>
00134             <span class="comment">// determine at this time what kind of platform we are on:</span>
00135             <span class="comment">//</span>
00136             <span class="comment">// NEC PC9800 Compatibles/Fujitsu FM-R Compatibles/IBM PC/AT Compatibles</span>
00137             <span class="comment">//</span>
00138             <span class="comment">// Default is PC/AT compatible.</span>
00139             <span class="comment">//</span>
00140 
00141             JapanMachineId = MACHINE_TYPE_PC_AT_COMPATIBLE;
00142 
00143             <span class="comment">//</span>
00144             <span class="comment">// Find the hardware description node</span>
00145             <span class="comment">//</span>
00146 
00147             SystemNode = <a class="code" href="../../d9/d4/config_8c.html#a0">KeFindConfigurationEntry</a>(ConfigurationRoot,
00148                                                   <a class="code" href="../../d1/d9/arc_8h.html#a314a179">SystemClass</a>,
00149                                                   <a class="code" href="../../d1/d9/arc_8h.html#a315a227">MaximumType</a>,
00150                                                   <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00151 
00152             <span class="comment">//</span>
00153             <span class="comment">// Did we find something?</span>
00154             <span class="comment">//</span>
00155 
00156             <span class="keywordflow">if</span> (SystemNode) {
00157 
00158                 <span class="comment">//</span>
00159                 <span class="comment">// Check platform from identifier string</span>
00160                 <span class="comment">//</span>
00161 
00162                 <span class="keywordflow">if</span> (RtlCompareMemory(SystemNode-&gt;<a class="code" href="../../d5/d8/struct__CONFIGURATION__COMPONENT__DATA.html#o3">ComponentEntry</a>.<a class="code" href="../../d4/d8/struct__CONFIGURATION__COMPONENT.html#o9">Identifier</a>,
00163                                      MACHINE_TYPE_NEC_PC98_NAME_A,
00164                                      <span class="keyword">sizeof</span>(MACHINE_TYPE_NEC_PC98_NAME_A) - 1) ==
00165                     <span class="keyword">sizeof</span>(MACHINE_TYPE_NEC_PC98_NAME_A) - 1) {
00166 
00167                     <span class="comment">//</span>
00168                     <span class="comment">// we are running on NEC PC-9800 comaptibles.</span>
00169                     <span class="comment">//</span>
00170 
00171                     JapanMachineId = MACHINE_TYPE_PC_9800_COMPATIBLE;
00172                     SetNEC_98;
00173 
00174                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (RtlCompareMemory(SystemNode-&gt;<a class="code" href="../../d5/d8/struct__CONFIGURATION__COMPONENT__DATA.html#o3">ComponentEntry</a>.<a class="code" href="../../d4/d8/struct__CONFIGURATION__COMPONENT.html#o9">Identifier</a>,
00175                                             MACHINE_TYPE_FUJITSU_FMR_NAME_A,
00176                                             <span class="keyword">sizeof</span>(MACHINE_TYPE_FUJITSU_FMR_NAME_A) - 1) ==
00177                            <span class="keyword">sizeof</span>(MACHINE_TYPE_FUJITSU_FMR_NAME_A) - 1) {
00178 
00179                     <span class="comment">//</span>
00180                     <span class="comment">// we are running on Fujitsu FMR comaptibles.</span>
00181                     <span class="comment">//</span>
00182 
00183                     JapanMachineId = MACHINE_TYPE_FMR_COMPATIBLE;
00184                 }
00185             }
00186 
00187             <span class="comment">//</span>
00188             <span class="comment">//  Now 'or' this value into the kernel global.</span>
00189             <span class="comment">//</span>
00190 
00191             <a class="code" href="../../d7/d3/i386init_8c.html#a1">KeI386MachineType</a> |= JapanMachineId;
00192         }
00193 <span class="preprocessor">#endif //_X86_</span>
00194 <span class="preprocessor"></span>
00195         <span class="comment">//</span>
00196         <span class="comment">// Create \\Registry\Machine\Hardware\DeviceMap</span>
00197         <span class="comment">//</span>
00198 
00199         InitializeObjectAttributes(
00200             &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00201             &amp;<a class="code" href="../../d6/d0/cmdat_8c.html#a18">CmRegistryMachineHardwareDeviceMapName</a>,
00202             0,
00203             (HANDLE)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00204             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00205             );
00206         <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>.Attributes |= OBJ_CASE_INSENSITIVE;
00207 
00208         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a14">NtCreateKey</a>(                   <span class="comment">// Paht may already exist</span>
00209                     &amp;BaseHandle,
00210                     KEY_READ | KEY_WRITE,
00211                     &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00212                     <a class="code" href="../../d4/d1/config_2alpha_2init_8c.html#a0">TITLE_INDEX_VALUE</a>,
00213                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00214                     0,
00215                     &amp;Disposition
00216                     );
00217 
00218         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00219             <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00220         }
00221 
00222         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(BaseHandle);
00223 
00224         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Disposition == REG_CREATED_NEW_KEY);
00225 
00226         <span class="comment">//</span>
00227         <span class="comment">// Create \\Registry\Machine\Hardware\Description and use the</span>
00228         <span class="comment">// returned handle as the BaseHandle to build the hardware tree.</span>
00229         <span class="comment">//</span>
00230 
00231         InitializeObjectAttributes(
00232             &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00233             &amp;<a class="code" href="../../d6/d0/cmdat_8c.html#a16">CmRegistryMachineHardwareDescriptionName</a>,
00234             0,
00235             (HANDLE)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00236             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00237             );
00238         <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>.Attributes |= OBJ_CASE_INSENSITIVE;
00239 
00240         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a14">NtCreateKey</a>(                   <span class="comment">// Path may already exist</span>
00241                     &amp;BaseHandle,
00242                     KEY_READ | KEY_WRITE,
00243                     &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00244                     <a class="code" href="../../d4/d1/config_2alpha_2init_8c.html#a0">TITLE_INDEX_VALUE</a>,
00245                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00246                     0,
00247                     &amp;Disposition
00248                     );
00249 
00250         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00251             <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00252         }
00253 
00254         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Disposition == REG_CREATED_NEW_KEY);
00255 
00256         <span class="comment">//</span>
00257         <span class="comment">// Allocate 16K bytes memory from paged pool for constructing</span>
00258         <span class="comment">// configuration data for controller component.</span>
00259         <span class="comment">// NOTE:  The configuration Data for controller component</span>
00260         <span class="comment">//    usually takes less than 100 bytes.  But on EISA machine, the</span>
00261         <span class="comment">//    EISA configuration information takes more than 10K and up to</span>
00262         <span class="comment">//    64K.  I believe 16K is the reasonable number to handler 99.9%</span>
00263         <span class="comment">//    of the machines.  Therefore, 16K is the initial value.</span>
00264         <span class="comment">//</span>
00265 
00266         <a class="code" href="../../d4/d0/cmconfig_8c.html#a10">CmpConfigurationData</a> = (PCM_FULL_RESOURCE_DESCRIPTOR)<a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(
00267                                             <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
00268                                             <a class="code" href="../../d4/d0/cmconfig_8c.html#a9">CmpConfigurationAreaSize</a>
00269                                             );
00270 
00271         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/cmconfig_8c.html#a10">CmpConfigurationData</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00272             <span class="keywordflow">return</span>(STATUS_INSUFFICIENT_RESOURCES);
00273         }
00274 
00275         <span class="comment">//</span>
00276         <span class="comment">// Call SetupConfigurationTree routine to go over each component</span>
00277         <span class="comment">// of the tree and add component information to registry database.</span>
00278         <span class="comment">//</span>
00279 
00280         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d0/cmconfig_8c.html#a11">CmpSetupConfigurationTree</a>(ConfigurationRoot,
00281                                            BaseHandle,
00282                                            -1,
00283                                            (ULONG)-1
00284                                            );
00285         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>((PVOID)<a class="code" href="../../d4/d0/cmconfig_8c.html#a10">CmpConfigurationData</a>);
00286         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(BaseHandle);
00287         <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00288     } <span class="keywordflow">else</span> {
00289         <span class="keywordflow">return</span>(STATUS_SUCCESS);
00290     }
00291 }
00292 
00293 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00294"></a><a class="code" href="../../d4/d0/cmconfig_8c.html#a11">00294</a> <a class="code" href="../../d4/d0/cmconfig_8c.html#a11">CmpSetupConfigurationTree</a>(
00295      IN <a class="code" href="../../d5/d8/struct__CONFIGURATION__COMPONENT__DATA.html">PCONFIGURATION_COMPONENT_DATA</a> CurrentEntry,
00296      IN HANDLE ParentHandle,
00297      IN INTERFACE_TYPE InterfaceType,
00298      IN ULONG BusNumber
00299      )
00300 <span class="comment">/*++</span>
00301 <span class="comment"></span>
00302 <span class="comment">Routine Description:</span>
00303 <span class="comment"></span>
00304 <span class="comment">    This routine traverses loader configuration tree and register</span>
00305 <span class="comment">    the hardware information to the registry data base.</span>
00306 <span class="comment"></span>
00307 <span class="comment">    Note to reduce the stack usage on machines with large number of PCI buses,</span>
00308 <span class="comment">    we do not recursively process the sibling nodes.  We only recursively</span>
00309 <span class="comment">    process the child trees.</span>
00310 <span class="comment"></span>
00311 <span class="comment">Arguments:</span>
00312 <span class="comment"></span>
00313 <span class="comment">    CurrentEntry - Supplies a pointer to a loader configuration</span>
00314 <span class="comment">        tree or subtree.</span>
00315 <span class="comment"></span>
00316 <span class="comment">    ParentHandle - Supplies the parent handle of CurrentEntry node.</span>
00317 <span class="comment"></span>
00318 <span class="comment">    InterfaceType - Specify the Interface type of the bus that the</span>
00319 <span class="comment">        CurrentEntry component resides.</span>
00320 <span class="comment"></span>
00321 <span class="comment">    BusNumber - Specify the Bus Number of the bus that the CurrentEntry</span>
00322 <span class="comment">        component resides.  If Bus number is -1, it means InterfaceType</span>
00323 <span class="comment">        and BusNumber are meaningless for this component.</span>
00324 <span class="comment"></span>
00325 <span class="comment">Returns:</span>
00326 <span class="comment"></span>
00327 <span class="comment">    None.</span>
00328 <span class="comment"></span>
00329 <span class="comment">--*/</span>
00330 {
00331     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00332     HANDLE NewHandle;
00333     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> i;
00334     <a class="code" href="../../d4/d8/struct__CONFIGURATION__COMPONENT.html">CONFIGURATION_COMPONENT</a> *Component;
00335     INTERFACE_TYPE LocalInterfaceType = <a class="code" href="../../d4/d0/cmconfig_8c.html#a5">InterfaceType</a>;
00336     ULONG LocalBusNumber = <a class="code" href="../../d2/d7/hal_8h.html#a75">BusNumber</a>;
00337     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> DeviceIndexTable[<a class="code" href="../../d1/d2/cmp_8h.html#a68">NUMBER_TYPES</a>];
00338 
00339     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d1/d2/cmp_8h.html#a68">NUMBER_TYPES</a>; i++) {
00340         DeviceIndexTable[i] = 0;
00341     }
00342 
00343     <span class="comment">//</span>
00344     <span class="comment">// Process current entry and its siblings</span>
00345     <span class="comment">//</span>
00346 
00347     <span class="keywordflow">while</span> (CurrentEntry) {
00348 
00349         <span class="comment">//</span>
00350         <span class="comment">// Register current entry first before going down to its children</span>
00351         <span class="comment">//</span>
00352 
00353         Component = &amp;CurrentEntry-&gt;ComponentEntry;
00354 
00355         <span class="comment">//</span>
00356         <span class="comment">// If the current component is a bus component, we will set up</span>
00357         <span class="comment">// its bus number and Interface type and use them to initialize</span>
00358         <span class="comment">// its subtree.</span>
00359         <span class="comment">//</span>
00360 
00361         <span class="keywordflow">if</span> (Component-&gt;<a class="code" href="../../d4/d8/struct__CONFIGURATION__COMPONENT.html#o0">Class</a> == <a class="code" href="../../d1/d9/arc_8h.html#a314a182">AdapterClass</a> &amp;&amp;
00362             CurrentEntry-&gt;Parent-&gt;ComponentEntry.Class == <a class="code" href="../../d1/d9/arc_8h.html#a314a179">SystemClass</a>) {
00363 
00364             <span class="keywordflow">switch</span> (Component-&gt;<a class="code" href="../../d4/d8/struct__CONFIGURATION__COMPONENT.html#o1">Type</a>) {
00365 
00366             <span class="keywordflow">case</span> <a class="code" href="../../d1/d9/arc_8h.html#a315a195">EisaAdapter</a>:
00367                 LocalInterfaceType = Eisa;
00368                 LocalBusNumber = <a class="code" href="../../d4/d0/cmconfig_8c.html#a3">CmpTypeCount</a>[<a class="code" href="../../d4/d0/cmconfig_8c.html#a1">EISA_ADAPTER_INDEX</a>]++;
00369                 <span class="keywordflow">break</span>;
00370             <span class="keywordflow">case</span> <a class="code" href="../../d1/d9/arc_8h.html#a315a196">TcAdapter</a>:
00371                 LocalInterfaceType = TurboChannel;
00372                 LocalBusNumber = <a class="code" href="../../d4/d0/cmconfig_8c.html#a3">CmpTypeCount</a>[<a class="code" href="../../d4/d0/cmconfig_8c.html#a2">TURBOCHANNEL_ADAPTER_INDEX</a>]++;
00373                 <span class="keywordflow">break</span>;
00374             <span class="keywordflow">case</span> <a class="code" href="../../d1/d9/arc_8h.html#a315a199">MultiFunctionAdapter</a>:
00375 
00376                 <span class="comment">//</span>
00377                 <span class="comment">// Here we try to distinguish if the Multifunction adapter is</span>
00378                 <span class="comment">// Isa, Mca, Internal bus and assign BusNumber based on</span>
00379                 <span class="comment">// its interface type (bus type.)</span>
00380                 <span class="comment">//</span>
00381 
00382                 <span class="keywordflow">if</span> (Component-&gt;<a class="code" href="../../d4/d8/struct__CONFIGURATION__COMPONENT.html#o9">Identifier</a>) {
00383                     <span class="keywordflow">for</span> (i=0; <a class="code" href="../../d4/d0/cmconfig_8c.html#a7">CmpMultifunctionTypes</a>[i].AscString; i++) {
00384                         <span class="keywordflow">if</span> (_stricmp(<a class="code" href="../../d4/d0/cmconfig_8c.html#a7">CmpMultifunctionTypes</a>[i].<a class="code" href="../../d4/d0/cmconfig_8c.html#a4">AscString</a>,
00385                                     Component-&gt;<a class="code" href="../../d4/d8/struct__CONFIGURATION__COMPONENT.html#o9">Identifier</a>) == 0) {
00386                                         <span class="keywordflow">break</span>;
00387                         }
00388                     }
00389 
00390                     LocalInterfaceType = <a class="code" href="../../d4/d0/cmconfig_8c.html#a7">CmpMultifunctionTypes</a>[i].InterfaceType;
00391                     LocalBusNumber = <a class="code" href="../../d4/d0/cmconfig_8c.html#a7">CmpMultifunctionTypes</a>[i].Count++;
00392                 }
00393                 <span class="keywordflow">break</span>;
00394 
00395             <span class="keywordflow">case</span> <a class="code" href="../../d1/d9/arc_8h.html#a315a197">ScsiAdapter</a>:
00396 
00397                 <span class="comment">//</span>
00398                 <span class="comment">// Set the bus type to internal.</span>
00399                 <span class="comment">//</span>
00400 
00401                 LocalInterfaceType = Internal;
00402                 LocalBusNumber = <a class="code" href="../../d4/d0/cmconfig_8c.html#a3">CmpTypeCount</a>[<a class="code" href="../../d1/d9/arc_8h.html#a315a197">ScsiAdapter</a>]++;
00403                 <span class="keywordflow">break</span>;
00404 
00405             <span class="keywordflow">default</span>:
00406                 LocalInterfaceType = -1;
00407                 LocalBusNumber = <a class="code" href="../../d4/d0/cmconfig_8c.html#a8">CmpUnknownBusCount</a>++;
00408                 <span class="keywordflow">break</span>;
00409             }
00410         }
00411 
00412         <span class="comment">//</span>
00413         <span class="comment">// Initialize and copy current component to hardware registry</span>
00414         <span class="comment">//</span>
00415 
00416         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a274">CmpInitializeRegistryNode</a>(
00417                      CurrentEntry,
00418                      ParentHandle,
00419                      &amp;NewHandle,
00420                      LocalInterfaceType,
00421                      LocalBusNumber,
00422                      DeviceIndexTable
00423                      );
00424 
00425         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00426             <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00427         }
00428 
00429         <span class="comment">//</span>
00430         <span class="comment">// Once we are going one level down, we need to clear the TypeCount</span>
00431         <span class="comment">// table for everything under the current component class ...</span>
00432         <span class="comment">//</span>
00433 
00434         <span class="keywordflow">if</span> (CurrentEntry-&gt;Child) {
00435 
00436             <span class="comment">//</span>
00437             <span class="comment">// Process the child entry of current entry</span>
00438             <span class="comment">//</span>
00439 
00440             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d0/cmconfig_8c.html#a11">CmpSetupConfigurationTree</a>(CurrentEntry-&gt;Child,
00441                                                NewHandle,
00442                                                LocalInterfaceType,
00443                                                LocalBusNumber
00444                                                );
00445             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00446                 <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(NewHandle);
00447                 <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00448             }
00449         }
00450         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(NewHandle);
00451         CurrentEntry = CurrentEntry-&gt;Sibling;
00452     }
00453     <span class="keywordflow">return</span>(STATUS_SUCCESS);
00454 }
00455 
00456 
00457 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00458"></a><a class="code" href="../../d1/d2/cmp_8h.html#a274">00458</a> <a class="code" href="../../d1/d2/cmp_8h.html#a274">CmpInitializeRegistryNode</a>(
00459     IN <a class="code" href="../../d5/d8/struct__CONFIGURATION__COMPONENT__DATA.html">PCONFIGURATION_COMPONENT_DATA</a> CurrentEntry,
00460     IN HANDLE ParentHandle,
00461     OUT PHANDLE NewHandle,
00462     IN INTERFACE_TYPE InterfaceType,
00463     IN ULONG BusNumber,
00464     IN PUSHORT DeviceIndexTable
00465     )
00466 
00467 <span class="comment">/*++</span>
00468 <span class="comment"></span>
00469 <span class="comment">Routine Description:</span>
00470 <span class="comment"></span>
00471 <span class="comment">    This routine creates a node for the current firmware component</span>
00472 <span class="comment">    and puts component data to the data part of the node.</span>
00473 <span class="comment"></span>
00474 <span class="comment">Arguments:</span>
00475 <span class="comment"></span>
00476 <span class="comment">    CurrentEntry - Supplies a pointer to a configuration component.</span>
00477 <span class="comment"></span>
00478 <span class="comment">    Handle - Supplies the parent handle of CurrentEntry node.</span>
00479 <span class="comment"></span>
00480 <span class="comment">    NewHandle - Suppiles a pointer to a HANDLE to receive the handle of</span>
00481 <span class="comment">        the newly created node.</span>
00482 <span class="comment"></span>
00483 <span class="comment">    InterfaceType - Specify the Interface type of the bus that the</span>
00484 <span class="comment">        CurrentEntry component resides. (See BusNumber also)</span>
00485 <span class="comment"></span>
00486 <span class="comment">    BusNumber - Specify the Bus Number of the bus that the CurrentEntry</span>
00487 <span class="comment">        component resides on.  If Bus number is -1, it means InterfaceType</span>
00488 <span class="comment">        and BusNumber are meaningless for this component.</span>
00489 <span class="comment"></span>
00490 <span class="comment">Returns:</span>
00491 <span class="comment"></span>
00492 <span class="comment">    None.</span>
00493 <span class="comment"></span>
00494 <span class="comment">--*/</span>
00495 {
00496 
00497     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00498     OBJECT_ATTRIBUTES <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>;
00499     UNICODE_STRING <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>;
00500     UNICODE_STRING <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>;
00501     UNICODE_STRING ValueData;
00502     HANDLE <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>;
00503     HANDLE OldHandle;
00504     ANSI_STRING AnsiString;
00505     UCHAR <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>[12];
00506     WCHAR UnicodeBuffer[12];
00507     <a class="code" href="../../d4/d8/struct__CONFIGURATION__COMPONENT.html">CONFIGURATION_COMPONENT</a> *Component;
00508     ULONG Disposition;
00509     ULONG ConfigurationDataLength;
00510     PCM_FULL_RESOURCE_DESCRIPTOR NewArea;
00511 
00512     Component = &amp;CurrentEntry-&gt;ComponentEntry;
00513 
00514     <span class="comment">//</span>
00515     <span class="comment">// If the component class is SystemClass, we set its Type to be</span>
00516     <span class="comment">// ArcSystem.  The reason is because the detection code sets</span>
00517     <span class="comment">// its type to MaximumType to indicate it is NOT ARC compatible.</span>
00518     <span class="comment">// Here, we are only interested in building a System Node.  So we</span>
00519     <span class="comment">// change its Type to ArcSystem to ease the setup.</span>
00520     <span class="comment">//</span>
00521 
00522     <span class="keywordflow">if</span> (Component-&gt;<a class="code" href="../../d4/d8/struct__CONFIGURATION__COMPONENT.html#o0">Class</a> == <a class="code" href="../../d1/d9/arc_8h.html#a314a179">SystemClass</a>) {
00523         Component-&gt;<a class="code" href="../../d4/d8/struct__CONFIGURATION__COMPONENT.html#o1">Type</a> = <a class="code" href="../../d1/d9/arc_8h.html#a315a187">ArcSystem</a>;
00524     }
00525 
00526     <span class="comment">//</span>
00527     <span class="comment">// Create a new key to describe the Component.</span>
00528     <span class="comment">//</span>
00529     <span class="comment">// The type of the component will be used as the keyname of the</span>
00530     <span class="comment">// registry node.  The class is the class of the component.</span>
00531     <span class="comment">//</span>
00532 
00533     InitializeObjectAttributes(
00534         &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00535         &amp;(<a class="code" href="../../d6/d0/cmdat_8c.html#a10">CmTypeName</a>[Component-&gt;<a class="code" href="../../d4/d8/struct__CONFIGURATION__COMPONENT.html#o1">Type</a>]),
00536         0,
00537         ParentHandle,
00538         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00539         );
00540     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>.Attributes |= OBJ_CASE_INSENSITIVE;
00541 
00542     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a14">NtCreateKey</a>(                   <span class="comment">// Paht may already exist</span>
00543                 &amp;<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>,
00544                 KEY_READ | KEY_WRITE,
00545                 &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00546                 <a class="code" href="../../d4/d1/config_2alpha_2init_8c.html#a0">TITLE_INDEX_VALUE</a>,
00547                 &amp;(<a class="code" href="../../d6/d0/cmdat_8c.html#a1">CmClassName</a>[Component-&gt;<a class="code" href="../../d4/d8/struct__CONFIGURATION__COMPONENT.html#o0">Class</a>]),
00548                 0,
00549                 &amp;Disposition
00550                 );
00551 
00552     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00553         <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00554     }
00555 
00556     <span class="comment">//</span>
00557     <span class="comment">// If this component is NOT a SystemClass component, we will</span>
00558     <span class="comment">// create a subkey to identify the component's ordering.</span>
00559     <span class="comment">//</span>
00560 
00561     <span class="keywordflow">if</span> (Component-&gt;<a class="code" href="../../d4/d8/struct__CONFIGURATION__COMPONENT.html#o0">Class</a> != <a class="code" href="../../d1/d9/arc_8h.html#a314a179">SystemClass</a>) {
00562 
00563         <a class="code" href="../../d9/d3/cnvint_8c.html#a2">RtlIntegerToChar</a>(
00564             DeviceIndexTable[Component-&gt;<a class="code" href="../../d4/d8/struct__CONFIGURATION__COMPONENT.html#o1">Type</a>]++,
00565             10,
00566             12,
00567             <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>
00568             );
00569 
00570         <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>(
00571             &amp;AnsiString,
00572             <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>
00573             );
00574 
00575         <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.Buffer = (PWSTR)UnicodeBuffer;
00576         <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.Length = 0;
00577         <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>.MaximumLength = <span class="keyword">sizeof</span>(UnicodeBuffer);
00578 
00579         <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(
00580             &amp;<a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>,
00581             &amp;AnsiString,
00582             <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
00583             );
00584 
00585         OldHandle = <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>;
00586 
00587         InitializeObjectAttributes(
00588             &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00589             &amp;<a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>,
00590             0,
00591             OldHandle,
00592             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00593             );
00594         <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>.Attributes |= OBJ_CASE_INSENSITIVE;
00595 
00596         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a14">NtCreateKey</a>(
00597                     &amp;<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>,
00598                     KEY_READ | KEY_WRITE,
00599                     &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00600                     <a class="code" href="../../d4/d1/config_2alpha_2init_8c.html#a0">TITLE_INDEX_VALUE</a>,
00601                     &amp;(<a class="code" href="../../d6/d0/cmdat_8c.html#a1">CmClassName</a>[Component-&gt;<a class="code" href="../../d4/d8/struct__CONFIGURATION__COMPONENT.html#o0">Class</a>]),
00602                     0,
00603                     &amp;Disposition
00604                     );
00605 
00606         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(OldHandle);
00607 
00608         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00609             <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00610         }
00611 
00612         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Disposition == REG_CREATED_NEW_KEY);
00613     }
00614 
00615     <span class="comment">//</span>
00616     <span class="comment">// Create a value which describes the following component information:</span>
00617     <span class="comment">//     Flags, Cersion, Key, AffinityMask.</span>
00618     <span class="comment">//</span>
00619 
00620     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(
00621         &amp;<a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>,
00622         <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Component Information"</span>
00623         );
00624 
00625     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a>(
00626                 <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>,
00627                 &amp;<a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>,
00628                 <a class="code" href="../../d4/d1/config_2alpha_2init_8c.html#a0">TITLE_INDEX_VALUE</a>,
00629                 REG_BINARY,
00630                 &amp;Component-&gt;<a class="code" href="../../d4/d8/struct__CONFIGURATION__COMPONENT.html#o2">Flags</a>,
00631                 FIELD_OFFSET(<a class="code" href="../../d4/d8/struct__CONFIGURATION__COMPONENT.html">CONFIGURATION_COMPONENT</a>, ConfigurationDataLength) -
00632                     FIELD_OFFSET(<a class="code" href="../../d4/d8/struct__CONFIGURATION__COMPONENT.html">CONFIGURATION_COMPONENT</a>, Flags)
00633                 );
00634 
00635     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00636         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>);
00637         <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00638     }
00639 
00640     <span class="comment">//</span>
00641     <span class="comment">// Create a value which describes the component identifier, if any.</span>
00642     <span class="comment">//</span>
00643 
00644     <span class="keywordflow">if</span> (Component-&gt;<a class="code" href="../../d4/d8/struct__CONFIGURATION__COMPONENT.html#o8">IdentifierLength</a>) {
00645 
00646         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(
00647             &amp;<a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>,
00648             <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Identifier"</span>
00649             );
00650 
00651         <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>(
00652             &amp;AnsiString,
00653             Component-&gt;<a class="code" href="../../d4/d8/struct__CONFIGURATION__COMPONENT.html#o9">Identifier</a>
00654             );
00655 
00656         <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(
00657             &amp;ValueData,
00658             &amp;AnsiString,
00659             <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>
00660             );
00661 
00662         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a>(
00663                     <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>,
00664                     &amp;<a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>,
00665                     <a class="code" href="../../d4/d1/config_2alpha_2init_8c.html#a0">TITLE_INDEX_VALUE</a>,
00666                     REG_SZ,
00667                     ValueData.Buffer,
00668                     ValueData.Length + <span class="keyword">sizeof</span>( UNICODE_NULL )
00669                     );
00670 
00671         <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;ValueData);
00672 
00673         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00674             <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>);
00675             <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00676         }
00677     }
00678 
00679     <span class="comment">//</span>
00680     <span class="comment">// Create a value entry for component configuration data.</span>
00681     <span class="comment">//</span>
00682 
00683     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(
00684         &amp;<a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>,
00685         <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Configuration Data"</span>
00686         );
00687 
00688     <span class="comment">//</span>
00689     <span class="comment">// Create the configuration data based on CM_FULL_RESOURCE_DESCRIPTOR.</span>
00690     <span class="comment">//</span>
00691     <span class="comment">// Note the configuration data in firmware tree may be in the form of</span>
00692     <span class="comment">// CM_PARTIAL_RESOURCE_LIST or nothing.  In both cases, we need to</span>
00693     <span class="comment">// set up the registry configuration data to be in the form of</span>
00694     <span class="comment">// CM_FULL_RESOURCE_DESCRIPTOR.</span>
00695     <span class="comment">//</span>
00696 
00697     <span class="keywordflow">if</span> (CurrentEntry-&gt;ConfigurationData) {
00698 
00699         <span class="comment">//</span>
00700         <span class="comment">// This component has configuration data, we copy the data</span>
00701         <span class="comment">// to our work area, add some more data items and copy the new</span>
00702         <span class="comment">// configuration data to the registry.</span>
00703         <span class="comment">//</span>
00704 
00705         ConfigurationDataLength = Component-&gt;<a class="code" href="../../d4/d8/struct__CONFIGURATION__COMPONENT.html#o7">ConfigurationDataLength</a> +
00706                       FIELD_OFFSET(CM_FULL_RESOURCE_DESCRIPTOR,
00707                       PartialResourceList);
00708 
00709         <span class="comment">//</span>
00710         <span class="comment">// Make sure our reserved area is big enough to hold the data.</span>
00711         <span class="comment">//</span>
00712 
00713         <span class="keywordflow">if</span> (ConfigurationDataLength &gt; <a class="code" href="../../d4/d0/cmconfig_8c.html#a9">CmpConfigurationAreaSize</a>) {
00714 
00715             <span class="comment">//</span>
00716             <span class="comment">// If reserved area is not big enough, we resize our reserved</span>
00717             <span class="comment">// area.  If, unfortunately, the reallocation fails, we simply</span>
00718             <span class="comment">// loss the configuration data of this particular component.</span>
00719             <span class="comment">//</span>
00720 
00721             NewArea = (PCM_FULL_RESOURCE_DESCRIPTOR)<a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(
00722                                             <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
00723                                             ConfigurationDataLength
00724                                             );
00725 
00726             <span class="keywordflow">if</span> (NewArea) {
00727                 <a class="code" href="../../d4/d0/cmconfig_8c.html#a9">CmpConfigurationAreaSize</a> = ConfigurationDataLength;
00728                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(<a class="code" href="../../d4/d0/cmconfig_8c.html#a10">CmpConfigurationData</a>);
00729                 <a class="code" href="../../d4/d0/cmconfig_8c.html#a10">CmpConfigurationData</a> = NewArea;
00730                 RtlMoveMemory(
00731                     (PUCHAR)&amp;<a class="code" href="../../d4/d0/cmconfig_8c.html#a10">CmpConfigurationData</a>-&gt;PartialResourceList.Version,
00732                     CurrentEntry-&gt;ConfigurationData,
00733                     Component-&gt;<a class="code" href="../../d4/d8/struct__CONFIGURATION__COMPONENT.html#o7">ConfigurationDataLength</a>
00734                     );
00735             } <span class="keywordflow">else</span> {
00736                 Component-&gt;<a class="code" href="../../d4/d8/struct__CONFIGURATION__COMPONENT.html#o7">ConfigurationDataLength</a> = 0;
00737                 CurrentEntry-&gt;ConfigurationData = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00738             }
00739         } <span class="keywordflow">else</span> {
00740             RtlMoveMemory(
00741                 (PUCHAR)&amp;<a class="code" href="../../d4/d0/cmconfig_8c.html#a10">CmpConfigurationData</a>-&gt;PartialResourceList.Version,
00742                 CurrentEntry-&gt;ConfigurationData,
00743                 Component-&gt;<a class="code" href="../../d4/d8/struct__CONFIGURATION__COMPONENT.html#o7">ConfigurationDataLength</a>
00744                 );
00745         }
00746 
00747     }
00748 
00749     <span class="keywordflow">if</span> (CurrentEntry-&gt;ConfigurationData == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00750 
00751         <span class="comment">//</span>
00752         <span class="comment">// This component has NO configuration data (or we can't resize</span>
00753         <span class="comment">// our reserved area to hold the data), we simple add whatever</span>
00754         <span class="comment">// is required to set up a CM_FULL_RESOURCE_LIST.</span>
00755         <span class="comment">//</span>
00756 
00757         <a class="code" href="../../d4/d0/cmconfig_8c.html#a10">CmpConfigurationData</a>-&gt;PartialResourceList.Version = 0;
00758         <a class="code" href="../../d4/d0/cmconfig_8c.html#a10">CmpConfigurationData</a>-&gt;PartialResourceList.Revision = 0;
00759         <a class="code" href="../../d4/d0/cmconfig_8c.html#a10">CmpConfigurationData</a>-&gt;PartialResourceList.Count = 0;
00760         ConfigurationDataLength = FIELD_OFFSET(CM_FULL_RESOURCE_DESCRIPTOR,
00761                                                PartialResourceList) +
00762                                   FIELD_OFFSET(CM_PARTIAL_RESOURCE_LIST,
00763                                                PartialDescriptors);
00764     }
00765 
00766     <span class="comment">//</span>
00767     <span class="comment">// Set up InterfaceType and BusNumber for the component.</span>
00768     <span class="comment">//</span>
00769 
00770     <a class="code" href="../../d4/d0/cmconfig_8c.html#a10">CmpConfigurationData</a>-&gt;InterfaceType = <a class="code" href="../../d4/d0/cmconfig_8c.html#a5">InterfaceType</a>;
00771     <a class="code" href="../../d4/d0/cmconfig_8c.html#a10">CmpConfigurationData</a>-&gt;BusNumber = <a class="code" href="../../d2/d7/hal_8h.html#a75">BusNumber</a>;
00772 
00773     <span class="comment">//</span>
00774     <span class="comment">// Write the newly constructed configuration data to the hardware registry</span>
00775     <span class="comment">//</span>
00776 
00777     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d7/ntapi_8c.html#a29">NtSetValueKey</a>(
00778                 <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>,
00779                 &amp;<a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>,
00780                 <a class="code" href="../../d4/d1/config_2alpha_2init_8c.html#a0">TITLE_INDEX_VALUE</a>,
00781                 REG_FULL_RESOURCE_DESCRIPTOR,
00782                 <a class="code" href="../../d4/d0/cmconfig_8c.html#a10">CmpConfigurationData</a>,
00783                 ConfigurationDataLength
00784                 );
00785 
00786     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00787         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>);
00788         <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00789     }
00790 
00791     *NewHandle = <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>;
00792     <span class="keywordflow">return</span>(STATUS_SUCCESS);
00793 
00794 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:26 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
