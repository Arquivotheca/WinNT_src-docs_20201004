<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: sessnirp.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>sessnirp.c File Reference</h1><code>#include "<a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>"</code><br>
<code>#include "srb.h"</code><br>

<p>
<a href="../../d6/d6/sessnirp_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d7/sessnirp_8c.html#a0">POOL_TAG_SESSION_DATA</a>&nbsp;&nbsp;&nbsp;'sprI'</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d8/d1/struct__IOV__SESSION__DATA.html">PIOV_SESSION_DATA</a> FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d7/sessnirp_8c.html#a1">IovpSessionDataCreate</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, IN OUT <a class="el" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html">PIOV_REQUEST_PACKET</a> *IovPacketPointer, OUT PBOOLEAN SurrogateSpawned)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d7/sessnirp_8c.html#a2">IovpSessionDataAdvance</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, IN <a class="el" href="../../d8/d1/struct__IOV__SESSION__DATA.html">PIOV_SESSION_DATA</a> IovSessionData, IN OUT <a class="el" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html">PIOV_REQUEST_PACKET</a> *IovPacketPointer, OUT PBOOLEAN SurrogateSpawned)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d7/sessnirp_8c.html#a3">IovpSessionDataDereference</a> (IN <a class="el" href="../../d8/d1/struct__IOV__SESSION__DATA.html">PIOV_SESSION_DATA</a> IovSessionData)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d7/sessnirp_8c.html#a4">IovpSessionDataReference</a> (IN <a class="el" href="../../d8/d1/struct__IOV__SESSION__DATA.html">PIOV_SESSION_DATA</a> IovSessionData)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d7/sessnirp_8c.html#a5">IovpSessionDataClose</a> (IN <a class="el" href="../../d8/d1/struct__IOV__SESSION__DATA.html">PIOV_SESSION_DATA</a> IovSessionData)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d7/sessnirp_8c.html#a6">IovpSessionDataDeterminePolicy</a> (IN <a class="el" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html">PIOV_REQUEST_PACKET</a> IovRequestPacket, IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, OUT PBOOLEAN Trackable, OUT PBOOLEAN UseSurrogateIrp)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d7/sessnirp_8c.html#a7">IovpSessionDataAttachSurrogate</a> (IN OUT <a class="el" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html">PIOV_REQUEST_PACKET</a> *IovPacketPointer, IN <a class="el" href="../../d8/d1/struct__IOV__SESSION__DATA.html">PIOV_SESSION_DATA</a> IovSessionData)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d7/sessnirp_8c.html#a8">IovpSessionDataFinalizeSurrogate</a> (IN <a class="el" href="../../d8/d1/struct__IOV__SESSION__DATA.html">PIOV_SESSION_DATA</a> IovSessionData, IN OUT <a class="el" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html">PIOV_REQUEST_PACKET</a> IovPacket, IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> SurrogateIrp)</td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a0" doxytag="sessnirp.c::POOL_TAG_SESSION_DATA" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define POOL_TAG_SESSION_DATA&nbsp;&nbsp;&nbsp;'sprI'          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d6/sessnirp_8c-source.html#l00023">23</a> of file <a class="el" href="../../d6/d6/sessnirp_8c-source.html">sessnirp.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d6/sessnirp_8c-source.html#l00027">IovpSessionDataCreate()</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a2" doxytag="sessnirp.c::IovpSessionDataAdvance" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID FASTCALL IovpSessionDataAdvance           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d8/d1/struct__IOV__SESSION__DATA.html">PIOV_SESSION_DATA</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IovSessionData</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT <a class="el" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html">PIOV_REQUEST_PACKET</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>IovPacketPointer</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PBOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>SurrogateSpawned</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d6/sessnirp_8c-source.html#l00140">140</a> of file <a class="el" href="../../d6/d6/sessnirp_8c-source.html">sessnirp.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>.
<p>
Referenced by <a class="el" href="../../d9/d3/trackirp_8c-source.html#l00493">IovpCallDriver1()</a>.
<p>
<pre class="fragment"><div>00146 {
00147     *SurrogateSpawned = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00148 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="sessnirp.c::IovpSessionDataAttachSurrogate" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN FASTCALL IovpSessionDataAttachSurrogate           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT <a class="el" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html">PIOV_REQUEST_PACKET</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>IovPacketPointer</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d8/d1/struct__IOV__SESSION__DATA.html">PIOV_SESSION_DATA</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IovSessionData</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d6/sessnirp_8c-source.html#l00314">314</a> of file <a class="el" href="../../d6/d6/sessnirp_8c-source.html">sessnirp.c</a>.
<p>
References <a class="el" href="../../d1/d4/io_8h-source.html#l01680">_IRP::AllocationFlags</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d3/d4/ioassert_8h-source.html#l00165">ASSERT_SPINLOCK_HELD</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00204">_IOV_REQUEST_PACKET::AssertFlags</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00194">_IOV_REQUEST_PACKET::CallerIrql</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01701">_IRP::CancelRoutine</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01655">_IRP::CurrentLocation</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00087">DISPATCH_LEVEL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00197">_IOV_REQUEST_PACKET::Flags</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02030">_IO_STACK_LOCATION::Flags</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01602">_IRP::Flags</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00201">_IOV_REQUEST_PACKET::HeadPacket</a>, <a class="el" href="../../d0/d5/io_8h.html#a373">IO_STACK_LOCATION</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03252">IoGetCurrentIrpStackLocation</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03398">IoGetNextIrpStackLocation</a>, <a class="el" href="../../d2/d4/ioassert_8c-source.html#l01320">IopIsMemoryRangeReadable()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01635">_IRP::IoStatus</a>, <a class="el" href="../../d9/d4/trackirp_8h.html#a98">IOV_REQUEST_PACKET</a>, <a class="el" href="../../d9/d7/hashirp_8c-source.html#l00686">IovpProtectedIrpAllocate()</a>, <a class="el" href="../../d9/d7/hashirp_8c-source.html#l00838">IovpProtectedIrpFree()</a>, <a class="el" href="../../d9/d7/hashirp_8c-source.html#l00744">IovpProtectedIrpMakeUntouchable()</a>, <a class="el" href="../../d9/d7/hashirp_8c-source.html#l00122">IovpTrackingDataCreateAndLock()</a>, <a class="el" href="../../d9/d7/hashirp_8c-source.html#l00584">IovpTrackingDataReference()</a>, <a class="el" href="../../d9/d8/hashirp_8h.html#a21a5">IOVREFTYPE_POINTER</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00066">IRP_DIAG_HAS_SURROGATE</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00067">IRP_DIAG_IS_SURROGATE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00090">IRP_MJ_SCSI</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01574">IRP_QUOTA_CHARGED</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00193">_IOV_REQUEST_PACKET::IrpLock</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00217">_IOV_REQUEST_PACKET::LastLocation</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02028">_IO_STACK_LOCATION::MajorFunction</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02069">_IO_STACK_LOCATION::Parameters</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00221">_IOV_REQUEST_PACKET::pIovSessionData</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01654">_IRP::StackCount</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00199">_IOV_REQUEST_PACKET::SurrogateLink</a>, <a class="el" href="../../d0/d2/struct__IRP.html#o38">_IRP::Tail</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01629">_IRP::ThreadListEntry</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00214">_IOV_REQUEST_PACKET::TopStackLocation</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00192">_IOV_REQUEST_PACKET::TrackedIrp</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00070">TRACKFLAG_ACTIVE</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00072">TRACKFLAG_HAS_SURROGATE</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00078">TRACKFLAG_SRB_MUNGED</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00071">TRACKFLAG_SURROGATE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01687">_IRP::UserEvent</a>, and <a class="el" href="../../d1/d4/io_8h-source.html#l01686">_IRP::UserIosb</a>.
<p>
Referenced by <a class="el" href="../../d6/d6/sessnirp_8c-source.html#l00027">IovpSessionDataCreate()</a>.
<p>
<pre class="fragment"><div>00320              :
00321 
00322     This routine creates tracking data <span class="keywordflow">for</span> a <span class="keyword">new</span> <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a>. It must be called on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00323     thread <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> was originally sent down...
00324 
00325   Arguments:
00326 
00327     IovPacketPointer       - Pointer to <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> packet to attach surrogate to. If
00328                              a surrogate can be attached <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> packet will be
00329                              updated to track <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> surrogate.
00330 
00331     SurrogateIrp           - Prepared surrogate <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> to attach.
00332 
00333   Return Value:
00334 
00335     iovPacket block, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> <span class="keywordflow">if</span> no memory.
00336 
00337 --*/
00338 {
00339 
00340     <a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html">PIOV_REQUEST_PACKET</a> iovSurrogatePacket, iovPacket, headPacket;
00341     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> surrogateIrp, irp;
00342     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> irpSp;
00343     PSCSI_REQUEST_BLOCK srb;
00344     PVOID restoreHandle;
00345     CCHAR activeSize;
00346 
00347     iovPacket = *IovPacketPointer;
00348     <a class="code" href="../../d2/d5/ioassert_8h.html#a24">ASSERT_SPINLOCK_HELD</a>(&amp;iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o1">IrpLock</a>);
00349     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(!(CONTAINING_RECORD(
00350         iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o7">SurrogateLink</a>.Flink,
00351         <a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html">IOV_REQUEST_PACKET</a>,
00352         SurrogateLink)-&gt;Flags&amp;TRACKFLAG_SURROGATE
00353         ));
00354 
00355     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o5">Flags</a> &amp; TRACKFLAG_ACTIVE);
00356 
00357     irp = iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o0">TrackedIrp</a>;
00358     activeSize = (irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o13">CurrentLocation</a>-1);
00359     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(activeSize);
00360 
00361     <span class="comment">//</span>
00362     <span class="comment">// We now try to make a copy of this new IRP which we will track. We</span>
00363     <span class="comment">// do this so that we may free *every* tracked IRP immediately upon</span>
00364     <span class="comment">// completion.</span>
00365     <span class="comment">// Technically speaking, we only need to allocate what's left of the</span>
00366     <span class="comment">// stack, not the entire thing. But using the entire stack makes our</span>
00367     <span class="comment">// work much much easier. Specifically the session stack array may depend</span>
00368     <span class="comment">// on this.</span>
00369     <span class="comment">//</span>
00370     <span class="comment">// ADRIAO BUGBUG 03/04/1999 - Make this work only copying a portion of the</span>
00371     <span class="comment">// IRP.</span>
00372     <span class="comment">//</span>
00373     surrogateIrp = <a class="code" href="../../d9/d8/hashirp_8h.html#a20">IovpProtectedIrpAllocate</a>(
00374         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o12">StackCount</a>, <span class="comment">// activeSize</span>
00375         (BOOLEAN) ((irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o17">AllocationFlags</a>&amp;IRP_QUOTA_CHARGED) ? TRUE : FALSE),
00376         NULL
00377         );
00378 
00379     <span class="keywordflow">if</span> (surrogateIrp == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00380 
00381         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00382     }
00383 
00384     <span class="comment">//</span>
00385     <span class="comment">// Now set up the new IRP - we do this here so IovpTrackingDataCreateAndLock</span>
00386     <span class="comment">// can peek at it's fields. Start with the IRP header.</span>
00387     <span class="comment">//</span>
00388     RtlCopyMemory(surrogateIrp, irp, <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d2/struct__IRP.html">IRP</a>));
00389 
00390     <span class="comment">//</span>
00391     <span class="comment">// Adjust StackCount and CurrentLocation</span>
00392     <span class="comment">//</span>
00393     surrogateIrp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o12">StackCount</a> = irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o12">StackCount</a>; <span class="comment">// activeSize</span>
00394     surrogateIrp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.CurrentStackLocation =
00395         ((<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a>) (surrogateIrp+1))+activeSize;
00396 
00397     <span class="comment">//</span>
00398     <span class="comment">// Our new IRP "floats", and is not attached to any thread.</span>
00399     <span class="comment">// Note that all cancels due to thread death will come through the</span>
00400     <span class="comment">// original IRP.</span>
00401     <span class="comment">//</span>
00402     InitializeListHead(&amp;surrogateIrp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o8">ThreadListEntry</a>);
00403 
00404     <span class="comment">//</span>
00405     <span class="comment">// Our new IRP also is not connected to user mode.</span>
00406     <span class="comment">//</span>
00407     surrogateIrp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o19">UserEvent</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00408     surrogateIrp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o18">UserIosb</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00409 
00410     <span class="comment">//</span>
00411     <span class="comment">// Now copy over only the active portions of IRP. Be very careful to not</span>
00412     <span class="comment">// assume that the last stack location is right after the end of the IRP,</span>
00413     <span class="comment">// as we may change this someday!</span>
00414     <span class="comment">//</span>
00415     irpSp = (<a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>(irp)-activeSize);
00416     RtlCopyMemory(surrogateIrp+1, irpSp, <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">IO_STACK_LOCATION</a>)*activeSize);
00417 
00418     <span class="comment">//</span>
00419     <span class="comment">// Zero the portion of the new IRP we won't be using (this should</span>
00420     <span class="comment">// eventually go away).</span>
00421     <span class="comment">//</span>
00422     RtlZeroMemory(
00423         ((<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a>) (surrogateIrp+1))+activeSize,
00424         <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">IO_STACK_LOCATION</a>)*(surrogateIrp-&gt;StackCount - activeSize)
00425         );
00426 
00427     <span class="comment">//</span>
00428     <span class="comment">// Now create a surrogate packet to track the new IRP.</span>
00429     <span class="comment">//</span>
00430     iovSurrogatePacket = <a class="code" href="../../d9/d8/hashirp_8h.html#a8">IovpTrackingDataCreateAndLock</a>(surrogateIrp);
00431     <span class="keywordflow">if</span> (iovSurrogatePacket == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00432 
00433         <span class="comment">//</span>
00434         <span class="comment">// ADRIAO BUGBUG 02/11/1999 - Need to free IRP</span>
00435         <span class="comment">//</span>
00436         restoreHandle = <a class="code" href="../../d9/d8/hashirp_8h.html#a17">IovpProtectedIrpMakeUntouchable</a>(surrogateIrp, TRUE);
00437         <a class="code" href="../../d9/d8/hashirp_8h.html#a19">IovpProtectedIrpFree</a>(surrogateIrp, restoreHandle);
00438         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00439     }
00440 
00441     headPacket = iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o9">HeadPacket</a>;
00442 
00443     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(iovSurrogatePacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o2">CallerIrql</a> == DISPATCH_LEVEL);
00444     irpSp = <a class="code" href="../../d0/d5/io_8h.html#a230">IoGetNextIrpStackLocation</a>(irp);
00445 
00446     <span class="comment">//</span>
00447     <span class="comment">// We will flag this bug later.</span>
00448     <span class="comment">//</span>
00449     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o25">CancelRoutine</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00450 
00451     <span class="comment">//</span>
00452     <span class="comment">// Let's take advantage of the original IRP not being the thing partied on</span>
00453     <span class="comment">// now; store a pointer to our tracking data in the information field. We</span>
00454     <span class="comment">// don't use this, but it's nice when debugging...</span>
00455     <span class="comment">//</span>
00456     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information = (ULONG_PTR) iovPacket;
00457 
00458     <span class="comment">//</span>
00459     <span class="comment">// ADRIAO BUGBUG #28 06/10/98 - This is absolutely *gross*, and not</span>
00460     <span class="comment">//                              deterministic enough for my tastes.</span>
00461     <span class="comment">//</span>
00462     <span class="comment">// For IRP_MJ_SCSI (ie, IRP_MJ_INTERNAL_DEVICE_CONTROL), look and see</span>
00463     <span class="comment">// if we have an SRB coming through. If so, fake out the OriginalRequest</span>
00464     <span class="comment">// IRP pointer as appropriate.</span>
00465     <span class="comment">//</span>
00466     <span class="keywordflow">if</span> (irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a> == <a class="code" href="../../d0/d5/io_8h.html#a43">IRP_MJ_SCSI</a>) {
00467         srb = irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.Others.Argument1 ;
00468         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d5/ioassert_8h.html#a113">IopIsMemoryRangeReadable</a>(srb, SCSI_REQUEST_BLOCK_SIZE)) {
00469             <span class="keywordflow">if</span> ((srb-&gt;Length == SCSI_REQUEST_BLOCK_SIZE)&amp;&amp;(srb-&gt;OriginalRequest == irp)) {
00470                 srb-&gt;OriginalRequest = surrogateIrp ;
00471                 headPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o5">Flags</a> |= <a class="code" href="../../d9/d4/trackirp_8h.html#a32">TRACKFLAG_SRB_MUNGED</a> ;
00472             }
00473         }
00474     }
00475 
00476     <span class="comment">//</span>
00477     <span class="comment">// Since the replacement will never make it back to user mode (the real</span>
00478     <span class="comment">// IRP shall of course), we will steal a field or two for debugging info.</span>
00479     <span class="comment">//</span>
00480     surrogateIrp-&gt;UserIosb = (PIO_STATUS_BLOCK) iovPacket ;
00481 
00482     <span class="comment">//</span>
00483     <span class="comment">// Now that everything is built correctly, attach the surrogate. The</span>
00484     <span class="comment">// surrogate holds down the packet we are attaching to. When the surrogate</span>
00485     <span class="comment">// dies we will remove this reference.</span>
00486     <span class="comment">//</span>
00487     <a class="code" href="../../d9/d8/hashirp_8h.html#a13">IovpTrackingDataReference</a>(iovPacket, IOVREFTYPE_POINTER);
00488 
00489     <span class="comment">//</span>
00490     <span class="comment">// Stamp IRPs appropriately.</span>
00491     <span class="comment">//</span>
00492     surrogateIrp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o2">Flags</a> |= <a class="code" href="../../d9/d4/trackirp_8h.html#a24">IRP_DIAG_IS_SURROGATE</a>;
00493     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> |= <a class="code" href="../../d9/d4/trackirp_8h.html#a23">IRP_DIAG_HAS_SURROGATE</a>;
00494 
00495     <span class="comment">//</span>
00496     <span class="comment">// Mark packet as surrogate and inherit appropriate fields from iovPacket.</span>
00497     <span class="comment">//</span>
00498     iovSurrogatePacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o5">Flags</a> |= <a class="code" href="../../d9/d4/trackirp_8h.html#a26">TRACKFLAG_SURROGATE</a> | <a class="code" href="../../d9/d4/trackirp_8h.html#a25">TRACKFLAG_ACTIVE</a>;
00499     iovSurrogatePacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o21">pIovSessionData</a> = iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o21">pIovSessionData</a>;
00500     iovSurrogatePacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o11">AssertFlags</a> = iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o11">AssertFlags</a>;
00501     iovSurrogatePacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o9">HeadPacket</a> = iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o9">HeadPacket</a>;
00502     iovSurrogatePacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o18">LastLocation</a> = iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o18">LastLocation</a>;
00503     iovSurrogatePacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o16">TopStackLocation</a> = irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o13">CurrentLocation</a>;
00504 
00505     iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o5">Flags</a> |= <a class="code" href="../../d9/d4/trackirp_8h.html#a27">TRACKFLAG_HAS_SURROGATE</a>;
00506 
00507     <span class="comment">//</span>
00508     <span class="comment">// Fix up IRQL's so spinlocks are released in the right order. Link'm.</span>
00509     <span class="comment">//</span>
00510     iovSurrogatePacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o2">CallerIrql</a> = iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o2">CallerIrql</a>;
00511     iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o2">CallerIrql</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>;
00512     InsertTailList(
00513         &amp;iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o9">HeadPacket</a>-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o7">SurrogateLink</a>,
00514         &amp;iovSurrogatePacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o7">SurrogateLink</a>
00515         );
00516 
00517     *IovPacketPointer = iovSurrogatePacket;
00518     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00519 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="sessnirp.c::IovpSessionDataClose" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID FASTCALL IovpSessionDataClose           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d1/struct__IOV__SESSION__DATA.html">PIOV_SESSION_DATA</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>IovSessionData</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d6/sessnirp_8c-source.html#l00220">220</a> of file <a class="el" href="../../d6/d6/sessnirp_8c-source.html">sessnirp.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d3/d4/ioassert_8h-source.html#l00165">ASSERT_SPINLOCK_HELD</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00197">_IOV_REQUEST_PACKET::Flags</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00201">_IOV_REQUEST_PACKET::HeadPacket</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00193">_IOV_REQUEST_PACKET::IrpLock</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00221">_IOV_REQUEST_PACKET::pIovSessionData</a>, and <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00712">TRACKIRP_DBGPRINT</a>.
<p>
Referenced by <a class="el" href="../../d9/d3/trackirp_8c-source.html#l01416">IovpCompleteRequest2()</a>, and <a class="el" href="../../d9/d3/trackirp_8c-source.html#l02751">IovpSwapSurrogateIrp()</a>.
<p>
<pre class="fragment"><div>00223 {
00224    <a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html">PIOV_REQUEST_PACKET</a> iovPacket = IovSessionData-&gt;IovRequestPacket;
00225 
00226    <a class="code" href="../../d2/d5/ioassert_8h.html#a24">ASSERT_SPINLOCK_HELD</a>(&amp;iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o1">IrpLock</a>);
00227 
00228    <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(iovPacket == iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o9">HeadPacket</a>);
00229    <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o21">pIovSessionData</a> == IovSessionData);
00230 
00231    <a class="code" href="../../d9/d4/trackirp_8h.html#a88">TRACKIRP_DBGPRINT</a>((
00232        <span class="stringliteral">"  SSN CLOSE(%x)\n"</span>
00233        ), 3) ;
00234 
00235    iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o5">Flags</a> &amp;=~ TRACKFLAG_ACTIVE;
00236    iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o21">pIovSessionData</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00237 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="sessnirp.c::IovpSessionDataCreate" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d8/d1/struct__IOV__SESSION__DATA.html">PIOV_SESSION_DATA</a> FASTCALL IovpSessionDataCreate           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT <a class="el" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html">PIOV_REQUEST_PACKET</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>IovPacketPointer</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PBOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>SurrogateSpawned</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d6/sessnirp_8c-source.html#l00027">27</a> of file <a class="el" href="../../d6/d6/sessnirp_8c-source.html">sessnirp.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00036">ASSERTFLAG_COMPLETEATPASSIVE</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00037">ASSERTFLAG_DEFERCOMPLETION</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00034">ASSERTFLAG_FORCEPENDING</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00180">_IOV_SESSION_DATA::AssertFlags</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00185">_IOV_SESSION_DATA::BestVisibleIrp</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01655">_IRP::CurrentLocation</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00197">_IOV_REQUEST_PACKET::Flags</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00201">_IOV_REQUEST_PACKET::HeadPacket</a>, <a class="el" href="../../d9/d4/trackirp_8h.html#a97">IOV_SESSION_DATA</a>, <a class="el" href="../../d9/d4/trackirp_8h.html#a96">IOV_STACK_LOCATION</a>, <a class="el" href="../../d6/d6/sessnirp_8c-source.html#l00314">IovpSessionDataAttachSurrogate()</a>, <a class="el" href="../../d6/d6/sessnirp_8c-source.html#l00240">IovpSessionDataDeterminePolicy()</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l00121">IovpTrackingFlags</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00176">_IOV_SESSION_DATA::IovRequestPacket</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00141">PIOV_REQUEST_PACKET</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00221">_IOV_REQUEST_PACKET::pIovSessionData</a>, <a class="el" href="../../d6/d6/sessnirp_8c-source.html#l00023">POOL_TAG_SESSION_DATA</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00200">_IOV_REQUEST_PACKET::SessionHead</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00178">_IOV_SESSION_DATA::SessionLink</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01654">_IRP::StackCount</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00214">_IOV_REQUEST_PACKET::TopStackLocation</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00192">_IOV_REQUEST_PACKET::TrackedIrp</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00070">TRACKFLAG_ACTIVE</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00083">TRACKFLAG_PASSED_FAILURE</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00075">TRACKFLAG_QUEUED_INTERNALLY</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00077">TRACKFLAG_RELEASED</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00078">TRACKFLAG_SRB_MUNGED</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00079">TRACKFLAG_SWAPPED_BACK</a>, and <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00712">TRACKIRP_DBGPRINT</a>.
<p>
Referenced by <a class="el" href="../../d9/d3/trackirp_8c-source.html#l00493">IovpCallDriver1()</a>.
<p>
<pre class="fragment"><div>00034              :
00035 
00036     This routine creates tracking data <span class="keywordflow">for</span> a <span class="keyword">new</span> <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a>. It must be called on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00037     thread <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> was originally sent down...
00038 
00039   Arguments:
00040 
00041     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>                    - <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> to track.
00042 
00043   Return Value:
00044 
00045     iovPacket block, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> <span class="keywordflow">if</span> no memory.
00046 
00047 --*/
00048 {
00049     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> irp, surrogateIrp;
00050     <a class="code" href="../../d8/d1/struct__IOV__SESSION__DATA.html">PIOV_SESSION_DATA</a> iovSessionData;
00051     <a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html">PIOV_REQUEST_PACKET</a> headPacket;
00052     ULONG sessionDataSize;
00053     BOOLEAN trackable, useSurrogateIrp;
00054 
00055     *SurrogateSpawned = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00056 
00057     headPacket = (*IovPacketPointer)-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o9">HeadPacket</a>;
00058     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(headPacket == (*IovPacketPointer));
00059     irp = headPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o0">TrackedIrp</a>;
00060 
00061     <span class="comment">//</span>
00062     <span class="comment">// Check the IRP appropriately</span>
00063     <span class="comment">//</span>
00064     <a class="code" href="../../d6/d7/sessnirp_8h.html#a5">IovpSessionDataDeterminePolicy</a>(
00065         headPacket,
00066         DeviceObject,
00067         &amp;trackable,
00068         &amp;useSurrogateIrp
00069         );
00070 
00071     <span class="keywordflow">if</span> (!trackable) {
00072 
00073         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00074     }
00075 
00076     <span class="comment">//</span>
00077     <span class="comment">// One extra stack location is allocated as the "zero'th" is used to</span>
00078     <span class="comment">// simplify some logic...</span>
00079     <span class="comment">//</span>
00080     sessionDataSize =
00081         <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d1/struct__IOV__SESSION__DATA.html">IOV_SESSION_DATA</a>)+
00082         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o12">StackCount</a>*<span class="keyword">sizeof</span>(<a class="code" href="../../d9/d1/struct__IOV__STACK__LOCATION.html">IOV_STACK_LOCATION</a>);
00083 
00084     iovSessionData = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(
00085         NonPagedPool,
00086         sessionDataSize,
00087         POOL_TAG_SESSION_DATA
00088         );
00089 
00090     <span class="keywordflow">if</span> (iovSessionData == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00091 
00092         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00093     }
00094 
00095     RtlZeroMemory(iovSessionData, sessionDataSize);
00096 
00097     iovSessionData-&gt;<a class="code" href="../../d8/d1/struct__IOV__SESSION__DATA.html#o4">AssertFlags</a> = <a class="code" href="../../d8/d4/trackirp_8c.html#a7">IovpTrackingFlags</a>;
00098     iovSessionData-&gt;<a class="code" href="../../d8/d1/struct__IOV__SESSION__DATA.html#o0">IovRequestPacket</a> = headPacket;
00099     InsertHeadList(&amp;headPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o8">SessionHead</a>, &amp;iovSessionData-&gt;<a class="code" href="../../d8/d1/struct__IOV__SESSION__DATA.html#o2">SessionLink</a>);
00100 
00101     <span class="keywordflow">if</span> ((iovSessionData-&gt;<a class="code" href="../../d8/d1/struct__IOV__SESSION__DATA.html#o4">AssertFlags</a>&amp;<a class="code" href="../../d9/d4/trackirp_8h.html#a9">ASSERTFLAG_COMPLETEATPASSIVE</a>) ||
00102         (iovSessionData-&gt;<a class="code" href="../../d8/d1/struct__IOV__SESSION__DATA.html#o4">AssertFlags</a>&amp;<a class="code" href="../../d9/d4/trackirp_8h.html#a10">ASSERTFLAG_DEFERCOMPLETION</a>)) {
00103 
00104         iovSessionData-&gt;<a class="code" href="../../d8/d1/struct__IOV__SESSION__DATA.html#o4">AssertFlags</a> |= <a class="code" href="../../d9/d4/trackirp_8h.html#a7">ASSERTFLAG_FORCEPENDING</a>;
00105     }
00106 
00107     headPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o21">pIovSessionData</a> = iovSessionData;
00108     headPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o16">TopStackLocation</a> = irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o13">CurrentLocation</a>;
00109     headPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o5">Flags</a> |= <a class="code" href="../../d9/d4/trackirp_8h.html#a25">TRACKFLAG_ACTIVE</a>;
00110     headPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o5">Flags</a> &amp;=~ (
00111                           <a class="code" href="../../d9/d4/trackirp_8h.html#a29">TRACKFLAG_QUEUED_INTERNALLY</a>|
00112                           <a class="code" href="../../d9/d4/trackirp_8h.html#a31">TRACKFLAG_RELEASED</a>|
00113                           <a class="code" href="../../d9/d4/trackirp_8h.html#a32">TRACKFLAG_SRB_MUNGED</a>|
00114                           <a class="code" href="../../d9/d4/trackirp_8h.html#a33">TRACKFLAG_SWAPPED_BACK</a>|
00115                           <a class="code" href="../../d9/d4/trackirp_8h.html#a37">TRACKFLAG_PASSED_FAILURE</a>
00116                          );
00117 
00118     iovSessionData-&gt;<a class="code" href="../../d8/d1/struct__IOV__SESSION__DATA.html#o8">BestVisibleIrp</a> = irp;
00119     <span class="keywordflow">if</span> (useSurrogateIrp) {
00120 
00121         <span class="comment">//</span>
00122         <span class="comment">// We will track the IRP using a surrogate.</span>
00123         <span class="comment">//</span>
00124         *SurrogateSpawned = <a class="code" href="../../d6/d7/sessnirp_8h.html#a6">IovpSessionDataAttachSurrogate</a>(
00125             IovPacketPointer,
00126             iovSessionData
00127             );
00128     }
00129 
00130     <a class="code" href="../../d9/d4/trackirp_8h.html#a88">TRACKIRP_DBGPRINT</a>((
00131         <span class="stringliteral">"  SSN CREATE(%x)-&gt;%x\n"</span>,
00132         headPacket,
00133         iovSessionData
00134         ), 3) ;
00135     <span class="keywordflow">return</span> iovSessionData;
00136 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="sessnirp.c::IovpSessionDataDereference" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID FASTCALL IovpSessionDataDereference           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d1/struct__IOV__SESSION__DATA.html">PIOV_SESSION_DATA</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>IovSessionData</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d6/sessnirp_8c-source.html#l00152">152</a> of file <a class="el" href="../../d6/d6/sessnirp_8c-source.html">sessnirp.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d3/d4/ioassert_8h-source.html#l00165">ASSERT_SPINLOCK_HELD</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00201">_IOV_REQUEST_PACKET::HeadPacket</a>, <a class="el" href="../../d9/d7/hashirp_8c-source.html#l00612">IovpTrackingDataDereference()</a>, <a class="el" href="../../d9/d8/hashirp_8h.html#a21a4">IOVREFTYPE_PACKET</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00193">_IOV_REQUEST_PACKET::IrpLock</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00221">_IOV_REQUEST_PACKET::pIovSessionData</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00196">_IOV_REQUEST_PACKET::PointerCount</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00195">_IOV_REQUEST_PACKET::ReferenceCount</a>, and <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00712">TRACKIRP_DBGPRINT</a>.
<p>
Referenced by <a class="el" href="../../d9/d3/trackirp_8c-source.html#l00948">IovpCallDriver2()</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l01416">IovpCompleteRequest2()</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l01901">IovpCompleteRequest5()</a>, and <a class="el" href="../../d9/d3/trackirp_8c-source.html#l02751">IovpSwapSurrogateIrp()</a>.
<p>
<pre class="fragment"><div>00155 {
00156     <a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html">PIOV_REQUEST_PACKET</a> iovPacket, headPacket;
00157 
00158     iovPacket = IovSessionData-&gt;IovRequestPacket;
00159     headPacket = iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o9">HeadPacket</a>;
00160 
00161     <a class="code" href="../../d2/d5/ioassert_8h.html#a24">ASSERT_SPINLOCK_HELD</a>(&amp;headPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o1">IrpLock</a>);
00162     <a class="code" href="../../d2/d5/ioassert_8h.html#a24">ASSERT_SPINLOCK_HELD</a>(&amp;iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o1">IrpLock</a>);
00163     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(IovSessionData-&gt;SessionRefCount &gt; 0);
00164     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(headPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o3">ReferenceCount</a> &gt; 0);
00165     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o3">ReferenceCount</a> &gt;= 0);
00166 
00167     <a class="code" href="../../d9/d4/trackirp_8h.html#a88">TRACKIRP_DBGPRINT</a>((
00168         <span class="stringliteral">"  SSN DEREF(%x) %x--\n"</span>,
00169         IovSessionData,
00170         IovSessionData-&gt;SessionRefCount
00171         ), 3) ;
00172 
00173     IovSessionData-&gt;SessionRefCount--;
00174     <span class="keywordflow">if</span> (!IovSessionData-&gt;SessionRefCount) {
00175 
00176         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(headPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o21">pIovSessionData</a> != IovSessionData);
00177         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o3">ReferenceCount</a> &gt; iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o4">PointerCount</a>);
00178         <span class="comment">//ASSERT(IsListEmpty(&amp;IovSessionData-&gt;SessionLink));</span>
00179         RemoveEntryList(&amp;IovSessionData-&gt;SessionLink);
00180         InitializeListHead(&amp;IovSessionData-&gt;SessionLink);
00181 
00182         <a class="code" href="../../d9/d8/hashirp_8h.html#a14">IovpTrackingDataDereference</a>(iovPacket, IOVREFTYPE_PACKET);
00183 
00184         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(IovSessionData);
00185     }
00186 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="sessnirp.c::IovpSessionDataDeterminePolicy" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IovpSessionDataDeterminePolicy           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html">PIOV_REQUEST_PACKET</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IovRequestPacket</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PBOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>Trackable</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PBOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>UseSurrogateIrp</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d6/sessnirp_8c-source.html#l00240">240</a> of file <a class="el" href="../../d6/d6/sessnirp_8c-source.html">sessnirp.c</a>.
<p>
References <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00029">ASSERTFLAG_POLICEIRPS</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00032">ASSERTFLAG_SMASH_SRBS</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00031">ASSERTFLAG_SURROGATE</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00027">ASSERTFLAG_TRACKIRPS</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00050">HACKFLAG_FOR_MUP</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03398">IoGetNextIrpStackLocation</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l00122">IovpHackFlags</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l03436">IovpIsInterestingStack()</a>, <a class="el" href="../../d9/d3/trackirp_8c-source.html#l00121">IovpTrackingFlags</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00055">IRP_MJ_CREATE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00090">IRP_MJ_SCSI</a>, and <a class="el" href="../../d1/d4/io_8h-source.html#l02028">_IO_STACK_LOCATION::MajorFunction</a>.
<p>
Referenced by <a class="el" href="../../d6/d6/sessnirp_8c-source.html#l00027">IovpSessionDataCreate()</a>.
<p>
<pre class="fragment"><div>00248              :
00249 
00250     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called by <a class="code" href="../../d8/d4/trackirp_8c.html#a15">IovpCallDriver1</a> to determine which IRPs should
00251     be tracked and how that tracking should be done.
00252 
00253   Arguments:
00254 
00255     ADRIAO BUGBUG 12/31/1998 - Fill <span class="keyword">this</span> <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a>.
00256 
00257   Return Value:
00258 
00259      None.
00260 
00261 --*/
00262 {
00263     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> irpSp;
00264     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> irp;
00265 
00266     irp = IovRequestPacket-&gt;TrackedIrp;
00267 
00268     <span class="keywordflow">if</span> (!(<a class="code" href="../../d8/d4/trackirp_8c.html#a7">IovpTrackingFlags</a>&amp;<a class="code" href="../../d9/d4/trackirp_8h.html#a0">ASSERTFLAG_TRACKIRPS</a>)) {
00269 
00270         <span class="comment">//</span>
00271         <span class="comment">// No IRPs are to be tracked. Exit now.</span>
00272         <span class="comment">//</span>
00273         *Trackable = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00274         <span class="keywordflow">return</span>;
00275     }
00276 
00277     <span class="comment">//</span>
00278     <span class="comment">// Determine whether we are to monitor this IRP. If we are going to test</span>
00279     <span class="comment">// any one driver in a stack, then we must unfortunately monitor the IRP's</span>
00280     <span class="comment">// progress through the *entire* stack. Thus our granularity here is stack</span>
00281     <span class="comment">// based, not device based! We will compensate for this somewhat in the</span>
00282     <span class="comment">// driver check code, which will attempt to ignore asserts from those</span>
00283     <span class="comment">// "non-targetted" drivers who happen to have screwed up in our stack...</span>
00284     <span class="comment">//</span>
00285     *Trackable = <a class="code" href="../../d9/d4/trackirp_8h.html#a141">IovpIsInterestingStack</a>(DeviceObject);
00286 
00287     irpSp = <a class="code" href="../../d0/d5/io_8h.html#a230">IoGetNextIrpStackLocation</a>( irp );
00288 
00289     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d4/trackirp_8c.html#a7">IovpTrackingFlags</a>&amp;<a class="code" href="../../d9/d4/trackirp_8h.html#a2">ASSERTFLAG_POLICEIRPS</a>) {
00290 
00291         *UseSurrogateIrp = ((<a class="code" href="../../d8/d4/trackirp_8c.html#a7">IovpTrackingFlags</a>&amp;<a class="code" href="../../d9/d4/trackirp_8h.html#a4">ASSERTFLAG_SURROGATE</a>)!=0) ;
00292         *UseSurrogateIrp &amp;= ((irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a> != <a class="code" href="../../d0/d5/io_8h.html#a43">IRP_MJ_SCSI</a>) ||
00293                         ((<a class="code" href="../../d8/d4/trackirp_8c.html#a7">IovpTrackingFlags</a>&amp;<a class="code" href="../../d9/d4/trackirp_8h.html#a5">ASSERTFLAG_SMASH_SRBS</a>)!=0)) ;
00294 
00295 <span class="preprocessor">#ifdef HACKHACKS_ENABLED</span>
00296 <span class="preprocessor"></span>
00297         <span class="comment">//</span>
00298         <span class="comment">// ADRIAO HACKHACK #05 05/30/98 -</span>
00299         <span class="comment">// We don't surrogate creates right now because MUP touches IRPs</span>
00300         <span class="comment">// after they are completed.</span>
00301         <span class="comment">//</span>
00302         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d4/trackirp_8c.html#a8">IovpHackFlags</a>&amp;<a class="code" href="../../d9/d4/trackirp_8h.html#a15">HACKFLAG_FOR_MUP</a>) {
00303             *UseSurrogateIrp &amp;= (irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a> != <a class="code" href="../../d0/d5/io_8h.html#a13">IRP_MJ_CREATE</a>) ;
00304         }
00305 <span class="preprocessor">#endif</span>
00306 <span class="preprocessor"></span>    } <span class="keywordflow">else</span> {
00307 
00308         *UseSurrogateIrp = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00309     }
00310 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="sessnirp.c::IovpSessionDataFinalizeSurrogate" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID FASTCALL IovpSessionDataFinalizeSurrogate           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d1/struct__IOV__SESSION__DATA.html">PIOV_SESSION_DATA</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IovSessionData</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT <a class="el" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html">PIOV_REQUEST_PACKET</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IovPacket</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>SurrogateIrp</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d6/sessnirp_8c-source.html#l00523">523</a> of file <a class="el" href="../../d6/d6/sessnirp_8c-source.html">sessnirp.c</a>.
<p>
References <a class="el" href="../../d1/d4/io_8h-source.html#l01680">_IRP::AllocationFlags</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01674">_IRP::ApcEnvironment</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d2/struct__IRP.html#o7">_IRP::AssociatedIrp</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01661">_IRP::Cancel</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01602">_IRP::Flags</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00197">_IOV_REQUEST_PACKET::Flags</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03620">IoMarkIrpPending</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01635">_IRP::IoStatus</a>, <a class="el" href="../../d9/d7/hashirp_8c-source.html#l00838">IovpProtectedIrpFree()</a>, <a class="el" href="../../d9/d7/hashirp_8c-source.html#l00744">IovpProtectedIrpMakeUntouchable()</a>, <a class="el" href="../../d9/d7/hashirp_8c-source.html#l00612">IovpTrackingDataDereference()</a>, <a class="el" href="../../d9/d7/hashirp_8c-source.html#l00657">IovpTrackingDataGetCurrentSessionData()</a>, <a class="el" href="../../d9/d8/hashirp_8h.html#a21a5">IOVREFTYPE_POINTER</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01555">IRP_DEALLOCATE_BUFFER</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00066">IRP_DIAG_HAS_SURROGATE</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00067">IRP_DIAG_IS_SURROGATE</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00061">IRPFLAG_EXAMINE_MASK</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01596">_IRP::MdlAddress</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d0/d2/struct__IRP.html#o24">_IRP::Overlay</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01648">_IRP::PendingReturned</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01641">_IRP::RequestorMode</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01654">_IRP::StackCount</a>, <a class="el" href="../../d0/d2/struct__IRP.html#o38">_IRP::Tail</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00192">_IOV_REQUEST_PACKET::TrackedIrp</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00071">TRACKFLAG_SURROGATE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01584">_IRP::Type</a>, and <a class="el" href="../../d1/d4/io_8h-source.html#l01711">_IRP::UserBuffer</a>.
<p>
Referenced by <a class="el" href="../../d9/d3/trackirp_8c-source.html#l02751">IovpSwapSurrogateIrp()</a>.
<p>
<pre class="fragment"><div>00530              :
00531 
00532     This routine removes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> flags from both <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> real and
00533     surrogate <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> and records <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">final</span> <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> settings. Finally,
00534     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> surrogate <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a> <span class="stringliteral">"untouchable"</span> (decommitted).
00535 
00536   Arguments:
00537 
00538     iovPacket              - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> tracking data.
00539 
00540   Return Value:
00541 
00542      None.
00543 --*/
00544 {
00545     <a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html">PIOV_REQUEST_PACKET</a> iovPrevPacket;
00546     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status, lockedStatus;
00547     ULONG nonInterestingFlags;
00548     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> irpSp;
00549     PVOID restoreHandle;
00550     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> irp;
00551 
00552     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(IovPacket-&gt;Flags&amp;TRACKFLAG_SURROGATE);
00553 
00554     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d9/d8/hashirp_8h.html#a16">IovpTrackingDataGetCurrentSessionData</a>(IovPacket) == IovSessionData);
00555 
00556     <span class="comment">//</span>
00557     <span class="comment">// It's a surrogate, do as appropriate.</span>
00558     <span class="comment">//</span>
00559     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(IovPacket-&gt;TopStackLocation == SurrogateIrp-&gt;CurrentLocation+1) ;
00560 
00561     iovPrevPacket = CONTAINING_RECORD(
00562         IovPacket-&gt;SurrogateLink.Blink,
00563         <a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html">IOV_REQUEST_PACKET</a>,
00564         SurrogateLink
00565         );
00566 
00567     irp = iovPrevPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o0">TrackedIrp</a>;
00568 
00569     <span class="comment">//</span>
00570     <span class="comment">// Carry the pending bit over.</span>
00571     <span class="comment">//</span>
00572     <span class="keywordflow">if</span> (SurrogateIrp-&gt;PendingReturned) {
00573         <a class="code" href="../../d0/d5/io_8h.html#a234">IoMarkIrpPending</a>(irp);
00574     }
00575 
00576     nonInterestingFlags = (
00577         <a class="code" href="../../d9/d4/trackirp_8h.html#a19">IRPFLAG_EXAMINE_MASK</a> |
00578         <a class="code" href="../../d9/d4/trackirp_8h.html#a24">IRP_DIAG_IS_SURROGATE</a>|
00579         <a class="code" href="../../d9/d4/trackirp_8h.html#a23">IRP_DIAG_HAS_SURROGATE</a>
00580         );
00581 
00582     <span class="comment">//</span>
00583     <span class="comment">// Wipe the flags nice and clean</span>
00584     <span class="comment">//</span>
00585     SurrogateIrp-&gt;Flags &amp;=~ IRP_DIAG_IS_SURROGATE;
00586     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a>          &amp;=~ IRP_DIAG_HAS_SURROGATE;
00587 
00588     <span class="comment">//</span>
00589     <span class="comment">// ASSERT portions of the IRP header have not changed.</span>
00590     <span class="comment">//</span>
00591     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o12">StackCount</a> == SurrogateIrp-&gt;StackCount); <span class="comment">// Later to be removed</span>
00592 
00593     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o0">Type</a> == SurrogateIrp-&gt;Type);
00594     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o10">RequestorMode</a> == SurrogateIrp-&gt;RequestorMode);
00595     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o16">ApcEnvironment</a> == SurrogateIrp-&gt;ApcEnvironment);
00596     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o17">AllocationFlags</a> == SurrogateIrp-&gt;AllocationFlags);
00597     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o26">UserBuffer</a> == SurrogateIrp-&gt;UserBuffer);
00598     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.Thread == SurrogateIrp-&gt;Tail.Overlay.Thread);
00599 
00600     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(
00601         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o24">Overlay</a>.AsynchronousParameters.UserApcRoutine ==
00602         SurrogateIrp-&gt;Overlay.AsynchronousParameters.UserApcRoutine
00603         );
00604 
00605     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(
00606         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o24">Overlay</a>.AsynchronousParameters.UserApcContext ==
00607         SurrogateIrp-&gt;Overlay.AsynchronousParameters.UserApcContext
00608         );
00609 
00610     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(
00611         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.OriginalFileObject ==
00612         SurrogateIrp-&gt;Tail.Overlay.OriginalFileObject
00613         );
00614 
00615     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(
00616         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.AuxiliaryBuffer ==
00617         SurrogateIrp-&gt;Tail.Overlay.AuxiliaryBuffer
00618         );
00619 
00620 <span class="comment">/*</span>
00621 <span class="comment">    ASSERT(</span>
00622 <span class="comment">        irp-&gt;AssociatedIrp.SystemBuffer ==</span>
00623 <span class="comment">        SurrogateIrp-&gt;AssociatedIrp.SystemBuffer</span>
00624 <span class="comment">        );</span>
00625 <span class="comment"></span>
00626 <span class="comment">    ASSERT(</span>
00627 <span class="comment">        (irp-&gt;Flags          &amp; ~nonInterestingFlags) ==</span>
00628 <span class="comment">        (SurrogateIrp-&gt;Flags &amp; ~nonInterestingFlags)</span>
00629 <span class="comment">        );</span>
00630 <span class="comment"></span>
00631 <span class="comment">    ASSERT(irp-&gt;MdlAddress == SurrogateIrp-&gt;MdlAddress);</span>
00632 <span class="comment">*/</span>
00633     <span class="comment">//</span>
00634     <span class="comment">// ADRIAO BUGBUG 02/28/1999 -</span>
00635     <span class="comment">//     How do these change as an IRP progresses?</span>
00636     <span class="comment">//</span>
00637     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> |= SurrogateIrp-&gt;Flags;
00638     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o2">MdlAddress</a> = SurrogateIrp-&gt;MdlAddress;
00639     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o7">AssociatedIrp</a>.SystemBuffer = SurrogateIrp-&gt;AssociatedIrp.SystemBuffer;
00640 
00641     <span class="keywordflow">if</span> ((irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a>&amp;<a class="code" href="../../d0/d5/io_8h.html#a179">IRP_DEALLOCATE_BUFFER</a>)&amp;&amp;
00642         (irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o7">AssociatedIrp</a>.SystemBuffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00643 
00644         irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a> &amp;=~ IRP_DEALLOCATE_BUFFER;
00645     }
00646 
00647     <span class="comment">//</span>
00648     <span class="comment">// Copy the salient fields back. We only need to touch certain areas of the</span>
00649     <span class="comment">// header.</span>
00650     <span class="comment">//</span>
00651     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a> = SurrogateIrp-&gt;IoStatus;
00652     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o11">PendingReturned</a> = SurrogateIrp-&gt;PendingReturned;
00653     irp-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o14">Cancel</a> = SurrogateIrp-&gt;Cancel;
00654 
00655     iovPrevPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o5">Flags</a> &amp;=~ TRACKFLAG_HAS_SURROGATE;
00656 
00657     <span class="comment">//</span>
00658     <span class="comment">// Record data from it and make the system fault if the IRP is touched</span>
00659     <span class="comment">// after this completion routine.</span>
00660     <span class="comment">//</span>
00661     IovSessionData-&gt;BestVisibleIrp = irp;
00662 
00663     <a class="code" href="../../d9/d8/hashirp_8h.html#a14">IovpTrackingDataDereference</a>(iovPrevPacket, IOVREFTYPE_POINTER);
00664 
00665     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(IovPacket-&gt;PointerCount == 0);
00666 
00667     restoreHandle = <a class="code" href="../../d9/d8/hashirp_8h.html#a17">IovpProtectedIrpMakeUntouchable</a>(SurrogateIrp, TRUE);
00668     <a class="code" href="../../d9/d8/hashirp_8h.html#a19">IovpProtectedIrpFree</a>(SurrogateIrp, &amp;restoreHandle);
00669 }
<span class="preprocessor">#endif // NO_SPECIAL_IRP</span>
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="sessnirp.c::IovpSessionDataReference" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID FASTCALL IovpSessionDataReference           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d1/struct__IOV__SESSION__DATA.html">PIOV_SESSION_DATA</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>IovSessionData</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d6/sessnirp_8c-source.html#l00190">190</a> of file <a class="el" href="../../d6/d6/sessnirp_8c-source.html">sessnirp.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d3/d4/ioassert_8h-source.html#l00165">ASSERT_SPINLOCK_HELD</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00201">_IOV_REQUEST_PACKET::HeadPacket</a>, <a class="el" href="../../d9/d7/hashirp_8c-source.html#l00584">IovpTrackingDataReference()</a>, <a class="el" href="../../d9/d8/hashirp_8h.html#a21a4">IOVREFTYPE_PACKET</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00193">_IOV_REQUEST_PACKET::IrpLock</a>, <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00195">_IOV_REQUEST_PACKET::ReferenceCount</a>, and <a class="el" href="../../d0/d4/trackirp_8h-source.html#l00712">TRACKIRP_DBGPRINT</a>.
<p>
Referenced by <a class="el" href="../../d9/d3/trackirp_8c-source.html#l00493">IovpCallDriver1()</a>, and <a class="el" href="../../d9/d3/trackirp_8c-source.html#l01416">IovpCompleteRequest2()</a>.
<p>
<pre class="fragment"><div>00193 {
00194     <a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html">PIOV_REQUEST_PACKET</a> iovPacket, headPacket;
00195 
00196     iovPacket = IovSessionData-&gt;IovRequestPacket;
00197     headPacket = iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o9">HeadPacket</a>;
00198 
00199     <a class="code" href="../../d2/d5/ioassert_8h.html#a24">ASSERT_SPINLOCK_HELD</a>(&amp;headPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o1">IrpLock</a>);
00200     <a class="code" href="../../d2/d5/ioassert_8h.html#a24">ASSERT_SPINLOCK_HELD</a>(&amp;iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o1">IrpLock</a>);
00201     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(IovSessionData-&gt;SessionRefCount &gt;= 0);
00202     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(headPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o3">ReferenceCount</a> &gt;= 0);
00203     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(iovPacket-&gt;<a class="code" href="../../d7/d1/struct__IOV__REQUEST__PACKET.html#o3">ReferenceCount</a> &gt;= 0);
00204 
00205     <a class="code" href="../../d9/d4/trackirp_8h.html#a88">TRACKIRP_DBGPRINT</a>((
00206         <span class="stringliteral">"  SSN REF(%x) %x++\n"</span>,
00207         IovSessionData,
00208         IovSessionData-&gt;SessionRefCount
00209         ), 3) ;
00210 
00211     <span class="keywordflow">if</span> (!IovSessionData-&gt;SessionRefCount) {
00212 
00213         <a class="code" href="../../d9/d8/hashirp_8h.html#a13">IovpTrackingDataReference</a>(iovPacket, IOVREFTYPE_PACKET);
00214     }
00215     IovSessionData-&gt;SessionRefCount++;
00216 }
</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:45:38 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
