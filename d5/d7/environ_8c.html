<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: environ.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>environ.c File Reference</h1><code>#include "<a class="el" href="../../d6/d8/ntrtlp_8h-source.html">ntrtlp.h</a>"</code><br>
<code>#include "zwapi.h"</code><br>
<code>#include "nturtl.h"</code><br>
<code>#include "string.h"</code><br>

<p>
<a href="../../d6/d6/environ_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d7/environ_8c.html#a3">RtlCreateEnvironment</a> (IN BOOLEAN CloneCurrentEnvironment OPTIONAL, OUT PVOID *Environment)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d7/environ_8c.html#a4">RtlDestroyEnvironment</a> (IN PVOID Environment)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d7/environ_8c.html#a5">RtlSetCurrentEnvironment</a> (IN PVOID Environment, OUT PVOID *PreviousEnvironment OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d7/environ_8c.html#a6">RtlQueryEnvironmentVariable_U</a> (IN PVOID Environment OPTIONAL, IN PUNICODE_STRING <a class="el" href="../../d9/d3/rules_8c.html#a6">Name</a>, IN OUT PUNICODE_STRING Value)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d7/environ_8c.html#a7">RtlSetEnvironmentVariable</a> (IN OUT PVOID *Environment OPTIONAL, IN PUNICODE_STRING <a class="el" href="../../d9/d3/rules_8c.html#a6">Name</a>, IN PUNICODE_STRING Value OPTIONAL)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d7/environ_8c.html#a0">RtlpEnvironCacheValid</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>UNICODE_STRING&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d7/environ_8c.html#a1">RtlpEnvironCacheName</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>UNICODE_STRING&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d7/environ_8c.html#a2">RtlpEnvironCacheValue</a></td></tr>

</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a3" doxytag="environ.c::RtlCreateEnvironment" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlCreateEnvironment           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN BOOLEAN CloneCurrentEnvironment&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>Environment</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d6/environ_8c-source.html#l00035">35</a> of file <a class="el" href="../../d6/d6/environ_8c-source.html">environ.c</a>.
<p>
References <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d3/d3/eballoc_8c-source.html#l00032">RtlAcquirePebLock()</a>, <a class="el" href="../../d3/d3/eballoc_8c-source.html#l00047">RtlReleasePebLock()</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
Referenced by <a class="el" href="../../d3/d9/tenv_8c-source.html#l00093">main()</a>.
<p>
<pre class="fragment"><div>00039 {
00040     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00041     MEMORY_BASIC_INFORMATION MemoryInformation;
00042     PVOID pNew, pOld;
00043 
00044     <span class="comment">//</span>
00045     <span class="comment">// If not cloning a copy of the current process's environment variable</span>
00046     <span class="comment">// block, just allocate a block of committed memory and return its</span>
00047     <span class="comment">// address.</span>
00048     <span class="comment">//</span>
00049 
00050     pNew = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00051     <span class="keywordflow">if</span> (!CloneCurrentEnvironment) {
00052 createEmptyEnvironment:
00053         MemoryInformation.RegionSize = 1;
00054         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwAllocateVirtualMemory( NtCurrentProcess(),
00055                                           &amp;pNew,
00056                                           0,
00057                                           &amp;MemoryInformation.RegionSize,
00058                                           MEM_COMMIT,
00059                                           PAGE_READWRITE
00060                                         );
00061         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00062             *Environment = pNew;
00063             }
00064 
00065         <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00066         }
00067 
00068     <span class="comment">//</span>
00069     <span class="comment">// Acquire the Peb Lock for the duration while we munge the environment</span>
00070     <span class="comment">// variable storage block.</span>
00071     <span class="comment">//</span>
00072 
00073     <a class="code" href="../../d2/d4/eballoc_8c.html#a1">RtlAcquirePebLock</a>();
00074 
00075     <span class="comment">//</span>
00076     <span class="comment">// Capture the pointer to the current process's environment variable</span>
00077     <span class="comment">// block and initialize the new pointer to null for our finally clause.</span>
00078     <span class="comment">//</span>
00079 
00080     pOld = NtCurrentPeb()-&gt;ProcessParameters-&gt;Environment;
00081     <span class="keywordflow">if</span> (pOld == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00082         <a class="code" href="../../d2/d4/eballoc_8c.html#a2">RtlReleasePebLock</a>();
00083         <span class="keywordflow">goto</span> createEmptyEnvironment;
00084         }
00085 
00086     <span class="keywordflow">try</span> {
00087         <span class="comment">//</span>
00088         <span class="comment">// Query the current size of the current process's environment</span>
00089         <span class="comment">// variable block.  Return status if failure.</span>
00090         <span class="comment">//</span>
00091 
00092         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwQueryVirtualMemory( NtCurrentProcess(),
00093                                        pOld,
00094                                        MemoryBasicInformation,
00095                                        &amp;MemoryInformation,
00096                                        <span class="keyword">sizeof</span>( MemoryInformation ),
00097                                        NULL
00098                                      );
00099         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00100             <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00101             }
00102 
00103         <span class="comment">//</span>
00104         <span class="comment">// Allocate memory to contain a copy of the current process's</span>
00105         <span class="comment">// environment variable block.  Return status if failure.</span>
00106         <span class="comment">//</span>
00107 
00108         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwAllocateVirtualMemory( NtCurrentProcess(),
00109                                           &amp;pNew,
00110                                           0,
00111                                           &amp;MemoryInformation.RegionSize,
00112                                           MEM_COMMIT,
00113                                           PAGE_READWRITE
00114                                         );
00115         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00116             <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00117             }
00118 
00119         <span class="comment">//</span>
00120         <span class="comment">// Copy the current process's environment to the allocated memory</span>
00121         <span class="comment">// and return a pointer to the copy.</span>
00122         <span class="comment">//</span>
00123 
00124         RtlMoveMemory( pNew, pOld, MemoryInformation.RegionSize );
00125         *Environment = pNew;
00126         }
00127     finally {
00128         <span class="keywordflow">if</span> (AbnormalTermination()) {
00129             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_ACCESS_VIOLATION;
00130             <span class="keywordflow">if</span> (pNew != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00131                 ZwFreeVirtualMemory( NtCurrentProcess(),
00132                                      &amp;pNew,
00133                                      &amp;MemoryInformation.RegionSize,
00134                                      MEM_RELEASE
00135                                    );
00136                 }
00137             }
00138 
00139         <a class="code" href="../../d2/d4/eballoc_8c.html#a2">RtlReleasePebLock</a>();
00140         }
00141 
00142     <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00143 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="environ.c::RtlDestroyEnvironment" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlDestroyEnvironment           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Environment</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d6/environ_8c-source.html#l00147">147</a> of file <a class="el" href="../../d6/d6/environ_8c-source.html">environ.c</a>.
<p>
References <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
Referenced by <a class="el" href="../../d6/d6/environ_8c-source.html#l00173">RtlSetCurrentEnvironment()</a>.
<p>
<pre class="fragment"><div>00150 {
00151     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00152     SIZE_T RegionSize;
00153 
00154     <span class="comment">//</span>
00155     <span class="comment">// Free the specified environment variable block.</span>
00156     <span class="comment">//</span>
00157 
00158     RegionSize = 0;
00159     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwFreeVirtualMemory( NtCurrentProcess(),
00160                                   &amp;Environment,
00161                                   &amp;RegionSize,
00162                                   MEM_RELEASE
00163                                 );
00164     <span class="comment">//</span>
00165     <span class="comment">// Return status.</span>
00166     <span class="comment">//</span>
00167 
00168     <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00169 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="environ.c::RtlQueryEnvironmentVariable_U" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlQueryEnvironmentVariable_U           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID Environment&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>Name</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>Value</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d6/environ_8c-source.html#l00250">250</a> of file <a class="el" href="../../d6/d6/environ_8c-source.html">environ.c</a>.
<p>
References <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d9/d9/geninst_8c-source.html#l00154">Name</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d3/d3/eballoc_8c-source.html#l00032">RtlAcquirePebLock()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01608">RtlEqualUnicodeString()</a>, <a class="el" href="../../d6/d6/environ_8c-source.html#l00246">RtlpEnvironCacheName</a>, <a class="el" href="../../d6/d6/environ_8c-source.html#l00245">RtlpEnvironCacheValid</a>, <a class="el" href="../../d6/d6/environ_8c-source.html#l00247">RtlpEnvironCacheValue</a>, <a class="el" href="../../d3/d3/eballoc_8c-source.html#l00047">RtlReleasePebLock()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l02277">LdrQueryApplicationCompatibilityGoo()</a>, <a class="el" href="../../d5/d6/rtl_2regutil_8c-source.html#l01325">RtlExpandEnvironmentStrings_U()</a>, <a class="el" href="../../d6/d0/curdir_8c-source.html#l00920">RtlGetFullPathName_Ustr()</a>, and <a class="el" href="../../d6/d0/curdir_8c-source.html#l02341">RtlpCheckRelativeDrive()</a>.
<p>
<pre class="fragment"><div>00255 {
00256     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00257     UNICODE_STRING CurrentName;
00258     UNICODE_STRING CurrentValue;
00259     PWSTR p;
00260     PPEB Peb;
00261 
00262     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_VARIABLE_NOT_FOUND;
00263     Peb = NtCurrentPeb();
00264 
00265     <span class="keywordflow">try</span> {
00266         <span class="keywordflow">if</span> (ARGUMENT_PRESENT( Environment )) {
00267             p = Environment;
00268             <span class="keywordflow">if</span> (*p == UNICODE_NULL) {
00269                 leave;
00270                 }
00271             }
00272         <span class="keywordflow">else</span> {
00273             <span class="comment">//</span>
00274             <span class="comment">// Acquire the Peb Lock for the duration while we munge the</span>
00275             <span class="comment">// environment variable storage block.</span>
00276             <span class="comment">//</span>
00277 
00278             <a class="code" href="../../d2/d4/eballoc_8c.html#a1">RtlAcquirePebLock</a>();
00279 
00280             <span class="comment">//</span>
00281             <span class="comment">// Capture the pointer to the current process's environment variable</span>
00282             <span class="comment">// block.</span>
00283             <span class="comment">//</span>
00284 
00285             p = Peb-&gt;ProcessParameters-&gt;Environment;
00286 
00287             }
00288 <span class="preprocessor">#if DBG</span>
00289 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (*p == UNICODE_NULL)
00290             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"RTL: QEV - Empty Environment being searched: %08x\n"</span>, p);
00291         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((UCHAR)((*p) &gt;&gt; 8) != <span class="charliteral">'\0'</span>)
00292             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"RTL: QEV - Possible ANSI Environment being searched: %08x\n"</span>, p);
00293 <span class="preprocessor">#endif</span>
00294 <span class="preprocessor"></span>
00295         <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d7/environ_8c.html#a0">RtlpEnvironCacheValid</a> &amp;&amp; p == Peb-&gt;ProcessParameters-&gt;Environment ) {
00296             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/nls_8c.html#a42">RtlEqualUnicodeString</a>( Name, &amp;RtlpEnvironCacheName, TRUE )) {
00297 
00298                 <span class="comment">//</span>
00299                 <span class="comment">// Names are equal.  Always return the length of the</span>
00300                 <span class="comment">// value string, excluding the terminating null.  If</span>
00301                 <span class="comment">// there is room in the caller's buffer, return a copy</span>
00302                 <span class="comment">// of the value string and success status.  Otherwise</span>
00303                 <span class="comment">// return an error status.  In the latter case, the caller</span>
00304                 <span class="comment">// can examine the length field of their value string</span>
00305                 <span class="comment">// so they can determine much memory is needed.</span>
00306                 <span class="comment">//</span>
00307 
00308                 Value-&gt;Length = <a class="code" href="../../d5/d7/environ_8c.html#a2">RtlpEnvironCacheValue</a>.Length;
00309                 <span class="keywordflow">if</span> (Value-&gt;MaximumLength &gt;= <a class="code" href="../../d5/d7/environ_8c.html#a2">RtlpEnvironCacheValue</a>.Length) {
00310                     RtlMoveMemory( Value-&gt;Buffer,
00311                                    <a class="code" href="../../d5/d7/environ_8c.html#a2">RtlpEnvironCacheValue</a>.Buffer,
00312                                    <a class="code" href="../../d5/d7/environ_8c.html#a2">RtlpEnvironCacheValue</a>.Length
00313                                  );
00314                     <span class="comment">//</span>
00315                     <span class="comment">// Null terminate returned string if there is room.</span>
00316                     <span class="comment">//</span>
00317 
00318                     <span class="keywordflow">if</span> (Value-&gt;MaximumLength &gt; <a class="code" href="../../d5/d7/environ_8c.html#a2">RtlpEnvironCacheValue</a>.Length) {
00319                         Value-&gt;Buffer[ <a class="code" href="../../d5/d7/environ_8c.html#a2">RtlpEnvironCacheValue</a>.Length/<span class="keyword">sizeof</span>(WCHAR) ] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
00320                         }
00321 
00322                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00323                     }
00324                 <span class="keywordflow">else</span> {
00325                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_BUFFER_TOO_SMALL;
00326                     }
00327                 <span class="keywordflow">goto</span> environcachehit;
00328                 }
00329             }
00330 
00331         <span class="comment">//</span>
00332         <span class="comment">// The environment variable block consists of zero or more null</span>
00333         <span class="comment">// terminated UNICODE strings.  Each string is of the form:</span>
00334         <span class="comment">//</span>
00335         <span class="comment">//      name=value</span>
00336         <span class="comment">//</span>
00337         <span class="comment">// where the null termination is after the value.</span>
00338         <span class="comment">//</span>
00339 
00340         <span class="keywordflow">if</span> (p != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) <span class="keywordflow">while</span> (*p) {
00341             <span class="comment">//</span>
00342             <span class="comment">// Determine the size of the name and value portions of</span>
00343             <span class="comment">// the current string of the environment variable block.</span>
00344             <span class="comment">//</span>
00345 
00346             CurrentName.Buffer = p;
00347             CurrentName.Length = 0;
00348             CurrentName.MaximumLength = 0;
00349             <span class="keywordflow">while</span> (*p) {
00350                 <span class="comment">//</span>
00351                 <span class="comment">// If we see an equal sign, then compute the size of</span>
00352                 <span class="comment">// the name portion and scan for the end of the value.</span>
00353                 <span class="comment">//</span>
00354 
00355                 <span class="keywordflow">if</span> (*p == <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'='</span> &amp;&amp; p != CurrentName.Buffer) {
00356                     CurrentName.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(p - CurrentName.Buffer)*<span class="keyword">sizeof</span>(WCHAR);
00357                     CurrentName.MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(CurrentName.Length+<span class="keyword">sizeof</span>(WCHAR));
00358                     CurrentValue.Buffer = ++p;
00359 
00360                     <span class="keywordflow">while</span>(*p) {
00361                         p++;
00362                         }
00363                     CurrentValue.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(p - CurrentValue.Buffer)*<span class="keyword">sizeof</span>(WCHAR);
00364                     CurrentValue.MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(CurrentValue.Length+<span class="keyword">sizeof</span>(WCHAR));
00365 
00366                     <span class="comment">//</span>
00367                     <span class="comment">// At this point we have the length of both the name</span>
00368                     <span class="comment">// and value portions, so exit the loop so we can</span>
00369                     <span class="comment">// do the compare.</span>
00370                     <span class="comment">//</span>
00371                     <span class="keywordflow">break</span>;
00372                     }
00373                 <span class="keywordflow">else</span> {
00374                     p++;
00375                     }
00376                 }
00377 
00378             <span class="comment">//</span>
00379             <span class="comment">// Skip over the terminating null character for this name=value</span>
00380             <span class="comment">// pair in preparation for the next iteration of the loop.</span>
00381             <span class="comment">//</span>
00382 
00383             p++;
00384 
00385             <span class="comment">//</span>
00386             <span class="comment">// Compare the current name with the one requested, ignore</span>
00387             <span class="comment">// case.</span>
00388             <span class="comment">//</span>
00389 
00390             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/nls_8c.html#a42">RtlEqualUnicodeString</a>( Name, &amp;CurrentName, TRUE )) {
00391                 <span class="comment">//</span>
00392                 <span class="comment">// Names are equal.  Always return the length of the</span>
00393                 <span class="comment">// value string, excluding the terminating null.  If</span>
00394                 <span class="comment">// there is room in the caller's buffer, return a copy</span>
00395                 <span class="comment">// of the value string and success status.  Otherwise</span>
00396                 <span class="comment">// return an error status.  In the latter case, the caller</span>
00397                 <span class="comment">// can examine the length field of their value string</span>
00398                 <span class="comment">// so they can determine much memory is needed.</span>
00399                 <span class="comment">//</span>
00400 
00401                 Value-&gt;Length = CurrentValue.Length;
00402                 <span class="keywordflow">if</span> (Value-&gt;MaximumLength &gt;= CurrentValue.Length) {
00403                     RtlMoveMemory( Value-&gt;Buffer,
00404                                    CurrentValue.Buffer,
00405                                    CurrentValue.Length
00406                                  );
00407                     <span class="comment">//</span>
00408                     <span class="comment">// Null terminate returned string if there is room.</span>
00409                     <span class="comment">//</span>
00410 
00411                     <span class="keywordflow">if</span> (Value-&gt;MaximumLength &gt; CurrentValue.Length) {
00412                         Value-&gt;Buffer[ CurrentValue.Length/<span class="keyword">sizeof</span>(WCHAR) ] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
00413                         }
00414 
00415                     <span class="keywordflow">if</span> ( !Environment || Environment == Peb-&gt;ProcessParameters-&gt;Environment) {
00416                         <a class="code" href="../../d5/d7/environ_8c.html#a0">RtlpEnvironCacheValid</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00417                         <a class="code" href="../../d5/d7/environ_8c.html#a1">RtlpEnvironCacheName</a> = CurrentName;
00418                         <a class="code" href="../../d5/d7/environ_8c.html#a2">RtlpEnvironCacheValue</a> = CurrentValue;
00419                         }
00420 
00421                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00422                     }
00423                 <span class="keywordflow">else</span> {
00424                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_BUFFER_TOO_SMALL;
00425                     }
00426                 <span class="keywordflow">break</span>;
00427                 }
00428             }
00429 environcachehit:;
00430         }
00431     finally {
00432         <span class="comment">//</span>
00433         <span class="comment">// If abnormally terminating, assume access violation.</span>
00434         <span class="comment">//</span>
00435 
00436         <span class="keywordflow">if</span> (AbnormalTermination()) {
00437             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_ACCESS_VIOLATION;
00438             }
00439 
00440         <span class="comment">//</span>
00441         <span class="comment">// Release the Peb lock.</span>
00442         <span class="comment">//</span>
00443 
00444         <span class="keywordflow">if</span> (!ARGUMENT_PRESENT( Environment )) {
00445             <a class="code" href="../../d2/d4/eballoc_8c.html#a2">RtlReleasePebLock</a>();
00446             }
00447         }
00448 
00449     <span class="comment">//</span>
00450     <span class="comment">// Return status.</span>
00451     <span class="comment">//</span>
00452 
00453     <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00454 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="environ.c::RtlSetCurrentEnvironment" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlSetCurrentEnvironment           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Environment</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID *PreviousEnvironment&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d6/environ_8c-source.html#l00173">173</a> of file <a class="el" href="../../d6/d6/environ_8c-source.html">environ.c</a>.
<p>
References <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d3/d3/eballoc_8c-source.html#l00032">RtlAcquirePebLock()</a>, <a class="el" href="../../d6/d6/environ_8c-source.html#l00147">RtlDestroyEnvironment()</a>, <a class="el" href="../../d3/d3/eballoc_8c-source.html#l00047">RtlReleasePebLock()</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
<pre class="fragment"><div>00177 {
00178     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00179     PVOID pOld;
00180 
00181     <span class="comment">//</span>
00182     <span class="comment">// Acquire the Peb Lock for the duration while we munge the environment</span>
00183     <span class="comment">// variable storage block.</span>
00184     <span class="comment">//</span>
00185 
00186     <a class="code" href="../../d2/d4/eballoc_8c.html#a1">RtlAcquirePebLock</a>();
00187 
00188     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00189     <span class="keywordflow">try</span> {
00190         <span class="comment">//</span>
00191         <span class="comment">// Capture current process's environment variable block pointer to</span>
00192         <span class="comment">// return to caller or destroy.</span>
00193         <span class="comment">//</span>
00194 
00195         pOld = NtCurrentPeb()-&gt;ProcessParameters-&gt;Environment;
00196 
00197         <span class="comment">//</span>
00198         <span class="comment">// Change current process's environment variable block pointer to</span>
00199         <span class="comment">// point to the passed block.</span>
00200         <span class="comment">//</span>
00201 
00202 
00203         NtCurrentPeb()-&gt;ProcessParameters-&gt;Environment = Environment;
00204 
00205         <span class="comment">//</span>
00206         <span class="comment">// If caller requested it, return the pointer to the previous</span>
00207         <span class="comment">// process environment variable block and set the local variable</span>
00208         <span class="comment">// to NULL so we dont destroy it below.</span>
00209         <span class="comment">//</span>
00210 
00211         <span class="keywordflow">if</span> (ARGUMENT_PRESENT( PreviousEnvironment )) {
00212             *PreviousEnvironment = pOld;
00213             pOld = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00214             }
00215         }
00216     finally {
00217         <span class="keywordflow">if</span> (AbnormalTermination()) {
00218             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_ACCESS_VIOLATION;
00219             pOld = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00220             }
00221         }
00222 
00223     <span class="comment">//</span>
00224     <span class="comment">// Release the Peb Lock</span>
00225     <span class="comment">//</span>
00226 
00227     <a class="code" href="../../d2/d4/eballoc_8c.html#a2">RtlReleasePebLock</a>();
00228 
00229 
00230     <span class="comment">//</span>
00231     <span class="comment">// If old environment not returned to caller, destroy it.</span>
00232     <span class="comment">//</span>
00233 
00234     <span class="keywordflow">if</span> (pOld != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00235         <a class="code" href="../../d5/d7/environ_8c.html#a4">RtlDestroyEnvironment</a>( pOld );
00236         }
00237 
00238     <span class="comment">//</span>
00239     <span class="comment">// Return status</span>
00240     <span class="comment">//</span>
00241 
00242     <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00243 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="environ.c::RtlSetEnvironmentVariable" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlSetEnvironmentVariable           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT PVOID *Environment&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>Name</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING Value&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d6/environ_8c-source.html#l00458">458</a> of file <a class="el" href="../../d6/d6/environ_8c-source.html">environ.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d8/d9/exts_8h-source.html#l00092">n</a>, <a class="el" href="../../d9/d9/geninst_8c-source.html#l00154">Name</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d3/d3/eballoc_8c-source.html#l00032">RtlAcquirePebLock()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01520">RtlCompareUnicodeString()</a>, <a class="el" href="../../d6/d6/environ_8c-source.html#l00245">RtlpEnvironCacheValid</a>, <a class="el" href="../../d3/d3/eballoc_8c-source.html#l00047">RtlReleasePebLock()</a>, <a class="el" href="../../d9/d6/lh__open_2pi__mem_8h-source.html#l00017">Size</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/curdir_8c-source.html#l00120">RtlpResetDriveEnvironment()</a>, and <a class="el" href="../../d3/d9/tenv_8c-source.html#l00046">SetEnvironment()</a>.
<p>
<pre class="fragment"><div>00463 {
00464     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00465     MEMORY_BASIC_INFORMATION MemoryInformation;
00466     UNICODE_STRING CurrentName;
00467     UNICODE_STRING CurrentValue;
00468     PVOID pOld, pNew;
00469     ULONG <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a>, <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
00470     SIZE_T NewSize;
00471     LONG CompareResult;
00472     PWSTR p, pStart, pEnd;
00473 
00474     <span class="comment">//</span>
00475     <span class="comment">// Validate passed in name and reject if zero length or anything but the first</span>
00476     <span class="comment">// character is an equal sign.</span>
00477     <span class="comment">//</span>
00478     <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a> = <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Length / <span class="keyword">sizeof</span>( WCHAR );
00479     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d0/exts_8h.html#a0">n</a> == 0) {
00480         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00481         }
00482 
00483     <span class="keywordflow">try</span> {
00484         p = <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Buffer;
00485         <span class="keywordflow">while</span> (--<a class="code" href="../../d7/d0/exts_8h.html#a0">n</a>) {
00486             <span class="keywordflow">if</span> (*++p == <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'='</span>) {
00487                 <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00488                 }
00489             }
00490         }
00491     except (EXCEPTION_EXECUTE_HANDLER) {
00492         <span class="keywordflow">return</span> GetExceptionCode();
00493         }
00494 
00495     <a class="code" href="../../d5/d7/environ_8c.html#a0">RtlpEnvironCacheValid</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00496     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_VARIABLE_NOT_FOUND;
00497     <span class="keywordflow">if</span> (ARGUMENT_PRESENT( Environment )) {
00498         pOld = *Environment;
00499         }
00500     <span class="keywordflow">else</span> {
00501         <span class="comment">//</span>
00502         <span class="comment">// Acquire the Peb Lock for the duration while we munge the</span>
00503         <span class="comment">// environment variable storage block.</span>
00504         <span class="comment">//</span>
00505 
00506         <a class="code" href="../../d2/d4/eballoc_8c.html#a1">RtlAcquirePebLock</a>();
00507 
00508         <span class="comment">//</span>
00509         <span class="comment">// Capture the pointer to the current process's environment variable</span>
00510         <span class="comment">// block.</span>
00511         <span class="comment">//</span>
00512 
00513         pOld = NtCurrentPeb()-&gt;ProcessParameters-&gt;Environment;
00514         }
00515     pNew = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00516 
00517     <span class="keywordflow">try</span> {
00518         <span class="comment">//</span>
00519         <span class="comment">// The environment variable block consists of zero or more null</span>
00520         <span class="comment">// terminated UNICODE strings.  Each string is of the form:</span>
00521         <span class="comment">//</span>
00522         <span class="comment">//      name=value</span>
00523         <span class="comment">//</span>
00524         <span class="comment">// where the null termination is after the value.</span>
00525         <span class="comment">//</span>
00526 
00527         p = pOld;
00528         pEnd = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00529         <span class="keywordflow">if</span> (p != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) <span class="keywordflow">while</span> (*p) {
00530             <span class="comment">//</span>
00531             <span class="comment">// Determine the size of the name and value portions of</span>
00532             <span class="comment">// the current string of the environment variable block.</span>
00533             <span class="comment">//</span>
00534 
00535             CurrentName.Buffer = p;
00536             CurrentName.Length = 0;
00537             CurrentName.MaximumLength = 0;
00538             <span class="keywordflow">while</span> (*p) {
00539                 <span class="comment">//</span>
00540                 <span class="comment">// If we see an equal sign, then compute the size of</span>
00541                 <span class="comment">// the name portion and scan for the end of the value.</span>
00542                 <span class="comment">//</span>
00543 
00544                 <span class="keywordflow">if</span> (*p == <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'='</span> &amp;&amp; p != CurrentName.Buffer) {
00545                     CurrentName.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(p - CurrentName.Buffer) * <span class="keyword">sizeof</span>(WCHAR);
00546                     CurrentName.MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(CurrentName.Length+<span class="keyword">sizeof</span>(WCHAR));
00547                     CurrentValue.Buffer = ++p;
00548 
00549                     <span class="keywordflow">while</span>(*p) {
00550                         p++;
00551                         }
00552                     CurrentValue.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(p - CurrentValue.Buffer) * <span class="keyword">sizeof</span>(WCHAR);
00553                     CurrentValue.MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(CurrentValue.Length+<span class="keyword">sizeof</span>(WCHAR));
00554 
00555                     <span class="comment">//</span>
00556                     <span class="comment">// At this point we have the length of both the name</span>
00557                     <span class="comment">// and value portions, so exit the loop so we can</span>
00558                     <span class="comment">// do the compare.</span>
00559                     <span class="comment">//</span>
00560                     <span class="keywordflow">break</span>;
00561                     }
00562                 <span class="keywordflow">else</span> {
00563                     p++;
00564                     }
00565                 }
00566 
00567             <span class="comment">//</span>
00568             <span class="comment">// Skip over the terminating null character for this name=value</span>
00569             <span class="comment">// pair in preparation for the next iteration of the loop.</span>
00570             <span class="comment">//</span>
00571 
00572             p++;
00573 
00574             <span class="comment">//</span>
00575             <span class="comment">// Compare the current name with the one requested, ignore</span>
00576             <span class="comment">// case.</span>
00577             <span class="comment">//</span>
00578 
00579             <span class="keywordflow">if</span> (!(CompareResult = <a class="code" href="../../d6/d6/nls_8c.html#a41">RtlCompareUnicodeString</a>( Name, &amp;CurrentName, TRUE ))) {
00580                 <span class="comment">//</span>
00581                 <span class="comment">// Names are equal.  Now find the end of the current</span>
00582                 <span class="comment">// environment variable block.</span>
00583                 <span class="comment">//</span>
00584 
00585                 pEnd = p;
00586                 <span class="keywordflow">while</span> (*pEnd) {
00587                     <span class="keywordflow">while</span> (*pEnd++) {
00588                         }
00589                     }
00590                 pEnd++;
00591 
00592                 <span class="keywordflow">if</span> (!ARGUMENT_PRESENT( Value )) {
00593                     <span class="comment">//</span>
00594                     <span class="comment">// If the caller did not specify a new value, then delete</span>
00595                     <span class="comment">// the entire name=value pair by copying up the remainder</span>
00596                     <span class="comment">// of the environment variable block.</span>
00597                     <span class="comment">//</span>
00598 
00599                     RtlMoveMemory( CurrentName.Buffer,
00600                                    p,
00601                                    (ULONG) ((pEnd - p)*<span class="keyword">sizeof</span>(WCHAR))
00602                                  );
00603                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00604                     }
00605                 <span class="keywordflow">else</span>
00606                 <span class="keywordflow">if</span> (Value-&gt;Length &lt;= CurrentValue.Length) {
00607                     <span class="comment">//</span>
00608                     <span class="comment">// New value is smaller, so copy new value, then null</span>
00609                     <span class="comment">// terminate it, and then move up the remainder of the</span>
00610                     <span class="comment">// variable block so it is immediately after the new</span>
00611                     <span class="comment">// null terminated value.</span>
00612                     <span class="comment">//</span>
00613 
00614                     pStart = CurrentValue.Buffer;
00615                     RtlMoveMemory( pStart, Value-&gt;Buffer, Value-&gt;Length );
00616                     pStart += Value-&gt;Length/<span class="keyword">sizeof</span>(WCHAR);
00617                     *pStart++ = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
00618 
00619                     RtlMoveMemory( pStart, p,(ULONG)((pEnd - p)*<span class="keyword">sizeof</span>(WCHAR)) );
00620                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00621                     }
00622                 <span class="keywordflow">else</span> {
00623                     <span class="comment">//</span>
00624                     <span class="comment">// New value is larger, so query the current size of the</span>
00625                     <span class="comment">// environment variable block.  Return status if failure.</span>
00626                     <span class="comment">//</span>
00627 
00628                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwQueryVirtualMemory( NtCurrentProcess(),
00629                                                    pOld,
00630                                                    MemoryBasicInformation,
00631                                                    &amp;MemoryInformation,
00632                                                    <span class="keyword">sizeof</span>( MemoryInformation ),
00633                                                    NULL
00634                                                  );
00635                     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00636                         <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00637                         }
00638 
00639                     <span class="comment">//</span>
00640                     <span class="comment">// See if there is room for new, larger value.  If not</span>
00641                     <span class="comment">// allocate a new copy of the environment variable</span>
00642                     <span class="comment">// block.</span>
00643                     <span class="comment">//</span>
00644 
00645                     NewSize = (pEnd - (PWSTR)pOld)*<span class="keyword">sizeof</span>(WCHAR) +
00646                                 Value-&gt;Length - CurrentValue.Length;
00647                     <span class="keywordflow">if</span> (NewSize &gt;= MemoryInformation.RegionSize) {
00648                         <span class="comment">//</span>
00649                         <span class="comment">// Allocate memory to contain a copy of the current</span>
00650                         <span class="comment">// process's environment variable block.  Return</span>
00651                         <span class="comment">// status if failure.</span>
00652                         <span class="comment">//</span>
00653 
00654                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwAllocateVirtualMemory( NtCurrentProcess(),
00655                                                           &amp;pNew,
00656                                                           0,
00657                                                           &amp;NewSize,
00658                                                           MEM_COMMIT,
00659                                                           PAGE_READWRITE
00660                                                         );
00661                         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00662                             <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00663                             }
00664 
00665                         <span class="comment">//</span>
00666                         <span class="comment">// Copy the current process's environment to the allocated memory</span>
00667                         <span class="comment">// inserting the new value as we do the copy.</span>
00668                         <span class="comment">//</span>
00669 
00670                         <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = (ULONG) (CurrentValue.Buffer - (PWSTR)pOld);
00671                         RtlMoveMemory( pNew, pOld, Size*<span class="keyword">sizeof</span>(WCHAR) );
00672                         pStart = (PWSTR)pNew + <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
00673                         RtlMoveMemory( pStart, Value-&gt;Buffer, Value-&gt;Length );
00674                         pStart += Value-&gt;Length/<span class="keyword">sizeof</span>(WCHAR);
00675                         *pStart++ = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
00676                         RtlMoveMemory( pStart, p,(ULONG)((pEnd - p)*<span class="keyword">sizeof</span>(WCHAR)));
00677                         <span class="keywordflow">if</span> (ARGUMENT_PRESENT( Environment ))
00678                             *Environment = pNew;
00679                         <span class="keywordflow">else</span> {
00680                             NtCurrentPeb()-&gt;ProcessParameters-&gt;Environment = pNew;
00681                             NtCurrentPeb()-&gt;EnvironmentUpdateCount += 1;
00682                             }
00683 
00684                         ZwFreeVirtualMemory( NtCurrentProcess(),
00685                                      &amp;pOld,
00686                                      &amp;MemoryInformation.RegionSize,
00687                                      MEM_RELEASE
00688                                    );
00689                         pNew = pOld;
00690                         }
00691                     <span class="keywordflow">else</span> {
00692                         pStart = CurrentValue.Buffer + Value-&gt;Length/<span class="keyword">sizeof</span>(WCHAR) + 1;
00693                         RtlMoveMemory( pStart, p,(ULONG)((pEnd - p)*<span class="keyword">sizeof</span>(WCHAR)));
00694                         *--pStart = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
00695 
00696                         RtlMoveMemory( pStart - Value-&gt;Length/<span class="keyword">sizeof</span>(WCHAR),
00697                                        Value-&gt;Buffer,
00698                                        Value-&gt;Length
00699                                      );
00700                         }
00701                     }
00702 
00703                 <span class="keywordflow">break</span>;
00704                 }
00705             <span class="keywordflow">else</span>
00706             <span class="keywordflow">if</span> (CompareResult &lt; 0) {
00707                 <span class="comment">//</span>
00708                 <span class="comment">// Request name is less than current name, then look no</span>
00709                 <span class="comment">// further as we will not find it in our sorted list.</span>
00710                 <span class="comment">// The insertion point for the new variable is before the</span>
00711                 <span class="comment">// variable just examined.</span>
00712                 <span class="comment">//</span>
00713 
00714                 p = CurrentName.Buffer;
00715                 <span class="keywordflow">break</span>;
00716                 }
00717             }
00718 
00719         <span class="comment">//</span>
00720         <span class="comment">// If variable name not found and a new value parameter was specified</span>
00721         <span class="comment">// then insert the new variable name and its value at the appropriate</span>
00722         <span class="comment">// place in the environment variable block (i.e. where p points to).</span>
00723         <span class="comment">//</span>
00724 
00725         <span class="keywordflow">if</span> (pEnd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; ARGUMENT_PRESENT( Value )) {
00726             <span class="keywordflow">if</span> (p != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00727                 <span class="comment">//</span>
00728                 <span class="comment">// Name not found.  Now find the end of the current</span>
00729                 <span class="comment">// environment variable block.</span>
00730                 <span class="comment">//</span>
00731 
00732                 pEnd = p;
00733                 <span class="keywordflow">while</span> (*pEnd) {
00734                     <span class="keywordflow">while</span> (*pEnd++) {
00735                         }
00736                     }
00737                 pEnd++;
00738 
00739                 <span class="comment">//</span>
00740                 <span class="comment">// New value is present, so query the current size of the</span>
00741                 <span class="comment">// environment variable block.  Return status if failure.</span>
00742                 <span class="comment">//</span>
00743 
00744                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwQueryVirtualMemory( NtCurrentProcess(),
00745                                                pOld,
00746                                                MemoryBasicInformation,
00747                                                &amp;MemoryInformation,
00748                                                <span class="keyword">sizeof</span>( MemoryInformation ),
00749                                                NULL
00750                                              );
00751                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00752                     <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00753                     }
00754 
00755                 <span class="comment">//</span>
00756                 <span class="comment">// See if there is room for new, larger value.  If not</span>
00757                 <span class="comment">// allocate a new copy of the environment variable</span>
00758                 <span class="comment">// block.</span>
00759                 <span class="comment">//</span>
00760 
00761                 NewSize = (pEnd - (PWSTR)pOld) * <span class="keyword">sizeof</span>(WCHAR) +
00762                           <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Length +
00763                           <span class="keyword">sizeof</span>(WCHAR) +
00764                           Value-&gt;Length +
00765                           <span class="keyword">sizeof</span>(WCHAR);
00766                 }
00767             <span class="keywordflow">else</span> {
00768                 NewSize = <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Length +
00769                           <span class="keyword">sizeof</span>(WCHAR) +
00770                           Value-&gt;Length +
00771                           <span class="keyword">sizeof</span>(WCHAR);
00772                 MemoryInformation.RegionSize = 0;
00773                 }
00774 
00775             <span class="keywordflow">if</span> (NewSize &gt;= MemoryInformation.RegionSize) {
00776                 <span class="comment">//</span>
00777                 <span class="comment">// Allocate memory to contain a copy of the current</span>
00778                 <span class="comment">// process's environment variable block.  Return</span>
00779                 <span class="comment">// status if failure.</span>
00780                 <span class="comment">//</span>
00781 
00782                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwAllocateVirtualMemory( NtCurrentProcess(),
00783                                                   &amp;pNew,
00784                                                   0,
00785                                                   &amp;NewSize,
00786                                                   MEM_COMMIT,
00787                                                   PAGE_READWRITE
00788                                                 );
00789                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00790                     <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00791                     }
00792 
00793                 <span class="comment">//</span>
00794                 <span class="comment">// Copy the current process's environment to the allocated memory</span>
00795                 <span class="comment">// inserting the new value as we do the copy.</span>
00796                 <span class="comment">//</span>
00797 
00798                 <span class="keywordflow">if</span> (p != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00799                     <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = (ULONG)(p - (PWSTR)pOld);
00800                     RtlMoveMemory( pNew, pOld, Size*<span class="keyword">sizeof</span>(WCHAR) );
00801                     }
00802                 <span class="keywordflow">else</span> {
00803                     <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = 0;
00804                     }
00805                 pStart = (PWSTR)pNew + <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
00806                 RtlMoveMemory( pStart, <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Buffer, <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Length );
00807                 pStart += <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Length/<span class="keyword">sizeof</span>(WCHAR);
00808                 *pStart++ = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'='</span>;
00809                 RtlMoveMemory( pStart, Value-&gt;Buffer, Value-&gt;Length );
00810                 pStart += Value-&gt;Length/<span class="keyword">sizeof</span>(WCHAR);
00811                 *pStart++ = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
00812                 <span class="keywordflow">if</span> (p != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00813                     RtlMoveMemory( pStart, p,(ULONG)((pEnd - p)*<span class="keyword">sizeof</span>(WCHAR)) );
00814                     }
00815 
00816                 <span class="keywordflow">if</span> (ARGUMENT_PRESENT( Environment ))
00817                     *Environment = pNew;
00818                 <span class="keywordflow">else</span> {
00819                     NtCurrentPeb()-&gt;ProcessParameters-&gt;Environment = pNew;
00820                     NtCurrentPeb()-&gt;EnvironmentUpdateCount += 1;
00821                     }
00822                 ZwFreeVirtualMemory( NtCurrentProcess(),
00823                                      &amp;pOld,
00824                                      &amp;MemoryInformation.RegionSize,
00825                                      MEM_RELEASE
00826                                    );
00827                 }
00828             <span class="keywordflow">else</span> {
00829                 pStart = p + <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Length/<span class="keyword">sizeof</span>(WCHAR) + 1 + Value-&gt;Length/<span class="keyword">sizeof</span>(WCHAR) + 1;
00830                 RtlMoveMemory( pStart, p,(ULONG)((pEnd - p)*<span class="keyword">sizeof</span>(WCHAR)) );
00831                 RtlMoveMemory( p, <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Buffer, <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Length );
00832                 p += <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Length/<span class="keyword">sizeof</span>(WCHAR);
00833                 *p++ = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'='</span>;
00834                 RtlMoveMemory( p, Value-&gt;Buffer, Value-&gt;Length );
00835                 p += Value-&gt;Length/<span class="keyword">sizeof</span>(WCHAR);
00836                 *p++ = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
00837                 }
00838             }
00839         }
00840     finally {
00841         <span class="comment">//</span>
00842         <span class="comment">// Release the Peb lock.</span>
00843         <span class="comment">//</span>
00844 
00845         <span class="keywordflow">if</span> (!ARGUMENT_PRESENT( Environment )) {
00846             <a class="code" href="../../d2/d4/eballoc_8c.html#a2">RtlReleasePebLock</a>();
00847             }
00848 
00849         <span class="comment">//</span>
00850         <span class="comment">// If abnormally terminating, assume access violation.</span>
00851         <span class="comment">//</span>
00852 
00853         <span class="keywordflow">if</span> (AbnormalTermination()) {
00854             <span class="keywordflow">return</span> (STATUS_ACCESS_VIOLATION);
00855             }
00856         }
00857 
00858     <span class="comment">//</span>
00859     <span class="comment">// Return status.</span>
00860     <span class="comment">//</span>
00861 
00862     <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00863 }
</div></pre>    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a1" doxytag="environ.c::RtlpEnvironCacheName" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> UNICODE_STRING <a class="el" href="../../d5/d7/environ_8c.html#a1">RtlpEnvironCacheName</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d6/environ_8c-source.html#l00246">246</a> of file <a class="el" href="../../d6/d6/environ_8c-source.html">environ.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d6/environ_8c-source.html#l00250">RtlQueryEnvironmentVariable_U()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="environ.c::RtlpEnvironCacheValid" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN <a class="el" href="../../d5/d7/environ_8c.html#a0">RtlpEnvironCacheValid</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d6/environ_8c-source.html#l00245">245</a> of file <a class="el" href="../../d6/d6/environ_8c-source.html">environ.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d6/environ_8c-source.html#l00250">RtlQueryEnvironmentVariable_U()</a>, and <a class="el" href="../../d6/d6/environ_8c-source.html#l00458">RtlSetEnvironmentVariable()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="environ.c::RtlpEnvironCacheValue" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> UNICODE_STRING <a class="el" href="../../d5/d7/environ_8c.html#a2">RtlpEnvironCacheValue</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d6/environ_8c-source.html#l00247">247</a> of file <a class="el" href="../../d6/d6/environ_8c-source.html">environ.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d6/environ_8c-source.html#l00250">RtlQueryEnvironmentVariable_U()</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:43:33 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
