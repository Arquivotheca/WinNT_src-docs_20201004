<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: mi.h Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>mi.h</h1><a href="../../d4/d8/mi_8h.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    mi.h</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module contains the private data structures and procedure</span>
00012 <span class="comment">    prototypes for the memory management system.</span>
00013 <span class="comment"></span>
00014 <span class="comment">Author:</span>
00015 <span class="comment"></span>
00016 <span class="comment">    Lou Perazzoli (loup) 20-Mar-1989</span>
00017 <span class="comment">    Landy Wang (landyw) 02-Jun-1997</span>
00018 <span class="comment"></span>
00019 <span class="comment">Revision History:</span>
00020 <span class="comment"></span>
00021 <span class="comment">--*/</span>
00022 
00023 <span class="preprocessor">#ifndef _MI_</span>
00024 <span class="preprocessor"></span><span class="preprocessor">#define _MI_</span>
00025 <span class="preprocessor"></span>
00026 <span class="preprocessor">#include "<a class="code" href="../../d9/d8/ntos_8h.html">ntos.h</a>"</span>
00027 <span class="preprocessor">#include "ntimage.h"</span>
00028 <span class="preprocessor">#include "<a class="code" href="../../d0/d0/ki_8h.html">ki.h</a>"</span>
00029 <span class="preprocessor">#include "<a class="code" href="../../d1/d8/fsrtl_8h.html">fsrtl.h</a>"</span>
00030 <span class="preprocessor">#include "zwapi.h"</span>
00031 <span class="preprocessor">#include "<a class="code" href="../../d4/d2/pool_8h.html">pool.h</a>"</span>
00032 <span class="preprocessor">#include "ntiodump.h"</span>
00033 <span class="preprocessor">#include "stdio.h"</span>
00034 <span class="preprocessor">#include "string.h"</span>
00035 <span class="preprocessor">#include "safeboot.h"</span>
00036 <span class="preprocessor">#include "triage.h"</span>
00037 
00038 <span class="preprocessor">#if defined(_X86_)</span>
00039 <span class="preprocessor"></span><span class="preprocessor">#include "..\mm\i386\mi386.h"</span>
00040 
00041 <span class="preprocessor">#elif defined(_AXP64_)</span>
00042 <span class="preprocessor"></span><span class="preprocessor">#include "..\mm\axp64\mialpha.h"</span>
00043 
00044 <span class="preprocessor">#elif defined(_ALPHA_)</span>
00045 <span class="preprocessor"></span><span class="preprocessor">#include "..\mm\alpha\mialpha.h"</span>
00046 
00047 <span class="preprocessor">#elif defined(_IA64_)</span>
00048 <span class="preprocessor"></span><span class="preprocessor">#include "..\mm\ia64\miia64.h"</span>
00049 
00050 <span class="preprocessor">#else</span>
00051 <span class="preprocessor"></span><span class="preprocessor">#error "mm: a target architecture must be defined."</span>
00052 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00053 <span class="preprocessor"></span>
00054 <span class="preprocessor">#if defined (_WIN64)</span>
00055 <span class="preprocessor"></span><span class="preprocessor">#define ASSERT32(exp)</span>
00056 <span class="preprocessor"></span><span class="preprocessor">#define ASSERT64(exp)   ASSERT(exp)</span>
00057 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l00058"></a><a class="code" href="../../d4/d8/mi_8h.html#a0">00058</a> <span class="preprocessor"></span><span class="preprocessor">#define ASSERT32(exp)   ASSERT(exp)</span>
<a name="l00059"></a><a class="code" href="../../d4/d8/mi_8h.html#a1">00059</a> <span class="preprocessor"></span><span class="preprocessor">#define ASSERT64(exp)</span>
00060 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00061 <span class="preprocessor"></span>
00062 <span class="comment">//</span>
00063 <span class="comment">// Special pool constants</span>
00064 <span class="comment">//</span>
<a name="l00065"></a><a class="code" href="../../d4/d8/mi_8h.html#a2">00065</a> <span class="preprocessor">#define MI_SPECIAL_POOL_PAGABLE         0x8000</span>
<a name="l00066"></a><a class="code" href="../../d4/d8/mi_8h.html#a3">00066</a> <span class="preprocessor"></span><span class="preprocessor">#define MI_SPECIAL_POOL_VERIFIER        0x4000</span>
<a name="l00067"></a><a class="code" href="../../d4/d8/mi_8h.html#a4">00067</a> <span class="preprocessor"></span><span class="preprocessor">#define MI_SPECIAL_POOL_PTE_PAGABLE     0x0002</span>
<a name="l00068"></a><a class="code" href="../../d4/d8/mi_8h.html#a5">00068</a> <span class="preprocessor"></span><span class="preprocessor">#define MI_SPECIAL_POOL_PTE_NONPAGABLE  0x0004</span>
00069 <span class="preprocessor"></span>
00070 
<a name="l00071"></a><a class="code" href="../../d4/d8/mi_8h.html#a6">00071</a> <span class="preprocessor">#define _2gb 0x80000000                 // 2 gigabytes</span>
<a name="l00072"></a><a class="code" href="../../d4/d8/mi_8h.html#a7">00072</a> <span class="preprocessor"></span><span class="preprocessor">#define _4gb 0x100000000                // 4 gigabytes</span>
00073 <span class="preprocessor"></span>
<a name="l00074"></a><a class="code" href="../../d4/d8/mi_8h.html#a8">00074</a> <span class="preprocessor">#define MM_FLUSH_COUNTER_MASK (0xFFFFF)</span>
00075 <span class="preprocessor"></span>
<a name="l00076"></a><a class="code" href="../../d4/d8/mi_8h.html#a9">00076</a> <span class="preprocessor">#define MM_FREE_WSLE_SHIFT 4</span>
00077 <span class="preprocessor"></span>
<a name="l00078"></a><a class="code" href="../../d4/d8/mi_8h.html#a10">00078</a> <span class="preprocessor">#define WSLE_NULL_INDEX ((ULONG)0xFFFFFFF)</span>
00079 <span class="preprocessor"></span>
<a name="l00080"></a><a class="code" href="../../d4/d8/mi_8h.html#a11">00080</a> <span class="preprocessor">#define MM_FREE_POOL_SIGNATURE (0x50554F4C)</span>
00081 <span class="preprocessor"></span>
<a name="l00082"></a><a class="code" href="../../d4/d8/mi_8h.html#a12">00082</a> <span class="preprocessor">#define MM_MINIMUM_PAGED_POOL_NTAS ((SIZE_T)(48*1024*1024))</span>
00083 <span class="preprocessor"></span>
<a name="l00084"></a><a class="code" href="../../d4/d8/mi_8h.html#a13">00084</a> <span class="preprocessor">#define MM_ALLOCATION_FILLS_VAD ((PMMPTE)(ULONG_PTR)~3)</span>
00085 <span class="preprocessor"></span>
<a name="l00086"></a><a class="code" href="../../d4/d8/mi_8h.html#a14">00086</a> <span class="preprocessor">#define MM_WORKING_SET_LIST_SEARCH 17</span>
00087 <span class="preprocessor"></span>
<a name="l00088"></a><a class="code" href="../../d4/d8/mi_8h.html#a15">00088</a> <span class="preprocessor">#define MM_FLUID_WORKING_SET 8</span>
00089 <span class="preprocessor"></span>
<a name="l00090"></a><a class="code" href="../../d4/d8/mi_8h.html#a16">00090</a> <span class="preprocessor">#define MM_FLUID_PHYSICAL_PAGES 32  //see MmResidentPages below.</span>
00091 <span class="preprocessor"></span>
<a name="l00092"></a><a class="code" href="../../d4/d8/mi_8h.html#a17">00092</a> <span class="preprocessor">#define MM_USABLE_PAGES_FREE 32</span>
00093 <span class="preprocessor"></span>
<a name="l00094"></a><a class="code" href="../../d4/d8/mi_8h.html#a18">00094</a> <span class="preprocessor">#define X64K (ULONG)65536</span>
00095 <span class="preprocessor"></span>
<a name="l00096"></a><a class="code" href="../../d4/d8/mi_8h.html#a19">00096</a> <span class="preprocessor">#define MM_HIGHEST_VAD_ADDRESS ((PVOID)((ULONG_PTR)MM_HIGHEST_USER_ADDRESS - (64 * 1024)))</span>
00097 <span class="preprocessor"></span>
00098 
<a name="l00099"></a><a class="code" href="../../d4/d8/mi_8h.html#a20">00099</a> <span class="preprocessor">#define MM_NO_WS_EXPANSION ((PLIST_ENTRY)0)</span>
<a name="l00100"></a><a class="code" href="../../d4/d8/mi_8h.html#a21">00100</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_WS_EXPANSION_IN_PROGRESS ((PLIST_ENTRY)35)</span>
<a name="l00101"></a><a class="code" href="../../d4/d8/mi_8h.html#a22">00101</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_WS_SWAPPED_OUT ((PLIST_ENTRY)37)</span>
<a name="l00102"></a><a class="code" href="../../d4/d8/mi_8h.html#a23">00102</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_IO_IN_PROGRESS ((PLIST_ENTRY)97)  // MUST HAVE THE HIGHEST VALUE</span>
00103 <span class="preprocessor"></span>
<a name="l00104"></a><a class="code" href="../../d4/d8/mi_8h.html#a24">00104</a> <span class="preprocessor">#define MM_PAGES_REQUIRED_FOR_MAPPED_IO 7</span>
00105 <span class="preprocessor"></span>
<a name="l00106"></a><a class="code" href="../../d4/d8/mi_8h.html#a25">00106</a> <span class="preprocessor">#define MM4K_SHIFT    12  //MUST BE LESS THAN OR EQUAL TO PAGE_SHIFT</span>
<a name="l00107"></a><a class="code" href="../../d4/d8/mi_8h.html#a26">00107</a> <span class="preprocessor"></span><span class="preprocessor">#define MM4K_MASK  0xfff</span>
00108 <span class="preprocessor"></span>
<a name="l00109"></a><a class="code" href="../../d4/d8/mi_8h.html#a27">00109</a> <span class="preprocessor">#define MMSECTOR_SHIFT 9  //MUST BE LESS THAN OR EQUAL TO PAGE_SHIFT</span>
00110 <span class="preprocessor"></span>
<a name="l00111"></a><a class="code" href="../../d4/d8/mi_8h.html#a28">00111</a> <span class="preprocessor">#define MMSECTOR_MASK 0x1ff</span>
00112 <span class="preprocessor"></span>
<a name="l00113"></a><a class="code" href="../../d4/d8/mi_8h.html#a29">00113</a> <span class="preprocessor">#define MM_LOCK_BY_REFCOUNT 0</span>
00114 <span class="preprocessor"></span>
<a name="l00115"></a><a class="code" href="../../d4/d8/mi_8h.html#a30">00115</a> <span class="preprocessor">#define MM_LOCK_BY_NONPAGE 1</span>
00116 <span class="preprocessor"></span>
<a name="l00117"></a><a class="code" href="../../d4/d8/mi_8h.html#a31">00117</a> <span class="preprocessor">#define MM_FORCE_TRIM 6</span>
00118 <span class="preprocessor"></span>
<a name="l00119"></a><a class="code" href="../../d4/d8/mi_8h.html#a32">00119</a> <span class="preprocessor">#define MM_GROW_WSLE_HASH 20</span>
00120 <span class="preprocessor"></span>
<a name="l00121"></a><a class="code" href="../../d4/d8/mi_8h.html#a33">00121</a> <span class="preprocessor">#define MM_MAXIMUM_WRITE_CLUSTER (MM_MAXIMUM_DISK_IO_SIZE / PAGE_SIZE)</span>
00122 <span class="preprocessor"></span>
00123 <span class="comment">//</span>
00124 <span class="comment">// Number of PTEs to flush singularly before flushing the entire TB.</span>
00125 <span class="comment">//</span>
00126 
<a name="l00127"></a><a class="code" href="../../d4/d8/mi_8h.html#a34">00127</a> <span class="preprocessor">#define MM_MAXIMUM_FLUSH_COUNT (FLUSH_MULTIPLE_MAXIMUM-1)</span>
00128 <span class="preprocessor"></span>
00129 <span class="comment">//</span>
00130 <span class="comment">// Page protections</span>
00131 <span class="comment">//</span>
00132 
<a name="l00133"></a><a class="code" href="../../d4/d8/mi_8h.html#a35">00133</a> <span class="preprocessor">#define MM_ZERO_ACCESS         0  // this value is not used.</span>
<a name="l00134"></a><a class="code" href="../../d4/d8/mi_8h.html#a36">00134</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_READONLY            1</span>
<a name="l00135"></a><a class="code" href="../../d4/d8/mi_8h.html#a37">00135</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_EXECUTE             2</span>
<a name="l00136"></a><a class="code" href="../../d4/d8/mi_8h.html#a38">00136</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_EXECUTE_READ        3</span>
<a name="l00137"></a><a class="code" href="../../d4/d8/mi_8h.html#a39">00137</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_READWRITE           4  // bit 2 is set if this is writable.</span>
<a name="l00138"></a><a class="code" href="../../d4/d8/mi_8h.html#a40">00138</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_WRITECOPY           5</span>
<a name="l00139"></a><a class="code" href="../../d4/d8/mi_8h.html#a41">00139</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_EXECUTE_READWRITE   6</span>
<a name="l00140"></a><a class="code" href="../../d4/d8/mi_8h.html#a42">00140</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_EXECUTE_WRITECOPY   7</span>
00141 <span class="preprocessor"></span>
<a name="l00142"></a><a class="code" href="../../d4/d8/mi_8h.html#a43">00142</a> <span class="preprocessor">#define MM_NOCACHE            0x8</span>
<a name="l00143"></a><a class="code" href="../../d4/d8/mi_8h.html#a44">00143</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_GUARD_PAGE         0x10</span>
<a name="l00144"></a><a class="code" href="../../d4/d8/mi_8h.html#a45">00144</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_DECOMMIT           0x10   //NO_ACCESS, Guard page</span>
<a name="l00145"></a><a class="code" href="../../d4/d8/mi_8h.html#a46">00145</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_NOACCESS           0x18   //NO_ACCESS, Guard_page, nocache.</span>
<a name="l00146"></a><a class="code" href="../../d4/d8/mi_8h.html#a47">00146</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_UNKNOWN_PROTECTION 0x100  //bigger than 5 bits!</span>
<a name="l00147"></a><a class="code" href="../../d4/d8/mi_8h.html#a48">00147</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_LARGE_PAGES        0x111</span>
00148 <span class="preprocessor"></span>
<a name="l00149"></a><a class="code" href="../../d4/d8/mi_8h.html#a49">00149</a> <span class="preprocessor">#define PROTECT_KSTACKS       1</span>
00150 <span class="preprocessor"></span>
<a name="l00151"></a><a class="code" href="../../d4/d8/mi_8h.html#a50">00151</a> <span class="preprocessor">#define MM_KSTACK_OUTSWAPPED  0x1F   //Debug marking for kernel stacks</span>
00152 <span class="preprocessor"></span>
<a name="l00153"></a><a class="code" href="../../d4/d8/mi_8h.html#a51">00153</a> <span class="preprocessor">#define MM_PROTECTION_WRITE_MASK     4</span>
<a name="l00154"></a><a class="code" href="../../d4/d8/mi_8h.html#a52">00154</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_PROTECTION_COPY_MASK      1</span>
<a name="l00155"></a><a class="code" href="../../d4/d8/mi_8h.html#a53">00155</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_PROTECTION_OPERATION_MASK 7 // mask off guard page and nocache.</span>
<a name="l00156"></a><a class="code" href="../../d4/d8/mi_8h.html#a54">00156</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_PROTECTION_EXECUTE_MASK   2</span>
00157 <span class="preprocessor"></span>
<a name="l00158"></a><a class="code" href="../../d4/d8/mi_8h.html#a55">00158</a> <span class="preprocessor">#define MM_SECURE_DELETE_CHECK 0x55</span>
00159 <span class="preprocessor"></span>
00160 <span class="comment">//</span>
00161 <span class="comment">// Debug flags</span>
00162 <span class="comment">//</span>
00163 
<a name="l00164"></a><a class="code" href="../../d4/d8/mi_8h.html#a56">00164</a> <span class="preprocessor">#define MM_DBG_WRITEFAULT       0x1</span>
<a name="l00165"></a><a class="code" href="../../d4/d8/mi_8h.html#a57">00165</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_DBG_PTE_UPDATE       0x2</span>
<a name="l00166"></a><a class="code" href="../../d4/d8/mi_8h.html#a58">00166</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_DBG_DUMP_WSL         0x4</span>
<a name="l00167"></a><a class="code" href="../../d4/d8/mi_8h.html#a59">00167</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_DBG_PAGEFAULT        0x8</span>
<a name="l00168"></a><a class="code" href="../../d4/d8/mi_8h.html#a60">00168</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_DBG_WS_EXPANSION     0x10</span>
<a name="l00169"></a><a class="code" href="../../d4/d8/mi_8h.html#a61">00169</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_DBG_MOD_WRITE        0x20</span>
<a name="l00170"></a><a class="code" href="../../d4/d8/mi_8h.html#a62">00170</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_DBG_CHECK_PTE        0x40</span>
<a name="l00171"></a><a class="code" href="../../d4/d8/mi_8h.html#a63">00171</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_DBG_VAD_CONFLICT     0x80</span>
<a name="l00172"></a><a class="code" href="../../d4/d8/mi_8h.html#a64">00172</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_DBG_SECTIONS         0x100</span>
<a name="l00173"></a><a class="code" href="../../d4/d8/mi_8h.html#a65">00173</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_DBG_SYS_PTES         0x400</span>
<a name="l00174"></a><a class="code" href="../../d4/d8/mi_8h.html#a66">00174</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_DBG_CLEAN_PROCESS    0x800</span>
<a name="l00175"></a><a class="code" href="../../d4/d8/mi_8h.html#a67">00175</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_DBG_COLLIDED_PAGE    0x1000</span>
<a name="l00176"></a><a class="code" href="../../d4/d8/mi_8h.html#a68">00176</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_DBG_DUMP_BOOT_PTES   0x2000</span>
<a name="l00177"></a><a class="code" href="../../d4/d8/mi_8h.html#a69">00177</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_DBG_FORK             0x4000</span>
<a name="l00178"></a><a class="code" href="../../d4/d8/mi_8h.html#a70">00178</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_DBG_DIR_BASE         0x8000</span>
<a name="l00179"></a><a class="code" href="../../d4/d8/mi_8h.html#a71">00179</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_DBG_FLUSH_SECTION    0x10000</span>
<a name="l00180"></a><a class="code" href="../../d4/d8/mi_8h.html#a72">00180</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_DBG_PRINTS_MODWRITES 0x20000</span>
<a name="l00181"></a><a class="code" href="../../d4/d8/mi_8h.html#a73">00181</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_DBG_PAGE_IN_LIST     0x40000</span>
<a name="l00182"></a><a class="code" href="../../d4/d8/mi_8h.html#a74">00182</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_DBG_CHECK_PFN_LOCK   0x80000</span>
<a name="l00183"></a><a class="code" href="../../d4/d8/mi_8h.html#a75">00183</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_DBG_PRIVATE_PAGES    0x100000</span>
<a name="l00184"></a><a class="code" href="../../d4/d8/mi_8h.html#a76">00184</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_DBG_WALK_VAD_TREE    0x200000</span>
<a name="l00185"></a><a class="code" href="../../d4/d8/mi_8h.html#a77">00185</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_DBG_SWAP_PROCESS     0x400000</span>
<a name="l00186"></a><a class="code" href="../../d4/d8/mi_8h.html#a78">00186</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_DBG_LOCK_CODE        0x800000</span>
<a name="l00187"></a><a class="code" href="../../d4/d8/mi_8h.html#a79">00187</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_DBG_STOP_ON_ACCVIO   0x1000000</span>
<a name="l00188"></a><a class="code" href="../../d4/d8/mi_8h.html#a80">00188</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_DBG_PAGE_REF_COUNT   0x2000000</span>
<a name="l00189"></a><a class="code" href="../../d4/d8/mi_8h.html#a81">00189</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_DBG_SHOW_NT_CALLS    0x10000000</span>
<a name="l00190"></a><a class="code" href="../../d4/d8/mi_8h.html#a82">00190</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_DBG_SHOW_FAULTS      0x40000000</span>
<a name="l00191"></a><a class="code" href="../../d4/d8/mi_8h.html#a83">00191</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_DBG_SESSIONS         0x80000000</span>
00192 <span class="preprocessor"></span>
00193 <span class="comment">//</span>
00194 <span class="comment">// if the PTE.protection &amp; MM_COPY_ON_WRITE_MASK == MM_COPY_ON_WRITE_MASK</span>
00195 <span class="comment">// then the pte is copy on write.</span>
00196 <span class="comment">//</span>
00197 
<a name="l00198"></a><a class="code" href="../../d4/d8/mi_8h.html#a84">00198</a> <span class="preprocessor">#define MM_COPY_ON_WRITE_MASK  5</span>
00199 <span class="preprocessor"></span>
<a name="l00200"></a><a class="code" href="../../d4/d8/mi_8h.html#a411">00200</a> <span class="keyword">extern</span> ULONG <a class="code" href="../../d4/d8/mi_8h.html#a411">MmProtectToValue</a>[32];
<a name="l00201"></a><a class="code" href="../../d4/d8/mi_8h.html#a412">00201</a> <span class="keyword">extern</span> ULONG <a class="code" href="../../d4/d8/mi_8h.html#a412">MmProtectToPteMask</a>[32];
<a name="l00202"></a><a class="code" href="../../d4/d8/mi_8h.html#a413">00202</a> <span class="keyword">extern</span> ULONG <a class="code" href="../../d4/d8/mi_8h.html#a413">MmMakeProtectNotWriteCopy</a>[32];
<a name="l00203"></a><a class="code" href="../../d4/d8/mi_8h.html#a414">00203</a> <span class="keyword">extern</span> ACCESS_MASK <a class="code" href="../../d4/d8/mi_8h.html#a414">MmMakeSectionAccess</a>[8];
<a name="l00204"></a><a class="code" href="../../d4/d8/mi_8h.html#a415">00204</a> <span class="keyword">extern</span> ACCESS_MASK <a class="code" href="../../d4/d8/mi_8h.html#a415">MmMakeFileAccess</a>[8];
00205 
00206 
00207 <span class="comment">//</span>
00208 <span class="comment">// Time constants</span>
00209 <span class="comment">//</span>
00210 
<a name="l00211"></a><a class="code" href="../../d4/d8/mi_8h.html#a416">00211</a> <span class="keyword">extern</span> LARGE_INTEGER <a class="code" href="../../d4/d8/mi_8h.html#a416">MmSevenMinutes</a>;
<a name="l00212"></a><a class="code" href="../../d4/d8/mi_8h.html#a417">00212</a> <span class="keyword">extern</span> LARGE_INTEGER <a class="code" href="../../d4/d8/mi_8h.html#a417">MmWorkingSetProtectionTime</a>;
<a name="l00213"></a><a class="code" href="../../d4/d8/mi_8h.html#a418">00213</a> <span class="keyword">extern</span> LARGE_INTEGER <a class="code" href="../../d4/d8/mi_8h.html#a418">MmOneSecond</a>;
<a name="l00214"></a><a class="code" href="../../d4/d8/mi_8h.html#a419">00214</a> <span class="keyword">extern</span> LARGE_INTEGER <a class="code" href="../../d4/d8/mi_8h.html#a419">MmTwentySeconds</a>;
<a name="l00215"></a><a class="code" href="../../d4/d8/mi_8h.html#a420">00215</a> <span class="keyword">extern</span> LARGE_INTEGER <a class="code" href="../../d4/d8/mi_8h.html#a420">MmShortTime</a>;
<a name="l00216"></a><a class="code" href="../../d4/d8/mi_8h.html#a421">00216</a> <span class="keyword">extern</span> LARGE_INTEGER <a class="code" href="../../d4/d8/mi_8h.html#a421">MmHalfSecond</a>;
<a name="l00217"></a><a class="code" href="../../d4/d8/mi_8h.html#a422">00217</a> <span class="keyword">extern</span> LARGE_INTEGER <a class="code" href="../../d4/d8/mi_8h.html#a422">Mm30Milliseconds</a>;
<a name="l00218"></a><a class="code" href="../../d4/d8/mi_8h.html#a423">00218</a> <span class="keyword">extern</span> LARGE_INTEGER <a class="code" href="../../d4/d8/mi_8h.html#a423">MmCriticalSectionTimeout</a>;
00219 
00220 <span class="comment">//</span>
00221 <span class="comment">// A month's worth</span>
00222 <span class="comment">//</span>
00223 
<a name="l00224"></a><a class="code" href="../../d4/d8/mi_8h.html#a424">00224</a> <span class="keyword">extern</span> ULONG <a class="code" href="../../d8/d0/cmdat3_8c.html#a45">MmCritsectTimeoutSeconds</a>;
00225 
00226 <span class="comment">//</span>
00227 <span class="comment">// this is the csrss process !</span>
00228 <span class="comment">//</span>
00229 
<a name="l00230"></a><a class="code" href="../../d4/d8/mi_8h.html#a425">00230</a> <span class="keyword">extern</span> <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> <a class="code" href="../../d6/d8/ex_2harderr_8c.html#a4">ExpDefaultErrorPortProcess</a>;
00231 
<a name="l00232"></a><a class="code" href="../../d4/d8/mi_8h.html#a426">00232</a> <span class="keyword">extern</span> SIZE_T <a class="code" href="../../d8/d5/kddata_8c.html#a35">MmExtendedCommit</a>;
00233 
00234 <span class="comment">//</span>
00235 <span class="comment">// The total number of pages needed for the loader to successfully hibernate.</span>
00236 <span class="comment">//</span>
00237 
<a name="l00238"></a><a class="code" href="../../d4/d8/mi_8h.html#a427">00238</a> <span class="keyword">extern</span> PFN_NUMBER <a class="code" href="../../d4/d8/mi_8h.html#a427">MmHiberPages</a>;
00239 
00240 <span class="comment">//</span>
00241 <span class="comment">//  The counters and reasons to retry IO to protect against verifier induced</span>
00242 <span class="comment">//  failures and temporary conditions.</span>
00243 <span class="comment">//</span>
00244 
<a name="l00245"></a><a class="code" href="../../d4/d8/mi_8h.html#a428">00245</a> <span class="keyword">extern</span> ULONG <a class="code" href="../../d4/d8/mi_8h.html#a428">MiIoRetryLevel</a>;
<a name="l00246"></a><a class="code" href="../../d4/d8/mi_8h.html#a429">00246</a> <span class="keyword">extern</span> ULONG <a class="code" href="../../d4/d8/mi_8h.html#a429">MiFaultRetries</a>;
<a name="l00247"></a><a class="code" href="../../d4/d8/mi_8h.html#a430">00247</a> <span class="keyword">extern</span> ULONG <a class="code" href="../../d4/d8/mi_8h.html#a430">MiUserIoRetryLevel</a>;
<a name="l00248"></a><a class="code" href="../../d4/d8/mi_8h.html#a431">00248</a> <span class="keyword">extern</span> ULONG <a class="code" href="../../d4/d8/mi_8h.html#a431">MiUserFaultRetries</a>;
00249                         
<a name="l00250"></a><a class="code" href="../../d4/d8/mi_8h.html#a85">00250</a> <span class="preprocessor">#define MmIsRetryIoStatus(S) (((S) == STATUS_INSUFFICIENT_RESOURCES) || \</span>
00251 <span class="preprocessor">                              ((S) == STATUS_WORKING_SET_QUOTA) ||      \</span>
00252 <span class="preprocessor">                              ((S) == STATUS_NO_MEMORY))</span>
00253 <span class="preprocessor"></span>
00254 <span class="comment">//++</span>
00255 <span class="comment">//</span>
00256 <span class="comment">// ULONG</span>
00257 <span class="comment">// MI_CONVERT_FROM_PTE_PROTECTION (</span>
00258 <span class="comment">//     IN ULONG PROTECTION_MASK</span>
00259 <span class="comment">//     )</span>
00260 <span class="comment">//</span>
00261 <span class="comment">// Routine Description:</span>
00262 <span class="comment">//</span>
00263 <span class="comment">//  This routine converts a PTE protection into a Protect value.</span>
00264 <span class="comment">//</span>
00265 <span class="comment">// Arguments:</span>
00266 <span class="comment">//</span>
00267 <span class="comment">//</span>
00268 <span class="comment">// Return Value:</span>
00269 <span class="comment">//</span>
00270 <span class="comment">//     Returns the</span>
00271 <span class="comment">//</span>
00272 <span class="comment">//--</span>
00273 
<a name="l00274"></a><a class="code" href="../../d4/d8/mi_8h.html#a86">00274</a> <span class="preprocessor">#define MI_CONVERT_FROM_PTE_PROTECTION(PROTECTION_MASK)      \</span>
00275 <span class="preprocessor">                                     (MmProtectToValue[PROTECTION_MASK])</span>
00276 <span class="preprocessor"></span>
<a name="l00277"></a><a class="code" href="../../d4/d8/mi_8h.html#a87">00277</a> <span class="preprocessor">#define MI_MASK_TO_PTE(PROTECTION_MASK) MmProtectToPteMask[PROTECTION_MASK]</span>
00278 <span class="preprocessor"></span>
00279 
<a name="l00280"></a><a class="code" href="../../d4/d8/mi_8h.html#a88">00280</a> <span class="preprocessor">#define MI_IS_PTE_PROTECTION_COPY_WRITE(PROTECTION_MASK)  \</span>
00281 <span class="preprocessor">   (((PROTECTION_MASK) &amp; MM_COPY_ON_WRITE_MASK) == MM_COPY_ON_WRITE_MASK)</span>
00282 <span class="preprocessor"></span>
00283 <span class="comment">//++</span>
00284 <span class="comment">//</span>
00285 <span class="comment">// ULONG</span>
00286 <span class="comment">// MI_ROUND_TO_64K (</span>
00287 <span class="comment">//     IN ULONG LENGTH</span>
00288 <span class="comment">//     )</span>
00289 <span class="comment">//</span>
00290 <span class="comment">// Routine Description:</span>
00291 <span class="comment">//</span>
00292 <span class="comment">//</span>
00293 <span class="comment">// The ROUND_TO_64k macro takes a LENGTH in bytes and rounds it up to a multiple</span>
00294 <span class="comment">// of 64K.</span>
00295 <span class="comment">//</span>
00296 <span class="comment">// Arguments:</span>
00297 <span class="comment">//</span>
00298 <span class="comment">//     LENGTH - LENGTH in bytes to round up to 64k.</span>
00299 <span class="comment">//</span>
00300 <span class="comment">// Return Value:</span>
00301 <span class="comment">//</span>
00302 <span class="comment">//     Returns the LENGTH rounded up to a multiple of 64k.</span>
00303 <span class="comment">//</span>
00304 <span class="comment">//--</span>
00305 
<a name="l00306"></a><a class="code" href="../../d4/d8/mi_8h.html#a89">00306</a> <span class="preprocessor">#define MI_ROUND_TO_64K(LENGTH)  (((LENGTH) + X64K - 1) &amp; ~(X64K - 1))</span>
00307 <span class="preprocessor"></span>
00308 <span class="comment">//++</span>
00309 <span class="comment">//</span>
00310 <span class="comment">// ULONG</span>
00311 <span class="comment">// MI_ROUND_TO_SIZE (</span>
00312 <span class="comment">//     IN ULONG LENGTH,</span>
00313 <span class="comment">//     IN ULONG ALIGNMENT</span>
00314 <span class="comment">//     )</span>
00315 <span class="comment">//</span>
00316 <span class="comment">// Routine Description:</span>
00317 <span class="comment">//</span>
00318 <span class="comment">//</span>
00319 <span class="comment">// The ROUND_TO_SIZE macro takes a LENGTH in bytes and rounds it up to a</span>
00320 <span class="comment">// multiple of the alignment.</span>
00321 <span class="comment">//</span>
00322 <span class="comment">// Arguments:</span>
00323 <span class="comment">//</span>
00324 <span class="comment">//     LENGTH - LENGTH in bytes to round up to.</span>
00325 <span class="comment">//</span>
00326 <span class="comment">//     ALIGNMENT - alignment to round to, must be a power of 2, e.g, 2**n.</span>
00327 <span class="comment">//</span>
00328 <span class="comment">// Return Value:</span>
00329 <span class="comment">//</span>
00330 <span class="comment">//     Returns the LENGTH rounded up to a multiple of the alignment.</span>
00331 <span class="comment">//</span>
00332 <span class="comment">//--</span>
00333 
<a name="l00334"></a><a class="code" href="../../d4/d8/mi_8h.html#a90">00334</a> <span class="preprocessor">#define MI_ROUND_TO_SIZE(LENGTH,ALIGNMENT)     \</span>
00335 <span class="preprocessor">                    (((LENGTH) + ((ALIGNMENT) - 1)) &amp; ~((ALIGNMENT) - 1))</span>
00336 <span class="preprocessor"></span>
00337 <span class="comment">//++</span>
00338 <span class="comment">//</span>
00339 <span class="comment">// PVOID</span>
00340 <span class="comment">// MI_64K_ALIGN (</span>
00341 <span class="comment">//     IN PVOID VA</span>
00342 <span class="comment">//     )</span>
00343 <span class="comment">//</span>
00344 <span class="comment">// Routine Description:</span>
00345 <span class="comment">//</span>
00346 <span class="comment">//</span>
00347 <span class="comment">// The MI_64K_ALIGN macro takes a virtual address and returns a 64k-aligned</span>
00348 <span class="comment">// virtual address for that page.</span>
00349 <span class="comment">//</span>
00350 <span class="comment">// Arguments:</span>
00351 <span class="comment">//</span>
00352 <span class="comment">//     VA - Virtual address.</span>
00353 <span class="comment">//</span>
00354 <span class="comment">// Return Value:</span>
00355 <span class="comment">//</span>
00356 <span class="comment">//     Returns the 64k aligned virtual address.</span>
00357 <span class="comment">//</span>
00358 <span class="comment">//--</span>
00359 
<a name="l00360"></a><a class="code" href="../../d4/d8/mi_8h.html#a91">00360</a> <span class="preprocessor">#define MI_64K_ALIGN(VA) ((PVOID)((ULONG_PTR)(VA) &amp; ~((LONG)X64K - 1)))</span>
00361 <span class="preprocessor"></span>
00362 
00363 <span class="comment">//++</span>
00364 <span class="comment">//</span>
00365 <span class="comment">// PVOID</span>
00366 <span class="comment">// MI_ALIGN_TO_SIZE (</span>
00367 <span class="comment">//     IN PVOID VA</span>
00368 <span class="comment">//     IN ULONG ALIGNMENT</span>
00369 <span class="comment">//     )</span>
00370 <span class="comment">//</span>
00371 <span class="comment">// Routine Description:</span>
00372 <span class="comment">//</span>
00373 <span class="comment">//</span>
00374 <span class="comment">// The MI_ALIGN_TO_SIZE macro takes a virtual address and returns a</span>
00375 <span class="comment">// virtual address for that page with the specified alignment.</span>
00376 <span class="comment">//</span>
00377 <span class="comment">// Arguments:</span>
00378 <span class="comment">//</span>
00379 <span class="comment">//     VA - Virtual address.</span>
00380 <span class="comment">//</span>
00381 <span class="comment">//     ALIGNMENT - alignment to round to, must be a power of 2, e.g, 2**n.</span>
00382 <span class="comment">//</span>
00383 <span class="comment">// Return Value:</span>
00384 <span class="comment">//</span>
00385 <span class="comment">//     Returns the aligned virtual address.</span>
00386 <span class="comment">//</span>
00387 <span class="comment">//--</span>
00388 
<a name="l00389"></a><a class="code" href="../../d4/d8/mi_8h.html#a92">00389</a> <span class="preprocessor">#define MI_ALIGN_TO_SIZE(VA,ALIGNMENT) ((PVOID)((ULONG_PTR)(VA) &amp; ~((ULONG_PTR) ALIGNMENT - 1)))</span>
00390 <span class="preprocessor"></span>
00391 <span class="comment">//++</span>
00392 <span class="comment">//</span>
00393 <span class="comment">// LONGLONG</span>
00394 <span class="comment">// MI_STARTING_OFFSET (</span>
00395 <span class="comment">//     IN PSUBSECTION SUBSECT</span>
00396 <span class="comment">//     IN PMMPTE PTE</span>
00397 <span class="comment">//     )</span>
00398 <span class="comment">//</span>
00399 <span class="comment">// Routine Description:</span>
00400 <span class="comment">//</span>
00401 <span class="comment">//    This macro takes a pointer to a PTE within a subsection and a pointer</span>
00402 <span class="comment">//    to that subsection and calculates the offset for that PTE within the</span>
00403 <span class="comment">//    file.</span>
00404 <span class="comment">//</span>
00405 <span class="comment">// Arguments:</span>
00406 <span class="comment">//</span>
00407 <span class="comment">//     PTE - PTE within subsection.</span>
00408 <span class="comment">//</span>
00409 <span class="comment">//     SUBSECT - Subsection</span>
00410 <span class="comment">//</span>
00411 <span class="comment">// Return Value:</span>
00412 <span class="comment">//</span>
00413 <span class="comment">//     Offset for issuing I/O from.</span>
00414 <span class="comment">//</span>
00415 <span class="comment">//--</span>
00416 
<a name="l00417"></a><a class="code" href="../../d4/d8/mi_8h.html#a93">00417</a> <span class="preprocessor">#define MI_STARTING_OFFSET(SUBSECT,PTE) \</span>
00418 <span class="preprocessor">           (((LONGLONG)((ULONG_PTR)((PTE) - ((SUBSECT)-&gt;SubsectionBase))) &lt;&lt; PAGE_SHIFT) + \</span>
00419 <span class="preprocessor">             ((LONGLONG)((SUBSECT)-&gt;StartingSector) &lt;&lt; MMSECTOR_SHIFT));</span>
00420 <span class="preprocessor"></span>
00421 
00422 <span class="comment">// PVOID</span>
00423 <span class="comment">// MiFindEmptyAddressRangeDown (</span>
00424 <span class="comment">//    IN ULONG_PTR SizeOfRange,</span>
00425 <span class="comment">//    IN PVOID HighestAddressToEndAt,</span>
00426 <span class="comment">//    IN ULONG_PTR Alignment</span>
00427 <span class="comment">//    )</span>
00428 <span class="comment">//</span>
00429 <span class="comment">//</span>
00430 <span class="comment">// Routine Description:</span>
00431 <span class="comment">//</span>
00432 <span class="comment">//    The function examines the virtual address descriptors to locate</span>
00433 <span class="comment">//    an unused range of the specified size and returns the starting</span>
00434 <span class="comment">//    address of the range.  This routine looks from the top down.</span>
00435 <span class="comment">//</span>
00436 <span class="comment">// Arguments:</span>
00437 <span class="comment">//</span>
00438 <span class="comment">//    SizeOfRange - Supplies the size in bytes of the range to locate.</span>
00439 <span class="comment">//</span>
00440 <span class="comment">//    HighestAddressToEndAt - Supplies the virtual address to begin looking</span>
00441 <span class="comment">//                            at.</span>
00442 <span class="comment">//</span>
00443 <span class="comment">//    Alignment - Supplies the alignment for the address.  Must be</span>
00444 <span class="comment">//                 a power of 2 and greater than the page_size.</span>
00445 <span class="comment">//</span>
00446 <span class="comment">//Return Value:</span>
00447 <span class="comment">//</span>
00448 <span class="comment">//    Returns the starting address of a suitable range.</span>
00449 <span class="comment">//</span>
00450 
<a name="l00451"></a><a class="code" href="../../d4/d8/mi_8h.html#a94">00451</a> <span class="preprocessor">#define MiFindEmptyAddressRangeDown(SizeOfRange,HighestAddressToEndAt,Alignment) \</span>
00452 <span class="preprocessor">               (MiFindEmptyAddressRangeDownTree(                             \</span>
00453 <span class="preprocessor">                    (SizeOfRange),                                           \</span>
00454 <span class="preprocessor">                    (HighestAddressToEndAt),                                 \</span>
00455 <span class="preprocessor">                    (Alignment),                                             \</span>
00456 <span class="preprocessor">                    (PMMADDRESS_NODE)(PsGetCurrentProcess()-&gt;VadRoot)))</span>
00457 <span class="preprocessor"></span>
00458 <span class="comment">// PMMVAD</span>
00459 <span class="comment">// MiGetPreviousVad (</span>
00460 <span class="comment">//     IN PMMVAD Vad</span>
00461 <span class="comment">//     )</span>
00462 <span class="comment">//</span>
00463 <span class="comment">// Routine Description:</span>
00464 <span class="comment">//</span>
00465 <span class="comment">//     This function locates the virtual address descriptor which contains</span>
00466 <span class="comment">//     the address range which logically precedes the specified virtual</span>
00467 <span class="comment">//     address descriptor.</span>
00468 <span class="comment">//</span>
00469 <span class="comment">// Arguments:</span>
00470 <span class="comment">//</span>
00471 <span class="comment">//     Vad - Supplies a pointer to a virtual address descriptor.</span>
00472 <span class="comment">//</span>
00473 <span class="comment">// Return Value:</span>
00474 <span class="comment">//</span>
00475 <span class="comment">//     Returns a pointer to the virtual address descriptor containing the</span>
00476 <span class="comment">//     next address range, NULL if none.</span>
00477 <span class="comment">//</span>
00478 <span class="comment">//</span>
00479 
<a name="l00480"></a><a class="code" href="../../d4/d8/mi_8h.html#a95">00480</a> <span class="preprocessor">#define MiGetPreviousVad(VAD) ((PMMVAD)MiGetPreviousNode((PMMADDRESS_NODE)(VAD)))</span>
00481 <span class="preprocessor"></span>
00482 
00483 <span class="comment">// PMMVAD</span>
00484 <span class="comment">// MiGetNextVad (</span>
00485 <span class="comment">//     IN PMMVAD Vad</span>
00486 <span class="comment">//     )</span>
00487 <span class="comment">//</span>
00488 <span class="comment">// Routine Description:</span>
00489 <span class="comment">//</span>
00490 <span class="comment">//     This function locates the virtual address descriptor which contains</span>
00491 <span class="comment">//     the address range which logically follows the specified address range.</span>
00492 <span class="comment">//</span>
00493 <span class="comment">// Arguments:</span>
00494 <span class="comment">//</span>
00495 <span class="comment">//     VAD - Supplies a pointer to a virtual address descriptor.</span>
00496 <span class="comment">//</span>
00497 <span class="comment">// Return Value:</span>
00498 <span class="comment">//</span>
00499 <span class="comment">//     Returns a pointer to the virtual address descriptor containing the</span>
00500 <span class="comment">//     next address range, NULL if none.</span>
00501 <span class="comment">//</span>
00502 
<a name="l00503"></a><a class="code" href="../../d4/d8/mi_8h.html#a96">00503</a> <span class="preprocessor">#define MiGetNextVad(VAD) ((PMMVAD)MiGetNextNode((PMMADDRESS_NODE)(VAD)))</span>
00504 <span class="preprocessor"></span>
00505 
00506 
00507 <span class="comment">// PMMVAD</span>
00508 <span class="comment">// MiGetFirstVad (</span>
00509 <span class="comment">//     Process</span>
00510 <span class="comment">//     )</span>
00511 <span class="comment">//</span>
00512 <span class="comment">// Routine Description:</span>
00513 <span class="comment">//</span>
00514 <span class="comment">//     This function locates the virtual address descriptor which contains</span>
00515 <span class="comment">//     the address range which logically is first within the address space.</span>
00516 <span class="comment">//</span>
00517 <span class="comment">// Arguments:</span>
00518 <span class="comment">//</span>
00519 <span class="comment">//     Process - Specifies the process in which to locate the VAD.</span>
00520 <span class="comment">//</span>
00521 <span class="comment">// Return Value:</span>
00522 <span class="comment">//</span>
00523 <span class="comment">//     Returns a pointer to the virtual address descriptor containing the</span>
00524 <span class="comment">//     first address range, NULL if none.</span>
00525 
<a name="l00526"></a><a class="code" href="../../d4/d8/mi_8h.html#a97">00526</a> <span class="preprocessor">#define MiGetFirstVad(Process) \</span>
00527 <span class="preprocessor">    ((PMMVAD)MiGetFirstNode((PMMADDRESS_NODE)(Process-&gt;VadRoot)))</span>
00528 <span class="preprocessor"></span>
00529 
00530 
00531 <span class="comment">// PMMVAD</span>
00532 <span class="comment">// MiCheckForConflictingVad (</span>
00533 <span class="comment">//     IN PVOID StartingAddress,</span>
00534 <span class="comment">//     IN PVOID EndingAddress</span>
00535 <span class="comment">//     )</span>
00536 <span class="comment">//</span>
00537 <span class="comment">// Routine Description:</span>
00538 <span class="comment">//</span>
00539 <span class="comment">//     The function determines if any addresses between a given starting and</span>
00540 <span class="comment">//     ending address is contained within a virtual address descriptor.</span>
00541 <span class="comment">//</span>
00542 <span class="comment">// Arguments:</span>
00543 <span class="comment">//</span>
00544 <span class="comment">//     StartingAddress - Supplies the virtual address to locate a containing</span>
00545 <span class="comment">//                       descriptor.</span>
00546 <span class="comment">//</span>
00547 <span class="comment">//     EndingAddress - Supplies the virtual address to locate a containing</span>
00548 <span class="comment">//                       descriptor.</span>
00549 <span class="comment">//</span>
00550 <span class="comment">// Return Value:</span>
00551 <span class="comment">//</span>
00552 <span class="comment">//     Returns a pointer to the first conflicting virtual address descriptor</span>
00553 <span class="comment">//     if one is found, otherwise a NULL value is returned.</span>
00554 <span class="comment">//</span>
00555 
<a name="l00556"></a><a class="code" href="../../d4/d8/mi_8h.html#a98">00556</a> <span class="preprocessor">#define MiCheckForConflictingVad(StartingAddress,EndingAddress)           \</span>
00557 <span class="preprocessor">    ((PMMVAD)MiCheckForConflictingNode(                                   \</span>
00558 <span class="preprocessor">                    MI_VA_TO_VPN(StartingAddress),                        \</span>
00559 <span class="preprocessor">                    MI_VA_TO_VPN(EndingAddress),                          \</span>
00560 <span class="preprocessor">                    (PMMADDRESS_NODE)(PsGetCurrentProcess()-&gt;VadRoot)))</span>
00561 <span class="preprocessor"></span>
00562 <span class="comment">// PMMCLONE_DESCRIPTOR</span>
00563 <span class="comment">// MiGetNextClone (</span>
00564 <span class="comment">//     IN PMMCLONE_DESCRIPTOR Clone</span>
00565 <span class="comment">//     )</span>
00566 <span class="comment">//</span>
00567 <span class="comment">// Routine Description:</span>
00568 <span class="comment">//</span>
00569 <span class="comment">//     This function locates the virtual address descriptor which contains</span>
00570 <span class="comment">//     the address range which logically follows the specified address range.</span>
00571 <span class="comment">//</span>
00572 <span class="comment">// Arguments:</span>
00573 <span class="comment">//</span>
00574 <span class="comment">//     Clone - Supplies a pointer to a virtual address descriptor.</span>
00575 <span class="comment">//</span>
00576 <span class="comment">// Return Value:</span>
00577 <span class="comment">//</span>
00578 <span class="comment">//     Returns a pointer to the virtual address descriptor containing the</span>
00579 <span class="comment">//     next address range, NULL if none.</span>
00580 <span class="comment">//</span>
00581 <span class="comment">//</span>
00582 
<a name="l00583"></a><a class="code" href="../../d4/d8/mi_8h.html#a99">00583</a> <span class="preprocessor">#define MiGetNextClone(CLONE) \</span>
00584 <span class="preprocessor"> ((PMMCLONE_DESCRIPTOR)MiGetNextNode((PMMADDRESS_NODE)(CLONE)))</span>
00585 <span class="preprocessor"></span>
00586 
00587 
00588 <span class="comment">// PMMCLONE_DESCRIPTOR</span>
00589 <span class="comment">// MiGetPreviousClone (</span>
00590 <span class="comment">//     IN PMMCLONE_DESCRIPTOR Clone</span>
00591 <span class="comment">//     )</span>
00592 <span class="comment">//</span>
00593 <span class="comment">// Routine Description:</span>
00594 <span class="comment">//</span>
00595 <span class="comment">//     This function locates the virtual address descriptor which contains</span>
00596 <span class="comment">//     the address range which logically precedes the specified virtual</span>
00597 <span class="comment">//     address descriptor.</span>
00598 <span class="comment">//</span>
00599 <span class="comment">// Arguments:</span>
00600 <span class="comment">//</span>
00601 <span class="comment">//     Clone - Supplies a pointer to a virtual address descriptor.</span>
00602 <span class="comment">//</span>
00603 <span class="comment">// Return Value:</span>
00604 <span class="comment">//</span>
00605 <span class="comment">//     Returns a pointer to the virtual address descriptor containing the</span>
00606 <span class="comment">//     next address range, NULL if none.</span>
00607 
00608 
<a name="l00609"></a><a class="code" href="../../d4/d8/mi_8h.html#a100">00609</a> <span class="preprocessor">#define MiGetPreviousClone(CLONE)  \</span>
00610 <span class="preprocessor">             ((PMMCLONE_DESCRIPTOR)MiGetPreviousNode((PMMADDRESS_NODE)(CLONE)))</span>
00611 <span class="preprocessor"></span>
00612 
00613 
00614 <span class="comment">// PMMCLONE_DESCRIPTOR</span>
00615 <span class="comment">// MiGetFirstClone (</span>
00616 <span class="comment">//     )</span>
00617 <span class="comment">//</span>
00618 <span class="comment">// Routine Description:</span>
00619 <span class="comment">//</span>
00620 <span class="comment">//     This function locates the virtual address descriptor which contains</span>
00621 <span class="comment">//     the address range which logically is first within the address space.</span>
00622 <span class="comment">//</span>
00623 <span class="comment">// Arguments:</span>
00624 <span class="comment">//</span>
00625 <span class="comment">//     None.</span>
00626 <span class="comment">//</span>
00627 <span class="comment">// Return Value:</span>
00628 <span class="comment">//</span>
00629 <span class="comment">//     Returns a pointer to the virtual address descriptor containing the</span>
00630 <span class="comment">//     first address range, NULL if none.</span>
00631 <span class="comment">//</span>
00632 
00633 
<a name="l00634"></a><a class="code" href="../../d4/d8/mi_8h.html#a101">00634</a> <span class="preprocessor">#define MiGetFirstClone() \</span>
00635 <span class="preprocessor">    ((PMMCLONE_DESCRIPTOR)MiGetFirstNode((PMMADDRESS_NODE)(PsGetCurrentProcess()-&gt;CloneRoot)))</span>
00636 <span class="preprocessor"></span>
00637 
00638 
00639 <span class="comment">// VOID</span>
00640 <span class="comment">// MiInsertClone (</span>
00641 <span class="comment">//     IN PMMCLONE_DESCRIPTOR Clone</span>
00642 <span class="comment">//     )</span>
00643 <span class="comment">//</span>
00644 <span class="comment">// Routine Description:</span>
00645 <span class="comment">//</span>
00646 <span class="comment">//     This function inserts a virtual address descriptor into the tree and</span>
00647 <span class="comment">//     reorders the splay tree as appropriate.</span>
00648 <span class="comment">//</span>
00649 <span class="comment">// Arguments:</span>
00650 <span class="comment">//</span>
00651 <span class="comment">//     Clone - Supplies a pointer to a virtual address descriptor</span>
00652 <span class="comment">//</span>
00653 <span class="comment">//</span>
00654 <span class="comment">// Return Value:</span>
00655 <span class="comment">//</span>
00656 <span class="comment">//     None.</span>
00657 <span class="comment">//</span>
00658 
<a name="l00659"></a><a class="code" href="../../d4/d8/mi_8h.html#a102">00659</a> <span class="preprocessor">#define MiInsertClone(CLONE) \</span>
00660 <span class="preprocessor">    {                                           \</span>
00661 <span class="preprocessor">        ASSERT ((CLONE)-&gt;NumberOfPtes != 0);     \</span>
00662 <span class="preprocessor">        MiInsertNode(((PMMADDRESS_NODE)(CLONE)),(PMMADDRESS_NODE *)&amp;(PsGetCurrentProcess()-&gt;CloneRoot)); \</span>
00663 <span class="preprocessor">    }</span>
00664 <span class="preprocessor"></span>
00665 
00666 
00667 
00668 <span class="comment">// VOID</span>
00669 <span class="comment">// MiRemoveClone (</span>
00670 <span class="comment">//     IN PMMCLONE_DESCRIPTOR Clone</span>
00671 <span class="comment">//     )</span>
00672 <span class="comment">//</span>
00673 <span class="comment">// Routine Description:</span>
00674 <span class="comment">//</span>
00675 <span class="comment">//     This function removes a virtual address descriptor from the tree and</span>
00676 <span class="comment">//     reorders the splay tree as appropriate.</span>
00677 <span class="comment">//</span>
00678 <span class="comment">// Arguments:</span>
00679 <span class="comment">//</span>
00680 <span class="comment">//     Clone - Supplies a pointer to a virtual address descriptor.</span>
00681 <span class="comment">//</span>
00682 <span class="comment">// Return Value:</span>
00683 <span class="comment">//</span>
00684 <span class="comment">//     None.</span>
00685 <span class="comment">//</span>
00686 
<a name="l00687"></a><a class="code" href="../../d4/d8/mi_8h.html#a103">00687</a> <span class="preprocessor">#define MiRemoveClone(CLONE) \</span>
00688 <span class="preprocessor">    MiRemoveNode((PMMADDRESS_NODE)(CLONE),(PMMADDRESS_NODE *)&amp;(PsGetCurrentProcess()-&gt;CloneRoot));</span>
00689 <span class="preprocessor"></span>
00690 
00691 
00692 <span class="comment">// PMMCLONE_DESCRIPTOR</span>
00693 <span class="comment">// MiLocateCloneAddress (</span>
00694 <span class="comment">//     IN PVOID VirtualAddress</span>
00695 <span class="comment">//     )</span>
00696 <span class="comment">//</span>
00697 <span class="comment">// /*++</span>
00698 <span class="comment">//</span>
00699 <span class="comment">// Routine Description:</span>
00700 <span class="comment">//</span>
00701 <span class="comment">//     The function locates the virtual address descriptor which describes</span>
00702 <span class="comment">//     a given address.</span>
00703 <span class="comment">//</span>
00704 <span class="comment">// Arguments:</span>
00705 <span class="comment">//</span>
00706 <span class="comment">//     VirtualAddress - Supplies the virtual address to locate a descriptor</span>
00707 <span class="comment">//                      for.</span>
00708 <span class="comment">//</span>
00709 <span class="comment">// Return Value:</span>
00710 <span class="comment">//</span>
00711 <span class="comment">//     Returns a pointer to the virtual address descriptor which contains</span>
00712 <span class="comment">//     the supplied virtual address or NULL if none was located.</span>
00713 <span class="comment">//</span>
00714 
<a name="l00715"></a><a class="code" href="../../d4/d8/mi_8h.html#a104">00715</a> <span class="preprocessor">#define MiLocateCloneAddress(VA)                                            \</span>
00716 <span class="preprocessor">    (PsGetCurrentProcess()-&gt;CloneRoot ?                                     \</span>
00717 <span class="preprocessor">        ((PMMCLONE_DESCRIPTOR)MiLocateAddressInTree(((ULONG_PTR)VA),                   \</span>
00718 <span class="preprocessor">                   (PMMADDRESS_NODE *)&amp;(PsGetCurrentProcess()-&gt;CloneRoot))) :  \</span>
00719 <span class="preprocessor">        ((PMMCLONE_DESCRIPTOR)NULL))</span>
00720 <span class="preprocessor"></span>
00721 
00722 <span class="comment">// PMMCLONE_DESCRIPTOR</span>
00723 <span class="comment">// MiCheckForConflictingClone (</span>
00724 <span class="comment">//     IN PVOID StartingAddress,</span>
00725 <span class="comment">//     IN PVOID EndingAddress</span>
00726 <span class="comment">//     )</span>
00727 <span class="comment">//</span>
00728 <span class="comment">// Routine Description:</span>
00729 <span class="comment">//</span>
00730 <span class="comment">//     The function determines if any addresses between a given starting and</span>
00731 <span class="comment">//     ending address is contained within a virtual address descriptor.</span>
00732 <span class="comment">//</span>
00733 <span class="comment">// Arguments:</span>
00734 <span class="comment">//</span>
00735 <span class="comment">//     StartingAddress - Supplies the virtual address to locate a containing</span>
00736 <span class="comment">//                       descriptor.</span>
00737 <span class="comment">//</span>
00738 <span class="comment">//     EndingAddress - Supplies the virtual address to locate a containing</span>
00739 <span class="comment">//                       descriptor.</span>
00740 <span class="comment">//</span>
00741 <span class="comment">// Return Value:</span>
00742 <span class="comment">//</span>
00743 <span class="comment">//     Returns a pointer to the first conflicting virtual address descriptor</span>
00744 <span class="comment">//     if one is found, otherwise a NULL value is returned.</span>
00745 <span class="comment">//</span>
00746 
<a name="l00747"></a><a class="code" href="../../d4/d8/mi_8h.html#a105">00747</a> <span class="preprocessor">#define MiCheckForConflictingClone(START,END)                             \</span>
00748 <span class="preprocessor">    ((PMMCLONE_DESCRIPTOR)(MiCheckForConflictingNode(START,END,           \</span>
00749 <span class="preprocessor">                   (PMMADDRESS_NODE)(PsGetCurrentProcess()-&gt;CloneRoot))))</span>
00750 <span class="preprocessor"></span>
00751 
00752 <span class="comment">//</span>
00753 <span class="comment">// MiGetVirtualPageNumber returns the virtual page number</span>
00754 <span class="comment">// for a given address.</span>
00755 <span class="comment">//</span>
00756 
00757 <span class="comment">//#define MiGetVirtualPageNumber(va) ((ULONG_PTR)(va) &gt;&gt; PAGE_SHIFT)</span>
00758 
<a name="l00759"></a><a class="code" href="../../d4/d8/mi_8h.html#a106">00759</a> <span class="preprocessor">#define MI_VA_TO_PAGE(va) ((ULONG_PTR)(va) &gt;&gt; PAGE_SHIFT)</span>
00760 <span class="preprocessor"></span>
<a name="l00761"></a><a class="code" href="../../d4/d8/mi_8h.html#a107">00761</a> <span class="preprocessor">#define MI_VA_TO_VPN(va)  ((ULONG_PTR)(va) &gt;&gt; PAGE_SHIFT)</span>
00762 <span class="preprocessor"></span>
<a name="l00763"></a><a class="code" href="../../d4/d8/mi_8h.html#a108">00763</a> <span class="preprocessor">#define MI_VPN_TO_VA(vpn)  (PVOID)((vpn) &lt;&lt; PAGE_SHIFT)</span>
00764 <span class="preprocessor"></span>
<a name="l00765"></a><a class="code" href="../../d4/d8/mi_8h.html#a109">00765</a> <span class="preprocessor">#define MI_VPN_TO_VA_ENDING(vpn)  (PVOID)(((vpn) &lt;&lt; PAGE_SHIFT) | (PAGE_SIZE - 1))</span>
00766 <span class="preprocessor"></span>
<a name="l00767"></a><a class="code" href="../../d4/d8/mi_8h.html#a110">00767</a> <span class="preprocessor">#define MiGetByteOffset(va) ((ULONG_PTR)(va) &amp; (PAGE_SIZE - 1))</span>
00768 <span class="preprocessor"></span>
<a name="l00769"></a><a class="code" href="../../d4/d8/mi_8h.html#a111">00769</a> <span class="preprocessor">#define MI_PFN_ELEMENT(index) (&amp;MmPfnDatabase[index])</span>
00770 <span class="preprocessor"></span>
00771 <span class="comment">//</span>
00772 <span class="comment">// Make a write-copy PTE, only writable.</span>
00773 <span class="comment">//</span>
00774 
<a name="l00775"></a><a class="code" href="../../d4/d8/mi_8h.html#a112">00775</a> <span class="preprocessor">#define MI_MAKE_PROTECT_NOT_WRITE_COPY(PROTECT) \</span>
00776 <span class="preprocessor">            (MmMakeProtectNotWriteCopy[PROTECT])</span>
00777 <span class="preprocessor"></span>
00778 <span class="comment">//</span>
00779 <span class="comment">// Define macros to lock and unlock the PFN database.</span>
00780 <span class="comment">//</span>
00781 
00782 <span class="preprocessor">#if defined(_ALPHA_) || defined(_X86_)</span>
00783 <span class="preprocessor"></span>
00784 <span class="preprocessor">#define MiLockPfnDatabase(OldIrql) \</span>
00785 <span class="preprocessor">    OldIrql = KeAcquireQueuedSpinLock(LockQueuePfnLock)</span>
00786 <span class="preprocessor"></span>
00787 <span class="preprocessor">#define MiUnlockPfnDatabase(OldIrql) \</span>
00788 <span class="preprocessor">    KeReleaseQueuedSpinLock(LockQueuePfnLock, OldIrql)</span>
00789 <span class="preprocessor"></span>
00790 <span class="preprocessor">#define MiTryToLockPfnDatabase(OldIrql) \</span>
00791 <span class="preprocessor">    KeTryToAcquireQueuedSpinLock(LockQueuePfnLock, &amp;OldIrql)</span>
00792 <span class="preprocessor"></span>
00793 <span class="preprocessor">#define MiReleasePfnLock() \</span>
00794 <span class="preprocessor">    KiReleaseQueuedSpinLock(&amp;KeGetCurrentPrcb()-&gt;LockQueue[LockQueuePfnLock])</span>
00795 <span class="preprocessor"></span>
00796 <span class="preprocessor">#define MiLockSystemSpace(OldIrql) \</span>
00797 <span class="preprocessor">    OldIrql = KeAcquireQueuedSpinLock(LockQueueSystemSpaceLock)</span>
00798 <span class="preprocessor"></span>
00799 <span class="preprocessor">#define MiUnlockSystemSpace(OldIrql) \</span>
00800 <span class="preprocessor">    KeReleaseQueuedSpinLock(LockQueueSystemSpaceLock, OldIrql)</span>
00801 <span class="preprocessor"></span>
00802 <span class="preprocessor">#define MiLockSystemSpaceAtDpcLevel() \</span>
00803 <span class="preprocessor">    KiAcquireQueuedSpinLock(&amp;KeGetCurrentPrcb()-&gt;LockQueue[LockQueueSystemSpaceLock])</span>
00804 <span class="preprocessor"></span>
00805 <span class="preprocessor">#define MiUnlockSystemSpaceFromDpcLevel() \</span>
00806 <span class="preprocessor">    KiReleaseQueuedSpinLock(&amp;KeGetCurrentPrcb()-&gt;LockQueue[LockQueueSystemSpaceLock])</span>
00807 <span class="preprocessor"></span>
00808 <span class="preprocessor">#else</span>
00809 <span class="preprocessor"></span>
<a name="l00810"></a><a class="code" href="../../d4/d8/mi_8h.html#a113">00810</a> <span class="preprocessor">#define MiLockPfnDatabase(OldIrql) \</span>
00811 <span class="preprocessor">    ExAcquireSpinLock(&amp;MmPfnLock, &amp;OldIrql)</span>
00812 <span class="preprocessor"></span>
<a name="l00813"></a><a class="code" href="../../d4/d8/mi_8h.html#a114">00813</a> <span class="preprocessor">#define MiUnlockPfnDatabase(OldIrql) \</span>
00814 <span class="preprocessor">    ExReleaseSpinLock(&amp;MmPfnLock, OldIrql)</span>
00815 <span class="preprocessor"></span>
<a name="l00816"></a><a class="code" href="../../d4/d8/mi_8h.html#a115">00816</a> <span class="preprocessor">#define MiTryToLockPfnDatabase(OldIrql) \</span>
00817 <span class="preprocessor">    KeTryToAcquireSpinLock(&amp;MmPfnLock, &amp;OldIrql)</span>
00818 <span class="preprocessor"></span>
<a name="l00819"></a><a class="code" href="../../d4/d8/mi_8h.html#a116">00819</a> <span class="preprocessor">#define MiReleasePfnLock() \</span>
00820 <span class="preprocessor">    KiReleaseSpinLock(&amp;MmPfnLock)</span>
00821 <span class="preprocessor"></span>
<a name="l00822"></a><a class="code" href="../../d4/d8/mi_8h.html#a117">00822</a> <span class="preprocessor">#define MiLockSystemSpace(OldIrql) \</span>
00823 <span class="preprocessor">    ExAcquireSpinLock(&amp;MmSystemSpaceLock, &amp;OldIrql)</span>
00824 <span class="preprocessor"></span>
<a name="l00825"></a><a class="code" href="../../d4/d8/mi_8h.html#a118">00825</a> <span class="preprocessor">#define MiUnlockSystemSpace(OldIrql) \</span>
00826 <span class="preprocessor">    ExReleaseSpinLock(&amp;MmSystemSpaceLock, OldIrql)</span>
00827 <span class="preprocessor"></span>
<a name="l00828"></a><a class="code" href="../../d4/d8/mi_8h.html#a119">00828</a> <span class="preprocessor">#define MiLockSystemSpaceAtDpcLevel() \</span>
00829 <span class="preprocessor">    ExAcquireSpinLockAtDpcLevel(&amp;MmSystemSpaceLock)</span>
00830 <span class="preprocessor"></span>
<a name="l00831"></a><a class="code" href="../../d4/d8/mi_8h.html#a120">00831</a> <span class="preprocessor">#define MiUnlockSystemSpaceFromDpcLevel() \</span>
00832 <span class="preprocessor">    ExReleaseSpinLockFromDpcLevel(&amp;MmSystemSpaceLock)</span>
00833 <span class="preprocessor"></span>
00834 <span class="preprocessor">#endif</span>
00835 <span class="preprocessor"></span>
00836 <span class="preprocessor">#if PFN_CONSISTENCY</span>
00837 <span class="preprocessor"></span>
00838 <span class="preprocessor">#define CONSISTENCY_LOCK_PFN(OLDIRQL)  LOCK_PFN(OLDIRQL)</span>
00839 <span class="preprocessor"></span><span class="preprocessor">#define CONSISTENCY_UNLOCK_PFN(OLDIRQL)  UNLOCK_PFN(OLDIRQL)</span>
00840 <span class="preprocessor"></span>
00841 <span class="preprocessor">#define CONSISTENCY_LOCK_PFN2(OLDIRQL)  LOCK_PFN2(OLDIRQL)</span>
00842 <span class="preprocessor"></span><span class="preprocessor">#define CONSISTENCY_UNLOCK_PFN2(OLDIRQL)  UNLOCK_PFN2(OLDIRQL)</span>
00843 <span class="preprocessor"></span>
00844 <span class="preprocessor">#define PFN_CONSISTENCY_SET \</span>
00845 <span class="preprocessor">    (MiPfnLockOwner = PsGetCurrentThread(), MiMapInPfnDatabase())</span>
00846 <span class="preprocessor"></span><span class="preprocessor">#define PFN_CONSISTENCY_UNSET \</span>
00847 <span class="preprocessor">    (MiUnMapPfnDatabase(), MiPfnLockOwner = (PETHREAD)0)</span>
00848 <span class="preprocessor"></span>
00849 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00850 MiMapInPfnDatabase (
00851     VOID
00852     );
00853 
00854 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00855 MiUnMapPfnDatabase (
00856     VOID
00857     );
00858 
00859 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00860 MiSetModified (
00861     IN <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1,
00862     IN ULONG Dirty
00863     );
00864 
00865 <span class="keyword">extern</span> <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> MiPfnStartPte;
00866 <span class="keyword">extern</span> PFN_NUMBER MiPfnPtes;
00867 <span class="keyword">extern</span> BOOLEAN MiPfnProtectionEnabled;
00868 <span class="keyword">extern</span> <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> MiPfnLockOwner;
00869 
00870 <span class="preprocessor">#define PFN_LOCK_OWNED_BY_ME()      (MiPfnLockOwner == PsGetCurrentThread())</span>
00871 <span class="preprocessor"></span>
00872 
00873 <span class="preprocessor">#else // PFN_CONSISTENCY</span>
00874 <span class="preprocessor"></span>
<a name="l00875"></a><a class="code" href="../../d4/d8/mi_8h.html#a121">00875</a> <span class="preprocessor">#define CONSISTENCY_LOCK_PFN(OLDIRQL)</span>
<a name="l00876"></a><a class="code" href="../../d4/d8/mi_8h.html#a122">00876</a> <span class="preprocessor"></span><span class="preprocessor">#define CONSISTENCY_UNLOCK_PFN(OLDIRQL)</span>
00877 <span class="preprocessor"></span>
<a name="l00878"></a><a class="code" href="../../d4/d8/mi_8h.html#a123">00878</a> <span class="preprocessor">#define CONSISTENCY_LOCK_PFN2(OLDIRQL)</span>
<a name="l00879"></a><a class="code" href="../../d4/d8/mi_8h.html#a124">00879</a> <span class="preprocessor"></span><span class="preprocessor">#define CONSISTENCY_UNLOCK_PFN2(OLDIRQL)</span>
00880 <span class="preprocessor"></span>
<a name="l00881"></a><a class="code" href="../../d4/d8/mi_8h.html#a125">00881</a> <span class="preprocessor">#define PFN_CONSISTENCY_SET</span>
<a name="l00882"></a><a class="code" href="../../d4/d8/mi_8h.html#a126">00882</a> <span class="preprocessor"></span><span class="preprocessor">#define PFN_CONSISTENCY_UNSET</span>
00883 <span class="preprocessor"></span>
00884 <span class="preprocessor">#endif // PFN_CONSISTENCY</span>
00885 <span class="preprocessor"></span>
<a name="l00886"></a><a class="code" href="../../d4/d8/mi_8h.html#a127">00886</a> <span class="preprocessor">#define LOCK_PFN(OLDIRQL) ASSERT (KeGetCurrentIrql() &lt;= APC_LEVEL); \</span>
00887 <span class="preprocessor">                          MiLockPfnDatabase(OLDIRQL);               \</span>
00888 <span class="preprocessor">                          PFN_CONSISTENCY_SET;</span>
00889 <span class="preprocessor"></span>
<a name="l00890"></a><a class="code" href="../../d4/d8/mi_8h.html#a128">00890</a> <span class="preprocessor">#define LOCK_PFN_WITH_TRY(OLDIRQL)                                   \</span>
00891 <span class="preprocessor">    ASSERT (KeGetCurrentIrql() &lt;= APC_LEVEL);                        \</span>
00892 <span class="preprocessor">    do {                                                             \</span>
00893 <span class="preprocessor">    } while (MiTryToLockPfnDatabase(OLDIRQL) == FALSE);              \</span>
00894 <span class="preprocessor">    PFN_CONSISTENCY_SET;</span>
00895 <span class="preprocessor"></span>
<a name="l00896"></a><a class="code" href="../../d4/d8/mi_8h.html#a129">00896</a> <span class="preprocessor">#define UNLOCK_PFN(OLDIRQL)                                        \</span>
00897 <span class="preprocessor">    PFN_CONSISTENCY_UNSET;                                         \</span>
00898 <span class="preprocessor">    MiUnlockPfnDatabase(OLDIRQL);                                  \</span>
00899 <span class="preprocessor">    ASSERT(KeGetCurrentIrql() &lt;= APC_LEVEL);</span>
00900 <span class="preprocessor"></span>
<a name="l00901"></a><a class="code" href="../../d4/d8/mi_8h.html#a130">00901</a> <span class="preprocessor">#define LOCK_PFN2(OLDIRQL) ASSERT (KeGetCurrentIrql() &lt;= DISPATCH_LEVEL); \</span>
00902 <span class="preprocessor">                          MiLockPfnDatabase(OLDIRQL);               \</span>
00903 <span class="preprocessor">                          PFN_CONSISTENCY_SET;</span>
00904 <span class="preprocessor"></span>
<a name="l00905"></a><a class="code" href="../../d4/d8/mi_8h.html#a131">00905</a> <span class="preprocessor">#define UNLOCK_PFN2(OLDIRQL)                                       \</span>
00906 <span class="preprocessor">    PFN_CONSISTENCY_UNSET;                                         \</span>
00907 <span class="preprocessor">    MiUnlockPfnDatabase(OLDIRQL);                                  \</span>
00908 <span class="preprocessor">    ASSERT(KeGetCurrentIrql() &lt;= DISPATCH_LEVEL);</span>
00909 <span class="preprocessor"></span>
<a name="l00910"></a><a class="code" href="../../d4/d8/mi_8h.html#a132">00910</a> <span class="preprocessor">#define UNLOCK_PFN_AND_THEN_WAIT(OLDIRQL)                          \</span>
00911 <span class="preprocessor">                {                                                  \</span>
00912 <span class="preprocessor">                    KIRQL XXX;                                     \</span>
00913 <span class="preprocessor">                    ASSERT (KeGetCurrentIrql() == 2);              \</span>
00914 <span class="preprocessor">                    ASSERT (OLDIRQL &lt;= APC_LEVEL);                 \</span>
00915 <span class="preprocessor">                    KiLockDispatcherDatabase (&amp;XXX);               \</span>
00916 <span class="preprocessor">                    PFN_CONSISTENCY_UNSET;                         \</span>
00917 <span class="preprocessor">                    MiReleasePfnLock();                            \</span>
00918 <span class="preprocessor">                    (KeGetCurrentThread())-&gt;WaitIrql = OLDIRQL;    \</span>
00919 <span class="preprocessor">                    (KeGetCurrentThread())-&gt;WaitNext = TRUE;       \</span>
00920 <span class="preprocessor">                }</span>
00921 <span class="preprocessor"></span>
<a name="l00922"></a><a class="code" href="../../d4/d8/mi_8h.html#a133">00922</a> <span class="preprocessor">#define LOCK_AWE(PROCESS,OldIrql) \</span>
00923 <span class="preprocessor">    ExAcquireSpinLock(&amp;((PROCESS)-&gt;AweLock), &amp;OldIrql)</span>
00924 <span class="preprocessor"></span>
<a name="l00925"></a><a class="code" href="../../d4/d8/mi_8h.html#a134">00925</a> <span class="preprocessor">#define UNLOCK_AWE(PROCESS,OldIrql) \</span>
00926 <span class="preprocessor">    ExReleaseSpinLock(&amp;((PROCESS)-&gt;AweLock), OldIrql)</span>
00927 <span class="preprocessor"></span>
<a name="l00928"></a><a class="code" href="../../d4/d8/mi_8h.html#a432">00928</a> <span class="keyword">extern</span> <a class="code" href="../../d3/d7/struct__KMUTANT.html">KMUTANT</a> <a class="code" href="../../d4/d8/mi_8h.html#a432">MmSystemLoadLock</a>;
00929 
00930 <span class="preprocessor">#if DBG</span>
00931 <span class="preprocessor"></span><span class="preprocessor">#define SYSLOAD_LOCK_OWNED_BY_ME()      ((PETHREAD)MmSystemLoadLock.OwnerThread == PsGetCurrentThread())</span>
00932 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l00933"></a><a class="code" href="../../d4/d8/mi_8h.html#a135">00933</a> <span class="preprocessor"></span><span class="preprocessor">#define SYSLOAD_LOCK_OWNED_BY_ME()</span>
00934 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00935 <span class="preprocessor"></span>
00936 <span class="preprocessor">#if DBG</span>
00937 <span class="preprocessor"></span><span class="preprocessor">#define MM_PFN_LOCK_ASSERT() \</span>
00938 <span class="preprocessor">    if (MmDebug &amp; 0x80000) { \</span>
00939 <span class="preprocessor">        ASSERT (KeGetCurrentIrql() == 2);   \</span>
00940 <span class="preprocessor">    }</span>
00941 <span class="preprocessor"></span>
00942 <span class="keyword">extern</span> <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> MiExpansionLockOwner;
00943 
00944 <span class="preprocessor">#define MM_SET_EXPANSION_OWNER()  ASSERT (MiExpansionLockOwner == NULL); \</span>
00945 <span class="preprocessor">                                  MiExpansionLockOwner = PsGetCurrentThread();</span>
00946 <span class="preprocessor"></span>
00947 <span class="preprocessor">#define MM_CLEAR_EXPANSION_OWNER()  ASSERT (MiExpansionLockOwner == PsGetCurrentThread()); \</span>
00948 <span class="preprocessor">                                    MiExpansionLockOwner = NULL;</span>
00949 <span class="preprocessor"></span>
00950 <span class="preprocessor">#else</span>
<a name="l00951"></a><a class="code" href="../../d4/d8/mi_8h.html#a136">00951</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_PFN_LOCK_ASSERT()</span>
<a name="l00952"></a><a class="code" href="../../d4/d8/mi_8h.html#a137">00952</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_SET_EXPANSION_OWNER()</span>
<a name="l00953"></a><a class="code" href="../../d4/d8/mi_8h.html#a138">00953</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_CLEAR_EXPANSION_OWNER()</span>
00954 <span class="preprocessor"></span><span class="preprocessor">#endif //DBG</span>
00955 <span class="preprocessor"></span>
00956 
<a name="l00957"></a><a class="code" href="../../d4/d8/mi_8h.html#a139">00957</a> <span class="preprocessor">#define LOCK_EXPANSION(OLDIRQL)     ASSERT (KeGetCurrentIrql() &lt;= APC_LEVEL); \</span>
00958 <span class="preprocessor">                                ExAcquireSpinLock (&amp;MmExpansionLock, &amp;OLDIRQL);\</span>
00959 <span class="preprocessor">                                MM_SET_EXPANSION_OWNER ();</span>
00960 <span class="preprocessor"></span>
<a name="l00961"></a><a class="code" href="../../d4/d8/mi_8h.html#a140">00961</a> <span class="preprocessor">#define UNLOCK_EXPANSION(OLDIRQL)    MM_CLEAR_EXPANSION_OWNER (); \</span>
00962 <span class="preprocessor">                                ExReleaseSpinLock (&amp;MmExpansionLock, OLDIRQL); \</span>
00963 <span class="preprocessor">                                ASSERT (KeGetCurrentIrql() &lt;= APC_LEVEL);</span>
00964 <span class="preprocessor"></span>
<a name="l00965"></a><a class="code" href="../../d4/d8/mi_8h.html#a141">00965</a> <span class="preprocessor">#define UNLOCK_EXPANSION_AND_THEN_WAIT(OLDIRQL)                    \</span>
00966 <span class="preprocessor">                {                                                  \</span>
00967 <span class="preprocessor">                    KIRQL XXX;                                     \</span>
00968 <span class="preprocessor">                    ASSERT (KeGetCurrentIrql() == 2);              \</span>
00969 <span class="preprocessor">                    ASSERT (OLDIRQL &lt;= APC_LEVEL);                 \</span>
00970 <span class="preprocessor">                    KiLockDispatcherDatabase (&amp;XXX);               \</span>
00971 <span class="preprocessor">                    MM_CLEAR_EXPANSION_OWNER ();                   \</span>
00972 <span class="preprocessor">                    KiReleaseSpinLock (&amp;MmExpansionLock);          \</span>
00973 <span class="preprocessor">                    (KeGetCurrentThread())-&gt;WaitIrql = OLDIRQL;    \</span>
00974 <span class="preprocessor">                    (KeGetCurrentThread())-&gt;WaitNext = TRUE;       \</span>
00975 <span class="preprocessor">                }</span>
00976 <span class="preprocessor"></span>
00977 <span class="preprocessor">#if defined(_ALPHA_) &amp;&amp; !defined(_AXP64_)</span>
00978 <span class="preprocessor"></span><span class="preprocessor">#define LOCK_EXPANSION_IF_ALPHA(OLDIRQL)            \</span>
00979 <span class="preprocessor"> ExAcquireSpinLock (&amp;MmExpansionLock, &amp;OLDIRQL);    \</span>
00980 <span class="preprocessor"> MM_SET_EXPANSION_OWNER ();</span>
00981 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l00982"></a><a class="code" href="../../d4/d8/mi_8h.html#a142">00982</a> <span class="preprocessor"></span><span class="preprocessor">#define LOCK_EXPANSION_IF_ALPHA(OLDIRQL)</span>
00983 <span class="preprocessor"></span><span class="preprocessor">#endif //ALPHA</span>
00984 <span class="preprocessor"></span>
00985 
00986 <span class="preprocessor">#if defined(_ALPHA_) &amp;&amp; !defined(_AXP64_)</span>
00987 <span class="preprocessor"></span><span class="preprocessor">#define UNLOCK_EXPANSION_IF_ALPHA(OLDIRQL)            \</span>
00988 <span class="preprocessor"> MM_CLEAR_EXPANSION_OWNER ();                         \</span>
00989 <span class="preprocessor"> ExReleaseSpinLock ( &amp;MmExpansionLock, OLDIRQL )</span>
00990 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l00991"></a><a class="code" href="../../d4/d8/mi_8h.html#a143">00991</a> <span class="preprocessor"></span><span class="preprocessor">#define UNLOCK_EXPANSION_IF_ALPHA(OLDIRQL)</span>
00992 <span class="preprocessor"></span><span class="preprocessor">#endif //ALPHA</span>
00993 <span class="preprocessor"></span>
00994 
<a name="l00995"></a><a class="code" href="../../d4/d8/mi_8h.html#a433">00995</a> <span class="keyword">extern</span> LIST_ENTRY <a class="code" href="../../d4/d8/mi_8h.html#a433">MmLockConflictList</a>;
<a name="l00996"></a><a class="code" href="../../d4/d8/mi_8h.html#a434">00996</a> <span class="keyword">extern</span> <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> <a class="code" href="../../d4/d8/mi_8h.html#a434">MmSystemLockOwner</a>;
00997 
<a name="l00998"></a><a class="code" href="../../d4/d8/mi_8h.html#a144">00998</a> <span class="preprocessor">#define LOCK_SYSTEM_WS(OLDIRQL)                                 \</span>
00999 <span class="preprocessor">            ASSERT (KeGetCurrentIrql() &lt;= APC_LEVEL);           \</span>
01000 <span class="preprocessor">            KeRaiseIrql(APC_LEVEL,&amp;OLDIRQL);                    \</span>
01001 <span class="preprocessor">            ExAcquireResourceExclusive(&amp;MmSystemWsLock,TRUE);   \</span>
01002 <span class="preprocessor">            ASSERT (MmSystemLockOwner == NULL);                 \</span>
01003 <span class="preprocessor">            MmSystemLockOwner = PsGetCurrentThread();</span>
01004 <span class="preprocessor"></span>
<a name="l01005"></a><a class="code" href="../../d4/d8/mi_8h.html#a145">01005</a> <span class="preprocessor">#define UNLOCK_SYSTEM_WS(OLDIRQL)                               \</span>
01006 <span class="preprocessor">            ASSERT (MmSystemLockOwner == PsGetCurrentThread()); \</span>
01007 <span class="preprocessor">            MmSystemLockOwner = NULL;                           \</span>
01008 <span class="preprocessor">            ExReleaseResource (&amp;MmSystemWsLock);                \</span>
01009 <span class="preprocessor">            KeLowerIrql (OLDIRQL);                              \</span>
01010 <span class="preprocessor">            ASSERT (KeGetCurrentIrql() &lt;= APC_LEVEL);</span>
01011 <span class="preprocessor"></span>
<a name="l01012"></a><a class="code" href="../../d4/d8/mi_8h.html#a146">01012</a> <span class="preprocessor">#define UNLOCK_SYSTEM_WS_NO_IRQL()                              \</span>
01013 <span class="preprocessor">            ASSERT (MmSystemLockOwner == PsGetCurrentThread()); \</span>
01014 <span class="preprocessor">            MmSystemLockOwner = NULL;                           \</span>
01015 <span class="preprocessor">            ExReleaseResource (&amp;MmSystemWsLock);</span>
01016 <span class="preprocessor"></span>
<a name="l01017"></a><a class="code" href="../../d4/d8/mi_8h.html#a147">01017</a> <span class="preprocessor">#define MM_SYSTEM_WS_LOCK_ASSERT()                              \</span>
01018 <span class="preprocessor">        ASSERT (PsGetCurrentThread() == MmSystemLockOwner);</span>
01019 <span class="preprocessor"></span>
<a name="l01020"></a><a class="code" href="../../d4/d8/mi_8h.html#a148">01020</a> <span class="preprocessor">#define LOCK_HYPERSPACE(OLDIRQL)                            \</span>
01021 <span class="preprocessor">    ExAcquireSpinLock ( &amp;(PsGetCurrentProcess())-&gt;HyperSpaceLock, OLDIRQL );</span>
01022 <span class="preprocessor"></span>
01023 
<a name="l01024"></a><a class="code" href="../../d4/d8/mi_8h.html#a149">01024</a> <span class="preprocessor">#define UNLOCK_HYPERSPACE(OLDIRQL)                         \</span>
01025 <span class="preprocessor">    ExReleaseSpinLock ( &amp;(PsGetCurrentProcess())-&gt;HyperSpaceLock, OLDIRQL );</span>
01026 <span class="preprocessor"></span>
01027 <span class="preprocessor">#if defined (_AXP64_)</span>
01028 <span class="preprocessor"></span><span class="preprocessor">#define MI_WS_OWNER(PROCESS) ((PROCESS)-&gt;WorkingSetLock.Owner == KeGetCurrentThread())</span>
01029 <span class="preprocessor"></span><span class="preprocessor">#define MI_NOT_WS_OWNER(PROCESS) (!MI_WS_OWNER(PROCESS))</span>
01030 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l01031"></a><a class="code" href="../../d4/d8/mi_8h.html#a150">01031</a> <span class="preprocessor"></span><span class="preprocessor">#define MI_WS_OWNER(PROCESS)        1</span>
<a name="l01032"></a><a class="code" href="../../d4/d8/mi_8h.html#a151">01032</a> <span class="preprocessor"></span><span class="preprocessor">#define MI_NOT_WS_OWNER(PROCESS)    1</span>
01033 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
01034 <span class="preprocessor"></span>
<a name="l01035"></a><a class="code" href="../../d4/d8/mi_8h.html#a152">01035</a> <span class="preprocessor">#define MI_MUTEX_ACQUIRED_UNSAFE    0x88</span>
01036 <span class="preprocessor"></span>
<a name="l01037"></a><a class="code" href="../../d4/d8/mi_8h.html#a153">01037</a> <span class="preprocessor">#define MI_IS_WS_UNSAFE(PROCESS) ((PROCESS)-&gt;WorkingSetLock.OldIrql == MI_MUTEX_ACQUIRED_UNSAFE)</span>
01038 <span class="preprocessor"></span>
<a name="l01039"></a><a class="code" href="../../d4/d8/mi_8h.html#a154">01039</a> <span class="preprocessor">#define LOCK_WS(PROCESS)                                            \</span>
01040 <span class="preprocessor">            ASSERT (MI_NOT_WS_OWNER(PROCESS));                      \</span>
01041 <span class="preprocessor">            ExAcquireFastMutex( &amp;((PROCESS)-&gt;WorkingSetLock));      \</span>
01042 <span class="preprocessor">            ASSERT (!MI_IS_WS_UNSAFE(PROCESS));</span>
01043 <span class="preprocessor"></span>
<a name="l01044"></a><a class="code" href="../../d4/d8/mi_8h.html#a155">01044</a> <span class="preprocessor">#define LOCK_WS_UNSAFE(PROCESS)                                     \</span>
01045 <span class="preprocessor">            ASSERT (MI_NOT_WS_OWNER(PROCESS));                      \</span>
01046 <span class="preprocessor">            ASSERT (KeGetCurrentIrql() == APC_LEVEL);               \</span>
01047 <span class="preprocessor">            ExAcquireFastMutexUnsafe( &amp;((PROCESS)-&gt;WorkingSetLock));\</span>
01048 <span class="preprocessor">            (PROCESS)-&gt;WorkingSetLock.OldIrql = MI_MUTEX_ACQUIRED_UNSAFE;</span>
01049 <span class="preprocessor"></span>
<a name="l01050"></a><a class="code" href="../../d4/d8/mi_8h.html#a156">01050</a> <span class="preprocessor">#define MI_MUST_BE_UNSAFE(PROCESS)                                  \</span>
01051 <span class="preprocessor">            ASSERT (KeGetCurrentIrql() == APC_LEVEL);               \</span>
01052 <span class="preprocessor">            ASSERT (MI_WS_OWNER(PROCESS));                          \</span>
01053 <span class="preprocessor">            ASSERT (MI_IS_WS_UNSAFE(PROCESS));</span>
01054 <span class="preprocessor"></span>
<a name="l01055"></a><a class="code" href="../../d4/d8/mi_8h.html#a157">01055</a> <span class="preprocessor">#define MI_MUST_BE_SAFE(PROCESS)                                    \</span>
01056 <span class="preprocessor">            ASSERT (MI_WS_OWNER(PROCESS));                          \</span>
01057 <span class="preprocessor">            ASSERT (!MI_IS_WS_UNSAFE(PROCESS));</span>
01058 <span class="preprocessor"></span><span class="preprocessor">#if 0</span>
01059 <span class="preprocessor"></span>
01060 <span class="preprocessor">#define MI_MUST_BE_UNSAFE(PROCESS)                                  \</span>
01061 <span class="preprocessor">            if (KeGetCurrentIrql() != APC_LEVEL) {                  \</span>
01062 <span class="preprocessor">                KeBugCheckEx(MEMORY_MANAGEMENT, 0x32, (ULONG_PTR)PROCESS, KeGetCurrentIrql(), 0); \</span>
01063 <span class="preprocessor">            }                                                       \</span>
01064 <span class="preprocessor">            if (!MI_WS_OWNER(PROCESS)) {                            \</span>
01065 <span class="preprocessor">                KeBugCheckEx(MEMORY_MANAGEMENT, 0x33, (ULONG_PTR)PROCESS, 0, 0); \</span>
01066 <span class="preprocessor">            }                                                       \</span>
01067 <span class="preprocessor">            if (!MI_IS_WS_UNSAFE(PROCESS)) {                        \</span>
01068 <span class="preprocessor">                KeBugCheckEx(MEMORY_MANAGEMENT, 0x34, (ULONG_PTR)PROCESS, 0, 0); \</span>
01069 <span class="preprocessor">            }</span>
01070 <span class="preprocessor"></span>
01071 <span class="preprocessor">#define MI_MUST_BE_SAFE(PROCESS)                                    \</span>
01072 <span class="preprocessor">            if (!MI_WS_OWNER(PROCESS)) {                            \</span>
01073 <span class="preprocessor">                KeBugCheckEx(MEMORY_MANAGEMENT, 0x42, (ULONG_PTR)PROCESS, 0, 0); \</span>
01074 <span class="preprocessor">            }                                                       \</span>
01075 <span class="preprocessor">            if (MI_IS_WS_UNSAFE(PROCESS)) {                         \</span>
01076 <span class="preprocessor">                KeBugCheckEx(MEMORY_MANAGEMENT, 0x43, (ULONG_PTR)PROCESS, 0, 0); \</span>
01077 <span class="preprocessor">            }</span>
01078 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
01079 <span class="preprocessor"></span>
01080 
<a name="l01081"></a><a class="code" href="../../d4/d8/mi_8h.html#a158">01081</a> <span class="preprocessor">#define UNLOCK_WS(PROCESS)                                          \</span>
01082 <span class="preprocessor">            MI_MUST_BE_SAFE(PROCESS);                               \</span>
01083 <span class="preprocessor">            ExReleaseFastMutex(&amp;((PROCESS)-&gt;WorkingSetLock));</span>
01084 <span class="preprocessor"></span>
<a name="l01085"></a><a class="code" href="../../d4/d8/mi_8h.html#a159">01085</a> <span class="preprocessor">#define UNLOCK_WS_UNSAFE(PROCESS)                                   \</span>
01086 <span class="preprocessor">            MI_MUST_BE_UNSAFE(PROCESS);                             \</span>
01087 <span class="preprocessor">            ExReleaseFastMutexUnsafe(&amp;((PROCESS)-&gt;WorkingSetLock)); \</span>
01088 <span class="preprocessor">            ASSERT (KeGetCurrentIrql() == APC_LEVEL);</span>
01089 <span class="preprocessor"></span>
<a name="l01090"></a><a class="code" href="../../d4/d8/mi_8h.html#a160">01090</a> <span class="preprocessor">#define LOCK_ADDRESS_SPACE(PROCESS)                                  \</span>
01091 <span class="preprocessor">            ExAcquireFastMutex( &amp;((PROCESS)-&gt;AddressCreationLock))</span>
01092 <span class="preprocessor"></span>
<a name="l01093"></a><a class="code" href="../../d4/d8/mi_8h.html#a161">01093</a> <span class="preprocessor">#define LOCK_WS_AND_ADDRESS_SPACE(PROCESS)                          \</span>
01094 <span class="preprocessor">        LOCK_ADDRESS_SPACE(PROCESS);                                \</span>
01095 <span class="preprocessor">        LOCK_WS_UNSAFE(PROCESS);</span>
01096 <span class="preprocessor"></span>
<a name="l01097"></a><a class="code" href="../../d4/d8/mi_8h.html#a162">01097</a> <span class="preprocessor">#define UNLOCK_WS_AND_ADDRESS_SPACE(PROCESS)                        \</span>
01098 <span class="preprocessor">        UNLOCK_WS_UNSAFE(PROCESS);                                  \</span>
01099 <span class="preprocessor">        UNLOCK_ADDRESS_SPACE(PROCESS);</span>
01100 <span class="preprocessor"></span>
<a name="l01101"></a><a class="code" href="../../d4/d8/mi_8h.html#a163">01101</a> <span class="preprocessor">#define UNLOCK_ADDRESS_SPACE(PROCESS)                            \</span>
01102 <span class="preprocessor">            ExReleaseFastMutex( &amp;((PROCESS)-&gt;AddressCreationLock))</span>
01103 <span class="preprocessor"></span>
01104 <span class="comment">//</span>
01105 <span class="comment">// The working set lock may have been acquired safely or unsafely.</span>
01106 <span class="comment">// Release and reacquire it regardless.</span>
01107 <span class="comment">//</span>
01108 
<a name="l01109"></a><a class="code" href="../../d4/d8/mi_8h.html#a164">01109</a> <span class="preprocessor">#define UNLOCK_WS_REGARDLESS(PROCESS, WSHELDSAFE)                   \</span>
01110 <span class="preprocessor">            ASSERT (MI_WS_OWNER (PROCESS));                         \</span>
01111 <span class="preprocessor">            if (MI_IS_WS_UNSAFE (PROCESS)) {                        \</span>
01112 <span class="preprocessor">                UNLOCK_WS_UNSAFE (PROCESS);                         \</span>
01113 <span class="preprocessor">                WSHELDSAFE = FALSE;                                 \</span>
01114 <span class="preprocessor">            }                                                       \</span>
01115 <span class="preprocessor">            else {                                                  \</span>
01116 <span class="preprocessor">                UNLOCK_WS (PROCESS);                                \</span>
01117 <span class="preprocessor">                WSHELDSAFE = TRUE;                                  \</span>
01118 <span class="preprocessor">            }</span>
01119 <span class="preprocessor"></span>
<a name="l01120"></a><a class="code" href="../../d4/d8/mi_8h.html#a165">01120</a> <span class="preprocessor">#define LOCK_WS_REGARDLESS(PROCESS, WSHELDSAFE)                     \</span>
01121 <span class="preprocessor">            if (WSHELDSAFE == TRUE) {                               \</span>
01122 <span class="preprocessor">                LOCK_WS (PROCESS);                                  \</span>
01123 <span class="preprocessor">            }                                                       \</span>
01124 <span class="preprocessor">            else {                                                  \</span>
01125 <span class="preprocessor">                LOCK_WS_UNSAFE (PROCESS);                           \</span>
01126 <span class="preprocessor">            }</span>
01127 <span class="preprocessor"></span>
<a name="l01128"></a><a class="code" href="../../d4/d8/mi_8h.html#a166">01128</a> <span class="preprocessor">#define ZERO_LARGE(LargeInteger)                \</span>
01129 <span class="preprocessor">        (LargeInteger).LowPart = 0;             \</span>
01130 <span class="preprocessor">        (LargeInteger).HighPart = 0;</span>
01131 <span class="preprocessor"></span>
01132 <span class="comment">//++</span>
01133 <span class="comment">//</span>
01134 <span class="comment">// ULONG</span>
01135 <span class="comment">// MI_CHECK_BIT (</span>
01136 <span class="comment">//     IN PULONG ARRAY</span>
01137 <span class="comment">//     IN ULONG BIT</span>
01138 <span class="comment">//     )</span>
01139 <span class="comment">//</span>
01140 <span class="comment">// Routine Description:</span>
01141 <span class="comment">//</span>
01142 <span class="comment">//     The MI_CHECK_BIT macro checks to see if the specified bit is</span>
01143 <span class="comment">//     set within the specified array.</span>
01144 <span class="comment">//</span>
01145 <span class="comment">// Arguments:</span>
01146 <span class="comment">//</span>
01147 <span class="comment">//     ARRAY - First element of the array to check.</span>
01148 <span class="comment">//</span>
01149 <span class="comment">//     BIT - bit number (first bit is 0) to check.</span>
01150 <span class="comment">//</span>
01151 <span class="comment">// Return Value:</span>
01152 <span class="comment">//</span>
01153 <span class="comment">//     Returns the value of the bit (0 or 1).</span>
01154 <span class="comment">//</span>
01155 <span class="comment">//--</span>
01156 
<a name="l01157"></a><a class="code" href="../../d4/d8/mi_8h.html#a167">01157</a> <span class="preprocessor">#define MI_CHECK_BIT(ARRAY,BIT)  \</span>
01158 <span class="preprocessor">        (((ULONG)ARRAY[(BIT) / (sizeof(ULONG)*8)] &gt;&gt; ((BIT) &amp; 0x1F)) &amp; 1)</span>
01159 <span class="preprocessor"></span>
01160 
01161 <span class="comment">//++</span>
01162 <span class="comment">//</span>
01163 <span class="comment">// VOID</span>
01164 <span class="comment">// MI_SET_BIT (</span>
01165 <span class="comment">//     IN PULONG ARRAY</span>
01166 <span class="comment">//     IN ULONG BIT</span>
01167 <span class="comment">//     )</span>
01168 <span class="comment">//</span>
01169 <span class="comment">// Routine Description:</span>
01170 <span class="comment">//</span>
01171 <span class="comment">//     The MI_SET_BIT macro sets the specified bit within the</span>
01172 <span class="comment">//     specified array.</span>
01173 <span class="comment">//</span>
01174 <span class="comment">// Arguments:</span>
01175 <span class="comment">//</span>
01176 <span class="comment">//     ARRAY - First element of the array to set.</span>
01177 <span class="comment">//</span>
01178 <span class="comment">//     BIT - bit number.</span>
01179 <span class="comment">//</span>
01180 <span class="comment">// Return Value:</span>
01181 <span class="comment">//</span>
01182 <span class="comment">//     None.</span>
01183 <span class="comment">//</span>
01184 <span class="comment">//--</span>
01185 
<a name="l01186"></a><a class="code" href="../../d4/d8/mi_8h.html#a168">01186</a> <span class="preprocessor">#define MI_SET_BIT(ARRAY,BIT)  \</span>
01187 <span class="preprocessor">        (ULONG)ARRAY[(BIT) / (sizeof(ULONG)*8)] |= (1 &lt;&lt; ((BIT) &amp; 0x1F))</span>
01188 <span class="preprocessor"></span>
01189 
01190 <span class="comment">//++</span>
01191 <span class="comment">//</span>
01192 <span class="comment">// VOID</span>
01193 <span class="comment">// MI_CLEAR_BIT (</span>
01194 <span class="comment">//     IN PULONG ARRAY</span>
01195 <span class="comment">//     IN ULONG BIT</span>
01196 <span class="comment">//     )</span>
01197 <span class="comment">//</span>
01198 <span class="comment">// Routine Description:</span>
01199 <span class="comment">//</span>
01200 <span class="comment">//     The MI_CLEAR_BIT macro sets the specified bit within the</span>
01201 <span class="comment">//     specified array.</span>
01202 <span class="comment">//</span>
01203 <span class="comment">// Arguments:</span>
01204 <span class="comment">//</span>
01205 <span class="comment">//     ARRAY - First element of the array to clear.</span>
01206 <span class="comment">//</span>
01207 <span class="comment">//     BIT - bit number.</span>
01208 <span class="comment">//</span>
01209 <span class="comment">// Return Value:</span>
01210 <span class="comment">//</span>
01211 <span class="comment">//     None.</span>
01212 <span class="comment">//</span>
01213 <span class="comment">//--</span>
01214 
<a name="l01215"></a><a class="code" href="../../d4/d8/mi_8h.html#a169">01215</a> <span class="preprocessor">#define MI_CLEAR_BIT(ARRAY,BIT)  \</span>
01216 <span class="preprocessor">        (ULONG)ARRAY[(BIT) / (sizeof(ULONG)*8)] &amp;= ~(1 &lt;&lt; ((BIT) &amp; 0x1F))</span>
01217 <span class="preprocessor"></span>
01218 
<a name="l01219"></a><a class="code" href="../../d4/d8/mi_8h.html#a170">01219</a> <span class="preprocessor">#define MI_MAGIC_AWE_PTEFRAME   0xffffedcb</span>
01220 <span class="preprocessor"></span>
<a name="l01221"></a><a class="code" href="../../d4/d8/mi_8h.html#a171">01221</a> <span class="preprocessor">#define MI_PFN_IS_AWE(Pfn1)                                     \</span>
01222 <span class="preprocessor">        ((Pfn1-&gt;u2.ShareCount &lt;= 3) &amp;&amp;                          \</span>
01223 <span class="preprocessor">         (Pfn1-&gt;u3.e1.PageLocation == ActiveAndValid) &amp;&amp;        \</span>
01224 <span class="preprocessor">         (Pfn1-&gt;u3.e1.VerifierAllocation == 0) &amp;&amp;               \</span>
01225 <span class="preprocessor">         (Pfn1-&gt;u3.e1.LargeSessionAllocation == 0) &amp;&amp;           \</span>
01226 <span class="preprocessor">         (Pfn1-&gt;u3.e1.StartOfAllocation == 1) &amp;&amp;                \</span>
01227 <span class="preprocessor">         (Pfn1-&gt;u3.e1.EndOfAllocation == 1) &amp;&amp;                  \</span>
01228 <span class="preprocessor">         (Pfn1-&gt;PteFrame == MI_MAGIC_AWE_PTEFRAME))</span>
01229 <span class="preprocessor"></span>
01230 
<a name="l01231"></a><a class="code" href="../../d4/d8/mi_8h.html#a435">01231</a> <span class="keyword">typedef</span> ULONG <a class="code" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a>, *<a class="code" href="../../d4/d8/mi_8h.html#a436">PWSLE_NUMBER</a>;
01232 
01233 <span class="comment">//</span>
01234 <span class="comment">// PFN database element.</span>
01235 <span class="comment">//</span>
01236 
01237 <span class="comment">//</span>
01238 <span class="comment">// Define pseudo fields for start and end of allocation.</span>
01239 <span class="comment">//</span>
01240 
<a name="l01241"></a><a class="code" href="../../d4/d8/mi_8h.html#a172">01241</a> <span class="preprocessor">#define StartOfAllocation ReadInProgress</span>
01242 <span class="preprocessor"></span>
<a name="l01243"></a><a class="code" href="../../d4/d8/mi_8h.html#a173">01243</a> <span class="preprocessor">#define EndOfAllocation WriteInProgress</span>
01244 <span class="preprocessor"></span>
<a name="l01245"></a><a class="code" href="../../d4/d8/mi_8h.html#a174">01245</a> <span class="preprocessor">#define LargeSessionAllocation PrototypePte</span>
01246 <span class="preprocessor"></span>
01247 <span class="comment">//</span>
01248 <span class="comment">// The PteFrame field size determines the largest physical page that</span>
01249 <span class="comment">// can be supported on the system.  On a 4k page sized machine, 20 bits</span>
01250 <span class="comment">// limits it to 4GBs.</span>
01251 <span class="comment">//</span>
01252 
<a name="l01253"></a><a class="code" href="../../d9/d3/struct__MMPFNENTRY.html">01253</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d9/d3/struct__MMPFNENTRY.html">_MMPFNENTRY</a> {
<a name="l01254"></a><a class="code" href="../../d9/d3/struct__MMPFNENTRY.html#o0">01254</a>     ULONG <a class="code" href="../../d9/d3/struct__MMPFNENTRY.html#o0">Modified</a> : 1;
<a name="l01255"></a><a class="code" href="../../d9/d3/struct__MMPFNENTRY.html#o1">01255</a>     ULONG <a class="code" href="../../d9/d3/struct__MMPFNENTRY.html#o1">ReadInProgress</a> : 1;
<a name="l01256"></a><a class="code" href="../../d9/d3/struct__MMPFNENTRY.html#o2">01256</a>     ULONG <a class="code" href="../../d9/d3/struct__MMPFNENTRY.html#o2">WriteInProgress</a> : 1;
<a name="l01257"></a><a class="code" href="../../d9/d3/struct__MMPFNENTRY.html#o3">01257</a>     ULONG <a class="code" href="../../d9/d3/struct__MMPFNENTRY.html#o3">PrototypePte</a>: 1;
<a name="l01258"></a><a class="code" href="../../d9/d3/struct__MMPFNENTRY.html#o4">01258</a>     ULONG <a class="code" href="../../d9/d3/struct__MMPFNENTRY.html#o4">PageColor</a> : 3;
<a name="l01259"></a><a class="code" href="../../d9/d3/struct__MMPFNENTRY.html#o5">01259</a>     ULONG <a class="code" href="../../d9/d3/struct__MMPFNENTRY.html#o5">ParityError</a> : 1;
<a name="l01260"></a><a class="code" href="../../d9/d3/struct__MMPFNENTRY.html#o6">01260</a>     ULONG <a class="code" href="../../d9/d3/struct__MMPFNENTRY.html#o6">PageLocation</a> : 3;
<a name="l01261"></a><a class="code" href="../../d9/d3/struct__MMPFNENTRY.html#o7">01261</a>     ULONG <a class="code" href="../../d9/d3/struct__MMPFNENTRY.html#o7">InPageError</a> : 1;
<a name="l01262"></a><a class="code" href="../../d9/d3/struct__MMPFNENTRY.html#o8">01262</a>     ULONG <a class="code" href="../../d9/d3/struct__MMPFNENTRY.html#o8">VerifierAllocation</a> : 1;
<a name="l01263"></a><a class="code" href="../../d9/d3/struct__MMPFNENTRY.html#o9">01263</a>     ULONG <a class="code" href="../../d9/d3/struct__MMPFNENTRY.html#o9">RemovalRequested</a> : 1;
<a name="l01264"></a><a class="code" href="../../d9/d3/struct__MMPFNENTRY.html#o10">01264</a>     ULONG <a class="code" href="../../d9/d3/struct__MMPFNENTRY.html#o10">Reserved</a> : 1;
<a name="l01265"></a><a class="code" href="../../d9/d3/struct__MMPFNENTRY.html#o11">01265</a>     ULONG <a class="code" href="../../d9/d3/struct__MMPFNENTRY.html#o11">LockCharged</a> : 1;
<a name="l01266"></a><a class="code" href="../../d9/d3/struct__MMPFNENTRY.html#o12">01266</a>     ULONG <a class="code" href="../../d9/d3/struct__MMPFNENTRY.html#o12">DontUse</a> : 16; <span class="comment">//overlays USHORT for reference count field.</span>
01267 } <a class="code" href="../../d9/d3/struct__MMPFNENTRY.html">MMPFNENTRY</a>;
01268 
01269 <span class="preprocessor">#if defined (_X86PAE_)</span>
01270 <span class="preprocessor"></span><span class="preprocessor">#pragma pack(1)</span>
01271 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
01272 <span class="preprocessor"></span>
<a name="l01273"></a><a class="code" href="../../d4/d3/struct__MMPFN.html">01273</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d4/d3/struct__MMPFN.html">_MMPFN</a> {
01274     <span class="keyword">union </span>{
<a name="l01275"></a><a class="code" href="../../d4/d3/struct__MMPFN.html#o0">01275</a>         PFN_NUMBER <a class="code" href="../../d4/d3/struct__MMPFN.html#o0">Flink</a>;
<a name="l01276"></a><a class="code" href="../../d4/d3/struct__MMPFN.html#o1">01276</a>         <a class="code" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a> <a class="code" href="../../d4/d3/struct__MMPFN.html#o1">WsIndex</a>;
<a name="l01277"></a><a class="code" href="../../d4/d3/struct__MMPFN.html#o2">01277</a>         <a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a> <a class="code" href="../../d4/d3/struct__MMPFN.html#o2">Event</a>;
<a name="l01278"></a><a class="code" href="../../d4/d3/struct__MMPFN.html#o3">01278</a>         <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d4/d3/struct__MMPFN.html#o3">ReadStatus</a>;
<a name="l01279"></a><a class="code" href="../../d4/d3/struct__MMPFN.html#o4">01279</a>         <span class="keyword">struct </span><a class="code" href="../../d4/d3/struct__MMPFN.html">_MMPFN</a> *<a class="code" href="../../d4/d3/struct__MMPFN.html#o4">NextStackPfn</a>;
01280     } u1;
<a name="l01281"></a><a class="code" href="../../d4/d3/struct__MMPFN.html#o6">01281</a>     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> <a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a>;
01282     <span class="keyword">union </span>{
<a name="l01283"></a><a class="code" href="../../d4/d3/struct__MMPFN.html#o7">01283</a>         PFN_NUMBER Blink;
<a name="l01284"></a><a class="code" href="../../d4/d3/struct__MMPFN.html#o8">01284</a>         ULONG ShareCount;
<a name="l01285"></a><a class="code" href="../../d4/d3/struct__MMPFN.html#o9">01285</a>         ULONG SecondaryColorFlink;
01286     } u2;
01287     <span class="keyword">union </span>{
<a name="l01288"></a><a class="code" href="../../d4/d3/struct__MMPFN.html#o11">01288</a>         <a class="code" href="../../d9/d3/struct__MMPFNENTRY.html">MMPFNENTRY</a> <a class="code" href="../../d4/d3/struct__MMPFN.html#o11">e1</a>;
01289         <span class="keyword">struct </span>{
<a name="l01290"></a><a class="code" href="../../d4/d3/struct__MMPFN.html#o12">01290</a>             <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> <a class="code" href="../../d4/d3/struct__MMPFN.html#o12">ShortFlags</a>;
<a name="l01291"></a><a class="code" href="../../d4/d3/struct__MMPFN.html#o13">01291</a>             <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> <a class="code" href="../../d4/d3/struct__MMPFN.html#o13">ReferenceCount</a>;
01292         } e2;
01293     } <a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>;
01294 <span class="preprocessor">#if defined (_WIN64)</span>
01295 <span class="preprocessor"></span>    ULONG UsedPageTableEntries;
01296 <span class="preprocessor">#endif</span>
<a name="l01297"></a><a class="code" href="../../d4/d3/struct__MMPFN.html#o16">01297</a> <span class="preprocessor"></span>    <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> <a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>;
<a name="l01298"></a><a class="code" href="../../d4/d3/struct__MMPFN.html#o17">01298</a>     PFN_NUMBER <a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a>;
01299 } <a class="code" href="../../d4/d3/struct__MMPFN.html">MMPFN</a>, *<a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a>;
01300 
01301 <span class="preprocessor">#if defined (_X86PAE_)</span>
01302 <span class="preprocessor"></span><span class="preprocessor">#pragma pack()</span>
01303 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
01304 <span class="preprocessor"></span>
01305 <span class="preprocessor">#if defined (_WIN64)</span>
01306 <span class="preprocessor"></span>
01307 <span class="comment">//</span>
01308 <span class="comment">// Note there are some places where these portable macros are not currently</span>
01309 <span class="comment">// used because we are not in the correct address space required.</span>
01310 <span class="comment">//</span>
01311 
01312 <span class="preprocessor">#define MI_CAPTURE_USED_PAGETABLE_ENTRIES(PFN) \</span>
01313 <span class="preprocessor">        ASSERT ((PFN)-&gt;UsedPageTableEntries &lt;= PTE_PER_PAGE); \</span>
01314 <span class="preprocessor">        (PFN)-&gt;OriginalPte.u.Soft.UsedPageTableEntries = (PFN)-&gt;UsedPageTableEntries;</span>
01315 <span class="preprocessor"></span>
01316 <span class="preprocessor">#define MI_RETRIEVE_USED_PAGETABLE_ENTRIES_FROM_PTE(RBL, PTE) \</span>
01317 <span class="preprocessor">        ASSERT ((PTE)-&gt;u.Soft.UsedPageTableEntries &lt;= PTE_PER_PAGE); \</span>
01318 <span class="preprocessor">        (RBL)-&gt;UsedPageTableEntries = (ULONG)(((PMMPTE)(PTE))-&gt;u.Soft.UsedPageTableEntries);</span>
01319 <span class="preprocessor"></span>
01320 <span class="preprocessor">#define MI_ZERO_USED_PAGETABLE_ENTRIES_IN_INPAGE_SUPPORT(INPAGE_SUPPORT) \</span>
01321 <span class="preprocessor">            (INPAGE_SUPPORT)-&gt;UsedPageTableEntries = 0;</span>
01322 <span class="preprocessor"></span>
01323 <span class="preprocessor">#define MI_ZERO_USED_PAGETABLE_ENTRIES_IN_PFN(PFN) (PFN)-&gt;UsedPageTableEntries = 0;</span>
01324 <span class="preprocessor"></span>
01325 <span class="preprocessor">#define MI_INSERT_USED_PAGETABLE_ENTRIES_IN_PFN(PFN, INPAGE_SUPPORT) \</span>
01326 <span class="preprocessor">        ASSERT ((INPAGE_SUPPORT)-&gt;UsedPageTableEntries &lt;= PTE_PER_PAGE); \</span>
01327 <span class="preprocessor">        (PFN)-&gt;UsedPageTableEntries = (INPAGE_SUPPORT)-&gt;UsedPageTableEntries;</span>
01328 <span class="preprocessor"></span>
01329 <span class="preprocessor">#define MI_ZERO_USED_PAGETABLE_ENTRIES(PFN) \</span>
01330 <span class="preprocessor">        (PFN)-&gt;UsedPageTableEntries = 0;</span>
01331 <span class="preprocessor"></span>
01332 <span class="preprocessor">#define MI_GET_USED_PTES_HANDLE(VA) \</span>
01333 <span class="preprocessor">        ((PVOID)MI_PFN_ELEMENT((PFN_NUMBER)MiGetPdeAddress(VA)-&gt;u.Hard.PageFrameNumber))</span>
01334 <span class="preprocessor"></span>
01335 <span class="preprocessor">#define MI_GET_USED_PTES_FROM_HANDLE(PFN) \</span>
01336 <span class="preprocessor">        ((ULONG)(((PMMPFN)(PFN))-&gt;UsedPageTableEntries))</span>
01337 <span class="preprocessor"></span>
01338 <span class="preprocessor">#define MI_INCREMENT_USED_PTES_BY_HANDLE(PFN) \</span>
01339 <span class="preprocessor">        (((PMMPFN)(PFN))-&gt;UsedPageTableEntries += 1); \</span>
01340 <span class="preprocessor">        ASSERT (((PMMPFN)(PFN))-&gt;UsedPageTableEntries &lt;= PTE_PER_PAGE)</span>
01341 <span class="preprocessor"></span>
01342 <span class="preprocessor">#define MI_DECREMENT_USED_PTES_BY_HANDLE(PFN) \</span>
01343 <span class="preprocessor">        (((PMMPFN)(PFN))-&gt;UsedPageTableEntries -= 1); \</span>
01344 <span class="preprocessor">        ASSERT (((PMMPFN)(PFN))-&gt;UsedPageTableEntries &lt; PTE_PER_PAGE)</span>
01345 <span class="preprocessor"></span>
01346 <span class="preprocessor">#else</span>
01347 <span class="preprocessor"></span>
<a name="l01348"></a><a class="code" href="../../d4/d8/mi_8h.html#a175">01348</a> <span class="preprocessor">#define MI_CAPTURE_USED_PAGETABLE_ENTRIES(PFN)</span>
<a name="l01349"></a><a class="code" href="../../d4/d8/mi_8h.html#a176">01349</a> <span class="preprocessor"></span><span class="preprocessor">#define MI_RETRIEVE_USED_PAGETABLE_ENTRIES_FROM_PTE(RBL, PTE)</span>
<a name="l01350"></a><a class="code" href="../../d4/d8/mi_8h.html#a177">01350</a> <span class="preprocessor"></span><span class="preprocessor">#define MI_ZERO_USED_PAGETABLE_ENTRIES_IN_INPAGE_SUPPORT(INPAGE_SUPPORT)</span>
<a name="l01351"></a><a class="code" href="../../d4/d8/mi_8h.html#a178">01351</a> <span class="preprocessor"></span><span class="preprocessor">#define MI_ZERO_USED_PAGETABLE_ENTRIES_IN_PFN(PFN)</span>
01352 <span class="preprocessor"></span>
<a name="l01353"></a><a class="code" href="../../d4/d8/mi_8h.html#a179">01353</a> <span class="preprocessor">#define MI_INSERT_USED_PAGETABLE_ENTRIES_IN_PFN(PFN, INPAGE_SUPPORT)</span>
01354 <span class="preprocessor"></span>
<a name="l01355"></a><a class="code" href="../../d4/d8/mi_8h.html#a180">01355</a> <span class="preprocessor">#define MI_GET_USED_PTES_HANDLE(VA) ((PVOID)&amp;MmWorkingSetList-&gt;UsedPageTableEntries[MiGetPpePdeOffset(VA)])</span>
01356 <span class="preprocessor"></span>
<a name="l01357"></a><a class="code" href="../../d4/d8/mi_8h.html#a181">01357</a> <span class="preprocessor">#define MI_GET_USED_PTES_FROM_HANDLE(PDSHORT) ((ULONG)(*(PUSHORT)(PDSHORT)))</span>
01358 <span class="preprocessor"></span>
<a name="l01359"></a><a class="code" href="../../d4/d8/mi_8h.html#a182">01359</a> <span class="preprocessor">#define MI_INCREMENT_USED_PTES_BY_HANDLE(PDSHORT) ((*(PUSHORT)(PDSHORT)) += 1); \</span>
01360 <span class="preprocessor">    ASSERT (((*(PUSHORT)(PDSHORT)) &lt;= PTE_PER_PAGE))</span>
01361 <span class="preprocessor"></span>
<a name="l01362"></a><a class="code" href="../../d4/d8/mi_8h.html#a183">01362</a> <span class="preprocessor">#define MI_DECREMENT_USED_PTES_BY_HANDLE(PDSHORT) ((*(PUSHORT)(PDSHORT)) -= 1); \</span>
01363 <span class="preprocessor">    ASSERT (((*(PUSHORT)(PDSHORT)) &lt; PTE_PER_PAGE))</span>
01364 <span class="preprocessor"></span>
01365 <span class="preprocessor">#endif</span>
01366 <span class="preprocessor"></span>
<a name="l01367"></a><a class="code" href="../../d4/d8/mi_8h.html#a440">01367</a> <span class="keyword">extern</span> LOGICAL <a class="code" href="../../d8/d0/cmdat3_8c.html#a29">MmDynamicPfn</a>;
01368 
<a name="l01369"></a><a class="code" href="../../d4/d8/mi_8h.html#a441">01369</a> <span class="keyword">extern</span> <a class="code" href="../../d6/d9/struct__FAST__MUTEX.html">FAST_MUTEX</a> <a class="code" href="../../d9/d3/dynmem_8c.html#a1">MmDynamicMemoryMutex</a>;
01370 
<a name="l01371"></a><a class="code" href="../../d4/d8/mi_8h.html#a442">01371</a> <span class="keyword">extern</span> PFN_NUMBER <a class="code" href="../../d5/d6/iosup_8c.html#a2">MmSystemLockPagesCount</a>;
01372 
01373 <span class="preprocessor">#if DBG</span>
01374 <span class="preprocessor"></span>
01375 <span class="preprocessor">#define MI_LOCK_ID_COUNTER_MAX 64</span>
01376 <span class="preprocessor"></span>ULONG MiLockIds[MI_LOCK_ID_COUNTER_MAX];
01377 
01378 <span class="preprocessor">#define MI_MARK_PFN_AS_LOCK_CHARGED(Pfn, CallerId)      \</span>
01379 <span class="preprocessor">         ASSERT (Pfn-&gt;u3.e1.LockCharged == 0);          \</span>
01380 <span class="preprocessor">         ASSERT (CallerId &lt; MI_LOCK_ID_COUNTER_MAX);    \</span>
01381 <span class="preprocessor">         MiLockIds[CallerId] += 1;                      \</span>
01382 <span class="preprocessor">         Pfn-&gt;u3.e1.LockCharged = 1;</span>
01383 <span class="preprocessor"></span>
01384 <span class="preprocessor">#define MI_UNMARK_PFN_AS_LOCK_CHARGED(Pfn, CallerId)    \</span>
01385 <span class="preprocessor">         ASSERT (Pfn-&gt;u3.e1.LockCharged == 1);          \</span>
01386 <span class="preprocessor">         ASSERT (CallerId &lt; MI_LOCK_ID_COUNTER_MAX);    \</span>
01387 <span class="preprocessor">         MiLockIds[CallerId] += 1;                      \</span>
01388 <span class="preprocessor">         Pfn-&gt;u3.e1.LockCharged = 0;</span>
01389 <span class="preprocessor"></span>
01390 <span class="preprocessor">#else</span>
<a name="l01391"></a><a class="code" href="../../d4/d8/mi_8h.html#a184">01391</a> <span class="preprocessor"></span><span class="preprocessor">#define MI_MARK_PFN_AS_LOCK_CHARGED(Pfn, CallerId)</span>
<a name="l01392"></a><a class="code" href="../../d4/d8/mi_8h.html#a185">01392</a> <span class="preprocessor"></span><span class="preprocessor">#define MI_UNMARK_PFN_AS_LOCK_CHARGED(Pfn, CallerId)</span>
01393 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
01394 <span class="preprocessor"></span>
01395 <span class="comment">//++</span>
01396 <span class="comment">//</span>
01397 <span class="comment">// VOID</span>
01398 <span class="comment">// MI_ADD_LOCKED_PAGE_CHARGE (</span>
01399 <span class="comment">//     IN PMMPFN Pfn</span>
01400 <span class="comment">//     )</span>
01401 <span class="comment">//</span>
01402 <span class="comment">// Routine Description:</span>
01403 <span class="comment">//</span>
01404 <span class="comment">//     Charge the systemwide count of locked pages if this is the initial</span>
01405 <span class="comment">//     lock for this page (multiple concurrent locks are only charged once).</span>
01406 <span class="comment">//</span>
01407 <span class="comment">// Arguments:</span>
01408 <span class="comment">//</span>
01409 <span class="comment">//     Pfn - the PFN index to operate on.</span>
01410 <span class="comment">//</span>
01411 <span class="comment">// Return Value:</span>
01412 <span class="comment">//</span>
01413 <span class="comment">//     None.</span>
01414 <span class="comment">//</span>
01415 <span class="comment">//--</span>
01416 <span class="comment">//</span>
<a name="l01417"></a><a class="code" href="../../d4/d8/mi_8h.html#a186">01417</a> <span class="preprocessor">#define MI_ADD_LOCKED_PAGE_CHARGE(Pfn, CallerId)                \</span>
01418 <span class="preprocessor">    ASSERT (Pfn-&gt;u3.e2.ReferenceCount != 0);                    \</span>
01419 <span class="preprocessor">    if (Pfn-&gt;u3.e2.ReferenceCount == 1) {                       \</span>
01420 <span class="preprocessor">        if (Pfn-&gt;u2.ShareCount != 0) {                          \</span>
01421 <span class="preprocessor">            ASSERT (Pfn-&gt;u3.e1.PageLocation == ActiveAndValid); \</span>
01422 <span class="preprocessor">            MI_MARK_PFN_AS_LOCK_CHARGED(Pfn, CallerId);         \</span>
01423 <span class="preprocessor">            MmSystemLockPagesCount += 1;                        \</span>
01424 <span class="preprocessor">        }                                                       \</span>
01425 <span class="preprocessor">        else {                                                  \</span>
01426 <span class="preprocessor">            ASSERT (Pfn-&gt;u3.e1.LockCharged == 1);               \</span>
01427 <span class="preprocessor">        }                                                       \</span>
01428 <span class="preprocessor">    }</span>
01429 <span class="preprocessor"></span>
<a name="l01430"></a><a class="code" href="../../d4/d8/mi_8h.html#a187">01430</a> <span class="preprocessor">#define MI_ADD_LOCKED_PAGE_CHARGE_FOR_MODIFIED_PAGE(Pfn, CallerId) \</span>
01431 <span class="preprocessor">    ASSERT (Pfn-&gt;u3.e1.PageLocation != ActiveAndValid);    \</span>
01432 <span class="preprocessor">    ASSERT (Pfn-&gt;u2.ShareCount == 0);                      \</span>
01433 <span class="preprocessor">    if (Pfn-&gt;u3.e2.ReferenceCount == 0) {                  \</span>
01434 <span class="preprocessor">        MI_MARK_PFN_AS_LOCK_CHARGED(Pfn, CallerId);        \</span>
01435 <span class="preprocessor">        MmSystemLockPagesCount += 1;                       \</span>
01436 <span class="preprocessor">    }</span>
01437 <span class="preprocessor"></span>
<a name="l01438"></a><a class="code" href="../../d4/d8/mi_8h.html#a188">01438</a> <span class="preprocessor">#define MI_ADD_LOCKED_PAGE_CHARGE_FOR_TRANSITION_PAGE(Pfn, CallerId) \</span>
01439 <span class="preprocessor">    ASSERT (Pfn-&gt;u3.e1.PageLocation == ActiveAndValid);    \</span>
01440 <span class="preprocessor">    ASSERT (Pfn-&gt;u2.ShareCount == 0);                      \</span>
01441 <span class="preprocessor">    ASSERT (Pfn-&gt;u3.e2.ReferenceCount != 0);               \</span>
01442 <span class="preprocessor">    if (Pfn-&gt;u3.e2.ReferenceCount == 1) {                  \</span>
01443 <span class="preprocessor">        MI_MARK_PFN_AS_LOCK_CHARGED(Pfn, CallerId);        \</span>
01444 <span class="preprocessor">        MmSystemLockPagesCount += 1;                       \</span>
01445 <span class="preprocessor">    }</span>
01446 <span class="preprocessor"></span>
01447 <span class="comment">//++</span>
01448 <span class="comment">//</span>
01449 <span class="comment">// VOID</span>
01450 <span class="comment">// MI_REMOVE_LOCKED_PAGE_CHARGE (</span>
01451 <span class="comment">//     IN PMMPFN Pfn</span>
01452 <span class="comment">//     )</span>
01453 <span class="comment">//</span>
01454 <span class="comment">// Routine Description:</span>
01455 <span class="comment">//</span>
01456 <span class="comment">//     Remove the charge from the systemwide count of locked pages if this</span>
01457 <span class="comment">//     is the last lock for this page (multiple concurrent locks are only</span>
01458 <span class="comment">//     charged once).</span>
01459 <span class="comment">//</span>
01460 <span class="comment">// Arguments:</span>
01461 <span class="comment">//</span>
01462 <span class="comment">//     Pfn - the PFN index to operate on.</span>
01463 <span class="comment">//</span>
01464 <span class="comment">// Return Value:</span>
01465 <span class="comment">//</span>
01466 <span class="comment">//     None.</span>
01467 <span class="comment">//</span>
01468 <span class="comment">//--</span>
01469 <span class="comment">//</span>
<a name="l01470"></a><a class="code" href="../../d4/d8/mi_8h.html#a189">01470</a> <span class="preprocessor">#define MI_REMOVE_LOCKED_PAGE_CHARGE(Pfn, CallerId)                         \</span>
01471 <span class="preprocessor">        ASSERT (Pfn-&gt;u3.e2.ReferenceCount != 0);                            \</span>
01472 <span class="preprocessor">        if (Pfn-&gt;u3.e2.ReferenceCount == 2) {                               \</span>
01473 <span class="preprocessor">            if (Pfn-&gt;u2.ShareCount &gt;= 1) {                                  \</span>
01474 <span class="preprocessor">                ASSERT (Pfn-&gt;u3.e1.PageLocation == ActiveAndValid);         \</span>
01475 <span class="preprocessor">                MI_UNMARK_PFN_AS_LOCK_CHARGED(Pfn, CallerId);               \</span>
01476 <span class="preprocessor">                MmSystemLockPagesCount -= 1;                                \</span>
01477 <span class="preprocessor">            }                                                               \</span>
01478 <span class="preprocessor">            else {                                                          \</span>
01479 <span class="preprocessor">                </span><span class="comment">/*                                                          \</span>
01480 <span class="comment">                 * There are multiple referencers to this page and the      \</span>
01481 <span class="comment">                 * page is no longer valid in any process address space.    \</span>
01482 <span class="comment">                 * The systemwide lock count can only be decremented        \</span>
01483 <span class="comment">                 * by the last dereference.                                 \</span>
01484 <span class="comment">                 */</span>                                                         \
01485                 NOTHING;                                                    \
01486             }                                                               \
01487         }                                                                   \
01488         else if (Pfn-&gt;u3.e2.ReferenceCount == 1) {                          \
01489             <span class="comment">/*                                                              \</span>
01490 <span class="comment">             * This page has already been deleted from all process address  \</span>
01491 <span class="comment">             * spaces.  It is sitting in limbo (not on any list) awaiting   \</span>
01492 <span class="comment">             * this last dereference.                                       \</span>
01493 <span class="comment">             */</span>                                                             \
01494             ASSERT (Pfn-&gt;u3.e1.PageLocation != ActiveAndValid);             \
01495             ASSERT (Pfn-&gt;u2.ShareCount == 0);                               \
01496             MI_UNMARK_PFN_AS_LOCK_CHARGED(Pfn, CallerId);                   \
01497             MmSystemLockPagesCount -= 1;                                    \
01498         }                                                                   \
01499         else {                                                              \
01500             <span class="comment">/*                                                              \</span>
01501 <span class="comment">             * There are still multiple referencers to this page (it may    \</span>
01502 <span class="comment">             * or may not be resident in any process address space).        \</span>
01503 <span class="comment">             * Since the systemwide lock count can only be decremented      \</span>
01504 <span class="comment">             * by the last dereference (and this is not it), no action      \</span>
01505 <span class="comment">             * is taken here.                                               \</span>
01506 <span class="comment">             */</span>                                                             \
01507             NOTHING;                                                        \
01508         }
01509 
01510 
01511 <span class="comment">//++</span>
01512 <span class="comment">//</span>
01513 <span class="comment">// VOID</span>
01514 <span class="comment">// MI_ZERO_WSINDEX (</span>
01515 <span class="comment">//     IN PMMPFN Pfn</span>
01516 <span class="comment">//     )</span>
01517 <span class="comment">//</span>
01518 <span class="comment">// Routine Description:</span>
01519 <span class="comment">//</span>
01520 <span class="comment">//     Zero the Working Set Index field of the argument PFN entry.</span>
<a name="l01521"></a><a class="code" href="../../d4/d8/mi_8h.html#a190">01521</a> <span class="comment">//     There is a subtlety here on systems where the WsIndex ULONG is</span>
01522 <span class="comment">//     overlaid with an Event pointer and sizeof(ULONG) != sizeof(PKEVENT).</span>
01523 <span class="comment">//     Note this will need to be updated if we ever decide to allocate bodies of</span>
<a name="l01524"></a><a class="code" href="../../d4/d8/mi_8h.html#a1001">01524</a> <span class="comment">//     thread objects on 4GB boundaries.</span>
01525 <span class="comment">//</span>
01526 <span class="comment">// Arguments:</span>
01527 <span class="comment">//</span>
01528 <span class="comment">//     Pfn - the PFN index to operate on.</span>
01529 <span class="comment">//</span>
<a name="l01530"></a><a class="code" href="../../d3/d8/struct__MMWSLE__HASH.html">01530</a> <span class="comment">// Return Value:</span>
<a name="l01531"></a><a class="code" href="../../d3/d8/struct__MMWSLE__HASH.html#o0">01531</a> <span class="comment">//</span>
<a name="l01532"></a><a class="code" href="../../d3/d8/struct__MMWSLE__HASH.html#o1">01532</a> <span class="comment">//     None.</span>
01533 <span class="comment">//</span>
01534 <span class="comment">//--</span>
01535 <span class="comment">//</span>
01536 <span class="preprocessor">#define MI_ZERO_WSINDEX(Pfn) \</span>
01537 <span class="preprocessor">    Pfn-&gt;u1.Event = NULL;</span>
01538 <span class="preprocessor"></span>
01539 <span class="keyword">typedef</span> <span class="keyword">enum</span> <a class="code" href="../../d4/d8/mi_8h.html#a1001">_MMSHARE_TYPE</a> {
01540     <a class="code" href="../../d4/d8/mi_8h.html#a1001a762">Normal</a>,
01541     <a class="code" href="../../d4/d8/mi_8h.html#a1001a763">ShareCountOnly</a>,
01542     <a class="code" href="../../d4/d8/mi_8h.html#a1001a764">AndValid</a>
01543 } <a class="code" href="../../d4/d8/mi_8h.html#a443">MMSHARE_TYPE</a>;
01544 
01545 <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d3/d8/struct__MMWSLE__HASH.html">_MMWSLE_HASH</a> {
01546     ULONG_PTR Key;
01547     <a class="code" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a> Index;
01548 } <a class="code" href="../../d3/d8/struct__MMWSLE__HASH.html">MMWSLE_HASH</a>, *<a class="code" href="../../d3/d8/struct__MMWSLE__HASH.html">PMMWSLE_HASH</a>;
01549 
01550 <span class="comment">//++</span>
01551 <span class="comment">//</span>
01552 <span class="comment">// WSLE_NUMBER</span>
01553 <span class="comment">// MI_WSLE_HASH (</span>
01554 <span class="comment">//     IN ULONG_PTR VirtualAddress,</span>
01555 <span class="comment">//     IN PMMWSL WorkingSetList</span>
01556 <span class="comment">//     )</span>
01557 <span class="comment">//</span>
01558 <span class="comment">// Routine Description:</span>
<a name="l01559"></a><a class="code" href="../../d4/d8/mi_8h.html#a191">01559</a> <span class="comment">//</span>
01560 <span class="comment">//     Hash the address</span>
01561 <span class="comment">//</span>
01562 <span class="comment">// Arguments:</span>
01563 <span class="comment">//</span>
01564 <span class="comment">//     VirtualAddress - the address to hash.</span>
01565 <span class="comment">//</span>
01566 <span class="comment">//     WorkingSetList - the working set to hash the address into.</span>
<a name="l01567"></a><a class="code" href="../../d4/d8/struct__MMWSLENTRY.html">01567</a> <span class="comment">//</span>
<a name="l01568"></a><a class="code" href="../../d4/d8/struct__MMWSLENTRY.html#o0">01568</a> <span class="comment">// Return Value:</span>
<a name="l01569"></a><a class="code" href="../../d4/d8/struct__MMWSLENTRY.html#o1">01569</a> <span class="comment">//</span>
<a name="l01570"></a><a class="code" href="../../d4/d8/struct__MMWSLENTRY.html#o2">01570</a> <span class="comment">//     The hash key.</span>
<a name="l01571"></a><a class="code" href="../../d4/d8/struct__MMWSLENTRY.html#o3">01571</a> <span class="comment">//</span>
<a name="l01572"></a><a class="code" href="../../d4/d8/struct__MMWSLENTRY.html#o4">01572</a> <span class="comment">//--</span>
<a name="l01573"></a><a class="code" href="../../d4/d8/struct__MMWSLENTRY.html#o5">01573</a> <span class="comment">//</span>
<a name="l01574"></a><a class="code" href="../../d4/d8/struct__MMWSLENTRY.html#o6">01574</a> <span class="preprocessor">#define MI_WSLE_HASH(Address, Wsl) \</span>
01575 <span class="preprocessor">    ((WSLE_NUMBER)(((ULONG_PTR)PAGE_ALIGN(Address) &gt;&gt; (PAGE_SHIFT - 2)) % \</span>
01576 <span class="preprocessor">        ((Wsl)-&gt;HashTableSize - 1)))</span>
01577 <span class="preprocessor"></span>
<a name="l01578"></a><a class="code" href="../../d4/d8/struct__MMWSLENTRY.html#o7">01578</a> <span class="comment">//</span>
01579 <span class="comment">// Working Set List Entry.</span>
01580 <span class="comment">//</span>
<a name="l01581"></a><a class="code" href="../../d1/d8/struct__MMWSLE.html">01581</a> 
01582 <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d4/d8/struct__MMWSLENTRY.html">_MMWSLENTRY</a> {
<a name="l01583"></a><a class="code" href="../../d1/d8/struct__MMWSLE.html#o0">01583</a>     ULONG_PTR Valid : 1;
<a name="l01584"></a><a class="code" href="../../d1/d8/struct__MMWSLE.html#o1">01584</a>     ULONG_PTR LockedInWs : 1;
<a name="l01585"></a><a class="code" href="../../d1/d8/struct__MMWSLE.html#o2">01585</a>     ULONG_PTR LockedInMemory : 1;
01586     ULONG_PTR Protection : 5;
01587     ULONG_PTR SameProtectAsProto : 1;
01588     ULONG_PTR Direct : 1;
<a name="l01589"></a><a class="code" href="../../d4/d8/mi_8h.html#a192">01589</a>     ULONG_PTR Age : 2;
01590 <span class="preprocessor">#if MM_VIRTUAL_PAGE_FILLER</span>
<a name="l01591"></a><a class="code" href="../../d4/d8/mi_8h.html#a448">01591</a> <span class="preprocessor"></span>    ULONG_PTR Filler : <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a45">MM_VIRTUAL_PAGE_FILLER</a>;
01592 <span class="preprocessor">#endif</span>
01593 <span class="preprocessor"></span>    ULONG_PTR VirtualPageNumber : <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a46">MM_VIRTUAL_PAGE_SIZE</a>;
01594 } <a class="code" href="../../d4/d8/struct__MMWSLENTRY.html">MMWSLENTRY</a>;
01595 
01596 <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d1/d8/struct__MMWSLE.html">_MMWSLE</a> {
<a name="l01597"></a><a class="code" href="../../d0/d8/struct__MMWSL.html">01597</a>     <span class="keyword">union </span>{
<a name="l01598"></a><a class="code" href="../../d0/d8/struct__MMWSL.html#o0">01598</a>         PVOID VirtualAddress;
<a name="l01599"></a><a class="code" href="../../d0/d8/struct__MMWSL.html#o1">01599</a>         ULONG_PTR Long;
<a name="l01600"></a><a class="code" href="../../d0/d8/struct__MMWSL.html#o2">01600</a>         <a class="code" href="../../d4/d8/struct__MMWSLENTRY.html">MMWSLENTRY</a> e1;
<a name="l01601"></a><a class="code" href="../../d0/d8/struct__MMWSL.html#o3">01601</a>     } u1;
<a name="l01602"></a><a class="code" href="../../d0/d8/struct__MMWSL.html#o4">01602</a> } <a class="code" href="../../d1/d8/struct__MMWSLE.html">MMWSLE</a>;
<a name="l01603"></a><a class="code" href="../../d0/d8/struct__MMWSL.html#o5">01603</a> 
<a name="l01604"></a><a class="code" href="../../d0/d8/struct__MMWSL.html#o6">01604</a> <span class="preprocessor">#define MI_GET_PROTECTION_FROM_WSLE(Wsl) ((Wsl)-&gt;u1.e1.Protection)</span>
<a name="l01605"></a><a class="code" href="../../d0/d8/struct__MMWSL.html#o7">01605</a> <span class="preprocessor"></span>
<a name="l01606"></a><a class="code" href="../../d0/d8/struct__MMWSL.html#o8">01606</a> <span class="keyword">typedef</span> <a class="code" href="../../d1/d8/struct__MMWSLE.html">MMWSLE</a> *<a class="code" href="../../d1/d8/struct__MMWSLE.html">PMMWSLE</a>;
<a name="l01607"></a><a class="code" href="../../d0/d8/struct__MMWSL.html#o9">01607</a> 
<a name="l01608"></a><a class="code" href="../../d0/d8/struct__MMWSL.html#o10">01608</a> <span class="comment">//</span>
<a name="l01609"></a><a class="code" href="../../d0/d8/struct__MMWSL.html#o11">01609</a> <span class="comment">// Working Set List.  Must be quadword sized.</span>
<a name="l01610"></a><a class="code" href="../../d0/d8/struct__MMWSL.html#o12">01610</a> <span class="comment">//</span>
<a name="l01611"></a><a class="code" href="../../d0/d8/struct__MMWSL.html#o13">01611</a> 
01612 <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d0/d8/struct__MMWSL.html">_MMWSL</a> {
01613     SIZE_T <a class="code" href="../../d0/d8/struct__MMWSL.html#o0">Quota</a>;
01614     <a class="code" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a> <a class="code" href="../../d0/d8/struct__MMWSL.html#o1">FirstFree</a>;
01615     <a class="code" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a> <a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>;
<a name="l01616"></a><a class="code" href="../../d0/d8/struct__MMWSL.html#o14">01616</a>     <a class="code" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a> <a class="code" href="../../d0/d8/struct__MMWSL.html#o3">LastEntry</a>;
<a name="l01617"></a><a class="code" href="../../d0/d8/struct__MMWSL.html#o15">01617</a>     <a class="code" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a> <a class="code" href="../../d0/d8/struct__MMWSL.html#o4">NextSlot</a>;               <span class="comment">// The next slot to trim</span>
01618     <a class="code" href="../../d4/d8/mi_8h.html#a448">PMMWSLE</a> <a class="code" href="../../d0/d8/struct__MMWSL.html#o5">Wsle</a>;
01619     SIZE_T <a class="code" href="../../d0/d8/struct__MMWSL.html#o6">NumberOfCommittedPageTables</a>;
01620     <a class="code" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a> <a class="code" href="../../d0/d8/struct__MMWSL.html#o7">LastInitializedWsle</a>;
01621     <a class="code" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a> <a class="code" href="../../d0/d8/struct__MMWSL.html#o8">NonDirectCount</a>;
<a name="l01622"></a><a class="code" href="../../d0/d8/struct__MMWSL.html#o16">01622</a>     <a class="code" href="../../d4/d8/mi_8h.html#a445">PMMWSLE_HASH</a> <a class="code" href="../../d0/d8/struct__MMWSL.html#o9">HashTable</a>;
01623     ULONG <a class="code" href="../../d0/d8/struct__MMWSL.html#o10">HashTableSize</a>;
01624     <a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a> <a class="code" href="../../d0/d8/struct__MMWSL.html#o11">WaitingForImageMapping</a>;
01625     PVOID <a class="code" href="../../d0/d8/struct__MMWSL.html#o12">HashTableStart</a>;
<a name="l01626"></a><a class="code" href="../../d0/d8/struct__MMWSL.html#o17">01626</a>     PVOID <a class="code" href="../../d0/d8/struct__MMWSL.html#o13">HighestPermittedHashAddress</a>;
01627 
01628     <span class="comment">//MUST BE QUADWORD ALIGNED AT THIS POINT!</span>
01629 
01630 <span class="preprocessor">#if !defined (_WIN64)</span>
01631 <span class="preprocessor"></span>    PVOID <a class="code" href="../../d0/d8/struct__MMWSL.html#o14">Align1</a>;   <span class="comment">// to quadword align</span>
01632     PVOID <a class="code" href="../../d0/d8/struct__MMWSL.html#o15">Align2</a>;   <span class="comment">// to quadword align</span>
01633     <span class="comment">//</span>
01634     <span class="comment">// This must be at the end.</span>
01635     <span class="comment">// not used in system cache or session working set lists.</span>
01636     <span class="comment">//</span>
01637     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> <a class="code" href="../../d0/d8/struct__MMWSL.html#o16">UsedPageTableEntries</a>[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a104">MM_USER_PAGE_TABLE_PAGES</a>];
01638 <span class="preprocessor">#endif</span>
01639 <span class="preprocessor"></span>
01640 <span class="preprocessor">#ifndef _WIN64</span>
01641 <span class="preprocessor"></span>    ULONG <a class="code" href="../../d0/d8/struct__MMWSL.html#o17">CommittedPageTables</a>[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a104">MM_USER_PAGE_TABLE_PAGES</a>/(<span class="keyword">sizeof</span>(ULONG)*8)];
01642 <span class="preprocessor">#endif</span>
01643 <span class="preprocessor"></span>
01644 } <a class="code" href="../../d0/d8/struct__MMWSL.html">MMWSL</a>, *<a class="code" href="../../d0/d8/struct__MMWSL.html">PMMWSL</a>;
01645 
<a name="l01646"></a><a class="code" href="../../d4/d8/mi_8h.html#a193">01646</a> <span class="preprocessor">#ifdef _MI_USE_CLAIMS_</span>
<a name="l01647"></a><a class="code" href="../../d4/d8/mi_8h.html#a194">01647</a> <span class="preprocessor"></span>
01648 <span class="comment">//</span>
01649 <span class="comment">// The claim estimate of unused pages in a working set is limited</span>
01650 <span class="comment">// to grow by this amount per estimation period.</span>
01651 <span class="comment">//</span>
01652 
01653 <span class="preprocessor">#define MI_CLAIM_INCR 30</span>
<a name="l01654"></a><a class="code" href="../../d4/d8/mi_8h.html#a195">01654</a> <span class="preprocessor"></span>
01655 <span class="preprocessor">#endif</span>
01656 <span class="preprocessor"></span>
01657 <span class="comment">//</span>
01658 <span class="comment">// The maximum number of different ages a page can be.</span>
01659 <span class="comment">//</span>
01660 
<a name="l01661"></a><a class="code" href="../../d4/d8/mi_8h.html#a196">01661</a> <span class="preprocessor">#define MI_USE_AGE_COUNT 4</span>
01662 <span class="preprocessor"></span><span class="preprocessor">#define MI_USE_AGE_MAX (MI_USE_AGE_COUNT - 1)</span>
01663 <span class="preprocessor"></span>
01664 <span class="comment">//</span>
01665 <span class="comment">// If more than this "percentage" of the working set is estimated to</span>
01666 <span class="comment">// be used then allow it to grow freely.</span>
01667 <span class="comment">//</span>
<a name="l01668"></a><a class="code" href="../../d4/d8/mi_8h.html#a197">01668</a> 
01669 <span class="preprocessor">#define MI_REPLACEMENT_FREE_GROWTH_SHIFT 5</span>
01670 <span class="preprocessor"></span>
01671 <span class="comment">//</span>
01672 <span class="comment">// If more than this "percentage" of the working set has been claimed</span>
01673 <span class="comment">// then force replacement in low memory.</span>
01674 <span class="comment">//</span>
<a name="l01675"></a><a class="code" href="../../d4/d8/mi_8h.html#a198">01675</a> 
01676 <span class="preprocessor">#define MI_REPLACEMENT_CLAIM_THRESHOLD_SHIFT 3</span>
01677 <span class="preprocessor"></span>
01678 <span class="comment">//</span>
01679 <span class="comment">// If more than this "percentage" of the working set is estimated to</span>
01680 <span class="comment">// be available then force replacement in low memory.</span>
<a name="l01681"></a><a class="code" href="../../d4/d8/mi_8h.html#a199">01681</a> <span class="comment">//</span>
<a name="l01682"></a><a class="code" href="../../d4/d8/mi_8h.html#a200">01682</a> 
<a name="l01683"></a><a class="code" href="../../d4/d8/mi_8h.html#a201">01683</a> <span class="preprocessor">#define MI_REPLACEMENT_EAVAIL_THRESHOLD_SHIFT 3</span>
<a name="l01684"></a><a class="code" href="../../d4/d8/mi_8h.html#a202">01684</a> <span class="preprocessor"></span>
<a name="l01685"></a><a class="code" href="../../d4/d8/mi_8h.html#a203">01685</a> <span class="comment">//</span>
<a name="l01686"></a><a class="code" href="../../d4/d8/mi_8h.html#a204">01686</a> <span class="comment">// If while doing replacement a page is found of this age or older then</span>
01687 <span class="comment">// replace it.  Otherwise the oldest is selected.</span>
01688 <span class="comment">//</span>
01689 
01690 <span class="preprocessor">#define MI_IMMEDIATE_REPLACEMENT_AGE 2</span>
01691 <span class="preprocessor"></span>
<a name="l01692"></a><a class="code" href="../../d4/d8/mi_8h.html#a205">01692</a> <span class="comment">//</span>
01693 <span class="comment">// When trimming, use these ages for different passes.</span>
01694 <span class="comment">//</span>
01695 
01696 <span class="preprocessor">#define MI_MAX_TRIM_PASSES 4</span>
01697 <span class="preprocessor"></span><span class="preprocessor">#define MI_PASS0_TRIM_AGE 2</span>
<a name="l01698"></a><a class="code" href="../../d4/d8/mi_8h.html#a206">01698</a> <span class="preprocessor"></span><span class="preprocessor">#define MI_PASS1_TRIM_AGE 1</span>
01699 <span class="preprocessor"></span><span class="preprocessor">#define MI_PASS2_TRIM_AGE 1</span>
01700 <span class="preprocessor"></span><span class="preprocessor">#define MI_PASS3_TRIM_AGE 1</span>
01701 <span class="preprocessor"></span><span class="preprocessor">#define MI_PASS4_TRIM_AGE 0</span>
01702 <span class="preprocessor"></span>
01703 <span class="comment">//</span>
<a name="l01704"></a><a class="code" href="../../d4/d8/mi_8h.html#a207">01704</a> <span class="comment">// If not a forced trim, trim pages older than this age.</span>
01705 <span class="comment">//</span>
01706 
01707 <span class="preprocessor">#define MI_TRIM_AGE_THRESHOLD 2</span>
01708 <span class="preprocessor"></span>
01709 <span class="comment">//</span>
01710 <span class="comment">// This "percentage" of a claim is up for grabs in a foreground process.</span>
01711 <span class="comment">//</span>
01712 
01713 <span class="preprocessor">#define MI_FOREGROUND_CLAIM_AVAILABLE_SHIFT 3</span>
01714 <span class="preprocessor"></span>
01715 <span class="comment">//</span>
01716 <span class="comment">// This "percentage" of a claim is up for grabs in a background process.</span>
01717 <span class="comment">//</span>
01718 
01719 <span class="preprocessor">#define MI_BACKGROUND_CLAIM_AVAILABLE_SHIFT 1</span>
01720 <span class="preprocessor"></span>
01721 <span class="comment">//++</span>
01722 <span class="comment">//</span>
01723 <span class="comment">// DWORD</span>
01724 <span class="comment">// MI_CALC_NEXT_VALID_ESTIMATION_SLOT (</span>
01725 <span class="comment">//     DWORD Previous,</span>
01726 <span class="comment">//     DWORD Minimum,</span>
01727 <span class="comment">//     DWORD Maximum,</span>
01728 <span class="comment">//     MI_NEXT_ESTIMATION_SLOT_CONST NextEstimationSlotConst,</span>
01729 <span class="comment">//     PMMWSLE Wsle</span>
01730 <span class="comment">//     )</span>
01731 <span class="comment">//</span>
01732 <span class="comment">// Routine Description:</span>
01733 <span class="comment">//</span>
01734 <span class="comment">//      We iterate through the working set array in a non-sequential</span>
01735 <span class="comment">//      manner so that the sample is independent of any aging or trimming.</span>
01736 <span class="comment">//</span>
01737 <span class="comment">//      This algorithm walks through the working set with a stride of</span>
01738 <span class="comment">//      2^MiEstimationShift elements.</span>
01739 <span class="comment">//</span>
01740 <span class="comment">// Arguments:</span>
01741 <span class="comment">//</span>
01742 <span class="comment">//      Previous - Last slot used</span>
01743 <span class="comment">//</span>
01744 <span class="comment">//      Minimum - Minimum acceptable slot (ie. the first dynamic one)</span>
01745 <span class="comment">//</span>
01746 <span class="comment">//      Maximum - max slot number + 1</span>
<a name="l01747"></a><a class="code" href="../../d2/d9/struct__MI__NEXT__ESTIMATION__SLOT__CONST.html">01747</a> <span class="comment">//</span>
<a name="l01748"></a><a class="code" href="../../d2/d9/struct__MI__NEXT__ESTIMATION__SLOT__CONST.html#o0">01748</a> <span class="comment">//      NextEstimationSlotConst - for this algorithm it contains the stride</span>
01749 <span class="comment">//</span>
01750 <span class="comment">//      Wsle - the working set array</span>
01751 <span class="comment">//</span>
<a name="l01752"></a><a class="code" href="../../d4/d8/mi_8h.html#a208">01752</a> <span class="comment">// Return Value:</span>
01753 <span class="comment">//</span>
01754 <span class="comment">//      Next slot.</span>
<a name="l01755"></a><a class="code" href="../../d4/d8/mi_8h.html#a209">01755</a> <span class="comment">//</span>
01756 <span class="comment">// Environment:</span>
01757 <span class="comment">//</span>
01758 <span class="comment">//      Kernel mode, APCs disabled, working set lock held and PFN lock held.</span>
01759 <span class="comment">//</span>
01760 <span class="comment">//--</span>
01761 
01762 <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d2/d9/struct__MI__NEXT__ESTIMATION__SLOT__CONST.html">_MI_NEXT_ESTIMATION_SLOT_CONST</a> {
01763     <a class="code" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a> Stride;
01764 } <a class="code" href="../../d2/d9/struct__MI__NEXT__ESTIMATION__SLOT__CONST.html">MI_NEXT_ESTIMATION_SLOT_CONST</a>;
01765 
01766 
01767 <span class="preprocessor">#define MI_CALC_NEXT_ESTIMATION_SLOT_CONST(NextEstimationSlotConst, WorkingSetList) \</span>
01768 <span class="preprocessor">    (NextEstimationSlotConst).Stride = 1 &lt;&lt; MiEstimationShift;</span>
01769 <span class="preprocessor"></span>
01770 <span class="preprocessor">#define MI_NEXT_VALID_ESTIMATION_SLOT(Previous, StartEntry, Minimum, Maximum, NextEstimationSlotConst, Wsle) \</span>
01771 <span class="preprocessor">    ASSERT(((Previous) &gt;= Minimum) &amp;&amp; ((Previous) &lt;= Maximum)); \</span>
01772 <span class="preprocessor">    ASSERT(((StartEntry) &gt;= Minimum) &amp;&amp; ((StartEntry) &lt;= Maximum)); \</span>
01773 <span class="preprocessor">    do { \</span>
01774 <span class="preprocessor">        (Previous) += (NextEstimationSlotConst).Stride; \</span>
01775 <span class="preprocessor">        if ((Previous) &gt; Maximum) { \</span>
01776 <span class="preprocessor">            (Previous) = Minimum + ((Previous + 1) &amp; (NextEstimationSlotConst.Stride - 1)); \</span>
01777 <span class="preprocessor">            StartEntry += 1; \</span>
01778 <span class="preprocessor">            (Previous) = StartEntry; \</span>
01779 <span class="preprocessor">        } \</span>
01780 <span class="preprocessor">        if ((Previous) &gt; Maximum || (Previous) &lt; Minimum) { \</span>
01781 <span class="preprocessor">            StartEntry = Minimum; \</span>
01782 <span class="preprocessor">            (Previous) = StartEntry; \</span>
01783 <span class="preprocessor">        } \</span>
01784 <span class="preprocessor">    } while (Wsle[Previous].u1.e1.Valid == 0);</span>
01785 <span class="preprocessor"></span>
01786 <span class="comment">//++</span>
01787 <span class="comment">//</span>
01788 <span class="comment">// WSLE_NUMBER</span>
01789 <span class="comment">// MI_NEXT_VALID_AGING_SLOT (</span>
01790 <span class="comment">//     DWORD Previous,</span>
01791 <span class="comment">//     DWORD Minimum,</span>
01792 <span class="comment">//     DWORD Maximum,</span>
01793 <span class="comment">//     PMMWSLE Wsle</span>
01794 <span class="comment">//     )</span>
01795 <span class="comment">//</span>
01796 <span class="comment">// Routine Description:</span>
01797 <span class="comment">//</span>
01798 <span class="comment">//      This finds the next slot to valid slot to age.  It walks</span>
01799 <span class="comment">//      through the slots sequentialy.</span>
01800 <span class="comment">//</span>
01801 <span class="comment">// Arguments:</span>
01802 <span class="comment">//</span>
01803 <span class="comment">//      Previous - Last slot used</span>
01804 <span class="comment">//</span>
01805 <span class="comment">//      Minimum - Minimum acceptable slot (ie. the first dynamic one)</span>
<a name="l01806"></a><a class="code" href="../../d4/d8/mi_8h.html#a210">01806</a> <span class="comment">//</span>
01807 <span class="comment">//      Maximum - Max slot number + 1</span>
01808 <span class="comment">//</span>
01809 <span class="comment">//      Wsle - the working set array</span>
01810 <span class="comment">//</span>
01811 <span class="comment">// Return Value:</span>
01812 <span class="comment">//</span>
01813 <span class="comment">//      None.</span>
01814 <span class="comment">//</span>
01815 <span class="comment">// Environment:</span>
01816 <span class="comment">//</span>
01817 <span class="comment">//      Kernel mode, APCs disabled, working set lock held and PFN lock held.</span>
01818 <span class="comment">//</span>
01819 <span class="comment">//--</span>
01820 
01821 <span class="preprocessor">#define MI_NEXT_VALID_AGING_SLOT(Previous, Minimum, Maximum, Wsle) \</span>
01822 <span class="preprocessor">    ASSERT(((Previous) &gt;= Minimum) &amp;&amp; ((Previous) &lt;= Maximum)); \</span>
01823 <span class="preprocessor">    do { \</span>
01824 <span class="preprocessor">        (Previous) += 1; \</span>
01825 <span class="preprocessor">        if ((Previous) &gt; Maximum) { \</span>
01826 <span class="preprocessor">            Previous = Minimum; \</span>
01827 <span class="preprocessor">        } \</span>
01828 <span class="preprocessor">    } while ((Wsle[Previous].u1.e1.Valid == 0));</span>
01829 <span class="preprocessor"></span>
01830 <span class="comment">//++</span>
01831 <span class="comment">//</span>
01832 <span class="comment">// ULONG</span>
01833 <span class="comment">// MI_CALCULATE_USAGE_ESTIMATE (</span>
01834 <span class="comment">//     IN ULONG *SampledAgeCounts</span>
01835 <span class="comment">//     )</span>
01836 <span class="comment">//</span>
01837 <span class="comment">// Routine Description:</span>
01838 <span class="comment">//</span>
<a name="l01839"></a><a class="code" href="../../d4/d8/mi_8h.html#a211">01839</a> <span class="comment">//      In Usage Estimation, we count the number of pages of each age in</span>
01840 <span class="comment">//      a sample.  The function turns the SampledAgeCounts into an</span>
01841 <span class="comment">//      estimate of the unused pages.</span>
01842 <span class="comment">//</span>
01843 <span class="comment">// Arguments:</span>
01844 <span class="comment">//</span>
01845 <span class="comment">//      SampledAgeCounts - counts of pages of each different age in the sample</span>
01846 <span class="comment">//</span>
01847 <span class="comment">// Return Value:</span>
01848 <span class="comment">//</span>
01849 <span class="comment">//      The number of pages to walk in the working set to get a good</span>
01850 <span class="comment">//      estimate of the number available.</span>
01851 <span class="comment">//</span>
01852 <span class="comment">//--</span>
01853 
01854 <span class="preprocessor">#define MI_CALCULATE_USAGE_ESTIMATE(SampledAgeCounts) \</span>
01855 <span class="preprocessor">                (((SampledAgeCounts)[1] + \</span>
01856 <span class="preprocessor">                    (SampledAgeCounts)[2] + (SampledAgeCounts)[3]) \</span>
01857 <span class="preprocessor">                    &lt;&lt; MiEstimationShift)</span>
01858 <span class="preprocessor"></span>
01859 <span class="comment">//++</span>
01860 <span class="comment">//</span>
01861 <span class="comment">// VOID</span>
01862 <span class="comment">// MI_RESET_WSLE_AGE (</span>
01863 <span class="comment">//     IN PMMPTE PointerPte,</span>
01864 <span class="comment">//     IN PMMWSLE Wsle</span>
01865 <span class="comment">//     )</span>
01866 <span class="comment">//</span>
<a name="l01867"></a><a class="code" href="../../d4/d8/mi_8h.html#a212">01867</a> <span class="comment">// Routine Description:</span>
01868 <span class="comment">//</span>
01869 <span class="comment">//      Clear the age counter for the working set entry.</span>
01870 <span class="comment">//</span>
01871 <span class="comment">// Arguments:</span>
01872 <span class="comment">//</span>
01873 <span class="comment">//      PointerPte - pointer to the working set list entry's PTE.</span>
01874 <span class="comment">//</span>
01875 <span class="comment">//      Wsle - pointer to the working set list entry.</span>
01876 <span class="comment">//</span>
01877 <span class="comment">// Return Value:</span>
01878 <span class="comment">//</span>
01879 <span class="comment">//      None.</span>
01880 <span class="comment">//</span>
01881 <span class="comment">//--</span>
01882 <span class="preprocessor">#define MI_RESET_WSLE_AGE(PointerPte, Wsle) \</span>
01883 <span class="preprocessor">    (Wsle)-&gt;u1.e1.Age = 0;</span>
01884 <span class="preprocessor"></span>
01885 <span class="comment">//++</span>
01886 <span class="comment">//</span>
01887 <span class="comment">// ULONG</span>
01888 <span class="comment">// MI_GET_WSLE_AGE (</span>
01889 <span class="comment">//     IN PMMPTE PointerPte,</span>
01890 <span class="comment">//     IN PMMWSLE Wsle</span>
01891 <span class="comment">//     )</span>
<a name="l01892"></a><a class="code" href="../../d4/d8/mi_8h.html#a213">01892</a> <span class="comment">//</span>
01893 <span class="comment">// Routine Description:</span>
01894 <span class="comment">//</span>
01895 <span class="comment">//      Clear the age counter for the working set entry.</span>
01896 <span class="comment">//</span>
01897 <span class="comment">// Arguments:</span>
01898 <span class="comment">//</span>
01899 <span class="comment">//      PointerPte - pointer to the working set list entry's pte</span>
01900 <span class="comment">//      Wsle - pointer to the working set list entry</span>
01901 <span class="comment">//</span>
01902 <span class="comment">// Return Value:</span>
01903 <span class="comment">//</span>
01904 <span class="comment">//      Age group of the working set entry</span>
01905 <span class="comment">//</span>
01906 <span class="comment">//--</span>
01907 <span class="preprocessor">#define MI_GET_WSLE_AGE(PointerPte, Wsle) \</span>
01908 <span class="preprocessor">    ((Wsle)-&gt;u1.e1.Age)</span>
01909 <span class="preprocessor"></span>
01910 <span class="comment">//++</span>
01911 <span class="comment">//</span>
01912 <span class="comment">// VOID</span>
01913 <span class="comment">// MI_INC_WSLE_AGE (</span>
01914 <span class="comment">//     IN PMMPTE PointerPte,</span>
01915 <span class="comment">//     IN PMMWSLE Wsle,</span>
01916 <span class="comment">//     )</span>
01917 <span class="comment">//</span>
01918 <span class="comment">// Routine Description:</span>
<a name="l01919"></a><a class="code" href="../../d4/d8/mi_8h.html#a214">01919</a> <span class="comment">//</span>
01920 <span class="comment">//      Increment the age counter for the working set entry.</span>
01921 <span class="comment">//</span>
01922 <span class="comment">// Arguments:</span>
01923 <span class="comment">//</span>
01924 <span class="comment">//      PointerPte - pointer to the working set list entry's PTE.</span>
01925 <span class="comment">//</span>
01926 <span class="comment">//      Wsle - pointer to the working set list entry.</span>
01927 <span class="comment">//</span>
01928 <span class="comment">// Return Value:</span>
01929 <span class="comment">//</span>
01930 <span class="comment">//      None</span>
01931 <span class="comment">//</span>
01932 <span class="comment">//--</span>
01933 
01934 <span class="preprocessor">#define MI_INC_WSLE_AGE(PointerPte, Wsle) \</span>
01935 <span class="preprocessor">    if ((Wsle)-&gt;u1.e1.Age &lt; 3) { \</span>
01936 <span class="preprocessor">        (Wsle)-&gt;u1.e1.Age += 1; \</span>
01937 <span class="preprocessor">    }</span>
01938 <span class="preprocessor"></span>
01939 <span class="comment">//++</span>
01940 <span class="comment">//</span>
01941 <span class="comment">// VOID</span>
01942 <span class="comment">// MI_UPDATE_USE_ESTIMATE (</span>
01943 <span class="comment">//     IN PMMPTE PointerPte,</span>
01944 <span class="comment">//     IN PMMWSLE Wsle,</span>
01945 <span class="comment">//     IN ULONG *SampledAgeCounts</span>
01946 <span class="comment">//     )</span>
01947 <span class="comment">//</span>
01948 <span class="comment">// Routine Description:</span>
01949 <span class="comment">//</span>
01950 <span class="comment">//      Update the sampled age counts.</span>
<a name="l01951"></a><a class="code" href="../../d4/d8/mi_8h.html#a215">01951</a> <span class="comment">//</span>
01952 <span class="comment">// Arguments:</span>
01953 <span class="comment">//</span>
01954 <span class="comment">//      PointerPte - pointer to the working set list entry's PTE.</span>
01955 <span class="comment">//</span>
01956 <span class="comment">//      Wsle - pointer to the working set list entry.</span>
01957 <span class="comment">//</span>
01958 <span class="comment">//      SampledAgeCounts - array of age counts to be updated.</span>
01959 <span class="comment">//</span>
01960 <span class="comment">// Return Value:</span>
01961 <span class="comment">//</span>
01962 <span class="comment">//      None</span>
01963 <span class="comment">//</span>
01964 <span class="comment">//--</span>
01965 
01966 <span class="preprocessor">#define MI_UPDATE_USE_ESTIMATE(PointerPte, Wsle, SampledAgeCounts) \</span>
01967 <span class="preprocessor">    (SampledAgeCounts)[(Wsle)-&gt;u1.e1.Age] += 1;</span>
01968 <span class="preprocessor"></span>
01969 <span class="comment">//++</span>
01970 <span class="comment">//</span>
01971 <span class="comment">// BOOLEAN</span>
01972 <span class="comment">// MI_WS_GROWING_TOO_FAST (</span>
01973 <span class="comment">//     IN PMMSUPPORT VmSupport</span>
01974 <span class="comment">//     )</span>
01975 <span class="comment">//</span>
01976 <span class="comment">// Routine Description:</span>
<a name="l01977"></a><a class="code" href="../../d4/d8/mi_8h.html#a216">01977</a> <span class="comment">//</span>
01978 <span class="comment">//      Limit the growth rate of processes as the</span>
01979 <span class="comment">//      available memory approaches zero.  Note the caller must ensure that</span>
01980 <span class="comment">//      MmAvailablePages is low enough so this calculation does not wrap.</span>
01981 <span class="comment">//</span>
01982 <span class="comment">// Arguments:</span>
01983 <span class="comment">//</span>
01984 <span class="comment">//      VmSupport - a working set.</span>
<a name="l01985"></a><a class="code" href="../../d4/d8/mi_8h.html#a217">01985</a> <span class="comment">//</span>
01986 <span class="comment">// Return Value:</span>
01987 <span class="comment">//</span>
<a name="l01988"></a><a class="code" href="../../d4/d8/mi_8h.html#a1002">01988</a> <span class="comment">//      TRUE if the growth rate is too fast, FALSE otherwise.</span>
01989 <span class="comment">//</span>
01990 <span class="comment">//--</span>
01991 
01992 <span class="preprocessor">#define MI_WS_GROWING_TOO_FAST(VmSupport) \</span>
01993 <span class="preprocessor">    ((VmSupport)-&gt;GrowthSinceLastEstimate &gt; \</span>
01994 <span class="preprocessor">        (((MI_CLAIM_INCR * (MmAvailablePages*MmAvailablePages)) / (64*64)) + 1))</span>
<a name="l01995"></a><a class="code" href="../../d0/d2/struct__MMEXTEND__INFO.html">01995</a> <span class="preprocessor"></span>
<a name="l01996"></a><a class="code" href="../../d0/d2/struct__MMEXTEND__INFO.html#o0">01996</a> <span class="comment">//</span>
<a name="l01997"></a><a class="code" href="../../d0/d2/struct__MMEXTEND__INFO.html#o1">01997</a> <span class="comment">// Memory Management Object structures.</span>
01998 <span class="comment">//</span>
01999 
<a name="l02000"></a><a class="code" href="../../d1/d1/struct__SEGMENT.html">02000</a> <span class="preprocessor">#define SECTION_BASE_ADDRESS(_NtSection) \</span>
<a name="l02001"></a><a class="code" href="../../d1/d1/struct__SEGMENT.html#o0">02001</a> <span class="preprocessor">    (*((PVOID *)&amp;(_NtSection)-&gt;PointerToRelocations))</span>
<a name="l02002"></a><a class="code" href="../../d1/d1/struct__SEGMENT.html#o1">02002</a> <span class="preprocessor"></span>
<a name="l02003"></a><a class="code" href="../../d1/d1/struct__SEGMENT.html#o2">02003</a> <span class="keyword">typedef</span> <span class="keyword">enum</span> <a class="code" href="../../d4/d8/mi_8h.html#a1002">_SECTION_CHECK_TYPE</a> {
<a name="l02004"></a><a class="code" href="../../d1/d1/struct__SEGMENT.html#o3">02004</a>     <a class="code" href="../../d4/d8/mi_8h.html#a1002a765">CheckDataSection</a>,
<a name="l02005"></a><a class="code" href="../../d1/d1/struct__SEGMENT.html#o4">02005</a>     <a class="code" href="../../d4/d8/mi_8h.html#a1002a766">CheckImageSection</a>,
<a name="l02006"></a><a class="code" href="../../d1/d1/struct__SEGMENT.html#o5">02006</a>     <a class="code" href="../../d4/d8/mi_8h.html#a1002a767">CheckUserDataSection</a>,
<a name="l02007"></a><a class="code" href="../../d1/d1/struct__SEGMENT.html#o6">02007</a>     <a class="code" href="../../d4/d8/mi_8h.html#a1002a768">CheckBothSection</a>
<a name="l02008"></a><a class="code" href="../../d1/d1/struct__SEGMENT.html#o7">02008</a> } <a class="code" href="../../d4/d8/mi_8h.html#a452">SECTION_CHECK_TYPE</a>;
<a name="l02009"></a><a class="code" href="../../d1/d1/struct__SEGMENT.html#o8">02009</a> 
<a name="l02010"></a><a class="code" href="../../d1/d1/struct__SEGMENT.html#o9">02010</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d0/d2/struct__MMEXTEND__INFO.html">_MMEXTEND_INFO</a> {
<a name="l02011"></a><a class="code" href="../../d1/d1/struct__SEGMENT.html#o10">02011</a>     UINT64 CommittedSize;
<a name="l02012"></a><a class="code" href="../../d1/d1/struct__SEGMENT.html#o11">02012</a>     ULONG ReferenceCount;
<a name="l02013"></a><a class="code" href="../../d1/d1/struct__SEGMENT.html#o12">02013</a> } <a class="code" href="../../d0/d2/struct__MMEXTEND__INFO.html">MMEXTEND_INFO</a>, *<a class="code" href="../../d0/d2/struct__MMEXTEND__INFO.html">PMMEXTEND_INFO</a>;
<a name="l02014"></a><a class="code" href="../../d1/d1/struct__SEGMENT.html#o13">02014</a> 
02015 <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d1/d1/struct__SEGMENT.html">_SEGMENT</a> {
02016     <span class="keyword">struct </span><a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">_CONTROL_AREA</a> *<a class="code" href="../../d1/d1/struct__SEGMENT.html#o0">ControlArea</a>;
02017     PVOID <a class="code" href="../../d1/d1/struct__SEGMENT.html#o1">SegmentBaseAddress</a>;
<a name="l02018"></a><a class="code" href="../../d3/d7/struct__EVENT__COUNTER.html">02018</a>     ULONG TotalNumberOfPtes;
<a name="l02019"></a><a class="code" href="../../d3/d7/struct__EVENT__COUNTER.html#o0">02019</a>     ULONG NonExtendedPtes;
<a name="l02020"></a><a class="code" href="../../d3/d7/struct__EVENT__COUNTER.html#o1">02020</a>     UINT64 SizeOfSegment;
<a name="l02021"></a><a class="code" href="../../d3/d7/struct__EVENT__COUNTER.html#o2">02021</a>     SIZE_T ImageCommitment;
02022     PSECTION_IMAGE_INFORMATION ImageInformation;
02023     PVOID SystemImageBase;
<a name="l02024"></a><a class="code" href="../../d7/d5/struct__MMSECTION__FLAGS.html">02024</a>     SIZE_T NumberOfCommittedPages;
<a name="l02025"></a><a class="code" href="../../d7/d5/struct__MMSECTION__FLAGS.html#o0">02025</a>     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> SegmentPteTemplate;
<a name="l02026"></a><a class="code" href="../../d7/d5/struct__MMSECTION__FLAGS.html#o1">02026</a>     PVOID BasedAddress;
<a name="l02027"></a><a class="code" href="../../d7/d5/struct__MMSECTION__FLAGS.html#o2">02027</a>     <a class="code" href="../../d4/d8/mi_8h.html#a454">PMMEXTEND_INFO</a> ExtendInfo;
<a name="l02028"></a><a class="code" href="../../d7/d5/struct__MMSECTION__FLAGS.html#o3">02028</a>     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PrototypePte;
<a name="l02029"></a><a class="code" href="../../d7/d5/struct__MMSECTION__FLAGS.html#o4">02029</a>     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> ThePtes[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a47">MM_PROTO_PTE_ALIGNMENT</a> / <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>];
<a name="l02030"></a><a class="code" href="../../d7/d5/struct__MMSECTION__FLAGS.html#o5">02030</a> 
<a name="l02031"></a><a class="code" href="../../d7/d5/struct__MMSECTION__FLAGS.html#o6">02031</a> } <a class="code" href="../../d1/d1/struct__SEGMENT.html">SEGMENT</a>, *<a class="code" href="../../d1/d1/struct__SEGMENT.html">PSEGMENT</a>;
<a name="l02032"></a><a class="code" href="../../d7/d5/struct__MMSECTION__FLAGS.html#o7">02032</a> 
<a name="l02033"></a><a class="code" href="../../d7/d5/struct__MMSECTION__FLAGS.html#o8">02033</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d3/d7/struct__EVENT__COUNTER.html">_EVENT_COUNTER</a> {
<a name="l02034"></a><a class="code" href="../../d7/d5/struct__MMSECTION__FLAGS.html#o9">02034</a>     ULONG RefCount;
<a name="l02035"></a><a class="code" href="../../d7/d5/struct__MMSECTION__FLAGS.html#o10">02035</a>     <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> Event;
<a name="l02036"></a><a class="code" href="../../d7/d5/struct__MMSECTION__FLAGS.html#o11">02036</a>     LIST_ENTRY ListEntry;
<a name="l02037"></a><a class="code" href="../../d7/d5/struct__MMSECTION__FLAGS.html#o12">02037</a> } <a class="code" href="../../d3/d7/struct__EVENT__COUNTER.html">EVENT_COUNTER</a>, *<a class="code" href="../../d3/d7/struct__EVENT__COUNTER.html">PEVENT_COUNTER</a>;
<a name="l02038"></a><a class="code" href="../../d7/d5/struct__MMSECTION__FLAGS.html#o13">02038</a> 
<a name="l02039"></a><a class="code" href="../../d7/d5/struct__MMSECTION__FLAGS.html#o14">02039</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d7/d5/struct__MMSECTION__FLAGS.html">_MMSECTION_FLAGS</a> {
<a name="l02040"></a><a class="code" href="../../d7/d5/struct__MMSECTION__FLAGS.html#o15">02040</a>     <span class="keywordtype">unsigned</span> <a class="code" href="../../d7/d5/struct__MMSECTION__FLAGS.html#o0">BeingDeleted</a> : 1;
<a name="l02041"></a><a class="code" href="../../d7/d5/struct__MMSECTION__FLAGS.html#o16">02041</a>     <span class="keywordtype">unsigned</span> <a class="code" href="../../d7/d5/struct__MMSECTION__FLAGS.html#o1">BeingCreated</a> : 1;
<a name="l02042"></a><a class="code" href="../../d7/d5/struct__MMSECTION__FLAGS.html#o17">02042</a>     <span class="keywordtype">unsigned</span> <a class="code" href="../../d7/d5/struct__MMSECTION__FLAGS.html#o2">BeingPurged</a> : 1;
<a name="l02043"></a><a class="code" href="../../d7/d5/struct__MMSECTION__FLAGS.html#o18">02043</a>     <span class="keywordtype">unsigned</span> <a class="code" href="../../d7/d5/struct__MMSECTION__FLAGS.html#o3">NoModifiedWriting</a> : 1;
<a name="l02044"></a><a class="code" href="../../d7/d5/struct__MMSECTION__FLAGS.html#o19">02044</a>     <span class="keywordtype">unsigned</span> <a class="code" href="../../d7/d5/struct__MMSECTION__FLAGS.html#o4">FailAllIo</a> : 1;
<a name="l02045"></a><a class="code" href="../../d7/d5/struct__MMSECTION__FLAGS.html#o20">02045</a>     <span class="keywordtype">unsigned</span> <a class="code" href="../../d7/d5/struct__MMSECTION__FLAGS.html#o5">Image</a> : 1;
<a name="l02046"></a><a class="code" href="../../d7/d5/struct__MMSECTION__FLAGS.html#o21">02046</a>     <span class="keywordtype">unsigned</span> <a class="code" href="../../d7/d5/struct__MMSECTION__FLAGS.html#o6">Based</a> : 1;
<a name="l02047"></a><a class="code" href="../../d7/d5/struct__MMSECTION__FLAGS.html#o22">02047</a>     <span class="keywordtype">unsigned</span> <a class="code" href="../../d7/d5/struct__MMSECTION__FLAGS.html#o7">File</a> : 1;
<a name="l02048"></a><a class="code" href="../../d7/d5/struct__MMSECTION__FLAGS.html#o23">02048</a>     <span class="keywordtype">unsigned</span> <a class="code" href="../../d7/d5/struct__MMSECTION__FLAGS.html#o8">Networked</a> : 1;
<a name="l02049"></a><a class="code" href="../../d7/d5/struct__MMSECTION__FLAGS.html#o24">02049</a>     <span class="keywordtype">unsigned</span> <a class="code" href="../../d7/d5/struct__MMSECTION__FLAGS.html#o9">NoCache</a> : 1;
<a name="l02050"></a><a class="code" href="../../d7/d5/struct__MMSECTION__FLAGS.html#o25">02050</a>     <span class="keywordtype">unsigned</span> <a class="code" href="../../d7/d5/struct__MMSECTION__FLAGS.html#o10">PhysicalMemory</a> : 1;
<a name="l02051"></a><a class="code" href="../../d7/d5/struct__MMSECTION__FLAGS.html#o26">02051</a>     <span class="keywordtype">unsigned</span> <a class="code" href="../../d7/d5/struct__MMSECTION__FLAGS.html#o11">CopyOnWrite</a> : 1;
<a name="l02052"></a><a class="code" href="../../d7/d5/struct__MMSECTION__FLAGS.html#o27">02052</a>     <span class="keywordtype">unsigned</span> <a class="code" href="../../d7/d5/struct__MMSECTION__FLAGS.html#o12">Reserve</a> : 1;  <span class="comment">// not a spare bit!</span>
<a name="l02053"></a><a class="code" href="../../d7/d5/struct__MMSECTION__FLAGS.html#o28">02053</a>     <span class="keywordtype">unsigned</span> <a class="code" href="../../d7/d5/struct__MMSECTION__FLAGS.html#o13">Commit</a> : 1;
<a name="l02054"></a><a class="code" href="../../d7/d5/struct__MMSECTION__FLAGS.html#o29">02054</a>     <span class="keywordtype">unsigned</span> <a class="code" href="../../d7/d5/struct__MMSECTION__FLAGS.html#o14">FloppyMedia</a> : 1;
02055     <span class="keywordtype">unsigned</span> <a class="code" href="../../d7/d5/struct__MMSECTION__FLAGS.html#o15">WasPurged</a> : 1;
02056     <span class="keywordtype">unsigned</span> <a class="code" href="../../d7/d5/struct__MMSECTION__FLAGS.html#o16">UserReference</a> : 1;
<a name="l02057"></a><a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">02057</a>     <span class="keywordtype">unsigned</span> GlobalMemory : 1;
<a name="l02058"></a><a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o0">02058</a>     <span class="keywordtype">unsigned</span> DeleteOnClose : 1;
<a name="l02059"></a><a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o1">02059</a>     <span class="keywordtype">unsigned</span> FilePointerNull : 1;
<a name="l02060"></a><a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o2">02060</a>     <span class="keywordtype">unsigned</span> DebugSymbolsLoaded : 1;
<a name="l02061"></a><a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o3">02061</a>     <span class="keywordtype">unsigned</span> SetMappedFileIoComplete : 1;
<a name="l02062"></a><a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o4">02062</a>     <span class="keywordtype">unsigned</span> CollidedFlush : 1;
<a name="l02063"></a><a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o5">02063</a>     <span class="keywordtype">unsigned</span> NoChange : 1;
<a name="l02064"></a><a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o6">02064</a>     <span class="keywordtype">unsigned</span> HadUserReference : 1;
<a name="l02065"></a><a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o7">02065</a>     <span class="keywordtype">unsigned</span> ImageMappedInSystemSpace : 1;
02066     <span class="keywordtype">unsigned</span> filler0 : 1;
<a name="l02067"></a><a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o8">02067</a>     <span class="keywordtype">unsigned</span> Accessed : 1;
<a name="l02068"></a><a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o9">02068</a>     <span class="keywordtype">unsigned</span> GlobalOnlyPerSession : 1;
02069     <span class="keywordtype">unsigned</span> filler : 3;
<a name="l02070"></a><a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o11">02070</a> } <a class="code" href="../../d7/d5/struct__MMSECTION__FLAGS.html">MMSECTION_FLAGS</a>;
<a name="l02071"></a><a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o12">02071</a> 
<a name="l02072"></a><a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o13">02072</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">_CONTROL_AREA</a> {      <span class="comment">// must be quadword sized.</span>
<a name="l02073"></a><a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o14">02073</a>     <a class="code" href="../../d4/d8/mi_8h.html#a456">PSEGMENT</a> <a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o0">Segment</a>;
<a name="l02074"></a><a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o15">02074</a>     LIST_ENTRY <a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o1">DereferenceList</a>;
<a name="l02075"></a><a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o16">02075</a>     ULONG <a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o2">NumberOfSectionReferences</a>;
02076     ULONG <a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o3">NumberOfPfnReferences</a>;
02077     ULONG <a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o4">NumberOfMappedViews</a>;
<a name="l02078"></a><a class="code" href="../../d6/d8/struct__LARGE__CONTROL__AREA.html">02078</a>     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> NumberOfSubsections;
<a name="l02079"></a><a class="code" href="../../d6/d8/struct__LARGE__CONTROL__AREA.html#o0">02079</a>     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> FlushInProgressCount;
<a name="l02080"></a><a class="code" href="../../d6/d8/struct__LARGE__CONTROL__AREA.html#o1">02080</a>     ULONG NumberOfUserReferences;
<a name="l02081"></a><a class="code" href="../../d6/d8/struct__LARGE__CONTROL__AREA.html#o2">02081</a>     <span class="keyword">union </span>{
<a name="l02082"></a><a class="code" href="../../d6/d8/struct__LARGE__CONTROL__AREA.html#o3">02082</a>         ULONG LongFlags;
<a name="l02083"></a><a class="code" href="../../d6/d8/struct__LARGE__CONTROL__AREA.html#o4">02083</a>         <a class="code" href="../../d7/d5/struct__MMSECTION__FLAGS.html">MMSECTION_FLAGS</a> Flags;
<a name="l02084"></a><a class="code" href="../../d6/d8/struct__LARGE__CONTROL__AREA.html#o5">02084</a>     } u;
<a name="l02085"></a><a class="code" href="../../d6/d8/struct__LARGE__CONTROL__AREA.html#o6">02085</a>     <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FilePointer;
<a name="l02086"></a><a class="code" href="../../d6/d8/struct__LARGE__CONTROL__AREA.html#o7">02086</a>     <a class="code" href="../../d4/d8/mi_8h.html#a458">PEVENT_COUNTER</a> WaitingForDeletion;
02087     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> ModifiedWriteCount;
<a name="l02088"></a><a class="code" href="../../d6/d8/struct__LARGE__CONTROL__AREA.html#o8">02088</a>     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> NumberOfSystemCacheViews;
<a name="l02089"></a><a class="code" href="../../d6/d8/struct__LARGE__CONTROL__AREA.html#o9">02089</a>     SIZE_T PagedPoolUsage;
02090     SIZE_T NonPagedPoolUsage;
<a name="l02091"></a><a class="code" href="../../d6/d8/struct__LARGE__CONTROL__AREA.html#o11">02091</a> } <a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">CONTROL_AREA</a>, *<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a>;
<a name="l02092"></a><a class="code" href="../../d6/d8/struct__LARGE__CONTROL__AREA.html#o12">02092</a> 
<a name="l02093"></a><a class="code" href="../../d6/d8/struct__LARGE__CONTROL__AREA.html#o13">02093</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d6/d8/struct__LARGE__CONTROL__AREA.html">_LARGE_CONTROL_AREA</a> {      <span class="comment">// must be quadword sized.</span>
<a name="l02094"></a><a class="code" href="../../d6/d8/struct__LARGE__CONTROL__AREA.html#o14">02094</a>     <a class="code" href="../../d4/d8/mi_8h.html#a456">PSEGMENT</a> <a class="code" href="../../d6/d8/struct__LARGE__CONTROL__AREA.html#o0">Segment</a>;
<a name="l02095"></a><a class="code" href="../../d6/d8/struct__LARGE__CONTROL__AREA.html#o15">02095</a>     LIST_ENTRY <a class="code" href="../../d6/d8/struct__LARGE__CONTROL__AREA.html#o1">DereferenceList</a>;
<a name="l02096"></a><a class="code" href="../../d6/d8/struct__LARGE__CONTROL__AREA.html#o16">02096</a>     ULONG <a class="code" href="../../d6/d8/struct__LARGE__CONTROL__AREA.html#o2">NumberOfSectionReferences</a>;
<a name="l02097"></a><a class="code" href="../../d6/d8/struct__LARGE__CONTROL__AREA.html#o17">02097</a>     ULONG <a class="code" href="../../d6/d8/struct__LARGE__CONTROL__AREA.html#o3">NumberOfPfnReferences</a>;
<a name="l02098"></a><a class="code" href="../../d6/d8/struct__LARGE__CONTROL__AREA.html#o18">02098</a>     ULONG <a class="code" href="../../d6/d8/struct__LARGE__CONTROL__AREA.html#o4">NumberOfMappedViews</a>;
<a name="l02099"></a><a class="code" href="../../d6/d8/struct__LARGE__CONTROL__AREA.html#o19">02099</a>     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> <a class="code" href="../../d6/d8/struct__LARGE__CONTROL__AREA.html#o5">NumberOfSubsections</a>;
02100     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> <a class="code" href="../../d6/d8/struct__LARGE__CONTROL__AREA.html#o6">FlushInProgressCount</a>;
02101     ULONG <a class="code" href="../../d6/d8/struct__LARGE__CONTROL__AREA.html#o7">NumberOfUserReferences</a>;
<a name="l02102"></a><a class="code" href="../../d1/d6/struct__MMSUBSECTION__FLAGS.html">02102</a>     <span class="keyword">union </span>{
<a name="l02103"></a><a class="code" href="../../d1/d6/struct__MMSUBSECTION__FLAGS.html#o0">02103</a>         ULONG LongFlags;
<a name="l02104"></a><a class="code" href="../../d1/d6/struct__MMSUBSECTION__FLAGS.html#o1">02104</a>         <a class="code" href="../../d7/d5/struct__MMSECTION__FLAGS.html">MMSECTION_FLAGS</a> Flags;
<a name="l02105"></a><a class="code" href="../../d1/d6/struct__MMSUBSECTION__FLAGS.html#o2">02105</a>     } u;
<a name="l02106"></a><a class="code" href="../../d1/d6/struct__MMSUBSECTION__FLAGS.html#o3">02106</a>     <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FilePointer;
<a name="l02107"></a><a class="code" href="../../d1/d6/struct__MMSUBSECTION__FLAGS.html#o4">02107</a>     <a class="code" href="../../d4/d8/mi_8h.html#a458">PEVENT_COUNTER</a> WaitingForDeletion;
<a name="l02108"></a><a class="code" href="../../d1/d6/struct__MMSUBSECTION__FLAGS.html#o5">02108</a>     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> ModifiedWriteCount;
<a name="l02109"></a><a class="code" href="../../d1/d6/struct__MMSUBSECTION__FLAGS.html#o6">02109</a>     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> NumberOfSystemCacheViews;
<a name="l02110"></a><a class="code" href="../../d1/d6/struct__MMSUBSECTION__FLAGS.html#o7">02110</a>     SIZE_T PagedPoolUsage;
02111     SIZE_T NonPagedPoolUsage;
02112     LIST_ENTRY UserGlobalList;
<a name="l02113"></a><a class="code" href="../../d1/d7/struct__SUBSECTION.html">02113</a>     ULONG SessionId;
<a name="l02114"></a><a class="code" href="../../d1/d7/struct__SUBSECTION.html#o0">02114</a>     ULONG Pad;
02115 } <a class="code" href="../../d6/d8/struct__LARGE__CONTROL__AREA.html">LARGE_CONTROL_AREA</a>, *<a class="code" href="../../d6/d8/struct__LARGE__CONTROL__AREA.html">PLARGE_CONTROL_AREA</a>;
<a name="l02116"></a><a class="code" href="../../d1/d7/struct__SUBSECTION.html#o1">02116</a> 
<a name="l02117"></a><a class="code" href="../../d1/d7/struct__SUBSECTION.html#o2">02117</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d1/d6/struct__MMSUBSECTION__FLAGS.html">_MMSUBSECTION_FLAGS</a> {
02118     <span class="keywordtype">unsigned</span> ReadOnly : 1;
<a name="l02119"></a><a class="code" href="../../d1/d7/struct__SUBSECTION.html#o4">02119</a>     <span class="keywordtype">unsigned</span> ReadWrite : 1;
<a name="l02120"></a><a class="code" href="../../d1/d7/struct__SUBSECTION.html#o5">02120</a>     <span class="keywordtype">unsigned</span> CopyOnWrite : 1;
<a name="l02121"></a><a class="code" href="../../d1/d7/struct__SUBSECTION.html#o6">02121</a>     <span class="keywordtype">unsigned</span> GlobalMemory: 1;
<a name="l02122"></a><a class="code" href="../../d1/d7/struct__SUBSECTION.html#o7">02122</a>     <span class="keywordtype">unsigned</span> Protection : 5;
<a name="l02123"></a><a class="code" href="../../d1/d7/struct__SUBSECTION.html#o8">02123</a>     <span class="keywordtype">unsigned</span> LargePages : 1;
<a name="l02124"></a><a class="code" href="../../d1/d7/struct__SUBSECTION.html#o9">02124</a>     <span class="keywordtype">unsigned</span> StartingSector4132 : 10;   <span class="comment">// 2 ** (42+12) == 4MB*4GB == 16K TB</span>
02125     <span class="keywordtype">unsigned</span> SectorEndOffset : 12;
02126 } <a class="code" href="../../d1/d6/struct__MMSUBSECTION__FLAGS.html">MMSUBSECTION_FLAGS</a>;
<a name="l02127"></a><a class="code" href="../../d4/d8/mi_8h.html#a218">02127</a> 
02128 <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d1/d7/struct__SUBSECTION.html">_SUBSECTION</a> { <span class="comment">// Must start on quadword boundary and be quad sized</span>
02129     <a class="code" href="../../d4/d8/mi_8h.html#a461">PCONTROL_AREA</a> ControlArea;
02130     <span class="keyword">union </span>{
02131         ULONG LongFlags;
02132         <a class="code" href="../../d1/d6/struct__MMSUBSECTION__FLAGS.html">MMSUBSECTION_FLAGS</a> SubsectionFlags;
02133     } u;
02134     ULONG StartingSector;
02135     ULONG NumberOfFullSectors;  <span class="comment">// (4GB-1) * 4K == 16TB-4K limit per subsection</span>
02136     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> SubsectionBase;
02137     ULONG UnusedPtes;
02138     ULONG PtesInSubsection;
02139     <span class="keyword">struct </span><a class="code" href="../../d1/d7/struct__SUBSECTION.html">_SUBSECTION</a> *NextSubsection;
02140 } <a class="code" href="../../d1/d7/struct__SUBSECTION.html">SUBSECTION</a>, *<a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a>;
02141 
02142 <span class="preprocessor">#define MI_MAXIMUM_SECTION_SIZE ((UINT64)16*1024*1024*1024*1024*1024 - (1&lt;&lt;MM4K_SHIFT))</span>
02143 <span class="preprocessor"></span>
02144 <span class="preprocessor">#if DBG</span>
02145 <span class="preprocessor"></span><a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
02146 MiSubsectionConsistent(
02147     IN PSUBSECTION Subsection
02148     );
02149 <span class="preprocessor">#endif</span>
02150 <span class="preprocessor"></span>
02151 <span class="comment">//++</span>
02152 <span class="comment">//ULONG</span>
02153 <span class="comment">//Mi4KStartForSubsection (</span>
02154 <span class="comment">//    IN PLARGE_INTEGER address,</span>
02155 <span class="comment">//    IN OUT PSUBSECTION subsection</span>
02156 <span class="comment">//    );</span>
02157 <span class="comment">//</span>
02158 <span class="comment">// Routine Description:</span>
02159 <span class="comment">//</span>
02160 <span class="comment">//    This macro sets into the specified subsection the supplied information</span>
<a name="l02161"></a><a class="code" href="../../d4/d8/mi_8h.html#a219">02161</a> <span class="comment">//    indicating the start address (in 4K units) of this portion of the file.</span>
02162 <span class="comment">//</span>
02163 <span class="comment">// Arguments</span>
02164 <span class="comment">//</span>
02165 <span class="comment">//    address - Supplies the 64-bit address (in 4K units) of the start of this</span>
02166 <span class="comment">//              portion of the file.</span>
02167 <span class="comment">//</span>
02168 <span class="comment">//    subsection - Supplies the subsection address to store the address in.</span>
02169 <span class="comment">//</span>
02170 <span class="comment">// Return Value:</span>
02171 <span class="comment">//</span>
02172 <span class="comment">//    None.</span>
02173 <span class="comment">//</span>
02174 <span class="comment">//--</span>
02175 
02176 <span class="preprocessor">#define Mi4KStartForSubsection(address, subsection)  \</span>
02177 <span class="preprocessor">   subsection-&gt;StartingSector = ((PLARGE_INTEGER)address)-&gt;LowPart; \</span>
02178 <span class="preprocessor">   subsection-&gt;u.SubsectionFlags.StartingSector4132 = \</span>
02179 <span class="preprocessor">        (((PLARGE_INTEGER)(address))-&gt;HighPart &amp; 0x3ff);</span>
02180 <span class="preprocessor"></span>
02181 <span class="comment">//++</span>
02182 <span class="comment">//ULONG</span>
02183 <span class="comment">//Mi4KStartFromSubsection (</span>
02184 <span class="comment">//    IN OUT PLARGE_INTEGER address,</span>
02185 <span class="comment">//    IN PSUBSECTION subsection</span>
02186 <span class="comment">//    );</span>
02187 <span class="comment">//</span>
02188 <span class="comment">// Routine Description:</span>
02189 <span class="comment">//</span>
<a name="l02190"></a><a class="code" href="../../d4/d8/mi_8h.html#a220">02190</a> <span class="comment">//    This macro gets the start 4K offset from the specified subsection.</span>
02191 <span class="comment">//</span>
02192 <span class="comment">// Arguments</span>
02193 <span class="comment">//</span>
<a name="l02194"></a><a class="code" href="../../d8/d1/struct__MMDEREFERENCE__SEGMENT__HEADER.html">02194</a> <span class="comment">//    address - Supplies the 64-bit address (in 4K units) to place the</span>
<a name="l02195"></a><a class="code" href="../../d8/d1/struct__MMDEREFERENCE__SEGMENT__HEADER.html#o0">02195</a> <span class="comment">//              start of this subsection into.</span>
<a name="l02196"></a><a class="code" href="../../d8/d1/struct__MMDEREFERENCE__SEGMENT__HEADER.html#o1">02196</a> <span class="comment">//</span>
<a name="l02197"></a><a class="code" href="../../d8/d1/struct__MMDEREFERENCE__SEGMENT__HEADER.html#o2">02197</a> <span class="comment">//    subsection - Supplies the subsection address to get the address from.</span>
02198 <span class="comment">//</span>
02199 <span class="comment">// Return Value:</span>
02200 <span class="comment">//</span>
02201 <span class="comment">//    None.</span>
02202 <span class="comment">//</span>
02203 <span class="comment">//--</span>
02204 
02205 <span class="preprocessor">#define Mi4KStartFromSubsection(address, subsection)  \</span>
02206 <span class="preprocessor">   ((PLARGE_INTEGER)address)-&gt;LowPart = subsection-&gt;StartingSector; \</span>
02207 <span class="preprocessor">   ((PLARGE_INTEGER)address)-&gt;HighPart = subsection-&gt;u.SubsectionFlags.StartingSector4132;</span>
02208 <span class="preprocessor"></span>
<a name="l02209"></a><a class="code" href="../../d1/d3/struct__MMPAGE__FILE__EXPANSION.html">02209</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d8/d1/struct__MMDEREFERENCE__SEGMENT__HEADER.html">_MMDEREFERENCE_SEGMENT_HEADER</a> {
<a name="l02210"></a><a class="code" href="../../d1/d3/struct__MMPAGE__FILE__EXPANSION.html#o0">02210</a>     KSPIN_LOCK Lock;
<a name="l02211"></a><a class="code" href="../../d1/d3/struct__MMPAGE__FILE__EXPANSION.html#o1">02211</a>     <a class="code" href="../../d8/d7/struct__KSEMAPHORE.html">KSEMAPHORE</a> Semaphore;
<a name="l02212"></a><a class="code" href="../../d1/d3/struct__MMPAGE__FILE__EXPANSION.html#o2">02212</a>     LIST_ENTRY ListHead;
<a name="l02213"></a><a class="code" href="../../d1/d3/struct__MMPAGE__FILE__EXPANSION.html#o3">02213</a> } <a class="code" href="../../d8/d1/struct__MMDEREFERENCE__SEGMENT__HEADER.html">MMDEREFERENCE_SEGMENT_HEADER</a>;
<a name="l02214"></a><a class="code" href="../../d1/d3/struct__MMPAGE__FILE__EXPANSION.html#o4">02214</a> 
<a name="l02215"></a><a class="code" href="../../d1/d3/struct__MMPAGE__FILE__EXPANSION.html#o5">02215</a> <span class="comment">//</span>
<a name="l02216"></a><a class="code" href="../../d1/d3/struct__MMPAGE__FILE__EXPANSION.html#o6">02216</a> <span class="comment">// This entry is used for calling the segment dereference thread</span>
02217 <span class="comment">// to perform page file expansion.  It has a similar structure</span>
02218 <span class="comment">// to a control area to allow either a control area or a page file</span>
<a name="l02219"></a><a class="code" href="../../d4/d8/mi_8h.html#a221">02219</a> <span class="comment">// expansion entry to be placed on the list.  Note that for a control</span>
02220 <span class="comment">// area the segment pointer is valid whereas for page file expansion</span>
<a name="l02221"></a><a class="code" href="../../d7/d7/struct__MMWORKING__SET__EXPANSION__HEAD.html">02221</a> <span class="comment">// it is null.</span>
<a name="l02222"></a><a class="code" href="../../d7/d7/struct__MMWORKING__SET__EXPANSION__HEAD.html#o0">02222</a> <span class="comment">//</span>
02223 
02224 <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d1/d3/struct__MMPAGE__FILE__EXPANSION.html">_MMPAGE_FILE_EXPANSION</a> {
<a name="l02225"></a><a class="code" href="../../d4/d8/mi_8h.html#a222">02225</a>     <a class="code" href="../../d4/d8/mi_8h.html#a456">PSEGMENT</a> Segment;
<a name="l02226"></a><a class="code" href="../../d4/d8/mi_8h.html#a223">02226</a>     LIST_ENTRY DereferenceList;
<a name="l02227"></a><a class="code" href="../../d4/d8/mi_8h.html#a224">02227</a>     SIZE_T RequestedExpansionSize;
<a name="l02228"></a><a class="code" href="../../d4/d8/mi_8h.html#a225">02228</a>     SIZE_T ActualExpansion;
02229     <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> Event;
<a name="l02230"></a><a class="code" href="../../d1/d2/struct__MMFLUSH__BLOCK.html">02230</a>     ULONG InProgress;
<a name="l02231"></a><a class="code" href="../../d1/d2/struct__MMFLUSH__BLOCK.html#o0">02231</a>     ULONG PageFileNumber;
<a name="l02232"></a><a class="code" href="../../d1/d2/struct__MMFLUSH__BLOCK.html#o1">02232</a> } <a class="code" href="../../d1/d3/struct__MMPAGE__FILE__EXPANSION.html">MMPAGE_FILE_EXPANSION</a>, *<a class="code" href="../../d1/d3/struct__MMPAGE__FILE__EXPANSION.html">PMMPAGE_FILE_EXPANSION</a>;
<a name="l02233"></a><a class="code" href="../../d1/d2/struct__MMFLUSH__BLOCK.html#o2">02233</a> 
<a name="l02234"></a><a class="code" href="../../d1/d2/struct__MMFLUSH__BLOCK.html#o3">02234</a> <span class="preprocessor">#define MI_EXTEND_ANY_PAGEFILE      ((ULONG)-1)</span>
02235 <span class="preprocessor"></span>
02236 <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d7/d7/struct__MMWORKING__SET__EXPANSION__HEAD.html">_MMWORKING_SET_EXPANSION_HEAD</a> {
<a name="l02237"></a><a class="code" href="../../d4/d2/struct__MMINPAGE__SUPPORT.html">02237</a>     LIST_ENTRY ListHead;
<a name="l02238"></a><a class="code" href="../../d4/d2/struct__MMINPAGE__SUPPORT.html#o0">02238</a> } <a class="code" href="../../d7/d7/struct__MMWORKING__SET__EXPANSION__HEAD.html">MMWORKING_SET_EXPANSION_HEAD</a>;
<a name="l02239"></a><a class="code" href="../../d4/d2/struct__MMINPAGE__SUPPORT.html#o1">02239</a> 
<a name="l02240"></a><a class="code" href="../../d4/d2/struct__MMINPAGE__SUPPORT.html#o2">02240</a> <span class="preprocessor">#define SUBSECTION_READ_ONLY      1L</span>
<a name="l02241"></a><a class="code" href="../../d4/d2/struct__MMINPAGE__SUPPORT.html#o3">02241</a> <span class="preprocessor"></span><span class="preprocessor">#define SUBSECTION_READ_WRITE     2L</span>
02242 <span class="preprocessor"></span><span class="preprocessor">#define SUBSECTION_COPY_ON_WRITE  4L</span>
02243 <span class="preprocessor"></span><span class="preprocessor">#define SUBSECTION_SHARE_ALLOW    8L</span>
02244 <span class="preprocessor"></span>
02245 <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d1/d2/struct__MMFLUSH__BLOCK.html">_MMFLUSH_BLOCK</a> {
<a name="l02246"></a><a class="code" href="../../d4/d2/struct__MMINPAGE__SUPPORT.html#o4">02246</a>     LARGE_INTEGER ErrorOffset;
<a name="l02247"></a><a class="code" href="../../d4/d2/struct__MMINPAGE__SUPPORT.html#o5">02247</a>     IO_STATUS_BLOCK IoStatus;
02248     <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> IoEvent;
<a name="l02249"></a><a class="code" href="../../d4/d2/struct__MMINPAGE__SUPPORT.html#o7">02249</a>     ULONG IoCount;
<a name="l02250"></a><a class="code" href="../../d4/d2/struct__MMINPAGE__SUPPORT.html#o8">02250</a> } <a class="code" href="../../d1/d2/struct__MMFLUSH__BLOCK.html">MMFLUSH_BLOCK</a>, *<a class="code" href="../../d1/d2/struct__MMFLUSH__BLOCK.html">PMMFLUSH_BLOCK</a>;
<a name="l02251"></a><a class="code" href="../../d4/d2/struct__MMINPAGE__SUPPORT.html#o9">02251</a> 
<a name="l02252"></a><a class="code" href="../../d4/d2/struct__MMINPAGE__SUPPORT.html#o10">02252</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d4/d2/struct__MMINPAGE__SUPPORT.html">_MMINPAGE_SUPPORT</a> {
<a name="l02253"></a><a class="code" href="../../d4/d2/struct__MMINPAGE__SUPPORT.html#o11">02253</a>     <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> <a class="code" href="../../d4/d2/struct__MMINPAGE__SUPPORT.html#o0">Event</a>;
<a name="l02254"></a><a class="code" href="../../d4/d2/struct__MMINPAGE__SUPPORT.html#o12">02254</a>     IO_STATUS_BLOCK <a class="code" href="../../d4/d2/struct__MMINPAGE__SUPPORT.html#o1">IoStatus</a>;
<a name="l02255"></a><a class="code" href="../../d4/d2/struct__MMINPAGE__SUPPORT.html#o13">02255</a>     LARGE_INTEGER <a class="code" href="../../d4/d2/struct__MMINPAGE__SUPPORT.html#o2">ReadOffset</a>;
02256     ULONG <a class="code" href="../../d4/d2/struct__MMINPAGE__SUPPORT.html#o3">WaitCount</a>;
02257 <span class="preprocessor">#if defined (_WIN64)</span>
02258 <span class="preprocessor"></span>    ULONG UsedPageTableEntries;
02259 <span class="preprocessor">#endif</span>
02260 <span class="preprocessor"></span>    <span class="keyword">union </span>{
02261         <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> <a class="code" href="../../d4/d2/struct__MMINPAGE__SUPPORT.html#o4">Thread</a>;
02262         <a class="code" href="../../d4/d8/mi_8h.html#a472">PMMFLUSH_BLOCK</a> <a class="code" href="../../d4/d2/struct__MMINPAGE__SUPPORT.html#o5">Flush</a>;
02263     } u;
02264     <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FilePointer;
<a name="l02265"></a><a class="code" href="../../d2/d3/struct__MMPAGE__READ.html">02265</a>     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> BasePte;
<a name="l02266"></a><a class="code" href="../../d2/d3/struct__MMPAGE__READ.html#o0">02266</a>     <a class="code" href="../../d4/d8/mi_8h.html#a439">PMMPFN</a> Pfn;
<a name="l02267"></a><a class="code" href="../../d2/d3/struct__MMPAGE__READ.html#o1">02267</a>     LOGICAL Completed;
<a name="l02268"></a><a class="code" href="../../d2/d3/struct__MMPAGE__READ.html#o2">02268</a>     <a class="code" href="../../d6/d7/struct__MDL.html">MDL</a> Mdl;
<a name="l02269"></a><a class="code" href="../../d2/d3/struct__MMPAGE__READ.html#o3">02269</a>     PFN_NUMBER Page[<a class="code" href="../../d2/d1/mm_8h.html#a2">MM_MAXIMUM_READ_CLUSTER_SIZE</a> + 1];
<a name="l02270"></a><a class="code" href="../../d2/d3/struct__MMPAGE__READ.html#o4">02270</a>     LIST_ENTRY ListEntry;
<a name="l02271"></a><a class="code" href="../../d2/d3/struct__MMPAGE__READ.html#o5">02271</a> <span class="preprocessor">#if defined (_PREFETCH_)</span>
02272 <span class="preprocessor"></span>    <a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a> PrefetchMdl;
02273 <span class="preprocessor">#endif</span>
02274 <span class="preprocessor"></span>} <a class="code" href="../../d4/d2/struct__MMINPAGE__SUPPORT.html">MMINPAGE_SUPPORT</a>, *<a class="code" href="../../d4/d2/struct__MMINPAGE__SUPPORT.html">PMMINPAGE_SUPPORT</a>;
02275 
02276 <span class="preprocessor">#if defined (_PREFETCH_)</span>
02277 <span class="preprocessor"></span><span class="preprocessor">#define MI_PF_DUMMY_PAGE_PTE ((PMMPTE)0x23452345)</span>
<a name="l02278"></a><a class="code" href="../../d9/d0/struct__MMADDRESS__NODE.html">02278</a> <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l02279"></a><a class="code" href="../../d9/d0/struct__MMADDRESS__NODE.html#o0">02279</a> <span class="preprocessor"></span>
<a name="l02280"></a><a class="code" href="../../d9/d0/struct__MMADDRESS__NODE.html#o1">02280</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d2/d3/struct__MMPAGE__READ.html">_MMPAGE_READ</a> {
<a name="l02281"></a><a class="code" href="../../d9/d0/struct__MMADDRESS__NODE.html#o2">02281</a>     LARGE_INTEGER ReadOffset;
<a name="l02282"></a><a class="code" href="../../d9/d0/struct__MMADDRESS__NODE.html#o3">02282</a>     <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FilePointer;
<a name="l02283"></a><a class="code" href="../../d9/d0/struct__MMADDRESS__NODE.html#o4">02283</a>     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> BasePte;
02284     <a class="code" href="../../d4/d8/mi_8h.html#a439">PMMPFN</a> Pfn;
02285     <a class="code" href="../../d6/d7/struct__MDL.html">MDL</a> Mdl;
<a name="l02286"></a><a class="code" href="../../d5/d0/struct__SECTION.html">02286</a>     PFN_NUMBER Page[<a class="code" href="../../d2/d1/mm_8h.html#a2">MM_MAXIMUM_READ_CLUSTER_SIZE</a> + 1];
<a name="l02287"></a><a class="code" href="../../d5/d0/struct__SECTION.html#o0">02287</a> } <a class="code" href="../../d2/d3/struct__MMPAGE__READ.html">MMPAGE_READ</a>, *<a class="code" href="../../d2/d3/struct__MMPAGE__READ.html">PMMPAGE_READ</a>;
<a name="l02288"></a><a class="code" href="../../d5/d0/struct__SECTION.html#o1">02288</a> 
<a name="l02289"></a><a class="code" href="../../d5/d0/struct__SECTION.html#o2">02289</a> <span class="comment">//</span>
02290 <span class="comment">// Address Node.</span>
<a name="l02291"></a><a class="code" href="../../d5/d0/struct__SECTION.html#o3">02291</a> <span class="comment">//</span>
<a name="l02292"></a><a class="code" href="../../d5/d0/struct__SECTION.html#o4">02292</a> 
02293 <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d9/d0/struct__MMADDRESS__NODE.html">_MMADDRESS_NODE</a> {
<a name="l02294"></a><a class="code" href="../../d5/d0/struct__SECTION.html#o6">02294</a>     ULONG_PTR StartingVpn;
02295     ULONG_PTR EndingVpn;
02296     <span class="keyword">struct </span><a class="code" href="../../d9/d0/struct__MMADDRESS__NODE.html">_MMADDRESS_NODE</a> *Parent;
02297     <span class="keyword">struct </span><a class="code" href="../../d9/d0/struct__MMADDRESS__NODE.html">_MMADDRESS_NODE</a> *LeftChild;
02298     <span class="keyword">struct </span><a class="code" href="../../d9/d0/struct__MMADDRESS__NODE.html">_MMADDRESS_NODE</a> *RightChild;
02299 } <a class="code" href="../../d9/d0/struct__MMADDRESS__NODE.html">MMADDRESS_NODE</a>, *<a class="code" href="../../d9/d0/struct__MMADDRESS__NODE.html">PMMADDRESS_NODE</a>;
02300 
02301 <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d5/d0/struct__SECTION.html">_SECTION</a> {
02302     <a class="code" href="../../d9/d0/struct__MMADDRESS__NODE.html">MMADDRESS_NODE</a> Address;
<a name="l02303"></a><a class="code" href="../../d0/d1/struct__MMBANKED__SECTION.html">02303</a>     <a class="code" href="../../d4/d8/mi_8h.html#a456">PSEGMENT</a> Segment;
<a name="l02304"></a><a class="code" href="../../d0/d1/struct__MMBANKED__SECTION.html#o0">02304</a>     LARGE_INTEGER SizeOfSection;
<a name="l02305"></a><a class="code" href="../../d0/d1/struct__MMBANKED__SECTION.html#o1">02305</a>     <span class="keyword">union </span>{
<a name="l02306"></a><a class="code" href="../../d0/d1/struct__MMBANKED__SECTION.html#o2">02306</a>         ULONG LongFlags;
<a name="l02307"></a><a class="code" href="../../d0/d1/struct__MMBANKED__SECTION.html#o3">02307</a>         <a class="code" href="../../d7/d5/struct__MMSECTION__FLAGS.html">MMSECTION_FLAGS</a> Flags;
<a name="l02308"></a><a class="code" href="../../d0/d1/struct__MMBANKED__SECTION.html#o4">02308</a>     } u;
<a name="l02309"></a><a class="code" href="../../d0/d1/struct__MMBANKED__SECTION.html#o5">02309</a>     ULONG InitialPageProtection;
<a name="l02310"></a><a class="code" href="../../d0/d1/struct__MMBANKED__SECTION.html#o6">02310</a> } <a class="code" href="../../d5/d0/struct__SECTION.html">SECTION</a>, *<a class="code" href="../../d5/d3/parseini_8c.html#a2">PSECTION</a>;
<a name="l02311"></a><a class="code" href="../../d0/d1/struct__MMBANKED__SECTION.html#o7">02311</a> 
02312 <span class="comment">//</span>
02313 <span class="comment">// Banked memory descriptor.  Pointed to by VAD which has</span>
02314 <span class="comment">// the PhysicalMemory flags set and the Banked pointer field as</span>
02315 <span class="comment">// non-NULL.</span>
02316 <span class="comment">//</span>
02317 
02318 <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d0/d1/struct__MMBANKED__SECTION.html">_MMBANKED_SECTION</a> {
02319     PFN_NUMBER <a class="code" href="../../d0/d1/struct__MMBANKED__SECTION.html#o0">BasePhysicalPage</a>;
02320     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> <a class="code" href="../../d0/d1/struct__MMBANKED__SECTION.html#o1">BasedPte</a>;
02321     ULONG <a class="code" href="../../d0/d1/struct__MMBANKED__SECTION.html#o2">BankSize</a>;
02322     ULONG <a class="code" href="../../d0/d1/struct__MMBANKED__SECTION.html#o3">BankShift</a>; <span class="comment">//shift for PTEs to calculate bank number</span>
02323     <a class="code" href="../../d2/d1/mm_8h.html#a162">PBANKED_SECTION_ROUTINE</a> <a class="code" href="../../d0/d1/struct__MMBANKED__SECTION.html#o4">BankedRoutine</a>;
02324     PVOID <a class="code" href="../../d0/d1/struct__MMBANKED__SECTION.html#o5">Context</a>;
02325     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> <a class="code" href="../../d0/d1/struct__MMBANKED__SECTION.html#o6">CurrentMappedPte</a>;
02326     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> <a class="code" href="../../d0/d1/struct__MMBANKED__SECTION.html#o7">BankTemplate</a>[1];
02327 } <a class="code" href="../../d0/d1/struct__MMBANKED__SECTION.html">MMBANKED_SECTION</a>, *<a class="code" href="../../d0/d1/struct__MMBANKED__SECTION.html">PMMBANKED_SECTION</a>;
02328 
02329 
02330 <span class="comment">//</span>
<a name="l02331"></a><a class="code" href="../../d4/d8/mi_8h.html#a226">02331</a> <span class="comment">// Virtual address descriptor</span>
02332 <span class="comment">//</span>
02333 <span class="comment">// ***** NOTE **********</span>
02334 <span class="comment">//  The first part of a virtual address descriptor is a MMADDRESS_NODE!!!</span>
02335 <span class="comment">//</span>
02336 
02337 <span class="preprocessor">#if defined (_WIN64)</span>
<a name="l02338"></a><a class="code" href="../../d4/d8/mi_8h.html#a227">02338</a> <span class="preprocessor"></span>
02339 <span class="preprocessor">#define COMMIT_SIZE 51</span>
<a name="l02340"></a><a class="code" href="../../d4/d8/mi_8h.html#a228">02340</a> <span class="preprocessor"></span>
<a name="l02341"></a><a class="code" href="../../d4/d8/mi_8h.html#a229">02341</a> <span class="preprocessor">#if ((COMMIT_SIZE + PAGE_SHIFT) &lt; 63)</span>
02342 <span class="preprocessor"></span><span class="preprocessor">#error COMMIT_SIZE too small</span>
<a name="l02343"></a><a class="code" href="../../d1/d7/struct__MMVAD__FLAGS.html">02343</a> <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l02344"></a><a class="code" href="../../d1/d7/struct__MMVAD__FLAGS.html#o0">02344</a> <span class="preprocessor"></span>
<a name="l02345"></a><a class="code" href="../../d1/d7/struct__MMVAD__FLAGS.html#o1">02345</a> <span class="preprocessor">#else</span>
<a name="l02346"></a><a class="code" href="../../d1/d7/struct__MMVAD__FLAGS.html#o2">02346</a> <span class="preprocessor"></span><span class="preprocessor">#define COMMIT_SIZE 19</span>
<a name="l02347"></a><a class="code" href="../../d1/d7/struct__MMVAD__FLAGS.html#o3">02347</a> <span class="preprocessor"></span>
<a name="l02348"></a><a class="code" href="../../d1/d7/struct__MMVAD__FLAGS.html#o4">02348</a> <span class="preprocessor">#if ((COMMIT_SIZE + PAGE_SHIFT) &lt; 31)</span>
<a name="l02349"></a><a class="code" href="../../d1/d7/struct__MMVAD__FLAGS.html#o5">02349</a> <span class="preprocessor"></span><span class="preprocessor">#error COMMIT_SIZE too small</span>
<a name="l02350"></a><a class="code" href="../../d1/d7/struct__MMVAD__FLAGS.html#o6">02350</a> <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l02351"></a><a class="code" href="../../d1/d7/struct__MMVAD__FLAGS.html#o7">02351</a> <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l02352"></a><a class="code" href="../../d1/d7/struct__MMVAD__FLAGS.html#o8">02352</a> <span class="preprocessor"></span>
<a name="l02353"></a><a class="code" href="../../d1/d7/struct__MMVAD__FLAGS.html#o9">02353</a> <span class="preprocessor">#define MM_MAX_COMMIT (((ULONG_PTR) 1 &lt;&lt; COMMIT_SIZE) - 1)</span>
02354 <span class="preprocessor"></span>
02355 <span class="preprocessor">#define MM_VIEW_UNMAP 0</span>
<a name="l02356"></a><a class="code" href="../../d2/d7/struct__MMVAD__FLAGS2.html">02356</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_VIEW_SHARE 1</span>
<a name="l02357"></a><a class="code" href="../../d2/d7/struct__MMVAD__FLAGS2.html#o0">02357</a> <span class="preprocessor"></span>
<a name="l02358"></a><a class="code" href="../../d2/d7/struct__MMVAD__FLAGS2.html#o1">02358</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d1/d7/struct__MMVAD__FLAGS.html">_MMVAD_FLAGS</a> {
<a name="l02359"></a><a class="code" href="../../d2/d7/struct__MMVAD__FLAGS2.html#o2">02359</a>     ULONG_PTR CommitCharge : <a class="code" href="../../d4/d8/mi_8h.html#a226">COMMIT_SIZE</a>; <span class="comment">//limits system to 4k pages or bigger!</span>
<a name="l02360"></a><a class="code" href="../../d2/d7/struct__MMVAD__FLAGS2.html#o3">02360</a>     ULONG_PTR PhysicalMapping : 1;
<a name="l02361"></a><a class="code" href="../../d2/d7/struct__MMVAD__FLAGS2.html#o4">02361</a>     ULONG_PTR ImageMap : 1;
<a name="l02362"></a><a class="code" href="../../d2/d7/struct__MMVAD__FLAGS2.html#o5">02362</a>     ULONG_PTR UserPhysicalPages : 1;
<a name="l02363"></a><a class="code" href="../../d2/d7/struct__MMVAD__FLAGS2.html#o6">02363</a>     ULONG_PTR NoChange : 1;
<a name="l02364"></a><a class="code" href="../../d2/d7/struct__MMVAD__FLAGS2.html#o7">02364</a>     ULONG_PTR WriteWatch : 1;
<a name="l02365"></a><a class="code" href="../../d2/d7/struct__MMVAD__FLAGS2.html#o8">02365</a>     ULONG_PTR Protection : 5;
02366     ULONG_PTR LargePages : 1;
02367     ULONG_PTR MemCommit: 1;
<a name="l02368"></a><a class="code" href="../../d8/d0/struct__MMADDRESS__LIST.html">02368</a>     ULONG_PTR PrivateMemory : 1;    <span class="comment">//used to tell VAD from VAD_SHORT</span>
<a name="l02369"></a><a class="code" href="../../d8/d0/struct__MMADDRESS__LIST.html#o0">02369</a> } <a class="code" href="../../d1/d7/struct__MMVAD__FLAGS.html">MMVAD_FLAGS</a>;
<a name="l02370"></a><a class="code" href="../../d8/d0/struct__MMADDRESS__LIST.html#o1">02370</a> 
02371 <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d2/d7/struct__MMVAD__FLAGS2.html">_MMVAD_FLAGS2</a> {
02372     <span class="keywordtype">unsigned</span> FileOffset : 24;        <span class="comment">// number of 64k units into file</span>
<a name="l02373"></a><a class="code" href="../../d8/d5/struct__MMSECURE__ENTRY.html">02373</a>     <span class="keywordtype">unsigned</span> SecNoChange : 1;        <span class="comment">// set if SEC_NOCHANGE specified</span>
02374     <span class="keywordtype">unsigned</span> OneSecured : 1;         <span class="comment">// set if u3 field is a range</span>
<a name="l02375"></a><a class="code" href="../../d8/d5/struct__MMSECURE__ENTRY.html#o0">02375</a>     <span class="keywordtype">unsigned</span> MultipleSecured : 1;    <span class="comment">// set if u3 field is a list head</span>
<a name="l02376"></a><a class="code" href="../../d8/d5/struct__MMSECURE__ENTRY.html#o1">02376</a>     <span class="keywordtype">unsigned</span> ReadOnly : 1;           <span class="comment">// protected as ReadOnly</span>
02377     <span class="keywordtype">unsigned</span> StoredInVad : 1;        <span class="comment">// set if secure is stored in VAD</span>
<a name="l02378"></a><a class="code" href="../../d8/d5/struct__MMSECURE__ENTRY.html#o3">02378</a>     <span class="keywordtype">unsigned</span> ExtendableFile : 1;
<a name="l02379"></a><a class="code" href="../../d8/d5/struct__MMSECURE__ENTRY.html#o4">02379</a>     <span class="keywordtype">unsigned</span> Inherit : 1; <span class="comment">//1 = ViewShare, 0 = ViewUnmap</span>
<a name="l02380"></a><a class="code" href="../../d8/d5/struct__MMSECURE__ENTRY.html#o5">02380</a>     <span class="keywordtype">unsigned</span> CopyOnWrite : 1;
02381 } <a class="code" href="../../d2/d7/struct__MMVAD__FLAGS2.html">MMVAD_FLAGS2</a>;
02382 
<a name="l02383"></a><a class="code" href="../../d6/d6/struct__MMVAD.html">02383</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d8/d0/struct__MMADDRESS__LIST.html">_MMADDRESS_LIST</a> {
<a name="l02384"></a><a class="code" href="../../d6/d6/struct__MMVAD.html#o0">02384</a>     ULONG_PTR StartVpn;
<a name="l02385"></a><a class="code" href="../../d6/d6/struct__MMVAD.html#o1">02385</a>     ULONG_PTR EndVpn;
<a name="l02386"></a><a class="code" href="../../d6/d6/struct__MMVAD.html#o2">02386</a> } <a class="code" href="../../d8/d0/struct__MMADDRESS__LIST.html">MMADDRESS_LIST</a>, *<a class="code" href="../../d8/d0/struct__MMADDRESS__LIST.html">PMMADDRESS_LIST</a>;
<a name="l02387"></a><a class="code" href="../../d6/d6/struct__MMVAD.html#o3">02387</a> 
<a name="l02388"></a><a class="code" href="../../d6/d6/struct__MMVAD.html#o4">02388</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d8/d5/struct__MMSECURE__ENTRY.html">_MMSECURE_ENTRY</a> {
02389     <span class="keyword">union </span>{
<a name="l02390"></a><a class="code" href="../../d6/d6/struct__MMVAD.html#o5">02390</a>         ULONG_PTR LongFlags2;
<a name="l02391"></a><a class="code" href="../../d6/d6/struct__MMVAD.html#o6">02391</a>         <a class="code" href="../../d2/d7/struct__MMVAD__FLAGS2.html">MMVAD_FLAGS2</a> VadFlags2;
02392     } u2;
<a name="l02393"></a><a class="code" href="../../d6/d6/struct__MMVAD.html#o8">02393</a>     ULONG_PTR StartVpn;
<a name="l02394"></a><a class="code" href="../../d6/d6/struct__MMVAD.html#o9">02394</a>     ULONG_PTR EndVpn;
<a name="l02395"></a><a class="code" href="../../d6/d6/struct__MMVAD.html#o10">02395</a>     LIST_ENTRY List;
02396 } <a class="code" href="../../d8/d5/struct__MMSECURE__ENTRY.html">MMSECURE_ENTRY</a>, *<a class="code" href="../../d8/d5/struct__MMSECURE__ENTRY.html">PMMSECURE_ENTRY</a>;
<a name="l02397"></a><a class="code" href="../../d6/d6/struct__MMVAD.html#o11">02397</a> 
<a name="l02398"></a><a class="code" href="../../d6/d6/struct__MMVAD.html#o12">02398</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d6/d6/struct__MMVAD.html">_MMVAD</a> {
02399     ULONG_PTR <a class="code" href="../../d6/d6/struct__MMVAD.html#o0">StartingVpn</a>;
02400     ULONG_PTR <a class="code" href="../../d6/d6/struct__MMVAD.html#o1">EndingVpn</a>;
<a name="l02401"></a><a class="code" href="../../d6/d6/struct__MMVAD.html#o14">02401</a>     <span class="keyword">struct </span><a class="code" href="../../d6/d6/struct__MMVAD.html">_MMVAD</a> *<a class="code" href="../../d6/d6/struct__MMVAD.html#o2">Parent</a>;
<a name="l02402"></a><a class="code" href="../../d6/d6/struct__MMVAD.html#o15">02402</a>     <span class="keyword">struct </span><a class="code" href="../../d6/d6/struct__MMVAD.html">_MMVAD</a> *<a class="code" href="../../d6/d6/struct__MMVAD.html#o3">LeftChild</a>;
02403     <span class="keyword">struct </span><a class="code" href="../../d6/d6/struct__MMVAD.html">_MMVAD</a> *<a class="code" href="../../d6/d6/struct__MMVAD.html#o4">RightChild</a>;
02404     <span class="keyword">union </span>{
<a name="l02405"></a><a class="code" href="../../d6/d6/struct__MMVAD.html#o17">02405</a>         ULONG_PTR LongFlags;
<a name="l02406"></a><a class="code" href="../../d6/d6/struct__MMVAD.html#o18">02406</a>         <a class="code" href="../../d1/d7/struct__MMVAD__FLAGS.html">MMVAD_FLAGS</a> VadFlags;
02407     } u;
02408     <a class="code" href="../../d4/d8/mi_8h.html#a461">PCONTROL_AREA</a> ControlArea;
02409     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> FirstPrototypePte;
02410     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastContiguousPte;
<a name="l02411"></a><a class="code" href="../../d3/d7/struct__MMVAD__SHORT.html">02411</a>     <span class="keyword">union </span>{
<a name="l02412"></a><a class="code" href="../../d3/d7/struct__MMVAD__SHORT.html#o0">02412</a>         ULONG LongFlags2;
<a name="l02413"></a><a class="code" href="../../d3/d7/struct__MMVAD__SHORT.html#o1">02413</a>         <a class="code" href="../../d2/d7/struct__MMVAD__FLAGS2.html">MMVAD_FLAGS2</a> VadFlags2;
<a name="l02414"></a><a class="code" href="../../d3/d7/struct__MMVAD__SHORT.html#o2">02414</a>     } u2;
<a name="l02415"></a><a class="code" href="../../d3/d7/struct__MMVAD__SHORT.html#o3">02415</a>     <span class="keyword">union </span>{
<a name="l02416"></a><a class="code" href="../../d3/d7/struct__MMVAD__SHORT.html#o4">02416</a>         LIST_ENTRY List;
02417         <a class="code" href="../../d8/d0/struct__MMADDRESS__LIST.html">MMADDRESS_LIST</a> Secured;
<a name="l02418"></a><a class="code" href="../../d3/d7/struct__MMVAD__SHORT.html#o5">02418</a>     } u3;
<a name="l02419"></a><a class="code" href="../../d3/d7/struct__MMVAD__SHORT.html#o6">02419</a>     <span class="keyword">union </span>{
02420         <a class="code" href="../../d4/d8/mi_8h.html#a482">PMMBANKED_SECTION</a> Banked;
02421         <a class="code" href="../../d4/d8/mi_8h.html#a454">PMMEXTEND_INFO</a> ExtendedInfo;
02422     } u4;
<a name="l02423"></a><a class="code" href="../../d4/d8/mi_8h.html#a230">02423</a> } <a class="code" href="../../d6/d6/struct__MMVAD.html">MMVAD</a>, *<a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a>;
02424 
<a name="l02425"></a><a class="code" href="../../d3/d9/struct__MI__PHYSICAL__VIEW.html">02425</a> 
<a name="l02426"></a><a class="code" href="../../d3/d9/struct__MI__PHYSICAL__VIEW.html#o0">02426</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d3/d7/struct__MMVAD__SHORT.html">_MMVAD_SHORT</a> {
<a name="l02427"></a><a class="code" href="../../d3/d9/struct__MI__PHYSICAL__VIEW.html#o1">02427</a>     ULONG_PTR StartingVpn;
<a name="l02428"></a><a class="code" href="../../d3/d9/struct__MI__PHYSICAL__VIEW.html#o2">02428</a>     ULONG_PTR EndingVpn;
<a name="l02429"></a><a class="code" href="../../d3/d9/struct__MI__PHYSICAL__VIEW.html#o3">02429</a>     <span class="keyword">struct </span><a class="code" href="../../d6/d6/struct__MMVAD.html">_MMVAD</a> *Parent;
<a name="l02430"></a><a class="code" href="../../d3/d9/struct__MI__PHYSICAL__VIEW.html#o4">02430</a>     <span class="keyword">struct </span><a class="code" href="../../d6/d6/struct__MMVAD.html">_MMVAD</a> *LeftChild;
02431     <span class="keyword">struct </span><a class="code" href="../../d6/d6/struct__MMVAD.html">_MMVAD</a> *RightChild;
02432     <span class="keyword">union </span>{
<a name="l02433"></a><a class="code" href="../../d4/d8/mi_8h.html#a231">02433</a>         ULONG_PTR LongFlags;
<a name="l02434"></a><a class="code" href="../../d4/d8/mi_8h.html#a232">02434</a>         <a class="code" href="../../d1/d7/struct__MMVAD__FLAGS.html">MMVAD_FLAGS</a> VadFlags;
02435     } u;
02436 } <a class="code" href="../../d3/d7/struct__MMVAD__SHORT.html">MMVAD_SHORT</a>, *<a class="code" href="../../d3/d7/struct__MMVAD__SHORT.html">PMMVAD_SHORT</a>;
02437 
02438 <span class="preprocessor">#define MI_GET_PROTECTION_FROM_VAD(_Vad) ((ULONG)(_Vad)-&gt;u.VadFlags.Protection)</span>
02439 <span class="preprocessor"></span>
<a name="l02440"></a><a class="code" href="../../d4/d8/mi_8h.html#a495">02440</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d3/d9/struct__MI__PHYSICAL__VIEW.html">_MI_PHYSICAL_VIEW</a> {
02441     LIST_ENTRY ListEntry;
02442     <a class="code" href="../../d4/d8/mi_8h.html#a490">PMMVAD</a> Vad;
02443     PCHAR StartVa;
02444     PCHAR EndVa;
02445     PRTL_BITMAP <a class="code" href="../../d2/d1/structBitMap.html">BitMap</a>;   <span class="comment">// Only initialized if Vad-&gt;u.VadFlags.WriteWatch == 1</span>
02446 } <a class="code" href="../../d3/d9/struct__MI__PHYSICAL__VIEW.html">MI_PHYSICAL_VIEW</a>, *<a class="code" href="../../d3/d9/struct__MI__PHYSICAL__VIEW.html">PMI_PHYSICAL_VIEW</a>;
02447 
02448 <span class="preprocessor">#define MI_PHYSICAL_VIEW_KEY 'vpmM'</span>
02449 <span class="preprocessor"></span><span class="preprocessor">#define MI_WRITEWATCH_VIEW_KEY 'wWmM'</span>
02450 <span class="preprocessor"></span>
02451 <span class="comment">//</span>
02452 <span class="comment">// Stuff for support of Write Watch.</span>
02453 <span class="comment">//</span>
02454 
02455 <span class="keyword">extern</span> ULONG_PTR <a class="code" href="../../d4/d8/mi_8h.html#a495">MiActiveWriteWatch</a>;
02456 
02457 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02458"></a><a class="code" href="../../d1/d1/struct__MMCLONE__BLOCK.html">02458</a> <a class="code" href="../../d4/d8/mi_8h.html#a772">MiCaptureWriteWatchDirtyBit</a> (
<a name="l02459"></a><a class="code" href="../../d1/d1/struct__MMCLONE__BLOCK.html#o0">02459</a>     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process,
<a name="l02460"></a><a class="code" href="../../d1/d1/struct__MMCLONE__BLOCK.html#o1">02460</a>     IN PVOID VirtualAddress
02461     );
02462 
<a name="l02463"></a><a class="code" href="../../d4/d8/mi_8h.html#a497">02463</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
02464 <a class="code" href="../../d4/d8/mi_8h.html#a773">MiMarkProcessAsWriteWatch</a> (
<a name="l02465"></a><a class="code" href="../../d3/d1/struct__MMCLONE__HEADER.html">02465</a>     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process
<a name="l02466"></a><a class="code" href="../../d3/d1/struct__MMCLONE__HEADER.html#o0">02466</a>     );
<a name="l02467"></a><a class="code" href="../../d3/d1/struct__MMCLONE__HEADER.html#o1">02467</a> 
<a name="l02468"></a><a class="code" href="../../d3/d1/struct__MMCLONE__HEADER.html#o2">02468</a> <span class="comment">//</span>
02469 <span class="comment">// Stuff for support of POSIX Fork.</span>
02470 <span class="comment">//</span>
02471 
<a name="l02472"></a><a class="code" href="../../d2/d1/struct__MMCLONE__DESCRIPTOR.html">02472</a> 
<a name="l02473"></a><a class="code" href="../../d2/d1/struct__MMCLONE__DESCRIPTOR.html#o0">02473</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d1/d1/struct__MMCLONE__BLOCK.html">_MMCLONE_BLOCK</a> {
<a name="l02474"></a><a class="code" href="../../d2/d1/struct__MMCLONE__DESCRIPTOR.html#o1">02474</a>     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> ProtoPte;
<a name="l02475"></a><a class="code" href="../../d2/d1/struct__MMCLONE__DESCRIPTOR.html#o2">02475</a>     LONG CloneRefCount;
<a name="l02476"></a><a class="code" href="../../d2/d1/struct__MMCLONE__DESCRIPTOR.html#o3">02476</a> } <a class="code" href="../../d1/d1/struct__MMCLONE__BLOCK.html">MMCLONE_BLOCK</a>;
<a name="l02477"></a><a class="code" href="../../d2/d1/struct__MMCLONE__DESCRIPTOR.html#o4">02477</a> 
<a name="l02478"></a><a class="code" href="../../d2/d1/struct__MMCLONE__DESCRIPTOR.html#o5">02478</a> <span class="keyword">typedef</span> <a class="code" href="../../d1/d1/struct__MMCLONE__BLOCK.html">MMCLONE_BLOCK</a> *<a class="code" href="../../d1/d1/struct__MMCLONE__BLOCK.html">PMMCLONE_BLOCK</a>;
<a name="l02479"></a><a class="code" href="../../d2/d1/struct__MMCLONE__DESCRIPTOR.html#o6">02479</a> 
<a name="l02480"></a><a class="code" href="../../d2/d1/struct__MMCLONE__DESCRIPTOR.html#o7">02480</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d3/d1/struct__MMCLONE__HEADER.html">_MMCLONE_HEADER</a> {
<a name="l02481"></a><a class="code" href="../../d2/d1/struct__MMCLONE__DESCRIPTOR.html#o8">02481</a>     ULONG NumberOfPtes;
02482     ULONG NumberOfProcessReferences;
02483     <a class="code" href="../../d4/d8/mi_8h.html#a497">PMMCLONE_BLOCK</a> ClonePtes;
02484 } <a class="code" href="../../d3/d1/struct__MMCLONE__HEADER.html">MMCLONE_HEADER</a>, *<a class="code" href="../../d3/d1/struct__MMCLONE__HEADER.html">PMMCLONE_HEADER</a>;
02485 
02486 
02487 <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d2/d1/struct__MMCLONE__DESCRIPTOR.html">_MMCLONE_DESCRIPTOR</a> {
02488     ULONG_PTR StartingVpn;
02489     ULONG_PTR EndingVpn;
02490     <span class="keyword">struct </span><a class="code" href="../../d2/d1/struct__MMCLONE__DESCRIPTOR.html">_MMCLONE_DESCRIPTOR</a> *Parent;
02491     <span class="keyword">struct </span><a class="code" href="../../d2/d1/struct__MMCLONE__DESCRIPTOR.html">_MMCLONE_DESCRIPTOR</a> *LeftChild;
02492     <span class="keyword">struct </span><a class="code" href="../../d2/d1/struct__MMCLONE__DESCRIPTOR.html">_MMCLONE_DESCRIPTOR</a> *RightChild;
02493     <a class="code" href="../../d4/d8/mi_8h.html#a499">PMMCLONE_HEADER</a> CloneHeader;
02494     ULONG NumberOfPtes;
02495     ULONG NumberOfReferences;
<a name="l02496"></a><a class="code" href="../../d4/d8/mi_8h.html#a233">02496</a>     SIZE_T PagedPoolQuotaCharge;
02497 } <a class="code" href="../../d2/d1/struct__MMCLONE__DESCRIPTOR.html">MMCLONE_DESCRIPTOR</a>, *<a class="code" href="../../d2/d1/struct__MMCLONE__DESCRIPTOR.html">PMMCLONE_DESCRIPTOR</a>;
02498 
02499 <span class="comment">//</span>
02500 <span class="comment">// The following macro will allocate and initialize a bitmap from the</span>
02501 <span class="comment">// specified pool of the specified size</span>
02502 <span class="comment">//</span>
02503 <span class="comment">//      VOID</span>
02504 <span class="comment">//      MiCreateBitMap (</span>
<a name="l02505"></a><a class="code" href="../../d4/d8/mi_8h.html#a234">02505</a> <span class="comment">//          OUT PRTL_BITMAP *BitMapHeader,</span>
02506 <span class="comment">//          IN SIZE_T SizeOfBitMap,</span>
02507 <span class="comment">//          IN POOL_TYPE PoolType</span>
02508 <span class="comment">//          );</span>
02509 <span class="comment">//</span>
<a name="l02510"></a><a class="code" href="../../d4/d8/mi_8h.html#a235">02510</a> 
02511 <span class="preprocessor">#define MiCreateBitMap(BMH,S,P) {                          \</span>
02512 <span class="preprocessor">    ULONG _S;                                              \</span>
02513 <span class="preprocessor">    _S = sizeof(RTL_BITMAP) + (ULONG)((((S) + 31) / 32) * 4);         \</span>
02514 <span class="preprocessor">    *(BMH) = (PRTL_BITMAP)ExAllocatePoolWithTag( (P), _S, '  mM');       \</span>
02515 <span class="preprocessor">    if (*(BMH)) { \</span>
02516 <span class="preprocessor">        RtlInitializeBitMap( *(BMH), (PULONG)((*(BMH))+1), (ULONG)S); \</span>
02517 <span class="preprocessor">    }                                                          \</span>
02518 <span class="preprocessor">}</span>
02519 <span class="preprocessor"></span>
02520 <span class="preprocessor">#define MiRemoveBitMap(BMH)     {                          \</span>
02521 <span class="preprocessor">    ExFreePool(*(BMH));                                    \</span>
<a name="l02522"></a><a class="code" href="../../d8/d2/struct__MMMOD__WRITER__LISTHEAD.html">02522</a> <span class="preprocessor">    *(BMH) = NULL;                                         \</span>
<a name="l02523"></a><a class="code" href="../../d8/d2/struct__MMMOD__WRITER__LISTHEAD.html#o0">02523</a> <span class="preprocessor">}</span>
<a name="l02524"></a><a class="code" href="../../d8/d2/struct__MMMOD__WRITER__LISTHEAD.html#o1">02524</a> <span class="preprocessor"></span>
02525 <span class="preprocessor">#define MI_INITIALIZE_ZERO_MDL(MDL) { \</span>
02526 <span class="preprocessor">    MDL-&gt;Next = (PMDL) NULL; \</span>
<a name="l02527"></a><a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html">02527</a> <span class="preprocessor">    MDL-&gt;MdlFlags = 0; \</span>
<a name="l02528"></a><a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o0">02528</a> <span class="preprocessor">    MDL-&gt;StartVa = NULL; \</span>
<a name="l02529"></a><a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o1">02529</a> <span class="preprocessor">    MDL-&gt;ByteOffset = 0; \</span>
02530 <span class="preprocessor">    MDL-&gt;ByteCount = 0; \</span>
<a name="l02531"></a><a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o2">02531</a> <span class="preprocessor">    }</span>
<a name="l02532"></a><a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o3">02532</a> <span class="preprocessor"></span>
02533 <span class="comment">//</span>
<a name="l02534"></a><a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o5">02534</a> <span class="comment">// Page File structures.</span>
<a name="l02535"></a><a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o6">02535</a> <span class="comment">//</span>
<a name="l02536"></a><a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o7">02536</a> 
<a name="l02537"></a><a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o8">02537</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d8/d2/struct__MMMOD__WRITER__LISTHEAD.html">_MMMOD_WRITER_LISTHEAD</a> {
<a name="l02538"></a><a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o9">02538</a>     LIST_ENTRY ListHead;
<a name="l02539"></a><a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o10">02539</a>     <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> Event;
<a name="l02540"></a><a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o11">02540</a> } <a class="code" href="../../d8/d2/struct__MMMOD__WRITER__LISTHEAD.html">MMMOD_WRITER_LISTHEAD</a>, *<a class="code" href="../../d8/d2/struct__MMMOD__WRITER__LISTHEAD.html">PMMMOD_WRITER_LISTHEAD</a>;
<a name="l02541"></a><a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o12">02541</a> 
<a name="l02542"></a><a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o13">02542</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html">_MMMOD_WRITER_MDL_ENTRY</a> {
<a name="l02543"></a><a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o14">02543</a>     LIST_ENTRY <a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o0">Links</a>;
02544     LARGE_INTEGER <a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o1">WriteOffset</a>;
02545     <span class="keyword">union </span>{
02546         IO_STATUS_BLOCK <a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html#o2">IoStatus</a>;
<a name="l02547"></a><a class="code" href="../../d4/d8/mi_8h.html#a236">02547</a>         LARGE_INTEGER LastByte;
02548     } u;
<a name="l02549"></a><a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html">02549</a>     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>;
<a name="l02550"></a><a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o0">02550</a>     ULONG_PTR LastPageToWrite;
<a name="l02551"></a><a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o1">02551</a>     <a class="code" href="../../d4/d8/mi_8h.html#a503">PMMMOD_WRITER_LISTHEAD</a> PagingListHead;
<a name="l02552"></a><a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o2">02552</a>     PLIST_ENTRY CurrentList;
<a name="l02553"></a><a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o3">02553</a>     <span class="keyword">struct </span><a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html">_MMPAGING_FILE</a> *PagingFile;
<a name="l02554"></a><a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o4">02554</a>     <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> File;
<a name="l02555"></a><a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o5">02555</a>     <a class="code" href="../../d4/d8/mi_8h.html#a461">PCONTROL_AREA</a> ControlArea;
<a name="l02556"></a><a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o6">02556</a>     <a class="code" href="../../d6/d4/struct__ERESOURCE.html">PERESOURCE</a> FileResource;
<a name="l02557"></a><a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o7">02557</a>     <a class="code" href="../../d6/d7/struct__MDL.html">MDL</a> Mdl;
<a name="l02558"></a><a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o8">02558</a>     PFN_NUMBER Page[1];
<a name="l02559"></a><a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o9">02559</a> } <a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html">MMMOD_WRITER_MDL_ENTRY</a>, *<a class="code" href="../../d9/d2/struct__MMMOD__WRITER__MDL__ENTRY.html">PMMMOD_WRITER_MDL_ENTRY</a>;
<a name="l02560"></a><a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o10">02560</a> 
<a name="l02561"></a><a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o11">02561</a> 
<a name="l02562"></a><a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o12">02562</a> <span class="preprocessor">#define MM_PAGING_FILE_MDLS 2</span>
<a name="l02563"></a><a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o13">02563</a> <span class="preprocessor"></span>
<a name="l02564"></a><a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o14">02564</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html">_MMPAGING_FILE</a> {
02565     PFN_NUMBER <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
02566     PFN_NUMBER <a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html#o1">MaximumSize</a>;
<a name="l02567"></a><a class="code" href="../../d6/d2/struct__MMINPAGE__SUPPORT__LIST.html">02567</a>     PFN_NUMBER MinimumSize;
<a name="l02568"></a><a class="code" href="../../d6/d2/struct__MMINPAGE__SUPPORT__LIST.html#o0">02568</a>     PFN_NUMBER FreeSpace;
<a name="l02569"></a><a class="code" href="../../d6/d2/struct__MMINPAGE__SUPPORT__LIST.html#o1">02569</a>     PFN_NUMBER CurrentUsage;
02570     PFN_NUMBER PeakUsage;
02571     PFN_NUMBER Hint;
<a name="l02572"></a><a class="code" href="../../d9/d1/struct__MMEVENT__COUNT__LIST.html">02572</a>     PFN_NUMBER HighestPage;
<a name="l02573"></a><a class="code" href="../../d9/d1/struct__MMEVENT__COUNT__LIST.html#o0">02573</a>     <a class="code" href="../../d4/d8/mi_8h.html#a505">PMMMOD_WRITER_MDL_ENTRY</a> Entry[<a class="code" href="../../d4/d8/mi_8h.html#a236">MM_PAGING_FILE_MDLS</a>];
<a name="l02574"></a><a class="code" href="../../d9/d1/struct__MMEVENT__COUNT__LIST.html#o1">02574</a>     PRTL_BITMAP Bitmap;
02575     <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> File;
02576     UNICODE_STRING PageFileName;
02577     ULONG PageFileNumber;
02578     BOOLEAN Extended;
02579     BOOLEAN HintSetToZero;
02580     } <a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html">MMPAGING_FILE</a>, *<a class="code" href="../../d3/d3/struct__MMPAGING__FILE.html">PMMPAGING_FILE</a>;
<a name="l02581"></a><a class="code" href="../../d4/d8/mi_8h.html#a237">02581</a> 
02582 <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d6/d2/struct__MMINPAGE__SUPPORT__LIST.html">_MMINPAGE_SUPPORT_LIST</a> {
<a name="l02583"></a><a class="code" href="../../d4/d8/mi_8h.html#a1003">02583</a>     LIST_ENTRY ListHead;
02584     ULONG Count;
02585 } <a class="code" href="../../d6/d2/struct__MMINPAGE__SUPPORT__LIST.html">MMINPAGE_SUPPORT_LIST</a>, *<a class="code" href="../../d6/d2/struct__MMINPAGE__SUPPORT__LIST.html">PMMINPAGE_SUPPORT_LIST</a>;
02586 
02587 <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d9/d1/struct__MMEVENT__COUNT__LIST.html">_MMEVENT_COUNT_LIST</a> {
02588     LIST_ENTRY ListHead;
<a name="l02589"></a><a class="code" href="../../d2/d2/struct__MMFREE__POOL__ENTRY.html">02589</a>     ULONG Count;
<a name="l02590"></a><a class="code" href="../../d2/d2/struct__MMFREE__POOL__ENTRY.html#o0">02590</a> } <a class="code" href="../../d9/d1/struct__MMEVENT__COUNT__LIST.html">MMEVENT_COUNT_LIST</a>, *<a class="code" href="../../d9/d1/struct__MMEVENT__COUNT__LIST.html">PMMEVENT_COUNT_LIST</a>;
<a name="l02591"></a><a class="code" href="../../d2/d2/struct__MMFREE__POOL__ENTRY.html#o1">02591</a> 
<a name="l02592"></a><a class="code" href="../../d2/d2/struct__MMFREE__POOL__ENTRY.html#o2">02592</a> <span class="comment">//</span>
<a name="l02593"></a><a class="code" href="../../d2/d2/struct__MMFREE__POOL__ENTRY.html#o3">02593</a> <span class="comment">// System PTE structures.</span>
02594 <span class="comment">//</span>
02595 
02596 <span class="preprocessor">#define MM_SYS_PTE_TABLES_MAX 5</span>
<a name="l02597"></a><a class="code" href="../../d7/d2/struct__MMLOCK__CONFLICT.html">02597</a> <span class="preprocessor"></span>
<a name="l02598"></a><a class="code" href="../../d7/d2/struct__MMLOCK__CONFLICT.html#o0">02598</a> <span class="keyword">typedef</span> <span class="keyword">enum</span> <a class="code" href="../../d4/d8/mi_8h.html#a1003">_MMSYSTEM_PTE_POOL_TYPE</a> {
<a name="l02599"></a><a class="code" href="../../d7/d2/struct__MMLOCK__CONFLICT.html#o1">02599</a>     <a class="code" href="../../d4/d8/mi_8h.html#a1003a769">SystemPteSpace</a>,
02600     <a class="code" href="../../d4/d8/mi_8h.html#a1003a770">NonPagedPoolExpansion</a>,
02601     <a class="code" href="../../d4/d8/mi_8h.html#a1003a771">MaximumPtePoolTypes</a>
02602 } <a class="code" href="../../d4/d8/mi_8h.html#a512">MMSYSTEM_PTE_POOL_TYPE</a>;
02603 
02604 <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d2/d2/struct__MMFREE__POOL__ENTRY.html">_MMFREE_POOL_ENTRY</a> {
02605     LIST_ENTRY List;
<a name="l02606"></a><a class="code" href="../../d5/d7/struct__MMVIEW.html">02606</a>     PFN_NUMBER <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
<a name="l02607"></a><a class="code" href="../../d5/d7/struct__MMVIEW.html#o0">02607</a>     ULONG Signature;
<a name="l02608"></a><a class="code" href="../../d5/d7/struct__MMVIEW.html#o1">02608</a>     <span class="keyword">struct </span><a class="code" href="../../d2/d2/struct__MMFREE__POOL__ENTRY.html">_MMFREE_POOL_ENTRY</a> *Owner;
02609 } <a class="code" href="../../d2/d2/struct__MMFREE__POOL__ENTRY.html">MMFREE_POOL_ENTRY</a>, *<a class="code" href="../../d2/d2/struct__MMFREE__POOL__ENTRY.html">PMMFREE_POOL_ENTRY</a>;
02610 
02611 
02612 <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d7/d2/struct__MMLOCK__CONFLICT.html">_MMLOCK_CONFLICT</a> {
02613     LIST_ENTRY List;
02614     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> Thread;
02615 } <a class="code" href="../../d7/d2/struct__MMLOCK__CONFLICT.html">MMLOCK_CONFLICT</a>, *<a class="code" href="../../d7/d2/struct__MMLOCK__CONFLICT.html">PMMLOCK_CONFLICT</a>;
02616 
<a name="l02617"></a><a class="code" href="../../d0/d6/struct__MMSESSION.html">02617</a> <span class="comment">//</span>
02618 <span class="comment">// System view structures</span>
02619 <span class="comment">//</span>
02620 
02621 <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d5/d7/struct__MMVIEW.html">_MMVIEW</a> {
02622     ULONG_PTR Entry;
02623     <a class="code" href="../../d4/d8/mi_8h.html#a461">PCONTROL_AREA</a> ControlArea;
<a name="l02624"></a><a class="code" href="../../d0/d6/struct__MMSESSION.html#o0">02624</a> } <a class="code" href="../../d5/d7/struct__MMVIEW.html">MMVIEW</a>, *<a class="code" href="../../d5/d7/struct__MMVIEW.html">PMMVIEW</a>;
02625 
02626 <span class="comment">//</span>
02627 <span class="comment">// The MMSESSION structure represents kernel memory that is only valid on a</span>
02628 <span class="comment">// per-session basis, thus the calling thread must be in the proper session</span>
02629 <span class="comment">// to access this structure.</span>
02630 <span class="comment">//</span>
02631 
<a name="l02632"></a><a class="code" href="../../d0/d6/struct__MMSESSION.html#o1">02632</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d0/d6/struct__MMSESSION.html">_MMSESSION</a> {
<a name="l02633"></a><a class="code" href="../../d0/d6/struct__MMSESSION.html#o2">02633</a> 
<a name="l02634"></a><a class="code" href="../../d0/d6/struct__MMSESSION.html#o3">02634</a>     <span class="comment">//</span>
<a name="l02635"></a><a class="code" href="../../d0/d6/struct__MMSESSION.html#o4">02635</a>     <span class="comment">// Never refer to the SystemSpaceViewLock directly - always use the pointer</span>
<a name="l02636"></a><a class="code" href="../../d0/d6/struct__MMSESSION.html#o5">02636</a>     <span class="comment">// following it or you will break support for multiple concurrent sessions.</span>
<a name="l02637"></a><a class="code" href="../../d0/d6/struct__MMSESSION.html#o6">02637</a>     <span class="comment">//</span>
<a name="l02638"></a><a class="code" href="../../d0/d6/struct__MMSESSION.html#o7">02638</a> 
02639     <a class="code" href="../../d6/d9/struct__FAST__MUTEX.html">FAST_MUTEX</a> <a class="code" href="../../d0/d6/struct__MMSESSION.html#o0">SystemSpaceViewLock</a>;
02640 
02641     <span class="comment">//</span>
<a name="l02642"></a><a class="code" href="../../d4/d8/mi_8h.html#a521">02642</a>     <span class="comment">// This points to the mutex above and is needed because the MMSESSION</span>
02643     <span class="comment">// is mapped in session space on Hydra and the mutex needs to be globally</span>
<a name="l02644"></a><a class="code" href="../../d4/d8/mi_8h.html#a238">02644</a>     <span class="comment">// visible for proper KeWaitForSingleObject &amp; KeSetEvent operation.</span>
02645     <span class="comment">//</span>
02646 
<a name="l02647"></a><a class="code" href="../../d4/d8/mi_8h.html#a239">02647</a>     <a class="code" href="../../d6/d9/struct__FAST__MUTEX.html">PFAST_MUTEX</a> SystemSpaceViewLockPointer;
02648     PCHAR SystemSpaceViewStart;
02649     <a class="code" href="../../d4/d8/mi_8h.html#a518">PMMVIEW</a> SystemSpaceViewTable;
02650     ULONG SystemSpaceHashSize;
02651     ULONG SystemSpaceHashEntries;
02652     ULONG SystemSpaceHashKey;
02653     PRTL_BITMAP SystemSpaceBitMap;
<a name="l02654"></a><a class="code" href="../../d9/d4/struct__MMPTE__FLUSH__LIST.html">02654</a> 
<a name="l02655"></a><a class="code" href="../../d9/d4/struct__MMPTE__FLUSH__LIST.html#o0">02655</a> } <a class="code" href="../../d0/d6/struct__MMSESSION.html">MMSESSION</a>, *<a class="code" href="../../d0/d6/struct__MMSESSION.html">PMMSESSION</a>;
<a name="l02656"></a><a class="code" href="../../d9/d4/struct__MMPTE__FLUSH__LIST.html#o1">02656</a> 
<a name="l02657"></a><a class="code" href="../../d9/d4/struct__MMPTE__FLUSH__LIST.html#o2">02657</a> <span class="keyword">extern</span> <a class="code" href="../../d0/d6/struct__MMSESSION.html">MMSESSION</a>   <a class="code" href="../../d3/d5/mapview_8c.html#a6">MmSession</a>;
02658 
02659 <span class="preprocessor">#define LOCK_SYSTEM_VIEW_SPACE(_Session) \</span>
<a name="l02660"></a><a class="code" href="../../d0/d3/struct__LOCK__TRACKER.html">02660</a> <span class="preprocessor">            ExAcquireFastMutex (_Session-&gt;SystemSpaceViewLockPointer)</span>
<a name="l02661"></a><a class="code" href="../../d0/d3/struct__LOCK__TRACKER.html#o0">02661</a> <span class="preprocessor"></span>
<a name="l02662"></a><a class="code" href="../../d0/d3/struct__LOCK__TRACKER.html#o1">02662</a> <span class="preprocessor">#define UNLOCK_SYSTEM_VIEW_SPACE(_Session) \</span>
<a name="l02663"></a><a class="code" href="../../d0/d3/struct__LOCK__TRACKER.html#o2">02663</a> <span class="preprocessor">            ExReleaseFastMutex (_Session-&gt;SystemSpaceViewLockPointer)</span>
<a name="l02664"></a><a class="code" href="../../d0/d3/struct__LOCK__TRACKER.html#o3">02664</a> <span class="preprocessor"></span>
<a name="l02665"></a><a class="code" href="../../d0/d3/struct__LOCK__TRACKER.html#o4">02665</a> <span class="comment">//</span>
<a name="l02666"></a><a class="code" href="../../d0/d3/struct__LOCK__TRACKER.html#o5">02666</a> <span class="comment">// List for flushing TBs singularly.</span>
<a name="l02667"></a><a class="code" href="../../d0/d3/struct__LOCK__TRACKER.html#o6">02667</a> <span class="comment">//</span>
<a name="l02668"></a><a class="code" href="../../d0/d3/struct__LOCK__TRACKER.html#o7">02668</a> 
<a name="l02669"></a><a class="code" href="../../d0/d3/struct__LOCK__TRACKER.html#o8">02669</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d9/d4/struct__MMPTE__FLUSH__LIST.html">_MMPTE_FLUSH_LIST</a> {
<a name="l02670"></a><a class="code" href="../../d0/d3/struct__LOCK__TRACKER.html#o9">02670</a>     ULONG Count;
<a name="l02671"></a><a class="code" href="../../d0/d3/struct__LOCK__TRACKER.html#o10">02671</a>     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> FlushPte[<a class="code" href="../../d4/d8/mi_8h.html#a34">MM_MAXIMUM_FLUSH_COUNT</a>];
<a name="l02672"></a><a class="code" href="../../d0/d3/struct__LOCK__TRACKER.html#o11">02672</a>     PVOID FlushVa[<a class="code" href="../../d4/d8/mi_8h.html#a34">MM_MAXIMUM_FLUSH_COUNT</a>];
02673 } <a class="code" href="../../d9/d4/struct__MMPTE__FLUSH__LIST.html">MMPTE_FLUSH_LIST</a>, *<a class="code" href="../../d9/d4/struct__MMPTE__FLUSH__LIST.html">PMMPTE_FLUSH_LIST</a>;
02674 
<a name="l02675"></a><a class="code" href="../../d4/d8/mi_8h.html#a526">02675</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d0/d3/struct__LOCK__TRACKER.html">_LOCK_TRACKER</a> {
<a name="l02676"></a><a class="code" href="../../d4/d8/mi_8h.html#a527">02676</a>     LIST_ENTRY ListEntry;
02677     <a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a> Mdl;
<a name="l02678"></a><a class="code" href="../../d5/d2/struct__LOCK__HEADER.html">02678</a>     PVOID StartVa;
<a name="l02679"></a><a class="code" href="../../d5/d2/struct__LOCK__HEADER.html#o0">02679</a>     PFN_NUMBER Count;
<a name="l02680"></a><a class="code" href="../../d5/d2/struct__LOCK__HEADER.html#o1">02680</a>     ULONG Offset;
02681     ULONG Length;
02682     PFN_NUMBER Page;
<a name="l02683"></a><a class="code" href="../../d4/d8/mi_8h.html#a530">02683</a>     PVOID CallingAddress;
02684     PVOID CallersCaller;
<a name="l02685"></a><a class="code" href="../../d4/d8/mi_8h.html#a240">02685</a>     LIST_ENTRY GlobalListEntry;
02686     ULONG Who;
<a name="l02687"></a><a class="code" href="../../d0/d4/struct__UNLOADED__DRIVERS.html">02687</a>     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
<a name="l02688"></a><a class="code" href="../../d0/d4/struct__UNLOADED__DRIVERS.html#o0">02688</a> } <a class="code" href="../../d0/d3/struct__LOCK__TRACKER.html">LOCK_TRACKER</a>, *<a class="code" href="../../d0/d3/struct__LOCK__TRACKER.html">PLOCK_TRACKER</a>;
<a name="l02689"></a><a class="code" href="../../d0/d4/struct__UNLOADED__DRIVERS.html#o1">02689</a> 
<a name="l02690"></a><a class="code" href="../../d0/d4/struct__UNLOADED__DRIVERS.html#o2">02690</a> <span class="keyword">extern</span> LOGICAL  <a class="code" href="../../d8/d0/cmdat3_8c.html#a33">MmTrackLockedPages</a>;
<a name="l02691"></a><a class="code" href="../../d0/d4/struct__UNLOADED__DRIVERS.html#o3">02691</a> <span class="keyword">extern</span> BOOLEAN  <a class="code" href="../../d5/d6/iosup_8c.html#a14">MiTrackingAborted</a>;
02692 
02693 <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d5/d2/struct__LOCK__HEADER.html">_LOCK_HEADER</a> {
<a name="l02694"></a><a class="code" href="../../d4/d8/mi_8h.html#a533">02694</a>     LIST_ENTRY ListHead;
02695     PFN_NUMBER Count;
02696 } <a class="code" href="../../d5/d2/struct__LOCK__HEADER.html">LOCK_HEADER</a>, *<a class="code" href="../../d5/d2/struct__LOCK__HEADER.html">PLOCK_HEADER</a>;
02697 
02698 <span class="keyword">extern</span> LOGICAL <a class="code" href="../../d8/d0/cmdat3_8c.html#a32">MmSnapUnloads</a>;
02699 
02700 <span class="preprocessor">#define MI_UNLOADED_DRIVERS 50</span>
02701 <span class="preprocessor"></span>
02702 <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d0/d4/struct__UNLOADED__DRIVERS.html">_UNLOADED_DRIVERS</a> {
02703     UNICODE_STRING Name;
02704     PVOID StartAddress;
02705     PVOID EndAddress;
02706     LARGE_INTEGER CurrentTime;
02707 } <a class="code" href="../../d0/d4/struct__UNLOADED__DRIVERS.html">UNLOADED_DRIVERS</a>, *<a class="code" href="../../d0/d4/struct__UNLOADED__DRIVERS.html">PUNLOADED_DRIVERS</a>;
02708 
02709 <span class="keyword">extern</span> <a class="code" href="../../d4/d8/mi_8h.html#a532">PUNLOADED_DRIVERS</a> <a class="code" href="../../d9/d5/4_2kddata_8c.html#a46">MiUnloadedDrivers</a>;
02710 
02711 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
02712 <a class="code" href="../../d4/d8/mi_8h.html#a774">MiRemoveConflictFromList</a> (
02713     IN PMMLOCK_CONFLICT Conflict
02714     );
02715 
02716 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
02717 <a class="code" href="../../d4/d8/mi_8h.html#a775">MiInsertConflictInList</a> (
02718     IN PMMLOCK_CONFLICT Conflict
02719     );
02720 
02721 
02722 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
02723 <a class="code" href="../../d2/d3/initppc_8c.html#a1">MiInitMachineDependent</a> (
02724     IN <a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a> LoaderBlock
02725     );
02726 
02727 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
02728 <a class="code" href="../../d5/d1/mminit_8c.html#a47">MiBuildPagedPool</a> (
02729     VOID
02730     );
02731 
02732 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
02733 <a class="code" href="../../d4/d8/mi_8h.html#a778">MiInitializeNonPagedPool</a> (
02734     VOID
02735     );
02736 
02737 BOOLEAN
02738 <a class="code" href="../../d4/d8/mi_8h.html#a779">MiInitializeSystemSpaceMap</a> (
02739     PVOID Session OPTIONAL
02740     );
02741 
02742 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
02743 <a class="code" href="../../d5/d1/mminit_8c.html#a55">MiFindInitializationCode</a> (
02744     OUT PVOID *StartVa,
02745     OUT PVOID *EndVa
02746     );
02747 
02748 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
02749 <a class="code" href="../../d5/d1/mminit_8c.html#a56">MiFreeInitializationCode</a> (
02750     IN PVOID StartVa,
02751     IN PVOID EndVa
02752     );
02753 
02754 
02755 ULONG
02756 <a class="code" href="../../d5/d5/sectsup_8c.html#a20">MiSectionInitialization</a> (
<a name="l02757"></a><a class="code" href="../../d4/d8/mi_8h.html#a241">02757</a>     VOID
02758     );
<a name="l02759"></a><a class="code" href="../../d4/d8/mi_8h.html#a242">02759</a> 
02760 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
02761 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
02762 <a class="code" href="../../d6/d5/pfndec_8c.html#a2">MiDecrementReferenceCount</a> (
02763     IN PFN_NUMBER PageFrameIndex
02764     );
02765 
02766 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
02767 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
02768 <a class="code" href="../../d6/d5/pfndec_8c.html#a1">MiDecrementShareCount</a> (
02769     IN PFN_NUMBER PageFrameIndex
02770     );
02771 
02772 <span class="preprocessor">#define MiDecrementShareCountOnly(P) MiDecrementShareCount(P)</span>
02773 <span class="preprocessor"></span>
02774 <span class="preprocessor">#define MiDecrementShareAndValidCount(P) MiDecrementShareCount(P)</span>
02775 <span class="preprocessor"></span>
02776 <span class="comment">//</span>
02777 <span class="comment">// Routines which operate on the Page Frame Database Lists</span>
02778 <span class="comment">//</span>
02779 
02780 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
02781 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
02782 <a class="code" href="../../d7/d5/pfnlist_8c.html#a8">MiInsertPageInList</a> (
02783     IN <a class="code" href="../../d0/d4/struct__MMPFNLIST.html">PMMPFNLIST</a> ListHead,
02784     IN PFN_NUMBER PageFrameIndex
02785     );
02786 
02787 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
02788 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
02789 <a class="code" href="../../d7/d5/pfnlist_8c.html#a9">MiInsertStandbyListAtFront</a> (
02790     IN PFN_NUMBER PageFrameIndex
02791     );
02792 
02793 PFN_NUMBER  <span class="comment">//PageFrameIndex</span>
02794 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
02795 <a class="code" href="../../d7/d5/pfnlist_8c.html#a10">MiRemovePageFromList</a> (
02796     IN <a class="code" href="../../d0/d4/struct__MMPFNLIST.html">PMMPFNLIST</a> ListHead
02797     );
02798 
02799 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
02800 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
02801 <a class="code" href="../../d7/d5/pfnlist_8c.html#a11">MiUnlinkPageFromList</a> (
02802     IN PMMPFN Pfn
02803     );
02804 
02805 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
02806 <a class="code" href="../../d7/d5/pfnlist_8c.html#a12">MiUnlinkFreeOrZeroedPage</a> (
02807     IN PFN_NUMBER Page
02808     );
02809 
02810 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
02811 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
02812 <a class="code" href="../../d7/d5/pfnlist_8c.html#a16">MiInsertFrontModifiedNoWrite</a> (
02813     IN PFN_NUMBER PageFrameIndex
<a name="l02814"></a><a class="code" href="../../d4/d8/mi_8h.html#a243">02814</a>     );
02815 
02816 ULONG
02817 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
02818 <a class="code" href="../../d7/d5/pfnlist_8c.html#a13">MiEnsureAvailablePageOrWait</a> (
02819     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process,
02820     IN PVOID VirtualAddress
02821     );
02822 
02823 PFN_NUMBER
02824 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
02825 <a class="code" href="../../d7/d5/pfnlist_8c.html#a14">MiRemoveZeroPage</a> (
02826     IN ULONG PageColor
02827     );
02828 
02829 <span class="preprocessor">#define MiRemoveZeroPageIfAny(COLOR)   \</span>
02830 <span class="preprocessor">    (MmFreePagesByColor[ZeroedPageList][COLOR].Flink != MM_EMPTY_LIST) ? \</span>
02831 <span class="preprocessor">                       MiRemoveZeroPage(COLOR) : 0</span>
02832 <span class="preprocessor"></span>
02833 
02834 PFN_NUMBER  <span class="comment">//PageFrameIndex</span>
02835 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
02836 <a class="code" href="../../d7/d5/pfnlist_8c.html#a15">MiRemoveAnyPage</a> (
02837     IN ULONG PageColor
02838     );
02839 
02840 PVOID
02841 <a class="code" href="../../d4/d8/mi_8h.html#a794">MiFindContiguousMemory</a> (
02842     IN PFN_NUMBER LowestPfn,
02843     IN PFN_NUMBER HighestPfn,
02844     IN PFN_NUMBER BoundaryPfn,
02845     IN PFN_NUMBER SizeInPages,
02846     IN PVOID CallingAddress
02847     );
02848 
02849 PVOID
02850 <a class="code" href="../../d4/d8/mi_8h.html#a795">MiCheckForContiguousMemory</a> (
02851     IN PVOID BaseAddress,
02852     IN PFN_NUMBER BaseAddressPages,
02853     IN PFN_NUMBER SizeInPages,
02854     IN PFN_NUMBER LowestPfn,
02855     IN PFN_NUMBER HighestPfn,
02856     IN PFN_NUMBER BoundaryPfn
02857     );
02858 
02859 <span class="comment">//</span>
02860 <span class="comment">// Routines which operate on the page frame database entry.</span>
02861 <span class="comment">//</span>
02862 
02863 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
02864 <a class="code" href="../../d8/d2/pagfault_8c.html#a22">MiInitializePfn</a> (
02865     IN PFN_NUMBER PageFrameIndex,
02866     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte,
02867     IN ULONG ModifiedState
02868     );
02869 
02870 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
02871 <a class="code" href="../../d8/d2/pagfault_8c.html#a27">MiInitializePfnForOtherProcess</a> (
02872     IN PFN_NUMBER PageFrameIndex,
02873     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte,
02874     IN PFN_NUMBER ContainingPageFrame
02875     );
02876 
02877 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
02878 <a class="code" href="../../d8/d2/pagfault_8c.html#a25">MiInitializeCopyOnWritePfn</a> (
02879     IN PFN_NUMBER PageFrameIndex,
02880     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte,
02881     IN WSLE_NUMBER WorkingSetIndex,
02882     IN PVOID SessionSpace
02883     );
02884 
02885 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
02886 <a class="code" href="../../d8/d2/pagfault_8c.html#a24">MiInitializeTransitionPfn</a> (
02887     IN PFN_NUMBER PageFrameIndex,
02888     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte,
02889     IN WSLE_NUMBER WorkingSetIndex
02890     );
02891 
02892 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
02893 <a class="code" href="../../d4/d8/mi_8h.html#a800">MiFlushInPageSupportBlock</a> (
02894     );
02895 
02896 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
02897 <a class="code" href="../../d8/d2/pagfault_8c.html#a30">MiFreeInPageSupportBlock</a> (
02898     IN PMMINPAGE_SUPPORT Support
02899     );
02900 
02901 <a class="code" href="../../d4/d8/mi_8h.html#a474">PMMINPAGE_SUPPORT</a>
02902 <a class="code" href="../../d8/d2/pagfault_8c.html#a29">MiGetInPageSupportBlock</a> (
02903     VOID
02904     );
02905 
02906 <span class="comment">//</span>
02907 <span class="comment">// Routines which require a physical page to be mapped into hyperspace</span>
02908 <span class="comment">// within the current process.</span>
02909 <span class="comment">//</span>
02910 
02911 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
02912 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
02913 <a class="code" href="../../d0/d2/mmsup_8c.html#a14">MiZeroPhysicalPage</a> (
02914     IN PFN_NUMBER PageFrameIndex,
02915     IN ULONG Color
02916     );
02917 
02918 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
02919 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
02920 <a class="code" href="../../d0/d2/mmsup_8c.html#a15">MiRestoreTransitionPte</a> (
02921     IN PFN_NUMBER PageFrameIndex
<a name="l02922"></a><a class="code" href="../../d4/d8/mi_8h.html#a244">02922</a>     );
02923 
02924 <a class="code" href="../../d4/d8/mi_8h.html#a466">PSUBSECTION</a>
02925 <a class="code" href="../../d0/d2/mmsup_8c.html#a16">MiGetSubsectionAndProtoFromPte</a> (
02926     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte,
02927     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> *ProtoPte,
02928     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process
02929     );
02930 
02931 PVOID
02932 <a class="code" href="../../d2/d3/ppc_2hypermap_8c.html#a0">MiMapPageInHyperSpace</a> (
02933     IN PFN_NUMBER PageFrameIndex,
02934     OUT PKIRQL OldIrql
02935     );
02936 
02937 <span class="preprocessor">#define MiUnmapPageInHyperSpace(OLDIRQL) UNLOCK_HYPERSPACE(OLDIRQL)</span>
02938 <span class="preprocessor"></span>
02939 
02940 PVOID
02941 <a class="code" href="../../d2/d3/ppc_2hypermap_8c.html#a1">MiMapImageHeaderInHyperSpace</a> (
02942     IN PFN_NUMBER PageFrameIndex
02943     );
02944 
02945 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
02946 <a class="code" href="../../d2/d3/ppc_2hypermap_8c.html#a2">MiUnmapImageHeaderInHyperSpace</a> (
02947     VOID
02948     );
02949 
02950 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
02951 <a class="code" href="../../d4/d8/mi_8h.html#a808">MiUpdateImageHeaderPage</a> (
02952     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte,
02953     IN PFN_NUMBER PageFrameNumber,
02954     IN PCONTROL_AREA ControlArea
02955     );
02956 
02957 PFN_NUMBER
02958 <a class="code" href="../../d4/d8/mi_8h.html#a809">MiGetPageForHeader</a> (
02959     VOID
02960     );
02961 
02962 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
02963 <a class="code" href="../../d4/d8/mi_8h.html#a810">MiRemoveImageHeaderPage</a> (
02964     IN PFN_NUMBER PageFrameNumber
02965     );
02966 
02967 PVOID
02968 <a class="code" href="../../d2/d3/ppc_2hypermap_8c.html#a3">MiMapPageToZeroInHyperSpace</a> (
02969     IN PFN_NUMBER PageFrameIndex
02970     );
02971 
02972 
02973 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
02974 <a class="code" href="../../d4/d8/mi_8h.html#a812">MiGetWritablePagesInSection</a>(
02975     IN PSECTION Section,
02976     OUT PULONG WritablePages
02977     );
02978 
02979 <span class="comment">//</span>
02980 <span class="comment">// Routines to obtain and release system PTEs.</span>
02981 <span class="comment">//</span>
02982 
02983 <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>
02984 <a class="code" href="../../d0/d9/sysptes_8c.html#a25">MiReserveSystemPtes</a> (
02985     IN ULONG NumberOfPtes,
02986     IN MMSYSTEM_PTE_POOL_TYPE SystemPteType,
02987     IN ULONG Alignment,
02988     IN ULONG Offset,
02989     IN ULONG BugCheckOnFailure
02990     );
02991 
02992 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
02993 <a class="code" href="../../d0/d9/sysptes_8c.html#a26">MiReleaseSystemPtes</a> (
02994     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> StartingPte,
02995     IN ULONG NumberOfPtes,
02996     IN MMSYSTEM_PTE_POOL_TYPE SystemPteType
02997     );
02998 
02999 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
03000 <a class="code" href="../../d0/d9/sysptes_8c.html#a27">MiInitializeSystemPtes</a> (
03001     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> StartingPte,
03002     IN ULONG NumberOfPtes,
03003     IN MMSYSTEM_PTE_POOL_TYPE SystemPteType
03004     );
03005 
03006 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
03007 <a class="code" href="../../d4/d8/mi_8h.html#a816">MiAddMappedPtes</a> (
03008     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> FirstPte,
03009     IN ULONG NumberOfPtes,
03010     IN PCONTROL_AREA ControlArea
03011     );
03012 
03013 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
03014 <a class="code" href="../../d4/d8/mi_8h.html#a817">MiInitializeIoTrackers</a> (
03015     VOID
03016     );
03017 
03018 PVOID
03019 <a class="code" href="../../d4/d8/mi_8h.html#a818">MiMapSinglePage</a> (
03020      IN PVOID VirtualAddress OPTIONAL,
03021      IN PFN_NUMBER PageFrameIndex,
03022      IN MEMORY_CACHING_TYPE CacheType,
03023      IN MM_PAGE_PRIORITY Priority
03024      );
03025 
03026 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
03027 <a class="code" href="../../d4/d8/mi_8h.html#a819">MiUnmapSinglePage</a> (
03028      IN PVOID BaseAddress
03029      );
03030 
03031 <span class="comment">//</span>
03032 <span class="comment">// Access Fault routines.</span>
03033 <span class="comment">//</span>
03034 
03035 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
03036 <a class="code" href="../../d8/d2/pagfault_8c.html#a11">MiDispatchFault</a> (
03037     IN BOOLEAN StoreInstrution,
03038     IN PVOID VirtualAdress,
03039     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte,
03040     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerProtoPte,
03041     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process,
03042     OUT PLOGICAL ApcNeeded
03043     );
03044 
03045 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
03046 <a class="code" href="../../d8/d2/pagfault_8c.html#a12">MiResolveDemandZeroFault</a> (
03047     IN PVOID VirtualAddress,
03048     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte,
03049     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process,
03050     IN ULONG PrototypePte
03051     );
03052 
03053 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
03054 <a class="code" href="../../d8/d2/pagfault_8c.html#a13">MiResolveTransitionFault</a> (
03055     IN PVOID FaultingAddress,
03056     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte,
03057     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process,
03058     IN ULONG PfnLockHeld,
03059     OUT PLOGICAL ApcNeeded
03060     );
03061 
03062 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
03063 <a class="code" href="../../d8/d2/pagfault_8c.html#a14">MiResolvePageFileFault</a> (
03064     IN PVOID FaultingAddress,
03065     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte,
03066     IN PMMINPAGE_SUPPORT *ReadBlock,
03067     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process
03068     );
03069 
03070 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
03071 <a class="code" href="../../d8/d2/pagfault_8c.html#a15">MiResolveProtoPteFault</a> (
03072     IN BOOLEAN StoreInstruction,
03073     IN PVOID VirtualAddress,
03074     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte,
03075     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerProtoPte,
03076     IN PMMINPAGE_SUPPORT *ReadBlock,
03077     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process,
03078     OUT PLOGICAL ApcNeeded
03079     );
03080 
03081 
03082 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
03083 <a class="code" href="../../d8/d2/pagfault_8c.html#a16">MiResolveMappedFileFault</a> (
03084     IN PVOID FaultingAddress,
03085     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte,
03086     IN PMMINPAGE_SUPPORT *ReadBlock,
03087     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process
03088     );
03089 
03090 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
03091 <a class="code" href="../../d8/d2/pagfault_8c.html#a28">MiAddValidPageToWorkingSet</a> (
03092     IN PVOID VirtualAddress,
03093     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte,
03094     IN PMMPFN Pfn1,
03095     IN ULONG WsleMask
03096     );
03097 
03098 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
03099 <a class="code" href="../../d8/d2/pagfault_8c.html#a17">MiWaitForInPageComplete</a> (
03100     IN PMMPFN Pfn,
03101     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte,
03102     IN PVOID FaultingAddress,
03103     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPteContents,
03104     IN PMMINPAGE_SUPPORT InPageSupport,
03105     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> CurrentProcess
03106     );
03107 
03108 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
03109 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
03110 <a class="code" href="../../d3/d0/wrtfault_8c.html#a0">MiCopyOnWrite</a> (
03111     IN PVOID FaultingAddress,
03112     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte
03113     );
03114 
03115 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
03116 <a class="code" href="../../d1/d8/ppc_2setdirty_8c.html#a0">MiSetDirtyBit</a> (
03117     IN PVOID FaultingAddress,
03118     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte,
03119     IN ULONG PfnHeld
03120     );
03121 
03122 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
03123 <a class="code" href="../../d4/d8/mi_8h.html#a830">MiSetModifyBit</a> (
03124     IN PMMPFN Pfn
03125     );
03126 
03127 <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>
03128 <a class="code" href="../../d8/d2/pagfault_8c.html#a18">MiFindActualFaultingPte</a> (
03129     IN PVOID FaultingAddress
03130     );
03131 
03132 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
03133 <a class="code" href="../../d8/d2/pagfault_8c.html#a23">MiInitializeReadInProgressPfn</a> (
03134     IN <a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a> Mdl,
03135     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> BasePte,
03136     IN <a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a> Event,
03137     IN WSLE_NUMBER WorkingSetIndex
03138     );
03139 
03140 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
03141 <a class="code" href="../../d4/d8/mi_8h.html#a833">MiAccessCheck</a> (
03142     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte,
03143     IN BOOLEAN WriteOperation,
03144     IN KPROCESSOR_MODE PreviousMode,
03145     IN ULONG Protection,
03146     IN BOOLEAN CallerHoldsPfnLock
03147     );
03148 
03149 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
03150 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
03151 <a class="code" href="../../d4/d8/mi_8h.html#a834">MiCheckForUserStackOverflow</a> (
03152     IN PVOID FaultingAddress
03153     );
03154 
03155 <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>
03156 <a class="code" href="../../d8/d2/pagfault_8c.html#a19">MiCheckVirtualAddress</a> (
03157     IN PVOID VirtualAddress,
03158     OUT PULONG ProtectCode
03159     );
03160 
03161 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
03162 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
03163 <a class="code" href="../../d8/d2/pagfault_8c.html#a20">MiCheckPdeForPagedPool</a> (
03164     IN PVOID VirtualAddress
03165     );
03166 
03167 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
03168 <a class="code" href="../../d4/d8/mi_8h.html#a837">MiInitializeMustSucceedPool</a> (
03169     VOID
03170     );
03171 
03172 <span class="comment">//</span>
03173 <span class="comment">// Routines which operate on an address tree.</span>
03174 <span class="comment">//</span>
03175 
03176 <a class="code" href="../../d4/d8/mi_8h.html#a478">PMMADDRESS_NODE</a>
03177 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
03178 <a class="code" href="../../d4/d8/mi_8h.html#a838">MiGetNextNode</a> (
03179     IN PMMADDRESS_NODE Node
03180     );
03181 
03182 <a class="code" href="../../d4/d8/mi_8h.html#a478">PMMADDRESS_NODE</a>
03183 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
03184 <a class="code" href="../../d4/d8/mi_8h.html#a839">MiGetPreviousNode</a> (
03185     IN PMMADDRESS_NODE Node
03186     );
03187 
03188 
03189 <a class="code" href="../../d4/d8/mi_8h.html#a478">PMMADDRESS_NODE</a>
03190 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
03191 <a class="code" href="../../d4/d8/mi_8h.html#a840">MiGetFirstNode</a> (
03192     IN PMMADDRESS_NODE Root
03193     );
03194 
03195 <a class="code" href="../../d4/d8/mi_8h.html#a478">PMMADDRESS_NODE</a>
03196 <a class="code" href="../../d4/d8/mi_8h.html#a841">MiGetLastNode</a> (
03197     IN PMMADDRESS_NODE Root
03198     );
03199 
03200 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
03201 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
03202 <a class="code" href="../../d4/d8/mi_8h.html#a842">MiInsertNode</a> (
03203     IN PMMADDRESS_NODE Node,
03204     IN OUT PMMADDRESS_NODE *Root
03205     );
03206 
03207 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
03208 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
03209 <a class="code" href="../../d4/d8/mi_8h.html#a843">MiRemoveNode</a> (
03210     IN PMMADDRESS_NODE Node,
03211     IN OUT PMMADDRESS_NODE *Root
03212     );
03213 
03214 <a class="code" href="../../d4/d8/mi_8h.html#a478">PMMADDRESS_NODE</a>
03215 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
03216 <a class="code" href="../../d4/d8/mi_8h.html#a844">MiLocateAddressInTree</a> (
03217     IN ULONG_PTR Vpn,
03218     IN PMMADDRESS_NODE *Root
03219     );
03220 
03221 <a class="code" href="../../d4/d8/mi_8h.html#a478">PMMADDRESS_NODE</a>
03222 <a class="code" href="../../d4/d8/mi_8h.html#a845">MiCheckForConflictingNode</a> (
03223     IN ULONG_PTR StartVpn,
03224     IN ULONG_PTR EndVpn,
03225     IN PMMADDRESS_NODE Root
03226     );
03227 
03228 PVOID
03229 <a class="code" href="../../d4/d8/mi_8h.html#a846">MiFindEmptyAddressRangeInTree</a> (
03230     IN SIZE_T SizeOfRange,
03231     IN ULONG_PTR Alignment,
03232     IN PMMADDRESS_NODE Root,
03233     OUT PMMADDRESS_NODE *PreviousVad
03234     );
03235 
03236 PVOID
03237 <a class="code" href="../../d4/d8/mi_8h.html#a847">MiFindEmptyAddressRangeDownTree</a> (
03238     IN SIZE_T SizeOfRange,
03239     IN PVOID HighestAddressToEndAt,
03240     IN ULONG_PTR Alignment,
03241     IN PMMADDRESS_NODE Root
03242     );
03243 
03244 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
03245 <a class="code" href="../../d4/d8/mi_8h.html#a848">NodeTreeWalk</a> (
03246     PMMADDRESS_NODE Start
03247     );
03248 
03249 <span class="comment">//</span>
03250 <span class="comment">// Routines which operate on the tree of virtual address descriptors.</span>
03251 <span class="comment">//</span>
03252 
03253 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
03254 <a class="code" href="../../d6/d3/vadtree_8c.html#a0">MiInsertVad</a> (
03255     IN PMMVAD Vad
03256     );
03257 
03258 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
03259 <a class="code" href="../../d6/d3/vadtree_8c.html#a1">MiRemoveVad</a> (
03260     IN PMMVAD Vad
03261     );
03262 
03263 <a class="code" href="../../d4/d8/mi_8h.html#a490">PMMVAD</a>
03264 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
03265 <a class="code" href="../../d6/d3/vadtree_8c.html#a2">MiLocateAddress</a> (
03266     IN PVOID Vad
03267     );
03268 
03269 PVOID
03270 <a class="code" href="../../d6/d3/vadtree_8c.html#a3">MiFindEmptyAddressRange</a> (
03271     IN SIZE_T SizeOfRange,
03272     IN ULONG_PTR Alignment,
03273     IN ULONG QuickCheck
03274     );
03275 
03276 <span class="comment">//</span>
03277 <span class="comment">// Routines which operate on the clone tree structure.</span>
03278 <span class="comment">//</span>
03279 
03280 
03281 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
03282 <a class="code" href="../../d4/d8/mi_8h.html#a853">MiCloneProcessAddressSpace</a> (
03283     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> ProcessToClone,
03284     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> ProcessToInitialize,
03285     IN PFN_NUMBER PdePhysicalPage,
03286     IN PFN_NUMBER HyperPhysicalPage
03287     );
03288 
03289 
03290 ULONG
03291 <a class="code" href="../../d4/d8/mi_8h.html#a854">MiDecrementCloneBlockReference</a> (
03292     IN PMMCLONE_DESCRIPTOR CloneDescriptor,
03293     IN PMMCLONE_BLOCK CloneBlock,
03294     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> CurrentProcess
03295     );
03296 
03297 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
03298 <a class="code" href="../../d4/d8/mi_8h.html#a855">MiWaitForForkToComplete</a> (
03299     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> CurrentProcess
03300     );
03301 
03302 <span class="comment">//</span>
03303 <span class="comment">// Routines which operate on the working set list.</span>
03304 <span class="comment">//</span>
03305 
03306 <a class="code" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a>
03307 <a class="code" href="../../d4/d0/wslist_8c.html#a21">MiLocateAndReserveWsle</a> (
03308     IN <a class="code" href="../../d3/d6/struct__MMSUPPORT.html">PMMSUPPORT</a> WsInfo
03309     );
03310 
03311 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
03312 <a class="code" href="../../d4/d0/wslist_8c.html#a24">MiReleaseWsle</a> (
03313     IN WSLE_NUMBER WorkingSetIndex,
03314     IN <a class="code" href="../../d3/d6/struct__MMSUPPORT.html">PMMSUPPORT</a> WsInfo
03315     );
03316 
03317 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
03318 <a class="code" href="../../d4/d0/wslist_8c.html#a25">MiUpdateWsle</a> (
03319     IN PWSLE_NUMBER DesiredIndex,
03320     IN PVOID VirtualAddress,
03321     IN PMMWSL WorkingSetList,
03322     IN PMMPFN Pfn
03323     );
03324 
03325 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
03326 <a class="code" href="../../d4/d0/wslist_8c.html#a27">MiInitializeWorkingSetList</a> (
03327     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> CurrentProcess
03328     );
03329 
03330 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
03331 <a class="code" href="../../d4/d0/wslist_8c.html#a33">MiGrowWsleHash</a> (
03332     IN <a class="code" href="../../d3/d6/struct__MMSUPPORT.html">PMMSUPPORT</a> WsInfo
03333     );
03334 
03335 ULONG
03336 <a class="code" href="../../d4/d0/wslist_8c.html#a34">MiTrimWorkingSet</a> (
03337     ULONG Reduction,
03338     IN <a class="code" href="../../d3/d6/struct__MMSUPPORT.html">PMMSUPPORT</a> WsInfo,
03339     IN ULONG ForcedReduction
03340     );
03341 
03342 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
03343 <a class="code" href="../../d4/d0/wslist_8c.html#a17">MiRemoveWorkingSetPages</a> (
03344     IN PMMWSL WorkingSetList,
03345     IN <a class="code" href="../../d3/d6/struct__MMSUPPORT.html">PMMSUPPORT</a> WsInfo
03346     );
03347 
03348 <span class="preprocessor">#ifdef _MI_USE_CLAIMS_</span>
03349 <span class="preprocessor"></span><a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
03350 MiAgeAndEstimateAvailableInWorkingSet(
03351     IN <a class="code" href="../../d3/d6/struct__MMSUPPORT.html">PMMSUPPORT</a> VmSupport,
03352     IN BOOLEAN DoAging,
03353     IN OUT PULONG TotalClaim,
03354     IN OUT PULONG TotalEstimatedAvailable
03355     );
03356 <span class="preprocessor">#endif</span>
03357 <span class="preprocessor"></span>
03358 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
03359 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
03360 <a class="code" href="../../d7/d0/wstree_8c.html#a6">MiInsertWsle</a> (
03361     IN WSLE_NUMBER Entry,
03362     IN PMMWSL WorkingSetList
03363     );
03364 
03365 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
03366 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
03367 <a class="code" href="../../d7/d0/wstree_8c.html#a8">MiRemoveWsle</a> (
03368     IN WSLE_NUMBER Entry,
03369     IN PMMWSL WorkingSetList
03370     );
03371 
03372 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
03373 <a class="code" href="../../d4/d8/mi_8h.html#a865">MiFreeWorkingSetRange</a> (
03374     IN PVOID StartVa,
03375     IN PVOID EndVa,
03376     IN <a class="code" href="../../d3/d6/struct__MMSUPPORT.html">PMMSUPPORT</a> WsInfo
03377     );
03378 
03379 <a class="code" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a>
03380 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
03381 <a class="code" href="../../d7/d0/wstree_8c.html#a7">MiLocateWsle</a> (
03382     IN PVOID VirtualAddress,
03383     IN PMMWSL WorkingSetList,
03384     IN WSLE_NUMBER WsPfnIndex
03385     );
03386 
03387 ULONG
03388 <a class="code" href="../../d4/d0/wslist_8c.html#a26">MiFreeWsle</a> (
03389     IN WSLE_NUMBER WorkingSetIndex,
03390     IN <a class="code" href="../../d3/d6/struct__MMSUPPORT.html">PMMSUPPORT</a> WsInfo,
03391     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte
03392     );
03393 
03394 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
03395 <a class="code" href="../../d7/d0/wstree_8c.html#a9">MiSwapWslEntries</a> (
03396     IN WSLE_NUMBER SwapEntry,
03397     IN WSLE_NUMBER Entry,
03398     IN <a class="code" href="../../d3/d6/struct__MMSUPPORT.html">PMMSUPPORT</a> WsInfo
03399     );
03400 
03401 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
03402 <a class="code" href="../../d7/d0/wstree_8c.html#a10">MiRemoveWsleFromFreeList</a> (
03403     IN ULONG Entry,
03404     IN PMMWSLE Wsle,
03405     IN PMMWSL WorkingSetList
03406     );
03407 
03408 ULONG
03409 <a class="code" href="../../d4/d0/wslist_8c.html#a23">MiRemovePageFromWorkingSet</a> (
03410     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte,
03411     IN PMMPFN Pfn1,
03412     IN <a class="code" href="../../d3/d6/struct__MMSUPPORT.html">PMMSUPPORT</a> WsInfo
03413     );
03414 
03415 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
03416 <a class="code" href="../../d4/d8/mi_8h.html#a871">MiTakePageFromWorkingSet</a> (
03417     IN ULONG Entry,
03418     IN <a class="code" href="../../d3/d6/struct__MMSUPPORT.html">PMMSUPPORT</a> WsInfo,
03419     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte
03420     );
03421 
03422 PFN_NUMBER
03423 <a class="code" href="../../d8/d8/sysload_8c.html#a61">MiDeleteSystemPagableVm</a> (
03424     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte,
03425     IN PFN_NUMBER NumberOfPtes,
03426     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> NewPteValue,
03427     IN LOGICAL SessionAllocation,
03428     OUT PPFN_NUMBER ResidentPages OPTIONAL
03429     );
03430 
03431 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
03432 <a class="code" href="../../d4/d8/mi_8h.html#a873">MiLockCode</a> (
03433     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> FirstPte,
03434     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastPte,
03435     IN ULONG LockType
03436     );
03437 
03438 PLDR_DATA_TABLE_ENTRY
03439 <a class="code" href="../../d4/d8/mi_8h.html#a874">MiLookupDataTableEntry</a> (
03440     IN PVOID AddressWithinSection,
03441     IN ULONG ResourceHeld
03442     );
03443 
03444 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
03445 <a class="code" href="../../d4/d8/mi_8h.html#a875">MiFlushTb</a> (
03446     VOID
03447     );
03448 
03449 <span class="comment">//</span>
03450 <span class="comment">// Routines which perform working set management.</span>
03451 <span class="comment">//</span>
03452 
03453 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
03454 <a class="code" href="../../d5/d0/wsmanage_8c.html#a40">MiObtainFreePages</a> (
03455     VOID
03456     );
03457 
03458 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
03459 <a class="code" href="../../d6/d3/modwrite_8c.html#a51">MiModifiedPageWriter</a> (
03460     IN PVOID StartContext
03461     );
03462 
03463 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
03464 <a class="code" href="../../d6/d3/modwrite_8c.html#a53">MiMappedPageWriter</a> (
03465     IN PVOID StartContext
03466     );
03467 
03468 LOGICAL
03469 <a class="code" href="../../d6/d3/modwrite_8c.html#a58">MiIssuePageExtendRequest</a> (
03470     IN PMMPAGE_FILE_EXPANSION PageExtend
03471     );
03472 
03473 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
03474 <a class="code" href="../../d6/d3/modwrite_8c.html#a59">MiIssuePageExtendRequestNoWait</a> (
03475     IN PFN_NUMBER SizeInPages
03476     );
03477 
03478 SIZE_T
03479 <a class="code" href="../../d6/d3/modwrite_8c.html#a46">MiExtendPagingFiles</a> (
03480     IN PMMPAGE_FILE_EXPANSION PageExpand
03481     );
03482 
03483 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
03484 <a class="code" href="../../d6/d3/modwrite_8c.html#a47">MiContractPagingFiles</a> (
03485     VOID
03486     );
03487 
03488 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
03489 <a class="code" href="../../d6/d3/modwrite_8c.html#a48">MiAttemptPageFileReduction</a> (
03490     VOID
03491     );
03492 
03493 LOGICAL
03494 <a class="code" href="../../d6/d3/modwrite_8c.html#a50">MiCancelWriteOfMappedPfn</a> (
03495     IN PFN_NUMBER PageToStop
03496     );
03497 
03498 <span class="comment">//</span>
03499 <span class="comment">// Routines to delete address space.</span>
03500 <span class="comment">//</span>
03501 
03502 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
03503 <a class="code" href="../../d4/d8/mi_8h.html#a885">MiDeleteVirtualAddresses</a> (
03504     IN PUCHAR StartingAddress,
03505     IN PUCHAR EndingAddress,
03506     IN ULONG AddressSpaceDeletion,
03507     IN PMMVAD Vad
03508     );
03509 
03510 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
03511 <a class="code" href="../../d4/d8/mi_8h.html#a886">MiDeletePte</a> (
03512     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte,
03513     IN PVOID VirtualAddress,
03514     IN ULONG AddressSpaceDeletion,
03515     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> CurrentProcess,
03516     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PrototypePte,
03517     IN PMMPTE_FLUSH_LIST PteFlushList OPTIONAL
03518     );
03519 
03520 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
03521 <a class="code" href="../../d4/d8/mi_8h.html#a887">MiDeletePageTablesForPhysicalRange</a> (
03522     IN PVOID StartingAddress,
03523     IN PVOID EndingAddress
03524     );
03525 
03526 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
03527 <a class="code" href="../../d4/d8/mi_8h.html#a888">MiFlushPteList</a> (
03528     IN PMMPTE_FLUSH_LIST PteFlushList,
03529     IN ULONG AllProcessors,
03530     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> FillPte
03531     );
03532 
03533 
03534 ULONG
03535 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
03536 <a class="code" href="../../d4/d8/mi_8h.html#a889">MiReleasePageFileSpace</a> (
03537     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> PteContents
03538     );
03539 
03540 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
03541 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
03542 <a class="code" href="../../d4/d8/mi_8h.html#a890">MiUpdateModifiedWriterMdls</a> (
03543     IN ULONG PageFileNumber
03544     );
03545 
03546 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
03547 <a class="code" href="../../d8/d5/physical_8c.html#a13">MiRemoveUserPhysicalPagesVad</a> (
03548     IN PMMVAD_SHORT FoundVad
03549     );
03550 
03551 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
03552 <a class="code" href="../../d8/d5/physical_8c.html#a15">MiCleanPhysicalProcessPages</a> (
03553     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process
03554     );
03555 
03556 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
03557 <a class="code" href="../../d4/d8/mi_8h.html#a893">MiPhysicalViewRemover</a> (
03558     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process,
03559     IN PMMVAD Vad
03560     );
03561 
03562 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
03563 <a class="code" href="../../d4/d8/mi_8h.html#a894">MiPhysicalViewAdjuster</a> (
03564     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process,
03565     IN PMMVAD OldVad,
03566     IN PMMVAD NewVad
03567     );
03568 
03569 <span class="comment">//</span>
03570 <span class="comment">// General support routines.</span>
03571 <span class="comment">//</span>
03572 
03573 ULONG
03574 <a class="code" href="../../d0/d2/mmsup_8c.html#a6">MiDoesPdeExistAndMakeValid</a> (
03575     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPde,
03576     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> TargetProcess,
03577     IN ULONG PfnMutexHeld,
03578     OUT PULONG Waited
03579     );
03580 
03581 <span class="preprocessor">#if defined (_WIN64)</span>
03582 <span class="preprocessor"></span>LOGICAL
03583 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a168">MiDoesPpeExistAndMakeValid</a> (
03584     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPpe,
03585     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> TargetProcess,
03586     IN ULONG PfnMutexHeld,
03587     OUT PULONG Waited
03588     );
03589 <span class="preprocessor">#endif</span>
03590 <span class="preprocessor"></span>
<a name="l03591"></a><a class="code" href="../../d4/d8/mi_8h.html#a245">03591</a> ULONG
03592 <a class="code" href="../../d0/d2/mmsup_8c.html#a7">MiMakePdeExistAndMakeValid</a> (
03593     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPde,
03594     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> TargetProcess,
03595     IN ULONG PfnMutexHeld
03596     );
03597 
03598 <span class="preprocessor">#if defined (_WIN64)</span>
03599 <span class="preprocessor"></span>ULONG
03600 <a class="code" href="../../d4/d8/mi_8h.html#a245">MiMakePpeExistAndMakeValid</a> (
03601     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPde,
03602     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> TargetProcess,
03603     IN ULONG PfnMutexHeld
03604     );
03605 <span class="preprocessor">#else</span>
03606 <span class="preprocessor"></span><span class="preprocessor">#define MiMakePpeExistAndMakeValid(PDE, PROCESS, PFNMUTEXHELD)</span>
03607 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
03608 <span class="preprocessor"></span>
03609 ULONG
03610 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
03611 <a class="code" href="../../d0/d2/mmsup_8c.html#a8">MiMakeSystemAddressValid</a> (
03612     IN PVOID VirtualAddress,
03613     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> CurrentProcess
03614     );
03615 
03616 ULONG
03617 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
03618 <a class="code" href="../../d0/d2/mmsup_8c.html#a9">MiMakeSystemAddressValidPfnWs</a> (
03619     IN PVOID VirtualAddress,
03620     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> CurrentProcess OPTIONAL
03621     );
03622 
03623 ULONG
03624 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
03625 <a class="code" href="../../d0/d2/mmsup_8c.html#a10">MiMakeSystemAddressValidPfnSystemWs</a> (
03626     IN PVOID VirtualAddress
03627     );
03628 
03629 ULONG
03630 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
03631 <a class="code" href="../../d0/d2/mmsup_8c.html#a11">MiMakeSystemAddressValidPfn</a> (
03632     IN PVOID VirtualAddress
03633     );
03634 
03635 ULONG
03636 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
03637 <a class="code" href="../../d0/d2/mmsup_8c.html#a12">MiLockPagedAddress</a> (
03638     IN PVOID VirtualAddress,
03639     IN ULONG PfnLockHeld
03640     );
03641 
03642 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
03643 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
03644 <a class="code" href="../../d0/d2/mmsup_8c.html#a13">MiUnlockPagedAddress</a> (
03645     IN PVOID VirtualAddress,
03646     IN ULONG PfnLockHeld
03647     );
03648 
03649 ULONG
03650 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
03651 <a class="code" href="../../d0/d2/mmsup_8c.html#a3">MiIsPteDecommittedPage</a> (
03652     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte
03653     );
03654 
03655 ULONG
03656 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
03657 <a class="code" href="../../d0/d2/mmsup_8c.html#a4">MiIsProtectionCompatible</a> (
03658     IN ULONG OldProtect,
03659     IN ULONG NewProtect
03660     );
03661 
03662 ULONG
03663 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
03664 <a class="code" href="../../d0/d2/mmsup_8c.html#a5">MiMakeProtectionMask</a> (
03665     IN ULONG Protect
03666     );
03667 
03668 ULONG
03669 <a class="code" href="../../d4/d8/mi_8h.html#a906">MiIsEntireRangeCommitted</a> (
03670     IN PVOID StartingAddress,
03671     IN PVOID EndingAddress,
03672     IN PMMVAD Vad,
03673     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process
03674     );
03675 
03676 ULONG
03677 <a class="code" href="../../d4/d8/mi_8h.html#a907">MiIsEntireRangeDecommitted</a> (
03678     IN PVOID StartingAddress,
03679     IN PVOID EndingAddress,
03680     IN PMMVAD Vad,
03681     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process
03682     );
03683 
03684 <span class="comment">//++</span>
03685 <span class="comment">//PMMPTE</span>
03686 <span class="comment">//MiGetProtoPteAddress (</span>
03687 <span class="comment">//    IN PMMPTE VAD,</span>
03688 <span class="comment">//    IN PVOID VA</span>
03689 <span class="comment">//    );</span>
03690 <span class="comment">//</span>
03691 <span class="comment">// Routine Description:</span>
03692 <span class="comment">//</span>
03693 <span class="comment">//    MiGetProtoPteAddress returns a pointer to the prototype PTE which</span>
03694 <span class="comment">//    is mapped by the given virtual address descriptor and address within</span>
03695 <span class="comment">//    the virtual address descriptor.</span>
<a name="l03696"></a><a class="code" href="../../d4/d8/mi_8h.html#a246">03696</a> <span class="comment">//</span>
03697 <span class="comment">// Arguments</span>
03698 <span class="comment">//</span>
03699 <span class="comment">//    VAD - Supplies a pointer to the virtual address descriptor that contains</span>
03700 <span class="comment">//          the VA.</span>
03701 <span class="comment">//</span>
03702 <span class="comment">//    VPN - Supplies the virtual page number.</span>
03703 <span class="comment">//</span>
03704 <span class="comment">// Return Value:</span>
03705 <span class="comment">//</span>
03706 <span class="comment">//    A pointer to the proto PTE which corresponds to the VA.</span>
03707 <span class="comment">//</span>
03708 <span class="comment">//--</span>
03709 
03710 
03711 <span class="preprocessor">#define MiGetProtoPteAddress(VAD,VPN)                                        \</span>
03712 <span class="preprocessor">    ((((((VPN) - (VAD)-&gt;StartingVpn) &lt;&lt; PTE_SHIFT) +                         \</span>
03713 <span class="preprocessor">      (ULONG_PTR)(VAD)-&gt;FirstPrototypePte) &lt;= (ULONG_PTR)(VAD)-&gt;LastContiguousPte) ? \</span>
03714 <span class="preprocessor">    ((PMMPTE)(((((VPN) - (VAD)-&gt;StartingVpn) &lt;&lt; PTE_SHIFT) +                 \</span>
03715 <span class="preprocessor">        (ULONG_PTR)(VAD)-&gt;FirstPrototypePte))) :                                  \</span>
03716 <span class="preprocessor">        MiGetProtoPteAddressExtended ((VAD),(VPN)))</span>
03717 <span class="preprocessor"></span>
03718 <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>
03719 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
03720 <a class="code" href="../../d4/d8/mi_8h.html#a908">MiGetProtoPteAddressExtended</a> (
03721     IN PMMVAD Vad,
03722     IN ULONG_PTR Vpn
03723     );
03724 
03725 <a class="code" href="../../d4/d8/mi_8h.html#a466">PSUBSECTION</a>
03726 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
03727 <a class="code" href="../../d4/d8/mi_8h.html#a909">MiLocateSubsection</a> (
03728     IN PMMVAD Vad,
03729     IN ULONG_PTR Vpn
03730     );
03731 
03732 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
03733 <a class="code" href="../../d4/d8/mi_8h.html#a910">MiInitializeSystemCache</a> (
03734     IN ULONG MinimumWorkingSet,
03735     IN ULONG MaximumWorkingSet
03736     );
03737 
03738 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
03739 <a class="code" href="../../d5/d0/wsmanage_8c.html#a39">MiAdjustWorkingSetManagerParameters</a>(
03740     BOOLEAN WorkStation
03741     );
03742 
03743 <span class="comment">//</span>
03744 <span class="comment">// Section support</span>
03745 <span class="comment">//</span>
03746 
03747 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
03748 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
03749 <a class="code" href="../../d5/d5/sectsup_8c.html#a14">MiInsertBasedSection</a> (
03750     IN PSECTION Section
03751     );
03752 
03753 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
03754 <a class="code" href="../../d4/d8/mi_8h.html#a913">MiMapViewOfPhysicalSection</a> (
03755     IN PCONTROL_AREA ControlArea,
03756     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process,
03757     IN PVOID *CapturedBase,
03758     IN PLARGE_INTEGER SectionOffset,
03759     IN PSIZE_T CapturedViewSize,
03760     IN ULONG ProtectionMask,
03761     IN ULONG_PTR ZeroBits,
03762     IN ULONG AllocationType,
03763     IN BOOLEAN WriteCombined,
03764     OUT PBOOLEAN ReleasedWsMutex
03765     );
03766 
03767 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
03768 <a class="code" href="../../d4/d8/mi_8h.html#a914">MiRemoveImageSectionObject</a>(
03769     IN <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> File,
03770     IN PCONTROL_AREA ControlArea
03771     );
03772 
03773 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
03774 <a class="code" href="../../d0/d9/sysptes_8c.html#a28">MiAddSystemPtes</a>(
03775     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> StartingPte,
03776     IN ULONG  NumberOfPtes,
03777     IN MMSYSTEM_PTE_POOL_TYPE SystemPtePoolType
03778     );
03779 
03780 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
03781 <a class="code" href="../../d4/d9/umapview_8c.html#a2">MiRemoveMappedView</a> (
03782     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> CurrentProcess,
03783     IN PMMVAD Vad
03784     );
03785 
03786 PVOID
03787 <a class="code" href="../../d5/d5/sectsup_8c.html#a16">MiFindEmptySectionBaseDown</a> (
03788     IN ULONG SizeOfRange,
03789     IN PVOID HighestAddressToEndAt
03790     );
03791 
03792 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
03793 <a class="code" href="../../d5/d5/sectsup_8c.html#a17">MiSegmentDelete</a> (
03794     PSEGMENT Segment
03795     );
03796 
03797 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
03798 <a class="code" href="../../d5/d5/sectsup_8c.html#a18">MiSectionDelete</a> (
03799     PVOID Object
03800     );
03801 
03802 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
03803 <a class="code" href="../../d5/d5/sectsup_8c.html#a19">MiDereferenceSegmentThread</a> (
03804     IN PVOID StartContext
03805     );
03806 
03807 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
03808 <a class="code" href="../../d4/d8/mi_8h.html#a921">MiCreateImageFileMap</a> (
03809     IN <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> File,
03810     OUT PSEGMENT *Segment
03811     );
03812 
03813 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
03814 <a class="code" href="../../d4/d8/mi_8h.html#a922">MiCreateDataFileMap</a> (
03815     IN <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> File,
03816     OUT PSEGMENT *Segment,
03817     IN PUINT64 MaximumSize,
03818     IN ULONG SectionPageProtection,
03819     IN ULONG AllocationAttributes,
03820     IN ULONG IgnoreFileSizing
03821     );
03822 
03823 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
03824 <a class="code" href="../../d4/d8/mi_8h.html#a923">MiCreatePagingFileMap</a> (
03825     OUT PSEGMENT *Segment,
03826     IN PUINT64 MaximumSize,
03827     IN ULONG ProtectionMask,
03828     IN ULONG AllocationAttributes
03829     );
03830 
03831 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
03832 <a class="code" href="../../d4/d8/mi_8h.html#a924">MiPurgeSubsectionInternal</a> (
03833     IN PSUBSECTION Subsection,
03834     IN ULONG PteOffset
03835     );
03836 
03837 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
03838 <a class="code" href="../../d4/d9/umapview_8c.html#a3">MiPurgeImageSection</a> (
03839     IN PCONTROL_AREA ControlArea,
03840     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process
03841     );
03842 
03843 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
03844 <a class="code" href="../../d5/d5/sectsup_8c.html#a22">MiCleanSection</a> (
03845     IN PCONTROL_AREA ControlArea,
03846     IN LOGICAL DirtyDataPagesOk
03847     );
03848 
03849 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
03850 <a class="code" href="../../d5/d5/sectsup_8c.html#a24">MiCheckControlArea</a> (
03851     IN PCONTROL_AREA ControlArea,
03852     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> CurrentProcess,
03853     IN KIRQL PreviousIrql
03854     );
03855 
03856 LOGICAL
03857 <a class="code" href="../../d4/d8/mi_8h.html#a928">MiCheckPurgeAndUpMapCount</a> (
03858     IN PCONTROL_AREA ControlArea
03859     );
03860 
03861 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
03862 <a class="code" href="../../d5/d5/sectsup_8c.html#a25">MiCheckForControlAreaDeletion</a> (
03863     IN PCONTROL_AREA ControlArea
03864     );
03865 
03866 BOOLEAN
03867 <a class="code" href="../../d5/d5/sectsup_8c.html#a26">MiCheckControlAreaStatus</a> (
03868     IN SECTION_CHECK_TYPE SectionCheckType,
03869     IN <a class="code" href="../../d7/d0/struct__SECTION__OBJECT__POINTERS.html">PSECTION_OBJECT_POINTERS</a> SectionObjectPointers,
03870     IN ULONG DelayClose,
03871     OUT PCONTROL_AREA *ControlArea,
03872     OUT PKIRQL OldIrql
03873     );
03874 
03875 <a class="code" href="../../d4/d8/mi_8h.html#a458">PEVENT_COUNTER</a>
03876 <a class="code" href="../../d4/d8/mi_8h.html#a931">MiGetEventCounter</a> (
03877     );
03878 
03879 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
03880 <a class="code" href="../../d4/d8/mi_8h.html#a932">MiFlushEventCounter</a> (
03881     );
<a name="l03882"></a><a class="code" href="../../d4/d8/mi_8h.html#a247">03882</a> 
03883 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
03884 <a class="code" href="../../d5/d5/sectsup_8c.html#a28">MiFreeEventCounter</a> (
03885     IN PEVENT_COUNTER Support,
03886     IN ULONG Flush
03887     );
03888 
03889 ULONG
03890 <a class="code" href="../../d5/d5/sectsup_8c.html#a31">MiCanFileBeTruncatedInternal</a> (
03891     IN <a class="code" href="../../d7/d0/struct__SECTION__OBJECT__POINTERS.html">PSECTION_OBJECT_POINTERS</a> SectionPointer,
03892     IN PLARGE_INTEGER NewFileSize OPTIONAL,
03893     IN LOGICAL BlockNewViews,
03894     OUT PKIRQL PreviousIrql
03895     );
03896 
03897 <span class="preprocessor">#define STATUS_MAPPED_WRITER_COLLISION (0xC0033333)</span>
03898 <span class="preprocessor"></span>
03899 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
03900 <a class="code" href="../../d4/d8/mi_8h.html#a935">MiFlushSectionInternal</a> (
03901     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> StartingPte,
03902     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> FinalPte,
03903     IN PSUBSECTION FirstSubsection,
03904     IN PSUBSECTION LastSubsection,
03905     IN ULONG Synchronize,
03906     IN LOGICAL WriteInProgressOk,
03907     OUT PIO_STATUS_BLOCK IoStatus
03908     );
03909 
03910 <span class="comment">//</span>
03911 <span class="comment">// protection stuff...</span>
03912 <span class="comment">//</span>
03913 
03914 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
03915 <a class="code" href="../../d0/d9/protect_8c.html#a5">MiProtectVirtualMemory</a> (
03916     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process,
03917     IN PVOID *CapturedBase,
03918     IN PSIZE_T CapturedRegionSize,
03919     IN ULONG Protect,
03920     IN PULONG LastProtect
03921     );
03922 
03923 ULONG
03924 <a class="code" href="../../d0/d9/protect_8c.html#a7">MiGetPageProtection</a> (
03925     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte,
03926     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process
03927     );
03928 
03929 ULONG
03930 <a class="code" href="../../d0/d9/protect_8c.html#a6">MiSetProtectionOnSection</a> (
03931     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process,
03932     IN PMMVAD Vad,
03933     IN PVOID StartingAddress,
03934     IN PVOID EndingAddress,
03935     IN ULONG NewProtect,
03936     OUT PULONG CapturedOldProtect,
03937     IN ULONG DontCharge
03938     );
03939 
03940 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
03941 <a class="code" href="../../d0/d9/protect_8c.html#a9">MiCheckSecuredVad</a> (
03942     IN PMMVAD Vad,
03943     IN PVOID Base,
03944     IN ULONG_PTR Size,
03945     IN ULONG ProtectionMask
03946     );
03947 
03948 ULONG
03949 <a class="code" href="../../d0/d9/protect_8c.html#a8">MiChangeNoAccessForkPte</a> (
03950     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte,
03951     IN ULONG ProtectionMask
03952     );
03953 
03954 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
03955 <a class="code" href="../../d8/d8/sysload_8c.html#a62">MiSetImageProtect</a> (
03956     IN PSEGMENT Segment,
03957     IN ULONG Protection
03958     );
03959 
03960 <span class="comment">//</span>
03961 <span class="comment">// Routines for charging quota and commitment.</span>
03962 <span class="comment">//</span>
03963 
03964 ULONG
03965 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
03966 <a class="code" href="../../d6/d1/mmquota_8c.html#a15">MiChargePageFileQuota</a> (
03967     IN SIZE_T QuotaCharge,
03968     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> CurrentProcess
03969     );
03970 
03971 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
03972 <a class="code" href="../../d0/d2/psquota_8c.html#a5">MiReturnPageFileQuota</a> (
03973     IN SIZE_T QuotaCharge,
03974     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> CurrentProcess
03975     );
03976 
03977 LOGICAL
03978 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
03979 <a class="code" href="../../d6/d1/mmquota_8c.html#a17">MiChargeCommitment</a> (
03980     IN SIZE_T QuotaCharge,
03981     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process OPTIONAL
<a name="l03982"></a><a class="code" href="../../d4/d8/mi_8h.html#a535">03982</a>     );
03983 
<a name="l03984"></a><a class="code" href="../../d4/d8/mi_8h.html#a536">03984</a> LOGICAL
03985 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
03986 <a class="code" href="../../d6/d1/mmquota_8c.html#a18">MiChargeCommitmentCantExpand</a> (
03987     IN SIZE_T QuotaCharge,
03988     IN ULONG MustSucceed
03989     );
03990 
03991 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
03992 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
03993 <a class="code" href="../../d6/d1/mmquota_8c.html#a19">MiReturnCommitment</a> (
03994     IN SIZE_T QuotaCharge
03995     );
03996 
03997 <span class="keyword">extern</span> SIZE_T <a class="code" href="../../d6/d8/sysinfo_8c.html#a5">MmPeakCommitment</a>;
03998 
03999 <span class="keyword">extern</span> SIZE_T <a class="code" href="../../d9/d5/4_2kddata_8c.html#a54">MmTotalCommitLimitMaximum</a>;
04000 
04001 SIZE_T
04002 <a class="code" href="../../d6/d1/mmquota_8c.html#a20">MiCalculatePageCommitment</a> (
04003     IN PVOID StartingAddress,
04004     IN PVOID EndingAddress,
04005     IN PMMVAD Vad,
04006     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process
04007     );
04008 
04009 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
04010 <a class="code" href="../../d6/d1/mmquota_8c.html#a21">MiReturnPageTablePageCommitment</a> (
04011     IN PVOID StartingAddress,
04012     IN PVOID EndingAddress,
04013     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> CurrentProcess,
04014     IN PMMVAD PreviousVad,
04015     IN PMMVAD NextVad
04016     );
04017 
04018 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
04019 <a class="code" href="../../d5/d0/wsmanage_8c.html#a47">MiEmptyAllWorkingSets</a> (
04020     VOID
04021     );
04022 
04023 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
04024 <a class="code" href="../../d6/d3/modwrite_8c.html#a57">MiFlushAllPages</a> (
04025     VOID
04026     );
04027 
04028 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
04029 <a class="code" href="../../d6/d3/modwrite_8c.html#a52">MiModifiedPageWriterTimerDispatch</a> (
04030     IN <a class="code" href="../../d1/d6/struct__KDPC.html">PKDPC</a> Dpc,
04031     IN PVOID DeferredContext,
04032     IN PVOID SystemArgument1,
04033     IN PVOID SystemArgument2
04034     );
04035 
04036 LONGLONG
04037 <a class="code" href="../../d4/d8/mi_8h.html#a952">MiStartingOffset</a>(
04038     IN PSUBSECTION Subsection,
04039     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PteAddress
04040     );
04041 
04042 LARGE_INTEGER
04043 <a class="code" href="../../d4/d8/mi_8h.html#a953">MiEndingOffset</a>(
04044     IN PSUBSECTION Subsection
04045     );
04046 
04047 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
04048 <a class="code" href="../../d8/d8/sysload_8c.html#a64">MiReloadBootLoadedDrivers</a> (
04049     IN <a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a> LoaderBlock
04050     );
04051 
04052 LOGICAL
04053 <a class="code" href="../../d8/d8/sysload_8c.html#a66">MiInitializeLoadedModuleList</a> (
04054     IN <a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a> LoaderBlock
04055     );
04056 
04057 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
04058 <a class="code" href="../../d4/d8/mi_8h.html#a956">MiEnableRandomSpecialPool</a> (
04059     IN LOGICAL Enable
04060     );
04061 
04062 LOGICAL
04063 <a class="code" href="../../d4/d8/mi_8h.html#a957">MiTriageSystem</a> (
04064     IN <a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a> LoaderBlock
<a name="l04065"></a><a class="code" href="../../d4/d8/mi_8h.html#a248">04065</a>     );
04066 
04067 LOGICAL
<a name="l04068"></a><a class="code" href="../../d4/d8/mi_8h.html#a249">04068</a> <a class="code" href="../../d4/d8/mi_8h.html#a958">MiTriageAddDrivers</a> (
04069     IN <a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a> LoaderBlock
<a name="l04070"></a><a class="code" href="../../d4/d8/mi_8h.html#a537">04070</a>     );
<a name="l04071"></a><a class="code" href="../../d4/d8/mi_8h.html#a538">04071</a> 
<a name="l04072"></a><a class="code" href="../../d4/d8/mi_8h.html#a539">04072</a> LOGICAL
04073 <a class="code" href="../../d4/d8/mi_8h.html#a959">MiTriageVerifyDriver</a> (
<a name="l04074"></a><a class="code" href="../../d4/d8/mi_8h.html#a540">04074</a>     IN PLDR_DATA_TABLE_ENTRY DataTableEntry
04075     );
<a name="l04076"></a><a class="code" href="../../d4/d8/mi_8h.html#a541">04076</a> 
<a name="l04077"></a><a class="code" href="../../d4/d8/mi_8h.html#a542">04077</a> <span class="preprocessor">#if defined (_WIN64)</span>
04078 <span class="preprocessor"></span><span class="preprocessor">#define MM_SPECIAL_POOL_PTES ((1024 * 1024) / sizeof (MMPTE))</span>
<a name="l04079"></a><a class="code" href="../../d4/d8/mi_8h.html#a543">04079</a> <span class="preprocessor"></span><span class="preprocessor">#else</span>
04080 <span class="preprocessor"></span><span class="preprocessor">#define MM_SPECIAL_POOL_PTES 25000</span>
<a name="l04081"></a><a class="code" href="../../d4/d8/mi_8h.html#a250">04081</a> <span class="preprocessor"></span><span class="preprocessor">#endif</span>
04082 <span class="preprocessor"></span>
<a name="l04083"></a><a class="code" href="../../d9/d6/struct__VI__POOL__ENTRY__INUSE.html">04083</a> <span class="preprocessor">#define MI_SUSPECT_DRIVER_BUFFER_LENGTH 512</span>
<a name="l04084"></a><a class="code" href="../../d9/d6/struct__VI__POOL__ENTRY__INUSE.html#o0">04084</a> <span class="preprocessor"></span>
<a name="l04085"></a><a class="code" href="../../d9/d6/struct__VI__POOL__ENTRY__INUSE.html#o1">04085</a> <span class="keyword">extern</span> WCHAR <a class="code" href="../../d8/d0/cmdat3_8c.html#a9">MmVerifyDriverBuffer</a>[];
<a name="l04086"></a><a class="code" href="../../d9/d6/struct__VI__POOL__ENTRY__INUSE.html#o2">04086</a> <span class="keyword">extern</span> ULONG <a class="code" href="../../d8/d0/cmdat3_8c.html#a10">MmVerifyDriverBufferLength</a>;
<a name="l04087"></a><a class="code" href="../../d9/d6/struct__VI__POOL__ENTRY__INUSE.html#o3">04087</a> <span class="keyword">extern</span> ULONG <a class="code" href="../../d8/d0/cmdat3_8c.html#a12">MmVerifyDriverLevel</a>;
04088 
04089 <span class="keyword">extern</span> LOGICAL <a class="code" href="../../d8/d0/cmdat3_8c.html#a13">MmDontVerifyRandomDrivers</a>;
<a name="l04090"></a><a class="code" href="../../d7/d6/struct__VI__POOL__ENTRY.html">04090</a> <span class="keyword">extern</span> LOGICAL <a class="code" href="../../d8/d0/cmdat3_8c.html#a32">MmSnapUnloads</a>;
04091 <span class="keyword">extern</span> LOGICAL <a class="code" href="../../d8/d0/cmdat3_8c.html#a36">MmProtectFreedNonPagedPool</a>;
<a name="l04092"></a><a class="code" href="../../d7/d6/struct__VI__POOL__ENTRY.html#o0">04092</a> <span class="keyword">extern</span> ULONG <a class="code" href="../../d8/d0/cmdat3_8c.html#a30">MmEnforceWriteProtection</a>;
<a name="l04093"></a><a class="code" href="../../d7/d6/struct__VI__POOL__ENTRY.html#o1">04093</a> <span class="keyword">extern</span> LOGICAL <a class="code" href="../../d8/d0/cmdat3_8c.html#a33">MmTrackLockedPages</a>;
04094 <span class="keyword">extern</span> LOGICAL <a class="code" href="../../d8/d0/cmdat3_8c.html#a37">MmTrackPtes</a>;
04095 
04096 <span class="preprocessor">#define VI_POOL_FREELIST_END  ((ULONG_PTR)-1)</span>
<a name="l04097"></a><a class="code" href="../../d4/d8/mi_8h.html#a251">04097</a> <span class="preprocessor"></span>
04098 <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d9/d6/struct__VI__POOL__ENTRY__INUSE.html">_VI_POOL_ENTRY_INUSE</a> {
<a name="l04099"></a><a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html">04099</a>     PVOID VirtualAddress;
<a name="l04100"></a><a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o0">04100</a>     PVOID CallingAddress;
<a name="l04101"></a><a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o1">04101</a>     SIZE_T NumberOfBytes;
<a name="l04102"></a><a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o2">04102</a>     ULONG_PTR Tag;
04103 } <a class="code" href="../../d9/d6/struct__VI__POOL__ENTRY__INUSE.html">VI_POOL_ENTRY_INUSE</a>, *<a class="code" href="../../d9/d6/struct__VI__POOL__ENTRY__INUSE.html">PVI_POOL_ENTRY_INUSE</a>;
<a name="l04104"></a><a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o3">04104</a> 
<a name="l04105"></a><a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o4">04105</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d7/d6/struct__VI__POOL__ENTRY.html">_VI_POOL_ENTRY</a> {
<a name="l04106"></a><a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o5">04106</a>     <span class="keyword">union </span>{
04107         <a class="code" href="../../d9/d6/struct__VI__POOL__ENTRY__INUSE.html">VI_POOL_ENTRY_INUSE</a> InUse;
<a name="l04108"></a><a class="code" href="../../d4/d8/mi_8h.html#a252">04108</a>         ULONG_PTR FreeListNext;
<a name="l04109"></a><a class="code" href="../../d4/d8/mi_8h.html#a253">04109</a>     };
04110 } <a class="code" href="../../d7/d6/struct__VI__POOL__ENTRY.html">VI_POOL_ENTRY</a>, *<a class="code" href="../../d7/d6/struct__VI__POOL__ENTRY.html">PVI_POOL_ENTRY</a>;
<a name="l04111"></a><a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o6">04111</a> 
<a name="l04112"></a><a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o7">04112</a> <span class="preprocessor">#define MI_VERIFIER_ENTRY_SIGNATURE            0x98761940</span>
<a name="l04113"></a><a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o8">04113</a> <span class="preprocessor"></span>
<a name="l04114"></a><a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o9">04114</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html">_MI_VERIFIER_DRIVER_ENTRY</a> {
04115     LIST_ENTRY <a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o0">Links</a>;
<a name="l04116"></a><a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o10">04116</a>     ULONG <a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o1">Loads</a>;
<a name="l04117"></a><a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o11">04117</a>     ULONG <a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o2">Unloads</a>;
<a name="l04118"></a><a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o12">04118</a> 
<a name="l04119"></a><a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o13">04119</a>     UNICODE_STRING <a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o3">BaseName</a>;
04120     PVOID <a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o4">StartAddress</a>;
<a name="l04121"></a><a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o14">04121</a>     PVOID <a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o5">EndAddress</a>;
<a name="l04122"></a><a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o15">04122</a> 
<a name="l04123"></a><a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o16">04123</a> <span class="preprocessor">#define VI_VERIFYING_DIRECTLY   0x1</span>
<a name="l04124"></a><a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o17">04124</a> <span class="preprocessor"></span><span class="preprocessor">#define VI_VERIFYING_INVERSELY  0x2</span>
04125 <span class="preprocessor"></span>
<a name="l04126"></a><a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o18">04126</a>     ULONG <a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o6">Flags</a>;
<a name="l04127"></a><a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o19">04127</a>     ULONG_PTR <a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o7">Signature</a>;
<a name="l04128"></a><a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o20">04128</a>     ULONG_PTR <a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o8">Reserved</a>;
<a name="l04129"></a><a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o21">04129</a>     KSPIN_LOCK <a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o9">VerifierPoolLock</a>;
04130 
04131     <a class="code" href="../../d4/d8/mi_8h.html#a547">PVI_POOL_ENTRY</a> <a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o10">PoolHash</a>;
04132     ULONG_PTR <a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html#o11">PoolHashSize</a>;
<a name="l04133"></a><a class="code" href="../../d5/d9/struct__MI__VERIFIER__POOL__HEADER.html">04133</a>     ULONG_PTR PoolHashFree;
<a name="l04134"></a><a class="code" href="../../d5/d9/struct__MI__VERIFIER__POOL__HEADER.html#o0">04134</a>     ULONG_PTR PoolHashReserved;
<a name="l04135"></a><a class="code" href="../../d5/d9/struct__MI__VERIFIER__POOL__HEADER.html#o1">04135</a> 
04136     ULONG CurrentPagedPoolAllocations;
04137     ULONG CurrentNonPagedPoolAllocations;
<a name="l04138"></a><a class="code" href="../../d8/d9/struct__MM__DRIVER__VERIFIER__DATA.html">04138</a>     ULONG PeakPagedPoolAllocations;
<a name="l04139"></a><a class="code" href="../../d8/d9/struct__MM__DRIVER__VERIFIER__DATA.html#o0">04139</a>     ULONG PeakNonPagedPoolAllocations;
<a name="l04140"></a><a class="code" href="../../d8/d9/struct__MM__DRIVER__VERIFIER__DATA.html#o1">04140</a> 
<a name="l04141"></a><a class="code" href="../../d8/d9/struct__MM__DRIVER__VERIFIER__DATA.html#o2">04141</a>     SIZE_T PagedBytes;
<a name="l04142"></a><a class="code" href="../../d8/d9/struct__MM__DRIVER__VERIFIER__DATA.html#o3">04142</a>     SIZE_T NonPagedBytes;
04143     SIZE_T PeakPagedBytes;
<a name="l04144"></a><a class="code" href="../../d8/d9/struct__MM__DRIVER__VERIFIER__DATA.html#o4">04144</a>     SIZE_T PeakNonPagedBytes;
<a name="l04145"></a><a class="code" href="../../d8/d9/struct__MM__DRIVER__VERIFIER__DATA.html#o5">04145</a> 
<a name="l04146"></a><a class="code" href="../../d8/d9/struct__MM__DRIVER__VERIFIER__DATA.html#o6">04146</a> } <a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html">MI_VERIFIER_DRIVER_ENTRY</a>, *<a class="code" href="../../d4/d9/struct__MI__VERIFIER__DRIVER__ENTRY.html">PMI_VERIFIER_DRIVER_ENTRY</a>;
<a name="l04147"></a><a class="code" href="../../d8/d9/struct__MM__DRIVER__VERIFIER__DATA.html#o7">04147</a> 
04148 <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d5/d9/struct__MI__VERIFIER__POOL__HEADER.html">_MI_VERIFIER_POOL_HEADER</a> {
<a name="l04149"></a><a class="code" href="../../d8/d9/struct__MM__DRIVER__VERIFIER__DATA.html#o8">04149</a>     ULONG_PTR ListIndex;
<a name="l04150"></a><a class="code" href="../../d8/d9/struct__MM__DRIVER__VERIFIER__DATA.html#o9">04150</a>     <a class="code" href="../../d4/d8/mi_8h.html#a549">PMI_VERIFIER_DRIVER_ENTRY</a> Verifier;
<a name="l04151"></a><a class="code" href="../../d8/d9/struct__MM__DRIVER__VERIFIER__DATA.html#o10">04151</a> } <a class="code" href="../../d5/d9/struct__MI__VERIFIER__POOL__HEADER.html">MI_VERIFIER_POOL_HEADER</a>, *<a class="code" href="../../d5/d9/struct__MI__VERIFIER__POOL__HEADER.html">PMI_VERIFIER_POOL_HEADER</a>;
<a name="l04152"></a><a class="code" href="../../d8/d9/struct__MM__DRIVER__VERIFIER__DATA.html#o11">04152</a> 
04153 <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d8/d9/struct__MM__DRIVER__VERIFIER__DATA.html">_MM_DRIVER_VERIFIER_DATA</a> {
<a name="l04154"></a><a class="code" href="../../d8/d9/struct__MM__DRIVER__VERIFIER__DATA.html#o12">04154</a>     ULONG <a class="code" href="../../d8/d9/struct__MM__DRIVER__VERIFIER__DATA.html#o0">Level</a>;
<a name="l04155"></a><a class="code" href="../../d8/d9/struct__MM__DRIVER__VERIFIER__DATA.html#o13">04155</a>     ULONG <a class="code" href="../../d8/d9/struct__MM__DRIVER__VERIFIER__DATA.html#o1">RaiseIrqls</a>;
<a name="l04156"></a><a class="code" href="../../d8/d9/struct__MM__DRIVER__VERIFIER__DATA.html#o14">04156</a>     ULONG <a class="code" href="../../d8/d9/struct__MM__DRIVER__VERIFIER__DATA.html#o2">AcquireSpinLocks</a>;
<a name="l04157"></a><a class="code" href="../../d8/d9/struct__MM__DRIVER__VERIFIER__DATA.html#o15">04157</a>     ULONG <a class="code" href="../../d8/d9/struct__MM__DRIVER__VERIFIER__DATA.html#o3">SynchronizeExecutions</a>;
04158 
<a name="l04159"></a><a class="code" href="../../d8/d9/struct__MM__DRIVER__VERIFIER__DATA.html#o16">04159</a>     ULONG <a class="code" href="../../d8/d9/struct__MM__DRIVER__VERIFIER__DATA.html#o4">AllocationsAttempted</a>;
<a name="l04160"></a><a class="code" href="../../d8/d9/struct__MM__DRIVER__VERIFIER__DATA.html#o17">04160</a>     ULONG <a class="code" href="../../d8/d9/struct__MM__DRIVER__VERIFIER__DATA.html#o5">AllocationsSucceeded</a>;
<a name="l04161"></a><a class="code" href="../../d8/d9/struct__MM__DRIVER__VERIFIER__DATA.html#o18">04161</a>     ULONG <a class="code" href="../../d8/d9/struct__MM__DRIVER__VERIFIER__DATA.html#o6">AllocationsSucceededSpecialPool</a>;
<a name="l04162"></a><a class="code" href="../../d8/d9/struct__MM__DRIVER__VERIFIER__DATA.html#o19">04162</a>     ULONG <a class="code" href="../../d8/d9/struct__MM__DRIVER__VERIFIER__DATA.html#o7">AllocationsWithNoTag</a>;
04163 
<a name="l04164"></a><a class="code" href="../../d8/d9/struct__MM__DRIVER__VERIFIER__DATA.html#o20">04164</a>     ULONG <a class="code" href="../../d8/d9/struct__MM__DRIVER__VERIFIER__DATA.html#o8">TrimRequests</a>;
<a name="l04165"></a><a class="code" href="../../d8/d9/struct__MM__DRIVER__VERIFIER__DATA.html#o21">04165</a>     ULONG <a class="code" href="../../d8/d9/struct__MM__DRIVER__VERIFIER__DATA.html#o9">Trims</a>;
<a name="l04166"></a><a class="code" href="../../d8/d9/struct__MM__DRIVER__VERIFIER__DATA.html#o22">04166</a>     ULONG <a class="code" href="../../d8/d9/struct__MM__DRIVER__VERIFIER__DATA.html#o10">AllocationsFailed</a>;
<a name="l04167"></a><a class="code" href="../../d8/d9/struct__MM__DRIVER__VERIFIER__DATA.html#o23">04167</a>     ULONG <a class="code" href="../../d8/d9/struct__MM__DRIVER__VERIFIER__DATA.html#o11">AllocationsFailedDeliberately</a>;
04168 
04169     ULONG <a class="code" href="../../d8/d9/struct__MM__DRIVER__VERIFIER__DATA.html#o12">Loads</a>;
04170     ULONG <a class="code" href="../../d8/d9/struct__MM__DRIVER__VERIFIER__DATA.html#o13">Unloads</a>;
04171     ULONG <a class="code" href="../../d8/d9/struct__MM__DRIVER__VERIFIER__DATA.html#o14">UnTrackedPool</a>;
04172     ULONG <a class="code" href="../../d8/d9/struct__MM__DRIVER__VERIFIER__DATA.html#o15">Fill</a>;
04173 
04174     ULONG <a class="code" href="../../d8/d9/struct__MM__DRIVER__VERIFIER__DATA.html#o16">CurrentPagedPoolAllocations</a>;
04175     ULONG <a class="code" href="../../d8/d9/struct__MM__DRIVER__VERIFIER__DATA.html#o17">CurrentNonPagedPoolAllocations</a>;
04176     ULONG <a class="code" href="../../d8/d9/struct__MM__DRIVER__VERIFIER__DATA.html#o18">PeakPagedPoolAllocations</a>;
04177     ULONG <a class="code" href="../../d8/d9/struct__MM__DRIVER__VERIFIER__DATA.html#o19">PeakNonPagedPoolAllocations</a>;
04178 
04179     SIZE_T <a class="code" href="../../d8/d9/struct__MM__DRIVER__VERIFIER__DATA.html#o20">PagedBytes</a>;
04180     SIZE_T <a class="code" href="../../d8/d9/struct__MM__DRIVER__VERIFIER__DATA.html#o21">NonPagedBytes</a>;
04181     SIZE_T <a class="code" href="../../d8/d9/struct__MM__DRIVER__VERIFIER__DATA.html#o22">PeakPagedBytes</a>;
04182     SIZE_T <a class="code" href="../../d8/d9/struct__MM__DRIVER__VERIFIER__DATA.html#o23">PeakNonPagedBytes</a>;
04183 
04184 } <a class="code" href="../../d8/d9/struct__MM__DRIVER__VERIFIER__DATA.html">MM_DRIVER_VERIFIER_DATA</a>, *<a class="code" href="../../d8/d9/struct__MM__DRIVER__VERIFIER__DATA.html">PMM_DRIVER_VERIFIER_DATA</a>;
04185 
04186 LOGICAL
04187 <a class="code" href="../../d9/d5/verifier_8c.html#a109">MiInitializeDriverVerifierList</a> (
04188     IN <a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a> LoaderBlock
04189     );
04190 
04191 LOGICAL
<a name="l04192"></a><a class="code" href="../../d4/d8/mi_8h.html#a554">04192</a> <a class="code" href="../../d9/d5/verifier_8c.html#a110">MiApplyDriverVerifier</a> (
<a name="l04193"></a><a class="code" href="../../d4/d8/mi_8h.html#a555">04193</a>     IN PLDR_DATA_TABLE_ENTRY,
04194     IN PMI_VERIFIER_DRIVER_ENTRY Verifier
<a name="l04195"></a><a class="code" href="../../d4/d8/mi_8h.html#a556">04195</a>     );
04196 
<a name="l04197"></a><a class="code" href="../../d4/d8/mi_8h.html#a557">04197</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
04198 <a class="code" href="../../d9/d5/verifier_8c.html#a111">MiVerifyingDriverUnloading</a> (
04199     IN PLDR_DATA_TABLE_ENTRY DataTableEntry
04200     );
04201 
04202 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
04203 <a class="code" href="../../d9/d5/verifier_8c.html#a106">MiVerifierCheckThunks</a> (
04204     IN PLDR_DATA_TABLE_ENTRY DataTableEntry
04205     );
04206 
04207 <span class="keyword">extern</span> ULONG <a class="code" href="../../d4/d8/mi_8h.html#a554">MiActiveVerifierThunks</a>;
04208 <span class="keyword">extern</span> LIST_ENTRY <a class="code" href="../../d4/d8/mi_8h.html#a555">MiSuspectDriverList</a>;
04209 
04210 <span class="keyword">extern</span> LOGICAL <a class="code" href="../../d2/d2/ex_2pool_8c.html#a61">KernelVerifier</a>;
04211 
04212 <span class="keyword">extern</span> <a class="code" href="../../d8/d9/struct__MM__DRIVER__VERIFIER__DATA.html">MM_DRIVER_VERIFIER_DATA</a> <a class="code" href="../../d9/d5/4_2kddata_8c.html#a51">MmVerifierData</a>;
04213 
04214 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
04215 <a class="code" href="../../d4/d8/mi_8h.html#a964">MiEnableKernelVerifier</a> (
04216     VOID
04217     );
04218 
04219 <span class="preprocessor">#if 0</span>
04220 <span class="preprocessor"></span>
<a name="l04221"></a><a class="code" href="../../d4/d8/mi_8h.html#a254">04221</a> <span class="preprocessor">#define MM_COMMIT_COUNTER_MAX 70</span>
04222 <span class="preprocessor"></span>
04223 <span class="preprocessor">#define MM_TRACK_COMMIT(_index, bump) \</span>
04224 <span class="preprocessor">    if (_index &gt;= MM_COMMIT_COUNTER_MAX) { \</span>
<a name="l04225"></a><a class="code" href="../../d4/d8/mi_8h.html#a255">04225</a> <span class="preprocessor">        DbgPrint("Mm: Invalid commit counter %d %d\n", _index, MM_COMMIT_COUNTER_MAX); \</span>
04226 <span class="preprocessor">        DbgBreakPoint(); \</span>
<a name="l04227"></a><a class="code" href="../../d4/d8/mi_8h.html#a256">04227</a> <span class="preprocessor">    } \</span>
04228 <span class="preprocessor">    else { \</span>
<a name="l04229"></a><a class="code" href="../../d1/d9/struct__MI__FREED__SPECIAL__POOL.html">04229</a> <span class="preprocessor">        MmTrackCommit[_index] += (bump); \</span>
<a name="l04230"></a><a class="code" href="../../d1/d9/struct__MI__FREED__SPECIAL__POOL.html#o0">04230</a> <span class="preprocessor">    }</span>
<a name="l04231"></a><a class="code" href="../../d1/d9/struct__MI__FREED__SPECIAL__POOL.html#o1">04231</a> <span class="preprocessor"></span>
04232 <span class="keyword">extern</span> SIZE_T MmTrackCommit[MM_COMMIT_COUNTER_MAX];
<a name="l04233"></a><a class="code" href="../../d1/d9/struct__MI__FREED__SPECIAL__POOL.html#o2">04233</a> 
<a name="l04234"></a><a class="code" href="../../d1/d9/struct__MI__FREED__SPECIAL__POOL.html#o3">04234</a> <span class="preprocessor">#else</span>
<a name="l04235"></a><a class="code" href="../../d1/d9/struct__MI__FREED__SPECIAL__POOL.html#o4">04235</a> <span class="preprocessor"></span>
<a name="l04236"></a><a class="code" href="../../d1/d9/struct__MI__FREED__SPECIAL__POOL.html#o5">04236</a> <span class="preprocessor">#define MM_TRACK_COMMIT(_index, bump)</span>
04237 <span class="preprocessor"></span>
<a name="l04238"></a><a class="code" href="../../d1/d9/struct__MI__FREED__SPECIAL__POOL.html#o6">04238</a> <span class="preprocessor">#endif</span>
<a name="l04239"></a><a class="code" href="../../d1/d9/struct__MI__FREED__SPECIAL__POOL.html#o7">04239</a> <span class="preprocessor"></span>
<a name="l04240"></a><a class="code" href="../../d1/d9/struct__MI__FREED__SPECIAL__POOL.html#o8">04240</a> <span class="preprocessor">#define MI_FREED_SPECIAL_POOL_SIGNATURE 0x98764321</span>
<a name="l04241"></a><a class="code" href="../../d1/d9/struct__MI__FREED__SPECIAL__POOL.html#o9">04241</a> <span class="preprocessor"></span>
04242 <span class="preprocessor">#define MI_STACK_BYTES 1024</span>
<a name="l04243"></a><a class="code" href="../../d1/d9/struct__MI__FREED__SPECIAL__POOL.html#o10">04243</a> <span class="preprocessor"></span>
04244 <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d1/d9/struct__MI__FREED__SPECIAL__POOL.html">_MI_FREED_SPECIAL_POOL</a> {
04245     <a class="code" href="../../d5/d8/struct__POOL__HEADER.html">POOL_HEADER</a> <a class="code" href="../../d1/d9/struct__MI__FREED__SPECIAL__POOL.html#o0">OverlaidPoolHeader</a>;
<a name="l04246"></a><a class="code" href="../../d4/d8/mi_8h.html#a257">04246</a>     <a class="code" href="../../d5/d9/struct__MI__VERIFIER__POOL__HEADER.html">MI_VERIFIER_POOL_HEADER</a> OverlaidVerifierPoolHeader;
<a name="l04247"></a><a class="code" href="../../d4/d8/mi_8h.html#a258">04247</a> 
<a name="l04248"></a><a class="code" href="../../d4/d8/mi_8h.html#a259">04248</a>     ULONG Signature;
<a name="l04249"></a><a class="code" href="../../d4/d8/mi_8h.html#a260">04249</a>     ULONG TickCount;
<a name="l04250"></a><a class="code" href="../../d4/d8/mi_8h.html#a261">04250</a>     ULONG NumberOfBytesRequested;
<a name="l04251"></a><a class="code" href="../../d4/d8/mi_8h.html#a262">04251</a>     ULONG Pagable;
<a name="l04252"></a><a class="code" href="../../d4/d8/mi_8h.html#a263">04252</a> 
<a name="l04253"></a><a class="code" href="../../d4/d8/mi_8h.html#a264">04253</a>     PVOID VirtualAddress;
<a name="l04254"></a><a class="code" href="../../d4/d8/mi_8h.html#a265">04254</a>     PVOID StackPointer;
<a name="l04255"></a><a class="code" href="../../d4/d8/mi_8h.html#a266">04255</a>     ULONG StackBytes;
<a name="l04256"></a><a class="code" href="../../d4/d8/mi_8h.html#a267">04256</a>     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> Thread;
<a name="l04257"></a><a class="code" href="../../d4/d8/mi_8h.html#a268">04257</a> 
<a name="l04258"></a><a class="code" href="../../d4/d8/mi_8h.html#a269">04258</a>     UCHAR StackData[<a class="code" href="../../d4/d8/mi_8h.html#a256">MI_STACK_BYTES</a>];
<a name="l04259"></a><a class="code" href="../../d4/d8/mi_8h.html#a270">04259</a> } <a class="code" href="../../d1/d9/struct__MI__FREED__SPECIAL__POOL.html">MI_FREED_SPECIAL_POOL</a>, *<a class="code" href="../../d1/d9/struct__MI__FREED__SPECIAL__POOL.html">PMI_FREED_SPECIAL_POOL</a>;
<a name="l04260"></a><a class="code" href="../../d4/d8/mi_8h.html#a271">04260</a> 
<a name="l04261"></a><a class="code" href="../../d4/d8/mi_8h.html#a272">04261</a> <span class="preprocessor">#define MM_DBG_COMMIT_NONPAGED_POOL_EXPANSION           0</span>
<a name="l04262"></a><a class="code" href="../../d4/d8/mi_8h.html#a273">04262</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_DBG_COMMIT_PAGED_POOL_PAGETABLE              1</span>
<a name="l04263"></a><a class="code" href="../../d4/d8/mi_8h.html#a274">04263</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_DBG_COMMIT_PAGED_POOL_PAGES                  2</span>
<a name="l04264"></a><a class="code" href="../../d4/d8/mi_8h.html#a275">04264</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_DBG_COMMIT_SESSION_POOL_PAGE_TABLES          3</span>
<a name="l04265"></a><a class="code" href="../../d4/d8/mi_8h.html#a276">04265</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_DBG_COMMIT_ALLOCVM1                          4</span>
<a name="l04266"></a><a class="code" href="../../d4/d8/mi_8h.html#a277">04266</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_DBG_COMMIT_ALLOCVM2                          5</span>
<a name="l04267"></a><a class="code" href="../../d4/d8/mi_8h.html#a278">04267</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_DBG_COMMIT_IMAGE                             6</span>
<a name="l04268"></a><a class="code" href="../../d4/d8/mi_8h.html#a279">04268</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_DBG_COMMIT_PAGEFILE_BACKED_SHMEM             7</span>
<a name="l04269"></a><a class="code" href="../../d4/d8/mi_8h.html#a280">04269</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_DBG_COMMIT_INDEPENDENT_PAGES                 8</span>
<a name="l04270"></a><a class="code" href="../../d4/d8/mi_8h.html#a281">04270</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_DBG_COMMIT_CONTIGUOUS_PAGES                  9</span>
<a name="l04271"></a><a class="code" href="../../d4/d8/mi_8h.html#a282">04271</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_DBG_COMMIT_MDL_PAGES                         10</span>
<a name="l04272"></a><a class="code" href="../../d4/d8/mi_8h.html#a283">04272</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_DBG_COMMIT_NONCACHED_PAGES                   11</span>
<a name="l04273"></a><a class="code" href="../../d4/d8/mi_8h.html#a284">04273</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_DBG_COMMIT_MAPVIEW_DATA                      12</span>
<a name="l04274"></a><a class="code" href="../../d4/d8/mi_8h.html#a285">04274</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_DBG_COMMIT_FILL_SYSTEM_DIRECTORY             13</span>
04275 <span class="preprocessor"></span><span class="preprocessor">#define MM_DBG_COMMIT_EXTRA_SYSTEM_PTES                 14</span>
<a name="l04276"></a><a class="code" href="../../d4/d8/mi_8h.html#a286">04276</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_DBG_COMMIT_DRIVER_PAGING_AT_INIT             15</span>
<a name="l04277"></a><a class="code" href="../../d4/d8/mi_8h.html#a287">04277</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_DBG_COMMIT_PAGEFILE_FULL                     16</span>
<a name="l04278"></a><a class="code" href="../../d4/d8/mi_8h.html#a288">04278</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_DBG_COMMIT_PROCESS_CREATE                    17</span>
<a name="l04279"></a><a class="code" href="../../d4/d8/mi_8h.html#a289">04279</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_DBG_COMMIT_KERNEL_STACK_CREATE               18</span>
<a name="l04280"></a><a class="code" href="../../d4/d8/mi_8h.html#a290">04280</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_DBG_COMMIT_SET_PROTECTION                    19</span>
<a name="l04281"></a><a class="code" href="../../d4/d8/mi_8h.html#a291">04281</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_DBG_COMMIT_SESSION_CREATE                    20</span>
<a name="l04282"></a><a class="code" href="../../d4/d8/mi_8h.html#a292">04282</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_DBG_COMMIT_SESSION_IMAGE_PAGES               21</span>
<a name="l04283"></a><a class="code" href="../../d4/d8/mi_8h.html#a293">04283</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_DBG_COMMIT_SESSION_PAGETABLE_PAGES           22</span>
<a name="l04284"></a><a class="code" href="../../d4/d8/mi_8h.html#a294">04284</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_DBG_COMMIT_SESSION_SHARED_IMAGE              23</span>
<a name="l04285"></a><a class="code" href="../../d4/d8/mi_8h.html#a295">04285</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_DBG_COMMIT_DRIVER_PAGES                      24</span>
<a name="l04286"></a><a class="code" href="../../d4/d8/mi_8h.html#a296">04286</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_DBG_COMMIT_INSERT_VAD                        25</span>
<a name="l04287"></a><a class="code" href="../../d4/d8/mi_8h.html#a297">04287</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_DBG_COMMIT_SESSION_WS_INIT                   26</span>
<a name="l04288"></a><a class="code" href="../../d4/d8/mi_8h.html#a298">04288</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_DBG_COMMIT_SESSION_ADDITIONAL_WS_PAGES       27</span>
<a name="l04289"></a><a class="code" href="../../d4/d8/mi_8h.html#a299">04289</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_DBG_COMMIT_SESSION_ADDITIONAL_WS_HASHPAGES   28</span>
<a name="l04290"></a><a class="code" href="../../d4/d8/mi_8h.html#a300">04290</a> <span class="preprocessor"></span>
<a name="l04291"></a><a class="code" href="../../d4/d8/mi_8h.html#a301">04291</a> <span class="preprocessor">#define MM_DBG_COMMIT_RETURN_NONPAGED_POOL_EXPANSION    29</span>
<a name="l04292"></a><a class="code" href="../../d4/d8/mi_8h.html#a302">04292</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_DBG_COMMIT_RETURN_PAGED_POOL_PAGES           30</span>
<a name="l04293"></a><a class="code" href="../../d4/d8/mi_8h.html#a303">04293</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_DBG_COMMIT_RETURN_SESSION_POOL_PAGE_TABLES   31</span>
<a name="l04294"></a><a class="code" href="../../d4/d8/mi_8h.html#a304">04294</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_DBG_COMMIT_RETURN_ALLOCVM1                   32</span>
<a name="l04295"></a><a class="code" href="../../d4/d8/mi_8h.html#a305">04295</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_DBG_COMMIT_RETURN_ALLOCVM2                   33</span>
<a name="l04296"></a><a class="code" href="../../d4/d8/mi_8h.html#a306">04296</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_DBG_COMMIT_RETURN_ALLOCVM3                   34</span>
<a name="l04297"></a><a class="code" href="../../d4/d8/mi_8h.html#a307">04297</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_DBG_COMMIT_RETURN_IMAGE_NO_LARGE_CA          35</span>
<a name="l04298"></a><a class="code" href="../../d4/d8/mi_8h.html#a308">04298</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_DBG_COMMIT_RETURN_PAGEFILE_BACKED_SHMEM      36</span>
<a name="l04299"></a><a class="code" href="../../d4/d8/mi_8h.html#a309">04299</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_DBG_COMMIT_RETURN_NTFREEVM1                  37</span>
<a name="l04300"></a><a class="code" href="../../d4/d8/mi_8h.html#a310">04300</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_DBG_COMMIT_RETURN_NTFREEVM2                  38</span>
<a name="l04301"></a><a class="code" href="../../d4/d8/mi_8h.html#a311">04301</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_DBG_COMMIT_RETURN_NTFREEVM3                  39</span>
<a name="l04302"></a><a class="code" href="../../d4/d8/mi_8h.html#a312">04302</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_DBG_COMMIT_RETURN_NTFREEVM4                  40</span>
<a name="l04303"></a><a class="code" href="../../d4/d8/mi_8h.html#a313">04303</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_DBG_COMMIT_RETURN_MDL_PAGES                  41</span>
<a name="l04304"></a><a class="code" href="../../d4/d8/mi_8h.html#a314">04304</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_DBG_COMMIT_RETURN_NONCACHED_PAGES            42</span>
<a name="l04305"></a><a class="code" href="../../d4/d8/mi_8h.html#a315">04305</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_DBG_COMMIT_RETURN_MAPVIEW_DATA               43</span>
<a name="l04306"></a><a class="code" href="../../d4/d8/mi_8h.html#a316">04306</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_DBG_COMMIT_RETURN_PAGETABLES                 44</span>
<a name="l04307"></a><a class="code" href="../../d4/d8/mi_8h.html#a317">04307</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_DBG_COMMIT_RETURN_PROTECTION                 45</span>
<a name="l04308"></a><a class="code" href="../../d4/d8/mi_8h.html#a318">04308</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_DBG_COMMIT_RETURN_SEGMENT_DELETE1            46</span>
<a name="l04309"></a><a class="code" href="../../d4/d8/mi_8h.html#a319">04309</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_DBG_COMMIT_RETURN_SEGMENT_DELETE2            47</span>
<a name="l04310"></a><a class="code" href="../../d4/d8/mi_8h.html#a320">04310</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_DBG_COMMIT_RETURN_SESSION_CREATE_FAILURE1    48</span>
04311 <span class="preprocessor"></span><span class="preprocessor">#define MM_DBG_COMMIT_RETURN_SESSION_DEREFERENCE        49</span>
04312 <span class="preprocessor"></span><span class="preprocessor">#define MM_DBG_COMMIT_RETURN_SESSION_IMAGE_FAILURE1     50</span>
04313 <span class="preprocessor"></span><span class="preprocessor">#define MM_DBG_COMMIT_RETURN_SESSION_PAGETABLE_PAGES    51</span>
04314 <span class="preprocessor"></span><span class="preprocessor">#define MM_DBG_COMMIT_RETURN_VAD                        52</span>
<a name="l04315"></a><a class="code" href="../../d4/d8/mi_8h.html#a321">04315</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_DBG_COMMIT_RETURN_SESSION_WSL_FAILURE        54</span>
04316 <span class="preprocessor"></span><span class="preprocessor">#define MM_DBG_COMMIT_RETURN_PROCESS_CREATE_FAILURE1    55</span>
<a name="l04317"></a><a class="code" href="../../d4/d8/mi_8h.html#a322">04317</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_DBG_COMMIT_RETURN_PROCESS_DELETE             56</span>
04318 <span class="preprocessor"></span><span class="preprocessor">#define MM_DBG_COMMIT_RETURN_PROCESS_CLEAN_PAGETABLES   57</span>
04319 <span class="preprocessor"></span><span class="preprocessor">#define MM_DBG_COMMIT_RETURN_KERNEL_STACK_FAILURE1      58</span>
04320 <span class="preprocessor"></span><span class="preprocessor">#define MM_DBG_COMMIT_RETURN_KERNEL_STACK_FAILURE2      59</span>
04321 <span class="preprocessor"></span><span class="preprocessor">#define MM_DBG_COMMIT_RETURN_KERNEL_STACK_DELETE        60</span>
04322 <span class="preprocessor"></span><span class="preprocessor">#define MM_DBG_COMMIT_RETURN_SESSION_DRIVER_LOAD_FAILURE1 61</span>
04323 <span class="preprocessor"></span><span class="preprocessor">#define MM_DBG_COMMIT_RETURN_DRIVER_INIT_CODE           62</span>
04324 <span class="preprocessor"></span><span class="preprocessor">#define MM_DBG_COMMIT_RETURN_DRIVER_UNLOAD              63</span>
04325 <span class="preprocessor"></span><span class="preprocessor">#define MM_DBG_COMMIT_RETURN_DRIVER_UNLOAD1             64</span>
04326 <span class="preprocessor"></span>
04327 
04328 <span class="preprocessor">#if 1   // LWFIX - TEMP TEMP TEMP</span>
04329 <span class="preprocessor"></span>
04330 <span class="preprocessor">#define MM_BUMP_COUNTER_MAX 60</span>
<a name="l04331"></a><a class="code" href="../../d4/d8/mi_8h.html#a560">04331</a> <span class="preprocessor"></span>
<a name="l04332"></a><a class="code" href="../../d4/d8/mi_8h.html#a561">04332</a> <span class="preprocessor">#define MM_BUMP_COUNTER(_index, bump) \</span>
04333 <span class="preprocessor">    if (_index &gt;= MM_BUMP_COUNTER_MAX) { \</span>
<a name="l04334"></a><a class="code" href="../../d4/d8/mi_8h.html#a562">04334</a> <span class="preprocessor">        DbgPrint("Mm: Invalid bump counter %d %d\n", _index, MM_BUMP_COUNTER_MAX); \</span>
04335 <span class="preprocessor">        DbgBreakPoint(); \</span>
04336 <span class="preprocessor">    } \</span>
04337 <span class="preprocessor">    else { \</span>
04338 <span class="preprocessor">        MmResTrack[_index] += (bump); \</span>
04339 <span class="preprocessor">    }</span>
04340 <span class="preprocessor"></span><span class="preprocessor">#else</span>
04341 <span class="preprocessor"></span>
04342 <span class="preprocessor">#define MM_BUMP_COUNTER(_index, bump)</span>
04343 <span class="preprocessor"></span>
04344 <span class="preprocessor">#endif</span>
04345 <span class="preprocessor"></span>
04346 <span class="keyword">extern</span> ULONG <a class="code" href="../../d1/d6/allocpag_8c.html#a19">MiSpecialPagesNonPaged</a>;
04347 <span class="keyword">extern</span> ULONG <a class="code" href="../../d1/d6/allocpag_8c.html#a25">MiSpecialPagesNonPagedMaximum</a>;
04348 
04349 <span class="keyword">extern</span> ULONG <a class="code" href="../../d8/d0/cmdat3_8c.html#a21">MmLockPagesPercentage</a>;
04350 
04351 <span class="comment">//++</span>
04352 <span class="comment">//PFN_NUMBER</span>
04353 <span class="comment">//MI_NONPAGABLE_MEMORY_AVAILABLE(</span>
04354 <span class="comment">//    VOID</span>
04355 <span class="comment">//    );</span>
04356 <span class="comment">//</span>
04357 <span class="comment">// Routine Description:</span>
04358 <span class="comment">//</span>
04359 <span class="comment">//    This routine lets callers know how many pages can be charged against</span>
<a name="l04360"></a><a class="code" href="../../d4/d8/mi_8h.html#a323">04360</a> <span class="comment">//    the resident available, factoring in earlier Mm promises that</span>
04361 <span class="comment">//    may not have been redeemed at this point (ie: nonpaged pool expansion,</span>
04362 <span class="comment">//    etc, that must be honored at a later point if requested).</span>
04363 <span class="comment">//</span>
04364 <span class="comment">// Arguments</span>
04365 <span class="comment">//</span>
04366 <span class="comment">//    None.</span>
<a name="l04367"></a><a class="code" href="../../d4/d8/mi_8h.html#a563">04367</a> <span class="comment">//</span>
04368 <span class="comment">// Return Value:</span>
04369 <span class="comment">//</span>
04370 <span class="comment">//    The number of currently available pages in the resident available.</span>
04371 <span class="comment">//</span>
04372 <span class="comment">//    N.B.  This is a signed quantity and can be negative.</span>
04373 <span class="comment">//</span>
04374 <span class="comment">//--</span>
04375 <span class="preprocessor">#define MI_NONPAGABLE_MEMORY_AVAILABLE()                                    \</span>
04376 <span class="preprocessor">        ((SPFN_NUMBER)                                                      \</span>
04377 <span class="preprocessor">            (MmResidentAvailablePages -                                     \</span>
04378 <span class="preprocessor">             MmTotalFreeSystemPtes[NonPagedPoolExpansion] -                 \</span>
04379 <span class="preprocessor">             (MiSpecialPagesNonPagedMaximum - MiSpecialPagesNonPaged) -     \</span>
04380 <span class="preprocessor">             MmSystemLockPagesCount))</span>
04381 <span class="preprocessor"></span>
04382 <span class="keyword">extern</span> ULONG <a class="code" href="../../d8/d0/cmdat3_8c.html#a31">MmLargePageMinimum</a>;
04383 
04384 <span class="comment">//</span>
04385 <span class="comment">// hack stuff for testing.</span>
04386 <span class="comment">//</span>
04387 
04388 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
04389 <a class="code" href="../../d4/d8/mi_8h.html#a965">MiDumpValidAddresses</a> (
04390     VOID
04391     );
04392 
04393 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
04394 <a class="code" href="../../d4/d8/mi_8h.html#a966">MiDumpPfn</a> ( VOID );
04395 
04396 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
04397 <a class="code" href="../../d4/d8/mi_8h.html#a967">MiDumpWsl</a> ( VOID );
04398 
04399 
04400 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
04401 <a class="code" href="../../d4/d8/mi_8h.html#a968">MiFormatPte</a> (
04402     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte
04403     );
<a name="l04404"></a><a class="code" href="../../d4/d8/mi_8h.html#a564">04404</a> 
04405 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l04406"></a><a class="code" href="../../d4/d8/mi_8h.html#a565">04406</a> <a class="code" href="../../d4/d8/mi_8h.html#a969">MiCheckPfn</a> ( VOID );
04407 
<a name="l04408"></a><a class="code" href="../../d4/d8/mi_8h.html#a566">04408</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
04409 <a class="code" href="../../d4/d8/mi_8h.html#a970">MiCheckPte</a> ( VOID );
<a name="l04410"></a><a class="code" href="../../d4/d8/mi_8h.html#a567">04410</a> 
04411 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l04412"></a><a class="code" href="../../d4/d8/mi_8h.html#a568">04412</a> <a class="code" href="../../d4/d8/mi_8h.html#a971">MiFormatPfn</a> (
04413     IN PMMPFN PointerPfn
<a name="l04414"></a><a class="code" href="../../d4/d8/mi_8h.html#a569">04414</a>     );
04415 
<a name="l04416"></a><a class="code" href="../../d4/d8/mi_8h.html#a570">04416</a> 
04417 
<a name="l04418"></a><a class="code" href="../../d4/d8/mi_8h.html#a571">04418</a> 
04419 <span class="keyword">extern</span> <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> <a class="code" href="../../d4/d2/datalpha_8c.html#a0">ZeroPte</a>;
<a name="l04420"></a><a class="code" href="../../d4/d8/mi_8h.html#a572">04420</a> 
04421 <span class="keyword">extern</span> <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> <a class="code" href="../../d4/d2/datalpha_8c.html#a1">ZeroKernelPte</a>;
<a name="l04422"></a><a class="code" href="../../d4/d8/mi_8h.html#a573">04422</a> 
04423 <span class="keyword">extern</span> <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> <a class="code" href="../../d4/d2/datalpha_8c.html#a3">ValidKernelPteLocal</a>;
<a name="l04424"></a><a class="code" href="../../d4/d8/mi_8h.html#a574">04424</a> 
04425 <span class="keyword">extern</span> <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> <a class="code" href="../../d4/d2/datalpha_8c.html#a2">ValidKernelPte</a>;
<a name="l04426"></a><a class="code" href="../../d4/d8/mi_8h.html#a575">04426</a> 
04427 <span class="keyword">extern</span> <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> <a class="code" href="../../d4/d2/datalpha_8c.html#a7">ValidKernelPde</a>;
<a name="l04428"></a><a class="code" href="../../d4/d8/mi_8h.html#a576">04428</a> 
04429 <span class="keyword">extern</span> <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> <a class="code" href="../../d4/d2/datalpha_8c.html#a8">ValidKernelPdeLocal</a>;
<a name="l04430"></a><a class="code" href="../../d4/d8/mi_8h.html#a577">04430</a> 
04431 <span class="keyword">extern</span> <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> <a class="code" href="../../d4/d2/datalpha_8c.html#a4">ValidUserPte</a>;
<a name="l04432"></a><a class="code" href="../../d4/d8/mi_8h.html#a578">04432</a> 
04433 <span class="keyword">extern</span> <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> <a class="code" href="../../d4/d2/datalpha_8c.html#a5">ValidPtePte</a>;
<a name="l04434"></a><a class="code" href="../../d4/d8/mi_8h.html#a579">04434</a> 
04435 <span class="keyword">extern</span> <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> <a class="code" href="../../d4/d2/datalpha_8c.html#a6">ValidPdePde</a>;
<a name="l04436"></a><a class="code" href="../../d4/d8/mi_8h.html#a580">04436</a> 
04437 <span class="keyword">extern</span> <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> <a class="code" href="../../d4/d2/datalpha_8c.html#a9">DemandZeroPde</a>;
<a name="l04438"></a><a class="code" href="../../d4/d8/mi_8h.html#a581">04438</a> 
04439 <span class="keyword">extern</span> <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> <a class="code" href="../../d4/d2/datalpha_8c.html#a10">DemandZeroPte</a>;
<a name="l04440"></a><a class="code" href="../../d4/d8/mi_8h.html#a582">04440</a> 
04441 <span class="keyword">extern</span> <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> <a class="code" href="../../d4/d8/mi_8h.html#a575">KernelPrototypePte</a>;
04442 
04443 <span class="keyword">extern</span> <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> <a class="code" href="../../d4/d2/datalpha_8c.html#a11">TransitionPde</a>;
04444 
04445 <span class="keyword">extern</span> <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> <a class="code" href="../../d4/d2/datalpha_8c.html#a12">PrototypePte</a>;
04446 
04447 <span class="keyword">extern</span> <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> <a class="code" href="../../d4/d2/datalpha_8c.html#a13">NoAccessPte</a>;
04448 
04449 <span class="keyword">extern</span> ULONG_PTR <a class="code" href="../../d8/d5/kddata_8c.html#a16">MmSubsectionBase</a>;
04450 
04451 <span class="keyword">extern</span> ULONG_PTR <a class="code" href="../../d4/d8/mi_8h.html#a580">MmSubsectionTopPage</a>;
04452 
04453 <span class="keyword">extern</span> BOOLEAN <a class="code" href="../../d4/d8/mi_8h.html#a581">MiHydra</a>;
04454 
<a name="l04455"></a><a class="code" href="../../d4/d8/mi_8h.html#a583">04455</a> <span class="keyword">extern</span> ULONG <a class="code" href="../../d8/d0/cmdat3_8c.html#a54">ExpMultiUserTS</a>;
04456 
04457 <span class="comment">// extern MMPTE UserNoCommitPte;</span>
04458 
04459 <span class="comment">//</span>
04460 <span class="comment">// Virtual alignment for PTEs (machine specific) minimum value is</span>
<a name="l04461"></a><a class="code" href="../../d4/d8/mi_8h.html#a584">04461</a> <span class="comment">// 4k maximum value is 64k.  The maximum value can be raised by</span>
04462 <span class="comment">// changing the MM_PROTO_PTE_ALIGNMENT constant and adding more</span>
04463 <span class="comment">// reserved mapping PTEs in hyperspace.</span>
04464 <span class="comment">//</span>
04465 
04466 <span class="comment">//</span>
<a name="l04467"></a><a class="code" href="../../d4/d8/mi_8h.html#a585">04467</a> <span class="comment">// Total number of physical pages on the system.</span>
04468 <span class="comment">//</span>
04469 
04470 <span class="keyword">extern</span> PFN_COUNT <a class="code" href="../../d2/d1/mm_8h.html#a136">MmNumberOfPhysicalPages</a>;
04471 
04472 <span class="comment">//</span>
<a name="l04473"></a><a class="code" href="../../d4/d8/mi_8h.html#a586">04473</a> <span class="comment">// Lowest physical page number on the system.</span>
04474 <span class="comment">//</span>
04475 
04476 <span class="keyword">extern</span> PFN_NUMBER <a class="code" href="../../d6/d8/sysinfo_8c.html#a6">MmLowestPhysicalPage</a>;
04477 
04478 <span class="comment">//</span>
04479 <span class="comment">// Highest physical page number on the system.</span>
<a name="l04480"></a><a class="code" href="../../d4/d8/mi_8h.html#a587">04480</a> <span class="comment">//</span>
04481 
04482 <span class="keyword">extern</span> PFN_NUMBER <a class="code" href="../../d6/d8/sysinfo_8c.html#a7">MmHighestPhysicalPage</a>;
04483 
04484 <span class="comment">//</span>
04485 <span class="comment">// Highest possible physical page number in the system.</span>
<a name="l04486"></a><a class="code" href="../../d4/d8/mi_8h.html#a588">04486</a> <span class="comment">//</span>
04487 
04488 <span class="keyword">extern</span> PFN_NUMBER <a class="code" href="../../d2/d3/dumpctl_8c.html#a16">MmHighestPossiblePhysicalPage</a>;
04489 
04490 <span class="comment">//</span>
04491 <span class="comment">// Total number of available pages on the system.  This</span>
04492 <span class="comment">// is the sum of the pages on the zeroed, free and standby lists.</span>
04493 <span class="comment">//</span>
04494 
04495 <span class="keyword">extern</span> PFN_COUNT <a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a>;
04496 
04497 <span class="comment">//</span>
04498 <span class="comment">// Total number of free pages to base working set trimming on.</span>
<a name="l04499"></a><a class="code" href="../../d4/d8/mi_8h.html#a589">04499</a> <span class="comment">//</span>
04500 
04501 <span class="keyword">extern</span> PFN_NUMBER <a class="code" href="../../d4/d8/mi_8h.html#a588">MmMoreThanEnoughFreePages</a>;
04502 
04503 <span class="comment">//</span>
04504 <span class="comment">// Total number physical pages which would be usable if every process</span>
04505 <span class="comment">// was at it's minimum working set size.  This value is initialized</span>
<a name="l04506"></a><a class="code" href="../../d4/d8/mi_8h.html#a590">04506</a> <span class="comment">// at system initialization to MmAvailablePages - MM_FLUID_PHYSICAL_PAGES.</span>
04507 <span class="comment">// Everytime a thread is created, the kernel stack is subtracted from</span>
04508 <span class="comment">// this and every time a process is created, the minimum working set</span>
04509 <span class="comment">// is subtracted from this.  If the value would become negative, the</span>
04510 <span class="comment">// operation (create process/kernel stack/ adjust working set) fails.</span>
04511 <span class="comment">// The PFN LOCK must be owned to manipulate this value.</span>
04512 <span class="comment">//</span>
<a name="l04513"></a><a class="code" href="../../d4/d8/mi_8h.html#a591">04513</a> 
04514 <span class="keyword">extern</span> SPFN_NUMBER <a class="code" href="../../d8/d5/kddata_8c.html#a42">MmResidentAvailablePages</a>;
04515 
04516 <span class="comment">//</span>
04517 <span class="comment">// The total number of pages which would be removed from working sets</span>
04518 <span class="comment">// if every working set was at its minimum.</span>
04519 <span class="comment">//</span>
<a name="l04520"></a><a class="code" href="../../d4/d8/mi_8h.html#a592">04520</a> 
04521 <span class="keyword">extern</span> PFN_NUMBER <a class="code" href="../../d4/d8/mi_8h.html#a590">MmPagesAboveWsMinimum</a>;
04522 
04523 <span class="comment">//</span>
04524 <span class="comment">// The total number of pages which would be removed from working sets</span>
04525 <span class="comment">// if every working set above its maximum was at its maximum.</span>
04526 <span class="comment">//</span>
<a name="l04527"></a><a class="code" href="../../d4/d8/mi_8h.html#a593">04527</a> 
04528 <span class="keyword">extern</span> PFN_NUMBER <a class="code" href="../../d4/d8/mi_8h.html#a591">MmPagesAboveWsMaximum</a>;
04529 
04530 <span class="comment">//</span>
04531 <span class="comment">// If memory is becoming short and MmPagesAboveWsMinimum is</span>
04532 <span class="comment">// greater than MmPagesAboveWsThreshold, trim working sets.</span>
<a name="l04533"></a><a class="code" href="../../d4/d8/mi_8h.html#a594">04533</a> <span class="comment">//</span>
04534 
04535 <span class="keyword">extern</span> PFN_NUMBER <a class="code" href="../../d4/d8/mi_8h.html#a592">MmPagesAboveWsThreshold</a>;
04536 
04537 <span class="comment">//</span>
04538 <span class="comment">// The number of pages to add to a working set if there are ample</span>
04539 <span class="comment">// available pages and the working set is below its maximum.</span>
<a name="l04540"></a><a class="code" href="../../d4/d8/mi_8h.html#a595">04540</a> <span class="comment">//</span>
04541 
04542 <span class="keyword">extern</span> PFN_NUMBER <a class="code" href="../../d4/d8/mi_8h.html#a593">MmWorkingSetSizeIncrement</a>;
04543 
04544 <span class="comment">//</span>
04545 <span class="comment">// The number of pages to extend the maximum working set size by</span>
04546 <span class="comment">// if the working set at its maximum and there are ample available pages.</span>
<a name="l04547"></a><a class="code" href="../../d4/d8/mi_8h.html#a596">04547</a> 
04548 <span class="keyword">extern</span> PFN_NUMBER <a class="code" href="../../d4/d8/mi_8h.html#a594">MmWorkingSetSizeExpansion</a>;
04549 
04550 <span class="comment">//</span>
04551 <span class="comment">// The number of pages required to be freed by working set reduction</span>
04552 <span class="comment">// before working set reduction is attempted.</span>
<a name="l04553"></a><a class="code" href="../../d4/d8/mi_8h.html#a597">04553</a> <span class="comment">//</span>
04554 
<a name="l04555"></a><a class="code" href="../../d4/d8/mi_8h.html#a598">04555</a> <span class="keyword">extern</span> PFN_NUMBER <a class="code" href="../../d4/d8/mi_8h.html#a595">MmWsAdjustThreshold</a>;
04556 
<a name="l04557"></a><a class="code" href="../../d4/d8/mi_8h.html#a599">04557</a> <span class="comment">//</span>
04558 <span class="comment">// The number of pages available to allow the working set to be</span>
<a name="l04559"></a><a class="code" href="../../d4/d8/mi_8h.html#a600">04559</a> <span class="comment">// expanded above its maximum.</span>
04560 <span class="comment">//</span>
<a name="l04561"></a><a class="code" href="../../d4/d8/mi_8h.html#a601">04561</a> 
04562 <span class="keyword">extern</span> PFN_NUMBER <a class="code" href="../../d4/d8/mi_8h.html#a596">MmWsExpandThreshold</a>;
<a name="l04563"></a><a class="code" href="../../d4/d8/mi_8h.html#a602">04563</a> 
04564 <span class="comment">//</span>
<a name="l04565"></a><a class="code" href="../../d4/d8/mi_8h.html#a603">04565</a> <span class="comment">// The total number of pages to reduce by working set trimming.</span>
04566 <span class="comment">//</span>
<a name="l04567"></a><a class="code" href="../../d4/d8/mi_8h.html#a604">04567</a> 
04568 <span class="keyword">extern</span> PFN_NUMBER <a class="code" href="../../d4/d8/mi_8h.html#a597">MmWsTrimReductionGoal</a>;
<a name="l04569"></a><a class="code" href="../../d4/d8/mi_8h.html#a605">04569</a> 
04570 <span class="keyword">extern</span> ULONG <a class="code" href="../../d4/d8/mi_8h.html#a598">MiDelayPageFaults</a>;
<a name="l04571"></a><a class="code" href="../../d4/d8/mi_8h.html#a606">04571</a> 
04572 <span class="keyword">extern</span> <a class="code" href="../../d4/d8/mi_8h.html#a439">PMMPFN</a> <a class="code" href="../../d2/d3/dumpctl_8c.html#a15">MmPfnDatabase</a>;
<a name="l04573"></a><a class="code" href="../../d4/d8/mi_8h.html#a607">04573</a> 
04574 <span class="keyword">extern</span> <a class="code" href="../../d0/d4/struct__MMPFNLIST.html">MMPFNLIST</a> <a class="code" href="../../d8/d5/kddata_8c.html#a36">MmZeroedPageListHead</a>;
<a name="l04575"></a><a class="code" href="../../d4/d8/mi_8h.html#a608">04575</a> 
04576 <span class="keyword">extern</span> <a class="code" href="../../d0/d4/struct__MMPFNLIST.html">MMPFNLIST</a> <a class="code" href="../../d8/d5/kddata_8c.html#a37">MmFreePageListHead</a>;
04577 
04578 <span class="keyword">extern</span> <a class="code" href="../../d0/d4/struct__MMPFNLIST.html">MMPFNLIST</a> <a class="code" href="../../d8/d5/kddata_8c.html#a38">MmStandbyPageListHead</a>;
04579 
04580 <span class="keyword">extern</span> <a class="code" href="../../d0/d4/struct__MMPFNLIST.html">MMPFNLIST</a> <a class="code" href="../../d2/d1/mm_8h.html#a150">MmModifiedPageListHead</a>;
<a name="l04581"></a><a class="code" href="../../d4/d8/mi_8h.html#a609">04581</a> 
04582 <span class="keyword">extern</span> <a class="code" href="../../d0/d4/struct__MMPFNLIST.html">MMPFNLIST</a> <a class="code" href="../../d8/d5/kddata_8c.html#a40">MmModifiedNoWritePageListHead</a>;
<a name="l04583"></a><a class="code" href="../../d4/d8/mi_8h.html#a610">04583</a> 
04584 <span class="keyword">extern</span> <a class="code" href="../../d0/d4/struct__MMPFNLIST.html">MMPFNLIST</a> <a class="code" href="../../d4/d8/mi_8h.html#a605">MmBadPageListHead</a>;
04585 
04586 <span class="keyword">extern</span> <a class="code" href="../../d0/d4/struct__MMPFNLIST.html">PMMPFNLIST</a> <a class="code" href="../../d4/d8/mi_8h.html#a606">MmPageLocationList</a>[<a class="code" href="../../d2/d1/mm_8h.html#a22">NUMBER_OF_PAGE_LISTS</a>];
04587 
04588 <span class="keyword">extern</span> <a class="code" href="../../d0/d4/struct__MMPFNLIST.html">MMPFNLIST</a> <a class="code" href="../../d4/d2/datalpha_8c.html#a21">MmModifiedPageListByColor</a>[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a55">MM_MAXIMUM_NUMBER_OF_COLORS</a>];
<a name="l04589"></a><a class="code" href="../../d4/d8/mi_8h.html#a611">04589</a> 
04590 <span class="keyword">extern</span> ULONG <a class="code" href="../../d4/d8/mi_8h.html#a608">MmModNoWriteInsert</a>;
04591 
04592 <span class="comment">//</span>
04593 <span class="comment">// Event for available pages, set means pages are available.</span>
04594 <span class="comment">//</span>
04595 
04596 <span class="keyword">extern</span> <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> <a class="code" href="../../d4/d8/mi_8h.html#a609">MmAvailablePagesEvent</a>;
04597 
<a name="l04598"></a><a class="code" href="../../d4/d8/mi_8h.html#a612">04598</a> <span class="keyword">extern</span> <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> <a class="code" href="../../d4/d8/mi_8h.html#a610">MmAvailablePagesEventHigh</a>;
04599 
04600 <span class="comment">//</span>
04601 <span class="comment">// Event for the zeroing page thread.</span>
04602 <span class="comment">//</span>
04603 
<a name="l04604"></a><a class="code" href="../../d4/d8/mi_8h.html#a613">04604</a> <span class="keyword">extern</span> <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> <a class="code" href="../../d4/d8/mi_8h.html#a611">MmZeroingPageEvent</a>;
04605 
04606 <span class="comment">//</span>
04607 <span class="comment">// Boolean to indicate if the zeroing page thread is currently</span>
04608 <span class="comment">// active.  This is set to true when the zeroing page event is</span>
04609 <span class="comment">// set and set to false when the zeroing page thread is done</span>
<a name="l04610"></a><a class="code" href="../../d4/d8/mi_8h.html#a614">04610</a> <span class="comment">// zeroing all the pages on the free list.</span>
04611 <span class="comment">//</span>
04612 
04613 <span class="keyword">extern</span> BOOLEAN <a class="code" href="../../d4/d8/mi_8h.html#a612">MmZeroingPageThreadActive</a>;
04614 
04615 <span class="comment">//</span>
<a name="l04616"></a><a class="code" href="../../d4/d8/mi_8h.html#a615">04616</a> <span class="comment">// Minimum number of free pages before zeroing page thread starts.</span>
04617 <span class="comment">//</span>
<a name="l04618"></a><a class="code" href="../../d4/d8/mi_8h.html#a616">04618</a> 
04619 <span class="keyword">extern</span> PFN_NUMBER <a class="code" href="../../d4/d8/mi_8h.html#a613">MmMinimumFreePagesToZero</a>;
04620 
04621 <span class="comment">//</span>
04622 <span class="comment">// Global event to synchronize mapped writing with cleaning segments.</span>
04623 <span class="comment">//</span>
04624 
04625 <span class="keyword">extern</span> <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> <a class="code" href="../../d4/d8/mi_8h.html#a614">MmMappedFileIoComplete</a>;
<a name="l04626"></a><a class="code" href="../../d4/d8/mi_8h.html#a617">04626</a> 
04627 <span class="comment">//</span>
<a name="l04628"></a><a class="code" href="../../d4/d8/mi_8h.html#a618">04628</a> <span class="comment">// Hyper space items.</span>
04629 <span class="comment">//</span>
04630 
04631 <span class="keyword">extern</span> <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> <a class="code" href="../../d4/d8/mi_8h.html#a615">MmFirstReservedMappingPte</a>;
04632 
04633 <span class="keyword">extern</span> <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> <a class="code" href="../../d4/d8/mi_8h.html#a616">MmLastReservedMappingPte</a>;
04634 
04635 <span class="comment">//</span>
<a name="l04636"></a><a class="code" href="../../d4/d8/mi_8h.html#a619">04636</a> <span class="comment">// System space sizes - MmNonPagedSystemStart to MM_NON_PAGED_SYSTEM_END</span>
04637 <span class="comment">// defines the ranges of PDEs which must be copied into a new process's</span>
<a name="l04638"></a><a class="code" href="../../d4/d8/mi_8h.html#a620">04638</a> <span class="comment">// address space.</span>
04639 <span class="comment">//</span>
<a name="l04640"></a><a class="code" href="../../d4/d8/mi_8h.html#a621">04640</a> 
04641 <span class="keyword">extern</span> PVOID <a class="code" href="../../d8/d5/kddata_8c.html#a22">MmNonPagedSystemStart</a>;
<a name="l04642"></a><a class="code" href="../../d4/d8/mi_8h.html#a622">04642</a> 
04643 <span class="keyword">extern</span> PCHAR <a class="code" href="../../d4/d8/mi_8h.html#a618">MmSystemSpaceViewStart</a>;
<a name="l04644"></a><a class="code" href="../../d4/d8/mi_8h.html#a623">04644</a> 
04645 <span class="keyword">extern</span> LOGICAL <a class="code" href="../../d8/d0/cmdat3_8c.html#a36">MmProtectFreedNonPagedPool</a>;
<a name="l04646"></a><a class="code" href="../../d4/d8/mi_8h.html#a624">04646</a> 
04647 <span class="comment">//</span>
<a name="l04648"></a><a class="code" href="../../d4/d8/mi_8h.html#a625">04648</a> <span class="comment">// Pool sizes.</span>
04649 <span class="comment">//</span>
<a name="l04650"></a><a class="code" href="../../d4/d8/mi_8h.html#a626">04650</a> 
04651 <span class="keyword">extern</span> SIZE_T <a class="code" href="../../d8/d0/cmdat3_8c.html#a19">MmSizeOfNonPagedPoolInBytes</a>;
<a name="l04652"></a><a class="code" href="../../d4/d8/mi_8h.html#a627">04652</a> 
04653 <span class="keyword">extern</span> SIZE_T <a class="code" href="../../d4/d8/mi_8h.html#a620">MmMinimumNonPagedPoolSize</a>;
<a name="l04654"></a><a class="code" href="../../d4/d8/mi_8h.html#a628">04654</a> 
04655 <span class="keyword">extern</span> SIZE_T <a class="code" href="../../d4/d8/mi_8h.html#a621">MmDefaultMaximumNonPagedPool</a>;
<a name="l04656"></a><a class="code" href="../../d4/d8/mi_8h.html#a629">04656</a> 
04657 <span class="keyword">extern</span> ULONG <a class="code" href="../../d4/d8/mi_8h.html#a622">MmMinAdditionNonPagedPoolPerMb</a>;
<a name="l04658"></a><a class="code" href="../../d4/d8/mi_8h.html#a630">04658</a> 
04659 <span class="keyword">extern</span> ULONG <a class="code" href="../../d4/d8/mi_8h.html#a623">MmMaxAdditionNonPagedPoolPerMb</a>;
<a name="l04660"></a><a class="code" href="../../d4/d8/mi_8h.html#a631">04660</a> 
04661 <span class="keyword">extern</span> SIZE_T <a class="code" href="../../d8/d0/cmdat3_8c.html#a18">MmSizeOfPagedPoolInBytes</a>;
<a name="l04662"></a><a class="code" href="../../d4/d8/mi_8h.html#a632">04662</a> 
04663 <span class="keyword">extern</span> SIZE_T <a class="code" href="../../d8/d5/kddata_8c.html#a21">MmMaximumNonPagedPoolInBytes</a>;
<a name="l04664"></a><a class="code" href="../../d4/d8/mi_8h.html#a633">04664</a> 
04665 <span class="keyword">extern</span> PFN_NUMBER <a class="code" href="../../d9/d5/4_2kddata_8c.html#a52">MmAllocatedNonPagedPool</a>;
<a name="l04666"></a><a class="code" href="../../d4/d8/mi_8h.html#a634">04666</a> 
04667 <span class="keyword">extern</span> PFN_NUMBER <a class="code" href="../../d4/d8/mi_8h.html#a627">MmSizeOfNonPagedMustSucceed</a>;
<a name="l04668"></a><a class="code" href="../../d4/d8/mi_8h.html#a635">04668</a> 
04669 <span class="keyword">extern</span> PVOID <a class="code" href="../../d1/d6/allocpag_8c.html#a7">MmNonPagedPoolExpansionStart</a>;
<a name="l04670"></a><a class="code" href="../../d4/d8/mi_8h.html#a636">04670</a> 
04671 <span class="keyword">extern</span> ULONG <a class="code" href="../../d4/d8/mi_8h.html#a629">MmExpandedPoolBitPosition</a>;
04672 
<a name="l04673"></a><a class="code" href="../../d4/d8/mi_8h.html#a637">04673</a> <span class="keyword">extern</span> PFN_NUMBER <a class="code" href="../../d4/d8/mi_8h.html#a630">MmNumberOfFreeNonPagedPool</a>;
04674 
04675 <span class="keyword">extern</span> ULONG <a class="code" href="../../d4/d8/mi_8h.html#a631">MmMustSucceedPoolBitPosition</a>;
04676 
04677 <span class="keyword">extern</span> ULONG <a class="code" href="../../d8/d0/cmdat3_8c.html#a23">MmNumberOfSystemPtes</a>;
<a name="l04678"></a><a class="code" href="../../d4/d8/mi_8h.html#a638">04678</a> 
04679 <span class="keyword">extern</span> ULONG <a class="code" href="../../d4/d8/mi_8h.html#a633">MiRequestedSystemPtes</a>;
<a name="l04680"></a><a class="code" href="../../d4/d8/mi_8h.html#a639">04680</a> 
04681 <span class="keyword">extern</span> ULONG <a class="code" href="../../d6/d8/sysinfo_8c.html#a8">MmTotalFreeSystemPtes</a>[<a class="code" href="../../d4/d8/mi_8h.html#a1003a771">MaximumPtePoolTypes</a>];
<a name="l04682"></a><a class="code" href="../../d4/d8/mi_8h.html#a640">04682</a> 
04683 <span class="keyword">extern</span> SIZE_T <a class="code" href="../../d4/d8/mi_8h.html#a635">MmLockPagesLimit</a>;
<a name="l04684"></a><a class="code" href="../../d4/d8/mi_8h.html#a641">04684</a> 
04685 <span class="keyword">extern</span> <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> <a class="code" href="../../d4/d8/mi_8h.html#a636">MmSystemPagePtes</a>;
<a name="l04686"></a><a class="code" href="../../d4/d8/mi_8h.html#a642">04686</a> 
04687 <span class="preprocessor">#if !defined (_X86PAE_)</span>
<a name="l04688"></a><a class="code" href="../../d4/d8/mi_8h.html#a324">04688</a> <span class="preprocessor"></span><span class="keyword">extern</span> ULONG <a class="code" href="../../d4/d8/mi_8h.html#a637">MmSystemPageDirectory</a>;
04689 <span class="preprocessor">#else</span>
<a name="l04690"></a><a class="code" href="../../d4/d8/mi_8h.html#a643">04690</a> <span class="preprocessor"></span><span class="keyword">extern</span> ULONG <a class="code" href="../../d4/d8/mi_8h.html#a637">MmSystemPageDirectory</a>[];
04691 <span class="preprocessor">#endif</span>
04692 <span class="preprocessor"></span>
04693 <span class="keyword">extern</span> <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> <a class="code" href="../../d4/d8/mi_8h.html#a638">MmPagedPoolBasePde</a>;
04694 
04695 <span class="keyword">extern</span> SIZE_T <a class="code" href="../../d8/d0/cmdat3_8c.html#a46">MmHeapSegmentReserve</a>;
<a name="l04696"></a><a class="code" href="../../d4/d8/mi_8h.html#a644">04696</a> 
04697 <span class="keyword">extern</span> SIZE_T <a class="code" href="../../d8/d0/cmdat3_8c.html#a47">MmHeapSegmentCommit</a>;
04698 
04699 <span class="keyword">extern</span> SIZE_T <a class="code" href="../../d8/d0/cmdat3_8c.html#a48">MmHeapDeCommitTotalFreeThreshold</a>;
04700 
04701 <span class="keyword">extern</span> SIZE_T <a class="code" href="../../d8/d0/cmdat3_8c.html#a49">MmHeapDeCommitFreeBlockThreshold</a>;
<a name="l04702"></a><a class="code" href="../../d4/d8/mi_8h.html#a645">04702</a> 
04703 <span class="preprocessor">#define MI_MAX_FREE_LIST_HEADS  4</span>
<a name="l04704"></a><a class="code" href="../../d4/d8/mi_8h.html#a646">04704</a> <span class="preprocessor"></span>
04705 <span class="keyword">extern</span> LIST_ENTRY <a class="code" href="../../d1/d6/allocpag_8c.html#a8">MmNonPagedPoolFreeListHead</a>[<a class="code" href="../../d4/d8/mi_8h.html#a324">MI_MAX_FREE_LIST_HEADS</a>];
<a name="l04706"></a><a class="code" href="../../d4/d8/mi_8h.html#a647">04706</a> 
04707 <span class="comment">//</span>
<a name="l04708"></a><a class="code" href="../../d4/d8/mi_8h.html#a648">04708</a> <span class="comment">// Counter for flushes of the entire TB.</span>
04709 <span class="comment">//</span>
<a name="l04710"></a><a class="code" href="../../d4/d8/mi_8h.html#a649">04710</a> 
04711 <span class="keyword">extern</span> ULONG <a class="code" href="../../d4/d8/mi_8h.html#a644">MmFlushCounter</a>;
04712 
04713 <span class="comment">//</span>
04714 <span class="comment">// Pool start and end.</span>
04715 <span class="comment">//</span>
<a name="l04716"></a><a class="code" href="../../d9/d9/struct__MM__PAGED__POOL__INFO.html">04716</a> 
04717 <span class="keyword">extern</span> PVOID <a class="code" href="../../d8/d5/kddata_8c.html#a23">MmNonPagedPoolStart</a>;
<a name="l04718"></a><a class="code" href="../../d9/d9/struct__MM__PAGED__POOL__INFO.html#o0">04718</a> 
<a name="l04719"></a><a class="code" href="../../d9/d9/struct__MM__PAGED__POOL__INFO.html#o1">04719</a> <span class="keyword">extern</span> PVOID <a class="code" href="../../d8/d5/kddata_8c.html#a24">MmNonPagedPoolEnd</a>;
<a name="l04720"></a><a class="code" href="../../d9/d9/struct__MM__PAGED__POOL__INFO.html#o2">04720</a> 
<a name="l04721"></a><a class="code" href="../../d9/d9/struct__MM__PAGED__POOL__INFO.html#o3">04721</a> <span class="keyword">extern</span> PVOID <a class="code" href="../../d8/d5/kddata_8c.html#a25">MmPagedPoolStart</a>;
<a name="l04722"></a><a class="code" href="../../d9/d9/struct__MM__PAGED__POOL__INFO.html#o4">04722</a> 
<a name="l04723"></a><a class="code" href="../../d9/d9/struct__MM__PAGED__POOL__INFO.html#o5">04723</a> <span class="keyword">extern</span> PVOID <a class="code" href="../../d8/d5/kddata_8c.html#a26">MmPagedPoolEnd</a>;
<a name="l04724"></a><a class="code" href="../../d9/d9/struct__MM__PAGED__POOL__INFO.html#o6">04724</a> 
<a name="l04725"></a><a class="code" href="../../d9/d9/struct__MM__PAGED__POOL__INFO.html#o7">04725</a> <span class="keyword">extern</span> PVOID <a class="code" href="../../d4/d8/mi_8h.html#a649">MmNonPagedMustSucceed</a>;
<a name="l04726"></a><a class="code" href="../../d9/d9/struct__MM__PAGED__POOL__INFO.html#o8">04726</a> 
04727 <span class="comment">//</span>
04728 <span class="comment">// Pool bit maps and other related structures.</span>
04729 <span class="comment">//</span>
<a name="l04730"></a><a class="code" href="../../d4/d8/mi_8h.html#a652">04730</a> 
04731 <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d9/d9/struct__MM__PAGED__POOL__INFO.html">_MM_PAGED_POOL_INFO</a> {
<a name="l04732"></a><a class="code" href="../../d4/d8/mi_8h.html#a653">04732</a> 
04733     PRTL_BITMAP PagedPoolAllocationMap;
<a name="l04734"></a><a class="code" href="../../d4/d8/mi_8h.html#a654">04734</a>     PRTL_BITMAP EndOfPagedPoolBitmap;
04735     PRTL_BITMAP PagedPoolLargeSessionAllocationMap;     <span class="comment">// HYDRA only</span>
04736     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> FirstPteForPagedPool;
04737     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastPteForPagedPool;
04738     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> NextPdeForPagedPoolExpansion;
04739     ULONG PagedPoolHint;
04740     SIZE_T PagedPoolCommit;
04741     SIZE_T AllocatedPagedPool;
<a name="l04742"></a><a class="code" href="../../d4/d8/mi_8h.html#a655">04742</a> 
04743 } <a class="code" href="../../d9/d9/struct__MM__PAGED__POOL__INFO.html">MM_PAGED_POOL_INFO</a>, *<a class="code" href="../../d9/d9/struct__MM__PAGED__POOL__INFO.html">PMM_PAGED_POOL_INFO</a>;
<a name="l04744"></a><a class="code" href="../../d4/d8/mi_8h.html#a656">04744</a> 
04745 <span class="keyword">extern</span> <a class="code" href="../../d9/d9/struct__MM__PAGED__POOL__INFO.html">MM_PAGED_POOL_INFO</a> <a class="code" href="../../d8/d5/kddata_8c.html#a27">MmPagedPoolInfo</a>;
04746 
04747 <span class="keyword">extern</span> PVOID <a class="code" href="../../d4/d8/mi_8h.html#a653">MmPageAlignedPoolBase</a>[2];
04748 
04749 <span class="keyword">extern</span> PRTL_BITMAP <a class="code" href="../../d4/d8/mi_8h.html#a654">VerifierLargePagedPoolMap</a>;
04750 
04751 <span class="comment">//</span>
<a name="l04752"></a><a class="code" href="../../d4/d8/mi_8h.html#a657">04752</a> <span class="comment">// MmFirstFreeSystemPte contains the offset from the</span>
04753 <span class="comment">// Nonpaged system base to the first free system PTE.</span>
<a name="l04754"></a><a class="code" href="../../d4/d8/mi_8h.html#a658">04754</a> <span class="comment">// Note, that an offset of zero indicates an empty list.</span>
04755 <span class="comment">//</span>
<a name="l04756"></a><a class="code" href="../../d4/d8/mi_8h.html#a659">04756</a> 
04757 <span class="keyword">extern</span> <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> <a class="code" href="../../d4/d8/mi_8h.html#a655">MmFirstFreeSystemPte</a>[<a class="code" href="../../d4/d8/mi_8h.html#a1003a771">MaximumPtePoolTypes</a>];
<a name="l04758"></a><a class="code" href="../../d4/d8/mi_8h.html#a660">04758</a> 
04759 <span class="keyword">extern</span> ULONG_PTR <a class="code" href="../../d4/d8/mi_8h.html#a656">MiSystemViewStart</a>;
<a name="l04760"></a><a class="code" href="../../d4/d8/mi_8h.html#a661">04760</a> 
04761 <span class="comment">//</span>
<a name="l04762"></a><a class="code" href="../../d4/d8/mi_8h.html#a662">04762</a> <span class="comment">// System cache sizes.</span>
04763 <span class="comment">//</span>
<a name="l04764"></a><a class="code" href="../../d4/d8/mi_8h.html#a663">04764</a> 
04765 <span class="comment">//extern MMSUPPORT MmSystemCacheWs;</span>
<a name="l04766"></a><a class="code" href="../../d4/d8/mi_8h.html#a664">04766</a> 
04767 <span class="keyword">extern</span> <a class="code" href="../../d4/d8/mi_8h.html#a450">PMMWSL</a> <a class="code" href="../../d4/d8/mi_8h.html#a657">MmSystemCacheWorkingSetList</a>;
04768 
04769 <span class="keyword">extern</span> <a class="code" href="../../d4/d8/mi_8h.html#a448">PMMWSLE</a> <a class="code" href="../../d4/d8/mi_8h.html#a658">MmSystemCacheWsle</a>;
04770 
04771 <span class="keyword">extern</span> PVOID <a class="code" href="../../d8/d5/kddata_8c.html#a11">MmSystemCacheStart</a>;
04772 
04773 <span class="keyword">extern</span> PVOID <a class="code" href="../../d8/d5/kddata_8c.html#a12">MmSystemCacheEnd</a>;
04774 
<a name="l04775"></a><a class="code" href="../../d4/d8/mi_8h.html#a665">04775</a> <span class="keyword">extern</span> PRTL_BITMAP <a class="code" href="../../d4/d8/mi_8h.html#a661">MmSystemCacheAllocationMap</a>;
04776 
04777 <span class="keyword">extern</span> PRTL_BITMAP <a class="code" href="../../d4/d8/mi_8h.html#a662">MmSystemCacheEndingMap</a>;
04778 
04779 <span class="keyword">extern</span> PFN_NUMBER <a class="code" href="../../d4/d8/mi_8h.html#a663">MmSystemCacheWsMinimum</a>;
04780 
04781 <span class="keyword">extern</span> PFN_NUMBER <a class="code" href="../../d4/d8/mi_8h.html#a664">MmSystemCacheWsMaximum</a>;
<a name="l04782"></a><a class="code" href="../../d4/d8/mi_8h.html#a666">04782</a> 
04783 <span class="comment">//</span>
04784 <span class="comment">// Virtual alignment for PTEs (machine specific) minimum value is</span>
04785 <span class="comment">// 0 (no alignment) maximum value is 64k.  The maximum value can be raised by</span>
04786 <span class="comment">// changing the MM_PROTO_PTE_ALIGNMENT constant and adding more</span>
04787 <span class="comment">// reserved mapping PTEs in hyperspace.</span>
04788 <span class="comment">//</span>
<a name="l04789"></a><a class="code" href="../../d4/d8/mi_8h.html#a667">04789</a> 
04790 <span class="keyword">extern</span> ULONG <a class="code" href="../../d4/d8/mi_8h.html#a665">MmAliasAlignment</a>;
04791 
04792 <span class="comment">//</span>
04793 <span class="comment">// Mask to AND with virtual address to get an offset to go</span>
04794 <span class="comment">// with the alignment.  This value is page aligned.</span>
04795 <span class="comment">//</span>
<a name="l04796"></a><a class="code" href="../../d4/d8/mi_8h.html#a668">04796</a> 
<a name="l04797"></a><a class="code" href="../../d4/d8/mi_8h.html#a669">04797</a> <span class="keyword">extern</span> ULONG <a class="code" href="../../d4/d8/mi_8h.html#a666">MmAliasAlignmentOffset</a>;
<a name="l04798"></a><a class="code" href="../../d4/d8/mi_8h.html#a670">04798</a> 
04799 <span class="comment">//</span>
04800 <span class="comment">// Mask to and with PTEs to determine if the alias mapping is compatible.</span>
04801 <span class="comment">// This value is usually (MmAliasAlignment - 1)</span>
04802 <span class="comment">//</span>
04803 
04804 <span class="keyword">extern</span> ULONG <a class="code" href="../../d4/d8/mi_8h.html#a667">MmAliasAlignmentMask</a>;
04805 
<a name="l04806"></a><a class="code" href="../../d4/d8/mi_8h.html#a671">04806</a> <span class="comment">//</span>
04807 <span class="comment">// Cells to track unused thread kernel stacks to avoid TB flushes</span>
04808 <span class="comment">// every time a thread terminates.</span>
04809 <span class="comment">//</span>
04810 
04811 <span class="keyword">extern</span> ULONG <a class="code" href="../../d4/d8/mi_8h.html#a668">MmNumberDeadKernelStacks</a>;
04812 <span class="keyword">extern</span> ULONG <a class="code" href="../../d4/d8/mi_8h.html#a669">MmMaximumDeadKernelStacks</a>;
04813 <span class="keyword">extern</span> <a class="code" href="../../d4/d8/mi_8h.html#a439">PMMPFN</a> <a class="code" href="../../d4/d8/mi_8h.html#a670">MmFirstDeadKernelStack</a>;
04814 
04815 <span class="comment">//</span>
04816 <span class="comment">// MmSystemPteBase contains the address of 1 PTE before</span>
<a name="l04817"></a><a class="code" href="../../d4/d8/mi_8h.html#a674">04817</a> <span class="comment">// the first free system PTE (zero indicates an empty list).</span>
04818 <span class="comment">// The value of this field does not change once set.</span>
<a name="l04819"></a><a class="code" href="../../d4/d8/mi_8h.html#a675">04819</a> <span class="comment">//</span>
04820 
<a name="l04821"></a><a class="code" href="../../d4/d8/mi_8h.html#a676">04821</a> <span class="keyword">extern</span> <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> <a class="code" href="../../d4/d8/mi_8h.html#a671">MmSystemPteBase</a>;
04822 
04823 <span class="keyword">extern</span> <a class="code" href="../../d4/d8/mi_8h.html#a450">PMMWSL</a> <a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>;
04824 
04825 <span class="keyword">extern</span> <a class="code" href="../../d4/d8/mi_8h.html#a448">PMMWSLE</a> <a class="code" href="../../d4/d8/mi_8h.html#a673">MmWsle</a>;
04826 
<a name="l04827"></a><a class="code" href="../../d4/d8/mi_8h.html#a677">04827</a> <span class="comment">//</span>
04828 <span class="comment">// Root of system space virtual address descriptors.  These define</span>
04829 <span class="comment">// the pagable portion of the system.</span>
04830 <span class="comment">//</span>
04831 
04832 <span class="keyword">extern</span> <a class="code" href="../../d4/d8/mi_8h.html#a490">PMMVAD</a> <a class="code" href="../../d4/d8/mi_8h.html#a674">MmVirtualAddressDescriptorRoot</a>;
<a name="l04833"></a><a class="code" href="../../d4/d8/mi_8h.html#a678">04833</a> 
04834 <span class="keyword">extern</span> <a class="code" href="../../d4/d8/mi_8h.html#a478">PMMADDRESS_NODE</a> <a class="code" href="../../d4/d8/mi_8h.html#a675">MmSectionBasedRoot</a>;
04835 
04836 <span class="keyword">extern</span> PVOID <a class="code" href="../../d4/d8/mi_8h.html#a676">MmHighSectionBase</a>;
04837 
04838 <span class="comment">//</span>
<a name="l04839"></a><a class="code" href="../../d4/d8/mi_8h.html#a679">04839</a> <span class="comment">// Section commit mutex.</span>
<a name="l04840"></a><a class="code" href="../../d4/d8/mi_8h.html#a680">04840</a> <span class="comment">//</span>
04841 
04842 <span class="keyword">extern</span> <a class="code" href="../../d6/d9/struct__FAST__MUTEX.html">FAST_MUTEX</a> <a class="code" href="../../d4/d8/mi_8h.html#a677">MmSectionCommitMutex</a>;
04843 
04844 <span class="comment">//</span>
04845 <span class="comment">// Section base address mutex.</span>
<a name="l04846"></a><a class="code" href="../../d4/d8/mi_8h.html#a681">04846</a> <span class="comment">//</span>
04847 
04848 <span class="keyword">extern</span> <a class="code" href="../../d6/d9/struct__FAST__MUTEX.html">FAST_MUTEX</a> <a class="code" href="../../d4/d8/mi_8h.html#a678">MmSectionBasedMutex</a>;
04849 
04850 <span class="comment">//</span>
04851 <span class="comment">// Resource for section extension.</span>
<a name="l04852"></a><a class="code" href="../../d4/d8/mi_8h.html#a682">04852</a> <span class="comment">//</span>
04853 
<a name="l04854"></a><a class="code" href="../../d4/d8/mi_8h.html#a683">04854</a> <span class="keyword">extern</span> <a class="code" href="../../d6/d4/struct__ERESOURCE.html">ERESOURCE</a> <a class="code" href="../../d4/d8/mi_8h.html#a679">MmSectionExtendResource</a>;
04855 <span class="keyword">extern</span> <a class="code" href="../../d6/d4/struct__ERESOURCE.html">ERESOURCE</a> <a class="code" href="../../d4/d8/mi_8h.html#a680">MmSectionExtendSetResource</a>;
04856 
04857 <span class="comment">//</span>
04858 <span class="comment">// Event to synchronize threads within process mapping images via hyperspace.</span>
04859 <span class="comment">//</span>
<a name="l04860"></a><a class="code" href="../../d4/d8/mi_8h.html#a684">04860</a> 
04861 <span class="keyword">extern</span> <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> <a class="code" href="../../d4/d8/mi_8h.html#a681">MmImageMappingPteEvent</a>;
04862 
04863 <span class="comment">//</span>
04864 <span class="comment">// Inpage cluster sizes for executable pages (set based on memory size).</span>
04865 <span class="comment">//</span>
<a name="l04866"></a><a class="code" href="../../d4/d8/mi_8h.html#a685">04866</a> 
04867 <span class="keyword">extern</span> ULONG <a class="code" href="../../d4/d8/mi_8h.html#a682">MmDataClusterSize</a>;
04868 
04869 <span class="keyword">extern</span> ULONG <a class="code" href="../../d4/d8/mi_8h.html#a683">MmCodeClusterSize</a>;
04870 
04871 <span class="comment">//</span>
<a name="l04872"></a><a class="code" href="../../d4/d8/mi_8h.html#a686">04872</a> <span class="comment">// Pagefile creation mutex.</span>
04873 <span class="comment">//</span>
04874 
04875 <span class="keyword">extern</span> <a class="code" href="../../d6/d9/struct__FAST__MUTEX.html">FAST_MUTEX</a> <a class="code" href="../../d4/d8/mi_8h.html#a684">MmPageFileCreationLock</a>;
04876 
04877 <span class="comment">//</span>
04878 <span class="comment">// Event to set when first paging file is created.</span>
04879 <span class="comment">//</span>
<a name="l04880"></a><a class="code" href="../../d4/d8/mi_8h.html#a687">04880</a> 
04881 <span class="keyword">extern</span> <a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a> <a class="code" href="../../d4/d8/mi_8h.html#a685">MmPagingFileCreated</a>;
04882 
04883 <span class="comment">//</span>
04884 <span class="comment">// Paging file debug information.</span>
04885 <span class="comment">//</span>
04886 
<a name="l04887"></a><a class="code" href="../../d4/d8/mi_8h.html#a688">04887</a> <span class="keyword">extern</span> ULONG_PTR <a class="code" href="../../d4/d8/mi_8h.html#a686">MmPagingFileDebug</a>[];
04888 
04889 <span class="comment">//</span>
04890 <span class="comment">// Spinlock which guards PFN database.  This spinlock is used by</span>
04891 <span class="comment">// memory management for accessing the PFN database.  The I/O</span>
04892 <span class="comment">// system makes use of it for unlocking pages during I/O complete.</span>
<a name="l04893"></a><a class="code" href="../../d4/d8/mi_8h.html#a689">04893</a> <span class="comment">//</span>
04894 
04895 <span class="keyword">extern</span> KSPIN_LOCK <a class="code" href="../../d7/d2/alpha_2initkr_8c.html#a2">MmPfnLock</a>;
04896 
04897 <span class="comment">//</span>
04898 <span class="comment">// Spinlock which guards the working set list for the system shared</span>
<a name="l04899"></a><a class="code" href="../../d4/d8/mi_8h.html#a690">04899</a> <span class="comment">// address space (paged pool, system cache, pagable drivers).</span>
04900 <span class="comment">//</span>
04901 
04902 <span class="keyword">extern</span> <a class="code" href="../../d6/d4/struct__ERESOURCE.html">ERESOURCE</a> <a class="code" href="../../d4/d8/mi_8h.html#a688">MmSystemWsLock</a>;
04903 
04904 <span class="comment">//</span>
<a name="l04905"></a><a class="code" href="../../d4/d8/mi_8h.html#a691">04905</a> <span class="comment">// Spin lock for allocating non-paged PTEs from system space.</span>
04906 <span class="comment">//</span>
04907 
04908 <span class="keyword">extern</span> KSPIN_LOCK <a class="code" href="../../d4/d4/alpha_2splocks_8c.html#a15">MmSystemSpaceLock</a>;
04909 
04910 <span class="comment">//</span>
<a name="l04911"></a><a class="code" href="../../d4/d8/mi_8h.html#a692">04911</a> <span class="comment">// Spin lock for operating on page file commit charges.</span>
04912 <span class="comment">//</span>
04913 
04914 <span class="keyword">extern</span> KSPIN_LOCK <a class="code" href="../../d4/d8/mi_8h.html#a690">MmChargeCommitmentLock</a>;
04915 
04916 <span class="comment">//</span>
<a name="l04917"></a><a class="code" href="../../d4/d8/mi_8h.html#a693">04917</a> <span class="comment">// Spin lock for allowing working set expansion.</span>
04918 <span class="comment">//</span>
<a name="l04919"></a><a class="code" href="../../d4/d8/mi_8h.html#a694">04919</a> 
04920 <span class="keyword">extern</span> KSPIN_LOCK <a class="code" href="../../d4/d8/mi_8h.html#a691">MmExpansionLock</a>;
<a name="l04921"></a><a class="code" href="../../d4/d8/mi_8h.html#a695">04921</a> 
04922 <span class="comment">//</span>
04923 <span class="comment">// To prevent optimizations.</span>
04924 <span class="comment">//</span>
04925 
04926 <span class="keyword">extern</span> <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> <a class="code" href="../../d4/d8/mi_8h.html#a692">GlobalPte</a>;
04927 
04928 <span class="comment">//</span>
<a name="l04929"></a><a class="code" href="../../d4/d8/mi_8h.html#a696">04929</a> <span class="comment">// Page color for system working set.</span>
04930 <span class="comment">//</span>
04931 
04932 <span class="keyword">extern</span> ULONG <a class="code" href="../../d4/d8/mi_8h.html#a693">MmSystemPageColor</a>;
04933 
04934 <span class="keyword">extern</span> ULONG <a class="code" href="../../d8/d0/cmdat3_8c.html#a25">MmSecondaryColors</a>;
04935 
04936 <span class="keyword">extern</span> ULONG <a class="code" href="../../d4/d8/mi_8h.html#a695">MmProcessColorSeed</a>;
04937 
04938 <span class="comment">//</span>
04939 <span class="comment">// Set from ntos\config\CMDAT3.C  Used by customers to disable paging</span>
04940 <span class="comment">// of executive on machines with lots of memory.  Worth a few TPS on a</span>
04941 <span class="comment">// data base server.</span>
04942 <span class="comment">//</span>
04943 
<a name="l04944"></a><a class="code" href="../../d4/d8/mi_8h.html#a697">04944</a> <span class="keyword">extern</span> ULONG <a class="code" href="../../d8/d0/cmdat3_8c.html#a26">MmDisablePagingExecutive</a>;
04945 
<a name="l04946"></a><a class="code" href="../../d4/d8/mi_8h.html#a698">04946</a> 
04947 <span class="comment">//</span>
<a name="l04948"></a><a class="code" href="../../d4/d8/mi_8h.html#a699">04948</a> <span class="comment">// For debugging.</span>
04949 
<a name="l04950"></a><a class="code" href="../../d4/d8/mi_8h.html#a700">04950</a> 
04951 <span class="preprocessor">#if DBG</span>
<a name="l04952"></a><a class="code" href="../../d4/d8/mi_8h.html#a701">04952</a> <span class="preprocessor"></span><span class="keyword">extern</span> ULONG MmDebug;
<a name="l04953"></a><a class="code" href="../../d4/d8/mi_8h.html#a702">04953</a> <span class="preprocessor">#endif</span>
04954 <span class="preprocessor"></span>
<a name="l04955"></a><a class="code" href="../../d4/d8/mi_8h.html#a703">04955</a> <span class="comment">//</span>
04956 <span class="comment">// Unused segment management</span>
<a name="l04957"></a><a class="code" href="../../d4/d8/mi_8h.html#a704">04957</a> <span class="comment">//</span>
04958 
<a name="l04959"></a><a class="code" href="../../d4/d8/mi_8h.html#a705">04959</a> <span class="keyword">extern</span> <a class="code" href="../../d8/d1/struct__MMDEREFERENCE__SEGMENT__HEADER.html">MMDEREFERENCE_SEGMENT_HEADER</a> <a class="code" href="../../d4/d8/mi_8h.html#a697">MmDereferenceSegmentHeader</a>;
<a name="l04960"></a><a class="code" href="../../d4/d8/mi_8h.html#a706">04960</a> 
04961 <span class="keyword">extern</span> LIST_ENTRY <a class="code" href="../../d4/d8/mi_8h.html#a698">MmUnusedSegmentList</a>;
<a name="l04962"></a><a class="code" href="../../d4/d8/mi_8h.html#a707">04962</a> 
04963 <span class="keyword">extern</span> <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> <a class="code" href="../../d4/d8/mi_8h.html#a699">MmUnusedSegmentCleanup</a>;
<a name="l04964"></a><a class="code" href="../../d4/d8/mi_8h.html#a708">04964</a> 
04965 <span class="keyword">extern</span> SIZE_T <a class="code" href="../../d4/d8/mi_8h.html#a700">MmMaxUnusedSegmentPagedPoolUsage</a>;
<a name="l04966"></a><a class="code" href="../../d4/d8/mi_8h.html#a709">04966</a> 
04967 <span class="keyword">extern</span> SIZE_T <a class="code" href="../../d4/d8/mi_8h.html#a701">MmUnusedSegmentPagedPoolUsage</a>;
<a name="l04968"></a><a class="code" href="../../d4/d8/mi_8h.html#a325">04968</a> <span class="keyword">extern</span> SIZE_T <a class="code" href="../../d4/d8/mi_8h.html#a702">MiUnusedSegmentPagedPoolUsage</a>;
04969 
04970 <span class="keyword">extern</span> SIZE_T <a class="code" href="../../d4/d8/mi_8h.html#a703">MmUnusedSegmentPagedPoolReduction</a>;
<a name="l04971"></a><a class="code" href="../../d4/d8/mi_8h.html#a326">04971</a> 
04972 <span class="keyword">extern</span> SIZE_T <a class="code" href="../../d4/d8/mi_8h.html#a704">MmMaxUnusedSegmentNonPagedPoolUsage</a>;
<a name="l04973"></a><a class="code" href="../../d4/d8/mi_8h.html#a327">04973</a> 
04974 <span class="keyword">extern</span> SIZE_T <a class="code" href="../../d4/d8/mi_8h.html#a705">MmUnusedSegmentNonPagedPoolUsage</a>;
04975 <span class="keyword">extern</span> SIZE_T <a class="code" href="../../d4/d8/mi_8h.html#a706">MiUnusedSegmentNonPagedPoolUsage</a>;
04976 
04977 <span class="keyword">extern</span> SIZE_T <a class="code" href="../../d4/d8/mi_8h.html#a707">MmUnusedSegmentNonPagedPoolReduction</a>;
04978 
04979 <span class="keyword">extern</span> ULONG <a class="code" href="../../d8/d0/cmdat3_8c.html#a24">MmUnusedSegmentTrimLevel</a>;
04980 
04981 <span class="keyword">extern</span> ULONG <a class="code" href="../../d4/d8/mi_8h.html#a709">MmUnusedSegmentCount</a>;
04982 
04983 <span class="preprocessor">#define MI_UNUSED_SEGMENTS_COUNT_UPDATE(_count) \</span>
04984 <span class="preprocessor">        MmUnusedSegmentCount += (_count);</span>
04985 <span class="preprocessor"></span>
04986 <span class="preprocessor">#define MI_FILESYSTEM_NONPAGED_POOL_CHARGE 150</span>
04987 <span class="preprocessor"></span>
04988 <span class="preprocessor">#define MI_FILESYSTEM_PAGED_POOL_CHARGE 1024</span>
04989 <span class="preprocessor"></span>
04990 <span class="comment">//++</span>
04991 <span class="comment">//LOGICAL</span>
04992 <span class="comment">//MI_UNUSED_SEGMENTS_SURPLUS (</span>
04993 <span class="comment">//    IN PVOID va</span>
04994 <span class="comment">//    );</span>
<a name="l04995"></a><a class="code" href="../../d4/d8/mi_8h.html#a328">04995</a> <span class="comment">//</span>
04996 <span class="comment">// Routine Description:</span>
04997 <span class="comment">//</span>
04998 <span class="comment">//    This routine determines whether a surplus of unused</span>
04999 <span class="comment">//    segments exist.  If so, the caller can initiate a trim to free pool.</span>
05000 <span class="comment">//</span>
05001 <span class="comment">// Arguments</span>
05002 <span class="comment">//</span>
05003 <span class="comment">//    None.</span>
05004 <span class="comment">//</span>
05005 <span class="comment">// Return Value:</span>
05006 <span class="comment">//</span>
05007 <span class="comment">//    TRUE if unused segment trimming should be initiated, FALSE if not.</span>
05008 <span class="comment">//</span>
05009 <span class="comment">//--</span>
05010 <span class="preprocessor">#define MI_UNUSED_SEGMENTS_SURPLUS()                                    \</span>
05011 <span class="preprocessor">        (MmUnusedSegmentPagedPoolUsage &gt; MmMaxUnusedSegmentPagedPoolUsage) || \</span>
05012 <span class="preprocessor">        (MmUnusedSegmentNonPagedPoolUsage &gt; MmMaxUnusedSegmentNonPagedPoolUsage)</span>
05013 <span class="preprocessor"></span>
05014 <span class="comment">//++</span>
05015 <span class="comment">//VOID</span>
05016 <span class="comment">//MI_UNUSED_SEGMENTS_INSERT_CHARGE (</span>
05017 <span class="comment">//    IN PCONTROL_AREA _ControlArea</span>
05018 <span class="comment">//    );</span>
<a name="l05019"></a><a class="code" href="../../d4/d8/mi_8h.html#a329">05019</a> <span class="comment">//</span>
05020 <span class="comment">// Routine Description:</span>
05021 <span class="comment">//</span>
05022 <span class="comment">//    This routine manages pool charges during insertions of segments to</span>
05023 <span class="comment">//    the unused segment list.</span>
05024 <span class="comment">//</span>
05025 <span class="comment">// Arguments</span>
05026 <span class="comment">//</span>
05027 <span class="comment">//    _ControlArea - Supplies the control area to obtain the pool charges from.</span>
05028 <span class="comment">//</span>
05029 <span class="comment">// Return Value:</span>
05030 <span class="comment">//</span>
05031 <span class="comment">//    None.</span>
05032 <span class="comment">//</span>
05033 <span class="comment">//--</span>
05034 <span class="preprocessor">#define MI_UNUSED_SEGMENTS_INSERT_CHARGE(_ControlArea)                       \</span>
05035 <span class="preprocessor">        {                                                                    \</span>
05036 <span class="preprocessor">           MM_PFN_LOCK_ASSERT();                                             \</span>
05037 <span class="preprocessor">           ASSERT (_ControlArea-&gt;PagedPoolUsage &gt;= sizeof(SEGMENT));         \</span>
05038 <span class="preprocessor">           ASSERT (_ControlArea-&gt;NonPagedPoolUsage &gt;= sizeof(CONTROL_AREA) + sizeof(SUBSECTION));          \</span>
05039 <span class="preprocessor">           ASSERT (MiUnusedSegmentNonPagedPoolUsage + _ControlArea-&gt;NonPagedPoolUsage &gt; MiUnusedSegmentNonPagedPoolUsage); \</span>
05040 <span class="preprocessor">           ASSERT (MiUnusedSegmentPagedPoolUsage + _ControlArea-&gt;PagedPoolUsage &gt; MiUnusedSegmentPagedPoolUsage); \</span>
05041 <span class="preprocessor">           MiUnusedSegmentPagedPoolUsage += _ControlArea-&gt;PagedPoolUsage;    \</span>
05042 <span class="preprocessor">           MiUnusedSegmentNonPagedPoolUsage += _ControlArea-&gt;NonPagedPoolUsage;\</span>
05043 <span class="preprocessor">           MmUnusedSegmentPagedPoolUsage += (_ControlArea-&gt;PagedPoolUsage + MI_FILESYSTEM_PAGED_POOL_CHARGE);    \</span>
05044 <span class="preprocessor">           MmUnusedSegmentNonPagedPoolUsage += (_ControlArea-&gt;NonPagedPoolUsage + MI_FILESYSTEM_NONPAGED_POOL_CHARGE);\</span>
05045 <span class="preprocessor">           MI_UNUSED_SEGMENTS_COUNT_UPDATE(1); \</span>
05046 <span class="preprocessor">        }</span>
05047 <span class="preprocessor"></span>
05048 <span class="comment">//++</span>
05049 <span class="comment">//VOID</span>
05050 <span class="comment">//MI_UNUSED_SEGMENTS_REMOVE_CHARGE (</span>
05051 <span class="comment">//    IN PCONTROL_AREA _ControlArea</span>
05052 <span class="comment">//    );</span>
<a name="l05053"></a><a class="code" href="../../d4/d8/mi_8h.html#a330">05053</a> <span class="comment">//</span>
05054 <span class="comment">// Routine Description:</span>
05055 <span class="comment">//</span>
05056 <span class="comment">//    This routine manages pool charges during removals of segments from</span>
05057 <span class="comment">//    the unused segment list.</span>
05058 <span class="comment">//</span>
05059 <span class="comment">// Arguments</span>
05060 <span class="comment">//</span>
05061 <span class="comment">//    _ControlArea - Supplies the control area to obtain the pool charges from.</span>
05062 <span class="comment">//</span>
05063 <span class="comment">// Return Value:</span>
05064 <span class="comment">//</span>
05065 <span class="comment">//    None.</span>
05066 <span class="comment">//</span>
05067 <span class="comment">//--</span>
05068 <span class="preprocessor">#define MI_UNUSED_SEGMENTS_REMOVE_CHARGE(_ControlArea)                       \</span>
05069 <span class="preprocessor">        {                                                                    \</span>
05070 <span class="preprocessor">           MM_PFN_LOCK_ASSERT();                                             \</span>
<a name="l05071"></a><a class="code" href="../../d4/d8/mi_8h.html#a710">05071</a> <span class="preprocessor">           ASSERT (_ControlArea-&gt;PagedPoolUsage &gt;= sizeof(SEGMENT));         \</span>
05072 <span class="preprocessor">           ASSERT (_ControlArea-&gt;NonPagedPoolUsage &gt;= sizeof(CONTROL_AREA) + sizeof(SUBSECTION));          \</span>
<a name="l05073"></a><a class="code" href="../../d4/d8/mi_8h.html#a711">05073</a> <span class="preprocessor">           ASSERT (MmUnusedSegmentNonPagedPoolUsage - _ControlArea-&gt;NonPagedPoolUsage &lt; MmUnusedSegmentNonPagedPoolUsage); \</span>
05074 <span class="preprocessor">           ASSERT (MmUnusedSegmentPagedPoolUsage - _ControlArea-&gt;PagedPoolUsage &lt; MmUnusedSegmentPagedPoolUsage); \</span>
05075 <span class="preprocessor">           MiUnusedSegmentPagedPoolUsage -= _ControlArea-&gt;PagedPoolUsage;    \</span>
05076 <span class="preprocessor">           MiUnusedSegmentNonPagedPoolUsage -= _ControlArea-&gt;NonPagedPoolUsage;\</span>
05077 <span class="preprocessor">           MmUnusedSegmentPagedPoolUsage -= (_ControlArea-&gt;PagedPoolUsage + MI_FILESYSTEM_PAGED_POOL_CHARGE);    \</span>
05078 <span class="preprocessor">           MmUnusedSegmentNonPagedPoolUsage -= (_ControlArea-&gt;NonPagedPoolUsage + MI_FILESYSTEM_NONPAGED_POOL_CHARGE);\</span>
<a name="l05079"></a><a class="code" href="../../d4/d8/mi_8h.html#a712">05079</a> <span class="preprocessor">           MI_UNUSED_SEGMENTS_COUNT_UPDATE(-1); \</span>
05080 <span class="preprocessor">        }</span>
<a name="l05081"></a><a class="code" href="../../d4/d8/mi_8h.html#a713">05081</a> <span class="preprocessor"></span>
05082 <span class="comment">//</span>
<a name="l05083"></a><a class="code" href="../../d4/d8/mi_8h.html#a714">05083</a> <span class="comment">// List heads</span>
05084 <span class="comment">//</span>
<a name="l05085"></a><a class="code" href="../../d4/d8/mi_8h.html#a331">05085</a> 
05086 <span class="keyword">extern</span> <a class="code" href="../../d7/d7/struct__MMWORKING__SET__EXPANSION__HEAD.html">MMWORKING_SET_EXPANSION_HEAD</a> <a class="code" href="../../d4/d8/mi_8h.html#a710">MmWorkingSetExpansionHead</a>;
05087 
<a name="l05088"></a><a class="code" href="../../d4/d8/mi_8h.html#a715">05088</a> <span class="keyword">extern</span> <a class="code" href="../../d1/d3/struct__MMPAGE__FILE__EXPANSION.html">MMPAGE_FILE_EXPANSION</a> <a class="code" href="../../d4/d8/mi_8h.html#a711">MmAttemptForCantExtend</a>;
05089 
<a name="l05090"></a><a class="code" href="../../d4/d8/mi_8h.html#a716">05090</a> <span class="comment">//</span>
05091 <span class="comment">// Paging files</span>
<a name="l05092"></a><a class="code" href="../../d4/d8/mi_8h.html#a717">05092</a> <span class="comment">//</span>
05093 
<a name="l05094"></a><a class="code" href="../../d4/d8/mi_8h.html#a718">05094</a> <span class="keyword">extern</span> <a class="code" href="../../d8/d2/struct__MMMOD__WRITER__LISTHEAD.html">MMMOD_WRITER_LISTHEAD</a> <a class="code" href="../../d4/d8/mi_8h.html#a712">MmPagingFileHeader</a>;
05095 
<a name="l05096"></a><a class="code" href="../../d4/d8/mi_8h.html#a719">05096</a> <span class="keyword">extern</span> <a class="code" href="../../d8/d2/struct__MMMOD__WRITER__LISTHEAD.html">MMMOD_WRITER_LISTHEAD</a> <a class="code" href="../../d4/d8/mi_8h.html#a713">MmMappedFileHeader</a>;
05097 
<a name="l05098"></a><a class="code" href="../../d4/d8/mi_8h.html#a720">05098</a> <span class="keyword">extern</span> <a class="code" href="../../d4/d8/mi_8h.html#a507">PMMPAGING_FILE</a> <a class="code" href="../../d4/d8/mi_8h.html#a714">MmPagingFile</a>[<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a48">MAX_PAGE_FILES</a>];
05099 
<a name="l05100"></a><a class="code" href="../../d4/d8/mi_8h.html#a721">05100</a> <span class="preprocessor">#define MM_MAPPED_FILE_MDLS 4</span>
05101 <span class="preprocessor"></span>
05102 
05103 <span class="keyword">extern</span> <a class="code" href="../../d4/d8/mi_8h.html#a505">PMMMOD_WRITER_MDL_ENTRY</a> <a class="code" href="../../d4/d8/mi_8h.html#a715">MmMappedFileMdl</a>[<a class="code" href="../../d4/d8/mi_8h.html#a331">MM_MAPPED_FILE_MDLS</a>];
05104 
05105 <span class="keyword">extern</span> LIST_ENTRY <a class="code" href="../../d4/d8/mi_8h.html#a716">MmFreePagingSpaceLow</a>;
<a name="l05106"></a><a class="code" href="../../d4/d8/mi_8h.html#a722">05106</a> 
05107 <span class="keyword">extern</span> ULONG <a class="code" href="../../d4/d8/mi_8h.html#a717">MmNumberOfActiveMdlEntries</a>;
<a name="l05108"></a><a class="code" href="../../d4/d8/mi_8h.html#a723">05108</a> 
05109 <span class="keyword">extern</span> ULONG <a class="code" href="../../d8/d5/kddata_8c.html#a17">MmNumberOfPagingFiles</a>;
<a name="l05110"></a><a class="code" href="../../d4/d8/mi_8h.html#a724">05110</a> 
05111 <span class="keyword">extern</span> <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> <a class="code" href="../../d4/d8/mi_8h.html#a719">MmModifiedPageWriterEvent</a>;
<a name="l05112"></a><a class="code" href="../../d4/d8/mi_8h.html#a725">05112</a> 
05113 <span class="keyword">extern</span> <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> <a class="code" href="../../d4/d8/mi_8h.html#a720">MmCollidedFlushEvent</a>;
05114 
05115 <span class="keyword">extern</span> <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> <a class="code" href="../../d5/d6/iosup_8c.html#a18">MmCollidedLockEvent</a>;
05116 
05117 <span class="comment">//</span>
<a name="l05118"></a><a class="code" href="../../d4/d8/mi_8h.html#a726">05118</a> <span class="comment">// Total number of committed pages.</span>
05119 <span class="comment">//</span>
<a name="l05120"></a><a class="code" href="../../d4/d8/mi_8h.html#a727">05120</a> 
05121 <span class="keyword">extern</span> SIZE_T <a class="code" href="../../d6/d8/sysinfo_8c.html#a3">MmTotalCommittedPages</a>;
<a name="l05122"></a><a class="code" href="../../d4/d8/mi_8h.html#a728">05122</a> 
05123 <span class="keyword">extern</span> SIZE_T <a class="code" href="../../d6/d8/sysinfo_8c.html#a4">MmTotalCommitLimit</a>;
<a name="l05124"></a><a class="code" href="../../d4/d8/mi_8h.html#a729">05124</a> 
05125 <span class="keyword">extern</span> SIZE_T <a class="code" href="../../d8/d0/cmdat3_8c.html#a20">MmOverCommit</a>;
<a name="l05126"></a><a class="code" href="../../d4/d8/mi_8h.html#a730">05126</a> 
05127 <span class="keyword">extern</span> SIZE_T <a class="code" href="../../d8/d5/kddata_8c.html#a31">MmSharedCommit</a>;
<a name="l05128"></a><a class="code" href="../../d4/d8/mi_8h.html#a731">05128</a> 
05129 <span class="comment">//</span>
<a name="l05130"></a><a class="code" href="../../d4/d8/mi_8h.html#a732">05130</a> <span class="comment">// Modified page writer.</span>
05131 <span class="comment">//</span>
<a name="l05132"></a><a class="code" href="../../d4/d8/mi_8h.html#a733">05132</a> 
05133 <span class="keyword">extern</span> PFN_NUMBER <a class="code" href="../../d4/d8/mi_8h.html#a726">MmMinimumFreePages</a>;
<a name="l05134"></a><a class="code" href="../../d4/d8/mi_8h.html#a734">05134</a> 
05135 <span class="keyword">extern</span> PFN_NUMBER <a class="code" href="../../d4/d8/mi_8h.html#a727">MmFreeGoal</a>;
<a name="l05136"></a><a class="code" href="../../d4/d8/mi_8h.html#a735">05136</a> 
05137 <span class="keyword">extern</span> PFN_NUMBER <a class="code" href="../../d4/d8/mi_8h.html#a728">MmModifiedPageMaximum</a>;
<a name="l05138"></a><a class="code" href="../../d4/d8/mi_8h.html#a736">05138</a> 
05139 <span class="keyword">extern</span> PFN_NUMBER <a class="code" href="../../d4/d8/mi_8h.html#a729">MmModifiedPageMinimum</a>;
<a name="l05140"></a><a class="code" href="../../d4/d8/mi_8h.html#a737">05140</a> 
05141 <span class="keyword">extern</span> ULONG <a class="code" href="../../d4/d8/mi_8h.html#a730">MmModifiedWriteClusterSize</a>;
<a name="l05142"></a><a class="code" href="../../d4/d8/mi_8h.html#a738">05142</a> 
05143 <span class="keyword">extern</span> ULONG <a class="code" href="../../d4/d8/mi_8h.html#a731">MmMinimumFreeDiskSpace</a>;
05144 
05145 <span class="keyword">extern</span> ULONG <a class="code" href="../../d4/d8/mi_8h.html#a732">MmPageFileExtension</a>;
05146 
05147 <span class="keyword">extern</span> ULONG <a class="code" href="../../d4/d8/mi_8h.html#a733">MmMinimumPageFileReduction</a>;
<a name="l05148"></a><a class="code" href="../../d4/d8/mi_8h.html#a739">05148</a> 
05149 <span class="keyword">extern</span> LARGE_INTEGER <a class="code" href="../../d4/d8/mi_8h.html#a734">MiModifiedPageLife</a>;
<a name="l05150"></a><a class="code" href="../../d4/d8/mi_8h.html#a740">05150</a> 
05151 <span class="keyword">extern</span> BOOLEAN <a class="code" href="../../d4/d8/mi_8h.html#a735">MiTimerPending</a>;
<a name="l05152"></a><a class="code" href="../../d4/d8/mi_8h.html#a741">05152</a> 
05153 <span class="keyword">extern</span> <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> <a class="code" href="../../d4/d8/mi_8h.html#a736">MiMappedPagesTooOldEvent</a>;
05154 
05155 <span class="keyword">extern</span> <a class="code" href="../../d1/d6/struct__KDPC.html">KDPC</a> <a class="code" href="../../d4/d8/mi_8h.html#a737">MiModifiedPageWriterTimerDpc</a>;
05156 
05157 <span class="keyword">extern</span> <a class="code" href="../../d3/d8/struct__KTIMER.html">KTIMER</a> <a class="code" href="../../d4/d8/mi_8h.html#a738">MiModifiedPageWriterTimer</a>;
<a name="l05158"></a><a class="code" href="../../d4/d8/mi_8h.html#a742">05158</a> 
05159 <span class="comment">//</span>
<a name="l05160"></a><a class="code" href="../../d4/d8/mi_8h.html#a743">05160</a> <span class="comment">// System process working set sizes.</span>
05161 <span class="comment">//</span>
<a name="l05162"></a><a class="code" href="../../d4/d8/mi_8h.html#a744">05162</a> 
05163 <span class="keyword">extern</span> PFN_NUMBER <a class="code" href="../../d4/d8/mi_8h.html#a739">MmSystemProcessWorkingSetMin</a>;
<a name="l05164"></a><a class="code" href="../../d4/d8/mi_8h.html#a745">05164</a> 
05165 <span class="keyword">extern</span> PFN_NUMBER <a class="code" href="../../d4/d8/mi_8h.html#a740">MmSystemProcessWorkingSetMax</a>;
05166 
05167 <span class="keyword">extern</span> PFN_NUMBER <a class="code" href="../../d4/d8/mi_8h.html#a741">MmMinimumWorkingSetSize</a>;
05168 
05169 <span class="comment">//</span>
<a name="l05170"></a><a class="code" href="../../d4/d8/mi_8h.html#a746">05170</a> <span class="comment">// Support for debugger's mapping physical memory.</span>
<a name="l05171"></a><a class="code" href="../../d4/d8/mi_8h.html#a747">05171</a> <span class="comment">//</span>
05172 
05173 <span class="keyword">extern</span> <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> <a class="code" href="../../d4/d2/datalpha_8c.html#a18">MmDebugPte</a>;
05174 
05175 <span class="keyword">extern</span> <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> <a class="code" href="../../d4/d2/datalpha_8c.html#a19">MmCrashDumpPte</a>;
05176 
05177 <span class="keyword">extern</span> ULONG <a class="code" href="../../d4/d8/mi_8h.html#a744">MiOverCommitCallCount</a>;
05178 
<a name="l05179"></a><a class="code" href="../../d4/d8/mi_8h.html#a332">05179</a> <span class="keyword">extern</span> SIZE_T <a class="code" href="../../d4/d8/mi_8h.html#a745">MmResTrack</a>[<a class="code" href="../../d4/d8/mi_8h.html#a321">MM_BUMP_COUNTER_MAX</a>];
05180 
05181 <span class="comment">//</span>
05182 <span class="comment">// Event tracing routines</span>
05183 <span class="comment">//</span>
05184 
05185 <span class="keyword">extern</span> <a class="code" href="../../d2/d1/mm_8h.html#a163">PPAGE_FAULT_NOTIFY_ROUTINE</a> <a class="code" href="../../d4/d8/mi_8h.html#a746">MmPageFaultNotifyRoutine</a>;
05186 <span class="keyword">extern</span> <a class="code" href="../../d2/d1/mm_8h.html#a164">PHARD_FAULT_NOTIFY_ROUTINE</a> <a class="code" href="../../d4/d8/mi_8h.html#a747">MmHardFaultNotifyRoutine</a>;
05187 
05188 <span class="comment">//</span>
05189 <span class="comment">// This is a special value loaded into an EPROCESS pointer to indicate that</span>
05190 <span class="comment">// the action underway is for a Hydra session, not really the current process.</span>
05191 <span class="comment">// (Any value could be used here that is not a valid system pointer or NULL).</span>
05192 <span class="comment">//</span>
05193 
05194 <span class="preprocessor">#define HYDRA_PROCESS   ((PEPROCESS)1)</span>
05195 <span class="preprocessor"></span>
05196 <span class="comment">/*++</span>
05197 <span class="comment"></span>
05198 <span class="comment">  Virtual Memory Layout of the 48MB Session space when loaded at 0xA0000000</span>
05199 <span class="comment"></span>
05200 <span class="comment">                 +------------------------------------+</span>
05201 <span class="comment">        A0000000 |                                    |</span>
05202 <span class="comment">                 | win32k.sys, video drivers and any  |</span>
05203 <span class="comment">                 | rebased NT4 printer drivers.       |</span>
05204 <span class="comment">                 |                                    |</span>
05205 <span class="comment">                 |             (8MB)                  |</span>
05206 <span class="comment">                 |                                    |</span>
05207 <span class="comment">                 +------------------------------------+</span>
05208 <span class="comment">        A0800000 |                                    |</span>
05209 <span class="comment">                 |   MM_SESSION_SPACE &amp; Session WSLs  |</span>
05210 <span class="comment">                 |              (4MB)                 |</span>
<a name="l05211"></a><a class="code" href="../../d4/d8/mi_8h.html#a748">05211</a> <span class="comment">                 |                                    |</span>
05212 <span class="comment">                 +------------------------------------+</span>
05213 <span class="comment">        A0C00000 |                                    |</span>
05214 <span class="comment">                 |   Mapped Views for this session    |</span>
05215 <span class="comment">                 |              (20MB)                |</span>
05216 <span class="comment">                 |                                    |</span>
<a name="l05217"></a><a class="code" href="../../d4/d8/mi_8h.html#a333">05217</a> <span class="comment">                 +------------------------------------+</span>
05218 <span class="comment">        A2000000 |                                    |</span>
<a name="l05219"></a><a class="code" href="../../d4/d8/mi_8h.html#a334">05219</a> <span class="comment">                 |   Paged Pool for this session      |</span>
05220 <span class="comment">                 |              (16MB)                |</span>
<a name="l05221"></a><a class="code" href="../../d4/d8/mi_8h.html#a335">05221</a> <span class="comment">                 |                                    |</span>
05222 <span class="comment">        A3000000 +------------------------------------+</span>
<a name="l05223"></a><a class="code" href="../../d4/d8/mi_8h.html#a336">05223</a> <span class="comment"></span>
05224 <span class="comment">--*/</span>
<a name="l05225"></a><a class="code" href="../../d4/d8/mi_8h.html#a337">05225</a> 
05226 <span class="keyword">extern</span> ULONG_PTR <a class="code" href="../../d4/d8/mi_8h.html#a748">MmSessionBase</a>;
<a name="l05227"></a><a class="code" href="../../d4/d8/mi_8h.html#a338">05227</a> 
05228 <span class="comment">//</span>
<a name="l05229"></a><a class="code" href="../../d4/d8/mi_8h.html#a339">05229</a> <span class="comment">// Sizes of Session fields.</span>
05230 <span class="comment">//</span>
05231 
05232 <span class="preprocessor">#define MI_SESSION_SPACE_STRUCT_SIZE MM_ALLOCATION_GRANULARITY</span>
05233 <span class="preprocessor"></span>
05234 <span class="preprocessor">#define MI_SESSION_SPACE_WS_SIZE  (4*1024*1024 - MI_SESSION_SPACE_STRUCT_SIZE)</span>
05235 <span class="preprocessor"></span>
05236 <span class="preprocessor">#define MI_SESSION_IMAGE_SIZE      (8*1024*1024)</span>
05237 <span class="preprocessor"></span>
05238 <span class="preprocessor">#define MI_SESSION_VIEW_SIZE      (20*1024*1024)</span>
05239 <span class="preprocessor"></span>
05240 <span class="preprocessor">#define MI_SESSION_POOL_SIZE      (16*1024*1024)</span>
<a name="l05241"></a><a class="code" href="../../d4/d8/mi_8h.html#a340">05241</a> <span class="preprocessor"></span>
05242 <span class="preprocessor">#define MM_SESSION_SPACE_DATA_SIZE PAGE_SIZE</span>
05243 <span class="preprocessor"></span>
05244 <span class="preprocessor">#define MI_SESSION_SPACE_TOTAL_SIZE \</span>
05245 <span class="preprocessor">            (MI_SESSION_IMAGE_SIZE + \</span>
05246 <span class="preprocessor">             MI_SESSION_SPACE_STRUCT_SIZE + \</span>
05247 <span class="preprocessor">             MI_SESSION_SPACE_WS_SIZE + \</span>
<a name="l05248"></a><a class="code" href="../../d4/d8/mi_8h.html#a341">05248</a> <span class="preprocessor">             MI_SESSION_VIEW_SIZE + \</span>
05249 <span class="preprocessor">             MI_SESSION_POOL_SIZE)</span>
05250 <span class="preprocessor"></span>
05251 <span class="comment">//</span>
05252 <span class="comment">// Actually this is a little larger due to page table pages, etc, but this is</span>
05253 <span class="comment">// all handled ok.</span>
05254 <span class="comment">//</span>
05255 
<a name="l05256"></a><a class="code" href="../../d4/d8/mi_8h.html#a342">05256</a> <span class="preprocessor">#define MI_SESSION_MAXIMUM_WORKING_SET \</span>
05257 <span class="preprocessor">       ((ULONG)(MI_SESSION_SPACE_TOTAL_SIZE &gt;&gt; PAGE_SHIFT))</span>
<a name="l05258"></a><a class="code" href="../../d4/d8/mi_8h.html#a343">05258</a> <span class="preprocessor"></span>
05259 <span class="comment">//</span>
<a name="l05260"></a><a class="code" href="../../d4/d8/mi_8h.html#a344">05260</a> <span class="comment">// The number of page table pages required to map all of session space.</span>
05261 <span class="comment">//</span>
<a name="l05262"></a><a class="code" href="../../d4/d8/mi_8h.html#a345">05262</a> 
05263 <span class="preprocessor">#define MI_SESSION_SPACE_PAGE_TABLES \</span>
<a name="l05264"></a><a class="code" href="../../d4/d8/mi_8h.html#a346">05264</a> <span class="preprocessor">            (MI_SESSION_SPACE_TOTAL_SIZE / MM_VA_MAPPED_BY_PDE)</span>
05265 <span class="preprocessor"></span>
05266 
05267 <span class="comment">//</span>
05268 <span class="comment">// Offsets from MmSessionBase.</span>
05269 <span class="comment">//</span>
05270 
05271 <span class="preprocessor">#define MI_SESSION_IMAGE_OFFSET   (0)</span>
<a name="l05272"></a><a class="code" href="../../d4/d8/mi_8h.html#a347">05272</a> <span class="preprocessor"></span>
05273 <span class="preprocessor">#define MI_SESSION_DATA_OFFSET    (8*1024*1024)</span>
<a name="l05274"></a><a class="code" href="../../d4/d8/mi_8h.html#a348">05274</a> <span class="preprocessor"></span>
05275 <span class="preprocessor">#define MI_SESSION_WS_OFFSET      (8*1024*1024 + MI_SESSION_SPACE_STRUCT_SIZE)</span>
<a name="l05276"></a><a class="code" href="../../d4/d8/mi_8h.html#a349">05276</a> <span class="preprocessor"></span>
05277 <span class="preprocessor">#define MI_SESSION_VIEW_OFFSET    (12*1024*1024)</span>
<a name="l05278"></a><a class="code" href="../../d4/d8/mi_8h.html#a350">05278</a> <span class="preprocessor"></span>
05279 <span class="preprocessor">#define MI_SESSION_POOL_OFFSET    (32*1024*1024)</span>
<a name="l05280"></a><a class="code" href="../../d4/d8/mi_8h.html#a351">05280</a> <span class="preprocessor"></span>
05281 
05282 
05283 <span class="comment">//</span>
05284 <span class="comment">// Virtual addresses of various session fields.</span>
05285 <span class="comment">//</span>
05286 
<a name="l05287"></a><a class="code" href="../../d4/d8/mi_8h.html#a352">05287</a> <span class="preprocessor">#define MI_SESSION_IMAGE_START  ((ULONG_PTR)MmSessionBase)</span>
05288 <span class="preprocessor"></span>
05289 <span class="preprocessor">#define MI_SESSION_SPACE_WS     (MmSessionBase + MI_SESSION_WS_OFFSET)</span>
<a name="l05290"></a><a class="code" href="../../d4/d8/mi_8h.html#a353">05290</a> <span class="preprocessor"></span>
05291 <span class="preprocessor">#define MI_SESSION_VIEW_START   (MmSessionBase + MI_SESSION_VIEW_OFFSET)</span>
05292 <span class="preprocessor"></span>
<a name="l05293"></a><a class="code" href="../../d4/d8/mi_8h.html#a354">05293</a> <span class="preprocessor">#define MI_SESSION_POOL         (MmSessionBase + MI_SESSION_POOL_OFFSET)</span>
05294 <span class="preprocessor"></span>
05295 <span class="preprocessor">#define MI_SESSION_SPACE_END    ((ULONG_PTR)MmSessionBase +          \</span>
<a name="l05296"></a><a class="code" href="../../d4/d8/mi_8h.html#a355">05296</a> <span class="preprocessor">                                        MI_SESSION_SPACE_TOTAL_SIZE)</span>
05297 <span class="preprocessor"></span>
05298 <span class="comment">//</span>
05299 <span class="comment">// Macros to determine if a given address lies in the specified session range.</span>
<a name="l05300"></a><a class="code" href="../../d4/d8/mi_8h.html#a356">05300</a> <span class="comment">//</span>
05301 
<a name="l05302"></a><a class="code" href="../../d4/d8/mi_8h.html#a357">05302</a> <span class="preprocessor">#define MI_IS_SESSION_IMAGE_ADDRESS(VirtualAddress) \</span>
<a name="l05303"></a><a class="code" href="../../d4/d8/mi_8h.html#a358">05303</a> <span class="preprocessor">        (MiHydra == TRUE &amp;&amp; (PVOID)(VirtualAddress) &gt;= (PVOID)MI_SESSION_IMAGE_START &amp;&amp; (PVOID)(VirtualAddress) &lt; (PVOID)(MI_SESSION_IMAGE_START + MI_SESSION_IMAGE_SIZE))</span>
<a name="l05304"></a><a class="code" href="../../d4/d8/mi_8h.html#a359">05304</a> <span class="preprocessor"></span>
<a name="l05305"></a><a class="code" href="../../d4/d8/mi_8h.html#a360">05305</a> <span class="preprocessor">#define MI_IS_SESSION_POOL_ADDRESS(VirtualAddress) \</span>
<a name="l05306"></a><a class="code" href="../../d4/d8/mi_8h.html#a361">05306</a> <span class="preprocessor">        (MiHydra == TRUE &amp;&amp; (PVOID)(VirtualAddress) &gt;= (PVOID)MI_SESSION_POOL &amp;&amp; (PVOID)(VirtualAddress) &lt; (PVOID)(MI_SESSION_POOL + MI_SESSION_POOL_SIZE))</span>
<a name="l05307"></a><a class="code" href="../../d4/d8/mi_8h.html#a362">05307</a> <span class="preprocessor"></span>
<a name="l05308"></a><a class="code" href="../../d4/d8/mi_8h.html#a363">05308</a> <span class="preprocessor">#define MI_IS_SESSION_ADDRESS(_VirtualAddress) \</span>
<a name="l05309"></a><a class="code" href="../../d4/d8/mi_8h.html#a364">05309</a> <span class="preprocessor">        (MiHydra == TRUE &amp;&amp; (PVOID)(_VirtualAddress) &gt;= (PVOID)MmSessionBase &amp;&amp; (PVOID)(_VirtualAddress) &lt; (PVOID)(MI_SESSION_SPACE_END))</span>
<a name="l05310"></a><a class="code" href="../../d4/d8/mi_8h.html#a365">05310</a> <span class="preprocessor"></span>
<a name="l05311"></a><a class="code" href="../../d4/d8/mi_8h.html#a366">05311</a> <span class="preprocessor">#define MI_IS_SESSION_PTE(_Pte) \</span>
<a name="l05312"></a><a class="code" href="../../d4/d8/mi_8h.html#a367">05312</a> <span class="preprocessor">        (MiHydra == TRUE &amp;&amp; (PMMPTE)(_Pte) &gt;= MiSessionBasePte &amp;&amp; (PMMPTE)(_Pte) &lt; MiSessionLastPte)</span>
<a name="l05313"></a><a class="code" href="../../d4/d8/mi_8h.html#a368">05313</a> <span class="preprocessor"></span>
<a name="l05314"></a><a class="code" href="../../d4/d8/mi_8h.html#a369">05314</a> 
<a name="l05315"></a><a class="code" href="../../d4/d8/mi_8h.html#a370">05315</a> <span class="preprocessor">#define SESSION_GLOBAL(_Session)    (_Session-&gt;GlobalVirtualAddress)</span>
<a name="l05316"></a><a class="code" href="../../d4/d8/mi_8h.html#a371">05316</a> <span class="preprocessor"></span>
<a name="l05317"></a><a class="code" href="../../d4/d8/mi_8h.html#a372">05317</a> <span class="preprocessor">#define MM_DBG_SESSION_INITIAL_PAGETABLE_ALLOC          0</span>
<a name="l05318"></a><a class="code" href="../../d4/d8/mi_8h.html#a373">05318</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_DBG_SESSION_INITIAL_PAGETABLE_FREE_RACE      1</span>
<a name="l05319"></a><a class="code" href="../../d4/d8/mi_8h.html#a374">05319</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_DBG_SESSION_INITIAL_PAGE_ALLOC               2</span>
<a name="l05320"></a><a class="code" href="../../d4/d8/mi_8h.html#a375">05320</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_DBG_SESSION_INITIAL_PAGE_FREE_FAIL1          3</span>
<a name="l05321"></a><a class="code" href="../../d4/d8/mi_8h.html#a376">05321</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_DBG_SESSION_INITIAL_PAGETABLE_FREE_FAIL1     4</span>
05322 <span class="preprocessor"></span><span class="preprocessor">#define MM_DBG_SESSION_WS_PAGE_FREE                     5</span>
<a name="l05323"></a><a class="code" href="../../d4/d8/mi_8h.html#a377">05323</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_DBG_SESSION_PAGETABLE_ALLOC                  6</span>
<a name="l05324"></a><a class="code" href="../../d4/d8/mi_8h.html#a378">05324</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_DBG_SESSION_SYSMAPPED_PAGES_ALLOC            7</span>
<a name="l05325"></a><a class="code" href="../../d4/d8/mi_8h.html#a379">05325</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_DBG_SESSION_WS_PAGETABLE_ALLOC               8</span>
<a name="l05326"></a><a class="code" href="../../d4/d8/mi_8h.html#a380">05326</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_DBG_SESSION_PAGEDPOOL_PAGETABLE_ALLOC        9</span>
<a name="l05327"></a><a class="code" href="../../d4/d8/mi_8h.html#a381">05327</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_DBG_SESSION_PAGEDPOOL_PAGETABLE_FREE_FAIL1   10</span>
<a name="l05328"></a><a class="code" href="../../d4/d8/mi_8h.html#a382">05328</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_DBG_SESSION_WS_PAGE_ALLOC                    11</span>
<a name="l05329"></a><a class="code" href="../../d4/d8/mi_8h.html#a383">05329</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_DBG_SESSION_WS_PAGE_ALLOC_GROWTH             12</span>
05330 <span class="preprocessor"></span><span class="preprocessor">#define MM_DBG_SESSION_INITIAL_PAGE_FREE                13</span>
05331 <span class="preprocessor"></span><span class="preprocessor">#define MM_DBG_SESSION_PAGETABLE_FREE                   14</span>
05332 <span class="preprocessor"></span><span class="preprocessor">#define MM_DBG_SESSION_PAGEDPOOL_PAGETABLE_ALLOC1       15</span>
05333 <span class="preprocessor"></span><span class="preprocessor">#define MM_DBG_SESSION_DRIVER_PAGES_LOCKED              16</span>
05334 <span class="preprocessor"></span><span class="preprocessor">#define MM_DBG_SESSION_DRIVER_PAGES_UNLOCKED            17</span>
05335 <span class="preprocessor"></span><span class="preprocessor">#define MM_DBG_SESSION_WS_HASHPAGE_ALLOC                18</span>
05336 <span class="preprocessor"></span><span class="preprocessor">#define MM_DBG_SESSION_SYSMAPPED_PAGES_COMMITTED        19</span>
05337 <span class="preprocessor"></span>
05338 <span class="preprocessor">#define MM_DBG_SESSION_COMMIT_PAGEDPOOL_PAGES           30</span>
05339 <span class="preprocessor"></span><span class="preprocessor">#define MM_DBG_SESSION_COMMIT_DELETE_VM_RETURN          31</span>
05340 <span class="preprocessor"></span><span class="preprocessor">#define MM_DBG_SESSION_COMMIT_POOL_FREED                32</span>
05341 <span class="preprocessor"></span><span class="preprocessor">#define MM_DBG_SESSION_COMMIT_IMAGE_UNLOAD              33</span>
05342 <span class="preprocessor"></span><span class="preprocessor">#define MM_DBG_SESSION_COMMIT_IMAGELOAD_FAILED1         34</span>
05343 <span class="preprocessor"></span><span class="preprocessor">#define MM_DBG_SESSION_COMMIT_IMAGELOAD_FAILED2         35</span>
05344 <span class="preprocessor"></span><span class="preprocessor">#define MM_DBG_SESSION_COMMIT_IMAGELOAD_NOACCESS        36</span>
05345 <span class="preprocessor"></span>
05346 <span class="preprocessor">#if DBG</span>
05347 <span class="preprocessor"></span><span class="preprocessor">#define MM_SESS_COUNTER_MAX 40</span>
05348 <span class="preprocessor"></span>
05349 <span class="preprocessor">#define MM_BUMP_SESS_COUNTER(_index, bump) \</span>
05350 <span class="preprocessor">    if (_index &gt;= MM_SESS_COUNTER_MAX) { \</span>
05351 <span class="preprocessor">        DbgPrint("Mm: Invalid bump counter %d %d\n", _index, MM_SESS_COUNTER_MAX); \</span>
05352 <span class="preprocessor">        DbgBreakPoint(); \</span>
05353 <span class="preprocessor">    } \</span>
05354 <span class="preprocessor">    else if (MiHydra == TRUE) { \</span>
05355 <span class="preprocessor">        MmSessionSpace-&gt;Debug[_index] += (bump); \</span>
05356 <span class="preprocessor">    }</span>
05357 <span class="preprocessor"></span>
05358 <span class="keyword">typedef</span> <span class="keyword">struct </span>_MM_SESSION_MEMORY_COUNTERS {
05359     SIZE_T NonPagablePages;
05360     SIZE_T CommittedPages;
<a name="l05361"></a><a class="code" href="../../d4/d8/mi_8h.html#a384">05361</a> } MM_SESSION_MEMORY_COUNTERS, *PMM_SESSION_MEMORY_COUNTERS;
<a name="l05362"></a><a class="code" href="../../d4/d8/mi_8h.html#a385">05362</a> 
05363 <span class="preprocessor">#define MM_SESS_MEMORY_COUNTER_MAX  8</span>
05364 <span class="preprocessor"></span>
05365 <span class="preprocessor">#define MM_SNAP_SESS_MEMORY_COUNTERS(_index) \</span>
<a name="l05366"></a><a class="code" href="../../d4/d8/mi_8h.html#a386">05366</a> <span class="preprocessor">    if (_index &gt;= MM_SESS_MEMORY_COUNTER_MAX) { \</span>
<a name="l05367"></a><a class="code" href="../../d4/d8/mi_8h.html#a387">05367</a> <span class="preprocessor">        DbgPrint("Mm: Invalid session mem counter %d %d\n", _index, MM_SESS_MEMORY_COUNTER_MAX); \</span>
<a name="l05368"></a><a class="code" href="../../d4/d8/mi_8h.html#a388">05368</a> <span class="preprocessor">        DbgBreakPoint(); \</span>
<a name="l05369"></a><a class="code" href="../../d4/d8/mi_8h.html#a389">05369</a> <span class="preprocessor">    } \</span>
<a name="l05370"></a><a class="code" href="../../d4/d8/mi_8h.html#a390">05370</a> <span class="preprocessor">    else { \</span>
<a name="l05371"></a><a class="code" href="../../d4/d8/mi_8h.html#a391">05371</a> <span class="preprocessor">        MmSessionSpace-&gt;Debug2[_index].NonPagablePages = MmSessionSpace-&gt;NonPagablePages; \</span>
<a name="l05372"></a><a class="code" href="../../d4/d8/mi_8h.html#a392">05372</a> <span class="preprocessor">        MmSessionSpace-&gt;Debug2[_index].CommittedPages = MmSessionSpace-&gt;CommittedPages; \</span>
<a name="l05373"></a><a class="code" href="../../d4/d8/mi_8h.html#a393">05373</a> <span class="preprocessor">    }</span>
<a name="l05374"></a><a class="code" href="../../d4/d8/mi_8h.html#a394">05374</a> <span class="preprocessor"></span>
05375 <span class="preprocessor">#else</span>
<a name="l05376"></a><a class="code" href="../../d4/d8/mi_8h.html#a395">05376</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_BUMP_SESS_COUNTER(_index, bump)</span>
05377 <span class="preprocessor"></span><span class="preprocessor">#define MM_SNAP_SESS_MEMORY_COUNTERS(_index)</span>
<a name="l05378"></a><a class="code" href="../../d4/d8/mi_8h.html#a749">05378</a> <span class="preprocessor"></span><span class="preprocessor">#endif</span>
05379 <span class="preprocessor"></span>
<a name="l05380"></a><a class="code" href="../../d4/d8/mi_8h.html#a396">05380</a> 
05381 <span class="preprocessor">#define MM_SESSION_FAILURE_NO_IDS                   0</span>
05382 <span class="preprocessor"></span><span class="preprocessor">#define MM_SESSION_FAILURE_NO_COMMIT                1</span>
05383 <span class="preprocessor"></span><span class="preprocessor">#define MM_SESSION_FAILURE_NO_RESIDENT              2</span>
05384 <span class="preprocessor"></span><span class="preprocessor">#define MM_SESSION_FAILURE_RACE_DETECTED            3</span>
05385 <span class="preprocessor"></span><span class="preprocessor">#define MM_SESSION_FAILURE_NO_SYSPTES               4</span>
<a name="l05386"></a><a class="code" href="../../d2/d0/struct__MM__SESSION__SPACE__FLAGS.html">05386</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_SESSION_FAILURE_NO_PAGED_POOL            5</span>
<a name="l05387"></a><a class="code" href="../../d2/d0/struct__MM__SESSION__SPACE__FLAGS.html#o0">05387</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_SESSION_FAILURE_NO_NONPAGED_POOL         6</span>
<a name="l05388"></a><a class="code" href="../../d2/d0/struct__MM__SESSION__SPACE__FLAGS.html#o1">05388</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_SESSION_FAILURE_NO_IMAGE_VA_SPACE        7</span>
<a name="l05389"></a><a class="code" href="../../d2/d0/struct__MM__SESSION__SPACE__FLAGS.html#o2">05389</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_SESSION_FAILURE_NO_SESSION_PAGED_POOL    8</span>
<a name="l05390"></a><a class="code" href="../../d2/d0/struct__MM__SESSION__SPACE__FLAGS.html#o3">05390</a> <span class="preprocessor"></span>
<a name="l05391"></a><a class="code" href="../../d2/d0/struct__MM__SESSION__SPACE__FLAGS.html#o4">05391</a> <span class="preprocessor">#define MM_SESSION_FAILURE_CAUSES                   9</span>
<a name="l05392"></a><a class="code" href="../../d2/d0/struct__MM__SESSION__SPACE__FLAGS.html#o5">05392</a> <span class="preprocessor"></span>
<a name="l05393"></a><a class="code" href="../../d2/d0/struct__MM__SESSION__SPACE__FLAGS.html#o6">05393</a> ULONG <a class="code" href="../../d4/d8/mi_8h.html#a749">MmSessionFailureCauses</a>[<a class="code" href="../../d4/d8/mi_8h.html#a395">MM_SESSION_FAILURE_CAUSES</a>];
05394 
05395 <span class="preprocessor">#define MM_BUMP_SESSION_FAILURES(_index) MmSessionFailureCauses[_index] += 1;</span>
05396 <span class="preprocessor"></span>
05397 <span class="comment">//</span>
05398 <span class="comment">// Note that modifying session space flag bits must be synchronized on Alpha.</span>
05399 <span class="comment">//</span>
05400 
05401 <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d2/d0/struct__MM__SESSION__SPACE__FLAGS.html">_MM_SESSION_SPACE_FLAGS</a> {
05402     ULONG <a class="code" href="../../d2/d0/struct__MM__SESSION__SPACE__FLAGS.html#o0">Initialized</a> : 1;
05403     ULONG <a class="code" href="../../d2/d0/struct__MM__SESSION__SPACE__FLAGS.html#o1">BeingDeleted</a> : 1;
05404     ULONG <a class="code" href="../../d2/d0/struct__MM__SESSION__SPACE__FLAGS.html#o2">WorkingSetInserted</a> : 1;
05405     ULONG <a class="code" href="../../d2/d0/struct__MM__SESSION__SPACE__FLAGS.html#o3">SessionListInserted</a> : 1;
05406     ULONG <a class="code" href="../../d2/d0/struct__MM__SESSION__SPACE__FLAGS.html#o4">HasWsLock</a> : 1;
05407     ULONG <a class="code" href="../../d2/d0/struct__MM__SESSION__SPACE__FLAGS.html#o5">DeletePending</a> : 1;
05408     ULONG <a class="code" href="../../d2/d0/struct__MM__SESSION__SPACE__FLAGS.html#o6">Filler</a> : 26;
<a name="l05409"></a><a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html">05409</a> } <a class="code" href="../../d2/d0/struct__MM__SESSION__SPACE__FLAGS.html">MM_SESSION_SPACE_FLAGS</a>;
05410 
<a name="l05411"></a><a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o0">05411</a> <span class="comment">//</span>
05412 <span class="comment">// The session space data structure - allocated per session and only visible at</span>
<a name="l05413"></a><a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o1">05413</a> <span class="comment">// MM_SESSION_SPACE_BASE when in the context of a process from the session.</span>
<a name="l05414"></a><a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o2">05414</a> <span class="comment">// This virtual address space is rotated at context switch time when switching</span>
05415 <span class="comment">// from a process in session A to a process in session B.  This rotation is</span>
<a name="l05416"></a><a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o4">05416</a> <span class="comment">// useful for things like providing paged pool per session so many sessions</span>
05417 <span class="comment">// won't exhaust the VA space which backs the system global pool.</span>
05418 <span class="comment">//</span>
05419 <span class="comment">// A kernel PTE is also allocated to double map this page so that global</span>
05420 <span class="comment">// pointers can be maintained to provide system access from any process context.</span>
05421 <span class="comment">// This is needed for things like mutexes and WSL chains.</span>
05422 <span class="comment">//</span>
05423 
05424 <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html">_MM_SESSION_SPACE</a> {
05425 
05426     ULONG <a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o0">ReferenceCount</a>;
<a name="l05427"></a><a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o5">05427</a>     <span class="keyword">union </span>{
05428         ULONG <a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o1">LongFlags</a>;
05429         <a class="code" href="../../d2/d0/struct__MM__SESSION__SPACE__FLAGS.html">MM_SESSION_SPACE_FLAGS</a> <a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o2">Flags</a>;
05430     } u;
05431     ULONG SessionId;
05432 
05433     <span class="comment">//</span>
05434     <span class="comment">// All the page tables for session space use this as their parent.</span>
<a name="l05435"></a><a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o6">05435</a>     <span class="comment">// Note that it's not really a page directory - it's really a page</span>
05436     <span class="comment">// table page itself (the one used to map this very structure).</span>
<a name="l05437"></a><a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o7">05437</a>     <span class="comment">//</span>
05438     <span class="comment">// This provides a reference to something that won't go away and</span>
05439     <span class="comment">// is relevant regardless of which process within the session is current.</span>
05440     <span class="comment">//</span>
05441 
05442     PFN_NUMBER <a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o5">SessionPageDirectoryIndex</a>;
05443 
<a name="l05444"></a><a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o8">05444</a>     <span class="comment">//</span>
05445     <span class="comment">// This is a pointer in global system address space, used to make various</span>
05446     <span class="comment">// fields that can be referenced from any process visible from any process</span>
05447     <span class="comment">// context.  This is for things like mutexes, WSL chains, etc.</span>
05448     <span class="comment">//</span>
05449 
<a name="l05450"></a><a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o9">05450</a>     <span class="keyword">struct </span><a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html">_MM_SESSION_SPACE</a> *<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o6">GlobalVirtualAddress</a>;
<a name="l05451"></a><a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o10">05451</a> 
<a name="l05452"></a><a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o11">05452</a>     KSPIN_LOCK <a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o7">SpinLock</a>;
<a name="l05453"></a><a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o12">05453</a> 
05454     <span class="comment">//</span>
05455     <span class="comment">// This is the list of the processes in this group that have</span>
05456     <span class="comment">// session space entries.</span>
05457     <span class="comment">//</span>
05458 
05459     LIST_ENTRY <a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o8">ProcessList</a>;
05460 
05461     <span class="comment">//</span>
05462     <span class="comment">// Pool allocation counts - these are always valid.</span>
<a name="l05463"></a><a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o13">05463</a>     <span class="comment">//</span>
05464 
05465     SIZE_T <a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o9">NonPagedPoolBytes</a>;
05466     SIZE_T <a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o10">PagedPoolBytes</a>;
05467     ULONG <a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o11">NonPagedPoolAllocations</a>;
05468     ULONG <a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o12">PagedPoolAllocations</a>;
05469 
05470     <span class="comment">//</span>
<a name="l05471"></a><a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o14">05471</a>     <span class="comment">// This is the count of non paged allocations to support this session</span>
05472     <span class="comment">// space.  This includes the session structure page table and data pages,</span>
<a name="l05473"></a><a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o15">05473</a>     <span class="comment">// WSL page table and data pages, session pool page table pages and session</span>
05474     <span class="comment">// image page table pages.  These are all charged against</span>
05475     <span class="comment">// MmResidentAvailable.</span>
05476     <span class="comment">//</span>
05477 
05478     SIZE_T <a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o13">NonPagablePages</a>;
05479 
05480     <span class="comment">//</span>
05481     <span class="comment">// This is the count of pages in this session that have been charged against</span>
05482     <span class="comment">// the systemwide commit.  This includes all the NonPagablePages plus the</span>
05483     <span class="comment">// data pages they typically map.</span>
05484     <span class="comment">//</span>
05485 
05486     SIZE_T <a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o14">CommittedPages</a>;
05487 
05488     LARGE_INTEGER <a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o15">LastProcessSwappedOutTime</a>;
05489 
05490 <span class="preprocessor">#if defined (_WIN64)</span>
<a name="l05491"></a><a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o16">05491</a> <span class="preprocessor"></span>
05492     <span class="comment">//</span>
05493     <span class="comment">// The page directory that maps session space is saved here so</span>
05494     <span class="comment">// trimmers can attach.</span>
05495     <span class="comment">//</span>
05496 
05497     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> PageDirectory;
05498 
<a name="l05499"></a><a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o17">05499</a> <span class="preprocessor">#else</span>
05500 <span class="preprocessor"></span>
05501     <span class="comment">//</span>
05502     <span class="comment">// The second level page tables that map session space are shared</span>
05503     <span class="comment">// by all processes in the session.</span>
05504     <span class="comment">//</span>
<a name="l05505"></a><a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o18">05505</a> 
05506     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> <a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o16">PageTables</a>[<a class="code" href="../../d4/d8/mi_8h.html#a341">MI_SESSION_SPACE_PAGE_TABLES</a>];
05507 
05508 <span class="preprocessor">#endif</span>
05509 <span class="preprocessor"></span>
05510     <span class="comment">//</span>
05511     <span class="comment">// Session space paged pool support.</span>
<a name="l05512"></a><a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o19">05512</a>     <span class="comment">//</span>
05513 
05514     <a class="code" href="../../d6/d9/struct__FAST__MUTEX.html">FAST_MUTEX</a> <a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o17">PagedPoolMutex</a>;
05515 
05516     <span class="comment">//</span>
05517     <span class="comment">// Start of session paged pool virtual space.</span>
<a name="l05518"></a><a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o20">05518</a>     <span class="comment">//</span>
05519 
<a name="l05520"></a><a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o21">05520</a>     PVOID <a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o18">PagedPoolStart</a>;
05521 
<a name="l05522"></a><a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o22">05522</a>     <span class="comment">//</span>
05523     <span class="comment">// Current end of pool virtual space. Can be extended to the</span>
<a name="l05524"></a><a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o23">05524</a>     <span class="comment">// end of the session space.</span>
05525     <span class="comment">//</span>
05526 
05527     PVOID <a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o19">PagedPoolEnd</a>;
05528 
05529     <span class="comment">//</span>
05530     <span class="comment">// PTE pointers for pool.</span>
05531     <span class="comment">//</span>
<a name="l05532"></a><a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o24">05532</a> 
05533     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> <a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o20">PagedPoolBasePde</a>;
05534 
05535     <a class="code" href="../../d9/d9/struct__MM__PAGED__POOL__INFO.html">MM_PAGED_POOL_INFO</a> <a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o21">PagedPoolInfo</a>;
05536 
05537     ULONG <a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o22">Color</a>;
<a name="l05538"></a><a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o25">05538</a> 
05539     ULONG <a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o23">ProcessOutSwapCount</a>;
<a name="l05540"></a><a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o26">05540</a> 
05541     <span class="comment">//</span>
05542     <span class="comment">// This is the list of system images currently valid in</span>
05543     <span class="comment">// this session space.  This information is in addition</span>
05544     <span class="comment">// to the module global information in PsLoadedModuleList.</span>
05545     <span class="comment">//</span>
<a name="l05546"></a><a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o27">05546</a> 
05547     LIST_ENTRY <a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o24">ImageList</a>;
<a name="l05548"></a><a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o28">05548</a> 
05549     <span class="comment">//</span>
<a name="l05550"></a><a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o29">05550</a>     <span class="comment">// The system PTE self-map entry.</span>
05551     <span class="comment">//</span>
05552 
05553     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> <a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o25">GlobalPteEntry</a>;
05554 
05555     ULONG <a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o26">CopyOnWriteCount</a>;
<a name="l05556"></a><a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">05556</a> 
<a name="l05557"></a><a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o31">05557</a>     <span class="comment">//</span>
05558     <span class="comment">// The count of "known attachers and the associated event.</span>
<a name="l05559"></a><a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o32">05559</a>     <span class="comment">//</span>
05560 
05561     ULONG <a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o27">AttachCount</a>;
05562 
05563     <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> <a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o28">AttachEvent</a>;
05564 
05565     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> <a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o29">LastProcess</a>;
<a name="l05566"></a><a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o33">05566</a> 
05567     <span class="comment">//</span>
05568     <span class="comment">// Working set information.</span>
05569     <span class="comment">//</span>
05570 
05571     <a class="code" href="../../d3/d6/struct__MMSUPPORT.html">MMSUPPORT</a>  <a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>;
05572     <a class="code" href="../../d4/d8/mi_8h.html#a448">PMMWSLE</a>    <a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o31">Wsle</a>;
05573 
05574     <a class="code" href="../../d6/d4/struct__ERESOURCE.html">ERESOURCE</a>  <a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o32">WsLock</a>;         <span class="comment">// owned by WorkingSetLockOwner</span>
<a name="l05575"></a><a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o34">05575</a> 
05576     <span class="comment">//</span>
05577     <span class="comment">// This chain is in global system addresses (not session VAs) and can</span>
05578     <span class="comment">// be walked from any system context, ie: for WSL trimming.</span>
05579     <span class="comment">//</span>
05580 
05581     LIST_ENTRY <a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o33">WsListEntry</a>;
05582 
05583     <span class="comment">//</span>
<a name="l05584"></a><a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o35">05584</a>     <span class="comment">// Support for mapping system views into session space.  Each desktop</span>
05585     <span class="comment">// allocates a 3MB heap and the global system view space is only 48M</span>
<a name="l05586"></a><a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o36">05586</a>     <span class="comment">// total.  This would limit us to only 20-30 users - rotating the</span>
05587     <span class="comment">// system view space with each session removes this limitation.</span>
05588     <span class="comment">//</span>
05589 
05590     <a class="code" href="../../d0/d6/struct__MMSESSION.html">MMSESSION</a> <a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o34">Session</a>;
05591 
<a name="l05592"></a><a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o37">05592</a>     <span class="comment">//</span>
05593     <span class="comment">// This is the driver object entry for WIN32K.SYS</span>
05594     <span class="comment">//</span>
05595     <span class="comment">// It is not a real driver object, but contained here</span>
05596     <span class="comment">// for information such as the DriverUnload routine.</span>
05597     <span class="comment">//</span>
05598 
05599     <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">DRIVER_OBJECT</a> <a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o35">Win32KDriverObject</a>;
05600 
05601     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> <a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o36">WorkingSetLockOwner</a>;
05602 
05603     <span class="comment">//</span>
05604     <span class="comment">// Pool descriptor for less than 1 page allocations.</span>
05605     <span class="comment">//</span>
05606 
05607     <a class="code" href="../../d4/d8/struct__POOL__DESCRIPTOR.html">POOL_DESCRIPTOR</a> <a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o37">PagedPool</a>;
05608 
<a name="l05609"></a><a class="code" href="../../d4/d8/mi_8h.html#a753">05609</a> <span class="preprocessor">#if defined(_IA64_)</span>
05610 <span class="preprocessor"></span>    REGION_MAP_INFO SessionMapInfo;
<a name="l05611"></a><a class="code" href="../../d4/d8/mi_8h.html#a754">05611</a> <span class="preprocessor">#endif</span>
05612 <span class="preprocessor"></span>
05613 <span class="preprocessor">#if DBG</span>
05614 <span class="preprocessor"></span>    <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> SessionLockOwner;
05615     ULONG WorkingSetLockOwnerCount;
05616 
<a name="l05617"></a><a class="code" href="../../d4/d8/mi_8h.html#a397">05617</a>     ULONG_PTR <a class="code" href="../../d2/d5/editreg_8c.html#a51">Debug</a>[MM_SESS_COUNTER_MAX];
05618 
05619     MM_SESSION_MEMORY_COUNTERS Debug2[MM_SESS_MEMORY_COUNTER_MAX];
05620 <span class="preprocessor">#endif</span>
05621 <span class="preprocessor"></span>
05622 } <a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html">MM_SESSION_SPACE</a>, *<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html">PMM_SESSION_SPACE</a>;
05623 
05624 <span class="keyword">extern</span> <a class="code" href="../../d4/d8/mi_8h.html#a752">PMM_SESSION_SPACE</a> <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>;
05625 
05626 <span class="keyword">extern</span> ULONG <a class="code" href="../../d4/d8/mi_8h.html#a754">MiSessionCount</a>;
05627 
<a name="l05628"></a><a class="code" href="../../d4/d8/mi_8h.html#a398">05628</a> <span class="comment">//</span>
<a name="l05629"></a><a class="code" href="../../d4/d8/mi_8h.html#a399">05629</a> <span class="comment">// This could be improved to just flush the non-global TB entries.</span>
05630 <span class="comment">//</span>
05631 
<a name="l05632"></a><a class="code" href="../../d4/d8/mi_8h.html#a400">05632</a> <span class="preprocessor">#define MI_FLUSH_SESSION_TB(OLDIRQL) KeRaiseIrql (DISPATCH_LEVEL, &amp;OLDIRQL); \</span>
05633 <span class="preprocessor">                                     KeFlushEntireTb (TRUE, TRUE); \</span>
05634 <span class="preprocessor">                                     KeLowerIrql (OLDIRQL);</span>
<a name="l05635"></a><a class="code" href="../../d4/d8/mi_8h.html#a401">05635</a> <span class="preprocessor"></span>
05636 <span class="preprocessor">#if DBG</span>
05637 <span class="preprocessor"></span><span class="preprocessor">#define MM_SET_SESSION_LOCK_OWNER()  ASSERT (MmSessionSpace-&gt;SessionLockOwner == NULL); \</span>
05638 <span class="preprocessor">                                  MmSessionSpace-&gt;SessionLockOwner = PsGetCurrentThread();</span>
05639 <span class="preprocessor"></span>
05640 <span class="preprocessor">#define MM_CLEAR_SESSION_LOCK_OWNER()  ASSERT (MmSessionSpace-&gt;SessionLockOwner == PsGetCurrentThread()); \</span>
05641 <span class="preprocessor">                                    MmSessionSpace-&gt;SessionLockOwner = NULL;</span>
<a name="l05642"></a><a class="code" href="../../d4/d8/mi_8h.html#a402">05642</a> <span class="preprocessor"></span><span class="preprocessor">#else</span>
05643 <span class="preprocessor"></span><span class="preprocessor">#define MM_SET_SESSION_LOCK_OWNER()</span>
<a name="l05644"></a><a class="code" href="../../d4/d8/mi_8h.html#a403">05644</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_CLEAR_SESSION_LOCK_OWNER()</span>
05645 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
05646 <span class="preprocessor"></span>
05647 <span class="preprocessor">#define LOCK_SESSION(OLDIRQL)   ExAcquireSpinLock (&amp;((SESSION_GLOBAL(MmSessionSpace))-&gt;SpinLock), &amp;OLDIRQL); \</span>
05648 <span class="preprocessor">      MM_SET_SESSION_LOCK_OWNER ();</span>
05649 <span class="preprocessor"></span>
05650 <span class="preprocessor">#define UNLOCK_SESSION(OLDIRQL)    MM_CLEAR_SESSION_LOCK_OWNER (); \</span>
05651 <span class="preprocessor">    ExReleaseSpinLock (&amp;((SESSION_GLOBAL(MmSessionSpace))-&gt;SpinLock), OLDIRQL);</span>
05652 <span class="preprocessor"></span>
05653 <span class="comment">//</span>
05654 <span class="comment">// The default number of pages for the session working set minimum &amp; maximum.</span>
05655 <span class="comment">//</span>
05656 
05657 <span class="preprocessor">#define MI_SESSION_SPACE_WORKING_SET_MINIMUM 20</span>
05658 <span class="preprocessor"></span>
05659 <span class="preprocessor">#define MI_SESSION_SPACE_WORKING_SET_MAXIMUM 384</span>
05660 <span class="preprocessor"></span>
05661 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
05662 <a class="code" href="../../d3/d7/session_8c.html#a9">MiSessionCommitPageTables</a>(
05663     PVOID StartVa,
05664     PVOID EndVa
05665     );
05666 
05667 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
05668 <a class="code" href="../../d4/d8/mi_8h.html#a973">MiInitializeSessionPool</a>(
05669     VOID
05670     );
05671 
05672 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
05673 <a class="code" href="../../d4/d8/mi_8h.html#a974">MiCheckSessionPoolAllocations</a>(
05674     VOID
05675     );
05676 
<a name="l05677"></a><a class="code" href="../../d4/d8/mi_8h.html#a404">05677</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
05678 <a class="code" href="../../d4/d8/mi_8h.html#a975">MiFreeSessionPoolBitMaps</a>(
05679     VOID
05680     );
<a name="l05681"></a><a class="code" href="../../d4/d8/mi_8h.html#a405">05681</a> 
05682 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
05683 <a class="code" href="../../d3/d7/session_8c.html#a17">MiDetachSession</a>(
05684     VOID
<a name="l05685"></a><a class="code" href="../../d4/d8/mi_8h.html#a406">05685</a>     );
05686 
05687 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l05688"></a><a class="code" href="../../d4/d8/mi_8h.html#a407">05688</a> <a class="code" href="../../d3/d7/session_8c.html#a16">MiAttachSession</a>(
05689     IN PMM_SESSION_SPACE SessionGlobal
05690     );
05691 
05692 <span class="preprocessor">#define MM_SET_SESSION_RESOURCE_OWNER()                                 \</span>
05693 <span class="preprocessor">        ASSERT (MmSessionSpace-&gt;WorkingSetLockOwner == NULL);           \</span>
<a name="l05694"></a><a class="code" href="../../d4/d8/mi_8h.html#a408">05694</a> <span class="preprocessor">        MmSessionSpace-&gt;WorkingSetLockOwner = PsGetCurrentThread();</span>
05695 <span class="preprocessor"></span>
05696 <span class="preprocessor">#define MM_CLEAR_SESSION_RESOURCE_OWNER()                               \</span>
05697 <span class="preprocessor">        ASSERT (MmSessionSpace-&gt;WorkingSetLockOwner == PsGetCurrentThread()); \</span>
05698 <span class="preprocessor">        MmSessionSpace-&gt;WorkingSetLockOwner = NULL;</span>
05699 <span class="preprocessor"></span>
<a name="l05700"></a><a class="code" href="../../d4/d8/mi_8h.html#a755">05700</a> <span class="preprocessor">#define MM_SESSION_SPACE_WS_LOCK_ASSERT()                               \</span>
<a name="l05701"></a><a class="code" href="../../d4/d8/mi_8h.html#a756">05701</a> <span class="preprocessor">        ASSERT (MmSessionSpace-&gt;WorkingSetLockOwner == PsGetCurrentThread())</span>
05702 <span class="preprocessor"></span>
<a name="l05703"></a><a class="code" href="../../d4/d8/mi_8h.html#a757">05703</a> <span class="preprocessor">#define LOCK_SESSION_SPACE_WS(OLDIRQL)                                  \</span>
<a name="l05704"></a><a class="code" href="../../d4/d8/mi_8h.html#a758">05704</a> <span class="preprocessor">            ASSERT (KeGetCurrentIrql() &lt;= APC_LEVEL);                   \</span>
05705 <span class="preprocessor">            KeRaiseIrql(APC_LEVEL,&amp;OLDIRQL);                            \</span>
05706 <span class="preprocessor">            ExAcquireResourceExclusive(&amp;MmSessionSpace-&gt;WsLock, TRUE);  \</span>
05707 <span class="preprocessor">            MM_SET_SESSION_RESOURCE_OWNER ();</span>
05708 <span class="preprocessor"></span>
05709 <span class="preprocessor">#define UNLOCK_SESSION_SPACE_WS(OLDIRQL)                                 \</span>
05710 <span class="preprocessor">                            MM_CLEAR_SESSION_RESOURCE_OWNER ();          \</span>
05711 <span class="preprocessor">                            ExReleaseResource (&amp;MmSessionSpace-&gt;WsLock); \</span>
05712 <span class="preprocessor">                            KeLowerIrql (OLDIRQL);                       \</span>
05713 <span class="preprocessor">                            ASSERT (KeGetCurrentIrql() &lt;= APC_LEVEL);</span>
05714 <span class="preprocessor"></span>
05715 <span class="keyword">extern</span> <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> <a class="code" href="../../d4/d8/mi_8h.html#a755">MiHighestUserPte</a>;
05716 <span class="keyword">extern</span> <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> <a class="code" href="../../d4/d8/mi_8h.html#a756">MiHighestUserPde</a>;
05717 
05718 <span class="keyword">extern</span> <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> <a class="code" href="../../d4/d8/mi_8h.html#a757">MiSessionBasePte</a>;
05719 <span class="keyword">extern</span> <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> <a class="code" href="../../d4/d8/mi_8h.html#a758">MiSessionLastPte</a>;
05720 
05721 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
05722 <a class="code" href="../../d4/d0/wslist_8c.html#a35">MiEmptyWorkingSet</a> (
05723     IN <a class="code" href="../../d3/d6/struct__MMSUPPORT.html">PMMSUPPORT</a> WsInfo,
05724     IN LOGICAL WaitOk
05725     );
05726 
05727 <span class="comment">//++</span>
05728 <span class="comment">//ULONG</span>
05729 <span class="comment">//MiGetPdeSessionIndex (</span>
05730 <span class="comment">//    IN PVOID va</span>
05731 <span class="comment">//    );</span>
05732 <span class="comment">//</span>
<a name="l05733"></a><a class="code" href="../../d4/d8/mi_8h.html#a409">05733</a> <span class="comment">// Routine Description:</span>
05734 <span class="comment">//</span>
05735 <span class="comment">//    MiGetPdeSessionIndex returns the session structure index for the PDE</span>
05736 <span class="comment">//    will (or does) map the given virtual address.</span>
05737 <span class="comment">//</span>
05738 <span class="comment">// Arguments</span>
05739 <span class="comment">//</span>
05740 <span class="comment">//    Va - Supplies the virtual address to locate the PDE index for.</span>
05741 <span class="comment">//</span>
05742 <span class="comment">// Return Value:</span>
05743 <span class="comment">//</span>
05744 <span class="comment">//    The index of the PDE entry.</span>
05745 <span class="comment">//</span>
05746 <span class="comment">//--</span>
05747 
05748 <span class="preprocessor">#define MiGetPdeSessionIndex(va)  ((ULONG)(((ULONG_PTR)(va) - (ULONG_PTR)MmSessionBase) &gt;&gt; PDI_SHIFT))</span>
05749 <span class="preprocessor"></span>
05750 <span class="comment">//</span>
05751 <span class="comment">// Session space contains the image loader and tracker, virtual</span>
05752 <span class="comment">// address allocator, paged pool allocator, system view image mappings,</span>
05753 <span class="comment">// and working set for kernel mode virtual addresses that are instanced</span>
05754 <span class="comment">// for groups of processes in a Session process group. This</span>
05755 <span class="comment">// process group is identified by a SessionId.</span>
05756 <span class="comment">//</span>
05757 <span class="comment">// Each Session process group's loaded kernel modules, paged pool</span>
05758 <span class="comment">// allocations, working set, and mapped system views are separate from</span>
05759 <span class="comment">// other Session process groups, even though they have the same</span>
05760 <span class="comment">// virtual addresses.</span>
05761 <span class="comment">//</span>
<a name="l05762"></a><a class="code" href="../../d1/d1/struct__IMAGE__ENTRY__IN__SESSION.html">05762</a> <span class="comment">// This is to support the Hydra multi-user Windows NT system by</span>
<a name="l05763"></a><a class="code" href="../../d1/d1/struct__IMAGE__ENTRY__IN__SESSION.html#o0">05763</a> <span class="comment">// replicating WIN32K.SYS, and its complement of video and printer drivers,</span>
<a name="l05764"></a><a class="code" href="../../d1/d1/struct__IMAGE__ENTRY__IN__SESSION.html#o1">05764</a> <span class="comment">// desktop heaps, memory allocations, etc.</span>
<a name="l05765"></a><a class="code" href="../../d1/d1/struct__IMAGE__ENTRY__IN__SESSION.html#o2">05765</a> <span class="comment">//</span>
<a name="l05766"></a><a class="code" href="../../d1/d1/struct__IMAGE__ENTRY__IN__SESSION.html#o3">05766</a> 
<a name="l05767"></a><a class="code" href="../../d1/d1/struct__IMAGE__ENTRY__IN__SESSION.html#o4">05767</a> <span class="comment">//</span>
<a name="l05768"></a><a class="code" href="../../d1/d1/struct__IMAGE__ENTRY__IN__SESSION.html#o5">05768</a> <span class="comment">// Structure linked into a session space structure to describe</span>
05769 <span class="comment">// which system images in PsLoadedModuleTable and</span>
05770 <span class="comment">// SESSION_DRIVER_GLOBAL_LOAD_ADDRESS's</span>
<a name="l05771"></a><a class="code" href="../../d4/d8/mi_8h.html#a761">05771</a> <span class="comment">// have been allocated for the current session space.</span>
05772 <span class="comment">//</span>
05773 <span class="comment">// The reference count tracks the number of loads of this image within</span>
05774 <span class="comment">// this session.</span>
05775 <span class="comment">//</span>
05776 
05777 <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d1/d1/struct__IMAGE__ENTRY__IN__SESSION.html">_IMAGE_ENTRY_IN_SESSION</a> {
05778     LIST_ENTRY Link;
05779     PVOID Address;
05780     PVOID LastAddress;
05781     ULONG ImageCountInThisSession;
05782     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PrototypePtes;
05783     PLDR_DATA_TABLE_ENTRY DataTableEntry;
05784 } <a class="code" href="../../d1/d1/struct__IMAGE__ENTRY__IN__SESSION.html">IMAGE_ENTRY_IN_SESSION</a>, *<a class="code" href="../../d1/d1/struct__IMAGE__ENTRY__IN__SESSION.html">PIMAGE_ENTRY_IN_SESSION</a>;
05785 
05786 <span class="keyword">extern</span> LIST_ENTRY <a class="code" href="../../d4/d8/mi_8h.html#a761">MiSessionWsList</a>;
05787 
05788 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
05789 <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a0">FASTCALL</a>
05790 <a class="code" href="../../d8/d2/pagfault_8c.html#a21">MiCheckPdeForSessionSpace</a>(
05791     IN PVOID VirtualAddress
05792     );
05793 
05794 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
05795 <a class="code" href="../../d4/d7/sessload_8c.html#a11">MiShareSessionImage</a> (
05796     IN PSECTION Section,
05797     IN OUT PSIZE_T ViewSize
05798     );
05799 
05800 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
05801 <a class="code" href="../../d4/d7/sessload_8c.html#a15">MiSessionWideInitializeAddresses</a> (
05802     VOID
05803     );
05804 
05805 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
05806 <a class="code" href="../../d4/d7/sessload_8c.html#a17">MiSessionWideReserveImageAddress</a> (
05807     IN PUNICODE_STRING pImageName,
05808     IN PSECTION Section,
05809     IN ULONG_PTR Alignment,
05810     OUT PVOID *ppAddr,
05811     OUT PBOOLEAN pAlreadyLoaded
05812     );
05813 
05814 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
05815 <a class="code" href="../../d3/d7/session_8c.html#a7">MiInitializeSessionIds</a> (
05816     VOID
05817     );
05818 
05819 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
05820 <a class="code" href="../../d4/d0/wslist_8c.html#a28">MiInitializeSessionWsSupport</a>(
05821     VOID
05822     );
05823 
05824 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
05825 <a class="code" href="../../d3/d7/session_8c.html#a5">MiSessionAddProcess</a> (
05826     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> NewProcess
05827     );
05828 
05829 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
05830 <a class="code" href="../../d3/d7/session_8c.html#a6">MiSessionRemoveProcess</a> (
05831     VOID
05832     );
05833 
05834 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
05835 <a class="code" href="../../d4/d8/mi_8h.html#a987">MiRemovePsLoadedModule</a>(
05836     PLDR_DATA_TABLE_ENTRY DataTableEntry
05837     );
05838 
05839 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
05840 <a class="code" href="../../d4/d7/sessload_8c.html#a18">MiRemoveImageSessionWide</a>(
05841     IN PVOID BaseAddr
05842     );
05843 
05844 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
05845 <a class="code" href="../../d4/d8/mi_8h.html#a989">MiDeleteSessionVirtualAddresses</a>(
05846     IN PVOID VirtualAddress,
05847     IN SIZE_T NumberOfBytes
05848     );
05849 
05850 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
05851 <a class="code" href="../../d4/d8/mi_8h.html#a990">MiUnloadSessionImageByForce</a> (
05852     IN SIZE_T NumberOfPtes,
05853     IN PVOID ImageBase
05854     );
05855 
05856 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
05857 <a class="code" href="../../d4/d7/sessload_8c.html#a16">MiSessionWideGetImageSize</a>(
05858     IN PVOID BaseAddress,
05859     OUT PSIZE_T NumberOfBytes OPTIONAL,
05860     OUT PSIZE_T CommitPages OPTIONAL
05861     );
05862 
05863 <a class="code" href="../../d4/d8/mi_8h.html#a760">PIMAGE_ENTRY_IN_SESSION</a>
05864 <a class="code" href="../../d4/d7/sessload_8c.html#a13">MiSessionLookupImage</a> (
05865     IN PVOID BaseAddress
05866     );
05867 
05868 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
05869 <a class="code" href="../../d3/d7/session_8c.html#a18">MiSessionCommitImagePages</a>(
05870     PVOID BaseAddr,
05871     SIZE_T Size
05872     );
05873 
05874 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
05875 <a class="code" href="../../d4/d7/sessload_8c.html#a14">MiSessionUnloadAllImages</a> (
05876     VOID
05877     );
05878 
05879 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
05880 <a class="code" href="../../d4/d8/mi_8h.html#a995">MiFreeSessionSpaceMap</a> (
05881     VOID
05882     );
05883 
05884 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
05885 <a class="code" href="../../d4/d0/wslist_8c.html#a29">MiSessionInitializeWorkingSetList</a> (
05886     VOID
05887     );
05888 
05889 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
05890 <a class="code" href="../../d4/d8/mi_8h.html#a997">MiSessionUnlinkWorkingSet</a> (
05891     VOID
05892     );
05893 
05894 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
05895 <a class="code" href="../../d8/d2/pagfault_8c.html#a32">MiSessionCopyOnWrite</a> (
05896     IN PMM_SESSION_SPACE SessionSpace,
05897     IN PVOID FaultingAddress,
<a name="l05898"></a><a class="code" href="../../d4/d8/mi_8h.html#a410">05898</a>     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte
05899     );
05900 
05901 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
05902 <a class="code" href="../../d3/d7/session_8c.html#a19">MiSessionOutSwapProcess</a> (
05903     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process
05904     );
05905 
05906 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
05907 <a class="code" href="../../d3/d7/session_8c.html#a20">MiSessionInSwapProcess</a> (
05908     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process
05909     );
05910 
05911 <span class="preprocessor">#if !defined (_X86PAE_)</span>
05912 <span class="preprocessor"></span>
05913 <span class="preprocessor">#define MI_GET_DIRECTORY_FRAME_FROM_PROCESS(_Process) \</span>
05914 <span class="preprocessor">        MI_GET_PAGE_FRAME_FROM_PTE((PMMPTE)(&amp;((_Process)-&gt;Pcb.DirectoryTableBase[0])))</span>
05915 <span class="preprocessor"></span>
05916 <span class="preprocessor">#else</span>
05917 <span class="preprocessor"></span>
05918 <span class="preprocessor">#define MI_GET_DIRECTORY_FRAME_FROM_PROCESS(_Process) \</span>
05919 <span class="preprocessor">        ((_Process)-&gt;PaePageDirectoryPage)</span>
05920 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
05921 <span class="preprocessor"></span>
05922 <a class="code" href="../../d2/d1/mm_8h.html#a76">PERFINFO_MIH_DECL</a>
05923 
05924 <span class="preprocessor">#if defined(_MIALT4K_)</span>
05925 <span class="preprocessor"></span><a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
05926 MiSetCopyPagesFor4kPage(
05927     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process,
05928     IN OUT PMMVAD *Vad,
05929     IN OUT PVOID *StartingAddress,
05930     IN OUT PVOID *EndingAddress,
05931     IN ULONG ProtectionMask);
05932 <span class="preprocessor">#endif</span>
05933 <span class="preprocessor"></span>
05934 <span class="preprocessor">#endif  // MI</span>
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:48 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
