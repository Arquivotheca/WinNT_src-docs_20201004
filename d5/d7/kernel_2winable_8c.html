<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: kernel/winable.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>winable.c File Reference</h1><code>#include "<a class="el" href="../../d1/d3/w32_2ntuser_2kernel_2precomp_8h-source.html">precomp.h</a>"</code><br>

<p>
<a href="../../d6/d6/kernel_2winable_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d7/kernel_2winable_8c.html#a0">DBGVERIFYEVENTHOOK</a>(peh)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d7/kernel_2winable_8c.html#a1">DBGVERIFYNOTIFY</a>(pNotify)</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>WINEVENTPROC&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d7/kernel_2winable_8c.html#a4">xxxGetEventProc</a> (<a class="el" href="../../d8/d4/structtagEVENTHOOK.html">PEVENTHOOK</a> pEventOrg)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d9/d2/structtagNOTIFY.html">PNOTIFY</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d7/kernel_2winable_8c.html#a5">CreateNotify</a> (<a class="el" href="../../d8/d4/structtagEVENTHOOK.html">PEVENTHOOK</a> peh, <a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> event, <a class="el" href="../../d6/d9/structtagWND.html">PWND</a> pwnd, LONG idObject, LONG idChild, <a class="el" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiEvent, <a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwTime)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d8/d4/structtagEVENTHOOK.html">PEVENTHOOK</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d7/kernel_2winable_8c.html#a6">xxxProcessNotifyWinEvent</a> (<a class="el" href="../../d9/d2/structtagNOTIFY.html">PNOTIFY</a> pNotify)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d7/kernel_2winable_8c.html#a7">xxxFlushDeferredWindowEvents</a> ()</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d7/kernel_2winable_8c.html#a8">xxxWindowEvent</a> (<a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> event, <a class="el" href="../../d6/d9/structtagWND.html">PWND</a> pwnd, LONG idObject, LONG idChild, <a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="el" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d7/kernel_2winable_8c.html#a9">RemoveNotify</a> (<a class="el" href="../../d9/d2/structtagNOTIFY.html">PNOTIFY</a> *ppNotify)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d7/kernel_2winable_8c.html#a10">DestroyNotify</a> (<a class="el" href="../../d9/d2/structtagNOTIFY.html">PNOTIFY</a> pNotifyDestroy)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d7/kernel_2winable_8c.html#a11">FreeThreadsWinEvents</a> (<a class="el" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d8/d4/structtagEVENTHOOK.html">PEVENTHOOK</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d7/kernel_2winable_8c.html#a12">_SetWinEventHook</a> (<a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> eventMin, <a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> eventMax, HMODULE hmodWinEventProc, PUNICODE_STRING pstrLib, WINEVENTPROC pfnWinEventProc, HANDLE hEventProcess, <a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> idEventThread, <a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="el" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d7/kernel_2winable_8c.html#a13">_UnhookWinEvent</a> (<a class="el" href="../../d8/d4/structtagEVENTHOOK.html">PEVENTHOOK</a> pEventUnhook)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d7/kernel_2winable_8c.html#a14">DestroyEventHook</a> (<a class="el" href="../../d8/d4/structtagEVENTHOOK.html">PEVENTHOOK</a> pEventDestroy)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d9/d2/structtagNOTIFY.html">NOTIFY</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d7/kernel_2winable_8c.html#a2">notifyCache</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d7/kernel_2winable_8c.html#a3">fNotifyCacheInUse</a> = FALSE</td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a0" doxytag="kernel/winable.c::DBGVERIFYEVENTHOOK" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define DBGVERIFYEVENTHOOK          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">peh&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d6/kernel_2winable_8c-source.html#l00033">33</a> of file <a class="el" href="../../d6/d6/kernel_2winable_8c-source.html">kernel/winable.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d6/kernel_2winable_8c-source.html#l00827">_UnhookWinEvent()</a>, <a class="el" href="../../d6/d6/kernel_2winable_8c-source.html#l00879">DestroyEventHook()</a>, <a class="el" href="../../d6/d6/kernel_2winable_8c-source.html#l00495">RemoveNotify()</a>, <a class="el" href="../../d6/d6/kernel_2winable_8c-source.html#l00068">xxxProcessNotifyWinEvent()</a>, and <a class="el" href="../../d6/d6/kernel_2winable_8c-source.html#l00274">xxxWindowEvent()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="kernel/winable.c::DBGVERIFYNOTIFY" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define DBGVERIFYNOTIFY          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">pNotify&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d6/kernel_2winable_8c-source.html#l00034">34</a> of file <a class="el" href="../../d6/d6/kernel_2winable_8c-source.html">kernel/winable.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d6/kernel_2winable_8c-source.html#l00566">DestroyNotify()</a>, <a class="el" href="../../d6/d6/kernel_2winable_8c-source.html#l00068">xxxProcessNotifyWinEvent()</a>, and <a class="el" href="../../d6/d6/kernel_2winable_8c-source.html#l00274">xxxWindowEvent()</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a12" doxytag="kernel/winable.c::_SetWinEventHook" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d8/d4/structtagEVENTHOOK.html">PEVENTHOOK</a> _SetWinEventHook           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>eventMin</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>eventMax</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>HMODULE&nbsp;</td>
          <td class="mdname" nowrap> <em>hmodWinEventProc</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>pstrLib</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>WINEVENTPROC&nbsp;</td>
          <td class="mdname" nowrap> <em>pfnWinEventProc</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>hEventProcess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>idEventThread</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>dwFlags</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d6/kernel_2winable_8c-source.html#l00674">674</a> of file <a class="el" href="../../d6/d6/kernel_2winable_8c-source.html">kernel/winable.c</a>.
<p>
References <a class="el" href="../../d3/d3/libmgmt_8c-source.html#l00136">AddHmodDependency()</a>, <a class="el" href="../../d4/d7/propapi_8h-source.html#l00043">dwFlags</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l06433">tagEVENTHOOK::eventMax</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l06432">tagEVENTHOOK::eventMin</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l06434">tagEVENTHOOK::fDestroyed</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l06438">tagEVENTHOOK::fIgnoreOwnProcess</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l06437">tagEVENTHOOK::fIgnoreOwnThread</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l06439">tagEVENTHOOK::fSync</a>, <a class="el" href="../../d3/d3/libmgmt_8c-source.html#l00053">GetHmodTableIndex()</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00690">gpWinEventHooks</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l06441">tagEVENTHOOK::hEventProcess</a>, <a class="el" href="../../d5/d7/handtabl_8c-source.html#l00828">HMAllocObject()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l06442">tagEVENTHOOK::idEventThread</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l06446">tagEVENTHOOK::ihmod</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l06445">tagEVENTHOOK::offPfn</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l06431">tagEVENTHOOK::pehNext</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l00058">PtiCurrent</a>, <a class="el" href="../../d7/d2/queue_8c-source.html#l04737">PtiFromThreadId()</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01152">SET_SRVIF</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01145">SRVIF_WINEVENTHOOKS</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03331">tagTHREADINFO::TIF_flags</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02850">TIF_GUITHREADINITIALIZED</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02826">TIF_INCLEANUP</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l00920">TYPE_WINEVENTHOOK</a>, and <a class="el" href="../../d0/d5/ndismain_8h-source.html#l00026">UINT</a>.
<p>
Referenced by <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l03414">NtUserSetWinEventHook()</a>.
<p>
<pre class="fragment"><div>00683 {
00684     <a class="code" href="../../d8/d4/structtagEVENTHOOK.html">PEVENTHOOK</a> pEventNew;
00685     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent;
00686 
00687     <span class="keywordtype">int</span> ihmod;
00688 
00689     ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
00690 
00691     <span class="comment">//</span>
00692     <span class="comment">// If exiting, fail the call.</span>
00693     <span class="comment">//</span>
00694     <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a795">TIF_INCLEANUP</a>) {
00695         RIPMSG1(RIP_ERROR, <span class="stringliteral">"SetWinEventHook: Fail call - thread %#p in cleanup"</span>, ptiCurrent);
00696         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00697     }
00698 
00699     <span class="comment">/*</span>
00700 <span class="comment">     * Check to see if filter proc is valid.</span>
00701 <span class="comment">     */</span>
00702     <span class="keywordflow">if</span> (pfnWinEventProc == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00703         RIPERR0(ERROR_INVALID_FILTER_PROC, RIP_VERBOSE, <span class="stringliteral">"pfnWinEventProc == NULL"</span>);
00704         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00705     }
00706 
00707     <span class="keywordflow">if</span> (eventMin &gt; eventMax) {
00708         RIPERR0(ERROR_INVALID_HOOK_FILTER, RIP_VERBOSE, <span class="stringliteral">"eventMin &gt; eventMax"</span>);
00709         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00710     }
00711 
00712     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; WINEVENT_INCONTEXT) {
00713         <span class="comment">/*</span>
00714 <span class="comment">         * WinEventProc to be called in context of hooked thread, so needs a DLL</span>
00715 <span class="comment">         */</span>
00716         <span class="keywordflow">if</span> (hmodWinEventProc == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00717             RIPERR0(ERROR_HOOK_NEEDS_HMOD, RIP_VERBOSE, <span class="stringliteral">""</span>);
00718             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00719         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pstrLib == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00720             <span class="comment">/*</span>
00721 <span class="comment">             * If we got an hmod, we should get a DLL name too!</span>
00722 <span class="comment">             */</span>
00723             RIPERR1(ERROR_DLL_NOT_FOUND, RIP_ERROR,
00724                     <span class="stringliteral">"hmod %#p, but no lib name"</span>, hmodWinEventProc);
00725             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00726         }
00727         ihmod = <a class="code" href="../../d4/d1/userk_8h.html#a1541">GetHmodTableIndex</a>(pstrLib);
00728         <span class="keywordflow">if</span> (ihmod == -1) {
00729             RIPERR0(ERROR_MOD_NOT_FOUND, RIP_VERBOSE, <span class="stringliteral">""</span>);
00730             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00731         }
00732     } <span class="keywordflow">else</span> {
00733         ihmod = -1;            <span class="comment">// means no DLL is required</span>
00734         hmodWinEventProc = 0;
00735     }
00736 
00737     <span class="comment">/*</span>
00738 <span class="comment">     * Check the thread id, check it is a GUI thread.</span>
00739 <span class="comment">     */</span>
00740     <span class="keywordflow">if</span> (idEventThread != 0) {
00741         <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiT;
00742 
00743         ptiT = <a class="code" href="../../d4/d1/userk_8h.html#a1201">PtiFromThreadId</a>(idEventThread);
00744         <span class="keywordflow">if</span> ((ptiT == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
00745                 !(ptiT-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a816">TIF_GUITHREADINITIALIZED</a>)) {
00746             RIPERR1(ERROR_INVALID_THREAD_ID, RIP_VERBOSE, <span class="stringliteral">"pti %#p"</span>, ptiT);
00747             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00748         }
00749     }
00750 
00751     <span class="comment">//</span>
00752     <span class="comment">// Create the window for async events first.  Creating it might yield,</span>
00753     <span class="comment">// so we want to do this before we've touched our event array.</span>
00754     <span class="comment">//</span>
00755     <span class="comment">// NOTE that USER itself will not pass on window creation/destruction</span>
00756     <span class="comment">// notifications for</span>
00757     <span class="comment">//      * IME windows</span>
00758     <span class="comment">//      * OLE windows</span>
00759     <span class="comment">//      * RPC windows</span>
00760     <span class="comment">//      * Event windows</span>
00761     <span class="comment">//</span>
00762 
00763     <span class="comment">//</span>
00764     <span class="comment">// Get a new event.</span>
00765     <span class="comment">//</span>
00766     pEventNew = (<a class="code" href="../../d8/d4/structtagEVENTHOOK.html">PEVENTHOOK</a>)<a class="code" href="../../d4/d1/userk_8h.html#a969">HMAllocObject</a>(ptiCurrent, NULL,
00767             TYPE_WINEVENTHOOK, <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d4/structtagEVENTHOOK.html">EVENTHOOK</a>));
00768     <span class="keywordflow">if</span> (!pEventNew)
00769         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00770 
00771     <span class="comment">//</span>
00772     <span class="comment">// Fill in the new event.</span>
00773     <span class="comment">//</span>
00774     pEventNew-&gt;<a class="code" href="../../d8/d4/structtagEVENTHOOK.html#o2">eventMin</a> = (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)eventMin;
00775     pEventNew-&gt;<a class="code" href="../../d8/d4/structtagEVENTHOOK.html#o3">eventMax</a> = (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)eventMax;
00776 
00777     <span class="comment">// pEventNew-&gt;f32Bit = ((dwFlags &amp; WINEVENT_32BITCALLER) != 0);</span>
00778     pEventNew-&gt;<a class="code" href="../../d8/d4/structtagEVENTHOOK.html#o5">fIgnoreOwnThread</a> = ((<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; WINEVENT_SKIPOWNTHREAD) != 0);
00779     pEventNew-&gt;<a class="code" href="../../d8/d4/structtagEVENTHOOK.html#o6">fIgnoreOwnProcess</a> = ((<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; WINEVENT_SKIPOWNPROCESS) != 0);
00780     pEventNew-&gt;<a class="code" href="../../d8/d4/structtagEVENTHOOK.html#o4">fDestroyed</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00781     pEventNew-&gt;<a class="code" href="../../d8/d4/structtagEVENTHOOK.html#o7">fSync</a> = ((<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; WINEVENT_INCONTEXT) != 0);
00782 
00783     pEventNew-&gt;<a class="code" href="../../d8/d4/structtagEVENTHOOK.html#o9">hEventProcess</a> = hEventProcess;
00784     pEventNew-&gt;<a class="code" href="../../d8/d4/structtagEVENTHOOK.html#o10">idEventThread</a> = idEventThread;
00785     <span class="comment">// pEventNew-&gt;cInUse = 0;</span>
00786 
00787     pEventNew-&gt;<a class="code" href="../../d8/d4/structtagEVENTHOOK.html#o12">ihmod</a> = ihmod;
00788 
00789     <span class="comment">/*</span>
00790 <span class="comment">     * Add a dependency on this module - meaning, increment a count</span>
00791 <span class="comment">     * that simply counts the number of hooks set into this module.</span>
00792 <span class="comment">     */</span>
00793     <span class="keywordflow">if</span> (pEventNew-&gt;<a class="code" href="../../d8/d4/structtagEVENTHOOK.html#o12">ihmod</a> &gt;= 0) {
00794         <a class="code" href="../../d4/d1/userk_8h.html#a1542">AddHmodDependency</a>(pEventNew-&gt;<a class="code" href="../../d8/d4/structtagEVENTHOOK.html#o12">ihmod</a>);
00795     }
00796 
00797     <span class="comment">/*</span>
00798 <span class="comment">     * If pfnWinEventProc is in caller's process and no DLL is involved,</span>
00799 <span class="comment">     * then pEventNew-&gt;offPfn is the actual address.</span>
00800 <span class="comment">     */</span>
00801     pEventNew-&gt;<a class="code" href="../../d8/d4/structtagEVENTHOOK.html#o11">offPfn</a> = ((ULONG_PTR)pfnWinEventProc) - ((ULONG_PTR)hmodWinEventProc);
00802 
00803     <span class="comment">//</span>
00804     <span class="comment">//</span>
00805     <span class="comment">// Link our event into the master list.</span>
00806     <span class="comment">//</span>
00807     <span class="comment">// Note that we count on USER to not generate any events when installing</span>
00808     <span class="comment">// our hook.  The caller can't handle it yet since he hasn't got back</span>
00809     <span class="comment">// his event handle from this call.</span>
00810     <span class="comment">//</span>
00811     pEventNew-&gt;<a class="code" href="../../d8/d4/structtagEVENTHOOK.html#o1">pehNext</a> = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a255">gpWinEventHooks</a>;
00812     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a255">gpWinEventHooks</a> = pEventNew;
00813     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a381">SET_SRVIF</a>(SRVIF_WINEVENTHOOKS);
00814 
00815     <span class="keywordflow">return</span> pEventNew;
00816 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a13" doxytag="kernel/winable.c::_UnhookWinEvent" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOL _UnhookWinEvent           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d8/d4/structtagEVENTHOOK.html">PEVENTHOOK</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>pEventUnhook</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d6/kernel_2winable_8c-source.html#l00827">827</a> of file <a class="el" href="../../d6/d6/kernel_2winable_8c-source.html">kernel/winable.c</a>.
<p>
References <a class="el" href="../../d6/d6/kernel_2winable_8c-source.html#l00033">DBGVERIFYEVENTHOOK</a>, <a class="el" href="../../d6/d6/kernel_2winable_8c-source.html#l00879">DestroyEventHook()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01547">GETPTI</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01477">HMIsMarkDestroy</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l00058">PtiCurrent</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l03446">NtUserUnhookWinEvent()</a>.
<p>
<pre class="fragment"><div>00828 {
00829     <a class="code" href="../../d5/d7/kernel_2winable_8c.html#a0">DBGVERIFYEVENTHOOK</a>(pEventUnhook);
00830 
00831     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a438">HMIsMarkDestroy</a>(pEventUnhook) || (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pEventUnhook) != <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>())) {
00832         <span class="comment">//</span>
00833         <span class="comment">// We do this to avoid someone calling UnhookWinEvent() the first</span>
00834         <span class="comment">// time, then somehow getting control again and calling it a second</span>
00835         <span class="comment">// time before we've managed to free up the event since someone was</span>
00836         <span class="comment">// in the middle of using it at the first UWE call.</span>
00837         <span class="comment">//</span>
00838 
00839         RIPERR0(ERROR_INVALID_HANDLE, RIP_WARNING, <span class="stringliteral">"_UnhookWinEvent: Invalid event hook"</span>);
00840         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00841     }
00842 
00843     <span class="comment">//</span>
00844     <span class="comment">// Purge this baby if all notifications are done.</span>
00845     <span class="comment">//      * if there are SYNC ones pending, the caller will clean this up</span>
00846     <span class="comment">//          upon the return from calling the event</span>
00847     <span class="comment">//      * if there are ASYNC ones pending, the receiver will not call</span>
00848     <span class="comment">//          the event and clean it up when he gets it.</span>
00849     <span class="comment">//</span>
00850 
00851     <span class="comment">//</span>
00852     <span class="comment">// NOTE that DestroyEventHook() does not yield!</span>
00853     <span class="comment">//</span>
00854     <a class="code" href="../../d5/d7/kernel_2winable_8c.html#a14">DestroyEventHook</a>(pEventUnhook);
00855 
00856     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00857 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="kernel/winable.c::CreateNotify" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d9/d2/structtagNOTIFY.html">PNOTIFY</a> CreateNotify           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d8/d4/structtagEVENTHOOK.html">PEVENTHOOK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>peh</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>event</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d6/d9/structtagWND.html">PWND</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pwnd</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>LONG&nbsp;</td>
          <td class="mdname" nowrap> <em>idObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>LONG&nbsp;</td>
          <td class="mdname" nowrap> <em>idChild</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ptiEvent</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>dwTime</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d6/kernel_2winable_8c-source.html#l00425">425</a> of file <a class="el" href="../../d6/d6/kernel_2winable_8c-source.html">kernel/winable.c</a>.
<p>
References <a class="el" href="../../d5/d0/userk_8h-source.html#l06458">tagNOTIFY::dwEventTime</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l06459">tagNOTIFY::dwWEFlags</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l06453">tagNOTIFY::event</a>, <a class="el" href="../../d6/d6/kernel_2winable_8c-source.html#l00042">fNotifyCacheInUse</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l06439">tagEVENTHOOK::fSync</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00692">gpLastPendingNotify</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00691">gpPendingNotifies</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01514">HW</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l06454">tagNOTIFY::hwnd</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l06456">tagNOTIFY::idChild</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l06455">tagNOTIFY::idObject</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l06457">tagNOTIFY::idSenderThread</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00367">Lock</a>, <a class="el" href="../../d6/d6/kernel_2winable_8c-source.html#l00041">notifyCache</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l06451">tagNOTIFY::pNotifyNext</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l06460">tagNOTIFY::ptiReceiver</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l06452">tagNOTIFY::spEventHook</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l01175">TIDq</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d0/userk_8h-source.html#l06466">WEF_ASYNC</a>.
<p>
Referenced by <a class="el" href="../../d6/d6/kernel_2winable_8c-source.html#l00274">xxxWindowEvent()</a>.
<p>
<pre class="fragment"><div>00427 {
00428     <a class="code" href="../../d9/d2/structtagNOTIFY.html">PNOTIFY</a> pNotify;
00429     UserAssert(pEvent != NULL);
00430 
00431     <span class="comment">//</span>
00432     <span class="comment">// Get a pointer.  From cache if available.</span>
00433     <span class="comment">// IanJa - change this to allocate from zone a la AllocQEntry??</span>
00434     <span class="comment">//</span>
00435     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d7/kernel_2winable_8c.html#a3">fNotifyCacheInUse</a>) {
00436         <a class="code" href="../../d5/d7/kernel_2winable_8c.html#a3">fNotifyCacheInUse</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00437         pNotify = &amp;<a class="code" href="../../d5/d7/kernel_2winable_8c.html#a2">notifyCache</a>;
00438 <span class="preprocessor">#if DBG</span>
00439 <span class="preprocessor"></span>        <span class="comment">//</span>
00440         <span class="comment">// Make sure we aren't forgetting to set any fields.</span>
00441         <span class="comment">//</span>
00442         <span class="comment">// DebugFillBuffer(pNotify, sizeof(NOTIFY));</span>
00443 <span class="preprocessor">#endif</span>
00444 <span class="preprocessor"></span>    } <span class="keywordflow">else</span> {
00445         pNotify = (<a class="code" href="../../d9/d2/structtagNOTIFY.html">PNOTIFY</a>)UserAllocPool(<span class="keyword">sizeof</span>(<a class="code" href="../../d9/d2/structtagNOTIFY.html">NOTIFY</a>), TAG_NOTIFY);
00446         <span class="keywordflow">if</span> (!pNotify)
00447             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00448     }
00449 
00450 
00451     <span class="comment">/*</span>
00452 <span class="comment">     * Fill in the notify block.</span>
00453 <span class="comment">     */</span>
00454     pNotify-&gt;<a class="code" href="../../d9/d2/structtagNOTIFY.html#o1">spEventHook</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00455     <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;pNotify-&gt;<a class="code" href="../../d9/d2/structtagNOTIFY.html#o1">spEventHook</a>, pEvent);
00456     pNotify-&gt;<a class="code" href="../../d9/d2/structtagNOTIFY.html#o3">hwnd</a> = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(pwnd);
00457     pNotify-&gt;<a class="code" href="../../d9/d2/structtagNOTIFY.html#o2">event</a> = event;
00458     pNotify-&gt;<a class="code" href="../../d9/d2/structtagNOTIFY.html#o4">idObject</a> = idObject;
00459     pNotify-&gt;<a class="code" href="../../d9/d2/structtagNOTIFY.html#o5">idChild</a> = idChild;
00460     pNotify-&gt;<a class="code" href="../../d9/d2/structtagNOTIFY.html#o6">idSenderThread</a> = <a class="code" href="../../d4/d1/userk_8h.html#a107">TIDq</a>(ptiSender);
00461     UserAssert(pNotify-&gt;<a class="code" href="../../d9/d2/structtagNOTIFY.html#o6">idSenderThread</a> != 0);
00462     pNotify-&gt;<a class="code" href="../../d9/d2/structtagNOTIFY.html#o7">dwEventTime</a> = dwTime;
00463     pNotify-&gt;<a class="code" href="../../d9/d2/structtagNOTIFY.html#o8">dwWEFlags</a> = pEvent-&gt;<a class="code" href="../../d8/d4/structtagEVENTHOOK.html#o7">fSync</a> ? 0 : <a class="code" href="../../d4/d1/userk_8h.html#a612">WEF_ASYNC</a>;
00464     pNotify-&gt;<a class="code" href="../../d9/d2/structtagNOTIFY.html#o0">pNotifyNext</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00465     pNotify-&gt;<a class="code" href="../../d9/d2/structtagNOTIFY.html#o9">ptiReceiver</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00466 <span class="preprocessor">#if DBG</span>
00467 <span class="preprocessor"></span>    gnNotifies++;
00468 <span class="preprocessor">#endif</span>
00469 <span class="preprocessor"></span>
00470     <span class="comment">/*</span>
00471 <span class="comment">     * The order of non-deferred notifications doesn't matter; they are here</span>
00472 <span class="comment">     * simply for cleanup/in-use tracking. However, deferred notifications must</span>
00473 <span class="comment">     * be ordered with most recent at the end, so just order them all that way.</span>
00474 <span class="comment">     */</span>
00475     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a256">gpPendingNotifies</a>) {
00476         UserAssert(gpLastPendingNotify);
00477         UserAssert(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a257">gpLastPendingNotify</a>-&gt;<a class="code" href="../../d9/d2/structtagNOTIFY.html#o0">pNotifyNext</a> == NULL);
00478         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a257">gpLastPendingNotify</a>-&gt;<a class="code" href="../../d9/d2/structtagNOTIFY.html#o0">pNotifyNext</a> = pNotify;
00479     } <span class="keywordflow">else</span> {
00480         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a256">gpPendingNotifies</a> = pNotify;
00481     }
00482     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a257">gpLastPendingNotify</a> = pNotify;
00483 
00484     <span class="keywordflow">return</span> pNotify;
00485 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a14" doxytag="kernel/winable.c::DestroyEventHook" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID DestroyEventHook           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d8/d4/structtagEVENTHOOK.html">PEVENTHOOK</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>pEventDestroy</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d6/kernel_2winable_8c-source.html#l00879">879</a> of file <a class="el" href="../../d6/d6/kernel_2winable_8c-source.html">kernel/winable.c</a>.
<p>
References <a class="el" href="../../d6/d6/kernel_2winable_8c-source.html#l00033">DBGVERIFYEVENTHOOK</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l06434">tagEVENTHOOK::fDestroyed</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00690">gpWinEventHooks</a>, <a class="el" href="../../d5/d7/handtabl_8c-source.html#l01069">HMFreeObject()</a>, <a class="el" href="../../d5/d7/handtabl_8c-source.html#l01237">HMMarkObjectDestroy()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l06446">tagEVENTHOOK::ihmod</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l06431">tagEVENTHOOK::pehNext</a>, <a class="el" href="../../d3/d3/libmgmt_8c-source.html#l00158">RemoveHmodDependency()</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01154">SET_OR_CLEAR_SRVIF</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01145">SRVIF_WINEVENTHOOKS</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d6/d6/kernel_2winable_8c-source.html#l00827">_UnhookWinEvent()</a>, and <a class="el" href="../../d6/d6/kernel_2winable_8c-source.html#l00615">FreeThreadsWinEvents()</a>.
<p>
<pre class="fragment"><div>00880 {
00881     <a class="code" href="../../d8/d4/structtagEVENTHOOK.html">PEVENTHOOK</a> *ppEvent;
00882     <a class="code" href="../../d8/d4/structtagEVENTHOOK.html">PEVENTHOOK</a> pEventT;
00883 
00884     <a class="code" href="../../d5/d7/kernel_2winable_8c.html#a0">DBGVERIFYEVENTHOOK</a>(pEventDestroy);
00885     UserAssert(gpWinEventHooks);
00886 
00887     <span class="comment">/*</span>
00888 <span class="comment">     * Mark this event as destroyed, but don't remove it from the event list</span>
00889 <span class="comment">     * until its lock count goes to 0 - we may be traversing the list</span>
00890 <span class="comment">     * within xxxWindowEvent, so we mustn't break the link to the next hook.</span>
00891 <span class="comment">     */</span>
00892     pEventDestroy-&gt;<a class="code" href="../../d8/d4/structtagEVENTHOOK.html#o4">fDestroyed</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00893 
00894     <span class="comment">/*</span>
00895 <span class="comment">     * If the object is locked, mark it for destroy but don't free it yet.</span>
00896 <span class="comment">     */</span>
00897     <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a971">HMMarkObjectDestroy</a>(pEventDestroy))
00898         <span class="keywordflow">return</span>;
00899 
00900     <span class="comment">/*</span>
00901 <span class="comment">     * Remove this from our event list.</span>
00902 <span class="comment">     */</span>
00903     <span class="keywordflow">for</span> (ppEvent = &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a255">gpWinEventHooks</a>; pEventT = *ppEvent; ppEvent = &amp;pEventT-&gt;<a class="code" href="../../d8/d4/structtagEVENTHOOK.html#o1">pehNext</a>) {
00904         <span class="keywordflow">if</span> (pEventT == pEventDestroy) {
00905             *ppEvent = pEventDestroy-&gt;<a class="code" href="../../d8/d4/structtagEVENTHOOK.html#o1">pehNext</a>;
00906             <span class="keywordflow">break</span>;
00907         }
00908     }
00909     UserAssert(pEventT);
00910     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a383">SET_OR_CLEAR_SRVIF</a>(SRVIF_WINEVENTHOOKS, gpWinEventHooks);
00911 
00912     <span class="comment">/*</span>
00913 <span class="comment">     * Make sure each hooked thread will unload the hook proc DLL</span>
00914 <span class="comment">     */</span>
00915     <span class="keywordflow">if</span> (pEventDestroy-&gt;<a class="code" href="../../d8/d4/structtagEVENTHOOK.html#o12">ihmod</a> &gt;= 0) {
00916         <a class="code" href="../../d4/d1/userk_8h.html#a1543">RemoveHmodDependency</a>(pEventDestroy-&gt;<a class="code" href="../../d8/d4/structtagEVENTHOOK.html#o12">ihmod</a>);
00917     }
00918 
00919     <span class="comment">/*</span>
00920 <span class="comment">     * Free this pointer.</span>
00921 <span class="comment">     */</span>
00922     <a class="code" href="../../d4/d1/userk_8h.html#a970">HMFreeObject</a>(pEventDestroy);
00923 
00924     <span class="keywordflow">return</span>;
00925 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="kernel/winable.c::DestroyNotify" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID DestroyNotify           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d9/d2/structtagNOTIFY.html">PNOTIFY</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>pNotifyDestroy</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d6/kernel_2winable_8c-source.html#l00566">566</a> of file <a class="el" href="../../d6/d6/kernel_2winable_8c-source.html">kernel/winable.c</a>.
<p>
References <a class="el" href="../../d6/d6/kernel_2winable_8c-source.html#l00034">DBGVERIFYNOTIFY</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00691">gpPendingNotifies</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l06451">tagNOTIFY::pNotifyNext</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l00058">PtiCurrent</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l06460">tagNOTIFY::ptiReceiver</a>, and <a class="el" href="../../d6/d6/kernel_2winable_8c-source.html#l00495">RemoveNotify()</a>.
<p>
Referenced by <a class="el" href="../../d7/d2/queue_8c-source.html#l03068">CleanEventMessage()</a>, <a class="el" href="../../d6/d6/kernel_2winable_8c-source.html#l00615">FreeThreadsWinEvents()</a>, and <a class="el" href="../../d6/d6/kernel_2winable_8c-source.html#l00068">xxxProcessNotifyWinEvent()</a>.
<p>
<pre class="fragment"><div>00567 {
00568     <a class="code" href="../../d9/d2/structtagNOTIFY.html">PNOTIFY</a>  *ppNotify;
00569     <a class="code" href="../../d9/d2/structtagNOTIFY.html">PNOTIFY</a>  pNotifyT;
00570 
00571     <a class="code" href="../../d5/d7/kernel_2winable_8c.html#a1">DBGVERIFYNOTIFY</a>(pNotifyDestroy);
00572 
00573     <span class="comment">/*</span>
00574 <span class="comment">     * Either this notify isn't currently in the process of calling back</span>
00575 <span class="comment">     * (which means ptiReceiver is NULL) or the thread destroying it</span>
00576 <span class="comment">     * must be the one that was calling back (which means this thread</span>
00577 <span class="comment">     * was destroyed during the callback and is cleaning up).</span>
00578 <span class="comment">     */</span>
00579     UserAssert((pNotifyDestroy-&gt;<a class="code" href="../../d9/d2/structtagNOTIFY.html#o9">ptiReceiver</a> == NULL) ||
00580             (pNotifyDestroy-&gt;<a class="code" href="../../d9/d2/structtagNOTIFY.html#o9">ptiReceiver</a> == <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>()));
00581 
00582     ppNotify = &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a256">gpPendingNotifies</a>;
00583     <span class="keywordflow">while</span> (pNotifyT = *ppNotify) {
00584         <span class="keywordflow">if</span> (pNotifyT == pNotifyDestroy) {
00585             <a class="code" href="../../d5/d7/kernel_2winable_8c.html#a9">RemoveNotify</a>(ppNotify);
00586             <span class="keywordflow">return</span>;
00587         } <span class="keywordflow">else</span> {
00588             ppNotify = &amp;pNotifyT-&gt;<a class="code" href="../../d9/d2/structtagNOTIFY.html#o0">pNotifyNext</a>;
00589         }
00590     }
00591     RIPMSG1(RIP_ERROR, <span class="stringliteral">"DestroyNotify %#p - not found"</span>, pNotifyDestroy);
00592 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="kernel/winable.c::FreeThreadsWinEvents" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID FreeThreadsWinEvents           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>pti</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d6/kernel_2winable_8c-source.html#l00615">615</a> of file <a class="el" href="../../d6/d6/kernel_2winable_8c-source.html">kernel/winable.c</a>.
<p>
References <a class="el" href="../../d6/d6/kernel_2winable_8c-source.html#l00879">DestroyEventHook()</a>, <a class="el" href="../../d6/d6/kernel_2winable_8c-source.html#l00566">DestroyNotify()</a>, <a class="el" href="../../d1/d4/perfuser_8c-source.html#l00052">DWORD</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l06459">tagNOTIFY::dwWEFlags</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01547">GETPTI</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00691">gpPendingNotifies</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00690">gpWinEventHooks</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l06457">tagNOTIFY::idSenderThread</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l06431">tagEVENTHOOK::pehNext</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l06451">tagNOTIFY::pNotifyNext</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l06460">tagNOTIFY::ptiReceiver</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l06466">WEF_ASYNC</a>, and <a class="el" href="../../d5/d0/userk_8h-source.html#l06467">WEF_POSTED</a>.
<p>
Referenced by <a class="el" href="../../d7/d2/queue_8c-source.html#l02552">xxxDestroyThreadInfo()</a>.
<p>
<pre class="fragment"><div>00616 {
00617     <a class="code" href="../../d8/d4/structtagEVENTHOOK.html">PEVENTHOOK</a> peh, pehNext;
00618     <a class="code" href="../../d9/d2/structtagNOTIFY.html">PNOTIFY</a> pn, pnNext;
00619     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> idCurrentThread = W32GetCurrentTID();
00620 
00621     <span class="comment">/*</span>
00622 <span class="comment">     * Loop through all the notifications</span>
00623 <span class="comment">     */</span>
00624     <span class="keywordflow">for</span> (pn = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a256">gpPendingNotifies</a>; pn; pn = pnNext) {
00625         pnNext = pn-&gt;<a class="code" href="../../d9/d2/structtagNOTIFY.html#o0">pNotifyNext</a>;
00626 
00627         <span class="comment">/*</span>
00628 <span class="comment">         * Only destroy sync notifications that belong to this thread</span>
00629 <span class="comment">         * and are not currently calling back i.e. ptiReceiver must be NULL.</span>
00630 <span class="comment">         * Otherwise, when we come back from the callback in</span>
00631 <span class="comment">         * xxxProcessNotifyWinEvent we will operate on a freed notify.</span>
00632 <span class="comment">         * Also destroy the notification if the receiver is going away</span>
00633 <span class="comment">         * or else it gets leaked as long as the sender is alive.</span>
00634 <span class="comment">         */</span>
00635         <span class="keywordflow">if</span> ((pn-&gt;<a class="code" href="../../d9/d2/structtagNOTIFY.html#o6">idSenderThread</a> == idCurrentThread &amp;&amp;
00636                 pn-&gt;<a class="code" href="../../d9/d2/structtagNOTIFY.html#o9">ptiReceiver</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) || (pn-&gt;<a class="code" href="../../d9/d2/structtagNOTIFY.html#o9">ptiReceiver</a> == pti)) {
00637             <span class="keywordflow">if</span> ((pn-&gt;<a class="code" href="../../d9/d2/structtagNOTIFY.html#o8">dwWEFlags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a612">WEF_ASYNC</a>) == 0) {
00638                 UserAssert((pn-&gt;<a class="code" href="../../d9/d2/structtagNOTIFY.html#o8">dwWEFlags</a> &amp; WEF_POSTED) == 0);
00639                 <a class="code" href="../../d5/d7/kernel_2winable_8c.html#a10">DestroyNotify</a>(pn);
00640             }
00641         }
00642     }
00643 
00644     peh = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a255">gpWinEventHooks</a>;
00645     <span class="keywordflow">while</span> (peh) {
00646         pehNext = peh-&gt;<a class="code" href="../../d8/d4/structtagEVENTHOOK.html#o1">pehNext</a>;
00647         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(peh) == pti) {
00648             <a class="code" href="../../d5/d7/kernel_2winable_8c.html#a14">DestroyEventHook</a>(peh);
00649         }
00650         peh = pehNext;
00651     }
00652     <span class="comment">// Async notification not yet processed may still be posted in a queue,</span>
00653     <span class="comment">// pending being read and processed (gnNotifies &gt; 0), although the</span>
00654     <span class="comment">// originating hook has now been unhooked (maybe gpWinEventHooks == NULL)</span>
00655     <span class="comment">// so the following assert is no good:</span>
00656     <span class="comment">// UserAssert(gpWinEventHooks || (!gpWinEventHooks &amp;&amp; !gnNotifies));</span>
00657 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="kernel/winable.c::RemoveNotify" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID RemoveNotify           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d9/d2/structtagNOTIFY.html">PNOTIFY</a> *&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>ppNotify</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d6/kernel_2winable_8c-source.html#l00495">495</a> of file <a class="el" href="../../d6/d6/kernel_2winable_8c-source.html">kernel/winable.c</a>.
<p>
References <a class="el" href="../../d6/d6/kernel_2winable_8c-source.html#l00033">DBGVERIFYEVENTHOOK</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l06459">tagNOTIFY::dwWEFlags</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d6/kernel_2winable_8c-source.html#l00042">fNotifyCacheInUse</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00692">gpLastPendingNotify</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00691">gpPendingNotifies</a>, <a class="el" href="../../d6/d6/kernel_2winable_8c-source.html#l00041">notifyCache</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l06451">tagNOTIFY::pNotifyNext</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l06452">tagNOTIFY::spEventHook</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00368">Unlock</a>, and <a class="el" href="../../d5/d0/userk_8h-source.html#l06465">WEF_DEFERNOTIFY</a>.
<p>
Referenced by <a class="el" href="../../d6/d6/kernel_2winable_8c-source.html#l00566">DestroyNotify()</a>.
<p>
<pre class="fragment"><div>00496 {
00497     <a class="code" href="../../d9/d2/structtagNOTIFY.html">PNOTIFY</a> pNotifyRemove;
00498 
00499     pNotifyRemove = *ppNotify;
00500 
00501     <span class="comment">/*</span>
00502 <span class="comment">     * First, get it out of the pending list.</span>
00503 <span class="comment">     */</span>
00504     *ppNotify = pNotifyRemove-&gt;<a class="code" href="../../d9/d2/structtagNOTIFY.html#o0">pNotifyNext</a>;
00505 
00506 <span class="preprocessor">#if DBG</span>
00507 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (pNotifyRemove-&gt;<a class="code" href="../../d9/d2/structtagNOTIFY.html#o8">dwWEFlags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a611">WEF_DEFERNOTIFY</a>) {
00508         UserAssert(gnDeferredWinEvents &gt; 0);
00509         gnDeferredWinEvents--;
00510     }
00511 <span class="preprocessor">#endif</span>
00512 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (*ppNotify == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00513         <span class="comment">/*</span>
00514 <span class="comment">         * Removing last notify, so fix up gpLastPendingNotify:</span>
00515 <span class="comment">         * If list now empty, there is no last item.</span>
00516 <span class="comment">         */</span>
00517         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a256">gpPendingNotifies</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00518             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a257">gpLastPendingNotify</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00519         } <span class="keywordflow">else</span> {
00520             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a257">gpLastPendingNotify</a> = CONTAINING_RECORD(ppNotify, <a class="code" href="../../d9/d2/structtagNOTIFY.html">NOTIFY</a>, pNotifyNext);
00521         }
00522     }
00523     UserAssert((gpPendingNotifies == 0) || (gpPendingNotifies &gt; (<a class="code" href="../../d9/d2/structtagNOTIFY.html">PNOTIFY</a>)100));
00524 
00525     <a class="code" href="../../d5/d7/kernel_2winable_8c.html#a0">DBGVERIFYEVENTHOOK</a>(pNotifyRemove-&gt;<a class="code" href="../../d9/d2/structtagNOTIFY.html#o1">spEventHook</a>);
00526 
00527     <span class="comment">/*</span>
00528 <span class="comment">     * This may cause the win event hook to be freed.</span>
00529 <span class="comment">     */</span>
00530     <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(&amp;pNotifyRemove-&gt;<a class="code" href="../../d9/d2/structtagNOTIFY.html#o1">spEventHook</a>);
00531 
00532     <span class="comment">//</span>
00533     <span class="comment">// Now free it.  Either put it back in the cache if it is the cache,</span>
00534     <span class="comment">// or really free it otherwise.</span>
00535     <span class="comment">//</span>
00536     <span class="keywordflow">if</span> (pNotifyRemove == &amp;<a class="code" href="../../d5/d7/kernel_2winable_8c.html#a2">notifyCache</a>) {
00537         UserAssert(fNotifyCacheInUse);
00538         <a class="code" href="../../d5/d7/kernel_2winable_8c.html#a3">fNotifyCacheInUse</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00539     } <span class="keywordflow">else</span> {
00540         UserFreePool(pNotifyRemove);
00541     }
00542 <span class="preprocessor">#if DBG</span>
00543 <span class="preprocessor"></span>    UserAssert(gnNotifies &gt; 0);
00544     gnNotifies--;
00545 <span class="preprocessor">#endif</span>
00546 <span class="preprocessor"></span>}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="kernel/winable.c::xxxFlushDeferredWindowEvents" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID xxxFlushDeferredWindowEvents           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d6/kernel_2winable_8c-source.html#l00217">217</a> of file <a class="el" href="../../d6/d6/kernel_2winable_8c-source.html">kernel/winable.c</a>.
<p>
References <a class="el" href="../../d1/d4/perfuser_8c-source.html#l00052">DWORD</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l06459">tagNOTIFY::dwWEFlags</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00691">gpPendingNotifies</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l06457">tagNOTIFY::idSenderThread</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l06472">IsWinEventNotifyDeferredOK</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l06451">tagNOTIFY::pNotifyNext</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l06466">WEF_ASYNC</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l06465">WEF_DEFERNOTIFY</a>, and <a class="el" href="../../d6/d6/kernel_2winable_8c-source.html#l00068">xxxProcessNotifyWinEvent()</a>.
<p>
Referenced by <a class="el" href="../../d6/d6/kernel_2winable_8c-source.html#l00274">xxxWindowEvent()</a>.
<p>
<pre class="fragment"><div>00218 {
00219     <a class="code" href="../../d9/d2/structtagNOTIFY.html">PNOTIFY</a> pNotify;
00220     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> idCurrentThread = W32GetCurrentTID();
00221 
00222     <span class="keywordflow">if</span> (idCurrentThread == 0) {
00223         RIPMSG0(RIP_ERROR, <span class="stringliteral">"processing deferred notifications before we have a pti!"</span>);
00224         <span class="comment">// return;</span>
00225     }
00226 
00227     UserAssert(<a class="code" href="../../d4/d1/userk_8h.html#a616">IsWinEventNotifyDeferredOK</a>());
00228 
00229     pNotify = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a256">gpPendingNotifies</a>;
00230     <span class="keywordflow">while</span> (pNotify) {
00231         <span class="keywordflow">if</span> (((pNotify-&gt;<a class="code" href="../../d9/d2/structtagNOTIFY.html#o8">dwWEFlags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a611">WEF_DEFERNOTIFY</a>) == 0) ||
00232                 (pNotify-&gt;<a class="code" href="../../d9/d2/structtagNOTIFY.html#o6">idSenderThread</a> != idCurrentThread)) {
00233             <span class="comment">// UserAssert(pNotify-&gt;idSenderThread == idCurrentThread); // just testing!</span>
00234             pNotify = pNotify-&gt;<a class="code" href="../../d9/d2/structtagNOTIFY.html#o0">pNotifyNext</a>;
00235         } <span class="keywordflow">else</span> {
00236             <span class="comment">/*</span>
00237 <span class="comment">             * Clear WEF_DEFERNOTIFY so that if we recurse in the callback</span>
00238 <span class="comment">             * we won't try to send this notification again.</span>
00239 <span class="comment">             */</span>
00240             pNotify-&gt;<a class="code" href="../../d9/d2/structtagNOTIFY.html#o8">dwWEFlags</a> &amp;= ~<a class="code" href="../../d4/d1/userk_8h.html#a611">WEF_DEFERNOTIFY</a>;
00241 <span class="preprocessor">#if DBG</span>
00242 <span class="preprocessor"></span>            gnDeferredWinEvents--;
00243 <span class="preprocessor">#endif</span>
00244 <span class="preprocessor"></span>            <span class="comment">/*</span>
00245 <span class="comment">             * We shouldn't have deferred ASYNC notifications: we should have</span>
00246 <span class="comment">             * posted them immediately.</span>
00247 <span class="comment">             */</span>
00248             UserAssert((pNotify-&gt;<a class="code" href="../../d9/d2/structtagNOTIFY.html#o8">dwWEFlags</a> &amp; WEF_ASYNC) == 0);
00249             <a class="code" href="../../d5/d7/kernel_2winable_8c.html#a6">xxxProcessNotifyWinEvent</a>(pNotify);
00250             <span class="comment">/*</span>
00251 <span class="comment">             * Start again at the head of the list, in case it munged during</span>
00252 <span class="comment">             * the callback.</span>
00253 <span class="comment">             */</span>
00254             pNotify = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a256">gpPendingNotifies</a>;
00255         }
00256     }
00257 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="kernel/winable.c::xxxGetEventProc" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> WINEVENTPROC xxxGetEventProc           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d8/d4/structtagEVENTHOOK.html">PEVENTHOOK</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>pEventOrg</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d6/kernel_2winable_8c-source.html#l00936">936</a> of file <a class="el" href="../../d6/d6/kernel_2winable_8c-source.html">kernel/winable.c</a>.
<p>
References <a class="el" href="../../d7/d9/usercli_8h-source.html#l00361">CheckLock</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l06439">tagEVENTHOOK::fSync</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01477">HMIsMarkDestroy</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l06446">tagEVENTHOOK::ihmod</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l06445">tagEVENTHOOK::offPfn</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03670">PFNHOOK</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l00058">PtiCurrent</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03665">TESTHMODLOADED</a>, and <a class="el" href="../../d3/d3/libmgmt_8c-source.html#l00192">xxxLoadHmodIndex()</a>.
<p>
Referenced by <a class="el" href="../../d6/d6/kernel_2winable_8c-source.html#l00068">xxxProcessNotifyWinEvent()</a>.
<p>
<pre class="fragment"><div>00936                                       {
00937     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent;
00938 
00939     UserAssert(pEventOrg);
00940     UserAssert(pEventOrg-&gt;<a class="code" href="../../d8/d4/structtagEVENTHOOK.html#o7">fSync</a>);
00941     UserAssert(pEventOrg-&gt;<a class="code" href="../../d8/d4/structtagEVENTHOOK.html#o12">ihmod</a> &gt;= 0);
00942     UserAssert(pEventOrg-&gt;<a class="code" href="../../d8/d4/structtagEVENTHOOK.html#o11">offPfn</a> != 0);
00943 
00944     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pEventOrg);
00945 
00946     <span class="comment">/*</span>
00947 <span class="comment">     * Make sure the hook is still around before we</span>
00948 <span class="comment">     * try and call it.</span>
00949 <span class="comment">     */</span>
00950     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a438">HMIsMarkDestroy</a>(pEventOrg)) {
00951         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00952     }
00953 
00954     ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
00955 
00956     <span class="comment">/*</span>
00957 <span class="comment">     * Make sure the DLL for this hook, if any, has been loaded</span>
00958 <span class="comment">     * for the current process.</span>
00959 <span class="comment">     */</span>
00960     <span class="keywordflow">if</span> ((pEventOrg-&gt;<a class="code" href="../../d8/d4/structtagEVENTHOOK.html#o12">ihmod</a> != -1) &amp;&amp;
00961             (<a class="code" href="../../d4/d1/userk_8h.html#a420">TESTHMODLOADED</a>(ptiCurrent, pEventOrg-&gt;<a class="code" href="../../d8/d4/structtagEVENTHOOK.html#o12">ihmod</a>) == 0)) {
00962 
00963         <span class="comment">/*</span>
00964 <span class="comment">         * Try loading the library, since it isn't loaded in this processes</span>
00965 <span class="comment">         * context.  The hook is alrerady locked, so it won't go away while</span>
00966 <span class="comment">         * we're loading this library.</span>
00967 <span class="comment">         */</span>
00968         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1544">xxxLoadHmodIndex</a>(pEventOrg-&gt;<a class="code" href="../../d8/d4/structtagEVENTHOOK.html#o12">ihmod</a>, FALSE) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00969             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00970         }
00971     }
00972 
00973     <span class="comment">/*</span>
00974 <span class="comment">     * While we're still inside the critical section make sure the</span>
00975 <span class="comment">     * hook hasn't been 'freed'.  If so just return NULL.</span>
00976 <span class="comment">     * IanJa - since WinEvent has already been called, you might think that we</span>
00977 <span class="comment">     * should pass the event on, but the hooker may not be expecting this after</span>
00978 <span class="comment">     * having cancelled the hook!  In any case, seems we may have two ways</span>
00979 <span class="comment">     * of detecting that this hook has been removed:</span>
00980 <span class="comment">     */</span>
00981 
00982     <span class="comment">/*</span>
00983 <span class="comment">     * Make sure the hook is still around before we</span>
00984 <span class="comment">     * try and call it.</span>
00985 <span class="comment">     */</span>
00986     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a438">HMIsMarkDestroy</a>(pEventOrg)) {
00987         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00988     }
00989 
00990     <span class="keywordflow">return</span> (WINEVENTPROC)<a class="code" href="../../d4/d1/userk_8h.html#a423">PFNHOOK</a>(pEventOrg);
00991 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="kernel/winable.c::xxxProcessNotifyWinEvent" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d8/d4/structtagEVENTHOOK.html">PEVENTHOOK</a> xxxProcessNotifyWinEvent           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d9/d2/structtagNOTIFY.html">PNOTIFY</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>pNotify</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d6/kernel_2winable_8c-source.html#l00068">68</a> of file <a class="el" href="../../d6/d6/kernel_2winable_8c-source.html">kernel/winable.c</a>.
<p>
References <a class="el" href="../../d5/d0/userk_8h-source.html#l01838">BEGINATOMICCHECK</a>, <a class="el" href="../../d6/d6/kernel_2winable_8c-source.html#l00033">DBGVERIFYEVENTHOOK</a>, <a class="el" href="../../d6/d6/kernel_2winable_8c-source.html#l00034">DBGVERIFYNOTIFY</a>, <a class="el" href="../../d6/d6/kernel_2winable_8c-source.html#l00566">DestroyNotify()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l06459">tagNOTIFY::dwWEFlags</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l01842">ENDATOMICCHECK</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l06434">tagEVENTHOOK::fDestroyed</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l06439">tagEVENTHOOK::fSync</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01547">GETPTI</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00455">gptiRit</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l06430">tagEVENTHOOK::head</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l06446">tagEVENTHOOK::ihmod</a>, <a class="el" href="../../d7/d8/restrfil_8c-source.html#l00223">IsRestricted()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03504">tagPROCESSINFO::luidSession</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l06445">tagEVENTHOOK::offPfn</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l06431">tagEVENTHOOK::pehNext</a>, <a class="el" href="../../d6/d2/ntuser_2kernel_2input_8c-source.html#l02068">PostEventMessage()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03319">tagTHREADINFO::ppi</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l00058">PtiCurrent</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l06460">tagNOTIFY::ptiReceiver</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03001">QEVENT_NOTIFYWINEVENT</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l01824">RtlEqualLuid()</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l06452">tagNOTIFY::spEventHook</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00363">ThreadLockAlways</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00366">ThreadUnlock</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02849">TIF_ALLOWOTHERACCOUNTHOOK</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02829">TIF_CSRSSTHREAD</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03331">tagTHREADINFO::TIF_flags</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02826">TIF_INCLEANUP</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02828">TIF_SYSTEMTHREAD</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l03006">TIF_WOW64</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l06466">WEF_ASYNC</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l06465">WEF_DEFERNOTIFY</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l06467">WEF_POSTED</a>, <a class="el" href="../../d4/d1/userk_8h.html#a1950">xxxClientCallWinEventProc()</a>, and <a class="el" href="../../d6/d6/kernel_2winable_8c-source.html#l00936">xxxGetEventProc()</a>.
<p>
Referenced by <a class="el" href="../../d6/d6/kernel_2winable_8c-source.html#l00217">xxxFlushDeferredWindowEvents()</a>, <a class="el" href="../../d7/d2/queue_8c-source.html#l03772">xxxProcessEventMessage()</a>, and <a class="el" href="../../d6/d6/kernel_2winable_8c-source.html#l00274">xxxWindowEvent()</a>.
<p>
<pre class="fragment"><div>00069 {
00070     WINEVENTPROC   pfn;
00071     <a class="code" href="../../d8/d4/structtagEVENTHOOK.html">PEVENTHOOK</a>     pEventHook;
00072     <a class="code" href="../../d5/d1/struct__TL.html">TL</a>             tlpEventHook;
00073     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a>    ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
00074 
00075     pEventHook = pNotify-&gt;<a class="code" href="../../d9/d2/structtagNOTIFY.html#o1">spEventHook</a>;
00076     <a class="code" href="../../d5/d7/kernel_2winable_8c.html#a0">DBGVERIFYEVENTHOOK</a>(pEventHook);
00077     UserAssert(pEventHook-&gt;<a class="code" href="../../d8/d4/structtagEVENTHOOK.html#o0">head</a>.cLockObj);
00078 
00079     <span class="keywordflow">if</span> (((pNotify-&gt;<a class="code" href="../../d9/d2/structtagNOTIFY.html#o8">dwWEFlags</a> &amp; (<a class="code" href="../../d4/d1/userk_8h.html#a612">WEF_ASYNC</a> | <a class="code" href="../../d4/d1/userk_8h.html#a613">WEF_POSTED</a>)) == <a class="code" href="../../d4/d1/userk_8h.html#a612">WEF_ASYNC</a>)
00080         ||
00081         (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a797">TIF_SYSTEMTHREAD</a> | <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a798">TIF_CSRSSTHREAD</a> | <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a795">TIF_INCLEANUP</a>))
00082 
00083         ||
00084         (!<a class="code" href="../../d8/d6/sertl_8c.html#a50">RtlEqualLuid</a>(&amp;<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pEventHook)-&gt;ppi-&gt;luidSession, &amp;ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>-&gt;<a class="code" href="../../d7/d3/structtagPROCESSINFO.html#o27">luidSession</a>) &amp;&amp;
00085          !(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a815">TIF_ALLOWOTHERACCOUNTHOOK</a>))
00086 
00087         ||
00088         (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pEventHook)-&gt;ppi != ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a> &amp;&amp;
00089          <a class="code" href="../../d6/d9/restrfil_8c.html#a29">IsRestricted</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pEventHook)-&gt;pEThread))
00090 
00091 <span class="preprocessor">#if defined(_WIN64)</span>
00092 <span class="preprocessor"></span>        ||
00093         ((<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pEventHook)-&gt;TIF_flags &amp; <a class="code" href="../../d1/d0/inc_2user_8h.html#a796">TIF_WOW64</a>) != (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d1/d0/inc_2user_8h.html#a796">TIF_WOW64</a>))
00094 <span class="preprocessor">#endif</span>
00095 <span class="preprocessor"></span>        ) {
00096         <span class="comment">/*</span>
00097 <span class="comment">         * POST</span>
00098 <span class="comment">         *</span>
00099 <span class="comment">         * WinEvent Hook set without WINEVENT_INCONTEXT flag are posted;</span>
00100 <span class="comment">         * Events from system threads are posted because there is no user-mode</span>
00101 <span class="comment">         *    part to callback to;</span>
00102 <span class="comment">         * Console is not permitted to load DLLs, so we must post back to the</span>
00103 <span class="comment">         *    hooking application;</span>
00104 <span class="comment">         * DLLs can not be loaded cross bit type(32bit to 64bit) on 64bit NT</span>
00105 <span class="comment">         *    so we must post(It may be usefull to let the app be aware and</span>
00106 <span class="comment">         *    even supply both a 32bit and a 64bit DLL that are aware of each other);</span>
00107 <span class="comment">         * Threads in cleanup can't get called back, so turn their</span>
00108 <span class="comment">         *    notifications into async ones. (Better late than never).</span>
00109 <span class="comment">         *</span>
00110 <span class="comment">         * If forcing these events ASYNC is unacceptable, we might consider</span>
00111 <span class="comment">         * doing system/console SYNC events like low-level hooks (sync with</span>
00112 <span class="comment">         * timeout: but may have to post it if the timeout expires) - IanJa</span>
00113 <span class="comment">         */</span>
00114         <a class="code" href="../../d7/d4/structtagQ.html">PQ</a>  pqReceiver = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pEventHook)-&gt;pq;
00115         <a class="code" href="../../d8/d4/structtagEVENTHOOK.html">PEVENTHOOK</a> pEventHookNext = pEventHook-&gt;<a class="code" href="../../d8/d4/structtagEVENTHOOK.html#o1">pehNext</a>;
00116 
00117         <a class="code" href="../../d4/d1/userk_8h.html#a159">BEGINATOMICCHECK</a>();
00118 
00119         <a class="code" href="../../d5/d7/kernel_2winable_8c.html#a1">DBGVERIFYNOTIFY</a>(pNotify);
00120         pNotify-&gt;<a class="code" href="../../d9/d2/structtagNOTIFY.html#o8">dwWEFlags</a> |= <a class="code" href="../../d4/d1/userk_8h.html#a613">WEF_POSTED</a> | <a class="code" href="../../d4/d1/userk_8h.html#a612">WEF_ASYNC</a>;
00121         <span class="keywordflow">if</span> (!pqReceiver || (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pEventHook) == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a175">gptiRit</a>) ||
00122                 pEventHook-&gt;<a class="code" href="../../d8/d4/structtagEVENTHOOK.html#o4">fDestroyed</a> ||
00123                 !<a class="code" href="../../d4/d1/userk_8h.html#a1217">PostEventMessage</a>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pEventHook), pqReceiver,
00124                                   QEVENT_NOTIFYWINEVENT,
00125                                   NULL, 0, 0, (LPARAM)pNotify)) {
00126             <span class="comment">/*</span>
00127 <span class="comment">             * If the receiver doesn't have a queue or the</span>
00128 <span class="comment">             * post failed (low memory), cleanup what we just</span>
00129 <span class="comment">             * created.</span>
00130 <span class="comment">             * Note: destroying the notification may destroy pEventHook too.</span>
00131 <span class="comment">             */</span>
00132             RIPMSG2(RIP_WARNING, <span class="stringliteral">"failed to post NOTIFY at %#p, time %lx\n"</span>,
00133                       pNotify, pNotify-&gt;<a class="code" href="../../d9/d2/structtagNOTIFY.html#o7">dwEventTime</a>);
00134             <a class="code" href="../../d5/d7/kernel_2winable_8c.html#a10">DestroyNotify</a>(pNotify);
00135         }
00136 
00137         <a class="code" href="../../d4/d1/userk_8h.html#a163">ENDATOMICCHECK</a>();
00138 
00139         <span class="keywordflow">if</span> (pEventHookNext) {
00140             <a class="code" href="../../d5/d7/kernel_2winable_8c.html#a0">DBGVERIFYEVENTHOOK</a>(pEventHookNext);
00141         }
00142         <span class="keywordflow">return</span> pEventHookNext;
00143     }
00144 
00145     <span class="comment">/*</span>
00146 <span class="comment">     * Don't call back if the hook has been destroyed (unhooked).</span>
00147 <span class="comment">     */</span>
00148     <span class="keywordflow">if</span> (pEventHook-&gt;<a class="code" href="../../d8/d4/structtagEVENTHOOK.html#o4">fDestroyed</a>) {
00149         <span class="comment">/*</span>
00150 <span class="comment">         * Save the next hook since DestroyNotify may cause pEventHook to</span>
00151 <span class="comment">         * be freed by unlocking it.</span>
00152 <span class="comment">         */</span>
00153         pEventHook = pEventHook-&gt;<a class="code" href="../../d8/d4/structtagEVENTHOOK.html#o1">pehNext</a>;
00154         <a class="code" href="../../d5/d7/kernel_2winable_8c.html#a10">DestroyNotify</a>(pNotify);
00155         <span class="keywordflow">return</span> pEventHook;
00156     }
00157 
00158     <span class="comment">/*</span>
00159 <span class="comment">     * CALLBACK</span>
00160 <span class="comment">     *</span>
00161 <span class="comment">     * This leaves the critical section.</span>
00162 <span class="comment">     * We return the next Event Hook in the list so that the caller doesn't</span>
00163 <span class="comment">     * have to lock pEventHook.</span>
00164 <span class="comment">     */</span>
00165     UserAssert((pNotify-&gt;<a class="code" href="../../d9/d2/structtagNOTIFY.html#o8">dwWEFlags</a> &amp; WEF_DEFERNOTIFY) == 0);
00166 
00167     <a class="code" href="../../d6/d0/usercli_8h.html#a37">ThreadLockAlways</a>(pEventHook, &amp;tlpEventHook);
00168 
00169     UserAssertMsg1(pNotify-&gt;<a class="code" href="../../d9/d2/structtagNOTIFY.html#o9">ptiReceiver</a> == NULL,
00170          <span class="stringliteral">"pNotify %#p is already in callback!  Reentrant?"</span>, pNotify);
00171     pNotify-&gt;<a class="code" href="../../d9/d2/structtagNOTIFY.html#o9">ptiReceiver</a> = ptiCurrent;
00172 
00173     <span class="keywordflow">if</span> (!pEventHook-&gt;<a class="code" href="../../d8/d4/structtagEVENTHOOK.html#o7">fSync</a>) {
00174         UserAssert(pEventHook-&gt;<a class="code" href="../../d8/d4/structtagEVENTHOOK.html#o12">ihmod</a> == -1);
00175         pfn = (WINEVENTPROC)pEventHook-&gt;<a class="code" href="../../d8/d4/structtagEVENTHOOK.html#o11">offPfn</a>;
00176     } <span class="keywordflow">else</span> {
00177         pfn = <a class="code" href="../../d5/d7/kernel_2winable_8c.html#a4">xxxGetEventProc</a>(pEventHook);
00178     }
00179     <span class="keywordflow">if</span> (pfn) {
00180         <a class="code" href="../../d4/d1/userk_8h.html#a1950">xxxClientCallWinEventProc</a>(pfn, pEventHook, pNotify);
00181         <a class="code" href="../../d5/d7/kernel_2winable_8c.html#a1">DBGVERIFYNOTIFY</a>(pNotify);
00182         <a class="code" href="../../d5/d7/kernel_2winable_8c.html#a0">DBGVERIFYEVENTHOOK</a>(pEventHook);
00183         UserAssert(pEventHook-&gt;<a class="code" href="../../d8/d4/structtagEVENTHOOK.html#o0">head</a>.cLockObj);
00184     }
00185 
00186     pNotify-&gt;<a class="code" href="../../d9/d2/structtagNOTIFY.html#o9">ptiReceiver</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00187 
00188     <span class="comment">/*</span>
00189 <span class="comment">     * Save the next item in the list, ThreadUnlock() may destroy pEventHook.</span>
00190 <span class="comment">     * DestroyNotify() may also kill the event if it is a zombie (destroyed</span>
00191 <span class="comment">     * but being used, waiting for use count to go to 0 before being freed).</span>
00192 <span class="comment">     */</span>
00193     pEventHook = pEventHook-&gt;<a class="code" href="../../d8/d4/structtagEVENTHOOK.html#o1">pehNext</a>;
00194     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpEventHook);
00195 
00196     <span class="comment">/*</span>
00197 <span class="comment">     * We are done with the notification.  Kill it.</span>
00198 <span class="comment">     *</span>
00199 <span class="comment">     * NOTE that DestroyNotify does not yield, which is why we can hang on</span>
00200 <span class="comment">     * to the pehNext field above around this call.</span>
00201 <span class="comment">     *</span>
00202 <span class="comment">     * NOTE ALSO that DestroyNotify will kill the event it references if the</span>
00203 <span class="comment">     * ref count goes down to zero and it was zombied earlier.</span>
00204 <span class="comment">     */</span>
00205     <a class="code" href="../../d5/d7/kernel_2winable_8c.html#a10">DestroyNotify</a>(pNotify);
00206 
00207     <span class="keywordflow">return</span> pEventHook;
00208 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="kernel/winable.c::xxxWindowEvent" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID xxxWindowEvent           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>event</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d6/d9/structtagWND.html">PWND</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>pwnd</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>LONG&nbsp;</td>
          <td class="mdname" nowrap> <em>idObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>LONG&nbsp;</td>
          <td class="mdname" nowrap> <em>idChild</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>dwFlags</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d6/kernel_2winable_8c-source.html#l00274">274</a> of file <a class="el" href="../../d6/d6/kernel_2winable_8c-source.html">kernel/winable.c</a>.
<p>
References <a class="el" href="../../d6/d6/kernel_2winable_8c-source.html#l00425">CreateNotify()</a>, <a class="el" href="../../d6/d6/kernel_2winable_8c-source.html#l00033">DBGVERIFYEVENTHOOK</a>, <a class="el" href="../../d6/d6/kernel_2winable_8c-source.html#l00034">DBGVERIFYNOTIFY</a>, <a class="el" href="../../d4/d7/propapi_8h-source.html#l00043">dwFlags</a>, <a class="el" href="../../d1/d4/perfuser_8c-source.html#l00052">DWORD</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l06459">tagNOTIFY::dwWEFlags</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l06433">tagEVENTHOOK::eventMax</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l06432">tagEVENTHOOK::eventMin</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l06434">tagEVENTHOOK::fDestroyed</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l06438">tagEVENTHOOK::fIgnoreOwnProcess</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l06437">tagEVENTHOOK::fIgnoreOwnThread</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01265">FWINABLE</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01547">GETPTI</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00665">gptiCurrent</a>, <a class="el" href="../../d4/d5/ntuser_2kernel_2globals_8c-source.html#l00690">gpWinEventHooks</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l06430">tagEVENTHOOK::head</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l06441">tagEVENTHOOK::hEventProcess</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l01477">HMIsMarkDestroy</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l06442">tagEVENTHOOK::idEventThread</a>, <a class="el" href="../../d0/d5/gettickc_8c-source.html#l00026">NtGetTickCount()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l06431">tagEVENTHOOK::pehNext</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03319">tagTHREADINFO::ppi</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l01457">_THROBJHEAD::pti</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l00058">PtiCurrent</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03327">tagTHREADINFO::rpdesk</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02555">TestWF</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l01692">ThreadLockPti</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00364">ThreadLockWithPti</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00366">ThreadUnlock</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l01699">ThreadUnlockPti</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l01175">TIDq</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02855">TIF_DISABLEHOOKS</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l03331">tagTHREADINFO::TIF_flags</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02826">TIF_INCLEANUP</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l06466">WEF_ASYNC</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l06465">WEF_DEFERNOTIFY</a>, <a class="el" href="../../d5/d0/userk_8h-source.html#l06464">WEF_USEPWNDTHREAD</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l02304">WFDESTROYED</a>, <a class="el" href="../../d6/d6/kernel_2winable_8c-source.html#l00217">xxxFlushDeferredWindowEvents()</a>, and <a class="el" href="../../d6/d6/kernel_2winable_8c-source.html#l00068">xxxProcessNotifyWinEvent()</a>.
<p>
Referenced by <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l03461">NtUserNotifyWinEvent()</a>, <a class="el" href="../../d9/d3/sprite_8c-source.html#l00141">UpdateLayeredSprite()</a>, <a class="el" href="../../d4/d5/focusact_8c-source.html#l00472">xxxActivateThisWindow()</a>, <a class="el" href="../../d0/d2/calcclrc_8c-source.html#l00021">xxxCalcClientRect()</a>, <a class="el" href="../../d2/d2/tmswitch_8c-source.html#l01635">xxxCancelCoolSwitch()</a>, <a class="el" href="../../d5/d4/caret_8c-source.html#l00254">xxxCreateCaret()</a>, <a class="el" href="../../d5/d7/createw_8c-source.html#l00033">xxxCreateWindowEx()</a>, <a class="el" href="../../d9/d2/dwp_8c-source.html#l01264">xxxDefWindowProc()</a>, <a class="el" href="../../d7/d2/queue_8c-source.html#l02552">xxxDestroyThreadInfo()</a>, <a class="el" href="../../d5/d7/createw_8c-source.html#l01591">xxxDestroyWindow()</a>, <a class="el" href="../../d7/d0/dragdrop_8c-source.html#l00026">xxxDragObject()</a>, <a class="el" href="../../d9/d3/sbctl_8c-source.html#l00211">xxxEnableSBCtlArrows()</a>, <a class="el" href="../../d0/d7/kernel_2winmgr_8c-source.html#l00184">xxxEnableWindow()</a>, <a class="el" href="../../d9/d3/sbctl_8c-source.html#l00271">xxxEnableWndSBArrows()</a>, <a class="el" href="../../d9/d3/sbctl_8c-source.html#l01782">xxxEndScroll()</a>, <a class="el" href="../../d3/d9/kernel_2help_8c-source.html#l00073">xxxHelpLoop()</a>, <a class="el" href="../../d5/d8/minmax_8c-source.html#l01329">xxxMinMaximize()</a>, <a class="el" href="../../d3/d6/ntuser_2kernel_2menu_8c-source.html#l03395">xxxMNCancel()</a>, <a class="el" href="../../d3/d6/ntuser_2kernel_2menu_8c-source.html#l02517">xxxMNCloseHierarchy()</a>, <a class="el" href="../../d3/d6/ntuser_2kernel_2menu_8c-source.html#l01934">xxxMNOpenHierarchy()</a>, <a class="el" href="../../d3/d6/ntuser_2kernel_2menu_8c-source.html#l02818">xxxMNSelectItem()</a>, <a class="el" href="../../d5/d2/mnstate_8c-source.html#l00677">xxxMNStartMenu()</a>, <a class="el" href="../../d3/d6/ntuser_2kernel_2menu_8c-source.html#l00795">xxxMNSwitchToAlternateMenu()</a>, <a class="el" href="../../d9/d2/movesize_8c-source.html#l01053">xxxMoveSize()</a>, <a class="el" href="../../d2/d2/tmswitch_8c-source.html#l01325">xxxMoveSwitchWndHilite()</a>, <a class="el" href="../../d9/d2/movesize_8c-source.html#l00437">xxxMS_TrackMove()</a>, <a class="el" href="../../d9/d3/sbctl_8c-source.html#l02123">xxxSBTrackLoop()</a>, <a class="el" href="../../d9/d3/sbctl_8c-source.html#l02582">xxxSBWndProc()</a>, <a class="el" href="../../d6/d2/ntuser_2kernel_2input_8c-source.html#l03305">xxxScanSysQueue()</a>, <a class="el" href="../../d3/d7/swp_8c-source.html#l01669">xxxSendChangedMsgs()</a>, <a class="el" href="../../d4/d5/focusact_8c-source.html#l00220">xxxSendFocusMessages()</a>, <a class="el" href="../../d4/d2/mnsel_8c-source.html#l00029">xxxSendMenuSelect()</a>, <a class="el" href="../../d7/d2/queue_8c-source.html#l06419">xxxSetConsoleCaretInfo()</a>, <a class="el" href="../../d0/d7/kernel_2winmgr_8c-source.html#l00311">xxxSetParent()</a>, <a class="el" href="../../d9/d3/sbctl_8c-source.html#l01316">xxxSetScrollBar()</a>, <a class="el" href="../../d2/d2/tmswitch_8c-source.html#l01476">xxxShowSwitchWindow()</a>, <a class="el" href="../../d2/d4/caption_8c-source.html#l00158">xxxTrackCaptionButton()</a>, and <a class="el" href="../../d3/d2/mnpopup_8c-source.html#l00052">xxxTrackPopupMenuEx()</a>.
<p>
<pre class="fragment"><div>00280 {
00281     <a class="code" href="../../d8/d4/structtagEVENTHOOK.html">PEVENTHOOK</a> peh;
00282     <a class="code" href="../../d8/d4/structtagEVENTHOOK.html">PEVENTHOOK</a> pehNext;
00283     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent, ptiEvent;
00284     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>   dwTime;
00285     <a class="code" href="../../d7/d3/structtagPROCESSINFO.html">PPROCESSINFO</a> ppiEvent;
00286     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> idEventThread;
00287     HANDLE hEventProcess;
00288     <a class="code" href="../../d9/d2/structtagNOTIFY.html">PNOTIFY</a> pNotify;
00289     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwnd;
00290     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpti;
00291 
00292     <span class="comment">/*</span>
00293 <span class="comment">     * Do not bother with CheckLock(pwnd) - we ThreadLock it below.</span>
00294 <span class="comment">     */</span>
00295     UserAssert(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a405">FWINABLE</a>());
00296 
00297     <span class="comment">/*</span>
00298 <span class="comment">     * This thread is in startup, and has not yet had it's pti set up</span>
00299 <span class="comment">     * This is pretty rare, but sometimes encountered in stress.</span>
00300 <span class="comment">     * Test gptiCurrent to avoid the UserAssert(gptiCurrent) in PtiCurrent()</span>
00301 <span class="comment">     */</span>
00302     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a246">gptiCurrent</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00303         RIPMSG3(RIP_WARNING, <span class="stringliteral">"Ignore WinEvent %lx %#p %lx... no PtiCurrent yet"</span>,
00304                 event, pwnd, idObject);
00305         <span class="keywordflow">return</span>;
00306     }
00307     ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
00308 
00309     <span class="comment">/*</span>
00310 <span class="comment">     * Don't bother with destroyed windows</span>
00311 <span class="comment">     */</span>
00312     <span class="keywordflow">if</span> (pwnd &amp;&amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, WFDESTROYED)) {
00313         RIPMSG3(RIP_WARNING,
00314                 <span class="stringliteral">"Ignore WinEvent %lx %#p %lx... pwnd already destroyed"</span>,
00315                 event, pwnd, idObject);
00316         <span class="keywordflow">return</span>;
00317     }
00318 
00319     <span class="comment">/*</span>
00320 <span class="comment">     * Under some special circumstances we have to defer</span>
00321 <span class="comment">     */</span>
00322     <span class="keywordflow">if</span> (ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a820">TIF_DISABLEHOOKS</a> | <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a795">TIF_INCLEANUP</a>)) {
00323         <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> |= <a class="code" href="../../d4/d1/userk_8h.html#a611">WEF_DEFERNOTIFY</a>;
00324     }
00325 
00326     <span class="comment">/*</span>
00327 <span class="comment">     * Determine process and thread issuing the event notification</span>
00328 <span class="comment">     */</span>
00329     <span class="keywordflow">if</span> ((<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a610">WEF_USEPWNDTHREAD</a>) &amp;&amp; pwnd) {
00330         ptiEvent = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd);
00331     } <span class="keywordflow">else</span> {
00332         ptiEvent = ptiCurrent;
00333     }
00334     idEventThread = <a class="code" href="../../d4/d1/userk_8h.html#a107">TIDq</a>(ptiEvent);
00335     ppiEvent = ptiEvent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o2">ppi</a>;
00336     hEventProcess = ptiEvent-&gt;pEThread-&gt;Cid.UniqueProcess;
00337 
00338     dwTime = <a class="code" href="../../d9/d5/gettickc_8c.html#a0">NtGetTickCount</a>();
00339 
00340     <a class="code" href="../../d6/d0/usercli_8h.html#a38">ThreadLockWithPti</a>(ptiCurrent, pwnd, &amp;tlpwnd);
00341     <a class="code" href="../../d4/d1/userk_8h.html#a134">ThreadLockPti</a>(ptiCurrent, ptiEvent, &amp;tlpti);
00342 
00343     <span class="comment">/*</span>
00344 <span class="comment">     * If we're not deferring the current notification process any pending</span>
00345 <span class="comment">     * deferred notifications before proceeding with the current notification</span>
00346 <span class="comment">     */</span>
00347     <span class="keywordflow">if</span> (!(<a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a611">WEF_DEFERNOTIFY</a>)) {
00348         <a class="code" href="../../d4/d1/userk_8h.html#a1949">xxxFlushDeferredWindowEvents</a>();
00349     }
00350 
00351     <span class="keywordflow">for</span> (peh = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a255">gpWinEventHooks</a>; peh; peh = pehNext) {
00352         <a class="code" href="../../d5/d7/kernel_2winable_8c.html#a0">DBGVERIFYEVENTHOOK</a>(peh);
00353         pehNext = peh-&gt;<a class="code" href="../../d8/d4/structtagEVENTHOOK.html#o1">pehNext</a>;
00354 
00355         <span class="comment">//</span>
00356         <span class="comment">// Is event in the right range?  And is it for this process/thread?</span>
00357         <span class="comment">// Note that we skip destroyed events.  They will be freed any</span>
00358         <span class="comment">// second now, it's just that yielding may have caused reentrancy.</span>
00359         <span class="comment">//</span>
00360         <span class="comment">// If the caller said to ignore events on his own thread, make sure</span>
00361         <span class="comment">// we skip them.</span>
00362         <span class="comment">//</span>
00363         <span class="keywordflow">if</span> (!peh-&gt;<a class="code" href="../../d8/d4/structtagEVENTHOOK.html#o4">fDestroyed</a>                &amp;&amp;
00364             (peh-&gt;<a class="code" href="../../d8/d4/structtagEVENTHOOK.html#o2">eventMin</a> &lt;= event)        &amp;&amp;
00365             (event &lt;= peh-&gt;<a class="code" href="../../d8/d4/structtagEVENTHOOK.html#o3">eventMax</a>)        &amp;&amp;
00366             (!peh-&gt;<a class="code" href="../../d8/d4/structtagEVENTHOOK.html#o9">hEventProcess</a> || (peh-&gt;<a class="code" href="../../d8/d4/structtagEVENTHOOK.html#o9">hEventProcess</a> == hEventProcess)) &amp;&amp;
00367             (!peh-&gt;<a class="code" href="../../d8/d4/structtagEVENTHOOK.html#o6">fIgnoreOwnProcess</a> || (ppiEvent != <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(peh)-&gt;ppi)) &amp;&amp;
00368             (!peh-&gt;<a class="code" href="../../d8/d4/structtagEVENTHOOK.html#o10">idEventThread</a> || (peh-&gt;<a class="code" href="../../d8/d4/structtagEVENTHOOK.html#o10">idEventThread</a> == idEventThread))  &amp;&amp;
00369             (!peh-&gt;<a class="code" href="../../d8/d4/structtagEVENTHOOK.html#o5">fIgnoreOwnThread</a> || (ptiEvent != <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(peh))) &amp;&amp;
00370             <span class="comment">// temp fix from SP3 - best to architect events on a per-desktop</span>
00371             <span class="comment">// basis, with a separate pWinEventHook list per desktop. (IanJa)</span>
00372             (peh-&gt;<a class="code" href="../../d8/d4/structtagEVENTHOOK.html#o0">head</a>.<a class="code" href="../../d1/d1/struct__THROBJHEAD.html#o1">pti</a>-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a> == ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>))
00373         {
00374             <span class="comment">/*</span>
00375 <span class="comment">             * Don't create new notifications for zombie event hooks.</span>
00376 <span class="comment">             * When an event is destroyed, it stays as a zombie until the in-use</span>
00377 <span class="comment">             * count goes to zero (all it's async and deferred notifies gone)</span>
00378 <span class="comment">             */</span>
00379             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a438">HMIsMarkDestroy</a>(peh)) {
00380                 <span class="keywordflow">break</span>;
00381             }
00382 
00383             UserAssert(peh-&gt;<a class="code" href="../../d8/d4/structtagEVENTHOOK.html#o4">fDestroyed</a> == 0);
00384 
00385             <span class="keywordflow">if</span> ((pNotify = <a class="code" href="../../d5/d7/kernel_2winable_8c.html#a5">CreateNotify</a>(peh, event, pwnd, idObject,
00386                     idChild, ptiEvent, dwTime)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00387                 <span class="keywordflow">break</span>;
00388             }
00389             pNotify-&gt;<a class="code" href="../../d9/d2/structtagNOTIFY.html#o8">dwWEFlags</a> |= <a class="code" href="../../d3/d8/propapi_8h.html#a34">dwFlags</a>;
00390 
00391             <span class="comment">/*</span>
00392 <span class="comment">             * If it's async, don't defer it: post it straight away.</span>
00393 <span class="comment">             */</span>
00394             <span class="keywordflow">if</span> (pNotify-&gt;<a class="code" href="../../d9/d2/structtagNOTIFY.html#o8">dwWEFlags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a612">WEF_ASYNC</a>) {
00395                 pNotify-&gt;<a class="code" href="../../d9/d2/structtagNOTIFY.html#o8">dwWEFlags</a> &amp;= ~<a class="code" href="../../d4/d1/userk_8h.html#a611">WEF_DEFERNOTIFY</a>;
00396             }
00397 
00398             <span class="keywordflow">if</span> (pNotify-&gt;<a class="code" href="../../d9/d2/structtagNOTIFY.html#o8">dwWEFlags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a611">WEF_DEFERNOTIFY</a>) {
00399 <span class="preprocessor">#if DBG</span>
00400 <span class="preprocessor"></span>                gnDeferredWinEvents++;
00401 <span class="preprocessor">#endif</span>
00402 <span class="preprocessor"></span>                <a class="code" href="../../d5/d7/kernel_2winable_8c.html#a1">DBGVERIFYNOTIFY</a>(pNotify);
00403             } <span class="keywordflow">else</span> {
00404                 pehNext = <a class="code" href="../../d5/d7/kernel_2winable_8c.html#a6">xxxProcessNotifyWinEvent</a>(pNotify);
00405             }
00406         }
00407     }
00408 
00409     <a class="code" href="../../d4/d1/userk_8h.html#a136">ThreadUnlockPti</a>(ptiCurrent, &amp;tlpti);
00410     <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwnd);
00411 }
</div></pre>    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a3" doxytag="kernel/winable.c::fNotifyCacheInUse" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOL <a class="el" href="../../d5/d7/kernel_2winable_8c.html#a3">fNotifyCacheInUse</a> = FALSE<code> [static]</code>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d6/kernel_2winable_8c-source.html#l00042">42</a> of file <a class="el" href="../../d6/d6/kernel_2winable_8c-source.html">kernel/winable.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d6/kernel_2winable_8c-source.html#l00425">CreateNotify()</a>, and <a class="el" href="../../d6/d6/kernel_2winable_8c-source.html#l00495">RemoveNotify()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="kernel/winable.c::notifyCache" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d9/d2/structtagNOTIFY.html">NOTIFY</a> <a class="el" href="../../d5/d7/kernel_2winable_8c.html#a2">notifyCache</a><code> [static]</code>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d6/kernel_2winable_8c-source.html#l00041">41</a> of file <a class="el" href="../../d6/d6/kernel_2winable_8c-source.html">kernel/winable.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d6/kernel_2winable_8c-source.html#l00425">CreateNotify()</a>, and <a class="el" href="../../d6/d6/kernel_2winable_8c-source.html#l00495">RemoveNotify()</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:46:09 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
