<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: dirsup.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>dirsup.c</h1><a href="../../d4/d8/dirsup_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1996  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    DirSup.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module implements the support for walking across on-disk directory</span>
00012 <span class="comment">    structures.</span>
00013 <span class="comment"></span>
00014 <span class="comment">Author:</span>
00015 <span class="comment"></span>
00016 <span class="comment">    Dan Lovinger    [DanLo]   11-Jun-1996</span>
00017 <span class="comment"></span>
00018 <span class="comment">Revision History:</span>
00019 <span class="comment"></span>
00020 <span class="comment">--*/</span>
00021 
00022 <span class="preprocessor">#include "UdfProcs.h"</span>
00023 
00024 <span class="comment">//</span>
00025 <span class="comment">//  The Bug check file id for this module</span>
00026 <span class="comment">//</span>
00027 
<a name="l00028"></a><a class="code" href="../../d4/d8/dirsup_8c.html#a0">00028</a> <span class="preprocessor">#define BugCheckFileId                   (UDFS_BUG_CHECK_DIRSUP)</span>
00029 <span class="preprocessor"></span>
00030 <span class="comment">//</span>
00031 <span class="comment">//  The local debug trace level</span>
00032 <span class="comment">//</span>
00033 
<a name="l00034"></a><a class="code" href="../../d4/d8/dirsup_8c.html#a1">00034</a> <span class="preprocessor">#define Dbg                              (UDFS_DEBUG_LEVEL_DIRSUP)</span>
00035 <span class="preprocessor"></span>
00036 <span class="comment">//</span>
00037 <span class="comment">//  Local support routines.</span>
00038 <span class="comment">//</span>
00039 
00040 BOOLEAN
00041 <a class="code" href="../../d4/d8/dirsup_8c.html#a2">UdfLookupDirEntryPostProcessing</a> (
00042     IN <a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext,
00043     IN <a class="code" href="../../d7/d9/struct__FCB.html">PFCB</a> Fcb,
00044     IN <a class="code" href="../../d5/d5/struct__DIR__ENUM__CONTEXT.html">PDIR_ENUM_CONTEXT</a> DirContext,
00045     IN BOOLEAN ReturnError
00046     );
00047 
00048 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00049 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, UdfCleanupDirContext)</span>
00050 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, UdfFindDirEntry)</span>
00051 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, UdfInitializeDirContext)</span>
00052 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, UdfLookupDirEntryPostProcessing)</span>
00053 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, UdfLookupInitialDirEntry)</span>
00054 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, UdfLookupNextDirEntry)</span>
00055 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, UdfUpdateDirNames)</span>
00056 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00057 <span class="preprocessor"></span>
00058 
00059 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00060"></a><a class="code" href="../../d3/d8/udfprocs_8h.html#a167">00060</a> <a class="code" href="../../d3/d8/udfprocs_8h.html#a167">UdfInitializeDirContext</a> (
00061     IN <a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext,
00062     IN <a class="code" href="../../d5/d5/struct__DIR__ENUM__CONTEXT.html">PDIR_ENUM_CONTEXT</a> DirContext
00063     )
00064 
00065 <span class="comment">/*++</span>
00066 <span class="comment"></span>
00067 <span class="comment">Routine Description:</span>
00068 <span class="comment"></span>
00069 <span class="comment">    This routine initializes a directory enumeartion context.</span>
00070 <span class="comment">    </span>
00071 <span class="comment">    Call this exactly once in the lifetime of a context.</span>
00072 <span class="comment"></span>
00073 <span class="comment">Arguments:</span>
00074 <span class="comment"></span>
00075 <span class="comment">    DirContext - a context to initialize</span>
00076 <span class="comment"></span>
00077 <span class="comment">Return Value:</span>
00078 <span class="comment"></span>
00079 <span class="comment">    None.</span>
00080 <span class="comment"></span>
00081 <span class="comment">--*/</span>
00082 
00083 {
00084     <span class="comment">//</span>
00085     <span class="comment">//  Check inputs.</span>
00086     <span class="comment">//</span>
00087 
00088     <a class="code" href="../../d1/d8/udfdata_8h.html#a28">ASSERT_IRP_CONTEXT</a>( IrpContext );
00089 
00090     <span class="comment">//</span>
00091     <span class="comment">//  Provide defaults for fields, nothing too special.</span>
00092     <span class="comment">//</span>
00093 
00094     RtlZeroMemory( DirContext, <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d5/struct__DIR__ENUM__CONTEXT.html">DIR_ENUM_CONTEXT</a>) );
00095 }
00096 
00097 
00098 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00099"></a><a class="code" href="../../d3/d8/udfprocs_8h.html#a168">00099</a> <a class="code" href="../../d3/d8/udfprocs_8h.html#a168">UdfCleanupDirContext</a> (
00100     IN <a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext,
00101     IN <a class="code" href="../../d5/d5/struct__DIR__ENUM__CONTEXT.html">PDIR_ENUM_CONTEXT</a> DirContext
00102     )
00103 
00104 <span class="comment">/*++</span>
00105 <span class="comment"></span>
00106 <span class="comment">Routine Description:</span>
00107 <span class="comment"></span>
00108 <span class="comment">    This routine cleans up a directory enumeration context for reuse.</span>
00109 <span class="comment"></span>
00110 <span class="comment">Arguments:</span>
00111 <span class="comment"></span>
00112 <span class="comment">    DirContext - a context to clean.</span>
00113 <span class="comment"></span>
00114 <span class="comment">Return Value:</span>
00115 <span class="comment"></span>
00116 <span class="comment">    None.</span>
00117 <span class="comment"></span>
00118 <span class="comment">--*/</span>
00119 
00120 {
00121     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00122 
00123     <span class="comment">//</span>
00124     <span class="comment">//  Check input.</span>
00125     <span class="comment">//</span>
00126 
00127     <a class="code" href="../../d1/d8/udfdata_8h.html#a28">ASSERT_IRP_CONTEXT</a>( IrpContext );
00128     
00129     <span class="comment">//</span>
00130     <span class="comment">//  Dump the allocation we store the triple of names in.</span>
00131     <span class="comment">//</span>
00132 
00133     <a class="code" href="../../d3/d8/udfprocs_8h.html#a124">UdfFreePool</a>( &amp;DirContext-&gt;NameBuffer );
00134 
00135     <span class="comment">//</span>
00136     <span class="comment">//  And the short name.</span>
00137     <span class="comment">//</span>
00138 
00139     <a class="code" href="../../d3/d8/udfprocs_8h.html#a124">UdfFreePool</a>( &amp;DirContext-&gt;ShortObjectName.Buffer );
00140 
00141     <span class="comment">//</span>
00142     <span class="comment">//  Unpin the view.</span>
00143     <span class="comment">//</span>
00144 
00145     <a class="code" href="../../d3/d8/udfprocs_8h.html#a69">UdfUnpinData</a>( IrpContext, &amp;DirContext-&gt;Bcb );
00146 
00147     <span class="comment">//</span>
00148     <span class="comment">//  Free a buffered Fid that may remain.</span>
00149     <span class="comment">//</span>
00150     
00151     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( DirContext-&gt;Flags, <a class="code" href="../../d6/d8/udfstruc_8h.html#a54">DIR_CONTEXT_FLAG_FID_BUFFERED</a> )) {
00152 
00153         <a class="code" href="../../d3/d8/udfprocs_8h.html#a124">UdfFreePool</a>( &amp;DirContext-&gt;Fid );
00154     }
00155     
00156     <span class="comment">//</span>
00157     <span class="comment">//  Zero everything else out.</span>
00158     <span class="comment">//</span>
00159 
00160     RtlZeroMemory( DirContext, <span class="keyword">sizeof</span>( <a class="code" href="../../d5/d5/struct__DIR__ENUM__CONTEXT.html">DIR_ENUM_CONTEXT</a> ) );
00161 }
00162 
00163 
00164 BOOLEAN
<a name="l00165"></a><a class="code" href="../../d3/d8/udfprocs_8h.html#a169">00165</a> <a class="code" href="../../d3/d8/udfprocs_8h.html#a169">UdfLookupInitialDirEntry</a> (
00166     IN <a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext,
00167     IN <a class="code" href="../../d7/d9/struct__FCB.html">PFCB</a> Fcb,
00168     IN <a class="code" href="../../d5/d5/struct__DIR__ENUM__CONTEXT.html">PDIR_ENUM_CONTEXT</a> DirContext,
00169     IN PLONGLONG InitialOffset OPTIONAL
00170     )
00171 
00172 <span class="comment">/*++</span>
00173 <span class="comment"></span>
00174 <span class="comment">Routine Description:</span>
00175 <span class="comment"></span>
00176 <span class="comment">    This routine begins the enumeration of a directory by setting the context</span>
00177 <span class="comment">    at the first avaliable directory entry.</span>
00178 <span class="comment"></span>
00179 <span class="comment">Arguments:</span>
00180 <span class="comment"></span>
00181 <span class="comment">    Fcb - the directory being enumerated.</span>
00182 <span class="comment">    </span>
00183 <span class="comment">    DirContext - a corresponding context for the enumeration.</span>
00184 <span class="comment">    </span>
00185 <span class="comment">    InitialOffset - an optional starting byte offset to base the enumeration.</span>
00186 <span class="comment"></span>
00187 <span class="comment">Return Value:</span>
00188 <span class="comment"></span>
00189 <span class="comment">    If InitialOffset is unspecified, TRUE will always be returned.  Failure will result</span>
00190 <span class="comment">    in a raised status indicating corruption.</span>
00191 <span class="comment">    </span>
00192 <span class="comment">    If InitialOffset is specified, TRUE will be returned if a valid entry is found at this</span>
00193 <span class="comment">    offset, FALSE otherwise.</span>
00194 <span class="comment"></span>
00195 <span class="comment">--*/</span>
00196 
00197 {
00198     BOOLEAN Result;
00199 
00200     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00201     
00202     <span class="comment">//</span>
00203     <span class="comment">//  Check inputs.</span>
00204     <span class="comment">//</span>
00205 
00206     <a class="code" href="../../d1/d8/udfdata_8h.html#a28">ASSERT_IRP_CONTEXT</a>( IrpContext );
00207     <a class="code" href="../../d1/d8/udfdata_8h.html#a18">ASSERT_FCB_INDEX</a>( Fcb );
00208     
00209     <span class="comment">//</span>
00210     <span class="comment">//  Create the internal stream if it isn't already in place.</span>
00211     <span class="comment">//</span>
00212 
00213     <span class="keywordflow">if</span> (Fcb-&gt;FileObject == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00214 
00215         <a class="code" href="../../d3/d8/udfprocs_8h.html#a154">UdfCreateInternalStream</a>( IrpContext, Fcb-&gt;Vcb, Fcb );
00216     }
00217 
00218     <span class="comment">//</span>
00219     <span class="comment">//  Reset the flags.</span>
00220     <span class="comment">//</span>
00221 
00222     DirContext-&gt;Flags = 0;
00223     
00224     <span class="keywordflow">if</span> (InitialOffset) {
00225 
00226         <span class="comment">//</span>
00227         <span class="comment">//  If we are beginning in the middle of the stream, adjust the sanity check flags.</span>
00228         <span class="comment">//</span>
00229         
00230         <span class="keywordflow">if</span> (*InitialOffset != 0) {
00231 
00232             DirContext-&gt;Flags = <a class="code" href="../../d6/d8/udfstruc_8h.html#a52">DIR_CONTEXT_FLAG_SEEN_NONCONSTANT</a> | <a class="code" href="../../d6/d8/udfstruc_8h.html#a53">DIR_CONTEXT_FLAG_SEEN_PARENT</a>;
00233         }
00234 
00235         <span class="comment">//</span>
00236         <span class="comment">//  Now set up the range we will map.  This is constrained by the size of a cache view.</span>
00237         <span class="comment">//</span>
00238         
00239         DirContext-&gt;BaseOffset.QuadPart = <a class="code" href="../../d3/d8/udfprocs_8h.html#a12">GenericTruncate</a>( *InitialOffset, <a class="code" href="../../d4/d2/cache_8h.html#a0">VACB_MAPPING_GRANULARITY</a> );
00240         DirContext-&gt;ViewOffset = (ULONG) <a class="code" href="../../d3/d8/udfprocs_8h.html#a14">GenericOffset</a>( *InitialOffset, <a class="code" href="../../d4/d2/cache_8h.html#a0">VACB_MAPPING_GRANULARITY</a> );
00241 
00242     } <span class="keywordflow">else</span> {
00243         
00244         <span class="comment">//</span>
00245         <span class="comment">//  Map at the beginning.</span>
00246         <span class="comment">//</span>
00247     
00248         DirContext-&gt;BaseOffset.QuadPart = 0;
00249         DirContext-&gt;ViewOffset = 0;
00250     }
00251 
00252     <span class="comment">//</span>
00253     <span class="comment">//  Contain the view length by the size of the stream and map.</span>
00254     <span class="comment">//</span>
00255 
00256     DirContext-&gt;ViewLength = <a class="code" href="../../d4/d2/cache_8h.html#a0">VACB_MAPPING_GRANULARITY</a>;
00257 
00258     <span class="keywordflow">if</span> (DirContext-&gt;BaseOffset.QuadPart + DirContext-&gt;ViewLength &gt; Fcb-&gt;FileSize.QuadPart) {
00259 
00260         DirContext-&gt;ViewLength = (ULONG) (Fcb-&gt;FileSize.QuadPart - DirContext-&gt;BaseOffset.QuadPart);
00261     }
00262     
00263     <a class="code" href="../../d3/d8/udfprocs_8h.html#a69">UdfUnpinData</a>( IrpContext, &amp;DirContext-&gt;Bcb );
00264     
00265     <a class="code" href="../../d4/d2/cache_8h.html#a88">CcMapData</a>( Fcb-&gt;FileObject,
00266                &amp;DirContext-&gt;BaseOffset,
00267                DirContext-&gt;ViewLength,
00268                <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00269                &amp;DirContext-&gt;Bcb,
00270                &amp;DirContext-&gt;View );
00271 
00272     DirContext-&gt;Fid = <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( DirContext-&gt;View, DirContext-&gt;ViewOffset, <a class="code" href="../../d1/d2/structNSR__FID.html">PNSR_FID</a> );
00273 
00274     <span class="comment">//</span>
00275     <span class="comment">//  The state of the context is now valid.  Tail off into our common post-processor</span>
00276     <span class="comment">//  to finish the work.</span>
00277     <span class="comment">//</span>
00278 
00279     <span class="keywordflow">return</span> <a class="code" href="../../d4/d8/dirsup_8c.html#a2">UdfLookupDirEntryPostProcessing</a>( IrpContext,
00280                                             Fcb,
00281                                             DirContext,
00282                                             (BOOLEAN) (InitialOffset != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>));
00283 }
00284 
00285 
00286 BOOLEAN
<a name="l00287"></a><a class="code" href="../../d3/d8/udfprocs_8h.html#a170">00287</a> <a class="code" href="../../d3/d8/udfprocs_8h.html#a170">UdfLookupNextDirEntry</a> (
00288     IN <a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext,
00289     IN <a class="code" href="../../d7/d9/struct__FCB.html">PFCB</a> Fcb,
00290     IN <a class="code" href="../../d5/d5/struct__DIR__ENUM__CONTEXT.html">PDIR_ENUM_CONTEXT</a> DirContext
00291     )
00292 
00293 <span class="comment">/*++</span>
00294 <span class="comment"></span>
00295 <span class="comment">Routine Description:</span>
00296 <span class="comment"></span>
00297 <span class="comment">    This routine advances the enumeration of a directory by one entry.</span>
00298 <span class="comment"></span>
00299 <span class="comment">Arguments:</span>
00300 <span class="comment"></span>
00301 <span class="comment">    Fcb - the directory being enumerated.</span>
00302 <span class="comment">    </span>
00303 <span class="comment">    DirContext - a corresponding context for the enumeration.</span>
00304 <span class="comment"></span>
00305 <span class="comment">Return Value:</span>
00306 <span class="comment"></span>
00307 <span class="comment">    BOOLEAN True if another Fid is avaliable, False if we are at the end.</span>
00308 <span class="comment"></span>
00309 <span class="comment">--*/</span>
00310 
00311 {
00312     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00313     
00314     <span class="comment">//</span>
00315     <span class="comment">//  Check inputs.</span>
00316     <span class="comment">//</span>
00317 
00318     <a class="code" href="../../d1/d8/udfdata_8h.html#a28">ASSERT_IRP_CONTEXT</a>( IrpContext );
00319     <a class="code" href="../../d1/d8/udfdata_8h.html#a18">ASSERT_FCB_INDEX</a>( Fcb );
00320 
00321     <span class="comment">//</span>
00322     <span class="comment">//  If we have reached the end, stop.</span>
00323     <span class="comment">//</span>
00324     
00325     <span class="keywordflow">if</span> (DirContext-&gt;BaseOffset.QuadPart + DirContext-&gt;NextFidOffset == Fcb-&gt;FileSize.QuadPart) {
00326 
00327         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00328     }
00329 
00330     <span class="comment">//</span>
00331     <span class="comment">//  If the previous Fid was buffered, dismantle it now.</span>
00332     <span class="comment">//</span>
00333     
00334     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( DirContext-&gt;Flags, <a class="code" href="../../d6/d8/udfstruc_8h.html#a54">DIR_CONTEXT_FLAG_FID_BUFFERED</a> )) {
00335 
00336         <a class="code" href="../../d5/d5/cc_8h.html#a61">ClearFlag</a>( DirContext-&gt;Flags, <a class="code" href="../../d6/d8/udfstruc_8h.html#a54">DIR_CONTEXT_FLAG_FID_BUFFERED</a> );
00337         <a class="code" href="../../d3/d8/udfprocs_8h.html#a124">UdfFreePool</a>( &amp;DirContext-&gt;Fid );
00338     }
00339     
00340     <span class="comment">//</span>
00341     <span class="comment">//  Move the pointers based on the knowledge generated in the previous iteration.</span>
00342     <span class="comment">//</span>
00343 
00344     DirContext-&gt;ViewOffset = DirContext-&gt;NextFidOffset;
00345     DirContext-&gt;Fid = <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( DirContext-&gt;View, DirContext-&gt;ViewOffset, <a class="code" href="../../d1/d2/structNSR__FID.html">PNSR_FID</a> );
00346 
00347     <span class="comment">//</span>
00348     <span class="comment">//  The state of the context is now valid.  Tail off into our common post-processor</span>
00349     <span class="comment">//  to finish the work.</span>
00350     <span class="comment">//</span>
00351 
00352     <span class="keywordflow">return</span> <a class="code" href="../../d4/d8/dirsup_8c.html#a2">UdfLookupDirEntryPostProcessing</a>( IrpContext,
00353                                             Fcb,
00354                                             DirContext,
00355                                             <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00356 }
00357 
00358 
00359 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00360"></a><a class="code" href="../../d3/d8/udfprocs_8h.html#a171">00360</a> <a class="code" href="../../d3/d8/udfprocs_8h.html#a171">UdfUpdateDirNames</a> (
00361     IN <a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext,
00362     IN <a class="code" href="../../d5/d5/struct__DIR__ENUM__CONTEXT.html">PDIR_ENUM_CONTEXT</a> DirContext,
00363     IN BOOLEAN IgnoreCase
00364     )
00365 
00366 <span class="comment">/*++</span>
00367 <span class="comment"></span>
00368 <span class="comment">Routine Description:</span>
00369 <span class="comment"></span>
00370 <span class="comment">    This routine fills in the non-short names of a directory enumeration context</span>
00371 <span class="comment">    for the Fid currently referenced.</span>
00372 <span class="comment"></span>
00373 <span class="comment">Arguments:</span>
00374 <span class="comment"></span>
00375 <span class="comment">    DirContext - a corresponding context to fill in.</span>
00376 <span class="comment">    </span>
00377 <span class="comment">    IgnoreCase - whether the caller wants to be insensitive to case.</span>
00378 <span class="comment"></span>
00379 <span class="comment">Return Value:</span>
00380 <span class="comment"></span>
00381 <span class="comment">    None.</span>
00382 <span class="comment">    </span>
00383 <span class="comment">--*/</span>
00384 
00385 {
00386     PUCHAR NameDstring;
00387     BOOLEAN ContainsIllegal;
00388     
00389     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> NameLength;
00390     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> BufferLength;
00391     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> PresentLength;
00392      
00393     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00394 
00395     <span class="comment">//</span>
00396     <span class="comment">//  Check input.</span>
00397     <span class="comment">//</span>
00398 
00399     <a class="code" href="../../d1/d8/udfdata_8h.html#a28">ASSERT_IRP_CONTEXT</a>( IrpContext );
00400 
00401     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( +1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"UdfUpdateDirNames\n"</span> ));
00402 
00403     <span class="comment">//</span>
00404     <span class="comment">//  Handle the case of the self directory entry.</span>
00405     <span class="comment">//</span>
00406 
00407     <span class="keywordflow">if</span> (DirContext-&gt;Fid == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00408 
00409         <span class="comment">//</span>
00410         <span class="comment">//  Simply synthesize</span>
00411         <span class="comment">//</span>
00412         
00413         <span class="comment">//</span>
00414         <span class="comment">//  It doesn't hurt to be pedantic about initialization, so do it all.</span>
00415         <span class="comment">//</span>
00416         
00417         DirContext-&gt;PureObjectName.Length =
00418         DirContext-&gt;CaseObjectName.Length =
00419         DirContext-&gt;ObjectName.Length = <a class="code" href="../../d0/d8/udfdata_8c.html#a6">UdfUnicodeDirectoryNames</a>[<a class="code" href="../../d1/d8/udfdata_8h.html#a5">SELF_ENTRY</a>].Length;
00420         
00421         DirContext-&gt;PureObjectName.MaximumLength =
00422         DirContext-&gt;CaseObjectName.MaximumLength =
00423         DirContext-&gt;ObjectName.MaximumLength = <a class="code" href="../../d0/d8/udfdata_8c.html#a6">UdfUnicodeDirectoryNames</a>[<a class="code" href="../../d1/d8/udfdata_8h.html#a5">SELF_ENTRY</a>].MaximumLength;
00424 
00425         DirContext-&gt;PureObjectName.Buffer = 
00426         DirContext-&gt;CaseObjectName.Buffer = 
00427         DirContext-&gt;ObjectName.Buffer = <a class="code" href="../../d0/d8/udfdata_8c.html#a6">UdfUnicodeDirectoryNames</a>[<a class="code" href="../../d1/d8/udfdata_8h.html#a5">SELF_ENTRY</a>].Buffer;
00428 
00429         <span class="comment">//</span>
00430         <span class="comment">//  All done.</span>
00431         <span class="comment">//</span>
00432 
00433         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>((  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"Self Entry case\n"</span> ));
00434         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( -1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"UdfUpdateDirNames -&gt; VOID\n"</span> ));
00435         
00436         <span class="keywordflow">return</span>;
00437     }
00438     
00439     <span class="comment">//</span>
00440     <span class="comment">//  Handle the case of the parent directory entry.</span>
00441     <span class="comment">//</span>
00442 
00443     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( DirContext-&gt;Fid-&gt;Flags, <a class="code" href="../../d0/d7/iso13346_8h.html#a91">NSR_FID_F_PARENT</a> )) {
00444 
00445         <span class="comment">//</span>
00446         <span class="comment">//  Parent entries must occur at the front of the directory and</span>
00447         <span class="comment">//  have a fid length of zero (13346 4/14.4.4).</span>
00448         <span class="comment">//</span>
00449 
00450         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( DirContext-&gt;Flags, <a class="code" href="../../d6/d8/udfstruc_8h.html#a52">DIR_CONTEXT_FLAG_SEEN_NONCONSTANT</a> ) ||
00451             DirContext-&gt;Fid-&gt;FileIDLen != 0) {
00452 
00453             <a class="code" href="../../d3/d8/udfprocs_8h.html#a122">UdfRaiseStatus</a>( IrpContext, STATUS_FILE_CORRUPT_ERROR );
00454         }
00455 
00456         <span class="comment">//</span>
00457         <span class="comment">//  Note that we have seen the parent entry.</span>
00458         <span class="comment">//</span>
00459 
00460         <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( DirContext-&gt;Flags, <a class="code" href="../../d6/d8/udfstruc_8h.html#a53">DIR_CONTEXT_FLAG_SEEN_PARENT</a> );
00461         
00462         <span class="comment">//</span>
00463         <span class="comment">//  It doesn't hurt to be pedantic about initialization, so do it all.</span>
00464         <span class="comment">//</span>
00465         
00466         DirContext-&gt;PureObjectName.Length =
00467         DirContext-&gt;CaseObjectName.Length =
00468         DirContext-&gt;ObjectName.Length = <a class="code" href="../../d0/d8/udfdata_8c.html#a6">UdfUnicodeDirectoryNames</a>[<a class="code" href="../../d1/d8/udfdata_8h.html#a6">PARENT_ENTRY</a>].Length;
00469         
00470         DirContext-&gt;PureObjectName.MaximumLength =
00471         DirContext-&gt;CaseObjectName.MaximumLength =
00472         DirContext-&gt;ObjectName.MaximumLength = <a class="code" href="../../d0/d8/udfdata_8c.html#a6">UdfUnicodeDirectoryNames</a>[<a class="code" href="../../d1/d8/udfdata_8h.html#a6">PARENT_ENTRY</a>].MaximumLength;
00473 
00474         DirContext-&gt;PureObjectName.Buffer = 
00475         DirContext-&gt;CaseObjectName.Buffer = 
00476         DirContext-&gt;ObjectName.Buffer = <a class="code" href="../../d0/d8/udfdata_8c.html#a6">UdfUnicodeDirectoryNames</a>[<a class="code" href="../../d1/d8/udfdata_8h.html#a6">PARENT_ENTRY</a>].Buffer;
00477 
00478         <span class="comment">//</span>
00479         <span class="comment">//  All done.</span>
00480         <span class="comment">//</span>
00481 
00482         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>((  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"Parent Entry case\n"</span> ));
00483         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( -1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"UdfUpdateDirNames -&gt; VOID\n"</span> ));
00484         
00485         <span class="keywordflow">return</span>;
00486     }
00487 
00488     <span class="comment">//</span>
00489     <span class="comment">//  We now know that we will need to convert the name in a real FID, so figure out where</span>
00490     <span class="comment">//  it sits in the descriptor.</span>
00491     <span class="comment">//</span>
00492     
00493     NameDstring = <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( DirContext-&gt;Fid, <a class="code" href="../../d0/d7/iso13346_8h.html#a86">ISONsrFidConstantSize</a> + DirContext-&gt;Fid-&gt;ImpUseLen, PUCHAR );
00494      
00495     <span class="comment">//</span>
00496     <span class="comment">//  Every directory must record a parent entry.</span>
00497     <span class="comment">//</span>
00498     
00499     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( DirContext-&gt;Flags, <a class="code" href="../../d6/d8/udfstruc_8h.html#a53">DIR_CONTEXT_FLAG_SEEN_PARENT</a>)) {
00500     
00501         <a class="code" href="../../d3/d8/udfprocs_8h.html#a122">UdfRaiseStatus</a>( IrpContext, STATUS_FILE_CORRUPT_ERROR );
00502     }
00503     
00504     <span class="comment">//</span>
00505     <span class="comment">//  Note that we are proceeding into the non-constant portion of a directory.</span>
00506     <span class="comment">//</span>
00507     
00508     <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( DirContext-&gt;Flags, <a class="code" href="../../d6/d8/udfstruc_8h.html#a52">DIR_CONTEXT_FLAG_SEEN_NONCONSTANT</a> );
00509     
00510     <span class="comment">//</span>
00511     <span class="comment">//  Make sure the dstring is good CS0</span>
00512     <span class="comment">//</span>
00513     
00514     <a class="code" href="../../d3/d8/udfprocs_8h.html#a182">UdfCheckLegalCS0Dstring</a>( IrpContext,
00515                              NameDstring,
00516                              DirContext-&gt;Fid-&gt;FileIDLen,
00517                              0,
00518                              <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00519     
00520     <span class="comment">//</span>
00521     <span class="comment">//  Don't bother allocating tiny buffers - always make sure we get enough for an 8.3 name.</span>
00522     <span class="comment">//</span>
00523 
00524     BufferLength =
00525     NameLength = <a class="code" href="../../d3/d8/udfprocs_8h.html#a4">Max</a>( <a class="code" href="../../d9/d7/udf_8h.html#a11">BYTE_COUNT_8_DOT_3</a>, <a class="code" href="../../d3/d8/udfprocs_8h.html#a187">UdfCS0DstringUnicodeSize</a>( IrpContext,
00526                                                                     NameDstring,
00527                                                                     DirContext-&gt;Fid-&gt;FileIDLen) );
00528 
00529     <span class="comment">//</span>
00530     <span class="comment">//  Illegality is both actual illegal characters and too many characters.</span>
00531     <span class="comment">//</span>
00532     
00533     ContainsIllegal = (!<a class="code" href="../../d3/d8/udfprocs_8h.html#a189">UdfCS0DstringContainsLegalCharacters</a>( NameDstring, DirContext-&gt;Fid-&gt;FileIDLen ) ||
00534                        (NameLength / <span class="keyword">sizeof</span>( WCHAR )) &gt; <a class="code" href="../../d9/d7/udf_8h.html#a13">MAX_LEN</a>);
00535 
00536     
00537     <span class="comment">//</span>
00538     <span class="comment">//  If we're illegal, we will need more characters to hold the uniqifying stamp.</span>
00539     <span class="comment">//</span>
00540     
00541     <span class="keywordflow">if</span> (ContainsIllegal) {
00542 
00543         BufferLength = (NameLength += (<a class="code" href="../../d9/d7/udf_8h.html#a15">CRC_LEN</a> * <span class="keyword">sizeof</span>(WCHAR)));
00544     }
00545     
00546     
00547     <span class="comment">//</span>
00548     <span class="comment">//  If we need to build a case insensitive name, need more space.</span>
00549     <span class="comment">//</span>
00550         
00551     <span class="keywordflow">if</span> (IgnoreCase) {
00552 
00553         BufferLength += NameLength;
00554     }
00555     
00556     <span class="comment">//</span>
00557     <span class="comment">//  If we need to render the names due to illegal characters, more space again.</span>
00558     <span class="comment">//</span>
00559         
00560     <span class="keywordflow">if</span> (ContainsIllegal) {
00561 
00562         BufferLength += NameLength;
00563     
00564     } <span class="keywordflow">else</span> {
00565 
00566         <span class="comment">//</span>
00567         <span class="comment">//  Make sure the names aren't seperated. If more illegal names are found we can</span>
00568         <span class="comment">//  resplit the buffer but until then avoid the expense of having to copy bytes</span>
00569         <span class="comment">//  ... odds are that illegal characters are going to be a rarish occurance.</span>
00570         <span class="comment">//</span>
00571         
00572         DirContext-&gt;PureObjectName.Buffer = DirContext-&gt;ObjectName.Buffer;
00573     }
00574 
00575     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( 0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>,
00576                  <span class="stringliteral">"Ob %s%sneeds %d bytes (%d byte chunks), have %d\n"</span>,
00577                  (IgnoreCase? <span class="stringliteral">"Ic "</span> : <span class="stringliteral">""</span>),
00578                  (ContainsIllegal? <span class="stringliteral">"Ci "</span> : <span class="stringliteral">""</span>),
00579                  BufferLength,
00580                  NameLength,
00581                  DirContext-&gt;AllocLength ));
00582 
00583     <span class="comment">//</span>
00584     <span class="comment">//  Check if we need more space for the names.  We will need more if the name size is greater</span>
00585     <span class="comment">//  than the maximum we can currently store, or if we have stumbled across illegal characters</span>
00586     <span class="comment">//  and the current Pure name is not seperated from the exposed Object name.</span>
00587     <span class="comment">//</span>
00588     <span class="comment">//  Note that IgnoreCase remains constant across usage of a context so we don't have to wonder</span>
00589     <span class="comment">//  if it has been seperated from the ObjectName - it'll always be correct.</span>
00590     <span class="comment">//</span>
00591     
00592     <span class="keywordflow">if</span> ((NameLength &gt; DirContext-&gt;ObjectName.MaximumLength) ||
00593         (ContainsIllegal &amp;&amp; DirContext-&gt;ObjectName.Buffer == DirContext-&gt;PureObjectName.Buffer)) {
00594 
00595         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( 0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"Resizing buffers\n"</span> ));
00596         
00597         <span class="comment">//</span>
00598         <span class="comment">//  For some reason the sizing is not good for the current name we have to unroll.  Figure</span>
00599         <span class="comment">//  out if we can break up the current allocation in a different way before falling back</span>
00600         <span class="comment">//  to a new allocation.</span>
00601         <span class="comment">//</span>
00602 
00603         <span class="keywordflow">if</span> (DirContext-&gt;AllocLength &gt;= BufferLength) {
00604 
00605             <span class="comment">//</span>
00606             <span class="comment">//  So we can still use the current allocation.  Chop it up into the required number</span>
00607             <span class="comment">//  of chunks.</span>
00608             <span class="comment">//</span>
00609 
00610             DirContext-&gt;PureObjectName.MaximumLength =
00611             DirContext-&gt;CaseObjectName.MaximumLength =
00612             DirContext-&gt;ObjectName.MaximumLength = DirContext-&gt;AllocLength / (1 +
00613                                                                               (IgnoreCase? 1 : 0) +
00614                                                                               (ContainsIllegal? 1 : 0));
00615 
00616             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( 0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, 
00617                          <span class="stringliteral">"... by resplit into %d byte chunks\n"</span>,
00618                          DirContext-&gt;ObjectName.MaximumLength ));
00619             
00620             <span class="comment">//</span>
00621             <span class="comment">//  Set the buffer pointers up.  Required adjustment will occur below.</span>
00622             <span class="comment">//</span>
00623                 
00624             DirContext-&gt;PureObjectName.Buffer = 
00625             DirContext-&gt;CaseObjectName.Buffer = 
00626             DirContext-&gt;ObjectName.Buffer = DirContext-&gt;NameBuffer;
00627         
00628         } <span class="keywordflow">else</span> {
00629 
00630             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( 0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"... by allocating new pool\n"</span> ));
00631             
00632             <span class="comment">//</span>
00633             <span class="comment">//  Oh well, no choice but to fall back into the pool.  Drop our previous hunk.</span>
00634             <span class="comment">//</span>
00635             
00636             <a class="code" href="../../d3/d8/udfprocs_8h.html#a124">UdfFreePool</a>( &amp;DirContext-&gt;NameBuffer );
00637             DirContext-&gt;AllocLength = 0;
00638             
00639             <span class="comment">//</span>
00640             <span class="comment">//  The names share an allocation for efficiency.</span>
00641             <span class="comment">//</span>
00642             
00643             DirContext-&gt;PureObjectName.MaximumLength =
00644             DirContext-&gt;CaseObjectName.MaximumLength =
00645             DirContext-&gt;ObjectName.MaximumLength = NameLength;
00646     
00647             DirContext-&gt;NameBuffer =
00648             DirContext-&gt;PureObjectName.Buffer = 
00649             DirContext-&gt;CaseObjectName.Buffer = 
00650             DirContext-&gt;ObjectName.Buffer = <a class="code" href="../../d1/d8/fsrtl_8h.html#a37">FsRtlAllocatePoolWithTag</a>( <a class="code" href="../../d3/d8/udfprocs_8h.html#a65">UdfPagedPool</a>,
00651                                                                       BufferLength,
00652                                                                       <a class="code" href="../../d1/d7/udfs_2nodetype_8h.html#a75">TAG_FILE_NAME</a> );
00653 
00654             DirContext-&gt;AllocLength = BufferLength;
00655         }
00656         
00657         <span class="comment">//</span>
00658         <span class="comment">//  In the presence of the "as appropriate" names, adjust the buffer locations.  Note</span>
00659         <span class="comment">//  that ObjectName.Buffer is always the base of the allocated space.</span>
00660         <span class="comment">//</span>
00661         
00662         <span class="keywordflow">if</span> (IgnoreCase) {
00663 
00664             DirContext-&gt;CaseObjectName.Buffer = <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( DirContext-&gt;ObjectName.Buffer, 
00665                                                          DirContext-&gt;ObjectName.MaximumLength,
00666                                                          PWCHAR );
00667         }
00668 
00669         <span class="keywordflow">if</span> (ContainsIllegal) {
00670             
00671             DirContext-&gt;PureObjectName.Buffer = <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( DirContext-&gt;CaseObjectName.Buffer,
00672                                                          DirContext-&gt;CaseObjectName.MaximumLength,
00673                                                          PWCHAR );
00674         }
00675     }
00676 
00677     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( BufferLength &lt;= DirContext-&gt;AllocLength );
00678 
00679     <span class="comment">//</span>
00680     <span class="comment">//  Convert the dstring.</span>
00681     <span class="comment">//</span>
00682     
00683     <a class="code" href="../../d3/d8/udfprocs_8h.html#a181">UdfConvertCS0DstringToUnicode</a>( IrpContext,
00684                                    NameDstring,
00685                                    DirContext-&gt;Fid-&gt;FileIDLen,
00686                                    0,
00687                                    &amp;DirContext-&gt;PureObjectName );
00688 
00689     <span class="comment">//</span>
00690     <span class="comment">//  If illegal characters were present, run the name through the UDF transmogrifier.</span>
00691     <span class="comment">//</span>
00692 
00693     <span class="keywordflow">if</span> (ContainsIllegal) {
00694 
00695         <a class="code" href="../../d3/d8/udfprocs_8h.html#a183">UdfRenderNameToLegalUnicode</a>( IrpContext,
00696                                      &amp;DirContext-&gt;PureObjectName,
00697                                      &amp;DirContext-&gt;ObjectName );
00698 
00699     <span class="comment">//</span>
00700     <span class="comment">//  The ObjectName is the same as the PureObjectName.</span>
00701     <span class="comment">//</span>
00702 
00703     } <span class="keywordflow">else</span> {
00704 
00705         DirContext-&gt;ObjectName.Length = DirContext-&gt;PureObjectName.Length;
00706     }
00707 
00708     <span class="comment">//</span>
00709     <span class="comment">//  Upcase the result if required.</span>
00710     <span class="comment">//</span>
00711 
00712     <span class="keywordflow">if</span> (IgnoreCase) {
00713 
00714         <a class="code" href="../../d3/d8/udfprocs_8h.html#a186">UdfUpcaseName</a>( IrpContext,
00715                        &amp;DirContext-&gt;ObjectName,
00716                        &amp;DirContext-&gt;CaseObjectName );
00717     }
00718 
00719     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( -1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"UdfUpdateDirNames -&gt; VOID\n"</span> ));
00720     
00721     <span class="keywordflow">return</span>;
00722 }
00723 
00724 
00725 BOOLEAN
<a name="l00726"></a><a class="code" href="../../d3/d8/udfprocs_8h.html#a172">00726</a> <a class="code" href="../../d3/d8/udfprocs_8h.html#a172">UdfFindDirEntry</a> (
00727     IN <a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext,
00728     IN <a class="code" href="../../d7/d9/struct__FCB.html">PFCB</a> Fcb,
00729     IN PUNICODE_STRING Name,
00730     IN BOOLEAN IgnoreCase,
00731     IN BOOLEAN ShortName,
00732     IN <a class="code" href="../../d5/d5/struct__DIR__ENUM__CONTEXT.html">PDIR_ENUM_CONTEXT</a> DirContext
00733     )
00734 
00735 <span class="comment">/*++</span>
00736 <span class="comment"></span>
00737 <span class="comment">Routine Description:</span>
00738 <span class="comment"></span>
00739 <span class="comment">    This routine walks the directory specified for an entry which matches the input</span>
00740 <span class="comment">    criteria.</span>
00741 <span class="comment"></span>
00742 <span class="comment">Arguments:</span>
00743 <span class="comment"></span>
00744 <span class="comment">    Fcb - the directory to search</span>
00745 <span class="comment">    </span>
00746 <span class="comment">    Name - name to search for</span>
00747 <span class="comment">    </span>
00748 <span class="comment">    IgnoreCase - whether this search should be case-insensitive (Name will already</span>
00749 <span class="comment">        be upcased)</span>
00750 <span class="comment">        </span>
00751 <span class="comment">    ShortName - whether the name should be searched for according to short name rules</span>
00752 <span class="comment">    </span>
00753 <span class="comment">    DirContext - context structure to use and return results in</span>
00754 <span class="comment"></span>
00755 <span class="comment">Return Value:</span>
00756 <span class="comment"></span>
00757 <span class="comment">    BOOLEAN True if a matching directory entry is being returned, False otherwise.</span>
00758 <span class="comment"></span>
00759 <span class="comment">--*/</span>
00760 
00761 {
00762     PUNICODE_STRING MatchName;
00763 
00764     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00765 
00766     <span class="comment">//</span>
00767     <span class="comment">//  Check inputs.</span>
00768     <span class="comment">//</span>
00769 
00770     <a class="code" href="../../d1/d8/udfdata_8h.html#a28">ASSERT_IRP_CONTEXT</a>( IrpContext );
00771     <a class="code" href="../../d1/d8/udfdata_8h.html#a18">ASSERT_FCB_INDEX</a>( Fcb );
00772 
00773     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( +1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>,
00774                  <span class="stringliteral">"UdfFindDirEntry, Fcb=%08x Name=\"%wZ\" Ignore=%u Short=%u, DC=%08x\n"</span>,
00775                  Fcb,
00776                  <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>,
00777                  IgnoreCase,
00778                  ShortName,
00779                  DirContext ));
00780 
00781     <span class="comment">//</span>
00782     <span class="comment">//  Depending on the kind of search we are performing a different flavor of the found name</span>
00783     <span class="comment">//  wil be used in the comparison.</span>
00784     <span class="comment">//</span>
00785     
00786     <span class="keywordflow">if</span> (ShortName) {
00787 
00788         MatchName = &amp;DirContext-&gt;ShortObjectName;
00789     
00790     } <span class="keywordflow">else</span> {
00791 
00792         MatchName = &amp;DirContext-&gt;CaseObjectName;
00793     }
00794 
00795 
00796     <span class="comment">//</span>
00797     <span class="comment">//  Go get the first entry.</span>
00798     <span class="comment">//</span>
00799 
00800     <a class="code" href="../../d3/d8/udfprocs_8h.html#a169">UdfLookupInitialDirEntry</a>( IrpContext,
00801                               Fcb,
00802                               DirContext,
00803                               <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00804 
00805     <span class="comment">//</span>
00806     <span class="comment">//  Now loop looking for a good match.</span>
00807     <span class="comment">//</span>
00808     
00809     <span class="keywordflow">do</span> {
00810 
00811         <span class="comment">//</span>
00812         <span class="comment">//  If it is deleted, we obviously aren't interested in it.</span>
00813         <span class="comment">//</span>
00814         
00815         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( DirContext-&gt;Fid-&gt;Flags, <a class="code" href="../../d0/d7/iso13346_8h.html#a90">NSR_FID_F_DELETED</a> )) {
00816 
00817             <span class="keywordflow">continue</span>;
00818         }
00819 
00820         <a class="code" href="../../d3/d8/udfprocs_8h.html#a171">UdfUpdateDirNames</a>( IrpContext,
00821                            DirContext,
00822                            IgnoreCase );
00823             
00824         
00825         <span class="comment">//</span>
00826         <span class="comment">//  If this is a constant entry, just keep going.</span>
00827         <span class="comment">//</span>
00828         
00829         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( DirContext-&gt;Flags, <a class="code" href="../../d6/d8/udfstruc_8h.html#a52">DIR_CONTEXT_FLAG_SEEN_NONCONSTANT</a> )) {
00830             
00831             <span class="keywordflow">continue</span>;
00832         }
00833 
00834         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( 0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>,
00835                      <span class="stringliteral">"\"%wZ\" (pure \"%wZ\") @ +%08x\n"</span>,
00836                      &amp;DirContext-&gt;ObjectName,
00837                      &amp;DirContext-&gt;PureObjectName,
00838                      DirContext-&gt;ViewOffset ));
00839 
00840         <span class="comment">//</span>
00841         <span class="comment">//  If we are searching for generated shortnames, a small subset of the names</span>
00842         <span class="comment">//  in the directory are actually candidates for a match.  Go get the name.</span>
00843         <span class="comment">//</span>
00844         
00845         <span class="keywordflow">if</span> (ShortName) {
00846 
00847             <span class="comment">//</span>
00848             <span class="comment">//  Now, only if this Fid's name is non 8.3 is it neccesary to work with it.</span>
00849             <span class="comment">//</span>
00850             
00851             <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d8/udfprocs_8h.html#a178">UdfIs8dot3Name</a>( IrpContext, DirContext-&gt;ObjectName )) {
00852 
00853                 <span class="comment">//</span>
00854                 <span class="comment">//  Allocate the shortname if it isn't already done.</span>
00855                 <span class="comment">//</span>
00856                 
00857                 <span class="keywordflow">if</span> (DirContext-&gt;ShortObjectName.Buffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00858 
00859                     DirContext-&gt;ShortObjectName.Buffer = <a class="code" href="../../d1/d8/fsrtl_8h.html#a37">FsRtlAllocatePoolWithTag</a>( <a class="code" href="../../d3/d8/udfprocs_8h.html#a65">UdfPagedPool</a>,
00860                                                                                    <a class="code" href="../../d9/d7/udf_8h.html#a11">BYTE_COUNT_8_DOT_3</a>,
00861                                                                                    <a class="code" href="../../d1/d7/udfs_2nodetype_8h.html#a83">TAG_SHORT_FILE_NAME</a> );
00862                     DirContext-&gt;ShortObjectName.MaximumLength = <a class="code" href="../../d9/d7/udf_8h.html#a11">BYTE_COUNT_8_DOT_3</a>;
00863                 }
00864 
00865                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a180">UdfGenerate8dot3Name</a>( IrpContext,
00866                                       &amp;DirContext-&gt;PureObjectName,
00867                                       &amp;DirContext-&gt;ShortObjectName );
00868 
00869                 <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( 0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>,
00870                              <span class="stringliteral">"built shortname \"%wZ\"\n"</span>, &amp;DirContext-&gt;ShortObjectName ));
00871 
00872             } <span class="keywordflow">else</span> {
00873 
00874                 <span class="comment">//</span>
00875                 <span class="comment">//  As an 8.3 name already, this name will not have caused us to have to generate</span>
00876                 <span class="comment">//  a short name, so it can't be the case that the caller is looking for it.</span>
00877                 <span class="comment">//</span>
00878                 
00879                 <span class="keywordflow">continue</span>;
00880             }
00881         }
00882 
00883         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/udfprocs_8h.html#a185">UdfFullCompareNames</a>( IrpContext,
00884                                  MatchName,
00885                                  <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a> ) == <a class="code" href="../../d1/d8/fsrtl_8h.html#a189a90">EqualTo</a>) {
00886 
00887             <span class="comment">//</span>
00888             <span class="comment">//  Got a match, so give it up.</span>
00889             <span class="comment">//</span>
00890 
00891             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>((  0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"HIT\n"</span> ));
00892             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( -1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"UdfFindDirEntry -&gt; TRUE\n"</span> ));
00893 
00894             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00895         }
00896 
00897     } <span class="keywordflow">while</span> ( <a class="code" href="../../d3/d8/udfprocs_8h.html#a170">UdfLookupNextDirEntry</a>( IrpContext,
00898                                      Fcb,
00899                                      DirContext ));
00900 
00901     <span class="comment">//</span>
00902     <span class="comment">//  No match was found.</span>
00903     <span class="comment">//</span>
00904 
00905     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( -1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"UdfFindDirEntry -&gt; FALSE\n"</span> ));
00906 
00907     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00908 }
00909 
00910 
00911 <span class="comment">//</span>
00912 <span class="comment">//  Local support routine</span>
00913 <span class="comment">//</span>
00914 
00915 BOOLEAN
<a name="l00916"></a><a class="code" href="../../d4/d8/dirsup_8c.html#a2">00916</a> <a class="code" href="../../d4/d8/dirsup_8c.html#a2">UdfLookupDirEntryPostProcessing</a> (
00917     IN <a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext,
00918     IN <a class="code" href="../../d7/d9/struct__FCB.html">PFCB</a> Fcb,
00919     IN <a class="code" href="../../d5/d5/struct__DIR__ENUM__CONTEXT.html">PDIR_ENUM_CONTEXT</a> DirContext,
00920     IN BOOLEAN ReturnError
00921     )
00922 
00923 <span class="comment">/*++</span>
00924 <span class="comment"></span>
00925 <span class="comment">Routine Description:</span>
00926 <span class="comment"></span>
00927 <span class="comment">    This routine is the core engine of directory stream enumeration. It receives</span>
00928 <span class="comment">    a context which has been advanced and does the integrity checks and final</span>
00929 <span class="comment">    extraction of the Fid with respect to file cache granularity restrictions.</span>
00930 <span class="comment"></span>
00931 <span class="comment">    NOTE: we assume that a Fid cannot span a cache view.  The maximum size of a</span>
00932 <span class="comment">    Fid is just over 32k, so this is a good and likely permanent assumption.</span>
00933 <span class="comment"></span>
00934 <span class="comment">Arguments:</span>
00935 <span class="comment"></span>
00936 <span class="comment">    Fcb - the directory being enumerated.</span>
00937 <span class="comment">    </span>
00938 <span class="comment">    DirContext - a corresponding context for the enumeration.</span>
00939 <span class="comment">    </span>
00940 <span class="comment">    ReturnError - whether errors should be returned (or raised)</span>
00941 <span class="comment"></span>
00942 <span class="comment">Return Value:</span>
00943 <span class="comment"></span>
00944 <span class="comment">    BOOLEAN according to the successful extraction of the Fid.  If ReturnError is</span>
00945 <span class="comment">    FALSE, then failure will result in a raised status.</span>
00946 <span class="comment"></span>
00947 <span class="comment">--*/</span>
00948 
00949 {
00950     BOOLEAN Result = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00951     
00952     <a class="code" href="../../d1/d2/structNSR__FID.html">PNSR_FID</a> FidBufferC = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00953     <a class="code" href="../../d1/d2/structNSR__FID.html">PNSR_FID</a> FidBuffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00954 
00955     <a class="code" href="../../d1/d2/structNSR__FID.html">PNSR_FID</a> FidC;
00956     <a class="code" href="../../d1/d2/structNSR__FID.html">PNSR_FID</a> Fid;
00957 
00958     ULONG FidBytesInPreviousView = 0;
00959     
00960     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00961     
00962     <span class="comment">//</span>
00963     <span class="comment">//  Check inputs.</span>
00964     <span class="comment">//</span>
00965 
00966     <a class="code" href="../../d1/d8/udfdata_8h.html#a28">ASSERT_IRP_CONTEXT</a>( IrpContext );
00967     <a class="code" href="../../d1/d8/udfdata_8h.html#a18">ASSERT_FCB_INDEX</a>( Fcb );
00968     
00969     <span class="keywordflow">try</span> {
00970         
00971         <span class="comment">//</span>
00972         <span class="comment">//  First check that the stream can contain another FID.</span>
00973         <span class="comment">//</span>
00974     
00975         <span class="keywordflow">if</span> (DirContext-&gt;BaseOffset.QuadPart +
00976             DirContext-&gt;ViewOffset +
00977             <a class="code" href="../../d0/d7/iso13346_8h.html#a86">ISONsrFidConstantSize</a> &gt; Fcb-&gt;FileSize.QuadPart) {
00978     
00979             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( 0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>,
00980                          <span class="stringliteral">"UdfLookupDirEntryPostProcessing: DC %p, constant header overlaps end of dir\n"</span>,
00981                          DirContext ));
00982 
00983             <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( Result = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00984         }
00985             
00986         <span class="comment">//</span>
00987         <span class="comment">//  We now build up the constant portion of the FID for use.  It may be the case that</span>
00988         <span class="comment">//  this spans a view boundary and must be buffered, or is entirely in the next view</span>
00989         <span class="comment">//  and we simply need to advance.</span>
00990         <span class="comment">//</span>
00991     
00992         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/udfprocs_8h.html#a16">GenericTruncatePtr</a>( <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( DirContext-&gt;Fid, <a class="code" href="../../d0/d7/iso13346_8h.html#a86">ISONsrFidConstantSize</a> - 1, PUCHAR ), <a class="code" href="../../d4/d2/cache_8h.html#a0">VACB_MAPPING_GRANULARITY</a> ) !=
00993             DirContext-&gt;View) {
00994             
00995             FidBytesInPreviousView = <a class="code" href="../../d3/d8/udfprocs_8h.html#a19">GenericRemainderPtr</a>( DirContext-&gt;Fid, <a class="code" href="../../d4/d2/cache_8h.html#a0">VACB_MAPPING_GRANULARITY</a> );
00996             
00997             <span class="comment">//</span>
00998             <span class="comment">//  Only buffer if there are really bytes in the previous view.</span>
00999             <span class="comment">//</span>
01000             
01001             <span class="keywordflow">if</span> (FidBytesInPreviousView) {
01002                 
01003                 FidC =
01004                 FidBufferC = <a class="code" href="../../d1/d8/fsrtl_8h.html#a37">FsRtlAllocatePoolWithTag</a>( <a class="code" href="../../d3/d8/udfprocs_8h.html#a65">UdfPagedPool</a>,
01005                                                        <a class="code" href="../../d0/d7/iso13346_8h.html#a86">ISONsrFidConstantSize</a>,
01006                                                        <a class="code" href="../../d1/d7/udfs_2nodetype_8h.html#a74">TAG_FID_BUFFER</a> );
01007         
01008                 RtlCopyMemory( FidBufferC,
01009                                DirContext-&gt;Fid,
01010                                FidBytesInPreviousView );
01011             }
01012     
01013             <span class="comment">//</span>
01014             <span class="comment">//  Now advance into the next view to pick up the rest.</span>
01015             <span class="comment">//</span>
01016             
01017             DirContext-&gt;BaseOffset.QuadPart += <a class="code" href="../../d4/d2/cache_8h.html#a0">VACB_MAPPING_GRANULARITY</a>;
01018             DirContext-&gt;ViewOffset = 0;
01019             
01020             <span class="comment">//</span>
01021             <span class="comment">//  Contain the view length by the size of the stream and map.</span>
01022             <span class="comment">//</span>
01023         
01024             DirContext-&gt;ViewLength = <a class="code" href="../../d4/d2/cache_8h.html#a0">VACB_MAPPING_GRANULARITY</a>;
01025         
01026             <span class="keywordflow">if</span> (DirContext-&gt;BaseOffset.QuadPart + DirContext-&gt;ViewLength &gt; Fcb-&gt;FileSize.QuadPart) {
01027         
01028                 DirContext-&gt;ViewLength = (ULONG) (Fcb-&gt;FileSize.QuadPart - DirContext-&gt;BaseOffset.QuadPart);
01029             }
01030             
01031             <a class="code" href="../../d3/d8/udfprocs_8h.html#a69">UdfUnpinData</a>( IrpContext, &amp;DirContext-&gt;Bcb );
01032             
01033             <a class="code" href="../../d4/d2/cache_8h.html#a88">CcMapData</a>( Fcb-&gt;FileObject,
01034                        &amp;DirContext-&gt;BaseOffset,
01035                        DirContext-&gt;ViewLength,
01036                        <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
01037                        &amp;DirContext-&gt;Bcb,
01038                        &amp;DirContext-&gt;View );
01039 
01040             <span class="comment">//</span>
01041             <span class="comment">//  We are guaranteed that this much lies in the stream.  Build the rest of the</span>
01042             <span class="comment">//  constant header.</span>
01043             <span class="comment">//</span>
01044     
01045             <span class="keywordflow">if</span> (FidBytesInPreviousView) {
01046                 
01047                 RtlCopyMemory( <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( FidBufferC, FidBytesInPreviousView, PUCHAR ),
01048                                DirContext-&gt;View,
01049                                <a class="code" href="../../d0/d7/iso13346_8h.html#a86">ISONsrFidConstantSize</a> - FidBytesInPreviousView );
01050             
01051             <span class="comment">//</span>
01052             <span class="comment">//  In fact, this FID is perfectly aligned to the front of this view.  No buffering</span>
01053             <span class="comment">//  is required, and we just set the FID pointer.</span>
01054             <span class="comment">//</span>
01055 
01056             } <span class="keywordflow">else</span> {
01057 
01058 
01059                 DirContext-&gt;Fid = DirContext-&gt;View;
01060             }
01061         }
01062          
01063         <span class="comment">//</span>
01064         <span class="comment">//  If no buffering was required, we can use the cache directly.</span>
01065         <span class="comment">//</span>
01066             
01067         <span class="keywordflow">if</span> (!FidBytesInPreviousView) {
01068     
01069             FidC = DirContext-&gt;Fid;
01070         }
01071     
01072         <span class="comment">//</span>
01073         <span class="comment">//  Now we can check that the Fid data lies within the stream bounds and is sized</span>
01074         <span class="comment">//  within a logical block (per UDF).  This will complete the size-wise integrity</span>
01075         <span class="comment">//  verification.</span>
01076         <span class="comment">//</span>
01077 
01078         <span class="keywordflow">if</span> (((DirContext-&gt;BaseOffset.QuadPart +
01079               DirContext-&gt;ViewOffset -
01080               FidBytesInPreviousView +
01081               <a class="code" href="../../d0/d7/iso13346_8h.html#a87">ISONsrFidSize</a>( FidC ) &gt; Fcb-&gt;FileSize.QuadPart) &amp;&amp;
01082              <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( 0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>,
01083                           <span class="stringliteral">"UdfLookupDirEntryPostProcessing: DC %p, FID (FidC %p, FBIPV %u) overlaps end of dir\n"</span>,
01084                           DirContext,
01085                           FidC,
01086                           FidBytesInPreviousView )))
01087               ||
01088 
01089             (<a class="code" href="../../d0/d7/iso13346_8h.html#a87">ISONsrFidSize</a>( FidC ) &gt; <a class="code" href="../../d3/d8/udfprocs_8h.html#a54">BlockSize</a>( Fcb-&gt;Vcb ) &amp;&amp;
01090              <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( 0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>,
01091              <span class="stringliteral">"UdfLookupDirEntryPostProcessing: DC %p, FID (FidC %p) larger than a logical block\n"</span>,
01092                           DirContext,
01093                           FidC )))) {
01094 
01095             <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( Result = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
01096 
01097         }
01098 
01099         <span class="comment">//</span>
01100         <span class="comment">//  Final Fid rollup.</span>
01101         <span class="comment">//</span>
01102         
01103         <span class="comment">//</span>
01104         <span class="comment">//  The Fid may span a view boundary and should be buffered.  If we already buffered, we know</span>
01105         <span class="comment">//  we have to do this.</span>
01106         <span class="comment">//</span>
01107 
01108         <span class="keywordflow">if</span> (FidBytesInPreviousView ||
01109             <a class="code" href="../../d3/d8/udfprocs_8h.html#a16">GenericTruncatePtr</a>( <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( DirContext-&gt;Fid, <a class="code" href="../../d0/d7/iso13346_8h.html#a87">ISONsrFidSize</a>( FidC ) - 1, PUCHAR ), <a class="code" href="../../d4/d2/cache_8h.html#a0">VACB_MAPPING_GRANULARITY</a> ) !=
01110             DirContext-&gt;View) {
01111         
01112             Fid =
01113             FidBuffer = <a class="code" href="../../d1/d8/fsrtl_8h.html#a37">FsRtlAllocatePoolWithTag</a>( <a class="code" href="../../d3/d8/udfprocs_8h.html#a65">UdfPagedPool</a>,
01114                                                   <a class="code" href="../../d0/d7/iso13346_8h.html#a87">ISONsrFidSize</a>( FidC ),
01115                                                   <a class="code" href="../../d1/d7/udfs_2nodetype_8h.html#a74">TAG_FID_BUFFER</a> );
01116 
01117             
01118             <span class="comment">//</span>
01119             <span class="comment">//  If we already buffered and advanced for the header, just prefill</span>
01120             <span class="comment">//  the final Fid buffer with the bytes that are now unavaliable.</span>
01121             <span class="comment">//</span>
01122             
01123             <span class="keywordflow">if</span> (FidBytesInPreviousView) {
01124 
01125                 RtlCopyMemory( FidBuffer,
01126                                FidBufferC,
01127                                FidBytesInPreviousView );
01128 
01129             } <span class="keywordflow">else</span> {
01130                 
01131                 <span class="comment">//</span>
01132                 <span class="comment">//  Buffer and advance the view.</span>
01133                 <span class="comment">//</span>
01134                 
01135                 FidBytesInPreviousView = <a class="code" href="../../d3/d8/udfprocs_8h.html#a19">GenericRemainderPtr</a>( DirContext-&gt;Fid, <a class="code" href="../../d4/d2/cache_8h.html#a0">VACB_MAPPING_GRANULARITY</a> );
01136                 
01137                 RtlCopyMemory( FidBuffer,
01138                                DirContext-&gt;Fid,
01139                                FidBytesInPreviousView );
01140                 
01141                 <span class="comment">//</span>
01142                 <span class="comment">//  Now advance into the next view to pick up the rest.</span>
01143                 <span class="comment">//</span>
01144                 
01145                 DirContext-&gt;BaseOffset.QuadPart += <a class="code" href="../../d4/d2/cache_8h.html#a0">VACB_MAPPING_GRANULARITY</a>;
01146                 DirContext-&gt;ViewOffset = 0;
01147                 
01148                 <span class="comment">//</span>
01149                 <span class="comment">//  Contain the view length by the size of the stream and map.</span>
01150                 <span class="comment">//</span>
01151             
01152                 DirContext-&gt;ViewLength = <a class="code" href="../../d4/d2/cache_8h.html#a0">VACB_MAPPING_GRANULARITY</a>;
01153             
01154                 <span class="keywordflow">if</span> (DirContext-&gt;BaseOffset.QuadPart + DirContext-&gt;ViewLength &gt; Fcb-&gt;FileSize.QuadPart) {
01155             
01156                     DirContext-&gt;ViewLength = (ULONG) (Fcb-&gt;FileSize.QuadPart - DirContext-&gt;BaseOffset.QuadPart);
01157                 }
01158                 
01159                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a69">UdfUnpinData</a>( IrpContext, &amp;DirContext-&gt;Bcb );
01160                 
01161                 <a class="code" href="../../d4/d2/cache_8h.html#a88">CcMapData</a>( Fcb-&gt;FileObject,
01162                            &amp;DirContext-&gt;BaseOffset,
01163                            DirContext-&gt;ViewLength,
01164                            <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
01165                            &amp;DirContext-&gt;Bcb,
01166                            &amp;DirContext-&gt;View );
01167             }
01168     
01169             <span class="comment">//</span>
01170             <span class="comment">//  We are guaranteed that this much lies in the stream.</span>
01171             <span class="comment">//</span>
01172     
01173             RtlCopyMemory( <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( FidBuffer, FidBytesInPreviousView, PUCHAR ),
01174                            DirContext-&gt;View,
01175                            <a class="code" href="../../d0/d7/iso13346_8h.html#a87">ISONsrFidSize</a>( FidC ) - FidBytesInPreviousView );
01176     
01177         } <span class="keywordflow">else</span> {
01178 
01179             Fid = DirContext-&gt;Fid;
01180         }
01181         
01182         <span class="comment">//</span>
01183         <span class="comment">//  We finally have the whole Fid safely extracted from the cache, so the</span>
01184         <span class="comment">//  integrity check is now the last step before success.  For simplicity's</span>
01185         <span class="comment">//  sake we trust the Lbn field.</span>
01186         <span class="comment">//</span>
01187     
01188         Result = <a class="code" href="../../d3/d8/udfprocs_8h.html#a219">UdfVerifyDescriptor</a>( IrpContext,
01189                                       &amp;Fid-&gt;<a class="code" href="../../d1/d2/structNSR__FID.html#o0">Destag</a>,
01190                                       <a class="code" href="../../d0/d7/iso13346_8h.html#a50">DESTAG_ID_NSR_FID</a>,
01191                                       <a class="code" href="../../d0/d7/iso13346_8h.html#a87">ISONsrFidSize</a>( Fid ),
01192                                       Fid-&gt;<a class="code" href="../../d1/d2/structNSR__FID.html#o0">Destag</a>.<a class="code" href="../../d7/d7/structDESTAG.html#o7">Lbn</a>,
01193                                       ReturnError );
01194 
01195         <span class="comment">//</span>
01196         <span class="comment">//  Prepare to return a buffered Fid.</span>
01197         <span class="comment">//</span>
01198         
01199         <span class="keywordflow">if</span> (FidBuffer &amp;&amp; Result) {
01200 
01201             <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( DirContext-&gt;Flags, <a class="code" href="../../d6/d8/udfstruc_8h.html#a54">DIR_CONTEXT_FLAG_FID_BUFFERED</a> );
01202             DirContext-&gt;Fid = FidBuffer;
01203             FidBuffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01204         }
01205         
01206     } finally {
01207 
01208         <a class="code" href="../../d3/d8/udfprocs_8h.html#a124">UdfFreePool</a>( &amp;FidBuffer );
01209         <a class="code" href="../../d3/d8/udfprocs_8h.html#a124">UdfFreePool</a>( &amp;FidBufferC );
01210     }
01211 
01212     <span class="keywordflow">if</span> (!ReturnError &amp;&amp; !Result) {
01213 
01214         <a class="code" href="../../d3/d8/udfprocs_8h.html#a122">UdfRaiseStatus</a>( IrpContext, STATUS_FILE_CORRUPT_ERROR );
01215     }
01216 
01217     <span class="comment">//</span>
01218     <span class="comment">//  On success update the next Fid information in the context.</span>
01219     <span class="comment">//  Note that  we must drop in a hint as to where the next Fid</span>
01220     <span class="comment">//  will be found so that the next advance will know how much</span>
01221     <span class="comment">//  of a buffered Fid isn't in this view.</span>
01222     <span class="comment">//</span>
01223 
01224     <span class="keywordflow">if</span> (Result) {
01225 
01226         DirContext-&gt;NextFidOffset = DirContext-&gt;ViewOffset +
01227                                     <a class="code" href="../../d0/d7/iso13346_8h.html#a87">ISONsrFidSize</a>( Fid );
01228         
01229         <span class="keywordflow">if</span> (FidBytesInPreviousView) {
01230             
01231             DirContext-&gt;NextFidOffset -= FidBytesInPreviousView;
01232         }
01233     }
01234 
01235     <span class="keywordflow">return</span> Result;
01236 }
01237 
01238 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:45 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
