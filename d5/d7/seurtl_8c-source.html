<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: seurtl.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>seurtl.c</h1><a href="../../d4/d8/seurtl_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    seurtl.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This Module implements many security rtl routines defined in nturtl.h</span>
00012 <span class="comment"></span>
00013 <span class="comment">Author:</span>
00014 <span class="comment"></span>
00015 <span class="comment">    Robert Reichel  (RobertRe)  1-Mar-1991</span>
00016 <span class="comment"></span>
00017 <span class="comment">Environment:</span>
00018 <span class="comment"></span>
00019 <span class="comment">    Pure Runtime Library Routine</span>
00020 <span class="comment">    User mode callable only</span>
00021 <span class="comment"></span>
00022 <span class="comment">Revision History:</span>
00023 <span class="comment"></span>
00024 <span class="comment">--*/</span>
00025 
00026 
00027 <span class="preprocessor">#include &lt;<a class="code" href="../../d9/d8/ntos_8h.html">ntos.h</a>&gt;</span>
00028 <span class="preprocessor">#include &lt;nturtl.h&gt;</span>
00029 <span class="preprocessor">#include &lt;ntlsa.h&gt;</span>      <span class="comment">// needed for RtlGetPrimaryDomain</span>
00030 <span class="preprocessor">#include "seopaque.h"</span>
00031 <span class="preprocessor">#include "sertlp.h"</span>
00032 <span class="preprocessor">#include "<a class="code" href="../../d9/d2/ldrp_8h.html">ldrp.h</a>"</span>
00033 
00034 
00035 
00036 
00037 
00039 <span class="comment">//                                                                           //</span>
00040 <span class="comment">//    Exported Procedures                                                    //</span>
00041 <span class="comment">//                                                                           //</span>
00043 <span class="comment"></span>
00044 
00045 <span class="preprocessor">#if WHEN_LSAUDLL_MOVED_TO_NTDLL</span>
00046 <span class="preprocessor"></span><a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00047 RtlGetPrimaryDomain(
00048     IN  ULONG            SidLength,
00049     OUT PBOOLEAN         PrimaryDomainPresent,
00050     OUT PUNICODE_STRING  PrimaryDomainName,
00051     OUT PUSHORT          RequiredNameLength,
00052     OUT PSID             PrimaryDomainSid OPTIONAL,
00053     OUT PULONG           RequiredSidLength
00054     )
00055 
00056 <span class="comment">/*++</span>
00057 <span class="comment"></span>
00058 <span class="comment">Routine Description:</span>
00059 <span class="comment"></span>
00060 <span class="comment">    This procedure opens the LSA policy object and retrieves</span>
00061 <span class="comment">    the primary domain information for this machine.</span>
00062 <span class="comment"></span>
00063 <span class="comment">Arguments:</span>
00064 <span class="comment"></span>
00065 <span class="comment">    SidLength - Specifies the length of the PrimaryDomainSid</span>
00066 <span class="comment">        parameter.</span>
00067 <span class="comment"></span>
00068 <span class="comment">    PrimaryDomainPresent - Receives a boolean value indicating</span>
00069 <span class="comment">        whether this machine has a primary domain or not. TRUE</span>
00070 <span class="comment">        indicates the machine does have a primary domain. FALSE</span>
00071 <span class="comment">        indicates the machine does not.</span>
00072 <span class="comment"></span>
00073 <span class="comment">    PrimaryDomainName - Points to the unicode string to receive</span>
00074 <span class="comment">        the primary domain name.  This parameter will only be</span>
00075 <span class="comment">        used if there is a primary domain.</span>
00076 <span class="comment"></span>
00077 <span class="comment">    RequiredNameLength - Recevies the length of the primary</span>
00078 <span class="comment">        domain name (in bytes).  This parameter will only be</span>
00079 <span class="comment">        used if there is a primary domain.</span>
00080 <span class="comment"></span>
00081 <span class="comment">    PrimaryDomainSid - This optional parameter, if present,</span>
00082 <span class="comment">        points to a buffer to receive the primary domain's</span>
00083 <span class="comment">        SID.  This parameter will only be used if there is a</span>
00084 <span class="comment">        primary domain.</span>
00085 <span class="comment"></span>
00086 <span class="comment">    RequiredSidLength - Recevies the length of the primary</span>
00087 <span class="comment">        domain SID (in bytes).  This parameter will only be</span>
00088 <span class="comment">        used if there is a primary domain.</span>
00089 <span class="comment"></span>
00090 <span class="comment"></span>
00091 <span class="comment">Return Value:</span>
00092 <span class="comment"></span>
00093 <span class="comment">    STATUS_SUCCESS - The requested information has been retrieved.</span>
00094 <span class="comment"></span>
00095 <span class="comment">    STATUS_BUFFER_TOO_SMALL - One of the return buffers was not</span>
00096 <span class="comment">        large enough to receive the corresponding information.</span>
00097 <span class="comment">        The RequiredNameLength and RequiredSidLength parameter</span>
00098 <span class="comment">        values have been set to indicate the needed length.</span>
00099 <span class="comment"></span>
00100 <span class="comment">    Other status values as may be returned by:</span>
00101 <span class="comment"></span>
00102 <span class="comment">        LsaOpenPolicy()</span>
00103 <span class="comment">        LsaQueryInformationPolicy()</span>
00104 <span class="comment">        RtlCopySid()</span>
00105 <span class="comment"></span>
00106 <span class="comment"></span>
00107 <span class="comment">--*/</span>
00108 
00109 
00110 
00111 
00112 {
00113     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>, IgnoreStatus;
00114     OBJECT_ATTRIBUTES <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>;
00115     LSA_HANDLE LsaHandle;
00116     SECURITY_QUALITY_OF_SERVICE SecurityQualityOfService;
00117     PPOLICY_PRIMARY_DOMAIN_INFO PrimaryDomainInfo;
00118 
00119 
00120     <span class="comment">//</span>
00121     <span class="comment">// Set up the Security Quality Of Service</span>
00122     <span class="comment">//</span>
00123 
00124     SecurityQualityOfService.Length = <span class="keyword">sizeof</span>(SECURITY_QUALITY_OF_SERVICE);
00125     SecurityQualityOfService.ImpersonationLevel = SecurityImpersonation;
00126     SecurityQualityOfService.ContextTrackingMode = SECURITY_DYNAMIC_TRACKING;
00127     SecurityQualityOfService.EffectiveOnly = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00128 
00129     <span class="comment">//</span>
00130     <span class="comment">// Set up the object attributes to open the Lsa policy object</span>
00131     <span class="comment">//</span>
00132 
00133     InitializeObjectAttributes(&amp;ObjectAttributes,
00134                                NULL,
00135                                0L,
00136                                (HANDLE)NULL,
00137                                NULL);
00138     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>.SecurityQualityOfService = &amp;SecurityQualityOfService;
00139 
00140     <span class="comment">//</span>
00141     <span class="comment">// Open the local LSA policy object</span>
00142     <span class="comment">//</span>
00143 
00144     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = LsaOpenPolicy( NULL,
00145                             &amp;ObjectAttributes,
00146                             POLICY_VIEW_LOCAL_INFORMATION,
00147                             &amp;LsaHandle
00148                           );
00149     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00150 
00151         <span class="comment">//</span>
00152         <span class="comment">// Get the primary domain info</span>
00153         <span class="comment">//</span>
00154         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = LsaQueryInformationPolicy(LsaHandle,
00155                                            PolicyPrimaryDomainInformation,
00156                                            (PVOID *)&amp;PrimaryDomainInfo);
00157         IgnoreStatus = LsaClose(LsaHandle);
00158         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IgnoreStatus));
00159     }
00160 
00161     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00162 
00163         <span class="comment">//</span>
00164         <span class="comment">// Is there a primary domain?</span>
00165         <span class="comment">//</span>
00166 
00167         <span class="keywordflow">if</span> (PrimaryDomainInfo-&gt;Sid != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00168 
00169             <span class="comment">//</span>
00170             <span class="comment">// Yes</span>
00171             <span class="comment">//</span>
00172 
00173             (*PrimaryDomainPresent) = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00174             (*RequiredNameLength) = PrimaryDomainInfo-&gt;Name.Length;
00175             (*RequiredSidLength)  = <a class="code" href="../../d8/d6/sertl_8c.html#a45">RtlLengthSid</a>(PrimaryDomainInfo-&gt;Sid);
00176 
00177 
00178 
00179             <span class="comment">//</span>
00180             <span class="comment">// Copy the name</span>
00181             <span class="comment">//</span>
00182 
00183             <span class="keywordflow">if</span> (PrimaryDomainName-&gt;MaximumLength &gt;=
00184                 PrimaryDomainInfo-&gt;Name.Length) {
00185                 <a class="code" href="../../d6/d6/nls_8c.html#a44">RtlCopyUnicodeString</a>(
00186                     PrimaryDomainName,
00187                     &amp;PrimaryDomainInfo-&gt;Name
00188                     );
00189             } <span class="keywordflow">else</span> {
00190                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_BUFFER_TOO_SMALL;
00191             }
00192 
00193 
00194             <span class="comment">//</span>
00195             <span class="comment">// Copy the SID (if appropriate)</span>
00196             <span class="comment">//</span>
00197 
00198             <span class="keywordflow">if</span> (PrimaryDomainSid != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00199 
00200                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a46">RtlCopySid</a>(SidLength,
00201                                     PrimaryDomainSid,
00202                                     PrimaryDomainInfo-&gt;Sid
00203                                     );
00204             }
00205         } <span class="keywordflow">else</span> {
00206 
00207             (*PrimaryDomainPresent) = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00208         }
00209 
00210         <span class="comment">//</span>
00211         <span class="comment">// We're finished with the buffer returned by LSA</span>
00212         <span class="comment">//</span>
00213 
00214         IgnoreStatus = LsaFreeMemory(PrimaryDomainInfo);
00215         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IgnoreStatus));
00216 
00217     }
00218 
00219 
00220     <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00221 }
00222 <span class="preprocessor">#endif //WHEN_LSAUDLL_MOVED_TO_NTDLL</span>
00223 <span class="preprocessor"></span>
00224 
00225 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00226"></a><a class="code" href="../../d4/d8/seurtl_8c.html#a0">00226</a> <a class="code" href="../../d4/d8/seurtl_8c.html#a0">RtlNewSecurityObjectEx</a> (
00227     IN PSECURITY_DESCRIPTOR ParentDescriptor OPTIONAL,
00228     IN PSECURITY_DESCRIPTOR CreatorDescriptor OPTIONAL,
00229     OUT PSECURITY_DESCRIPTOR * NewDescriptor,
00230     IN GUID *ObjectType OPTIONAL,
00231     IN BOOLEAN IsDirectoryObject,
00232     IN ULONG AutoInheritFlags,
00233     IN HANDLE Token OPTIONAL,
00234     IN PGENERIC_MAPPING GenericMapping
00235     )
00236 <span class="comment">/*++</span>
00237 <span class="comment"></span>
00238 <span class="comment">Routine Description:</span>
00239 <span class="comment"></span>
00240 <span class="comment">    See RtlpNewSecurityObject.</span>
00241 <span class="comment"></span>
00242 <span class="comment">                              - - WARNING - -</span>
00243 <span class="comment"></span>
00244 <span class="comment">    This service is for use by protected subsystems that project their own</span>
00245 <span class="comment">    type of object.  This service is explicitly not for use by the</span>
00246 <span class="comment">    executive for executive objects and must not be called from kernel</span>
00247 <span class="comment">    mode.</span>
00248 <span class="comment"></span>
00249 <span class="comment">Arguments:</span>
00250 <span class="comment"></span>
00251 <span class="comment">    See RtlpNewSecurityObject.</span>
00252 <span class="comment"></span>
00253 <span class="comment">Return Value:</span>
00254 <span class="comment"></span>
00255 <span class="comment">    See RtlpNewSecurityObject.</span>
00256 <span class="comment"></span>
00257 <span class="comment">--*/</span>
00258 {
00259 
00260     <span class="comment">//</span>
00261     <span class="comment">// Simple call the newer RtlpNewSecurityObject</span>
00262     <span class="comment">//</span>
00263 
00264     <span class="keywordflow">return</span> <a class="code" href="../../d8/d6/sertl_8c.html#a76">RtlpNewSecurityObject</a> (
00265                 ParentDescriptor,
00266                 CreatorDescriptor,
00267                 NewDescriptor,
00268                 ObjectType,
00269                 IsDirectoryObject,
00270                 AutoInheritFlags,
00271                 <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>,
00272                 GenericMapping );
00273 
00274 }
00275 
00276 
00277 
00278 
00279 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00280"></a><a class="code" href="../../d4/d8/seurtl_8c.html#a1">00280</a> <a class="code" href="../../d4/d8/seurtl_8c.html#a1">RtlNewSecurityObject</a> (
00281     IN PSECURITY_DESCRIPTOR ParentDescriptor OPTIONAL,
00282     IN PSECURITY_DESCRIPTOR CreatorDescriptor OPTIONAL,
00283     OUT PSECURITY_DESCRIPTOR * NewDescriptor,
00284     IN BOOLEAN IsDirectoryObject,
00285     IN HANDLE Token,
00286     IN PGENERIC_MAPPING GenericMapping
00287     )
00288 <span class="comment">/*++</span>
00289 <span class="comment"></span>
00290 <span class="comment">Routine Description:</span>
00291 <span class="comment"></span>
00292 <span class="comment">    See RtlpNewSecurityObject.</span>
00293 <span class="comment"></span>
00294 <span class="comment">                              - - WARNING - -</span>
00295 <span class="comment"></span>
00296 <span class="comment">    This service is for use by protected subsystems that project their own</span>
00297 <span class="comment">    type of object.  This service is explicitly not for use by the</span>
00298 <span class="comment">    executive for executive objects and must not be called from kernel</span>
00299 <span class="comment">    mode.</span>
00300 <span class="comment"></span>
00301 <span class="comment">Arguments:</span>
00302 <span class="comment"></span>
00303 <span class="comment">    See RtlpNewSecurityObject.</span>
00304 <span class="comment"></span>
00305 <span class="comment">Return Value:</span>
00306 <span class="comment"></span>
00307 <span class="comment">    See RtlpNewSecurityObject.</span>
00308 <span class="comment"></span>
00309 <span class="comment">--*/</span>
00310 {
00311 
00312     <span class="comment">//</span>
00313     <span class="comment">// Simple call the newer RtlpNewSecurityObject</span>
00314     <span class="comment">//</span>
00315 
00316     <span class="keywordflow">return</span> <a class="code" href="../../d8/d6/sertl_8c.html#a76">RtlpNewSecurityObject</a> (
00317                 ParentDescriptor,
00318                 CreatorDescriptor,
00319                 NewDescriptor,
00320                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,   <span class="comment">// No ObjectType</span>
00321                 IsDirectoryObject,
00322                 0,      <span class="comment">// No Automatic inheritance</span>
00323                 <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>,
00324                 GenericMapping );
00325 
00326 }
00327 
00328 
00329 
00330 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00331"></a><a class="code" href="../../d4/d8/seurtl_8c.html#a2">00331</a> <a class="code" href="../../d4/d8/seurtl_8c.html#a2">RtlSetSecurityObject</a> (
00332     IN SECURITY_INFORMATION SecurityInformation,
00333     IN PSECURITY_DESCRIPTOR ModificationDescriptor,
00334     IN OUT PSECURITY_DESCRIPTOR *ObjectsSecurityDescriptor,
00335     IN PGENERIC_MAPPING GenericMapping,
00336     IN HANDLE Token OPTIONAL
00337     )
00338 <span class="comment">/*++</span>
00339 <span class="comment"></span>
00340 <span class="comment">Routine Description:</span>
00341 <span class="comment"></span>
00342 <span class="comment">    See RtlpSetSecurityObject.</span>
00343 <span class="comment"></span>
00344 <span class="comment">Arguments:</span>
00345 <span class="comment"></span>
00346 <span class="comment">    See RtlpSetSecurityObject.</span>
00347 <span class="comment"></span>
00348 <span class="comment">Return Value:</span>
00349 <span class="comment"></span>
00350 <span class="comment">    See RtlpSetSecurityObject.</span>
00351 <span class="comment"></span>
00352 <span class="comment">--*/</span>
00353 
00354 {
00355 
00356     <span class="comment">//</span>
00357     <span class="comment">// Simply call RtlpSetSecurityObject specifying no auto inheritance.</span>
00358     <span class="comment">//</span>
00359 
00360     <span class="keywordflow">return</span> <a class="code" href="../../d8/d6/sertl_8c.html#a77">RtlpSetSecurityObject</a>( <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00361                                   SecurityInformation,
00362                                   ModificationDescriptor,
00363                                   ObjectsSecurityDescriptor,
00364                                   0,   <span class="comment">// No AutoInheritance</span>
00365                                   <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
00366                                   GenericMapping,
00367                                   <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00368 }
00369 
00370 
00371 
00372 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00373"></a><a class="code" href="../../d4/d8/seurtl_8c.html#a3">00373</a> <a class="code" href="../../d4/d8/seurtl_8c.html#a3">RtlSetSecurityObjectEx</a> (
00374     IN SECURITY_INFORMATION SecurityInformation,
00375     IN PSECURITY_DESCRIPTOR ModificationDescriptor,
00376     IN OUT PSECURITY_DESCRIPTOR *ObjectsSecurityDescriptor,
00377     IN ULONG AutoInheritFlags,
00378     IN PGENERIC_MAPPING GenericMapping,
00379     IN HANDLE Token OPTIONAL
00380     )
00381 <span class="comment">/*++</span>
00382 <span class="comment"></span>
00383 <span class="comment">Routine Description:</span>
00384 <span class="comment"></span>
00385 <span class="comment">    See RtlpSetSecurityObject.</span>
00386 <span class="comment"></span>
00387 <span class="comment">Arguments:</span>
00388 <span class="comment"></span>
00389 <span class="comment">    See RtlpSetSecurityObject.</span>
00390 <span class="comment"></span>
00391 <span class="comment">Return Value:</span>
00392 <span class="comment"></span>
00393 <span class="comment">    See RtlpSetSecurityObject.</span>
00394 <span class="comment"></span>
00395 <span class="comment">--*/</span>
00396 
00397 {
00398 
00399     <span class="comment">//</span>
00400     <span class="comment">// Simply call RtlpSetSecurityObject specifying no auto inheritance.</span>
00401     <span class="comment">//</span>
00402 
00403     <span class="keywordflow">return</span> <a class="code" href="../../d8/d6/sertl_8c.html#a77">RtlpSetSecurityObject</a>( <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00404                                   SecurityInformation,
00405                                   ModificationDescriptor,
00406                                   ObjectsSecurityDescriptor,
00407                                   AutoInheritFlags,
00408                                   <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
00409                                   GenericMapping,
00410                                   <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00411 }
00412 
00413 
00414 
00415 
00416 
00417 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00418"></a><a class="code" href="../../d4/d8/seurtl_8c.html#a4">00418</a> <a class="code" href="../../d4/d8/seurtl_8c.html#a4">RtlQuerySecurityObject</a> (
00419     IN PSECURITY_DESCRIPTOR ObjectDescriptor,
00420     IN SECURITY_INFORMATION SecurityInformation,
00421     OUT PSECURITY_DESCRIPTOR ResultantDescriptor,
00422     IN ULONG DescriptorLength,
00423     OUT PULONG ReturnLength
00424     )
00425 
00426 <span class="comment">/*++</span>
00427 <span class="comment"></span>
00428 <span class="comment">Routine Description:</span>
00429 <span class="comment"></span>
00430 <span class="comment">    Query information from a protected server object's existing security</span>
00431 <span class="comment">    descriptor.</span>
00432 <span class="comment"></span>
00433 <span class="comment">    This procedure, called only from user mode, is used to retrieve</span>
00434 <span class="comment">    information from a security descriptor on an existing protected</span>
00435 <span class="comment">    server's object.  All access checking is expected to be done before</span>
00436 <span class="comment">    calling this routine.  This includes checking for READ_CONTROL, and</span>
00437 <span class="comment">    privilege to read a system ACL as appropriate.</span>
00438 <span class="comment"></span>
00439 <span class="comment">                          - - WARNING - -</span>
00440 <span class="comment"></span>
00441 <span class="comment">    This service is for use by protected subsystems that project their own</span>
00442 <span class="comment">    type of object.  This service is explicitly not for use by the</span>
00443 <span class="comment">    executive for executive objects and must not be called from kernel</span>
00444 <span class="comment">    mode.</span>
00445 <span class="comment"></span>
00446 <span class="comment"></span>
00447 <span class="comment">Arguments:</span>
00448 <span class="comment"></span>
00449 <span class="comment">    ObjectDescriptor - Points to a pointer to a security descriptor to be</span>
00450 <span class="comment">        queried.</span>
00451 <span class="comment"></span>
00452 <span class="comment">    SecurityInformation - Identifies the security information being</span>
00453 <span class="comment">        requested.</span>
00454 <span class="comment"></span>
00455 <span class="comment">    ResultantDescriptor - Points to buffer to receive the resultant</span>
00456 <span class="comment">        security descriptor.  The resultant security descriptor will</span>
00457 <span class="comment">        contain all information requested by the SecurityInformation</span>
00458 <span class="comment">        parameter.</span>
00459 <span class="comment"></span>
00460 <span class="comment">    DescriptorLength - Is an unsigned integer which indicates the length,</span>
00461 <span class="comment">        in bytes, of the buffer provided to receive the resultant</span>
00462 <span class="comment">        descriptor.</span>
00463 <span class="comment"></span>
00464 <span class="comment">    ReturnLength - Receives an unsigned integer indicating the actual</span>
00465 <span class="comment">        number of bytes needed in the ResultantDescriptor to store the</span>
00466 <span class="comment">        requested information.  If the value returned is greater than the</span>
00467 <span class="comment">        value passed via the DescriptorLength parameter, then</span>
00468 <span class="comment">        STATUS_BUFFER_TOO_SMALL is returned and no information is returned.</span>
00469 <span class="comment"></span>
00470 <span class="comment"></span>
00471 <span class="comment">Return Value:</span>
00472 <span class="comment"></span>
00473 <span class="comment">    STATUS_SUCCESS - The operation was successful.</span>
00474 <span class="comment"></span>
00475 <span class="comment">    STATUS_BUFFER_TOO_SMALL - The buffer provided to receive the requested</span>
00476 <span class="comment">        information was not large enough to hold the information.  No</span>
00477 <span class="comment">        information has been returned.</span>
00478 <span class="comment"></span>
00479 <span class="comment">    STATUS_BAD_DESCRIPTOR_FORMAT - Indicates the provided object's security</span>
00480 <span class="comment">        descriptor was not in self-relative format.</span>
00481 <span class="comment"></span>
00482 <span class="comment">--*/</span>
00483 
00484 {
00485 
00486     PSID <a class="code" href="../../d6/d0/ctaccess_8c.html#a54">Group</a>;
00487     PSID <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a>;
00488     PACL <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a>;
00489     PACL Sacl;
00490 
00491     ULONG GroupSize = 0;
00492     ULONG DaclSize = 0;
00493     ULONG SaclSize = 0;
00494     ULONG OwnerSize = 0;
00495 
00496     PCHAR Field;
00497     PCHAR Base;
00498 
00499 
00500     PISECURITY_DESCRIPTOR IObjectDescriptor;
00501     PISECURITY_DESCRIPTOR_RELATIVE IResultantDescriptor;
00502 
00503 
00504     IResultantDescriptor = (PISECURITY_DESCRIPTOR_RELATIVE)ResultantDescriptor;
00505     IObjectDescriptor = (PISECURITY_DESCRIPTOR)ObjectDescriptor;
00506 
00507     <span class="comment">//</span>
00508     <span class="comment">// For each item specified in the SecurityInformation, extract it</span>
00509     <span class="comment">// and get it to the point where it can be copied into a new</span>
00510     <span class="comment">// descriptor.</span>
00511     <span class="comment">//</span>
00512 
00513     <span class="keywordflow">if</span> (SecurityInformation &amp; GROUP_SECURITY_INFORMATION) {
00514 
00515         <a class="code" href="../../d6/d0/ctaccess_8c.html#a54">Group</a> = RtlpGroupAddrSecurityDescriptor(IObjectDescriptor);
00516         GroupSize = LongAlignSize(<a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>(<a class="code" href="../../d6/d0/ctaccess_8c.html#a54">Group</a>));
00517     }
00518 
00519     <span class="keywordflow">if</span> (SecurityInformation &amp; DACL_SECURITY_INFORMATION) {
00520 
00521         <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a> = RtlpDaclAddrSecurityDescriptor( IObjectDescriptor );
00522 
00523         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00524             DaclSize = LongAlignSize(<a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a>-&gt;AclSize);
00525         }
00526     }
00527 
00528     <span class="keywordflow">if</span> (SecurityInformation &amp; SACL_SECURITY_INFORMATION) {
00529 
00530         Sacl = RtlpSaclAddrSecurityDescriptor( IObjectDescriptor );
00531 
00532         <span class="keywordflow">if</span> (Sacl != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00533             SaclSize = LongAlignSize(Sacl-&gt;AclSize);
00534         }
00535 
00536     }
00537 
00538     <span class="keywordflow">if</span> (SecurityInformation &amp; OWNER_SECURITY_INFORMATION) {
00539 
00540         <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a> = RtlpOwnerAddrSecurityDescriptor ( IObjectDescriptor );
00541         OwnerSize = LongAlignSize(<a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>(<a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a>));
00542     }
00543 
00544     *ReturnLength = <span class="keyword">sizeof</span>( SECURITY_DESCRIPTOR_RELATIVE ) +
00545                     GroupSize +
00546                     DaclSize  +
00547                     SaclSize  +
00548                     OwnerSize;
00549 
00550     <span class="keywordflow">if</span> (*ReturnLength &gt; DescriptorLength) {
00551         <span class="keywordflow">return</span>( STATUS_BUFFER_TOO_SMALL );
00552     }
00553 
00554     <a class="code" href="../../d8/d6/sertl_8c.html#a53">RtlCreateSecurityDescriptor</a>(
00555         IResultantDescriptor,
00556         SECURITY_DESCRIPTOR_REVISION
00557         );
00558 
00559     RtlpSetControlBits( IResultantDescriptor, SE_SELF_RELATIVE );
00560 
00561     Base = (PCHAR)(IResultantDescriptor);
00562     Field =  Base + (ULONG)<span class="keyword">sizeof</span>(SECURITY_DESCRIPTOR_RELATIVE);
00563 
00564     <span class="keywordflow">if</span> (SecurityInformation &amp; SACL_SECURITY_INFORMATION) {
00565 
00566         <span class="keywordflow">if</span> (SaclSize &gt; 0) {
00567             RtlMoveMemory( Field, Sacl, SaclSize );
00568             IResultantDescriptor-&gt;Sacl = RtlPointerToOffset(Base,Field);
00569             Field += SaclSize;
00570         }
00571 
00572         RtlpPropagateControlBits(
00573             IResultantDescriptor,
00574             IObjectDescriptor,
00575             SE_SACL_PRESENT | SE_SACL_DEFAULTED
00576             );
00577     }
00578 
00579     <span class="keywordflow">if</span> (SecurityInformation &amp; DACL_SECURITY_INFORMATION) {
00580 
00581         <span class="keywordflow">if</span> (DaclSize &gt; 0) {
00582             RtlMoveMemory( Field, <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a>, DaclSize );
00583             IResultantDescriptor-&gt;Dacl = RtlPointerToOffset(Base,Field);
00584             Field += DaclSize;
00585         }
00586 
00587         RtlpPropagateControlBits(
00588             IResultantDescriptor,
00589             IObjectDescriptor,
00590             SE_DACL_PRESENT | SE_DACL_DEFAULTED
00591             );
00592     }
00593 
00594     <span class="keywordflow">if</span> (SecurityInformation &amp; OWNER_SECURITY_INFORMATION) {
00595 
00596         <span class="keywordflow">if</span> (OwnerSize &gt; 0) {
00597             RtlMoveMemory( Field, <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a>, OwnerSize );
00598             IResultantDescriptor-&gt;Owner = RtlPointerToOffset(Base,Field);
00599             Field += OwnerSize;
00600         }
00601 
00602         RtlpPropagateControlBits(
00603             IResultantDescriptor,
00604             IObjectDescriptor,
00605             SE_OWNER_DEFAULTED
00606             );
00607 
00608     }
00609 
00610     <span class="keywordflow">if</span> (SecurityInformation &amp; GROUP_SECURITY_INFORMATION) {
00611 
00612         <span class="keywordflow">if</span> (GroupSize &gt; 0) {
00613             RtlMoveMemory( Field, <a class="code" href="../../d6/d0/ctaccess_8c.html#a54">Group</a>, GroupSize );
00614             IResultantDescriptor-&gt;Group = RtlPointerToOffset(Base,Field);
00615         }
00616 
00617         RtlpPropagateControlBits(
00618             IResultantDescriptor,
00619             IObjectDescriptor,
00620             SE_GROUP_DEFAULTED
00621             );
00622     }
00623 
00624     <span class="keywordflow">return</span>( STATUS_SUCCESS );
00625 
00626 }
00627 
00628 
00629 
00630 
00631 
00632 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00633"></a><a class="code" href="../../d4/d8/seurtl_8c.html#a5">00633</a> <a class="code" href="../../d4/d8/seurtl_8c.html#a5">RtlDeleteSecurityObject</a> (
00634     IN OUT PSECURITY_DESCRIPTOR * ObjectDescriptor
00635     )
00636 
00637 
00638 <span class="comment">/*++</span>
00639 <span class="comment"></span>
00640 <span class="comment">Routine Description:</span>
00641 <span class="comment"></span>
00642 <span class="comment">    Delete a protected server object's security descriptor.</span>
00643 <span class="comment"></span>
00644 <span class="comment">    This procedure, called only from user mode, is used to delete a</span>
00645 <span class="comment">    security descriptor associated with a protected server's object.  This</span>
00646 <span class="comment">    routine will normally be called by a protected server during object</span>
00647 <span class="comment">    deletion.</span>
00648 <span class="comment"></span>
00649 <span class="comment">                                  - - WARNING - -</span>
00650 <span class="comment"></span>
00651 <span class="comment">    This service is for use by protected subsystems that project their own</span>
00652 <span class="comment">    type of object.  This service is explicitly not for use by the</span>
00653 <span class="comment">    executive for executive objects and must not be called from kernel</span>
00654 <span class="comment">    mode.</span>
00655 <span class="comment"></span>
00656 <span class="comment"></span>
00657 <span class="comment">Arguments:</span>
00658 <span class="comment"></span>
00659 <span class="comment">    ObjectDescriptor - Points to a pointer to a security descriptor to be</span>
00660 <span class="comment">        deleted.</span>
00661 <span class="comment"></span>
00662 <span class="comment"></span>
00663 <span class="comment">Return Value:</span>
00664 <span class="comment"></span>
00665 <span class="comment">    STATUS_SUCCESS - The operation was successful.</span>
00666 <span class="comment"></span>
00667 <span class="comment">--*/</span>
00668 
00669 {
00670     <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>( RtlProcessHeap(), 0, (PVOID)*ObjectDescriptor );
00671 
00672     <span class="keywordflow">return</span>( STATUS_SUCCESS );
00673 
00674 }
00675 
00676 
00677 
00678 
00679 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00680"></a><a class="code" href="../../d4/d8/seurtl_8c.html#a6">00680</a> <a class="code" href="../../d4/d8/seurtl_8c.html#a6">RtlNewInstanceSecurityObject</a>(
00681     IN BOOLEAN ParentDescriptorChanged,
00682     IN BOOLEAN CreatorDescriptorChanged,
00683     IN PLUID OldClientTokenModifiedId,
00684     OUT PLUID NewClientTokenModifiedId,
00685     IN PSECURITY_DESCRIPTOR ParentDescriptor OPTIONAL,
00686     IN PSECURITY_DESCRIPTOR CreatorDescriptor OPTIONAL,
00687     OUT PSECURITY_DESCRIPTOR * NewDescriptor,
00688     IN BOOLEAN IsDirectoryObject,
00689     IN HANDLE Token,
00690     IN PGENERIC_MAPPING GenericMapping
00691     )
00692 
00693 <span class="comment">/*++</span>
00694 <span class="comment"></span>
00695 <span class="comment">Routine Description:</span>
00696 <span class="comment"></span>
00697 <span class="comment">    If the return status is STATUS_SUCCESS and the NewSecurity return</span>
00698 <span class="comment">    value is NULL, then the security desscriptor of the original</span>
00699 <span class="comment">    instance of the object is valid for this instance as well.</span>
00700 <span class="comment"></span>
00701 <span class="comment">Arguments:</span>
00702 <span class="comment"></span>
00703 <span class="comment">    ParentDescriptorChanged - Supplies a flag indicating whether the</span>
00704 <span class="comment">        parent security descriptor has changed since the last time</span>
00705 <span class="comment">        this set of parameters was used.</span>
00706 <span class="comment"></span>
00707 <span class="comment">    CreatorDescriptorChanged - Supplies a flag indicating whether the</span>
00708 <span class="comment">        creator security descriptor has changed since the last time</span>
00709 <span class="comment">        this set of parameters was used.</span>
00710 <span class="comment"></span>
00711 <span class="comment">    OldClientTokenModifiedId - Supplies the ModifiedId from the passed</span>
00712 <span class="comment">        token that was in effect when this call was last made with</span>
00713 <span class="comment">        these parameters.  If the current ModifiedId is different from</span>
00714 <span class="comment">        the one passed in here, the security descriptor must be</span>
00715 <span class="comment">        rebuilt.</span>
00716 <span class="comment"></span>
00717 <span class="comment">    NewClientTokenModifiedId - Returns the current ModifiedId from the</span>
00718 <span class="comment">        passed token.</span>
00719 <span class="comment"></span>
00720 <span class="comment">    ParentDescriptor - Supplies the Security Descriptor for the parent</span>
00721 <span class="comment">        directory under which a new object is being created.  If there is</span>
00722 <span class="comment">        no parent directory, then this argument is specified as NULL.</span>
00723 <span class="comment"></span>
00724 <span class="comment">    CreatorDescriptor - (Optionally) Points to a security descriptor</span>
00725 <span class="comment">        presented by the creator of the object.  If the creator of the</span>
00726 <span class="comment">        object did not explicitly pass security information for the new</span>
00727 <span class="comment">        object, then a null pointer should be passed.</span>
00728 <span class="comment"></span>
00729 <span class="comment">    NewDescriptor - Points to a pointer that is to be made to point to the</span>
00730 <span class="comment">        newly allocated self-relative security descriptor.</span>
00731 <span class="comment"></span>
00732 <span class="comment">    IsDirectoryObject - Specifies if the new object is going to be a</span>
00733 <span class="comment">        directory object.  A value of TRUE indicates the object is a</span>
00734 <span class="comment">        container of other objects.</span>
00735 <span class="comment"></span>
00736 <span class="comment">    Token - Supplies the token for the client on whose behalf the</span>
00737 <span class="comment">        object is being created.  If it is an impersonation token,</span>
00738 <span class="comment">        then it must be at SecurityIdentification level or higher.  If</span>
00739 <span class="comment">        it is not an impersonation token, the operation proceeds</span>
00740 <span class="comment">        normally.</span>
00741 <span class="comment"></span>
00742 <span class="comment">        A client token is used to retrieve default security</span>
00743 <span class="comment">        information for the new object, such as default owner, primary</span>
00744 <span class="comment">        group, and discretionary access control.  The token must be</span>
00745 <span class="comment">        open for TOKEN_QUERY access.</span>
00746 <span class="comment"></span>
00747 <span class="comment">    GenericMapping - Supplies a pointer to a generic mapping array denoting</span>
00748 <span class="comment">        the mapping between each generic right to specific rights.</span>
00749 <span class="comment"></span>
00750 <span class="comment">Return Value:</span>
00751 <span class="comment"></span>
00752 <span class="comment">    return-value - Description of conditions needed to return value. - or -</span>
00753 <span class="comment">    None.</span>
00754 <span class="comment"></span>
00755 <span class="comment">--*/</span>
00756 
00757 {
00758 
00759     TOKEN_STATISTICS <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a17">ClientTokenStatistics</a>;
00760     ULONG ReturnLength;
00761     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00762 
00763 
00764 
00765     <span class="comment">//</span>
00766     <span class="comment">// Get the current token modified LUID</span>
00767     <span class="comment">//</span>
00768 
00769 
00770     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
00771                  <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>,                        <span class="comment">// Handle</span>
00772                  TokenStatistics,              <span class="comment">// TokenInformationClass</span>
00773                  &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a17">ClientTokenStatistics</a>,       <span class="comment">// TokenInformation</span>
00774                  <span class="keyword">sizeof</span>(TOKEN_STATISTICS),     <span class="comment">// TokenInformationLength</span>
00775                  &amp;ReturnLength                 <span class="comment">// ReturnLength</span>
00776                  );
00777 
00778     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00779         <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00780     }
00781 
00782     *NewClientTokenModifiedId = <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a17">ClientTokenStatistics</a>.ModifiedId;
00783 
00784     <span class="keywordflow">if</span> ( <a class="code" href="../../d8/d6/sertl_8c.html#a50">RtlEqualLuid</a>(NewClientTokenModifiedId, OldClientTokenModifiedId) ) {
00785 
00786         <span class="keywordflow">if</span> ( !(ParentDescriptorChanged || CreatorDescriptorChanged) ) {
00787 
00788             <span class="comment">//</span>
00789             <span class="comment">// The old security descriptor is valid for this new instance</span>
00790             <span class="comment">// of the object type as well.  Pass back success and NULL for</span>
00791             <span class="comment">// the NewDescriptor.</span>
00792             <span class="comment">//</span>
00793 
00794             *NewDescriptor = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00795             <span class="keywordflow">return</span>( STATUS_SUCCESS );
00796 
00797         }
00798     }
00799 
00800     <span class="comment">//</span>
00801     <span class="comment">// Something has changed, take the long route and build a new</span>
00802     <span class="comment">// descriptor</span>
00803     <span class="comment">//</span>
00804 
00805     <span class="keywordflow">return</span>( <a class="code" href="../../d4/d8/seurtl_8c.html#a1">RtlNewSecurityObject</a>( ParentDescriptor,
00806                                   CreatorDescriptor,
00807                                   NewDescriptor,
00808                                   IsDirectoryObject,
00809                                   <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>,
00810                                   GenericMapping
00811                                   ));
00812 }
00813 
00814 
00815 
00816 
00817 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00818"></a><a class="code" href="../../d4/d8/seurtl_8c.html#a7">00818</a> <a class="code" href="../../d4/d8/seurtl_8c.html#a7">RtlNewSecurityGrantedAccess</a>(
00819     IN ACCESS_MASK DesiredAccess,
00820     OUT PPRIVILEGE_SET Privileges,
00821     IN OUT PULONG Length,
00822     IN HANDLE Token OPTIONAL,
00823     IN PGENERIC_MAPPING GenericMapping,
00824     OUT PACCESS_MASK RemainingDesiredAccess
00825     )
00826 
00827 <span class="comment">/*++</span>
00828 <span class="comment"></span>
00829 <span class="comment">Routine Description:</span>
00830 <span class="comment"></span>
00831 <span class="comment">    This routine implements privilege policy by examining the bits in</span>
00832 <span class="comment">    a DesiredAccess mask and adjusting them based on privilege checks.</span>
00833 <span class="comment"></span>
00834 <span class="comment">    Currently, a request for ACCESS_SYSTEM_SECURITY may only be satisfied</span>
00835 <span class="comment">    by the caller having SeSecurityPrivilege.</span>
00836 <span class="comment"></span>
00837 <span class="comment">    Note that this routine is only to be called when an object is being</span>
00838 <span class="comment">    created.  When an object is being opened, it is expected that</span>
00839 <span class="comment">    NtAccessCheck will be called, and that routine will implement</span>
00840 <span class="comment">    another policy for substituting privileges for DACL access.</span>
00841 <span class="comment"></span>
00842 <span class="comment">Arguments:</span>
00843 <span class="comment"></span>
00844 <span class="comment">    DesiredAccess - Supplies the user's desired access mask</span>
00845 <span class="comment"></span>
00846 <span class="comment">    Privileges - Supplies a pointer to an empty buffer in which will</span>
00847 <span class="comment">        be returned a privilege set describing any privileges that were</span>
00848 <span class="comment">        used to gain access.</span>
00849 <span class="comment"></span>
00850 <span class="comment">        Note that this is not an optional parameter, that is, enough</span>
00851 <span class="comment">        room for a single privilege must always be passed.</span>
00852 <span class="comment"></span>
00853 <span class="comment">    Length - Supplies the length of the Privileges parameter in bytes.</span>
00854 <span class="comment">        If the supplies length is not adequate to store the entire</span>
00855 <span class="comment">        privilege set, this field will return the minimum length required.</span>
00856 <span class="comment"></span>
00857 <span class="comment">    Token - (optionally) Supplies the token for the client on whose</span>
00858 <span class="comment">        behalf the object is being accessed.  If this value is</span>
00859 <span class="comment">        specified as null, then the token on the thread is opened and</span>
00860 <span class="comment">        examined to see if it is an impersonation token.  If it is,</span>
00861 <span class="comment">        then it must be at SecurityIdentification level or higher.  If</span>
00862 <span class="comment">        it is not an impersonation token, the operation proceeds</span>
00863 <span class="comment">        normally.</span>
00864 <span class="comment"></span>
00865 <span class="comment">    GenericMapping - Supplies the generic mapping associated with this</span>
00866 <span class="comment">        object type.</span>
00867 <span class="comment"></span>
00868 <span class="comment">    RemainingDesiredAccess - Returns the DesiredAccess mask after any bits</span>
00869 <span class="comment">        have been masked off.  If no access types could be granted, this</span>
00870 <span class="comment">        mask will be identical to the one passed in.</span>
00871 <span class="comment"></span>
00872 <span class="comment">Return Value:</span>
00873 <span class="comment"></span>
00874 <span class="comment">    STATUS_SUCCESS - The operation completed successfully.</span>
00875 <span class="comment"></span>
00876 <span class="comment">    STATUS_BUFFER_TOO_SMALL - The passed buffer was not large enough</span>
00877 <span class="comment">        to contain the information being returned.</span>
00878 <span class="comment"></span>
00879 <span class="comment">    STATUS_BAD_IMPERSONATION_LEVEL - The caller or passed token was</span>
00880 <span class="comment">        impersonating, but not at a high enough level.</span>
00881 <span class="comment"></span>
00882 <span class="comment"></span>
00883 <span class="comment">--*/</span>
00884 
00885 {
00886     PRIVILEGE_SET RequiredPrivilege;
00887     BOOLEAN Result = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00888     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00889     ULONG PrivilegeCount = 0;
00890     HANDLE ThreadToken;
00891     BOOLEAN TokenPassed;
00892     TOKEN_STATISTICS ThreadTokenStatistics;
00893     ULONG ReturnLength;
00894     ULONG SizeRequired;
00895     ULONG PrivilegeNumber = 0;
00896 
00897 
00898     <span class="comment">//</span>
00899     <span class="comment">//  If the caller hasn't passed a token, call the kernel and get</span>
00900     <span class="comment">//  his impersonation token.  This call will fail if the caller is</span>
00901     <span class="comment">//  not impersonating a client, so if the caller is not</span>
00902     <span class="comment">//  impersonating someone, he'd better have passed in an explicit</span>
00903     <span class="comment">//  token.</span>
00904     <span class="comment">//</span>
00905 
00906     <span class="keywordflow">if</span> (!ARGUMENT_PRESENT( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> )) {
00907 
00908         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d3/tokenopn_8c.html#a3">NtOpenThreadToken</a>(
00909                      NtCurrentThread(),
00910                      TOKEN_QUERY,
00911                      <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00912                      &amp;ThreadToken
00913                      );
00914 
00915         TokenPassed = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00916 
00917         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00918             <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00919         }
00920 
00921     } <span class="keywordflow">else</span> {
00922 
00923         ThreadToken = <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>;
00924         TokenPassed = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00925     }
00926 
00927     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
00928                  ThreadToken,                  <span class="comment">// Handle</span>
00929                  TokenStatistics,              <span class="comment">// TokenInformationClass</span>
00930                  &amp;ThreadTokenStatistics,       <span class="comment">// TokenInformation</span>
00931                  <span class="keyword">sizeof</span>(TOKEN_STATISTICS),     <span class="comment">// TokenInformationLength</span>
00932                  &amp;ReturnLength                 <span class="comment">// ReturnLength</span>
00933                  );
00934 
00935     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) );
00936 
00937     <a class="code" href="../../d8/d6/sertl_8c.html#a70">RtlMapGenericMask</a>(
00938         &amp;DesiredAccess,
00939         GenericMapping
00940         );
00941 
00942     *RemainingDesiredAccess = DesiredAccess;
00943 
00944     <span class="keywordflow">if</span> ( DesiredAccess &amp; ACCESS_SYSTEM_SECURITY ) {
00945 
00946         RequiredPrivilege.PrivilegeCount = 1;
00947         RequiredPrivilege.Control = PRIVILEGE_SET_ALL_NECESSARY;
00948         RequiredPrivilege.Privilege[0].Luid = RtlConvertLongToLuid(SE_SECURITY_PRIVILEGE);
00949         RequiredPrivilege.Privilege[0].Attributes = 0;
00950 
00951         <span class="comment">//</span>
00952         <span class="comment">// NtPrivilegeCheck will make sure we are impersonating</span>
00953         <span class="comment">// properly.</span>
00954         <span class="comment">//</span>
00955 
00956         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d4/privileg_8c.html#a2">NtPrivilegeCheck</a>(
00957                      ThreadToken,
00958                      &amp;RequiredPrivilege,
00959                      &amp;Result
00960                      );
00961 
00962         <span class="keywordflow">if</span> ( (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> ( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) || (!Result) ) {
00963 
00964             <span class="keywordflow">if</span> (!TokenPassed) {
00965                 <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( ThreadToken );
00966             }
00967 
00968             <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00969                 <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00970             }
00971 
00972             <span class="keywordflow">if</span> ( !Result ) {
00973                 <span class="keywordflow">return</span>( STATUS_PRIVILEGE_NOT_HELD );
00974             }
00975 
00976         }
00977 
00978         <span class="comment">//</span>
00979         <span class="comment">// We have the required privilege, turn off the bit in</span>
00980         <span class="comment">// copy of the input mask and remember that we need to return</span>
00981         <span class="comment">// this privilege.</span>
00982         <span class="comment">//</span>
00983 
00984         *RemainingDesiredAccess &amp;= ~ACCESS_SYSTEM_SECURITY;
00985     }
00986 
00987     <span class="keywordflow">if</span> (!TokenPassed) {
00988         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( ThreadToken );
00989     }
00990 
00991     SizeRequired = <span class="keyword">sizeof</span>(PRIVILEGE_SET);
00992 
00993     <span class="keywordflow">if</span> ( SizeRequired &gt; *Length ) {
00994         *Length = SizeRequired;
00995         <span class="keywordflow">return</span>( STATUS_BUFFER_TOO_SMALL );
00996     }
00997 
00998     <span class="keywordflow">if</span> (Result) {
00999 
01000         Privileges-&gt;PrivilegeCount = 1;
01001         Privileges-&gt;Control = 0;
01002         Privileges-&gt;Privilege[PrivilegeNumber].Luid = RtlConvertLongToLuid(SE_SECURITY_PRIVILEGE);
01003         Privileges-&gt;Privilege[PrivilegeNumber].Attributes = SE_PRIVILEGE_USED_FOR_ACCESS;
01004 
01005     } <span class="keywordflow">else</span> {
01006 
01007         Privileges-&gt;PrivilegeCount = 0;
01008         Privileges-&gt;Control = 0;
01009         Privileges-&gt;Privilege[PrivilegeNumber].Luid = RtlConvertLongToLuid(0);
01010         Privileges-&gt;Privilege[PrivilegeNumber].Attributes = 0;
01011 
01012     }
01013 
01014     <span class="keywordflow">return</span>( STATUS_SUCCESS );
01015 
01016 }
01017 
01018 
01019 
01020 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01021"></a><a class="code" href="../../d4/d8/seurtl_8c.html#a8">01021</a> <a class="code" href="../../d4/d8/seurtl_8c.html#a8">RtlCopySecurityDescriptor</a>(
01022     IN PSECURITY_DESCRIPTOR InputSecurityDescriptor,
01023     OUT PSECURITY_DESCRIPTOR *OutputSecurityDescriptor
01024     )
01025 
01026 <span class="comment">/*++</span>
01027 <span class="comment"></span>
01028 <span class="comment">Routine Description:</span>
01029 <span class="comment"></span>
01030 <span class="comment">    This routine will copy a self-relative security descriptor from</span>
01031 <span class="comment">    any memory into the correct type of memory required by security</span>
01032 <span class="comment">    descriptor Rtl routines.</span>
01033 <span class="comment"></span>
01034 <span class="comment">    This allows security descriptors to be kept in whatever kind of</span>
01035 <span class="comment">    storage is most convenient for the current application.  A security</span>
01036 <span class="comment">    descriptor should be copied via this routine and the copy passed</span>
01037 <span class="comment">    into any Rtl routine that in any way modify the security descriptor</span>
01038 <span class="comment">    (eg RtlSetSecurityObject).</span>
01039 <span class="comment"></span>
01040 <span class="comment">    The storage allocated by this routine must be freed by</span>
01041 <span class="comment">    RtlDeleteSecurityObject.</span>
01042 <span class="comment"></span>
01043 <span class="comment">Arguments:</span>
01044 <span class="comment"></span>
01045 <span class="comment">    InputSecurityDescriptor - contains the source security descriptor</span>
01046 <span class="comment"></span>
01047 <span class="comment">    OutputSecurityDescriptor - returns a copy of the security descriptor</span>
01048 <span class="comment">        in the correct kind of memory.</span>
01049 <span class="comment"></span>
01050 <span class="comment"></span>
01051 <span class="comment">Return Value:</span>
01052 <span class="comment"></span>
01053 <span class="comment">    STATUS_NO_MEMORY - There was not enough memory available to the current</span>
01054 <span class="comment">        process to complete this operation.</span>
01055 <span class="comment"></span>
01056 <span class="comment">--*/</span>
01057 
01058 {
01059 
01060     PACL <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a>;
01061     PACL Sacl;
01062 
01063     PSID <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a>;
01064     PSID PrimaryGroup;
01065 
01066     ULONG DaclSize;
01067     ULONG OwnerSize;
01068     ULONG PrimaryGroupSize;
01069     ULONG SaclSize;
01070     ULONG TotalSize;
01071 
01072     PISECURITY_DESCRIPTOR ISecurityDescriptor =
01073                             (PISECURITY_DESCRIPTOR)InputSecurityDescriptor;
01074 
01075 
01076     <a class="code" href="../../d7/d1/rtlassig_8c.html#a5">RtlpQuerySecurityDescriptor</a>(
01077         ISecurityDescriptor,
01078         &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a>,
01079         &amp;OwnerSize,
01080         &amp;PrimaryGroup,
01081         &amp;PrimaryGroupSize,
01082         &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a>,
01083         &amp;DaclSize,
01084         &amp;Sacl,
01085         &amp;SaclSize
01086         );
01087 
01088     TotalSize = <span class="keyword">sizeof</span>(SECURITY_DESCRIPTOR) +
01089                 OwnerSize +
01090                 PrimaryGroupSize +
01091                 DaclSize +
01092                 SaclSize;
01093 
01094     *OutputSecurityDescriptor = <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>( RtlProcessHeap(), <a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( <a class="code" href="../../d9/d2/ldrp_8h.html#a17">SE_TAG</a> ), TotalSize );
01095 
01096     <span class="keywordflow">if</span> ( *OutputSecurityDescriptor == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
01097         <span class="keywordflow">return</span>( STATUS_NO_MEMORY );
01098     }
01099 
01100     RtlMoveMemory( *OutputSecurityDescriptor,
01101                    ISecurityDescriptor,
01102                    TotalSize
01103                    );
01104 
01105     <span class="keywordflow">return</span>( STATUS_SUCCESS );
01106 
01107 }
01108 
01109 
01110 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01111"></a><a class="code" href="../../d4/d8/seurtl_8c.html#a9">01111</a> <a class="code" href="../../d4/d8/seurtl_8c.html#a9">RtlpInitializeAllowedAce</a>(
01112     IN  PACCESS_ALLOWED_ACE AllowedAce,
01113     IN  USHORT AceSize,
01114     IN  UCHAR InheritFlags,
01115     IN  UCHAR AceFlags,
01116     IN  ACCESS_MASK Mask,
01117     IN  PSID AllowedSid
01118     )
01119 <span class="comment">/*++</span>
01120 <span class="comment"></span>
01121 <span class="comment">Routine Description:</span>
01122 <span class="comment"></span>
01123 <span class="comment">    This function assigns the specified ACE values into an allowed type ACE.</span>
01124 <span class="comment"></span>
01125 <span class="comment">Arguments:</span>
01126 <span class="comment"></span>
01127 <span class="comment">    AllowedAce - Supplies a pointer to the ACE that is initialized.</span>
01128 <span class="comment"></span>
01129 <span class="comment">    AceSize - Supplies the size of the ACE in bytes.</span>
01130 <span class="comment"></span>
01131 <span class="comment">    InheritFlags - Supplies ACE inherit flags.</span>
01132 <span class="comment"></span>
01133 <span class="comment">    AceFlags - Supplies ACE type specific control flags.</span>
01134 <span class="comment"></span>
01135 <span class="comment">    Mask - Supplies the allowed access masks.</span>
01136 <span class="comment"></span>
01137 <span class="comment">    AllowedSid - Supplies the pointer to the SID of user/group which is allowed</span>
01138 <span class="comment">        the specified access.</span>
01139 <span class="comment"></span>
01140 <span class="comment">Return Value:</span>
01141 <span class="comment"></span>
01142 <span class="comment">    Returns status from RtlCopySid.</span>
01143 <span class="comment"></span>
01144 <span class="comment">--*/</span>
01145 {
01146     AllowedAce-&gt;Header.AceType = ACCESS_ALLOWED_ACE_TYPE;
01147     AllowedAce-&gt;Header.AceSize = AceSize;
01148     AllowedAce-&gt;Header.AceFlags = AceFlags | InheritFlags;
01149 
01150     AllowedAce-&gt;Mask = Mask;
01151 
01152     <span class="keywordflow">return</span> <a class="code" href="../../d8/d6/sertl_8c.html#a46">RtlCopySid</a>(
01153                <a class="code" href="../../d8/d6/sertl_8c.html#a45">RtlLengthSid</a>(AllowedSid),
01154                &amp;(AllowedAce-&gt;SidStart),
01155                AllowedSid
01156                );
01157 }
01158 
01159 
01160 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01161"></a><a class="code" href="../../d4/d8/seurtl_8c.html#a10">01161</a> <a class="code" href="../../d4/d8/seurtl_8c.html#a10">RtlpInitializeDeniedAce</a>(
01162     IN  PACCESS_DENIED_ACE DeniedAce,
01163     IN  USHORT AceSize,
01164     IN  UCHAR InheritFlags,
01165     IN  UCHAR AceFlags,
01166     IN  ACCESS_MASK Mask,
01167     IN  PSID DeniedSid
01168     )
01169 <span class="comment">/*++</span>
01170 <span class="comment"></span>
01171 <span class="comment">Routine Description:</span>
01172 <span class="comment"></span>
01173 <span class="comment">    This function assigns the specified ACE values into a denied type ACE.</span>
01174 <span class="comment"></span>
01175 <span class="comment">Arguments:</span>
01176 <span class="comment"></span>
01177 <span class="comment">    DeniedAce - Supplies a pointer to the ACE that is initialized.</span>
01178 <span class="comment"></span>
01179 <span class="comment">    AceSize - Supplies the size of the ACE in bytes.</span>
01180 <span class="comment"></span>
01181 <span class="comment">    InheritFlags - Supplies ACE inherit flags.</span>
01182 <span class="comment"></span>
01183 <span class="comment">    AceFlags - Supplies ACE type specific control flags.</span>
01184 <span class="comment"></span>
01185 <span class="comment">    Mask - Supplies the denied access masks.</span>
01186 <span class="comment"></span>
01187 <span class="comment">    AllowedSid - Supplies the pointer to the SID of user/group which is denied</span>
01188 <span class="comment">        the specified access.</span>
01189 <span class="comment"></span>
01190 <span class="comment">Return Value:</span>
01191 <span class="comment"></span>
01192 <span class="comment">    Returns status from RtlCopySid.</span>
01193 <span class="comment"></span>
01194 <span class="comment">--*/</span>
01195 {
01196     DeniedAce-&gt;Header.AceType = ACCESS_DENIED_ACE_TYPE;
01197     DeniedAce-&gt;Header.AceSize = AceSize;
01198     DeniedAce-&gt;Header.AceFlags = AceFlags | InheritFlags;
01199 
01200     DeniedAce-&gt;Mask = Mask;
01201 
01202     <span class="keywordflow">return</span> <a class="code" href="../../d8/d6/sertl_8c.html#a46">RtlCopySid</a>(
01203                <a class="code" href="../../d8/d6/sertl_8c.html#a45">RtlLengthSid</a>(DeniedSid),
01204                &amp;(DeniedAce-&gt;SidStart),
01205                DeniedSid
01206                );
01207 }
01208 
01209 
01210 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01211"></a><a class="code" href="../../d4/d8/seurtl_8c.html#a11">01211</a> <a class="code" href="../../d4/d8/seurtl_8c.html#a11">RtlpInitializeAuditAce</a>(
01212     IN  PACCESS_ALLOWED_ACE AuditAce,
01213     IN  USHORT AceSize,
01214     IN  UCHAR InheritFlags,
01215     IN  UCHAR AceFlags,
01216     IN  ACCESS_MASK Mask,
01217     IN  PSID AuditSid
01218     )
01219 <span class="comment">/*++</span>
01220 <span class="comment"></span>
01221 <span class="comment">Routine Description:</span>
01222 <span class="comment"></span>
01223 <span class="comment">    This function assigns the specified ACE values into an audit type ACE.</span>
01224 <span class="comment"></span>
01225 <span class="comment">Arguments:</span>
01226 <span class="comment"></span>
01227 <span class="comment">    AuditAce - Supplies a pointer to the ACE that is initialized.</span>
01228 <span class="comment"></span>
01229 <span class="comment">    AceSize - Supplies the size of the ACE in bytes.</span>
01230 <span class="comment"></span>
01231 <span class="comment">    InheritFlags - Supplies ACE inherit flags.</span>
01232 <span class="comment"></span>
01233 <span class="comment">    AceFlags - Supplies ACE type specific control flags.</span>
01234 <span class="comment"></span>
01235 <span class="comment">    Mask - Supplies the allowed access masks.</span>
01236 <span class="comment"></span>
01237 <span class="comment">    AuditSid - Supplies the pointer to the SID of user/group which is to be</span>
01238 <span class="comment">        audited.</span>
01239 <span class="comment"></span>
01240 <span class="comment">Return Value:</span>
01241 <span class="comment"></span>
01242 <span class="comment">    Returns status from RtlCopySid.</span>
01243 <span class="comment"></span>
01244 <span class="comment">--*/</span>
01245 {
01246     AuditAce-&gt;Header.AceType = SYSTEM_AUDIT_ACE_TYPE;
01247     AuditAce-&gt;Header.AceSize = AceSize;
01248     AuditAce-&gt;Header.AceFlags = AceFlags | InheritFlags;
01249 
01250     AuditAce-&gt;Mask = Mask;
01251 
01252     <span class="keywordflow">return</span> <a class="code" href="../../d8/d6/sertl_8c.html#a46">RtlCopySid</a>(
01253                <a class="code" href="../../d8/d6/sertl_8c.html#a45">RtlLengthSid</a>(AuditSid),
01254                &amp;(AuditAce-&gt;SidStart),
01255                AuditSid
01256                );
01257 }
01258 
01259 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01260"></a><a class="code" href="../../d4/d8/seurtl_8c.html#a12">01260</a> <a class="code" href="../../d4/d8/seurtl_8c.html#a12">RtlCreateAndSetSD</a>(
01261     IN  PRTL_ACE_DATA AceData,
01262     IN  ULONG AceCount,
01263     IN  PSID OwnerSid OPTIONAL,
01264     IN  PSID GroupSid OPTIONAL,
01265     OUT PSECURITY_DESCRIPTOR *NewDescriptor
01266     )
01267 <span class="comment">/*++</span>
01268 <span class="comment"></span>
01269 <span class="comment">Routine Description:</span>
01270 <span class="comment"></span>
01271 <span class="comment">    This function creates an absolute security descriptor containing</span>
01272 <span class="comment">    the supplied ACE information.</span>
01273 <span class="comment"></span>
01274 <span class="comment">    A sample usage of this function:</span>
01275 <span class="comment"></span>
01276 <span class="comment">        //</span>
01277 <span class="comment">        // Order matters!  These ACEs are inserted into the DACL in the</span>
01278 <span class="comment">        // following order.  Security access is granted or denied based on</span>
01279 <span class="comment">        // the order of the ACEs in the DACL.</span>
01280 <span class="comment">        //</span>
01281 <span class="comment"></span>
01282 <span class="comment">        RTL_ACE_DATA AceData[4] = {</span>
01283 <span class="comment">            {ACCESS_ALLOWED_ACE_TYPE, 0, 0,</span>
01284 <span class="comment">                   GENERIC_ALL,                  &amp;LocalAdminSid},</span>
01285 <span class="comment"></span>
01286 <span class="comment">            {ACCESS_DENIED_ACE_TYPE,  0, 0,</span>
01287 <span class="comment">                   GENERIC_ALL,                  &amp;NetworkSid},</span>
01288 <span class="comment"></span>
01289 <span class="comment">            {ACCESS_ALLOWED_ACE_TYPE, 0, 0,</span>
01290 <span class="comment">                   WKSTA_CONFIG_GUEST_INFO_GET |</span>
01291 <span class="comment">                   WKSTA_CONFIG_USER_INFO_GET,   &amp;DomainUsersSid},</span>
01292 <span class="comment"></span>
01293 <span class="comment">            {ACCESS_ALLOWED_ACE_TYPE, 0, 0,</span>
01294 <span class="comment">                   WKSTA_CONFIG_GUEST_INFO_GET,  &amp;DomainGuestsSid}</span>
01295 <span class="comment">            };</span>
01296 <span class="comment"></span>
01297 <span class="comment">        PSECURITY_DESCRIPTOR WkstaSecurityDescriptor;</span>
01298 <span class="comment"></span>
01299 <span class="comment"></span>
01300 <span class="comment">        return RtlCreateAndSetSD(</span>
01301 <span class="comment">                   AceData,</span>
01302 <span class="comment">                   4,</span>
01303 <span class="comment">                   LocalSystemSid,</span>
01304 <span class="comment">                   LocalSystemSid,</span>
01305 <span class="comment">                   &amp;WkstaSecurityDescriptor</span>
01306 <span class="comment">                   );</span>
01307 <span class="comment"></span>
01308 <span class="comment">Arguments:</span>
01309 <span class="comment"></span>
01310 <span class="comment">    AceData - Supplies the structure of information that describes the DACL.</span>
01311 <span class="comment"></span>
01312 <span class="comment">    AceCount - Supplies the number of entries in AceData structure.</span>
01313 <span class="comment"></span>
01314 <span class="comment">    OwnerSid - Supplies the pointer to the SID of the security descriptor</span>
01315 <span class="comment">        owner.  If not specified, a security descriptor with no owner</span>
01316 <span class="comment">        will be created.</span>
01317 <span class="comment"></span>
01318 <span class="comment">    GroupSid - Supplies the pointer to the SID of the security descriptor</span>
01319 <span class="comment">        primary group.  If not specified, a security descriptor with no primary</span>
01320 <span class="comment">        group will be created.</span>
01321 <span class="comment"></span>
01322 <span class="comment">    NewDescriptor - Returns a pointer to the absolute security descriptor</span>
01323 <span class="comment">        allocated using RtlAllocateHeap.</span>
01324 <span class="comment"></span>
01325 <span class="comment">Return Value:</span>
01326 <span class="comment"></span>
01327 <span class="comment">    STATUS_SUCCESS - if successful</span>
01328 <span class="comment">    STATUS_NO_MEMORY - if cannot allocate memory for DACL, ACEs, and</span>
01329 <span class="comment">        security descriptor.</span>
01330 <span class="comment"></span>
01331 <span class="comment">    Any other status codes returned from the security Rtl routines.</span>
01332 <span class="comment"></span>
01333 <span class="comment">    NOTE : the user security object created by calling this function may be</span>
01334 <span class="comment">                freed up by calling RtlDeleteSecurityObject().</span>
01335 <span class="comment"></span>
01336 <span class="comment">--*/</span>
01337 {
01338 
01339     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> ntstatus = STATUS_SUCCESS;
01340     ULONG i;
01341 
01342     <span class="comment">//</span>
01343     <span class="comment">// Pointer to memory dynamically allocated by this routine to hold</span>
01344     <span class="comment">// the absolute security descriptor, the DACL, the SACL, and all the ACEs.</span>
01345     <span class="comment">//</span>
01346     <span class="comment">// +---------------------------------------------------------------+</span>
01347     <span class="comment">// |                     Security Descriptor                       |</span>
01348     <span class="comment">// +-------------------------------+-------+---------------+-------+</span>
01349     <span class="comment">// |          DACL                 | ACE 1 |   .  .  .     | ACE n |</span>
01350     <span class="comment">// +-------------------------------+-------+---------------+-------+</span>
01351     <span class="comment">// |          SACL                 | ACE 1 |   .  .  .     | ACE n |</span>
01352     <span class="comment">// +-------------------------------+-------+---------------+-------+</span>
01353     <span class="comment">//</span>
01354 
01355     PSECURITY_DESCRIPTOR AbsoluteSd = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01356     PACL <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;   <span class="comment">// Pointer to the DACL portion of above buffer</span>
01357     PACL Sacl = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;   <span class="comment">// Pointer to the SACL portion of above buffer</span>
01358 
01359     ULONG DaclSize = <span class="keyword">sizeof</span>(ACL);
01360     ULONG SaclSize = <span class="keyword">sizeof</span>(ACL);
01361     ULONG MaxAceSize = 0;
01362     PVOID MaxAce = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01363 
01364     PCHAR CurrentAvailable;
01365     ULONG <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
01366 
01367     PVOID <a class="code" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a> = RtlProcessHeap();
01368 
01369 
01370     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( AceCount &gt; 0 );
01371 
01372     <span class="comment">//</span>
01373     <span class="comment">// Compute the total size of the DACL and SACL ACEs and the maximum</span>
01374     <span class="comment">// size of any ACE.</span>
01375     <span class="comment">//</span>
01376 
01377     <span class="keywordflow">for</span> (i = 0; i &lt; AceCount; i++) {
01378         ULONG AceSize;
01379 
01380         AceSize = <a class="code" href="../../d8/d6/sertl_8c.html#a45">RtlLengthSid</a>(*(AceData[i].Sid));
01381 
01382         <span class="keywordflow">switch</span> (AceData[i].AceType) {
01383         <span class="keywordflow">case</span> ACCESS_ALLOWED_ACE_TYPE:
01384             AceSize += <span class="keyword">sizeof</span>(ACCESS_ALLOWED_ACE);
01385             DaclSize += AceSize;
01386             <span class="keywordflow">break</span>;
01387 
01388         <span class="keywordflow">case</span> ACCESS_DENIED_ACE_TYPE:
01389             AceSize += <span class="keyword">sizeof</span>(ACCESS_DENIED_ACE);
01390             DaclSize += AceSize;
01391             <span class="keywordflow">break</span>;
01392 
01393         <span class="keywordflow">case</span> SYSTEM_AUDIT_ACE_TYPE:
01394             AceSize += <span class="keyword">sizeof</span>(SYSTEM_AUDIT_ACE);
01395             SaclSize += AceSize;
01396             <span class="keywordflow">break</span>;
01397 
01398         <span class="keywordflow">default</span>:
01399             <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
01400         }
01401 
01402         MaxAceSize = MaxAceSize &gt; AceSize ? MaxAceSize : AceSize;
01403     }
01404 
01405     <span class="comment">//</span>
01406     <span class="comment">// Allocate a chunk of memory large enough for the security descriptor,</span>
01407     <span class="comment">// the DACL, the SACL and all ACEs.</span>
01408     <span class="comment">//</span>
01409     <span class="comment">// A security descriptor is of opaque data type but</span>
01410     <span class="comment">// SECURITY_DESCRIPTOR_MIN_LENGTH is the right size.</span>
01411     <span class="comment">//</span>
01412 
01413     <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = SECURITY_DESCRIPTOR_MIN_LENGTH;
01414     <span class="keywordflow">if</span> ( DaclSize != <span class="keyword">sizeof</span>(ACL) ) {
01415         <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> += DaclSize;
01416     }
01417     <span class="keywordflow">if</span> ( SaclSize != <span class="keyword">sizeof</span>(ACL) ) {
01418         <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> += SaclSize;
01419     }
01420 
01421     <span class="keywordflow">if</span> ((AbsoluteSd = <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>(
01422                           <a class="code" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a>, <a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( <a class="code" href="../../d9/d2/ldrp_8h.html#a17">SE_TAG</a> ),
01423                           <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>
01424                           )) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01425         ntstatus = STATUS_NO_MEMORY;
01426         <span class="keywordflow">goto</span> Cleanup;
01427     }
01428 
01429     <span class="comment">//</span>
01430     <span class="comment">// Initialize the Dacl and Sacl</span>
01431     <span class="comment">//</span>
01432 
01433     CurrentAvailable = (PCHAR)AbsoluteSd + SECURITY_DESCRIPTOR_MIN_LENGTH;
01434 
01435     <span class="keywordflow">if</span> ( DaclSize != <span class="keyword">sizeof</span>(ACL) ) {
01436         <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a> = (PACL)CurrentAvailable;
01437         CurrentAvailable += DaclSize;
01438 
01439         ntstatus = <a class="code" href="../../d2/d4/acledit_8c.html#a6">RtlCreateAcl</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a>, DaclSize, ACL_REVISION );
01440 
01441         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(ntstatus) ) {
01442             <span class="keywordflow">goto</span> Cleanup;
01443         }
01444     }
01445 
01446     <span class="keywordflow">if</span> ( SaclSize != <span class="keyword">sizeof</span>(ACL) ) {
01447         Sacl = (PACL)CurrentAvailable;
01448         CurrentAvailable += SaclSize;
01449 
01450         ntstatus = <a class="code" href="../../d2/d4/acledit_8c.html#a6">RtlCreateAcl</a>( Sacl, SaclSize, ACL_REVISION );
01451 
01452         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(ntstatus) ) {
01453             <span class="keywordflow">goto</span> Cleanup;
01454         }
01455     }
01456 
01457     <span class="comment">//</span>
01458     <span class="comment">// Allocate a temporary buffer big enough for the biggest ACE.</span>
01459     <span class="comment">//</span>
01460 
01461     <span class="keywordflow">if</span> ((MaxAce = <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>(
01462                       <a class="code" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a>, <a class="code" href="../../d9/d2/ldrp_8h.html#a11">MAKE_TAG</a>( <a class="code" href="../../d9/d2/ldrp_8h.html#a17">SE_TAG</a> ),
01463                       MaxAceSize
01464                       )) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
01465         ntstatus = STATUS_NO_MEMORY;
01466         <span class="keywordflow">goto</span> Cleanup;
01467     }
01468 
01469     <span class="comment">//</span>
01470     <span class="comment">// Initialize each ACE, and append it into the end of the DACL or SACL.</span>
01471     <span class="comment">//</span>
01472 
01473     <span class="keywordflow">for</span> (i = 0; i &lt; AceCount; i++) {
01474         ULONG AceSize;
01475         PACL CurrentAcl;
01476 
01477         AceSize = <a class="code" href="../../d8/d6/sertl_8c.html#a45">RtlLengthSid</a>(*(AceData[i].Sid));
01478 
01479         <span class="keywordflow">switch</span> (AceData[i].AceType) {
01480         <span class="keywordflow">case</span> ACCESS_ALLOWED_ACE_TYPE:
01481 
01482             AceSize += <span class="keyword">sizeof</span>(ACCESS_ALLOWED_ACE);
01483             CurrentAcl = <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a>;
01484             ntstatus = <a class="code" href="../../d4/d8/seurtl_8c.html#a9">RtlpInitializeAllowedAce</a>(
01485                            MaxAce,
01486                            (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) AceSize,
01487                            AceData[i].InheritFlags,
01488                            AceData[i].AceFlags,
01489                            AceData[i].Mask,
01490                            *(AceData[i].Sid)
01491                            );
01492             <span class="keywordflow">break</span>;
01493 
01494         <span class="keywordflow">case</span> ACCESS_DENIED_ACE_TYPE:
01495             AceSize += <span class="keyword">sizeof</span>(ACCESS_DENIED_ACE);
01496             CurrentAcl = <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a>;
01497             ntstatus = <a class="code" href="../../d4/d8/seurtl_8c.html#a10">RtlpInitializeDeniedAce</a>(
01498                            MaxAce,
01499                            (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) AceSize,
01500                            AceData[i].InheritFlags,
01501                            AceData[i].AceFlags,
01502                            AceData[i].Mask,
01503                            *(AceData[i].Sid)
01504                            );
01505             <span class="keywordflow">break</span>;
01506 
01507         <span class="keywordflow">case</span> SYSTEM_AUDIT_ACE_TYPE:
01508             AceSize += <span class="keyword">sizeof</span>(SYSTEM_AUDIT_ACE);
01509             CurrentAcl = Sacl;
01510             ntstatus = <a class="code" href="../../d4/d8/seurtl_8c.html#a11">RtlpInitializeAuditAce</a>(
01511                            MaxAce,
01512                            (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) AceSize,
01513                            AceData[i].InheritFlags,
01514                            AceData[i].AceFlags,
01515                            AceData[i].Mask,
01516                            *(AceData[i].Sid)
01517                            );
01518             <span class="keywordflow">break</span>;
01519         }
01520 
01521         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( ntstatus ) ) {
01522             <span class="keywordflow">goto</span> Cleanup;
01523         }
01524 
01525         <span class="comment">//</span>
01526         <span class="comment">// Append the initialized ACE to the end of DACL or SACL</span>
01527         <span class="comment">//</span>
01528 
01529         <span class="keywordflow">if</span> (! <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (ntstatus = <a class="code" href="../../d2/d4/acledit_8c.html#a10">RtlAddAce</a>(
01530                                          CurrentAcl,
01531                                          ACL_REVISION,
01532                                          MAXULONG,
01533                                          MaxAce,
01534                                          AceSize
01535                                          ))) {
01536             <span class="keywordflow">goto</span> Cleanup;
01537         }
01538     }
01539 
01540     <span class="comment">//</span>
01541     <span class="comment">// Create the security descriptor with absolute pointers to SIDs</span>
01542     <span class="comment">// and ACLs.</span>
01543     <span class="comment">//</span>
01544     <span class="comment">// Owner = OwnerSid</span>
01545     <span class="comment">// Group = GroupSid</span>
01546     <span class="comment">// Dacl  = Dacl</span>
01547     <span class="comment">// Sacl  = Sacl</span>
01548     <span class="comment">//</span>
01549 
01550     <span class="keywordflow">if</span> (! <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(ntstatus = <a class="code" href="../../d8/d6/sertl_8c.html#a53">RtlCreateSecurityDescriptor</a>(
01551                                     AbsoluteSd,
01552                                     SECURITY_DESCRIPTOR_REVISION
01553                                     ))) {
01554         <span class="keywordflow">goto</span> Cleanup;
01555     }
01556 
01557     <span class="keywordflow">if</span> (! <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(ntstatus = <a class="code" href="../../d8/d6/sertl_8c.html#a64">RtlSetOwnerSecurityDescriptor</a>(
01558                                     AbsoluteSd,
01559                                     OwnerSid,
01560                                     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
01561                                     ))) {
01562         <span class="keywordflow">goto</span> Cleanup;
01563     }
01564 
01565     <span class="keywordflow">if</span> (! <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(ntstatus = <a class="code" href="../../d8/d6/sertl_8c.html#a66">RtlSetGroupSecurityDescriptor</a>(
01566                                     AbsoluteSd,
01567                                     GroupSid,
01568                                     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
01569                                     ))) {
01570         <span class="keywordflow">goto</span> Cleanup;
01571     }
01572 
01573     <span class="keywordflow">if</span> (! <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(ntstatus = <a class="code" href="../../d8/d6/sertl_8c.html#a60">RtlSetDaclSecurityDescriptor</a>(
01574                                     AbsoluteSd,
01575                                     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
01576                                     <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a>,
01577                                     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
01578                                     ))) {
01579         <span class="keywordflow">goto</span> Cleanup;
01580     }
01581 
01582     <span class="keywordflow">if</span> (! <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(ntstatus = <a class="code" href="../../d8/d6/sertl_8c.html#a62">RtlSetSaclSecurityDescriptor</a>(
01583                                     AbsoluteSd,
01584                                     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
01585                                     Sacl,
01586                                     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
01587                                     ))) {
01588         <span class="keywordflow">goto</span> Cleanup;
01589     }
01590 
01591     <span class="comment">//</span>
01592     <span class="comment">// Done</span>
01593     <span class="comment">//</span>
01594 
01595     ntstatus = STATUS_SUCCESS;
01596 
01597     <span class="comment">//</span>
01598     <span class="comment">// Clean up</span>
01599     <span class="comment">//</span>
01600 
01601 Cleanup:
01602     <span class="comment">//</span>
01603     <span class="comment">// Either return the security descriptor to the caller or delete it</span>
01604     <span class="comment">//</span>
01605 
01606     <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( ntstatus ) ) {
01607         *NewDescriptor = AbsoluteSd;
01608     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( AbsoluteSd != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
01609         (<span class="keywordtype">void</span>) <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>(<a class="code" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a>, 0, AbsoluteSd);
01610     }
01611 
01612     <span class="comment">//</span>
01613     <span class="comment">// Delete the temporary ACE</span>
01614     <span class="comment">//</span>
01615 
01616     <span class="keywordflow">if</span> ( MaxAce != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
01617         (<span class="keywordtype">void</span>) <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>(<a class="code" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a>, 0, MaxAce);
01618     }
01619     <span class="keywordflow">return</span> ntstatus;
01620 }
01621 
01622 
01623 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01624"></a><a class="code" href="../../d4/d8/seurtl_8c.html#a13">01624</a> <a class="code" href="../../d4/d8/seurtl_8c.html#a13">RtlCreateUserSecurityObject</a>(
01625     IN  PRTL_ACE_DATA AceData,
01626     IN  ULONG AceCount,
01627     IN  PSID OwnerSid,
01628     IN  PSID GroupSid,
01629     IN  BOOLEAN IsDirectoryObject,
01630     IN  PGENERIC_MAPPING GenericMapping,
01631     OUT PSECURITY_DESCRIPTOR *NewDescriptor
01632     )
01633 <span class="comment">/*++</span>
01634 <span class="comment"></span>
01635 <span class="comment">Routine Description:</span>
01636 <span class="comment"></span>
01637 <span class="comment">    This function creates the DACL for the security descriptor based on</span>
01638 <span class="comment">    on the ACE information specified, and creates the security descriptor</span>
01639 <span class="comment">    which becomes the user-mode security object.</span>
01640 <span class="comment"></span>
01641 <span class="comment">    A sample usage of this function:</span>
01642 <span class="comment"></span>
01643 <span class="comment">        //</span>
01644 <span class="comment">        // Structure that describes the mapping of Generic access rights to</span>
01645 <span class="comment">        // object specific access rights for the ConfigurationInfo object.</span>
01646 <span class="comment">        //</span>
01647 <span class="comment"></span>
01648 <span class="comment">        GENERIC_MAPPING WsConfigInfoMapping = {</span>
01649 <span class="comment">            STANDARD_RIGHTS_READ            |      // Generic read</span>
01650 <span class="comment">                WKSTA_CONFIG_GUEST_INFO_GET |</span>
01651 <span class="comment">                WKSTA_CONFIG_USER_INFO_GET  |</span>
01652 <span class="comment">                WKSTA_CONFIG_ADMIN_INFO_GET,</span>
01653 <span class="comment">            STANDARD_RIGHTS_WRITE |                // Generic write</span>
01654 <span class="comment">                WKSTA_CONFIG_INFO_SET,</span>
01655 <span class="comment">            STANDARD_RIGHTS_EXECUTE,               // Generic execute</span>
01656 <span class="comment">            WKSTA_CONFIG_ALL_ACCESS                // Generic all</span>
01657 <span class="comment">            };</span>
01658 <span class="comment"></span>
01659 <span class="comment">        //</span>
01660 <span class="comment">        // Order matters!  These ACEs are inserted into the DACL in the</span>
01661 <span class="comment">        // following order.  Security access is granted or denied based on</span>
01662 <span class="comment">        // the order of the ACEs in the DACL.</span>
01663 <span class="comment">        //</span>
01664 <span class="comment"></span>
01665 <span class="comment">        RTL_ACE_DATA AceData[4] = {</span>
01666 <span class="comment">            {ACCESS_ALLOWED_ACE_TYPE, 0, 0,</span>
01667 <span class="comment">                   GENERIC_ALL,                  &amp;LocalAdminSid},</span>
01668 <span class="comment"></span>
01669 <span class="comment">            {ACCESS_DENIED_ACE_TYPE,  0, 0,</span>
01670 <span class="comment">                   GENERIC_ALL,                  &amp;NetworkSid},</span>
01671 <span class="comment"></span>
01672 <span class="comment">            {ACCESS_ALLOWED_ACE_TYPE, 0, 0,</span>
01673 <span class="comment">                   WKSTA_CONFIG_GUEST_INFO_GET |</span>
01674 <span class="comment">                   WKSTA_CONFIG_USER_INFO_GET,   &amp;DomainUsersSid},</span>
01675 <span class="comment"></span>
01676 <span class="comment">            {ACCESS_ALLOWED_ACE_TYPE, 0, 0,</span>
01677 <span class="comment">                   WKSTA_CONFIG_GUEST_INFO_GET,  &amp;DomainGuestsSid}</span>
01678 <span class="comment">            };</span>
01679 <span class="comment"></span>
01680 <span class="comment">        PSECURITY_DESCRIPTOR WkstaSecurityObject;</span>
01681 <span class="comment"></span>
01682 <span class="comment"></span>
01683 <span class="comment">        return RtlCreateUserSecurityObject(</span>
01684 <span class="comment">                   AceData,</span>
01685 <span class="comment">                   4,</span>
01686 <span class="comment">                   LocalSystemSid,</span>
01687 <span class="comment">                   LocalSystemSid,</span>
01688 <span class="comment">                   FALSE,</span>
01689 <span class="comment">                   &amp;WsConfigInfoMapping,</span>
01690 <span class="comment">                   &amp;WkstaSecurityObject</span>
01691 <span class="comment">                   );</span>
01692 <span class="comment"></span>
01693 <span class="comment">Arguments:</span>
01694 <span class="comment"></span>
01695 <span class="comment">    AceData - Supplies the structure of information that describes the DACL.</span>
01696 <span class="comment"></span>
01697 <span class="comment">    AceCount - Supplies the number of entries in AceData structure.</span>
01698 <span class="comment"></span>
01699 <span class="comment">    OwnerSid - Supplies the pointer to the SID of the security descriptor</span>
01700 <span class="comment">        owner.</span>
01701 <span class="comment"></span>
01702 <span class="comment">    GroupSid - Supplies the pointer to the SID of the security descriptor</span>
01703 <span class="comment">        primary group.</span>
01704 <span class="comment"></span>
01705 <span class="comment">    IsDirectoryObject - Supplies the flag which indicates whether the</span>
01706 <span class="comment">        user-mode object is a directory object.</span>
01707 <span class="comment"></span>
01708 <span class="comment">    GenericMapping - Supplies the pointer to a generic mapping array denoting</span>
01709 <span class="comment">        the mapping between each generic right to specific rights.</span>
01710 <span class="comment"></span>
01711 <span class="comment">    NewDescriptor - Returns a pointer to the self-relative security descriptor</span>
01712 <span class="comment">        which represents the user-mode object.</span>
01713 <span class="comment"></span>
01714 <span class="comment">Return Value:</span>
01715 <span class="comment"></span>
01716 <span class="comment">    STATUS_SUCCESS - if successful</span>
01717 <span class="comment">    STATUS_NO_MEMORY - if cannot allocate memory for DACL, ACEs, and</span>
01718 <span class="comment">        security descriptor.</span>
01719 <span class="comment"></span>
01720 <span class="comment">    Any other status codes returned from the security Rtl routines.</span>
01721 <span class="comment"></span>
01722 <span class="comment">    NOTE : the user security object created by calling this function may be</span>
01723 <span class="comment">                freed up by calling RtlDeleteSecurityObject().</span>
01724 <span class="comment"></span>
01725 <span class="comment">--*/</span>
01726 {
01727 
01728     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> ntstatus;
01729     PSECURITY_DESCRIPTOR AbsoluteSd;
01730     HANDLE TokenHandle;
01731     PVOID <a class="code" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a> = RtlProcessHeap();
01732 
01733     ntstatus = <a class="code" href="../../d4/d8/seurtl_8c.html#a12">RtlCreateAndSetSD</a>(
01734                    AceData,
01735                    AceCount,
01736                    OwnerSid,
01737                    GroupSid,
01738                    &amp;AbsoluteSd
01739                    );
01740 
01741     <span class="keywordflow">if</span> (! <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(ntstatus)) {
01742         <span class="keywordflow">return</span> ntstatus;
01743     }
01744 
01745     ntstatus = <a class="code" href="../../d7/d3/tokenopn_8c.html#a1">NtOpenProcessToken</a>(
01746                    NtCurrentProcess(),
01747                    TOKEN_QUERY,
01748                    &amp;TokenHandle
01749                    );
01750 
01751     <span class="keywordflow">if</span> (! <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(ntstatus)) {
01752         (<span class="keywordtype">void</span>) <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>(<a class="code" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a>, 0, AbsoluteSd);
01753         <span class="keywordflow">return</span> ntstatus;
01754     }
01755 
01756     <span class="comment">//</span>
01757     <span class="comment">// Create the security object (a user-mode object is really a pseudo-</span>
01758     <span class="comment">// object represented by a security descriptor that have relative</span>
01759     <span class="comment">// pointers to SIDs and ACLs).  This routine allocates the memory to</span>
01760     <span class="comment">// hold the relative security descriptor so the memory allocated for the</span>
01761     <span class="comment">// DACL, ACEs, and the absolute descriptor can be freed.</span>
01762     <span class="comment">//</span>
01763     ntstatus = <a class="code" href="../../d4/d8/seurtl_8c.html#a1">RtlNewSecurityObject</a>(
01764                    <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,                   <span class="comment">// Parent descriptor</span>
01765                    AbsoluteSd,             <span class="comment">// Creator descriptor</span>
01766                    NewDescriptor,          <span class="comment">// Pointer to new descriptor</span>
01767                    IsDirectoryObject,      <span class="comment">// Is directory object</span>
01768                    TokenHandle,            <span class="comment">// Token</span>
01769                    GenericMapping          <span class="comment">// Generic mapping</span>
01770                    );
01771 
01772     (<span class="keywordtype">void</span>) <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(TokenHandle);
01773 
01774     <span class="comment">//</span>
01775     <span class="comment">// Free dynamic memory before returning</span>
01776     <span class="comment">//</span>
01777     (<span class="keywordtype">void</span>) <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>(<a class="code" href="../../d4/d6/memory_8c.html#a15">HeapHandle</a>, 0, AbsoluteSd);
01778     <span class="keywordflow">return</span> ntstatus;
01779 }
01780 
01781 
01782 
01783 
01784 
01785 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01786"></a><a class="code" href="../../d4/d8/seurtl_8c.html#a14">01786</a> <a class="code" href="../../d4/d8/seurtl_8c.html#a14">RtlConvertToAutoInheritSecurityObject</a>(
01787     IN PSECURITY_DESCRIPTOR ParentDescriptor OPTIONAL,
01788     IN PSECURITY_DESCRIPTOR CurrentSecurityDescriptor,
01789     OUT PSECURITY_DESCRIPTOR *NewSecurityDescriptor,
01790     IN GUID *ObjectType OPTIONAL,
01791     IN BOOLEAN IsDirectoryObject,
01792     IN PGENERIC_MAPPING GenericMapping
01793     )
01794 <span class="comment">/*++</span>
01795 <span class="comment"></span>
01796 <span class="comment">Routine Description:</span>
01797 <span class="comment"></span>
01798 <span class="comment">    This is a converts a security descriptor whose ACLs are not marked</span>
01799 <span class="comment">    as AutoInherit to a security descriptor whose ACLs are marked as</span>
01800 <span class="comment">    AutoInherit.</span>
01801 <span class="comment"></span>
01802 <span class="comment">    See further detailed description on ConvertToAutoInheritPrivateObjectSecurity.</span>
01803 <span class="comment"></span>
01804 <span class="comment">Arguments:</span>
01805 <span class="comment"></span>
01806 <span class="comment">    ParentDescriptor - Supplies the Security Descriptor for the parent</span>
01807 <span class="comment">        directory under which a object exists.  If there is</span>
01808 <span class="comment">        no parent directory, then this argument is specified as NULL.</span>
01809 <span class="comment"></span>
01810 <span class="comment">    CurrentSecurityDescriptor - Supplies a pointer to the objects security descriptor</span>
01811 <span class="comment">        that is going to be altered by this procedure.</span>
01812 <span class="comment"></span>
01813 <span class="comment">    NewSecurityDescriptor Points to a pointer that is to be made to point to the</span>
01814 <span class="comment">        newly allocated self-relative security descriptor. When no</span>
01815 <span class="comment">        longer needed, this descriptor must be freed using</span>
01816 <span class="comment">        DestroyPrivateObjectSecurity().</span>
01817 <span class="comment"></span>
01818 <span class="comment">    ObjectType - GUID of the object type being created.  If the object being</span>
01819 <span class="comment">        created has no GUID associated with it, then this argument is</span>
01820 <span class="comment">        specified as NULL.</span>
01821 <span class="comment"></span>
01822 <span class="comment">    IsDirectoryObject - Specifies if the object is a</span>
01823 <span class="comment">        directory object.  A value of TRUE indicates the object is a</span>
01824 <span class="comment">        container of other objects.</span>
01825 <span class="comment"></span>
01826 <span class="comment">    GenericMapping - Supplies a pointer to a generic mapping array denoting</span>
01827 <span class="comment">        the mapping between each generic right to specific rights.</span>
01828 <span class="comment"></span>
01829 <span class="comment">Return Value:</span>
01830 <span class="comment"></span>
01831 <span class="comment">    STATUS_SUCCESS - The operation was successful.</span>
01832 <span class="comment"></span>
01833 <span class="comment">    STATUS_UNKNOWN_REVISION - Indicates the source ACL is a revision that</span>
01834 <span class="comment">        is unknown to this routine.  (Only revision 2 ACLs are support by this routine.)</span>
01835 <span class="comment"></span>
01836 <span class="comment">    STATUS_INVALID_ACL - The structure of one of the ACLs in invalid.</span>
01837 <span class="comment"></span>
01838 <span class="comment"></span>
01839 <span class="comment"></span>
01840 <span class="comment">--*/</span>
01841 {
01842 
01843     <span class="comment">//</span>
01844     <span class="comment">// Simply call the corresponding Rtlp routine telling it which allocator</span>
01845     <span class="comment">//  to use.</span>
01846     <span class="comment">//</span>
01847 
01848     <span class="keywordflow">return</span> <a class="code" href="../../d8/d6/sertl_8c.html#a75">RtlpConvertToAutoInheritSecurityObject</a>(
01849                             ParentDescriptor,
01850                             CurrentSecurityDescriptor,
01851                             NewSecurityDescriptor,
01852                             ObjectType,
01853                             IsDirectoryObject,
01854                             GenericMapping );
01855 
01856 }
01857 
01858 
01859 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01860"></a><a class="code" href="../../d4/d8/seurtl_8c.html#a15">01860</a> <a class="code" href="../../d4/d8/seurtl_8c.html#a15">RtlDefaultNpAcl</a>(
01861     OUT PACL * pAcl
01862     )
01863 <span class="comment">/*++</span>
01864 <span class="comment"></span>
01865 <span class="comment">Routine Description:</span>
01866 <span class="comment"></span>
01867 <span class="comment">    This routine constructs a default ACL to be applied to</span>
01868 <span class="comment">    named pipe objects when the caller has not specified one.</span>
01869 <span class="comment">    See NT bug 131090.</span>
01870 <span class="comment"></span>
01871 <span class="comment">    The ACL constructed is as follows:</span>
01872 <span class="comment"></span>
01873 <span class="comment">    Need to build an ACL that looks like the following:</span>
01874 <span class="comment"></span>
01875 <span class="comment">     Local System : F</span>
01876 <span class="comment">     Administrators: F</span>
01877 <span class="comment">     Owner: F</span>
01878 <span class="comment">     Everyone: R</span>
01879 <span class="comment"></span>
01880 <span class="comment">     The owner is determined by querying the currently effective</span>
01881 <span class="comment">     toke and extracting the default owner.</span>
01882 <span class="comment"></span>
01883 <span class="comment">Arguments:</span>
01884 <span class="comment"></span>
01885 <span class="comment">    pAcl - Receives a pointer to an ACL to apply to the named pipe</span>
01886 <span class="comment">        being created.  Guaranteed to be NULL on return if an error</span>
01887 <span class="comment">        occurs.</span>
01888 <span class="comment"></span>
01889 <span class="comment">        This must be freed by calling RtlFreeHeap.</span>
01890 <span class="comment"></span>
01891 <span class="comment">Return Value:</span>
01892 <span class="comment"></span>
01893 <span class="comment">    NT Status.</span>
01894 <span class="comment"></span>
01895 <span class="comment">--*/</span>
01896 {
01897     SID_IDENTIFIER_AUTHORITY    NtAuthority         = SECURITY_NT_AUTHORITY;
01898     SID_IDENTIFIER_AUTHORITY    CreatorSidAuthority = SECURITY_CREATOR_SID_AUTHORITY;
01899     SID_IDENTIFIER_AUTHORITY    WorldSidAuthority   = SECURITY_WORLD_SID_AUTHORITY;
01900 
01901     ULONG AclSize         = 0;
01902     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>       = STATUS_SUCCESS;
01903     ULONG ReturnLength    = 0;
01904     PTOKEN_OWNER OwnerSid = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01905 
01906     HANDLE hToken;
01907 
01908     <span class="comment">//</span>
01909     <span class="comment">// Initialize OUT parameters</span>
01910     <span class="comment">//</span>
01911 
01912     *pAcl = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01913 
01914     <span class="comment">//</span>
01915     <span class="comment">// Open thread token</span>
01916     <span class="comment">//</span>
01917 
01918     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d3/tokenopn_8c.html#a3">NtOpenThreadToken</a>(
01919                  NtCurrentThread(),
01920                  TOKEN_QUERY,
01921                  <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
01922                  &amp;hToken
01923                  );
01924 
01925     <span class="keywordflow">if</span> (STATUS_NO_TOKEN == <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) {
01926 
01927         <span class="comment">//</span>
01928         <span class="comment">// Not impersonating, get process token</span>
01929         <span class="comment">//</span>
01930 
01931         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d3/tokenopn_8c.html#a1">NtOpenProcessToken</a>(
01932                      NtCurrentProcess(),
01933                      TOKEN_QUERY,
01934                      &amp;hToken
01935                      );
01936     }
01937 
01938     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
01939 
01940         <span class="comment">//</span>
01941         <span class="comment">// Get the default owner</span>
01942         <span class="comment">//</span>
01943 
01944         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a> (
01945                      hToken,
01946                      TokenOwner,
01947                      <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01948                      0,
01949                      &amp;ReturnLength
01950                      );
01951 
01952         <span class="keywordflow">if</span> (STATUS_BUFFER_TOO_SMALL == <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) {
01953 
01954             OwnerSid = (PTOKEN_OWNER)<a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>( RtlProcessHeap(), 0, ReturnLength );
01955 
01956             <span class="keywordflow">if</span> (OwnerSid) {
01957 
01958                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a> (
01959                              hToken,
01960                              TokenOwner,
01961                              OwnerSid,
01962                              ReturnLength,
01963                              &amp;ReturnLength
01964                              );
01965 
01966                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
01967 
01968                     <span class="comment">//</span>
01969                     <span class="comment">// Compute the size needed</span>
01970                     <span class="comment">//</span>
01971 
01972                     UCHAR SidBuffer[16];
01973                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( 16 == <a class="code" href="../../d8/d6/sertl_8c.html#a38">RtlLengthRequiredSid</a>( 2 ));
01974 
01975                     AclSize += <a class="code" href="../../d8/d6/sertl_8c.html#a38">RtlLengthRequiredSid</a>( 1 );   <span class="comment">// LocalSystem Sid</span>
01976                     AclSize += <a class="code" href="../../d8/d6/sertl_8c.html#a38">RtlLengthRequiredSid</a>( 2 );   <span class="comment">// Administrators</span>
01977                     AclSize += <a class="code" href="../../d8/d6/sertl_8c.html#a38">RtlLengthRequiredSid</a>( 1 );   <span class="comment">// Everyone (World)</span>
01978 
01979                     AclSize += <a class="code" href="../../d8/d6/sertl_8c.html#a45">RtlLengthSid</a>( OwnerSid-&gt;Owner );   <span class="comment">// Owner</span>
01980 
01981                     AclSize += <span class="keyword">sizeof</span>( ACL );               <span class="comment">// Header</span>
01982                     AclSize += 4 * (<span class="keyword">sizeof</span>( ACCESS_ALLOWED_ACE ) - <span class="keyword">sizeof</span>( ULONG ));
01983 
01984                     <span class="comment">//</span>
01985                     <span class="comment">// Allocate the Acl out of the local process heap</span>
01986                     <span class="comment">//</span>
01987 
01988                     *pAcl = (PACL)<a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>( RtlProcessHeap(), 0, AclSize );
01989 
01990                     <span class="keywordflow">if</span> (*pAcl != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01991 
01992                         <a class="code" href="../../d2/d4/acledit_8c.html#a6">RtlCreateAcl</a>( *pAcl, AclSize, ACL_REVISION );
01993 
01994                         <span class="comment">//</span>
01995                         <span class="comment">// Create each SID in turn and copy the resultant ACE into</span>
01996                         <span class="comment">// the new ACL</span>
01997                         <span class="comment">//</span>
01998 
01999                         <span class="comment">//</span>
02000                         <span class="comment">// Local System - Generic All</span>
02001                         <span class="comment">//</span>
02002 
02003                         <a class="code" href="../../d8/d6/sertl_8c.html#a40">RtlInitializeSid</a>( SidBuffer, &amp;NtAuthority, 1);
02004                         *(<a class="code" href="../../d8/d6/sertl_8c.html#a43">RtlSubAuthoritySid</a>( SidBuffer, 0 )) = SECURITY_LOCAL_SYSTEM_RID;
02005                         <a class="code" href="../../d2/d4/acledit_8c.html#a16">RtlAddAccessAllowedAce</a>( *pAcl, ACL_REVISION, GENERIC_ALL, (PSID)SidBuffer );
02006 
02007                         <span class="comment">//</span>
02008                         <span class="comment">// Admins - Generic All</span>
02009                         <span class="comment">//</span>
02010 
02011                         <a class="code" href="../../d8/d6/sertl_8c.html#a40">RtlInitializeSid</a>( SidBuffer, &amp;NtAuthority, 2);
02012                         *(<a class="code" href="../../d8/d6/sertl_8c.html#a43">RtlSubAuthoritySid</a>( SidBuffer, 0 )) = SECURITY_BUILTIN_DOMAIN_RID;
02013                         *(<a class="code" href="../../d8/d6/sertl_8c.html#a43">RtlSubAuthoritySid</a>( SidBuffer, 1 )) = DOMAIN_ALIAS_RID_ADMINS;
02014                         <a class="code" href="../../d2/d4/acledit_8c.html#a16">RtlAddAccessAllowedAce</a>( *pAcl, ACL_REVISION, GENERIC_ALL, (PSID)SidBuffer );
02015 
02016                         <span class="comment">//</span>
02017                         <span class="comment">// Owner - Generic All</span>
02018                         <span class="comment">//</span>
02019 
02020                         <a class="code" href="../../d2/d4/acledit_8c.html#a16">RtlAddAccessAllowedAce</a>( *pAcl, ACL_REVISION, GENERIC_ALL, OwnerSid-&gt;Owner );
02021 
02022                         <span class="comment">//</span>
02023                         <span class="comment">// World - Generic Read</span>
02024                         <span class="comment">//</span>
02025 
02026                         <a class="code" href="../../d8/d6/sertl_8c.html#a40">RtlInitializeSid</a>( SidBuffer, &amp;WorldSidAuthority, 1 );
02027                         *(<a class="code" href="../../d8/d6/sertl_8c.html#a43">RtlSubAuthoritySid</a>( SidBuffer, 0 )) = SECURITY_WORLD_RID;
02028                         <a class="code" href="../../d2/d4/acledit_8c.html#a16">RtlAddAccessAllowedAce</a>( *pAcl, ACL_REVISION, GENERIC_READ, (PSID)SidBuffer );
02029 
02030                     } <span class="keywordflow">else</span> {
02031 
02032                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_MEMORY;
02033                     }
02034                 }
02035 
02036                 <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>( RtlProcessHeap(), 0, OwnerSid );
02037 
02038             } <span class="keywordflow">else</span> {
02039 
02040                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_MEMORY;
02041             }
02042         }
02043 
02044         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( hToken );
02045     }
02046 
02047     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
02048 
02049         <span class="comment">//</span>
02050         <span class="comment">// Something failed, clean up OUT</span>
02051         <span class="comment">// parameters.</span>
02052         <span class="comment">//</span>
02053 
02054         <span class="keywordflow">if</span> (*pAcl != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02055             <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>( RtlProcessHeap(), 0, *pAcl );
02056             *pAcl = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02057         }
02058     }
02059 
02060     <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
02061 }
02062 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:49 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
