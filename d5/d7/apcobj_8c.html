<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: apcobj.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>apcobj.c File Reference</h1><code>#include "<a class="el" href="../../d1/d9/ki_8h-source.html">ki.h</a>"</code><br>

<p>
<a href="../../d6/d6/apcobj_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d7/apcobj_8c.html#a0">ASSERT_APC</a>(E)</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d7/apcobj_8c.html#a1">KeInitializeApc</a> (IN <a class="el" href="../../d1/d5/struct__KAPC.html">PRKAPC</a> Apc, IN <a class="el" href="../../d1/d8/struct__KTHREAD.html">PRKTHREAD</a> Thread, IN <a class="el" href="../../d4/d9/ke_8h.html#a49">KAPC_ENVIRONMENT</a> Environment, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a42">PKKERNEL_ROUTINE</a> KernelRoutine, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a43">PKRUNDOWN_ROUTINE</a> RundownRoutine OPTIONAL, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a41">PKNORMAL_ROUTINE</a> NormalRoutine OPTIONAL, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> ApcMode OPTIONAL, IN PVOID NormalContext OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PLIST_ENTRY&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d7/apcobj_8c.html#a2">KeFlushQueueApc</a> (IN <a class="el" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> Thread, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> ApcMode)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d7/apcobj_8c.html#a3">KeInsertQueueApc</a> (IN <a class="el" href="../../d1/d5/struct__KAPC.html">PRKAPC</a> Apc, IN PVOID SystemArgument1, IN PVOID SystemArgument2, IN KPRIORITY Increment)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d7/apcobj_8c.html#a4">KeRemoveQueueApc</a> (IN <a class="el" href="../../d1/d5/struct__KAPC.html">PKAPC</a> Apc)</td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a0" doxytag="apcobj.c::ASSERT_APC" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define ASSERT_APC          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">E&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>{             \
    <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((E)-&gt;Type == ApcObject); \
}
</div></pre>
<p>
Definition at line <a class="el" href="../../d6/d6/apcobj_8c-source.html#l00033">33</a> of file <a class="el" href="../../d6/d6/apcobj_8c-source.html">apcobj.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d6/apcobj_8c-source.html#l00217">KeInsertQueueApc()</a>, and <a class="el" href="../../d6/d6/apcobj_8c-source.html#l00291">KeRemoveQueueApc()</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a2" doxytag="apcobj.c::KeFlushQueueApc" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PLIST_ENTRY KeFlushQueueApc           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Thread</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ApcMode</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d6/apcobj_8c-source.html#l00138">138</a> of file <a class="el" href="../../d6/d6/apcobj_8c-source.html">apcobj.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00087">DISPATCH_LEVEL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00254">_KAPC::Inserted</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01907">KiLockDispatcherDatabase</a>, <a class="el" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d0/d9/ntosdef_8h.html#a47">PKAPC</a>.
<p>
Referenced by <a class="el" href="../../d9/d9/psdelete_8c-source.html#l00690">PspExitThread()</a>.
<p>
<pre class="fragment"><div>00145                    :
00146 
00147     This function flushes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> APC queue selected by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified processor
00148     mode <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified thread. An APC queue <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> flushed by removing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00149     listhead from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> list, scanning <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> APC entries in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> list, setting
00150     their inserted variables to <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, and then returning <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00151     doubly linked list as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function value.
00152 
00153 Arguments:
00154 
00155     Thread - Supplies a pointer to a dispatcher object of <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> thread.
00156 
00157     ApcMode - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> processor mode of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> APC queue that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to
00158         be flushed.
00159 
00160 Return Value:
00161 
00162     The address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first entry in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> list of APC objects that were flushed
00163     from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified APC queue.
00164 
00165 --*/
00166 
00167 {
00168 
00169     <a class="code" href="../../d1/d5/struct__KAPC.html">PKAPC</a> Apc;
00170     PLIST_ENTRY FirstEntry;
00171     PLIST_ENTRY NextEntry;
00172     KIRQL OldIrql;
00173 
00174     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(KeGetCurrentIrql() &lt;= DISPATCH_LEVEL);
00175 
00176     <span class="comment">//</span>
00177     <span class="comment">// Raise IRQL to dispatcher level, lock dispatcher database, and</span>
00178     <span class="comment">// lock the APC queue.</span>
00179     <span class="comment">//</span>
00180 
00181     <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;OldIrql);
00182     KiAcquireSpinLock(&amp;Thread-&gt;ApcQueueLock);
00183 
00184     <span class="comment">//</span>
00185     <span class="comment">// Get address of first APC in the list and check if the list is</span>
00186     <span class="comment">// empty or contains entries that should be flushed. If entries</span>
00187     <span class="comment">// should be flushed, then scan the list of APC objects and set their</span>
00188     <span class="comment">// inserted state to FALSE.</span>
00189     <span class="comment">//</span>
00190 
00191     FirstEntry = Thread-&gt;ApcState.ApcListHead[ApcMode].Flink;
00192     <span class="keywordflow">if</span> (FirstEntry == &amp;Thread-&gt;ApcState.ApcListHead[ApcMode]) {
00193         FirstEntry = (PLIST_ENTRY)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00194 
00195     } <span class="keywordflow">else</span> {
00196         RemoveEntryList(&amp;Thread-&gt;ApcState.ApcListHead[ApcMode]);
00197         NextEntry = FirstEntry;
00198         <span class="keywordflow">do</span> {
00199             Apc = CONTAINING_RECORD(NextEntry, <a class="code" href="../../d1/d5/struct__KAPC.html">KAPC</a>, ApcListEntry);
00200             Apc-&gt;<a class="code" href="../../d1/d5/struct__KAPC.html#o13">Inserted</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00201             NextEntry = NextEntry-&gt;Flink;
00202         } <span class="keywordflow">while</span> (NextEntry != FirstEntry);
00203     }
00204 
00205     <span class="comment">//</span>
00206     <span class="comment">// Unlock the APC queue, unlock the dispatcher database, lower IRQL to</span>
00207     <span class="comment">// its previous value, and return address of first entry in list of APC</span>
00208     <span class="comment">// objects that were flushed.</span>
00209     <span class="comment">//</span>
00210 
00211     KiReleaseSpinLock(&amp;Thread-&gt;ApcQueueLock);
00212     <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(OldIrql);
00213     <span class="keywordflow">return</span> FirstEntry;
00214 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="apcobj.c::KeInitializeApc" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KeInitializeApc           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d5/struct__KAPC.html">PRKAPC</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Apc</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d1/d8/struct__KTHREAD.html">PRKTHREAD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Thread</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d4/d9/ke_8h.html#a49">KAPC_ENVIRONMENT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Environment</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a42">PKKERNEL_ROUTINE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>KernelRoutine</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a43">PKRUNDOWN_ROUTINE</a> RundownRoutine&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a41">PKNORMAL_ROUTINE</a> NormalRoutine&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> ApcMode&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID NormalContext&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d6/apcobj_8c-source.html#l00039">39</a> of file <a class="el" href="../../d6/d6/apcobj_8c-source.html">apcobj.c</a>.
<p>
References <a class="el" href="../../d4/d9/ke_8h.html#a402a175">ApcObject</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d4/d9/ke_8h.html#a403a183">CurrentApcEnvironment</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d9/ntosdef_8h.html#a46">KAPC</a>, <a class="el" href="../../d4/d9/ke_8h.html#a49">KAPC_ENVIRONMENT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d1/d9/ki_8h-source.html#l00050">NIL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00204">PKKERNEL_ROUTINE</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00196">PKNORMAL_ROUTINE</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00214">PKRUNDOWN_ROUTINE</a>, and <a class="el" href="../../d0/d9/ntosdef_8h.html#a48">PRKAPC</a>.
<p>
Referenced by <a class="el" href="../../d3/d3/internal_8c-source.html#l01019">IopCompleteRequest()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l08769">IoRaiseHardError()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l08909">IoRaiseInformationalHardError()</a>, <a class="el" href="../../d0/d1/thredobj_8c-source.html#l00043">KeInitializeThread()</a>, <a class="el" href="../../d6/d0/i386_2thredini_8c-source.html#l00454">KeSetAutoAlignmentThread()</a>, <a class="el" href="../../d3/d9/psctx_8c-source.html#l00151">NtGetContextThread()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l01319">NtNotifyChangeMultipleKeys()</a>, <a class="el" href="../../d3/d9/psctx_8c-source.html#l00056">NtQueueApcThread()</a>, <a class="el" href="../../d3/d9/psctx_8c-source.html#l00352">NtSetContextThread()</a>, <a class="el" href="../../d3/d1/timer_8c-source.html#l00960">NtSetTimer()</a>, <a class="el" href="../../d9/d9/psdelete_8c-source.html#l00631">PspExitNormalApc()</a>, <a class="el" href="../../d9/d9/psdelete_8c-source.html#l00160">PspTerminateThreadByPointer()</a>, and <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l01800">PspUserThreadStartup()</a>.
<p>
<pre class="fragment"><div>00052                    :
00053 
00054     This function initializes a kernel APC object. The thread, kernel
00055     routine, and optionally a normal routine, processor mode, and normal
00056     context parameter are stored in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> APC object.
00057 
00058 Arguments:
00059 
00060     Apc - Supplies a pointer to a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> object of <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> APC.
00061 
00062     Thread - Supplies a pointer to a dispatcher object of <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> thread.
00063 
00064     Environment - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> environment in which <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> APC will execute.
00065         Valid values <span class="keywordflow">for</span> <span class="keyword">this</span> parameter are: <a class="code" href="../../d4/d9/ke_8h.html#a403a181">OriginalApcEnvironment</a>,
00066         <a class="code" href="../../d4/d9/ke_8h.html#a403a182">AttachedApcEnvironment</a>, or <a class="code" href="../../d4/d9/ke_8h.html#a403a183">CurrentApcEnvironment</a>.
00067 
00068     KernelRoutine - Supplies a pointer to a function that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be
00069         executed at IRQL <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a> in kernel mode.
00070 
00071     RundownRoutine - Supplies an optional pointer to a function that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be
00072         called <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> APC <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> in a thread's APC queue when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread terminates.
00073 
00074     NormalRoutine - Supplies an optional pointer to a function that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00075         to be executed at IRQL 0 in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified processor mode. If <span class="keyword">this</span>
00076         parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not specified, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ProcessorMode and NormalContext
00077         parameters are ignored.
00078 
00079     ApcMode - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> processor mode in which <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function specified
00080         by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> NormalRoutine parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be executed.
00081 
00082     NormalContext - Supplies a pointer to an arbitrary data structure which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00083         to be passed to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function specified by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> NormalRoutine parameter.
00084 
00085 Return Value:
00086 
00087     None.
00088 
00089 --*/
00090 
00091 {
00092 
00093     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Environment &lt;= CurrentApcEnvironment);
00094 
00095     <span class="comment">//</span>
00096     <span class="comment">// Initialize standard control object header.</span>
00097     <span class="comment">//</span>
00098 
00099     Apc-&gt;Type = <a class="code" href="../../d4/d9/ke_8h.html#a402a175">ApcObject</a>;
00100     Apc-&gt;Size = <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d5/struct__KAPC.html">KAPC</a>);
00101 
00102     <span class="comment">//</span>
00103     <span class="comment">// Initialize the APC environment, thread address, kernel routine address,</span>
00104     <span class="comment">// rundown routine address, normal routine address, processor mode, and</span>
00105     <span class="comment">// normal context parameter. If the normal routine address is null, then</span>
00106     <span class="comment">// the processor mode is defaulted to KernelMode and the APC is a special</span>
00107     <span class="comment">// APC. Otherwise, the processor mode is taken from the argument list.</span>
00108     <span class="comment">//</span>
00109 
00110     <span class="keywordflow">if</span> (Environment == <a class="code" href="../../d4/d9/ke_8h.html#a403a183">CurrentApcEnvironment</a>) {
00111         Apc-&gt;ApcStateIndex = Thread-&gt;ApcStateIndex;
00112 
00113     } <span class="keywordflow">else</span> {
00114 
00115         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Environment &lt;= Thread-&gt;ApcStateIndex);
00116 
00117         Apc-&gt;ApcStateIndex = (CCHAR)Environment;
00118     }
00119 
00120     Apc-&gt;Thread = Thread;
00121     Apc-&gt;KernelRoutine = KernelRoutine;
00122     Apc-&gt;RundownRoutine = RundownRoutine;
00123     Apc-&gt;NormalRoutine = NormalRoutine;
00124     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(NormalRoutine)) {
00125         Apc-&gt;ApcMode = ApcMode;
00126         Apc-&gt;NormalContext = NormalContext;
00127 
00128     } <span class="keywordflow">else</span> {
00129         Apc-&gt;ApcMode = <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>;
00130         Apc-&gt;NormalContext = <a class="code" href="../../d0/d0/ki_8h.html#a5">NIL</a>;
00131     }
00132 
00133     Apc-&gt;Inserted = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00134     <span class="keywordflow">return</span>;
00135 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="apcobj.c::KeInsertQueueApc" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN KeInsertQueueApc           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d5/struct__KAPC.html">PRKAPC</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Apc</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemArgument1</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemArgument2</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN KPRIORITY&nbsp;</td>
          <td class="mdname" nowrap> <em>Increment</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d6/apcobj_8c-source.html#l00217">217</a> of file <a class="el" href="../../d6/d6/apcobj_8c-source.html">apcobj.c</a>.
<p>
References <a class="el" href="../../d5/d8/ke_8h-source.html#l00659">_KTHREAD::ApcQueueable</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d6/d6/apcobj_8c-source.html#l00033">ASSERT_APC</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00087">DISPATCH_LEVEL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d7/d3/rtl_2random_8c-source.html#l00032">Increment</a>, <a class="el" href="../../d7/d6/apcsup_8c-source.html#l00223">KiInsertQueueApc()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01907">KiLockDispatcherDatabase</a>, and <a class="el" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase()</a>.
<p>
Referenced by <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l00487">CmpPostNotify()</a>, <a class="el" href="../../d3/d1/timer_8c-source.html#l00166">ExpTimerDpcRoutine()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l01019">IopCompleteRequest()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l08769">IoRaiseHardError()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l08909">IoRaiseInformationalHardError()</a>, <a class="el" href="../../d6/d0/i386_2thredini_8c-source.html#l00454">KeSetAutoAlignmentThread()</a>, <a class="el" href="../../d3/d9/psctx_8c-source.html#l00151">NtGetContextThread()</a>, <a class="el" href="../../d3/d9/psctx_8c-source.html#l00056">NtQueueApcThread()</a>, <a class="el" href="../../d3/d9/psctx_8c-source.html#l00352">NtSetContextThread()</a>, <a class="el" href="../../d9/d9/psdelete_8c-source.html#l00631">PspExitNormalApc()</a>, <a class="el" href="../../d9/d9/psdelete_8c-source.html#l00160">PspTerminateThreadByPointer()</a>, and <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l01800">PspUserThreadStartup()</a>.
<p>
<pre class="fragment"><div>00226                    :
00227 
00228     This function inserts an APC object into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> APC queue specifed by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00229     thread and processor mode fields of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> APC object. If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> APC object
00230     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> already in an APC queue or APC queuing <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> disabled, then no operation
00231     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> performed. Otherwise <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> APC object <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> inserted in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified queue
00232     and appropriate scheduling decisions are <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a>.
00233 
00234 Arguments:
00235 
00236     Apc - Supplies a pointer to a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> object of <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> APC.
00237 
00238     SystemArgument1, SystemArgument2 - Supply a set of two arguments that
00239         contain untyped data provided by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> executive.
00240 
00241     <a class="code" href="../../d6/d4/rtl_2random_8c.html#a1">Increment</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> priority increment that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be applied <span class="keywordflow">if</span>
00242         queuing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> APC causes a thread wait to be satisfied.
00243 
00244 Return Value:
00245 
00246     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> APC object <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> already in an APC queue or APC queuing <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> disabled,
00247     then a value of <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned. Otherwise a value of <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
00248 
00249 --*/
00250 
00251 {
00252 
00253     BOOLEAN Inserted;
00254     KIRQL OldIrql;
00255     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PRKTHREAD</a> Thread;
00256 
00257     <a class="code" href="../../d5/d7/apcobj_8c.html#a0">ASSERT_APC</a>(Apc);
00258     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(KeGetCurrentIrql() &lt;= DISPATCH_LEVEL);
00259 
00260     <span class="comment">//</span>
00261     <span class="comment">// Raise IRQL to dispatcher level and lock dispatcher database.</span>
00262     <span class="comment">//</span>
00263 
00264     <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;OldIrql);
00265 
00266     <span class="comment">//</span>
00267     <span class="comment">// If APC queuing is disabled, then set inserted to FALSE. Else save</span>
00268     <span class="comment">// system parameter values in APC object, and attempt to queue APC.</span>
00269     <span class="comment">//</span>
00270 
00271     Thread = Apc-&gt;Thread;
00272     <span class="keywordflow">if</span> (Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o59">ApcQueueable</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00273         Inserted = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00274 
00275     } <span class="keywordflow">else</span> {
00276         Apc-&gt;SystemArgument1 = SystemArgument1;
00277         Apc-&gt;SystemArgument2 = SystemArgument2;
00278         Inserted = <a class="code" href="../../d0/d0/ki_8h.html#a123">KiInsertQueueApc</a>(Apc, Increment);
00279     }
00280 
00281     <span class="comment">//</span>
00282     <span class="comment">// Unlock the dispatcher database, lower IRQL to its previous value,</span>
00283     <span class="comment">// and return whether APC object was inserted in APC queue.</span>
00284     <span class="comment">//</span>
00285 
00286     <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(OldIrql);
00287     <span class="keywordflow">return</span> Inserted;
00288 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="apcobj.c::KeRemoveQueueApc" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN KeRemoveQueueApc           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d5/struct__KAPC.html">PKAPC</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Apc</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d6/apcobj_8c-source.html#l00291">291</a> of file <a class="el" href="../../d6/d6/apcobj_8c-source.html">apcobj.c</a>.
<p>
References <a class="el" href="../../d5/d8/ke_8h-source.html#l00243">_KAPC_STATE::ApcListHead</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00613">_KTHREAD::ApcQueueLock</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00638">_KTHREAD::ApcStatePointer</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d6/d6/apcobj_8c-source.html#l00033">ASSERT_APC</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00087">DISPATCH_LEVEL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00246">_KAPC_STATE::KernelApcPending</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01907">KiLockDispatcherDatabase</a>, <a class="el" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase()</a>, <a class="el" href="../../d4/d9/ke_8h.html#a55">PKAPC_STATE</a>, and <a class="el" href="../../d5/d8/ke_8h-source.html#l00247">_KAPC_STATE::UserApcPending</a>.
<p>
Referenced by <a class="el" href="../../d1/d1/cmnotify_8c-source.html#l01028">CmNotifyRunDown()</a>, <a class="el" href="../../d3/d1/timer_8c-source.html#l00346">ExTimerRundown()</a>, <a class="el" href="../../d3/d1/timer_8c-source.html#l00679">NtCancelTimer()</a>, and <a class="el" href="../../d3/d1/timer_8c-source.html#l00960">NtSetTimer()</a>.
<p>
<pre class="fragment"><div>00297                    :
00298 
00299     This function removes an APC object from an APC queue. If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> APC object
00300     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not in an APC queue, then no operation <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> performed. Otherwise <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00301     APC object <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> removed from its current queue and its inserted state <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00302     set <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>.
00303 
00304 Arguments:
00305 
00306     Apc - Supplies a pointer to a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> object of <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> APC.
00307 
00308 Return Value:
00309 
00310     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> APC object <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not in an APC queue, then a value of <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
00311     Otherwise a value of <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
00312 
00313 --*/
00314 
00315 {
00316 
00317     <a class="code" href="../../d3/d5/struct__KAPC__STATE.html">PKAPC_STATE</a> ApcState;
00318     BOOLEAN Inserted;
00319     KIRQL OldIrql;
00320     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PRKTHREAD</a> Thread;
00321 
00322     <a class="code" href="../../d5/d7/apcobj_8c.html#a0">ASSERT_APC</a>(Apc);
00323     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(KeGetCurrentIrql() &lt;= DISPATCH_LEVEL);
00324 
00325     <span class="comment">//</span>
00326     <span class="comment">// Raise IRQL to dispatcher level, lock dispatcher database, and</span>
00327     <span class="comment">// lock the APC queue.</span>
00328     <span class="comment">//</span>
00329 
00330     Thread = Apc-&gt;Thread;
00331     <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;OldIrql);
00332     KiAcquireSpinLock(&amp;Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o38">ApcQueueLock</a>);
00333 
00334     <span class="comment">//</span>
00335     <span class="comment">// If the APC object is in an APC queue, then remove it from the queue</span>
00336     <span class="comment">// and set its inserted state to FALSE. If the queue becomes empty, set</span>
00337     <span class="comment">// the APC pending state to FALSE.</span>
00338     <span class="comment">//</span>
00339 
00340     Inserted = Apc-&gt;Inserted;
00341     <span class="keywordflow">if</span> (Inserted != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00342         Apc-&gt;Inserted = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00343         ApcState = Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o49">ApcStatePointer</a>[Apc-&gt;ApcStateIndex];
00344         RemoveEntryList(&amp;Apc-&gt;ApcListEntry);
00345         <span class="keywordflow">if</span> (IsListEmpty(&amp;ApcState-&gt;<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o0">ApcListHead</a>[Apc-&gt;ApcMode]) != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00346             <span class="keywordflow">if</span> (Apc-&gt;ApcMode == <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00347                 ApcState-&gt;<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o3">KernelApcPending</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00348 
00349             } <span class="keywordflow">else</span> {
00350                 ApcState-&gt;<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o4">UserApcPending</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00351             }
00352         }
00353     }
00354 
00355     <span class="comment">//</span>
00356     <span class="comment">// Unlock the APC queue, unlock the dispatcher database, lower IRQL to</span>
00357     <span class="comment">// its previous value, and return whether an APC object was removed from</span>
00358     <span class="comment">// the APC queue.</span>
00359     <span class="comment">//</span>
00360 
00361     KiReleaseSpinLock(&amp;Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o38">ApcQueueLock</a>);
00362     <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(OldIrql);
00363     <span class="keywordflow">return</span> Inserted;
00364 }
}
</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:42:52 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
