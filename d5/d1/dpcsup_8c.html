<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: dpcsup.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>dpcsup.c File Reference</h1><code>#include "<a class="el" href="../../d1/d9/ki_8h-source.html">ki.h</a>"</code><br>

<p>
<a href="../../d6/d0/dpcsup_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Classes</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d6/d8/struct__DPC__ENTRY.html">_DPC_ENTRY</a></td></tr>

<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/dpcsup_8c.html#a0">MAXIMUM_DPC_LIST_SIZE</a>&nbsp;&nbsp;&nbsp;16</td></tr>

<tr><td colspan=2><br><h2>Typedefs</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d6/d8/struct__DPC__ENTRY.html">_DPC_ENTRY</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/dpcsup_8c.html#a1">DPC_ENTRY</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d6/d8/struct__DPC__ENTRY.html">_DPC_ENTRY</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/dpcsup_8c.html#a2">PDPC_ENTRY</a></td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d1/d8/struct__KTHREAD.html">PRKTHREAD</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/dpcsup_8c.html#a3">KiQuantumEnd</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/dpcsup_8c.html#a4">KiTimerExpiration</a> (IN <a class="el" href="../../d1/d6/struct__KDPC.html">PKDPC</a> TimerDpc, IN PVOID DeferredContext, IN PVOID SystemArgument1, IN PVOID SystemArgument2)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/dpcsup_8c.html#a5">KiTimerListExpire</a> (IN PLIST_ENTRY ExpiredListHead, IN KIRQL OldIrql)</td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a0" doxytag="dpcsup.c::MAXIMUM_DPC_LIST_SIZE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define MAXIMUM_DPC_LIST_SIZE&nbsp;&nbsp;&nbsp;16          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/dpcsup_8c-source.html#l00033">33</a> of file <a class="el" href="../../d6/d0/dpcsup_8c-source.html">dpcsup.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/dpcsup_8c-source.html#l00333">KiTimerListExpire()</a>.    </td>
  </tr>
</table>
<hr><h2>Typedef Documentation</h2>
<a class="anchor" name="a1" doxytag="dpcsup.c::DPC_ENTRY" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d6/d8/struct__DPC__ENTRY.html">_DPC_ENTRY</a>  <a class="el" href="../../d6/d8/struct__DPC__ENTRY.html">DPC_ENTRY</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="dpcsup.c::PDPC_ENTRY" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d6/d8/struct__DPC__ENTRY.html">_DPC_ENTRY</a> * <a class="el" href="../../d6/d8/struct__DPC__ENTRY.html">PDPC_ENTRY</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a3" doxytag="dpcsup.c::KiQuantumEnd" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d1/d8/struct__KTHREAD.html">PRKTHREAD</a> KiQuantumEnd           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/dpcsup_8c-source.html#l00043">43</a> of file <a class="el" href="../../d6/d0/dpcsup_8c-source.html">dpcsup.c</a>.
<p>
References <a class="el" href="../../d5/d8/ke_8h-source.html#l00575">_KTHREAD::ApcState</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00590">_KTHREAD::BasePriority</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00775">_KPROCESS::DisableQuantum</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d6/alpha_2kdpcpu_8h-source.html#l00069">KeGetCurrentPrcb</a>, <a class="el" href="../../d3/d6/alpha_2kdpcpu_8h-source.html#l00070">KeGetCurrentThread</a>, <a class="el" href="../../d1/d1/thredsup_8c-source.html#l00095">KiFindReadyThread()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01907">KiLockDispatcherDatabase</a>, <a class="el" href="../../d1/d1/thredsup_8c-source.html#l00576">KiSetPriorityThread()</a>, <a class="el" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00626">_KTHREAD::NextProcessor</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00623">_KTHREAD::Preempted</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00574">_KTHREAD::Priority</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00592">_KTHREAD::PriorityDecrement</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00244">_KAPC_STATE::Process</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00593">_KTHREAD::Quantum</a>, <a class="el" href="../../d4/d9/ke_8h.html#a406a194">Standby</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00569">_KTHREAD::State</a>, and <a class="el" href="../../d5/d8/ke_8h-source.html#l00769">_KPROCESS::ThreadQuantum</a>.
<p>
<pre class="fragment"><div>00049                    :
00050 
00051     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called when a quantum end event occurs on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current
00052     processor. Its function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to determine whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread priority should
00053     be decremented and whether a redispatch of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> processor should occur.
00054 
00055 Arguments:
00056 
00057     None.
00058 
00059 Return Value:
00060 
00061     The next thread to be schedule on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current processor <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned as
00062     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function value. If <span class="keyword">this</span> value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keywordflow">return</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> with
00063     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> dispatcher database locked. Otherwise, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> dispatcher database <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00064     unlocked.
00065 
00066 --*/
00067 
00068 {
00069 
00070     KPRIORITY NewPriority;
00071     KIRQL OldIrql;
00072     PKPRCB Prcb;
00073     KPRIORITY Priority;
00074     <a class="code" href="../../d5/d7/struct__KPROCESS.html">PKPROCESS</a> Process;
00075     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PRKTHREAD</a> Thread;
00076     <a class="code" href="../../d1/d8/struct__KTHREAD.html">PRKTHREAD</a> NextThread;
00077 
00078     <span class="comment">//</span>
00079     <span class="comment">// Acquire the dispatcher database lock.</span>
00080     <span class="comment">//</span>
00081 
00082     Prcb = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a2">KeGetCurrentPrcb</a>();
00083     Thread = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>();
00084     <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;OldIrql);
00085 
00086     <span class="comment">//</span>
00087     <span class="comment">// If the quantum has expired for the current thread, then update its</span>
00088     <span class="comment">// quantum and priority.</span>
00089     <span class="comment">//</span>
00090 
00091     <span class="keywordflow">if</span> (Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o27">Quantum</a> &lt;= 0) {
00092 
00093         <span class="comment">//</span>
00094         <span class="comment">// If quantum runout is disabled for the thread's process and</span>
00095         <span class="comment">// the thread is running at a realtime priority, then set the</span>
00096         <span class="comment">// thread quantum to the highest value and do not round robin</span>
00097         <span class="comment">// at the thread's priority level. Otherwise, reset the thread</span>
00098         <span class="comment">// quantum and decay the thread's priority as appropriate.</span>
00099         <span class="comment">//</span>
00100 
00101         Process = Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o14">ApcState</a>.<a class="code" href="../../d3/d5/struct__KAPC__STATE.html#o1">Process</a>;
00102         <span class="keywordflow">if</span> ((Process-&gt;<a class="code" href="../../d5/d7/struct__KPROCESS.html#o19">DisableQuantum</a> != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) &amp;&amp;
00103             (Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o13">Priority</a> &gt;= LOW_REALTIME_PRIORITY)) {
00104             Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o27">Quantum</a> = MAXCHAR;
00105 
00106         } <span class="keywordflow">else</span> {
00107             Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o27">Quantum</a> = Process-&gt;<a class="code" href="../../d5/d7/struct__KPROCESS.html#o13">ThreadQuantum</a>;
00108 
00109             <span class="comment">//</span>
00110             <span class="comment">// Decrement the thread's current priority if the thread is not</span>
00111             <span class="comment">// running in a realtime priority class and check to determine</span>
00112             <span class="comment">// if the processor should be redispatched.</span>
00113             <span class="comment">//</span>
00114 
00115             Priority = Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o13">Priority</a>;
00116             <span class="keywordflow">if</span> (Priority &lt; LOW_REALTIME_PRIORITY) {
00117                 NewPriority = Priority - Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o26">PriorityDecrement</a> - 1;
00118                 <span class="keywordflow">if</span> (NewPriority &lt; Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o24">BasePriority</a>) {
00119                     NewPriority = Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o24">BasePriority</a>;
00120                 }
00121 
00122                 Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o26">PriorityDecrement</a> = 0;
00123 
00124             } <span class="keywordflow">else</span> {
00125                 NewPriority = Priority;
00126             }
00127 
00128             <span class="comment">//</span>
00129             <span class="comment">// If the new thread priority is different that the current thread</span>
00130             <span class="comment">// priority, then the thread does not run at a realtime level and</span>
00131             <span class="comment">// its priority should be set. Otherwise, attempt to round robin</span>
00132             <span class="comment">// at the current level.</span>
00133             <span class="comment">//</span>
00134 
00135             <span class="keywordflow">if</span> (Priority != NewPriority) {
00136                 <a class="code" href="../../d0/d2/thredsup_8c.html#a5">KiSetPriorityThread</a>(Thread, NewPriority);
00137 
00138             } <span class="keywordflow">else</span> {
00139                 <span class="keywordflow">if</span> (Prcb-&gt;NextThread == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00140                     NextThread = <a class="code" href="../../d0/d2/thredsup_8c.html#a2">KiFindReadyThread</a>(Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o45">NextProcessor</a>, Priority);
00141 
00142                     <span class="keywordflow">if</span> (NextThread != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00143                         NextThread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o8">State</a> = <a class="code" href="../../d4/d9/ke_8h.html#a406a194">Standby</a>;
00144                         Prcb-&gt;NextThread = NextThread;
00145                     }
00146 
00147                 } <span class="keywordflow">else</span> {
00148                     Thread-&gt;<a class="code" href="../../d1/d8/struct__KTHREAD.html#o42">Preempted</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00149                 }
00150             }
00151         }
00152     }
00153 
00154     <span class="comment">//</span>
00155     <span class="comment">// If a thread was scheduled for execution on the current processor,</span>
00156     <span class="comment">// then return the address of the thread with the dispatcher database</span>
00157     <span class="comment">// locked. Otherwise, return NULL with the dispatcher data unlocked.</span>
00158     <span class="comment">//</span>
00159 
00160     NextThread = Prcb-&gt;NextThread;
00161     <span class="keywordflow">if</span> (NextThread == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00162         <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(OldIrql);
00163     }
00164 
00165     <span class="keywordflow">return</span> NextThread;
00166 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="dpcsup.c::KiTimerExpiration" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KiTimerExpiration           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d6/struct__KDPC.html">PKDPC</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>TimerDpc</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>DeferredContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemArgument1</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemArgument2</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/dpcsup_8c-source.html#l00217">217</a> of file <a class="el" href="../../d6/d0/dpcsup_8c-source.html">dpcsup.c</a>.
<p>
References <a class="el" href="../../d5/d8/ke_8h-source.html#l00523">_KTIMER::DueTime</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02776">KeNumberProcessors</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01907">KiLockDispatcherDatabase</a>, <a class="el" href="../../d6/d0/dpcsup_8c-source.html#l00333">KiTimerListExpire()</a>, <a class="el" href="../../d6/d8/kernldat_8c-source.html#l00059">KiTimerTableListHead</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00094">TIMER_TABLE_SIZE</a>, and <a class="el" href="../../d5/d8/ke_8h-source.html#l00524">_KTIMER::TimerListEntry</a>.
<p>
Referenced by <a class="el" href="../../d3/d9/kiinit_8c-source.html#l00096">KiInitSystem()</a>.
<p>
<pre class="fragment"><div>00226                    :
00227 
00228     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> clock interupt routine discovers that
00229     a timer has expired.
00230 
00231 Arguments:
00232 
00233     TimerDpc - Supplies a pointer to a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> object of <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> DPC.
00234 
00235     DeferredContext - Not used.
00236 
00237     SystemArgument1 - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> starting timer table index value to
00238         use <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> timer table scan.
00239 
00240     SystemArgument2 - Not used.
00241 
00242 Return Value:
00243 
00244     None.
00245 
00246 --*/
00247 
00248 {
00249     ULARGE_INTEGER CurrentTime;
00250     LIST_ENTRY ExpiredListHead;
00251     LONG HandLimit;
00252     LONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00253     PLIST_ENTRY ListHead;
00254     PLIST_ENTRY NextEntry;
00255     KIRQL OldIrql;
00256     <a class="code" href="../../d3/d8/struct__KTIMER.html">PKTIMER</a> Timer;
00257 
00258     <span class="comment">//</span>
00259     <span class="comment">// Acquire the dispatcher database lock and read the current interrupt</span>
00260     <span class="comment">// time to determine which timers have expired.</span>
00261     <span class="comment">//</span>
00262 
00263     <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;OldIrql);
00264     KiQueryInterruptTime((PLARGE_INTEGER)&amp;CurrentTime);
00265 
00266     <span class="comment">//</span>
00267     <span class="comment">// If the timer table has not wrapped, then start with the specified</span>
00268     <span class="comment">// timer table index value, and scan for timer entries that have expired.</span>
00269     <span class="comment">// Otherwise, start with the first entry in the timer table and scan the</span>
00270     <span class="comment">// entire table for timer entries that have expired.</span>
00271     <span class="comment">//</span>
00272     <span class="comment">// N.B. This later condition exists when DPC processing is blocked for a</span>
00273     <span class="comment">//      period longer than one round trip throught the timer table.</span>
00274     <span class="comment">//</span>
00275 
00276     HandLimit = (LONG)KiQueryLowTickCount();
00277     <span class="keywordflow">if</span> (((ULONG)(HandLimit - PtrToLong(SystemArgument1))) &gt;= <a class="code" href="../../d4/d9/ke_8h.html#a10">TIMER_TABLE_SIZE</a>) {
00278         <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = - 1;
00279         HandLimit = <a class="code" href="../../d4/d9/ke_8h.html#a10">TIMER_TABLE_SIZE</a> - 1;
00280 
00281     } <span class="keywordflow">else</span> {
00282         <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = (PtrToLong(SystemArgument1) - 1) &amp; (<a class="code" href="../../d4/d9/ke_8h.html#a10">TIMER_TABLE_SIZE</a> - 1);
00283         HandLimit &amp;= (<a class="code" href="../../d4/d9/ke_8h.html#a10">TIMER_TABLE_SIZE</a> - 1);
00284     }
00285 
00286     InitializeListHead(&amp;ExpiredListHead);
00287     <span class="keywordflow">do</span> {
00288         <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> + 1) &amp; (<a class="code" href="../../d4/d9/ke_8h.html#a10">TIMER_TABLE_SIZE</a> - 1);
00289         ListHead = &amp;<a class="code" href="../../d5/d9/kernldat_8c.html#a3">KiTimerTableListHead</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>];
00290         NextEntry = ListHead-&gt;Flink;
00291         <span class="keywordflow">while</span> (NextEntry != ListHead) {
00292             Timer = CONTAINING_RECORD(NextEntry, <a class="code" href="../../d3/d8/struct__KTIMER.html">KTIMER</a>, TimerListEntry);
00293             <span class="keywordflow">if</span> (Timer-&gt;<a class="code" href="../../d3/d8/struct__KTIMER.html#o1">DueTime</a>.QuadPart &lt;= CurrentTime.QuadPart) {
00294 
00295                 <span class="comment">//</span>
00296                 <span class="comment">// The next timer in the current timer list has expired.</span>
00297                 <span class="comment">// Remove the entry from the timer list and insert the</span>
00298                 <span class="comment">// timer in the expired list.</span>
00299                 <span class="comment">//</span>
00300 
00301                 RemoveEntryList(&amp;Timer-&gt;<a class="code" href="../../d3/d8/struct__KTIMER.html#o2">TimerListEntry</a>);
00302                 InsertTailList(&amp;ExpiredListHead, &amp;Timer-&gt;<a class="code" href="../../d3/d8/struct__KTIMER.html#o2">TimerListEntry</a>);
00303                 NextEntry = ListHead-&gt;Flink;
00304 
00305             } <span class="keywordflow">else</span> {
00306                 <span class="keywordflow">break</span>;
00307             }
00308         }
00309 
00310     } <span class="keywordflow">while</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> != HandLimit);
00311 
00312 <span class="preprocessor">#if DBG</span>
00313 <span class="preprocessor"></span>
00314     <span class="keywordflow">if</span> ((PtrToUlong(SystemArgument2) == 0) &amp;&amp; (<a class="code" href="../../d4/d9/ke_8h.html#a133">KeNumberProcessors</a> == 1)) {
00315         KiCheckTimerTable(CurrentTime);
00316     }
00317 
00318 <span class="preprocessor">#endif</span>
00319 <span class="preprocessor"></span>
00320     <span class="comment">//</span>
00321     <span class="comment">// Process the expired timer list.</span>
00322     <span class="comment">//</span>
00323     <span class="comment">// N.B. The following function returns with the dispatcher database</span>
00324     <span class="comment">//      unlocked.</span>
00325     <span class="comment">//</span>
00326 
00327     <a class="code" href="../../d0/d0/ki_8h.html#a141">KiTimerListExpire</a>(&amp;ExpiredListHead, OldIrql);
00328     <span class="keywordflow">return</span>;
00329 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="dpcsup.c::KiTimerListExpire" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID FASTCALL KiTimerListExpire           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PLIST_ENTRY&nbsp;</td>
          <td class="mdname" nowrap> <em>ExpiredListHead</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN KIRQL&nbsp;</td>
          <td class="mdname" nowrap> <em>OldIrql</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/dpcsup_8c-source.html#l00333">333</a> of file <a class="el" href="../../d6/d0/dpcsup_8c-source.html">dpcsup.c</a>.
<p>
References <a class="el" href="../../d6/d0/dpcsup_8c-source.html#l00038">_DPC_ENTRY::Context</a>, <a class="el" href="../../d5/d9/cmconfig_8c-source.html#l00051">Count</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00337">_KDPC::DeferredContext</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00336">_KDPC::DeferredRoutine</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00087">DISPATCH_LEVEL</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00525">_KTIMER::Dpc</a>, <a class="el" href="../../d6/d0/dpcsup_8c-source.html#l00036">_DPC_ENTRY::Dpc</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00522">_KTIMER::Header</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d3/d6/alpha_2kdpcpu_8h-source.html#l00069">KeGetCurrentPrcb</a>, <a class="el" href="../../d5/d0/dpcobj_8c-source.html#l00089">KeInsertQueueDpc()</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql()</a>, <a class="el" href="../../d6/d1/timersup_8c-source.html#l00042">KiInsertTreeTimer()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01907">KiLockDispatcherDatabase</a>, <a class="el" href="../../d1/d9/ki_8h-source.html#l00755">KiRemoveTreeTimer</a>, <a class="el" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase()</a>, <a class="el" href="../../d3/d6/waitsup_8c-source.html#l00277">KiWaitTest()</a>, <a class="el" href="../../d6/d0/dpcsup_8c-source.html#l00033">MAXIMUM_DPC_LIST_SIZE</a>, <a class="el" href="../../d0/d5/ndismain_8h-source.html#l01420">MAXIMUM_PROCESSORS</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00333">_KDPC::Number</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00526">_KTIMER::Period</a>, <a class="el" href="../../d6/d0/dpcsup_8c-source.html#l00037">_DPC_ENTRY::Routine</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l00262">_DISPATCHER_HEADER::SignalState</a>, <a class="el" href="../../d1/d9/ki_8h-source.html#l00038">TIMER_EXPIRE_INCREMENT</a>, and <a class="el" href="../../d5/d8/ke_8h-source.html#l00263">_DISPATCHER_HEADER::WaitListHead</a>.
<p>
Referenced by <a class="el" href="../../d8/d9/ke_2miscc_8c-source.html#l00335">KeSetSystemTime()</a>, and <a class="el" href="../../d6/d0/dpcsup_8c-source.html#l00217">KiTimerExpiration()</a>.
<p>
<pre class="fragment"><div>00340                    :
00341 
00342     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called to process a list of timers that have expired.
00343 
00344     N.B. This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> dispatcher database locked and
00345         returns with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> dispatcher database unlocked.
00346 
00347 Arguments:
00348 
00349     ExpiredListHead - Supplies a pointer to a list of timers that have
00350         expired.
00351 
00352     OldIrql - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> previous IRQL.
00353 
00354 Return Value:
00355 
00356     None.
00357 
00358 --*/
00359 
00360 {
00361 
00362     LONG <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>;
00363     <a class="code" href="../../d1/d6/struct__KDPC.html">PKDPC</a> Dpc;
00364     <a class="code" href="../../d6/d8/struct__DPC__ENTRY.html">DPC_ENTRY</a> DpcList[<a class="code" href="../../d5/d1/dpcsup_8c.html#a0">MAXIMUM_DPC_LIST_SIZE</a>];
00365     LONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00366     LARGE_INTEGER Interval;
00367     KIRQL OldIrql1;
00368     LARGE_INTEGER SystemTime;
00369     <a class="code" href="../../d3/d8/struct__KTIMER.html">PKTIMER</a> Timer;
00370 
00371     <span class="comment">//</span>
00372     <span class="comment">// Capture the timer expiration time.</span>
00373     <span class="comment">//</span>
00374 
00375     KiQuerySystemTime(&amp;SystemTime);
00376 
00377     <span class="comment">//</span>
00378     <span class="comment">// Remove the next timer from the expired timer list, set the state of</span>
00379     <span class="comment">// the timer to signaled, reinsert the timer in the timer tree if it is</span>
00380     <span class="comment">// periodic, and optionally call the DPC routine if one is specified.</span>
00381     <span class="comment">//</span>
00382 
00383 RestartScan:
00384     <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> = 0;
00385     <span class="keywordflow">while</span> (ExpiredListHead-&gt;Flink != ExpiredListHead) {
00386         Timer = CONTAINING_RECORD(ExpiredListHead-&gt;Flink, <a class="code" href="../../d3/d8/struct__KTIMER.html">KTIMER</a>, TimerListEntry);
00387         <a class="code" href="../../d0/d0/ki_8h.html#a22">KiRemoveTreeTimer</a>(Timer);
00388         Timer-&gt;<a class="code" href="../../d3/d8/struct__KTIMER.html#o0">Header</a>.<a class="code" href="../../d1/d6/struct__DISPATCHER__HEADER.html#o4">SignalState</a> = 1;
00389         <span class="keywordflow">if</span> (IsListEmpty(&amp;Timer-&gt;<a class="code" href="../../d3/d8/struct__KTIMER.html#o0">Header</a>.<a class="code" href="../../d1/d6/struct__DISPATCHER__HEADER.html#o5">WaitListHead</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00390             <a class="code" href="../../d2/d7/waitsup_8c.html#a3">KiWaitTest</a>(Timer, TIMER_EXPIRE_INCREMENT);
00391         }
00392 
00393         <span class="comment">//</span>
00394         <span class="comment">// If the timer is periodic, then compute the next interval time</span>
00395         <span class="comment">// and reinsert the timer in the timer tree.</span>
00396         <span class="comment">//</span>
00397         <span class="comment">// N.B. Even though the timer insertion is relative, it can still</span>
00398         <span class="comment">//      fail if the period of the timer elapses in between computing</span>
00399         <span class="comment">//      the time and inserting the timer in the table. If this happens,</span>
00400         <span class="comment">//      try again.</span>
00401         <span class="comment">//</span>
00402         <span class="keywordflow">if</span> (Timer-&gt;<a class="code" href="../../d3/d8/struct__KTIMER.html#o4">Period</a> != 0) {
00403             Interval.QuadPart = Int32x32To64(Timer-&gt;<a class="code" href="../../d3/d8/struct__KTIMER.html#o4">Period</a>, - 10 * 1000);
00404             <span class="keywordflow">while</span> (!<a class="code" href="../../d5/d2/timersup_8c.html#a1">KiInsertTreeTimer</a>(Timer, Interval)) {
00405                 ;
00406             }
00407         }
00408 
00409         <span class="keywordflow">if</span> (Timer-&gt;<a class="code" href="../../d3/d8/struct__KTIMER.html#o3">Dpc</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00410             Dpc = Timer-&gt;<a class="code" href="../../d3/d8/struct__KTIMER.html#o3">Dpc</a>;
00411 
00412             <span class="comment">//</span>
00413             <span class="comment">// If the DPC is explicitly targeted to another processor, then</span>
00414             <span class="comment">// queue the DPC to the target processor. Otherwise, capture the</span>
00415             <span class="comment">// DPC parameters for execution on the current processor.</span>
00416             <span class="comment">//</span>
00417 
00418 <span class="preprocessor">#if defined(NT_UP)</span>
00419 <span class="preprocessor"></span>
00420             DpcList[<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>].<a class="code" href="../../d6/d8/struct__DPC__ENTRY.html#o0">Dpc</a> = Dpc;
00421             DpcList[<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>].<a class="code" href="../../d6/d8/struct__DPC__ENTRY.html#o1">Routine</a> = Dpc-&gt;<a class="code" href="../../d1/d6/struct__KDPC.html#o4">DeferredRoutine</a>;
00422             DpcList[<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>].<a class="code" href="../../d6/d8/struct__DPC__ENTRY.html#o2">Context</a> = Dpc-&gt;<a class="code" href="../../d1/d6/struct__KDPC.html#o5">DeferredContext</a>;
00423             <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> += 1;
00424             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> == <a class="code" href="../../d5/d1/dpcsup_8c.html#a0">MAXIMUM_DPC_LIST_SIZE</a>) {
00425                 <span class="keywordflow">break</span>;
00426             }
00427 
00428 <span class="preprocessor">#else</span>
00429 <span class="preprocessor"></span>
00430             <span class="keywordflow">if</span> ((Dpc-&gt;<a class="code" href="../../d1/d6/struct__KDPC.html#o1">Number</a> &gt;= <a class="code" href="../../d9/d5/ndismain_8h.html#a183">MAXIMUM_PROCESSORS</a>) &amp;&amp;
00431                 (((ULONG)Dpc-&gt;<a class="code" href="../../d1/d6/struct__KDPC.html#o1">Number</a> - <a class="code" href="../../d9/d5/ndismain_8h.html#a183">MAXIMUM_PROCESSORS</a>) != (ULONG)KeGetCurrentProcessorNumber())) {
00432                 <a class="code" href="../../d4/d1/dpcobj_8c.html#a2">KeInsertQueueDpc</a>(Dpc,
00433                                  ULongToPtr(SystemTime.LowPart),
00434                                  ULongToPtr(SystemTime.HighPart));
00435 
00436             } <span class="keywordflow">else</span> {
00437                 DpcList[<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>].<a class="code" href="../../d6/d8/struct__DPC__ENTRY.html#o0">Dpc</a> = Dpc;
00438                 DpcList[<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>].<a class="code" href="../../d6/d8/struct__DPC__ENTRY.html#o1">Routine</a> = Dpc-&gt;<a class="code" href="../../d1/d6/struct__KDPC.html#o4">DeferredRoutine</a>;
00439                 DpcList[<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>].<a class="code" href="../../d6/d8/struct__DPC__ENTRY.html#o2">Context</a> = Dpc-&gt;<a class="code" href="../../d1/d6/struct__KDPC.html#o5">DeferredContext</a>;
00440                 <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> += 1;
00441                 <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> == <a class="code" href="../../d5/d1/dpcsup_8c.html#a0">MAXIMUM_DPC_LIST_SIZE</a>) {
00442                     <span class="keywordflow">break</span>;
00443                 }
00444             }
00445 
00446 <span class="preprocessor">#endif</span>
00447 <span class="preprocessor"></span>
00448         }
00449     }
00450 
00451     <span class="comment">//</span>
00452     <span class="comment">// Unlock the dispacher database and process DPC list entries.</span>
00453     <span class="comment">//</span>
00454 
00455     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> != 0) {
00456         <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(DISPATCH_LEVEL);
00457         <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0;
00458         <span class="keywordflow">do</span> {
00459 
00460 <span class="preprocessor">#if DBG &amp;&amp; (defined(i386) || defined(ALPHA))</span>
00461 <span class="preprocessor"></span>
00462             <span class="comment">//</span>
00463             <span class="comment">// Reset the dpc tick count. If the tick count handler,</span>
00464             <span class="comment">// which increments this value, detects that it has crossed</span>
00465             <span class="comment">// a certain threshold, a breakpoint will be generated.</span>
00466             <span class="comment">//</span>
00467 
00468             <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a2">KeGetCurrentPrcb</a>()-&gt;DebugDpcTime = 0;
00469 <span class="preprocessor">#endif</span>
00470 <span class="preprocessor"></span>
00471             (DpcList[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d6/d8/struct__DPC__ENTRY.html#o1">Routine</a>)(DpcList[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d6/d8/struct__DPC__ENTRY.html#o0">Dpc</a>,
00472                                      DpcList[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d6/d8/struct__DPC__ENTRY.html#o2">Context</a>,
00473                                      ULongToPtr(SystemTime.LowPart),
00474                                      ULongToPtr(SystemTime.HighPart));
00475 
00476 
00477             <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1;
00478         } <span class="keywordflow">while</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>);
00479 
00480         <span class="comment">//</span>
00481         <span class="comment">// If processing of the expired timer list was terminated because</span>
00482         <span class="comment">// the DPC List was full, then process any remaining entries.</span>
00483         <span class="comment">//</span>
00484 
00485         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> == <a class="code" href="../../d5/d1/dpcsup_8c.html#a0">MAXIMUM_DPC_LIST_SIZE</a>) {
00486             <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;OldIrql1);
00487             <span class="keywordflow">goto</span> RestartScan;
00488         }
00489 
00490         <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>(OldIrql);
00491 
00492     } <span class="keywordflow">else</span> {
00493         <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(OldIrql);
00494     }
00495 
00496     <span class="keywordflow">return</span>;
00497 }
}
</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:43:29 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
