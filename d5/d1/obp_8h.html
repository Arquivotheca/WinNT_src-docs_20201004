<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: obp.h File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>obp.h File Reference</h1><code>#include "<a class="el" href="../../d0/d8/ntos_8h-source.html">ntos.h</a>"</code><br>
<code>#include "seopaque.h"</code><br>
<code>#include &lt;zwapi.h&gt;</code><br>

<p>
<a href="../../d6/d0/obp_8h-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Classes</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d0/struct__SECURITY__DESCRIPTOR__HEADER.html">_SECURITY_DESCRIPTOR_HEADER</a></td></tr>

<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/obp_8h.html#a0">ObpBeginTypeSpecificCallOut</a>(IRQL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/obp_8h.html#a1">ObpEndTypeSpecificCallOut</a>(IRQL, str, ot, o)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/obp_8h.html#a2">ObpValidateIrql</a>(str)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/obp_8h.html#a3">ObpIncrPointerCount</a>(np)&nbsp;&nbsp;&nbsp;InterlockedIncrement( &amp;np-&gt;PointerCount )</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/obp_8h.html#a4">ObpDecrPointerCount</a>(np)&nbsp;&nbsp;&nbsp;InterlockedDecrement( &amp;np-&gt;PointerCount )</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/obp_8h.html#a5">ObpDecrPointerCountWithResult</a>(np)&nbsp;&nbsp;&nbsp;(InterlockedDecrement( &amp;np-&gt;PointerCount ) == 0)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/obp_8h.html#a6">ObpIncrHandleCount</a>(np)&nbsp;&nbsp;&nbsp;InterlockedIncrement( &amp;np-&gt;HandleCount )</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/obp_8h.html#a7">ObpDecrHandleCount</a>(np)&nbsp;&nbsp;&nbsp;(InterlockedDecrement( &amp;np-&gt;HandleCount ) == 0)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/obp_8h.html#a8">ObpEnterObjectTypeMutex</a>(_ObjectType)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/obp_8h.html#a9">ObpLeaveObjectTypeMutex</a>(_ObjectType)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/obp_8h.html#a10">ObpEnterRootDirectoryMutex</a>()</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/obp_8h.html#a11">ObpLeaveRootDirectoryMutex</a>()</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/obp_8h.html#a12">ObpGetObjectTable</a>()&nbsp;&nbsp;&nbsp;(PsGetCurrentProcess()-&gt;ObjectTable)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/obp_8h.html#a13">ObpCentralizedSecurity</a>(_ObjectType)&nbsp;&nbsp;&nbsp;((_ObjectType)-&gt;TypeInfo.SecurityProcedure == SeDefaultObjectMethod)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/obp_8h.html#a14">OBP_MAX_DEFINED_OBJECT_TYPES</a>&nbsp;&nbsp;&nbsp;24</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/obp_8h.html#a15">OBJ_PROTECT_CLOSE</a>&nbsp;&nbsp;&nbsp;0x1</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/obp_8h.html#a16">OBJ_AUDIT_OBJECT_CLOSE</a>&nbsp;&nbsp;&nbsp;0x00000004L</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/obp_8h.html#a17">OBJ_HANDLE_ATTRIBUTES</a>&nbsp;&nbsp;&nbsp;(OBJ_PROTECT_CLOSE | OBJ_INHERIT | OBJ_AUDIT_OBJECT_CLOSE)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/obp_8h.html#a18">SD_TO_SD_HEADER</a>(_sd)&nbsp;&nbsp;&nbsp;CONTAINING_RECORD( (_sd), <a class="el" href="../../d9/d0/struct__SECURITY__DESCRIPTOR__HEADER.html">SECURITY_DESCRIPTOR_HEADER</a>, SecurityDescriptor )</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/obp_8h.html#a19">LINK_TO_SD_HEADER</a>(_link)&nbsp;&nbsp;&nbsp;CONTAINING_RECORD( (_link), <a class="el" href="../../d9/d0/struct__SECURITY__DESCRIPTOR__HEADER.html">SECURITY_DESCRIPTOR_HEADER</a>, Link )</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/obp_8h.html#a20">NEXT_SDHEADER</a>(_sdh)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/obp_8h.html#a21">PREV_SDHEADER</a>(_sdh)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/obp_8h.html#a22">SECURITY_DESCRIPTOR_CACHE_ENTRIES</a>&nbsp;&nbsp;&nbsp;256</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/obp_8h.html#a23">OBJECT_NAME_BUFFER_SIZE</a>&nbsp;&nbsp;&nbsp;248</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/obp_8h.html#a24">KERNEL_HANDLE_MASK</a>&nbsp;&nbsp;&nbsp;((ULONG_PTR)((LONG)0x80000000))</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/obp_8h.html#a25">IsKernelHandle</a>(H, M)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/obp_8h.html#a26">EncodeKernelHandle</a>(H)&nbsp;&nbsp;&nbsp;(HANDLE)(KERNEL_HANDLE_MASK | (ULONG_PTR)(H))</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/obp_8h.html#a27">DecodeKernelHandle</a>(H)&nbsp;&nbsp;&nbsp;(HANDLE)(KERNEL_HANDLE_MASK ^ (ULONG_PTR)(H))</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/obp_8h.html#a28">ObpIsOverflow</a>(A, B)&nbsp;&nbsp;&nbsp;((A) &gt; ((A) + (B)))</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/obp_8h.html#a29">ObpFreeObjectCreateInformation</a>(_ObjectCreateInfo)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/obp_8h.html#a30">ObpReleaseObjectCreateInformation</a>(_ObjectCreateInfo)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/obp_8h.html#a31">ObpAllocateObjectCreateInfoBuffer</a>()&nbsp;&nbsp;&nbsp;(<a class="el" href="../../d7/d4/struct__OBJECT__CREATE__INFORMATION.html">POBJECT_CREATE_INFORMATION</a>)ExAllocateFromPPNPagedLookasideList(LookasideCreateInfoList)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/obp_8h.html#a32">ObpFreeObjectCreateInfoBuffer</a>(ObjectCreateInfo)&nbsp;&nbsp;&nbsp;ExFreeToPPNPagedLookasideList(LookasideCreateInfoList, ObjectCreateInfo)</td></tr>

<tr><td colspan=2><br><h2>Typedefs</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d9/d0/struct__SECURITY__DESCRIPTOR__HEADER.html">_SECURITY_DESCRIPTOR_HEADER</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/obp_8h.html#a39">SECURITY_DESCRIPTOR_HEADER</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d9/d0/struct__SECURITY__DESCRIPTOR__HEADER.html">_SECURITY_DESCRIPTOR_HEADER</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/obp_8h.html#a40">PSECURITY_DESCRIPTOR_HEADER</a></td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/obp_8h.html#a55">ObpAcquireDescriptorCacheWriteLock</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/obp_8h.html#a56">ObpAcquireDescriptorCacheReadLock</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/obp_8h.html#a57">ObpReleaseDescriptorCacheLock</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/obp_8h.html#a58">ObpCaptureObjectCreateInformation</a> (IN <a class="el" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> ObjectType OPTIONAL, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> ProbeMode, IN POBJECT_ATTRIBUTES <a class="el" href="../../d8/d0/ctlpcqos_8c.html#a1">ObjectAttributes</a>, OUT PUNICODE_STRING CapturedObjectName, IN <a class="el" href="../../d7/d4/struct__OBJECT__CREATE__INFORMATION.html">POBJECT_CREATE_INFORMATION</a> ObjectCreateInfo, IN LOGICAL UseLookaside)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/obp_8h.html#a59">ObpCaptureObjectName</a> (IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> ProbeMode, IN PUNICODE_STRING ObjectName, IN OUT PUNICODE_STRING CapturedObjectName, IN LOGICAL UseLookaside)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PWCHAR&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/obp_8h.html#a60">ObpAllocateObjectNameBuffer</a> (IN ULONG Length, IN LOGICAL UseLookaside, IN OUT PUNICODE_STRING ObjectName)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/obp_8h.html#a61">ObpFreeObjectNameBuffer</a> (IN PUNICODE_STRING ObjectName)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/obp_8h.html#a62">ObpAllocateObject</a> (IN <a class="el" href="../../d7/d4/struct__OBJECT__CREATE__INFORMATION.html">POBJECT_CREATE_INFORMATION</a> ObjectCreateInfo, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> OwnershipMode, IN <a class="el" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> ObjectType, IN PUNICODE_STRING ObjectName, IN ULONG ObjectBodySize, OUT <a class="el" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> *ReturnedObjectHeader)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/obp_8h.html#a63">ObpFreeObject</a> (IN PVOID Object)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/obp_8h.html#a64">ObpParseSymbolicLink</a> (IN PVOID ParseObject, IN PVOID ObjectType, IN <a class="el" href="../../d2/d5/struct__ACCESS__STATE.html">PACCESS_STATE</a> AccessState, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> AccessMode, IN ULONG Attributes, IN OUT PUNICODE_STRING CompleteName, IN OUT PUNICODE_STRING RemainingName, IN OUT PVOID Context OPTIONAL, IN PSECURITY_QUALITY_OF_SERVICE <a class="el" href="../../d8/d0/ctlpcqos_8c.html#a9">SecurityQos</a> OPTIONAL, OUT PVOID *Object)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/obp_8h.html#a65">ObpDeleteSymbolicLink</a> (IN PVOID Object)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/obp_8h.html#a66">ObpCreateSymbolicLinkName</a> (<a class="el" href="../../d2/d6/struct__OBJECT__SYMBOLIC__LINK.html">POBJECT_SYMBOLIC_LINK</a> SymbolicLink)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/obp_8h.html#a67">ObpDeleteSymbolicLinkName</a> (<a class="el" href="../../d2/d6/struct__OBJECT__SYMBOLIC__LINK.html">POBJECT_SYMBOLIC_LINK</a> SymbolicLink)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PVOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/obp_8h.html#a68">ObpLookupDirectoryEntry</a> (IN <a class="el" href="../../d8/d4/struct__OBJECT__DIRECTORY.html">POBJECT_DIRECTORY</a> Directory, IN PUNICODE_STRING <a class="el" href="../../d9/d3/rules_8c.html#a6">Name</a>, IN ULONG Attributes)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/obp_8h.html#a69">ObpInsertDirectoryEntry</a> (IN <a class="el" href="../../d8/d4/struct__OBJECT__DIRECTORY.html">POBJECT_DIRECTORY</a> Directory, IN PVOID Object)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/obp_8h.html#a70">ObpDeleteDirectoryEntry</a> (IN <a class="el" href="../../d8/d4/struct__OBJECT__DIRECTORY.html">POBJECT_DIRECTORY</a> Directory)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/obp_8h.html#a71">ObpLookupObjectName</a> (IN HANDLE RootDirectoryHandle, IN PUNICODE_STRING ObjectName, IN ULONG Attributes, IN <a class="el" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> ObjectType, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> AccessMode, IN PVOID ParseContext OPTIONAL, IN PSECURITY_QUALITY_OF_SERVICE <a class="el" href="../../d8/d0/ctlpcqos_8c.html#a9">SecurityQos</a> OPTIONAL, IN PVOID InsertObject OPTIONAL, IN OUT <a class="el" href="../../d2/d5/struct__ACCESS__STATE.html">PACCESS_STATE</a> AccessState, OUT PBOOLEAN DirectoryLocked, OUT PVOID *FoundObject)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/obp_8h.html#a72">ObpUnlockObjectDirectoryPath</a> (IN <a class="el" href="../../d8/d4/struct__OBJECT__DIRECTORY.html">POBJECT_DIRECTORY</a> LockedDirectory)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/obp_8h.html#a73">ObpDeleteNameCheck</a> (IN PVOID Object, IN BOOLEAN TypeMutexHeld)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/obp_8h.html#a74">ObpProcessRemoveObjectQueue</a> (PVOID Parameter)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/obp_8h.html#a75">ObpRemoveObjectRoutine</a> (PVOID Object)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d2/d5/struct__OBJECT__HANDLE__COUNT__ENTRY.html">POBJECT_HANDLE_COUNT_ENTRY</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/obp_8h.html#a76">ObpInsertHandleCount</a> (<a class="el" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> ObjectHeader)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/obp_8h.html#a77">ObpIncrementHandleCount</a> (<a class="el" href="../../d4/d0/ob_8h.html#a21">OB_OPEN_REASON</a> OpenReason, <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process, PVOID Object, <a class="el" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> ObjectType, <a class="el" href="../../d2/d5/struct__ACCESS__STATE.html">PACCESS_STATE</a> AccessState OPTIONAL, <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> AccessMode, ULONG Attributes)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/obp_8h.html#a78">ObpDecrementHandleCount</a> (<a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process, <a class="el" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> ObjectHeader, <a class="el" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> ObjectType, ACCESS_MASK GrantedAccess)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/obp_8h.html#a79">ObpCreateHandle</a> (IN <a class="el" href="../../d4/d0/ob_8h.html#a21">OB_OPEN_REASON</a> OpenReason, IN PVOID Object, IN <a class="el" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> ExpectedObjectType OPTIONAL, IN <a class="el" href="../../d2/d5/struct__ACCESS__STATE.html">PACCESS_STATE</a> AccessState, IN ULONG ObjectPointerBias OPTIONAL, IN ULONG Attributes, IN BOOLEAN DirectoryLocked, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> AccessMode, OUT PVOID *ReferencedNewObject OPTIONAL, OUT PHANDLE <a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a29">Handle</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/obp_8h.html#a80">ObpIncrementUnnamedHandleCount</a> (PACCESS_MASK DesiredAccess, <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process, PVOID Object, <a class="el" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> ObjectType, <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> AccessMode, ULONG Attributes)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/obp_8h.html#a81">ObpCreateUnnamedHandle</a> (IN PVOID Object, IN ACCESS_MASK DesiredAccess, IN ULONG ObjectPointerBias OPTIONAL, IN ULONG Attributes, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> AccessMode, OUT PVOID *ReferencedNewObject OPTIONAL, OUT PHANDLE <a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a29">Handle</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/obp_8h.html#a82">ObpChargeQuotaForObject</a> (IN <a class="el" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> ObjectHeader, IN <a class="el" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> ObjectType, OUT PBOOLEAN NewObject)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/obp_8h.html#a83">ObpValidateDesiredAccess</a> (IN ACCESS_MASK DesiredAccess)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/obp_8h.html#a84">ObpCheckPseudoHandleAccess</a> (IN PVOID Object, IN ACCESS_MASK DesiredAccess, OUT PNTSTATUS AccessStatus, IN BOOLEAN TypeMutexLocked)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/obp_8h.html#a85">ObpCheckTraverseAccess</a> (IN PVOID DirectoryObject, IN ACCESS_MASK TraverseAccess, IN <a class="el" href="../../d2/d5/struct__ACCESS__STATE.html">PACCESS_STATE</a> AccessState OPTIONAL, IN BOOLEAN TypeMutexLocked, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode, OUT PNTSTATUS AccessStatus)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/obp_8h.html#a86">ObpCheckObjectReference</a> (IN PVOID Object, IN OUT <a class="el" href="../../d2/d5/struct__ACCESS__STATE.html">PACCESS_STATE</a> AccessState, IN BOOLEAN TypeMutexLocked, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> AccessMode, OUT PNTSTATUS AccessStatus)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/obp_8h.html#a87">ObpInitSecurityDescriptorCache</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/obp_8h.html#a88">ObpHashSecurityDescriptor</a> (PSECURITY_DESCRIPTOR SecurityDescriptor)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/obp_8h.html#a89">ObpHashBuffer</a> (PVOID Data, ULONG Length)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/obp_8h.html#a90">ObpLogSecurityDescriptor</a> (IN PSECURITY_DESCRIPTOR InputSecurityDescriptor, OUT PSECURITY_DESCRIPTOR *OutputSecurityDescriptor)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d9/d0/struct__SECURITY__DESCRIPTOR__HEADER.html">PSECURITY_DESCRIPTOR_HEADER</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/obp_8h.html#a91">ObpCreateCacheEntry</a> (PSECURITY_DESCRIPTOR InputSecurityDescriptor, ULONG FullHash)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PSECURITY_DESCRIPTOR&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/obp_8h.html#a92">ObpReferenceSecurityDescriptor</a> (PVOID Object)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/obp_8h.html#a93">ObpDereferenceSecurityDescriptor</a> (PSECURITY_DESCRIPTOR SecurityDescriptor)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/obp_8h.html#a94">ObpDestroySecurityDescriptorHeader</a> (IN <a class="el" href="../../d9/d0/struct__SECURITY__DESCRIPTOR__HEADER.html">PSECURITY_DESCRIPTOR_HEADER</a> <a class="el" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/obp_8h.html#a95">ObpCompareSecurityDescriptors</a> (IN PSECURITY_DESCRIPTOR SD1, IN PSECURITY_DESCRIPTOR SD2)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/obp_8h.html#a96">ObpValidateAccessMask</a> (<a class="el" href="../../d2/d5/struct__ACCESS__STATE.html">PACCESS_STATE</a> AccessState)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>KSPIN_LOCK&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/obp_8h.html#a33">ObpLock</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d2/d6/struct__KEVENT.html">KEVENT</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/obp_8h.html#a34">ObpDefaultObject</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d7/d9/struct__WORK__QUEUE__ITEM.html">WORK_QUEUE_ITEM</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/obp_8h.html#a35">ObpRemoveObjectWorkItem</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PSINGLE_LIST_ENTRY&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/obp_8h.html#a36">ObpRemoveObjectQueue</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>KSPIN_LOCK&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/obp_8h.html#a37">ObpDeviceMapLock</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/obp_8h.html#a38">ObpObjectTypes</a> [OBP_MAX_DEFINED_OBJECT_TYPES]</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/obp_8h.html#a41">ObpTypeObjectType</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/obp_8h.html#a42">ObpDirectoryObjectType</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/obp_8h.html#a43">ObpSymbolicLinkObjectType</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/obp_8h.html#a44">ObpDeviceMapObjectType</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d8/d4/struct__OBJECT__DIRECTORY.html">POBJECT_DIRECTORY</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/obp_8h.html#a45">ObpRootDirectoryObject</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d8/d4/struct__OBJECT__DIRECTORY.html">POBJECT_DIRECTORY</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/obp_8h.html#a46">ObpTypeDirectoryObject</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULARGE_INTEGER&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/obp_8h.html#a47">ObpDosDevicesShortNamePrefix</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULARGE_INTEGER&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/obp_8h.html#a48">ObpDosDevicesShortNameRoot</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>UNICODE_STRING&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/obp_8h.html#a49">ObpDosDevicesShortName</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d6/d4/struct__ERESOURCE.html">ERESOURCE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/obp_8h.html#a50">ObpRootDirectoryMutex</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d6/d4/struct__ERESOURCE.html">ERESOURCE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/obp_8h.html#a51">SecurityDescriptorCacheLock</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html">NPAGED_LOOKASIDE_LIST</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/obp_8h.html#a52">ObpCreateInfoLookasideList</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html">NPAGED_LOOKASIDE_LIST</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/obp_8h.html#a53">ObpNameBufferLookasideList</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d6/d3/struct__HANDLE__TABLE.html">PHANDLE_TABLE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/obp_8h.html#a54">ObpKernelHandleTable</a></td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a27" doxytag="obp.h::DecodeKernelHandle" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define DecodeKernelHandle          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">H&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;(HANDLE)(KERNEL_HANDLE_MASK ^ (ULONG_PTR)(H))</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/obp_8h-source.html#l00418">418</a> of file <a class="el" href="../../d6/d0/obp_8h-source.html">obp.h</a>.
<p>
Referenced by <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d7/d0/obquery_8c-source.html#l00545">NtSetInformationObject()</a>, <a class="el" href="../../d2/d1/obwait_8c-source.html#l00406">NtWaitForMultipleObjects()</a>, and <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a26" doxytag="obp.h::EncodeKernelHandle" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define EncodeKernelHandle          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">H&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;(HANDLE)(KERNEL_HANDLE_MASK | (ULONG_PTR)(H))</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/obp_8h-source.html#l00416">416</a> of file <a class="el" href="../../d6/d0/obp_8h-source.html">obp.h</a>.
<p>
Referenced by <a class="el" href="../../d0/d0/obhandle_8c-source.html#l02160">ObpCreateHandle()</a>, and <a class="el" href="../../d0/d0/obhandle_8c-source.html#l02507">ObpCreateUnnamedHandle()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a25" doxytag="obp.h::IsKernelHandle" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define IsKernelHandle          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">H,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>M&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>(((<a class="code" href="../../d5/d1/obp_8h.html#a24">KERNEL_HANDLE_MASK</a> &amp; (ULONG_PTR)(H)) == <a class="code" href="../../d5/d1/obp_8h.html#a24">KERNEL_HANDLE_MASK</a>) &amp;&amp; \
     ((M) == <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) &amp;&amp;                                \
     ((H) != NtCurrentThread()) &amp;&amp;                         \
     ((H) != NtCurrentProcess()))
</div></pre>
<p>
Definition at line <a class="el" href="../../d6/d0/obp_8h-source.html#l00410">410</a> of file <a class="el" href="../../d6/d0/obp_8h-source.html">obp.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a24" doxytag="obp.h::KERNEL_HANDLE_MASK" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define KERNEL_HANDLE_MASK&nbsp;&nbsp;&nbsp;((ULONG_PTR)((LONG)0x80000000))          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/obp_8h-source.html#l00408">408</a> of file <a class="el" href="../../d6/d0/obp_8h-source.html">obp.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a19" doxytag="obp.h::LINK_TO_SD_HEADER" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define LINK_TO_SD_HEADER          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">_link&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;CONTAINING_RECORD( (_link), <a class="el" href="../../d9/d0/struct__SECURITY__DESCRIPTOR__HEADER.html">SECURITY_DESCRIPTOR_HEADER</a>, Link )</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/obp_8h-source.html#l00318">318</a> of file <a class="el" href="../../d6/d0/obp_8h-source.html">obp.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d0/obsdata_8c-source.html#l00297">ObpLogSecurityDescriptor()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a20" doxytag="obp.h::NEXT_SDHEADER" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define NEXT_SDHEADER          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">_sdh&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>(                                                 \
    (_sdh)-&gt;Link.Flink == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ? <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> :                                       \
    CONTAINING_RECORD( (_sdh)-&gt;Link.Flink, <a class="code" href="../../d9/d0/struct__SECURITY__DESCRIPTOR__HEADER.html">SECURITY_DESCRIPTOR_HEADER</a>, Link ) \
)
</div></pre>
<p>
Definition at line <a class="el" href="../../d6/d0/obp_8h-source.html#l00325">325</a> of file <a class="el" href="../../d6/d0/obp_8h-source.html">obp.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a16" doxytag="obp.h::OBJ_AUDIT_OBJECT_CLOSE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define OBJ_AUDIT_OBJECT_CLOSE&nbsp;&nbsp;&nbsp;0x00000004L          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/obp_8h-source.html#l00282">282</a> of file <a class="el" href="../../d6/d0/obp_8h-source.html">obp.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a17" doxytag="obp.h::OBJ_HANDLE_ATTRIBUTES" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define OBJ_HANDLE_ATTRIBUTES&nbsp;&nbsp;&nbsp;(OBJ_PROTECT_CLOSE | OBJ_INHERIT | OBJ_AUDIT_OBJECT_CLOSE)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/obp_8h-source.html#l00289">289</a> of file <a class="el" href="../../d6/d0/obp_8h-source.html">obp.h</a>.
<p>
Referenced by <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d0/d0/obhandle_8c-source.html#l00163">NtDuplicateObject()</a>, <a class="el" href="../../d2/d1/obwait_8c-source.html#l00406">NtWaitForMultipleObjects()</a>, <a class="el" href="../../d1/d0/obinit_8c-source.html#l00658">ObDupHandleProcedure()</a>, <a class="el" href="../../d0/d0/obhandle_8c-source.html#l00807">ObpCaptureHandleInformation()</a>, <a class="el" href="../../d0/d0/obhandle_8c-source.html#l02160">ObpCreateHandle()</a>, <a class="el" href="../../d0/d0/obhandle_8c-source.html#l02507">ObpCreateUnnamedHandle()</a>, <a class="el" href="../../d1/d0/obinit_8c-source.html#l01127">ObpEnumFindHandleProcedure()</a>, <a class="el" href="../../d7/d0/obquery_8c-source.html#l01469">ObpSetHandleAttributes()</a>, and <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a15" doxytag="obp.h::OBJ_PROTECT_CLOSE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define OBJ_PROTECT_CLOSE&nbsp;&nbsp;&nbsp;0x1          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/obp_8h-source.html#l00261">261</a> of file <a class="el" href="../../d6/d0/obp_8h-source.html">obp.h</a>.
<p>
Referenced by <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d7/d0/obquery_8c-source.html#l00058">NtQueryObject()</a>, and <a class="el" href="../../d7/d0/obquery_8c-source.html#l01469">ObpSetHandleAttributes()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a23" doxytag="obp.h::OBJECT_NAME_BUFFER_SIZE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define OBJECT_NAME_BUFFER_SIZE&nbsp;&nbsp;&nbsp;248          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/obp_8h-source.html#l00390">390</a> of file <a class="el" href="../../d6/d0/obp_8h-source.html">obp.h</a>.
<p>
Referenced by <a class="el" href="../../d1/d0/obinit_8c-source.html#l00117">ObInitSystem()</a>, <a class="el" href="../../d7/d9/obcreate_8c-source.html#l00583">ObpAllocateObjectNameBuffer()</a>, and <a class="el" href="../../d7/d9/obcreate_8c-source.html#l00663">ObpFreeObjectNameBuffer()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a14" doxytag="obp.h::OBP_MAX_DEFINED_OBJECT_TYPES" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define OBP_MAX_DEFINED_OBJECT_TYPES&nbsp;&nbsp;&nbsp;24          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/obp_8h-source.html#l00228">228</a> of file <a class="el" href="../../d6/d0/obp_8h-source.html">obp.h</a>.
<p>
Referenced by <a class="el" href="../../d7/d0/obquery_8c-source.html#l00058">NtQueryObject()</a>, and <a class="el" href="../../d1/d1/obtype_8c-source.html#l00069">ObCreateObjectType()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a31" doxytag="obp.h::ObpAllocateObjectCreateInfoBuffer" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define ObpAllocateObjectCreateInfoBuffer          </td>
          <td class="md" valign="top">(&nbsp;</td>
&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;(<a class="el" href="../../d7/d4/struct__OBJECT__CREATE__INFORMATION.html">POBJECT_CREATE_INFORMATION</a>)ExAllocateFromPPNPagedLookasideList(LookasideCreateInfoList)</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/obp_8h-source.html#l00519">519</a> of file <a class="el" href="../../d6/d0/obp_8h-source.html">obp.h</a>.
<p>
Referenced by <a class="el" href="../../d7/d9/obcreate_8c-source.html#l00055">ObCreateObject()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="obp.h::ObpBeginTypeSpecificCallOut" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define ObpBeginTypeSpecificCallOut          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IRQL&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/obp_8h-source.html#l00056">56</a> of file <a class="el" href="../../d6/d0/obp_8h-source.html">obp.h</a>.
<p>
Referenced by <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d0/d1/obse_8c-source.html#l01574">ObAssignSecurity()</a>, <a class="el" href="../../d0/d1/obse_8c-source.html#l01258">ObGetObjectSecurity()</a>, <a class="el" href="../../d0/d0/obhandle_8c-source.html#l01967">ObpDecrementHandleCount()</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l01497">ObpDeleteNameCheck()</a>, <a class="el" href="../../d0/d0/obhandle_8c-source.html#l01232">ObpIncrementHandleCount()</a>, <a class="el" href="../../d0/d0/obhandle_8c-source.html#l01587">ObpIncrementUnnamedHandleCount()</a>, <a class="el" href="../../d9/d9/obdir_8c-source.html#l01081">ObpLookupObjectName()</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l01370">ObpRemoveObjectRoutine()</a>, and <a class="el" href="../../d7/d0/obquery_8c-source.html#l00713">ObQueryNameString()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a13" doxytag="obp.h::ObpCentralizedSecurity" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define ObpCentralizedSecurity          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">_ObjectType&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;((_ObjectType)-&gt;TypeInfo.SecurityProcedure == SeDefaultObjectMethod)</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/obp_8h-source.html#l00221">221</a> of file <a class="el" href="../../d6/d0/obp_8h-source.html">obp.h</a>.
<p>
Referenced by <a class="el" href="../../d0/d1/obse_8c-source.html#l01258">ObGetObjectSecurity()</a>, and <a class="el" href="../../d9/d0/obsdata_8c-source.html#l00559">ObpReferenceSecurityDescriptor()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="obp.h::ObpDecrHandleCount" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define ObpDecrHandleCount          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">np&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;(InterlockedDecrement( &amp;np-&gt;HandleCount ) == 0)</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/obp_8h-source.html#l00148">148</a> of file <a class="el" href="../../d6/d0/obp_8h-source.html">obp.h</a>.
<p>
Referenced by <a class="el" href="../../d0/d0/obhandle_8c-source.html#l01967">ObpDecrementHandleCount()</a>, <a class="el" href="../../d0/d0/obhandle_8c-source.html#l01232">ObpIncrementHandleCount()</a>, and <a class="el" href="../../d0/d0/obhandle_8c-source.html#l01587">ObpIncrementUnnamedHandleCount()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="obp.h::ObpDecrPointerCount" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define ObpDecrPointerCount          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">np&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;InterlockedDecrement( &amp;np-&gt;PointerCount )</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/obp_8h-source.html#l00144">144</a> of file <a class="el" href="../../d6/d0/obp_8h-source.html">obp.h</a>.
<p>
Referenced by <a class="el" href="../../d0/d0/obhandle_8c-source.html#l02160">ObpCreateHandle()</a>, and <a class="el" href="../../d0/d0/obhandle_8c-source.html#l02507">ObpCreateUnnamedHandle()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="obp.h::ObpDecrPointerCountWithResult" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define ObpDecrPointerCountWithResult          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">np&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;(InterlockedDecrement( &amp;np-&gt;PointerCount ) == 0)</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/obp_8h-source.html#l00145">145</a> of file <a class="el" href="../../d6/d0/obp_8h-source.html">obp.h</a>.
<p>
Referenced by <a class="el" href="../../d8/d0/obref_8c-source.html#l01124">ObfDereferenceObject()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="obp.h::ObpEndTypeSpecificCallOut" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define ObpEndTypeSpecificCallOut          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IRQL,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>str,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ot,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>o&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/obp_8h-source.html#l00057">57</a> of file <a class="el" href="../../d6/d0/obp_8h-source.html">obp.h</a>.
<p>
Referenced by <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d0/d1/obse_8c-source.html#l01574">ObAssignSecurity()</a>, <a class="el" href="../../d0/d1/obse_8c-source.html#l01258">ObGetObjectSecurity()</a>, <a class="el" href="../../d0/d0/obhandle_8c-source.html#l01967">ObpDecrementHandleCount()</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l01497">ObpDeleteNameCheck()</a>, <a class="el" href="../../d0/d0/obhandle_8c-source.html#l01232">ObpIncrementHandleCount()</a>, <a class="el" href="../../d0/d0/obhandle_8c-source.html#l01587">ObpIncrementUnnamedHandleCount()</a>, <a class="el" href="../../d9/d9/obdir_8c-source.html#l01081">ObpLookupObjectName()</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l01370">ObpRemoveObjectRoutine()</a>, and <a class="el" href="../../d7/d0/obquery_8c-source.html#l00713">ObQueryNameString()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="obp.h::ObpEnterObjectTypeMutex" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define ObpEnterObjectTypeMutex          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">_ObjectType&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>{                   \
    <a class="code" href="../../d5/d1/obp_8h.html#a2">ObpValidateIrql</a>(<span class="stringliteral">"ObpEnterObjectTypeMutex"</span>);                  \
    <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();                                     \
    <a class="code" href="../../d8/d8/ex_2resource_8c.html#a18">ExAcquireResourceExclusiveLite</a>(&amp;(_ObjectType)-&gt;Mutex, TRUE); \
}
</div></pre>
<p>
Definition at line <a class="el" href="../../d6/d0/obp_8h-source.html#l00163">163</a> of file <a class="el" href="../../d6/d0/obp_8h-source.html">obp.h</a>.
<p>
Referenced by <a class="el" href="../../d5/d0/oblink_8c-source.html#l00333">NtQuerySymbolicLinkObject()</a>, <a class="el" href="../../d0/d1/obse_8c-source.html#l00983">ObCheckCreateObjectAccess()</a>, <a class="el" href="../../d0/d1/obse_8c-source.html#l00392">ObCheckObjectAccess()</a>, <a class="el" href="../../d1/d1/obtype_8c-source.html#l00069">ObCreateObjectType()</a>, <a class="el" href="../../d1/d1/obtype_8c-source.html#l00478">ObEnumerateObjectsByType()</a>, <a class="el" href="../../d1/d1/obtype_8c-source.html#l00800">ObGetObjectInformation()</a>, <a class="el" href="../../d0/d1/obse_8c-source.html#l00602">ObpCheckObjectReference()</a>, <a class="el" href="../../d0/d1/obse_8c-source.html#l00778">ObpCheckTraverseAccess()</a>, <a class="el" href="../../d1/d1/obtype_8c-source.html#l00607">ObpCreateTypeArray()</a>, <a class="el" href="../../d0/d0/obhandle_8c-source.html#l01967">ObpDecrementHandleCount()</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l01497">ObpDeleteNameCheck()</a>, <a class="el" href="../../d0/d0/obhandle_8c-source.html#l01232">ObpIncrementHandleCount()</a>, <a class="el" href="../../d0/d0/obhandle_8c-source.html#l01587">ObpIncrementUnnamedHandleCount()</a>, and <a class="el" href="../../d8/d0/obref_8c-source.html#l01370">ObpRemoveObjectRoutine()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="obp.h::ObpEnterRootDirectoryMutex" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define ObpEnterRootDirectoryMutex          </td>
          <td class="md" valign="top">(&nbsp;</td>
&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>{                            \
    <a class="code" href="../../d5/d1/obp_8h.html#a2">ObpValidateIrql</a>(<span class="stringliteral">"ObpEnterRootDirectoryMutex"</span>);                \
    <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();                                      \
    <a class="code" href="../../d8/d8/ex_2resource_8c.html#a18">ExAcquireResourceExclusiveLite</a>(&amp;ObpRootDirectoryMutex, TRUE); \
}
</div></pre>
<p>
Definition at line <a class="el" href="../../d6/d0/obp_8h-source.html#l00189">189</a> of file <a class="el" href="../../d6/d0/obp_8h-source.html">obp.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d9/obdir_8c-source.html#l00229">NtQueryDirectoryObject()</a>, <a class="el" href="../../d7/d0/obquery_8c-source.html#l00058">NtQueryObject()</a>, <a class="el" href="../../d1/d1/obtype_8c-source.html#l00069">ObCreateObjectType()</a>, <a class="el" href="../../d1/d0/obinit_8c-source.html#l00117">ObInitSystem()</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l01497">ObpDeleteNameCheck()</a>, <a class="el" href="../../d5/d0/oblink_8c-source.html#l00951">ObpDeleteSymbolicLinkName()</a>, <a class="el" href="../../d9/d9/obdir_8c-source.html#l01081">ObpLookupObjectName()</a>, <a class="el" href="../../d5/d0/oblink_8c-source.html#l00501">ObpParseSymbolicLink()</a>, and <a class="el" href="../../d7/d0/obquery_8c-source.html#l00713">ObQueryNameString()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a32" doxytag="obp.h::ObpFreeObjectCreateInfoBuffer" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define ObpFreeObjectCreateInfoBuffer          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">ObjectCreateInfo&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;ExFreeToPPNPagedLookasideList(LookasideCreateInfoList, ObjectCreateInfo)</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/obp_8h-source.html#l00547">547</a> of file <a class="el" href="../../d6/d0/obp_8h-source.html">obp.h</a>.
<p>
Referenced by <a class="el" href="../../d7/d9/obcreate_8c-source.html#l00055">ObCreateObject()</a>, and <a class="el" href="../../d7/d9/obcreate_8c-source.html#l01279">ObFreeObjectCreateInfoBuffer()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a29" doxytag="obp.h::ObpFreeObjectCreateInformation" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define ObpFreeObjectCreateInformation          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">_ObjectCreateInfo&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>{ \
    <a class="code" href="../../d5/d1/obp_8h.html#a30">ObpReleaseObjectCreateInformation</a>((_ObjectCreateInfo)); \
    <a class="code" href="../../d5/d1/obp_8h.html#a32">ObpFreeObjectCreateInfoBuffer</a>((_ObjectCreateInfo));     \
}
</div></pre>
<p>
Definition at line <a class="el" href="../../d6/d0/obp_8h-source.html#l00431">431</a> of file <a class="el" href="../../d6/d0/obp_8h-source.html">obp.h</a>.
<p>
Referenced by <a class="el" href="../../d7/d9/obcreate_8c-source.html#l00713">ObDeleteCapturedInsertInfo()</a>, <a class="el" href="../../d2/d0/obinsert_8c-source.html#l00029">ObInsertObject()</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00095">ObOpenObjectByName()</a>, and <a class="el" href="../../d7/d9/obcreate_8c-source.html#l01098">ObpFreeObject()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a12" doxytag="obp.h::ObpGetObjectTable" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define ObpGetObjectTable          </td>
          <td class="md" valign="top">(&nbsp;</td>
&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;(PsGetCurrentProcess()-&gt;ObjectTable)</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/obp_8h-source.html#l00213">213</a> of file <a class="el" href="../../d6/d0/obp_8h-source.html">obp.h</a>.
<p>
Referenced by <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d0/d0/obhandle_8c-source.html#l00163">NtDuplicateObject()</a>, <a class="el" href="../../d7/d0/obquery_8c-source.html#l00545">NtSetInformationObject()</a>, <a class="el" href="../../d2/d1/obwait_8c-source.html#l00406">NtWaitForMultipleObjects()</a>, <a class="el" href="../../d0/d0/obhandle_8c-source.html#l02160">ObpCreateHandle()</a>, <a class="el" href="../../d0/d0/obhandle_8c-source.html#l02507">ObpCreateUnnamedHandle()</a>, <a class="el" href="../../d7/d0/obquery_8c-source.html#l01319">ObQueryObjectAuditingByHandle()</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, and <a class="el" href="../../d4/d2/tob_8c-source.html#l00187">obtest()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="obp.h::ObpIncrHandleCount" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define ObpIncrHandleCount          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">np&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;InterlockedIncrement( &amp;np-&gt;HandleCount )</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/obp_8h-source.html#l00147">147</a> of file <a class="el" href="../../d6/d0/obp_8h-source.html">obp.h</a>.
<p>
Referenced by <a class="el" href="../../d0/d0/obhandle_8c-source.html#l01232">ObpIncrementHandleCount()</a>, and <a class="el" href="../../d0/d0/obhandle_8c-source.html#l01587">ObpIncrementUnnamedHandleCount()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="obp.h::ObpIncrPointerCount" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define ObpIncrPointerCount          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">np&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;InterlockedIncrement( &amp;np-&gt;PointerCount )</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/obp_8h-source.html#l00143">143</a> of file <a class="el" href="../../d6/d0/obp_8h-source.html">obp.h</a>.
<p>
Referenced by <a class="el" href="../../d2/d1/obwait_8c-source.html#l00406">NtWaitForMultipleObjects()</a>, <a class="el" href="../../d1/d0/obinit_8c-source.html#l00658">ObDupHandleProcedure()</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l01087">ObfReferenceObject()</a>, <a class="el" href="../../d0/d0/obhandle_8c-source.html#l02160">ObpCreateHandle()</a>, <a class="el" href="../../d0/d0/obhandle_8c-source.html#l02507">ObpCreateUnnamedHandle()</a>, <a class="el" href="../../d9/d9/obdir_8c-source.html#l01081">ObpLookupObjectName()</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, and <a class="el" href="../../d8/d0/obref_8c-source.html#l01022">ObReferenceObjectByPointer()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a28" doxytag="obp.h::ObpIsOverflow" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define ObpIsOverflow          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">A,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>B&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;((A) &gt; ((A) + (B)))</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/obp_8h-source.html#l00424">424</a> of file <a class="el" href="../../d6/d0/obp_8h-source.html">obp.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d9/obdir_8c-source.html#l00229">NtQueryDirectoryObject()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="obp.h::ObpLeaveObjectTypeMutex" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define ObpLeaveObjectTypeMutex          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">_ObjectType&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>{  \
    <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;(_ObjectType)-&gt;Mutex);   \
    <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();                    \
    <a class="code" href="../../d5/d1/obp_8h.html#a2">ObpValidateIrql</a>(<span class="stringliteral">"ObpLeaveObjectTypeMutex"</span>); \
}
</div></pre>
<p>
Definition at line <a class="el" href="../../d6/d0/obp_8h-source.html#l00176">176</a> of file <a class="el" href="../../d6/d0/obp_8h-source.html">obp.h</a>.
<p>
Referenced by <a class="el" href="../../d5/d0/oblink_8c-source.html#l00333">NtQuerySymbolicLinkObject()</a>, <a class="el" href="../../d0/d1/obse_8c-source.html#l00983">ObCheckCreateObjectAccess()</a>, <a class="el" href="../../d0/d1/obse_8c-source.html#l00392">ObCheckObjectAccess()</a>, <a class="el" href="../../d1/d1/obtype_8c-source.html#l00069">ObCreateObjectType()</a>, <a class="el" href="../../d1/d1/obtype_8c-source.html#l00478">ObEnumerateObjectsByType()</a>, <a class="el" href="../../d1/d1/obtype_8c-source.html#l00800">ObGetObjectInformation()</a>, <a class="el" href="../../d0/d1/obse_8c-source.html#l00602">ObpCheckObjectReference()</a>, <a class="el" href="../../d0/d1/obse_8c-source.html#l00778">ObpCheckTraverseAccess()</a>, <a class="el" href="../../d1/d1/obtype_8c-source.html#l00607">ObpCreateTypeArray()</a>, <a class="el" href="../../d0/d0/obhandle_8c-source.html#l01967">ObpDecrementHandleCount()</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l01497">ObpDeleteNameCheck()</a>, <a class="el" href="../../d0/d0/obhandle_8c-source.html#l01232">ObpIncrementHandleCount()</a>, <a class="el" href="../../d0/d0/obhandle_8c-source.html#l01587">ObpIncrementUnnamedHandleCount()</a>, and <a class="el" href="../../d8/d0/obref_8c-source.html#l01370">ObpRemoveObjectRoutine()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="obp.h::ObpLeaveRootDirectoryMutex" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define ObpLeaveRootDirectoryMutex          </td>
          <td class="md" valign="top">(&nbsp;</td>
&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>{             \
    <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;ObpRootDirectoryMutex);     \
    <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();                       \
    <a class="code" href="../../d5/d1/obp_8h.html#a2">ObpValidateIrql</a>(<span class="stringliteral">"ObpLeaveRootDirectoryMutex"</span>); \
}
</div></pre>
<p>
Definition at line <a class="el" href="../../d6/d0/obp_8h-source.html#l00202">202</a> of file <a class="el" href="../../d6/d0/obp_8h-source.html">obp.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d9/obdir_8c-source.html#l00229">NtQueryDirectoryObject()</a>, <a class="el" href="../../d7/d0/obquery_8c-source.html#l00058">NtQueryObject()</a>, <a class="el" href="../../d1/d1/obtype_8c-source.html#l00069">ObCreateObjectType()</a>, <a class="el" href="../../d1/d0/obinit_8c-source.html#l00117">ObInitSystem()</a>, <a class="el" href="../../d2/d0/obinsert_8c-source.html#l00029">ObInsertObject()</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00095">ObOpenObjectByName()</a>, <a class="el" href="../../d0/d0/obhandle_8c-source.html#l02160">ObpCreateHandle()</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l01497">ObpDeleteNameCheck()</a>, <a class="el" href="../../d5/d0/oblink_8c-source.html#l00951">ObpDeleteSymbolicLinkName()</a>, <a class="el" href="../../d9/d9/obdir_8c-source.html#l01081">ObpLookupObjectName()</a>, <a class="el" href="../../d5/d0/oblink_8c-source.html#l00501">ObpParseSymbolicLink()</a>, <a class="el" href="../../d7/d0/obquery_8c-source.html#l00713">ObQueryNameString()</a>, and <a class="el" href="../../d8/d0/obref_8c-source.html#l00844">ObReferenceObjectByName()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a30" doxytag="obp.h::ObpReleaseObjectCreateInformation" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define ObpReleaseObjectCreateInformation          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">_ObjectCreateInfo&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>{               \
    <span class="keywordflow">if</span> ((_ObjectCreateInfo)-&gt;SecurityDescriptor != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {                   \
        <a class="code" href="../../d0/d5/se_8h.html#a117">SeReleaseSecurityDescriptor</a>((_ObjectCreateInfo)-&gt;SecurityDescriptor, \
                                    (_ObjectCreateInfo)-&gt;ProbeMode,          \
                                     TRUE);                                  \
        (_ObjectCreateInfo)-&gt;SecurityDescriptor = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;                      \
    }                                                                        \
}
</div></pre>
<p>
Definition at line <a class="el" href="../../d6/d0/obp_8h-source.html#l00436">436</a> of file <a class="el" href="../../d6/d0/obp_8h-source.html">obp.h</a>.
<p>
Referenced by <a class="el" href="../../d7/d9/obcreate_8c-source.html#l00055">ObCreateObject()</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00095">ObOpenObjectByName()</a>, and <a class="el" href="../../d7/d9/obcreate_8c-source.html#l00248">ObpCaptureObjectCreateInformation()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="obp.h::ObpValidateIrql" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define ObpValidateIrql          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">str&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/obp_8h-source.html#l00071">71</a> of file <a class="el" href="../../d6/d0/obp_8h-source.html">obp.h</a>.
<p>
Referenced by <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d9/d9/obdir_8c-source.html#l00032">NtCreateDirectoryObject()</a>, <a class="el" href="../../d9/d9/obdir_8c-source.html#l00144">NtOpenDirectoryObject()</a>, <a class="el" href="../../d9/d9/obdir_8c-source.html#l00229">NtQueryDirectoryObject()</a>, <a class="el" href="../../d1/d1/obtype_8c-source.html#l00069">ObCreateObjectType()</a>, <a class="el" href="../../d2/d0/obinsert_8c-source.html#l00029">ObInsertObject()</a>, <a class="el" href="../../d1/d0/obinit_8c-source.html#l01022">ObKillProcess()</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00095">ObOpenObjectByName()</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00367">ObOpenObjectByPointer()</a>, <a class="el" href="../../d0/d0/obhandle_8c-source.html#l02160">ObpCreateHandle()</a>, <a class="el" href="../../d0/d0/obhandle_8c-source.html#l02507">ObpCreateUnnamedHandle()</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l01497">ObpDeleteNameCheck()</a>, <a class="el" href="../../d0/d0/obhandle_8c-source.html#l01232">ObpIncrementHandleCount()</a>, <a class="el" href="../../d0/d0/obhandle_8c-source.html#l01587">ObpIncrementUnnamedHandleCount()</a>, <a class="el" href="../../d9/d9/obdir_8c-source.html#l01081">ObpLookupObjectName()</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l01370">ObpRemoveObjectRoutine()</a>, <a class="el" href="../../d7/d0/obquery_8c-source.html#l01319">ObQueryObjectAuditingByHandle()</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, and <a class="el" href="../../d8/d0/obref_8c-source.html#l00844">ObReferenceObjectByName()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a21" doxytag="obp.h::PREV_SDHEADER" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PREV_SDHEADER          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">_sdh&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>(                                                \
    (sdh)-&gt;Link.Blink == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ? <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> :                                       \
    CONTAINING_RECORD( (sdh)-&gt;Link.Blink, <a class="code" href="../../d9/d0/struct__SECURITY__DESCRIPTOR__HEADER.html">SECURITY_DESCRIPTOR_HEADER</a>, Link ) \
)
</div></pre>
<p>
Definition at line <a class="el" href="../../d6/d0/obp_8h-source.html#l00330">330</a> of file <a class="el" href="../../d6/d0/obp_8h-source.html">obp.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a18" doxytag="obp.h::SD_TO_SD_HEADER" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define SD_TO_SD_HEADER          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">_sd&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;CONTAINING_RECORD( (_sd), <a class="el" href="../../d9/d0/struct__SECURITY__DESCRIPTOR__HEADER.html">SECURITY_DESCRIPTOR_HEADER</a>, SecurityDescriptor )</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/obp_8h-source.html#l00311">311</a> of file <a class="el" href="../../d6/d0/obp_8h-source.html">obp.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d0/obsdata_8c-source.html#l00637">ObDeassignSecurity()</a>, <a class="el" href="../../d9/d0/obsdata_8c-source.html#l00700">ObpDereferenceSecurityDescriptor()</a>, and <a class="el" href="../../d9/d0/obsdata_8c-source.html#l00559">ObpReferenceSecurityDescriptor()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a22" doxytag="obp.h::SECURITY_DESCRIPTOR_CACHE_ENTRIES" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define SECURITY_DESCRIPTOR_CACHE_ENTRIES&nbsp;&nbsp;&nbsp;256          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/obp_8h-source.html#l00339">339</a> of file <a class="el" href="../../d6/d0/obp_8h-source.html">obp.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d0/obsdata_8c-source.html#l00118">ObpInitSecurityDescriptorCache()</a>.    </td>
  </tr>
</table>
<hr><h2>Typedef Documentation</h2>
<a class="anchor" name="a40" doxytag="obp.h::PSECURITY_DESCRIPTOR_HEADER" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d9/d0/struct__SECURITY__DESCRIPTOR__HEADER.html">_SECURITY_DESCRIPTOR_HEADER</a> * <a class="el" href="../../d9/d0/struct__SECURITY__DESCRIPTOR__HEADER.html">PSECURITY_DESCRIPTOR_HEADER</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a39" doxytag="obp.h::SECURITY_DESCRIPTOR_HEADER" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d9/d0/struct__SECURITY__DESCRIPTOR__HEADER.html">_SECURITY_DESCRIPTOR_HEADER</a>  <a class="el" href="../../d9/d0/struct__SECURITY__DESCRIPTOR__HEADER.html">SECURITY_DESCRIPTOR_HEADER</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a56" doxytag="obp.h::ObpAcquireDescriptorCacheReadLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID ObpAcquireDescriptorCacheReadLock           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d0/obsdata_8c-source.html#l00914">914</a> of file <a class="el" href="../../d9/d0/obsdata_8c-source.html">obsdata.c</a>.
<p>
References <a class="el" href="../../d6/d7/ex_8h-source.html#l02474">ExAcquireResourceShared</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01598">KeEnterCriticalRegion</a>, <a class="el" href="../../d9/d0/obsdata_8c-source.html#l00103">ObsSecurityDescriptorCacheLock</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
Referenced by <a class="el" href="../../d7/d0/obquery_8c-source.html#l00058">NtQueryObject()</a>, and <a class="el" href="../../d0/d1/obse_8c-source.html#l01679">ObQuerySecurityDescriptorInfo()</a>.
<p>
<pre class="fragment"><div>00920                    :
00921 
00922     Takes a read lock on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security descriptor cache.
00923 
00924 Arguments:
00925 
00926     none
00927 
00928 Return Value:
00929 
00930     None.
00931 
00932 --*/
00933 
00934 {
00935     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
00936     (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>)<a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a>( &amp;ObsSecurityDescriptorCacheLock,TRUE );
00937 
00938     <span class="keywordflow">return</span>;
00939 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a55" doxytag="obp.h::ObpAcquireDescriptorCacheWriteLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID ObpAcquireDescriptorCacheWriteLock           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d0/obsdata_8c-source.html#l00886">886</a> of file <a class="el" href="../../d9/d0/obsdata_8c-source.html">obsdata.c</a>.
<p>
References <a class="el" href="../../d6/d7/ex_8h-source.html#l02475">ExAcquireResourceExclusive</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01598">KeEnterCriticalRegion</a>, <a class="el" href="../../d9/d0/obsdata_8c-source.html#l00103">ObsSecurityDescriptorCacheLock</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
Referenced by <a class="el" href="../../d9/d0/obsdata_8c-source.html#l00637">ObDeassignSecurity()</a>, <a class="el" href="../../d9/d0/obsdata_8c-source.html#l00700">ObpDereferenceSecurityDescriptor()</a>, <a class="el" href="../../d9/d0/obsdata_8c-source.html#l00297">ObpLogSecurityDescriptor()</a>, <a class="el" href="../../d9/d0/obsdata_8c-source.html#l00559">ObpReferenceSecurityDescriptor()</a>, and <a class="el" href="../../d0/d1/obse_8c-source.html#l01748">ObSetSecurityDescriptorInfo()</a>.
<p>
<pre class="fragment"><div>00892                    :
00893 
00894     Takes a write lock on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security descriptor cache.
00895 
00896 Arguments:
00897 
00898     none
00899 
00900 Return Value:
00901 
00902     None.
00903 
00904 --*/
00905 
00906 {
00907     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
00908     (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>)<a class="code" href="../../d5/d8/ex_8h.html#a70">ExAcquireResourceExclusive</a>( &amp;ObsSecurityDescriptorCacheLock, TRUE );
00909 
00910     <span class="keywordflow">return</span>;
00911 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a62" doxytag="obp.h::ObpAllocateObject" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS ObpAllocateObject           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d4/struct__OBJECT__CREATE__INFORMATION.html">POBJECT_CREATE_INFORMATION</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectCreateInfo</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>OwnershipMode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectBodySize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>ReturnedObjectHeader</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d9/obcreate_8c-source.html#l00761">761</a> of file <a class="el" href="../../d7/d9/obcreate_8c-source.html">obcreate.c</a>.
<p>
References <a class="el" href="../../d5/d9/ob_8h-source.html#l00343">_OBJECT_HEADER_CREATOR_INFO::CreatorBackTraceIndex</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00342">_OBJECT_HEADER_CREATOR_INFO::CreatorUniqueProcess</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00331">_OBJECT_HEADER_NAME_INFO::Directory</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00320">_OBJECT_HEADER_QUOTA_INFO::ExclusiveProcess</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00306">_OBJECT_HEADER::Flags</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00299">_OBJECT_HEADER::HandleCount</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00257">_OBJECT_HANDLE_COUNT_ENTRY::HandleCount</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00304">_OBJECT_HEADER::HandleInfoOffset</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00332">_OBJECT_HEADER_NAME_INFO::Name</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00303">_OBJECT_HEADER::NameInfoOffset</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00318">_OBJECT_HEADER_QUOTA_INFO::NonPagedPoolCharge</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00349">OB_FLAG_CREATOR_INFO</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00350">OB_FLAG_EXCLUSIVE_OBJECT</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00348">OB_FLAG_KERNEL_OBJECT</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00347">OB_FLAG_NEW_OBJECT</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00351">OB_FLAG_PERMANENT_OBJECT</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00353">OB_FLAG_SINGLE_HANDLE_ENTRY</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00308">_OBJECT_HEADER::ObjectCreateInfo</a>, <a class="el" href="../../d7/d9/obcreate_8c-source.html#l00047">ObpObjectsCreated</a>, <a class="el" href="../../d7/d9/obcreate_8c-source.html#l00051">ObpObjectsWithCreatorInfo</a>, <a class="el" href="../../d7/d9/obcreate_8c-source.html#l00049">ObpObjectsWithHandleDB</a>, <a class="el" href="../../d7/d9/obcreate_8c-source.html#l00050">ObpObjectsWithName</a>, <a class="el" href="../../d7/d9/obcreate_8c-source.html#l00048">ObpObjectsWithPoolQuota</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00317">_OBJECT_HEADER_QUOTA_INFO::PagedPoolCharge</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00297">_OBJECT_HEADER::PointerCount</a>, <a class="el" href="../../d5/d8/ex_8h.html#a96">POOL_TYPE</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00281">PROTECTED_POOL</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00305">_OBJECT_HEADER::QuotaInfoOffset</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l00062">SE_DEFAULT_SECURITY_QUOTA</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00312">_OBJECT_HEADER::SecurityDescriptor</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00319">_OBJECT_HEADER_QUOTA_INFO::SecurityDescriptorCharge</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00326">_OBJECT_HEADER_HANDLE_INFO::SingleEntry</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00302">_OBJECT_HEADER::Type</a>, and <a class="el" href="../../d5/d9/ob_8h-source.html#l00341">_OBJECT_HEADER_CREATOR_INFO::TypeList</a>.
<p>
Referenced by <a class="el" href="../../d7/d9/obcreate_8c-source.html#l00055">ObCreateObject()</a>, and <a class="el" href="../../d1/d1/obtype_8c-source.html#l00069">ObCreateObjectType()</a>.
<p>
<pre class="fragment"><div>00772                    :
00773 
00774     This routine allocates a <span class="keyword">new</span> object including <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object header
00775     and body from <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> and fill in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> appropriate fields.
00776 
00777 Arguments:
00778 
00779     ObjectCreateInfo - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> create information <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> object
00780 
00781     OwnershipMode - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> processor mode of who <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> going to own
00782         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object
00783 
00784     ObjectType - Optionally supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object being
00785         created. If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object create info not null then <span class="keyword">this</span> field must
00786         be supplied.
00787 
00788     ObjectName - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object being created
00789 
00790     ObjectBodySize - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size, in bytes, of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> body of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object
00791         being created
00792 
00793     ReturnedObjectHeader - Receives a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object header <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00794         newly created objet.
00795 
00796 Return Value:
00797 
00798     An appropriate status value.
00799 
00800 --*/
00801 
00802 {
00803     ULONG HeaderSize;
00804     <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> ObjectHeader;
00805     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00806     PVOID ZoneSegment;
00807     ULONG QuotaInfoSize;
00808     ULONG HandleInfoSize;
00809     ULONG NameInfoSize;
00810     ULONG CreatorInfoSize;
00811     <a class="code" href="../../d1/d6/struct__OBJECT__HEADER__QUOTA__INFO.html">POBJECT_HEADER_QUOTA_INFO</a> QuotaInfo;
00812     <a class="code" href="../../d8/d5/struct__OBJECT__HEADER__HANDLE__INFO.html">POBJECT_HEADER_HANDLE_INFO</a> HandleInfo;
00813     <a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html">POBJECT_HEADER_NAME_INFO</a> NameInfo;
00814     <a class="code" href="../../d7/d5/struct__OBJECT__HEADER__CREATOR__INFO.html">POBJECT_HEADER_CREATOR_INFO</a> CreatorInfo;
00815     <a class="code" href="../../d5/d8/ex_8h.html#a96">POOL_TYPE</a> PoolType;
00816 
00817     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00818 
00819     <a class="code" href="../../d6/d0/obcreate_8c.html#a0">ObpObjectsCreated</a> += 1;
00820 
00821     <span class="comment">//</span>
00822     <span class="comment">//  Compute the sizes of the optional object header components.</span>
00823     <span class="comment">//</span>
00824 
00825     <span class="keywordflow">if</span> (ObjectCreateInfo == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00826 
00827         QuotaInfoSize = 0;
00828         HandleInfoSize = 0;
00829         NameInfoSize = <span class="keyword">sizeof</span>( <a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html">OBJECT_HEADER_NAME_INFO</a> );
00830         CreatorInfoSize = <span class="keyword">sizeof</span>( <a class="code" href="../../d7/d5/struct__OBJECT__HEADER__CREATOR__INFO.html">OBJECT_HEADER_CREATOR_INFO</a> );
00831 
00832     } <span class="keywordflow">else</span> {
00833 
00834         <span class="comment">//</span>
00835         <span class="comment">//  The caller specified some additional object create info</span>
00836         <span class="comment">//</span>
00837         <span class="comment">//  First check to see if we need to set the quota</span>
00838         <span class="comment">//</span>
00839 
00840         <span class="keywordflow">if</span> (ObjectCreateInfo-&gt;PagedPoolCharge != ObjectType-&gt;TypeInfo.DefaultPagedPoolCharge ||
00841             ObjectCreateInfo-&gt;NonPagedPoolCharge != ObjectType-&gt;TypeInfo.DefaultNonPagedPoolCharge ||
00842             ObjectCreateInfo-&gt;SecurityDescriptorCharge &gt; <a class="code" href="../../d0/d5/se_8h.html#a0">SE_DEFAULT_SECURITY_QUOTA</a> ||
00843             (ObjectCreateInfo-&gt;Attributes &amp; OBJ_EXCLUSIVE)) {
00844 
00845             QuotaInfoSize = <span class="keyword">sizeof</span>( <a class="code" href="../../d1/d6/struct__OBJECT__HEADER__QUOTA__INFO.html">OBJECT_HEADER_QUOTA_INFO</a> );
00846             <a class="code" href="../../d6/d0/obcreate_8c.html#a1">ObpObjectsWithPoolQuota</a> += 1;
00847 
00848         } <span class="keywordflow">else</span> {
00849 
00850             QuotaInfoSize = 0;
00851         }
00852 
00853         <span class="comment">//</span>
00854         <span class="comment">//  Check if we are to allocate space to maintain handle counts</span>
00855         <span class="comment">//</span>
00856 
00857         <span class="keywordflow">if</span> (ObjectType-&gt;TypeInfo.MaintainHandleCount) {
00858 
00859             HandleInfoSize = <span class="keyword">sizeof</span>( <a class="code" href="../../d8/d5/struct__OBJECT__HEADER__HANDLE__INFO.html">OBJECT_HEADER_HANDLE_INFO</a> );
00860             <a class="code" href="../../d6/d0/obcreate_8c.html#a2">ObpObjectsWithHandleDB</a> += 1;
00861 
00862         } <span class="keywordflow">else</span> {
00863 
00864             HandleInfoSize = 0;
00865         }
00866 
00867         <span class="comment">//</span>
00868         <span class="comment">//  Check if we are to allocate space for the name</span>
00869         <span class="comment">//</span>
00870 
00871         <span class="keywordflow">if</span> (ObjectName-&gt;Buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00872 
00873             NameInfoSize = <span class="keyword">sizeof</span>( <a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html">OBJECT_HEADER_NAME_INFO</a> );
00874             <a class="code" href="../../d6/d0/obcreate_8c.html#a3">ObpObjectsWithName</a> += 1;
00875 
00876         } <span class="keywordflow">else</span> {
00877 
00878             NameInfoSize = 0;
00879         }
00880 
00881         <span class="comment">//</span>
00882         <span class="comment">//  Finally check if we are to maintain the creator info</span>
00883         <span class="comment">//</span>
00884 
00885         <span class="keywordflow">if</span> (ObjectType-&gt;TypeInfo.MaintainTypeList) {
00886 
00887             CreatorInfoSize = <span class="keyword">sizeof</span>( <a class="code" href="../../d7/d5/struct__OBJECT__HEADER__CREATOR__INFO.html">OBJECT_HEADER_CREATOR_INFO</a> );
00888             <a class="code" href="../../d6/d0/obcreate_8c.html#a4">ObpObjectsWithCreatorInfo</a> += 1;
00889 
00890         } <span class="keywordflow">else</span> {
00891 
00892             CreatorInfoSize = 0;
00893         }
00894     }
00895 
00896     <span class="comment">//</span>
00897     <span class="comment">//  Now compute the total header size</span>
00898     <span class="comment">//</span>
00899 
00900     HeaderSize = QuotaInfoSize +
00901                  HandleInfoSize +
00902                  NameInfoSize +
00903                  CreatorInfoSize +
00904                  FIELD_OFFSET( <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">OBJECT_HEADER</a>, Body );
00905 
00906     <span class="comment">//</span>
00907     <span class="comment">//  Allocate and initialize the object.</span>
00908     <span class="comment">//</span>
00909     <span class="comment">//  If the object type is not specified or specifies nonpaged pool,</span>
00910     <span class="comment">//  then allocate the object from nonpaged pool.</span>
00911     <span class="comment">//  Otherwise, allocate the object from paged pool.</span>
00912     <span class="comment">//</span>
00913 
00914     <span class="keywordflow">if</span> ((ObjectType == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) || (ObjectType-&gt;TypeInfo.PoolType == <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>)) {
00915 
00916         PoolType = <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>;
00917 
00918     } <span class="keywordflow">else</span> {
00919 
00920         PoolType = <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>;
00921     }
00922 
00923     ObjectHeader = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( PoolType,
00924                                           HeaderSize + ObjectBodySize,
00925                                           (ObjectType == NULL ? 'TjbO' : ObjectType-&gt;Key) |
00926                                             PROTECTED_POOL );
00927 
00928     <span class="keywordflow">if</span> (ObjectHeader == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00929 
00930         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00931     }
00932 
00933     <span class="comment">//</span>
00934     <span class="comment">//  Now based on if we are to put in the quota, handle, name, or creator info we</span>
00935     <span class="comment">//  will do the extra work.  This order is very important because we rely on</span>
00936     <span class="comment">//  it to free the object.</span>
00937     <span class="comment">//</span>
00938 
00939     <span class="keywordflow">if</span> (QuotaInfoSize != 0) {
00940 
00941         QuotaInfo = (<a class="code" href="../../d1/d6/struct__OBJECT__HEADER__QUOTA__INFO.html">POBJECT_HEADER_QUOTA_INFO</a>)ObjectHeader;
00942         QuotaInfo-&gt;<a class="code" href="../../d1/d6/struct__OBJECT__HEADER__QUOTA__INFO.html#o0">PagedPoolCharge</a> = ObjectCreateInfo-&gt;PagedPoolCharge;
00943         QuotaInfo-&gt;<a class="code" href="../../d1/d6/struct__OBJECT__HEADER__QUOTA__INFO.html#o1">NonPagedPoolCharge</a> = ObjectCreateInfo-&gt;NonPagedPoolCharge;
00944         QuotaInfo-&gt;<a class="code" href="../../d1/d6/struct__OBJECT__HEADER__QUOTA__INFO.html#o2">SecurityDescriptorCharge</a> = ObjectCreateInfo-&gt;SecurityDescriptorCharge;
00945         QuotaInfo-&gt;<a class="code" href="../../d1/d6/struct__OBJECT__HEADER__QUOTA__INFO.html#o3">ExclusiveProcess</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00946         ObjectHeader = (<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a>)(QuotaInfo + 1);
00947     }
00948 
00949     <span class="keywordflow">if</span> (HandleInfoSize != 0) {
00950 
00951         HandleInfo = (<a class="code" href="../../d8/d5/struct__OBJECT__HEADER__HANDLE__INFO.html">POBJECT_HEADER_HANDLE_INFO</a>)ObjectHeader;
00952         HandleInfo-&gt;<a class="code" href="../../d8/d5/struct__OBJECT__HEADER__HANDLE__INFO.html#o1">SingleEntry</a>.<a class="code" href="../../d2/d5/struct__OBJECT__HANDLE__COUNT__ENTRY.html#o1">HandleCount</a> = 0;
00953         ObjectHeader = (<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a>)(HandleInfo + 1);
00954     }
00955 
00956     <span class="keywordflow">if</span> (NameInfoSize != 0) {
00957 
00958         NameInfo = (<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html">POBJECT_HEADER_NAME_INFO</a>)ObjectHeader;
00959         NameInfo-&gt;<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html#o1">Name</a> = *ObjectName;
00960         NameInfo-&gt;<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html#o0">Directory</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00961         ObjectHeader = (<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a>)(NameInfo + 1);
00962     }
00963 
00964     <span class="keywordflow">if</span> (CreatorInfoSize != 0) {
00965 
00966         CreatorInfo = (<a class="code" href="../../d7/d5/struct__OBJECT__HEADER__CREATOR__INFO.html">POBJECT_HEADER_CREATOR_INFO</a>)ObjectHeader;
00967         CreatorInfo-&gt;<a class="code" href="../../d7/d5/struct__OBJECT__HEADER__CREATOR__INFO.html#o2">CreatorBackTraceIndex</a> = 0;
00968         CreatorInfo-&gt;<a class="code" href="../../d7/d5/struct__OBJECT__HEADER__CREATOR__INFO.html#o1">CreatorUniqueProcess</a> = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;UniqueProcessId;
00969         InitializeListHead( &amp;CreatorInfo-&gt;<a class="code" href="../../d7/d5/struct__OBJECT__HEADER__CREATOR__INFO.html#o0">TypeList</a> );
00970         ObjectHeader = (<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a>)(CreatorInfo + 1);
00971     }
00972 
00973     <span class="comment">//</span>
00974     <span class="comment">//  Compute the proper offsets based on what we have</span>
00975     <span class="comment">//</span>
00976 
00977     <span class="keywordflow">if</span> (QuotaInfoSize != 0) {
00978 
00979         ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o6">QuotaInfoOffset</a> = (UCHAR)(QuotaInfoSize + HandleInfoSize + NameInfoSize + CreatorInfoSize);
00980 
00981     } <span class="keywordflow">else</span> {
00982 
00983         ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o6">QuotaInfoOffset</a> = 0;
00984     }
00985 
00986     <span class="keywordflow">if</span> (HandleInfoSize != 0) {
00987 
00988         ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o5">HandleInfoOffset</a> = (UCHAR)(HandleInfoSize + NameInfoSize + CreatorInfoSize);
00989 
00990     } <span class="keywordflow">else</span> {
00991 
00992         ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o5">HandleInfoOffset</a> = 0;
00993     }
00994 
00995     <span class="keywordflow">if</span> (NameInfoSize != 0) {
00996 
00997         ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o4">NameInfoOffset</a> =  (UCHAR)(NameInfoSize + CreatorInfoSize);
00998 
00999     } <span class="keywordflow">else</span> {
01000 
01001         ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o4">NameInfoOffset</a> = 0;
01002     }
01003 
01004     <span class="comment">//</span>
01005     <span class="comment">//  Say that this is a new object, and conditionally set the other flags</span>
01006     <span class="comment">//</span>
01007 
01008     ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o7">Flags</a> = <a class="code" href="../../d4/d0/ob_8h.html#a1">OB_FLAG_NEW_OBJECT</a>;
01009 
01010     <span class="keywordflow">if</span> (CreatorInfoSize != 0) {
01011 
01012         ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o7">Flags</a> |= <a class="code" href="../../d4/d0/ob_8h.html#a3">OB_FLAG_CREATOR_INFO</a>;
01013     }
01014 
01015     <span class="keywordflow">if</span> (HandleInfoSize != 0) {
01016 
01017         ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o7">Flags</a> |= <a class="code" href="../../d4/d0/ob_8h.html#a7">OB_FLAG_SINGLE_HANDLE_ENTRY</a>;
01018     }
01019 
01020     <span class="comment">//</span>
01021     <span class="comment">//  Set the counters and its type</span>
01022     <span class="comment">//</span>
01023 
01024     ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o0">PointerCount</a> = 1;
01025     ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o1">HandleCount</a> = 0;
01026     ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o3">Type</a> = ObjectType;
01027 
01028     <span class="comment">//</span>
01029     <span class="comment">//  Initialize the object header.</span>
01030     <span class="comment">//</span>
01031     <span class="comment">//  N.B. The initialization of the object header is done field by</span>
01032     <span class="comment">//       field rather than zeroing the memory and then initializing</span>
01033     <span class="comment">//       the pertinent fields.</span>
01034     <span class="comment">//</span>
01035     <span class="comment">//  N.B. It is assumed that the caller will initialize the object</span>
01036     <span class="comment">//       attributes, object ownership, and parse context.</span>
01037     <span class="comment">//</span>
01038 
01039     <span class="keywordflow">if</span> (OwnershipMode == <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
01040 
01041         ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o7">Flags</a> |= <a class="code" href="../../d4/d0/ob_8h.html#a2">OB_FLAG_KERNEL_OBJECT</a>;
01042     }
01043 
01044     <span class="keywordflow">if</span> (ObjectCreateInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp;
01045         ObjectCreateInfo-&gt;Attributes &amp; OBJ_PERMANENT ) {
01046 
01047         ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o7">Flags</a> |= <a class="code" href="../../d4/d0/ob_8h.html#a5">OB_FLAG_PERMANENT_OBJECT</a>;
01048     }
01049 
01050     <span class="keywordflow">if</span> ((ObjectCreateInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
01051         (ObjectCreateInfo-&gt;Attributes &amp; OBJ_EXCLUSIVE)) {
01052 
01053         ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o7">Flags</a> |= <a class="code" href="../../d4/d0/ob_8h.html#a4">OB_FLAG_EXCLUSIVE_OBJECT</a>;
01054     }
01055 
01056     ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o8">ObjectCreateInfo</a> = ObjectCreateInfo;
01057     ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o10">SecurityDescriptor</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01058 
01059     <span class="keywordflow">if</span> (ObjectType != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01060 
01061         ObjectType-&gt;TotalNumberOfObjects += 1;
01062 
01063         <span class="keywordflow">if</span> (ObjectType-&gt;TotalNumberOfObjects &gt; ObjectType-&gt;HighWaterNumberOfObjects) {
01064 
01065             ObjectType-&gt;HighWaterNumberOfObjects = ObjectType-&gt;TotalNumberOfObjects;
01066         }
01067     }
01068 
01069 <span class="preprocessor">#if DBG</span>
01070 <span class="preprocessor"></span>
01071     <span class="comment">//</span>
01072     <span class="comment">//  On a checked build echo out allocs</span>
01073     <span class="comment">//</span>
01074 
01075     <span class="keywordflow">if</span> (ObpShowAllocAndFree) {
01076 
01077         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"OB: Alloc %lx (%lx) %04lu"</span>, ObjectHeader, ObjectHeader, ObjectBodySize );
01078 
01079         <span class="keywordflow">if</span> (ObjectType) {
01080 
01081             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">" - %wZ\n"</span>, &amp;ObjectType-&gt;Name );
01082 
01083         } <span class="keywordflow">else</span> {
01084 
01085             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">" - Type\n"</span> );
01086         }
01087     }
01088 <span class="preprocessor">#endif</span>
01089 <span class="preprocessor"></span>
01090     *ReturnedObjectHeader = ObjectHeader;
01091 
01092     <span class="keywordflow">return</span> STATUS_SUCCESS;
01093 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a60" doxytag="obp.h::ObpAllocateObjectNameBuffer" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PWCHAR ObpAllocateObjectNameBuffer           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN LOGICAL&nbsp;</td>
          <td class="mdname" nowrap> <em>UseLookaside</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectName</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d9/obcreate_8c-source.html#l00583">583</a> of file <a class="el" href="../../d7/d9/obcreate_8c-source.html">obcreate.c</a>.
<p>
References <a class="el" href="../../d7/d1/rtqkey_8c-source.html#l00042">Buffer</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01011">ExAllocateFromPPNPagedLookasideList()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a331a201">LookasideNameBufferList</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00390">OBJECT_NAME_BUFFER_SIZE</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d7/d9/obcreate_8c-source.html#l00438">ObpCaptureObjectName()</a>.
<p>
<pre class="fragment"><div>00591                    :
00592 
00593     This function allocates an object name buffer.
00594 
00595     N.B. This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> nonpageable.
00596 
00597 Arguments:
00598 
00599     Length - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> required buffer in bytes.
00600 
00601     UseLookaside - Supplies a logical variable that determines whether an
00602         attempt <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a> to allocate <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name buffer from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> lookaside list.
00603 
00604     ObjectName - Supplies a pointer to a name buffer string descriptor.
00605 
00606 Return Value:
00607 
00608     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> allocation <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> successful, then name buffer string descriptor
00609     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> initialized and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name buffer <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00610     function value. Otherwise, a value of <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
00611 
00612 --*/
00613 
00614 {
00615     PVOID <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
00616     ULONG Maximum;
00617     KIRQL OldIrql;
00618     PKPRCB Prcb;
00619 
00620     <span class="comment">//</span>
00621     <span class="comment">//  If allocation from the lookaside lists is specified and the buffer</span>
00622     <span class="comment">//  size is less than the size of lookaside list entries, then attempt</span>
00623     <span class="comment">//  to allocate the name buffer from the lookaside lists. Otherwise,</span>
00624     <span class="comment">//  attempt to allocate the name buffer from nonpaged pool.</span>
00625     <span class="comment">//</span>
00626 
00627     Maximum = Length + <span class="keyword">sizeof</span>(WCHAR);
00628 
00629     <span class="keywordflow">if</span> ((UseLookaside == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) || (Maximum &gt; <a class="code" href="../../d5/d1/obp_8h.html#a23">OBJECT_NAME_BUFFER_SIZE</a>)) {
00630 
00631         <span class="comment">//</span>
00632         <span class="comment">//  Attempt to allocate the buffer from nonpaged pool.</span>
00633         <span class="comment">//</span>
00634 
00635         <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(NonPagedPool, Maximum, 'mNbO');
00636 
00637     } <span class="keywordflow">else</span> {
00638 
00639         <span class="comment">//</span>
00640         <span class="comment">//  Attempt to allocate the name buffer from the lookaside list. If</span>
00641         <span class="comment">//  the allocation attempt fails, then attempt to allocate the name</span>
00642         <span class="comment">//  buffer from pool.</span>
00643         <span class="comment">//</span>
00644 
00645         Maximum = <a class="code" href="../../d5/d1/obp_8h.html#a23">OBJECT_NAME_BUFFER_SIZE</a>;
00646         <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = <a class="code" href="../../d5/d8/ex_8h.html#a254">ExAllocateFromPPNPagedLookasideList</a>(LookasideNameBufferList);
00647     }
00648 
00649     <span class="comment">//</span>
00650     <span class="comment">//  Initialize the string descriptor and return the buffer address.</span>
00651     <span class="comment">//</span>
00652 
00653     ObjectName-&gt;Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)Length;
00654     ObjectName-&gt;MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)Maximum;
00655     ObjectName-&gt;Buffer = <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
00656 
00657     <span class="keywordflow">return</span> (PWCHAR)<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
00658 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a58" doxytag="obp.h::ObpCaptureObjectCreateInformation" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS ObpCaptureObjectCreateInformation           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> ObjectType&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ProbeMode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN POBJECT_ATTRIBUTES&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectAttributes</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>CapturedObjectName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d7/d4/struct__OBJECT__CREATE__INFORMATION.html">POBJECT_CREATE_INFORMATION</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectCreateInfo</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN LOGICAL&nbsp;</td>
          <td class="mdname" nowrap> <em>UseLookaside</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d7/d9/obcreate_8c-source.html#l00055">ObCreateObject()</a>, and <a class="el" href="../../d8/d0/obref_8c-source.html#l00095">ObOpenObjectByName()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a59" doxytag="obp.h::ObpCaptureObjectName" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS ObpCaptureObjectName           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ProbeMode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>CapturedObjectName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN LOGICAL&nbsp;</td>
          <td class="mdname" nowrap> <em>UseLookaside</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d9/obcreate_8c-source.html#l00438">438</a> of file <a class="el" href="../../d7/d9/obcreate_8c-source.html">obcreate.c</a>.
<p>
References <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d9/obcreate_8c-source.html#l00583">ObpAllocateObjectNameBuffer()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01417">ProbeAndReadUnicodeString</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01209">ProbeForRead</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
Referenced by <a class="el" href="../../d7/d9/obcreate_8c-source.html#l00248">ObpCaptureObjectCreateInformation()</a>, and <a class="el" href="../../d8/d0/obref_8c-source.html#l00844">ObReferenceObjectByName()</a>.
<p>
<pre class="fragment"><div>00447                    :
00448 
00449     This function captures <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object name but first verifies that
00450     <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> at least properly sized.
00451 
00452 Arguments:
00453 
00454     ProbeMode - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> processor mode to use when probing
00455         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object name
00456 
00457     ObjectName - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller's version of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object name
00458 
00459     CapturedObjectName - Receives <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> captured verified version
00460         of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object name
00461 
00462     UseLookaside - Indicates <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> captured name buffer should be
00463         allocated from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> lookaside list or from straight <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a>
00464 
00465 Return Value:
00466 
00467     An appropriate status value
00468 
00469 --*/
00470 
00471 {
00472     PWCH FreeBuffer;
00473     UNICODE_STRING InputObjectName;
00474     ULONG Length;
00475     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00476 
00477     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00478 
00479     <span class="comment">//</span>
00480     <span class="comment">//  Initialize the object name descriptor and capture the specified name</span>
00481     <span class="comment">//  string.</span>
00482     <span class="comment">//</span>
00483 
00484     CapturedObjectName-&gt;Buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00485     CapturedObjectName-&gt;Length = 0;
00486     CapturedObjectName-&gt;MaximumLength = 0;
00487 
00488     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00489 
00490     <span class="keywordflow">try</span> {
00491 
00492         <span class="comment">//</span>
00493         <span class="comment">//  Probe and capture the name string descriptor and probe the</span>
00494         <span class="comment">//  name string, if necessary.</span>
00495         <span class="comment">//</span>
00496 
00497         FreeBuffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00498 
00499         <span class="keywordflow">if</span> (ProbeMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00500 
00501             InputObjectName = <a class="code" href="../../d5/d8/ex_8h.html#a26">ProbeAndReadUnicodeString</a>(ObjectName);
00502 
00503             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>( InputObjectName.Buffer,
00504                           InputObjectName.Length,
00505                           <span class="keyword">sizeof</span>(WCHAR) );
00506 
00507         } <span class="keywordflow">else</span> {
00508 
00509             InputObjectName = *ObjectName;
00510         }
00511 
00512         <span class="comment">//</span>
00513         <span class="comment">//  If the length of the string is not zero, then capture the string.</span>
00514         <span class="comment">//</span>
00515 
00516         <span class="keywordflow">if</span> (InputObjectName.Length != 0) {
00517 
00518             <span class="comment">//</span>
00519             <span class="comment">//  If the length of the string is not an even multiple of the</span>
00520             <span class="comment">//  size of a UNICODE character or cannot be zero terminated,</span>
00521             <span class="comment">//  then return an error.</span>
00522             <span class="comment">//</span>
00523 
00524             Length = InputObjectName.Length;
00525 
00526             <span class="keywordflow">if</span> (((Length &amp; (<span class="keyword">sizeof</span>(WCHAR) - 1)) != 0) ||
00527                 (Length == (MAXUSHORT - <span class="keyword">sizeof</span>(WCHAR) + 1))) {
00528 
00529                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_OBJECT_NAME_INVALID;
00530 
00531             } <span class="keywordflow">else</span> {
00532 
00533                 <span class="comment">//</span>
00534                 <span class="comment">//  Allocate a buffer for the specified name string.</span>
00535                 <span class="comment">//</span>
00536                 <span class="comment">//  N.B. The name buffer allocation routine adds one</span>
00537                 <span class="comment">//       UNICODE character to the length and initializes</span>
00538                 <span class="comment">//       the string descriptor.</span>
00539                 <span class="comment">//</span>
00540 
00541                 FreeBuffer = <a class="code" href="../../d5/d1/obp_8h.html#a60">ObpAllocateObjectNameBuffer</a>( Length,
00542                                                           UseLookaside,
00543                                                           CapturedObjectName );
00544 
00545                 <span class="keywordflow">if</span> (FreeBuffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00546 
00547                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
00548 
00549                 } <span class="keywordflow">else</span> {
00550 
00551                     <span class="comment">//</span>
00552                     <span class="comment">//  Copy the specified name string to the destination</span>
00553                     <span class="comment">//  buffer.</span>
00554                     <span class="comment">//</span>
00555 
00556                     RtlMoveMemory(FreeBuffer, InputObjectName.Buffer, Length);
00557 
00558                     <span class="comment">//</span>
00559                     <span class="comment">//  Zero terminate the name string and initialize the</span>
00560                     <span class="comment">//  string descriptor.</span>
00561                     <span class="comment">//</span>
00562 
00563                     FreeBuffer[Length / <span class="keyword">sizeof</span>(WCHAR)] = UNICODE_NULL;
00564                 }
00565             }
00566         }
00567 
00568     } except(<a class="code" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter</a>()) {
00569 
00570         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00571 
00572         <span class="keywordflow">if</span> (FreeBuffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00573 
00574             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(FreeBuffer);
00575         }
00576     }
00577 
00578     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00579 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a82" doxytag="obp.h::ObpChargeQuotaForObject" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS ObpChargeQuotaForObject           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectHeader</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PBOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>NewObject</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/obhandle_8c-source.html#l01861">1861</a> of file <a class="el" href="../../d0/d0/obhandle_8c-source.html">obhandle.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00318">_OBJECT_HEADER_QUOTA_INFO::NonPagedPoolCharge</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00352">OB_FLAG_DEFAULT_SECURITY_QUOTA</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00347">OB_FLAG_NEW_OBJECT</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00362">OBJECT_HEADER_TO_QUOTA_INFO</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00317">_OBJECT_HEADER_QUOTA_INFO::PagedPoolCharge</a>, <a class="el" href="../../d1/d1/psquota_8c-source.html#l00024">PsChargeSharedPoolQuota()</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l00062">SE_DEFAULT_SECURITY_QUOTA</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00319">_OBJECT_HEADER_QUOTA_INFO::SecurityDescriptorCharge</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d0/d0/obhandle_8c-source.html#l01232">ObpIncrementHandleCount()</a>, and <a class="el" href="../../d0/d0/obhandle_8c-source.html#l01587">ObpIncrementUnnamedHandleCount()</a>.
<p>
<pre class="fragment"><div>01869                    :
01870 
01871     This routine charges quota against <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current process <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span>
01872     object
01873 
01874 Arguments:
01875 
01876     ObjectHeader - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> object being charged <span class="keywordflow">for</span>
01877 
01878     ObjectType - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> object
01879 
01880     NewObject - Returns <span class="keyword">true</span> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> really <span class="keyword">new</span> and <span class="keyword">false</span> otherwise
01881 
01882 Return Value:
01883 
01884     An appropriate status value
01885 
01886 --*/
01887 
01888 {
01889     <a class="code" href="../../d1/d6/struct__OBJECT__HEADER__QUOTA__INFO.html">POBJECT_HEADER_QUOTA_INFO</a> QuotaInfo;
01890     ULONG NonPagedPoolCharge;
01891     ULONG PagedPoolCharge;
01892 
01893     <span class="comment">//</span>
01894     <span class="comment">//  Get a pointer to the quota block for this object</span>
01895     <span class="comment">//</span>
01896 
01897     QuotaInfo = <a class="code" href="../../d4/d0/ob_8h.html#a10">OBJECT_HEADER_TO_QUOTA_INFO</a>( ObjectHeader );
01898 
01899     *NewObject = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01900 
01901     <span class="comment">//</span>
01902     <span class="comment">//  If the object is new then we have work to do otherwise</span>
01903     <span class="comment">//  we'll return with NewObject set to false</span>
01904     <span class="comment">//</span>
01905 
01906     <span class="keywordflow">if</span> (ObjectHeader-&gt;Flags &amp; <a class="code" href="../../d4/d0/ob_8h.html#a1">OB_FLAG_NEW_OBJECT</a>) {
01907 
01908         <span class="comment">//</span>
01909         <span class="comment">//  Say the object now isn't new</span>
01910         <span class="comment">//</span>
01911 
01912         ObjectHeader-&gt;Flags &amp;= ~<a class="code" href="../../d4/d0/ob_8h.html#a1">OB_FLAG_NEW_OBJECT</a>;
01913 
01914         <span class="comment">//</span>
01915         <span class="comment">//  If there does exist a quota info structure for this</span>
01916         <span class="comment">//  object then calculate what our charge should be from</span>
01917         <span class="comment">//  the information stored in that structure</span>
01918         <span class="comment">//</span>
01919 
01920         <span class="keywordflow">if</span> (QuotaInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01921 
01922             PagedPoolCharge = QuotaInfo-&gt;<a class="code" href="../../d1/d6/struct__OBJECT__HEADER__QUOTA__INFO.html#o0">PagedPoolCharge</a> +
01923                               QuotaInfo-&gt;<a class="code" href="../../d1/d6/struct__OBJECT__HEADER__QUOTA__INFO.html#o2">SecurityDescriptorCharge</a>;
01924             NonPagedPoolCharge = QuotaInfo-&gt;<a class="code" href="../../d1/d6/struct__OBJECT__HEADER__QUOTA__INFO.html#o1">NonPagedPoolCharge</a>;
01925 
01926         } <span class="keywordflow">else</span> {
01927 
01928             <span class="comment">//</span>
01929             <span class="comment">//  There isn't any quota information so we're on our own</span>
01930             <span class="comment">//  Paged pool charge is the default for the object plus</span>
01931             <span class="comment">//  the security descriptor if present.  Nonpaged pool charge</span>
01932             <span class="comment">//  is the default for the object.</span>
01933             <span class="comment">//</span>
01934 
01935             PagedPoolCharge = ObjectType-&gt;TypeInfo.DefaultPagedPoolCharge;
01936 
01937             <span class="keywordflow">if</span> (ObjectHeader-&gt;SecurityDescriptor != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01938 
01939                 ObjectHeader-&gt;Flags |= <a class="code" href="../../d4/d0/ob_8h.html#a6">OB_FLAG_DEFAULT_SECURITY_QUOTA</a>;
01940                 PagedPoolCharge += <a class="code" href="../../d0/d5/se_8h.html#a0">SE_DEFAULT_SECURITY_QUOTA</a>;
01941             }
01942 
01943             NonPagedPoolCharge = ObjectType-&gt;TypeInfo.DefaultNonPagedPoolCharge;
01944         }
01945 
01946         <span class="comment">//</span>
01947         <span class="comment">//  Now charge for the quota and make sure it succeeds</span>
01948         <span class="comment">//</span>
01949 
01950         ObjectHeader-&gt;QuotaBlockCharged = (PVOID)<a class="code" href="../../d0/d2/psquota_8c.html#a0">PsChargeSharedPoolQuota</a>( <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>(),
01951                                                                           PagedPoolCharge,
01952                                                                           NonPagedPoolCharge );
01953 
01954         <span class="keywordflow">if</span> (ObjectHeader-&gt;QuotaBlockCharged == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01955 
01956             <span class="keywordflow">return</span> STATUS_QUOTA_EXCEEDED;
01957         }
01958 
01959         *NewObject = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01960     }
01961 
01962     <span class="keywordflow">return</span> STATUS_SUCCESS;
01963 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a86" doxytag="obp.h::ObpCheckObjectReference" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN ObpCheckObjectReference           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Object</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT <a class="el" href="../../d2/d5/struct__ACCESS__STATE.html">PACCESS_STATE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessState</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>TypeMutexLocked</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessMode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PNTSTATUS&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessStatus</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/obse_8c-source.html#l00602">602</a> of file <a class="el" href="../../d0/d1/obse_8c-source.html">obse.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00168">_OBJECT_TYPE_INITIALIZER::GenericMapping</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d0/d1/obse_8c-source.html#l01258">ObGetObjectSecurity()</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00355">OBJECT_TO_OBJECT_HEADER</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00163">ObpEnterObjectTypeMutex</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00176">ObpLeaveObjectTypeMutex</a>, <a class="el" href="../../d0/d1/obse_8c-source.html#l01418">ObReleaseObjectSecurity()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d3/accessck_8c-source.html#l03323">SeAccessCheck()</a>, <a class="el" href="../../d1/d7/subject_8c-source.html#l00115">SeLockSubjectContext()</a>, <a class="el" href="../../d4/d4/seaudit_8c-source.html#l03660">SeObjectReferenceAuditAlarm()</a>, <a class="el" href="../../d1/d7/subject_8c-source.html#l00159">SeUnlockSubjectContext()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00302">_OBJECT_HEADER::Type</a>, and <a class="el" href="../../d5/d9/ob_8h-source.html#l00196">_OBJECT_TYPE::TypeInfo</a>.
<p>
Referenced by <a class="el" href="../../d8/d0/obref_8c-source.html#l00844">ObReferenceObjectByName()</a>.
<p>
<pre class="fragment"><div>00612                    :
00613 
00614     The routine performs access validation on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> passed object.  The
00615     remaining desired access mask <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> extracted from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> AccessState
00616     parameter and passes to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> appropriate security routine to
00617     perform <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> access check.
00618 
00619     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> access attempt <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> successful, <a class="code" href="../../d0/d5/se_8h.html#a135">SeAccessCheck</a> returns a mask
00620     containing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> granted accesses.  The bits in <span class="keyword">this</span> mask are turned
00621     on in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PreviouslyGrantedAccess field of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> AccessState, and
00622     are turned off in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> RemainingDesiredAccess field.
00623 
00624     This routine differs from ObpCheckObjectAccess in that <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> calls
00625     a different audit routine.
00626 
00627 Arguments:
00628 
00629     Object - The object being examined.
00630 
00631     AccessState - The <a class="code" href="../../d2/d5/struct__ACCESS__STATE.html">ACCESS_STATE</a> structure containing accumulated
00632         information about <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current attempt to gain access to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object.
00633 
00634     TypeMutexLocked - Indicates whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> mutex <span class="keywordflow">for</span> <span class="keyword">this</span> object's
00635         <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> locked.  The <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> mutex <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to protect <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object's
00636         security descriptor from being modified <span class="keywordflow">while</span> <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being accessed.
00637 
00638     AccessMode - The previous processor mode.
00639 
00640     AccessStatus - Pointer to a variable to <span class="keywordflow">return</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> status code of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00641         access attempt.  In <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keywordflow">case</span> of <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a> <span class="keyword">this</span> status code must be
00642         propagated back to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user.
00643 
00644 
00645 Return Value:
00646 
00647     BOOLEAN - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> access <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> allowed and <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise
00648 
00649 --*/
00650 
00651 {
00652     BOOLEAN AccessAllowed;
00653     ACCESS_MASK GrantedAccess = 0;
00654     BOOLEAN MemoryAllocated;
00655     PSECURITY_DESCRIPTOR SecurityDescriptor;
00656     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00657     <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> ObjectHeader;
00658     <a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> ObjectType;
00659     PPRIVILEGE_SET Privileges = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00660 
00661     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00662 
00663     <span class="comment">//</span>
00664     <span class="comment">//  Map the object body to an object header and the</span>
00665     <span class="comment">//  corresponding object type</span>
00666     <span class="comment">//</span>
00667 
00668     ObjectHeader = <a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>( Object );
00669     ObjectType = ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o3">Type</a>;
00670 
00671     <span class="comment">//</span>
00672     <span class="comment">//  If the caller does not have the object type locked</span>
00673     <span class="comment">//  then lock it down</span>
00674     <span class="comment">//</span>
00675 
00676     <span class="keywordflow">if</span> (!TypeMutexLocked) {
00677 
00678         <a class="code" href="../../d5/d1/obp_8h.html#a8">ObpEnterObjectTypeMutex</a>( ObjectType );
00679     }
00680 
00681     <span class="comment">//</span>
00682     <span class="comment">//  Obtain the object's security descriptor</span>
00683     <span class="comment">//</span>
00684 
00685     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d1/obse_8c.html#a8">ObGetObjectSecurity</a>( Object,
00686                                   &amp;SecurityDescriptor,
00687                                   &amp;MemoryAllocated );
00688 
00689     <span class="comment">//</span>
00690     <span class="comment">//  If we failed in getting the security descriptor then</span>
00691     <span class="comment">//  put the object type lock back where it was and return</span>
00692     <span class="comment">//  the error back to our caller</span>
00693     <span class="comment">//</span>
00694 
00695     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00696 
00697         <span class="keywordflow">if</span> (!TypeMutexLocked) {
00698 
00699             <a class="code" href="../../d5/d1/obp_8h.html#a9">ObpLeaveObjectTypeMutex</a>( ObjectType );
00700         }
00701 
00702         *AccessStatus = <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00703 
00704         <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00705     }
00706 
00707     <span class="comment">//</span>
00708     <span class="comment">//  Lock the caller's tokens until after auditing has been</span>
00709     <span class="comment">//  performed.</span>
00710     <span class="comment">//</span>
00711 
00712     <a class="code" href="../../d0/d8/subject_8c.html#a1">SeLockSubjectContext</a>( &amp;AccessState-&gt;SubjectSecurityContext );
00713 
00714     <span class="comment">//</span>
00715     <span class="comment">//  Do the access check, and if we have some privileges then</span>
00716     <span class="comment">//  put those in the access state too.</span>
00717     <span class="comment">//</span>
00718 
00719     AccessAllowed = <a class="code" href="../../d0/d4/accessck_8c.html#a18">SeAccessCheck</a>( SecurityDescriptor,
00720                                    &amp;AccessState-&gt;SubjectSecurityContext,
00721                                    TRUE,               <span class="comment">// Tokens are locked</span>
00722                                    AccessState-&gt;RemainingDesiredAccess,
00723                                    AccessState-&gt;PreviouslyGrantedAccess,
00724                                    &amp;Privileges,
00725                                    &amp;ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o4">GenericMapping</a>,
00726                                    AccessMode,
00727                                    &amp;GrantedAccess,
00728                                    AccessStatus );
00729 
00730     <span class="keywordflow">if</span> (AccessAllowed) {
00731 
00732         AccessState-&gt;PreviouslyGrantedAccess |= GrantedAccess;
00733         AccessState-&gt;RemainingDesiredAccess &amp;= ~GrantedAccess;
00734     }
00735 
00736     <span class="comment">//</span>
00737     <span class="comment">//  If we have a security descriptor then call the security routine</span>
00738     <span class="comment">//  to audit this reference and then unlock the caller's token</span>
00739     <span class="comment">//</span>
00740 
00741     <span class="keywordflow">if</span> ( SecurityDescriptor != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00742 
00743         <a class="code" href="../../d3/d5/seaudit_8c.html#a27">SeObjectReferenceAuditAlarm</a>( &amp;AccessState-&gt;OperationID,
00744                                      Object,
00745                                      SecurityDescriptor,
00746                                      &amp;AccessState-&gt;SubjectSecurityContext,
00747                                      AccessState-&gt;RemainingDesiredAccess | AccessState-&gt;PreviouslyGrantedAccess,
00748                                      ((<a class="code" href="../../d5/d2/struct__AUX__ACCESS__DATA.html">PAUX_ACCESS_DATA</a>)(AccessState-&gt;AuxData))-&gt;PrivilegesUsed,
00749                                      AccessAllowed,
00750                                      AccessMode );
00751     }
00752 
00753     <a class="code" href="../../d0/d8/subject_8c.html#a2">SeUnlockSubjectContext</a>( &amp;AccessState-&gt;SubjectSecurityContext );
00754 
00755     <span class="comment">//</span>
00756     <span class="comment">//  If the caller didn't have the object type locked then remove</span>
00757     <span class="comment">//  our lock</span>
00758     <span class="comment">//</span>
00759 
00760     <span class="keywordflow">if</span> (!TypeMutexLocked) {
00761 
00762         <a class="code" href="../../d5/d1/obp_8h.html#a9">ObpLeaveObjectTypeMutex</a>( ObjectType );
00763     }
00764 
00765     <span class="comment">//</span>
00766     <span class="comment">//  Finally free the security descriptor</span>
00767     <span class="comment">//  and return to our caller</span>
00768     <span class="comment">//</span>
00769 
00770     <a class="code" href="../../d9/d1/obse_8c.html#a9">ObReleaseObjectSecurity</a>( SecurityDescriptor,
00771                              MemoryAllocated );
00772 
00773     <span class="keywordflow">return</span>( AccessAllowed );
00774 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a84" doxytag="obp.h::ObpCheckPseudoHandleAccess" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN ObpCheckPseudoHandleAccess           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Object</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>DesiredAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PNTSTATUS&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessStatus</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>TypeMutexLocked</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a85" doxytag="obp.h::ObpCheckTraverseAccess" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN ObpCheckTraverseAccess           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>DirectoryObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>TraverseAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d5/struct__ACCESS__STATE.html">PACCESS_STATE</a> AccessState&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>TypeMutexLocked</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PreviousMode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PNTSTATUS&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessStatus</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/obse_8c-source.html#l00778">778</a> of file <a class="el" href="../../d0/d1/obse_8c-source.html">obse.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00168">_OBJECT_TYPE_INITIALIZER::GenericMapping</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d0/d1/obse_8c-source.html#l01258">ObGetObjectSecurity()</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00355">OBJECT_TO_OBJECT_HEADER</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00163">ObpEnterObjectTypeMutex</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00176">ObpLeaveObjectTypeMutex</a>, <a class="el" href="../../d0/d1/obse_8c-source.html#l01418">ObReleaseObjectSecurity()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d3/accessck_8c-source.html#l03323">SeAccessCheck()</a>, <a class="el" href="../../d3/d4/seastate_8c-source.html#l00434">SeAppendPrivileges()</a>, <a class="el" href="../../d1/d3/accessck_8c-source.html#l03871">SeFastTraverseCheck()</a>, <a class="el" href="../../d1/d3/accessck_8c-source.html#l03294">SeFreePrivileges()</a>, <a class="el" href="../../d1/d7/subject_8c-source.html#l00115">SeLockSubjectContext()</a>, <a class="el" href="../../d1/d7/subject_8c-source.html#l00159">SeUnlockSubjectContext()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l00076">TOKEN_IS_RESTRICTED</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00302">_OBJECT_HEADER::Type</a>, and <a class="el" href="../../d5/d9/ob_8h-source.html#l00196">_OBJECT_TYPE::TypeInfo</a>.
<p>
Referenced by <a class="el" href="../../d9/d9/obdir_8c-source.html#l01081">ObpLookupObjectName()</a>.
<p>
<pre class="fragment"><div>00789                    :
00790 
00791     This routine checks <span class="keywordflow">for</span> traverse access to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> given directory object.
00792 
00793     Note that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> contents of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> AccessState structure are not
00794     modified, since <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> assumed that <span class="keyword">this</span> access check <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> incidental
00795     to another access operation.
00796 
00797 Arguments:
00798 
00799     DirectoryObject - The object body of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object being examined.
00800 
00801     TraverseAccess - The desired access to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object, most likely DIRECTORY
00802         TRAVERSE access.
00803 
00804     AccessState - Checks <span class="keywordflow">for</span> traverse access will typically be incidental
00805         to some other access attempt.  Information on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current state of
00806         that access attempt <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> required so that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> constituent access
00807         attempts may be associated with each other in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> audit log.
00808         This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> an OPTIONAL parameter, in which <span class="keywordflow">case</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> call will
00809         success ONLY <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d5/editreg_8c.html#a68">Directory</a> Object grants World traverse
00810         access rights.
00811 
00812     TypeMutexLocked - Indicates whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> mutex <span class="keywordflow">for</span> <span class="keyword">this</span> object's
00813         <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> locked.  The <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> mutex <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to protect <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object's
00814         security descriptor from being modified <span class="keywordflow">while</span> <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being accessed.
00815 
00816     PreviousMode - The previous processor mode.
00817 
00818     AccessStatus - Pointer to a variable to <span class="keywordflow">return</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> status code of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00819         access attempt.  In <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keywordflow">case</span> of <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a> <span class="keyword">this</span> status code must be
00820         propagated back to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user.
00821 
00822 Return Value:
00823 
00824     BOOLEAN - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> access <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> allowed and <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise.  AccessStatus
00825     contains <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> status code to be passed back to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller.  It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not
00826     correct to simply pass back STATUS_ACCESS_DENIED, since <span class="keyword">this</span> will have
00827     to change with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> advent of mandatory access <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a>.
00828 
00829 --*/
00830 
00831 {
00832     BOOLEAN AccessAllowed;
00833     ACCESS_MASK GrantedAccess = 0;
00834     PSECURITY_DESCRIPTOR SecurityDescriptor;
00835     BOOLEAN MemoryAllocated;
00836     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00837     <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> ObjectHeader;
00838     <a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> ObjectType;
00839     BOOLEAN SubjectContextLocked = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00840     PPRIVILEGE_SET Privileges = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00841 
00842     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00843 
00844     <span class="comment">//</span>
00845     <span class="comment">//  Map the object body to an object header and corresponding</span>
00846     <span class="comment">//  object type</span>
00847     <span class="comment">//</span>
00848 
00849     ObjectHeader = <a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>( DirectoryObject );
00850     ObjectType = ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o3">Type</a>;
00851 
00852     <span class="comment">//</span>
00853     <span class="comment">//  If the caller hasn't locked down the object type then</span>
00854     <span class="comment">//  lock it down now</span>
00855     <span class="comment">//</span>
00856 
00857     <span class="keywordflow">if</span> (!TypeMutexLocked) {
00858 
00859         <a class="code" href="../../d5/d1/obp_8h.html#a8">ObpEnterObjectTypeMutex</a>( ObjectType );
00860     }
00861 
00862     <span class="comment">//</span>
00863     <span class="comment">//  Obtain the object's security descriptor and make it was</span>
00864     <span class="comment">//  successful</span>
00865     <span class="comment">//</span>
00866 
00867     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d1/obse_8c.html#a8">ObGetObjectSecurity</a>( DirectoryObject,
00868                                   &amp;SecurityDescriptor,
00869                                   &amp;MemoryAllocated );
00870 
00871     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00872 
00873         <span class="keywordflow">if</span> (!TypeMutexLocked) {
00874 
00875             <a class="code" href="../../d5/d1/obp_8h.html#a9">ObpLeaveObjectTypeMutex</a>( ObjectType );
00876         }
00877 
00878         *AccessStatus = <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00879 
00880         <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00881     }
00882 
00883     <span class="comment">//</span>
00884     <span class="comment">//  Check to see if WORLD has TRAVERSE access, by seeing if the</span>
00885     <span class="comment">//  token is restricted or the fast traverse check fails meaning</span>
00886     <span class="comment">//  that the world does not have traverse access</span>
00887     <span class="comment">//</span>
00888 
00889     <span class="keywordflow">if</span> (((AccessState-&gt;Flags &amp; <a class="code" href="../../d0/d5/se_8h.html#a5">TOKEN_IS_RESTRICTED</a>) != 0)
00890 
00891         ||
00892 
00893         (!<a class="code" href="../../d0/d4/accessck_8c.html#a22">SeFastTraverseCheck</a>( SecurityDescriptor,
00894                                DIRECTORY_TRAVERSE,
00895                                PreviousMode ))) {
00896 
00897         <span class="comment">//</span>
00898         <span class="comment">//  SeFastTraverseCheck could be modified to tell us that</span>
00899         <span class="comment">//  no one has any access to this directory.  However,</span>
00900         <span class="comment">//  we're going to have to fail this entire call if</span>
00901         <span class="comment">//  that is the case, so we really don't need to worry</span>
00902         <span class="comment">//  all that much about making it blindingly fast.</span>
00903         <span class="comment">//</span>
00904 
00905         <span class="keywordflow">if</span> (ARGUMENT_PRESENT( AccessState )) {
00906 
00907             <span class="comment">//</span>
00908             <span class="comment">//  The world does not have traverse access and we have</span>
00909             <span class="comment">//  the client's access state so lock down the client's</span>
00910             <span class="comment">//  token and then do the access check, appending privileges</span>
00911             <span class="comment">//  if present.  The access check will give the answer</span>
00912             <span class="comment">//  we return back to our caller</span>
00913             <span class="comment">//</span>
00914 
00915             <a class="code" href="../../d0/d8/subject_8c.html#a1">SeLockSubjectContext</a>( &amp;AccessState-&gt;SubjectSecurityContext );
00916 
00917             SubjectContextLocked = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00918 
00919             AccessAllowed = <a class="code" href="../../d0/d4/accessck_8c.html#a18">SeAccessCheck</a>( SecurityDescriptor,
00920                                            &amp;AccessState-&gt;SubjectSecurityContext,
00921                                            TRUE,             <span class="comment">// Tokens are locked</span>
00922                                            TraverseAccess,
00923                                            0,
00924                                            &amp;Privileges,
00925                                            &amp;ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o4">GenericMapping</a>,
00926                                            PreviousMode,
00927                                            &amp;GrantedAccess,
00928                                            AccessStatus );
00929 
00930             <span class="keywordflow">if</span> (Privileges != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00931 
00932                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d5/seastate_8c.html#a5">SeAppendPrivileges</a>( AccessState,
00933                                              Privileges );
00934 
00935                 <a class="code" href="../../d0/d4/accessck_8c.html#a17">SeFreePrivileges</a>( Privileges );
00936             }
00937         }
00938 
00939     } <span class="keywordflow">else</span> {
00940 
00941         <span class="comment">//</span>
00942         <span class="comment">//  At this point the world has traverse access</span>
00943         <span class="comment">//</span>
00944 
00945         AccessAllowed = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00946     }
00947 
00948     <span class="comment">//</span>
00949     <span class="comment">//  If the client's token is locked then now we can unlock it</span>
00950     <span class="comment">//</span>
00951     <span class="comment">//  **** this should be able to move up into the preceding clause</span>
00952     <span class="comment">//  where it is locked</span>
00953     <span class="comment">//</span>
00954 
00955     <span class="keywordflow">if</span> ( SubjectContextLocked ) {
00956 
00957         <a class="code" href="../../d0/d8/subject_8c.html#a2">SeUnlockSubjectContext</a>( &amp;AccessState-&gt;SubjectSecurityContext );
00958     }
00959 
00960     <span class="comment">//</span>
00961     <span class="comment">//  If the caller did not lock the object type then we</span>
00962     <span class="comment">//  now need to unlock it</span>
00963     <span class="comment">//</span>
00964 
00965     <span class="keywordflow">if</span> (!TypeMutexLocked) {
00966 
00967         <a class="code" href="../../d5/d1/obp_8h.html#a9">ObpLeaveObjectTypeMutex</a>( ObjectType );
00968     }
00969 
00970     <span class="comment">//</span>
00971     <span class="comment">//  Finally free the security descriptor</span>
00972     <span class="comment">//  and then return to our caller</span>
00973     <span class="comment">//</span>
00974 
00975     <a class="code" href="../../d9/d1/obse_8c.html#a9">ObReleaseObjectSecurity</a>( SecurityDescriptor,
00976                              MemoryAllocated );
00977 
00978     <span class="keywordflow">return</span>( AccessAllowed );
00979 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a95" doxytag="obp.h::ObpCompareSecurityDescriptors" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN ObpCompareSecurityDescriptors           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PSECURITY_DESCRIPTOR&nbsp;</td>
          <td class="mdname" nowrap> <em>SD1</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSECURITY_DESCRIPTOR&nbsp;</td>
          <td class="mdname" nowrap> <em>SD2</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d0/obsdata_8c-source.html#l00839">839</a> of file <a class="el" href="../../d9/d0/obsdata_8c-source.html">obsdata.c</a>.
<p>
References <a class="el" href="../../d0/d1/lboxctl2_8c-source.html#l02757">Compare()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, and <a class="el" href="../../d9/d5/sertl_8c-source.html#l02165">RtlLengthSecurityDescriptor()</a>.
<p>
Referenced by <a class="el" href="../../d9/d0/obsdata_8c-source.html#l00297">ObpLogSecurityDescriptor()</a>.
<p>
<pre class="fragment"><div>00846                    :
00847 
00848     Performs a byte by byte comparison of two <span class="keyword">self</span> relative security
00849     descriptors to determine <span class="keywordflow">if</span> they are identical.
00850 
00851 Arguments:
00852 
00853     SD1, SD2 - Security descriptors to be compared.
00854 
00855 Return Value:
00856 
00857     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> - They are <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> same.
00858 
00859     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> - They are different.
00860 
00861 --*/
00862 
00863 {
00864     ULONG Length1;
00865     ULONG Length2;
00866     ULONG <a class="code" href="../../d9/d1/lboxctl2_8c.html#a38">Compare</a>;
00867 
00868     <span class="comment">//</span>
00869     <span class="comment">//  Calculating the length is pretty fast, see if we</span>
00870     <span class="comment">//  can get away with doing only that.</span>
00871     <span class="comment">//</span>
00872 
00873     Length1 =  <a class="code" href="../../d8/d6/sertl_8c.html#a56">RtlLengthSecurityDescriptor</a> ( SD1 );
00874     Length2 =  <a class="code" href="../../d8/d6/sertl_8c.html#a56">RtlLengthSecurityDescriptor</a> ( SD2 );
00875 
00876     <span class="keywordflow">if</span> (Length1 != Length2) {
00877 
00878         <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00879     }
00880 
00881     <span class="keywordflow">return</span> (BOOLEAN)RtlEqualMemory ( SD1, SD2, Length1 );
00882 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a91" doxytag="obp.h::ObpCreateCacheEntry" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d9/d0/struct__SECURITY__DESCRIPTOR__HEADER.html">PSECURITY_DESCRIPTOR_HEADER</a> ObpCreateCacheEntry           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PSECURITY_DESCRIPTOR&nbsp;</td>
          <td class="mdname" nowrap> <em>InputSecurityDescriptor</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>FullHash</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d0/obsdata_8c-source.html#l00491">491</a> of file <a class="el" href="../../d9/d0/obsdata_8c-source.html">obsdata.c</a>.
<p>
References <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00302">_SECURITY_DESCRIPTOR_HEADER::FullHash</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00300">_SECURITY_DESCRIPTOR_HEADER::Link</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00301">_SECURITY_DESCRIPTOR_HEADER::RefCount</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l02165">RtlLengthSecurityDescriptor()</a>, and <a class="el" href="../../d6/d0/obp_8h-source.html#l00303">_SECURITY_DESCRIPTOR_HEADER::SecurityDescriptor</a>.
<p>
Referenced by <a class="el" href="../../d9/d0/obsdata_8c-source.html#l00297">ObpLogSecurityDescriptor()</a>.
<p>
<pre class="fragment"><div>00498                    :
00499 
00500     Allocates and initializes a <span class="keyword">new</span> cache entry.
00501 
00502 Arguments:
00503 
00504     InputSecurityDescriptor - The security descriptor to be cached.
00505 
00506     FullHash - Full 32 bit hash of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security descriptor.
00507 
00508 Return Value:
00509 
00510     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> newly allocated cache entry, or <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00511 
00512 --*/
00513 
00514 {
00515 
00516     ULONG SecurityDescriptorLength;
00517     ULONG CacheEntrySize;
00518     <a class="code" href="../../d9/d0/struct__SECURITY__DESCRIPTOR__HEADER.html">PSECURITY_DESCRIPTOR_HEADER</a> NewDescriptor;
00519 
00520     <span class="comment">//</span>
00521     <span class="comment">//  Compute the size that we'll need to allocate.  We need space for</span>
00522     <span class="comment">//  the security descriptor cache minus the funny quad at the end and the</span>
00523     <span class="comment">//  security descriptor itself.</span>
00524     <span class="comment">//</span>
00525 
00526     SecurityDescriptorLength = <a class="code" href="../../d8/d6/sertl_8c.html#a56">RtlLengthSecurityDescriptor</a> ( InputSecurityDescriptor );
00527     CacheEntrySize = SecurityDescriptorLength + (<span class="keyword">sizeof</span>(<a class="code" href="../../d9/d0/struct__SECURITY__DESCRIPTOR__HEADER.html">SECURITY_DESCRIPTOR_HEADER</a>) - <span class="keyword">sizeof</span>( QUAD ));
00528 
00529     <span class="comment">//</span>
00530     <span class="comment">//  Now allocate space for the cached entry</span>
00531     <span class="comment">//</span>
00532 
00533     NewDescriptor = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( PagedPool, CacheEntrySize, 'dSeS');
00534 
00535     <span class="keywordflow">if</span> ( NewDescriptor == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00536 
00537         <span class="keywordflow">return</span>( <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00538     }
00539 
00540     <span class="comment">//</span>
00541     <span class="comment">//  Fill the header, copy over the descriptor data, and return to our</span>
00542     <span class="comment">//  caller</span>
00543     <span class="comment">//</span>
00544 
00545     NewDescriptor-&gt;<a class="code" href="../../d9/d0/struct__SECURITY__DESCRIPTOR__HEADER.html#o1">RefCount</a>   = 1;
00546     NewDescriptor-&gt;<a class="code" href="../../d9/d0/struct__SECURITY__DESCRIPTOR__HEADER.html#o2">FullHash</a>   = FullHash;
00547     NewDescriptor-&gt;<a class="code" href="../../d9/d0/struct__SECURITY__DESCRIPTOR__HEADER.html#o0">Link</a>.Flink = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00548     NewDescriptor-&gt;<a class="code" href="../../d9/d0/struct__SECURITY__DESCRIPTOR__HEADER.html#o0">Link</a>.Blink = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00549 
00550     RtlCopyMemory( &amp;NewDescriptor-&gt;<a class="code" href="../../d9/d0/struct__SECURITY__DESCRIPTOR__HEADER.html#o3">SecurityDescriptor</a>,
00551                    InputSecurityDescriptor,
00552                    SecurityDescriptorLength );
00553 
00554     <span class="keywordflow">return</span>( NewDescriptor );
00555 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a79" doxytag="obp.h::ObpCreateHandle" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS ObpCreateHandle           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d0/ob_8h.html#a21">OB_OPEN_REASON</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>OpenReason</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Object</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> ExpectedObjectType&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d5/struct__ACCESS__STATE.html">PACCESS_STATE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessState</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG ObjectPointerBias&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Attributes</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>DirectoryLocked</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessMode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID *ReferencedNewObject&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PHANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>Handle</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/obhandle_8c-source.html#l02160">2160</a> of file <a class="el" href="../../d0/d0/obhandle_8c-source.html">obhandle.c</a>.
<p>
References <a class="el" href="../../d6/d7/ex_8h-source.html#l02695">_HANDLE_TABLE_ENTRY::CreatorBackTraceIndex</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00416">EncodeKernelHandle</a>, <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l01144">ExCreateHandle()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02690">_HANDLE_TABLE_ENTRY::GrantedAccess</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02694">_HANDLE_TABLE_ENTRY::GrantedAccessIndex</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00091">Handle</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00324">KeStackAttachProcess()</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00512">KeUnstackDetachProcess()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00370">NtGlobalFlag</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02674">_HANDLE_TABLE_ENTRY::ObAttributes</a>, <a class="el" href="../../d4/d0/ob_8h.html#a100a58">ObCreateHandle</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00408">OBJ_AUDIT_OBJECT_CLOSE</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00289">OBJ_HANDLE_ATTRIBUTES</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02672">_HANDLE_TABLE_ENTRY::Object</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00355">OBJECT_TO_OBJECT_HEADER</a>, <a class="el" href="../../d0/d0/obhandle_8c-source.html#l01967">ObpDecrementHandleCount()</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00144">ObpDecrPointerCount</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00213">ObpGetObjectTable</a>, <a class="el" href="../../d0/d0/obhandle_8c-source.html#l01232">ObpIncrementHandleCount()</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00143">ObpIncrPointerCount</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00399">ObpKernelHandleTable</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00202">ObpLeaveRootDirectoryMutex</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00071">ObpValidateIrql</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d0/d5/se_8h.html#a28">PAUX_ACCESS_DATA</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00166">_EPROCESS::Pcb</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l00258">_AUX_ACCESS_DATA::PrivilegesUsed</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00579">PsInitialSystemProcess</a>, <a class="el" href="../../d4/d4/seaudit_8c-source.html#l03736">SeAuditHandleCreation()</a>, <a class="el" href="../../d4/d4/seaudit_8c-source.html#l00650">SePrivilegeObjectAuditAlarm()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00302">_OBJECT_HEADER::Type</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00196">_OBJECT_TYPE::TypeInfo</a>, and <a class="el" href="../../d5/d9/ob_8h-source.html#l00169">_OBJECT_TYPE_INITIALIZER::ValidAccessMask</a>.
<p>
Referenced by <a class="el" href="../../d2/d0/obinsert_8c-source.html#l00029">ObInsertObject()</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00095">ObOpenObjectByName()</a>, and <a class="el" href="../../d8/d0/obref_8c-source.html#l00367">ObOpenObjectByPointer()</a>.
<p>
<pre class="fragment"><div>02175                    :
02176 
02177     This function creates a <span class="keyword">new</span> handle to an existing object
02178 
02179 Arguments:
02180 
02181     OpenReason - The <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a10">reason</a> why we are doing <span class="keyword">this</span> work
02182 
02183     Object - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> body of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> object
02184 
02185     ExpectedObjectType - Optionally Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> that
02186         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> expecting
02187 
02188     AccessState - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> access state <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle requested
02189         by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller
02190 
02191     ObjectPointerBias - Optionally supplies a count of addition
02192         increments we <span class="keywordflow">do</span> to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pointer count <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object
02193 
02194     Attributes -  Desired attributes <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle
02195 
02196     DirectoryLocked - Indicates <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> root directory mutex <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> already held
02197 
02198     AccessMode - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> mode of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> requestor.
02199 
02200     ReferencedNewObject - Optionally receives a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> body
02201         of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> object
02202 
02203     <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> - Receives <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> handle value
02204 
02205 Return Value:
02206 
02207     An appropriate status value
02208 
02209 --*/
02210 
02211 {
02212     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02213     <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> ObjectHeader;
02214     <a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> ObjectType;
02215     PVOID ObjectTable;
02216     <a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html">HANDLE_TABLE_ENTRY</a> ObjectTableEntry;
02217     HANDLE NewHandle;
02218     ACCESS_MASK DesiredAccess;
02219     ACCESS_MASK GrantedAccess;
02220     ULONG BiasCount;
02221     BOOLEAN AttachedToProcess = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02222     BOOLEAN KernelHandle = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02223     <a class="code" href="../../d3/d5/struct__KAPC__STATE.html">KAPC_STATE</a> ApcState;
02224 
02225     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02226 
02227     <a class="code" href="../../d5/d1/obp_8h.html#a2">ObpValidateIrql</a>( <span class="stringliteral">"ObpCreateHandle"</span> );
02228 
02229     <span class="comment">//</span>
02230     <span class="comment">//  Merge both the remaining desired access and the currently</span>
02231     <span class="comment">//  granted access states into one mask</span>
02232     <span class="comment">//</span>
02233     <span class="comment">//  **** why is this being done here and then later in the this</span>
02234     <span class="comment">//  same routine.</span>
02235     <span class="comment">//</span>
02236 
02237     DesiredAccess = AccessState-&gt;RemainingDesiredAccess |
02238                     AccessState-&gt;PreviouslyGrantedAccess;
02239 
02240     <span class="comment">//</span>
02241     <span class="comment">//  Get a pointer to the object header and object type</span>
02242     <span class="comment">//</span>
02243 
02244     ObjectHeader = <a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>( Object );
02245     ObjectType = ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o3">Type</a>;
02246 
02247     <span class="comment">//</span>
02248     <span class="comment">//  If the object type isn't what was expected then</span>
02249     <span class="comment">//  return an error to our caller, but first see if</span>
02250     <span class="comment">//  we should release the directory mutex</span>
02251     <span class="comment">//</span>
02252 
02253     <span class="keywordflow">if</span> ((ARGUMENT_PRESENT( ExpectedObjectType )) &amp;&amp;
02254         (ObjectType != ExpectedObjectType )) {
02255 
02256         <span class="keywordflow">if</span> (DirectoryLocked) {
02257 
02258             <a class="code" href="../../d5/d1/obp_8h.html#a11">ObpLeaveRootDirectoryMutex</a>();
02259         }
02260 
02261         <span class="keywordflow">return</span>( STATUS_OBJECT_TYPE_MISMATCH );
02262     }
02263 
02264     <span class="comment">//</span>
02265     <span class="comment">//  Set the first ulong of the object table entry to point</span>
02266     <span class="comment">//  back to the object header</span>
02267     <span class="comment">//</span>
02268 
02269     ObjectTableEntry.<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o0">Object</a> = ObjectHeader;
02270 
02271     <span class="comment">//</span>
02272     <span class="comment">//  Now get a pointer to the object table for either the current process</span>
02273     <span class="comment">//  of the kernel handle table</span>
02274     <span class="comment">//</span>
02275 
02276     <span class="keywordflow">if</span> ((Attributes &amp; OBJ_KERNEL_HANDLE) &amp;&amp; (AccessMode == <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>)) {
02277 
02278         ObjectTable = <a class="code" href="../../d5/d1/obp_8h.html#a54">ObpKernelHandleTable</a>;
02279         KernelHandle = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02280 
02281         <span class="comment">//</span>
02282         <span class="comment">//  Go to the system process if we have to</span>
02283         <span class="comment">//</span>
02284 
02285         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>() != <a class="code" href="../../d1/d9/ps_8h.html#a53">PsInitialSystemProcess</a>) {
02286             <a class="code" href="../../d3/d5/procobj_8c.html#a6">KeStackAttachProcess</a> (&amp;<a class="code" href="../../d1/d9/ps_8h.html#a53">PsInitialSystemProcess</a>-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>, &amp;ApcState);
02287             AttachedToProcess = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02288         }
02289 
02290 
02291     } <span class="keywordflow">else</span> {
02292 
02293         ObjectTable = <a class="code" href="../../d5/d1/obp_8h.html#a12">ObpGetObjectTable</a>();
02294     }
02295 
02296     <span class="comment">//</span>
02297     <span class="comment">//  ObpIncrementHandleCount will perform access checking on the</span>
02298     <span class="comment">//  object being opened as appropriate.</span>
02299     <span class="comment">//</span>
02300 
02301     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d1/obp_8h.html#a77">ObpIncrementHandleCount</a>( OpenReason,
02302                                       <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>(),
02303                                       Object,
02304                                       ObjectType,
02305                                       AccessState,
02306                                       AccessMode,
02307                                       Attributes );
02308 
02309     <span class="keywordflow">if</span> (AccessState-&gt;GenerateOnClose) {
02310 
02311         Attributes |= <a class="code" href="../../d7/d7/ntapi_8c.html#a2">OBJ_AUDIT_OBJECT_CLOSE</a>;
02312     }
02313 
02314     <span class="comment">//</span>
02315     <span class="comment">//  Or in some low order bits into the first ulong of the object</span>
02316     <span class="comment">//  table entry</span>
02317     <span class="comment">//</span>
02318 
02319     ObjectTableEntry.<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o1">ObAttributes</a> |= (Attributes &amp; <a class="code" href="../../d5/d1/obp_8h.html#a17">OBJ_HANDLE_ATTRIBUTES</a>);
02320 
02321     <span class="comment">//</span>
02322     <span class="comment">//  Merge both the remaining desired access and the currently</span>
02323     <span class="comment">//  granted access states into one mask and then compute</span>
02324     <span class="comment">//  the granted access</span>
02325     <span class="comment">//</span>
02326 
02327     DesiredAccess = AccessState-&gt;RemainingDesiredAccess |
02328                     AccessState-&gt;PreviouslyGrantedAccess;
02329 
02330     GrantedAccess = DesiredAccess &amp;
02331                     (ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o5">ValidAccessMask</a> | ACCESS_SYSTEM_SECURITY );
02332 
02333     <span class="comment">//</span>
02334     <span class="comment">//  Unlock the directory if it is locked and make sure</span>
02335     <span class="comment">//  we've been successful so far</span>
02336     <span class="comment">//</span>
02337 
02338     <span class="keywordflow">if</span> (DirectoryLocked) {
02339 
02340         <a class="code" href="../../d5/d1/obp_8h.html#a11">ObpLeaveRootDirectoryMutex</a>();
02341     }
02342 
02343     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
02344 
02345         <span class="comment">//</span>
02346         <span class="comment">//  If we are attached to the system process then return</span>
02347         <span class="comment">//  back to our caller</span>
02348         <span class="comment">//</span>
02349 
02350         <span class="keywordflow">if</span> (AttachedToProcess) {
02351             <a class="code" href="../../d3/d5/procobj_8c.html#a8">KeUnstackDetachProcess</a>(&amp;ApcState);
02352             AttachedToProcess = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02353         }
02354 
02355         <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
02356     }
02357 
02358     <span class="comment">//</span>
02359     <span class="comment">//  Bias the pointer count if that is what the caller wanted</span>
02360     <span class="comment">//</span>
02361 
02362     <span class="keywordflow">if</span> (ARGUMENT_PRESENT( (PVOID)(ULONG_PTR)ObjectPointerBias )) {
02363 
02364         BiasCount = ObjectPointerBias;
02365 
02366         <span class="keywordflow">while</span> (BiasCount--) {
02367 
02368             <a class="code" href="../../d5/d1/obp_8h.html#a3">ObpIncrPointerCount</a>( ObjectHeader );
02369         }
02370     }
02371 
02372     <span class="comment">//</span>
02373     <span class="comment">//  Set the granted access mask in the object table entry (second ulong)</span>
02374     <span class="comment">//</span>
02375 
02376 <span class="preprocessor">#if i386 &amp;&amp; !FPO</span>
02377 <span class="preprocessor"></span>
02378     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a33">NtGlobalFlag</a> &amp; FLG_KERNEL_STACK_TRACE_DB) {
02379 
02380         ObjectTableEntry.<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o3">GrantedAccessIndex</a> = ObpComputeGrantedAccessIndex( GrantedAccess );
02381         ObjectTableEntry.<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o4">CreatorBackTraceIndex</a> = RtlLogStackBackTrace();
02382 
02383     } <span class="keywordflow">else</span> {
02384 
02385         ObjectTableEntry.<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o2">GrantedAccess</a> = GrantedAccess;
02386     }
02387 
02388 <span class="preprocessor">#else</span>
02389 <span class="preprocessor"></span>
02390     ObjectTableEntry.<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o2">GrantedAccess</a> = GrantedAccess;
02391 
02392 <span class="preprocessor">#endif // i386 &amp;&amp; !FPO</span>
02393 <span class="preprocessor"></span>
02394     <span class="comment">//</span>
02395     <span class="comment">//  Add this new object table entry to the object table for the process</span>
02396     <span class="comment">//</span>
02397 
02398     NewHandle = <a class="code" href="../../d5/d8/ex_8h.html#a296">ExCreateHandle</a>( ObjectTable, &amp;ObjectTableEntry );
02399 
02400     <span class="comment">//</span>
02401     <span class="comment">//  If we didn't get a handle then cleanup after ourselves and return</span>
02402     <span class="comment">//  the error to our caller</span>
02403     <span class="comment">//</span>
02404 
02405     <span class="keywordflow">if</span> (NewHandle == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02406 
02407         <span class="keywordflow">if</span> (ARGUMENT_PRESENT( (PVOID)(ULONG_PTR)ObjectPointerBias )) {
02408 
02409             BiasCount = ObjectPointerBias;
02410 
02411             <span class="keywordflow">while</span> (BiasCount--) {
02412 
02413                 <a class="code" href="../../d5/d1/obp_8h.html#a4">ObpDecrPointerCount</a>( ObjectHeader );
02414             }
02415         }
02416 
02417         <a class="code" href="../../d5/d1/obp_8h.html#a78">ObpDecrementHandleCount</a>( <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>(),
02418                                  ObjectHeader,
02419                                  ObjectType,
02420                                  GrantedAccess );
02421 
02422         <span class="comment">//</span>
02423         <span class="comment">//  If we are attached to the system process then return</span>
02424         <span class="comment">//  back to our caller</span>
02425         <span class="comment">//</span>
02426 
02427         <span class="keywordflow">if</span> (AttachedToProcess) {
02428             <a class="code" href="../../d3/d5/procobj_8c.html#a8">KeUnstackDetachProcess</a>(&amp;ApcState);
02429             AttachedToProcess = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02430         }
02431 
02432         <span class="keywordflow">return</span>( STATUS_INSUFFICIENT_RESOURCES );
02433     }
02434 
02435     <span class="comment">//</span>
02436     <span class="comment">//  We have a new Ex style handle now make it an ob style handle and also</span>
02437     <span class="comment">//  adjust for the kernel handle by setting the sign bit in the handle</span>
02438     <span class="comment">//  value</span>
02439     <span class="comment">//</span>
02440 
02441     <span class="keywordflow">if</span> (KernelHandle) {
02442 
02443         NewHandle = <a class="code" href="../../d5/d1/obp_8h.html#a26">EncodeKernelHandle</a>( NewHandle );
02444     }
02445 
02446     *<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> = NewHandle;
02447 
02448     <span class="comment">//</span>
02449     <span class="comment">//  If requested, generate audit messages to indicate that a new handle</span>
02450     <span class="comment">//  has been allocated.</span>
02451     <span class="comment">//</span>
02452     <span class="comment">//  This is the final security operation in the creation/opening of the</span>
02453     <span class="comment">//  object.</span>
02454     <span class="comment">//</span>
02455 
02456     <span class="keywordflow">if</span> ( AccessState-&gt;GenerateAudit ) {
02457 
02458         <a class="code" href="../../d3/d5/seaudit_8c.html#a28">SeAuditHandleCreation</a>( AccessState,
02459                                *Handle );
02460     }
02461 
02462     <span class="keywordflow">if</span> (OpenReason == <a class="code" href="../../d4/d0/ob_8h.html#a100a58">ObCreateHandle</a>) {
02463 
02464         <a class="code" href="../../d5/d2/struct__AUX__ACCESS__DATA.html">PAUX_ACCESS_DATA</a> AuxData = AccessState-&gt;AuxData;
02465 
02466         <span class="keywordflow">if</span> ( ( AuxData-&gt;<a class="code" href="../../d5/d2/struct__AUX__ACCESS__DATA.html#o0">PrivilegesUsed</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (AuxData-&gt;<a class="code" href="../../d5/d2/struct__AUX__ACCESS__DATA.html#o0">PrivilegesUsed</a>-&gt;PrivilegeCount &gt; 0) ) {
02467 
02468             <a class="code" href="../../d3/d5/seaudit_8c.html#a13">SePrivilegeObjectAuditAlarm</a>( *Handle,
02469                                          &amp;AccessState-&gt;SubjectSecurityContext,
02470                                          GrantedAccess,
02471                                          AuxData-&gt;<a class="code" href="../../d5/d2/struct__AUX__ACCESS__DATA.html#o0">PrivilegesUsed</a>,
02472                                          TRUE,
02473                                          KeGetPreviousMode() );
02474         }
02475     }
02476 
02477     <span class="comment">//</span>
02478     <span class="comment">//  If the caller had a pointer bias and wanted the new reference object</span>
02479     <span class="comment">//  then return that value</span>
02480     <span class="comment">//</span>
02481 
02482     <span class="keywordflow">if</span> ((ARGUMENT_PRESENT( (PVOID)(ULONG_PTR)ObjectPointerBias )) &amp;&amp;
02483         (ARGUMENT_PRESENT( ReferencedNewObject ))) {
02484 
02485         *ReferencedNewObject = Object;
02486     }
02487 
02488     <span class="comment">//</span>
02489     <span class="comment">//  If we are attached to the system process then return</span>
02490     <span class="comment">//  back to our caller</span>
02491     <span class="comment">//</span>
02492 
02493     <span class="keywordflow">if</span> (AttachedToProcess) {
02494         <a class="code" href="../../d3/d5/procobj_8c.html#a8">KeUnstackDetachProcess</a>(&amp;ApcState);
02495         AttachedToProcess = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02496     }
02497 
02498     <span class="comment">//</span>
02499     <span class="comment">//  And return to our caller</span>
02500     <span class="comment">//</span>
02501 
02502     <span class="keywordflow">return</span>( STATUS_SUCCESS );
02503 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a66" doxytag="obp.h::ObpCreateSymbolicLinkName" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID ObpCreateSymbolicLinkName           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d2/d6/struct__OBJECT__SYMBOLIC__LINK.html">POBJECT_SYMBOLIC_LINK</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>SymbolicLink</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d0/oblink_8c-source.html#l01015">1015</a> of file <a class="el" href="../../d5/d0/oblink_8c-source.html">oblink.c</a>.
<p>
References <a class="el" href="../../d5/d0/oblink_8c-source.html#l00041">CREATE_SYMBOLIC_LINK</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00213">_OBJECT_DIRECTORY::DeviceMap</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00331">_OBJECT_HEADER_NAME_INFO::Directory</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00234">_OBJECT_SYMBOLIC_LINK::DosDeviceDriveIndex</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00332">_OBJECT_HEADER_NAME_INFO::Name</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00368">OBJECT_HEADER_TO_NAME_INFO</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00355">OBJECT_TO_OBJECT_HEADER</a>, <a class="el" href="../../d5/d0/oblink_8c-source.html#l01121">ObpProcessDosDeviceSymbolicLink()</a>, and <a class="el" href="../../d7/d5/nls_8c-source.html#l01178">RtlUpcaseUnicodeChar()</a>.
<p>
Referenced by <a class="el" href="../../d2/d0/obinsert_8c-source.html#l00029">ObInsertObject()</a>.
<p>
<pre class="fragment"><div>01021                    :
01022 
01023     This routine does extra processing <span class="keywordflow">for</span> symbolic links being created in
01024     object directories controlled by device map objects.
01025 
01026     This processing consists of:
01027 
01028     1.  Determine <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> symbolic link <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a drive letter.
01029         If so, then we will need to update <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> drive <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01030         associated device map object.
01031 
01032     2.  Process <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> link target, trying to resolve <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> into a pointer to
01033         an object other than a object directory object.  All object
01034         directories traversed must grant world traverse access other
01035         wise we bail <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a>.  If we successfully find a non object
01036         directory object, then reference <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object pointer and store <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>
01037         in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> symbolic link object, along with a remaining string <span class="keywordflow">if</span>
01038         any.  <a class="code" href="../../d8/d0/obdir_8c.html#a6">ObpLookupObjectName</a> will used <span class="keyword">this</span> cache object pointer to
01039         <span class="keywordtype">short</span> circuit <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name lookup directly to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> cached object's
01040         parse routine.  For any object directory objects traversed along
01041         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> way, increment their symbolic link SymbolicLinkUsageCount
01042         field.  This field <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used whenever an object directory <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
01043         deleted or its security <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> changed such that <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> no longer grants
01044         world traverse access.  In either <span class="keywordflow">case</span>, <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> field <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> non-zero
01045         we walk all <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> symbolic links and resnap them.
01046 
01047 Arguments:
01048 
01049     SymbolicLink - pointer to symbolic link object being created.
01050 
01051 Return Value:
01052 
01053     None.
01054 
01055 --*/
01056 
01057 {
01058     <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> ObjectHeader;
01059     <a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html">POBJECT_HEADER_NAME_INFO</a> NameInfo;
01060     WCHAR DosDeviceDriveLetter;
01061     ULONG DosDeviceDriveIndex;
01062 
01063     <span class="comment">//</span>
01064     <span class="comment">//  Now see if this symbolic link is being created in an object directory</span>
01065     <span class="comment">//  controlled by a device map object.  Since we are only called from</span>
01066     <span class="comment">//  NtCreateSymbolicLinkObject, after the handle to this symbolic link</span>
01067     <span class="comment">//  has been created but before it is returned to the caller the handle can't</span>
01068     <span class="comment">//  be closed while we are executing, unless via a random close,</span>
01069     <span class="comment">//  So no need to hold the type specific mutex while we look at the name.</span>
01070     <span class="comment">//</span>
01071 
01072     ObjectHeader = <a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>( SymbolicLink );
01073     NameInfo = <a class="code" href="../../d4/d0/ob_8h.html#a12">OBJECT_HEADER_TO_NAME_INFO</a>( ObjectHeader );
01074 
01075     <span class="keywordflow">if</span> ((NameInfo == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
01076         (NameInfo-&gt;<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html#o0">Directory</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
01077         (NameInfo-&gt;<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html#o0">Directory</a>-&gt;<a class="code" href="../../d8/d4/struct__OBJECT__DIRECTORY.html#o4">DeviceMap</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
01078 
01079         <span class="keywordflow">return</span>;
01080     }
01081 
01082     <span class="comment">//</span>
01083     <span class="comment">//  Here if we are creating a symbolic link in an object directory controlled</span>
01084     <span class="comment">//  by a device map object.  See if this is a drive letter definition.  If so</span>
01085     <span class="comment">//  calculate the drive letter index and remember in the symbolic link object.</span>
01086     <span class="comment">//</span>
01087 
01088     DosDeviceDriveIndex = 0;
01089 
01090     <span class="keywordflow">if</span> ((NameInfo-&gt;<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html#o1">Name</a>.Length == (2 * <span class="keyword">sizeof</span>( WCHAR ))) &amp;&amp;
01091         (NameInfo-&gt;<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html#o1">Name</a>.Buffer[ 1 ] == <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">':'</span>)) {
01092 
01093         DosDeviceDriveLetter = <a class="code" href="../../d6/d6/nls_8c.html#a33">RtlUpcaseUnicodeChar</a>( NameInfo-&gt;<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html#o1">Name</a>.Buffer[ 0 ] );
01094 
01095         <span class="keywordflow">if</span> ((DosDeviceDriveLetter &gt;= <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'A'</span>) &amp;&amp; (DosDeviceDriveLetter &lt;= <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'Z'</span>)) {
01096 
01097             DosDeviceDriveIndex = DosDeviceDriveLetter - <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'A'</span>;
01098             DosDeviceDriveIndex += 1;
01099 
01100             SymbolicLink-&gt;<a class="code" href="../../d2/d6/struct__OBJECT__SYMBOLIC__LINK.html#o4">DosDeviceDriveIndex</a> = DosDeviceDriveIndex;
01101         }
01102     }
01103 
01104     <span class="comment">//</span>
01105     <span class="comment">//  Now traverse the target path seeing if we can snap the link now.</span>
01106     <span class="comment">//</span>
01107 
01108     <a class="code" href="../../d4/d1/oblink_8c.html#a4">ObpProcessDosDeviceSymbolicLink</a>( SymbolicLink, CREATE_SYMBOLIC_LINK );
01109 
01110     <span class="keywordflow">return</span>;
01111 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a81" doxytag="obp.h::ObpCreateUnnamedHandle" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS ObpCreateUnnamedHandle           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Object</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>DesiredAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG ObjectPointerBias&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Attributes</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessMode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID *ReferencedNewObject&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PHANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>Handle</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/obhandle_8c-source.html#l02507">2507</a> of file <a class="el" href="../../d0/d0/obhandle_8c-source.html">obhandle.c</a>.
<p>
References <a class="el" href="../../d6/d7/ex_8h-source.html#l02695">_HANDLE_TABLE_ENTRY::CreatorBackTraceIndex</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00416">EncodeKernelHandle</a>, <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l01144">ExCreateHandle()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02690">_HANDLE_TABLE_ENTRY::GrantedAccess</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02694">_HANDLE_TABLE_ENTRY::GrantedAccessIndex</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00091">Handle</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00324">KeStackAttachProcess()</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00512">KeUnstackDetachProcess()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00370">NtGlobalFlag</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02674">_HANDLE_TABLE_ENTRY::ObAttributes</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00289">OBJ_HANDLE_ATTRIBUTES</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02672">_HANDLE_TABLE_ENTRY::Object</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00355">OBJECT_TO_OBJECT_HEADER</a>, <a class="el" href="../../d0/d0/obhandle_8c-source.html#l01967">ObpDecrementHandleCount()</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00144">ObpDecrPointerCount</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00213">ObpGetObjectTable</a>, <a class="el" href="../../d0/d0/obhandle_8c-source.html#l01587">ObpIncrementUnnamedHandleCount()</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00143">ObpIncrPointerCount</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00399">ObpKernelHandleTable</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00071">ObpValidateIrql</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00166">_EPROCESS::Pcb</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00579">PsInitialSystemProcess</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00302">_OBJECT_HEADER::Type</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00196">_OBJECT_TYPE::TypeInfo</a>, and <a class="el" href="../../d5/d9/ob_8h-source.html#l00169">_OBJECT_TYPE_INITIALIZER::ValidAccessMask</a>.
<p>
Referenced by <a class="el" href="../../d2/d0/obinsert_8c-source.html#l00029">ObInsertObject()</a>.
<p>
<pre class="fragment"><div>02519                    :
02520 
02521     This function creates a <span class="keyword">new</span> unnamed handle <span class="keywordflow">for</span> an existing object
02522 
02523 Arguments:
02524 
02525     Object - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> body of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> object
02526 
02527     DesiredAccess - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> access mask being requsted
02528 
02529     ObjectPointerBias - Optionally supplies a count of addition
02530         increments we <span class="keywordflow">do</span> to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pointer count <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object
02531 
02532     Attributes -  Desired attributes <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle
02533 
02534     AccessMode - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> mode of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> requestor.
02535 
02536     ReferencedNewObject - Optionally receives a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> body
02537         of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> object
02538 
02539     <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> - Receives <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> handle value
02540 
02541 Return Value:
02542 
02543     An appropriate status value
02544 
02545 --*/
02546 
02547 {
02548     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02549     <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> ObjectHeader;
02550     <a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> ObjectType;
02551     PVOID ObjectTable;
02552     <a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html">HANDLE_TABLE_ENTRY</a> ObjectTableEntry;
02553     HANDLE NewHandle;
02554     ULONG BiasCount;
02555     ACCESS_MASK GrantedAccess;
02556     BOOLEAN AttachedToProcess = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02557     BOOLEAN KernelHandle = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02558     <a class="code" href="../../d3/d5/struct__KAPC__STATE.html">KAPC_STATE</a> ApcState;
02559 
02560     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02561 
02562     <a class="code" href="../../d5/d1/obp_8h.html#a2">ObpValidateIrql</a>( <span class="stringliteral">"ObpCreateUnnamedHandle"</span> );
02563 
02564     <span class="comment">//</span>
02565     <span class="comment">//  Get the object header and type for the new object</span>
02566     <span class="comment">//</span>
02567 
02568     ObjectHeader = <a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>( Object );
02569     ObjectType = ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o3">Type</a>;
02570 
02571     <span class="comment">//</span>
02572     <span class="comment">//  Set the first ulong of the object table entry to point</span>
02573     <span class="comment">//  to the object header and then or in the low order attribute</span>
02574     <span class="comment">//  bits</span>
02575     <span class="comment">//</span>
02576 
02577     ObjectTableEntry.<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o0">Object</a> = ObjectHeader;
02578 
02579     ObjectTableEntry.<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o1">ObAttributes</a> |= (Attributes &amp; <a class="code" href="../../d5/d1/obp_8h.html#a17">OBJ_HANDLE_ATTRIBUTES</a>);
02580 
02581     <span class="comment">//</span>
02582     <span class="comment">//  Now get a pointer to the object table for either the current process</span>
02583     <span class="comment">//  of the kernel handle table</span>
02584     <span class="comment">//</span>
02585 
02586     <span class="keywordflow">if</span> ((Attributes &amp; OBJ_KERNEL_HANDLE) &amp;&amp; (AccessMode == <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>)) {
02587 
02588         ObjectTable = <a class="code" href="../../d5/d1/obp_8h.html#a54">ObpKernelHandleTable</a>;
02589         KernelHandle = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02590 
02591         <span class="comment">//</span>
02592         <span class="comment">//  Go to the system process if we have to</span>
02593         <span class="comment">//</span>
02594 
02595         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>() != <a class="code" href="../../d1/d9/ps_8h.html#a53">PsInitialSystemProcess</a>) {
02596             <a class="code" href="../../d3/d5/procobj_8c.html#a6">KeStackAttachProcess</a> (&amp;<a class="code" href="../../d1/d9/ps_8h.html#a53">PsInitialSystemProcess</a>-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>, &amp;ApcState);
02597             AttachedToProcess = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02598         }
02599 
02600     } <span class="keywordflow">else</span> {
02601 
02602         ObjectTable = <a class="code" href="../../d5/d1/obp_8h.html#a12">ObpGetObjectTable</a>();
02603     }
02604 
02605     <span class="comment">//</span>
02606     <span class="comment">//  Increment the handle count, this routine also does the access</span>
02607     <span class="comment">//  check if necessary</span>
02608     <span class="comment">//</span>
02609 
02610     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d1/obp_8h.html#a80">ObpIncrementUnnamedHandleCount</a>( &amp;DesiredAccess,
02611                                              <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>(),
02612                                              Object,
02613                                              ObjectType,
02614                                              AccessMode,
02615                                              Attributes );
02616 
02617 
02618     GrantedAccess = DesiredAccess &amp;
02619                     (ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o5">ValidAccessMask</a> | ACCESS_SYSTEM_SECURITY );
02620 
02621     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
02622 
02623         <span class="comment">//</span>
02624         <span class="comment">//  If we are attached to the system process then return</span>
02625         <span class="comment">//  back to our caller</span>
02626         <span class="comment">//</span>
02627 
02628         <span class="keywordflow">if</span> (AttachedToProcess) {
02629             <a class="code" href="../../d3/d5/procobj_8c.html#a8">KeUnstackDetachProcess</a>(&amp;ApcState);
02630             AttachedToProcess = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02631         }
02632 
02633         <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
02634     }
02635 
02636     <span class="comment">//</span>
02637     <span class="comment">//  Bias the pointer count if that is what the caller wanted</span>
02638     <span class="comment">//</span>
02639 
02640     <span class="keywordflow">if</span> (ARGUMENT_PRESENT( (PVOID)(ULONG_PTR)ObjectPointerBias )) {
02641 
02642         BiasCount = ObjectPointerBias;
02643 
02644         <span class="keywordflow">while</span> (BiasCount--) {
02645 
02646             <a class="code" href="../../d5/d1/obp_8h.html#a3">ObpIncrPointerCount</a>( ObjectHeader );
02647         }
02648     }
02649 
02650     <span class="comment">//</span>
02651     <span class="comment">//  Set the granted access mask in the object table entry (second ulong)</span>
02652     <span class="comment">//</span>
02653 
02654 <span class="preprocessor">#if i386 &amp;&amp; !FPO</span>
02655 <span class="preprocessor"></span>
02656     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a33">NtGlobalFlag</a> &amp; FLG_KERNEL_STACK_TRACE_DB) {
02657 
02658         ObjectTableEntry.<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o3">GrantedAccessIndex</a> = ObpComputeGrantedAccessIndex( GrantedAccess );
02659         ObjectTableEntry.<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o4">CreatorBackTraceIndex</a> = RtlLogStackBackTrace();
02660 
02661     } <span class="keywordflow">else</span> {
02662 
02663         ObjectTableEntry.<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o2">GrantedAccess</a> = GrantedAccess;
02664     }
02665 
02666 <span class="preprocessor">#else</span>
02667 <span class="preprocessor"></span>
02668     ObjectTableEntry.<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o2">GrantedAccess</a> = GrantedAccess;
02669 
02670 <span class="preprocessor">#endif // i386 &amp;&amp; !FPO</span>
02671 <span class="preprocessor"></span>
02672     <span class="comment">//</span>
02673     <span class="comment">//  Add this new object table entry to the object table for the process</span>
02674     <span class="comment">//</span>
02675 
02676     NewHandle = <a class="code" href="../../d5/d8/ex_8h.html#a296">ExCreateHandle</a>( ObjectTable, &amp;ObjectTableEntry );
02677 
02678     <span class="comment">//</span>
02679     <span class="comment">//  If we didn't get a handle then cleanup after ourselves and return</span>
02680     <span class="comment">//  the error to our caller</span>
02681     <span class="comment">//</span>
02682 
02683     <span class="keywordflow">if</span> (NewHandle == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02684 
02685         <span class="keywordflow">if</span> (ARGUMENT_PRESENT( (PVOID)(ULONG_PTR)ObjectPointerBias )) {
02686 
02687             BiasCount = ObjectPointerBias;
02688 
02689             <span class="keywordflow">while</span> (BiasCount--) {
02690 
02691                 <a class="code" href="../../d5/d1/obp_8h.html#a4">ObpDecrPointerCount</a>( ObjectHeader );
02692             }
02693         }
02694 
02695         <a class="code" href="../../d5/d1/obp_8h.html#a78">ObpDecrementHandleCount</a>( <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>(),
02696                                  ObjectHeader,
02697                                  ObjectType,
02698                                  GrantedAccess );
02699 
02700         <span class="comment">//</span>
02701         <span class="comment">//  If we are attached to the system process then return</span>
02702         <span class="comment">//  back to our caller</span>
02703         <span class="comment">//</span>
02704 
02705         <span class="keywordflow">if</span> (AttachedToProcess) {
02706             <a class="code" href="../../d3/d5/procobj_8c.html#a8">KeUnstackDetachProcess</a>(&amp;ApcState);
02707             AttachedToProcess = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02708         }
02709 
02710         <span class="keywordflow">return</span>( STATUS_INSUFFICIENT_RESOURCES );
02711     }
02712 
02713     <span class="comment">//</span>
02714     <span class="comment">//  We have a new Ex style handle now make it an ob style handle and also</span>
02715     <span class="comment">//  adjust for the kernel handle by setting the sign bit in the handle</span>
02716     <span class="comment">//  value</span>
02717     <span class="comment">//</span>
02718 
02719     <span class="keywordflow">if</span> (KernelHandle) {
02720 
02721         NewHandle = <a class="code" href="../../d5/d1/obp_8h.html#a26">EncodeKernelHandle</a>( NewHandle );
02722     }
02723 
02724     *<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> = NewHandle;
02725 
02726     <span class="comment">//</span>
02727     <span class="comment">//  If the caller had a pointer bias and wanted the new reference object</span>
02728     <span class="comment">//  then return that value</span>
02729     <span class="comment">//</span>
02730 
02731     <span class="keywordflow">if</span> ((ARGUMENT_PRESENT( (PVOID)(ULONG_PTR)ObjectPointerBias )) &amp;&amp;
02732         (ARGUMENT_PRESENT( ReferencedNewObject ))) {
02733 
02734         *ReferencedNewObject = Object;
02735     }
02736 
02737     <span class="comment">//</span>
02738     <span class="comment">//  If we are attached to the system process then return</span>
02739     <span class="comment">//  back to our caller</span>
02740     <span class="comment">//</span>
02741 
02742     <span class="keywordflow">if</span> (AttachedToProcess) {
02743         <a class="code" href="../../d3/d5/procobj_8c.html#a8">KeUnstackDetachProcess</a>(&amp;ApcState);
02744         AttachedToProcess = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02745     }
02746 
02747     <span class="keywordflow">return</span>( STATUS_SUCCESS );
02748 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a78" doxytag="obp.h::ObpDecrementHandleCount" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID ObpDecrementHandleCount           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Process</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectHeader</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>GrantedAccess</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/obhandle_8c-source.html#l01967">1967</a> of file <a class="el" href="../../d0/d0/obhandle_8c-source.html">obhandle.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00313">_OBJECT_HEADER::Body</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00178">_OBJECT_TYPE_INITIALIZER::CloseProcedure</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00261">_OBJECT_HANDLE_COUNT_DATABASE::CountEntries</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00306">_OBJECT_HEADER::Flags</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00257">_OBJECT_HANDLE_COUNT_ENTRY::HandleCount</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00299">_OBJECT_HEADER::HandleCount</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00325">_OBJECT_HEADER_HANDLE_INFO::HandleCountDataBase</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00262">_OBJECT_HANDLE_COUNT_DATABASE::HandleCountEntries</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00171">_OBJECT_TYPE_INITIALIZER::MaintainHandleCount</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00350">OB_FLAG_EXCLUSIVE_OBJECT</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00353">OB_FLAG_SINGLE_HANDLE_ENTRY</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00371">OBJECT_HEADER_TO_CREATOR_INFO</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00365">OBJECT_HEADER_TO_HANDLE_INFO</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00362">OBJECT_HEADER_TO_QUOTA_INFO</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00056">ObpBeginTypeSpecificCallOut</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00148">ObpDecrHandleCount</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l01497">ObpDeleteNameCheck()</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00057">ObpEndTypeSpecificCallOut</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00163">ObpEnterObjectTypeMutex</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00176">ObpLeaveObjectTypeMutex</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00256">_OBJECT_HANDLE_COUNT_ENTRY::Process</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00326">_OBJECT_HEADER_HANDLE_INFO::SingleEntry</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00193">_OBJECT_TYPE::TotalNumberOfHandles</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00196">_OBJECT_TYPE::TypeInfo</a>, and <a class="el" href="../../d5/d9/ob_8h-source.html#l00341">_OBJECT_HEADER_CREATOR_INFO::TypeList</a>.
<p>
Referenced by <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d0/d0/obhandle_8c-source.html#l00163">NtDuplicateObject()</a>, <a class="el" href="../../d0/d0/obhandle_8c-source.html#l02160">ObpCreateHandle()</a>, and <a class="el" href="../../d0/d0/obhandle_8c-source.html#l02507">ObpCreateUnnamedHandle()</a>.
<p>
<pre class="fragment"><div>01976                    :
01977 
01978     This <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a> decrements <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle count <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified object
01979 
01980 Arguments:
01981 
01982     Process - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process where <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle existed
01983 
01984     ObjectHeader - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object header <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object
01985 
01986     ObjectType - Supplies a <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object
01987 
01988     GrantedAccess - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current access mask to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object
01989 
01990 Return Value:
01991 
01992     None.
01993 
01994 --*/
01995 
01996 {
01997     <a class="code" href="../../d8/d5/struct__OBJECT__HEADER__HANDLE__INFO.html">POBJECT_HEADER_HANDLE_INFO</a> HandleInfo;
01998     <a class="code" href="../../d1/d5/struct__OBJECT__HANDLE__COUNT__DATABASE.html">POBJECT_HANDLE_COUNT_DATABASE</a> HandleCountDataBase;
01999     <a class="code" href="../../d2/d5/struct__OBJECT__HANDLE__COUNT__ENTRY.html">POBJECT_HANDLE_COUNT_ENTRY</a> HandleCountEntry;
02000     <a class="code" href="../../d7/d5/struct__OBJECT__HEADER__CREATOR__INFO.html">POBJECT_HEADER_CREATOR_INFO</a> CreatorInfo;
02001     PVOID Object;
02002     ULONG CountEntries;
02003     ULONG ProcessHandleCount;
02004     ULONG SystemHandleCount;
02005     BOOLEAN HandleCountIsZero;
02006 
02007     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02008 
02009     <a class="code" href="../../d5/d1/obp_8h.html#a8">ObpEnterObjectTypeMutex</a>( ObjectType );
02010 
02011     Object = (PVOID)&amp;ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o11">Body</a>;
02012 
02013     SystemHandleCount = ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o1">HandleCount</a>;
02014     ProcessHandleCount = 0;
02015 
02016     <span class="comment">//</span>
02017     <span class="comment">//  Decrement the handle count and it was one and it</span>
02018     <span class="comment">//  was an exclusive object then zero out the exclusive</span>
02019     <span class="comment">//  process</span>
02020     <span class="comment">//</span>
02021 
02022     HandleCountIsZero = <a class="code" href="../../d5/d1/obp_8h.html#a7">ObpDecrHandleCount</a>( ObjectHeader );
02023             
02024     <span class="keywordflow">if</span> ( HandleCountIsZero &amp;&amp;
02025         (ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o7">Flags</a> &amp; <a class="code" href="../../d4/d0/ob_8h.html#a4">OB_FLAG_EXCLUSIVE_OBJECT</a>)) {
02026 
02027         <a class="code" href="../../d4/d0/ob_8h.html#a10">OBJECT_HEADER_TO_QUOTA_INFO</a>( ObjectHeader )-&gt;ExclusiveProcess = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02028     }
02029     
02030     <span class="keywordflow">if</span> ( HandleCountIsZero ) {
02031     
02032         CreatorInfo = <a class="code" href="../../d4/d0/ob_8h.html#a13">OBJECT_HEADER_TO_CREATOR_INFO</a>( ObjectHeader );
02033     
02034         <span class="comment">//</span>
02035         <span class="comment">//  If there is a creator info record and we are on the list</span>
02036         <span class="comment">//  for the object type then remove this object from the list</span>
02037         <span class="comment">//</span>
02038 
02039         <span class="keywordflow">if</span> (CreatorInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; !IsListEmpty( &amp;CreatorInfo-&gt;<a class="code" href="../../d7/d5/struct__OBJECT__HEADER__CREATOR__INFO.html#o0">TypeList</a> )) {
02040                         
02041             RemoveEntryList( &amp;CreatorInfo-&gt;<a class="code" href="../../d7/d5/struct__OBJECT__HEADER__CREATOR__INFO.html#o0">TypeList</a> );
02042             
02043             InitializeListHead( &amp;CreatorInfo-&gt;<a class="code" href="../../d7/d5/struct__OBJECT__HEADER__CREATOR__INFO.html#o0">TypeList</a> );
02044         }
02045     }
02046 
02047     <span class="comment">//</span>
02048     <span class="comment">//  If the object maintains a handle count database then</span>
02049     <span class="comment">//  search through the handle database and decrement</span>
02050     <span class="comment">//  the necessary information</span>
02051     <span class="comment">//</span>
02052 
02053     <span class="keywordflow">if</span> (ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o7">MaintainHandleCount</a>) {
02054 
02055         HandleInfo = <a class="code" href="../../d4/d0/ob_8h.html#a11">OBJECT_HEADER_TO_HANDLE_INFO</a>( ObjectHeader );
02056 
02057         <span class="comment">//</span>
02058         <span class="comment">//  Check if there is a single handle entry, then it better</span>
02059         <span class="comment">//  be ours</span>
02060         <span class="comment">//</span>
02061 
02062         <span class="keywordflow">if</span> (ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o7">Flags</a> &amp; <a class="code" href="../../d4/d0/ob_8h.html#a7">OB_FLAG_SINGLE_HANDLE_ENTRY</a>) {
02063 
02064             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(HandleInfo-&gt;<a class="code" href="../../d8/d5/struct__OBJECT__HEADER__HANDLE__INFO.html#o1">SingleEntry</a>.<a class="code" href="../../d2/d5/struct__OBJECT__HANDLE__COUNT__ENTRY.html#o0">Process</a> == Process);
02065             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(HandleInfo-&gt;<a class="code" href="../../d8/d5/struct__OBJECT__HEADER__HANDLE__INFO.html#o1">SingleEntry</a>.<a class="code" href="../../d2/d5/struct__OBJECT__HANDLE__COUNT__ENTRY.html#o1">HandleCount</a> &gt; 0);
02066 
02067             ProcessHandleCount = HandleInfo-&gt;<a class="code" href="../../d8/d5/struct__OBJECT__HEADER__HANDLE__INFO.html#o1">SingleEntry</a>.<a class="code" href="../../d2/d5/struct__OBJECT__HANDLE__COUNT__ENTRY.html#o1">HandleCount</a>--;
02068             HandleCountEntry = &amp;HandleInfo-&gt;<a class="code" href="../../d8/d5/struct__OBJECT__HEADER__HANDLE__INFO.html#o1">SingleEntry</a>;
02069 
02070         } <span class="keywordflow">else</span> {
02071 
02072             <span class="comment">//</span>
02073             <span class="comment">//  Otherwise search the database for a process match</span>
02074             <span class="comment">//</span>
02075 
02076             HandleCountDataBase = HandleInfo-&gt;<a class="code" href="../../d8/d5/struct__OBJECT__HEADER__HANDLE__INFO.html#o0">HandleCountDataBase</a>;
02077 
02078             <span class="keywordflow">if</span> (HandleCountDataBase != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02079 
02080                 CountEntries = HandleCountDataBase-&gt;<a class="code" href="../../d1/d5/struct__OBJECT__HANDLE__COUNT__DATABASE.html#o0">CountEntries</a>;
02081                 HandleCountEntry = &amp;HandleCountDataBase-&gt;<a class="code" href="../../d1/d5/struct__OBJECT__HANDLE__COUNT__DATABASE.html#o1">HandleCountEntries</a>[ 0 ];
02082 
02083                 <span class="keywordflow">while</span> (CountEntries) {
02084 
02085                     <span class="keywordflow">if</span> ((HandleCountEntry-&gt;<a class="code" href="../../d2/d5/struct__OBJECT__HANDLE__COUNT__ENTRY.html#o1">HandleCount</a> != 0) &amp;&amp;
02086                         (HandleCountEntry-&gt;<a class="code" href="../../d2/d5/struct__OBJECT__HANDLE__COUNT__ENTRY.html#o0">Process</a> == Process)) {
02087 
02088                         ProcessHandleCount = HandleCountEntry-&gt;<a class="code" href="../../d2/d5/struct__OBJECT__HANDLE__COUNT__ENTRY.html#o1">HandleCount</a>--;
02089 
02090                         <span class="keywordflow">break</span>;
02091                     }
02092 
02093                     HandleCountEntry++;
02094                     CountEntries--;
02095                 }
02096             }
02097         }
02098 
02099         <span class="comment">//</span>
02100         <span class="comment">//  Now if the process is giving up all handles to the object</span>
02101         <span class="comment">//  then zero out the handle count entry.  For a single handle</span>
02102         <span class="comment">//  entry this is just the single entry in the header handle info</span>
02103         <span class="comment">//  structure</span>
02104         <span class="comment">//</span>
02105 
02106         <span class="keywordflow">if</span> (ProcessHandleCount == 1) {
02107 
02108             HandleCountEntry-&gt;<a class="code" href="../../d2/d5/struct__OBJECT__HANDLE__COUNT__ENTRY.html#o0">Process</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02109             HandleCountEntry-&gt;<a class="code" href="../../d2/d5/struct__OBJECT__HANDLE__COUNT__ENTRY.html#o1">HandleCount</a> = 0;
02110         }
02111     }
02112 
02113     <span class="comment">//</span>
02114     <span class="comment">//  If the Object Type has a Close Procedure, then release the type</span>
02115     <span class="comment">//  mutex before calling it, and then call ObpDeleteNameCheck without</span>
02116     <span class="comment">//  the mutex held.</span>
02117     <span class="comment">//</span>
02118 
02119     <span class="keywordflow">if</span> (ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o14">CloseProcedure</a>) {
02120 
02121         KIRQL SaveIrql;
02122 
02123         <a class="code" href="../../d5/d1/obp_8h.html#a9">ObpLeaveObjectTypeMutex</a>( ObjectType );
02124 
02125         <a class="code" href="../../d5/d1/obp_8h.html#a0">ObpBeginTypeSpecificCallOut</a>( SaveIrql );
02126 
02127         (*ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o14">CloseProcedure</a>)( Process,
02128                                                 Object,
02129                                                 GrantedAccess,
02130                                                 ProcessHandleCount,
02131                                                 SystemHandleCount );
02132 
02133         <a class="code" href="../../d5/d1/obp_8h.html#a1">ObpEndTypeSpecificCallOut</a>( SaveIrql, <span class="stringliteral">"Close"</span>, ObjectType, Object );
02134 
02135         <a class="code" href="../../d7/d1/obref_8c.html#a11">ObpDeleteNameCheck</a>( Object, FALSE );
02136 
02137     } <span class="keywordflow">else</span> {
02138 
02139         <span class="comment">//</span>
02140         <span class="comment">//  If there is no Close Procedure, then just call ObpDeleteNameCheck</span>
02141         <span class="comment">//  with the mutex held.</span>
02142         <span class="comment">//</span>
02143         <span class="comment">//  The following call will release the type mutex</span>
02144         <span class="comment">//</span>
02145 
02146         <a class="code" href="../../d7/d1/obref_8c.html#a11">ObpDeleteNameCheck</a>( Object, TRUE );
02147     }
02148 
02149     <a class="code" href="../../d5/d1/obp_8h.html#a8">ObpEnterObjectTypeMutex</a>( ObjectType );
02150     
02151     ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o6">TotalNumberOfHandles</a> -= 1;
02152         
02153     <a class="code" href="../../d5/d1/obp_8h.html#a9">ObpLeaveObjectTypeMutex</a>( ObjectType );
02154 
02155     <span class="keywordflow">return</span>;
02156 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a70" doxytag="obp.h::ObpDeleteDirectoryEntry" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN ObpDeleteDirectoryEntry           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__OBJECT__DIRECTORY.html">POBJECT_DIRECTORY</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Directory</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d9/obdir_8c-source.html#l01009">1009</a> of file <a class="el" href="../../d9/d9/obdir_8c-source.html">obdir.c</a>.
<p>
References <a class="el" href="../../d5/d9/ob_8h-source.html#l00220">_OBJECT_DIRECTORY_ENTRY::ChainLink</a>, <a class="el" href="../../d3/d4/editreg_8c-source.html#l00903">Directory()</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d2/d0/obinsert_8c-source.html#l00029">ObInsertObject()</a>, and <a class="el" href="../../d8/d0/obref_8c-source.html#l01497">ObpDeleteNameCheck()</a>.
<p>
<pre class="fragment"><div>01015                    :
01016 
01017     This routine deletes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> most recently found directory entry from
01018     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified directory object.  It will <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> succeed after a
01019     successful <a class="code" href="../../d8/d0/obdir_8c.html#a3">ObpLookupDirectoryEntry</a> call.
01020 
01021 Arguments:
01022 
01023     <a class="code" href="../../d2/d5/editreg_8c.html#a68">Directory</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> directory being modified
01024 
01025 Return Value:
01026 
01027     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> deletion succeeded and <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise
01028 
01029 --*/
01030 
01031 {
01032     <a class="code" href="../../d9/d4/struct__OBJECT__DIRECTORY__ENTRY.html">POBJECT_DIRECTORY_ENTRY</a> *HeadDirectoryEntry;
01033     <a class="code" href="../../d9/d4/struct__OBJECT__DIRECTORY__ENTRY.html">POBJECT_DIRECTORY_ENTRY</a> DirectoryEntry;
01034 
01035     <span class="comment">//</span>
01036     <span class="comment">//  Make sure we have a directory and that it has a found entry</span>
01037     <span class="comment">//</span>
01038 
01039     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d5/editreg_8c.html#a68">Directory</a> || !<a class="code" href="../../d2/d5/editreg_8c.html#a68">Directory</a>-&gt;LookupFound) {
01040 
01041         <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
01042     }
01043 
01044     <span class="comment">//</span>
01045     <span class="comment">//  Also make sure that the lookup bucket is valid</span>
01046     <span class="comment">//</span>
01047 
01048     HeadDirectoryEntry = <a class="code" href="../../d2/d5/editreg_8c.html#a68">Directory</a>-&gt;LookupBucket;
01049 
01050     <span class="keywordflow">if</span> (!HeadDirectoryEntry) {
01051 
01052         <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
01053     }
01054 
01055     DirectoryEntry = *HeadDirectoryEntry;
01056 
01057     <span class="keywordflow">if</span> (!DirectoryEntry) {
01058 
01059         <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
01060     }
01061 
01062     <span class="comment">//</span>
01063     <span class="comment">//  Unlink the entry from the head of the bucket chain and free the</span>
01064     <span class="comment">//  memory for the entry.</span>
01065     <span class="comment">//</span>
01066 
01067     *HeadDirectoryEntry = DirectoryEntry-&gt;<a class="code" href="../../d9/d4/struct__OBJECT__DIRECTORY__ENTRY.html#o0">ChainLink</a>;
01068     DirectoryEntry-&gt;<a class="code" href="../../d9/d4/struct__OBJECT__DIRECTORY__ENTRY.html#o0">ChainLink</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01069 
01070     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( DirectoryEntry );
01071 
01072     <span class="comment">//</span>
01073     <span class="comment">//  Return success</span>
01074     <span class="comment">//</span>
01075 
01076     <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
01077 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a73" doxytag="obp.h::ObpDeleteNameCheck" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID ObpDeleteNameCheck           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Object</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>TypeMutexHeld</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d0/obref_8c-source.html#l01497">1497</a> of file <a class="el" href="../../d8/d0/obref_8c-source.html">obref.c</a>.
<p>
References <a class="el" href="../../d0/d5/se_8h.html#a200a110">DeleteSecurityDescriptor</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00331">_OBJECT_HEADER_NAME_INFO::Directory</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00306">_OBJECT_HEADER::Flags</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00299">_OBJECT_HEADER::HandleCount</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00332">_OBJECT_HEADER_NAME_INFO::Name</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00351">OB_FLAG_PERMANENT_OBJECT</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00368">OBJECT_HEADER_TO_NAME_INFO</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00355">OBJECT_TO_OBJECT_HEADER</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00056">ObpBeginTypeSpecificCallOut</a>, <a class="el" href="../../d9/d9/obdir_8c-source.html#l01009">ObpDeleteDirectoryEntry()</a>, <a class="el" href="../../d5/d0/oblink_8c-source.html#l00951">ObpDeleteSymbolicLinkName()</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00057">ObpEndTypeSpecificCallOut</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00163">ObpEnterObjectTypeMutex</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00189">ObpEnterRootDirectoryMutex</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00176">ObpLeaveObjectTypeMutex</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00202">ObpLeaveRootDirectoryMutex</a>, <a class="el" href="../../d9/d9/obdir_8c-source.html#l00705">ObpLookupDirectoryEntry()</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00368">ObpSymbolicLinkObjectType</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00071">ObpValidateIrql</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00173">_OBJECT_TYPE_INITIALIZER::PoolType</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00312">_OBJECT_HEADER::SecurityDescriptor</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00181">_OBJECT_TYPE_INITIALIZER::SecurityProcedure</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00170">_OBJECT_TYPE_INITIALIZER::SecurityRequired</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00302">_OBJECT_HEADER::Type</a>, and <a class="el" href="../../d5/d9/ob_8h-source.html#l00196">_OBJECT_TYPE::TypeInfo</a>.
<p>
Referenced by <a class="el" href="../../d2/d0/obinsert_8c-source.html#l00029">ObInsertObject()</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00484">ObMakeTemporaryObject()</a>, and <a class="el" href="../../d0/d0/obhandle_8c-source.html#l01967">ObpDecrementHandleCount()</a>.
<p>
<pre class="fragment"><div>01504                    :
01505 
01506     This routine removes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of an object from its parent directory
01507 
01508 Arguments:
01509 
01510     Object - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object body whose name <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being checked
01511 
01512     TypeMutexHeld - Indicates <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> lock on object <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being held by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01513         caller
01514 
01515 Return Value:
01516 
01517     None.
01518 
01519 --*/
01520 
01521 {
01522     <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> ObjectHeader;
01523     <a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> ObjectType;
01524     <a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html">POBJECT_HEADER_NAME_INFO</a> NameInfo;
01525     PVOID DirObject;
01526 
01527     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01528 
01529     <a class="code" href="../../d5/d1/obp_8h.html#a2">ObpValidateIrql</a>( <span class="stringliteral">"ObpDeleteNameCheck"</span> );
01530 
01531     <span class="comment">//</span>
01532     <span class="comment">//  Translate the object body to an object header also get</span>
01533     <span class="comment">//  the object type and name info if present</span>
01534     <span class="comment">//</span>
01535 
01536     ObjectHeader = <a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>( Object );
01537     NameInfo = <a class="code" href="../../d4/d0/ob_8h.html#a12">OBJECT_HEADER_TO_NAME_INFO</a>( ObjectHeader );
01538     ObjectType = ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o3">Type</a>;
01539 
01540     <span class="comment">//</span>
01541     <span class="comment">//  If the lock is not held then get the lock now</span>
01542     <span class="comment">//</span>
01543 
01544     <span class="keywordflow">if</span> (!TypeMutexHeld) {
01545 
01546         <a class="code" href="../../d5/d1/obp_8h.html#a8">ObpEnterObjectTypeMutex</a>( ObjectType );
01547     }
01548 
01549     <span class="comment">//</span>
01550     <span class="comment">//  Make sure that the object has a zero handle count, has a non</span>
01551     <span class="comment">//  empty name buffer, and is not a permanent object</span>
01552     <span class="comment">//</span>
01553 
01554     <span class="keywordflow">if</span> ((ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o1">HandleCount</a> == 0) &amp;&amp;
01555         (NameInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
01556         (NameInfo-&gt;<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html#o1">Name</a>.Length != 0) &amp;&amp;
01557         (!(ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o7">Flags</a> &amp; <a class="code" href="../../d4/d0/ob_8h.html#a5">OB_FLAG_PERMANENT_OBJECT</a>))) {
01558 
01559         <span class="comment">//</span>
01560         <span class="comment">//  Give up the lock on the object type and instead</span>
01561         <span class="comment">//  get the lock on the object directories</span>
01562         <span class="comment">//</span>
01563 
01564         <a class="code" href="../../d5/d1/obp_8h.html#a9">ObpLeaveObjectTypeMutex</a>( ObjectType );
01565         <a class="code" href="../../d5/d1/obp_8h.html#a10">ObpEnterRootDirectoryMutex</a>();
01566         DirObject = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01567 
01568         <span class="comment">//</span>
01569         <span class="comment">//  Check that the object we is still in the directory otherwise</span>
01570         <span class="comment">//  then is nothing for us to remove</span>
01571         <span class="comment">//</span>
01572 
01573         <span class="keywordflow">if</span> (Object == <a class="code" href="../../d5/d1/obp_8h.html#a68">ObpLookupDirectoryEntry</a>( NameInfo-&gt;<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html#o0">Directory</a>,
01574                                                &amp;NameInfo-&gt;<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html#o1">Name</a>,
01575                                                0 )) {
01576 
01577             <span class="comment">//</span>
01578             <span class="comment">//  Now reacquire the lock on the object type and</span>
01579             <span class="comment">//  check check the handle count again.  If it is still</span>
01580             <span class="comment">//  zero then we can do the actual delete name operation</span>
01581             <span class="comment">//</span>
01582 
01583             <a class="code" href="../../d5/d1/obp_8h.html#a8">ObpEnterObjectTypeMutex</a>( ObjectType );
01584 
01585             <span class="keywordflow">if</span> (ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o1">HandleCount</a> == 0) {
01586 
01587                 KIRQL SaveIrql;
01588 
01589                 <span class="comment">//</span>
01590                 <span class="comment">//  Delete the directory entry </span>
01591                 <span class="comment">//</span>
01592                 
01593                 <a class="code" href="../../d5/d1/obp_8h.html#a70">ObpDeleteDirectoryEntry</a>( NameInfo-&gt;<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html#o0">Directory</a> );
01594                 
01595                 <span class="comment">//</span>
01596                 <span class="comment">//  If security is not required invoke the </span>
01597                 <span class="comment">//  security callback to delete the security descriptor</span>
01598                 <span class="comment">//</span>
01599                 
01600                 <span class="keywordflow">if</span> ( !ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o6">SecurityRequired</a> ) {
01601                     
01602                     <a class="code" href="../../d5/d1/obp_8h.html#a0">ObpBeginTypeSpecificCallOut</a>( SaveIrql );
01603 
01604                     (ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o17">SecurityProcedure</a>)( Object,
01605                                                               <a class="code" href="../../d0/d5/se_8h.html#a200a110">DeleteSecurityDescriptor</a>,
01606                                                               <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01607                                                               <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01608                                                               <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01609                                                               &amp;ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o10">SecurityDescriptor</a>,
01610                                                               ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o9">PoolType</a>,
01611                                                               <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
01612 
01613                     <a class="code" href="../../d5/d1/obp_8h.html#a1">ObpEndTypeSpecificCallOut</a>( SaveIrql, <span class="stringliteral">"Security"</span>, ObjectType, Object );
01614                 }
01615                 
01616                 <span class="comment">//</span>
01617                 <span class="comment">//  If this is a symbolic link object then we also need to</span>
01618                 <span class="comment">//  delete the symbolic link</span>
01619                 <span class="comment">//</span>
01620 
01621                 <span class="keywordflow">if</span> (ObjectType == <a class="code" href="../../d5/d1/obp_8h.html#a43">ObpSymbolicLinkObjectType</a>) {
01622 
01623                     <a class="code" href="../../d5/d1/obp_8h.html#a67">ObpDeleteSymbolicLinkName</a>( (<a class="code" href="../../d2/d6/struct__OBJECT__SYMBOLIC__LINK.html">POBJECT_SYMBOLIC_LINK</a>)Object );
01624                 }
01625 
01626                 <span class="comment">//</span>
01627                 <span class="comment">//  Free the name buffer and zero out the name data fields</span>
01628                 <span class="comment">//</span>
01629 
01630                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( NameInfo-&gt;<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html#o1">Name</a>.Buffer );
01631 
01632                 NameInfo-&gt;<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html#o1">Name</a>.Buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01633                 NameInfo-&gt;<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html#o1">Name</a>.Length = 0;
01634                 NameInfo-&gt;<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html#o1">Name</a>.MaximumLength = 0;
01635 
01636                 DirObject = NameInfo-&gt;<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html#o0">Directory</a>;
01637                 NameInfo-&gt;<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html#o0">Directory</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01638             }
01639 
01640             <a class="code" href="../../d5/d1/obp_8h.html#a9">ObpLeaveObjectTypeMutex</a>( ObjectType );
01641         }
01642 
01643         <a class="code" href="../../d5/d1/obp_8h.html#a11">ObpLeaveRootDirectoryMutex</a>();
01644 
01645         <span class="comment">//</span>
01646         <span class="comment">//  If there is a directory object for the name then decrement</span>
01647         <span class="comment">//  its reference count for it and for the object</span>
01648         <span class="comment">//</span>
01649 
01650         <span class="keywordflow">if</span> (DirObject != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01651 
01652             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( DirObject );
01653             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Object );
01654         }
01655 
01656     } <span class="keywordflow">else</span> {
01657 
01658         <span class="comment">//</span>
01659         <span class="comment">//  Otherwise don't do any work but simply release the object type</span>
01660         <span class="comment">//  lock and return to our caller</span>
01661         <span class="comment">//</span>
01662 
01663         <a class="code" href="../../d5/d1/obp_8h.html#a9">ObpLeaveObjectTypeMutex</a>( ObjectType );
01664     }
01665 
01666     <span class="keywordflow">return</span>;
01667 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a65" doxytag="obp.h::ObpDeleteSymbolicLink" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID ObpDeleteSymbolicLink           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Object</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d0/oblink_8c-source.html#l00904">904</a> of file <a class="el" href="../../d5/d0/oblink_8c-source.html">oblink.c</a>.
<p>
References <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00231">_OBJECT_SYMBOLIC_LINK::LinkTarget</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d1/d0/obinit_8c-source.html#l00117">ObInitSystem()</a>.
<p>
<pre class="fragment"><div>00910                    :
00911 
00912     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called when a reference to a symbolic link goes to zero.
00913     Its job <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to clean up <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> memory used to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> symbolic link string
00914 
00915 Arguments:
00916 
00917     Object - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> symbolic link object being deleted
00918 
00919 Return Value:
00920 
00921     None.
00922 
00923 --*/
00924 
00925 {
00926     <a class="code" href="../../d2/d6/struct__OBJECT__SYMBOLIC__LINK.html">POBJECT_SYMBOLIC_LINK</a> SymbolicLink = (<a class="code" href="../../d2/d6/struct__OBJECT__SYMBOLIC__LINK.html">POBJECT_SYMBOLIC_LINK</a>)Object;
00927 
00928     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00929 
00930     <span class="comment">//</span>
00931     <span class="comment">//  The only cleaning up we need to do is to free the link target</span>
00932     <span class="comment">//  buffer</span>
00933     <span class="comment">//</span>
00934 
00935     <span class="keywordflow">if</span> (SymbolicLink-&gt;<a class="code" href="../../d2/d6/struct__OBJECT__SYMBOLIC__LINK.html#o1">LinkTarget</a>.Buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00936 
00937         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( SymbolicLink-&gt;<a class="code" href="../../d2/d6/struct__OBJECT__SYMBOLIC__LINK.html#o1">LinkTarget</a>.Buffer );
00938     }
00939 
00940     SymbolicLink-&gt;<a class="code" href="../../d2/d6/struct__OBJECT__SYMBOLIC__LINK.html#o1">LinkTarget</a>.Buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00941 
00942     <span class="comment">//</span>
00943     <span class="comment">//  And return to our caller</span>
00944     <span class="comment">//</span>
00945 
00946     <span class="keywordflow">return</span>;
00947 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a67" doxytag="obp.h::ObpDeleteSymbolicLinkName" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID ObpDeleteSymbolicLinkName           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d2/d6/struct__OBJECT__SYMBOLIC__LINK.html">POBJECT_SYMBOLIC_LINK</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>SymbolicLink</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d0/oblink_8c-source.html#l00951">951</a> of file <a class="el" href="../../d5/d0/oblink_8c-source.html">oblink.c</a>.
<p>
References <a class="el" href="../../d5/d0/oblink_8c-source.html#l00042">DELETE_SYMBOLIC_LINK</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00233">_OBJECT_SYMBOLIC_LINK::LinkTargetObject</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00189">ObpEnterRootDirectoryMutex</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00202">ObpLeaveRootDirectoryMutex</a>, <a class="el" href="../../d5/d0/oblink_8c-source.html#l01121">ObpProcessDosDeviceSymbolicLink()</a>, and <a class="el" href="../../d5/d9/ob_8h-source.html#l00514">ObReferenceObject</a>.
<p>
Referenced by <a class="el" href="../../d8/d0/obref_8c-source.html#l01497">ObpDeleteNameCheck()</a>.
<p>
<pre class="fragment"><div>00957                    :
00958 
00959     This routine <span class="keyword">delete</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> symbolic from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system
00960 
00961 Arguments:
00962 
00963     SymbolicLink - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object body <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> symbolic
00964         link object to <span class="keyword">delete</span>
00965 
00966 Return Value:
00967 
00968     None.
00969 
00970 --*/
00971 
00972 {
00973     PVOID CapturedLinkTargetObject;
00974 
00975     CapturedLinkTargetObject = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00976 
00977     <span class="comment">//</span>
00978     <span class="comment">//  Lock the root directory mutex while we look at the target path to</span>
00979     <span class="comment">//  prevent names from disappearing out from under us.  Also protects</span>
00980     <span class="comment">//  against collisions with NtCreateSymbolicLink</span>
00981     <span class="comment">//</span>
00982 
00983     <a class="code" href="../../d5/d1/obp_8h.html#a10">ObpEnterRootDirectoryMutex</a>();
00984 
00985     <span class="comment">//</span>
00986     <span class="comment">//  Capture the link target object and referenced one more time</span>
00987     <span class="comment">//  to avoid destroying while the RootDirectoryMutex is hold</span>
00988     <span class="comment">//</span>
00989 
00990     CapturedLinkTargetObject = SymbolicLink-&gt;<a class="code" href="../../d2/d6/struct__OBJECT__SYMBOLIC__LINK.html#o3">LinkTargetObject</a>;
00991 
00992     <span class="keywordflow">if</span> (CapturedLinkTargetObject != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00993 
00994         <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>(CapturedLinkTargetObject);
00995     }
00996 
00997     <a class="code" href="../../d4/d1/oblink_8c.html#a4">ObpProcessDosDeviceSymbolicLink</a>( SymbolicLink, DELETE_SYMBOLIC_LINK );
00998 
00999     <a class="code" href="../../d5/d1/obp_8h.html#a11">ObpLeaveRootDirectoryMutex</a>();
01000 
01001     <span class="comment">//</span>
01002     <span class="comment">//  Remove the extra-reference for the link target object</span>
01003     <span class="comment">//</span>
01004 
01005     <span class="keywordflow">if</span> (CapturedLinkTargetObject != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01006 
01007         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(CapturedLinkTargetObject);
01008     }
01009 
01010     <span class="keywordflow">return</span>;
01011 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a93" doxytag="obp.h::ObpDereferenceSecurityDescriptor" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID ObpDereferenceSecurityDescriptor           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PSECURITY_DESCRIPTOR&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>SecurityDescriptor</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d0/obsdata_8c-source.html#l00700">700</a> of file <a class="el" href="../../d9/d0/obsdata_8c-source.html">obsdata.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00302">_SECURITY_DESCRIPTOR_HEADER::FullHash</a>, <a class="el" href="../../d9/d0/obsdata_8c-source.html#l00886">ObpAcquireDescriptorCacheWriteLock()</a>, <a class="el" href="../../d9/d0/obsdata_8c-source.html#l00759">ObpDestroySecurityDescriptorHeader()</a>, <a class="el" href="../../d9/d0/obsdata_8c-source.html#l00942">ObpReleaseDescriptorCacheLock()</a>, <a class="el" href="../../d9/d0/obsdata_8c-source.html#l00064">ObPrint</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00301">_SECURITY_DESCRIPTOR_HEADER::RefCount</a>, and <a class="el" href="../../d6/d0/obp_8h-source.html#l00311">SD_TO_SD_HEADER</a>.
<p>
Referenced by <a class="el" href="../../d9/d0/obsdata_8c-source.html#l00637">ObDeassignSecurity()</a>, <a class="el" href="../../d0/d1/obse_8c-source.html#l01418">ObReleaseObjectSecurity()</a>, and <a class="el" href="../../d0/d1/obse_8c-source.html#l01748">ObSetSecurityDescriptorInfo()</a>.
<p>
<pre class="fragment"><div>00706                    :
00707 
00708     Decrements <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> refcount of a cached security descriptor
00709 
00710 Arguments:
00711 
00712     SecurityDescriptor - Points to a cached security descriptor
00713 
00714 Return Value:
00715 
00716     None.
00717 
00718 --*/
00719 
00720 {
00721     <a class="code" href="../../d9/d0/struct__SECURITY__DESCRIPTOR__HEADER.html">PSECURITY_DESCRIPTOR_HEADER</a>  SecurityDescriptorHeader;
00722 
00723     <span class="comment">//</span>
00724     <span class="comment">//  Lock the security descriptor cache and get a pointer</span>
00725     <span class="comment">//  to the security descriptor header</span>
00726     <span class="comment">//</span>
00727 
00728     <a class="code" href="../../d8/d1/obsdata_8c.html#a23">ObpAcquireDescriptorCacheWriteLock</a>();
00729 
00730     SecurityDescriptorHeader = <a class="code" href="../../d5/d1/obp_8h.html#a18">SD_TO_SD_HEADER</a>( SecurityDescriptor );
00731 
00732     <span class="comment">//</span>
00733     <span class="comment">//  Do some debug work</span>
00734     <span class="comment">//</span>
00735 
00736     <a class="code" href="../../d8/d1/obsdata_8c.html#a1">ObPrint</a>( SHOW_REFERENCES, (<span class="stringliteral">"Dereferencing SecurityDescriptor %x, hash %lx, refcount = %d \n"</span>, SecurityDescriptor, SecurityDescriptorHeader-&gt;<a class="code" href="../../d9/d0/struct__SECURITY__DESCRIPTOR__HEADER.html#o2">FullHash</a>,SecurityDescriptorHeader-&gt;<a class="code" href="../../d9/d0/struct__SECURITY__DESCRIPTOR__HEADER.html#o1">RefCount</a>));
00737 
00738     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(SecurityDescriptorHeader-&gt;<a class="code" href="../../d9/d0/struct__SECURITY__DESCRIPTOR__HEADER.html#o1">RefCount</a> != 0);
00739 
00740     <span class="comment">//</span>
00741     <span class="comment">//  Decrement the ref count and if it is now zero then</span>
00742     <span class="comment">//  we can completely remove this entry from the cache</span>
00743     <span class="comment">//</span>
00744 
00745     <span class="keywordflow">if</span> (--SecurityDescriptorHeader-&gt;<a class="code" href="../../d9/d0/struct__SECURITY__DESCRIPTOR__HEADER.html#o1">RefCount</a> == 0) {
00746 
00747         <a class="code" href="../../d8/d1/obsdata_8c.html#a21">ObpDestroySecurityDescriptorHeader</a>( SecurityDescriptorHeader );
00748     }
00749 
00750     <span class="comment">//</span>
00751     <span class="comment">//  Unlock the security descriptor cache and return to our caller</span>
00752     <span class="comment">//</span>
00753 
00754     <a class="code" href="../../d8/d1/obsdata_8c.html#a25">ObpReleaseDescriptorCacheLock</a>();
00755 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a94" doxytag="obp.h::ObpDestroySecurityDescriptorHeader" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID ObpDestroySecurityDescriptorHeader           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d9/d0/struct__SECURITY__DESCRIPTOR__HEADER.html">PSECURITY_DESCRIPTOR_HEADER</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Header</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d0/obsdata_8c-source.html#l00759">759</a> of file <a class="el" href="../../d9/d0/obsdata_8c-source.html">obsdata.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d4/d2/dumpuser_8c-source.html#l00048">Header</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d9/d0/obsdata_8c-source.html#l00064">ObPrint</a>, and <a class="el" href="../../d9/d0/obsdata_8c-source.html#l00096">ObsSecurityDescriptorCache</a>.
<p>
Referenced by <a class="el" href="../../d9/d0/obsdata_8c-source.html#l00700">ObpDereferenceSecurityDescriptor()</a>.
<p>
<pre class="fragment"><div>00765                    :
00766 
00767     Frees a cached security descriptor and unlinks <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> chain.
00768 
00769 Arguments:
00770 
00771     <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a> - Pointer to a security descriptor header (cached security
00772         descriptor)
00773 
00774 Return Value:
00775 
00776     None.
00777 
00778 --*/
00779 
00780 {
00781     PLIST_ENTRY Forward;
00782     PLIST_ENTRY Rear;
00783     UCHAR SmallHash;
00784 
00785     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;RefCount == 0 );
00786 
00787 <span class="preprocessor">#if OB_DIAGNOSTICS_ENABLED</span>
00788 <span class="preprocessor"></span>
00789     ObsTotalCacheEntries--;
00790 
00791 <span class="preprocessor">#endif</span>
00792 <span class="preprocessor"></span>
00793     <a class="code" href="../../d8/d1/obsdata_8c.html#a1">ObPrint</a>( SHOW_STATISTICS, (<span class="stringliteral">"ObsTotalCacheEntries = %d \n"</span>,ObsTotalCacheEntries));
00794 
00795     <span class="comment">//</span>
00796     <span class="comment">//  Unlink the cached security descriptor from its linked list and</span>
00797     <span class="comment">//  from the small hash table if it was at the head of the list</span>
00798     <span class="comment">//</span>
00799     <span class="comment">//  **** this should all be rewritten to use the regular set of</span>
00800     <span class="comment">//  link list macros</span>
00801     <span class="comment">//</span>
00802 
00803     SmallHash = (UCHAR)<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FullHash;
00804 
00805     Forward = <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Link.Flink;
00806     Rear = <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;Link.Blink;
00807 
00808     <span class="keywordflow">if</span> ( Forward != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00809 
00810         Forward-&gt;Blink = Rear;
00811     }
00812 
00813     <span class="keywordflow">if</span> ( Rear != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00814 
00815         Rear-&gt;Flink = Forward;
00816 
00817     } <span class="keywordflow">else</span> {
00818 
00819         <span class="comment">//</span>
00820         <span class="comment">//  if Rear is NULL, we're deleting the head of the list</span>
00821         <span class="comment">//</span>
00822 
00823         <a class="code" href="../../d8/d1/obsdata_8c.html#a11">ObsSecurityDescriptorCache</a>[SmallHash] = Forward;
00824     }
00825 
00826     <a class="code" href="../../d8/d1/obsdata_8c.html#a1">ObPrint</a>( SHOW_HEADER_FREE, (<span class="stringliteral">"Freeing memory at %x \n"</span>,Header));
00827 
00828     <span class="comment">//</span>
00829     <span class="comment">//  Now return the cached descriptor to pool and return to our caller</span>
00830     <span class="comment">//</span>
00831 
00832     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( Header );
00833 
00834     <span class="keywordflow">return</span>;
00835 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a63" doxytag="obp.h::ObpFreeObject" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID FASTCALL ObpFreeObject           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Object</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d9/obcreate_8c-source.html#l01098">1098</a> of file <a class="el" href="../../d7/d9/obcreate_8c-source.html">obcreate.c</a>.
<p>
References <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00175">_OBJECT_TYPE_INITIALIZER::DefaultNonPagedPoolCharge</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00174">_OBJECT_TYPE_INITIALIZER::DefaultPagedPoolCharge</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00291">ExFreePoolWithTag</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00325">_OBJECT_HEADER_HANDLE_INFO::HandleCountDataBase</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00332">_OBJECT_HEADER_NAME_INFO::Name</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00189">_OBJECT_TYPE::Name</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00318">_OBJECT_HEADER_QUOTA_INFO::NonPagedPoolCharge</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00352">OB_FLAG_DEFAULT_SECURITY_QUOTA</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00347">OB_FLAG_NEW_OBJECT</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00353">OB_FLAG_SINGLE_HANDLE_ENTRY</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00371">OBJECT_HEADER_TO_CREATOR_INFO</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00365">OBJECT_HEADER_TO_HANDLE_INFO</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00368">OBJECT_HEADER_TO_NAME_INFO</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00362">OBJECT_HEADER_TO_QUOTA_INFO</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00355">OBJECT_TO_OBJECT_HEADER</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00431">ObpFreeObjectCreateInformation</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00317">_OBJECT_HEADER_QUOTA_INFO::PagedPoolCharge</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00281">PROTECTED_POOL</a>, <a class="el" href="../../d1/d1/psquota_8c-source.html#l00174">PsReturnSharedPoolQuota()</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l00062">SE_DEFAULT_SECURITY_QUOTA</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00319">_OBJECT_HEADER_QUOTA_INFO::SecurityDescriptorCharge</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00192">_OBJECT_TYPE::TotalNumberOfObjects</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00302">_OBJECT_HEADER::Type</a>, and <a class="el" href="../../d5/d9/ob_8h-source.html#l00196">_OBJECT_TYPE::TypeInfo</a>.
<p>
Referenced by <a class="el" href="../../d7/d9/obcreate_8c-source.html#l00055">ObCreateObject()</a>, and <a class="el" href="../../d8/d0/obref_8c-source.html#l01370">ObpRemoveObjectRoutine()</a>.
<p>
<pre class="fragment"><div>01104                    :
01105 
01106     This routine undoes <a class="code" href="../../d6/d0/obcreate_8c.html#a11">ObpAllocateObject</a>.  It returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object back to free <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a>.
01107 
01108 Arguments:
01109 
01110     Object - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> body of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object being freed.
01111 
01112 Return Value:
01113 
01114     None.
01115 
01116 --*/
01117 
01118 {
01119     <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> ObjectHeader;
01120     <a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> ObjectType;
01121     <a class="code" href="../../d1/d6/struct__OBJECT__HEADER__QUOTA__INFO.html">POBJECT_HEADER_QUOTA_INFO</a> QuotaInfo;
01122     <a class="code" href="../../d8/d5/struct__OBJECT__HEADER__HANDLE__INFO.html">POBJECT_HEADER_HANDLE_INFO</a> HandleInfo;
01123     <a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html">POBJECT_HEADER_NAME_INFO</a> NameInfo;
01124     <a class="code" href="../../d7/d5/struct__OBJECT__HEADER__CREATOR__INFO.html">POBJECT_HEADER_CREATOR_INFO</a> CreatorInfo;
01125     PVOID FreeBuffer;
01126     ULONG NonPagedPoolCharge;
01127     ULONG PagedPoolCharge;
01128 
01129     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01130 
01131     <span class="comment">//</span>
01132     <span class="comment">//  Get the address of the object header.</span>
01133     <span class="comment">//</span>
01134 
01135     ObjectHeader = <a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>(Object);
01136     ObjectType = ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o3">Type</a>;
01137 
01138     <span class="comment">//</span>
01139     <span class="comment">//  Now from the header determine the start of the allocation.  We need</span>
01140     <span class="comment">//  to backup based on what precedes the header.  The order is very</span>
01141     <span class="comment">//  important and must be the inverse of that used by ObpAllocateObject</span>
01142     <span class="comment">//</span>
01143 
01144     FreeBuffer = ObjectHeader;
01145 
01146     CreatorInfo = <a class="code" href="../../d4/d0/ob_8h.html#a13">OBJECT_HEADER_TO_CREATOR_INFO</a>( ObjectHeader );
01147 
01148     <span class="keywordflow">if</span> (CreatorInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01149 
01150         FreeBuffer = CreatorInfo;
01151     }
01152 
01153     NameInfo = <a class="code" href="../../d4/d0/ob_8h.html#a12">OBJECT_HEADER_TO_NAME_INFO</a>( ObjectHeader );
01154 
01155     <span class="keywordflow">if</span> (NameInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01156 
01157         FreeBuffer = NameInfo;
01158     }
01159 
01160     HandleInfo = <a class="code" href="../../d4/d0/ob_8h.html#a11">OBJECT_HEADER_TO_HANDLE_INFO</a>( ObjectHeader );
01161 
01162     <span class="keywordflow">if</span> (HandleInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01163 
01164         FreeBuffer = HandleInfo;
01165     }
01166 
01167     QuotaInfo = <a class="code" href="../../d4/d0/ob_8h.html#a10">OBJECT_HEADER_TO_QUOTA_INFO</a>( ObjectHeader );
01168 
01169     <span class="keywordflow">if</span> (QuotaInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01170 
01171         FreeBuffer = QuotaInfo;
01172     }
01173 
01174 <span class="preprocessor">#if DBG</span>
01175 <span class="preprocessor"></span>
01176     <span class="comment">//</span>
01177     <span class="comment">//  On a checked build echo out frees</span>
01178     <span class="comment">//</span>
01179 
01180     <span class="keywordflow">if</span> (ObpShowAllocAndFree) {
01181 
01182         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"OB: Free  %lx (%lx) - Type: %wZ\n"</span>, ObjectHeader, ObjectHeader, &amp;ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o2">Name</a> );
01183     }
01184 <span class="preprocessor">#endif</span>
01185 <span class="preprocessor"></span>
01186     <span class="comment">//</span>
01187     <span class="comment">//  Decrement the number of objects of this type</span>
01188     <span class="comment">//</span>
01189 
01190     ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o5">TotalNumberOfObjects</a> -= 1;
01191 
01192     <span class="comment">//</span>
01193     <span class="comment">//  Check where we were in the object initialization phase.  This</span>
01194     <span class="comment">//  flag really only tests if we have charged quota for this object.</span>
01195     <span class="comment">//  This is because the object create info and the quota block charged</span>
01196     <span class="comment">//  are unioned together.</span>
01197     <span class="comment">//</span>
01198 
01199     <span class="keywordflow">if</span> (ObjectHeader-&gt;Flags &amp; <a class="code" href="../../d4/d0/ob_8h.html#a1">OB_FLAG_NEW_OBJECT</a>) {
01200 
01201         <span class="keywordflow">if</span> (ObjectHeader-&gt;ObjectCreateInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01202 
01203             <a class="code" href="../../d5/d1/obp_8h.html#a29">ObpFreeObjectCreateInformation</a>( ObjectHeader-&gt;ObjectCreateInfo );
01204 
01205             ObjectHeader-&gt;ObjectCreateInfo = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01206         }
01207 
01208     } <span class="keywordflow">else</span> {
01209 
01210         <span class="keywordflow">if</span> (ObjectHeader-&gt;QuotaBlockCharged != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01211 
01212             <span class="keywordflow">if</span> (QuotaInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01213 
01214                 PagedPoolCharge = QuotaInfo-&gt;<a class="code" href="../../d1/d6/struct__OBJECT__HEADER__QUOTA__INFO.html#o0">PagedPoolCharge</a> +
01215                                   QuotaInfo-&gt;<a class="code" href="../../d1/d6/struct__OBJECT__HEADER__QUOTA__INFO.html#o2">SecurityDescriptorCharge</a>;
01216 
01217                 NonPagedPoolCharge = QuotaInfo-&gt;<a class="code" href="../../d1/d6/struct__OBJECT__HEADER__QUOTA__INFO.html#o1">NonPagedPoolCharge</a>;
01218 
01219             } <span class="keywordflow">else</span> {
01220 
01221                 PagedPoolCharge = ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o10">DefaultPagedPoolCharge</a>;
01222 
01223                 <span class="keywordflow">if</span> (ObjectHeader-&gt;Flags &amp; <a class="code" href="../../d4/d0/ob_8h.html#a6">OB_FLAG_DEFAULT_SECURITY_QUOTA</a> ) {
01224 
01225                     PagedPoolCharge += <a class="code" href="../../d0/d5/se_8h.html#a0">SE_DEFAULT_SECURITY_QUOTA</a>;
01226                 }
01227 
01228                 NonPagedPoolCharge = ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o11">DefaultNonPagedPoolCharge</a>;
01229             }
01230 
01231             <a class="code" href="../../d0/d2/psquota_8c.html#a1">PsReturnSharedPoolQuota</a>( ObjectHeader-&gt;QuotaBlockCharged,
01232                                      PagedPoolCharge,
01233                                      NonPagedPoolCharge );
01234         }
01235     }
01236 
01237     <span class="keywordflow">if</span> ((HandleInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
01238         ((ObjectHeader-&gt;Flags &amp; <a class="code" href="../../d4/d0/ob_8h.html#a7">OB_FLAG_SINGLE_HANDLE_ENTRY</a>) == 0)) {
01239 
01240         <span class="comment">//</span>
01241         <span class="comment">//  If a handle database has been allocated, then free the memory.</span>
01242         <span class="comment">//</span>
01243 
01244         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( HandleInfo-&gt;<a class="code" href="../../d8/d5/struct__OBJECT__HEADER__HANDLE__INFO.html#o0">HandleCountDataBase</a> );
01245 
01246         HandleInfo-&gt;<a class="code" href="../../d8/d5/struct__OBJECT__HEADER__HANDLE__INFO.html#o0">HandleCountDataBase</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01247     }
01248 
01249     <span class="comment">//</span>
01250     <span class="comment">//  If a name string buffer has been allocated, then free the memory.</span>
01251     <span class="comment">//</span>
01252 
01253     <span class="keywordflow">if</span> (NameInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; NameInfo-&gt;<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html#o1">Name</a>.Buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01254 
01255         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( NameInfo-&gt;<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html#o1">Name</a>.Buffer );
01256 
01257         NameInfo-&gt;<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html#o1">Name</a>.Buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01258     }
01259 
01260     <span class="comment">//</span>
01261     <span class="comment">//  Trash type field so we don't get far if we attempt to</span>
01262     <span class="comment">//  use a stale object pointer to this object.</span>
01263     <span class="comment">//</span>
01264     <span class="comment">//  Sundown Note: trash it by zero-extended it. </span>
01265     <span class="comment">//                sign-extension will create a valid kernel address.</span>
01266 
01267 
01268     ObjectHeader-&gt;Type = UIntToPtr(0xBAD0B0B0); 
01269     <a class="code" href="../../d5/d8/ex_8h.html#a7">ExFreePoolWithTag</a>( FreeBuffer,
01270                        (ObjectType == NULL ? 'TjbO' : ObjectType-&gt;Key) |
01271                             PROTECTED_POOL );
01272 
01273     <span class="keywordflow">return</span>;
01274 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a61" doxytag="obp.h::ObpFreeObjectNameBuffer" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID FASTCALL ObpFreeObjectNameBuffer           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>ObjectName</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d7/d9/obcreate_8c-source.html#l00055">ObCreateObject()</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00095">ObOpenObjectByName()</a>, and <a class="el" href="../../d8/d0/obref_8c-source.html#l00844">ObReferenceObjectByName()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a89" doxytag="obp.h::ObpHashBuffer" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG ObpHashBuffer           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Data</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d0/obsdata_8c-source.html#l00253">253</a> of file <a class="el" href="../../d9/d0/obsdata_8c-source.html">obsdata.c</a>.
<p>
References <a class="el" href="../../d7/d1/rtqkey_8c-source.html#l00042">Buffer</a>.
<p>
Referenced by <a class="el" href="../../d9/d0/obsdata_8c-source.html#l00182">ObpHashSecurityDescriptor()</a>.
<p>
<pre class="fragment"><div>00260                    :
00261 
00262     Hashes a buffer into a 32 bit value
00263 
00264 Arguments:
00265 
00266     Data - <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> containing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data to be hashed.
00267 
00268     Length - The length in bytes of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer
00269 
00270 
00271 Return Value:
00272 
00273     ULONG - a 32 bit hash value.
00274 
00275 --*/
00276 
00277 {
00278     PCHAR <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
00279     ULONG Result = 0;
00280     LONG i;
00281 
00282     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = (PCHAR)Data;
00283 
00284     <span class="keywordflow">for</span> (i = 0; i &lt;= (LONG)((Length-3)-<span class="keyword">sizeof</span>(ULONG)); i++) {
00285 
00286         ULONG Tmp;
00287 
00288         Tmp = *((ULONG UNALIGNED *)(<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> + i));
00289         Result += Tmp;
00290     }
00291 
00292     <span class="keywordflow">return</span>( Result );
00293 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a88" doxytag="obp.h::ObpHashSecurityDescriptor" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG ObpHashSecurityDescriptor           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PSECURITY_DESCRIPTOR&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>SecurityDescriptor</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d0/obsdata_8c-source.html#l00182">182</a> of file <a class="el" href="../../d9/d0/obsdata_8c-source.html">obsdata.c</a>.
<p>
References <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00161">Dacl</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00160">Group</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d9/d0/obsdata_8c-source.html#l00253">ObpHashBuffer()</a>, <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00159">Owner</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l02665">RtlGetDaclSecurityDescriptor()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l03232">RtlGetGroupSecurityDescriptor()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l03059">RtlGetOwnerSecurityDescriptor()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l02871">RtlGetSaclSecurityDescriptor()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l01350">RtlLengthSid()</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
Referenced by <a class="el" href="../../d9/d0/obsdata_8c-source.html#l00297">ObpLogSecurityDescriptor()</a>.
<p>
<pre class="fragment"><div>00188                    :
00189 
00190     Hashes a security descriptor to a 32 bit value
00191 
00192 Arguments:
00193 
00194     SecurityDescriptor - Provides <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security descriptor to be hashed
00195 
00196 Return Value:
00197 
00198     ULONG - a 32 bit hash value.
00199 
00200 --*/
00201 
00202 {
00203     PSID <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00204     PSID <a class="code" href="../../d6/d0/ctaccess_8c.html#a54">Group</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00205 
00206     PACL <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a>;
00207     PACL Sacl;
00208 
00209     ULONG Hash = 0;
00210     BOOLEAN Junk;
00211     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00212     BOOLEAN DaclPresent = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00213     BOOLEAN SaclPresent = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00214     PISECURITY_DESCRIPTOR sd;
00215 
00216     <span class="comment">//</span>
00217     <span class="comment">//  Cast the actually opaque security descriptor into something</span>
00218     <span class="comment">//  that we can decipher</span>
00219     <span class="comment">//</span>
00220 
00221     sd = (PISECURITY_DESCRIPTOR)SecurityDescriptor;
00222 
00223     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a65">RtlGetOwnerSecurityDescriptor</a>( sd, &amp;Owner, &amp;Junk );
00224     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a67">RtlGetGroupSecurityDescriptor</a>( sd, &amp;Group, &amp;Junk );
00225     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a61">RtlGetDaclSecurityDescriptor</a>( sd, &amp;DaclPresent, &amp;Dacl, &amp;Junk );
00226     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a63">RtlGetSaclSecurityDescriptor</a>( sd, &amp;SaclPresent, &amp;Sacl, &amp;Junk );
00227 
00228     <span class="keywordflow">if</span> ( <a class="code" href="../../d6/d0/ctaccess_8c.html#a53">Owner</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00229 
00230         Hash = <a class="code" href="../../d8/d1/obsdata_8c.html#a15">ObpHashBuffer</a>( Owner, <a class="code" href="../../d8/d6/sertl_8c.html#a45">RtlLengthSid</a>( Owner ));
00231     }
00232 
00233     <span class="keywordflow">if</span> ( <a class="code" href="../../d6/d0/ctaccess_8c.html#a54">Group</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00234 
00235         Hash += <a class="code" href="../../d8/d1/obsdata_8c.html#a15">ObpHashBuffer</a>( Group, <a class="code" href="../../d8/d6/sertl_8c.html#a45">RtlLengthSid</a>( Group));
00236     }
00237 
00238     <span class="keywordflow">if</span> ( DaclPresent &amp;&amp; (<a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00239 
00240         Hash += <a class="code" href="../../d8/d1/obsdata_8c.html#a15">ObpHashBuffer</a>( Dacl, <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a>-&gt;AclSize);
00241     }
00242 
00243     <span class="keywordflow">if</span> ( SaclPresent &amp;&amp; (Sacl != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00244 
00245         Hash += <a class="code" href="../../d8/d1/obsdata_8c.html#a15">ObpHashBuffer</a>( Sacl, Sacl-&gt;AclSize);
00246     }
00247 
00248     <span class="keywordflow">return</span>( Hash );
00249 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a77" doxytag="obp.h::ObpIncrementHandleCount" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS ObpIncrementHandleCount           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d4/d0/ob_8h.html#a21">OB_OPEN_REASON</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>OpenReason</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Process</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Object</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d2/d5/struct__ACCESS__STATE.html">PACCESS_STATE</a> AccessState&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessMode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Attributes</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/obhandle_8c-source.html#l01232">1232</a> of file <a class="el" href="../../d0/d0/obhandle_8c-source.html">obhandle.c</a>.
<p>
References <a class="el" href="../../d5/d9/ob_8h-source.html#l00178">_OBJECT_TYPE_INITIALIZER::CloseProcedure</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00306">_OBJECT_HEADER::Flags</a>, <a class="el" href="../../d0/d0/obhandle_8c-source.html#l00027">GENERIC_ACCESS</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00168">_OBJECT_TYPE_INITIALIZER::GenericMapping</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00299">_OBJECT_HEADER::HandleCount</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00195">_OBJECT_TYPE::HighWaterNumberOfHandles</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00171">_OBJECT_TYPE_INITIALIZER::MaintainHandleCount</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00350">OB_FLAG_EXCLUSIVE_OBJECT</a>, <a class="el" href="../../d0/d1/obse_8c-source.html#l00392">ObCheckObjectAccess()</a>, <a class="el" href="../../d4/d0/ob_8h.html#a100a58">ObCreateHandle</a>, <a class="el" href="../../d4/d0/ob_8h.html#a100a60">ObDuplicateHandle</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00371">OBJECT_HEADER_TO_CREATOR_INFO</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00358">OBJECT_HEADER_TO_EXCLUSIVE_PROCESS</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00362">OBJECT_HEADER_TO_QUOTA_INFO</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00355">OBJECT_TO_OBJECT_HEADER</a>, <a class="el" href="../../d4/d0/ob_8h.html#a100a59">ObOpenHandle</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00056">ObpBeginTypeSpecificCallOut</a>, <a class="el" href="../../d0/d0/obhandle_8c-source.html#l01861">ObpChargeQuotaForObject()</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00148">ObpDecrHandleCount</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00057">ObpEndTypeSpecificCallOut</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00163">ObpEnterObjectTypeMutex</a>, <a class="el" href="../../d0/d0/obhandle_8c-source.html#l01058">ObpIncrementHandleDataBase()</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00147">ObpIncrHandleCount</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00176">ObpLeaveObjectTypeMutex</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00071">ObpValidateIrql</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00177">_OBJECT_TYPE_INITIALIZER::OpenProcedure</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l03381">RtlMapGenericMask()</a>, <a class="el" href="../../d3/d4/seastate_8c-source.html#l00434">SeAppendPrivileges()</a>, <a class="el" href="../../d9/d3/privileg_8c-source.html#l00158">SePrivilegeCheck()</a>, <a class="el" href="../../d4/d4/seaudit_8c-source.html#l00989">SePrivilegedServiceAuditAlarm()</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l01676">SeSecurityPrivilege</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00193">_OBJECT_TYPE::TotalNumberOfHandles</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00196">_OBJECT_TYPE::TypeInfo</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00341">_OBJECT_HEADER_CREATOR_INFO::TypeList</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00188">_OBJECT_TYPE::TypeList</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
Referenced by <a class="el" href="../../d0/d0/obhandle_8c-source.html#l00163">NtDuplicateObject()</a>, <a class="el" href="../../d1/d0/obinit_8c-source.html#l00658">ObDupHandleProcedure()</a>, and <a class="el" href="../../d0/d0/obhandle_8c-source.html#l02160">ObpCreateHandle()</a>.
<p>
<pre class="fragment"><div>01244                    :
01245 
01246     Increments <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> count of number of handles to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> given object.
01247 
01248     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being opened or created, access validation and
01249     auditing will be performed as appropriate.
01250 
01251 Arguments:
01252 
01253     OpenReason - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a10">reason</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle count <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being incremented.
01254 
01255     Process - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process in which <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> handle will reside.
01256 
01257     Object - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> body of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object.
01258 
01259     ObjectType - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object.
01260 
01261     AccessState - Optional parameter supplying <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current accumulated
01262         security information describing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> attempt to access <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object.
01263 
01264     AccessMode - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> mode of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> requestor.
01265 
01266     Attributes - Desired attributes <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle
01267 
01268 Return Value:
01269 
01270     An appropriate status value
01271 
01272 --*/
01273 
01274 {
01275     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01276     ULONG ProcessHandleCount;
01277     BOOLEAN ExclusiveHandle;
01278     <a class="code" href="../../d7/d5/struct__OBJECT__HEADER__CREATOR__INFO.html">POBJECT_HEADER_CREATOR_INFO</a> CreatorInfo;
01279     <a class="code" href="../../d1/d6/struct__OBJECT__HEADER__QUOTA__INFO.html">POBJECT_HEADER_QUOTA_INFO</a> QuotaInfo;
01280     <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> ObjectHeader;
01281     BOOLEAN HasPrivilege = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01282     PRIVILEGE_SET Privileges;
01283     BOOLEAN NewObject;
01284     BOOLEAN HoldObjectTypeMutex = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01285 
01286     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01287 
01288     <a class="code" href="../../d5/d1/obp_8h.html#a2">ObpValidateIrql</a>( <span class="stringliteral">"ObpIncrementHandleCount"</span> );
01289 
01290     <span class="comment">//</span>
01291     <span class="comment">//  Get a pointer to the object header</span>
01292     <span class="comment">//</span>
01293 
01294     ObjectHeader = <a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>( Object );
01295 
01296     <span class="comment">//</span>
01297     <span class="comment">//  Charge the user quota for the object</span>
01298     <span class="comment">//</span>
01299 
01300     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d1/obp_8h.html#a82">ObpChargeQuotaForObject</a>( ObjectHeader, ObjectType, &amp;NewObject );
01301 
01302     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
01303 
01304         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01305     }
01306 
01307     <a class="code" href="../../d5/d1/obp_8h.html#a8">ObpEnterObjectTypeMutex</a>( ObjectType );
01308     HoldObjectTypeMutex = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01309 
01310     <span class="keywordflow">try</span> {
01311 
01312         ExclusiveHandle = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01313 
01314         <span class="comment">//</span>
01315         <span class="comment">//  Check if the caller wants exlusive access and if so then</span>
01316         <span class="comment">//  make sure the attributes and header flags match up correctly</span>
01317         <span class="comment">//</span>
01318 
01319         <span class="keywordflow">if</span> (Attributes &amp; OBJ_EXCLUSIVE) {
01320 
01321             <span class="keywordflow">if</span> ((Attributes &amp; OBJ_INHERIT) ||
01322                 ((ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o7">Flags</a> &amp; <a class="code" href="../../d4/d0/ob_8h.html#a4">OB_FLAG_EXCLUSIVE_OBJECT</a>) == 0)) {
01323 
01324                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
01325                 leave;
01326             }
01327 
01328             <span class="keywordflow">if</span> (((<a class="code" href="../../d4/d0/ob_8h.html#a9">OBJECT_HEADER_TO_EXCLUSIVE_PROCESS</a>(ObjectHeader) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
01329                  (ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o1">HandleCount</a> != 0))
01330 
01331                     ||
01332 
01333                 ((<a class="code" href="../../d4/d0/ob_8h.html#a9">OBJECT_HEADER_TO_EXCLUSIVE_PROCESS</a>(ObjectHeader) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
01334                  (<a class="code" href="../../d4/d0/ob_8h.html#a9">OBJECT_HEADER_TO_EXCLUSIVE_PROCESS</a>(ObjectHeader) != <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()))) {
01335 
01336                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_ACCESS_DENIED;
01337                 leave;
01338             }
01339 
01340             ExclusiveHandle = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01341 
01342         <span class="comment">//</span>
01343         <span class="comment">//  The user doesn't want exclusive access so now check to make sure</span>
01344         <span class="comment">//  the attriutes and header flags match up correctly</span>
01345         <span class="comment">//</span>
01346 
01347         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o7">Flags</a> &amp; <a class="code" href="../../d4/d0/ob_8h.html#a4">OB_FLAG_EXCLUSIVE_OBJECT</a>) &amp;&amp;
01348                    (<a class="code" href="../../d4/d0/ob_8h.html#a9">OBJECT_HEADER_TO_EXCLUSIVE_PROCESS</a>(ObjectHeader) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
01349 
01350             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_ACCESS_DENIED;
01351             leave;
01352         }
01353 
01354         <span class="comment">//</span>
01355         <span class="comment">//  If handle count going from zero to one for an existing object that</span>
01356         <span class="comment">//  maintains a handle count database, but does not have an open procedure</span>
01357         <span class="comment">//  just a close procedure, then fail the call as they are trying to</span>
01358         <span class="comment">//  reopen an object by pointer and the close procedure will not know</span>
01359         <span class="comment">//  that the object has been 'recreated'</span>
01360         <span class="comment">//</span>
01361 
01362         <span class="keywordflow">if</span> ((ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o1">HandleCount</a> == 0) &amp;&amp;
01363             (!NewObject) &amp;&amp;
01364             (ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o7">MaintainHandleCount</a>) &amp;&amp;
01365             (ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o13">OpenProcedure</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
01366             (ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o14">CloseProcedure</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
01367 
01368             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_UNSUCCESSFUL;
01369             leave;
01370         }
01371 
01372         <span class="keywordflow">if</span> ((OpenReason == <a class="code" href="../../d4/d0/ob_8h.html#a100a59">ObOpenHandle</a>) ||
01373             ((OpenReason == <a class="code" href="../../d4/d0/ob_8h.html#a100a60">ObDuplicateHandle</a>) &amp;&amp; ARGUMENT_PRESENT(AccessState))) {
01374 
01375             <span class="comment">//</span>
01376             <span class="comment">//  Perform Access Validation to see if we can open this</span>
01377             <span class="comment">//  (already existing) object.</span>
01378             <span class="comment">//</span>
01379             
01380             <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d1/obse_8c.html#a3">ObCheckObjectAccess</a>( Object,
01381                                       AccessState,
01382                                       TRUE,
01383                                       AccessMode,
01384                                       &amp;Status )) {
01385 
01386                 leave;
01387             }
01388             
01389         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((OpenReason == <a class="code" href="../../d4/d0/ob_8h.html#a100a58">ObCreateHandle</a>)) {
01390 
01391             <span class="comment">//</span>
01392             <span class="comment">//  We are creating a new instance of this object type.</span>
01393             <span class="comment">//  A total of three audit messages may be generated:</span>
01394             <span class="comment">//</span>
01395             <span class="comment">//  1 - Audit the attempt to create an instance of this</span>
01396             <span class="comment">//      object type.</span>
01397             <span class="comment">//</span>
01398             <span class="comment">//  2 - Audit the successful creation.</span>
01399             <span class="comment">//</span>
01400             <span class="comment">//  3 - Audit the allocation of the handle.</span>
01401             <span class="comment">//</span>
01402 
01403             <span class="comment">//</span>
01404             <span class="comment">//  At this point, the RemainingDesiredAccess field in</span>
01405             <span class="comment">//  the AccessState may still contain either Generic access</span>
01406             <span class="comment">//  types, or MAXIMUM_ALLOWED.  We will map the generics</span>
01407             <span class="comment">//  and substitute GenericAll for MAXIMUM_ALLOWED.</span>
01408             <span class="comment">//</span>
01409 
01410             <span class="keywordflow">if</span> ( AccessState-&gt;RemainingDesiredAccess &amp; MAXIMUM_ALLOWED ) {
01411 
01412                 AccessState-&gt;RemainingDesiredAccess &amp;= ~MAXIMUM_ALLOWED;
01413                 AccessState-&gt;RemainingDesiredAccess |= GENERIC_ALL;
01414             }
01415 
01416             <span class="keywordflow">if</span> ((<a class="code" href="../../d9/d0/obhandle_8c.html#a0">GENERIC_ACCESS</a> &amp; AccessState-&gt;RemainingDesiredAccess) != 0) {
01417 
01418                 <a class="code" href="../../d8/d6/sertl_8c.html#a70">RtlMapGenericMask</a>( &amp;AccessState-&gt;RemainingDesiredAccess,
01419                                    &amp;ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o4">GenericMapping</a> );
01420             }
01421 
01422             <span class="comment">//</span>
01423             <span class="comment">//  Since we are creating the object, we can give any access the caller</span>
01424             <span class="comment">//  wants.  The only exception is ACCESS_SYSTEM_SECURITY, which requires</span>
01425             <span class="comment">//  a privilege.</span>
01426             <span class="comment">//</span>
01427 
01428             <span class="keywordflow">if</span> ( AccessState-&gt;RemainingDesiredAccess &amp; ACCESS_SYSTEM_SECURITY ) {
01429 
01430                 <span class="comment">//</span>
01431                 <span class="comment">//  We could use SeSinglePrivilegeCheck here, but it</span>
01432                 <span class="comment">//  captures the subject context again, and we don't</span>
01433                 <span class="comment">//  want to do that in this path for performance reasons.</span>
01434                 <span class="comment">//</span>
01435 
01436                 Privileges.PrivilegeCount = 1;
01437                 Privileges.Control = PRIVILEGE_SET_ALL_NECESSARY;
01438                 Privileges.Privilege[0].Luid = <a class="code" href="../../d0/d5/se_8h.html#a85">SeSecurityPrivilege</a>;
01439                 Privileges.Privilege[0].Attributes = 0;
01440 
01441                 HasPrivilege = <a class="code" href="../../d8/d4/privileg_8c.html#a1">SePrivilegeCheck</a>( &amp;Privileges,
01442                                                  &amp;AccessState-&gt;SubjectSecurityContext,
01443                                                  KeGetPreviousMode() );
01444 
01445                 <span class="keywordflow">if</span> (!HasPrivilege) {
01446 
01447                     <a class="code" href="../../d3/d5/seaudit_8c.html#a15">SePrivilegedServiceAuditAlarm</a> ( NULL,
01448                                                     &amp;AccessState-&gt;SubjectSecurityContext,
01449                                                     &amp;Privileges,
01450                                                     FALSE );
01451 
01452                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_PRIVILEGE_NOT_HELD;
01453                     leave;
01454                 }
01455 
01456                 AccessState-&gt;RemainingDesiredAccess &amp;= ~ACCESS_SYSTEM_SECURITY;
01457                 AccessState-&gt;PreviouslyGrantedAccess |= ACCESS_SYSTEM_SECURITY;
01458 
01459                 (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d2/d5/seastate_8c.html#a5">SeAppendPrivileges</a>( AccessState,
01460                                            &amp;Privileges );
01461             }
01462 
01463             <span class="comment">//</span>
01464             <span class="comment">//  Get the objects creator info block and insert it on the</span>
01465             <span class="comment">//  global list of objects for that type</span>
01466             <span class="comment">//</span>
01467 
01468             CreatorInfo = <a class="code" href="../../d4/d0/ob_8h.html#a13">OBJECT_HEADER_TO_CREATOR_INFO</a>( ObjectHeader );
01469 
01470             <span class="keywordflow">if</span> (CreatorInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01471 
01472                 InsertTailList( &amp;ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o1">TypeList</a>, &amp;CreatorInfo-&gt;<a class="code" href="../../d7/d5/struct__OBJECT__HEADER__CREATOR__INFO.html#o0">TypeList</a> );
01473             }
01474         }
01475 
01476         <span class="keywordflow">if</span> (ExclusiveHandle) {
01477 
01478             <a class="code" href="../../d4/d0/ob_8h.html#a10">OBJECT_HEADER_TO_QUOTA_INFO</a>(ObjectHeader)-&gt;ExclusiveProcess = Process;
01479         }
01480 
01481         <a class="code" href="../../d5/d1/obp_8h.html#a6">ObpIncrHandleCount</a>( ObjectHeader );
01482         ProcessHandleCount = 0;
01483 
01484         <span class="comment">//</span>
01485         <span class="comment">//  If the object type wants us to keep try of the handle counts</span>
01486         <span class="comment">//  then call our routine to do the work</span>
01487         <span class="comment">//</span>
01488 
01489         <span class="keywordflow">if</span> (ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o7">MaintainHandleCount</a>) {
01490 
01491             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d0/obhandle_8c.html#a2">ObpIncrementHandleDataBase</a>( ObjectHeader,
01492                                                  Process,
01493                                                  &amp;ProcessHandleCount );
01494 
01495             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01496                 <span class="comment">// BUG BUG, We probably need more backout than this, NeillC</span>
01497                 <a class="code" href="../../d5/d1/obp_8h.html#a7">ObpDecrHandleCount</a>( ObjectHeader );
01498 
01499                 leave;
01500             }
01501         }
01502 
01503         <span class="comment">//</span>
01504         <span class="comment">//  Set our preliminary status now to success because</span>
01505         <span class="comment">//  the call to the open procedure might change this</span>
01506         <span class="comment">//</span>
01507 
01508         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01509 
01510         <span class="comment">//</span>
01511         <span class="comment">//  If the object type has an open procedure</span>
01512         <span class="comment">//  then invoke that procedure</span>
01513         <span class="comment">//</span>
01514 
01515         <span class="keywordflow">if</span> (ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o13">OpenProcedure</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01516 
01517             KIRQL SaveIrql;
01518 
01519             <span class="comment">//</span>
01520             <span class="comment">//  Leave the object type mutex when call the OpenProcedure. If an exception</span>
01521             <span class="comment">//  while OpenProcedure the HoldObjectTypeMutex disable leaving the mutex</span>
01522             <span class="comment">//  on finally block</span>
01523             <span class="comment">//</span>
01524 
01525             <a class="code" href="../../d5/d1/obp_8h.html#a9">ObpLeaveObjectTypeMutex</a>( ObjectType );
01526             HoldObjectTypeMutex = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01527 
01528             <a class="code" href="../../d5/d1/obp_8h.html#a0">ObpBeginTypeSpecificCallOut</a>( SaveIrql );
01529 
01530             <span class="keywordflow">try</span> {
01531 
01532                 (*ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o13">OpenProcedure</a>)( OpenReason,
01533                                                        Process,
01534                                                        Object,
01535                                                        AccessState ?
01536                                                            AccessState-&gt;PreviouslyGrantedAccess :
01537                                                            0,
01538                                                        ProcessHandleCount );
01539 
01540             } except( EXCEPTION_EXECUTE_HANDLER ) {
01541 
01542                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
01543             }
01544 
01545             <a class="code" href="../../d5/d1/obp_8h.html#a1">ObpEndTypeSpecificCallOut</a>( SaveIrql, <span class="stringliteral">"Open"</span>, ObjectType, Object );
01546 
01547             <span class="comment">//</span>
01548             <span class="comment">//  Hold back the object type mutex and set the HoldObjectTypeMutex variable</span>
01549             <span class="comment">//  to allow releasing the mutex while leaving this procedure</span>
01550             <span class="comment">//</span>
01551 
01552             <a class="code" href="../../d5/d1/obp_8h.html#a8">ObpEnterObjectTypeMutex</a>( ObjectType );
01553             HoldObjectTypeMutex = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01554 
01555             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01556 
01557                 (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>)<a class="code" href="../../d5/d1/obp_8h.html#a7">ObpDecrHandleCount</a>( ObjectHeader );
01558                 leave;
01559             }
01560         }
01561 
01562         <span class="comment">//</span>
01563         <span class="comment">//  Do some simple bookkeeping for the handle counts</span>
01564         <span class="comment">//  and then return to our caller</span>
01565         <span class="comment">//</span>
01566 
01567         ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o6">TotalNumberOfHandles</a> += 1;
01568 
01569         <span class="keywordflow">if</span> (ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o6">TotalNumberOfHandles</a> &gt; ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o8">HighWaterNumberOfHandles</a>) {
01570 
01571             ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o8">HighWaterNumberOfHandles</a> = ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o6">TotalNumberOfHandles</a>;
01572         }
01573 
01574     } finally {
01575 
01576         <span class="keywordflow">if</span> ( HoldObjectTypeMutex ) {
01577 
01578             <a class="code" href="../../d5/d1/obp_8h.html#a9">ObpLeaveObjectTypeMutex</a>( ObjectType );
01579         }
01580     }
01581 
01582     <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
01583 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a80" doxytag="obp.h::ObpIncrementUnnamedHandleCount" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS ObpIncrementUnnamedHandleCount           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>DesiredAccess</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Process</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Object</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessMode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Attributes</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/obhandle_8c-source.html#l01587">1587</a> of file <a class="el" href="../../d0/d0/obhandle_8c-source.html">obhandle.c</a>.
<p>
References <a class="el" href="../../d5/d9/ob_8h-source.html#l00178">_OBJECT_TYPE_INITIALIZER::CloseProcedure</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00306">_OBJECT_HEADER::Flags</a>, <a class="el" href="../../d0/d0/obhandle_8c-source.html#l00027">GENERIC_ACCESS</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00168">_OBJECT_TYPE_INITIALIZER::GenericMapping</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00299">_OBJECT_HEADER::HandleCount</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00195">_OBJECT_TYPE::HighWaterNumberOfHandles</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00171">_OBJECT_TYPE_INITIALIZER::MaintainHandleCount</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00350">OB_FLAG_EXCLUSIVE_OBJECT</a>, <a class="el" href="../../d4/d0/ob_8h.html#a100a58">ObCreateHandle</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00371">OBJECT_HEADER_TO_CREATOR_INFO</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00358">OBJECT_HEADER_TO_EXCLUSIVE_PROCESS</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00362">OBJECT_HEADER_TO_QUOTA_INFO</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00355">OBJECT_TO_OBJECT_HEADER</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00056">ObpBeginTypeSpecificCallOut</a>, <a class="el" href="../../d0/d0/obhandle_8c-source.html#l01861">ObpChargeQuotaForObject()</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00148">ObpDecrHandleCount</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00057">ObpEndTypeSpecificCallOut</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00163">ObpEnterObjectTypeMutex</a>, <a class="el" href="../../d0/d0/obhandle_8c-source.html#l01058">ObpIncrementHandleDataBase()</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00147">ObpIncrHandleCount</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00176">ObpLeaveObjectTypeMutex</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00071">ObpValidateIrql</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00177">_OBJECT_TYPE_INITIALIZER::OpenProcedure</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l03381">RtlMapGenericMask()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00193">_OBJECT_TYPE::TotalNumberOfHandles</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00196">_OBJECT_TYPE::TypeInfo</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00341">_OBJECT_HEADER_CREATOR_INFO::TypeList</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00188">_OBJECT_TYPE::TypeList</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
Referenced by <a class="el" href="../../d0/d0/obhandle_8c-source.html#l02507">ObpCreateUnnamedHandle()</a>.
<p>
<pre class="fragment"><div>01598                    :
01599 
01600     Increments <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> count of number of handles to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> given object.
01601 
01602 Arguments:
01603 
01604     Desired Access - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> desired access to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object and receives
01605         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> assign access mask
01606 
01607     Process - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process in which <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> handle will reside.
01608 
01609     Object - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> body of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object.
01610 
01611     ObjectType - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object.
01612 
01613     AccessMode - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> mode of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> requestor.
01614 
01615     Attributes - Desired attributes <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle
01616 
01617 Return Value:
01618 
01619     An appropriate status value
01620 
01621 --*/
01622 
01623 {
01624     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01625     BOOLEAN ExclusiveHandle;
01626     <a class="code" href="../../d7/d5/struct__OBJECT__HEADER__CREATOR__INFO.html">POBJECT_HEADER_CREATOR_INFO</a> CreatorInfo;
01627     <a class="code" href="../../d1/d6/struct__OBJECT__HEADER__QUOTA__INFO.html">POBJECT_HEADER_QUOTA_INFO</a> QuotaInfo;
01628     <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> ObjectHeader;
01629     BOOLEAN NewObject;
01630     ULONG ProcessHandleCount;
01631     BOOLEAN HoldObjectTypeMutex = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01632 
01633     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01634 
01635     <a class="code" href="../../d5/d1/obp_8h.html#a2">ObpValidateIrql</a>( <span class="stringliteral">"ObpIncrementUnnamedHandleCount"</span> );
01636 
01637     <span class="comment">//</span>
01638     <span class="comment">//  Get a pointer to the object header</span>
01639     <span class="comment">//</span>
01640 
01641     ObjectHeader = <a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>( Object );
01642 
01643     <span class="comment">//</span>
01644     <span class="comment">//  Charge the user quota for the object</span>
01645     <span class="comment">//</span>
01646 
01647     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d1/obp_8h.html#a82">ObpChargeQuotaForObject</a>( ObjectHeader, ObjectType, &amp;NewObject );
01648 
01649     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
01650 
01651         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01652     }
01653 
01654     <a class="code" href="../../d5/d1/obp_8h.html#a8">ObpEnterObjectTypeMutex</a>( ObjectType );
01655     HoldObjectTypeMutex = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01656 
01657     <span class="keywordflow">try</span> {
01658 
01659         ExclusiveHandle = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01660 
01661         <span class="comment">//</span>
01662         <span class="comment">//  Check if the caller wants exlusive access and if so then</span>
01663         <span class="comment">//  make sure the attributes and header flags match up correctly</span>
01664         <span class="comment">//</span>
01665 
01666         <span class="keywordflow">if</span> (Attributes &amp; OBJ_EXCLUSIVE) {
01667 
01668             <span class="keywordflow">if</span> ((Attributes &amp; OBJ_INHERIT) ||
01669                 ((ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o7">Flags</a> &amp; <a class="code" href="../../d4/d0/ob_8h.html#a4">OB_FLAG_EXCLUSIVE_OBJECT</a>) == 0)) {
01670 
01671                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
01672                 leave;
01673             }
01674 
01675             <span class="keywordflow">if</span> (((<a class="code" href="../../d4/d0/ob_8h.html#a9">OBJECT_HEADER_TO_EXCLUSIVE_PROCESS</a>(ObjectHeader) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
01676                  (ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o1">HandleCount</a> != 0))
01677 
01678                         ||
01679 
01680                 ((<a class="code" href="../../d4/d0/ob_8h.html#a9">OBJECT_HEADER_TO_EXCLUSIVE_PROCESS</a>(ObjectHeader) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
01681                  (<a class="code" href="../../d4/d0/ob_8h.html#a9">OBJECT_HEADER_TO_EXCLUSIVE_PROCESS</a>(ObjectHeader) != <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()))) {
01682 
01683                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_ACCESS_DENIED;
01684                 leave;
01685             }
01686 
01687             ExclusiveHandle = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01688 
01689         <span class="comment">//</span>
01690         <span class="comment">//  The user doesn't want exclusive access so now check to make sure</span>
01691         <span class="comment">//  the attriutes and header flags match up correctly</span>
01692         <span class="comment">//</span>
01693 
01694         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o7">Flags</a> &amp; <a class="code" href="../../d4/d0/ob_8h.html#a4">OB_FLAG_EXCLUSIVE_OBJECT</a>) &amp;&amp;
01695                    (<a class="code" href="../../d4/d0/ob_8h.html#a9">OBJECT_HEADER_TO_EXCLUSIVE_PROCESS</a>(ObjectHeader) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
01696 
01697             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_ACCESS_DENIED;
01698             leave;
01699         }
01700 
01701         <span class="comment">//</span>
01702         <span class="comment">//  If handle count going from zero to one for an existing object that</span>
01703         <span class="comment">//  maintains a handle count database, but does not have an open procedure</span>
01704         <span class="comment">//  just a close procedure, then fail the call as they are trying to</span>
01705         <span class="comment">//  reopen an object by pointer and the close procedure will not know</span>
01706         <span class="comment">//  that the object has been 'recreated'</span>
01707         <span class="comment">//</span>
01708 
01709         <span class="keywordflow">if</span> ((ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o1">HandleCount</a> == 0) &amp;&amp;
01710             (!NewObject) &amp;&amp;
01711             (ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o7">MaintainHandleCount</a>) &amp;&amp;
01712             (ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o13">OpenProcedure</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
01713             (ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o14">CloseProcedure</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
01714 
01715             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_UNSUCCESSFUL;
01716 
01717             leave;
01718         }
01719 
01720         <span class="comment">//</span>
01721         <span class="comment">//  If the user asked for the maximum allowed then remove the bit and</span>
01722         <span class="comment">//  or in generic all access</span>
01723         <span class="comment">//</span>
01724 
01725         <span class="keywordflow">if</span> ( *DesiredAccess &amp; MAXIMUM_ALLOWED ) {
01726 
01727             *DesiredAccess &amp;= ~MAXIMUM_ALLOWED;
01728             *DesiredAccess |= GENERIC_ALL;
01729         }
01730 
01731         <span class="comment">//  If the user asked for any generic bit then translate it to</span>
01732         <span class="comment">//  someone more appropriate for the object type</span>
01733         <span class="comment">//</span>
01734 
01735         <span class="keywordflow">if</span> ((<a class="code" href="../../d9/d0/obhandle_8c.html#a0">GENERIC_ACCESS</a> &amp; *DesiredAccess) != 0) {
01736 
01737             <a class="code" href="../../d8/d6/sertl_8c.html#a70">RtlMapGenericMask</a>( DesiredAccess,
01738                                &amp;ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o4">GenericMapping</a> );
01739         }
01740 
01741         <span class="comment">//</span>
01742         <span class="comment">//  Get a pointer to the creator info block for the object and insert</span>
01743         <span class="comment">//  it on the global list of object for that type</span>
01744         <span class="comment">//</span>
01745 
01746         CreatorInfo = <a class="code" href="../../d4/d0/ob_8h.html#a13">OBJECT_HEADER_TO_CREATOR_INFO</a>( ObjectHeader );
01747 
01748         <span class="keywordflow">if</span> (CreatorInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01749 
01750             InsertTailList( &amp;ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o1">TypeList</a>, &amp;CreatorInfo-&gt;<a class="code" href="../../d7/d5/struct__OBJECT__HEADER__CREATOR__INFO.html#o0">TypeList</a> );
01751         }
01752 
01753         <span class="keywordflow">if</span> (ExclusiveHandle) {
01754 
01755             <a class="code" href="../../d4/d0/ob_8h.html#a10">OBJECT_HEADER_TO_QUOTA_INFO</a>(ObjectHeader)-&gt;ExclusiveProcess = Process;
01756         }
01757 
01758         <a class="code" href="../../d5/d1/obp_8h.html#a6">ObpIncrHandleCount</a>( ObjectHeader );
01759         ProcessHandleCount = 0;
01760 
01761         <span class="comment">//</span>
01762         <span class="comment">//  If the object type wants us to keep try of the handle counts</span>
01763         <span class="comment">//  then call our routine to do the work</span>
01764         <span class="comment">//</span>
01765 
01766         <span class="keywordflow">if</span> (ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o7">MaintainHandleCount</a>) {
01767 
01768             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d0/obhandle_8c.html#a2">ObpIncrementHandleDataBase</a>( ObjectHeader,
01769                                                  Process,
01770                                                  &amp;ProcessHandleCount );
01771 
01772             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01773                 <span class="comment">// BUG BUG, We probably need more backout than this, NeillC</span>
01774                 <a class="code" href="../../d5/d1/obp_8h.html#a7">ObpDecrHandleCount</a>( ObjectHeader );
01775                 leave;
01776             }
01777         }
01778 
01779         <span class="comment">//</span>
01780         <span class="comment">//  Set our preliminary status now to success because</span>
01781         <span class="comment">//  the call to the open procedure might change this</span>
01782         <span class="comment">//</span>
01783 
01784         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01785 
01786         <span class="comment">//</span>
01787         <span class="comment">//  If the object type has an open procedure</span>
01788         <span class="comment">//  then invoke that procedure</span>
01789         <span class="comment">//</span>
01790 
01791         <span class="keywordflow">if</span> (ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o13">OpenProcedure</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01792 
01793             KIRQL SaveIrql;
01794 
01795             <span class="comment">//</span>
01796             <span class="comment">//  Leave the object type mutex when call the OpenProcedure. If an exception</span>
01797             <span class="comment">//  while OpenProcedure the HoldObjectTypeMutex disable leaving the mutex</span>
01798             <span class="comment">//  on finally block</span>
01799             <span class="comment">//</span>
01800 
01801             <a class="code" href="../../d5/d1/obp_8h.html#a9">ObpLeaveObjectTypeMutex</a>( ObjectType );
01802             HoldObjectTypeMutex = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01803 
01804             <a class="code" href="../../d5/d1/obp_8h.html#a0">ObpBeginTypeSpecificCallOut</a>( SaveIrql );
01805 
01806             <span class="keywordflow">try</span> {
01807 
01808                 (*ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o13">OpenProcedure</a>)( <a class="code" href="../../d4/d0/ob_8h.html#a100a58">ObCreateHandle</a>,
01809                                                        Process,
01810                                                        Object,
01811                                                        *DesiredAccess,
01812                                                        ProcessHandleCount );
01813 
01814             } except( EXCEPTION_EXECUTE_HANDLER ) {
01815 
01816                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
01817             }
01818 
01819             <a class="code" href="../../d5/d1/obp_8h.html#a1">ObpEndTypeSpecificCallOut</a>( SaveIrql, <span class="stringliteral">"Open"</span>, ObjectType, Object );
01820 
01821             <span class="comment">//</span>
01822             <span class="comment">//  Hold back the object type mutex and set the HoldObjectTypeMutex variable</span>
01823             <span class="comment">//  to allow releasing the mutex while leaving this procedure</span>
01824             <span class="comment">//</span>
01825 
01826             <a class="code" href="../../d5/d1/obp_8h.html#a8">ObpEnterObjectTypeMutex</a>( ObjectType );
01827             HoldObjectTypeMutex = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01828 
01829             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01830 
01831                 (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>)<a class="code" href="../../d5/d1/obp_8h.html#a7">ObpDecrHandleCount</a>( ObjectHeader );
01832                 leave;
01833             }
01834         }
01835 
01836         <span class="comment">//</span>
01837         <span class="comment">//  Do some simple bookkeeping for the handle counts</span>
01838         <span class="comment">//  and then return to our caller</span>
01839         <span class="comment">//</span>
01840 
01841         ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o6">TotalNumberOfHandles</a> += 1;
01842 
01843         <span class="keywordflow">if</span> (ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o6">TotalNumberOfHandles</a> &gt; ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o8">HighWaterNumberOfHandles</a>) {
01844 
01845             ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o8">HighWaterNumberOfHandles</a> = ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o6">TotalNumberOfHandles</a>;
01846         }
01847 
01848     } finally {
01849 
01850         <span class="keywordflow">if</span> ( HoldObjectTypeMutex ) {
01851 
01852             <a class="code" href="../../d5/d1/obp_8h.html#a9">ObpLeaveObjectTypeMutex</a>( ObjectType );
01853         }
01854     }
01855 
01856     <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
01857 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a87" doxytag="obp.h::ObpInitSecurityDescriptorCache" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS ObpInitSecurityDescriptorCache           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d0/obsdata_8c-source.html#l00118">118</a> of file <a class="el" href="../../d9/d0/obsdata_8c-source.html">obsdata.c</a>.
<p>
References <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02473">ExInitializeResource</a>, <a class="el" href="../../d9/d0/obsdata_8c-source.html#l00058">IF_OB_GLOBAL</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d9/d0/obsdata_8c-source.html#l00096">ObsSecurityDescriptorCache</a>, <a class="el" href="../../d9/d0/obsdata_8c-source.html#l00103">ObsSecurityDescriptorCacheLock</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00339">SECURITY_DESCRIPTOR_CACHE_ENTRIES</a>, <a class="el" href="../../d9/d6/lh__open_2pi__mem_8h-source.html#l00017">Size</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
Referenced by <a class="el" href="../../d1/d0/obinit_8c-source.html#l00117">ObInitSystem()</a>.
<p>
<pre class="fragment"><div>00124                    :
00125 
00126     Allocates and initializes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> globalSecurity Descriptor Cache
00127 
00128 Arguments:
00129 
00130     None
00131 
00132 Return Value:
00133 
00134     STATUS_SUCCESS on success, <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> on <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a>.
00135 
00136 --*/
00137 
00138 {
00139     ULONG <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
00140     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00141 
00142     <a class="code" href="../../d8/d1/obsdata_8c.html#a0">IF_OB_GLOBAL</a>( BREAK_ON_INIT ) {
00143 
00144         DbgBreakPoint();
00145     }
00146 
00147     <span class="comment">//</span>
00148     <span class="comment">//  Allocate the cache of pointers and zero it out</span>
00149     <span class="comment">//</span>
00150 
00151     <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = <a class="code" href="../../d5/d1/obp_8h.html#a22">SECURITY_DESCRIPTOR_CACHE_ENTRIES</a> * <span class="keyword">sizeof</span>(PLIST_ENTRY);
00152     <a class="code" href="../../d8/d1/obsdata_8c.html#a11">ObsSecurityDescriptorCache</a> = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( PagedPool, Size, 'cCdS' );
00153 
00154     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d1/obsdata_8c.html#a11">ObsSecurityDescriptorCache</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00155 
00156         <span class="keywordflow">return</span>( STATUS_INSUFFICIENT_RESOURCES );
00157     }
00158 
00159     RtlZeroMemory( ObsSecurityDescriptorCache, Size );
00160 
00161     <span class="comment">//</span>
00162     <span class="comment">//  Initialize the resource used to protect the security cache</span>
00163     <span class="comment">//</span>
00164 
00165     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d8/ex_8h.html#a68">ExInitializeResource</a> ( &amp;ObsSecurityDescriptorCacheLock );
00166 
00167     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ) {
00168 
00169         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( ObsSecurityDescriptorCache );
00170         <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00171     }
00172 
00173     <span class="comment">//</span>
00174     <span class="comment">//  And return to our caller</span>
00175     <span class="comment">//</span>
00176 
00177     <span class="keywordflow">return</span>( STATUS_SUCCESS );
00178 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a69" doxytag="obp.h::ObpInsertDirectoryEntry" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN ObpInsertDirectoryEntry           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__OBJECT__DIRECTORY.html">POBJECT_DIRECTORY</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Directory</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Object</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d9/obdir_8c-source.html#l00903">903</a> of file <a class="el" href="../../d9/d9/obdir_8c-source.html">obdir.c</a>.
<p>
References <a class="el" href="../../d5/d9/ob_8h-source.html#l00220">_OBJECT_DIRECTORY_ENTRY::ChainLink</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00331">_OBJECT_HEADER_NAME_INFO::Directory</a>, <a class="el" href="../../d3/d4/editreg_8c-source.html#l00903">Directory()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00221">_OBJECT_DIRECTORY_ENTRY::Object</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00368">OBJECT_HEADER_TO_NAME_INFO</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00355">OBJECT_TO_OBJECT_HEADER</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d1/d1/obtype_8c-source.html#l00069">ObCreateObjectType()</a>, <a class="el" href="../../d1/d0/obinit_8c-source.html#l00117">ObInitSystem()</a>, and <a class="el" href="../../d9/d9/obdir_8c-source.html#l01081">ObpLookupObjectName()</a>.
<p>
<pre class="fragment"><div>00910                    :
00911 
00912     This routine will insert a <span class="keyword">new</span> directory entry into a directory
00913     object.  The directory must have already have been searched <span class="keyword">using</span>
00914     <a class="code" href="../../d8/d0/obdir_8c.html#a3">ObpLookupDirectoryEntry</a> because that routine sets <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> LookupBucket
00915 
00916 Arguments:
00917 
00918     <a class="code" href="../../d2/d5/editreg_8c.html#a68">Directory</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> directory object being modified.  This
00919         function assumes that we earlier did a lookup on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name
00920         that was successful or we just did an insertion
00921 
00922     Object - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object to insert into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> directory
00923 
00924 Return Value:
00925 
00926     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> inserted successfully and <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise
00927 
00928 --*/
00929 
00930 {
00931     <a class="code" href="../../d9/d4/struct__OBJECT__DIRECTORY__ENTRY.html">POBJECT_DIRECTORY_ENTRY</a> *HeadDirectoryEntry;
00932     <a class="code" href="../../d9/d4/struct__OBJECT__DIRECTORY__ENTRY.html">POBJECT_DIRECTORY_ENTRY</a> NewDirectoryEntry;
00933     <a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html">POBJECT_HEADER_NAME_INFO</a> NameInfo;
00934 
00935     <span class="comment">//</span>
00936     <span class="comment">//  Make sure we have a directory and that the last search was</span>
00937     <span class="comment">//  successful, meaning there is a lookupbuket</span>
00938     <span class="comment">//</span>
00939 
00940     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d5/editreg_8c.html#a68">Directory</a> || <a class="code" href="../../d2/d5/editreg_8c.html#a68">Directory</a>-&gt;LookupFound) {
00941 
00942         <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00943     }
00944 
00945     <span class="comment">//</span>
00946     <span class="comment">//  Also verify that we have a good lookupbucket</span>
00947     <span class="comment">//</span>
00948 
00949     HeadDirectoryEntry = <a class="code" href="../../d2/d5/editreg_8c.html#a68">Directory</a>-&gt;LookupBucket;
00950 
00951     <span class="keywordflow">if</span> (!HeadDirectoryEntry) {
00952 
00953         <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00954     }
00955 
00956     <span class="comment">//</span>
00957     <span class="comment">//  Translate the object into a name info record, and make sure</span>
00958     <span class="comment">//  that the object has a name</span>
00959     <span class="comment">//</span>
00960 
00961     NameInfo = <a class="code" href="../../d4/d0/ob_8h.html#a12">OBJECT_HEADER_TO_NAME_INFO</a>( <a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>( Object ) );
00962 
00963     <span class="keywordflow">if</span> (NameInfo == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00964 
00965         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00966     }
00967 
00968     <span class="comment">//</span>
00969     <span class="comment">//  Allocate memory for a new entry, and fail if not enough memory.</span>
00970     <span class="comment">//</span>
00971 
00972     NewDirectoryEntry = (<a class="code" href="../../d9/d4/struct__OBJECT__DIRECTORY__ENTRY.html">POBJECT_DIRECTORY_ENTRY</a>)<a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( PagedPool,
00973                                                                         <span class="keyword">sizeof</span>( <a class="code" href="../../d9/d4/struct__OBJECT__DIRECTORY__ENTRY.html">OBJECT_DIRECTORY_ENTRY</a> ),
00974                                                                         'iDbO' );
00975 
00976     <span class="keywordflow">if</span> (NewDirectoryEntry == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00977 
00978         <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00979     }
00980 
00981     <span class="comment">//</span>
00982     <span class="comment">//  Link the new entry into the chain at the insertion point.</span>
00983     <span class="comment">//  This puts the new object right at the head of the current</span>
00984     <span class="comment">//  hash bucket chain</span>
00985     <span class="comment">//</span>
00986 
00987     NewDirectoryEntry-&gt;<a class="code" href="../../d9/d4/struct__OBJECT__DIRECTORY__ENTRY.html#o0">ChainLink</a> = *HeadDirectoryEntry;
00988     *HeadDirectoryEntry = NewDirectoryEntry;
00989     NewDirectoryEntry-&gt;<a class="code" href="../../d9/d4/struct__OBJECT__DIRECTORY__ENTRY.html#o1">Object</a> = Object;
00990 
00991     <span class="comment">//</span>
00992     <span class="comment">//  Point the object header back to the directory we just inserted</span>
00993     <span class="comment">//  it into.</span>
00994     <span class="comment">//</span>
00995 
00996     NameInfo-&gt;<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html#o0">Directory</a> = <a class="code" href="../../d2/d5/editreg_8c.html#a68">Directory</a>;
00997 
00998     <span class="comment">//</span>
00999     <span class="comment">//  Return success.</span>
01000     <span class="comment">//</span>
01001 
01002     <a class="code" href="../../d2/d5/editreg_8c.html#a68">Directory</a>-&gt;LookupFound = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01003 
01004     <span class="keywordflow">return</span>( <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
01005 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a76" doxytag="obp.h::ObpInsertHandleCount" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d2/d5/struct__OBJECT__HANDLE__COUNT__ENTRY.html">POBJECT_HANDLE_COUNT_ENTRY</a> ObpInsertHandleCount           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>ObjectHeader</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/obhandle_8c-source.html#l00908">908</a> of file <a class="el" href="../../d0/d0/obhandle_8c-source.html">obhandle.c</a>.
<p>
References <a class="el" href="../../d5/d9/ob_8h-source.html#l00261">_OBJECT_HANDLE_COUNT_DATABASE::CountEntries</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00306">_OBJECT_HEADER::Flags</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00325">_OBJECT_HEADER_HANDLE_INFO::HandleCountDataBase</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00262">_OBJECT_HANDLE_COUNT_DATABASE::HandleCountEntries</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00353">OB_FLAG_SINGLE_HANDLE_ENTRY</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00365">OBJECT_HEADER_TO_HANDLE_INFO</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, and <a class="el" href="../../d5/d9/ob_8h-source.html#l00326">_OBJECT_HEADER_HANDLE_INFO::SingleEntry</a>.
<p>
Referenced by <a class="el" href="../../d0/d0/obhandle_8c-source.html#l01058">ObpIncrementHandleDataBase()</a>.
<p>
<pre class="fragment"><div>00914                    :
00915 
00916     This function will increase <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle database
00917     stored in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle information of an object header.  If
00918     necessary <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> will allocate <span class="keyword">new</span> and free old handle databases.
00919 
00920     This routine should not be called <span class="keywordflow">if</span> there <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> already free
00921     space in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle table.
00922 
00923 Arguments:
00924 
00925     ObjectHeader - The object whose handle count <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being incremented
00926 
00927 Return Value:
00928 
00929     The pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> next free handle count entry within <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00930     handle database.
00931 
00932 --*/
00933 
00934 {
00935     <a class="code" href="../../d8/d5/struct__OBJECT__HEADER__HANDLE__INFO.html">POBJECT_HEADER_HANDLE_INFO</a> HandleInfo;
00936     <a class="code" href="../../d1/d5/struct__OBJECT__HANDLE__COUNT__DATABASE.html">POBJECT_HANDLE_COUNT_DATABASE</a> OldHandleCountDataBase;
00937     <a class="code" href="../../d1/d5/struct__OBJECT__HANDLE__COUNT__DATABASE.html">POBJECT_HANDLE_COUNT_DATABASE</a> NewHandleCountDataBase;
00938     <a class="code" href="../../d2/d5/struct__OBJECT__HANDLE__COUNT__ENTRY.html">POBJECT_HANDLE_COUNT_ENTRY</a> FreeHandleCountEntry;
00939     ULONG CountEntries;
00940     ULONG OldSize;
00941     ULONG NewSize;
00942     <a class="code" href="../../d1/d5/struct__OBJECT__HANDLE__COUNT__DATABASE.html">OBJECT_HANDLE_COUNT_DATABASE</a> SingleEntryDataBase;
00943 
00944     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00945 
00946     <span class="comment">//</span>
00947     <span class="comment">//  Check if the object has any handle information</span>
00948     <span class="comment">//</span>
00949 
00950     HandleInfo = <a class="code" href="../../d4/d0/ob_8h.html#a11">OBJECT_HEADER_TO_HANDLE_INFO</a>(ObjectHeader);
00951 
00952     <span class="keywordflow">if</span> (HandleInfo == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00953 
00954         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00955     }
00956 
00957     <span class="comment">//</span>
00958     <span class="comment">//  The object does have some handle information.  If it has</span>
00959     <span class="comment">//  a single handle entry then we'll construct a local dummy</span>
00960     <span class="comment">//  handle count database and come up with a new data base for</span>
00961     <span class="comment">//  storing two entries.</span>
00962     <span class="comment">//</span>
00963 
00964     <span class="keywordflow">if</span> (ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o7">Flags</a> &amp; <a class="code" href="../../d4/d0/ob_8h.html#a7">OB_FLAG_SINGLE_HANDLE_ENTRY</a>) {
00965 
00966         SingleEntryDataBase.<a class="code" href="../../d1/d5/struct__OBJECT__HANDLE__COUNT__DATABASE.html#o0">CountEntries</a> = 1;
00967         SingleEntryDataBase.<a class="code" href="../../d1/d5/struct__OBJECT__HANDLE__COUNT__DATABASE.html#o1">HandleCountEntries</a>[0] = HandleInfo-&gt;<a class="code" href="../../d8/d5/struct__OBJECT__HEADER__HANDLE__INFO.html#o1">SingleEntry</a>;
00968 
00969         OldHandleCountDataBase = &amp;SingleEntryDataBase;
00970 
00971         OldSize = <span class="keyword">sizeof</span>( SingleEntryDataBase );
00972 
00973         CountEntries = 2;
00974 
00975         NewSize = <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d5/struct__OBJECT__HANDLE__COUNT__DATABASE.html">OBJECT_HANDLE_COUNT_DATABASE</a>) +
00976                ((CountEntries - 1) * <span class="keyword">sizeof</span>( <a class="code" href="../../d2/d5/struct__OBJECT__HANDLE__COUNT__ENTRY.html">OBJECT_HANDLE_COUNT_ENTRY</a> ));
00977 
00978     } <span class="keywordflow">else</span> {
00979 
00980         <span class="comment">//</span>
00981         <span class="comment">//  The object already has multiple handles so we reference the</span>
00982         <span class="comment">//  current handle database, and compute a new size bumped by four</span>
00983         <span class="comment">//</span>
00984 
00985         OldHandleCountDataBase = HandleInfo-&gt;<a class="code" href="../../d8/d5/struct__OBJECT__HEADER__HANDLE__INFO.html#o0">HandleCountDataBase</a>;
00986 
00987         CountEntries = OldHandleCountDataBase-&gt;<a class="code" href="../../d1/d5/struct__OBJECT__HANDLE__COUNT__DATABASE.html#o0">CountEntries</a>;
00988 
00989         OldSize = <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d5/struct__OBJECT__HANDLE__COUNT__DATABASE.html">OBJECT_HANDLE_COUNT_DATABASE</a>) +
00990                ((CountEntries - 1) * <span class="keyword">sizeof</span>( <a class="code" href="../../d2/d5/struct__OBJECT__HANDLE__COUNT__ENTRY.html">OBJECT_HANDLE_COUNT_ENTRY</a>));
00991 
00992         CountEntries += 4;
00993 
00994         NewSize = <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d5/struct__OBJECT__HANDLE__COUNT__DATABASE.html">OBJECT_HANDLE_COUNT_DATABASE</a>) +
00995                ((CountEntries - 1) * <span class="keyword">sizeof</span>( <a class="code" href="../../d2/d5/struct__OBJECT__HANDLE__COUNT__ENTRY.html">OBJECT_HANDLE_COUNT_ENTRY</a>));
00996     }
00997 
00998     <span class="comment">//</span>
00999     <span class="comment">//  Now allocate pool for the new handle database.</span>
01000     <span class="comment">//</span>
01001 
01002     NewHandleCountDataBase = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(PagedPool, NewSize,'dHbO');
01003 
01004     <span class="keywordflow">if</span> (NewHandleCountDataBase == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01005 
01006         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01007     }
01008 
01009     <span class="comment">//</span>
01010     <span class="comment">//  Copy over the old database.  Note that this might just copy our</span>
01011     <span class="comment">//  local dummy entry for the single entry case</span>
01012     <span class="comment">//</span>
01013 
01014     RtlMoveMemory(NewHandleCountDataBase, OldHandleCountDataBase, OldSize);
01015 
01016     <span class="comment">//</span>
01017     <span class="comment">//  If the previous mode was a single entry then remove that</span>
01018     <span class="comment">//  indication otherwise free up with previous handle database</span>
01019     <span class="comment">//</span>
01020 
01021     <span class="keywordflow">if</span> (ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o7">Flags</a> &amp; <a class="code" href="../../d4/d0/ob_8h.html#a7">OB_FLAG_SINGLE_HANDLE_ENTRY</a>) {
01022 
01023         ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o7">Flags</a> &amp;= ~<a class="code" href="../../d4/d0/ob_8h.html#a7">OB_FLAG_SINGLE_HANDLE_ENTRY</a>;
01024 
01025     } <span class="keywordflow">else</span> {
01026 
01027         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( OldHandleCountDataBase );
01028     }
01029 
01030     <span class="comment">//</span>
01031     <span class="comment">//  Find the end of the new database that is used and zero out</span>
01032     <span class="comment">//  the memory</span>
01033     <span class="comment">//</span>
01034 
01035     FreeHandleCountEntry =
01036         (<a class="code" href="../../d2/d5/struct__OBJECT__HANDLE__COUNT__ENTRY.html">POBJECT_HANDLE_COUNT_ENTRY</a>)((PCHAR)NewHandleCountDataBase + OldSize);
01037 
01038     RtlZeroMemory(FreeHandleCountEntry, NewSize - OldSize);
01039 
01040     <span class="comment">//</span>
01041     <span class="comment">//  Set the new database to the proper entry count and put it</span>
01042     <span class="comment">//  all in the object</span>
01043     <span class="comment">//</span>
01044 
01045     NewHandleCountDataBase-&gt;<a class="code" href="../../d1/d5/struct__OBJECT__HANDLE__COUNT__DATABASE.html#o0">CountEntries</a> = CountEntries;
01046 
01047     HandleInfo-&gt;<a class="code" href="../../d8/d5/struct__OBJECT__HEADER__HANDLE__INFO.html#o0">HandleCountDataBase</a> = NewHandleCountDataBase;
01048 
01049     <span class="comment">//</span>
01050     <span class="comment">//  And return to our caller</span>
01051     <span class="comment">//</span>
01052 
01053     <span class="keywordflow">return</span> FreeHandleCountEntry;
01054 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a90" doxytag="obp.h::ObpLogSecurityDescriptor" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS ObpLogSecurityDescriptor           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PSECURITY_DESCRIPTOR&nbsp;</td>
          <td class="mdname" nowrap> <em>InputSecurityDescriptor</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PSECURITY_DESCRIPTOR *&nbsp;</td>
          <td class="mdname" nowrap> <em>OutputSecurityDescriptor</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d0/obsdata_8c-source.html#l00297">297</a> of file <a class="el" href="../../d9/d0/obsdata_8c-source.html">obsdata.c</a>.
<p>
References <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d4/d2/dumpuser_8c-source.html#l00048">Header</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00300">_SECURITY_DESCRIPTOR_HEADER::Link</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00318">LINK_TO_SD_HEADER</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d9/d0/obsdata_8c-source.html#l00886">ObpAcquireDescriptorCacheWriteLock()</a>, <a class="el" href="../../d9/d0/obsdata_8c-source.html#l00839">ObpCompareSecurityDescriptors()</a>, <a class="el" href="../../d9/d0/obsdata_8c-source.html#l00491">ObpCreateCacheEntry()</a>, <a class="el" href="../../d9/d0/obsdata_8c-source.html#l00182">ObpHashSecurityDescriptor()</a>, <a class="el" href="../../d9/d0/obsdata_8c-source.html#l00942">ObpReleaseDescriptorCacheLock()</a>, <a class="el" href="../../d9/d0/obsdata_8c-source.html#l00064">ObPrint</a>, <a class="el" href="../../d9/d0/obsdata_8c-source.html#l00096">ObsSecurityDescriptorCache</a>, and <a class="el" href="../../d6/d0/obp_8h-source.html#l00303">_SECURITY_DESCRIPTOR_HEADER::SecurityDescriptor</a>.
<p>
Referenced by <a class="el" href="../../d0/d1/obse_8c-source.html#l01183">ObAssignObjectSecurityDescriptor()</a>, and <a class="el" href="../../d0/d1/obse_8c-source.html#l01748">ObSetSecurityDescriptorInfo()</a>.
<p>
<pre class="fragment"><div>00304                    :
00305 
00306     Takes a passed security descriptor and registers <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00307     security descriptor database.
00308 
00309 Arguments:
00310 
00311     InputSecurityDescriptor - The <span class="keyword">new</span> security descriptor to be logged into
00312         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> database. On a successful <span class="keywordflow">return</span> <span class="keyword">this</span> memory will have been
00313         freed back to <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a>.
00314 
00315     OutputSecurityDescriptor - Output security descriptor to be used by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00316         caller.
00317 
00318 Return Value:
00319 
00320     An appropriate status value
00321 
00322 --*/
00323 
00324 {
00325     ULONG FullHash;
00326     UCHAR  SmallHash;
00327     <a class="code" href="../../d9/d0/struct__SECURITY__DESCRIPTOR__HEADER.html">PSECURITY_DESCRIPTOR_HEADER</a> NewDescriptor;
00328     PLIST_ENTRY Front;
00329     PLIST_ENTRY Back;
00330     <a class="code" href="../../d9/d0/struct__SECURITY__DESCRIPTOR__HEADER.html">PSECURITY_DESCRIPTOR_HEADER</a> <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>;
00331     BOOLEAN Match;
00332 
00333     FullHash = <a class="code" href="../../d8/d1/obsdata_8c.html#a14">ObpHashSecurityDescriptor</a>( InputSecurityDescriptor );
00334     SmallHash = (UCHAR)FullHash;
00335 
00336     <span class="comment">//</span>
00337     <span class="comment">//  See if the entry matching SmallHash is in use.</span>
00338     <span class="comment">//  Lock the table first, unlock if if we don't need it.</span>
00339     <span class="comment">//</span>
00340 
00341     <a class="code" href="../../d8/d1/obsdata_8c.html#a23">ObpAcquireDescriptorCacheWriteLock</a>();
00342 
00343     Front = <a class="code" href="../../d8/d1/obsdata_8c.html#a11">ObsSecurityDescriptorCache</a>[SmallHash];
00344     Back  = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00345     Match = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00346 
00347     <span class="comment">//</span>
00348     <span class="comment">//  Zoom down the hash bucket looking for a full hash match</span>
00349     <span class="comment">//</span>
00350 
00351     <span class="keywordflow">while</span> ( Front != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00352 
00353         <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a> = <a class="code" href="../../d5/d1/obp_8h.html#a19">LINK_TO_SD_HEADER</a>( Front );
00354 
00355         <span class="comment">//</span>
00356         <span class="comment">//  **** is this test really right?  Is the full hash value really</span>
00357         <span class="comment">//  ordered like this?</span>
00358         <span class="comment">//</span>
00359 
00360         <span class="keywordflow">if</span> ( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FullHash &gt; FullHash ) {
00361 
00362             <span class="keywordflow">break</span>;
00363         }
00364 
00365         <span class="keywordflow">if</span> ( <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FullHash == FullHash ) {
00366 
00367             Match = <a class="code" href="../../d8/d1/obsdata_8c.html#a22">ObpCompareSecurityDescriptors</a>( InputSecurityDescriptor,
00368                                                    &amp;<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;SecurityDescriptor );
00369 
00370             <span class="keywordflow">if</span> ( Match ) {
00371 
00372                 <span class="keywordflow">break</span>;
00373             }
00374 
00375             <a class="code" href="../../d8/d1/obsdata_8c.html#a1">ObPrint</a>( SHOW_COLLISIONS,(<span class="stringliteral">"Got a collision on %d, no match\n"</span>,SmallHash));
00376         }
00377 
00378         Back = Front;
00379         Front = Front-&gt;Flink;
00380     }
00381 
00382     <span class="comment">//</span>
00383     <span class="comment">//  If we have a match then we'll get the caller to use the old</span>
00384     <span class="comment">//  cached descriptor, but bumping its ref count, freeing what</span>
00385     <span class="comment">//  the caller supplied and returning the old one to our caller</span>
00386     <span class="comment">//</span>
00387 
00388     <span class="keywordflow">if</span> ( Match ) {
00389 
00390         <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;RefCount++;
00391 
00392         <a class="code" href="../../d8/d1/obsdata_8c.html#a1">ObPrint</a>( SHOW_REFERENCES, (<span class="stringliteral">"Reference Hash = 0x%lX, New RefCount = %d\n"</span>,<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;FullHash,<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;RefCount));
00393 
00394         *OutputSecurityDescriptor = &amp;<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;SecurityDescriptor;
00395 
00396         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( InputSecurityDescriptor );
00397 
00398         <a class="code" href="../../d8/d1/obsdata_8c.html#a25">ObpReleaseDescriptorCacheLock</a>();
00399 
00400         <span class="keywordflow">return</span>( STATUS_SUCCESS );
00401     }
00402 
00403     <span class="comment">//</span>
00404     <span class="comment">//  Can't use an existing one, create a new entry</span>
00405     <span class="comment">//  and insert it into the list.</span>
00406     <span class="comment">//</span>
00407 
00408     NewDescriptor = <a class="code" href="../../d8/d1/obsdata_8c.html#a17">ObpCreateCacheEntry</a>( InputSecurityDescriptor,
00409                                          FullHash );
00410 
00411     <span class="keywordflow">if</span> ( NewDescriptor == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00412 
00413         <a class="code" href="../../d8/d1/obsdata_8c.html#a25">ObpReleaseDescriptorCacheLock</a>();
00414 
00415         <span class="keywordflow">return</span>( STATUS_INSUFFICIENT_RESOURCES );
00416     }
00417 
00418 <span class="preprocessor">#if OB_DIAGNOSTICS_ENABLED</span>
00419 <span class="preprocessor"></span>
00420     ObsTotalCacheEntries++;
00421 
00422 <span class="preprocessor">#endif</span>
00423 <span class="preprocessor"></span>
00424     <a class="code" href="../../d8/d1/obsdata_8c.html#a1">ObPrint</a>( SHOW_STATISTICS, (<span class="stringliteral">"ObsTotalCacheEntries = %d \n"</span>,ObsTotalCacheEntries));
00425     <a class="code" href="../../d8/d1/obsdata_8c.html#a1">ObPrint</a>( SHOW_COLLISIONS, (<span class="stringliteral">"Adding new entry for index #%d \n"</span>,SmallHash));
00426 
00427     <span class="comment">//</span>
00428     <span class="comment">//  We don't need the old security descriptor any more.</span>
00429     <span class="comment">//</span>
00430 
00431     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( InputSecurityDescriptor );
00432 
00433     <span class="comment">//</span>
00434     <span class="comment">//  The following logic inserts the new security descriptor into the</span>
00435     <span class="comment">//  small hash list.  We need to first decide if the we're adding</span>
00436     <span class="comment">//  the entry to the beginning of the list (back is null) or if we're</span>
00437     <span class="comment">//  further in the list.</span>
00438     <span class="comment">//</span>
00439     <span class="comment">//  **** This logic is plain bizzare because (1) the small hash</span>
00440     <span class="comment">//  should probably just be an array of list heads and not single</span>
00441     <span class="comment">//  pointer value and (2) the doubly linked list of security descriptors</span>
00442     <span class="comment">//  is not circular!  This should be fixed to use the regular set</span>
00443     <span class="comment">//  of link list macros</span>
00444     <span class="comment">//</span>
00445 
00446     <span class="keywordflow">if</span> ( Back == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00447 
00448         <span class="comment">//</span>
00449         <span class="comment">//  We're inserting at the beginning of the list for this</span>
00450         <span class="comment">//  minor index</span>
00451         <span class="comment">//</span>
00452 
00453         NewDescriptor-&gt;<a class="code" href="../../d9/d0/struct__SECURITY__DESCRIPTOR__HEADER.html#o0">Link</a>.Flink = <a class="code" href="../../d8/d1/obsdata_8c.html#a11">ObsSecurityDescriptorCache</a>[SmallHash];
00454         <a class="code" href="../../d8/d1/obsdata_8c.html#a11">ObsSecurityDescriptorCache</a>[SmallHash] = &amp;NewDescriptor-&gt;<a class="code" href="../../d9/d0/struct__SECURITY__DESCRIPTOR__HEADER.html#o0">Link</a>;
00455 
00456         <span class="keywordflow">if</span> ( NewDescriptor-&gt;<a class="code" href="../../d9/d0/struct__SECURITY__DESCRIPTOR__HEADER.html#o0">Link</a>.Flink != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00457 
00458             NewDescriptor-&gt;<a class="code" href="../../d9/d0/struct__SECURITY__DESCRIPTOR__HEADER.html#o0">Link</a>.Flink-&gt;Blink = &amp;NewDescriptor-&gt;<a class="code" href="../../d9/d0/struct__SECURITY__DESCRIPTOR__HEADER.html#o0">Link</a>;
00459         }
00460 
00461     } <span class="keywordflow">else</span> {
00462 
00463         <span class="comment">//</span>
00464         <span class="comment">//  Hook new descriptor entry into list.</span>
00465         <span class="comment">//</span>
00466 
00467         NewDescriptor-&gt;<a class="code" href="../../d9/d0/struct__SECURITY__DESCRIPTOR__HEADER.html#o0">Link</a>.Flink = Front;
00468 
00469         NewDescriptor-&gt;<a class="code" href="../../d9/d0/struct__SECURITY__DESCRIPTOR__HEADER.html#o0">Link</a>.Blink = Back;
00470 
00471         Back-&gt;Flink = &amp;NewDescriptor-&gt;<a class="code" href="../../d9/d0/struct__SECURITY__DESCRIPTOR__HEADER.html#o0">Link</a>;
00472 
00473         <span class="keywordflow">if</span> (Front != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00474 
00475             Front-&gt;Blink = &amp;NewDescriptor-&gt;<a class="code" href="../../d9/d0/struct__SECURITY__DESCRIPTOR__HEADER.html#o0">Link</a>;
00476         }
00477     }
00478 
00479     <span class="comment">//</span>
00480     <span class="comment">//  Set the output security descriptor and return to our caller</span>
00481     <span class="comment">//</span>
00482 
00483     *OutputSecurityDescriptor = &amp;NewDescriptor-&gt;<a class="code" href="../../d9/d0/struct__SECURITY__DESCRIPTOR__HEADER.html#o3">SecurityDescriptor</a>;
00484     <a class="code" href="../../d8/d1/obsdata_8c.html#a25">ObpReleaseDescriptorCacheLock</a>();
00485 
00486     <span class="keywordflow">return</span>( STATUS_SUCCESS );
00487 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a68" doxytag="obp.h::ObpLookupDirectoryEntry" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PVOID ObpLookupDirectoryEntry           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__OBJECT__DIRECTORY.html">POBJECT_DIRECTORY</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Directory</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>Name</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Attributes</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d9/obdir_8c-source.html#l00705">705</a> of file <a class="el" href="../../d9/d9/obdir_8c-source.html">obdir.c</a>.
<p>
References <a class="el" href="../../d7/d1/rtqkey_8c-source.html#l00042">Buffer</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00220">_OBJECT_DIRECTORY_ENTRY::ChainLink</a>, <a class="el" href="../../d3/d4/editreg_8c-source.html#l00903">Directory()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00332">_OBJECT_HEADER_NAME_INFO::Name</a>, <a class="el" href="../../d9/d9/geninst_8c-source.html#l00154">Name</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00206">NUMBER_HASH_BUCKETS</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00221">_OBJECT_DIRECTORY_ENTRY::Object</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00368">OBJECT_HEADER_TO_NAME_INFO</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00355">OBJECT_TO_OBJECT_HEADER</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01608">RtlEqualUnicodeString()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01178">RtlUpcaseUnicodeChar()</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d1/d1/obtype_8c-source.html#l00069">ObCreateObjectType()</a>, <a class="el" href="../../d1/d0/obinit_8c-source.html#l00117">ObInitSystem()</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l01497">ObpDeleteNameCheck()</a>, <a class="el" href="../../d9/d9/obdir_8c-source.html#l01081">ObpLookupObjectName()</a>, and <a class="el" href="../../d5/d0/oblink_8c-source.html#l01121">ObpProcessDosDeviceSymbolicLink()</a>.
<p>
<pre class="fragment"><div>00713                    :
00714 
00715     This routine will lookup a single directory entry in a given directory.
00716 
00717     I believe <span class="keyword">this</span> routine assumes that <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> root directory
00718     locked.
00719 
00720     Also note that <span class="keyword">this</span> routine does not reference <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> returned object
00721 
00722 Arguments:
00723 
00724     <a class="code" href="../../d2/d5/editreg_8c.html#a68">Directory</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> directory being searched
00725 
00726     <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of entry we're looking <span class="keywordflow">for</span>
00727 
00728     Attributes - Indicates <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> lookup should be <span class="keywordflow">case</span> insensitive
00729         or not
00730 
00731 Return Value:
00732 
00733     Returns a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> corresponding object body <span class="keywordflow">if</span> found and <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00734     otherwise.
00735 
00736 --*/
00737 
00738 {
00739     <a class="code" href="../../d9/d4/struct__OBJECT__DIRECTORY__ENTRY.html">POBJECT_DIRECTORY_ENTRY</a> *HeadDirectoryEntry;
00740     <a class="code" href="../../d9/d4/struct__OBJECT__DIRECTORY__ENTRY.html">POBJECT_DIRECTORY_ENTRY</a> DirectoryEntry;
00741     <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> ObjectHeader;
00742     <a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html">POBJECT_HEADER_NAME_INFO</a> NameInfo;
00743     PWCH <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
00744     WCHAR Wchar;
00745     ULONG HashIndex;
00746     ULONG WcharLength;
00747     BOOLEAN CaseInSensitive;
00748 
00749     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00750 
00751     <span class="comment">//</span>
00752     <span class="comment">//  The caller needs to specify both a directory and a name otherwise</span>
00753     <span class="comment">//  we can't process the request</span>
00754     <span class="comment">//</span>
00755 
00756     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d5/editreg_8c.html#a68">Directory</a> || !<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>) {
00757 
00758         <span class="keywordflow">return</span>( <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ); <span class="comment">// BUG BUG</span>
00759     }
00760 
00761     <span class="comment">//</span>
00762     <span class="comment">//  Set a local variable to tell us if the search is case sensitive</span>
00763     <span class="comment">//</span>
00764 
00765     <span class="keywordflow">if</span> (Attributes &amp; OBJ_CASE_INSENSITIVE) {
00766 
00767         CaseInSensitive = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00768 
00769     } <span class="keywordflow">else</span> {
00770 
00771         CaseInSensitive = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00772     }
00773 
00774     <span class="comment">//</span>
00775     <span class="comment">//  Establish our local pointer to the input name buffer and get the</span>
00776     <span class="comment">//  number of unicode characters in the input name.  Also make sure</span>
00777     <span class="comment">//  the caller gave us a non null name</span>
00778     <span class="comment">//</span>
00779 
00780     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Buffer;
00781     WcharLength = <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Length / <span class="keyword">sizeof</span>( *Buffer );
00782 
00783     <span class="keywordflow">if</span> (!WcharLength || !<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>) {
00784 
00785         <span class="keywordflow">return</span>( <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ); <span class="comment">// BUG BUG</span>
00786     }
00787 
00788     <span class="comment">//</span>
00789     <span class="comment">//  Compute the address of the head of the bucket chain for this name.</span>
00790     <span class="comment">//</span>
00791 
00792     HashIndex = 0;
00793     <span class="keywordflow">while</span> (WcharLength--) {
00794 
00795         Wchar = *<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>++;
00796         HashIndex += (HashIndex &lt;&lt; 1) + (HashIndex &gt;&gt; 1);
00797 
00798         <span class="keywordflow">if</span> (Wchar &lt; <span class="charliteral">'a'</span>) {
00799 
00800             HashIndex += Wchar;
00801 
00802         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Wchar &gt; <span class="charliteral">'z'</span>) {
00803 
00804             HashIndex += <a class="code" href="../../d6/d6/nls_8c.html#a33">RtlUpcaseUnicodeChar</a>( Wchar );
00805 
00806         } <span class="keywordflow">else</span> {
00807 
00808             HashIndex += (Wchar - (<span class="charliteral">'a'</span>-<span class="charliteral">'A'</span>));
00809         }
00810     }
00811 
00812     HashIndex %= <a class="code" href="../../d4/d0/ob_8h.html#a0">NUMBER_HASH_BUCKETS</a>;
00813 
00814     HeadDirectoryEntry = (<a class="code" href="../../d9/d4/struct__OBJECT__DIRECTORY__ENTRY.html">POBJECT_DIRECTORY_ENTRY</a> *)&amp;<a class="code" href="../../d2/d5/editreg_8c.html#a68">Directory</a>-&gt;HashBuckets[ HashIndex ];
00815 
00816     <a class="code" href="../../d2/d5/editreg_8c.html#a68">Directory</a>-&gt;LookupBucket = HeadDirectoryEntry;
00817 
00818     <span class="comment">//</span>
00819     <span class="comment">//  Walk the chain of directory entries for this hash bucket, looking</span>
00820     <span class="comment">//  for either a match, or the insertion point if no match in the chain.</span>
00821     <span class="comment">//</span>
00822 
00823     <span class="keywordflow">while</span> ((DirectoryEntry = *HeadDirectoryEntry) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00824 
00825         <span class="comment">//</span>
00826         <span class="comment">//  Get the object header and name from the object body</span>
00827         <span class="comment">//</span>
00828         <span class="comment">//  This function assumes the name must exist, otherwise it</span>
00829         <span class="comment">//  wouldn't be in a directory</span>
00830         <span class="comment">//</span>
00831 
00832         ObjectHeader = <a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>( DirectoryEntry-&gt;<a class="code" href="../../d9/d4/struct__OBJECT__DIRECTORY__ENTRY.html#o1">Object</a> );
00833         NameInfo = <a class="code" href="../../d4/d0/ob_8h.html#a12">OBJECT_HEADER_TO_NAME_INFO</a>( ObjectHeader );
00834 
00835         <span class="comment">//</span>
00836         <span class="comment">//  Compare strings using appropriate function.</span>
00837         <span class="comment">//</span>
00838 
00839         <span class="keywordflow">if</span> ((<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Length == NameInfo-&gt;<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html#o1">Name</a>.Length) &amp;&amp;
00840             <a class="code" href="../../d6/d6/nls_8c.html#a42">RtlEqualUnicodeString</a>( Name,
00841                                    &amp;NameInfo-&gt;<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html#o1">Name</a>,
00842                                    CaseInSensitive )) {
00843 
00844             <span class="comment">//</span>
00845             <span class="comment">//  If name matches, then exit loop with DirectoryEntry</span>
00846             <span class="comment">//  pointing to matching entry.</span>
00847             <span class="comment">//</span>
00848 
00849             <span class="keywordflow">break</span>;
00850         }
00851 
00852         HeadDirectoryEntry = &amp;DirectoryEntry-&gt;<a class="code" href="../../d9/d4/struct__OBJECT__DIRECTORY__ENTRY.html#o0">ChainLink</a>;
00853     }
00854 
00855     <span class="comment">//</span>
00856     <span class="comment">//  At this point, there are two possiblilities:</span>
00857     <span class="comment">//</span>
00858     <span class="comment">//   - we found an entry that matched and DirectoryEntry points to that</span>
00859     <span class="comment">//     entry.  Update the bucket chain so that the entry found is at the</span>
00860     <span class="comment">//     head of the bucket chain.  This is so the ObpDeleteDirectoryEntry</span>
00861     <span class="comment">//     and ObpInsertDirectoryEntry functions will work.  Also repeated</span>
00862     <span class="comment">//     lookups of the same name will succeed quickly.</span>
00863     <span class="comment">//</span>
00864     <span class="comment">//   - we did not find an entry that matched and DirectoryEntry is NULL.</span>
00865     <span class="comment">//</span>
00866 
00867     <span class="keywordflow">if</span> (DirectoryEntry) {
00868 
00869         <a class="code" href="../../d2/d5/editreg_8c.html#a68">Directory</a>-&gt;LookupFound = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00870 
00871         <span class="comment">//</span>
00872         <span class="comment">//  The following convoluted piece of code moves a directory entry</span>
00873         <span class="comment">//  we've found to the front of the hash list.</span>
00874         <span class="comment">//</span>
00875 
00876         <span class="keywordflow">if</span> (HeadDirectoryEntry != <a class="code" href="../../d2/d5/editreg_8c.html#a68">Directory</a>-&gt;LookupBucket) {
00877 
00878             *HeadDirectoryEntry = DirectoryEntry-&gt;<a class="code" href="../../d9/d4/struct__OBJECT__DIRECTORY__ENTRY.html#o0">ChainLink</a>;
00879             DirectoryEntry-&gt;<a class="code" href="../../d9/d4/struct__OBJECT__DIRECTORY__ENTRY.html#o0">ChainLink</a> = *(<a class="code" href="../../d2/d5/editreg_8c.html#a68">Directory</a>-&gt;LookupBucket);
00880             *(<a class="code" href="../../d2/d5/editreg_8c.html#a68">Directory</a>-&gt;LookupBucket) = DirectoryEntry;
00881         }
00882 
00883         <span class="comment">//</span>
00884         <span class="comment">//  Now return the object to our caller</span>
00885         <span class="comment">//</span>
00886 
00887         <span class="keywordflow">return</span>( DirectoryEntry-&gt;<a class="code" href="../../d9/d4/struct__OBJECT__DIRECTORY__ENTRY.html#o1">Object</a> );
00888 
00889     } <span class="keywordflow">else</span> {
00890 
00891         <span class="comment">//</span>
00892         <span class="comment">//  Otherwise we didn't find anything so return null</span>
00893         <span class="comment">//</span>
00894 
00895         <a class="code" href="../../d2/d5/editreg_8c.html#a68">Directory</a>-&gt;LookupFound = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00896 
00897         <span class="keywordflow">return</span>( <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00898     }
00899 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a71" doxytag="obp.h::ObpLookupObjectName" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS ObpLookupObjectName           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>RootDirectoryHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Attributes</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessMode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID ParseContext&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSECURITY_QUALITY_OF_SERVICE <a class="el" href="../../d8/d0/ctlpcqos_8c.html#a9">SecurityQos</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID InsertObject&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT <a class="el" href="../../d2/d5/struct__ACCESS__STATE.html">PACCESS_STATE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessState</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PBOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>DirectoryLocked</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>FoundObject</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d9/obdir_8c-source.html#l01081">1081</a> of file <a class="el" href="../../d9/d9/obdir_8c-source.html">obdir.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00313">_OBJECT_HEADER::Body</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00213">_OBJECT_DIRECTORY::DeviceMap</a>, <a class="el" href="../../d3/d4/editreg_8c-source.html#l00903">Directory()</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00244">_DEVICE_MAP::DosDevicesDirectory</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d7/fssup_8c-source.html#l00044">IoFileObjectType</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00332">_OBJECT_HEADER_NAME_INFO::Name</a>, <a class="el" href="../../d0/d2/rtreplac_8c-source.html#l00045">NewName</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00107">OB_PARSE_METHOD</a>, <a class="el" href="../../d0/d1/obse_8c-source.html#l00983">ObCheckCreateObjectAccess()</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00368">OBJECT_HEADER_TO_NAME_INFO</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00355">OBJECT_TO_OBJECT_HEADER</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00056">ObpBeginTypeSpecificCallOut</a>, <a class="el" href="../../d0/d1/obse_8c-source.html#l00778">ObpCheckTraverseAccess()</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00098">ObpDeviceMapLock</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00367">ObpDirectoryObjectType</a>, <a class="el" href="../../d1/d0/obinit_8c-source.html#l00110">ObpDosDevicesShortName</a>, <a class="el" href="../../d1/d0/obinit_8c-source.html#l00111">ObpDosDevicesShortNamePrefix</a>, <a class="el" href="../../d1/d0/obinit_8c-source.html#l00112">ObpDosDevicesShortNameRoot</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00057">ObpEndTypeSpecificCallOut</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00189">ObpEnterRootDirectoryMutex</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00143">ObpIncrPointerCount</a>, <a class="el" href="../../d9/d9/obdir_8c-source.html#l00903">ObpInsertDirectoryEntry()</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00202">ObpLeaveRootDirectoryMutex</a>, <a class="el" href="../../d9/d9/obdir_8c-source.html#l00705">ObpLookupDirectoryEntry()</a>, <a class="el" href="../../d5/d0/oblink_8c-source.html#l00501">ObpParseSymbolicLink()</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00046">ObpRootDirectoryObject</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00071">ObpValidateIrql</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00514">ObReferenceObject</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l01022">ObReferenceObjectByPointer()</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00180">_OBJECT_TYPE_INITIALIZER::ParseProcedure</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00243">_DEVICE_MAP::ReferenceCount</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00037">SecurityQos</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l00072">TOKEN_HAS_TRAVERSE_PRIVILEGE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00302">_OBJECT_HEADER::Type</a>, and <a class="el" href="../../d5/d9/ob_8h-source.html#l00196">_OBJECT_TYPE::TypeInfo</a>.
<p>
Referenced by <a class="el" href="../../d2/d0/obinsert_8c-source.html#l00029">ObInsertObject()</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00095">ObOpenObjectByName()</a>, and <a class="el" href="../../d8/d0/obref_8c-source.html#l00844">ObReferenceObjectByName()</a>.
<p>
<pre class="fragment"><div>01097                    :
01098 
01099     This function will search a given directoroy <span class="keywordflow">for</span> a specified
01100     object name.  It will also create a <span class="keyword">new</span> object specified by
01101     InsertObject.
01102 
01103 Arguments:
01104 
01105     RootDirectoryHandle - Optionally supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> directory being
01106         searched.  If not supplied then <span class="keyword">this</span> routine searches
01107         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> root directory
01108 
01109     ObjectName - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of object to lookup
01110 
01111     Attributes - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> attributes <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> lookup (e.g., <span class="keywordflow">case</span>
01112         insensitive)
01113 
01114     ObjectType - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object to lookup
01115 
01116     AccessMode - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> callers processor mode
01117 
01118     ParseContext - Optionally supplies a parse context that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> blindly
01119         passed to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> parse callback <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a24">routines</a>
01120 
01121     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a14">SecurityQos</a> - Optionally supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> passed Security
01122         Quality of Service parameter that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> blindly passed to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> parse
01123         callback <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a24">routines</a>
01124 
01125     InsertObject - Optionally supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object we think will be found.
01126         This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller did not give a root directory handle
01127         and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object name <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <span class="stringliteral">"\" and the root object directory hasn't</span>
01128 <span class="stringliteral">        been created yet.  In other cases where we wind up creating</span>
01129 <span class="stringliteral">        a new directory entry this is the object inserted.</span>
01130 <span class="stringliteral"></span>
01131 <span class="stringliteral">    AccessState - Current access state, describing already granted access</span>
01132 <span class="stringliteral">        types, the privileges used to get them, and any access types yet to</span>
01133 <span class="stringliteral">        be granted.  The access masks may not contain any generic access</span>
01134 <span class="stringliteral">        types.</span>
01135 <span class="stringliteral"></span>
01136 <span class="stringliteral">    DirectoryLocked - Receives an indication if this routine has returned</span>
01137 <span class="stringliteral">        with the input directory locked</span>
01138 <span class="stringliteral"></span>
01139 <span class="stringliteral">    FoundObject - Receives a pointer to the object body if found</span>
01140 <span class="stringliteral"></span>
01141 <span class="stringliteral">Return Value:</span>
01142 <span class="stringliteral"></span>
01143 <span class="stringliteral">    An appropriate status value</span>
01144 <span class="stringliteral"></span>
01145 <span class="stringliteral">--*/</span>
01146 <span class="stringliteral"></span>
01147 <span class="stringliteral">{</span>
01148 <span class="stringliteral">    POBJECT_DIRECTORY RootDirectory;</span>
01149 <span class="stringliteral">    POBJECT_DIRECTORY Directory;</span>
01150 <span class="stringliteral">    POBJECT_DIRECTORY ParentDirectory = NULL;</span>
01151 <span class="stringliteral">    POBJECT_HEADER ObjectHeader;</span>
01152 <span class="stringliteral">    POBJECT_HEADER_NAME_INFO NameInfo;</span>
01153 <span class="stringliteral">    PDEVICE_MAP DeviceMap = NULL;</span>
01154 <span class="stringliteral">    PVOID Object;</span>
01155 <span class="stringliteral">    UNICODE_STRING RemainingName;</span>
01156 <span class="stringliteral">    UNICODE_STRING ComponentName;</span>
01157 <span class="stringliteral">    PWCH NewName;</span>
01158 <span class="stringliteral">    NTSTATUS Status;</span>
01159 <span class="stringliteral">    BOOLEAN Reparse;</span>
01160 <span class="stringliteral">    ULONG MaxReparse = OBJ_MAX_REPARSE_ATTEMPTS;</span>
01161 <span class="stringliteral">    OB_PARSE_METHOD ParseProcedure;</span>
01162 <span class="stringliteral">    extern POBJECT_TYPE IoFileObjectType;</span>
01163 <span class="stringliteral"></span>
01164 <span class="stringliteral">    ObpValidateIrql( "</span><a class="code" href="../../d8/d0/obdir_8c.html#a6">ObpLookupObjectName</a><span class="stringliteral">" );</span>
01165 <span class="stringliteral"></span>
01166 <span class="stringliteral">    //</span>
01167 <span class="stringliteral">    //  Initialize our output variables to say we haven't lock or found</span>
01168 <span class="stringliteral">    //  anything but we were successful at it</span>
01169 <span class="stringliteral">    //</span>
01170 <span class="stringliteral"></span>
01171 <span class="stringliteral">    *DirectoryLocked = FALSE;</span>
01172 <span class="stringliteral">    *FoundObject = NULL;</span>
01173 <span class="stringliteral">    Status = STATUS_SUCCESS;</span>
01174 <span class="stringliteral"></span>
01175 <span class="stringliteral">    Object = NULL;</span>
01176 <span class="stringliteral"></span>
01177 <span class="stringliteral">    //</span>
01178 <span class="stringliteral">    //  Check if the caller has given us a directory to search.  Otherwise</span>
01179 <span class="stringliteral">    //  we'll search the root object directory</span>
01180 <span class="stringliteral">    //</span>
01181 <span class="stringliteral"></span>
01182 <span class="stringliteral">    if (ARGUMENT_PRESENT( RootDirectoryHandle )) {</span>
01183 <span class="stringliteral"></span>
01184 <span class="stringliteral">        //</span>
01185 <span class="stringliteral">        //  Otherwise reference the directory object and make sure</span>
01186 <span class="stringliteral">        //  that we successfully got the object</span>
01187 <span class="stringliteral">        //</span>
01188 <span class="stringliteral"></span>
01189 <span class="stringliteral">        Status = ObReferenceObjectByHandle( RootDirectoryHandle,</span>
01190 <span class="stringliteral">                                            0,</span>
01191 <span class="stringliteral">                                            NULL,</span>
01192 <span class="stringliteral">                                            AccessMode,</span>
01193 <span class="stringliteral">                                            (PVOID *)&amp;RootDirectory,</span>
01194 <span class="stringliteral">                                            NULL );</span>
01195 <span class="stringliteral"></span>
01196 <span class="stringliteral">        if (!NT_SUCCESS( Status )) {</span>
01197 <span class="stringliteral"></span>
01198 <span class="stringliteral">            return( Status );</span>
01199 <span class="stringliteral">        }</span>
01200 <span class="stringliteral"></span>
01201 <span class="stringliteral">        //</span>
01202 <span class="stringliteral">        //  Translate the directory object to its object header</span>
01203 <span class="stringliteral">        //</span>
01204 <span class="stringliteral"></span>
01205 <span class="stringliteral">        ObjectHeader = OBJECT_TO_OBJECT_HEADER( RootDirectory );</span>
01206 <span class="stringliteral"></span>
01207 <span class="stringliteral">        //</span>
01208 <span class="stringliteral">        //  Now if the name we're looking up starts with a "</span>\<span class="stringliteral">" and it</span>
01209 <span class="stringliteral">        //  does not have a parse procedure then the syntax is bad</span>
01210 <span class="stringliteral">        //</span>
01211 <span class="stringliteral"></span>
01212 <span class="stringliteral">        if ((ObjectName-&gt;Buffer != NULL) &amp;&amp;</span>
01213 <span class="stringliteral">            (*(ObjectName-&gt;Buffer) == OBJ_NAME_PATH_SEPARATOR) &amp;&amp;</span>
01214 <span class="stringliteral">            (ObjectHeader-&gt;Type != IoFileObjectType)) {</span>
01215 <span class="stringliteral"></span>
01216 <span class="stringliteral">            ObDereferenceObject( RootDirectory );</span>
01217 <span class="stringliteral"></span>
01218 <span class="stringliteral">            return( STATUS_OBJECT_PATH_SYNTAX_BAD );</span>
01219 <span class="stringliteral">        }</span>
01220 <span class="stringliteral"></span>
01221 <span class="stringliteral">        //</span>
01222 <span class="stringliteral">        //  Now make sure that we do not have the directory of the</span>
01223 <span class="stringliteral">        //  object types</span>
01224 <span class="stringliteral">        //</span>
01225 <span class="stringliteral"></span>
01226 <span class="stringliteral">        if (ObjectHeader-&gt;Type != ObpDirectoryObjectType) {</span>
01227 <span class="stringliteral"></span>
01228 <span class="stringliteral">            //</span>
01229 <span class="stringliteral">            //  We have an object directory that is not the object type</span>
01230 <span class="stringliteral">            //  directory.  So now if it doesn't have a parse routine</span>
01231 <span class="stringliteral">            //  then there is nothing we can</span>
01232 <span class="stringliteral">            //</span>
01233 <span class="stringliteral"></span>
01234 <span class="stringliteral">            if (ObjectHeader-&gt;Type-&gt;TypeInfo.ParseProcedure == NULL) {</span>
01235 <span class="stringliteral"></span>
01236 <span class="stringliteral">                ObDereferenceObject( RootDirectory );</span>
01237 <span class="stringliteral"></span>
01238 <span class="stringliteral">                return( STATUS_INVALID_HANDLE );</span>
01239 <span class="stringliteral"></span>
01240 <span class="stringliteral">            } else {</span>
01241 <span class="stringliteral"></span>
01242 <span class="stringliteral">                MaxReparse = OBJ_MAX_REPARSE_ATTEMPTS;</span>
01243 <span class="stringliteral"></span>
01244 <span class="stringliteral">                //</span>
01245 <span class="stringliteral">                //  The following loop cycles cycles through the various</span>
01246 <span class="stringliteral">                //  parse routine to we could encounter trying to resolve</span>
01247 <span class="stringliteral">                //  this name through symbolic links.</span>
01248 <span class="stringliteral">                //</span>
01249 <span class="stringliteral"></span>
01250 <span class="stringliteral">                while (TRUE) {</span>
01251 <span class="stringliteral"></span>
01252 <span class="stringliteral">                    KIRQL SaveIrql;</span>
01253 <span class="stringliteral"></span>
01254 <span class="stringliteral">                    RemainingName = *ObjectName;</span>
01255 <span class="stringliteral"></span>
01256 <span class="stringliteral">                    //</span>
01257 <span class="stringliteral">                    //  Invoke the callback routine to parse the remaining</span>
01258 <span class="stringliteral">                    //  object name</span>
01259 <span class="stringliteral">                    //</span>
01260 <span class="stringliteral"></span>
01261 <span class="stringliteral">                    ObpBeginTypeSpecificCallOut( SaveIrql );</span>
01262 <span class="stringliteral"></span>
01263 <span class="stringliteral">                    Status = (*ObjectHeader-&gt;Type-&gt;TypeInfo.ParseProcedure)( RootDirectory,</span>
01264 <span class="stringliteral">                                                                             ObjectType,</span>
01265 <span class="stringliteral">                                                                             AccessState,</span>
01266 <span class="stringliteral">                                                                             AccessMode,</span>
01267 <span class="stringliteral">                                                                             Attributes,</span>
01268 <span class="stringliteral">                                                                             ObjectName,</span>
01269 <span class="stringliteral">                                                                             &amp;RemainingName,</span>
01270 <span class="stringliteral">                                                                             ParseContext,</span>
01271 <span class="stringliteral">                                                                             SecurityQos,</span>
01272 <span class="stringliteral">                                                                             &amp;Object );</span>
01273 <span class="stringliteral"></span>
01274 <span class="stringliteral">                    ObpEndTypeSpecificCallOut( SaveIrql, "</span>Parse<span class="stringliteral">", ObjectHeader-&gt;Type, Object );</span>
01275 <span class="stringliteral"></span>
01276 <span class="stringliteral">                    //</span>
01277 <span class="stringliteral">                    //  If the status was not to do a reparse and the lookup</span>
01278 <span class="stringliteral">                    //  was not successful then we found nothing so we</span>
01279 <span class="stringliteral">                    //  dereference the directory and return the status to</span>
01280 <span class="stringliteral">                    //  our caller.  If the object we got back was null then</span>
01281 <span class="stringliteral">                    //  we'll tell our caller that we couldn't find the name.</span>
01282 <span class="stringliteral">                    //  Lastly if we did not get a reparse and we were</span>
01283 <span class="stringliteral">                    //  successful and the object is not null then everything</span>
01284 <span class="stringliteral">                    //  gets nicely returned to our caller</span>
01285 <span class="stringliteral">                    //</span>
01286 <span class="stringliteral"></span>
01287 <span class="stringliteral">                    if ( ( Status != STATUS_REPARSE ) &amp;&amp; </span>
01288 <span class="stringliteral">                         ( Status != STATUS_REPARSE_OBJECT )) {</span>
01289 <span class="stringliteral"></span>
01290 <span class="stringliteral">                        if (!NT_SUCCESS( Status )) {</span>
01291 <span class="stringliteral"></span>
01292 <span class="stringliteral">                            Object = NULL;</span>
01293 <span class="stringliteral"></span>
01294 <span class="stringliteral">                        } else if (Object == NULL) {</span>
01295 <span class="stringliteral"></span>
01296 <span class="stringliteral">                            Status = STATUS_OBJECT_NAME_NOT_FOUND;</span>
01297 <span class="stringliteral">                        }</span>
01298 <span class="stringliteral">    </span>
01299 <span class="stringliteral">                        ObDereferenceObject( RootDirectory );</span>
01300 <span class="stringliteral"></span>
01301 <span class="stringliteral">                        *FoundObject = Object;</span>
01302 <span class="stringliteral">                        </span>
01303 <span class="stringliteral">                        return( Status );</span>
01304 <span class="stringliteral"></span>
01305 <span class="stringliteral">                    //</span>
01306 <span class="stringliteral">                    //  We got a status reparse, which means the object</span>
01307 <span class="stringliteral">                    //  name has been modified to have use start all over</span>
01308 <span class="stringliteral">                    //  again.  If the reparse target is now empty or it</span>
01309 <span class="stringliteral">                    //  is a path separator then we start the parse at the</span>
01310 <span class="stringliteral">                    //  root directory</span>
01311 <span class="stringliteral">                    //</span>
01312 <span class="stringliteral"></span>
01313 <span class="stringliteral">                    } else if ((ObjectName-&gt;Length == 0) ||</span>
01314 <span class="stringliteral">                               (ObjectName-&gt;Buffer == NULL) ||</span>
01315 <span class="stringliteral">                               (*(ObjectName-&gt;Buffer) == OBJ_NAME_PATH_SEPARATOR)) {</span>
01316 <span class="stringliteral"></span>
01317 <span class="stringliteral">                        //</span>
01318 <span class="stringliteral">                        //  Restart the parse relative to the root directory.</span>
01319 <span class="stringliteral">                        //</span>
01320 <span class="stringliteral"></span>
01321 <span class="stringliteral">                        ObDereferenceObject( RootDirectory );</span>
01322 <span class="stringliteral"></span>
01323 <span class="stringliteral">                        RootDirectory = ObpRootDirectoryObject;</span>
01324 <span class="stringliteral">                        RootDirectoryHandle = NULL;</span>
01325 <span class="stringliteral"></span>
01326 <span class="stringliteral">                        break;</span>
01327 <span class="stringliteral"></span>
01328 <span class="stringliteral">                    //</span>
01329 <span class="stringliteral">                    //  We got a reparse and we actually have a new name to</span>
01330 <span class="stringliteral">                    //  go to we if we haven't exhausted our reparse attempts</span>
01331 <span class="stringliteral">                    //  yet then just continue to the top of this loop.</span>
01332 <span class="stringliteral">                    //</span>
01333 <span class="stringliteral"></span>
01334 <span class="stringliteral">                    } else if (--MaxReparse) {</span>
01335 <span class="stringliteral"></span>
01336 <span class="stringliteral">                        continue;</span>
01337 <span class="stringliteral"></span>
01338 <span class="stringliteral">                    //</span>
01339 <span class="stringliteral">                    //  We got a reparse and we've exhausted our times through</span>
01340 <span class="stringliteral">                    //  the loop so we'll return what we found.</span>
01341 <span class="stringliteral">                    //</span>
01342 <span class="stringliteral">                    //  **** this doesn't seem right.  It probably should be</span>
01343 <span class="stringliteral">                    //  an error</span>
01344 <span class="stringliteral">                    //</span>
01345 <span class="stringliteral"></span>
01346 <span class="stringliteral">                    } else {</span>
01347 <span class="stringliteral"></span>
01348 <span class="stringliteral">                        ObDereferenceObject( RootDirectory );</span>
01349 <span class="stringliteral"></span>
01350 <span class="stringliteral">                        *FoundObject = Object;</span>
01351 <span class="stringliteral"></span>
01352 <span class="stringliteral">                        //</span>
01353 <span class="stringliteral">                        //  At this point we were failing in stress by</span>
01354 <span class="stringliteral">                        //  returning to the caller with a success status but</span>
01355 <span class="stringliteral">                        //  a null object pointer.</span>
01356 <span class="stringliteral">                        //</span>
01357 <span class="stringliteral"></span>
01358 <span class="stringliteral">                        if (Object == NULL) {</span>
01359 <span class="stringliteral"></span>
01360 <span class="stringliteral">                            Status = STATUS_OBJECT_NAME_NOT_FOUND;</span>
01361 <span class="stringliteral">                        }</span>
01362 <span class="stringliteral"></span>
01363 <span class="stringliteral">                        return( Status );</span>
01364 <span class="stringliteral">                    }</span>
01365 <span class="stringliteral">                }</span>
01366 <span class="stringliteral">            }</span>
01367 <span class="stringliteral"></span>
01368 <span class="stringliteral">        //</span>
01369 <span class="stringliteral">        //  At this point the caller has given us the directory of object</span>
01370 <span class="stringliteral">        //  types.  If the caller didn't specify a name then we'll return</span>
01371 <span class="stringliteral">        //  a pointer to the root object directory.</span>
01372 <span class="stringliteral">        //</span>
01373 <span class="stringliteral"></span>
01374 <span class="stringliteral">        } else if ((ObjectName-&gt;Length == 0) ||</span>
01375 <span class="stringliteral">                   (ObjectName-&gt;Buffer == NULL)) {</span>
01376 <span class="stringliteral"></span>
01377 <span class="stringliteral">            Status = ObReferenceObjectByPointer( RootDirectory,</span>
01378 <span class="stringliteral">                                                 0,</span>
01379 <span class="stringliteral">                                                 ObjectType,</span>
01380 <span class="stringliteral">                                                 AccessMode );</span>
01381 <span class="stringliteral"></span>
01382 <span class="stringliteral">            if (NT_SUCCESS( Status )) {</span>
01383 <span class="stringliteral"></span>
01384 <span class="stringliteral">                Object = RootDirectory;</span>
01385 <span class="stringliteral">            }</span>
01386 <span class="stringliteral"></span>
01387 <span class="stringliteral">            ObDereferenceObject( RootDirectory );</span>
01388 <span class="stringliteral"></span>
01389 <span class="stringliteral">            *FoundObject = Object;</span>
01390 <span class="stringliteral"></span>
01391 <span class="stringliteral">            return( Status );</span>
01392 <span class="stringliteral">        }</span>
01393 <span class="stringliteral"></span>
01394 <span class="stringliteral">    //</span>
01395 <span class="stringliteral">    //  Otherwise the caller did not specify a directory to search so</span>
01396 <span class="stringliteral">    //  we'll default to the object root directory</span>
01397 <span class="stringliteral">    //</span>
01398 <span class="stringliteral"></span>
01399 <span class="stringliteral">    } else {</span>
01400 <span class="stringliteral"></span>
01401 <span class="stringliteral">        RootDirectory = ObpRootDirectoryObject;</span>
01402 <span class="stringliteral"></span>
01403 <span class="stringliteral">        //</span>
01404 <span class="stringliteral">        //  If the name we're looking for is empty then it is illformed.</span>
01405 <span class="stringliteral">        //  Also it has to start with a "</span>\<span class="stringliteral">" or it is illformed.</span>
01406 <span class="stringliteral">        //</span>
01407 <span class="stringliteral"></span>
01408 <span class="stringliteral">        if ((ObjectName-&gt;Length == 0) ||</span>
01409 <span class="stringliteral">            (ObjectName-&gt;Buffer == NULL) ||</span>
01410 <span class="stringliteral">            (*(ObjectName-&gt;Buffer) != OBJ_NAME_PATH_SEPARATOR)) {</span>
01411 <span class="stringliteral"></span>
01412 <span class="stringliteral">            return( STATUS_OBJECT_PATH_SYNTAX_BAD );</span>
01413 <span class="stringliteral">        }</span>
01414 <span class="stringliteral"></span>
01415 <span class="stringliteral">        //</span>
01416 <span class="stringliteral">        //  Check if the name is has only one character (that is the "</span>\<span class="stringliteral">")</span>
01417 <span class="stringliteral">        //  Which means that the caller really just wants to lookup the</span>
01418 <span class="stringliteral">        //  root directory.</span>
01419 <span class="stringliteral">        //</span>
01420 <span class="stringliteral"></span>
01421 <span class="stringliteral">        if (ObjectName-&gt;Length == sizeof( OBJ_NAME_PATH_SEPARATOR )) {</span>
01422 <span class="stringliteral"></span>
01423 <span class="stringliteral">            //</span>
01424 <span class="stringliteral">            //  If there is not a root directory yet.  Then we really</span>
01425 <span class="stringliteral">            //  can't return it, however if the caller specified</span>
01426 <span class="stringliteral">            //  an insert object that is the one we'll reference and</span>
01427 <span class="stringliteral">            //  return to our caller</span>
01428 <span class="stringliteral">            //</span>
01429 <span class="stringliteral"></span>
01430 <span class="stringliteral">            if (!RootDirectory) {</span>
01431 <span class="stringliteral"></span>
01432 <span class="stringliteral">                if (InsertObject) {</span>
01433 <span class="stringliteral"></span>
01434 <span class="stringliteral">                    Status = ObReferenceObjectByPointer( InsertObject,</span>
01435 <span class="stringliteral">                                                         0,</span>
01436 <span class="stringliteral">                                                         ObjectType,</span>
01437 <span class="stringliteral">                                                         AccessMode );</span>
01438 <span class="stringliteral"></span>
01439 <span class="stringliteral">                    if (NT_SUCCESS( Status )) {</span>
01440 <span class="stringliteral"></span>
01441 <span class="stringliteral">                        *FoundObject = InsertObject;</span>
01442 <span class="stringliteral">                    }</span>
01443 <span class="stringliteral"></span>
01444 <span class="stringliteral">                    return( Status );</span>
01445 <span class="stringliteral"></span>
01446 <span class="stringliteral">                } else {</span>
01447 <span class="stringliteral"></span>
01448 <span class="stringliteral">                    return( STATUS_INVALID_PARAMETER );</span>
01449 <span class="stringliteral">                }</span>
01450 <span class="stringliteral"></span>
01451 <span class="stringliteral">            //</span>
01452 <span class="stringliteral">            //  At this point the caller did not specify a root directory,</span>
01453 <span class="stringliteral">            //  the name is "</span>\<span class="stringliteral">" and the root object directory exists so</span>
01454 <span class="stringliteral">            //  we'll simply return the real root directory object</span>
01455 <span class="stringliteral">            //</span>
01456 <span class="stringliteral"></span>
01457 <span class="stringliteral">            } else {</span>
01458 <span class="stringliteral"></span>
01459 <span class="stringliteral">                Status = ObReferenceObjectByPointer( RootDirectory,</span>
01460 <span class="stringliteral">                                                     0,</span>
01461 <span class="stringliteral">                                                     ObjectType,</span>
01462 <span class="stringliteral">                                                     AccessMode );</span>
01463 <span class="stringliteral"></span>
01464 <span class="stringliteral">                if (NT_SUCCESS( Status )) {</span>
01465 <span class="stringliteral"></span>
01466 <span class="stringliteral">                    *FoundObject = RootDirectory;</span>
01467 <span class="stringliteral">                }</span>
01468 <span class="stringliteral"></span>
01469 <span class="stringliteral">                return( Status );</span>
01470 <span class="stringliteral">            }</span>
01471 <span class="stringliteral"></span>
01472 <span class="stringliteral">        //</span>
01473 <span class="stringliteral">        //  At this pointer the caller did not specify a root directory,</span>
01474 <span class="stringliteral">        //  and the name is more than just a "</span>\<span class="stringliteral">"</span>
01475 <span class="stringliteral">        //</span>
01476 <span class="stringliteral">        //  Now if the lookup is case insensitive, and the name buffer is a</span>
01477 <span class="stringliteral">        //  legitimate pointer (meaning that is it quadword aligned), and</span>
01478 <span class="stringliteral">        //  there is a dos device map for the process.  Then we'll handle</span>
01479 <span class="stringliteral">        //  the situation here. First get the device map and make sure it</span>
01480 <span class="stringliteral">        //  doesn't go away while we're using it.</span>
01481 <span class="stringliteral">        //</span>
01482 <span class="stringliteral"></span>
01483 <span class="stringliteral">        } else {</span>
01484 <span class="stringliteral"></span>
01485 <span class="stringliteral">            KIRQL OldIrql;</span>
01486 <span class="stringliteral"></span>
01487 <span class="stringliteral">            ExAcquireSpinLock( &amp;ObpDeviceMapLock, &amp;OldIrql );</span>
01488 <span class="stringliteral"></span>
01489 <span class="stringliteral">            if ((DeviceMap = PsGetCurrentProcess()-&gt;DeviceMap) != NULL) {</span>
01490 <span class="stringliteral"></span>
01491 <span class="stringliteral">                DeviceMap-&gt;ReferenceCount++;</span>
01492 <span class="stringliteral">                ExReleaseSpinLock( &amp;ObpDeviceMapLock, OldIrql );</span>
01493 <span class="stringliteral"></span>
01494 <span class="stringliteral">                if (!((ULONG_PTR)(ObjectName-&gt;Buffer) &amp; (sizeof(ULONGLONG)-1))</span>
01495 <span class="stringliteral"></span>
01496 <span class="stringliteral">                            &amp;&amp;</span>
01497 <span class="stringliteral"></span>
01498 <span class="stringliteral">                    (DeviceMap-&gt;DosDevicesDirectory != NULL )) {</span>
01499 <span class="stringliteral"></span>
01500 <span class="stringliteral">                    //</span>
01501 <span class="stringliteral">                    //  Check if the object name is actually equal to the</span>
01502 <span class="stringliteral">                    //  global dos devices short name prefix "</span>\??\<span class="stringliteral">"</span>
01503 <span class="stringliteral">                    //</span>
01504 <span class="stringliteral"></span>
01505 <span class="stringliteral">                    if ((ObjectName-&gt;Length &gt;= ObpDosDevicesShortName.Length)</span>
01506 <span class="stringliteral"></span>
01507 <span class="stringliteral">                            &amp;&amp;</span>
01508 <span class="stringliteral"></span>
01509 <span class="stringliteral">                        (*(PULONGLONG)(ObjectName-&gt;Buffer) == ObpDosDevicesShortNamePrefix.QuadPart)) {</span>
01510 <span class="stringliteral"></span>
01511 <span class="stringliteral">                        //</span>
01512 <span class="stringliteral">                        //  The user gave us the dos short name prefix so we'll</span>
01513 <span class="stringliteral">                        //  look down the directory, and start the search at the</span>
01514 <span class="stringliteral">                        //  dos device directory</span>
01515 <span class="stringliteral">                        //</span>
01516 <span class="stringliteral"></span>
01517 <span class="stringliteral">                        *DirectoryLocked = TRUE;</span>
01518 <span class="stringliteral"></span>
01519 <span class="stringliteral">                        ObpEnterRootDirectoryMutex();</span>
01520 <span class="stringliteral"></span>
01521 <span class="stringliteral">                        ParentDirectory = RootDirectory;</span>
01522 <span class="stringliteral"></span>
01523 <span class="stringliteral">                        Directory = DeviceMap-&gt;DosDevicesDirectory;</span>
01524 <span class="stringliteral"></span>
01525 <span class="stringliteral">                        RemainingName = *ObjectName;</span>
01526 <span class="stringliteral">                        RemainingName.Buffer += (ObpDosDevicesShortName.Length / sizeof( WCHAR ));</span>
01527 <span class="stringliteral">                        RemainingName.Length -= ObpDosDevicesShortName.Length;</span>
01528 <span class="stringliteral"></span>
01529 <span class="stringliteral">                        goto quickStart;</span>
01530 <span class="stringliteral"></span>
01531 <span class="stringliteral">                    //</span>
01532 <span class="stringliteral">                    //  The name is not equal to "</span>\??\<span class="stringliteral">" but check if it is</span>
01533 <span class="stringliteral">                    //  equal to "</span>\??<span class="stringliteral">"</span>
01534 <span class="stringliteral">                    //</span>
01535 <span class="stringliteral"></span>
01536 <span class="stringliteral">                    } else if ((ObjectName-&gt;Length == ObpDosDevicesShortName.Length - sizeof( WCHAR ))</span>
01537 <span class="stringliteral"></span>
01538 <span class="stringliteral">                                    &amp;&amp;</span>
01539 <span class="stringliteral"></span>
01540 <span class="stringliteral">                               (*(PULONG)(ObjectName-&gt;Buffer) == ObpDosDevicesShortNameRoot.LowPart)</span>
01541 <span class="stringliteral"></span>
01542 <span class="stringliteral">                                    &amp;&amp;</span>
01543 <span class="stringliteral"></span>
01544 <span class="stringliteral">                               (*((PWCHAR)(ObjectName-&gt;Buffer)+2) == (WCHAR)(ObpDosDevicesShortNameRoot.HighPart))) {</span>
01545 <span class="stringliteral"></span>
01546 <span class="stringliteral">                        //</span>
01547 <span class="stringliteral">                        //  The user specified "</span>\??<span class="stringliteral">" so we return to dos devices</span>
01548 <span class="stringliteral">                        //  directory to our caller</span>
01549 <span class="stringliteral">                        //</span>
01550 <span class="stringliteral"></span>
01551 <span class="stringliteral">                        Status = ObReferenceObjectByPointer( DeviceMap-&gt;DosDevicesDirectory,</span>
01552 <span class="stringliteral">                                                             0,</span>
01553 <span class="stringliteral">                                                             ObjectType,</span>
01554 <span class="stringliteral">                                                             AccessMode );</span>
01555 <span class="stringliteral"></span>
01556 <span class="stringliteral">                        if (NT_SUCCESS( Status )) {</span>
01557 <span class="stringliteral"></span>
01558 <span class="stringliteral">                            *FoundObject = DeviceMap-&gt;DosDevicesDirectory;</span>
01559 <span class="stringliteral">                        }</span>
01560 <span class="stringliteral"></span>
01561 <span class="stringliteral">                        //</span>
01562 <span class="stringliteral">                        //  Dereference the Device Map</span>
01563 <span class="stringliteral">                        //</span>
01564 <span class="stringliteral"></span>
01565 <span class="stringliteral">                        {</span>
01566 <span class="stringliteral">                            KIRQL OldIrql;</span>
01567 <span class="stringliteral"></span>
01568 <span class="stringliteral">                            ExAcquireSpinLock( &amp;ObpDeviceMapLock, &amp;OldIrql );</span>
01569 <span class="stringliteral"></span>
01570 <span class="stringliteral">                            DeviceMap-&gt;ReferenceCount--;</span>
01571 <span class="stringliteral"></span>
01572 <span class="stringliteral">                            if (DeviceMap-&gt;ReferenceCount == 0) {</span>
01573 <span class="stringliteral"></span>
01574 <span class="stringliteral">                                ExReleaseSpinLock( &amp;ObpDeviceMapLock, OldIrql );</span>
01575 <span class="stringliteral"></span>
01576 <span class="stringliteral">                                DeviceMap-&gt;DosDevicesDirectory-&gt;DeviceMap = NULL;</span>
01577 <span class="stringliteral">                                ObDereferenceObject( DeviceMap-&gt;DosDevicesDirectory );</span>
01578 <span class="stringliteral"></span>
01579 <span class="stringliteral">                                ExFreePool( DeviceMap );</span>
01580 <span class="stringliteral"></span>
01581 <span class="stringliteral">                            } else {</span>
01582 <span class="stringliteral"></span>
01583 <span class="stringliteral">                                ExReleaseSpinLock( &amp;ObpDeviceMapLock, OldIrql );</span>
01584 <span class="stringliteral">                            }</span>
01585 <span class="stringliteral">                        }</span>
01586 <span class="stringliteral"></span>
01587 <span class="stringliteral">                        return( Status );</span>
01588 <span class="stringliteral">                    }</span>
01589 <span class="stringliteral">                }</span>
01590 <span class="stringliteral"></span>
01591 <span class="stringliteral">            } else {</span>
01592 <span class="stringliteral"></span>
01593 <span class="stringliteral">                ExReleaseSpinLock( &amp;ObpDeviceMapLock, OldIrql );</span>
01594 <span class="stringliteral">            }</span>
01595 <span class="stringliteral">        }</span>
01596 <span class="stringliteral">    }</span>
01597 <span class="stringliteral"></span>
01598 <span class="stringliteral">    //</span>
01599 <span class="stringliteral">    //  At this point either</span>
01600 <span class="stringliteral">    //</span>
01601 <span class="stringliteral">    //  the user specified a directory that is not the object</span>
01602 <span class="stringliteral">    //  type directory and got repase back to the root directory</span>
01603 <span class="stringliteral">    //</span>
01604 <span class="stringliteral">    //  the user specified the object type directory and gave us</span>
01605 <span class="stringliteral">    //  a name to actually look up</span>
01606 <span class="stringliteral">    //</span>
01607 <span class="stringliteral">    //  the user did not specify a search directory (default</span>
01608 <span class="stringliteral">    //  to root object directory) and if the name did start off</span>
01609 <span class="stringliteral">    //  with the dos device prefix we've munged outselves back to</span>
01610 <span class="stringliteral">    //  it to the dos device directory for the process</span>
01611 <span class="stringliteral">    //</span>
01612 <span class="stringliteral"></span>
01613 <span class="stringliteral">    Reparse = TRUE;</span>
01614 <span class="stringliteral">    MaxReparse = OBJ_MAX_REPARSE_ATTEMPTS;</span>
01615 <span class="stringliteral"></span>
01616 <span class="stringliteral">    while (Reparse) {</span>
01617 <span class="stringliteral"></span>
01618 <span class="stringliteral">        RemainingName = *ObjectName;</span>
01619 <span class="stringliteral"></span>
01620 <span class="stringliteral">quickStart:</span>
01621 <span class="stringliteral"></span>
01622 <span class="stringliteral">        Reparse = FALSE;</span>
01623 <span class="stringliteral"></span>
01624 <span class="stringliteral">        while (TRUE) {</span>
01625 <span class="stringliteral"></span>
01626 <span class="stringliteral">            Object = NULL;</span>
01627 <span class="stringliteral"></span>
01628 <span class="stringliteral">            //if (RemainingName.Length == 0) {</span>
01629 <span class="stringliteral">            //    Status = STATUS_OBJECT_NAME_INVALID;</span>
01630 <span class="stringliteral">            //    break;</span>
01631 <span class="stringliteral">            //    }</span>
01632 <span class="stringliteral"></span>
01633 <span class="stringliteral">            //</span>
01634 <span class="stringliteral">            //  If the remaining name for the object starts with a</span>
01635 <span class="stringliteral">            //  "</span>\<span class="stringliteral">" then just gobble up the "</span>\<span class="stringliteral">"</span>
01636 <span class="stringliteral">            //</span>
01637 <span class="stringliteral"></span>
01638 <span class="stringliteral">            if ( (RemainingName.Length != 0) &amp;&amp;</span>
01639 <span class="stringliteral">                 (*(RemainingName.Buffer) == OBJ_NAME_PATH_SEPARATOR) ) {</span>
01640 <span class="stringliteral"></span>
01641 <span class="stringliteral">                RemainingName.Buffer++;</span>
01642 <span class="stringliteral">                RemainingName.Length -= sizeof( OBJ_NAME_PATH_SEPARATOR );</span>
01643 <span class="stringliteral">            }</span>
01644 <span class="stringliteral"></span>
01645 <span class="stringliteral">            //</span>
01646 <span class="stringliteral">            //  The following piece of code will calculate the first</span>
01647 <span class="stringliteral">            //  component of the remaining name.  If there is not</span>
01648 <span class="stringliteral">            //  a remaining component then the object name is illformed</span>
01649 <span class="stringliteral">            //</span>
01650 <span class="stringliteral"></span>
01651 <span class="stringliteral">            ComponentName = RemainingName;</span>
01652 <span class="stringliteral"></span>
01653 <span class="stringliteral">            while (RemainingName.Length != 0) {</span>
01654 <span class="stringliteral"></span>
01655 <span class="stringliteral">                if (*(RemainingName.Buffer) == OBJ_NAME_PATH_SEPARATOR) {</span>
01656 <span class="stringliteral"></span>
01657 <span class="stringliteral">                    break;</span>
01658 <span class="stringliteral">                }</span>
01659 <span class="stringliteral"></span>
01660 <span class="stringliteral">                RemainingName.Buffer++;</span>
01661 <span class="stringliteral">                RemainingName.Length -= sizeof( OBJ_NAME_PATH_SEPARATOR );</span>
01662 <span class="stringliteral">            }</span>
01663 <span class="stringliteral"></span>
01664 <span class="stringliteral">            ComponentName.Length -= RemainingName.Length;</span>
01665 <span class="stringliteral"></span>
01666 <span class="stringliteral">            if (ComponentName.Length == 0) {</span>
01667 <span class="stringliteral"></span>
01668 <span class="stringliteral">                Status = STATUS_OBJECT_NAME_INVALID;</span>
01669 <span class="stringliteral">                break;</span>
01670 <span class="stringliteral">            }</span>
01671 <span class="stringliteral"></span>
01672 <span class="stringliteral">            //</span>
01673 <span class="stringliteral">            //  Now we have the first component name to lookup so we'll</span>
01674 <span class="stringliteral">            //  look the directory is necessary</span>
01675 <span class="stringliteral">            //</span>
01676 <span class="stringliteral"></span>
01677 <span class="stringliteral">            if (!*DirectoryLocked) {</span>
01678 <span class="stringliteral"></span>
01679 <span class="stringliteral">                *DirectoryLocked = TRUE;</span>
01680 <span class="stringliteral">                ObpEnterRootDirectoryMutex();</span>
01681 <span class="stringliteral">                Directory = RootDirectory;</span>
01682 <span class="stringliteral">            }</span>
01683 <span class="stringliteral"></span>
01684 <span class="stringliteral">            //</span>
01685 <span class="stringliteral">            //  Now if the caller does not have traverse privilege and</span>
01686 <span class="stringliteral">            //  there is a parent directory then we must check if the</span>
01687 <span class="stringliteral">            //  user has traverse access to the directory.  Our local</span>
01688 <span class="stringliteral">            //  Reparse variable should be false at this point so we'll</span>
01689 <span class="stringliteral">            //  drop out of both loops</span>
01690 <span class="stringliteral">            //</span>
01691 <span class="stringliteral"></span>
01692 <span class="stringliteral">            if ( !(AccessState-&gt;Flags &amp; TOKEN_HAS_TRAVERSE_PRIVILEGE) &amp;&amp; (ParentDirectory != NULL) ) {</span>
01693 <span class="stringliteral"></span>
01694 <span class="stringliteral">                if (!ObpCheckTraverseAccess( ParentDirectory,</span>
01695 <span class="stringliteral">                                             DIRECTORY_TRAVERSE,</span>
01696 <span class="stringliteral">                                             AccessState,</span>
01697 <span class="stringliteral">                                             FALSE,</span>
01698 <span class="stringliteral">                                             AccessMode,</span>
01699 <span class="stringliteral">                                             &amp;Status )) {</span>
01700 <span class="stringliteral"></span>
01701 <span class="stringliteral">                    break;</span>
01702 <span class="stringliteral">                }</span>
01703 <span class="stringliteral">            }</span>
01704 <span class="stringliteral"></span>
01705 <span class="stringliteral">            //</span>
01706 <span class="stringliteral">            //  If the object already exists in this directory, find it,</span>
01707 <span class="stringliteral">            //  else return NULL.</span>
01708 <span class="stringliteral">            //</span>
01709 <span class="stringliteral"></span>
01710 <span class="stringliteral">            Object = ObpLookupDirectoryEntry( Directory, &amp;ComponentName, Attributes );</span>
01711 <span class="stringliteral"></span>
01712 <span class="stringliteral">            if (!Object) {</span>
01713 <span class="stringliteral"></span>
01714 <span class="stringliteral">                //</span>
01715 <span class="stringliteral">                //  We didn't find the object.  If there is some remaining</span>
01716 <span class="stringliteral">                //  name left (meaning the component name is a directory in</span>
01717 <span class="stringliteral">                //  path we trying to break) or the caller didn't specify an</span>
01718 <span class="stringliteral">                //  insert object then we then we'll break out here with an</span>
01719 <span class="stringliteral">                //  error status</span>
01720 <span class="stringliteral">                //</span>
01721 <span class="stringliteral"></span>
01722 <span class="stringliteral">                if (RemainingName.Length != 0) {</span>
01723 <span class="stringliteral"></span>
01724 <span class="stringliteral">                    Status = STATUS_OBJECT_PATH_NOT_FOUND;</span>
01725 <span class="stringliteral">                    break;</span>
01726 <span class="stringliteral">                }</span>
01727 <span class="stringliteral"></span>
01728 <span class="stringliteral">                if (!InsertObject) {</span>
01729 <span class="stringliteral"></span>
01730 <span class="stringliteral">                    Status = STATUS_OBJECT_NAME_NOT_FOUND;</span>
01731 <span class="stringliteral">                    break;</span>
01732 <span class="stringliteral">                }</span>
01733 <span class="stringliteral"></span>
01734 <span class="stringliteral">                //</span>
01735 <span class="stringliteral">                //  Check that the caller has the access to the directory</span>
01736 <span class="stringliteral">                //  to either create a subdirectory (in the object type</span>
01737 <span class="stringliteral">                //  directory) or to create an object of the given component</span>
01738 <span class="stringliteral">                //  name.  If the call fails then we'll break out of here</span>
01739 <span class="stringliteral">                //  with the status value set</span>
01740 <span class="stringliteral">                //</span>
01741 <span class="stringliteral"></span>
01742 <span class="stringliteral">                if (!ObCheckCreateObjectAccess( Directory,</span>
01743 <span class="stringliteral">                                                ObjectType == ObpDirectoryObjectType ?</span>
01744 <span class="stringliteral">                                                        DIRECTORY_CREATE_SUBDIRECTORY :</span>
01745 <span class="stringliteral">                                                        DIRECTORY_CREATE_OBJECT,</span>
01746 <span class="stringliteral">                                                AccessState,</span>
01747 <span class="stringliteral">                                                &amp;ComponentName,</span>
01748 <span class="stringliteral">                                                FALSE,</span>
01749 <span class="stringliteral">                                                AccessMode,</span>
01750 <span class="stringliteral">                                                &amp;Status )) {</span>
01751 <span class="stringliteral"></span>
01752 <span class="stringliteral">                    break;</span>
01753 <span class="stringliteral">                }</span>
01754 <span class="stringliteral"></span>
01755 <span class="stringliteral">                //</span>
01756 <span class="stringliteral">                //  The object does not exist in the directory and</span>
01757 <span class="stringliteral">                //  we are allowed to create one.  So allocate space</span>
01758 <span class="stringliteral">                //  for the name and insert the name into the directory</span>
01759 <span class="stringliteral">                //</span>
01760 <span class="stringliteral"></span>
01761 <span class="stringliteral">                NewName = ExAllocatePoolWithTag( PagedPool, ComponentName.Length, 'mNbO' );</span>
01762 <span class="stringliteral"></span>
01763 <span class="stringliteral">                if ((NewName == NULL) ||</span>
01764 <span class="stringliteral">                    !ObpInsertDirectoryEntry( Directory, InsertObject )) {</span>
01765 <span class="stringliteral"></span>
01766 <span class="stringliteral">                    if (NewName != NULL) {</span>
01767 <span class="stringliteral"></span>
01768 <span class="stringliteral">                        ExFreePool( NewName );</span>
01769 <span class="stringliteral">                    }</span>
01770 <span class="stringliteral"></span>
01771 <span class="stringliteral">                    Status = STATUS_INSUFFICIENT_RESOURCES;</span>
01772 <span class="stringliteral">                    break;</span>
01773 <span class="stringliteral">                }</span>
01774 <span class="stringliteral"></span>
01775 <span class="stringliteral">                //</span>
01776 <span class="stringliteral">                //  We have an insert object so now get its name info,</span>
01777 <span class="stringliteral">                //  because we are going to change its name and insert it</span>
01778 <span class="stringliteral">                //  into the directory</span>
01779 <span class="stringliteral">                //</span>
01780 <span class="stringliteral"></span>
01781 <span class="stringliteral">                ObReferenceObject( InsertObject );</span>
01782 <span class="stringliteral"></span>
01783 <span class="stringliteral">                ObjectHeader = OBJECT_TO_OBJECT_HEADER( InsertObject );</span>
01784 <span class="stringliteral"></span>
01785 <span class="stringliteral">                NameInfo = OBJECT_HEADER_TO_NAME_INFO( ObjectHeader );</span>
01786 <span class="stringliteral"></span>
01787 <span class="stringliteral">                ObReferenceObject( Directory );</span>
01788 <span class="stringliteral"></span>
01789 <span class="stringliteral">                RtlMoveMemory( NewName,</span>
01790 <span class="stringliteral">                               ComponentName.Buffer,</span>
01791 <span class="stringliteral">                               ComponentName.Length );</span>
01792 <span class="stringliteral"></span>
01793 <span class="stringliteral">                if (NameInfo-&gt;Name.Buffer) {</span>
01794 <span class="stringliteral"></span>
01795 <span class="stringliteral">                    ExFreePool( NameInfo-&gt;Name.Buffer );</span>
01796 <span class="stringliteral">                }</span>
01797 <span class="stringliteral"></span>
01798 <span class="stringliteral">                NameInfo-&gt;Name.Buffer = NewName;</span>
01799 <span class="stringliteral">                NameInfo-&gt;Name.Length = ComponentName.Length;</span>
01800 <span class="stringliteral">                NameInfo-&gt;Name.MaximumLength = ComponentName.Length;</span>
01801 <span class="stringliteral"></span>
01802 <span class="stringliteral">                Object = InsertObject;</span>
01803 <span class="stringliteral"></span>
01804 <span class="stringliteral">                Status = STATUS_SUCCESS;</span>
01805 <span class="stringliteral"></span>
01806 <span class="stringliteral">                break;</span>
01807 <span class="stringliteral">            }</span>
01808 <span class="stringliteral"></span>
01809 <span class="stringliteral">            //</span>
01810 <span class="stringliteral">            //  At this point we've found the component name within</span>
01811 <span class="stringliteral">            //  the directory.  So we'll now grab the components object</span>
01812 <span class="stringliteral">            //  header, and get its parse routine</span>
01813 <span class="stringliteral">            //</span>
01814 <span class="stringliteral"></span>
01815 <span class="stringliteral">ReparseObject:</span>
01816 <span class="stringliteral"></span>
01817 <span class="stringliteral">            ObjectHeader = OBJECT_TO_OBJECT_HEADER( Object );</span>
01818 <span class="stringliteral">            ParseProcedure = ObjectHeader-&gt;Type-&gt;TypeInfo.ParseProcedure;</span>
01819 <span class="stringliteral"></span>
01820 <span class="stringliteral">            //</span>
01821 <span class="stringliteral">            //  Now if there is a parse routine for the type and we are not</span>
01822 <span class="stringliteral">            //  inserting a new object or the parse routine is for symbolic</span>
01823 <span class="stringliteral">            //  links then we'll actually call the parse routine</span>
01824 <span class="stringliteral">            //</span>
01825 <span class="stringliteral"></span>
01826 <span class="stringliteral">            if (ParseProcedure &amp;&amp; (!InsertObject || (ParseProcedure == ObpParseSymbolicLink))) {</span>
01827 <span class="stringliteral"></span>
01828 <span class="stringliteral">                KIRQL SaveIrql;</span>
01829 <span class="stringliteral"></span>
01830 <span class="stringliteral">                //</span>
01831 <span class="stringliteral">                //  Reference the object and then free the directory lock</span>
01832 <span class="stringliteral">                //  This will keep the object from going away with the</span>
01833 <span class="stringliteral">                //  directory unlocked</span>
01834 <span class="stringliteral">                //</span>
01835 <span class="stringliteral"></span>
01836 <span class="stringliteral">                ObpIncrPointerCount( ObjectHeader );</span>
01837 <span class="stringliteral"></span>
01838 <span class="stringliteral">                ASSERT(*DirectoryLocked);</span>
01839 <span class="stringliteral"></span>
01840 <span class="stringliteral">                ObpLeaveRootDirectoryMutex();</span>
01841 <span class="stringliteral"></span>
01842 <span class="stringliteral">                *DirectoryLocked = FALSE;</span>
01843 <span class="stringliteral"></span>
01844 <span class="stringliteral">                ObpBeginTypeSpecificCallOut( SaveIrql );</span>
01845 <span class="stringliteral"></span>
01846 <span class="stringliteral">                //</span>
01847 <span class="stringliteral">                //  Call the objects parse routine</span>
01848 <span class="stringliteral">                //</span>
01849 <span class="stringliteral"></span>
01850 <span class="stringliteral">                Status = (*ParseProcedure)( Object,</span>
01851 <span class="stringliteral">                                            (PVOID)ObjectType,</span>
01852 <span class="stringliteral">                                            AccessState,</span>
01853 <span class="stringliteral">                                            AccessMode,</span>
01854 <span class="stringliteral">                                            Attributes,</span>
01855 <span class="stringliteral">                                            ObjectName,</span>
01856 <span class="stringliteral">                                            &amp;RemainingName,</span>
01857 <span class="stringliteral">                                            ParseContext,</span>
01858 <span class="stringliteral">                                            SecurityQos,</span>
01859 <span class="stringliteral">                                            &amp;Object );</span>
01860 <span class="stringliteral"></span>
01861 <span class="stringliteral">                ObpEndTypeSpecificCallOut( SaveIrql, "</span>Parse<span class="stringliteral">", ObjectHeader-&gt;Type, Object );</span>
01862 <span class="stringliteral"></span>
01863 <span class="stringliteral">                //</span>
01864 <span class="stringliteral">                //  We can now decrement the object reference count</span>
01865 <span class="stringliteral">                //</span>
01866 <span class="stringliteral"></span>
01867 <span class="stringliteral">                ObDereferenceObject( &amp;ObjectHeader-&gt;Body );</span>
01868 <span class="stringliteral"></span>
01869 <span class="stringliteral">                //</span>
01870 <span class="stringliteral">                //  Check if we have some reparsing to do</span>
01871 <span class="stringliteral">                //</span>
01872 <span class="stringliteral"></span>
01873 <span class="stringliteral">                if ((Status == STATUS_REPARSE) || (Status == STATUS_REPARSE_OBJECT)) {</span>
01874 <span class="stringliteral"></span>
01875 <span class="stringliteral">                    //</span>
01876 <span class="stringliteral">                    //  See if we've reparsed too many times already and if</span>
01877 <span class="stringliteral">                    //  so we'll fail the request</span>
01878 <span class="stringliteral">                    //</span>
01879 <span class="stringliteral"></span>
01880 <span class="stringliteral">                    if (--MaxReparse) {</span>
01881 <span class="stringliteral"></span>
01882 <span class="stringliteral">                        //</span>
01883 <span class="stringliteral">                        //  Tell the outer loop to continue looping</span>
01884 <span class="stringliteral">                        //</span>
01885 <span class="stringliteral"></span>
01886 <span class="stringliteral">                        Reparse = TRUE;</span>
01887 <span class="stringliteral"></span>
01888 <span class="stringliteral">                        //</span>
01889 <span class="stringliteral">                        //  Check if we have a reparse object or the name</span>
01890 <span class="stringliteral">                        //  starts with a "</span>\<span class="stringliteral">"</span>
01891 <span class="stringliteral">                        //</span>
01892 <span class="stringliteral"></span>
01893 <span class="stringliteral">                        if ((Status == STATUS_REPARSE_OBJECT) ||</span>
01894 <span class="stringliteral">                            (*(ObjectName-&gt;Buffer) == OBJ_NAME_PATH_SEPARATOR)) {</span>
01895 <span class="stringliteral"></span>
01896 <span class="stringliteral">                            //</span>
01897 <span class="stringliteral">                            //  If the user specified a start directory then</span>
01898 <span class="stringliteral">                            //  remove this information because we're taking</span>
01899 <span class="stringliteral">                            //  a reparse point to someplace else</span>
01900 <span class="stringliteral">                             //</span>
01901 <span class="stringliteral"></span>
01902 <span class="stringliteral">                            if (ARGUMENT_PRESENT( RootDirectoryHandle )) {</span>
01903 <span class="stringliteral"></span>
01904 <span class="stringliteral">                                ObDereferenceObject( RootDirectory );</span>
01905 <span class="stringliteral">                                RootDirectoryHandle = NULL;</span>
01906 <span class="stringliteral">                            }</span>
01907 <span class="stringliteral"></span>
01908 <span class="stringliteral">                            //</span>
01909 <span class="stringliteral">                            //  And where we start is the root directory</span>
01910 <span class="stringliteral">                            //  object</span>
01911 <span class="stringliteral">                            //</span>
01912 <span class="stringliteral"></span>
01913 <span class="stringliteral">                            ParentDirectory = NULL;</span>
01914 <span class="stringliteral">                            RootDirectory = ObpRootDirectoryObject;</span>
01915 <span class="stringliteral"></span>
01916 <span class="stringliteral">                            //</span>
01917 <span class="stringliteral">                            //  Now if this is a reparse object (means we have</span>
01918 <span class="stringliteral">                            //  encountered a symbolic link that has already been</span>
01919 <span class="stringliteral">                            //  snapped so we have an object and remaining</span>
01920 <span class="stringliteral">                            //  name that need to be examined) and we didn't</span>
01921 <span class="stringliteral">                            //  find an object from the parse routine object</span>
01922 <span class="stringliteral">                            //  break out of both loops.</span>
01923 <span class="stringliteral">                            //</span>
01924 <span class="stringliteral"></span>
01925 <span class="stringliteral">                            if (Status == STATUS_REPARSE_OBJECT) {</span>
01926 <span class="stringliteral"></span>
01927 <span class="stringliteral">                                Reparse = FALSE;</span>
01928 <span class="stringliteral"></span>
01929 <span class="stringliteral">                                if (Object == NULL) {</span>
01930 <span class="stringliteral"></span>
01931 <span class="stringliteral">                                    Status = STATUS_OBJECT_NAME_NOT_FOUND;</span>
01932 <span class="stringliteral"></span>
01933 <span class="stringliteral">                                } else {</span>
01934 <span class="stringliteral"></span>
01935 <span class="stringliteral">                                    //</span>
01936 <span class="stringliteral">                                    //  At this point we have a reparse object</span>
01937 <span class="stringliteral">                                    //  so we'll look the directory down and</span>
01938 <span class="stringliteral">                                    //  parse the new object</span>
01939 <span class="stringliteral">                                    //</span>
01940 <span class="stringliteral"></span>
01941 <span class="stringliteral">                                    *DirectoryLocked = TRUE;</span>
01942 <span class="stringliteral">                                    ObpEnterRootDirectoryMutex();</span>
01943 <span class="stringliteral"></span>
01944 <span class="stringliteral">                                    goto ReparseObject;</span>
01945 <span class="stringliteral">                                }</span>
01946 <span class="stringliteral">                            }</span>
01947 <span class="stringliteral"></span>
01948 <span class="stringliteral">                        //</span>
01949 <span class="stringliteral">                        //  We did not have a reparse object and the name</span>
01950 <span class="stringliteral">                        //  does not start with a "</span>\<span class="stringliteral">".  Meaning we got back</span>
01951 <span class="stringliteral">                        //  STATUS_REPASE, so now check if the directory</span>
01952 <span class="stringliteral">                        //  is the root object directory and if so then</span>
01953 <span class="stringliteral">                        //  we didn't the name otherwise we'll drop out of</span>
01954 <span class="stringliteral">                        //  the inner loop and reparse true to get back to</span>
01955 <span class="stringliteral">                        //  outer loop</span>
01956 <span class="stringliteral">                        //</span>
01957 <span class="stringliteral"></span>
01958 <span class="stringliteral">                        } else if (RootDirectory == ObpRootDirectoryObject) {</span>
01959 <span class="stringliteral"></span>
01960 <span class="stringliteral">                            Object = NULL;</span>
01961 <span class="stringliteral">                            Status = STATUS_OBJECT_NAME_NOT_FOUND;</span>
01962 <span class="stringliteral"></span>
01963 <span class="stringliteral">                            Reparse = FALSE;</span>
01964 <span class="stringliteral">                        }</span>
01965 <span class="stringliteral"></span>
01966 <span class="stringliteral">                    } else {</span>
01967 <span class="stringliteral"></span>
01968 <span class="stringliteral">                        //</span>
01969 <span class="stringliteral">                        //  **** this should probably be a differnt error</span>
01970 <span class="stringliteral">                        //  status related to too many reparse points</span>
01971 <span class="stringliteral">                        //</span>
01972 <span class="stringliteral"></span>
01973 <span class="stringliteral">                        Object = NULL;</span>
01974 <span class="stringliteral">                        Status = STATUS_OBJECT_NAME_NOT_FOUND;</span>
01975 <span class="stringliteral">                    }</span>
01976 <span class="stringliteral"></span>
01977 <span class="stringliteral">                //</span>
01978 <span class="stringliteral">                //  We are not reparsing and if we did not get success then</span>
01979 <span class="stringliteral">                //  the object is null and we'll break out of our loops</span>
01980 <span class="stringliteral">                //</span>
01981 <span class="stringliteral"></span>
01982 <span class="stringliteral">                } else if (!NT_SUCCESS( Status )) {</span>
01983 <span class="stringliteral"></span>
01984 <span class="stringliteral">                    Object = NULL;</span>
01985 <span class="stringliteral"></span>
01986 <span class="stringliteral">                //</span>
01987 <span class="stringliteral">                //  We are not reparsing and we got back success but check</span>
01988 <span class="stringliteral">                //  if the object is null because that means we really didn't</span>
01989 <span class="stringliteral">                //  find the object, and then break out of our loops</span>
01990 <span class="stringliteral">                //</span>
01991 <span class="stringliteral">                //  If the object is not null then we've been successful and</span>
01992 <span class="stringliteral">                //  prosperous so break out with the object set.</span>
01993 <span class="stringliteral">                //</span>
01994 <span class="stringliteral"></span>
01995 <span class="stringliteral">                } else if (Object == NULL) {</span>
01996 <span class="stringliteral"></span>
01997 <span class="stringliteral">                    Status = STATUS_OBJECT_NAME_NOT_FOUND;</span>
01998 <span class="stringliteral">                }</span>
01999 <span class="stringliteral"></span>
02000 <span class="stringliteral">                break;</span>
02001 <span class="stringliteral"></span>
02002 <span class="stringliteral">            } else {</span>
02003 <span class="stringliteral"></span>
02004 <span class="stringliteral">                //</span>
02005 <span class="stringliteral">                //  At this point we do not have a parse routine or if there</span>
02006 <span class="stringliteral">                //  is a parse routine it is not for symbolic links or there</span>
02007 <span class="stringliteral">                //  may not be a specified insert object</span>
02008 <span class="stringliteral">                //</span>
02009 <span class="stringliteral">                //  Check to see if we have exhausted the remaining name</span>
02010 <span class="stringliteral">                //</span>
02011 <span class="stringliteral"></span>
02012 <span class="stringliteral">                if (RemainingName.Length == 0) {</span>
02013 <span class="stringliteral"></span>
02014 <span class="stringliteral">                    //</span>
02015 <span class="stringliteral">                    //  Check if the caller specified an object to insert.</span>
02016 <span class="stringliteral">                    //  If specified then we'll break out of our loops with</span>
02017 <span class="stringliteral">                    //  the object that we've found</span>
02018 <span class="stringliteral">                    //</span>
02019 <span class="stringliteral"></span>
02020 <span class="stringliteral">                    if (!InsertObject) {</span>
02021 <span class="stringliteral"></span>
02022 <span class="stringliteral">                        //</span>
02023 <span class="stringliteral">                        //  The user did not specify an insert object</span>
02024 <span class="stringliteral">                        //  so we're opening an existing object.  Make sure</span>
02025 <span class="stringliteral">                        //  we have traverse access to the container</span>
02026 <span class="stringliteral">                        //  directory.</span>
02027 <span class="stringliteral">                        //</span>
02028 <span class="stringliteral"></span>
02029 <span class="stringliteral">                        if ( !(AccessState-&gt;Flags &amp; TOKEN_HAS_TRAVERSE_PRIVILEGE) ) {</span>
02030 <span class="stringliteral"></span>
02031 <span class="stringliteral">                            if (!ObpCheckTraverseAccess( Directory,</span>
02032 <span class="stringliteral">                                                         DIRECTORY_TRAVERSE,</span>
02033 <span class="stringliteral">                                                         AccessState,</span>
02034 <span class="stringliteral">                                                         FALSE,</span>
02035 <span class="stringliteral">                                                         AccessMode,</span>
02036 <span class="stringliteral">                                                         &amp;Status )) {</span>
02037 <span class="stringliteral"></span>
02038 <span class="stringliteral">                                Object = NULL;</span>
02039 <span class="stringliteral">                                break;</span>
02040 <span class="stringliteral">                            }</span>
02041 <span class="stringliteral">                        }</span>
02042 <span class="stringliteral"></span>
02043 <span class="stringliteral">                        Status = ObReferenceObjectByPointer( Object,</span>
02044 <span class="stringliteral">                                                             0,</span>
02045 <span class="stringliteral">                                                             ObjectType,</span>
02046 <span class="stringliteral">                                                             AccessMode );</span>
02047 <span class="stringliteral"></span>
02048 <span class="stringliteral">                        if (!NT_SUCCESS( Status )) {</span>
02049 <span class="stringliteral"></span>
02050 <span class="stringliteral">                            Object = NULL;</span>
02051 <span class="stringliteral">                        }</span>
02052 <span class="stringliteral">                    }</span>
02053 <span class="stringliteral"></span>
02054 <span class="stringliteral">                    break;</span>
02055 <span class="stringliteral"></span>
02056 <span class="stringliteral">                } else {</span>
02057 <span class="stringliteral"></span>
02058 <span class="stringliteral">                    //</span>
02059 <span class="stringliteral">                    //  There is some name remaining names to process</span>
02060 <span class="stringliteral">                    //  if the directory we're looking at is the</span>
02061 <span class="stringliteral">                    //  directory of object types and set ourselves</span>
02062 <span class="stringliteral">                    //  up to parse it all over again.</span>
02063 <span class="stringliteral">                    //</span>
02064 <span class="stringliteral"></span>
02065 <span class="stringliteral">                    if (ObjectHeader-&gt;Type == ObpDirectoryObjectType) {</span>
02066 <span class="stringliteral"></span>
02067 <span class="stringliteral">                        ParentDirectory = Directory;</span>
02068 <span class="stringliteral">                        Directory = (POBJECT_DIRECTORY)Object;</span>
02069 <span class="stringliteral"></span>
02070 <span class="stringliteral">                    } else {</span>
02071 <span class="stringliteral"></span>
02072 <span class="stringliteral">                        //</span>
02073 <span class="stringliteral">                        //  Otherwise there has been a mismatch so we'll</span>
02074 <span class="stringliteral">                        //  set our error status and break out of the</span>
02075 <span class="stringliteral">                        //  loops</span>
02076 <span class="stringliteral">                        //</span>
02077 <span class="stringliteral"></span>
02078 <span class="stringliteral">                        Status = STATUS_OBJECT_TYPE_MISMATCH;</span>
02079 <span class="stringliteral">                        Object = NULL;</span>
02080 <span class="stringliteral"></span>
02081 <span class="stringliteral">                        break;</span>
02082 <span class="stringliteral">                    }</span>
02083 <span class="stringliteral">                }</span>
02084 <span class="stringliteral">            }</span>
02085 <span class="stringliteral">        }</span>
02086 <span class="stringliteral">    }</span>
02087 <span class="stringliteral"></span>
02088 <span class="stringliteral">    //</span>
02089 <span class="stringliteral">    //  If the device map has been referenced then dereference it</span>
02090 <span class="stringliteral">    //</span>
02091 <span class="stringliteral"></span>
02092 <span class="stringliteral">    if (DeviceMap != NULL) {</span>
02093 <span class="stringliteral"></span>
02094 <span class="stringliteral">        KIRQL OldIrql;</span>
02095 <span class="stringliteral"></span>
02096 <span class="stringliteral">        ExAcquireSpinLock( &amp;ObpDeviceMapLock, &amp;OldIrql );</span>
02097 <span class="stringliteral"></span>
02098 <span class="stringliteral">        DeviceMap-&gt;ReferenceCount--;</span>
02099 <span class="stringliteral"></span>
02100 <span class="stringliteral">        if (DeviceMap-&gt;ReferenceCount == 0) {</span>
02101 <span class="stringliteral"></span>
02102 <span class="stringliteral">            ExReleaseSpinLock( &amp;ObpDeviceMapLock, OldIrql );</span>
02103 <span class="stringliteral"></span>
02104 <span class="stringliteral">            DeviceMap-&gt;DosDevicesDirectory-&gt;DeviceMap = NULL;</span>
02105 <span class="stringliteral">            ObDereferenceObject( DeviceMap-&gt;DosDevicesDirectory );</span>
02106 <span class="stringliteral"></span>
02107 <span class="stringliteral">            ExFreePool( DeviceMap );</span>
02108 <span class="stringliteral"></span>
02109 <span class="stringliteral">        } else {</span>
02110 <span class="stringliteral"></span>
02111 <span class="stringliteral">            ExReleaseSpinLock( &amp;ObpDeviceMapLock, OldIrql );</span>
02112 <span class="stringliteral">        }</span>
02113 <span class="stringliteral">    }</span>
02114 <span class="stringliteral"></span>
02115 <span class="stringliteral">    //</span>
02116 <span class="stringliteral">    //  At this point we've parsed the object name as much as possible</span>
02117 <span class="stringliteral">    //  going through symbolic links as necessary.  So now set the</span>
02118 <span class="stringliteral">    //  output object pointer, and if we really did not find an object</span>
02119 <span class="stringliteral">    //  then we might need to modify the error status.  If the</span>
02120 <span class="stringliteral">    //  status was repase or some success status then translate it</span>
02121 <span class="stringliteral">    //  to name not found.</span>
02122 <span class="stringliteral">    //</span>
02123 <span class="stringliteral"></span>
02124 <span class="stringliteral">    if (!(*FoundObject = Object)) {</span>
02125 <span class="stringliteral"></span>
02126 <span class="stringliteral">        if (Status == STATUS_REPARSE) {</span>
02127 <span class="stringliteral"></span>
02128 <span class="stringliteral">            Status = STATUS_OBJECT_NAME_NOT_FOUND;</span>
02129 <span class="stringliteral"></span>
02130 <span class="stringliteral">        } else if (NT_SUCCESS( Status )) {</span>
02131 <span class="stringliteral"></span>
02132 <span class="stringliteral">            Status = STATUS_OBJECT_NAME_NOT_FOUND;</span>
02133 <span class="stringliteral">        }</span>
02134 <span class="stringliteral">    }</span>
02135 <span class="stringliteral"></span>
02136 <span class="stringliteral">    //</span>
02137 <span class="stringliteral">    //  If the caller gave us a root directory to search (and we didn't</span>
02138 <span class="stringliteral">    //  zero out this value) then free up our reference</span>
02139 <span class="stringliteral">    //</span>
02140 <span class="stringliteral"></span>
02141 <span class="stringliteral">    if (ARGUMENT_PRESENT( RootDirectoryHandle )) {</span>
02142 <span class="stringliteral"></span>
02143 <span class="stringliteral">        ObDereferenceObject( RootDirectory );</span>
02144 <span class="stringliteral">        RootDirectoryHandle = NULL;</span>
02145 <span class="stringliteral">    }</span>
02146 <span class="stringliteral"></span>
02147 <span class="stringliteral">    //</span>
02148 <span class="stringliteral">    //  And return to our caller</span>
02149 <span class="stringliteral">    //</span>
02150 <span class="stringliteral"></span>
02151 <span class="stringliteral">    return( Status );</span>
02152 <span class="stringliteral">}</span>
</span>
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a64" doxytag="obp.h::ObpParseSymbolicLink" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS ObpParseSymbolicLink           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>ParseObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>ObjectType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d5/struct__ACCESS__STATE.html">PACCESS_STATE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessState</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessMode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Attributes</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>CompleteName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>RemainingName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PVOID Context&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSECURITY_QUALITY_OF_SERVICE <a class="el" href="../../d8/d0/ctlpcqos_8c.html#a9">SecurityQos</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>Object</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d0/oblink_8c-source.html#l00501">501</a> of file <a class="el" href="../../d5/d0/oblink_8c-source.html">oblink.c</a>.
<p>
References <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00231">_OBJECT_SYMBOLIC_LINK::LinkTarget</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00233">_OBJECT_SYMBOLIC_LINK::LinkTargetObject</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00232">_OBJECT_SYMBOLIC_LINK::LinkTargetRemaining</a>, <a class="el" href="../../d0/d2/rtreplac_8c-source.html#l00045">NewName</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00189">ObpEnterRootDirectoryMutex</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00202">ObpLeaveRootDirectoryMutex</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l01022">ObReferenceObjectByPointer()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d1/d0/obinit_8c-source.html#l00117">ObInitSystem()</a>, and <a class="el" href="../../d9/d9/obdir_8c-source.html#l01081">ObpLookupObjectName()</a>.
<p>
<pre class="fragment"><div>00516                    :
00517 
00518     This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> call back routine <span class="keywordflow">for</span> parsing symbolic link objects.  It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked
00519     as part of <a class="code" href="../../d8/d0/obdir_8c.html#a6">ObpLookupObjectName</a>
00520 
00521 Arguments:
00522 
00523     ParseObject - This will actually be a symbolic link object
00524 
00525     ObjectType - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object to lookup
00526 
00527     AccessState - Current access state, describing already granted access
00528         types, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> privileges used to get them, and any access types yet to
00529         be granted.  The access masks may not contain any generic access
00530         types.
00531 
00532     AccessMode - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> callers processor mode
00533 
00534     Attributes - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> attributes <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> lookup (e.g., <span class="keywordflow">case</span>
00535         insensitive)
00536 
00537     CompleteName - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> complete name that we are trying
00538         to open.  On <span class="keywordflow">return</span> <span class="keyword">this</span> could be modified to fit <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> reparse
00539         buffer
00540 
00541     RemainingName - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> remaining name that we are
00542         trying to open.  On <span class="keywordflow">return</span> <span class="keyword">this</span> will point to what remains after
00543         we processed <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> symbolic link.
00544 
00545     Context - Unused
00546 
00547     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a14">SecurityQos</a> - Unused
00548 
00549     Object - Receives a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> symbolic link object that we
00550         resolve to
00551 
00552 Return Value:
00553 
00554     STATUS_REPARSE_OBJECT <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> parse object <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> already a snapped
00555         symbolic link meaning we've modified <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> remaining name and
00556         and have returned <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target object of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> symbolic link
00557 
00558 
00559     STATUS_REPARSE <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> parse object has not been snapped.  In <span class="keyword">this</span>
00560         <span class="keywordflow">case</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Complete name has been modified with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> link target
00561         name added in front of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> remaining name.  The parameters
00562         remaining name and object must now be ignored by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller
00563 
00564     An appropriate error value
00565 
00566 --*/
00567 
00568 {
00569     ULONG NewLength;
00570     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> Length;
00571     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> MaximumLength;
00572     PWCHAR <a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a>, NewRemainingName;
00573     ULONG InsertAmount;
00574     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00575     <a class="code" href="../../d2/d6/struct__OBJECT__SYMBOLIC__LINK.html">POBJECT_SYMBOLIC_LINK</a> SymbolicLink;
00576     PUNICODE_STRING LinkTargetName;
00577 
00578     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00579 
00580     <span class="comment">//</span>
00581     <span class="comment">//  This routine needs to be synchonized with the delete symbolic link</span>
00582     <span class="comment">//  operation.  Which uses the root directory mutex.</span>
00583     <span class="comment">//</span>
00584 
00585     <a class="code" href="../../d5/d1/obp_8h.html#a10">ObpEnterRootDirectoryMutex</a>();
00586 
00587     <span class="keywordflow">try</span> {
00588 
00589         *Object = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00590 
00591         <span class="comment">//</span>
00592         <span class="comment">//  If there isn't any name remaining and the caller gave us</span>
00593         <span class="comment">//  an object type then we'll reference the parse object.  If</span>
00594         <span class="comment">//  this is successful then that's the object we return.  Otherwise</span>
00595         <span class="comment">//  if the status is anything but a type mismatch then we'll</span>
00596         <span class="comment">//  return that error status</span>
00597         <span class="comment">//</span>
00598 
00599         <span class="keywordflow">if</span> (RemainingName-&gt;Length == 0) {
00600 
00601             <span class="keywordflow">if</span> ( ObjectType ) {
00602 
00603                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a6">ObReferenceObjectByPointer</a>( ParseObject,
00604                                                      0,
00605                                                      ObjectType,
00606                                                      AccessMode );
00607 
00608                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00609 
00610                     *Object = ParseObject;
00611 
00612                     leave;
00613 
00614                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_OBJECT_TYPE_MISMATCH) {
00615 
00616                     leave;
00617                 }
00618            }
00619 
00620         <span class="comment">//</span>
00621         <span class="comment">//  If the remaining name does not start with a "\" then</span>
00622         <span class="comment">//  its is illformed and we'll call it a type mismatch</span>
00623         <span class="comment">//</span>
00624 
00625         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*(RemainingName-&gt;Buffer) != OBJ_NAME_PATH_SEPARATOR) {
00626 
00627             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_OBJECT_TYPE_MISMATCH;
00628             leave;
00629         }
00630 
00631         <span class="comment">//</span>
00632         <span class="comment">//  A symbolic link has been encountered. See if this link has been snapped</span>
00633         <span class="comment">//  to a particular object.</span>
00634         <span class="comment">//</span>
00635 
00636         SymbolicLink = (<a class="code" href="../../d2/d6/struct__OBJECT__SYMBOLIC__LINK.html">POBJECT_SYMBOLIC_LINK</a>)ParseObject;
00637 
00638         <span class="keywordflow">if</span> (SymbolicLink-&gt;<a class="code" href="../../d2/d6/struct__OBJECT__SYMBOLIC__LINK.html#o3">LinkTargetObject</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00639 
00640             <span class="comment">//</span>
00641             <span class="comment">//  This is a snapped link.  Get the remaining portion of the</span>
00642             <span class="comment">//  symbolic link target, if any.</span>
00643             <span class="comment">//</span>
00644 
00645             LinkTargetName = &amp;SymbolicLink-&gt;<a class="code" href="../../d2/d6/struct__OBJECT__SYMBOLIC__LINK.html#o2">LinkTargetRemaining</a>;
00646 
00647             <span class="keywordflow">if</span> (LinkTargetName-&gt;Length == 0) {
00648 
00649                 <span class="comment">//</span>
00650                 <span class="comment">//  Remaining link target string is zero, so return to caller</span>
00651                 <span class="comment">//  quickly with snapped object pointer and remaining object name</span>
00652                 <span class="comment">//  which we haven't touched yet.</span>
00653                 <span class="comment">//</span>
00654 
00655                 *Object = SymbolicLink-&gt;<a class="code" href="../../d2/d6/struct__OBJECT__SYMBOLIC__LINK.html#o3">LinkTargetObject</a>;
00656 
00657                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_REPARSE_OBJECT;
00658                 leave;
00659             }
00660 
00661             <span class="comment">//</span>
00662             <span class="comment">//  We have a snapped symbolic link that has additional text.</span>
00663             <span class="comment">//  Insert that in front of the current remaining name, preserving</span>
00664             <span class="comment">//  and text between CompleteName and RemainingName</span>
00665             <span class="comment">//</span>
00666 
00667             InsertAmount = LinkTargetName-&gt;Length;
00668 
00669             <span class="keywordflow">if</span> ((LinkTargetName-&gt;Buffer[ (InsertAmount / <span class="keyword">sizeof</span>( WCHAR )) - 1 ] == OBJ_NAME_PATH_SEPARATOR)
00670 
00671                     &amp;&amp;
00672 
00673                 (*(RemainingName-&gt;Buffer) == OBJ_NAME_PATH_SEPARATOR)) {
00674 
00675                 <span class="comment">//</span>
00676                 <span class="comment">//  Both the link target name ends in a "\" and the remaining</span>
00677                 <span class="comment">//  starts with a "\" but we only need one when we're done</span>
00678                 <span class="comment">//</span>
00679 
00680                 InsertAmount -= <span class="keyword">sizeof</span>( WCHAR );
00681             }
00682 
00683             <span class="comment">//</span>
00684             <span class="comment">//  **** don't see why we need to bias the differnce between two</span>
00685             <span class="comment">//  pointers with * sizeof(wchar)</span>
00686             <span class="comment">//</span>
00687 
00688             NewLength = (ULONG)(((RemainingName-&gt;Buffer - CompleteName-&gt;Buffer) * <span class="keyword">sizeof</span>( WCHAR )) +
00689                         InsertAmount +
00690                         RemainingName-&gt;Length);
00691 
00692             <span class="keywordflow">if</span> (NewLength &gt; 0xFFF0) {
00693 
00694                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NAME_TOO_LONG;
00695                 leave;
00696             }
00697 
00698             Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)NewLength;
00699 
00700             <span class="comment">//</span>
00701             <span class="comment">//  Now check if the new computed length is too big for the input</span>
00702             <span class="comment">//  buffer containing the complete name</span>
00703             <span class="comment">//</span>
00704 
00705             <span class="keywordflow">if</span> (CompleteName-&gt;MaximumLength &lt;= Length) {
00706 
00707                 <span class="comment">//</span>
00708                 <span class="comment">//  The new concatentated name is larger than the buffer supplied for</span>
00709                 <span class="comment">//  the complete name.  Allocate space for this new string</span>
00710                 <span class="comment">//</span>
00711 
00712                 MaximumLength = Length + <span class="keyword">sizeof</span>( UNICODE_NULL );
00713                 <a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a> = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( NonPagedPool, MaximumLength, 'mNbO' );
00714 
00715                 <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00716 
00717                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
00718                     leave;
00719                 }
00720 
00721                 <span class="comment">//</span>
00722                 <span class="comment">//  Calculate the pointer within this buffer for the remaining</span>
00723                 <span class="comment">//  name.  This value has not been biased by the new link</span>
00724                 <span class="comment">//  target name</span>
00725                 <span class="comment">//</span>
00726 
00727                 NewRemainingName = <a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a> + (RemainingName-&gt;Buffer - CompleteName-&gt;Buffer);
00728 
00729                 <span class="comment">//</span>
00730                 <span class="comment">//  Copy over all the names that we've processed so far</span>
00731                 <span class="comment">//</span>
00732 
00733                 RtlMoveMemory( NewName,
00734                                CompleteName-&gt;Buffer,
00735                                ((RemainingName-&gt;Buffer - CompleteName-&gt;Buffer) * <span class="keyword">sizeof</span>( WCHAR )));
00736 
00737                 <span class="comment">//</span>
00738                 <span class="comment">//  If we have some remaining names then those over at the</span>
00739                 <span class="comment">//  the location offset to hold the link target name</span>
00740                 <span class="comment">//</span>
00741 
00742                 <span class="keywordflow">if</span> (RemainingName-&gt;Length != 0) {
00743 
00744                     RtlMoveMemory( (PVOID)((PUCHAR)NewRemainingName + InsertAmount),
00745                                    RemainingName-&gt;Buffer,
00746                                    RemainingName-&gt;Length );
00747                 }
00748 
00749                 <span class="comment">//</span>
00750                 <span class="comment">//  Now insert the link target name</span>
00751                 <span class="comment">//</span>
00752 
00753                 RtlMoveMemory( NewRemainingName, LinkTargetName-&gt;Buffer, InsertAmount );
00754 
00755                 <span class="comment">//</span>
00756                 <span class="comment">//  Free the old complete name buffer and reset the input</span>
00757                 <span class="comment">//  strings to use the new buffer</span>
00758                 <span class="comment">//</span>
00759 
00760                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( CompleteName-&gt;Buffer );
00761 
00762                 CompleteName-&gt;Buffer = <a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a>;
00763                 CompleteName-&gt;Length = Length;
00764                 CompleteName-&gt;MaximumLength = MaximumLength;
00765 
00766                 RemainingName-&gt;Buffer = NewRemainingName;
00767                 RemainingName-&gt;Length = Length - (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)((PCHAR)NewRemainingName - (PCHAR)<a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a>);
00768                 RemainingName-&gt;MaximumLength = RemainingName-&gt;Length + <span class="keyword">sizeof</span>( UNICODE_NULL );
00769 
00770             } <span class="keywordflow">else</span> {
00771 
00772                 <span class="comment">//</span>
00773                 <span class="comment">//  Insert extra text associated with this symbolic link name before</span>
00774                 <span class="comment">//  existing remaining name, if any.</span>
00775                 <span class="comment">//</span>
00776                 <span class="comment">//  First shove over the remaining name to make a hole for the</span>
00777                 <span class="comment">//  link target name</span>
00778                 <span class="comment">//</span>
00779 
00780                 <span class="keywordflow">if</span> (RemainingName-&gt;Length != 0) {
00781 
00782                     RtlMoveMemory( (PVOID)((PUCHAR)RemainingName-&gt;Buffer + InsertAmount),
00783                                    RemainingName-&gt;Buffer,
00784                                    RemainingName-&gt;Length );
00785                 }
00786 
00787                 <span class="comment">//</span>
00788                 <span class="comment">//  Now insert the link target name</span>
00789                 <span class="comment">//</span>
00790 
00791                 RtlMoveMemory( RemainingName-&gt;Buffer, LinkTargetName-&gt;Buffer, InsertAmount );
00792 
00793                 <span class="comment">//</span>
00794                 <span class="comment">//  Adjust input strings to account for this inserted text</span>
00795                 <span class="comment">//</span>
00796 
00797                 CompleteName-&gt;Length += LinkTargetName-&gt;Length;
00798 
00799                 RemainingName-&gt;Length += LinkTargetName-&gt;Length;
00800                 RemainingName-&gt;MaximumLength += RemainingName-&gt;Length + <span class="keyword">sizeof</span>( UNICODE_NULL );
00801 
00802                 CompleteName-&gt;Buffer[ CompleteName-&gt;Length / <span class="keyword">sizeof</span>( WCHAR ) ] = UNICODE_NULL;
00803             }
00804 
00805             <span class="comment">//</span>
00806             <span class="comment">//  Return the object address associated with snapped symbolic link</span>
00807             <span class="comment">//  and the reparse object status code.</span>
00808             <span class="comment">//</span>
00809 
00810             *Object = SymbolicLink-&gt;<a class="code" href="../../d2/d6/struct__OBJECT__SYMBOLIC__LINK.html#o3">LinkTargetObject</a>;
00811 
00812             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_REPARSE_OBJECT;
00813             leave;
00814         }
00815 
00816         <span class="comment">//</span>
00817         <span class="comment">//  The symbolic has not yet been snapped</span>
00818         <span class="comment">//</span>
00819         <span class="comment">//  Compute the size of the new name and check if the name will</span>
00820         <span class="comment">//  fit in the existing complete name buffer.</span>
00821         <span class="comment">//</span>
00822 
00823         LinkTargetName = &amp;SymbolicLink-&gt;<a class="code" href="../../d2/d6/struct__OBJECT__SYMBOLIC__LINK.html#o1">LinkTarget</a>;
00824         NewLength = LinkTargetName-&gt;Length + RemainingName-&gt;Length;
00825 
00826         <span class="keywordflow">if</span> (NewLength &gt; 0xFFF0) {
00827 
00828             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NAME_TOO_LONG;
00829             leave;
00830         }
00831 
00832         Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)NewLength;
00833 
00834         <span class="keywordflow">if</span> (CompleteName-&gt;MaximumLength &lt;= Length) {
00835 
00836             <span class="comment">//</span>
00837             <span class="comment">//  The new concatentated name is larger than the buffer supplied for</span>
00838             <span class="comment">//  the complete name.</span>
00839             <span class="comment">//</span>
00840 
00841             MaximumLength = Length + <span class="keyword">sizeof</span>( UNICODE_NULL );
00842             <a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a> = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( NonPagedPool, MaximumLength, 'mNbO' );
00843 
00844             <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00845 
00846                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
00847                 leave;
00848             }
00849 
00850         } <span class="keywordflow">else</span> {
00851 
00852             MaximumLength = CompleteName-&gt;MaximumLength;
00853             <a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a> = CompleteName-&gt;Buffer;
00854         }
00855 
00856         <span class="comment">//</span>
00857         <span class="comment">//  Concatenate the symbolic link name with the remaining name,</span>
00858         <span class="comment">//  if any.  What this does is overwrite the front of the complete</span>
00859         <span class="comment">//  name up to the remaining name with the links target name</span>
00860         <span class="comment">//</span>
00861 
00862         <span class="keywordflow">if</span> (RemainingName-&gt;Length != 0) {
00863 
00864             RtlMoveMemory( (PVOID)((PUCHAR)NewName + LinkTargetName-&gt;Length),
00865                            RemainingName-&gt;Buffer,
00866                            RemainingName-&gt;Length );
00867         }
00868 
00869         RtlMoveMemory( NewName, LinkTargetName-&gt;Buffer, LinkTargetName-&gt;Length );
00870 
00871         <a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a>[ Length / <span class="keyword">sizeof</span>( WCHAR ) ] = UNICODE_NULL;
00872 
00873         <span class="comment">//</span>
00874         <span class="comment">//  If a new name buffer was allocated, then free the original complete</span>
00875         <span class="comment">//  name buffer.</span>
00876         <span class="comment">//</span>
00877 
00878         <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a> != CompleteName-&gt;Buffer) {
00879 
00880             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( CompleteName-&gt;Buffer );
00881         }
00882 
00883         <span class="comment">//</span>
00884         <span class="comment">//  Set the new complete name buffer parameters and return a reparse</span>
00885         <span class="comment">//  status.</span>
00886         <span class="comment">//</span>
00887 
00888         CompleteName-&gt;Buffer = <a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a>;
00889         CompleteName-&gt;Length = Length;
00890         CompleteName-&gt;MaximumLength = MaximumLength;
00891 
00892         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_REPARSE;
00893 
00894     } finally {
00895 
00896         <a class="code" href="../../d5/d1/obp_8h.html#a11">ObpLeaveRootDirectoryMutex</a>();
00897     }
00898 
00899     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00900 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a74" doxytag="obp.h::ObpProcessRemoveObjectQueue" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID ObpProcessRemoveObjectQueue           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Parameter</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d0/obref_8c-source.html#l01299">1299</a> of file <a class="el" href="../../d8/d0/obref_8c-source.html">obref.c</a>.
<p>
References <a class="el" href="../../d5/d9/ob_8h-source.html#l00313">_OBJECT_HEADER::Body</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00087">ObpLock</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00090">ObpRemoveObjectQueue</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l01370">ObpRemoveObjectRoutine()</a>, and <a class="el" href="../../d8/d0/obref_8c-source.html#l00027">ObpRemoveQueueActive</a>.
<p>
Referenced by <a class="el" href="../../d8/d0/obref_8c-source.html#l01124">ObfDereferenceObject()</a>.
<p>
<pre class="fragment"><div>01305                    :
01306 
01307     This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> work routine <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> remove object work queue.  Its
01308     job <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to remove and process items from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> remove object queue.
01309 
01310 Arguments:
01311 
01312     Parameter - Ignored
01313 
01314 Return Value:
01315 
01316     None.
01317 
01318 --*/
01319 
01320 {
01321     PSINGLE_LIST_ENTRY Entry;
01322     <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> ObjectHeader;
01323     KIRQL OldIrql;
01324 
01325     <span class="comment">//</span>
01326     <span class="comment">//  Lock the work queue this will keep the preceding routine</span>
01327     <span class="comment">//  from monkeying with the queue</span>
01328     <span class="comment">//</span>
01329 
01330     ExAcquireSpinLock( &amp;ObpLock, &amp;OldIrql );
01331 
01332     <span class="comment">//</span>
01333     <span class="comment">//  While there are items in our private remove object work queue</span>
01334     <span class="comment">//  then we remove each item, get back up to the object header,</span>
01335     <span class="comment">//  and delete the object.  The latter part done outside of the</span>
01336     <span class="comment">//  work queue lock</span>
01337     <span class="comment">//</span>
01338 
01339     Entry = PopEntryList( (PSINGLE_LIST_ENTRY)&amp;ObpRemoveObjectQueue );
01340 
01341     <span class="keywordflow">while</span> ( Entry != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
01342 
01343         ExReleaseSpinLock( &amp;ObpLock, OldIrql );
01344 
01345         ObjectHeader = CONTAINING_RECORD( Entry,
01346                                           <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">OBJECT_HEADER</a>,
01347                                           SEntry );
01348 
01349         <a class="code" href="../../d7/d1/obref_8c.html#a10">ObpRemoveObjectRoutine</a>( &amp;ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o11">Body</a> );
01350 
01351         ExAcquireSpinLock( &amp;ObpLock, &amp;OldIrql );
01352 
01353         Entry = PopEntryList((PSINGLE_LIST_ENTRY)&amp;ObpRemoveObjectQueue );
01354     }
01355 
01356     <span class="comment">//</span>
01357     <span class="comment">//  Indicate that we are now going inactive and then unlock</span>
01358     <span class="comment">//  the work queue</span>
01359     <span class="comment">//</span>
01360 
01361     <a class="code" href="../../d7/d1/obref_8c.html#a0">ObpRemoveQueueActive</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01362 
01363     ExReleaseSpinLock( &amp;ObpLock, OldIrql );
01364 
01365     <span class="keywordflow">return</span>;
01366 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a92" doxytag="obp.h::ObpReferenceSecurityDescriptor" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PSECURITY_DESCRIPTOR ObpReferenceSecurityDescriptor           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Object</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d0/obsdata_8c-source.html#l00559">559</a> of file <a class="el" href="../../d9/d0/obsdata_8c-source.html">obsdata.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00302">_SECURITY_DESCRIPTOR_HEADER::FullHash</a>, <a class="el" href="../../d9/d0/obsdata_8c-source.html#l00058">IF_OB_GLOBAL</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00355">OBJECT_TO_OBJECT_HEADER</a>, <a class="el" href="../../d9/d0/obsdata_8c-source.html#l00886">ObpAcquireDescriptorCacheWriteLock()</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00221">ObpCentralizedSecurity</a>, <a class="el" href="../../d9/d0/obsdata_8c-source.html#l00942">ObpReleaseDescriptorCacheLock()</a>, <a class="el" href="../../d9/d0/obsdata_8c-source.html#l00064">ObPrint</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00301">_SECURITY_DESCRIPTOR_HEADER::RefCount</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l02066">RtlValidSecurityDescriptor()</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00311">SD_TO_SD_HEADER</a>, and <a class="el" href="../../d5/d9/ob_8h-source.html#l00302">_OBJECT_HEADER::Type</a>.
<p>
Referenced by <a class="el" href="../../d0/d1/obse_8c-source.html#l01258">ObGetObjectSecurity()</a>.
<p>
<pre class="fragment"><div>00565                    :
00566 
00567     References <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security descriptor of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> passed object.
00568 
00569 Arguments:
00570 
00571     Object - Object being access validated.
00572 
00573 Return Value:
00574 
00575     The security descriptor of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object.
00576 
00577 --*/
00578 
00579 {
00580     <a class="code" href="../../d9/d0/struct__SECURITY__DESCRIPTOR__HEADER.html">PSECURITY_DESCRIPTOR_HEADER</a> SecurityDescriptorHeader;
00581     <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> ObjectHeader;
00582     <a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> ObjectType;
00583     PSECURITY_DESCRIPTOR SecurityDescriptor;
00584 
00585     <span class="comment">//</span>
00586     <span class="comment">//  Make sure the sure that the object in question is being</span>
00587     <span class="comment">//  maintained by the system and doesn't have it own security</span>
00588     <span class="comment">//  management routines.</span>
00589     <span class="comment">//</span>
00590     <span class="comment">//  **** the first two lines should probably be only done on</span>
00591     <span class="comment">//  a checked build</span>
00592     <span class="comment">//</span>
00593 
00594     ObjectHeader = <a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>( Object );
00595     ObjectType = ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o3">Type</a>;
00596     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d1/obp_8h.html#a13">ObpCentralizedSecurity</a>(ObjectType) );
00597 
00598     <span class="comment">//</span>
00599     <span class="comment">//  Lock the security descriptor cache and get the objects</span>
00600     <span class="comment">//  security descriptor</span>
00601     <span class="comment">//</span>
00602 
00603     <a class="code" href="../../d8/d1/obsdata_8c.html#a23">ObpAcquireDescriptorCacheWriteLock</a>();
00604 
00605     SecurityDescriptor = <a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>( Object )-&gt;SecurityDescriptor;
00606 
00607     <a class="code" href="../../d8/d1/obsdata_8c.html#a0">IF_OB_GLOBAL</a>( STOP_INVALID_DESCRIPTOR ) {
00608 
00609         <span class="keywordflow">if</span>((SecurityDescriptor != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
00610            (!<a class="code" href="../../d8/d6/sertl_8c.html#a55">RtlValidSecurityDescriptor</a> ( SecurityDescriptor ))) {
00611 
00612             DbgBreakPoint();
00613         }
00614     }
00615 
00616     <span class="comment">//</span>
00617     <span class="comment">//  If the object has a security descriptor then we need to</span>
00618     <span class="comment">//  get the security descriptor header and increment its</span>
00619     <span class="comment">//  ref count before releasing the lock and returning to</span>
00620     <span class="comment">//  our caller</span>
00621     <span class="comment">//</span>
00622 
00623     <span class="keywordflow">if</span> ( SecurityDescriptor != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00624 
00625         SecurityDescriptorHeader = <a class="code" href="../../d5/d1/obp_8h.html#a18">SD_TO_SD_HEADER</a>( SecurityDescriptor );
00626         <a class="code" href="../../d8/d1/obsdata_8c.html#a1">ObPrint</a>( SHOW_REFERENCES, (<span class="stringliteral">"Referencing Hash %lX, Refcount = %d \n"</span>,SecurityDescriptorHeader-&gt;<a class="code" href="../../d9/d0/struct__SECURITY__DESCRIPTOR__HEADER.html#o2">FullHash</a>,SecurityDescriptorHeader-&gt;<a class="code" href="../../d9/d0/struct__SECURITY__DESCRIPTOR__HEADER.html#o1">RefCount</a>));
00627         SecurityDescriptorHeader-&gt;<a class="code" href="../../d9/d0/struct__SECURITY__DESCRIPTOR__HEADER.html#o1">RefCount</a>++;
00628     }
00629 
00630     <a class="code" href="../../d8/d1/obsdata_8c.html#a25">ObpReleaseDescriptorCacheLock</a>();
00631 
00632     <span class="keywordflow">return</span>( SecurityDescriptor );
00633 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a57" doxytag="obp.h::ObpReleaseDescriptorCacheLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID ObpReleaseDescriptorCacheLock           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d0/obsdata_8c-source.html#l00942">942</a> of file <a class="el" href="../../d9/d0/obsdata_8c-source.html">obsdata.c</a>.
<p>
References <a class="el" href="../../d6/d7/ex_8h-source.html#l02393">ExReleaseResource</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01628">KeLeaveCriticalRegion</a>, <a class="el" href="../../d9/d0/obsdata_8c-source.html#l00103">ObsSecurityDescriptorCacheLock</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
Referenced by <a class="el" href="../../d7/d0/obquery_8c-source.html#l00058">NtQueryObject()</a>, <a class="el" href="../../d9/d0/obsdata_8c-source.html#l00637">ObDeassignSecurity()</a>, <a class="el" href="../../d9/d0/obsdata_8c-source.html#l00700">ObpDereferenceSecurityDescriptor()</a>, <a class="el" href="../../d9/d0/obsdata_8c-source.html#l00297">ObpLogSecurityDescriptor()</a>, <a class="el" href="../../d9/d0/obsdata_8c-source.html#l00559">ObpReferenceSecurityDescriptor()</a>, <a class="el" href="../../d0/d1/obse_8c-source.html#l01679">ObQuerySecurityDescriptorInfo()</a>, and <a class="el" href="../../d0/d1/obse_8c-source.html#l01748">ObSetSecurityDescriptorInfo()</a>.
<p>
<pre class="fragment"><div>00948                    :
00949 
00950     Releases a lock on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> security descriptor cache.
00951 
00952 Arguments:
00953 
00954     none
00955 
00956 Return Value:
00957 
00958     None.
00959 
00960 --*/
00961 
00962 {
00963     (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>)<a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( &amp;ObsSecurityDescriptorCacheLock );
00964     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a> ();
00965 
00966     <span class="keywordflow">return</span>;
00967 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a75" doxytag="obp.h::ObpRemoveObjectRoutine" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID ObpRemoveObjectRoutine           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Object</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d0/obref_8c-source.html#l01370">1370</a> of file <a class="el" href="../../d8/d0/obref_8c-source.html">obref.c</a>.
<p>
References <a class="el" href="../../d5/d9/ob_8h-source.html#l00179">_OBJECT_TYPE_INITIALIZER::DeleteProcedure</a>, <a class="el" href="../../d0/d5/se_8h.html#a200a110">DeleteSecurityDescriptor</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00332">_OBJECT_HEADER_NAME_INFO::Name</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00371">OBJECT_HEADER_TO_CREATOR_INFO</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00368">OBJECT_HEADER_TO_NAME_INFO</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00355">OBJECT_TO_OBJECT_HEADER</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00056">ObpBeginTypeSpecificCallOut</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00057">ObpEndTypeSpecificCallOut</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00163">ObpEnterObjectTypeMutex</a>, <a class="el" href="../../d7/d9/obcreate_8c-source.html#l01098">ObpFreeObject()</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00176">ObpLeaveObjectTypeMutex</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00071">ObpValidateIrql</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00312">_OBJECT_HEADER::SecurityDescriptor</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00181">_OBJECT_TYPE_INITIALIZER::SecurityProcedure</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00302">_OBJECT_HEADER::Type</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00196">_OBJECT_TYPE::TypeInfo</a>, and <a class="el" href="../../d5/d9/ob_8h-source.html#l00341">_OBJECT_HEADER_CREATOR_INFO::TypeList</a>.
<p>
Referenced by <a class="el" href="../../d8/d0/obref_8c-source.html#l01124">ObfDereferenceObject()</a>, and <a class="el" href="../../d8/d0/obref_8c-source.html#l01299">ObpProcessRemoveObjectQueue()</a>.
<p>
<pre class="fragment"><div>01376                    :
01377 
01378     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to <span class="keyword">delete</span> an object whose reference count has
01379     gone to zero.
01380 
01381 Arguments:
01382 
01383     Object - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> body of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object being deleted
01384 
01385 Return Value:
01386 
01387     None.
01388 
01389 --*/
01390 
01391 {
01392     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01393     <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> ObjectHeader;
01394     <a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> ObjectType;
01395     <a class="code" href="../../d7/d5/struct__OBJECT__HEADER__CREATOR__INFO.html">POBJECT_HEADER_CREATOR_INFO</a> CreatorInfo;
01396     <a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html">POBJECT_HEADER_NAME_INFO</a> NameInfo;
01397 
01398     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01399 
01400     <a class="code" href="../../d5/d1/obp_8h.html#a2">ObpValidateIrql</a>( <span class="stringliteral">"ObpRemoveObjectRoutine"</span> );
01401 
01402     <span class="comment">//</span>
01403     <span class="comment">//  Retrieve an object header from the object body, and also get</span>
01404     <span class="comment">//  the object type, creator and name info if available</span>
01405     <span class="comment">//</span>
01406 
01407     ObjectHeader = <a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>( Object );
01408     ObjectType = ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o3">Type</a>;
01409     CreatorInfo = <a class="code" href="../../d4/d0/ob_8h.html#a13">OBJECT_HEADER_TO_CREATOR_INFO</a>( ObjectHeader );
01410     NameInfo = <a class="code" href="../../d4/d0/ob_8h.html#a12">OBJECT_HEADER_TO_NAME_INFO</a>( ObjectHeader );
01411 
01412     <span class="comment">//</span>
01413     <span class="comment">//  Get exclusive access to the object type object</span>
01414     <span class="comment">//</span>
01415 
01416     <a class="code" href="../../d5/d1/obp_8h.html#a8">ObpEnterObjectTypeMutex</a>( ObjectType );
01417 
01418     <span class="comment">//</span>
01419     <span class="comment">//  If there is a creator info record and we are on the list</span>
01420     <span class="comment">//  for the object type then remove this object from the list</span>
01421     <span class="comment">//</span>
01422 
01423     <span class="keywordflow">if</span> (CreatorInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; !IsListEmpty( &amp;CreatorInfo-&gt;<a class="code" href="../../d7/d5/struct__OBJECT__HEADER__CREATOR__INFO.html#o0">TypeList</a> )) {
01424 
01425         RemoveEntryList( &amp;CreatorInfo-&gt;<a class="code" href="../../d7/d5/struct__OBJECT__HEADER__CREATOR__INFO.html#o0">TypeList</a> );
01426     }
01427 
01428     <span class="comment">//</span>
01429     <span class="comment">//  If there is a name info record and the name buffer is not null</span>
01430     <span class="comment">//  then free the buffer and zero out the name record</span>
01431     <span class="comment">//</span>
01432 
01433     <span class="keywordflow">if</span> (NameInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; NameInfo-&gt;<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html#o1">Name</a>.Buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01434 
01435         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( NameInfo-&gt;<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html#o1">Name</a>.Buffer );
01436 
01437         NameInfo-&gt;<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html#o1">Name</a>.Buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01438         NameInfo-&gt;<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html#o1">Name</a>.Length = 0;
01439         NameInfo-&gt;<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html#o1">Name</a>.MaximumLength = 0;
01440     }
01441 
01442     <span class="comment">//</span>
01443     <span class="comment">//  We are done with the object type object so we can now release it</span>
01444     <span class="comment">//</span>
01445 
01446     <a class="code" href="../../d5/d1/obp_8h.html#a9">ObpLeaveObjectTypeMutex</a>( ObjectType );
01447 
01448     <span class="comment">//</span>
01449     <span class="comment">//  Security descriptor deletion must precede the</span>
01450     <span class="comment">//  call to the object's DeleteProcedure.  Check if we have</span>
01451     <span class="comment">//  a security descriptor and if so then call the routine</span>
01452     <span class="comment">//  to delete the security descritpor.</span>
01453     <span class="comment">//</span>
01454 
01455     <span class="keywordflow">if</span> (ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o10">SecurityDescriptor</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01456 
01457         KIRQL SaveIrql;
01458 
01459         <a class="code" href="../../d5/d1/obp_8h.html#a0">ObpBeginTypeSpecificCallOut</a>( SaveIrql );
01460 
01461         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = (ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o17">SecurityProcedure</a>)( Object,
01462                                                            <a class="code" href="../../d0/d5/se_8h.html#a200a110">DeleteSecurityDescriptor</a>,
01463                                                            <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01464                                                            &amp;ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o10">SecurityDescriptor</a>,
01465                                                            0,
01466                                                            <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
01467 
01468         <a class="code" href="../../d5/d1/obp_8h.html#a1">ObpEndTypeSpecificCallOut</a>( SaveIrql, <span class="stringliteral">"Security"</span>, ObjectType, Object );
01469     }
01470 
01471     <span class="comment">//</span>
01472     <span class="comment">//  Now if there is a delete callback for the object type invoke</span>
01473     <span class="comment">//  the routine</span>
01474     <span class="comment">//</span>
01475 
01476     <span class="keywordflow">if</span> (ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o15">DeleteProcedure</a>) {
01477 
01478         KIRQL SaveIrql;
01479 
01480         <a class="code" href="../../d5/d1/obp_8h.html#a0">ObpBeginTypeSpecificCallOut</a>( SaveIrql );
01481 
01482         (*(ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o15">DeleteProcedure</a>))( Object );
01483 
01484         <a class="code" href="../../d5/d1/obp_8h.html#a1">ObpEndTypeSpecificCallOut</a>( SaveIrql, <span class="stringliteral">"Delete"</span>, ObjectType, Object );
01485     }
01486 
01487     <span class="comment">//</span>
01488     <span class="comment">//  Finally return the object back to pool including releasing any quota</span>
01489     <span class="comment">//  charges</span>
01490     <span class="comment">//</span>
01491 
01492     <a class="code" href="../../d5/d1/obp_8h.html#a63">ObpFreeObject</a>( Object );
01493 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a72" doxytag="obp.h::ObpUnlockObjectDirectoryPath" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID ObpUnlockObjectDirectoryPath           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__OBJECT__DIRECTORY.html">POBJECT_DIRECTORY</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>LockedDirectory</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a96" doxytag="obp.h::ObpValidateAccessMask" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS ObpValidateAccessMask           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d2/d5/struct__ACCESS__STATE.html">PACCESS_STATE</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>AccessState</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d1/obse_8c-source.html#l01886">1886</a> of file <a class="el" href="../../d0/d1/obse_8c-source.html">obse.c</a>.
<p>
References <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l00171">_ACCESS_STATE::PreviouslyGrantedAccess</a>, <a class="el" href="../../d1/d4/se_8h-source.html#l00170">_ACCESS_STATE::RemainingDesiredAccess</a>, and <a class="el" href="../../d1/d4/se_8h-source.html#l00174">_ACCESS_STATE::SecurityDescriptor</a>.
<p>
Referenced by <a class="el" href="../../d2/d0/obinsert_8c-source.html#l00029">ObInsertObject()</a>, and <a class="el" href="../../d8/d0/obref_8c-source.html#l00095">ObOpenObjectByName()</a>.
<p>
<pre class="fragment"><div>01892                    :
01893 
01894     Checks <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> desired access mask of a passed object against <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01895     passed security descriptor.
01896 
01897 Arguments:
01898 
01899     AccessState - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> AccessState <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pending operation.
01900 
01901 Return Value:
01902 
01903     Only returns STATUS_SUCCESS
01904 
01905 --*/
01906 
01907 {
01908     SECURITY_DESCRIPTOR *SecurityDescriptor = AccessState-&gt;<a class="code" href="../../d2/d5/struct__ACCESS__STATE.html#o10">SecurityDescriptor</a>;
01909 
01910     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01911 
01912     <span class="comment">//</span>
01913     <span class="comment">//  First make sure the access state has a security descriptor.  If there</span>
01914     <span class="comment">//  is one and it has a system acl and the previously granted access did</span>
01915     <span class="comment">//  not include system security then add the fact that we want system</span>
01916     <span class="comment">//  security to the remaining desired access state.</span>
01917     <span class="comment">//</span>
01918 
01919     <span class="keywordflow">if</span> (SecurityDescriptor != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01920 
01921         <span class="keywordflow">if</span> ( SecurityDescriptor-&gt;Control &amp; SE_SACL_PRESENT ) {
01922 
01923             <span class="keywordflow">if</span> ( !(AccessState-&gt;<a class="code" href="../../d2/d5/struct__ACCESS__STATE.html#o7">PreviouslyGrantedAccess</a> &amp; ACCESS_SYSTEM_SECURITY)) {
01924 
01925                 AccessState-&gt;<a class="code" href="../../d2/d5/struct__ACCESS__STATE.html#o6">RemainingDesiredAccess</a> |= ACCESS_SYSTEM_SECURITY;
01926             }
01927         }
01928     }
01929 
01930     <span class="keywordflow">return</span>( STATUS_SUCCESS );
01931 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a83" doxytag="obp.h::ObpValidateDesiredAccess" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS ObpValidateDesiredAccess           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN ACCESS_MASK&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>DesiredAccess</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d0/obhandle_8c-source.html#l02752">2752</a> of file <a class="el" href="../../d0/d0/obhandle_8c-source.html">obhandle.c</a>.
<p>
Referenced by <a class="el" href="../../d0/d0/obhandle_8c-source.html#l00163">NtDuplicateObject()</a>.
<p>
<pre class="fragment"><div>02758                    :
02759 
02760     This routine checks <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> input desired access mask to see that
02761     some invalid bits are not set.  The invalid bits are <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> top
02762     two reserved bits and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> top three standard rights bits.
02763     See \nt\<span class="keyword">public</span>\sdk\inc\ntseapi.h <span class="keywordflow">for</span> more details.
02764 
02765 Arguments:
02766 
02767     DesiredAccess - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> mask being checked
02768 
02769 Return Value:
02770 
02771     STATUS_ACCESS_DENIED <span class="keywordflow">if</span> one or more of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> wrongs bits are set and
02772     STATUS_SUCCESS otherwise
02773 
02774 --*/
02775 
02776 {
02777     <span class="keywordflow">if</span> (DesiredAccess &amp; 0x0CE00000) {
02778 
02779         <span class="keywordflow">return</span>( STATUS_ACCESS_DENIED );
02780 
02781     } <span class="keywordflow">else</span> {
02782 
02783         <span class="keywordflow">return</span>( STATUS_SUCCESS );
02784     }
02785 }

</div></pre>    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a52" doxytag="obp.h::ObpCreateInfoLookasideList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html">NPAGED_LOOKASIDE_LIST</a> <a class="el" href="../../d5/d1/obp_8h.html#a52">ObpCreateInfoLookasideList</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/obp_8h-source.html#l00384">384</a> of file <a class="el" href="../../d6/d0/obp_8h-source.html">obp.h</a>.
<p>
Referenced by <a class="el" href="../../d1/d0/obinit_8c-source.html#l00117">ObInitSystem()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a34" doxytag="obp.h::ObpDefaultObject" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> <a class="el" href="../../d5/d1/obp_8h.html#a34">ObpDefaultObject</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/obp_8h-source.html#l00088">88</a> of file <a class="el" href="../../d6/d0/obp_8h-source.html">obp.h</a>.
<p>
Referenced by <a class="el" href="../../d1/d1/obtype_8c-source.html#l00069">ObCreateObjectType()</a>, and <a class="el" href="../../d1/d0/obinit_8c-source.html#l00117">ObInitSystem()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a37" doxytag="obp.h::ObpDeviceMapLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> KSPIN_LOCK <a class="el" href="../../d5/d1/obp_8h.html#a37">ObpDeviceMapLock</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/obp_8h-source.html#l00098">98</a> of file <a class="el" href="../../d6/d0/obp_8h-source.html">obp.h</a>.
<p>
Referenced by <a class="el" href="../../d8/d9/obdevmap_8c-source.html#l00416">ObDereferenceDeviceMap()</a>, <a class="el" href="../../d8/d9/obdevmap_8c-source.html#l00343">ObInheritDeviceMap()</a>, <a class="el" href="../../d1/d0/obinit_8c-source.html#l00117">ObInitSystem()</a>, <a class="el" href="../../d9/d9/obdir_8c-source.html#l01081">ObpLookupObjectName()</a>, <a class="el" href="../../d8/d9/obdevmap_8c-source.html#l00236">ObQueryDeviceMapInformation()</a>, and <a class="el" href="../../d8/d9/obdevmap_8c-source.html#l00030">ObSetDeviceMap()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a44" doxytag="obp.h::ObpDeviceMapObjectType" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> <a class="el" href="../../d5/d1/obp_8h.html#a44">ObpDeviceMapObjectType</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/obp_8h-source.html#l00369">369</a> of file <a class="el" href="../../d6/d0/obp_8h-source.html">obp.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a42" doxytag="obp.h::ObpDirectoryObjectType" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> <a class="el" href="../../d5/d1/obp_8h.html#a42">ObpDirectoryObjectType</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/obp_8h-source.html#l00367">367</a> of file <a class="el" href="../../d6/d0/obp_8h-source.html">obp.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d9/obdir_8c-source.html#l00032">NtCreateDirectoryObject()</a>, <a class="el" href="../../d9/d9/obdir_8c-source.html#l00144">NtOpenDirectoryObject()</a>, <a class="el" href="../../d9/d9/obdir_8c-source.html#l00229">NtQueryDirectoryObject()</a>, <a class="el" href="../../d0/d1/obse_8c-source.html#l01574">ObAssignSecurity()</a>, <a class="el" href="../../d1/d0/obinit_8c-source.html#l00117">ObInitSystem()</a>, <a class="el" href="../../d9/d9/obdir_8c-source.html#l01081">ObpLookupObjectName()</a>, <a class="el" href="../../d5/d0/oblink_8c-source.html#l01121">ObpProcessDosDeviceSymbolicLink()</a>, <a class="el" href="../../d8/d9/obdevmap_8c-source.html#l00030">ObSetDeviceMap()</a>, and <a class="el" href="../../d0/d1/obse_8c-source.html#l01748">ObSetSecurityDescriptorInfo()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a49" doxytag="obp.h::ObpDosDevicesShortName" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> UNICODE_STRING <a class="el" href="../../d5/d1/obp_8h.html#a49">ObpDosDevicesShortName</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/obp_8h-source.html#l00375">375</a> of file <a class="el" href="../../d6/d0/obp_8h-source.html">obp.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a47" doxytag="obp.h::ObpDosDevicesShortNamePrefix" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULARGE_INTEGER <a class="el" href="../../d5/d1/obp_8h.html#a47">ObpDosDevicesShortNamePrefix</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/obp_8h-source.html#l00373">373</a> of file <a class="el" href="../../d6/d0/obp_8h-source.html">obp.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a48" doxytag="obp.h::ObpDosDevicesShortNameRoot" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULARGE_INTEGER <a class="el" href="../../d5/d1/obp_8h.html#a48">ObpDosDevicesShortNameRoot</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/obp_8h-source.html#l00374">374</a> of file <a class="el" href="../../d6/d0/obp_8h-source.html">obp.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a54" doxytag="obp.h::ObpKernelHandleTable" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d6/d3/struct__HANDLE__TABLE.html">PHANDLE_TABLE</a> <a class="el" href="../../d5/d1/obp_8h.html#a54">ObpKernelHandleTable</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/obp_8h-source.html#l00399">399</a> of file <a class="el" href="../../d6/d0/obp_8h-source.html">obp.h</a>.
<p>
Referenced by <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d7/d0/obquery_8c-source.html#l00545">NtSetInformationObject()</a>, <a class="el" href="../../d2/d1/obwait_8c-source.html#l00406">NtWaitForMultipleObjects()</a>, <a class="el" href="../../d1/d0/obinit_8c-source.html#l00117">ObInitSystem()</a>, <a class="el" href="../../d0/d0/obhandle_8c-source.html#l02160">ObpCreateHandle()</a>, <a class="el" href="../../d0/d0/obhandle_8c-source.html#l02507">ObpCreateUnnamedHandle()</a>, and <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a33" doxytag="obp.h::ObpLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> KSPIN_LOCK <a class="el" href="../../d5/d1/obp_8h.html#a33">ObpLock</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/obp_8h-source.html#l00087">87</a> of file <a class="el" href="../../d6/d0/obp_8h-source.html">obp.h</a>.
<p>
Referenced by <a class="el" href="../../d8/d0/obref_8c-source.html#l01124">ObfDereferenceObject()</a>, <a class="el" href="../../d1/d0/obinit_8c-source.html#l00117">ObInitSystem()</a>, and <a class="el" href="../../d8/d0/obref_8c-source.html#l01299">ObpProcessRemoveObjectQueue()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a53" doxytag="obp.h::ObpNameBufferLookasideList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html">NPAGED_LOOKASIDE_LIST</a> <a class="el" href="../../d5/d1/obp_8h.html#a53">ObpNameBufferLookasideList</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/obp_8h-source.html#l00392">392</a> of file <a class="el" href="../../d6/d0/obp_8h-source.html">obp.h</a>.
<p>
Referenced by <a class="el" href="../../d1/d0/obinit_8c-source.html#l00117">ObInitSystem()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a38" doxytag="obp.h::ObpObjectTypes" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> <a class="el" href="../../d5/d1/obp_8h.html#a38">ObpObjectTypes</a>[OBP_MAX_DEFINED_OBJECT_TYPES]          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/obp_8h-source.html#l00229">229</a> of file <a class="el" href="../../d6/d0/obp_8h-source.html">obp.h</a>.
<p>
Referenced by <a class="el" href="../../d7/d0/obquery_8c-source.html#l00058">NtQueryObject()</a>, and <a class="el" href="../../d1/d1/obtype_8c-source.html#l00069">ObCreateObjectType()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a36" doxytag="obp.h::ObpRemoveObjectQueue" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PSINGLE_LIST_ENTRY <a class="el" href="../../d5/d1/obp_8h.html#a36">ObpRemoveObjectQueue</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/obp_8h-source.html#l00090">90</a> of file <a class="el" href="../../d6/d0/obp_8h-source.html">obp.h</a>.
<p>
Referenced by <a class="el" href="../../d8/d0/obref_8c-source.html#l01124">ObfDereferenceObject()</a>, <a class="el" href="../../d1/d0/obinit_8c-source.html#l00117">ObInitSystem()</a>, and <a class="el" href="../../d8/d0/obref_8c-source.html#l01299">ObpProcessRemoveObjectQueue()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a35" doxytag="obp.h::ObpRemoveObjectWorkItem" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d7/d9/struct__WORK__QUEUE__ITEM.html">WORK_QUEUE_ITEM</a> <a class="el" href="../../d5/d1/obp_8h.html#a35">ObpRemoveObjectWorkItem</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/obp_8h-source.html#l00089">89</a> of file <a class="el" href="../../d6/d0/obp_8h-source.html">obp.h</a>.
<p>
Referenced by <a class="el" href="../../d8/d0/obref_8c-source.html#l01124">ObfDereferenceObject()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a50" doxytag="obp.h::ObpRootDirectoryMutex" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d6/d4/struct__ERESOURCE.html">ERESOURCE</a> <a class="el" href="../../d5/d1/obp_8h.html#a50">ObpRootDirectoryMutex</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/obp_8h-source.html#l00377">377</a> of file <a class="el" href="../../d6/d0/obp_8h-source.html">obp.h</a>.
<p>
Referenced by <a class="el" href="../../d1/d0/obinit_8c-source.html#l00117">ObInitSystem()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a45" doxytag="obp.h::ObpRootDirectoryObject" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d8/d4/struct__OBJECT__DIRECTORY.html">POBJECT_DIRECTORY</a> <a class="el" href="../../d5/d1/obp_8h.html#a45">ObpRootDirectoryObject</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/obp_8h-source.html#l00370">370</a> of file <a class="el" href="../../d6/d0/obp_8h-source.html">obp.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a43" doxytag="obp.h::ObpSymbolicLinkObjectType" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> <a class="el" href="../../d5/d1/obp_8h.html#a43">ObpSymbolicLinkObjectType</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/obp_8h-source.html#l00368">368</a> of file <a class="el" href="../../d6/d0/obp_8h-source.html">obp.h</a>.
<p>
Referenced by <a class="el" href="../../d5/d0/oblink_8c-source.html#l00052">NtCreateSymbolicLinkObject()</a>, <a class="el" href="../../d5/d0/oblink_8c-source.html#l00247">NtOpenSymbolicLinkObject()</a>, <a class="el" href="../../d7/d0/obquery_8c-source.html#l00058">NtQueryObject()</a>, <a class="el" href="../../d5/d0/oblink_8c-source.html#l00333">NtQuerySymbolicLinkObject()</a>, <a class="el" href="../../d1/d0/obinit_8c-source.html#l00117">ObInitSystem()</a>, <a class="el" href="../../d2/d0/obinsert_8c-source.html#l00029">ObInsertObject()</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l01497">ObpDeleteNameCheck()</a>, <a class="el" href="../../d5/d0/oblink_8c-source.html#l01121">ObpProcessDosDeviceSymbolicLink()</a>, and <a class="el" href="../../d8/d0/obref_8c-source.html#l01022">ObReferenceObjectByPointer()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a46" doxytag="obp.h::ObpTypeDirectoryObject" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d8/d4/struct__OBJECT__DIRECTORY.html">POBJECT_DIRECTORY</a> <a class="el" href="../../d5/d1/obp_8h.html#a46">ObpTypeDirectoryObject</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/obp_8h-source.html#l00371">371</a> of file <a class="el" href="../../d6/d0/obp_8h-source.html">obp.h</a>.
<p>
Referenced by <a class="el" href="../../d1/d1/obtype_8c-source.html#l00069">ObCreateObjectType()</a>, and <a class="el" href="../../d1/d0/obinit_8c-source.html#l00117">ObInitSystem()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a41" doxytag="obp.h::ObpTypeObjectType" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> <a class="el" href="../../d5/d1/obp_8h.html#a41">ObpTypeObjectType</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/obp_8h-source.html#l00366">366</a> of file <a class="el" href="../../d6/d0/obp_8h-source.html">obp.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a51" doxytag="obp.h::SecurityDescriptorCacheLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d6/d4/struct__ERESOURCE.html">ERESOURCE</a> <a class="el" href="../../d5/d1/obp_8h.html#a51">SecurityDescriptorCacheLock</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/obp_8h-source.html#l00378">378</a> of file <a class="el" href="../../d6/d0/obp_8h-source.html">obp.h</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:44:59 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
