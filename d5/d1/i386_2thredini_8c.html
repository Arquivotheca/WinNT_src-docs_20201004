<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: i386/thredini.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>thredini.c File Reference</h1><code>#include "<a class="el" href="../../d1/d9/ki_8h-source.html">ki.h</a>"</code><br>

<p>
<a href="../../d6/d0/i386_2thredini_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/i386_2thredini_8c.html#a0">ASSERT_PROCESS</a>(E)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/i386_2thredini_8c.html#a1">ASSERT_THREAD</a>(E)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/i386_2thredini_8c.html#a2">ALIGN_DOWN</a>(address, amt)&nbsp;&nbsp;&nbsp;((ULONG)(address) &amp; ~(( amt ) - 1))</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/i386_2thredini_8c.html#a3">ALIGN_UP</a>(address, amt)&nbsp;&nbsp;&nbsp;(ALIGN_DOWN( (address + (amt) - 1), (amt) ))</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/i386_2thredini_8c.html#a5">KepSetAlignmentSpecialApc</a> (IN <a class="el" href="../../d1/d5/struct__KAPC.html">PKAPC</a> Apc, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a41">PKNORMAL_ROUTINE</a> *NormalRoutine, IN PVOID *NormalContext, IN PVOID *SystemArgument1, IN PVOID *SystemArgument2)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/i386_2thredini_8c.html#a6">KiInitializeContextThread</a> (IN <a class="el" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> Thread, IN <a class="el" href="../../d4/d9/ke_8h.html#a67">PKSYSTEM_ROUTINE</a> SystemRoutine, IN <a class="el" href="../../d4/d9/ke_8h.html#a66">PKSTART_ROUTINE</a> StartRoutine OPTIONAL, IN PVOID StartContext OPTIONAL, IN PCONTEXT ContextFrame OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/i386_2thredini_8c.html#a7">KeSetAutoAlignmentProcess</a> (IN <a class="el" href="../../d5/d7/struct__KPROCESS.html">PKPROCESS</a> Process, IN BOOLEAN Enable)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/i386_2thredini_8c.html#a8">KeSetAutoAlignmentThread</a> (IN <a class="el" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a> Thread, IN BOOLEAN Enable)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/i386_2thredini_8c.html#a4">KeI386XMMIPresent</a></td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a2" doxytag="i386/thredini.c::ALIGN_DOWN" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define ALIGN_DOWN          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">address,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>amt&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;((ULONG)(address) &amp; ~(( amt ) - 1))</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/i386_2thredini_8c-source.html#l00050">50</a> of file <a class="el" href="../../d6/d0/i386_2thredini_8c-source.html">i386/thredini.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="i386/thredini.c::ALIGN_UP" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define ALIGN_UP          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">address,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>amt&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;(ALIGN_DOWN( (address + (amt) - 1), (amt) ))</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/i386_2thredini_8c-source.html#l00051">51</a> of file <a class="el" href="../../d6/d0/i386_2thredini_8c-source.html">i386/thredini.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="i386/thredini.c::ASSERT_PROCESS" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define ASSERT_PROCESS          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">E&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>{                    \
    <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((E)-&gt;<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>.Type == ProcessObject); \
}
</div></pre>
<p>
Definition at line <a class="el" href="../../d6/d0/i386_2thredini_8c-source.html#l00037">37</a> of file <a class="el" href="../../d6/d0/i386_2thredini_8c-source.html">i386/thredini.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="i386/thredini.c::ASSERT_THREAD" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define ASSERT_THREAD          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">E&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>{                    \
    <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((E)-&gt;<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>.Type == ThreadObject); \
}
</div></pre>
<p>
Definition at line <a class="el" href="../../d6/d0/i386_2thredini_8c-source.html#l00041">41</a> of file <a class="el" href="../../d6/d0/i386_2thredini_8c-source.html">i386/thredini.c</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a5" doxytag="i386/thredini.c::KepSetAlignmentSpecialApc" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KepSetAlignmentSpecialApc           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d5/struct__KAPC.html">PKAPC</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Apc</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a41">PKNORMAL_ROUTINE</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>NormalRoutine</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>NormalContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemArgument1</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemArgument2</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d6/d0/i386_2thredini_8c-source.html#l00454">KeSetAutoAlignmentThread()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="i386/thredini.c::KeSetAutoAlignmentProcess" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN KeSetAutoAlignmentProcess           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d5/d7/struct__KPROCESS.html">PKPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Process</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>Enable</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/i386_2thredini_8c-source.html#l00393">393</a> of file <a class="el" href="../../d6/d0/i386_2thredini_8c-source.html">i386/thredini.c</a>.
<p>
References <a class="el" href="../../d5/d0/alpha_2thredini_8c-source.html#l00048">ASSERT_PROCESS</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01907">KiLockDispatcherDatabase</a>, and <a class="el" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase()</a>.
<p>
<pre class="fragment"><div>00400                    :
00401 
00402     This function sets <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data alignment handling mode <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified
00403     process and returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> previous data alignment handling mode.
00404 
00405 Arguments:
00406 
00407     Process  - Supplies a pointer to a dispatcher object of <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> process.
00408 
00409     Enable - Supplies a <span class="keywordtype">boolean</span> value that determines <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handling of data
00410         alignment exceptions <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process. <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> value of <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> causes all
00411         data alignment exceptions to be automatically handled by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> kernel.
00412         <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> value of <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> causes all data alignment exceptions to be actually
00413         raised as exceptions.
00414 
00415 Return Value:
00416 
00417     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> value of <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned <span class="keywordflow">if</span> data alignment exceptions were
00418     previously automatically handled by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> kernel. Otherwise, a value
00419     of <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
00420 
00421 --*/
00422 
00423 {
00424 
00425     KIRQL OldIrql;
00426     BOOLEAN Previous;
00427 
00428     <a class="code" href="../../d4/d1/alpha_2thredini_8c.html#a0">ASSERT_PROCESS</a>(Process);
00429 
00430     <span class="comment">//</span>
00431     <span class="comment">// Raise IRQL to dispatcher level and lock dispatcher database.</span>
00432     <span class="comment">//</span>
00433 
00434     <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;OldIrql);
00435 
00436     <span class="comment">//</span>
00437     <span class="comment">// Capture the previous data alignment handling mode and set the</span>
00438     <span class="comment">// specified data alignment mode.</span>
00439     <span class="comment">//</span>
00440 
00441     Previous = Process-&gt;AutoAlignment;
00442     Process-&gt;AutoAlignment = Enable;
00443 
00444     <span class="comment">//</span>
00445     <span class="comment">// Unlock dispatcher database, lower IRQL to its previous value, and</span>
00446     <span class="comment">// return the previous data alignment mode.</span>
00447     <span class="comment">//</span>
00448 
00449     <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(OldIrql);
00450     <span class="keywordflow">return</span> Previous;
00451 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="i386/thredini.c::KeSetAutoAlignmentThread" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN KeSetAutoAlignmentThread           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Thread</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>Enable</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/i386_2thredini_8c-source.html#l00454">454</a> of file <a class="el" href="../../d6/d0/i386_2thredini_8c-source.html">i386/thredini.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00086">APC_LEVEL</a>, <a class="el" href="../../d5/d0/alpha_2thredini_8c-source.html#l00052">ASSERT_THREAD</a>, <a class="el" href="../../d4/d9/ke_8h.html#a403a183">CurrentApcEnvironment</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d9/d8/client_2ntstubs_8c-source.html#l00086">Event()</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d6/alpha_2kdpcpu_8h-source.html#l00070">KeGetCurrentThread</a>, <a class="el" href="../../d6/d6/apcobj_8c-source.html#l00039">KeInitializeApc()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01066">KeInitializeEvent</a>, <a class="el" href="../../d6/d6/apcobj_8c-source.html#l00217">KeInsertQueueApc()</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql()</a>, <a class="el" href="../../d5/d1/i386_2thredini_8c.html#a5">KepSetAlignmentSpecialApc()</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01907">KiLockDispatcherDatabase</a>, <a class="el" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase()</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a175">NonPagedPoolMustSucceed</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00250">_KAPC::SystemArgument1</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00251">_KAPC::SystemArgument2</a>.
<p>
<pre class="fragment"><div>00461                    :
00462 
00463     This function sets <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data alignment handling mode <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified
00464     thread and returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> previous data alignment handling mode.
00465 
00466 Arguments:
00467 
00468     Thread - Supplies a pointer to a dispatcher object of <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> thread.
00469 
00470     Enable - Supplies a <span class="keywordtype">boolean</span> value that determines <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handling of data
00471         alignment exceptions <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified thread. <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> value of <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> causes
00472         all data alignment exceptions to be automatically handled by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> kernel.
00473         <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> value of <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> causes all data alignment exceptions to be actually
00474         raised as exceptions.
00475 
00476 Return Value:
00477 
00478     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> value of <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned <span class="keywordflow">if</span> data alignment exceptions were
00479     previously automatically handled by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> kernel. Otherwise, a value
00480     of <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
00481 
00482 --*/
00483 
00484 {
00485 
00486     BOOLEAN Previous;
00487     <a class="code" href="../../d1/d5/struct__KAPC.html">PKAPC</a> Apc;
00488     <a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a> <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>;
00489     KIRQL OldIrql;
00490 
00491     <a class="code" href="../../d4/d1/alpha_2thredini_8c.html#a1">ASSERT_THREAD</a>(Thread);
00492 
00493     <span class="comment">//</span>
00494     <span class="comment">// Raise IRQL to dispatcher level and lock dispatcher database.</span>
00495     <span class="comment">//</span>
00496 
00497     <a class="code" href="../../d4/d9/ke_8h.html#a36">KiLockDispatcherDatabase</a>(&amp;OldIrql);
00498 
00499     <span class="comment">//</span>
00500     <span class="comment">// Capture the previous data alignment handling mode and set the</span>
00501     <span class="comment">// specified data alignment mode.</span>
00502     <span class="comment">//</span>
00503 
00504     Previous = Thread-&gt;AutoAlignment;
00505     Thread-&gt;AutoAlignment = Enable;
00506 
00507     <span class="comment">//</span>
00508     <span class="comment">// Unlock dispatcher database and lower IRQL to its previous value.</span>
00509     <span class="comment">//</span>
00510 
00511     <a class="code" href="../../d0/d0/ki_8h.html#a84">KiUnlockDispatcherDatabase</a>(OldIrql);
00512 
00513 <span class="preprocessor">#if 0</span>
00514 <span class="preprocessor"></span>    Apc = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(NonPagedPoolMustSucceed, <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d5/struct__KAPC.html">KAPC</a>));
00515     <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a> = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(NonPagedPoolMustSucceed, <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a>));
00516 
00517     <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>(Event, NotificationEvent, FALSE);
00518 
00519     <span class="keywordflow">if</span> ( Thread == <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>() ) {
00520 
00521         Apc-&gt;<a class="code" href="../../d1/d5/struct__KAPC.html#o9">SystemArgument1</a> = Thread;
00522         Apc-&gt;<a class="code" href="../../d1/d5/struct__KAPC.html#o10">SystemArgument2</a> = <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>;
00523 
00524         <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a>(APC_LEVEL, &amp;Irql);
00525         <a class="code" href="../../d5/d1/i386_2thredini_8c.html#a5">KepSetAlignmentSpecialApc</a>( Apc, NULL, NULL,
00526                                    &amp;Apc-&gt;<a class="code" href="../../d1/d5/struct__KAPC.html#o9">SystemArgument1</a>,
00527                                    &amp;Apc-&gt;<a class="code" href="../../d1/d5/struct__KAPC.html#o10">SystemArgument2</a> );
00528         <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>(Irql);
00529     } <span class="keywordflow">else</span> {
00530         <a class="code" href="../../d5/d7/apcobj_8c.html#a1">KeInitializeApc</a>( Apc,
00531                          Thread,
00532                          CurrentApcEnvironment,
00533                          KepSetAlignmentSpecialApc,
00534                          NULL,
00535                          NULL,
00536                          KernelMode,
00537                          NULL );
00538 
00539         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d7/apcobj_8c.html#a3">KeInsertQueueApc</a>( Apc,
00540                                Thread,
00541                                Event,
00542                                2 ) ) {
00543             <span class="comment">//</span>
00544             <span class="comment">// We couldn't queue the APC, so we will not be able to change</span>
00545             <span class="comment">// the AutoAlignment.  Update the thread object so that it</span>
00546             <span class="comment">// stays in sync with the hardware state.</span>
00547             <span class="comment">//</span>
00548 <span class="preprocessor">#if DBG</span>
00549 <span class="preprocessor"></span>            <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"KeSetAutoAlignmentThread: unable to change thread's context\n"</span>);
00550 <span class="preprocessor">#endif</span>
00551 <span class="preprocessor"></span>            Thread-&gt;AutoAlignment = Previous;
00552         }
00553 
00554         <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( Event,
00555                                Executive,
00556                                KernelMode,
00557                                FALSE,
00558                                NULL );
00559     }
00560 
00561     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(Apc);
00562     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(Event);
00563 <span class="preprocessor">#endif</span>
00564 <span class="preprocessor"></span>
00565     <span class="keywordflow">return</span>(Previous);
00566 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="i386/thredini.c::KiInitializeContextThread" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KiInitializeContextThread           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d8/struct__KTHREAD.html">PKTHREAD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Thread</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d4/d9/ke_8h.html#a67">PKSYSTEM_ROUTINE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemRoutine</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d4/d9/ke_8h.html#a66">PKSTART_ROUTINE</a> StartRoutine&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID StartContext&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PCONTEXT ContextFrame&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/i386_2thredini_8c-source.html#l00071">71</a> of file <a class="el" href="../../d6/d0/i386_2thredini_8c-source.html">i386/thredini.c</a>.
<p>
<pre class="fragment"><div>00081                    :
00082 
00083     This function initializes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> machine dependent context of a thread object.
00084 
00085     N.B. This function does not check <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> accessibility of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> context record.
00086          It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> assumed <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller of <span class="keyword">this</span> routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> either prepared to
00087          handle access violations or has probed and copied <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> context record
00088          as appropriate.
00089 
00090 Arguments:
00091 
00092     Thread - Supplies a pointer to a dispatcher object of <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> thread.
00093 
00094     SystemRoutine - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system function that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be
00095         called when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> first scheduled <span class="keywordflow">for</span> execution.
00096 
00097     StartRoutine - Supplies an optional pointer to a function that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be
00098         called after <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system has finished initializing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread. This
00099         parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> specified <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a system thread and will
00100         execute totally in kernel mode.
00101 
00102     StartContext - Supplies an optional pointer to an arbitrary data structure
00103         which will be passed to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> StartRoutine as a parameter. This
00104         parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> specified <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a system thread and will
00105         execute totally in kernel mode.
00106 
00107     ContextFrame - Supplies an optional pointer a context frame which contains
00108         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> initial user mode state of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread. This parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> specified
00109         <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a user thread and will execute in user mode. If <span class="keyword">this</span>
00110         parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not specified, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Teb parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> ignored.
00111 
00112 Return Value:
00113 
00114     None.
00115 
00116 --*/
00117 
00118 {
00119     PFX_SAVE_AREA NpxFrame;
00120     PKSWITCHFRAME SwitchFrame;
00121     PKTRAP_FRAME TrFrame;
00122     PULONG PSystemRoutine;
00123     PULONG PStartRoutine;
00124     PULONG PStartContext;
00125     PULONG PUserContextFlag;
00126     ULONG  ContextFlags;
00127     CONTEXT <a class="code" href="../../d3/d1/threads_8h.html#a108">Context2</a>;
00128     PCONTEXT ContextFrame2 = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00129     PFXSAVE_FORMAT   PFxSaveArea;
00130 
00131     <span class="comment">//</span>
00132     <span class="comment">// If a context frame is specified, then initialize a trap frame and</span>
00133     <span class="comment">// and an exception frame with the specified user mode context.</span>
00134     <span class="comment">//</span>
00135 
00136     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ContextFrame)) {
00137 
00138         RtlMoveMemory(&amp;Context2, ContextFrame, <span class="keyword">sizeof</span>(CONTEXT));
00139         ContextFrame2 = &amp;<a class="code" href="../../d3/d1/threads_8h.html#a108">Context2</a>;
00140         ContextFlags = <a class="code" href="../../d6/d7/halmips_8h.html#a153">CONTEXT_CONTROL</a>;
00141 
00142         <span class="comment">//</span>
00143         <span class="comment">// The 80387 save area is at the very base of the kernel stack.</span>
00144         <span class="comment">//</span>
00145 
00146         NpxFrame = (PFX_SAVE_AREA)(((ULONG)(Thread-&gt;InitialStack) -
00147                     <span class="keyword">sizeof</span>(FX_SAVE_AREA)));
00148 
00149         <span class="comment">//</span>
00150         <span class="comment">// Load up an initial NPX state.</span>
00151         <span class="comment">//</span>
00152 
00153         <span class="keywordflow">if</span> (<a class="code" href="../../d9/d8/i386_2exceptn_8c.html#a9">KeI386XMMIPresent</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00154             PFxSaveArea = (PFXSAVE_FORMAT)ContextFrame2-&gt;ExtendedRegisters;
00155     
00156             PFxSaveArea-&gt;ControlWord   = 0x27f;  <span class="comment">// like fpinit but 64bit mode</span>
00157             PFxSaveArea-&gt;StatusWord    = 0;
00158             PFxSaveArea-&gt;TagWord       = 0;
00159             PFxSaveArea-&gt;ErrorOffset   = 0;
00160             PFxSaveArea-&gt;ErrorSelector = 0;
00161             PFxSaveArea-&gt;DataOffset    = 0;
00162             PFxSaveArea-&gt;DataSelector  = 0;
00163             PFxSaveArea-&gt;MXCsr         = 0x1f80; <span class="comment">// mask all the exceptions</span>
00164         } <span class="keywordflow">else</span> {
00165             ContextFrame2-&gt;FloatSave.ControlWord   = 0x27f;  <span class="comment">// like fpinit but 64bit mode</span>
00166             ContextFrame2-&gt;FloatSave.StatusWord    = 0;
00167             ContextFrame2-&gt;FloatSave.TagWord       = 0xffff;
00168             ContextFrame2-&gt;FloatSave.ErrorOffset   = 0;
00169             ContextFrame2-&gt;FloatSave.ErrorSelector = 0;
00170             ContextFrame2-&gt;FloatSave.DataOffset    = 0;
00171             ContextFrame2-&gt;FloatSave.DataSelector  = 0;
00172         }
00173 
00174 
00175         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d3/i386_8h.html#a23">KeI386NpxPresent</a>) {
00176             ContextFrame2-&gt;FloatSave.Cr0NpxState = 0;
00177             NpxFrame-&gt;Cr0NpxState = 0;
00178             NpxFrame-&gt;NpxSavedCpu = 0;
00179             <span class="keywordflow">if</span> (<a class="code" href="../../d9/d8/i386_2exceptn_8c.html#a9">KeI386XMMIPresent</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00180                 ContextFlags |= CONTEXT_EXTENDED_REGISTERS;
00181             } <span class="keywordflow">else</span> {
00182                 ContextFlags |= <a class="code" href="../../d6/d7/halmips_8h.html#a154">CONTEXT_FLOATING_POINT</a>;
00183             }
00184 
00185             <span class="comment">//</span>
00186             <span class="comment">// Threads NPX state is not in the coprocessor.</span>
00187             <span class="comment">//</span>
00188 
00189             Thread-&gt;NpxState = NPX_STATE_NOT_LOADED;
00190             Thread-&gt;NpxIrql = <a class="code" href="../../d1/d3/ppcdef_8h.html#a21">PASSIVE_LEVEL</a>;
00191 
00192         } <span class="keywordflow">else</span> {
00193             NpxFrame-&gt;Cr0NpxState = CR0_EM;
00194 
00195             <span class="comment">//</span>
00196             <span class="comment">// Threads NPX state is not in the coprocessor.</span>
00197             <span class="comment">// In the emulator case, do not set the CR0_EM bit as their</span>
00198             <span class="comment">// emulators may not want exceptions on FWAIT instructions.</span>
00199             <span class="comment">//</span>
00200 
00201             Thread-&gt;NpxState = NPX_STATE_NOT_LOADED &amp; ~CR0_MP;
00202         }
00203 
00204         <span class="comment">//</span>
00205         <span class="comment">// Force debug registers off.  They won't work anyway from an</span>
00206         <span class="comment">// initial frame, debuggers must set a hard breakpoint in the target</span>
00207         <span class="comment">//</span>
00208 
00209         ContextFrame2-&gt;Dr0 = 0;
00210         ContextFrame2-&gt;Dr1 = 0;
00211         ContextFrame2-&gt;Dr2 = 0;
00212         ContextFrame2-&gt;Dr3 = 0;
00213         ContextFrame2-&gt;Dr6 = 0;
00214         ContextFrame2-&gt;Dr7 = 0;
00215         ContextFrame2-&gt;ContextFlags &amp;= ~(CONTEXT_DEBUG_REGISTERS);
00216 <span class="preprocessor">#if 0</span>
00217 <span class="preprocessor"></span>        <span class="comment">//</span>
00218         <span class="comment">// If AutoAlignment is FALSE, we want to set the Alignment Check bit</span>
00219         <span class="comment">// in Eflags, so we will get alignment faults.</span>
00220         <span class="comment">//</span>
00221 
00222         <span class="keywordflow">if</span> (Thread-&gt;AutoAlignment == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00223             ContextFrame2-&gt;EFlags |= EFLAGS_ALIGN_CHECK;
00224         }
00225 <span class="preprocessor">#endif</span>
00226 <span class="preprocessor"></span>        <span class="comment">//</span>
00227         <span class="comment">// If the thread is set</span>
00228 
00229         TrFrame = (PKTRAP_FRAME)(((ULONG)NpxFrame - KTRAP_FRAME_LENGTH));
00230 
00231         <span class="comment">//  Space for arguments to KiThreadStartup.  Order is important,</span>
00232         <span class="comment">//  Since args are passed on stack through KiThreadStartup to</span>
00233         <span class="comment">//  PStartRoutine with PStartContext as an argument.</span>
00234 
00235         PUserContextFlag = (PULONG)TrFrame - 1;
00236         PStartContext = PUserContextFlag - 1;
00237         PStartRoutine = PStartContext - 1;
00238         PSystemRoutine = PStartRoutine - 1;
00239 
00240         SwitchFrame = (PKSWITCHFRAME)((PUCHAR)PSystemRoutine -
00241                                     <span class="keyword">sizeof</span>(KSWITCHFRAME));
00242 
00243         <span class="comment">//</span>
00244         <span class="comment">// Copy information from the specified context frame to the trap and</span>
00245         <span class="comment">// exception frames.</span>
00246         <span class="comment">//</span>
00247 
00248         <a class="code" href="../../d2/d9/ppc_2exceptn_8c.html#a10">KeContextToKframes</a>(TrFrame, NULL, ContextFrame2,
00249                            ContextFrame2-&gt;ContextFlags | ContextFlags,
00250                            UserMode);
00251 
00252         TrFrame-&gt;HardwareSegSs |= RPL_MASK;
00253         TrFrame-&gt;SegDs |= RPL_MASK;
00254         TrFrame-&gt;SegEs |= RPL_MASK;
00255 
00256 <span class="preprocessor">#if DBG</span>
00257 <span class="preprocessor"></span>        TrFrame-&gt;DbgArgMark = 0xBADB0D00;
00258 <span class="preprocessor">#endif</span>
00259 <span class="preprocessor"></span>
00260         <span class="comment">//</span>
00261         <span class="comment">// Tell KiThreadStartup that a user context is present.</span>
00262         <span class="comment">//</span>
00263 
00264         *PUserContextFlag = 1;
00265 
00266 
00267         <span class="comment">//</span>
00268         <span class="comment">// Initialize the kernel mode ExceptionList pointer</span>
00269         <span class="comment">//</span>
00270 
00271         TrFrame-&gt;ExceptionList = EXCEPTION_CHAIN_END;
00272 
00273         <span class="comment">//</span>
00274         <span class="comment">// Initialize the saved previous processor mode.</span>
00275         <span class="comment">//</span>
00276 
00277         TrFrame-&gt;PreviousPreviousMode = <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>;
00278 
00279         <span class="comment">//</span>
00280         <span class="comment">// Set the previous mode in thread object to user.</span>
00281         <span class="comment">//</span>
00282 
00283         Thread-&gt;PreviousMode = <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>;
00284 
00285 
00286     } <span class="keywordflow">else</span> {
00287 
00288         <span class="comment">//</span>
00289         <span class="comment">// Dummy floating save area.  Kernel threads don't have or use</span>
00290         <span class="comment">// the floating point - the dummy save area is make the stacks</span>
00291         <span class="comment">// consistent.</span>
00292         <span class="comment">//</span>
00293 
00294         NpxFrame = (PFX_SAVE_AREA)(((ULONG)(Thread-&gt;InitialStack) -
00295                     <span class="keyword">sizeof</span>(FX_SAVE_AREA)));
00296 
00297         <span class="comment">//</span>
00298         <span class="comment">// Load up an initial NPX state.</span>
00299         <span class="comment">//</span>
00300         RtlZeroMemory((PVOID)NpxFrame, <span class="keyword">sizeof</span>(FX_SAVE_AREA));
00301 
00302         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d3/i386_8h.html#a24">KeI386FxsrPresent</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00303             NpxFrame-&gt;U.FxArea.ControlWord = 0x27f;<span class="comment">//like fpinit but 64bit mode</span>
00304             NpxFrame-&gt;U.FxArea.MXCsr       = 0x1f80;<span class="comment">// mask all the exceptions</span>
00305         } <span class="keywordflow">else</span> {
00306             NpxFrame-&gt;U.FnArea.ControlWord  = 0x27f;<span class="comment">//like fpinit but 64bit mode</span>
00307             NpxFrame-&gt;U.FnArea.TagWord      = 0xffff;
00308         }
00309 
00310         <span class="comment">//</span>
00311         <span class="comment">// Threads NPX state is not in the coprocessor.</span>
00312         <span class="comment">//</span>
00313 
00314         Thread-&gt;NpxState = NPX_STATE_NOT_LOADED;
00315 
00316         <span class="comment">//</span>
00317         <span class="comment">//  Space for arguments to KiThreadStartup.</span>
00318         <span class="comment">//  Order of fields in the switchframe is important,</span>
00319         <span class="comment">//  Since args are passed on stack through KiThreadStartup to</span>
00320         <span class="comment">//  PStartRoutine with PStartContext as an argument.</span>
00321         <span class="comment">//</span>
00322 
00323         PUserContextFlag = (PULONG)((ULONG)NpxFrame) - 1;
00324 
00325         PStartContext = PUserContextFlag - 1;
00326         PStartRoutine = PStartContext - 1;
00327         PSystemRoutine = PStartRoutine - 1;
00328 
00329         SwitchFrame = (PKSWITCHFRAME)((PUCHAR)PSystemRoutine -
00330                                         <span class="keyword">sizeof</span>(KSWITCHFRAME));
00331 
00332 
00333         <span class="comment">//</span>
00334         <span class="comment">// Tell KiThreadStartup that a user context is NOT present.</span>
00335         <span class="comment">//</span>
00336 
00337         *PUserContextFlag = 0;
00338 
00339 
00340         <span class="comment">//</span>
00341         <span class="comment">// Set the previous mode in thread object to kernel.</span>
00342         <span class="comment">//</span>
00343 
00344         Thread-&gt;PreviousMode = <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>;
00345     }
00346 
00347     <span class="comment">//</span>
00348     <span class="comment">//  Set up thread start parameters.</span>
00349     <span class="comment">//  (UserContextFlag set above)</span>
00350     <span class="comment">//</span>
00351 
00352     *PStartContext = (ULONG)StartContext;
00353     *PStartRoutine = (ULONG)StartRoutine;
00354     *PSystemRoutine = (ULONG)SystemRoutine;
00355 
00356 
00357     <span class="comment">//</span>
00358     <span class="comment">//  Set up switch frame.  Assume the thread doesn't use the 80387;</span>
00359     <span class="comment">//  if it ever does (and there is one), these flags will get reset.</span>
00360     <span class="comment">//  Each thread starts with these same flags set, regardless of</span>
00361     <span class="comment">//  whether the hardware exists or not.</span>
00362     <span class="comment">//</span>
00363 
00364     SwitchFrame-&gt;RetAddr = (ULONG)<a class="code" href="../../d0/d0/ki_8h.html#a139">KiThreadStartup</a>;
00365 
00366     SwitchFrame-&gt;Eflags = EFLAGS_INTERRUPT_MASK;
00367 
00368 <span class="preprocessor">#if 0</span>
00369 <span class="preprocessor"></span>    <span class="comment">//</span>
00370     <span class="comment">// If AutoAlignment is FALSE, we want to set the Alignment Check bit</span>
00371     <span class="comment">// in Eflags, so we will get alignment faults.</span>
00372     <span class="comment">//</span>
00373 
00374     <span class="keywordflow">if</span> (Thread-&gt;AutoAlignment == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00375         SwitchFrame-&gt;Eflags |= EFLAGS_ALIGN_CHECK;
00376     }
00377 <span class="preprocessor">#endif</span>
00378 <span class="preprocessor"></span>
00379     SwitchFrame-&gt;ExceptionList = (ULONG)(EXCEPTION_CHAIN_END);
00380 
00381     <span class="comment">//</span>
00382     <span class="comment">// Set the initial kernel stack pointer.</span>
00383     <span class="comment">//</span>
00384 
00385 <span class="comment">//DbgPrint("KiInitializeContextThread Thread %08x  SwitchFrame %08x\n", Thread, SwitchFrame);</span>
00386 <span class="comment">//DbgPrint("PSystemRoutine %08x  PStartRoutine %08x  PStartContext %08x\n", *PSystemRoutine, *PStartRoutine, *PStartContext);</span>
00387 
00388     Thread-&gt;KernelStack = (PVOID)SwitchFrame;
00389     <span class="keywordflow">return</span>;
00390 }

</div></pre>    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a4" doxytag="i386/thredini.c::KeI386XMMIPresent" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN <a class="el" href="../../d5/d1/i386_2thredini_8c.html#a4">KeI386XMMIPresent</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/i386_2thredini_8c-source.html#l00067">67</a> of file <a class="el" href="../../d6/d0/i386_2thredini_8c-source.html">i386/thredini.c</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:45:45 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
