<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: mncomput.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>mncomput.c</h1><a href="../../d4/d2/mncomput_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/**************************** Module Header ********************************\</span>
00002 <span class="comment">* Module Name: mncomput.c</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00005 <span class="comment">*</span>
00006 <span class="comment">* Menu Layout Calculation Routines</span>
00007 <span class="comment">*</span>
00008 <span class="comment">* History:</span>
00009 <span class="comment">* 10-10-90 JimA       Cleanup.</span>
00010 <span class="comment">* 03-18-91 IanJa      Window revalidation added</span>
00011 <span class="comment">\***************************************************************************/</span>
00012 
00013 <span class="preprocessor">#include "<a class="code" href="../../d0/d4/w32_2ntuser_2kernel_2precomp_8h.html">precomp.h</a>"</span>
00014 <span class="preprocessor">#pragma hdrstop</span>
00015 <span class="preprocessor"></span>
00016 
00017 <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d4/d2/mncomput_8c.html#a0">MNRecalcTabStrings</a>(HDC, <a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a>, UINT, UINT, DWORD, DWORD);
00018 
00019 <span class="comment">/***************************************************************************\</span>
00020 <span class="comment">* xxxMNGetBitmapSize</span>
00021 <span class="comment">*</span>
00022 <span class="comment">* returns TRUE if measureitem was sent and FALSE if not</span>
00023 <span class="comment">*</span>
00024 <span class="comment">* History:</span>
00025 <span class="comment">*  07-23-96 GerardoB - Added header &amp; fixed up for 5.0</span>
00026 <span class="comment">\***************************************************************************/</span>
<a name="l00027"></a><a class="code" href="../../d4/d2/mncomput_8c.html#a1">00027</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d2/mncomput_8c.html#a1">xxxMNGetBitmapSize</a>(<a class="code" href="../../d0/d9/structtagITEM.html">LPITEM</a> pItem, <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndNotify)
00028 {
00029     MEASUREITEMSTRUCT mis;
00030 
00031     <span class="keywordflow">if</span> (pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o17">cxBmp</a> != <a class="code" href="../../d4/d1/userk_8h.html#a533">MNIS_MEASUREBMP</a>) {
00032         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00033     }
00034 
00035     <span class="comment">// Send a measure item message to the owner</span>
00036     mis.CtlType = ODT_MENU;
00037     mis.CtlID = 0;
00038     mis.itemID  = pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o2">wID</a>;
00039     mis.itemWidth = 0;
00040 <span class="comment">// After scrollable menus</span>
00041 <span class="comment">//    mis32.itemHeight= gcyMenuFontChar;</span>
00042     mis.itemHeight= (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)<a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;cySysFontChar;
00043     mis.itemData = pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o8">dwItemData</a>;
00044 
00045     <a class="code" href="../../d4/d1/userk_8h.html#a1579">xxxSendMessage</a>(pwndNotify, WM_MEASUREITEM, 0, (LPARAM)&amp;mis);
00046 
00047     pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o17">cxBmp</a> = mis.itemWidth;
00048     pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o18">cyBmp</a> = mis.itemHeight;
00049 
00050     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00051 }
00052 
00053 <span class="comment">/***************************************************************************\</span>
00054 <span class="comment">* xxxItemSize</span>
00055 <span class="comment">*</span>
00056 <span class="comment">* Calc the dimensions of bitmaps and strings. Loword of returned</span>
00057 <span class="comment">* value contains width, high word contains height of item.</span>
00058 <span class="comment">*</span>
00059 <span class="comment">* History:</span>
00060 <span class="comment">*  07-23-96 GerardoB - fixed up for 5.0</span>
00061 <span class="comment">\***************************************************************************/</span>
<a name="l00062"></a><a class="code" href="../../d4/d2/mncomput_8c.html#a2">00062</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d2/mncomput_8c.html#a2">xxxMNItemSize</a>(
00063     <a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a> pMenu,
00064     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndNotify,
00065     HDC hdc,
00066     <a class="code" href="../../d0/d9/structtagITEM.html">PITEM</a> pItem,
00067     BOOL fPopup,
00068     LPPOINT lppt)
00069 {
00070     BITMAP bmp;
00071     <span class="keywordtype">int</span> width = 0;
00072     <span class="keywordtype">int</span> height = 0;
00073     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> xRightJustify;
00074     LPWSTR lpMenuString;
00075     HFONT               hfnOld;
00076     <span class="keywordtype">int</span>                 tcExtra;
00077 
00078     UNREFERENCED_PARAMETER(pMenu);
00079 
00080     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pMenu);
00081     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwndNotify);
00082 
00083     <span class="keywordflow">if</span> (!fPopup) {
00084 
00085         <span class="comment">/*</span>
00086 <span class="comment">         * Save off the height of the top menu bar since we will used this often</span>
00087 <span class="comment">         * if the pItem is not in a popup.  (ie.  it is in the top level menu bar)</span>
00088 <span class="comment">         */</span>
00089         height = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYMENUSIZE);
00090     }
00091 
00092     hfnOld = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00093     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a788">TestMFS</a>(pItem, MFS_DEFAULT)) {
00094         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a138">ghMenuFontDef</a>)
00095             hfnOld = GreSelectFont(hdc, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a138">ghMenuFontDef</a>);
00096         <span class="keywordflow">else</span> {
00097             tcExtra = GreGetTextCharacterExtra(hdc);
00098             GreSetTextCharacterExtra(hdc, tcExtra + 1 + (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a139">gcxMenuFontChar</a> / <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;cxSysFontChar));
00099         }
00100     }
00101 
00102     <span class="comment">/*</span>
00103 <span class="comment">     * Compute bitmap dimensions if needed</span>
00104 <span class="comment">     */</span>
00105     <span class="keywordflow">if</span> (pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o16">hbmp</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)  {
00106         <span class="keywordflow">if</span> (pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o16">hbmp</a> == HBMMENU_CALLBACK) {
00107             <a class="code" href="../../d4/d2/mncomput_8c.html#a1">xxxMNGetBitmapSize</a>(pItem, pwndNotify);
00108         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o17">cxBmp</a> == <a class="code" href="../../d4/d1/userk_8h.html#a533">MNIS_MEASUREBMP</a>) {
00109             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a788">TestMFS</a>(pItem, MFS_CACHEDBMP)) {
00110                 pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o17">cxBmp</a> = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXMENUSIZE);
00111                 pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o18">cyBmp</a> = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYMENUSIZE);
00112                 <span class="keywordflow">if</span> (pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o16">hbmp</a> == HBMMENU_SYSTEM) {
00113                     pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o17">cxBmp</a> += <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXEDGE);
00114                     <span class="comment">/*</span>
00115 <span class="comment">                     * Chicago/Memphis only stretch the width,</span>
00116 <span class="comment">                     * not the height.  NT Bug 124779.  FritzS</span>
00117 <span class="comment">                     */</span>
00118                  <span class="comment">//  pItem-&gt;cyBmp += SYSMET(CXEDGE);</span>
00119                 }
00120             } <span class="keywordflow">else</span> {
00121                 <span class="keywordflow">if</span> (GreExtGetObjectW(pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o16">hbmp</a>, <span class="keyword">sizeof</span>(BITMAP), (LPSTR)&amp;bmp)) {
00122                     pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o17">cxBmp</a> = bmp.bmWidth;
00123                     pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o18">cyBmp</a> = bmp.bmHeight;
00124                 } <span class="keywordflow">else</span> {
00125                     <span class="comment">/*</span>
00126 <span class="comment">                     * If the bitmap is not useable, this is as good a default</span>
00127 <span class="comment">                     * as any.</span>
00128 <span class="comment">                     */</span>
00129                     pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o17">cxBmp</a> = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXMENUSIZE);
00130                     pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o18">cyBmp</a> = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYMENUSIZE);
00131                 }
00132             }
00133         }
00134         width = pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o17">cxBmp</a>;
00135         <span class="comment">/*</span>
00136 <span class="comment">         * Remember the max bitmap width to align the text in all items.</span>
00137 <span class="comment">         */</span>
00138         pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o7">cxTextAlign</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o7">cxTextAlign</a>, (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)width);
00139         <span class="comment">/*</span>
00140 <span class="comment">         * In menu bars, we force the item to be at least CYMNSIZE.</span>
00141 <span class="comment">         * Fixes many, many problems w/ apps that fake own MDI.</span>
00142 <span class="comment">         */</span>
00143         <span class="keywordflow">if</span> (fPopup) {
00144             height = pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o18">cyBmp</a>;
00145         } <span class="keywordflow">else</span> {
00146             height = <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>((<span class="keywordtype">int</span>)pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o18">cyBmp</a>, height);
00147         }
00148     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a791">TestMFT</a>(pItem, MFT_OWNERDRAW)) {
00149         <span class="comment">// This is an ownerdraw item -- the width and height are stored in</span>
00150         <span class="comment">// cxBmp and cyBmp</span>
00151         <a class="code" href="../../d4/d2/mncomput_8c.html#a1">xxxMNGetBitmapSize</a>(pItem, pwndNotify);
00152         width = pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o17">cxBmp</a>;
00153         <span class="comment">//</span>
00154         <span class="comment">// Ignore height with menu bar now--that's set by user.</span>
00155         <span class="comment">//</span>
00156         <span class="keywordflow">if</span> (fPopup) {
00157             height = pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o18">cyBmp</a>;
00158             <span class="comment">// If this item has a popup (hierarchical) menu associated with it, then</span>
00159             <span class="comment">// reserve room for the bitmap that tells the user that a hierarchical</span>
00160             <span class="comment">// menu exists here.</span>
00161             <span class="comment">// B#2966, t-arthb</span>
00162 
00163             UserAssert(fPopup == (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a786">TestMF</a>(pMenu, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a142">MFISPOPUP</a>) != 0));
00164 
00165             width = width + (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a139">gcxMenuFontChar</a> &lt;&lt; 1);
00166         }
00167     }
00168 
00169     <span class="keywordflow">if</span> ((pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o6">lpstr</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a791">TestMFT</a>(pItem, MFT_OWNERDRAW)) ) {
00170         SIZE size;
00171 
00172         <span class="comment">/*</span>
00173 <span class="comment">         * This menu item contains a string</span>
00174 <span class="comment">         */</span>
00175 
00176         <span class="comment">/*</span>
00177 <span class="comment">         * We want to keep the menu bar height if this isn't a popup.</span>
00178 <span class="comment">         */</span>
00179         <span class="keywordflow">if</span> (fPopup) {
00180             <span class="comment">/* The thickness of mnemonic underscore is CYBORDER and the gap</span>
00181 <span class="comment">             * between the characters and the underscore is another CYBORDER</span>
00182 <span class="comment">             */</span>
00183             height = <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(height, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a140">gcyMenuFontChar</a> + <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a142">gcyMenuFontExternLeading</a> + <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYEDGE));
00184         }
00185 
00186         lpMenuString = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a909">TextPointer</a>(pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o6">lpstr</a>);
00187         xRightJustify = <a class="code" href="../../d1/d5/w32_2ntuser_2rtl_2random_8c.html#a1">FindCharPosition</a>(lpMenuString, TEXT(<span class="charliteral">'\t'</span>));
00188 
00189         <a class="code" href="../../d4/d1/userk_8h.html#a1408">xxxPSMGetTextExtent</a>(hdc, lpMenuString, xRightJustify, &amp;size);
00190 
00191         <span class="keywordflow">if</span> (width) {
00192             width += <a class="code" href="../../d4/d1/userk_8h.html#a528">MNXSPACE</a> + size.cx;
00193         } <span class="keywordflow">else</span> {
00194             width =  size.cx;
00195         }
00196     }
00197 
00198     <span class="keywordflow">if</span> (fPopup &amp;&amp; !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a791">TestMFT</a>(pItem, MFT_OWNERDRAW)) {
00199         <span class="comment">/*</span>
00200 <span class="comment">         *  Add on space for checkmark, then horz spacing for default &amp; disabled</span>
00201 <span class="comment">         *   plus some left margin.</span>
00202 <span class="comment">         */</span>
00203         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a786">TestMF</a>(pMenu, MNS_CHECKORBMP) || !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a786">TestMF</a>(pMenu, MNS_NOCHECK)) {
00204             width += <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;oembmi[<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a330">OBI_MENUCHECK</a>].cx;
00205         }
00206         width += <a class="code" href="../../d4/d1/userk_8h.html#a528">MNXSPACE</a> + <a class="code" href="../../d4/d1/userk_8h.html#a529">MNLEFTMARGIN</a> + 2;
00207         height += 2;
00208     }
00209 
00210     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a788">TestMFS</a>(pItem, MFS_DEFAULT)) {
00211         <span class="keywordflow">if</span> (hfnOld)
00212             GreSelectFont(hdc, hfnOld);
00213         <span class="keywordflow">else</span>
00214             GreSetTextCharacterExtra(hdc, tcExtra);
00215     }
00216 
00217     <span class="comment">/*</span>
00218 <span class="comment">     * Loword contains width, high word contains height of item.</span>
00219 <span class="comment">     */</span>
00220     lppt-&gt;x = width;
00221     lppt-&gt;y = height;
00222 
00223     <span class="keywordflow">return</span>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a791">TestMFT</a>(pItem, MFT_OWNERDRAW));
00224 }
00225 <span class="comment">/***************************************************************************\</span>
00226 <span class="comment">* xxxMenuCompute2</span>
00227 <span class="comment">*</span>
00228 <span class="comment">* !</span>
00229 <span class="comment">*</span>
00230 <span class="comment">* History:</span>
00231 <span class="comment">\***************************************************************************/</span>
00232 
<a name="l00233"></a><a class="code" href="../../d4/d1/userk_8h.html#a1381">00233</a> <span class="keywordtype">int</span> <a class="code" href="../../d4/d1/userk_8h.html#a1381">xxxMNCompute</a>(
00234     <a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a> pMenu,
00235     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndNotify,
00236     DWORD yMenuTop,
00237     DWORD xMenuLeft,
00238     DWORD cxMax,
00239     LPDWORD lpdwMenuHeight)
00240 {
00241     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>         cItem;
00242     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>        cxItem;
00243     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>        cyItem;
00244     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>        cyItemKeep;
00245     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>        yPopupTop;
00246     <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>          cMaxWidth;
00247     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>        cMaxHeight;
00248     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>         cItemBegCol;
00249     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>        temp;
00250     <span class="keywordtype">int</span>          ret;
00251     <a class="code" href="../../d0/d9/structtagITEM.html">PITEM</a>        pCurItem;
00252     POINT        ptMNItemSize;
00253     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>         fOwnerDrawItems;
00254     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>         fMenuBreak;
00255     LPWSTR       lpsz;
00256     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>         fPopupMenu;
00257     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>        menuHeight = 0;
00258     HDC          hdc;
00259     HFONT        hOldFont;
00260     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a>  ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
00261     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>         fStringAndBitmapItems;
00262 
00263     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pMenu);
00264     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwndNotify);
00265 
00266     <span class="comment">/*</span>
00267 <span class="comment">     * Whoever computes the menu, becomes the owner.</span>
00268 <span class="comment">     */</span>
00269     <span class="keywordflow">if</span> (pwndNotify != pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o8">spwndNotify</a>) {
00270         <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o8">spwndNotify</a>, pwndNotify);
00271     }
00272 
00273 
00274     <span class="keywordflow">if</span> (lpdwMenuHeight != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00275         menuHeight = *lpdwMenuHeight;
00276 
00277     <span class="comment">/*</span>
00278 <span class="comment">     * Empty menus have a height of zero.</span>
00279 <span class="comment">     */</span>
00280     ret = 0;
00281     <span class="keywordflow">if</span> (pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o4">cItems</a> == 0)
00282         <span class="keywordflow">return</span> ret;
00283 
00284     hdc = <a class="code" href="../../d4/d1/userk_8h.html#a1695">_GetDCEx</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, DCX_WINDOW | DCX_CACHE);
00285     hOldFont = GreSelectFont(hdc, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a137">ghMenuFont</a>);
00286 
00287     <span class="comment">/*</span>
00288 <span class="comment">     * Try to make a non-multirow menu first.</span>
00289 <span class="comment">     */</span>
00290     pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o1">fFlags</a> &amp;= (~<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a143">MFMULTIROW</a>);
00291 
00292     fPopupMenu = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a786">TestMF</a>(pMenu, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a142">MFISPOPUP</a>);
00293 
00294     <span class="keywordflow">if</span> (fPopupMenu) {
00295 
00296         <span class="comment">/*</span>
00297 <span class="comment">         * Reset the menu bar height to 0 if this is a popup since we are</span>
00298 <span class="comment">         * being called from menu.c MN_SIZEWINDOW.</span>
00299 <span class="comment">         */</span>
00300         menuHeight = 0;
00301     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pwndNotify != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00302         pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o5">cxMenu</a> = cxMax;
00303     }
00304 
00305     <span class="comment">/*</span>
00306 <span class="comment">     * Initialize the computing variables.</span>
00307 <span class="comment">     */</span>
00308     cMaxWidth = cyItemKeep = 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00309     cItemBegCol = 0;
00310 
00311     cyItem = yPopupTop = yMenuTop;
00312     cxItem = xMenuLeft;
00313 
00314     pCurItem = (<a class="code" href="../../d0/d9/structtagITEM.html">PITEM</a>)&amp;pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o9">rgItems</a>[0];
00315     <span class="comment">/*</span>
00316 <span class="comment">     * cxTextAlign is used to align the text in all items; this is useful</span>
00317 <span class="comment">     *  in popup menus that mix text only items with bitmap-text items. It's</span>
00318 <span class="comment">     *  set to the max bitmap width plus some spacing.</span>
00319 <span class="comment">     * Do this for new menus wich use string AND bitmaps on the same item</span>
00320 <span class="comment">     */</span>
00321     fStringAndBitmapItems = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00322     pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o7">cxTextAlign</a> = 0;
00323 
00324     <span class="comment">/*</span>
00325 <span class="comment">     * Process each item in the menu.</span>
00326 <span class="comment">     */</span>
00327     fOwnerDrawItems = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00328     <span class="keywordflow">for</span> (cItem = 0; cItem &lt; pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o4">cItems</a>; cItem++) {
00329 
00330         <span class="comment">/*</span>
00331 <span class="comment">         * If it's not a separator, find the dimensions of the object.</span>
00332 <span class="comment">         */</span>
00333         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a791">TestMFT</a>(pCurItem, MFT_SEPARATOR) &amp;&amp;
00334                 ( !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a791">TestMFT</a>(pCurItem, MFT_OWNERDRAW) ||
00335                   (LOWORD(ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o25">dwExpWinVer</a>) &lt; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a101">VER40</a>)) ) {
00336             <span class="comment">/*</span>
00337 <span class="comment">            * If version is less than 4.0  don't test the MFT_OWNERDRAW</span>
00338 <span class="comment">            * flag. Bug 21922; App MaxEda has both separator and Ownerdraw</span>
00339 <span class="comment">            * flags on. In 3.51 we didn't test the OwnerDraw flag</span>
00340 <span class="comment">            */</span>
00341 
00342             <span class="comment">//</span>
00343             <span class="comment">// This is a separator.  It's drawn as wide as the menu area,</span>
00344             <span class="comment">// leaving some space above and below.  Since the menu area is</span>
00345             <span class="comment">// the max of the items' widths, we set our width to 0 so as not</span>
00346             <span class="comment">// to affect the result.</span>
00347             <span class="comment">//</span>
00348             pCurItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o11">cxItem</a> = 0;
00349             pCurItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o12">cyItem</a> = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYMENUSIZE) / 2;
00350 
00351 
00352         } <span class="keywordflow">else</span> {
00353             <span class="comment">/*</span>
00354 <span class="comment">             * Are we using NT5 strings and bitmaps?</span>
00355 <span class="comment">             */</span>
00356             fStringAndBitmapItems |= ((pCurItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o16">hbmp</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (pCurItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o6">lpstr</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>));
00357             <span class="comment">/*</span>
00358 <span class="comment">             * Get the item's X and Y dimensions.</span>
00359 <span class="comment">             */</span>
00360             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d2/mncomput_8c.html#a2">xxxMNItemSize</a>(pMenu, pwndNotify, hdc, pCurItem, fPopupMenu, &amp;ptMNItemSize))
00361                 fOwnerDrawItems = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00362 
00363             pCurItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o11">cxItem</a> = ptMNItemSize.x;
00364             pCurItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o12">cyItem</a> = ptMNItemSize.y;
00365             <span class="keywordflow">if</span> (!fPopupMenu &amp;&amp; ((pCurItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o16">hbmp</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) || (pCurItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o6">lpstr</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>))) {
00366                 pCurItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o11">cxItem</a> += <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a139">gcxMenuFontChar</a> * 2;
00367             }
00368         }
00369 
00370         <span class="keywordflow">if</span> (menuHeight != 0)
00371             pCurItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o12">cyItem</a> = menuHeight;
00372 
00373         <span class="comment">/*</span>
00374 <span class="comment">         * If this is the first item, initialize cMaxHeight.</span>
00375 <span class="comment">         */</span>
00376         <span class="keywordflow">if</span> (cItem == 0)
00377             cMaxHeight = pCurItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o12">cyItem</a>;
00378 
00379         <span class="comment">/*</span>
00380 <span class="comment">         * Is this a Pull-Down menu?</span>
00381 <span class="comment">         */</span>
00382         <span class="keywordflow">if</span> (fPopupMenu) {
00383 
00384             <span class="comment">/*</span>
00385 <span class="comment">             * If this item has a break or is the last item...</span>
00386 <span class="comment">             */</span>
00387             <span class="keywordflow">if</span> ((fMenuBreak = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a791">TestMFT</a>(pCurItem, MFT_BREAK)) ||
00388                 pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o4">cItems</a> == cItem + (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)1) {
00389 
00390                 <span class="comment">/*</span>
00391 <span class="comment">                 * Keep cMaxWidth around if this is not the last item.</span>
00392 <span class="comment">                 */</span>
00393                 temp = cMaxWidth;
00394                 <span class="keywordflow">if</span> (pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o4">cItems</a> == cItem + (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)1) {
00395                     <span class="keywordflow">if</span> ((<span class="keywordtype">int</span>)(pCurItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o11">cxItem</a>) &gt; cMaxWidth)
00396                         temp = pCurItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o11">cxItem</a>;
00397                 }
00398 
00399                 <span class="comment">/*</span>
00400 <span class="comment">                 * Get new width of string from RecalcTabStrings.</span>
00401 <span class="comment">                 */</span>
00402                 temp = <a class="code" href="../../d4/d2/mncomput_8c.html#a0">MNRecalcTabStrings</a>(hdc, pMenu, cItemBegCol,
00403                         (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)(cItem + (fMenuBreak ? 0 : 1)), temp, cxItem);
00404 
00405                 <span class="comment">/*</span>
00406 <span class="comment">                 * If this item has a break, account for it.</span>
00407 <span class="comment">                 */</span>
00408                 <span class="keywordflow">if</span> (fMenuBreak) {
00409                     <span class="comment">//</span>
00410                     <span class="comment">// Add on space for the etch and a border on either side.</span>
00411                     <span class="comment">// NOTE:  For old apps that do weird stuff with owner</span>
00412                     <span class="comment">// draw, keep 'em happy by adding on the same amount</span>
00413                     <span class="comment">// of space we did in 3.1.</span>
00414                     <span class="comment">//</span>
00415                     <span class="keywordflow">if</span> (fOwnerDrawItems &amp;&amp; !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndNotify, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a593">WFWIN40COMPAT</a>))
00416                         cxItem = temp + <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXBORDER);
00417                     <span class="keywordflow">else</span>
00418                         cxItem = temp + 2 * <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXEDGE);
00419 
00420                     <span class="comment">/*</span>
00421 <span class="comment">                     * Reset the cMaxWidth to the current item.</span>
00422 <span class="comment">                     */</span>
00423                     cMaxWidth = pCurItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o11">cxItem</a>;
00424 
00425                     <span class="comment">/*</span>
00426 <span class="comment">                     * Start at the top.</span>
00427 <span class="comment">                     */</span>
00428                     cyItem = yPopupTop;
00429 
00430                     <span class="comment">/*</span>
00431 <span class="comment">                     * Save the item where this column begins.</span>
00432 <span class="comment">                     */</span>
00433                     cItemBegCol = cItem;
00434 
00435                     <span class="comment">/*</span>
00436 <span class="comment">                     * If this item is also the last item, recalc for this</span>
00437 <span class="comment">                     * column.</span>
00438 <span class="comment">                     */</span>
00439                     <span class="keywordflow">if</span> (pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o4">cItems</a> == (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)(cItem + 1)) {
00440                         temp = <a class="code" href="../../d4/d2/mncomput_8c.html#a0">MNRecalcTabStrings</a>(hdc, pMenu, cItem,
00441                                 (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)(cItem + 1), cMaxWidth, cxItem);
00442                     }
00443                 }
00444 
00445                 <span class="comment">/*</span>
00446 <span class="comment">                 * If this is the last entry, supply the width.</span>
00447 <span class="comment">                 */</span>
00448                 <span class="keywordflow">if</span> (pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o4">cItems</a> == cItem + (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)1)
00449                     pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o5">cxMenu</a> = temp;
00450             }
00451 
00452             pCurItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o9">xItem</a> = cxItem;
00453             pCurItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o10">yItem</a> = cyItem;
00454 
00455             cyItem += pCurItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o12">cyItem</a>;
00456 
00457             <span class="keywordflow">if</span> (cyItemKeep &lt; cyItem)
00458                 cyItemKeep = cyItem;
00459 
00460         } <span class="keywordflow">else</span> {
00461 
00462             <span class="comment">/*</span>
00463 <span class="comment">             * This a Top Level menu, not a Pull-Down.</span>
00464 <span class="comment">             */</span>
00465 
00466             <span class="comment">/*</span>
00467 <span class="comment">             * Adjust right aligned items before testing for multirow</span>
00468 <span class="comment">             */</span>
00469             <span class="keywordflow">if</span> (pCurItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o6">lpstr</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00470                 lpsz = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a909">TextPointer</a>(pCurItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o6">lpstr</a>);
00471                 <span class="keywordflow">if</span> ((lpsz != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (*lpsz == <a class="code" href="../../d4/d1/userk_8h.html#a469">CH_HELPPREFIX</a>)) {
00472                     pCurItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o11">cxItem</a> -= <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a139">gcxMenuFontChar</a>;
00473                 }
00474             }
00475 
00476 
00477             <span class="comment">/*</span>
00478 <span class="comment">             * If this is a new line or a menu break.</span>
00479 <span class="comment">             */</span>
00480             <span class="keywordflow">if</span> ((<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a791">TestMFT</a>(pCurItem, MFT_BREAK)) ||
00481                     (((cxItem + pCurItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o11">cxItem</a> + <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a139">gcxMenuFontChar</a>) &gt;
00482                     pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o5">cxMenu</a>) &amp;&amp; (cItem != 0))) {
00483                 cyItem += cMaxHeight;
00484 
00485                 cxItem = xMenuLeft;
00486                 cMaxHeight = pCurItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o12">cyItem</a>;
00487                 pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o1">fFlags</a> |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a143">MFMULTIROW</a>;
00488             }
00489 
00490             pCurItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o10">yItem</a> = cyItem;
00491 
00492             pCurItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o9">xItem</a> = cxItem;
00493             cxItem += pCurItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o11">cxItem</a>;
00494         }
00495 
00496         <span class="keywordflow">if</span> (cMaxWidth &lt; (<span class="keywordtype">int</span>)(pCurItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o11">cxItem</a>))
00497             cMaxWidth = pCurItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o11">cxItem</a>;
00498 
00499         <span class="keywordflow">if</span> (cMaxHeight != pCurItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o12">cyItem</a>) {
00500             <span class="keywordflow">if</span> (cMaxHeight &lt; pCurItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o12">cyItem</a>)
00501                 cMaxHeight = pCurItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o12">cyItem</a>;
00502 
00503             <span class="keywordflow">if</span> (!fPopupMenu)
00504                 menuHeight = cMaxHeight;
00505         }
00506 
00507         <span class="keywordflow">if</span> (!fPopupMenu)
00508             cyItemKeep = cyItem + cMaxHeight;
00509 
00510         pCurItem++;
00511 
00512     } <span class="comment">/* of for loop */</span>
00513     <span class="comment">/*</span>
00514 <span class="comment">     * Determine where the strings should be drawn so they are aligned</span>
00515 <span class="comment">     * The alignment is only for popup (vertical) menus (see xxxRealDrawMenuItem)</span>
00516 <span class="comment">     * The actual space depends on the MNS_NOCHECK and MNS_CHECKORBMP styles</span>
00517 <span class="comment">     * Multicolumn menus don't get aligment (now that we have scrollbars, multicolum is out)</span>
00518 <span class="comment">     */</span>
00519     <span class="keywordflow">if</span> (!fStringAndBitmapItems || (cItemBegCol != 0)) {
00520         pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o7">cxTextAlign</a> = 0;
00521     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a786">TestMF</a>(pMenu, MNS_NOCHECK)) {
00522         pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o7">cxTextAlign</a> += <a class="code" href="../../d4/d1/userk_8h.html#a528">MNXSPACE</a>;
00523     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a786">TestMF</a>(pMenu, MNS_CHECKORBMP)) {
00524         pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o7">cxTextAlign</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a1">max</a>(pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o7">cxTextAlign</a>, (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)<a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;oembmi[<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a330">OBI_MENUCHECK</a>].cx);
00525         pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o7">cxTextAlign</a> += <a class="code" href="../../d4/d1/userk_8h.html#a528">MNXSPACE</a>;
00526     } <span class="keywordflow">else</span> {
00527         pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o7">cxTextAlign</a> += <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;oembmi[<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a330">OBI_MENUCHECK</a>].cx + <a class="code" href="../../d4/d1/userk_8h.html#a528">MNXSPACE</a>;
00528     }
00529     <span class="comment">/*</span>
00530 <span class="comment">     * Add the left margin</span>
00531 <span class="comment">     */</span>
00532     <span class="keywordflow">if</span> (pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o7">cxTextAlign</a> != 0) {
00533         pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o7">cxTextAlign</a> += <a class="code" href="../../d4/d1/userk_8h.html#a529">MNLEFTMARGIN</a>;
00534     }
00535 
00536 
00537     <span class="keywordflow">if</span> (cItemBegCol &amp;&amp; pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o4">cItems</a> &amp;&amp;
00538         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a791">TestMFT</a>(((<a class="code" href="../../d0/d9/structtagITEM.html">PITEM</a>)&amp;pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o9">rgItems</a>[0]), MFT_RIGHTJUSTIFY)) {
00539         <span class="comment">//</span>
00540         <span class="comment">// multi-column, if we are in RtoL mode, reverse the columns</span>
00541         <span class="comment">//</span>
00542         pCurItem = (<a class="code" href="../../d0/d9/structtagITEM.html">PITEM</a>)&amp;pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o9">rgItems</a>[0];
00543 
00544         <span class="keywordflow">for</span> (cItem = 0; cItem &lt; pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o4">cItems</a>; cItem++) {
00545             pCurItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o9">xItem</a> = pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o5">cxMenu</a> -
00546                               (pCurItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o9">xItem</a> + pCurItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o11">cxItem</a>);
00547             pCurItem++;
00548         }
00549     }
00550 
00551     GreSelectFont(hdc, hOldFont);
00552     <a class="code" href="../../d4/d1/userk_8h.html#a1697">_ReleaseDC</a>(hdc);
00553 
00554     pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o6">cyMenu</a> = cyItemKeep - yMenuTop;
00555     ret = pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o6">cyMenu</a>;
00556 
00557     <span class="keywordflow">if</span> (lpdwMenuHeight != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00558         *lpdwMenuHeight = menuHeight;
00559 
00560     <span class="keywordflow">return</span> ret;
00561 }
00562 
00563 <span class="comment">/***************************************************************************\</span>
00564 <span class="comment">* MBC_RightJustifyMenu</span>
00565 <span class="comment">*</span>
00566 <span class="comment">* !</span>
00567 <span class="comment">*</span>
00568 <span class="comment">* History:</span>
00569 <span class="comment">\***************************************************************************/</span>
00570 
<a name="l00571"></a><a class="code" href="../../d4/d2/mncomput_8c.html#a4">00571</a> <span class="keywordtype">void</span> <a class="code" href="../../d4/d2/mncomput_8c.html#a4">MBC_RightJustifyMenu</a>(
00572     <a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a> pMenu)
00573 {
00574     <a class="code" href="../../d0/d9/structtagITEM.html">PITEM</a> pItem;
00575     <span class="keywordtype">int</span> cItem;
00576     <span class="keywordtype">int</span> iFirstRJItem = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a778">MFMWFP_NOITEM</a>;
00577     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> xMenuPos;
00578     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>  yPos;
00579     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>  xPosStart;
00580     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>  xPosEnd;
00581     <span class="keywordtype">int</span>    cItemEnd;
00582     <span class="keywordtype">int</span>    cItemStart;
00583     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>   bIsWin95;
00584 
00585     <span class="comment">//</span>
00586     <span class="comment">// need to compensate for MDI menus.  need to do all here as Win31/Hebrew did</span>
00587     <span class="comment">// this.  also screwed up computation, anything non-text was not moved.</span>
00588     <span class="comment">//</span>
00589     <span class="keywordflow">if</span> (pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o4">cItems</a> == 0)
00590         <span class="keywordflow">return</span>;
00591 
00592     pItem = (<a class="code" href="../../d0/d9/structtagITEM.html">PITEM</a>)&amp;pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o9">rgItems</a>[0];
00593     cItemStart = 0;
00594 
00595     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a786">TestMF</a>(pMenu,<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a147">MFRTL</a>)) {
00596         bIsWin95 = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o8">spwndNotify</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a593">WFWIN40COMPAT</a>);
00597 
00598         <span class="keywordflow">while</span>( cItemStart &lt; (<span class="keywordtype">int</span>)pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o4">cItems</a> ) {
00599             <span class="keywordflow">if</span> (bIsWin95) {  <span class="comment">//(not time critical)</span>
00600                 <span class="comment">//</span>
00601                 <span class="comment">// deal with fake MDI dude.</span>
00602                 <span class="comment">//</span>
00603                 <span class="keywordflow">if</span> (!cItemStart &amp;&amp; <a class="code" href="../../d4/d1/userk_8h.html#a1330">IsMDIItem</a>(pItem))
00604                     <span class="keywordflow">goto</span> StillFindStart;
00605                 <span class="keywordflow">else</span>
00606                     <span class="keywordflow">break</span>;
00607             }
00608 
00609             <span class="keywordflow">if</span>( <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a791">TestMFT</a>(pItem, MFT_BITMAP) ) {
00610                 <span class="keywordflow">if</span> ( pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o16">hbmp</a> &gt; (HBITMAP)HBMMENU_MAX )
00611                     <span class="keywordflow">break</span>;
00612                 <span class="keywordflow">else</span>
00613                     <span class="keywordflow">goto</span> StillFindStart;
00614             }
00615 
00616             <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a791">TestMFT</a>(pItem, MFT_OWNERDRAW) )
00617                 <span class="keywordflow">break</span>;
00618 
00619 StillFindStart:
00620             cItemStart++;
00621             pItem = pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o9">rgItems</a> + cItemStart;
00622         }
00623         <span class="comment">//</span>
00624         <span class="comment">// anything before cItems should be left where it is! Now need to find</span>
00625         <span class="comment">// the last item to fool with.</span>
00626         <span class="comment">//</span>
00627         cItemEnd = pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o4">cItems</a> - 1;
00628         pItem   = pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o9">rgItems</a> + cItemEnd;
00629 
00630         <span class="keywordflow">while</span>( cItemEnd &gt; cItemStart ) {
00631             <span class="keywordflow">if</span> (bIsWin95) {
00632                 <span class="comment">//</span>
00633                 <span class="comment">// fake mdi dudes</span>
00634                 <span class="comment">//</span>
00635                 <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1330">IsMDIItem</a>(pItem))
00636                     <span class="keywordflow">goto</span> StillFindEnd;
00637                 <span class="keywordflow">else</span>
00638                     <span class="keywordflow">break</span>;
00639             }
00640             <span class="keywordflow">if</span> ( !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a791">TestMFT</a>(pItem, MFT_BITMAP) &amp;&amp; !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a791">TestMFT</a>(pItem, MFT_OWNERDRAW) )
00641                 <span class="keywordflow">break</span>;
00642 StillFindEnd:
00643             cItemEnd --;
00644             pItem = pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o9">rgItems</a> + cItemEnd;
00645         }
00646 
00647         yPos      = pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o9">rgItems</a>[0].<a class="code" href="../../d0/d9/structtagITEM.html#o10">yItem</a>;
00648         xMenuPos  = pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o5">cxMenu</a> ;
00649         xPosStart = xMenuPos;              <span class="comment">// for 2nd row onward</span>
00650         xPosEnd   = pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o9">rgItems</a>[cItemStart].<a class="code" href="../../d0/d9/structtagITEM.html#o9">xItem</a> ;
00651 
00652         <span class="keywordflow">for</span> (cItem = pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o4">cItems</a>-1; cItem &gt; cItemEnd; cItem--) {
00653             <span class="comment">//</span>
00654             <span class="comment">// force any MDI dudes back to the top line again.</span>
00655             <span class="comment">//</span>
00656             pItem        = pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o9">rgItems</a> + cItem;
00657             xMenuPos      =
00658             pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o9">xItem</a> = xMenuPos - pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o11">cxItem</a>;
00659             pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o10">yItem</a> = yPos;
00660         }
00661 
00662         <span class="keywordflow">for</span>( cItem = cItemStart; cItem &lt;= cItemEnd; cItem++ ) {
00663             pItem = pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o9">rgItems</a> + cItem;
00664             <span class="keywordflow">if</span> (xMenuPos - pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o11">cxItem</a> &gt; xPosEnd) {
00665                 xMenuPos -= pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o11">cxItem</a>;
00666             } <span class="keywordflow">else</span> {
00667                 xMenuPos = xPosStart - pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o11">cxItem</a>;
00668                 yPos     += pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o12">cyItem</a>;
00669                 xPosEnd  = 0;
00670             }
00671             pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o9">xItem</a> = xMenuPos;
00672             pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o10">yItem</a> = yPos;
00673         }
00674     } <span class="keywordflow">else</span> {
00675         <span class="comment">// B#4055</span>
00676         <span class="comment">// Use signed arithmetic so comparison cItem &gt;= iFirstRJItem won't</span>
00677         <span class="comment">// cause underflow.</span>
00678         <span class="keywordflow">for</span> (cItem = 0; cItem &lt; (<span class="keywordtype">int</span>)pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o4">cItems</a>; cItem++) {
00679             <span class="comment">// Find the first item which is right justified.</span>
00680             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a791">TestMFT</a>((pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o9">rgItems</a> + cItem), MFT_RIGHTJUSTIFY)) {
00681                 iFirstRJItem = cItem;
00682                 xMenuPos = pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o5">cxMenu</a> + pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o9">rgItems</a>[0].<a class="code" href="../../d0/d9/structtagITEM.html#o9">xItem</a>;
00683                 <span class="keywordflow">for</span> (cItem = (<span class="keywordtype">int</span>)pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o4">cItems</a> - 1; cItem &gt;= iFirstRJItem; cItem--) {
00684                     pItem = pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o9">rgItems</a> + cItem;
00685                     xMenuPos -= pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o11">cxItem</a>;
00686                     <span class="keywordflow">if</span> (pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o9">xItem</a> &lt; xMenuPos)
00687                         pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o9">xItem</a> = xMenuPos;
00688                 }
00689                 <span class="keywordflow">return</span>;
00690             }
00691         }
00692     }
00693 }
00694 
00695 <span class="comment">/***************************************************************************\</span>
00696 <span class="comment">* xxxMenuBarCompute</span>
00697 <span class="comment">*</span>
00698 <span class="comment">* returns the height of the menubar menu. yMenuTop, xMenuLeft, and</span>
00699 <span class="comment">* cxMax are used when computing the height/width of top level menu bars in</span>
00700 <span class="comment">* windows.</span>
00701 <span class="comment">*</span>
00702 <span class="comment">*</span>
00703 <span class="comment">* History:</span>
00704 <span class="comment">\***************************************************************************/</span>
00705 
<a name="l00706"></a><a class="code" href="../../d4/d1/userk_8h.html#a1396">00706</a> <span class="keywordtype">int</span> <a class="code" href="../../d4/d1/userk_8h.html#a1396">xxxMenuBarCompute</a>(
00707     <a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a> pMenu,
00708     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndNotify,
00709     DWORD yMenuTop,
00710     DWORD xMenuLeft,
00711     <span class="keywordtype">int</span> cxMax)
00712 {
00713     <span class="keywordtype">int</span> size;
00714     <span class="comment">/* menuHeight is set by MNCompute when dealing with a top level menu and</span>
00715 <span class="comment">     * not all items in the menu bar have the same height.  Thus, by setting</span>
00716 <span class="comment">     * menuHeight, MNCompute is called a second time to set every item to the</span>
00717 <span class="comment">     * same height.  The actual value stored in menuHeight is the maximum</span>
00718 <span class="comment">     * height of all the menu bar items</span>
00719 <span class="comment">     */</span>
00720     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> menuHeight = 0;
00721 
00722     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwndNotify);
00723     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pMenu);
00724 
00725     size = <a class="code" href="../../d4/d1/userk_8h.html#a1381">xxxMNCompute</a>(pMenu, pwndNotify, yMenuTop, xMenuLeft, cxMax, &amp;menuHeight);
00726 
00727     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a786">TestMF</a>(pMenu, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a142">MFISPOPUP</a>)) {
00728         <span class="keywordflow">if</span> (menuHeight != 0) {
00729 
00730             <span class="comment">/*</span>
00731 <span class="comment">             * Add a border for the multi-row case.</span>
00732 <span class="comment">             */</span>
00733             size = <a class="code" href="../../d4/d1/userk_8h.html#a1381">xxxMNCompute</a>(pMenu, pwndNotify, yMenuTop, xMenuLeft,
00734                     cxMax, &amp;menuHeight);
00735         }
00736 
00737         <span class="comment">/*</span>
00738 <span class="comment">         * Right justification of HELP items is only needed on top level</span>
00739 <span class="comment">         * menus.</span>
00740 <span class="comment">         */</span>
00741         <a class="code" href="../../d4/d2/mncomput_8c.html#a4">MBC_RightJustifyMenu</a>(pMenu);
00742     }
00743 
00744     <span class="comment">/*</span>
00745 <span class="comment">     * There's an extra border underneath the menu bar, if it's not empty!</span>
00746 <span class="comment">     */</span>
00747     <span class="keywordflow">return</span>(size ? size + <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYBORDER) : size);
00748 }
00749 
00750 <span class="comment">/***************************************************************************\</span>
00751 <span class="comment">* xxxRecomputeMenu</span>
00752 <span class="comment">*</span>
00753 <span class="comment">* !</span>
00754 <span class="comment">*</span>
00755 <span class="comment">* History:</span>
00756 <span class="comment">\***************************************************************************/</span>
00757 
<a name="l00758"></a><a class="code" href="../../d4/d1/userk_8h.html#a1382">00758</a> <span class="keywordtype">void</span> <a class="code" href="../../d4/d1/userk_8h.html#a1382">xxxMNRecomputeBarIfNeeded</a>(
00759     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndNotify,
00760     <a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a> pMenu)
00761 {
00762     <span class="keywordtype">int</span> cxFrame;
00763     <span class="keywordtype">int</span> cyFrame;
00764 
00765     UserAssert(!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a786">TestMF</a>(pMenu, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a142">MFISPOPUP</a>));
00766 
00767     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwndNotify);
00768     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pMenu);
00769 
00770     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a786">TestMF</a>(pMenu, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a149">MFSYSMENU</a>)
00771         &amp;&amp; ((pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o8">spwndNotify</a> != pwndNotify) || !pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o5">cxMenu</a> || !pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o6">cyMenu</a>)) {
00772         <span class="keywordtype">int</span> cBorders;
00773 
00774         cBorders = <a class="code" href="../../d2/d8/rtl_2winmgr_8c.html#a7">GetWindowBorders</a>(pwndNotify-&gt;style, pwndNotify-&gt;ExStyle, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00775         cxFrame = cBorders * <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CXBORDER);
00776         cyFrame = cBorders * <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a18">SYSMET</a>(CYBORDER);
00777 
00778         cyFrame += <a class="code" href="../../d4/d1/userk_8h.html#a2017">GetCaptionHeight</a>(pwndNotify);
00779 
00780         <span class="comment">// The width passed in this call was larger by cxFrame;</span>
00781         <span class="comment">// Fix for Bug #11466 - Fixed by SANKAR - 01/06/92 --</span>
00782         <a class="code" href="../../d4/d1/userk_8h.html#a1396">xxxMenuBarCompute</a>(pMenu, pwndNotify, cyFrame, cxFrame,
00783                 (pwndNotify-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.right - pwndNotify-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.left) - cxFrame * 2);
00784     }
00785 }
00786 
00787 <span class="comment">/***************************************************************************\</span>
00788 <span class="comment">* RecalcTabStrings</span>
00789 <span class="comment">*</span>
00790 <span class="comment">* !</span>
00791 <span class="comment">*</span>
00792 <span class="comment">* History:</span>
00793 <span class="comment">*   10-11-90 JimA       Translated from ASM</span>
00794 <span class="comment">\***************************************************************************/</span>
00795 
<a name="l00796"></a><a class="code" href="../../d4/d2/mncomput_8c.html#a0">00796</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d4/d2/mncomput_8c.html#a0">MNRecalcTabStrings</a>(
00797     HDC hdc,
00798     <a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a> pMenu,
00799     UINT iBeg,
00800     UINT iEnd,
00801     DWORD xTab,
00802     DWORD hCount)
00803 {
00804     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> i;
00805     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>    cOwnerDraw;
00806     <span class="keywordtype">int</span> adx;
00807     <span class="keywordtype">int</span>     maxWidth = 0;
00808     <span class="keywordtype">int</span>     cx;
00809     <a class="code" href="../../d0/d9/structtagITEM.html">PITEM</a> pItem;
00810     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pMenu);
00811 
00812     xTab += hCount;
00813 
00814     <span class="keywordflow">if</span> ((iBeg &gt;= pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o4">cItems</a>) || (iBeg &gt; iEnd))
00815         <span class="keywordflow">goto</span> SeeYa;
00816 
00817     cOwnerDraw = 0;
00818 
00819     <span class="keywordflow">for</span> (i = iBeg, pItem = pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o9">rgItems</a> + iBeg; i &lt; iEnd; pItem++, i++) {
00820         adx = 0;
00821 
00822         <span class="comment">/*</span>
00823 <span class="comment">         * Subtract hCount to make dxTab relative to start of column for</span>
00824 <span class="comment">         * multi-column menus.</span>
00825 <span class="comment">         */</span>
00826 
00827         pItem-&gt;dxTab = xTab - hCount;
00828 
00829         <span class="comment">// Skip non-string or empty string items</span>
00830         <span class="keywordflow">if</span> ((pItem-&gt;lpstr != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; !<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a791">TestMFT</a>(pItem, MFT_OWNERDRAW)) {
00831             LPWSTR   lpString = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a909">TextPointer</a>(pItem-&gt;lpstr);
00832             <span class="keywordtype">int</span>     tp;
00833             SIZE size;
00834 
00835             <span class="comment">// Are there any tabs?</span>
00836             tp = <a class="code" href="../../d1/d5/w32_2ntuser_2rtl_2random_8c.html#a1">FindCharPosition</a>(lpString, TEXT(<span class="charliteral">'\t'</span>));
00837             <span class="keywordflow">if</span> (tp &lt; (<span class="keywordtype">int</span>) pItem-&gt;cch) {
00838                 <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> ptiCurrent = <a class="code" href="../../d4/d1/userk_8h.html#a10">PtiCurrentShared</a>();
00839 
00840                 <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a393">CALL_LPK</a>(ptiCurrent)) {
00841                     <a class="code" href="../../d4/d1/userk_8h.html#a1412">xxxClientGetTextExtentPointW</a>(hdc, lpString + tp + 1,
00842                           pItem-&gt;cch - tp - 1, &amp;size);
00843                 } <span class="keywordflow">else</span> {
00844                     GreGetTextExtentW(hdc, lpString + tp + 1,
00845                           pItem-&gt;cch - tp - 1, &amp;size, GGTE_WIN3_EXTENT);
00846                 }
00847                 adx = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a139">gcxMenuFontChar</a> + size.cx;
00848             }
00849         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a791">TestMFT</a>(pItem, MFT_OWNERDRAW))
00850             cOwnerDraw++;
00851 
00852         adx += xTab;
00853 
00854         <span class="keywordflow">if</span> (adx &gt; maxWidth)
00855             maxWidth = adx;
00856 
00857     }
00858 
00859     <span class="comment">/*</span>
00860 <span class="comment">     * Add on space for hierarchical arrow.  So basically, popup menu items</span>
00861 <span class="comment">     * can have 4 columns:</span>
00862 <span class="comment">     *      (1) Checkmark</span>
00863 <span class="comment">     *      (2) Text</span>
00864 <span class="comment">     *      (3) Tabbed text for accel</span>
00865 <span class="comment">     *      (4) Hierarchical arrow</span>
00866 <span class="comment">     *</span>
00867 <span class="comment">     * But, we only do this if at least one item isn't ownerdraw</span>
00868 <span class="comment">     *  and if there's at least one submenu in the popup.</span>
00869 <span class="comment">     */</span>
00870     <span class="keywordflow">if</span> (cOwnerDraw != (iEnd - iBeg)) {
00871         maxWidth += <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a139">gcxMenuFontChar</a> + <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;oembmi[<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a330">OBI_MENUCHECK</a>].cx;
00872     }
00873 
00874     cx = maxWidth - hCount;
00875 
00876     <span class="keywordflow">for</span> (i = iBeg, pItem = pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o9">rgItems</a> + iBeg; i &lt; iEnd; pItem++, i++)
00877         pItem-&gt;cxItem = cx;
00878 
00879 SeeYa:
00880     <span class="keywordflow">return</span>(maxWidth);
00881 }
00882 <span class="comment">/***************************************************************************\</span>
00883 <span class="comment">* GetMenuPwnd</span>
00884 <span class="comment">*</span>
00885 <span class="comment">* This function is used by xxxGetMenuItemRect and xxxMenuItemFromPoint</span>
00886 <span class="comment">*  which expect a pointer to the  menu window for popup menus.</span>
00887 <span class="comment">* In 4.0, apps had to go the extra mile to find the menu window; but this</span>
00888 <span class="comment">*  is bogus since menu windows are an internally thing not directly exposed</span>
00889 <span class="comment">*  to applications.</span>
00890 <span class="comment">*</span>
00891 <span class="comment">* 08/19/97  GerardoB    Created</span>
00892 <span class="comment">\***************************************************************************/</span>
<a name="l00893"></a><a class="code" href="../../d4/d2/mncomput_8c.html#a7">00893</a> <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> <a class="code" href="../../d4/d2/mncomput_8c.html#a7">GetMenuPwnd</a> (<a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd, <a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a> pmenu)
00894 {
00895     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a786">TestMF</a>(pmenu, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a142">MFISPOPUP</a>)) {
00896         <span class="keywordflow">if</span> ((pwnd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) || (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a232">GETFNID</a>(pwnd) != <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a195">FNID_MENU</a>)) {
00897             <a class="code" href="../../d4/d3/structtagPOPUPMENU.html">PPOPUPMENU</a> ppopup = <a class="code" href="../../d4/d1/userk_8h.html#a1602">MNGetPopupFromMenu</a>(pmenu, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00898             <span class="keywordflow">if</span> (ppopup != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00899                 UserAssert(ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o29">spmenu</a> == pmenu);
00900                 pwnd = ppopup-&gt;<a class="code" href="../../d4/d3/structtagPOPUPMENU.html#o26">spwndPopupMenu</a>;
00901             }
00902         }
00903     }
00904     <span class="keywordflow">return</span> pwnd;
00905 }
00906 <span class="comment">// ============================================================================</span>
00907 <span class="comment">//</span>
00908 <span class="comment">//  GetMenuItemRect()</span>
00909 <span class="comment">//</span>
00910 <span class="comment">// ============================================================================</span>
<a name="l00911"></a><a class="code" href="../../d4/d1/userk_8h.html#a1601">00911</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1601">xxxGetMenuItemRect</a>(<a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd, <a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a> pMenu, UINT uIndex, LPRECT lprcScreen)
00912 {
00913     <a class="code" href="../../d0/d9/structtagITEM.html">PITEM</a>  pItem;
00914     <span class="keywordtype">int</span>     dx, dy;
00915 
00916     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwnd);
00917     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pMenu);
00918 
00919     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a35">SetRectEmpty</a>(lprcScreen);
00920 
00921     <span class="keywordflow">if</span> (uIndex &gt;= pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o4">cItems</a>)
00922         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00923 
00924     <span class="comment">/*</span>
00925 <span class="comment">     * Raid #315084: Compatiblity with NT4/Win95/98</span>
00926 <span class="comment">     *</span>
00927 <span class="comment">     * WordPerfect does a long complex way to calc the menu rect</span>
00928 <span class="comment">     * by calling this API. It calls GetMenuItemRect() with the app's</span>
00929 <span class="comment">     * window.</span>
00930 <span class="comment">     */</span>
00931     <span class="keywordflow">if</span> (pwnd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a594">WFWIN50COMPAT</a>)) {
00932         pwnd = <a class="code" href="../../d4/d2/mncomput_8c.html#a7">GetMenuPwnd</a>(pwnd, pMenu);
00933     }
00934 
00935     <span class="comment">/*</span>
00936 <span class="comment">     * If no pwnd, no go.</span>
00937 <span class="comment">     * IMPORTANT: for MFISPOPUP we might get a different pwnd but we don't lock</span>
00938 <span class="comment">     *   it because we won't call back</span>
00939 <span class="comment">     */</span>
00940     <span class="keywordflow">if</span> (pwnd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00941         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00942     }
00943 
00944     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a786">TestMF</a>(pMenu, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a142">MFISPOPUP</a>)) {
00945         dx = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.left;
00946         dy = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.top;
00947     } <span class="keywordflow">else</span> {
00948         <a class="code" href="../../d4/d1/userk_8h.html#a1382">xxxMNRecomputeBarIfNeeded</a>(pwnd, pMenu);
00949 
00950         dx = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.left;
00951         dy = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o6">rcWindow</a>.top;
00952     }
00953 
00954     <span class="keywordflow">if</span> (uIndex &gt;= pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o4">cItems</a>)
00955         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00956 
00957     pItem = pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o9">rgItems</a> + uIndex;
00958 
00959     lprcScreen-&gt;right   = pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o11">cxItem</a>;
00960     lprcScreen-&gt;bottom  = pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o12">cyItem</a>;
00961 
00962     <a class="code" href="../../d3/d6/rect_8c.html#a6">OffsetRect</a>(lprcScreen, dx + pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o9">xItem</a>, dy + pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o10">yItem</a>);
00963     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00964 }
00965 
00966 <span class="comment">/***************************************************************************\</span>
00967 <span class="comment">*</span>
00968 <span class="comment">*  MenuItemFromPoint()</span>
00969 <span class="comment">*</span>
00970 <span class="comment">\***************************************************************************/</span>
00971 <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> <a class="code" href="../../d1/d4/tooltips_8c.html#a8">MNItemHitTest</a>(<a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a> pMenu, <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd, POINT pt);
<a name="l00972"></a><a class="code" href="../../d4/d1/userk_8h.html#a1600">00972</a> <span class="keywordtype">int</span> <a class="code" href="../../d4/d1/userk_8h.html#a1600">xxxMenuItemFromPoint</a>(<a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd, <a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a> pMenu, POINT ptScreen)
00973 {
00974     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwnd);
00975     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pMenu);
00976 
00977     <span class="comment">/*</span>
00978 <span class="comment">     * If no pwnd, no go.</span>
00979 <span class="comment">     * IMPORTANT: for MFISPOPUP we might get a different pwnd but we don't lock</span>
00980 <span class="comment">     *   it because we won't call back</span>
00981 <span class="comment">     */</span>
00982     pwnd = <a class="code" href="../../d4/d2/mncomput_8c.html#a7">GetMenuPwnd</a>(pwnd, pMenu);
00983     <span class="keywordflow">if</span> (pwnd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00984         <span class="keywordflow">return</span> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a778">MFMWFP_NOITEM</a>;
00985     }
00986 
00987     <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a786">TestMF</a>(pMenu, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a142">MFISPOPUP</a>)) {
00988         <a class="code" href="../../d4/d1/userk_8h.html#a1382">xxxMNRecomputeBarIfNeeded</a>(pwnd, pMenu);
00989     }
00990 
00991     <span class="keywordflow">return</span>(<a class="code" href="../../d1/d4/tooltips_8c.html#a8">MNItemHitTest</a>(pMenu, pwnd, ptScreen));
00992 }
00993 
00994 
<a name="l00995"></a><a class="code" href="../../d4/d1/userk_8h.html#a1405">00995</a> <a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a> <a class="code" href="../../d4/d1/userk_8h.html#a1405">MakeMenuRtoL</a>(<a class="code" href="../../d1/d1/structtagMENU.html">PMENU</a> pMenu, BOOL bRtoL)
00996 {
00997     <a class="code" href="../../d0/d9/structtagITEM.html">PITEM</a>  pItem;
00998     <span class="keywordtype">int</span>    cItem;
00999 
01000     <span class="keywordflow">if</span> (bRtoL)
01001         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a784">SetMF</a>(pMenu,<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a147">MFRTL</a>);
01002     <span class="keywordflow">else</span>
01003         <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a785">ClearMF</a>(pMenu,<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a147">MFRTL</a>);
01004 
01005     <span class="keywordflow">for</span> (cItem = 0; cItem &lt; (<span class="keywordtype">int</span>)pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o4">cItems</a>; cItem++) {
01006         pItem = pMenu-&gt;<a class="code" href="../../d1/d1/structtagMENU.html#o9">rgItems</a> + cItem;
01007         <span class="keywordflow">if</span> (bRtoL) {
01008             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a790">SetMFT</a>(pItem, MFT_RIGHTJUSTIFY);
01009             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a790">SetMFT</a>(pItem, MFT_RIGHTORDER);
01010         } <span class="keywordflow">else</span> {
01011             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a792">ClearMFT</a>(pItem, MFT_RIGHTJUSTIFY);
01012             <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a792">ClearMFT</a>(pItem, MFT_RIGHTORDER);
01013         }
01014         <span class="keywordflow">if</span> (pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o3">spSubMenu</a>)
01015             <a class="code" href="../../d4/d1/userk_8h.html#a1405">MakeMenuRtoL</a>(pItem-&gt;<a class="code" href="../../d0/d9/structtagITEM.html#o3">spSubMenu</a>, bRtoL);
01016     }
01017     <span class="keywordflow">return</span> pMenu;
01018 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:51 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
