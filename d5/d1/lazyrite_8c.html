<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: lazyrite.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>lazyrite.c File Reference</h1><code>#include "<a class="el" href="../../d6/d4/cc_8h-source.html">cc.h</a>"</code><br>

<p>
<a href="../../d6/d0/lazyrite_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/lazyrite_8c.html#a0">BugCheckFileId</a>&nbsp;&nbsp;&nbsp;(CACHE_BUG_CHECK_LAZYRITE)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/lazyrite_8c.html#a1">me</a>&nbsp;&nbsp;&nbsp;0x00000020</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d2/d9/struct__WORK__QUEUE__ENTRY.html">PWORK_QUEUE_ENTRY</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/lazyrite_8c.html#a2">CcReadWorkQueue</a> ()</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/lazyrite_8c.html#a3">CcLazyWriteScan</a> ()</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/lazyrite_8c.html#a4">CcScheduleLazyWriteScan</a> ()</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/lazyrite_8c.html#a5">CcScanDpc</a> (IN <a class="el" href="../../d1/d6/struct__KDPC.html">PKDPC</a> Dpc, IN PVOID DeferredContext, IN PVOID SystemArgument1, IN PVOID SystemArgument2)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/lazyrite_8c.html#a6">CcWaitForCurrentLazyWriterActivity</a> ()</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/lazyrite_8c.html#a7">CcExceptionFilter</a> (IN NTSTATUS ExceptionCode)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID FASTCALL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/lazyrite_8c.html#a8">CcPostWorkQueue</a> (IN <a class="el" href="../../d2/d9/struct__WORK__QUEUE__ENTRY.html">PWORK_QUEUE_ENTRY</a> WorkQueueEntry, IN PLIST_ENTRY WorkQueue)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/lazyrite_8c.html#a9">CcWorkerThread</a> (PVOID ExWorkQueueItem)</td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a0" doxytag="lazyrite.c::BugCheckFileId" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define BugCheckFileId&nbsp;&nbsp;&nbsp;(CACHE_BUG_CHECK_LAZYRITE)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/lazyrite_8c-source.html#l00027">27</a> of file <a class="el" href="../../d6/d0/lazyrite_8c-source.html">lazyrite.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="lazyrite.c::me" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define me&nbsp;&nbsp;&nbsp;0x00000020          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/lazyrite_8c-source.html#l00033">33</a> of file <a class="el" href="../../d6/d0/lazyrite_8c-source.html">lazyrite.c</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a7" doxytag="lazyrite.c::CcExceptionFilter" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LONG CcExceptionFilter           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN NTSTATUS&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>ExceptionCode</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/lazyrite_8c-source.html#l00619">619</a> of file <a class="el" href="../../d6/d0/lazyrite_8c-source.html">lazyrite.c</a>.
<p>
References <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00056">EXCEPTION_CONTINUE_SEARCH</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, and <a class="el" href="../../d8/d2/fsrtl_2filter_8c-source.html#l00082">FsRtlIsNtstatusExpected()</a>.
<p>
Referenced by <a class="el" href="../../d7/d1/cachesub_8c-source.html#l02861">CcAcquireByteRangeForWrite()</a>, <a class="el" href="../../d7/d1/cachesub_8c-source.html#l04411">CcFlushCache()</a>, <a class="el" href="../../d6/d0/lazyrite_8c-source.html#l00221">CcLazyWriteScan()</a>, and <a class="el" href="../../d6/d0/lazyrite_8c-source.html#l00738">CcWorkerThread()</a>.
<p>
<pre class="fragment"><div>00625                    :
00626 
00627     This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> standard exception filter <span class="keywordflow">for</span> worker threads which simply
00628     calls an FsRtl routine to see <span class="keywordflow">if</span> an expected status <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being raised.
00629     If so, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exception <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> handled, <span class="keywordflow">else</span> we bug check.
00630 
00631 Arguments:
00632 
00633     ExceptionCode - <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exception code which was raised.
00634 
00635 Return Value:
00636 
00637     <a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a> <span class="keywordflow">if</span> expected, <span class="keywordflow">else</span> a Bug Check occurs.
00638 
00639 --*/
00640 
00641 {
00642     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(0, 0, <span class="stringliteral">"CcExceptionFilter %08lx\n"</span>, ExceptionCode);
00643 
00644     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d8/fsrtl_8h.html#a137">FsRtlIsNtstatusExpected</a>( ExceptionCode )) {
00645 
00646         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>;
00647 
00648     } <span class="keywordflow">else</span> {
00649 
00650         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a34">EXCEPTION_CONTINUE_SEARCH</a>;
00651     }
00652 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="lazyrite.c::CcLazyWriteScan" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID CcLazyWriteScan           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/lazyrite_8c-source.html#l00221">221</a> of file <a class="el" href="../../d6/d0/lazyrite_8c-source.html">lazyrite.c</a>.
<p>
References <a class="el" href="../../d6/d4/cc_8h-source.html#l00064">CcAcquireMasterLock</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l01847">CcAllocateWorkQueueEntry</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00185">CcBugCheck</a>, <a class="el" href="../../d4/d2/cache_8h.html#a72">CcCanIWrite()</a>, <a class="el" href="../../d6/d1/cachedat_8c-source.html#l00109">CcCapturedSystemSize</a>, <a class="el" href="../../d6/d1/cachedat_8c-source.html#l00096">CcDeferredWrites</a>, <a class="el" href="../../d6/d1/cachedat_8c-source.html#l00101">CcDirtyPagesLastScan</a>, <a class="el" href="../../d6/d1/cachedat_8c-source.html#l00098">CcDirtyPageTarget</a>, <a class="el" href="../../d6/d0/lazyrite_8c-source.html#l00619">CcExceptionFilter()</a>, <a class="el" href="../../d6/d1/cachedat_8c-source.html#l00032">CcLazyWriterCursor</a>, <a class="el" href="../../d6/d1/cachedat_8c-source.html#l00100">CcPagesWrittenLastTime</a>, <a class="el" href="../../d6/d1/cachedat_8c-source.html#l00099">CcPagesYetToWrite</a>, <a class="el" href="../../d6/d6/copysup_8c-source.html#l02099">CcPostDeferredWrites()</a>, <a class="el" href="../../d6/d1/cachedat_8c-source.html#l00054">CcPostTickWorkQueue</a>, <a class="el" href="../../d6/d0/lazyrite_8c-source.html#l00662">CcPostWorkQueue()</a>, <a class="el" href="../../d6/d1/cachedat_8c-source.html#l00053">CcRegularWorkQueue</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00067">CcReleaseMasterLock</a>, <a class="el" href="../../d6/d0/lazyrite_8c-source.html#l00049">CcScheduleLazyWriteScan()</a>, <a class="el" href="../../d6/d1/cachedat_8c-source.html#l00103">CcTotalDirtyPages</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00509">ClearFlag</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00846">_SHARED_CACHE_MAP::DirtyPages</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00796">_SHARED_CACHE_MAP::FileObject</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00752">_SHARED_CACHE_MAP::FileSize</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01533">_FILE_OBJECT::Flags</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00832">_SHARED_CACHE_MAP::Flags</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01505">FO_TEMPORARY_FILE</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l01535">_WORK_QUEUE_ENTRY::Function</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l01090">IS_CURSOR</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00436">LAZY_WRITER_MAX_AGE_TARGET</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00939">_SHARED_CACHE_MAP::LazyWritePassCount</a>, <a class="el" href="../../d6/d1/cachedat_8c-source.html#l00129">LazyWriter</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00223">MAX_WRITE_BEHIND</a>, <a class="el" href="../../d7/d1/cachesub_8c-source.html#l00033">me</a>, <a class="el" href="../../d2/d1/mm_8h.html#a343a165">MmSmallSystem</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l01077">MODIFIED_WRITE_DISABLED</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00740">_SHARED_CACHE_MAP::OpenCount</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l01471">_LAZY_WRITER::OtherWork</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00886">_SHARED_CACHE_MAP::PagesToWrite</a>, <a class="el" href="../../d2/d9/struct__WORK__QUEUE__ENTRY.html#o7">_WORK_QUEUE_ENTRY::Parameters</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l01464">_LAZY_WRITER::ScanActive</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00505">SetFlag</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00826">_SHARED_CACHE_MAP::SharedCacheMapLinks</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l01113">_SHARED_CACHE_MAP_LIST_CURSOR::SharedCacheMapLinks</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00280">WRITE_CHARGE_THRESHOLD</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l01051">WRITE_QUEUED</a>, and <a class="el" href="../../d5/d5/cc_8h.html#a210a168">WriteBehind</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/lazyrite_8c-source.html#l00738">CcWorkerThread()</a>.
<p>
<pre class="fragment"><div>00226                    :
00227 
00228     This routine implements <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Lazy <a class="code" href="../../d4/d0/tex_8c.html#a44">Writer</a> scan <span class="keywordflow">for</span> dirty data to flush
00229     or any other work to <span class="keywordflow">do</span> (lazy close).  This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> scheduled by
00230     calling <a class="code" href="../../d5/d5/cc_8h.html#a185">CcScheduleLazyWriteScan</a>.
00231 
00232 Arguments:
00233 
00234     None.
00235 
00236 Return Value:
00237 
00238     None.
00239 
00240 --*/
00241 
00242 {
00243     ULONG PagesToWrite, ForegroundRate, EstimatedDirtyNextInterval;
00244     <a class="code" href="../../d0/d3/struct__SHARED__CACHE__MAP.html">PSHARED_CACHE_MAP</a> SharedCacheMap, FirstVisited;
00245     KIRQL OldIrql;
00246     ULONG LoopsWithLockHeld = 0;
00247     BOOLEAN AlreadyMoved = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00248 
00249     LIST_ENTRY PostTickWorkQueue;
00250 
00251     <span class="comment">//</span>
00252     <span class="comment">//  Top of Lazy Writer scan.</span>
00253     <span class="comment">//</span>
00254 
00255     <span class="keywordflow">try</span> {
00256 
00257         <span class="comment">//</span>
00258         <span class="comment">//  If there is no work to do, then we will go inactive, and return.</span>
00259         <span class="comment">//</span>
00260 
00261         <a class="code" href="../../d5/d5/cc_8h.html#a0">CcAcquireMasterLock</a>( &amp;OldIrql );
00262 
00263         <span class="keywordflow">if</span> ((<a class="code" href="../../d5/d2/cachedat_8c.html#a36">CcTotalDirtyPages</a> == 0) &amp;&amp; !<a class="code" href="../../d5/d2/cachedat_8c.html#a41">LazyWriter</a>.<a class="code" href="../../d3/d9/struct__LAZY__WRITER.html#o6">OtherWork</a>) {
00264 
00265             <span class="comment">//</span>
00266             <span class="comment">//  Sleep if there are no deferred writes.  It is important to check</span>
00267             <span class="comment">//  proactively because writes may be blocked for reasons external</span>
00268             <span class="comment">//  to the cache manager.  The lazy writer must keep poking since it</span>
00269             <span class="comment">//  may have no bytes to write itself.</span>
00270             <span class="comment">//</span>
00271         
00272             <span class="keywordflow">if</span> (IsListEmpty(&amp;CcDeferredWrites)) {
00273                 
00274                 <a class="code" href="../../d5/d2/cachedat_8c.html#a41">LazyWriter</a>.<a class="code" href="../../d3/d9/struct__LAZY__WRITER.html#o5">ScanActive</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00275                 <a class="code" href="../../d5/d5/cc_8h.html#a1">CcReleaseMasterLock</a>( OldIrql );
00276             
00277             } <span class="keywordflow">else</span> {
00278 
00279                 <a class="code" href="../../d5/d5/cc_8h.html#a1">CcReleaseMasterLock</a>( OldIrql );
00280         
00281                 <span class="comment">//</span>
00282                 <span class="comment">//  Check for writes and schedule the next scan.</span>
00283                 <span class="comment">//</span>
00284         
00285                 <a class="code" href="../../d5/d5/cc_8h.html#a174">CcPostDeferredWrites</a>();
00286                 <a class="code" href="../../d5/d5/cc_8h.html#a185">CcScheduleLazyWriteScan</a>();
00287             }
00288 
00289             <span class="keywordflow">return</span>;
00290         }
00291 
00292         <span class="comment">//</span>
00293         <span class="comment">//  Pull out the post tick workitems for this pass.  It is important that</span>
00294         <span class="comment">//  we are doing this at the top since more could be queued as we rummage</span>
00295         <span class="comment">//  for work to do.  Post tick workitems are guaranteed to occur after all</span>
00296         <span class="comment">//  work generated in a complete scan.</span>
00297         <span class="comment">//</span>
00298 
00299         InitializeListHead( &amp;PostTickWorkQueue );
00300         <span class="keywordflow">while</span> (!IsListEmpty( &amp;CcPostTickWorkQueue )) {
00301 
00302             PLIST_ENTRY Entry = RemoveHeadList( &amp;CcPostTickWorkQueue );
00303             InsertTailList( &amp;PostTickWorkQueue, Entry );
00304         }
00305 
00306         <span class="comment">//</span>
00307         <span class="comment">//  Calculate the next sweep time stamp, then update all relevant fields for</span>
00308         <span class="comment">//  the next time around.  Also we can clear the OtherWork flag.</span>
00309         <span class="comment">//</span>
00310 
00311         <a class="code" href="../../d5/d2/cachedat_8c.html#a41">LazyWriter</a>.<a class="code" href="../../d3/d9/struct__LAZY__WRITER.html#o6">OtherWork</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00312 
00313         <span class="comment">//</span>
00314         <span class="comment">//  Assume we will write our usual fraction of dirty pages.  Do not do the</span>
00315         <span class="comment">//  divide if there is not enough dirty pages, or else we will never write</span>
00316         <span class="comment">//  the last few pages.</span>
00317         <span class="comment">//</span>
00318 
00319         PagesToWrite = <a class="code" href="../../d5/d2/cachedat_8c.html#a36">CcTotalDirtyPages</a>;
00320         <span class="keywordflow">if</span> (PagesToWrite &gt; <a class="code" href="../../d5/d5/cc_8h.html#a55">LAZY_WRITER_MAX_AGE_TARGET</a>) {
00321             PagesToWrite /= <a class="code" href="../../d5/d5/cc_8h.html#a55">LAZY_WRITER_MAX_AGE_TARGET</a>;
00322         }
00323 
00324         <span class="comment">//</span>
00325         <span class="comment">//  Estimate the rate of dirty pages being produced in the foreground.</span>
00326         <span class="comment">//  This is the total number of dirty pages now plus the number of dirty</span>
00327         <span class="comment">//  pages we scheduled to write last time, minus the number of dirty</span>
00328         <span class="comment">//  pages we have now.  Throw out any cases which would not produce a</span>
00329         <span class="comment">//  positive rate.</span>
00330         <span class="comment">//</span>
00331 
00332         ForegroundRate = 0;
00333 
00334         <span class="keywordflow">if</span> ((<a class="code" href="../../d5/d2/cachedat_8c.html#a36">CcTotalDirtyPages</a> + <a class="code" href="../../d5/d2/cachedat_8c.html#a33">CcPagesWrittenLastTime</a>) &gt; <a class="code" href="../../d5/d2/cachedat_8c.html#a34">CcDirtyPagesLastScan</a>) {
00335             ForegroundRate = (<a class="code" href="../../d5/d2/cachedat_8c.html#a36">CcTotalDirtyPages</a> + <a class="code" href="../../d5/d2/cachedat_8c.html#a33">CcPagesWrittenLastTime</a>) -
00336                              <a class="code" href="../../d5/d2/cachedat_8c.html#a34">CcDirtyPagesLastScan</a>;
00337         }
00338 
00339         <span class="comment">//</span>
00340         <span class="comment">//  If we estimate that we will exceed our dirty page target by the end</span>
00341         <span class="comment">//  of this interval, then we must write more.  Try to arrive on target.</span>
00342         <span class="comment">//</span>
00343 
00344         EstimatedDirtyNextInterval = <a class="code" href="../../d5/d2/cachedat_8c.html#a36">CcTotalDirtyPages</a> - PagesToWrite + ForegroundRate;
00345 
00346         <span class="keywordflow">if</span> (EstimatedDirtyNextInterval &gt; <a class="code" href="../../d5/d2/cachedat_8c.html#a31">CcDirtyPageTarget</a>) {
00347             PagesToWrite += EstimatedDirtyNextInterval - <a class="code" href="../../d5/d2/cachedat_8c.html#a31">CcDirtyPageTarget</a>;
00348         }
00349 
00350         <span class="comment">//</span>
00351         <span class="comment">//  Now save away the number of dirty pages and the number of pages we</span>
00352         <span class="comment">//  just calculated to write.</span>
00353         <span class="comment">//</span>
00354 
00355         <a class="code" href="../../d5/d2/cachedat_8c.html#a34">CcDirtyPagesLastScan</a> = <a class="code" href="../../d5/d2/cachedat_8c.html#a36">CcTotalDirtyPages</a>;
00356         <a class="code" href="../../d5/d2/cachedat_8c.html#a32">CcPagesYetToWrite</a> = <a class="code" href="../../d5/d2/cachedat_8c.html#a33">CcPagesWrittenLastTime</a> = PagesToWrite;
00357 
00358         <span class="comment">//</span>
00359         <span class="comment">//  Loop to flush enough Shared Cache Maps to write the number of pages</span>
00360         <span class="comment">//  we just calculated.</span>
00361         <span class="comment">//</span>
00362 
00363         SharedCacheMap = CONTAINING_RECORD( <a class="code" href="../../d5/d2/cachedat_8c.html#a3">CcLazyWriterCursor</a>.<a class="code" href="../../d1/d3/struct__SHARED__CACHE__MAP__LIST__CURSOR.html#o0">SharedCacheMapLinks</a>.Flink,
00364                                             <a class="code" href="../../d0/d3/struct__SHARED__CACHE__MAP.html">SHARED_CACHE_MAP</a>,
00365                                             SharedCacheMapLinks );
00366 
00367         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( 0, me, <span class="stringliteral">"Start of Lazy Writer Scan\n"</span>, 0 );
00368 
00369         <span class="comment">//</span>
00370         <span class="comment">//  Normally we would just like to visit every Cache Map once on each scan,</span>
00371         <span class="comment">//  so the scan will terminate normally when we return to FirstVisited.  But</span>
00372         <span class="comment">//  in the off chance that FirstVisited gets deleted, we are guaranteed to stop</span>
00373         <span class="comment">//  when we get back to our own listhead.</span>
00374         <span class="comment">//</span>
00375 
00376         FirstVisited = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00377         <span class="keywordflow">while</span> ((SharedCacheMap != FirstVisited) &amp;&amp;
00378                (&amp;SharedCacheMap-&gt;<a class="code" href="../../d0/d3/struct__SHARED__CACHE__MAP.html#o17">SharedCacheMapLinks</a> != &amp;<a class="code" href="../../d5/d2/cachedat_8c.html#a3">CcLazyWriterCursor</a>.<a class="code" href="../../d1/d3/struct__SHARED__CACHE__MAP__LIST__CURSOR.html#o0">SharedCacheMapLinks</a>)) {
00379 
00380             <span class="keywordflow">if</span> (FirstVisited == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00381                 FirstVisited = SharedCacheMap;
00382             }
00383 
00384             <span class="comment">//</span>
00385             <span class="comment">//  Skip the SharedCacheMap if a write behind request is</span>
00386             <span class="comment">//  already queued, write behind has been disabled, or</span>
00387             <span class="comment">//  if there is no work to do (either dirty data to be written</span>
00388             <span class="comment">//  or a delete is required).</span>
00389             <span class="comment">//</span>
00390             <span class="comment">//  Note that for streams where modified writing is disabled, we</span>
00391             <span class="comment">//  need to take out Bcbs exclusive, which serializes with foreground</span>
00392             <span class="comment">//  activity.  Therefore we use a special counter in the SharedCacheMap</span>
00393             <span class="comment">//  to only service these once every n intervals.</span>
00394             <span class="comment">//</span>
00395             <span class="comment">//  Skip temporary files unless we currently could not write as many</span>
00396             <span class="comment">//  bytes as we might charge some hapless thread for throttling.</span>
00397             <span class="comment">//</span>
00398             <span class="comment">//  When considering lazy closes, decline to work on SharedCacheMaps</span>
00399             <span class="comment">//  that would require additional IO already prohibited by our normal</span>
00400             <span class="comment">//  tests.</span>
00401             <span class="comment">//</span>
00402 
00403             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>(SharedCacheMap-&gt;<a class="code" href="../../d0/d3/struct__SHARED__CACHE__MAP.html#o18">Flags</a>, WRITE_QUEUED | IS_CURSOR)
00404 
00405                     &amp;&amp;
00406 
00407                 (((PagesToWrite != 0) &amp;&amp; (SharedCacheMap-&gt;<a class="code" href="../../d0/d3/struct__SHARED__CACHE__MAP.html#o20">DirtyPages</a> != 0) &amp;&amp;
00408                   (((++SharedCacheMap-&gt;<a class="code" href="../../d0/d3/struct__SHARED__CACHE__MAP.html#o33">LazyWritePassCount</a> &amp; 0xF) == 0) ||
00409                    !<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>(SharedCacheMap-&gt;<a class="code" href="../../d0/d3/struct__SHARED__CACHE__MAP.html#o18">Flags</a>, MODIFIED_WRITE_DISABLED) ||
00410                    (<a class="code" href="../../d5/d2/cachedat_8c.html#a37">CcCapturedSystemSize</a> == <a class="code" href="../../d2/d1/mm_8h.html#a343a165">MmSmallSystem</a>) ||
00411                    (SharedCacheMap-&gt;<a class="code" href="../../d0/d3/struct__SHARED__CACHE__MAP.html#o20">DirtyPages</a> &gt;= (4 * (<a class="code" href="../../d5/d5/cc_8h.html#a33">MAX_WRITE_BEHIND</a> / <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>)))) &amp;&amp;
00412                   (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>(SharedCacheMap-&gt;<a class="code" href="../../d0/d3/struct__SHARED__CACHE__MAP.html#o10">FileObject</a>-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o18">Flags</a>, FO_TEMPORARY_FILE) ||
00413                    !<a class="code" href="../../d4/d2/cache_8h.html#a72">CcCanIWrite</a>(SharedCacheMap-&gt;<a class="code" href="../../d0/d3/struct__SHARED__CACHE__MAP.html#o10">FileObject</a>, WRITE_CHARGE_THRESHOLD, FALSE, MAXUCHAR)))
00414 
00415                     ||
00416 
00417                  ((SharedCacheMap-&gt;<a class="code" href="../../d0/d3/struct__SHARED__CACHE__MAP.html#o2">OpenCount</a> == 0) &amp;&amp;
00418                   ((SharedCacheMap-&gt;<a class="code" href="../../d0/d3/struct__SHARED__CACHE__MAP.html#o20">DirtyPages</a> == 0) ||
00419                    (SharedCacheMap-&gt;<a class="code" href="../../d0/d3/struct__SHARED__CACHE__MAP.html#o3">FileSize</a>.QuadPart == 0))))) {
00420 
00421                 <a class="code" href="../../d2/d9/struct__WORK__QUEUE__ENTRY.html">PWORK_QUEUE_ENTRY</a> WorkQueueEntry;
00422 
00423                 <span class="comment">//</span>
00424                 <span class="comment">//  If this is a metadata stream with at least 4 times</span>
00425                 <span class="comment">//  the maximum write behind I/O size, then let's tell</span>
00426                 <span class="comment">//  this guy to write 1/8 of his dirty data on this pass</span>
00427                 <span class="comment">//  so it doesn't build up.</span>
00428                 <span class="comment">//</span>
00429                 <span class="comment">//  Else assume we can write everything (PagesToWrite only affects</span>
00430                 <span class="comment">//  metadata streams - otherwise writing is controlled by the Mbcb).</span>
00431                 <span class="comment">//</span>
00432 
00433                 SharedCacheMap-&gt;<a class="code" href="../../d0/d3/struct__SHARED__CACHE__MAP.html#o25">PagesToWrite</a> = SharedCacheMap-&gt;<a class="code" href="../../d0/d3/struct__SHARED__CACHE__MAP.html#o20">DirtyPages</a>;
00434 
00435                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>(SharedCacheMap-&gt;<a class="code" href="../../d0/d3/struct__SHARED__CACHE__MAP.html#o18">Flags</a>, MODIFIED_WRITE_DISABLED) &amp;&amp;
00436                     (SharedCacheMap-&gt;<a class="code" href="../../d0/d3/struct__SHARED__CACHE__MAP.html#o25">PagesToWrite</a> &gt;= (4 * (<a class="code" href="../../d5/d5/cc_8h.html#a33">MAX_WRITE_BEHIND</a> / <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>))) &amp;&amp;
00437                     (<a class="code" href="../../d5/d2/cachedat_8c.html#a37">CcCapturedSystemSize</a> != <a class="code" href="../../d2/d1/mm_8h.html#a343a165">MmSmallSystem</a>)) {
00438 
00439                     SharedCacheMap-&gt;<a class="code" href="../../d0/d3/struct__SHARED__CACHE__MAP.html#o25">PagesToWrite</a> /= 8;
00440                 }
00441 
00442                 <span class="comment">//</span>
00443                 <span class="comment">//  If still searching for pages to write, adjust our targets.</span>
00444                 <span class="comment">//</span>
00445 
00446                 <span class="keywordflow">if</span> (!AlreadyMoved) {
00447 
00448                     <span class="comment">//</span>
00449                     <span class="comment">//  See if he exhausts the number of pages to write.  (We</span>
00450                     <span class="comment">//  keep going in case there are any closes to do.)</span>
00451                     <span class="comment">//</span>
00452 
00453                     <span class="keywordflow">if</span> (SharedCacheMap-&gt;<a class="code" href="../../d0/d3/struct__SHARED__CACHE__MAP.html#o25">PagesToWrite</a> &gt;= PagesToWrite) {
00454 
00455                         <span class="comment">//</span>
00456                         <span class="comment">//  If we met our write quota on a given SharedCacheMap, then make sure</span>
00457                         <span class="comment">//  we start at him on the next scan, unless it is a metadata stream.</span>
00458                         <span class="comment">//</span>
00459 
00460                         RemoveEntryList( &amp;<a class="code" href="../../d5/d2/cachedat_8c.html#a3">CcLazyWriterCursor</a>.<a class="code" href="../../d1/d3/struct__SHARED__CACHE__MAP__LIST__CURSOR.html#o0">SharedCacheMapLinks</a> );
00461 
00462                         <span class="comment">//</span>
00463                         <span class="comment">//  For Metadata streams, set up to resume on the next stream on the</span>
00464                         <span class="comment">//  next scan.</span>
00465                         <span class="comment">//</span>
00466 
00467                         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>(SharedCacheMap-&gt;<a class="code" href="../../d0/d3/struct__SHARED__CACHE__MAP.html#o18">Flags</a>, MODIFIED_WRITE_DISABLED)) {
00468                             InsertHeadList( &amp;SharedCacheMap-&gt;<a class="code" href="../../d0/d3/struct__SHARED__CACHE__MAP.html#o17">SharedCacheMapLinks</a>, &amp;<a class="code" href="../../d5/d2/cachedat_8c.html#a3">CcLazyWriterCursor</a>.<a class="code" href="../../d1/d3/struct__SHARED__CACHE__MAP__LIST__CURSOR.html#o0">SharedCacheMapLinks</a> );
00469 
00470                             <span class="comment">//</span>
00471                             <span class="comment">//  For other streams, set up to resume on the same stream on the</span>
00472                             <span class="comment">//  next scan.</span>
00473                             <span class="comment">//</span>
00474 
00475                         } <span class="keywordflow">else</span> {
00476                             InsertTailList( &amp;SharedCacheMap-&gt;<a class="code" href="../../d0/d3/struct__SHARED__CACHE__MAP.html#o17">SharedCacheMapLinks</a>, &amp;<a class="code" href="../../d5/d2/cachedat_8c.html#a3">CcLazyWriterCursor</a>.<a class="code" href="../../d1/d3/struct__SHARED__CACHE__MAP__LIST__CURSOR.html#o0">SharedCacheMapLinks</a> );
00477                         }
00478 
00479                         PagesToWrite = 0;
00480                         AlreadyMoved = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00481 
00482                     } <span class="keywordflow">else</span> {
00483 
00484                         PagesToWrite -= SharedCacheMap-&gt;<a class="code" href="../../d0/d3/struct__SHARED__CACHE__MAP.html#o25">PagesToWrite</a>;
00485                     }
00486                 }
00487 
00488                 <span class="comment">//</span>
00489                 <span class="comment">//  Otherwise show we are actively writing, and keep it in the dirty</span>
00490                 <span class="comment">//  list.</span>
00491                 <span class="comment">//</span>
00492 
00493                 <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>(SharedCacheMap-&gt;<a class="code" href="../../d0/d3/struct__SHARED__CACHE__MAP.html#o18">Flags</a>, WRITE_QUEUED);
00494                 SharedCacheMap-&gt;<a class="code" href="../../d0/d3/struct__SHARED__CACHE__MAP.html#o20">DirtyPages</a> += 1;
00495 
00496                 <a class="code" href="../../d5/d5/cc_8h.html#a1">CcReleaseMasterLock</a>( OldIrql );
00497 
00498                 <span class="comment">//</span>
00499                 <span class="comment">//  Queue the request to do the work to a worker thread.</span>
00500                 <span class="comment">//</span>
00501 
00502                 WorkQueueEntry = <a class="code" href="../../d5/d5/cc_8h.html#a88">CcAllocateWorkQueueEntry</a>();
00503 
00504                 <span class="comment">//</span>
00505                 <span class="comment">//  If we failed to allocate a WorkQueueEntry, things must</span>
00506                 <span class="comment">//  be in pretty bad shape.  However, all we have to do is</span>
00507                 <span class="comment">//  break out of our current loop, and try to go back and</span>
00508                 <span class="comment">//  delay a while.  Even if the current guy should have gone</span>
00509                 <span class="comment">//  away when we clear WRITE_QUEUED, we will find him again</span>
00510                 <span class="comment">//  in the LW scan.</span>
00511                 <span class="comment">//</span>
00512 
00513                 <span class="keywordflow">if</span> (WorkQueueEntry == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00514 
00515                     <a class="code" href="../../d5/d5/cc_8h.html#a0">CcAcquireMasterLock</a>( &amp;OldIrql );
00516                     <a class="code" href="../../d5/d5/cc_8h.html#a61">ClearFlag</a>(SharedCacheMap-&gt;<a class="code" href="../../d0/d3/struct__SHARED__CACHE__MAP.html#o18">Flags</a>, WRITE_QUEUED);
00517                     SharedCacheMap-&gt;<a class="code" href="../../d0/d3/struct__SHARED__CACHE__MAP.html#o20">DirtyPages</a> -= 1;
00518                     <span class="keywordflow">break</span>;
00519                 }
00520 
00521                 WorkQueueEntry-&gt;<a class="code" href="../../d2/d9/struct__WORK__QUEUE__ENTRY.html#o8">Function</a> = (UCHAR)<a class="code" href="../../d5/d5/cc_8h.html#a210a168">WriteBehind</a>;
00522                 WorkQueueEntry-&gt;<a class="code" href="../../d2/d9/struct__WORK__QUEUE__ENTRY.html#o7">Parameters</a>.Write.SharedCacheMap = SharedCacheMap;
00523 
00524                 <span class="comment">//</span>
00525                 <span class="comment">//  Post it to the regular work queue.</span>
00526                 <span class="comment">//</span>
00527 
00528                 <a class="code" href="../../d5/d5/cc_8h.html#a0">CcAcquireMasterLock</a>( &amp;OldIrql );
00529                 SharedCacheMap-&gt;<a class="code" href="../../d0/d3/struct__SHARED__CACHE__MAP.html#o20">DirtyPages</a> -= 1;
00530                 <a class="code" href="../../d5/d1/lazyrite_8c.html#a8">CcPostWorkQueue</a>( WorkQueueEntry, &amp;CcRegularWorkQueue );
00531 
00532                 LoopsWithLockHeld = 0;
00533 
00534             <span class="comment">//</span>
00535             <span class="comment">//  Make sure we occassionally drop the lock.  Set WRITE_QUEUED</span>
00536             <span class="comment">//  to keep the guy from going away.</span>
00537             <span class="comment">//</span>
00538 
00539             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((++LoopsWithLockHeld &gt;= 20) &amp;&amp;
00540                        !<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>(SharedCacheMap-&gt;<a class="code" href="../../d0/d3/struct__SHARED__CACHE__MAP.html#o18">Flags</a>, WRITE_QUEUED | IS_CURSOR)) {
00541 
00542                 <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>(SharedCacheMap-&gt;<a class="code" href="../../d0/d3/struct__SHARED__CACHE__MAP.html#o18">Flags</a>, WRITE_QUEUED);
00543                 SharedCacheMap-&gt;<a class="code" href="../../d0/d3/struct__SHARED__CACHE__MAP.html#o20">DirtyPages</a> += 1;
00544                 <a class="code" href="../../d5/d5/cc_8h.html#a1">CcReleaseMasterLock</a>( OldIrql );
00545                 LoopsWithLockHeld = 0;
00546                 <a class="code" href="../../d5/d5/cc_8h.html#a0">CcAcquireMasterLock</a>( &amp;OldIrql );
00547                 <a class="code" href="../../d5/d5/cc_8h.html#a61">ClearFlag</a>(SharedCacheMap-&gt;<a class="code" href="../../d0/d3/struct__SHARED__CACHE__MAP.html#o18">Flags</a>, WRITE_QUEUED);
00548                 SharedCacheMap-&gt;<a class="code" href="../../d0/d3/struct__SHARED__CACHE__MAP.html#o20">DirtyPages</a> -= 1;
00549             }
00550 
00551             <span class="comment">//</span>
00552             <span class="comment">//  Now loop back.</span>
00553             <span class="comment">//</span>
00554 
00555             SharedCacheMap =
00556                 CONTAINING_RECORD( SharedCacheMap-&gt;<a class="code" href="../../d0/d3/struct__SHARED__CACHE__MAP.html#o17">SharedCacheMapLinks</a>.Flink,
00557                                    <a class="code" href="../../d0/d3/struct__SHARED__CACHE__MAP.html">SHARED_CACHE_MAP</a>,
00558                                    SharedCacheMapLinks );
00559         }
00560 
00561         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( 0, me, <span class="stringliteral">"End of Lazy Writer Scan\n"</span>, 0 );
00562 
00563         <span class="comment">//</span>
00564         <span class="comment">//  Queue up our  post tick workitems for this pass.</span>
00565         <span class="comment">//</span>
00566 
00567         <span class="keywordflow">while</span> (!IsListEmpty( &amp;PostTickWorkQueue )) {
00568 
00569             PLIST_ENTRY Entry = RemoveHeadList( &amp;PostTickWorkQueue );
00570             <a class="code" href="../../d5/d1/lazyrite_8c.html#a8">CcPostWorkQueue</a>( CONTAINING_RECORD( Entry, <a class="code" href="../../d2/d9/struct__WORK__QUEUE__ENTRY.html">WORK_QUEUE_ENTRY</a>, WorkQueueLinks ),
00571                              &amp;CcRegularWorkQueue );
00572         }
00573         
00574         <span class="comment">//</span>
00575         <span class="comment">//  Now we can release the global list and loop back, per chance to sleep.</span>
00576         <span class="comment">//</span>
00577 
00578         <a class="code" href="../../d5/d5/cc_8h.html#a1">CcReleaseMasterLock</a>( OldIrql );
00579 
00580         <span class="comment">//</span>
00581         <span class="comment">//  Once again we need to give the deferred writes a poke.  We can have all dirty</span>
00582         <span class="comment">//  pages on disable_write_behind files but also have an external condition that</span>
00583         <span class="comment">//  caused the cached IO to be deferred. If so, this serves as our only chance to</span>
00584         <span class="comment">//  issue it when the condition clears.</span>
00585         <span class="comment">//</span>
00586         <span class="comment">//  Case hit on ForrestF's 5gb Alpha, 1/12/99.</span>
00587         <span class="comment">//</span>
00588         
00589         <span class="keywordflow">if</span> (!IsListEmpty(&amp;CcDeferredWrites)) {
00590             
00591             <a class="code" href="../../d5/d5/cc_8h.html#a174">CcPostDeferredWrites</a>();
00592         }
00593 
00594         <span class="comment">//</span>
00595         <span class="comment">//  Now go ahead and schedule the next scan.</span>
00596         <span class="comment">//</span>
00597 
00598         <a class="code" href="../../d5/d5/cc_8h.html#a185">CcScheduleLazyWriteScan</a>();
00599 
00600     <span class="comment">//</span>
00601     <span class="comment">//  Basically, the Lazy Writer thread should never get an exception,</span>
00602     <span class="comment">//  so we put a try-except around it that bug checks one way or the other.</span>
00603     <span class="comment">//  Better we bug check here than worry about what happens if we let one</span>
00604     <span class="comment">//  get by.</span>
00605     <span class="comment">//</span>
00606 
00607     } except( <a class="code" href="../../d5/d1/lazyrite_8c.html#a7">CcExceptionFilter</a>( GetExceptionCode() )) {
00608 
00609         <a class="code" href="../../d5/d5/cc_8h.html#a28">CcBugCheck</a>( GetExceptionCode(), 0, 0 );
00610     }
00611 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="lazyrite.c::CcPostWorkQueue" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID FASTCALL CcPostWorkQueue           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d2/d9/struct__WORK__QUEUE__ENTRY.html">PWORK_QUEUE_ENTRY</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>WorkQueueEntry</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLIST_ENTRY&nbsp;</td>
          <td class="mdname" nowrap> <em>WorkQueue</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/lazyrite_8c-source.html#l00662">662</a> of file <a class="el" href="../../d6/d0/lazyrite_8c-source.html">lazyrite.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d6/d1/cachedat_8c-source.html#l00051">CcIdleWorkerThreadList</a>, <a class="el" href="../../d6/d1/cachedat_8c-source.html#l00050">CcNumberActiveWorkerThreads</a>, <a class="el" href="../../d6/d1/cachedat_8c-source.html#l00056">CcQueueThrottle</a>, <a class="el" href="../../d6/d1/cachedat_8c-source.html#l00048">CcWorkQueueSpinlock</a>, <a class="el" href="../../d5/d8/ex_8h.html#a332a205">CriticalWorkQueue</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d2/d8/worker_8c-source.html#l00375">ExQueueWorkItem()</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00094">List</a>, <a class="el" href="../../d7/d1/cachesub_8c-source.html#l00033">me</a>, and <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/lazyrite_8c-source.html#l00221">CcLazyWriteScan()</a>, <a class="el" href="../../d6/d0/lazyrite_8c-source.html#l00099">CcScanDpc()</a>, and <a class="el" href="../../d7/d1/cachesub_8c-source.html#l01253">CcScheduleReadAhead()</a>.
<p>
<pre class="fragment"><div>00669                    :
00670 
00671     This routine queues a WorkQueueEntry, which has been allocated and
00672     initialized by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller, to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> WorkQueue <span class="keywordflow">for</span> FIFO processing by
00673     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> work threads.
00674 
00675 Arguments:
00676 
00677     WorkQueueEntry - supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> entry to queue
00678 
00679 Return Value:
00680 
00681     None
00682 
00683 --*/
00684 
00685 {
00686     KIRQL OldIrql;
00687     PLIST_ENTRY WorkerThreadEntry = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00688 
00689     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(FIELD_OFFSET(<a class="code" href="../../d7/d9/struct__WORK__QUEUE__ITEM.html">WORK_QUEUE_ITEM</a>, List) == 0);
00690 
00691     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(+1, me, <span class="stringliteral">"CcPostWorkQueue:\n"</span>, 0 );
00692     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( 0, me, <span class="stringliteral">"    WorkQueueEntry = %08lx\n"</span>, WorkQueueEntry );
00693 
00694     <span class="comment">//</span>
00695     <span class="comment">//  Queue the entry to the respective work queue.</span>
00696     <span class="comment">//</span>
00697 
00698     ExAcquireFastLock( &amp;CcWorkQueueSpinlock, &amp;OldIrql );
00699     InsertTailList( WorkQueue, &amp;WorkQueueEntry-&gt;WorkQueueLinks );
00700 
00701     <span class="comment">//</span>
00702     <span class="comment">//  Now, if we aren't throttled and have any more idle threads we can</span>
00703     <span class="comment">//  use, activate one.</span>
00704     <span class="comment">//</span>
00705 
00706     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d2/cachedat_8c.html#a11">CcQueueThrottle</a> &amp;&amp; !IsListEmpty(&amp;CcIdleWorkerThreadList)) {
00707         WorkerThreadEntry = RemoveHeadList( &amp;CcIdleWorkerThreadList );
00708         <a class="code" href="../../d5/d2/cachedat_8c.html#a6">CcNumberActiveWorkerThreads</a> += 1;
00709     }
00710     ExReleaseFastLock( &amp;CcWorkQueueSpinlock, OldIrql );
00711 
00712     <span class="keywordflow">if</span> (WorkerThreadEntry != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00713 
00714         <span class="comment">//</span>
00715         <span class="comment">//  I had to peak in the sources to verify that this routine</span>
00716         <span class="comment">//  is a noop if the Flink is not NULL.  Sheeeeit!</span>
00717         <span class="comment">//</span>
00718 
00719         ((<a class="code" href="../../d7/d9/struct__WORK__QUEUE__ITEM.html">PWORK_QUEUE_ITEM</a>)WorkerThreadEntry)-&gt;List.Flink = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00720         <a class="code" href="../../d5/d8/ex_8h.html#a261">ExQueueWorkItem</a>( (<a class="code" href="../../d7/d9/struct__WORK__QUEUE__ITEM.html">PWORK_QUEUE_ITEM</a>)WorkerThreadEntry, CriticalWorkQueue );
00721     }
00722 
00723     <span class="comment">//</span>
00724     <span class="comment">//  And return to our caller</span>
00725     <span class="comment">//</span>
00726 
00727     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(-1, me, <span class="stringliteral">"CcPostWorkQueue -&gt; VOID\n"</span>, 0 );
00728 
00729     <span class="keywordflow">return</span>;
00730 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="lazyrite.c::CcReadWorkQueue" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d2/d9/struct__WORK__QUEUE__ENTRY.html">PWORK_QUEUE_ENTRY</a> CcReadWorkQueue           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="lazyrite.c::CcScanDpc" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID CcScanDpc           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d6/struct__KDPC.html">PKDPC</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Dpc</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>DeferredContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemArgument1</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemArgument2</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/lazyrite_8c-source.html#l00099">99</a> of file <a class="el" href="../../d6/d0/lazyrite_8c-source.html">lazyrite.c</a>.
<p>
References <a class="el" href="../../d6/d4/cc_8h-source.html#l01847">CcAllocateWorkQueueEntry</a>, <a class="el" href="../../d6/d0/lazyrite_8c-source.html#l00662">CcPostWorkQueue()</a>, <a class="el" href="../../d6/d1/cachedat_8c-source.html#l00053">CcRegularWorkQueue</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l01535">_WORK_QUEUE_ENTRY::Function</a>, <a class="el" href="../../d6/d1/cachedat_8c-source.html#l00129">LazyWriter</a>, <a class="el" href="../../d5/d5/cc_8h.html#a210a169">LazyWriteScan</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d6/d4/cc_8h-source.html#l01464">_LAZY_WRITER::ScanActive</a>.
<p>
Referenced by <a class="el" href="../../d6/d7/fssup_8c-source.html#l00069">CcInitializeCacheManager()</a>.
<p>
<pre class="fragment"><div>00108                    :
00109 
00110     This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Dpc routine which runs when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> scan timer goes off.  It
00111     simply posts an element <span class="keywordflow">for</span> an Ex Worker thread to <span class="keywordflow">do</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> scan.
00112 
00113 Arguments:
00114 
00115     (All are ignored)
00116 
00117 Return Value:
00118 
00119     None.
00120 
00121 --*/
00122 
00123 {
00124     <a class="code" href="../../d2/d9/struct__WORK__QUEUE__ENTRY.html">PWORK_QUEUE_ENTRY</a> WorkQueueEntry;
00125 
00126     UNREFERENCED_PARAMETER(Dpc);
00127     UNREFERENCED_PARAMETER(DeferredContext);
00128     UNREFERENCED_PARAMETER(SystemArgument1);
00129     UNREFERENCED_PARAMETER(SystemArgument2);
00130 
00131     WorkQueueEntry = <a class="code" href="../../d5/d5/cc_8h.html#a88">CcAllocateWorkQueueEntry</a>();
00132 
00133     <span class="comment">//</span>
00134     <span class="comment">//  If we failed to allocate a WorkQueueEntry, things must</span>
00135     <span class="comment">//  be in pretty bad shape.  However, all we have to do is</span>
00136     <span class="comment">//  say we are not active, and wait for another event to</span>
00137     <span class="comment">//  wake things up again.</span>
00138     <span class="comment">//</span>
00139 
00140     <span class="keywordflow">if</span> (WorkQueueEntry == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00141 
00142         <a class="code" href="../../d5/d2/cachedat_8c.html#a41">LazyWriter</a>.<a class="code" href="../../d3/d9/struct__LAZY__WRITER.html#o5">ScanActive</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00143 
00144     } <span class="keywordflow">else</span> {
00145 
00146         <span class="comment">//</span>
00147         <span class="comment">//  Otherwise post a work queue entry to do the scan.</span>
00148         <span class="comment">//</span>
00149 
00150         WorkQueueEntry-&gt;<a class="code" href="../../d2/d9/struct__WORK__QUEUE__ENTRY.html#o8">Function</a> = (UCHAR)<a class="code" href="../../d5/d5/cc_8h.html#a210a169">LazyWriteScan</a>;
00151 
00152         <a class="code" href="../../d5/d1/lazyrite_8c.html#a8">CcPostWorkQueue</a>( WorkQueueEntry, &amp;CcRegularWorkQueue );
00153     }
00154 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="lazyrite.c::CcScheduleLazyWriteScan" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID CcScheduleLazyWriteScan           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/lazyrite_8c-source.html#l00049">49</a> of file <a class="el" href="../../d6/d0/lazyrite_8c-source.html">lazyrite.c</a>.
<p>
References <a class="el" href="../../d6/d1/cachedat_8c-source.html#l00065">CcFirstDelay</a>, <a class="el" href="../../d6/d1/cachedat_8c-source.html#l00066">CcIdleDelay</a>, <a class="el" href="../../d4/d1/timerobj_8c-source.html#l00243">KeSetTimer()</a>, <a class="el" href="../../d6/d1/cachedat_8c-source.html#l00129">LazyWriter</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l01464">_LAZY_WRITER::ScanActive</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l01457">_LAZY_WRITER::ScanDpc</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l01458">_LAZY_WRITER::ScanTimer</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d6/d6/copysup_8c-source.html#l01982">CcDeferWrite()</a>, <a class="el" href="../../d7/d1/cachesub_8c-source.html#l04411">CcFlushCache()</a>, <a class="el" href="../../d7/d1/cachesub_8c-source.html#l04232">CcGetFlushedValidData()</a>, <a class="el" href="../../d6/d2/vacbsup_8c-source.html#l00401">CcGetVacbMiss()</a>, <a class="el" href="../../d6/d7/fssup_8c-source.html#l00387">CcInitializeCacheMap()</a>, <a class="el" href="../../d6/d0/lazyrite_8c-source.html#l00221">CcLazyWriteScan()</a>, <a class="el" href="../../d8/d4/mdlsup_8c-source.html#l00838">CcMdlWriteComplete2()</a>, <a class="el" href="../../d7/d1/cachesub_8c-source.html#l01633">CcPerformReadAhead()</a>, <a class="el" href="../../d6/d7/fssup_8c-source.html#l02331">CcPurgeCacheSection()</a>, <a class="el" href="../../d7/d1/cachesub_8c-source.html#l02242">CcSetDirtyInMask()</a>, <a class="el" href="../../d7/d1/cachesub_8c-source.html#l02560">CcSetDirtyPinnedData()</a>, <a class="el" href="../../d6/d7/fssup_8c-source.html#l01821">CcSetFileSizes()</a>, <a class="el" href="../../d6/d7/fssup_8c-source.html#l01164">CcUninitializeCacheMap()</a>, <a class="el" href="../../d6/d0/lazyrite_8c-source.html#l00158">CcWaitForCurrentLazyWriterActivity()</a>, and <a class="el" href="../../d6/d7/fssup_8c-source.html#l02804">CcZeroEndOfLastPage()</a>.
<p>
<pre class="fragment"><div>00054                    :
00055 
00056     This routine may be called to schedule <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> next lazy writer scan,
00057     during which lazy write and lazy close activity <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> posted to other
00058     worker threads.  Callers should acquire <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> lazy writer spin lock
00059     to see <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> scan <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> currently active, and then call <span class="keyword">this</span> routine
00060     still holding <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> spin lock <span class="keywordflow">if</span> not.  One special call <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used at
00061     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> end of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> lazy write scan to propagate lazy write active once
00062     we go active.  This call <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <span class="stringliteral">"the"</span> scan thread, and <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> can therefore
00063     safely schedule <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> next scan without taking <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> spin lock.
00064 
00065 Arguments:
00066 
00067     None
00068 
00069 Return Value:
00070 
00071     None.
00072 
00073 --*/
00074 
00075 {
00076     <span class="comment">//</span>
00077     <span class="comment">//  It is important to set the active flag TRUE first for the propagate</span>
00078     <span class="comment">//  case, because it is conceivable that once the timer is set, another</span>
00079     <span class="comment">//  thread could actually run and make the scan go idle before we then</span>
00080     <span class="comment">//  jam the flag TRUE.</span>
00081     <span class="comment">//</span>
00082     <span class="comment">//  When going from idle to active, we delay a little longer to let the</span>
00083     <span class="comment">//  app finish saving its file.</span>
00084     <span class="comment">//</span>
00085 
00086     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d2/cachedat_8c.html#a41">LazyWriter</a>.<a class="code" href="../../d3/d9/struct__LAZY__WRITER.html#o5">ScanActive</a>) {
00087 
00088         <a class="code" href="../../d3/d2/timerobj_8c.html#a6">KeSetTimer</a>( &amp;<a class="code" href="../../d5/d2/cachedat_8c.html#a41">LazyWriter</a>.<a class="code" href="../../d3/d9/struct__LAZY__WRITER.html#o4">ScanTimer</a>, CcIdleDelay, &amp;<a class="code" href="../../d5/d2/cachedat_8c.html#a41">LazyWriter</a>.<a class="code" href="../../d3/d9/struct__LAZY__WRITER.html#o3">ScanDpc</a> );
00089 
00090     } <span class="keywordflow">else</span> {
00091 
00092         <a class="code" href="../../d5/d2/cachedat_8c.html#a41">LazyWriter</a>.<a class="code" href="../../d3/d9/struct__LAZY__WRITER.html#o5">ScanActive</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00093         <a class="code" href="../../d3/d2/timerobj_8c.html#a6">KeSetTimer</a>( &amp;<a class="code" href="../../d5/d2/cachedat_8c.html#a41">LazyWriter</a>.<a class="code" href="../../d3/d9/struct__LAZY__WRITER.html#o4">ScanTimer</a>, CcFirstDelay, &amp;<a class="code" href="../../d5/d2/cachedat_8c.html#a41">LazyWriter</a>.<a class="code" href="../../d3/d9/struct__LAZY__WRITER.html#o3">ScanDpc</a> );
00094     }
00095 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="lazyrite.c::CcWaitForCurrentLazyWriterActivity" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS CcWaitForCurrentLazyWriterActivity           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/lazyrite_8c-source.html#l00158">158</a> of file <a class="el" href="../../d6/d0/lazyrite_8c-source.html">lazyrite.c</a>.
<p>
References <a class="el" href="../../d6/d4/cc_8h-source.html#l00064">CcAcquireMasterLock</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l01847">CcAllocateWorkQueueEntry</a>, <a class="el" href="../../d6/d1/cachedat_8c-source.html#l00054">CcPostTickWorkQueue</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00067">CcReleaseMasterLock</a>, <a class="el" href="../../d6/d0/lazyrite_8c-source.html#l00049">CcScheduleLazyWriteScan()</a>, <a class="el" href="../../d9/d8/client_2ntstubs_8c-source.html#l00086">Event()</a>, <a class="el" href="../../d5/d5/cc_8h.html#a210a170">EventSet</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l01535">_WORK_QUEUE_ENTRY::Function</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01066">KeInitializeEvent</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d6/d1/cachedat_8c-source.html#l00129">LazyWriter</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l01471">_LAZY_WRITER::OtherWork</a>, <a class="el" href="../../d2/d9/struct__WORK__QUEUE__ENTRY.html#o7">_WORK_QUEUE_ENTRY::Parameters</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l01464">_LAZY_WRITER::ScanActive</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d6/d4/cc_8h-source.html#l01497">_WORK_QUEUE_ENTRY::WorkQueueLinks</a>.
<p>
Referenced by <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l00621">UdfLockVolumeInternal()</a>.
<p>
<pre class="fragment"><div>00163                    :
00164 
00165     This routine allows a thread to receive notification when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current tick
00166     of lazy writer work has completed.  It must not be called within a lazy
00167     writer workitem!  The caller must not be holding synchronization that could
00168     block a Cc workitem!
00169     
00170     In particular, <span class="keyword">this</span> lets a caller insure that all avaliable lazy closes at
00171     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> time of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> call have completed.
00172 
00173 Arguments:
00174 
00175     None.
00176 
00177 Return Value:
00178 
00179     Final result of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> wait.    
00180 
00181 --*/
00182 
00183 {
00184     KIRQL OldIrql;
00185     <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>;
00186     <a class="code" href="../../d2/d9/struct__WORK__QUEUE__ENTRY.html">PWORK_QUEUE_ENTRY</a> WorkQueueEntry;
00187 
00188     WorkQueueEntry = <a class="code" href="../../d5/d5/cc_8h.html#a88">CcAllocateWorkQueueEntry</a>();
00189 
00190     <span class="keywordflow">if</span> (WorkQueueEntry == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00191         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00192     }
00193 
00194     WorkQueueEntry-&gt;<a class="code" href="../../d2/d9/struct__WORK__QUEUE__ENTRY.html#o8">Function</a> = (UCHAR)<a class="code" href="../../d5/d5/cc_8h.html#a210a170">EventSet</a>;
00195     <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>( &amp;Event, NotificationEvent, FALSE );
00196     WorkQueueEntry-&gt;<a class="code" href="../../d2/d9/struct__WORK__QUEUE__ENTRY.html#o7">Parameters</a>.Event.Event = &amp;<a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>;
00197 
00198     <span class="comment">//</span>
00199     <span class="comment">//  Add this to the post-tick work queue and wake the lazy writer for it.</span>
00200     <span class="comment">//  The lazy writer will add this to the end of the next batch of work</span>
00201     <span class="comment">//  he issues.</span>
00202     <span class="comment">//</span>
00203 
00204     <a class="code" href="../../d5/d5/cc_8h.html#a0">CcAcquireMasterLock</a>( &amp;OldIrql );
00205 
00206     InsertTailList( &amp;CcPostTickWorkQueue, &amp;WorkQueueEntry-&gt;<a class="code" href="../../d2/d9/struct__WORK__QUEUE__ENTRY.html#o0">WorkQueueLinks</a> );
00207 
00208     <a class="code" href="../../d5/d2/cachedat_8c.html#a41">LazyWriter</a>.<a class="code" href="../../d3/d9/struct__LAZY__WRITER.html#o6">OtherWork</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00209     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d2/cachedat_8c.html#a41">LazyWriter</a>.<a class="code" href="../../d3/d9/struct__LAZY__WRITER.html#o5">ScanActive</a>) {
00210         <a class="code" href="../../d5/d5/cc_8h.html#a185">CcScheduleLazyWriteScan</a>();
00211     }
00212 
00213     <a class="code" href="../../d5/d5/cc_8h.html#a1">CcReleaseMasterLock</a>( OldIrql );
00214 
00215     <span class="keywordflow">return</span> <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;Event, Executive, KernelMode, FALSE, NULL );
00216 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="lazyrite.c::CcWorkerThread" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID CcWorkerThread           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>ExWorkQueueItem</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/lazyrite_8c-source.html#l00738">738</a> of file <a class="el" href="../../d6/d0/lazyrite_8c-source.html">lazyrite.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00442">CC_REQUEUE</a>, <a class="el" href="../../d6/d1/cachedat_8c-source.html#l00096">CcDeferredWrites</a>, <a class="el" href="../../d6/d0/lazyrite_8c-source.html#l00619">CcExceptionFilter()</a>, <a class="el" href="../../d6/d1/cachedat_8c-source.html#l00052">CcExpressWorkQueue</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l01850">CcFreeWorkQueueEntry</a>, <a class="el" href="../../d6/d1/cachedat_8c-source.html#l00051">CcIdleWorkerThreadList</a>, <a class="el" href="../../d6/d0/lazyrite_8c-source.html#l00221">CcLazyWriteScan()</a>, <a class="el" href="../../d6/d1/cachedat_8c-source.html#l00050">CcNumberActiveWorkerThreads</a>, <a class="el" href="../../d7/d1/cachesub_8c-source.html#l01633">CcPerformReadAhead()</a>, <a class="el" href="../../d6/d1/cachedat_8c-source.html#l00056">CcQueueThrottle</a>, <a class="el" href="../../d6/d1/cachedat_8c-source.html#l00053">CcRegularWorkQueue</a>, <a class="el" href="../../d6/d1/cachedat_8c-source.html#l00103">CcTotalDirtyPages</a>, <a class="el" href="../../d6/d1/cachedat_8c-source.html#l00048">CcWorkQueueSpinlock</a>, <a class="el" href="../../d7/d1/cachesub_8c-source.html#l03880">CcWriteBehind()</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d5/d5/cc_8h.html#a210a170">EventSet</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l01535">_WORK_QUEUE_ENTRY::Function</a>, <a class="el" href="../../d3/d7/eventobj_8c-source.html#l00343">KeSetEvent()</a>, <a class="el" href="../../d5/d5/cc_8h.html#a210a169">LazyWriteScan</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00094">List</a>, <a class="el" href="../../d7/d1/cachesub_8c-source.html#l00033">me</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d2/d9/struct__WORK__QUEUE__ENTRY.html#o7">_WORK_QUEUE_ENTRY::Parameters</a>, <a class="el" href="../../d5/d5/cc_8h.html#a210a167">ReadAhead</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l01497">_WORK_QUEUE_ENTRY::WorkQueueLinks</a>, and <a class="el" href="../../d5/d5/cc_8h.html#a210a168">WriteBehind</a>.
<p>
Referenced by <a class="el" href="../../d6/d7/fssup_8c-source.html#l00069">CcInitializeCacheManager()</a>.
<p>
<pre class="fragment"><div>00744                    :
00745 
00746     This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> worker thread routine <span class="keywordflow">for</span> processing cache manager work queue
00747     entries.
00748 
00749 Arguments:
00750 
00751     ExWorkQueueItem - The work item used <span class="keywordflow">for</span> <span class="keyword">this</span> thread
00752 
00753 Return Value:
00754 
00755     None
00756 
00757 --*/
00758 
00759 {
00760     KIRQL OldIrql;
00761     PLIST_ENTRY WorkQueue;
00762     <a class="code" href="../../d2/d9/struct__WORK__QUEUE__ENTRY.html">PWORK_QUEUE_ENTRY</a> WorkQueueEntry;
00763     BOOLEAN RescanOk = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00764     BOOLEAN DropThrottle = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00765     IO_STATUS_BLOCK IoStatus;
00766 
00767     IoStatus.Status = STATUS_SUCCESS;
00768     IoStatus.Information = 0;
00769 
00770     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(FIELD_OFFSET(<a class="code" href="../../d2/d9/struct__WORK__QUEUE__ENTRY.html">WORK_QUEUE_ENTRY</a>, WorkQueueLinks) == 0);
00771 
00772     <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00773 
00774         ExAcquireFastLock( &amp;CcWorkQueueSpinlock, &amp;OldIrql );
00775 
00776         <span class="comment">//</span>
00777         <span class="comment">//  If we just processed a throttled operation, drop the flag.</span>
00778         <span class="comment">//</span>
00779 
00780         <span class="keywordflow">if</span> (DropThrottle) {
00781 
00782             DropThrottle = <a class="code" href="../../d5/d2/cachedat_8c.html#a11">CcQueueThrottle</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00783         }
00784 
00785         <span class="comment">//</span>
00786         <span class="comment">//  On requeue, push at end of the regular queue and clear hint.</span>
00787         <span class="comment">//</span>
00788         
00789         <span class="keywordflow">if</span> (IoStatus.Information == <a class="code" href="../../d5/d5/cc_8h.html#a56">CC_REQUEUE</a>) {
00790 
00791             InsertTailList( WorkQueue, &amp;WorkQueueEntry-&gt;<a class="code" href="../../d2/d9/struct__WORK__QUEUE__ENTRY.html#o0">WorkQueueLinks</a> );
00792             IoStatus.Information = 0;
00793         }
00794         
00795         <span class="comment">//</span>
00796         <span class="comment">//  First see if there is something in the express queue.</span>
00797         <span class="comment">//</span>
00798 
00799         <span class="keywordflow">if</span> (!IsListEmpty(&amp;CcExpressWorkQueue)) {
00800             WorkQueue = &amp;<a class="code" href="../../d5/d2/cachedat_8c.html#a8">CcExpressWorkQueue</a>;
00801 
00802         <span class="comment">//</span>
00803         <span class="comment">//  If there was nothing there, then try the regular queue.</span>
00804         <span class="comment">//</span>
00805 
00806         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!IsListEmpty(&amp;CcRegularWorkQueue)) {
00807             WorkQueue = &amp;<a class="code" href="../../d5/d2/cachedat_8c.html#a9">CcRegularWorkQueue</a>;
00808 
00809         <span class="comment">//</span>
00810         <span class="comment">//  Else we can break and go idle.</span>
00811         <span class="comment">//</span>
00812         
00813         } <span class="keywordflow">else</span> {
00814 
00815             <span class="keywordflow">break</span>;
00816         }
00817 
00818         WorkQueueEntry = CONTAINING_RECORD( WorkQueue-&gt;Flink, <a class="code" href="../../d2/d9/struct__WORK__QUEUE__ENTRY.html">WORK_QUEUE_ENTRY</a>, WorkQueueLinks );
00819 
00820         <span class="comment">//</span>
00821         <span class="comment">//  If this is an EventSet, throttle down to a single thread to be sure</span>
00822         <span class="comment">//  that this event fires after all preceeding workitems have completed.</span>
00823         <span class="comment">//</span>
00824 
00825         <span class="keywordflow">if</span> (WorkQueueEntry-&gt;<a class="code" href="../../d2/d9/struct__WORK__QUEUE__ENTRY.html#o8">Function</a> == <a class="code" href="../../d5/d5/cc_8h.html#a210a170">EventSet</a> &amp;&amp; <a class="code" href="../../d5/d2/cachedat_8c.html#a6">CcNumberActiveWorkerThreads</a> &gt; 1) {
00826 
00827             <a class="code" href="../../d5/d2/cachedat_8c.html#a11">CcQueueThrottle</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00828             <span class="keywordflow">break</span>;
00829         }
00830 
00831         <span class="comment">//</span>
00832         <span class="comment">//  Pop the workitem off: we will execute it now.</span>
00833         <span class="comment">//</span>
00834 
00835         RemoveHeadList( WorkQueue );
00836 
00837         ExReleaseFastLock( &amp;CcWorkQueueSpinlock, OldIrql );
00838 
00839         <span class="comment">//</span>
00840         <span class="comment">//  Process the entry within a try-except clause, so that any errors</span>
00841         <span class="comment">//  will cause us to continue after the called routine has unwound.</span>
00842         <span class="comment">//</span>
00843 
00844         <span class="keywordflow">try</span> {
00845 
00846             <span class="keywordflow">switch</span> (WorkQueueEntry-&gt;<a class="code" href="../../d2/d9/struct__WORK__QUEUE__ENTRY.html#o8">Function</a>) {
00847 
00848             <span class="comment">//</span>
00849             <span class="comment">//  Perform read ahead</span>
00850             <span class="comment">//</span>
00851 
00852             <span class="keywordflow">case</span> <a class="code" href="../../d5/d5/cc_8h.html#a210a167">ReadAhead</a>:
00853 
00854                 <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( 0, me, <span class="stringliteral">"CcWorkerThread Read Ahead FileObject = %08lx\n"</span>,
00855                             WorkQueueEntry-&gt;<a class="code" href="../../d2/d9/struct__WORK__QUEUE__ENTRY.html#o7">Parameters</a>.Read.FileObject );
00856 
00857                 <a class="code" href="../../d5/d5/cc_8h.html#a178">CcPerformReadAhead</a>( WorkQueueEntry-&gt;<a class="code" href="../../d2/d9/struct__WORK__QUEUE__ENTRY.html#o7">Parameters</a>.Read.FileObject );
00858 
00859                 <span class="keywordflow">break</span>;
00860 
00861             <span class="comment">//</span>
00862             <span class="comment">//  Perform write behind</span>
00863             <span class="comment">//</span>
00864 
00865             <span class="keywordflow">case</span> <a class="code" href="../../d5/d5/cc_8h.html#a210a168">WriteBehind</a>:
00866 
00867                 <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( 0, me, <span class="stringliteral">"CcWorkerThread WriteBehind SharedCacheMap = %08lx\n"</span>,
00868                             WorkQueueEntry-&gt;<a class="code" href="../../d2/d9/struct__WORK__QUEUE__ENTRY.html#o7">Parameters</a>.Write.SharedCacheMap );
00869 
00870                 <a class="code" href="../../d5/d5/cc_8h.html#a180">CcWriteBehind</a>( WorkQueueEntry-&gt;<a class="code" href="../../d2/d9/struct__WORK__QUEUE__ENTRY.html#o7">Parameters</a>.Write.SharedCacheMap, &amp;IoStatus );
00871                 RescanOk = (BOOLEAN)<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IoStatus.Status);
00872                 <span class="keywordflow">break</span>;
00873 
00874             
00875             <span class="comment">//</span>
00876             <span class="comment">//  Perform set event</span>
00877             <span class="comment">//</span>
00878             
00879             <span class="keywordflow">case</span> <a class="code" href="../../d5/d5/cc_8h.html#a210a170">EventSet</a>:
00880                 
00881                 <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( 0, me, <span class="stringliteral">"CcWorkerThread SetEvent Event = %08lx\n"</span>,
00882                             WorkQueueEntry-&gt;<a class="code" href="../../d2/d9/struct__WORK__QUEUE__ENTRY.html#o7">Parameters</a>.Event.Event );
00883 
00884                 <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>( WorkQueueEntry-&gt;<a class="code" href="../../d2/d9/struct__WORK__QUEUE__ENTRY.html#o7">Parameters</a>.Event.Event, 0, FALSE );
00885                 DropThrottle = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00886                 <span class="keywordflow">break</span>;
00887 
00888             <span class="comment">//</span>
00889             <span class="comment">//  Perform Lazy Write Scan</span>
00890             <span class="comment">//</span>
00891 
00892             <span class="keywordflow">case</span> <a class="code" href="../../d5/d5/cc_8h.html#a210a169">LazyWriteScan</a>:
00893 
00894                 <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>( 0, me, <span class="stringliteral">"CcWorkerThread Lazy Write Scan\n"</span>, 0 );
00895 
00896                 <a class="code" href="../../d5/d1/lazyrite_8c.html#a3">CcLazyWriteScan</a>();
00897                 <span class="keywordflow">break</span>;
00898             }
00899 
00900         }
00901         except( <a class="code" href="../../d5/d1/lazyrite_8c.html#a7">CcExceptionFilter</a>( GetExceptionCode() )) {
00902 
00903             NOTHING;
00904         }
00905 
00906         <span class="comment">//</span>
00907         <span class="comment">//  If not a requeue request, free the workitem.</span>
00908         <span class="comment">//</span>
00909         
00910         <span class="keywordflow">if</span> (IoStatus.Information != <a class="code" href="../../d5/d5/cc_8h.html#a56">CC_REQUEUE</a>) {
00911             
00912             <a class="code" href="../../d5/d5/cc_8h.html#a89">CcFreeWorkQueueEntry</a>( WorkQueueEntry );
00913         }
00914     }
00915 
00916     <span class="comment">//</span>
00917     <span class="comment">//  No more work.  Requeue our worker thread entry and get out.</span>
00918     <span class="comment">//</span>
00919 
00920     InsertTailList( &amp;CcIdleWorkerThreadList,
00921                     &amp;((<a class="code" href="../../d7/d9/struct__WORK__QUEUE__ITEM.html">PWORK_QUEUE_ITEM</a>)ExWorkQueueItem)-&gt;List );
00922     <a class="code" href="../../d5/d2/cachedat_8c.html#a6">CcNumberActiveWorkerThreads</a> -= 1;
00923 
00924     ExReleaseFastLock( &amp;CcWorkQueueSpinlock, OldIrql );
00925 
00926     <span class="keywordflow">if</span> (!IsListEmpty(&amp;CcDeferredWrites) &amp;&amp; (<a class="code" href="../../d5/d2/cachedat_8c.html#a36">CcTotalDirtyPages</a> &gt;= 20) &amp;&amp; RescanOk) {
00927         <a class="code" href="../../d5/d1/lazyrite_8c.html#a3">CcLazyWriteScan</a>();
00928     }
00929 
00930     <span class="keywordflow">return</span>;
00931 }
}
</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:44:29 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
