<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: pnpres.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>pnpres.c File Reference</h1><code>#include "<a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>"</code><br>

<p>
<a href="../../d6/d0/pnpres_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Classes</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d4/struct__REQ__DESC.html">_REQ_DESC</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d3/struct__REQ__ALTERNATIVE.html">_REQ_ALTERNATIVE</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d4/struct__REQ__LIST.html">_REQ_LIST</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d9/struct__Counter.html">_Counter</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/struct__DUPLICATE__DETECTION__CONTEXT.html">_DUPLICATE_DETECTION_CONTEXT</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d2/d1/struct__IOP__POOL.html">_IOP_POOL</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d5/structPNPRESDEBUGTRANSLATIONFAILURE.html">PNPRESDEBUGTRANSLATIONFAILURE</a></td></tr>

<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a0">MYDBG</a>&nbsp;&nbsp;&nbsp;0</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a1">ExAllocatePoolAT</a>(a, b)&nbsp;&nbsp;&nbsp;ExAllocatePool(a,b)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a2">ExAllocatePoolRD</a>(a, b)&nbsp;&nbsp;&nbsp;ExAllocatePool(a,b)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a3">ExAllocatePoolCMRL</a>(a, b)&nbsp;&nbsp;&nbsp;ExAllocatePool(a,b)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a4">ExAllocatePoolCMRR</a>(a, b)&nbsp;&nbsp;&nbsp;ExAllocatePool(a,b)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a5">ExAllocatePoolAE</a>(a, b)&nbsp;&nbsp;&nbsp;ExAllocatePool(a,b)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a6">ExAllocatePoolTE</a>(a, b)&nbsp;&nbsp;&nbsp;ExAllocatePool(a,b)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a7">ExAllocatePoolPRD</a>(a, b)&nbsp;&nbsp;&nbsp;ExAllocatePool(a,b)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a8">ExAllocatePoolIORD</a>(a, b)&nbsp;&nbsp;&nbsp;ExAllocatePool(a,b)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a9">ExAllocatePool1RD</a>(a, b)&nbsp;&nbsp;&nbsp;ExAllocatePool(a,b)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a10">ExAllocatePoolPDO</a>(a, b)&nbsp;&nbsp;&nbsp;ExAllocatePool(a,b)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a11">ExAllocatePoolIORR</a>(a, b)&nbsp;&nbsp;&nbsp;ExAllocatePool(a,b)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a12">ExAllocatePoolIORL</a>(a, b)&nbsp;&nbsp;&nbsp;ExAllocatePool(a,b)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a13">ExAllocatePoolIORRR</a>(a, b)&nbsp;&nbsp;&nbsp;ExAllocatePool(a,b)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a14">IS_TRANSLATED_REQ_DESC</a>(r)&nbsp;&nbsp;&nbsp;((r)-&gt;ReqAlternative ? FALSE : TRUE)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a15">IopReleaseBootResources</a>(DeviceNode)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a16">NextDeviceNode</a>&nbsp;&nbsp;&nbsp;Sibling</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a17">PreviousDeviceNode</a>&nbsp;&nbsp;&nbsp;Child</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a18">STRUCTURE_ALIGNMENT</a>&nbsp;&nbsp;&nbsp;1</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a19">IopInitPool</a>(Pool,<a class="el" href="../../d5/d2/config_2ia64_2initia64_8c.html#a14">Start</a>,<a class="el" href="../../d9/d7/w98_2lh__open_2pi__mem_8h.html#a0">Size</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a20">IopAllocPoolAligned</a>(Memory,Pool,<a class="el" href="../../d9/d7/w98_2lh__open_2pi__mem_8h.html#a0">Size</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a21">IopAllocPool</a>(Memory,Pool,<a class="el" href="../../d9/d7/w98_2lh__open_2pi__mem_8h.html#a0">Size</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a22">FIND_BEST_ASSIGNMENT_TIMEOUT</a>&nbsp;&nbsp;&nbsp;5000</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a23">DUMP_ERROR</a>&nbsp;&nbsp;&nbsp;0x0001</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a24">DUMP_INFO</a>&nbsp;&nbsp;&nbsp;0x0002</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a25">DUMP_DETAIL</a>&nbsp;&nbsp;&nbsp;0x0004</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a26">STOP_ERROR</a>&nbsp;&nbsp;&nbsp;0x1000</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(Level, Message)</td></tr>

<tr><td colspan=2><br><h2>Typedefs</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d0/d4/struct__REQ__DESC.html">_REQ_DESC</a> REQ_DESC *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a28">PREQ_DESC</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d9/d3/struct__REQ__ALTERNATIVE.html">_REQ_ALTERNATIVE</a> REQ_ALTERNATIVE *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a29">PREQ_ALTERNATIVE</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d2/d4/struct__REQ__LIST.html">_REQ_LIST</a> REQ_LIST *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a30">PREQ_LIST</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d0/d9/struct__Counter.html">_Counter</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a31">COUNTER</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d0/d9/struct__Counter.html">_Counter</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a32">PCOUNTER</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d2/d1/struct__DUPLICATE__DETECTION__CONTEXT.html">_DUPLICATE_DETECTION_CONTEXT</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a33">DUPLICATE_DETECTION_CONTEXT</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d2/d1/struct__DUPLICATE__DETECTION__CONTEXT.html">_DUPLICATE_DETECTION_CONTEXT</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a34">PDUPLICATE_DETECTION_CONTEXT</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d2/d1/struct__IOP__POOL.html">_IOP_POOL</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a35">IOP_POOL</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d2/d1/struct__IOP__POOL.html">_IOP_POOL</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a36">PIOP_POOL</a></td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>PCM_RESOURCE_LIST&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a51">IopCreateCmResourceList</a> (IN PCM_RESOURCE_LIST ResourceList, IN INTERFACE_TYPE <a class="el" href="../../d6/d0/cmdat_8c.html#a4">InterfaceType</a>, IN ULONG <a class="el" href="../../d2/d7/hal_8h.html#a75">BusNumber</a>, OUT PCM_RESOURCE_LIST *RemainingList)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PCM_RESOURCE_LIST&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a52">IopCombineCmResourceList</a> (IN PCM_RESOURCE_LIST ResourceListA, IN PCM_RESOURCE_LIST ResourceListB)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a53">IopRemoveLegacyDeviceNode</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject OPTIONAL, IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> LegacyDeviceNode)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a54">IopFindLegacyDeviceNode</a> (IN <a class="el" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> DriverObject, IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject OPTIONAL, OUT <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> *LegacyDeviceNode, OUT <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> *LegacyPDO)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a55">IopFindBusDeviceNodeInternal</a> (IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode, IN INTERFACE_TYPE <a class="el" href="../../d6/d0/cmdat_8c.html#a4">InterfaceType</a>, IN ULONG <a class="el" href="../../d2/d7/hal_8h.html#a75">BusNumber</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a56">IopGetResourceRequirementsForAssignTable</a> (IN <a class="el" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a> AssignTable, IN <a class="el" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a> AssignTableEnd, OUT PULONG DeviceCount)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a57">IopResourceRequirementsListToReqList</a> (IN <a class="el" href="../../d6/d9/pnp_8h.html#a58">ARBITER_REQUEST_SOURCE</a> AllocationType, IN PIO_RESOURCE_REQUIREMENTS_LIST IoResources, IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> PhysicalDevice, OUT PVOID *ResReqList)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a58">IopRearrangeReqList</a> (IN <a class="el" href="../../d5/d1/pnpres_8c.html#a30">PREQ_LIST</a> ReqList)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a59">IopRearrangeAssignTable</a> (IN <a class="el" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a> AssignTable, IN ULONG <a class="el" href="../../d6/d0/cmdat_8c.html#a5">Count</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>int __cdecl&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a60">IopComparePriority</a> (const void *arg1, const void *arg2)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a61">IopFreeResourceRequirementsForAssignTable</a> (IN <a class="el" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a> AssignTable, IN <a class="el" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a> AssignTableEnd)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a62">IopFreeReqAlternative</a> (IN <a class="el" href="../../d5/d1/pnpres_8c.html#a29">PREQ_ALTERNATIVE</a> ReqAlternative)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a63">IopFreeReqList</a> (IN <a class="el" href="../../d5/d1/pnpres_8c.html#a30">PREQ_LIST</a> ReqList)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a64">IopAssign</a> (IN ULONG AssignTableCount, IN <a class="el" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a> AssignTable, IN BOOLEAN Rebalance)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a65">IopBuildCmResourceLists</a> (IN <a class="el" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a> AssignTable, IN <a class="el" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a> AssignTableEnd)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a66">IopBuildCmResourceList</a> (IN <a class="el" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a> AssignEntry)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a67">IopAssignInner</a> (IN ULONG AssignTableCount, IN <a class="el" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a> AssignTable, IN BOOLEAN Rebalance)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a68">IopPlacement</a> (IN <a class="el" href="../../d6/d9/pnp_8h.html#a52">ARBITER_ACTION</a> ArbiterAction, IN BOOLEAN Rebalance)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a69">IopAddReqDescsToArbiters</a> (IN ULONG ReqDescCount, IN <a class="el" href="../../d5/d1/pnpres_8c.html#a28">PREQ_DESC</a> *ReqDescTable)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a70">IopRemoveReqDescsFromArbiters</a> (ULONG ReqDescCount, <a class="el" href="../../d5/d1/pnpres_8c.html#a28">PREQ_DESC</a> *ReqDescTable)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a71">IopIsBestConfiguration</a> (IN VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a72">IopSaveCurrentConfiguration</a> (IN VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a73">IopRestoreBestConfiguration</a> (IN VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a74">IopFindResourceHandlerInfo</a> (IN <a class="el" href="../../d9/d0/pnpiop_8h.html#a126">RESOURCE_HANDLER_TYPE</a> HandlerType, IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode, IN UCHAR ResourceType, OUT PVOID *HandlerEntry)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a75">IopSetupArbiterAndTranslators</a> (IN <a class="el" href="../../d5/d1/pnpres_8c.html#a28">PREQ_DESC</a> ReqDesc)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a76">IopParentToRawTranslation</a> (IN OUT <a class="el" href="../../d5/d1/pnpres_8c.html#a28">PREQ_DESC</a> ReqDesc)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a77">IopChildToRootTranslation</a> (IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode, OPTIONAL IN INTERFACE_TYPE <a class="el" href="../../d6/d0/cmdat_8c.html#a4">InterfaceType</a>, IN ULONG <a class="el" href="../../d2/d7/hal_8h.html#a75">BusNumber</a>, IN <a class="el" href="../../d6/d9/pnp_8h.html#a58">ARBITER_REQUEST_SOURCE</a> ArbiterRequestSource, IN PCM_PARTIAL_RESOURCE_DESCRIPTOR Source, OUT PCM_PARTIAL_RESOURCE_DESCRIPTOR *Target)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a78">IopTranslateAndAdjustReqDesc</a> (IN <a class="el" href="../../d5/d1/pnpres_8c.html#a28">PREQ_DESC</a> ReqDesc, IN <a class="el" href="../../d8/d5/struct__PI__RESOURCE__TRANSLATOR__ENTRY.html">PPI_RESOURCE_TRANSLATOR_ENTRY</a> TranslatorEntry, OUT <a class="el" href="../../d5/d1/pnpres_8c.html#a28">PREQ_DESC</a> *TranslatedReqDesc)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a79">IopCallArbiter</a> (<a class="el" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html">PPI_RESOURCE_ARBITER_ENTRY</a> ArbiterEntry, <a class="el" href="../../d6/d9/pnp_8h.html#a52">ARBITER_ACTION</a> Command, PVOID Input1, PVOID Input2, PVOID Input3)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a80">IopQueryRebalance</a> (IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode, IN ULONG Phase, IN PULONG RebalanceCount, IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> **DeviceTable)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a81">IopQueryRebalanceWorker</a> (IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode, IN ULONG RebalancePhase, IN PULONG RebalanceCount, IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> **DeviceTable)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a82">IopTestForReconfiguration</a> (IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode, IN ULONG RebalancePhase, IN PULONG RebalanceCount, IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> **DeviceTable)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a83">IopPlacementForRebalance</a> (IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode, IN <a class="el" href="../../d6/d9/pnp_8h.html#a52">ARBITER_ACTION</a> ArbiterAction)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a84">IopArbitrateDeviceResources</a> (IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode, IN <a class="el" href="../../d6/d9/pnp_8h.html#a52">ARBITER_ACTION</a> ArbiterAction)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a85">IopRebalance</a> (IN ULONG AssignTableCont, IN <a class="el" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a> AssignTable)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a86">IopFindResourcesForArbiter</a> (IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode, IN UCHAR ResourceType, OUT ULONG *<a class="el" href="../../d6/d0/cmdat_8c.html#a5">Count</a>, OUT PCM_PARTIAL_RESOURCE_DESCRIPTOR *CmDesc)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a87">IopReleaseResourcesInternal</a> (IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a88">IopReleaseResources</a> (IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a89">IopRestoreResourcesInternal</a> (IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a90">IopSetLegacyDeviceInstance</a> (IN <a class="el" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> DriverObject, IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PCM_RESOURCE_LIST&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a91">IopCombineLegacyResources</a> (IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a92">IopPlacementForReservation</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a93">IopReserve</a> (IN <a class="el" href="../../d5/d1/pnpres_8c.html#a30">PREQ_LIST</a> ReqList)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a94">IopReserveBootResourcesInternal</a> (IN <a class="el" href="../../d6/d9/pnp_8h.html#a58">ARBITER_REQUEST_SOURCE</a> ArbiterRequestSource, IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, IN PCM_RESOURCE_LIST BootResources)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a95">IopNeedToReleaseBootResources</a> (IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode, IN PCM_RESOURCE_LIST AllocatedResources)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a96">IopReleaseFilteredBootResources</a> (IN <a class="el" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a> AssignTable, IN <a class="el" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a> AssignTableEnd)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a97">IopDumpResourceRequirementsList</a> (IN PIO_RESOURCE_REQUIREMENTS_LIST IoResources)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a98">IopDumpResourceDescriptor</a> (IN PUCHAR Indent, IN PIO_RESOURCE_DESCRIPTOR Desc)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a99">IopCheckDataStructures</a> (IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a100">IopCheckDataStructuresWorker</a> (IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> Device)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a101">IopQueryConflictListInternal</a> (<a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> PhysicalDeviceObject, IN PCM_RESOURCE_LIST ResourceList, IN ULONG ResourceListSize, OUT PPLUGPLAY_CONTROL_CONFLICT_LIST ConflictList, IN ULONG ConflictListSize, IN ULONG Flags)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a102">IopQueryConflictFillConflicts</a> (<a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> PhysicalDeviceObject, IN ULONG ConflictCount, IN <a class="el" href="../../d7/d7/struct__ARBITER__CONFLICT__INFO.html">PARBITER_CONFLICT_INFO</a> ConflictInfoList, OUT PPLUGPLAY_CONTROL_CONFLICT_LIST ConflictList, IN ULONG ConflictListSize, IN ULONG Flags)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a103">IopQueryConflictFillString</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, IN PWSTR <a class="el" href="../../d8/d6/ttri_8c.html#a3">Buffer</a>, IN OUT PULONG Length, IN OUT PULONG Flags)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a104">IopEliminateBogusConflict</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> PhysicalDeviceObject, IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> ConflictDeviceObject)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a105">IopAllocateResources</a> (IN PULONG DeviceCountP, IN OUT <a class="el" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a> *AssignTablePP, IN BOOLEAN Locked, IN BOOLEAN BootConfigsOK)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>int __cdecl&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a106">IopCompareAlternativeCount</a> (const void *arg1, const void *arg2)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a107">IopLegacyResourceAllocation</a> (IN <a class="el" href="../../d6/d9/pnp_8h.html#a58">ARBITER_REQUEST_SOURCE</a> AllocationType, IN <a class="el" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> DriverObject, IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject OPTIONAL, IN PIO_RESOURCE_REQUIREMENTS_LIST ResourceRequirements, IN OUT PCM_RESOURCE_LIST *AllocatedResources OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a108">IopFindBusDeviceNode</a> (IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode, IN INTERFACE_TYPE <a class="el" href="../../d6/d0/cmdat_8c.html#a4">InterfaceType</a>, IN ULONG <a class="el" href="../../d2/d7/hal_8h.html#a75">BusNumber</a>, IN ULONG SlotNumber)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a109">IopDuplicateDetection</a> (IN INTERFACE_TYPE LegacyBusType, IN ULONG <a class="el" href="../../d2/d7/hal_8h.html#a75">BusNumber</a>, IN ULONG SlotNumber, OUT <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> *DeviceNode)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a110">IopReserveLegacyBootResources</a> (IN INTERFACE_TYPE <a class="el" href="../../d6/d0/cmdat_8c.html#a4">InterfaceType</a>, IN ULONG <a class="el" href="../../d2/d7/hal_8h.html#a75">BusNumber</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a111">IopAllocateBootResources</a> (IN <a class="el" href="../../d6/d9/pnp_8h.html#a58">ARBITER_REQUEST_SOURCE</a> ArbiterRequestSource, IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, IN PCM_RESOURCE_LIST BootResources)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a112">IopReserveBootResources</a> (IN <a class="el" href="../../d6/d9/pnp_8h.html#a58">ARBITER_REQUEST_SOURCE</a> ArbiterRequestSource, IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, IN PCM_RESOURCE_LIST BootResources)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a113">IopReallocateResources</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a114">IopQueryConflictList</a> (<a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> PhysicalDeviceObject, IN PCM_RESOURCE_LIST ResourceList, IN ULONG ResourceListSize, OUT PPLUGPLAY_CONTROL_CONFLICT_LIST ConflictList, IN ULONG ConflictListSize, IN ULONG Flags)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>LIST_ENTRY&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a37">PiActiveArbiterList</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LIST_ENTRY&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a38">PiBestArbiterList</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a39">PiBestPriority</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a40">PiAssignTable</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a41">PiAssignTableCount</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a42">IopLegacyDeviceNode</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a43">PiNoRetest</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a44">PiUseTimeout</a> = TRUE</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>WCHAR&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a45">IopWstrTranslated</a> []</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>WCHAR&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a46">IopWstrRaw</a> []</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a47">PnpResDebugLevel</a> = 0</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a48">PnpResDebugTranslationFailureCount</a> = 32</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d3/d5/structPNPRESDEBUGTRANSLATIONFAILURE.html">PNPRESDEBUGTRANSLATIONFAILURE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a49">PnpResDebugTranslationFailureArray</a> [32]</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d3/d5/structPNPRESDEBUGTRANSLATIONFAILURE.html">PNPRESDEBUGTRANSLATIONFAILURE</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/pnpres_8c.html#a50">PnpResDebugTranslationFailure</a> = <a class="el" href="../../d5/d1/pnpres_8c.html#a49">PnpResDebugTranslationFailureArray</a></td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a27" doxytag="pnpres.c::DebugMessage" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define DebugMessage          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">Level,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>Message&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div><span class="keywordflow">if</span> (<a class="code" href="../../d5/d1/pnpres_8c.html#a47">PnpResDebugLevel</a> &amp; (Level)) {       \
        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> Message;                   \
    }
</div></pre>
<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00275">275</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.
<p>
Referenced by <a class="el" href="../../d8/d1/drivesup_8c-source.html#l03882">DrivesupDebugPrint()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l07141">IopAllocateBootResources()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00720">IopAllocateResources()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l05016">IopArbitrateDeviceResources()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l03084">IopAssign()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l03292">IopAssignInner()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l02034">IopBuildCmResourceList()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l02320">IopBuildCmResourceLists()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l06408">IopFindBusDeviceNode()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l05911">IopFindLegacyDeviceNode()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l05121">IopFindResourcesForArbiter()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l01066">IopGetResourceRequirementsForAssignTable()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l06180">IopLegacyResourceAllocation()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l03868">IopParentToRawTranslation()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l08022">IopQueryConflictFillConflicts()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l07717">IopQueryConflictList()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l04667">IopQueryRebalanceWorker()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l07470">IopReallocateResources()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l01811">IopRearrangeReqList()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l05215">IopRebalance()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l06083">IopRemoveLegacyDeviceNode()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l06996">IopReserveLegacyBootResources()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l01267">IopResourceRequirementsListToReqList()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l05660">IopRestoreResourcesInternal()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l03534">IopSetupArbiterAndTranslators()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l04767">IopTestForReconfiguration()</a>, and <a class="el" href="../../d6/d0/pnpres_8c-source.html#l04129">IopTranslateAndAdjustReqDesc()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a25" doxytag="pnpres.c::DUMP_DETAIL" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define DUMP_DETAIL&nbsp;&nbsp;&nbsp;0x0004          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00269">269</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l03084">IopAssign()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l03292">IopAssignInner()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l06408">IopFindBusDeviceNode()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l01066">IopGetResourceRequirementsForAssignTable()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l08022">IopQueryConflictFillConflicts()</a>, and <a class="el" href="../../d6/d0/pnpres_8c-source.html#l05215">IopRebalance()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a23" doxytag="pnpres.c::DUMP_ERROR" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define DUMP_ERROR&nbsp;&nbsp;&nbsp;0x0001          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00267">267</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l07141">IopAllocateBootResources()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00720">IopAllocateResources()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l05016">IopArbitrateDeviceResources()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l03084">IopAssign()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l02034">IopBuildCmResourceList()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l05911">IopFindLegacyDeviceNode()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l05121">IopFindResourcesForArbiter()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l06180">IopLegacyResourceAllocation()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l03868">IopParentToRawTranslation()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l07717">IopQueryConflictList()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l04667">IopQueryRebalanceWorker()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l07470">IopReallocateResources()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l01811">IopRearrangeReqList()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l05215">IopRebalance()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l06083">IopRemoveLegacyDeviceNode()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l01267">IopResourceRequirementsListToReqList()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l05660">IopRestoreResourcesInternal()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l03534">IopSetupArbiterAndTranslators()</a>, and <a class="el" href="../../d6/d0/pnpres_8c-source.html#l04129">IopTranslateAndAdjustReqDesc()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a24" doxytag="pnpres.c::DUMP_INFO" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define DUMP_INFO&nbsp;&nbsp;&nbsp;0x0002          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00268">268</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00720">IopAllocateResources()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l02320">IopBuildCmResourceLists()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l05911">IopFindLegacyDeviceNode()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l01066">IopGetResourceRequirementsForAssignTable()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l05215">IopRebalance()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l06996">IopReserveLegacyBootResources()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l01267">IopResourceRequirementsListToReqList()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l03534">IopSetupArbiterAndTranslators()</a>, and <a class="el" href="../../d6/d0/pnpres_8c-source.html#l04767">IopTestForReconfiguration()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="pnpres.c::ExAllocatePool1RD" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define ExAllocatePool1RD          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">a,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>b&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;ExAllocatePool(a,b)</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00068">68</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l04129">IopTranslateAndAdjustReqDesc()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="pnpres.c::ExAllocatePoolAE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define ExAllocatePoolAE          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">a,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>b&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;ExAllocatePool(a,b)</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00064">64</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l03534">IopSetupArbiterAndTranslators()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="pnpres.c::ExAllocatePoolAT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define ExAllocatePoolAT          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">a,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>b&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;ExAllocatePool(a,b)</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00060">60</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00720">IopAllocateResources()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="pnpres.c::ExAllocatePoolCMRL" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define ExAllocatePoolCMRL          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">a,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>b&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;ExAllocatePool(a,b)</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00062">62</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l02034">IopBuildCmResourceList()</a>, and <a class="el" href="../../d6/d0/pnpres_8c-source.html#l06726">IopCombineLegacyResources()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="pnpres.c::ExAllocatePoolCMRR" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define ExAllocatePoolCMRR          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">a,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>b&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;ExAllocatePool(a,b)</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00063">63</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l02034">IopBuildCmResourceList()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="pnpres.c::ExAllocatePoolIORD" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define ExAllocatePoolIORD          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">a,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>b&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;ExAllocatePool(a,b)</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00067">67</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l04129">IopTranslateAndAdjustReqDesc()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a12" doxytag="pnpres.c::ExAllocatePoolIORL" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define ExAllocatePoolIORL          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">a,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>b&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;ExAllocatePool(a,b)</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00071">71</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l06180">IopLegacyResourceAllocation()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l07291">IopReserveBootResources()</a>, and <a class="el" href="../../d6/d0/pnpres_8c-source.html#l07198">IopReserveBootResourcesInternal()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="pnpres.c::ExAllocatePoolIORR" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define ExAllocatePoolIORR          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">a,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>b&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;ExAllocatePool(a,b)</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00070">70</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l05215">IopRebalance()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a13" doxytag="pnpres.c::ExAllocatePoolIORRR" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define ExAllocatePoolIORRR          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">a,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>b&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;ExAllocatePool(a,b)</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00072">72</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l06955">IopCombineCmResourceList()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l06801">IopCreateCmResourceList()</a>, and <a class="el" href="../../d6/d0/pnpres_8c-source.html#l07291">IopReserveBootResources()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="pnpres.c::ExAllocatePoolPDO" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define ExAllocatePoolPDO          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">a,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>b&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;ExAllocatePool(a,b)</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00069">69</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l04589">IopQueryRebalance()</a>, and <a class="el" href="../../d6/d0/pnpres_8c-source.html#l05215">IopRebalance()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="pnpres.c::ExAllocatePoolPRD" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define ExAllocatePoolPRD          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">a,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>b&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;ExAllocatePool(a,b)</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00066">66</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l03933">IopChildToRootTranslation()</a>, and <a class="el" href="../../d6/d0/pnpres_8c-source.html#l05121">IopFindResourcesForArbiter()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="pnpres.c::ExAllocatePoolRD" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define ExAllocatePoolRD          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">a,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>b&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;ExAllocatePool(a,b)</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00061">61</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l01267">IopResourceRequirementsListToReqList()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="pnpres.c::ExAllocatePoolTE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define ExAllocatePoolTE          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">a,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>b&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;ExAllocatePool(a,b)</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00065">65</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l03534">IopSetupArbiterAndTranslators()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a22" doxytag="pnpres.c::FIND_BEST_ASSIGNMENT_TIMEOUT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define FIND_BEST_ASSIGNMENT_TIMEOUT&nbsp;&nbsp;&nbsp;5000          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00252">252</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l03084">IopAssign()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a21" doxytag="pnpres.c::IopAllocPool" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define IopAllocPool          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">Memory,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>Pool,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d9/d7/w98_2lh__open_2pi__mem_8h.html#a0">Size</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>*(Memory) = (PVOID) (Pool)-&gt;PoolStart;                             \
    (Pool)-&gt;PoolStart += (<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>);                                       \
    <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((Pool)-&gt;PoolStart &lt;= (Pool)-&gt;PoolEnd);
</div></pre>
<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00225">225</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l01267">IopResourceRequirementsListToReqList()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a20" doxytag="pnpres.c::IopAllocPoolAligned" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define IopAllocPoolAligned          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">Memory,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>Pool,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d9/d7/w98_2lh__open_2pi__mem_8h.html#a0">Size</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>(Pool)-&gt;PoolStart = (PUCHAR)                                       \
        (((ULONG_PTR) (Pool)-&gt;PoolStart + <a class="code" href="../../d5/d1/pnpres_8c.html#a18">STRUCTURE_ALIGNMENT</a> - 1)     \
        &amp; ~(<a class="code" href="../../d5/d1/pnpres_8c.html#a18">STRUCTURE_ALIGNMENT</a> - 1));                                 \
    <a class="code" href="../../d5/d1/pnpres_8c.html#a21">IopAllocPool</a>(Memory, Pool, Size);
</div></pre>
<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00215">215</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l01267">IopResourceRequirementsListToReqList()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a19" doxytag="pnpres.c::IopInitPool" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define IopInitPool          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">Pool,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d5/d2/config_2ia64_2initia64_8c.html#a14">Start</a>,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d9/d7/w98_2lh__open_2pi__mem_8h.html#a0">Size</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>{                                                                      \
    (Pool)-&gt;PoolStart = (<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>);                                       \
    (Pool)-&gt;PoolEnd = (<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>) + (<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>);                                \
    (Pool)-&gt;PoolSize = (<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>);                                         \
    RtlZeroMemory(Start, Size);                                        \
}
</div></pre>
<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00203">203</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l01267">IopResourceRequirementsListToReqList()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a15" doxytag="pnpres.c::IopReleaseBootResources" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define IopReleaseBootResources          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">DeviceNode&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div><a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(((DeviceNode)-&gt;Flags &amp; DNF_MADEUP) == 0);                 \
    <a class="code" href="../../d5/d1/pnpres_8c.html#a87">IopReleaseResourcesInternal</a>(DeviceNode);                         \
    (DeviceNode)-&gt;Flags &amp;= ~<a class="code" href="../../d9/d0/pnpiop_8h.html#a12">DNF_HAS_BOOT_CONFIG</a>;                     \
    (DeviceNode)-&gt;Flags &amp;= ~<a class="code" href="../../d9/d0/pnpiop_8h.html#a13">DNF_BOOT_CONFIG_RESERVED</a>;                \
    <span class="keywordflow">if</span> ((DeviceNode)-&gt;BootResources) {                               \
        <a class="code" href="../../d6/d3/cmwraper_8c.html#a26">ExFreePool</a>((DeviceNode)-&gt;BootResources);                     \
        (DeviceNode)-&gt;BootResources = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;                          \
    }
</div></pre>
<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00157">157</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l04767">IopTestForReconfiguration()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a14" doxytag="pnpres.c::IS_TRANSLATED_REQ_DESC" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define IS_TRANSLATED_REQ_DESC          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">r&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;((r)-&gt;ReqAlternative ? FALSE : TRUE)</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00151">151</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l01922">IopFreeReqAlternative()</a>, and <a class="el" href="../../d6/d0/pnpres_8c-source.html#l03868">IopParentToRawTranslation()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="pnpres.c::MYDBG" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define MYDBG&nbsp;&nbsp;&nbsp;0          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00038">38</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a16" doxytag="pnpres.c::NextDeviceNode" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define NextDeviceNode&nbsp;&nbsp;&nbsp;Sibling          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00180">180</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a17" doxytag="pnpres.c::PreviousDeviceNode" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PreviousDeviceNode&nbsp;&nbsp;&nbsp;Child          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00181">181</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a26" doxytag="pnpres.c::STOP_ERROR" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define STOP_ERROR&nbsp;&nbsp;&nbsp;0x1000          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00270">270</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l03292">IopAssignInner()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l03933">IopChildToRootTranslation()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l08336">IopQueryConflictListInternal()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l05215">IopRebalance()</a>, and <a class="el" href="../../d6/d0/pnpres_8c-source.html#l03376">IopReserve()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a18" doxytag="pnpres.c::STRUCTURE_ALIGNMENT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define STRUCTURE_ALIGNMENT&nbsp;&nbsp;&nbsp;1          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00187">187</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l01267">IopResourceRequirementsListToReqList()</a>.    </td>
  </tr>
</table>
<hr><h2>Typedef Documentation</h2>
<a class="anchor" name="a31" doxytag="pnpres.c::COUNTER" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d0/d9/struct__Counter.html">_Counter</a>  <a class="el" href="../../d0/d9/struct__Counter.html">COUNTER</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a33" doxytag="pnpres.c::DUPLICATE_DETECTION_CONTEXT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d2/d1/struct__DUPLICATE__DETECTION__CONTEXT.html">_DUPLICATE_DETECTION_CONTEXT</a>  <a class="el" href="../../d2/d1/struct__DUPLICATE__DETECTION__CONTEXT.html">DUPLICATE_DETECTION_CONTEXT</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a35" doxytag="pnpres.c::IOP_POOL" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d2/d1/struct__IOP__POOL.html">_IOP_POOL</a>  <a class="el" href="../../d2/d1/struct__IOP__POOL.html">IOP_POOL</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a32" doxytag="pnpres.c::PCOUNTER" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d0/d9/struct__Counter.html">_Counter</a> * <a class="el" href="../../d0/d9/struct__Counter.html">PCOUNTER</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a34" doxytag="pnpres.c::PDUPLICATE_DETECTION_CONTEXT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d2/d1/struct__DUPLICATE__DETECTION__CONTEXT.html">_DUPLICATE_DETECTION_CONTEXT</a> * <a class="el" href="../../d2/d1/struct__DUPLICATE__DETECTION__CONTEXT.html">PDUPLICATE_DETECTION_CONTEXT</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a36" doxytag="pnpres.c::PIOP_POOL" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d2/d1/struct__IOP__POOL.html">_IOP_POOL</a> * <a class="el" href="../../d2/d1/struct__IOP__POOL.html">PIOP_POOL</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a29" doxytag="pnpres.c::PREQ_ALTERNATIVE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d9/d3/struct__REQ__ALTERNATIVE.html">_REQ_ALTERNATIVE</a> REQ_ALTERNATIVE* <a class="el" href="../../d5/d1/pnpres_8c.html#a29">PREQ_ALTERNATIVE</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00081">81</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l03084">IopAssign()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l02034">IopBuildCmResourceList()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l01723">IopComparePriority()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l05121">IopFindResourcesForArbiter()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l02845">IopIsBestConfiguration()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l08336">IopQueryConflictListInternal()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l01811">IopRearrangeReqList()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l03376">IopReserve()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l01267">IopResourceRequirementsListToReqList()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l02997">IopRestoreBestConfiguration()</a>, and <a class="el" href="../../d6/d0/pnpres_8c-source.html#l02906">IopSaveCurrentConfiguration()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a28" doxytag="pnpres.c::PREQ_DESC" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d0/d4/struct__REQ__DESC.html">_REQ_DESC</a> REQ_DESC* <a class="el" href="../../d5/d1/pnpres_8c.html#a28">PREQ_DESC</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00079">79</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l02716">IopAddReqDescsToArbiters()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l02034">IopBuildCmResourceList()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l04339">IopCallArbiter()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l05121">IopFindResourcesForArbiter()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l01922">IopFreeReqAlternative()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l03868">IopParentToRawTranslation()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l08336">IopQueryConflictListInternal()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l02780">IopRemoveReqDescsFromArbiters()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l01267">IopResourceRequirementsListToReqList()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l02997">IopRestoreBestConfiguration()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l02906">IopSaveCurrentConfiguration()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l03534">IopSetupArbiterAndTranslators()</a>, and <a class="el" href="../../d6/d0/pnpres_8c-source.html#l04129">IopTranslateAndAdjustReqDesc()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a30" doxytag="pnpres.c::PREQ_LIST" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d2/d4/struct__REQ__LIST.html">_REQ_LIST</a> REQ_LIST* <a class="el" href="../../d5/d1/pnpres_8c.html#a30">PREQ_LIST</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00083">83</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l03084">IopAssign()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l02034">IopBuildCmResourceList()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l05121">IopFindResourcesForArbiter()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l01066">IopGetResourceRequirementsForAssignTable()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l02845">IopIsBestConfiguration()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l08336">IopQueryConflictListInternal()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l07198">IopReserveBootResourcesInternal()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l01267">IopResourceRequirementsListToReqList()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l02997">IopRestoreBestConfiguration()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l05660">IopRestoreResourcesInternal()</a>, and <a class="el" href="../../d6/d0/pnpres_8c-source.html#l02906">IopSaveCurrentConfiguration()</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a69" doxytag="pnpres.c::IopAddReqDescsToArbiters" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopAddReqDescsToArbiters           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ReqDescCount</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d5/d1/pnpres_8c.html#a28">PREQ_DESC</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>ReqDescTable</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l02716">2716</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.
<p>
References <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00713">_PI_RESOURCE_ARBITER_ENTRY::ActiveArbiterList</a>, <a class="el" href="../../d6/d9/pnp_8h.html#a173a118">ArbiterActionRollbackAllocation</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l04339">IopCallArbiter()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00722">PI_ARBITER_HAS_SOMETHING</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00234">PiActiveArbiterList</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00079">PREQ_DESC</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00710">_PI_RESOURCE_ARBITER_ENTRY::ResourceList</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00715">_PI_RESOURCE_ARBITER_ENTRY::ResourcesChanged</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00714">_PI_RESOURCE_ARBITER_ENTRY::State</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00103">_REQ_DESC::TranslatedReqDesc</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l03084">IopAssign()</a>, and <a class="el" href="../../d6/d0/pnpres_8c-source.html#l03376">IopReserve()</a>.
<p>
<pre class="fragment"><div>02723                    :
02724 
02725     This routine adds a list of a req descriptors to their arbiters.
02726 
02727 Parameters:
02728 
02729     P1 -
02730 
02731 Return Value:
02732 
02733     None.
02734 
02735 --*/
02736 {
02737     <a class="code" href="../../d5/d1/pnpres_8c.html#a28">PREQ_DESC</a>                   reqDesc;
02738     <a class="code" href="../../d5/d1/pnpres_8c.html#a28">PREQ_DESC</a>                   reqDescTranslated;
02739     PLIST_ENTRY                 listHead;
02740     <a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html">PPI_RESOURCE_ARBITER_ENTRY</a>  arbiterEntry;
02741     <a class="code" href="../../d5/d1/pnpres_8c.html#a28">PREQ_DESC</a>                   *reqDescTableEnd;
02742 
02743     <span class="keywordflow">for</span> (reqDescTableEnd = ReqDescTable + ReqDescCount; ReqDescTable &lt; reqDescTableEnd; ReqDescTable++) {
02744 
02745         <span class="comment">//</span>
02746         <span class="comment">// For each req desc, find its arbiter, link the translated req desc to its arbiter.</span>
02747         <span class="comment">//</span>
02748 
02749         reqDesc = *ReqDescTable;
02750         <span class="keywordflow">if</span> (reqDesc-&gt;ArbitrationRequired) {
02751 
02752             reqDescTranslated = reqDesc-&gt;<a class="code" href="../../d0/d4/struct__REQ__DESC.html#o8">TranslatedReqDesc</a>;  <span class="comment">// Could be reqDesc itself</span>
02753 
02754             InitializeListHead(&amp;reqDescTranslated-&gt;AlternativeTable.ListEntry);
02755             arbiterEntry = reqDesc-&gt;u.Arbiter;
02756             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(arbiterEntry);
02757             listHead = &amp;arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o3">ResourceList</a>;
02758             InsertTailList(listHead, &amp;reqDescTranslated-&gt;AlternativeTable.ListEntry);
02759 
02760             arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o8">ResourcesChanged</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02761             <span class="keywordflow">if</span> (arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o7">State</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a58">PI_ARBITER_HAS_SOMETHING</a>) {
02762 
02763                 <a class="code" href="../../d5/d1/pnpres_8c.html#a79">IopCallArbiter</a>(arbiterEntry, ArbiterActionRollbackAllocation, NULL, NULL, NULL);
02764                 arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o7">State</a> &amp;= ~<a class="code" href="../../d9/d0/pnpiop_8h.html#a58">PI_ARBITER_HAS_SOMETHING</a>;
02765             }
02766 
02767             <span class="comment">//</span>
02768             <span class="comment">// Link the arbiter entry to our active arbiter list if it has not been</span>
02769             <span class="comment">//</span>
02770 
02771             <span class="keywordflow">if</span> (IsListEmpty(&amp;arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o6">ActiveArbiterList</a>)) {
02772 
02773                 InsertTailList(&amp;PiActiveArbiterList, &amp;arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o6">ActiveArbiterList</a>);
02774             }
02775         }
02776     }
02777 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a111" doxytag="pnpres.c::IopAllocateBootResources" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopAllocateBootResources           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d6/d9/pnp_8h.html#a58">ARBITER_REQUEST_SOURCE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ArbiterRequestSource</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PCM_RESOURCE_LIST&nbsp;</td>
          <td class="mdname" nowrap> <em>BootResources</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l07141">7141</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.
<p>
References <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00275">DebugMessage</a>, <a class="el" href="../../d4/d9/ke_8h.html#a407a202">DelayExecution</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00267">DUMP_ERROR</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00337">IopRegistrySemaphore</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l07198">IopReserveBootResourcesInternal()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01598">KeEnterCriticalRegion</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01628">KeLeaveCriticalRegion</a>, <a class="el" href="../../d2/d5/semphobj_8c-source.html#l00118">KeReleaseSemaphore()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/ioinit_8c-source.html#l02327">IopInitializeBootDrivers()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l07291">IopReserveBootResources()</a>, and <a class="el" href="../../d6/d0/pnpres_8c-source.html#l06996">IopReserveLegacyBootResources()</a>.
<p>
<pre class="fragment"><div>07149                    :
07150 
07151     This routine reports boot resources <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified device to
07152     arbiters.
07153 
07154 Arguments:
07155 
07156     DeviceObject - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device object, could be <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
07157         <span class="keywordflow">if</span> DeviceObject <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> BootResources are reserved and will not be given
07158             to a device unless there <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> no other choice. The caller must release <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
07159             <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> <span class="keywordflow">for</span> BootResources.
07160         <span class="keywordflow">if</span> DeviceObject <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> NON_NULL, BootResources are BOOT reserved (preallocated.)
07161 
07162     BootResources - Supplies a pointer to the Boot resources.
07163 
07164 Return Value:
07165 
07166     None.
07167 
07168 --*/
07169 {
07170     NTSTATUS    status;
07171 
07172     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
07173 
07174     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>( );
07175 
07176     status = <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;IopRegistrySemaphore,
07177                                     DelayExecution,
07178                                     KernelMode,
07179                                     FALSE,
07180                                     NULL );
07181 
07182     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
07183 
07184         status = <a class="code" href="../../d5/d1/pnpres_8c.html#a94">IopReserveBootResourcesInternal</a>(ArbiterRequestSource, DeviceObject, BootResources);
07185         <a class="code" href="../../d1/d6/semphobj_8c.html#a3">KeReleaseSemaphore</a>(&amp;IopRegistrySemaphore, 0, 1, FALSE);
07186 
07187     } <span class="keywordflow">else</span> {
07188 
07189         <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(DUMP_ERROR, (<span class="stringliteral">"IopReserveBootResources: Get RegustrySemaphore failed. Status %x\n"</span>, status));
07190     }
07191 
07192     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
07193 
07194     <span class="keywordflow">return</span> status;
07195 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a105" doxytag="pnpres.c::IopAllocateResources" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopAllocateResources           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceCountP</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT <a class="el" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>AssignTablePP</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>Locked</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>BootConfigsOK</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00720">720</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.
<p>
References <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00767">_IOP_RESOURCE_REQUEST::AllocationType</a>, <a class="el" href="../../d6/d9/pnp_8h.html#a174a129">ArbiterRequestPnpDetected</a>, <a class="el" href="../../d6/d9/pnp_8h.html#a174a130">ArbiterRequestPnpEnumerated</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00275">DebugMessage</a>, <a class="el" href="../../d4/d9/ke_8h.html#a407a202">DelayExecution</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01274">_DEVOBJ_EXTENSION::DeviceNode</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01210">_DEVICE_OBJECT::DeviceObjectExtension</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00415">DNF_HAS_BOOT_CONFIG</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00576">DNF_NEEDS_REBALANCE</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00267">DUMP_ERROR</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00268">DUMP_INFO</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00060">ExAllocatePoolAT</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00129">_DEVICE_NODE::Flags</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00766">_IOP_RESOURCE_REQUEST::Flags</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00177">_DEVICE_NODE::InstancePath</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00755">IOP_ASSIGN_EXCLUDE</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00756">IOP_ASSIGN_IGNORE</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00757">IOP_ASSIGN_NO_REBALANCE</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00754">IOP_ASSIGN_RETRY</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l03292">IopAssignInner()</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00134">IopBootConfigsReserved</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l02320">IopBuildCmResourceLists()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l01988">IopFreeResourceRequirementsForAssignTable()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l01066">IopGetResourceRequirementsForAssignTable()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l01878">IopRearrangeAssignTable()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l05215">IopRebalance()</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00337">IopRegistrySemaphore</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l02474">IopReleaseFilteredBootResources()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01598">KeEnterCriticalRegion</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01628">KeLeaveCriticalRegion</a>, <a class="el" href="../../d2/d5/semphobj_8c-source.html#l00118">KeReleaseSemaphore()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00765">_IOP_RESOURCE_REQUEST::PhysicalDevice</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00771">_IOP_RESOURCE_REQUEST::ResourceAssignment</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00769">_IOP_RESOURCE_REQUEST::ResourceRequirements</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00773">_IOP_RESOURCE_REQUEST::Status</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l01824">IopAssignResourcesToDevices()</a>, and <a class="el" href="../../d6/d0/pnpres_8c-source.html#l06180">IopLegacyResourceAllocation()</a>.
<p>
<pre class="fragment"><div>00729                    :
00730 
00731     For each AssignTable entry, <span class="keyword">this</span> routine queries device's IO resource requirements
00732     list and converts <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> to our internal REQ_LIST <a class="code" href="../../d8/d0/rtbatcr_8c.html#a8">format</a>; calls worker routine to perform
00733     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resources assignment.
00734 
00735 Parameters:
00736 
00737     AssignTable - supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first entry of a <a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">IOP_RESOURCE_REQUEST</a> table.
00738 
00739     AssignTableEnd - supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> end of <a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">IOP_RESOURCE_REQUEST</a> table.
00740 
00741     Locked - Indicates whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/iodata_8c.html#a60">IopRegistrySemaphore</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> acquired by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller.
00742 
00743     BootConfigsOK - Indicates whether we should assign BOOT configs.
00744 
00745 Return Value:
00746 
00747     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> code that indicates whether or not <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function was successful.
00748 
00749 --*/
00750 
00751 {
00752     <a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a>   AssignTable;
00753     <a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a>   AssignTableEnd;
00754     <a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a>   AssignTableTail;
00755     <a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a>   AssignEntry;
00756     <a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a>   AssignEntryOriginal;
00757     ULONG                   AssignTableCount;
00758     ULONG                   DeviceCount;
00759     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>                <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00760     BOOLEAN                 FreeAssignTable;
00761     BOOLEAN                 tryRebalance;
00762 
00763     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00764 
00765     DeviceCount = *DeviceCountP;
00766     FreeAssignTable = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00767     tryRebalance = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00768     AssignTable = *AssignTablePP;
00769     AssignTableEnd = AssignTable + DeviceCount;
00770 
00771     <span class="comment">//</span>
00772     <span class="comment">// If legacy device resource allocation, don't rebalance on failure,</span>
00773     <span class="comment">// if the resource they want is already assigned, what they are looking</span>
00774     <span class="comment">// for isn't there.</span>
00775     <span class="comment">//</span>
00776 
00777     <span class="keywordflow">if</span> ((DeviceCount == 1) &amp;&amp; (AssignTable-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o1">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a70">IOP_ASSIGN_NO_REBALANCE</a>)) {
00778 
00779         tryRebalance = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00780 
00781     }
00782 
00783     <span class="comment">//</span>
00784     <span class="comment">// Grab the IO registry semaphore to make sure no other device is</span>
00785     <span class="comment">// reporting it's resource usage while we are searching for conflicts.</span>
00786     <span class="comment">//</span>
00787 
00788     <span class="keywordflow">if</span> (!Locked) {
00789 
00790         <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
00791 
00792         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;IopRegistrySemaphore,
00793                                         DelayExecution,
00794                                         KernelMode,
00795                                         FALSE,
00796                                         NULL );
00797 
00798         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00799 
00800             <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(DUMP_ERROR, (<span class="stringliteral">"IopAllocateResources: Get RegistrySemaphore failed. Status %x\n"</span>, Status));
00801             <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
00802             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00803 
00804         }
00805     }
00806 
00807     <span class="comment">//</span>
00808     <span class="comment">// Get the resource requirements.</span>
00809     <span class="comment">//</span>
00810 
00811     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d1/pnpres_8c.html#a56">IopGetResourceRequirementsForAssignTable</a>(AssignTable, AssignTableEnd, &amp;DeviceCount);
00812     <span class="keywordflow">if</span> (DeviceCount == 0) {
00813 
00814         <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(DUMP_INFO, (<span class="stringliteral">"IopAllocateResources: Get Requirements for Assign Table found nothing. status %x\n"</span>, Status));
00815 
00816         <span class="keywordflow">if</span> (!Locked) {
00817 
00818             <a class="code" href="../../d1/d6/semphobj_8c.html#a3">KeReleaseSemaphore</a>(&amp;IopRegistrySemaphore, 0, 1, FALSE);
00819             <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
00820 
00821         }
00822 
00823         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00824 
00825     }
00826 
00827     <span class="comment">//</span>
00828     <span class="comment">// Check if it is OK to assign resources to devices with BOOT configs.</span>
00829     <span class="comment">//</span>
00830 
00831     <span class="keywordflow">if</span> (BootConfigsOK) {
00832 
00833         <span class="keywordflow">if</span> (!<a class="code" href="../../d1/d0/pnpdata_8c.html#a18">IopBootConfigsReserved</a>) {
00834 
00835             <span class="comment">//</span>
00836             <span class="comment">// Process devices with BOOT configs or no requirements first.</span>
00837             <span class="comment">//</span>
00838 
00839             <span class="keywordflow">for</span> (AssignEntry = AssignTable; AssignEntry &lt; AssignTableEnd; AssignEntry++) {
00840 
00841                 <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>    deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o0">PhysicalDevice</a>-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o6">DeviceNode</a>;
00842 
00843                 <span class="keywordflow">if</span> (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a12">DNF_HAS_BOOT_CONFIG</a>) {
00844 
00845                     <span class="keywordflow">break</span>;
00846                 }
00847             }
00848 
00849             <span class="keywordflow">if</span> (AssignEntry != AssignTableEnd) {
00850 
00851                 <span class="comment">//</span>
00852                 <span class="comment">// There are devices with BOOT config.</span>
00853                 <span class="comment">//</span>
00854 
00855                 <span class="keywordflow">for</span> (AssignEntry = AssignTable; AssignEntry &lt; AssignTableEnd; AssignEntry++) {
00856 
00857                     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>    deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o0">PhysicalDevice</a>-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o6">DeviceNode</a>;
00858 
00859                     <span class="keywordflow">if</span> (    !(AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o1">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a69">IOP_ASSIGN_IGNORE</a>) &amp;&amp;
00860                             !(deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a12">DNF_HAS_BOOT_CONFIG</a>) &amp;&amp;
00861                             AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o4">ResourceRequirements</a> &amp;&amp;
00862                             AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o2">AllocationType</a> != <a class="code" href="../../d6/d9/pnp_8h.html#a174a129">ArbiterRequestPnpDetected</a>) {
00863 
00864                         DeviceCount--;
00865                         <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(DUMP_INFO, (<span class="stringliteral">"Delaying non BOOT config device %ws...\n"</span>, deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o13">InstancePath</a>.Buffer));
00866                         AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o8">Status</a> = STATUS_RETRY;
00867                         AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o1">Flags</a> |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a69">IOP_ASSIGN_IGNORE</a>;
00868                         <a class="code" href="../../d5/d1/pnpres_8c.html#a61">IopFreeResourceRequirementsForAssignTable</a>(AssignEntry, AssignEntry + 1);
00869 
00870                     }
00871                 }
00872             }
00873 
00874             <span class="keywordflow">if</span> (DeviceCount == 0) {
00875 
00876                 <span class="keywordflow">if</span> (!Locked) {
00877 
00878                     <a class="code" href="../../d1/d6/semphobj_8c.html#a3">KeReleaseSemaphore</a>(&amp;IopRegistrySemaphore, 0, 1, FALSE);
00879                     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
00880 
00881                 }
00882 
00883                 <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00884             }
00885         }
00886 
00887         <span class="comment">//</span>
00888         <span class="comment">// Check if we need to allocate a new table.</span>
00889         <span class="comment">//</span>
00890 
00891         <span class="keywordflow">if</span> (DeviceCount != *DeviceCountP) {
00892 
00893             <span class="comment">//</span>
00894             <span class="comment">// Allocate a new table.</span>
00895             <span class="comment">//</span>
00896 
00897             AssignTable = (<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a>) <a class="code" href="../../d5/d1/pnpres_8c.html#a1">ExAllocatePoolAT</a>( PagedPool,
00898                                                                     <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">IOP_RESOURCE_REQUEST</a>) * DeviceCount);
00899             <span class="keywordflow">if</span> (AssignTable == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00900 
00901                 <a class="code" href="../../d5/d1/pnpres_8c.html#a61">IopFreeResourceRequirementsForAssignTable</a>(*AssignTablePP, AssignTableEnd);
00902 
00903                 <span class="keywordflow">if</span> (!Locked) {
00904 
00905                     <a class="code" href="../../d1/d6/semphobj_8c.html#a3">KeReleaseSemaphore</a>(&amp;IopRegistrySemaphore, 0, 1, FALSE);
00906                     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
00907 
00908                 }
00909 
00910                 <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00911             }
00912 
00913             FreeAssignTable = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00914 
00915             <span class="comment">//</span>
00916             <span class="comment">// Process the AssignTable to remove any entry which is marked as IOP_ASSIGN_IGNORE.</span>
00917             <span class="comment">//</span>
00918 
00919             AssignEntryOriginal = *AssignTablePP;
00920             AssignTableEnd = AssignTable + DeviceCount;
00921             <span class="keywordflow">for</span> (AssignEntry = AssignTable; AssignEntry &lt; AssignTableEnd;) {
00922 
00923                 <span class="keywordflow">if</span> (!(AssignEntryOriginal-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o1">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a69">IOP_ASSIGN_IGNORE</a>)) {
00924 
00925                     *AssignEntry = *AssignEntryOriginal;
00926                     AssignEntry++;
00927 
00928                 }
00929                 AssignEntryOriginal++;
00930             }
00931         }
00932 
00933     } <span class="keywordflow">else</span> {
00934 
00935         <span class="comment">//</span>
00936         <span class="comment">// Only process devices with no resource requirements. Rest get STATUS_RETRY.</span>
00937         <span class="comment">//</span>
00938 
00939         <span class="keywordflow">for</span> (AssignEntry = AssignTable; AssignEntry &lt; AssignTableEnd; AssignEntry++) {
00940 
00941             <span class="keywordflow">if</span> (    !(AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o1">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a69">IOP_ASSIGN_IGNORE</a>) &amp;&amp;
00942                     AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o4">ResourceRequirements</a>) {
00943 
00944                 <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>    deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o0">PhysicalDevice</a>-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o6">DeviceNode</a>;
00945 
00946                 <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(DUMP_INFO, (<span class="stringliteral">"Delaying resources requiring device %ws...\n"</span>, deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o13">InstancePath</a>.Buffer));
00947                 <a class="code" href="../../d5/d1/pnpres_8c.html#a61">IopFreeResourceRequirementsForAssignTable</a>(AssignEntry, AssignEntry + 1);
00948                 AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o8">Status</a> = STATUS_RETRY;
00949 
00950             }
00951         }
00952 
00953         <span class="comment">//</span>
00954         <span class="comment">// Release the I/O Registry Semaphore</span>
00955         <span class="comment">//</span>
00956 
00957         <span class="keywordflow">if</span> (!Locked) {
00958 
00959             <a class="code" href="../../d1/d6/semphobj_8c.html#a3">KeReleaseSemaphore</a>(&amp;IopRegistrySemaphore, 0, 1, FALSE);
00960             <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
00961 
00962         }
00963 
00964         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00965     }
00966     AssignTableCount = (ULONG)(AssignTableEnd - AssignTable);
00967     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(AssignTableCount == DeviceCount);
00968 
00969     <span class="comment">//</span>
00970     <span class="comment">// Sort the AssignTable</span>
00971     <span class="comment">//</span>
00972 
00973     <a class="code" href="../../d5/d1/pnpres_8c.html#a59">IopRearrangeAssignTable</a>(AssignTable, DeviceCount);
00974 
00975     <span class="keywordflow">for</span> (AssignEntry = AssignTable; AssignEntry &lt; AssignTableEnd; AssignEntry++) {
00976 
00977         <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>    deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o0">PhysicalDevice</a>-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o6">DeviceNode</a>;
00978 
00979         <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(DUMP_INFO, (<span class="stringliteral">"Pnpres: Trying to allocate resources for %ws.\n"</span>, deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o13">InstancePath</a>.Buffer));
00980 
00981         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d1/pnpres_8c.html#a67">IopAssignInner</a>(1, AssignEntry, FALSE);
00982         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00983 
00984             <a class="code" href="../../d5/d1/pnpres_8c.html#a65">IopBuildCmResourceLists</a>(AssignEntry, AssignEntry + 1);
00985             <span class="keywordflow">if</span> (AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o2">AllocationType</a> == <a class="code" href="../../d6/d9/pnp_8h.html#a174a130">ArbiterRequestPnpEnumerated</a>) {
00986 
00987                 <a class="code" href="../../d5/d1/pnpres_8c.html#a96">IopReleaseFilteredBootResources</a>(AssignEntry, AssignEntry + 1);
00988             }
00989         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_INSUFFICIENT_RESOURCES) {
00990 
00991             <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(DUMP_ERROR, (<span class="stringliteral">"IopAllocateResource: Failed to allocate Pool.\n"</span>));
00992             <span class="keywordflow">break</span>;
00993 
00994         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (tryRebalance) {
00995 
00996             <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(DUMP_INFO, (<span class="stringliteral">"IopAllocateResources: Initiating REBALANCE...\n"</span>));
00997 
00998             deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a35">DNF_NEEDS_REBALANCE</a>;
00999             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d1/pnpres_8c.html#a85">IopRebalance</a>(1, AssignEntry);
01000             deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp;= ~<a class="code" href="../../d9/d0/pnpiop_8h.html#a35">DNF_NEEDS_REBALANCE</a>;
01001             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01002                 AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o8">Status</a> = STATUS_CONFLICTING_ADDRESSES;
01003             }
01004         } <span class="keywordflow">else</span> {
01005             AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o8">Status</a> = STATUS_CONFLICTING_ADDRESSES;
01006         }
01007     }
01008 
01009     <span class="comment">//</span>
01010     <span class="comment">// IF we did not go through the entire table without any error,</span>
01011     <span class="comment">// mark remaining entries as RETRY.</span>
01012     <span class="comment">//</span>
01013 
01014     <span class="keywordflow">for</span> (; AssignEntry &lt; AssignTableEnd; AssignEntry++) {
01015 
01016         AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o8">Status</a> = STATUS_RETRY;
01017     }
01018 
01019     <a class="code" href="../../d5/d1/pnpres_8c.html#a61">IopFreeResourceRequirementsForAssignTable</a>(AssignTable, AssignTableEnd);
01020 
01021     <span class="comment">//</span>
01022     <span class="comment">// Release the I/O Registry Semaphore</span>
01023     <span class="comment">//</span>
01024 
01025     <span class="keywordflow">if</span> (!Locked) {
01026         <a class="code" href="../../d1/d6/semphobj_8c.html#a3">KeReleaseSemaphore</a>( &amp;IopRegistrySemaphore, 0, 1, FALSE );
01027         <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>( );
01028     }
01029 
01030     <span class="comment">//</span>
01031     <span class="comment">// Copy the information in our own AssignTable to caller's AssignTable</span>
01032     <span class="comment">//</span>
01033 
01034     <span class="keywordflow">if</span> (FreeAssignTable) {
01035         AssignEntryOriginal = *AssignTablePP;
01036         <span class="keywordflow">for</span> (AssignEntry = AssignTable; AssignEntry &lt; AssignTableEnd;) {
01037             <span class="keywordflow">if</span> (AssignEntryOriginal-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o1">Flags</a> &amp; (<a class="code" href="../../d9/d0/pnpiop_8h.html#a69">IOP_ASSIGN_IGNORE</a> | <a class="code" href="../../d9/d0/pnpiop_8h.html#a67">IOP_ASSIGN_RETRY</a>)) {
01038                 AssignEntryOriginal++;
01039                 <span class="keywordflow">continue</span>;
01040             }
01041             *AssignEntryOriginal = *AssignEntry;
01042             AssignEntry++;
01043             AssignEntryOriginal++;
01044         }
01045         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(AssignEntryOriginal &lt;= *AssignTablePP + *DeviceCountP);
01046         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(AssignTable);
01047     }
01048 
01049     AssignEntry = *AssignTablePP;
01050     <span class="keywordflow">while</span> (AssignEntry &lt; *AssignTablePP + *DeviceCountP) {
01051         <span class="keywordflow">if</span> (AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o1">Flags</a> &amp; (<a class="code" href="../../d9/d0/pnpiop_8h.html#a69">IOP_ASSIGN_IGNORE</a> | <a class="code" href="../../d9/d0/pnpiop_8h.html#a67">IOP_ASSIGN_RETRY</a>)) {
01052             AssignEntry++;
01053             <span class="keywordflow">continue</span>;
01054         }
01055         <span class="keywordflow">if</span> ((AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o1">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a68">IOP_ASSIGN_EXCLUDE</a>) || AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o6">ResourceAssignment</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01056 
01057             AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o8">Status</a> = STATUS_CONFLICTING_ADDRESSES;
01058         }
01059         AssignEntry++;
01060     }
01061 
01062     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01063 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a84" doxytag="pnpres.c::IopArbitrateDeviceResources" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopArbitrateDeviceResources           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceNode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d6/d9/pnp_8h.html#a52">ARBITER_ACTION</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ArbiterAction</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l05016">5016</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.
<p>
References <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00713">_PI_RESOURCE_ARBITER_ENTRY::ActiveArbiterList</a>, <a class="el" href="../../d6/d9/pnp_8h.html#a173a117">ArbiterActionCommitAllocation</a>, <a class="el" href="../../d6/d9/pnp_8h.html#a173a116">ArbiterActionRetestAllocation</a>, <a class="el" href="../../d6/d9/pnp_8h.html#a173a115">ArbiterActionTestAllocation</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00712">_PI_RESOURCE_ARBITER_ENTRY::BestConfig</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00711">_PI_RESOURCE_ARBITER_ENTRY::BestResourceList</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00275">DebugMessage</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00267">DUMP_ERROR</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l04339">IopCallArbiter()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l05121">IopFindResourcesForArbiter()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00722">PI_ARBITER_HAS_SOMETHING</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00723">PI_ARBITER_TEST_FAILED</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00710">_PI_RESOURCE_ARBITER_ENTRY::ResourceList</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00715">_PI_RESOURCE_ARBITER_ENTRY::ResourcesChanged</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00708">_PI_RESOURCE_ARBITER_ENTRY::ResourceType</a>, and <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00714">_PI_RESOURCE_ARBITER_ENTRY::State</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l04946">IopPlacementForRebalance()</a>.
<p>
<pre class="fragment"><div>05023                    :
05024 
05025     This routine
05026 
05027 Parameters:
05028 
05029     P1 -
05030 
05031 Return Value:
05032 
05033     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> code that indicates whether or not <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function was successful.
05034 
05035 --*/
05036 
05037 {
05038     PLIST_ENTRY listEntry, listHead;
05039     <a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html">PPI_RESOURCE_ARBITER_ENTRY</a> arbiterEntry;
05040     ULONG count = 0;
05041     PCM_PARTIAL_RESOURCE_DESCRIPTOR cmDesc = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05042     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
05043 
05044     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((ArbiterAction == ArbiterActionTestAllocation)   ||
05045            (ArbiterAction == ArbiterActionRetestAllocation) ||
05046            (ArbiterAction == ArbiterActionCommitAllocation));
05047 
05048 
05049     listHead = &amp;DeviceNode-&gt;DeviceArbiterList;
05050     listEntry = listHead-&gt;Flink;
05051     <span class="keywordflow">while</span> (listEntry != listHead) {
05052         arbiterEntry = CONTAINING_RECORD(listEntry, <a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html">PI_RESOURCE_ARBITER_ENTRY</a>, DeviceArbiterList);
05053         listEntry = listEntry-&gt;Flink;
05054         <span class="keywordflow">if</span> (IsListEmpty(&amp;arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o3">ResourceList</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
05055 
05056             <span class="keywordflow">if</span> (ArbiterAction == <a class="code" href="../../d6/d9/pnp_8h.html#a173a117">ArbiterActionCommitAllocation</a>) {
05057 
05058                 status = <a class="code" href="../../d5/d1/pnpres_8c.html#a79">IopCallArbiter</a>(arbiterEntry, ArbiterActionCommitAllocation, NULL, NULL, NULL);
05059                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(status == STATUS_SUCCESS);
05060                 arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o7">State</a> = 0;
05061                 InitializeListHead(&amp;arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o6">ActiveArbiterList</a>);
05062                 InitializeListHead(&amp;arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o5">BestConfig</a>);
05063                 InitializeListHead(&amp;arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o3">ResourceList</a>);
05064                 InitializeListHead(&amp;arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o4">BestResourceList</a>);
05065 
05066             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o8">ResourcesChanged</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
05067 
05068                 <span class="comment">//</span>
05069                 <span class="comment">// If the resource requirements are the same and it failed before, we know it</span>
05070                 <span class="comment">// won't be able to succeed.  So, return failure.</span>
05071                 <span class="comment">//</span>
05072 
05073                 <span class="keywordflow">if</span> (arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o7">State</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a59">PI_ARBITER_TEST_FAILED</a>) {
05074                     <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
05075                 }
05076             } <span class="keywordflow">else</span> {
05077 
05078 
05079                 <span class="comment">//</span>
05080                 <span class="comment">// If the resource requirements are changed, we need to call arbiter to test it.</span>
05081                 <span class="comment">// First find out what resources *could* be owned by the arbiter.</span>
05082                 <span class="comment">// And then call the Arbiter to try to satisfy the request from the resources</span>
05083                 <span class="comment">// it *could* have.</span>
05084 
05085                 status = <a class="code" href="../../d5/d1/pnpres_8c.html#a86">IopFindResourcesForArbiter</a>(
05086                                         DeviceNode,
05087                                         arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o1">ResourceType</a>,
05088                                         &amp;count,
05089                                         &amp;cmDesc
05090                                         );
05091                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
05092                     <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(DUMP_ERROR, (<span class="stringliteral">"Rebalance: Failed to find required resources for Arbiter\n"</span>));
05093                     <span class="keywordflow">return</span> status;
05094                 }
05095                 status = <a class="code" href="../../d5/d1/pnpres_8c.html#a79">IopCallArbiter</a>(arbiterEntry,
05096                                         ArbiterAction,
05097                                         &amp;arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o3">ResourceList</a>,
05098                                         (PVOID)ULongToPtr(count),
05099                                         cmDesc
05100                                         );
05101                 <span class="keywordflow">if</span> (cmDesc) {
05102                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(cmDesc);
05103                 }
05104                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
05105                     arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o7">State</a> |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a59">PI_ARBITER_TEST_FAILED</a>;
05106                     <span class="keywordflow">return</span> status;
05107                 } <span class="keywordflow">else</span> {
05108                     arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o7">State</a> &amp;= ~<a class="code" href="../../d9/d0/pnpiop_8h.html#a59">PI_ARBITER_TEST_FAILED</a>;
05109                     arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o8">ResourcesChanged</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05110                     <span class="keywordflow">if</span> (ArbiterAction == <a class="code" href="../../d6/d9/pnp_8h.html#a173a115">ArbiterActionTestAllocation</a>) {
05111                         arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o7">State</a> |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a58">PI_ARBITER_HAS_SOMETHING</a>;
05112                     }
05113                 }
05114             }
05115         }
05116     }
05117     <span class="keywordflow">return</span> STATUS_SUCCESS;
05118 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a64" doxytag="pnpres.c::IopAssign" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopAssign           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>AssignTableCount</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>AssignTable</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>Rebalance</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l03084">3084</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.
<p>
References <a class="el" href="../../d6/d9/pnp_8h.html#a173a115">ArbiterActionTestAllocation</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00275">DebugMessage</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00269">DUMP_DETAIL</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00267">DUMP_ERROR</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00252">FIND_BEST_ASSIGNMENT_TIMEOUT</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00177">_DEVICE_NODE::InstancePath</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00755">IOP_ASSIGN_EXCLUDE</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l02716">IopAddReqDescsToArbiters()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l02845">IopIsBestConfiguration()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l02554">IopPlacement()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l02780">IopRemoveReqDescsFromArbiters()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l02906">IopSaveCurrentConfiguration()</a>, <a class="el" href="../../d8/d9/ke_2miscc_8c-source.html#l00153">KeQuerySystemTime()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00241">PiNoRetest</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00245">PiUseTimeout</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00081">PREQ_ALTERNATIVE</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00083">PREQ_LIST</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l03292">IopAssignInner()</a>.
<p>
<pre class="fragment"><div>03092                    :
03093 
03094     This routine performs <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resource allocation <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> passed in AssignTables.
03095 
03096 Parameters:
03097 
03098     AssignTableCount - supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of AssignTable
03099 
03100     AssignTable - supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first AssignTable.
03101 
03102 Return Value:
03103 
03104     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> code that indicates whether or not <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function was successful.
03105 
03106 --*/
03107 
03108 {
03109     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>            status = STATUS_INSUFFICIENT_RESOURCES;
03110     LONG                tableIndex;
03111     <a class="code" href="../../d5/d1/pnpres_8c.html#a30">PREQ_LIST</a>           reqList;
03112     <a class="code" href="../../d5/d1/pnpres_8c.html#a29">PREQ_ALTERNATIVE</a>    reqAlternative;
03113     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>        deviceNode;
03114     LARGE_INTEGER       startTime;
03115     BOOLEAN             timeoutExpired;
03116     ULONG               spewCount = 0;
03117 
03118     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03119 
03120     timeoutExpired = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03121 
03122     <span class="comment">//</span>
03123     <span class="comment">// Initialize our starting time.</span>
03124     <span class="comment">//</span>
03125 
03126     <a class="code" href="../../d7/d0/ke_2miscc_8c.html#a3">KeQuerySystemTime</a>(&amp;startTime);
03127 
03128     <span class="comment">//</span>
03129     <span class="comment">// Initialize the selected alternative for each entry to the first</span>
03130     <span class="comment">// possible alternative.</span>
03131     <span class="comment">//</span>
03132 
03133     <span class="keywordflow">for</span> (tableIndex = 0; tableIndex &lt; (LONG)AssignTableCount; tableIndex++) {
03134 
03135         <span class="keywordflow">if</span> (!(AssignTable[tableIndex].Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a68">IOP_ASSIGN_EXCLUDE</a>)) {
03136 
03137             reqList = AssignTable[tableIndex].ReqList;
03138             reqList-&gt;SelectedAlternative = &amp;reqList-&gt;ReqAlternativeTable[0];
03139         }
03140     }
03141 
03142     <span class="comment">//</span>
03143     <span class="comment">// Go through all possible combinations of req alternatives for all devices.</span>
03144     <span class="comment">//</span>
03145 
03146     <span class="keywordflow">while</span> (tableIndex &gt;= 0) {
03147 
03148         <span class="comment">//</span>
03149         <span class="comment">// Add the currently selected alternative to the arbiters iff</span>
03150         <span class="comment">// it has changed since the last time.</span>
03151         <span class="comment">//</span>
03152 
03153         <span class="keywordflow">for</span> (tableIndex = AssignTableCount - 1; tableIndex &gt;= 0;) {
03154 
03155             <span class="keywordflow">if</span> (AssignTable[tableIndex].Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a68">IOP_ASSIGN_EXCLUDE</a>) {
03156 
03157                 tableIndex--;
03158             } <span class="keywordflow">else</span> {
03159 
03160                 reqList = AssignTable[tableIndex].ReqList;
03161                 reqAlternative = *reqList-&gt;SelectedAlternative;
03162                 deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)AssignTable[tableIndex].PhysicalDevice-&gt;DeviceObjectExtension-&gt;DeviceNode;
03163                 <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(DUMP_DETAIL, (<span class="stringliteral">"PnpRes: Adding %d/%d req alt to the arbiters for %ws.\n"</span>, reqAlternative-&gt;ReqAlternativeIndex + 1, reqList-&gt;ReqAlternativeCount, deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o13">InstancePath</a>.Buffer));
03164                 <a class="code" href="../../d5/d1/pnpres_8c.html#a69">IopAddReqDescsToArbiters</a>(   reqAlternative-&gt;ReqDescCount,
03165                                             reqAlternative-&gt;ReqDescTable);
03166                 <span class="keywordflow">if</span> (reqList-&gt;SelectedAlternative == &amp;reqList-&gt;ReqAlternativeTable[0]) {
03167 
03168                     tableIndex--;
03169                 } <span class="keywordflow">else</span> {
03170 
03171                     <span class="keywordflow">break</span>;
03172                 }
03173             }
03174         }
03175 
03176         <span class="comment">//</span>
03177         <span class="comment">// Test this configuration.</span>
03178         <span class="comment">//</span>
03179 
03180         status = <a class="code" href="../../d5/d1/pnpres_8c.html#a68">IopPlacement</a>(ArbiterActionTestAllocation, Rebalance);
03181         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03182             <span class="comment">//</span>
03183             <span class="comment">// Compute priority and update best configuration if needed.</span>
03184             <span class="comment">//</span>
03185 
03186             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d1/pnpres_8c.html#a71">IopIsBestConfiguration</a>()) {
03187 
03188                 <span class="comment">//</span>
03189                 <span class="comment">// This assignment gets the best score.  Update its ReqBestAlternative</span>
03190                 <span class="comment">// and return.</span>
03191                 <span class="comment">//</span>
03192 
03193                 <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(DUMP_DETAIL, (<span class="stringliteral">"PnpRes: Found a best assignment.  Save it\n"</span>));
03194                 <a class="code" href="../../d5/d1/pnpres_8c.html#a72">IopSaveCurrentConfiguration</a>();
03195 
03196                 <span class="comment">//</span>
03197                 <span class="comment">// The reqList-&gt;ReqBestAlternative will be set to reqAlternative, i.e.</span>
03198                 <span class="comment">//     reqList-&gt;ReqBestAlternative = reqAlternative;</span>
03199                 <span class="comment">// in IopSaveCurrentConfiguration().</span>
03200                 <span class="comment">// This will cause the control to exit the for-loop.</span>
03201                 <span class="comment">//</span>
03202 
03203             }
03204 
03205             <span class="comment">//</span>
03206             <span class="comment">// Do we need to stop?</span>
03207             <span class="comment">//</span>
03208 
03209             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d1/pnpres_8c.html#a43">PiNoRetest</a>) {
03210 
03211                 <span class="keywordflow">break</span>;
03212             }
03213         }
03214 
03215         <span class="comment">//</span>
03216         <span class="comment">// Algorithm to select the next alternative.</span>
03217         <span class="comment">//</span>
03218         <span class="comment">// We go through the table in the reverse direction.</span>
03219         <span class="comment">// We first remove the currently selected alternative.</span>
03220         <span class="comment">// We update the selected alternative to the next possible</span>
03221         <span class="comment">// alternative. If we roll over, we go to the next entry in</span>
03222         <span class="comment">// the table.</span>
03223         <span class="comment">//</span>
03224 
03225         <span class="keywordflow">for</span> (tableIndex = AssignTableCount - 1; tableIndex &gt;= 0; ) {
03226 
03227             <span class="keywordflow">if</span> (AssignTable[tableIndex].Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a68">IOP_ASSIGN_EXCLUDE</a>) {
03228 
03229                 tableIndex--;
03230             } <span class="keywordflow">else</span> {
03231 
03232                 reqList = AssignTable[tableIndex].ReqList;
03233                 reqAlternative = *reqList-&gt;SelectedAlternative;
03234                 deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)AssignTable[tableIndex].PhysicalDevice-&gt;DeviceObjectExtension-&gt;DeviceNode;
03235                 <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(DUMP_DETAIL, (<span class="stringliteral">"PnpRes: Removing %d/%d req alt from the arbiters for %ws.\n"</span>, reqAlternative-&gt;ReqAlternativeIndex + 1, reqList-&gt;ReqAlternativeCount, deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o13">InstancePath</a>.Buffer));
03236                 <a class="code" href="../../d5/d1/pnpres_8c.html#a70">IopRemoveReqDescsFromArbiters</a>(  reqAlternative-&gt;ReqDescCount,
03237                                                 reqAlternative-&gt;ReqDescTable);
03238                 <span class="keywordflow">if</span> (++reqList-&gt;SelectedAlternative &lt; reqList-&gt;ReqBestAlternative &amp;&amp; !timeoutExpired) {
03239 
03240                     <span class="keywordflow">break</span>;
03241                 } <span class="keywordflow">else</span> {
03242 
03243                     reqList-&gt;SelectedAlternative = &amp;reqList-&gt;ReqAlternativeTable[0];
03244                     tableIndex--;
03245                 }
03246             }
03247 
03248         }
03249 
03250         <span class="comment">//</span>
03251         <span class="comment">// Check if timeout has expired.</span>
03252         <span class="comment">//</span>
03253 
03254         <span class="keywordflow">if</span> (tableIndex &gt;= 0) {
03255 
03256             LARGE_INTEGER   currentTime;
03257             ULONG           timeDiff;
03258 
03259             <span class="comment">//</span>
03260             <span class="comment">// Compute time difference in milliseconds.</span>
03261             <span class="comment">//</span>
03262 
03263             <a class="code" href="../../d7/d0/ke_2miscc_8c.html#a3">KeQuerySystemTime</a>(&amp;currentTime);
03264             timeDiff = (ULONG)((currentTime.QuadPart - startTime.QuadPart) / 10000);
03265 
03266             <span class="comment">//</span>
03267             <span class="comment">// We are done if timeout has expired.</span>
03268             <span class="comment">//</span>
03269 
03270             <span class="keywordflow">if</span> (timeDiff &gt;= <a class="code" href="../../d5/d1/pnpres_8c.html#a22">FIND_BEST_ASSIGNMENT_TIMEOUT</a>)
03271             {
03272                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d1/pnpres_8c.html#a44">PiUseTimeout</a>) {
03273 
03274                     <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(DUMP_ERROR, (<span class="stringliteral">"PnpRes: Timeout expired, bailing out!\n"</span>));
03275                     timeoutExpired = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03276 
03277                 } <span class="keywordflow">else</span> {
03278 
03279                     spewCount = (spewCount + 1) % 50;
03280                     <span class="keywordflow">if</span> (spewCount == 0) {
03281                         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"PnpRes: Timeout expired.\n"</span>);
03282                     }
03283                 }
03284             }
03285         }
03286     }
03287 
03288     <span class="keywordflow">return</span> (status);
03289 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a67" doxytag="pnpres.c::IopAssignInner" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopAssignInner           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>AssignTableCount</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>AssignTable</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>Rebalance</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l03292">3292</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.
<p>
References <a class="el" href="../../d6/d9/pnp_8h.html#a52">ARBITER_ACTION</a>, <a class="el" href="../../d6/d9/pnp_8h.html#a173a117">ArbiterActionCommitAllocation</a>, <a class="el" href="../../d6/d9/pnp_8h.html#a173a116">ArbiterActionRetestAllocation</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00275">DebugMessage</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00269">DUMP_DETAIL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l03084">IopAssign()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l07662">IopCheckDataStructures()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l02554">IopPlacement()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l02997">IopRestoreBestConfiguration()</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00056">IopRootDeviceNode</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00234">PiActiveArbiterList</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00237">PiAssignTable</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00238">PiAssignTableCount</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00235">PiBestArbiterList</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00236">PiBestPriority</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00241">PiNoRetest</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00273">PnpResDebugLevel</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00270">STOP_ERROR</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00720">IopAllocateResources()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l07470">IopReallocateResources()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l05215">IopRebalance()</a>, and <a class="el" href="../../d6/d0/pnpres_8c-source.html#l05660">IopRestoreResourcesInternal()</a>.
<p>
<pre class="fragment"><div>03300                    :
03301 
03302     This routine sets up <span class="keyword">static</span> variables and invokes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> real resource allocation
03303     routine.
03304 
03305 Parameters:
03306 
03307     AssignTableCount - supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of AssignTable
03308 
03309     AssignTable - supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first AssignTable.
03310 
03311 Return Value:
03312 
03313     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> code that indicates whether or not <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function was successful.
03314 
03315 --*/
03316 
03317 {
03318     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
03319     <a class="code" href="../../d6/d9/pnp_8h.html#a52">ARBITER_ACTION</a> arbiterAction;
03320 
03321     <span class="comment">//</span>
03322     <span class="comment">// Initialize static variable</span>
03323     <span class="comment">//</span>
03324 
03325     InitializeListHead(&amp;PiBestArbiterList);
03326     InitializeListHead(&amp;PiActiveArbiterList);
03327     <a class="code" href="../../d5/d1/pnpres_8c.html#a41">PiAssignTableCount</a> = AssignTableCount;
03328     <a class="code" href="../../d5/d1/pnpres_8c.html#a40">PiAssignTable</a> = AssignTable;
03329     <a class="code" href="../../d5/d1/pnpres_8c.html#a39">PiBestPriority</a> = (ULONG) -1;
03330     <span class="keywordflow">if</span> (AssignTableCount == 1) {
03331         <a class="code" href="../../d5/d1/pnpres_8c.html#a43">PiNoRetest</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03332         arbiterAction = <a class="code" href="../../d6/d9/pnp_8h.html#a173a117">ArbiterActionCommitAllocation</a>;
03333     } <span class="keywordflow">else</span> {
03334         <a class="code" href="../../d5/d1/pnpres_8c.html#a43">PiNoRetest</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03335         arbiterAction = <a class="code" href="../../d6/d9/pnp_8h.html#a173a116">ArbiterActionRetestAllocation</a>;
03336     }
03337 
03338     <span class="comment">//</span>
03339     <span class="comment">// Try to solve the inner NP-complete problem.</span>
03340     <span class="comment">//</span>
03341 
03342     <a class="code" href="../../d5/d1/pnpres_8c.html#a64">IopAssign</a>(AssignTableCount, AssignTable, Rebalance);
03343 <span class="preprocessor">#if DBG_SCOPE</span>
03344 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ((<a class="code" href="../../d5/d1/pnpres_8c.html#a47">PnpResDebugLevel</a> &amp; <a class="code" href="../../d5/d1/pnpres_8c.html#a26">STOP_ERROR</a>) &amp;&amp; <a class="code" href="../../d5/d1/pnpres_8c.html#a43">PiNoRetest</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
03345         <a class="code" href="../../d5/d1/pnpres_8c.html#a99">IopCheckDataStructures</a>(IopRootDeviceNode);
03346     }
03347 <span class="preprocessor">#endif</span>
03348 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (IsListEmpty(&amp;PiBestArbiterList)) {
03349         <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(DUMP_DETAIL, (<span class="stringliteral">"PnpRes: IoAssignInner failed to find an assignment.\n"</span>));
03350         status = STATUS_UNSUCCESSFUL;
03351     } <span class="keywordflow">else</span> {
03352 
03353         <span class="keywordflow">if</span> (Rebalance) {
03354             <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(DUMP_DETAIL, (<span class="stringliteral">"PnpRes: Restore the best assignment.\n"</span>));
03355         } <span class="keywordflow">else</span> {
03356             <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(DUMP_DETAIL, (<span class="stringliteral">"PnpRes: Restore the best assignment and commit it.\n"</span>));
03357         }
03358 
03359         <a class="code" href="../../d5/d1/pnpres_8c.html#a73">IopRestoreBestConfiguration</a>();
03360         status = <a class="code" href="../../d5/d1/pnpres_8c.html#a68">IopPlacement</a>(arbiterAction, Rebalance);
03361 <span class="preprocessor">#if DBG_SCOPE</span>
03362 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (!Rebalance) {
03363             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d1/pnpres_8c.html#a47">PnpResDebugLevel</a> &amp; <a class="code" href="../../d5/d1/pnpres_8c.html#a26">STOP_ERROR</a>) {
03364                 <a class="code" href="../../d5/d1/pnpres_8c.html#a99">IopCheckDataStructures</a>(IopRootDeviceNode);
03365             }
03366         }
03367 <span class="preprocessor">#endif</span>
03368 <span class="preprocessor"></span>        <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(status == STATUS_SUCCESS);
03369     }
03370     <a class="code" href="../../d5/d1/pnpres_8c.html#a43">PiNoRetest</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03371     <span class="keywordflow">return</span> status;
03372 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a66" doxytag="pnpres.c::IopBuildCmResourceList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopBuildCmResourceList           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>AssignEntry</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l02034">2034</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.
<p>
References <a class="el" href="../../d6/d9/pnp_8h.html#a175a134">ArbiterResultNullRequest</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d9/cmdat_8c-source.html#l00172">CmRegistryMachineHardwareResourceMapName</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00275">DebugMessage</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00267">DUMP_ERROR</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00062">ExAllocatePoolCMRL</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00063">ExAllocatePoolCMRR</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l03933">IopChildToRootTranslation()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l01156">IopCreateRegistryKeyEx()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l03868">IopParentToRawTranslation()</a>, <a class="el" href="../../d2/d7/report_8c-source.html#l00760">IopWriteResourceList()</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00723">IopWstrRaw</a>, <a class="el" href="../../d8/d8/assign_8c-source.html#l00056">IopWstrTranslated</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d0/obquery_8c-source.html#l00713">ObQueryNameString()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00081">PREQ_ALTERNATIVE</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00079">PREQ_DESC</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00083">PREQ_LIST</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01821">RtlAppendUnicodeToString()</a>, and <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l02320">IopBuildCmResourceLists()</a>.
<p>
<pre class="fragment"><div>02039                    :
02040 
02041     This routine walks REQ_LIST of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> AssignEntry to build a corresponding
02042     Cm <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a> lists.  It also reports <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resources to ResourceMap.
02043 
02044 Parameters:
02045 
02046     AssignEntry - Supplies a pointer to an IOP_ASSIGN_REQUEST structure
02047 
02048 Return Value:
02049 
02050     None.  The ResourceAssignment in AssignEntry <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> initialized.
02051 
02052 --*/
02053 
02054 {
02055     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
02056     HANDLE resourceMapKey;
02057     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> physicalDevice;
02058     <a class="code" href="../../d5/d1/pnpres_8c.html#a30">PREQ_LIST</a> reqList = AssignEntry-&gt;ReqList;
02059     <a class="code" href="../../d5/d1/pnpres_8c.html#a29">PREQ_ALTERNATIVE</a> reqAlternative;
02060     <a class="code" href="../../d5/d1/pnpres_8c.html#a28">PREQ_DESC</a> reqDesc, reqDescx;
02061     PIO_RESOURCE_DESCRIPTOR privateData;
02062     ULONG count = 0, size, i;
02063     PCM_RESOURCE_LIST cmResources, cmResourcesRaw;
02064     PCM_FULL_RESOURCE_DESCRIPTOR cmFullResource, cmFullResourceRaw;
02065     PCM_PARTIAL_RESOURCE_LIST cmPartialList, cmPartialListRaw;
02066     PCM_PARTIAL_RESOURCE_DESCRIPTOR cmDescriptor, cmDescriptorRaw, assignment, tAssignment;
02067 <span class="preprocessor">#if DBG</span>
02068 <span class="preprocessor"></span>    PCM_PARTIAL_RESOURCE_DESCRIPTOR cmDescriptorEnd, cmDescriptorEndRaw;
02069 <span class="preprocessor">#endif</span>
02070 <span class="preprocessor"></span>
02071     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02072 
02073     <span class="comment">//</span>
02074     <span class="comment">// Determine the size of the CmResourceList</span>
02075     <span class="comment">//</span>
02076 
02077     <span class="comment">//</span>
02078     <span class="comment">// Determine the size of the CmResourceList</span>
02079     <span class="comment">//</span>
02080 
02081     reqAlternative = *reqList-&gt;SelectedAlternative;
02082     <span class="keywordflow">for</span> (i = 0; i &lt; reqAlternative-&gt;ReqDescCount; i++) {
02083         reqDesc = reqAlternative-&gt;ReqDescTable[i];
02084         count += reqDesc-&gt;DevicePrivateCount + 1;
02085     }
02086 
02087     size = <span class="keyword">sizeof</span>(CM_RESOURCE_LIST) + <span class="keyword">sizeof</span>(CM_PARTIAL_RESOURCE_DESCRIPTOR) * (count - 1);
02088     cmResources = (PCM_RESOURCE_LIST) <a class="code" href="../../d5/d1/pnpres_8c.html#a3">ExAllocatePoolCMRL</a>(PagedPool, size);
02089     <span class="keywordflow">if</span> (!cmResources) {
02090 
02091         <span class="comment">//</span>
02092         <span class="comment">// If we can not find memory, the resources will not be committed by arbiter.</span>
02093         <span class="comment">//</span>
02094 
02095         <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(DUMP_ERROR, (<span class="stringliteral">"PnpRes: Not enough memory to build Translated CmResourceList\n"</span>));
02096         AssignEntry-&gt;Status = STATUS_INSUFFICIENT_RESOURCES;
02097         AssignEntry-&gt;ResourceAssignment = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02098         AssignEntry-&gt;TranslatedResourceAssignment = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02099         <span class="keywordflow">return</span>;
02100     }
02101     cmResourcesRaw = (PCM_RESOURCE_LIST) <a class="code" href="../../d5/d1/pnpres_8c.html#a4">ExAllocatePoolCMRR</a>(PagedPool, size);
02102     <span class="keywordflow">if</span> (!cmResourcesRaw) {
02103         <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(DUMP_ERROR, (<span class="stringliteral">"PnpRes: Not enough memory to build Raw CmResourceList\n"</span>));
02104         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(cmResources);
02105         AssignEntry-&gt;Status = STATUS_INSUFFICIENT_RESOURCES;
02106         AssignEntry-&gt;ResourceAssignment = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02107         AssignEntry-&gt;TranslatedResourceAssignment = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02108         <span class="keywordflow">return</span>;
02109     }
02110     cmResources-&gt;Count = 1;
02111     cmFullResource = cmResources-&gt;List;
02112 
02113     <span class="comment">//</span>
02114     <span class="comment">// The CmResourceList we build here does not distinguish the</span>
02115     <span class="comment">// Interface Type on descriptor level.  This should be fine because</span>
02116     <span class="comment">// for IoReportResourceUsage we ignore the CmResourceList we build</span>
02117     <span class="comment">// here.</span>
02118     <span class="comment">//</span>
02119 
02120     cmFullResource-&gt;InterfaceType = reqList-&gt;InterfaceType;
02121     cmFullResource-&gt;BusNumber = reqList-&gt;BusNumber;
02122     cmPartialList = &amp;cmFullResource-&gt;PartialResourceList;
02123     cmPartialList-&gt;Version = 0;
02124     cmPartialList-&gt;Revision = 0;
02125     cmPartialList-&gt;Count = count;
02126     cmDescriptor = cmPartialList-&gt;PartialDescriptors;
02127 <span class="preprocessor">#if DBG</span>
02128 <span class="preprocessor"></span>    cmDescriptorEnd = cmDescriptor + count;
02129 <span class="preprocessor">#endif</span>
02130 <span class="preprocessor"></span>    cmResourcesRaw-&gt;Count = 1;
02131     cmFullResourceRaw = cmResourcesRaw-&gt;List;
02132     cmFullResourceRaw-&gt;InterfaceType = reqList-&gt;InterfaceType;
02133     cmFullResourceRaw-&gt;BusNumber = reqList-&gt;BusNumber;
02134     cmPartialListRaw = &amp;cmFullResourceRaw-&gt;PartialResourceList;
02135     cmPartialListRaw-&gt;Version = 0;
02136     cmPartialListRaw-&gt;Revision = 0;
02137     cmPartialListRaw-&gt;Count = count;
02138     cmDescriptorRaw = cmPartialListRaw-&gt;PartialDescriptors;
02139 <span class="preprocessor">#if DBG</span>
02140 <span class="preprocessor"></span>    cmDescriptorEndRaw = cmDescriptorRaw + count;
02141 <span class="preprocessor">#endif</span>
02142 <span class="preprocessor"></span>
02143     <span class="keywordflow">for</span> (i = 0; i &lt; reqAlternative-&gt;ReqDescCount; i++) {
02144         reqDesc = reqAlternative-&gt;ReqDescTable[i];
02145 
02146         <span class="keywordflow">if</span> (reqDesc-&gt;ArbitrationRequired) {
02147 
02148             <span class="comment">//</span>
02149             <span class="comment">// Get raw assignment and copy it to our raw resource list</span>
02150             <span class="comment">//</span>
02151 
02152             reqDescx = reqDesc-&gt;TranslatedReqDesc;
02153             <span class="keywordflow">if</span> (reqDescx-&gt;AlternativeTable.Result != <a class="code" href="../../d6/d9/pnp_8h.html#a175a134">ArbiterResultNullRequest</a>) {
02154                 status = <a class="code" href="../../d5/d1/pnpres_8c.html#a76">IopParentToRawTranslation</a>(reqDescx);
02155                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02156                     <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(DUMP_ERROR, (<span class="stringliteral">"PnpRes: Parent To Raw translation failed\n"</span>));
02157                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(cmResources);
02158                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(cmResourcesRaw);
02159                     AssignEntry-&gt;Status = STATUS_INSUFFICIENT_RESOURCES;
02160                     AssignEntry-&gt;ResourceAssignment = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02161                     <span class="keywordflow">return</span>;
02162                 }
02163                 assignment = reqDesc-&gt;AlternativeTable.Assignment;
02164             } <span class="keywordflow">else</span> {
02165                 assignment = reqDescx-&gt;AlternativeTable.Assignment;
02166             }
02167             *cmDescriptorRaw = *assignment;
02168             cmDescriptorRaw++;
02169 
02170             <span class="comment">//</span>
02171             <span class="comment">// Translate assignment and copy it to our translated resource list</span>
02172             <span class="comment">//</span>
02173             <span class="keywordflow">if</span> (reqDescx-&gt;AlternativeTable.Result != <a class="code" href="../../d6/d9/pnp_8h.html#a175a134">ArbiterResultNullRequest</a>) {
02174                 status = <a class="code" href="../../d5/d1/pnpres_8c.html#a77">IopChildToRootTranslation</a>(
02175                              (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)reqDesc-&gt;AlternativeTable.PhysicalDeviceObject-&gt;DeviceObjectExtension-&gt;DeviceNode,
02176                              reqDesc-&gt;InterfaceType,
02177                              reqDesc-&gt;BusNumber,
02178                              reqDesc-&gt;AlternativeTable.RequestSource,
02179                              &amp;reqDesc-&gt;Allocation,
02180                              &amp;tAssignment
02181                              );
02182                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02183                     <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(DUMP_ERROR, (<span class="stringliteral">"PnpRes: Child to Root translation failed\n"</span>));
02184                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(cmResources);
02185                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(cmResourcesRaw);
02186                     AssignEntry-&gt;Status = STATUS_INSUFFICIENT_RESOURCES;
02187                     AssignEntry-&gt;ResourceAssignment = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02188                     <span class="keywordflow">return</span>;
02189                 }
02190                 *cmDescriptor = *tAssignment;
02191                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(tAssignment);
02192             } <span class="keywordflow">else</span> {
02193                 *cmDescriptor = *(reqDescx-&gt;AlternativeTable.Assignment);
02194             }
02195             cmDescriptor++;
02196 
02197         } <span class="keywordflow">else</span> {
02198             *cmDescriptorRaw = reqDesc-&gt;Allocation;
02199             *cmDescriptor = reqDesc-&gt;Allocation;
02200             cmDescriptorRaw++;
02201             cmDescriptor++;
02202         }
02203 
02204         <span class="comment">//</span>
02205         <span class="comment">// Next copy the device private descriptors to CmResourceLists</span>
02206         <span class="comment">//</span>
02207 
02208         count = reqDesc-&gt;DevicePrivateCount;
02209         privateData = reqDesc-&gt;DevicePrivate;
02210         <span class="keywordflow">while</span> (count != 0) {
02211 
02212             cmDescriptor-&gt;Type = cmDescriptorRaw-&gt;Type = CmResourceTypeDevicePrivate;
02213             cmDescriptor-&gt;ShareDisposition = cmDescriptorRaw-&gt;ShareDisposition =
02214                          CmResourceShareDeviceExclusive;
02215             cmDescriptor-&gt;Flags = cmDescriptorRaw-&gt;Flags = privateData-&gt;Flags;
02216             RtlMoveMemory(&amp;cmDescriptorRaw-&gt;u.DevicePrivate,
02217                           &amp;privateData-&gt;u.DevicePrivate,
02218                           <span class="keyword">sizeof</span>(cmDescriptorRaw-&gt;u.DevicePrivate.Data)
02219                           );
02220             RtlMoveMemory(&amp;cmDescriptor-&gt;u.DevicePrivate,
02221                           &amp;privateData-&gt;u.DevicePrivate,
02222                           <span class="keyword">sizeof</span>(cmDescriptor-&gt;u.DevicePrivate.Data)
02223                           );
02224             privateData++;
02225             cmDescriptorRaw++;
02226             cmDescriptor++;
02227             count--;
02228             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(cmDescriptorRaw &lt;= cmDescriptorEndRaw);
02229             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(cmDescriptor &lt;= cmDescriptorEnd);
02230         }
02231         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(cmDescriptor &lt;= cmDescriptorEnd);
02232         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(cmDescriptorRaw &lt;= cmDescriptorEndRaw);
02233 
02234     }
02235 
02236     <span class="comment">//</span>
02237     <span class="comment">// report assigned resources to ResourceMap</span>
02238     <span class="comment">//</span>
02239 
02240     physicalDevice = AssignEntry-&gt;PhysicalDevice;
02241 
02242     <span class="comment">//</span>
02243     <span class="comment">// Open ResourceMap key</span>
02244     <span class="comment">//</span>
02245 
02246     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a8">IopCreateRegistryKeyEx</a>( &amp;resourceMapKey,
02247                                      (HANDLE) NULL,
02248                                      &amp;CmRegistryMachineHardwareResourceMapName,
02249                                      KEY_READ | KEY_WRITE,
02250                                      REG_OPTION_VOLATILE,
02251                                      NULL
02252                                      );
02253     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status )) {
02254         WCHAR DeviceBuffer[256];
02255         POBJECT_NAME_INFORMATION NameInformation;
02256         ULONG NameLength;
02257         UNICODE_STRING UnicodeClassName;
02258         UNICODE_STRING UnicodeDriverName;
02259         UNICODE_STRING UnicodeDeviceName;
02260 
02261         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;UnicodeClassName, PNPMGR_STR_PNP_MANAGER);
02262 
02263         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;UnicodeDriverName, REGSTR_KEY_PNP_DRIVER);
02264 
02265         NameInformation = (POBJECT_NAME_INFORMATION) DeviceBuffer;
02266         status = <a class="code" href="../../d6/d1/obquery_8c.html#a7">ObQueryNameString</a>( physicalDevice,
02267                                     NameInformation,
02268                                     <span class="keyword">sizeof</span>( DeviceBuffer ),
02269                                     &amp;NameLength );
02270         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02271             NameInformation-&gt;Name.MaximumLength = <span class="keyword">sizeof</span>(DeviceBuffer) - <span class="keyword">sizeof</span>(OBJECT_NAME_INFORMATION);
02272             <span class="keywordflow">if</span> (NameInformation-&gt;Name.Length == 0) {
02273                 NameInformation-&gt;Name.Buffer = (PVOID)((ULONG_PTR)DeviceBuffer + <span class="keyword">sizeof</span>(OBJECT_NAME_INFORMATION));
02274             }
02275 
02276             UnicodeDeviceName = NameInformation-&gt;Name;
02277             <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>(&amp;UnicodeDeviceName, IopWstrRaw);
02278 
02279             <span class="comment">//</span>
02280             <span class="comment">// IopWriteResourceList should remove all the device private and device</span>
02281             <span class="comment">// specifiec descriptors.</span>
02282             <span class="comment">//</span>
02283 
02284             status = <a class="code" href="../../d1/d8/report_8c.html#a15">IopWriteResourceList</a>(
02285                          resourceMapKey,
02286                          &amp;UnicodeClassName,
02287                          &amp;UnicodeDriverName,
02288                          &amp;UnicodeDeviceName,
02289                          cmResourcesRaw,
02290                          size
02291                          );
02292             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02293                 UnicodeDeviceName = NameInformation-&gt;Name;
02294                 <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a> (&amp;UnicodeDeviceName, IopWstrTranslated);
02295                 status = <a class="code" href="../../d1/d8/report_8c.html#a15">IopWriteResourceList</a>(
02296                              resourceMapKey,
02297                              &amp;UnicodeClassName,
02298                              &amp;UnicodeDriverName,
02299                              &amp;UnicodeDeviceName,
02300                              cmResources,
02301                              size
02302                              );
02303             }
02304         }
02305         ZwClose(resourceMapKey);
02306     }
02307 <span class="preprocessor">#if 0 // Ignore the registry writing status.</span>
02308 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02309         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(cmResources);
02310         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(cmResourcesRaw);
02311         cmResources = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02312         cmResourcesRaw = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02313     }
02314 <span class="preprocessor">#endif</span>
02315 <span class="preprocessor"></span>    AssignEntry-&gt;ResourceAssignment = cmResourcesRaw;
02316     AssignEntry-&gt;TranslatedResourceAssignment = cmResources;
02317 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a65" doxytag="pnpres.c::IopBuildCmResourceLists" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopBuildCmResourceLists           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>AssignTable</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>AssignTableEnd</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l02320">2320</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.
<p>
References <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00275">DebugMessage</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01274">_DEVOBJ_EXTENSION::DeviceNode</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01210">_DEVICE_OBJECT::DeviceObjectExtension</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00268">DUMP_INFO</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00766">_IOP_RESOURCE_REQUEST::Flags</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00177">_DEVICE_NODE::InstancePath</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00755">IOP_ASSIGN_EXCLUDE</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00756">IOP_ASSIGN_IGNORE</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00754">IOP_ASSIGN_RETRY</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l02034">IopBuildCmResourceList()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l03631">IopDetermineResourceListSize()</a>, <a class="el" href="../../d2/d7/report_8c-source.html#l00929">IopDumpCmResourceList()</a>, <a class="el" href="../../d9/d0/pnpiop_8h.html#a301">IopWriteAllocatedResourcesToRegistry()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00765">_IOP_RESOURCE_REQUEST::PhysicalDevice</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00273">PnpResDebugLevel</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00771">_IOP_RESOURCE_REQUEST::ResourceAssignment</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00773">_IOP_RESOURCE_REQUEST::Status</a>, and <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00772">_IOP_RESOURCE_REQUEST::TranslatedResourceAssignment</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00720">IopAllocateResources()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l07470">IopReallocateResources()</a>, and <a class="el" href="../../d6/d0/pnpres_8c-source.html#l05215">IopRebalance()</a>.
<p>
<pre class="fragment"><div>02327                    :
02328 
02329     For each AssignTable entry, <span class="keyword">this</span> routine queries device's IO resource requirements
02330     list and converts <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> to our internal REQ_LIST <a class="code" href="../../d8/d0/rtbatcr_8c.html#a8">format</a>.
02331 
02332 Parameters:
02333 
02334     AssignTable - supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first entry of a <a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">IOP_RESOURCE_REQUEST</a> table.
02335 
02336     AssignTableEnd - supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> end of <a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">IOP_RESOURCE_REQUEST</a> table.
02337 
02338 Return Value:
02339 
02340     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> code that indicates whether or not <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function was successful.
02341 
02342 --*/
02343 
02344 {
02345     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
02346     <a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a> assignEntry;
02347     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> physicalDevice;
02348     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode;
02349 
02350     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02351 
02352     <span class="comment">//</span>
02353     <span class="comment">// Go thru each entry, for each Physical device object, we build a CmResourceList</span>
02354     <span class="comment">// from its ListOfAssignedResources.</span>
02355     <span class="comment">//</span>
02356 
02357     <span class="keywordflow">for</span> (assignEntry = AssignTable; assignEntry &lt; AssignTableEnd; ++assignEntry) {
02358 
02359         assignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o6">ResourceAssignment</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02360         <span class="keywordflow">if</span> (assignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o1">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a69">IOP_ASSIGN_IGNORE</a> || assignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o1">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a67">IOP_ASSIGN_RETRY</a>) {
02361             <span class="keywordflow">continue</span>;
02362         }
02363         <span class="keywordflow">if</span> (assignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o1">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a68">IOP_ASSIGN_EXCLUDE</a>) {
02364             assignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o8">Status</a> = STATUS_UNSUCCESSFUL;
02365             <span class="keywordflow">continue</span>;
02366         }
02367         assignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o8">Status</a> = STATUS_SUCCESS;
02368         <a class="code" href="../../d5/d1/pnpres_8c.html#a66">IopBuildCmResourceList</a> (assignEntry);
02369         <span class="keywordflow">if</span> (assignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o6">ResourceAssignment</a>) {
02370             physicalDevice = assignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o0">PhysicalDevice</a>;
02371             deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)physicalDevice-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o6">DeviceNode</a>;
02372             <a class="code" href="../../d9/d0/pnpiop_8h.html#a301">IopWriteAllocatedResourcesToRegistry</a>(
02373                   deviceNode,
02374                   assignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o6">ResourceAssignment</a>,
02375                   <a class="code" href="../../d9/d0/pnpiop_8h.html#a254">IopDetermineResourceListSize</a>(assignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o6">ResourceAssignment</a>)
02376                   );
02377 <span class="preprocessor">#if DBG_SCOPE</span>
02378 <span class="preprocessor"></span>            <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(DUMP_INFO,(<span class="stringliteral">"Pnpres: Building CM resource lists for %ws...\n"</span>, deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o13">InstancePath</a>.Buffer));
02379             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d1/pnpres_8c.html#a47">PnpResDebugLevel</a> &amp; <a class="code" href="../../d5/d1/pnpres_8c.html#a24">DUMP_INFO</a>) {
02380                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Raw resources "</span>);
02381                 <a class="code" href="../../d1/d8/report_8c.html#a17">IopDumpCmResourceList</a>(assignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o6">ResourceAssignment</a>);
02382                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Translated resources "</span>);
02383                 <a class="code" href="../../d1/d8/report_8c.html#a17">IopDumpCmResourceList</a>(assignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o7">TranslatedResourceAssignment</a>);
02384             }
02385 <span class="preprocessor">#endif</span>
02386 <span class="preprocessor"></span>        }
02387     }
02388 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a79" doxytag="pnpres.c::IopCallArbiter" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopCallArbiter           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html">PPI_RESOURCE_ARBITER_ENTRY</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ArbiterEntry</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d6/d9/pnp_8h.html#a52">ARBITER_ACTION</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Command</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Input1</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Input2</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Input3</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l04339">4339</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.
<p>
References <a class="el" href="../../d6/d9/pnp_8h.html#a173a124">ArbiterActionBootAllocation</a>, <a class="el" href="../../d6/d9/pnp_8h.html#a173a117">ArbiterActionCommitAllocation</a>, <a class="el" href="../../d6/d9/pnp_8h.html#a173a119">ArbiterActionQueryAllocatedResources</a>, <a class="el" href="../../d6/d9/pnp_8h.html#a173a122">ArbiterActionQueryArbitrate</a>, <a class="el" href="../../d6/d9/pnp_8h.html#a173a121">ArbiterActionQueryConflict</a>, <a class="el" href="../../d6/d9/pnp_8h.html#a173a116">ArbiterActionRetestAllocation</a>, <a class="el" href="../../d6/d9/pnp_8h.html#a173a118">ArbiterActionRollbackAllocation</a>, <a class="el" href="../../d6/d9/pnp_8h.html#a173a115">ArbiterActionTestAllocation</a>, <a class="el" href="../../d6/d9/pnp_8h.html#a173a120">ArbiterActionWriteReservedResources</a>, <a class="el" href="../../d7/d8/pnp_8h-source.html#l00840">_ARBITER_INTERFACE::ArbiterHandler</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00709">_PI_RESOURCE_ARBITER_ENTRY::ArbiterInterface</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d8/pnp_8h-source.html#l00833">_ARBITER_INTERFACE::Context</a>, <a class="el" href="../../d7/d8/pnp_8h-source.html#l00739">_ARBITER_LIST_ENTRY::ListEntry</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d3/d8/struct__ARBITER__PARAMETERS.html#o17">_ARBITER_PARAMETERS::Parameters</a>, and <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00079">PREQ_DESC</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l02716">IopAddReqDescsToArbiters()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l05016">IopArbitrateDeviceResources()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l02554">IopPlacement()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l02649">IopPlacementForReservation()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l08336">IopQueryConflictListInternal()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l05757">IopReleaseResourcesInternal()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l02780">IopRemoveReqDescsFromArbiters()</a>, and <a class="el" href="../../d6/d0/pnpres_8c-source.html#l03534">IopSetupArbiterAndTranslators()</a>.
<p>
<pre class="fragment"><div>04349                    :
04350 
04351     This routine builds a Parameter block from Input structure and calls specified
04352     arbiter to carry <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Command.
04353 
04354 Parameters:
04355 
04356     ArbiterEntry - Supplies a pointer to our <a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html">PI_RESOURCE_ARBITER_ENTRY</a> such that
04357                    we know everything about <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> arbiter.
04358 
04359     Command - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d7/d0/cmdat2_8c.html#a18">Action</a> code <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> arbiter.
04360 
04361     Input - Supplies a PVOID pointer to a structure.
04362 
04363 Return Value:
04364 
04365     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> code that indicates whether or not <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function was successful.
04366 
04367 --*/
04368 {
04369     <a class="code" href="../../d3/d8/struct__ARBITER__PARAMETERS.html">ARBITER_PARAMETERS</a> parameters;
04370     <a class="code" href="../../d9/d7/struct__ARBITER__INTERFACE.html">PARBITER_INTERFACE</a> arbiterInterface = ArbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o2">ArbiterInterface</a>;
04371     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
04372     <a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html">PARBITER_LIST_ENTRY</a> arbiterListEntry;
04373     LIST_ENTRY listHead;
04374     PVOID *ExtParams;
04375 
04376     <span class="keywordflow">switch</span> (Command) {
04377     <span class="keywordflow">case</span> <a class="code" href="../../d6/d9/pnp_8h.html#a173a115">ArbiterActionTestAllocation</a>:
04378     <span class="keywordflow">case</span> <a class="code" href="../../d6/d9/pnp_8h.html#a173a116">ArbiterActionRetestAllocation</a>:
04379 
04380         <span class="comment">//</span>
04381         <span class="comment">// For ArbiterActionTestAllocation, the Input is a pointer to the doubly</span>
04382         <span class="comment">// linked list of ARBITER_LIST_ENTRY's.</span>
04383         <span class="comment">//</span>
04384 
04385         parameters.<a class="code" href="../../d3/d8/struct__ARBITER__PARAMETERS.html#o17">Parameters</a>.TestAllocation.ArbitrationList = (PLIST_ENTRY)Input1;
04386         parameters.<a class="code" href="../../d3/d8/struct__ARBITER__PARAMETERS.html#o17">Parameters</a>.TestAllocation.AllocateFromCount = (ULONG)((ULONG_PTR)Input2);
04387         parameters.<a class="code" href="../../d3/d8/struct__ARBITER__PARAMETERS.html#o17">Parameters</a>.TestAllocation.AllocateFrom =
04388                                             (PCM_PARTIAL_RESOURCE_DESCRIPTOR)Input3;
04389         status = (arbiterInterface-&gt;<a class="code" href="../../d9/d7/struct__ARBITER__INTERFACE.html#o5">ArbiterHandler</a>)(
04390                       arbiterInterface-&gt;<a class="code" href="../../d9/d7/struct__ARBITER__INTERFACE.html#o2">Context</a>,
04391                       Command,
04392                       &amp;parameters
04393                       );
04394         <span class="keywordflow">break</span>;
04395 
04396     <span class="keywordflow">case</span> <a class="code" href="../../d6/d9/pnp_8h.html#a173a124">ArbiterActionBootAllocation</a>:
04397 
04398         <span class="comment">//</span>
04399         <span class="comment">// For ArbiterActionBootAllocation, the input is a pointer to the doubly</span>
04400         <span class="comment">// linked list of ARBITER_LIST_ENTRY'S.</span>
04401         <span class="comment">//</span>
04402 
04403         parameters.<a class="code" href="../../d3/d8/struct__ARBITER__PARAMETERS.html#o17">Parameters</a>.BootAllocation.ArbitrationList = (PLIST_ENTRY)Input1;
04404 
04405         status = (arbiterInterface-&gt;<a class="code" href="../../d9/d7/struct__ARBITER__INTERFACE.html#o5">ArbiterHandler</a>)(
04406                       arbiterInterface-&gt;<a class="code" href="../../d9/d7/struct__ARBITER__INTERFACE.html#o2">Context</a>,
04407                       Command,
04408                       &amp;parameters
04409                       );
04410         <span class="keywordflow">break</span>;
04411 
04412     <span class="keywordflow">case</span> <a class="code" href="../../d6/d9/pnp_8h.html#a173a122">ArbiterActionQueryArbitrate</a>:
04413 
04414         <span class="comment">//</span>
04415         <span class="comment">// For QueryArbiter, the input is a pointer to REQ_DESC</span>
04416         <span class="comment">//</span>
04417 
04418         arbiterListEntry = &amp;((<a class="code" href="../../d5/d1/pnpres_8c.html#a28">PREQ_DESC</a>)Input1)-&gt;AlternativeTable;
04419         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(IsListEmpty(&amp;arbiterListEntry-&gt;<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o0">ListEntry</a>));
04420         listHead = arbiterListEntry-&gt;<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o0">ListEntry</a>;
04421         arbiterListEntry-&gt;<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o0">ListEntry</a>.Flink = arbiterListEntry-&gt;<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o0">ListEntry</a>.Blink = &amp;listHead;
04422         parameters.<a class="code" href="../../d3/d8/struct__ARBITER__PARAMETERS.html#o17">Parameters</a>.QueryArbitrate.ArbitrationList = &amp;listHead;
04423         status = (arbiterInterface-&gt;<a class="code" href="../../d9/d7/struct__ARBITER__INTERFACE.html#o5">ArbiterHandler</a>)(
04424                       arbiterInterface-&gt;<a class="code" href="../../d9/d7/struct__ARBITER__INTERFACE.html#o2">Context</a>,
04425                       Command,
04426                       &amp;parameters
04427                       );
04428         arbiterListEntry-&gt;<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o0">ListEntry</a> = listHead;
04429         <span class="keywordflow">break</span>;
04430 
04431     <span class="keywordflow">case</span> <a class="code" href="../../d6/d9/pnp_8h.html#a173a117">ArbiterActionCommitAllocation</a>:
04432     <span class="keywordflow">case</span> <a class="code" href="../../d6/d9/pnp_8h.html#a173a118">ArbiterActionRollbackAllocation</a>:
04433     <span class="keywordflow">case</span> <a class="code" href="../../d6/d9/pnp_8h.html#a173a120">ArbiterActionWriteReservedResources</a>:
04434 
04435         <span class="comment">//</span>
04436         <span class="comment">// Commit, Rollback and WriteReserved do not have parmater.</span>
04437         <span class="comment">//</span>
04438 
04439         status = (arbiterInterface-&gt;<a class="code" href="../../d9/d7/struct__ARBITER__INTERFACE.html#o5">ArbiterHandler</a>)(
04440                       arbiterInterface-&gt;<a class="code" href="../../d9/d7/struct__ARBITER__INTERFACE.html#o2">Context</a>,
04441                       Command,
04442                       <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
04443                       );
04444         <span class="keywordflow">break</span>;
04445 
04446     <span class="keywordflow">case</span> <a class="code" href="../../d6/d9/pnp_8h.html#a173a119">ArbiterActionQueryAllocatedResources</a>:
04447         status = STATUS_NOT_IMPLEMENTED;
04448         <span class="keywordflow">break</span>;
04449 
04450     <span class="keywordflow">case</span> <a class="code" href="../../d6/d9/pnp_8h.html#a173a121">ArbiterActionQueryConflict</a>:
04451         <span class="comment">//</span>
04452         <span class="comment">// For QueryConflict</span>
04453         <span class="comment">// Ex0 is PDO</span>
04454         <span class="comment">// Ex1 is PIO_RESOURCE_DESCRIPTOR</span>
04455         <span class="comment">// Ex2 is PULONG</span>
04456         <span class="comment">// Ex3 is PARBITER_CONFLICT_INFO *</span>
04457         ExtParams = (PVOID*)Input1;
04458 
04459         parameters.<a class="code" href="../../d3/d8/struct__ARBITER__PARAMETERS.html#o17">Parameters</a>.QueryConflict.PhysicalDeviceObject = (<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>)ExtParams[0];
04460         parameters.<a class="code" href="../../d3/d8/struct__ARBITER__PARAMETERS.html#o17">Parameters</a>.QueryConflict.ConflictingResource = (PIO_RESOURCE_DESCRIPTOR)ExtParams[1];
04461         parameters.<a class="code" href="../../d3/d8/struct__ARBITER__PARAMETERS.html#o17">Parameters</a>.QueryConflict.ConflictCount = (PULONG)ExtParams[2];
04462         parameters.<a class="code" href="../../d3/d8/struct__ARBITER__PARAMETERS.html#o17">Parameters</a>.QueryConflict.Conflicts = (<a class="code" href="../../d7/d7/struct__ARBITER__CONFLICT__INFO.html">PARBITER_CONFLICT_INFO</a> *)ExtParams[3];
04463         status = (arbiterInterface-&gt;<a class="code" href="../../d9/d7/struct__ARBITER__INTERFACE.html#o5">ArbiterHandler</a>)(
04464                       arbiterInterface-&gt;<a class="code" href="../../d9/d7/struct__ARBITER__INTERFACE.html#o2">Context</a>,
04465                       Command,
04466                       &amp;parameters
04467                       );
04468         <span class="keywordflow">break</span>;
04469 
04470     <span class="keywordflow">default</span>:
04471         status = STATUS_INVALID_PARAMETER;
04472         <span class="keywordflow">break</span>;
04473     }
04474 
04475     <span class="keywordflow">return</span> status;
04476 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a99" doxytag="pnpres.c::IopCheckDataStructures" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopCheckDataStructures           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>DeviceNode</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l07662">7662</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.
<p>
References <a class="el" href="../../d6/d0/pnpres_8c-source.html#l07674">IopCheckDataStructuresWorker()</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l03292">IopAssignInner()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l08336">IopQueryConflictListInternal()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l05215">IopRebalance()</a>, and <a class="el" href="../../d6/d0/pnpres_8c-source.html#l03376">IopReserve()</a>.
<p>
<pre class="fragment"><div>07666 {
07667     <span class="keywordflow">if</span> (DeviceNode) {
07668         <a class="code" href="../../d5/d1/pnpres_8c.html#a100">IopCheckDataStructuresWorker</a> (DeviceNode);
07669         <a class="code" href="../../d5/d1/pnpres_8c.html#a99">IopCheckDataStructures</a> (DeviceNode-&gt;Sibling);
07670         <a class="code" href="../../d5/d1/pnpres_8c.html#a99">IopCheckDataStructures</a> (DeviceNode-&gt;Child);
07671     }
07672 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a100" doxytag="pnpres.c::IopCheckDataStructuresWorker" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopCheckDataStructuresWorker           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Device</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l07674">7674</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.
<p>
References <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00713">_PI_RESOURCE_ARBITER_ENTRY::ActiveArbiterList</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00709">_PI_RESOURCE_ARBITER_ENTRY::ArbiterInterface</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00710">_PI_RESOURCE_ARBITER_ENTRY::ResourceList</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l07662">IopCheckDataStructures()</a>.
<p>
<pre class="fragment"><div>07680                    :
07681 
07682     This routine releases <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> assigned resources <span class="keywordflow">for</span> device specified by DeviceNode.
07683     Note, <span class="keyword">this</span> routine does not reset <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resource related fields in DeviceNode structure.
07684 
07685 Parameters:
07686 
07687     DeviceNode - specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device node whose resources are goint to be released.
07688 
07689 Return Value:
07690 
07691     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> code that indicates whether or not <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function was successful.
07692 
07693 --*/
07694 
07695 {
07696     PLIST_ENTRY listHead, listEntry;
07697     <a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html">PPI_RESOURCE_ARBITER_ENTRY</a> arbiterEntry;
07698 
07699     listHead = &amp;Device-&gt;DeviceArbiterList;
07700     listEntry = listHead-&gt;Flink;
07701     <span class="keywordflow">while</span> (listEntry != listHead) {
07702         arbiterEntry = CONTAINING_RECORD(listEntry, <a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html">PI_RESOURCE_ARBITER_ENTRY</a>, DeviceArbiterList);
07703         <span class="keywordflow">if</span> (arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o2">ArbiterInterface</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
07704             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(IsListEmpty(&amp;arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o3">ResourceList</a>));
07705             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(IsListEmpty(&amp;arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o6">ActiveArbiterList</a>));
07706             InitializeListHead(&amp;arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o6">ActiveArbiterList</a>);
07707             InitializeListHead(&amp;arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o3">ResourceList</a>);
07708         }
07709         listEntry = listEntry-&gt;Flink;
07710     }
07711 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a77" doxytag="pnpres.c::IopChildToRootTranslation" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopChildToRootTranslation           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceNode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OPTIONAL IN INTERFACE_TYPE&nbsp;</td>
          <td class="mdname" nowrap> <em>InterfaceType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>BusNumber</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d6/d9/pnp_8h.html#a58">ARBITER_REQUEST_SOURCE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ArbiterRequestSource</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PCM_PARTIAL_RESOURCE_DESCRIPTOR&nbsp;</td>
          <td class="mdname" nowrap> <em>Source</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PCM_PARTIAL_RESOURCE_DESCRIPTOR *&nbsp;</td>
          <td class="mdname" nowrap> <em>Target</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l03933">3933</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.
<p>
References <a class="el" href="../../d6/d9/pnp_8h.html#a174a127">ArbiterRequestHalReported</a>, <a class="el" href="../../d3/d6/hal_8h-source.html#l01170">BusNumber</a>, <a class="el" href="../../d7/d8/pnp_8h-source.html#l00891">_TRANSLATOR_INTERFACE::Context</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00246">_DEVICE_NODE::DeviceTranslatorList</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00281">PNPRESDEBUGTRANSLATIONFAILURE::devnode</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00066">ExAllocatePoolPRD</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d0/d1/fedefs_8h-source.html#l00051">exit</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d9/cmconfig_8c-source.html#l00050">InterfaceType</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l06408">IopFindBusDeviceNode()</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00056">IopRootDeviceNode</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00105">_DEVICE_NODE::Parent</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00273">PnpResDebugLevel</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00287">PnpResDebugTranslationFailure</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00285">PnpResDebugTranslationFailureCount</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00282">PNPRESDEBUGTRANSLATIONFAILURE::resource</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00731">_PI_RESOURCE_TRANSLATOR_ENTRY::ResourceType</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00270">STOP_ERROR</a>, <a class="el" href="../../d6/d9/pnp_8h.html#a176a135">TranslateChildToParent</a>, <a class="el" href="../../d7/d8/pnp_8h-source.html#l00894">_TRANSLATOR_INTERFACE::TranslateResources</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00732">_PI_RESOURCE_TRANSLATOR_ENTRY::TranslatorInterface</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l02034">IopBuildCmResourceList()</a>.
<p>
<pre class="fragment"><div>03944                    :
03945 
03946     This routine translates a CmPartialResourceDescriptors from
03947     their intermediate translated form to their <span class="keyword">final</span> translated form.
03948     The translated CM_PARTIAL_RESOURCE_DESCRIPTOR <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned via Target variable.
03949 
03950     The caller <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> responsible to release <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> translated descriptor.
03951 
03952 Parameters:
03953 
03954     DeviceNode - Specified <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device object.  If The DeviceNode <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> specified,
03955                  <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d4/d0/cmconfig_8c.html#a5">InterfaceType</a> and <a class="code" href="../../d2/d7/hal_8h.html#a75">BusNumber</a> are ignored and we will
03956                  use DeviceNode as a starting point to find various translators to
03957                  translate <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Source descriptor.  If DeviceNode <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not specified,
03958                  <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d4/d0/cmconfig_8c.html#a5">InterfaceType</a> and <a class="code" href="../../d2/d7/hal_8h.html#a75">BusNumber</a> must be specified.
03959 
03960     <a class="code" href="../../d4/d0/cmconfig_8c.html#a5">InterfaceType</a>, <a class="code" href="../../d2/d7/hal_8h.html#a75">BusNumber</a> - must be supplied <span class="keywordflow">if</span> DeviceNode <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not specified.
03961 
03962     Source - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resource descriptor to be translated.
03963 
03964     Target - Supplies an address to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> translated resource descriptor.
03965 
03966 Return Value:
03967 
03968     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> code that indicates whether or not <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function was successful.
03969 
03970 --*/
03971 {
03972     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode;
03973     PLIST_ENTRY listHead, nextEntry;
03974     PCM_PARTIAL_RESOURCE_DESCRIPTOR target, source, tmp;
03975     <a class="code" href="../../d8/d5/struct__PI__RESOURCE__TRANSLATOR__ENTRY.html">PPI_RESOURCE_TRANSLATOR_ENTRY</a> translatorEntry;
03976     <a class="code" href="../../d3/d2/struct__TRANSLATOR__INTERFACE.html">PTRANSLATOR_INTERFACE</a> translator;
03977     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status = STATUS_SUCCESS;
03978     BOOLEAN done = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, foundTranslator = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, restartedAlready;
03979 
03980     <span class="keywordflow">if</span> (ArbiterRequestSource == <a class="code" href="../../d6/d9/pnp_8h.html#a174a127">ArbiterRequestHalReported</a>) {
03981        restartedAlready = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03982     } <span class="keywordflow">else</span> {
03983        restartedAlready = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03984     }
03985 
03986     source = (PCM_PARTIAL_RESOURCE_DESCRIPTOR) <a class="code" href="../../d5/d1/pnpres_8c.html#a7">ExAllocatePoolPRD</a>(
03987                          PagedPool,
03988                          <span class="keyword">sizeof</span>(CM_PARTIAL_RESOURCE_DESCRIPTOR)
03989                          );
03990     <span class="keywordflow">if</span> (source == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03991         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
03992     }
03993     target = (PCM_PARTIAL_RESOURCE_DESCRIPTOR) <a class="code" href="../../d5/d1/pnpres_8c.html#a7">ExAllocatePoolPRD</a>(
03994                          PagedPool,
03995                          <span class="keyword">sizeof</span>(CM_PARTIAL_RESOURCE_DESCRIPTOR)
03996                          );
03997     <span class="keywordflow">if</span> (target == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03998         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(source);
03999         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
04000     }
04001     *source = *Source;
04002 
04003     <span class="comment">//</span>
04004     <span class="comment">// Move up to current device node's parent to start translation</span>
04005     <span class="comment">//</span>
04006 
04007     <span class="keywordflow">if</span> (!ARGUMENT_PRESENT(DeviceNode)) {
04008         deviceNode = <a class="code" href="../../d5/d1/pnpres_8c.html#a108">IopFindBusDeviceNode</a> (IopRootDeviceNode, InterfaceType, BusNumber, 0);
04009     } <span class="keywordflow">else</span> {
04010         <span class="comment">// We want to start with the deviceNode instead of its parent.  Because the</span>
04011         <span class="comment">// deviceNode may provide a translator interface.</span>
04012         deviceNode = DeviceNode;
04013     }
04014     <span class="keywordflow">while</span> (deviceNode &amp;&amp; !done) {
04015 
04016         <span class="keywordflow">if</span> ((deviceNode == <a class="code" href="../../d1/d0/pnpdata_8c.html#a5">IopRootDeviceNode</a>) &amp;&amp; (foundTranslator == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
04017             <span class="keywordflow">if</span> (restartedAlready == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
04018                 restartedAlready = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04019                 deviceNode = <a class="code" href="../../d5/d1/pnpres_8c.html#a108">IopFindBusDeviceNode</a> (IopRootDeviceNode, InterfaceType, BusNumber, 0);
04020 
04021                 <span class="comment">//</span>
04022                 <span class="comment">// If we did not find a PDO, try again with InterfaceType == Isa. This allows</span>
04023                 <span class="comment">// drivers that request Internal to get resources even if there is no PDO</span>
04024                 <span class="comment">// that is Internal. (but if there is an Internal PDO, they get that one)</span>
04025                 <span class="comment">//</span>
04026 
04027                 <span class="keywordflow">if</span> ((deviceNode == <a class="code" href="../../d1/d0/pnpdata_8c.html#a5">IopRootDeviceNode</a>) &amp;&amp; (<a class="code" href="../../d4/d0/cmconfig_8c.html#a5">InterfaceType</a> == Internal)) {
04028                     deviceNode = <a class="code" href="../../d5/d1/pnpres_8c.html#a108">IopFindBusDeviceNode</a>(IopRootDeviceNode, Isa, 0, 0);
04029                 }
04030 
04031                 <span class="keywordflow">continue</span>;
04032             }
04033         }
04034         <span class="comment">//</span>
04035         <span class="comment">// First, check if there is a translator for the device node?</span>
04036         <span class="comment">// If yes, translate the req desc and link it to the front of ReqDesc-&gt;TranslatedReqDesc</span>
04037         <span class="comment">// else do nothing.</span>
04038         <span class="comment">//</span>
04039 
04040         listHead = &amp;deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o25">DeviceTranslatorList</a>;
04041         nextEntry = listHead-&gt;Flink;
04042         <span class="keywordflow">for</span> (; nextEntry != listHead; nextEntry = nextEntry-&gt;Flink) {
04043             translatorEntry = CONTAINING_RECORD(nextEntry, <a class="code" href="../../d8/d5/struct__PI__RESOURCE__TRANSLATOR__ENTRY.html">PI_RESOURCE_TRANSLATOR_ENTRY</a>, DeviceTranslatorList);
04044             <span class="keywordflow">if</span> (translatorEntry-&gt;<a class="code" href="../../d8/d5/struct__PI__RESOURCE__TRANSLATOR__ENTRY.html#o1">ResourceType</a> == Source-&gt;Type) {
04045                 <span class="keywordflow">if</span> (translator = translatorEntry-&gt;<a class="code" href="../../d8/d5/struct__PI__RESOURCE__TRANSLATOR__ENTRY.html#o2">TranslatorInterface</a>) {
04046 
04047                     <span class="comment">//</span>
04048                     <span class="comment">// Find a translator to translate the req desc ... Translate it and link it to</span>
04049                     <span class="comment">// the front of ReqDesc-&gt;TranslatedReqDesc.</span>
04050                     <span class="comment">//</span>
04051 
04052 doitagain:
04053                     status = (translator-&gt;<a class="code" href="../../d3/d2/struct__TRANSLATOR__INTERFACE.html#o5">TranslateResources</a>) (
04054                                   translator-&gt;<a class="code" href="../../d3/d2/struct__TRANSLATOR__INTERFACE.html#o2">Context</a>,
04055                                   source,
04056                                   <a class="code" href="../../d6/d9/pnp_8h.html#a176a135">TranslateChildToParent</a>,
04057                                   0,
04058                                   <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
04059                                   DeviceNode ? DeviceNode-&gt;PhysicalDeviceObject : <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
04060                                   target
04061                                   );
04062                     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04063                         tmp = source;
04064                         source = target;
04065                         target = tmp;
04066 
04067                         <span class="comment">//</span>
04068                         <span class="comment">// If the translator is non-hierarchial and performs a complete</span>
04069                         <span class="comment">// translation to root (eg ISA interrups for PCI devices) then</span>
04070                         <span class="comment">// don't pass translations to parent.</span>
04071                         <span class="comment">//</span>
04072 
04073                         <span class="keywordflow">if</span> (status == STATUS_TRANSLATION_COMPLETE) {
04074                             done = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04075                         }
04076 
04077                     } <span class="keywordflow">else</span> {
04078 <span class="preprocessor">#if DBG_SCOPE</span>
04079 <span class="preprocessor"></span>                        <span class="comment">// DebugMessage(DUMP_ERROR, ("PnpRes: Child to Root Translation failed\n"));</span>
04080                         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"PnpRes: Child to Root Translation failed\n"</span>);
04081                         <span class="keywordflow">if</span> (DeviceNode) {
04082                             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(
04083                                 <span class="stringliteral">"        DeviceNode %08x (PDO %08x)\n"</span>,
04084                                 DeviceNode,
04085                                 DeviceNode-&gt;PhysicalDeviceObject
04086                                 );
04087                         }
04088                         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(
04089                             <span class="stringliteral">"        Resource Type %02x Data %08x %08x %08x\n"</span>,
04090                             source-&gt;Type,
04091                             source-&gt;u.DevicePrivate.Data[0],
04092                             source-&gt;u.DevicePrivate.Data[1],
04093                             source-&gt;u.DevicePrivate.Data[2]
04094                             );
04095                         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d1/pnpres_8c.html#a48">PnpResDebugTranslationFailureCount</a>) {
04096                             <a class="code" href="../../d5/d1/pnpres_8c.html#a48">PnpResDebugTranslationFailureCount</a>--;
04097                             <a class="code" href="../../d5/d1/pnpres_8c.html#a50">PnpResDebugTranslationFailure</a>-&gt;<a class="code" href="../../d3/d5/structPNPRESDEBUGTRANSLATIONFAILURE.html#o0">devnode</a> = DeviceNode;
04098                             <a class="code" href="../../d5/d1/pnpres_8c.html#a50">PnpResDebugTranslationFailure</a>-&gt;<a class="code" href="../../d3/d5/structPNPRESDEBUGTRANSLATIONFAILURE.html#o1">resource</a> = *source;
04099                             <a class="code" href="../../d5/d1/pnpres_8c.html#a50">PnpResDebugTranslationFailure</a>++;
04100                         }
04101                         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d1/pnpres_8c.html#a47">PnpResDebugLevel</a> &amp; <a class="code" href="../../d5/d1/pnpres_8c.html#a26">STOP_ERROR</a>) {
04102                             DbgBreakPoint();
04103                             <span class="keywordflow">goto</span> doitagain;
04104                         }
04105 <span class="preprocessor">#endif</span>
04106 <span class="preprocessor"></span>                        <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
04107                     }
04108                 }
04109                 <span class="keywordflow">break</span>;
04110             }
04111         }
04112 
04113         <span class="comment">//</span>
04114         <span class="comment">// Move up to current device node's parent</span>
04115         <span class="comment">//</span>
04116 
04117         deviceNode = deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o2">Parent</a>;
04118     }
04119     *Target = source;
04120     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(target);
04121     <span class="keywordflow">return</span> status;
04122 <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>:
04123     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(source);
04124     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(target);
04125     <span class="keywordflow">return</span> status;
04126 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a52" doxytag="pnpres.c::IopCombineCmResourceList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PCM_RESOURCE_LIST IopCombineCmResourceList           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PCM_RESOURCE_LIST&nbsp;</td>
          <td class="mdname" nowrap> <em>ResourceListA</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PCM_RESOURCE_LIST&nbsp;</td>
          <td class="mdname" nowrap> <em>ResourceListB</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l06955">6955</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.
<p>
References <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00072">ExAllocatePoolIORRR</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l03523">IopDetermineResourceListSize()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l06996">IopReserveLegacyBootResources()</a>.
<p>
<pre class="fragment"><div>06959 {
06960     PCM_RESOURCE_LIST newList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
06961     ULONG   sizeA, sizeB, size;
06962 
06963     <span class="keywordflow">if</span> (ResourceListA == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
06964 
06965         <span class="keywordflow">return</span> ResourceListB;
06966 
06967     }
06968 
06969     <span class="keywordflow">if</span> (ResourceListB == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
06970 
06971         <span class="keywordflow">return</span> ResourceListA;
06972 
06973     }
06974 
06975     sizeA = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a21">IopDetermineResourceListSize</a>(ResourceListA);
06976     sizeB = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a21">IopDetermineResourceListSize</a>(ResourceListB);
06977 
06978     <span class="keywordflow">if</span> (sizeA &amp;&amp; sizeB) {
06979 
06980         size = sizeA + sizeB - (<span class="keyword">sizeof</span>(CM_RESOURCE_LIST) - <span class="keyword">sizeof</span>(CM_FULL_RESOURCE_DESCRIPTOR));
06981         newList = (PCM_RESOURCE_LIST)<a class="code" href="../../d5/d1/pnpres_8c.html#a13">ExAllocatePoolIORRR</a>(PagedPool, size);
06982         <span class="keywordflow">if</span> (newList) {
06983 
06984             RtlMoveMemory(newList, ResourceListA, sizeA);
06985             RtlMoveMemory(  (PUCHAR)newList + sizeA,
06986                             (PUCHAR)ResourceListB + (<span class="keyword">sizeof</span>(CM_RESOURCE_LIST) - <span class="keyword">sizeof</span>(CM_FULL_RESOURCE_DESCRIPTOR)),
06987                             sizeB - (<span class="keyword">sizeof</span>(CM_RESOURCE_LIST) - <span class="keyword">sizeof</span>(CM_FULL_RESOURCE_DESCRIPTOR)));
06988             newList-&gt;Count += ResourceListB-&gt;Count;
06989         }
06990     }
06991 
06992     <span class="keywordflow">return</span> newList;
06993 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a91" doxytag="pnpres.c::IopCombineLegacyResources" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PCM_RESOURCE_LIST IopCombineLegacyResources           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>DeviceNode</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l06726">6726</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.
<p>
References <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00062">ExAllocatePoolCMRL</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l03523">IopDetermineResourceListSize()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html#o34">_DEVICE_NODE::OverUsed2</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, and <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00161">_DEVICE_NODE::ResourceList</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l06180">IopLegacyResourceAllocation()</a>.
<p>
<pre class="fragment"><div>06732                    :
06733 
06734     This routine sets <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Root\Legacy_xxxx\0000 device instance <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a> to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
06735     madeup PDO (i.e. DeviceNode) which is created only for legacy resource allocation.
06736     This routine also links the madeup PDO to the Root\Legacy_xxxx\0000 device node
06737     to keep track what resources are assigned to the driver which services the
06738     root\legacy_xxxx\0000 device.
06739 
06740 Parameters:
06741 
06742     DeviceNode - The legacy device node whose resources need to be combined.
06743 
06744 Return Value:
06745 
06746     Return the combined resource list.
06747 
06748 --*/
06749 
06750 {
06751     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
06752     PCM_RESOURCE_LIST combinedList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
06753     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> devNode = DeviceNode;
06754     ULONG size = 0;
06755     PUCHAR p;
06756 
06757     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
06758 
06759     <span class="keywordflow">if</span> (DeviceNode) {
06760 
06761         <span class="comment">//</span>
06762         <span class="comment">// First determine how much memory is needed for the new combined list.</span>
06763         <span class="comment">//</span>
06764 
06765         <span class="keywordflow">while</span> (devNode) {
06766             <span class="keywordflow">if</span> (devNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o10">ResourceList</a>) {
06767                 size += <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a21">IopDetermineResourceListSize</a>(devNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o10">ResourceList</a>);
06768             }
06769             devNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)devNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o34">OverUsed2</a>.NextResourceDeviceNode;
06770         }
06771         <span class="keywordflow">if</span> (size != 0) {
06772             combinedList = (PCM_RESOURCE_LIST) <a class="code" href="../../d5/d1/pnpres_8c.html#a3">ExAllocatePoolCMRL</a>(PagedPool, size);
06773             devNode = DeviceNode;
06774             <span class="keywordflow">if</span> (combinedList) {
06775                 combinedList-&gt;Count = 0;
06776                 p = (PUCHAR)combinedList;
06777                 p += <span class="keyword">sizeof</span>(ULONG);  <span class="comment">// Skip Count</span>
06778                 <span class="keywordflow">while</span> (devNode) {
06779                     <span class="keywordflow">if</span> (devNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o10">ResourceList</a>) {
06780                         size = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a21">IopDetermineResourceListSize</a>(devNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o10">ResourceList</a>);
06781                         <span class="keywordflow">if</span> (size != 0) {
06782                             size -= <span class="keyword">sizeof</span>(ULONG);
06783                             RtlMoveMemory(
06784                                 p,
06785                                 devNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o10">ResourceList</a>-&gt;List,
06786                                 size
06787                                 );
06788                             p += size;
06789                             combinedList-&gt;Count += devNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o10">ResourceList</a>-&gt;Count;
06790                         }
06791                     }
06792                     devNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)devNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o34">OverUsed2</a>.NextResourceDeviceNode;
06793                 }
06794             }
06795         }
06796     }
06797     <span class="keywordflow">return</span> combinedList;
06798 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a106" doxytag="pnpres.c::IopCompareAlternativeCount" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> int __cdecl IopCompareAlternativeCount           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">const void *&nbsp;</td>
          <td class="mdname" nowrap> <em>arg1</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>const void *&nbsp;</td>
          <td class="mdname" nowrap> <em>arg2</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l01767">1767</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.
<p>
References <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00768">_IOP_RESOURCE_REQUEST::Priority</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l01878">IopRearrangeAssignTable()</a>.
<p>
<pre class="fragment"><div>01774                    :
01775 
01776     This routine compares <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> priority of arg1 and arg1.  It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used in C run time sort.
01777 
01778 Parameters:
01779 
01780     Arg1, arg2 - a pointer to <a class="code" href="../../d5/d1/pnpres_8c.html#a29">PREQ_ALTERNATIVE</a>
01781 
01782 Return Value:
01783 
01784     &lt; 0 <span class="keywordflow">if</span> arg1 &lt; arg2
01785     = 0 <span class="keywordflow">if</span> arg1 = arg2
01786     &gt; 0 <span class="keywordflow">if</span> arg1 &gt; arg2
01787 
01788 --*/
01789 
01790 {
01791     <a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a> RR1 = (<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a>)arg1;
01792     <a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a> RR2 = (<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a>)arg2;
01793 
01794     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01795 
01796     <span class="keywordflow">if</span> (RR1-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o3">Priority</a> == RR2-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o3">Priority</a>) {
01797         <span class="keywordflow">if</span> ((ULONG_PTR)RR1 &lt; (ULONG_PTR)RR2) {
01798             <span class="keywordflow">return</span> -1;
01799         } <span class="keywordflow">else</span> {
01800             <span class="keywordflow">return</span> 1;
01801         }
01802     }
01803     <span class="keywordflow">if</span> (RR1-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o3">Priority</a> &gt; RR2-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o3">Priority</a>) {
01804         <span class="keywordflow">return</span> 1;
01805     } <span class="keywordflow">else</span> {
01806         <span class="keywordflow">return</span> -1;
01807     }
01808 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a60" doxytag="pnpres.c::IopComparePriority" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> int __cdecl IopComparePriority           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">const void *&nbsp;</td>
          <td class="mdname" nowrap> <em>arg1</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>const void *&nbsp;</td>
          <td class="mdname" nowrap> <em>arg2</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l01723">1723</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.
<p>
References <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00081">PREQ_ALTERNATIVE</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l01811">IopRearrangeReqList()</a>.
<p>
<pre class="fragment"><div>01730                    :
01731 
01732     This routine compares <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> priority of arg1 and arg1.  It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used in C run time sort.
01733 
01734 Parameters:
01735 
01736     Arg1, arg2 - a pointer to <a class="code" href="../../d5/d1/pnpres_8c.html#a29">PREQ_ALTERNATIVE</a>
01737 
01738 Return Value:
01739 
01740     &lt; 0 <span class="keywordflow">if</span> arg1 &lt; arg2
01741     = 0 <span class="keywordflow">if</span> arg1 = arg2
01742     &gt; 0 <span class="keywordflow">if</span> arg1 &gt; arg2
01743 
01744 --*/
01745 
01746 {
01747     <a class="code" href="../../d5/d1/pnpres_8c.html#a29">PREQ_ALTERNATIVE</a> RA1 = *(<a class="code" href="../../d5/d1/pnpres_8c.html#a29">PREQ_ALTERNATIVE</a> *)arg1;
01748     <a class="code" href="../../d5/d1/pnpres_8c.html#a29">PREQ_ALTERNATIVE</a> RA2 = *(<a class="code" href="../../d5/d1/pnpres_8c.html#a29">PREQ_ALTERNATIVE</a> *)arg2;
01749 
01750     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01751 
01752     <span class="keywordflow">if</span> (RA1-&gt;Priority == RA2-&gt;Priority) {
01753         <span class="keywordflow">if</span> ((ULONG_PTR)RA1 &lt; (ULONG_PTR)RA2) {
01754             <span class="keywordflow">return</span> -1;
01755         } <span class="keywordflow">else</span> {
01756             <span class="keywordflow">return</span> 1;
01757         }
01758     }
01759     <span class="keywordflow">if</span> (RA1-&gt;Priority &gt; RA2-&gt;Priority) {
01760         <span class="keywordflow">return</span> 1;
01761     } <span class="keywordflow">else</span> {
01762         <span class="keywordflow">return</span> -1;
01763     }
01764 }
<span class="keywordtype">int</span>
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a51" doxytag="pnpres.c::IopCreateCmResourceList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PCM_RESOURCE_LIST IopCreateCmResourceList           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PCM_RESOURCE_LIST&nbsp;</td>
          <td class="mdname" nowrap> <em>ResourceList</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN INTERFACE_TYPE&nbsp;</td>
          <td class="mdname" nowrap> <em>InterfaceType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>BusNumber</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PCM_RESOURCE_LIST *&nbsp;</td>
          <td class="mdname" nowrap> <em>RemainingList</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l06801">6801</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.
<p>
References <a class="el" href="../../d3/d6/hal_8h-source.html#l01170">BusNumber</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00072">ExAllocatePoolIORRR</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d5/d9/cmconfig_8c-source.html#l00050">InterfaceType</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00094">List</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l06996">IopReserveLegacyBootResources()</a>.
<p>
<pre class="fragment"><div>06807 {
06808     PCM_RESOURCE_LIST               newList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
06809     ULONG                           i, j;
06810     ULONG                           totalSize, matchSize, remainingSize, listSize;
06811     PCM_FULL_RESOURCE_DESCRIPTOR    fullResourceDesc, newFullResourceDesc, remainingFullResourceDesc;
06812     PCM_PARTIAL_RESOURCE_DESCRIPTOR partialDescriptor;
06813 
06814 
06815     <span class="comment">//</span>
06816     <span class="comment">// Determine the size of memory to be allocated for the matching resource list.</span>
06817     <span class="comment">//</span>
06818 
06819     fullResourceDesc = &amp;ResourceList-&gt;List[0];
06820     totalSize = FIELD_OFFSET(CM_RESOURCE_LIST, List);
06821     matchSize = 0;
06822     <span class="keywordflow">for</span> (i = 0; i &lt; ResourceList-&gt;Count; i++) {
06823 
06824         <span class="comment">//</span>
06825         <span class="comment">// Add the size of this descriptor.</span>
06826         <span class="comment">//</span>
06827 
06828         listSize = FIELD_OFFSET(CM_FULL_RESOURCE_DESCRIPTOR,
06829                                 PartialResourceList) +
06830                    FIELD_OFFSET(CM_PARTIAL_RESOURCE_LIST,
06831                                 PartialDescriptors);
06832 
06833         partialDescriptor = &amp;fullResourceDesc-&gt;PartialResourceList.PartialDescriptors[0];
06834         <span class="keywordflow">for</span> (j = 0; j &lt; fullResourceDesc-&gt;PartialResourceList.Count; j++) {
06835 
06836             ULONG descriptorSize = <span class="keyword">sizeof</span>(CM_PARTIAL_RESOURCE_DESCRIPTOR);
06837 
06838             <span class="keywordflow">if</span> (partialDescriptor-&gt;Type == CmResourceTypeDeviceSpecific) {
06839 
06840                 descriptorSize += partialDescriptor-&gt;u.DeviceSpecificData.DataSize;
06841             }
06842 
06843             listSize += descriptorSize;
06844             partialDescriptor = (PCM_PARTIAL_RESOURCE_DESCRIPTOR)
06845                                     ((PUCHAR)partialDescriptor + descriptorSize);
06846 
06847         }
06848 
06849         <span class="keywordflow">if</span> (    fullResourceDesc-&gt;InterfaceType == <a class="code" href="../../d4/d0/cmconfig_8c.html#a5">InterfaceType</a> &amp;&amp;
06850                 fullResourceDesc-&gt;BusNumber == <a class="code" href="../../d2/d7/hal_8h.html#a75">BusNumber</a>) {
06851 
06852 
06853             matchSize += listSize;
06854         }
06855 
06856         totalSize += listSize;
06857         fullResourceDesc = (PCM_FULL_RESOURCE_DESCRIPTOR)
06858                                   ((PUCHAR)fullResourceDesc + listSize);
06859     }
06860 
06861     <span class="keywordflow">if</span> (totalSize) {
06862 
06863         <span class="keywordflow">if</span> (matchSize) {
06864 
06865             matchSize += FIELD_OFFSET(CM_RESOURCE_LIST, List);
06866 
06867         }
06868         <span class="keywordflow">if</span> (matchSize == totalSize) {
06869 
06870             *RemainingList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
06871             newList = ResourceList;
06872 
06873         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (matchSize == 0) {
06874 
06875             *RemainingList = ResourceList;
06876 
06877         } <span class="keywordflow">else</span> {
06878 
06879             <span class="comment">//</span>
06880             <span class="comment">// Allocate memory for both lists.</span>
06881             <span class="comment">//</span>
06882 
06883             newList = (PCM_RESOURCE_LIST)<a class="code" href="../../d5/d1/pnpres_8c.html#a13">ExAllocatePoolIORRR</a>(PagedPool, matchSize);
06884 
06885             <span class="keywordflow">if</span> (newList) {
06886 
06887                 *RemainingList = (PCM_RESOURCE_LIST)<a class="code" href="../../d5/d1/pnpres_8c.html#a13">ExAllocatePoolIORRR</a>(PagedPool, totalSize - matchSize + FIELD_OFFSET(CM_RESOURCE_LIST, List));
06888 
06889                 <span class="keywordflow">if</span> (*RemainingList) {
06890 
06891                     newList-&gt;Count = 0;
06892                     (*RemainingList)-&gt;Count = 0;
06893                     newFullResourceDesc = &amp;newList-&gt;List[0];
06894                     remainingFullResourceDesc = &amp;(*RemainingList)-&gt;List[0];
06895                     fullResourceDesc = &amp;ResourceList-&gt;List[0];
06896                     <span class="keywordflow">for</span> (i = 0; i &lt; ResourceList-&gt;Count; i++) {
06897 
06898                         listSize = FIELD_OFFSET(CM_FULL_RESOURCE_DESCRIPTOR,
06899                                                 PartialResourceList) +
06900                                    FIELD_OFFSET(CM_PARTIAL_RESOURCE_LIST,
06901                                                 PartialDescriptors);
06902 
06903                         partialDescriptor = &amp;fullResourceDesc-&gt;PartialResourceList.PartialDescriptors[0];
06904                         <span class="keywordflow">for</span> (j = 0; j &lt; fullResourceDesc-&gt;PartialResourceList.Count; j++) {
06905 
06906                             ULONG descriptorSize = <span class="keyword">sizeof</span>(CM_PARTIAL_RESOURCE_DESCRIPTOR);
06907 
06908                             <span class="keywordflow">if</span> (partialDescriptor-&gt;Type == CmResourceTypeDeviceSpecific) {
06909 
06910                                 descriptorSize += partialDescriptor-&gt;u.DeviceSpecificData.DataSize;
06911                             }
06912 
06913                             listSize += descriptorSize;
06914                             partialDescriptor = (PCM_PARTIAL_RESOURCE_DESCRIPTOR)
06915                                                     ((PUCHAR)partialDescriptor + descriptorSize);
06916 
06917                         }
06918 
06919                         <span class="keywordflow">if</span> (    fullResourceDesc-&gt;InterfaceType == <a class="code" href="../../d4/d0/cmconfig_8c.html#a5">InterfaceType</a> &amp;&amp;
06920                                 fullResourceDesc-&gt;BusNumber == <a class="code" href="../../d2/d7/hal_8h.html#a75">BusNumber</a>) {
06921 
06922                             newList-&gt;Count++;
06923                             RtlMoveMemory(newFullResourceDesc, fullResourceDesc, listSize);
06924                             newFullResourceDesc = (PCM_FULL_RESOURCE_DESCRIPTOR)
06925                                                           ((PUCHAR)newFullResourceDesc + listSize);
06926                         } <span class="keywordflow">else</span> {
06927 
06928                             (*RemainingList)-&gt;Count++;
06929                             RtlMoveMemory(remainingFullResourceDesc, fullResourceDesc, listSize);
06930                             remainingFullResourceDesc = (PCM_FULL_RESOURCE_DESCRIPTOR)
06931                                                           ((PUCHAR)remainingFullResourceDesc + listSize);
06932                         }
06933 
06934                         fullResourceDesc = (PCM_FULL_RESOURCE_DESCRIPTOR)
06935                                                   ((PUCHAR)fullResourceDesc + listSize);
06936                     }
06937 
06938                 } <span class="keywordflow">else</span> {
06939 
06940                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(newList);
06941                     newList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
06942 
06943                 }
06944 
06945             } <span class="keywordflow">else</span> {
06946 
06947                 *RemainingList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
06948             }
06949         }
06950     }
06951     <span class="keywordflow">return</span> newList;
06952 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a98" doxytag="pnpres.c::IopDumpResourceDescriptor" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopDumpResourceDescriptor           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PUCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>Indent</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PIO_RESOURCE_DESCRIPTOR&nbsp;</td>
          <td class="mdname" nowrap> <em>Desc</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l04533">4533</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.
<p>
References <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l04480">IopDumpResourceRequirementsList()</a>, and <a class="el" href="../../d6/d0/pnpres_8c-source.html#l02649">IopPlacementForReservation()</a>.
<p>
<pre class="fragment"><div>04537 {
04538     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"%sOpt: %x, Share: %x\t"</span>, Indent, Desc-&gt;Option, Desc-&gt;ShareDisposition);
04539     <span class="keywordflow">switch</span> (Desc-&gt;Type) {
04540         <span class="keywordflow">case</span> CmResourceTypePort:
04541             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"IO  Min: %x:%08x, Max: %x:%08x, Algn: %x, Len %x\n"</span>,
04542                 Desc-&gt;u.Port.MinimumAddress.HighPart, Desc-&gt;u.Port.MinimumAddress.LowPart,
04543                 Desc-&gt;u.Port.MaximumAddress.HighPart, Desc-&gt;u.Port.MaximumAddress.LowPart,
04544                 Desc-&gt;u.Port.Alignment,
04545                 Desc-&gt;u.Port.Length
04546                 );
04547             <span class="keywordflow">break</span>;
04548 
04549         <span class="keywordflow">case</span> CmResourceTypeMemory:
04550             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"MEM Min: %x:%08x, Max: %x:%08x, Algn: %x, Len %x\n"</span>,
04551                 Desc-&gt;u.Memory.MinimumAddress.HighPart, Desc-&gt;u.Memory.MinimumAddress.LowPart,
04552                 Desc-&gt;u.Memory.MaximumAddress.HighPart, Desc-&gt;u.Memory.MaximumAddress.LowPart,
04553                 Desc-&gt;u.Memory.Alignment,
04554                 Desc-&gt;u.Memory.Length
04555                 );
04556             <span class="keywordflow">break</span>;
04557 
04558         <span class="keywordflow">case</span> CmResourceTypeInterrupt:
04559             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"INT Min: %x, Max: %x\n"</span>,
04560                 Desc-&gt;u.Interrupt.MinimumVector,
04561                 Desc-&gt;u.Interrupt.MaximumVector
04562                 );
04563             <span class="keywordflow">break</span>;
04564 
04565         <span class="keywordflow">case</span> CmResourceTypeDma:
04566             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"DMA Min: %x, Max: %x\n"</span>,
04567                 Desc-&gt;u.Dma.MinimumChannel,
04568                 Desc-&gt;u.Dma.MaximumChannel
04569                 );
04570             <span class="keywordflow">break</span>;
04571 
04572         <span class="keywordflow">case</span> CmResourceTypeDevicePrivate:
04573             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"DevicePrivate Data: %x, %x, %x\n"</span>,
04574                 Desc-&gt;u.DevicePrivate.Data[0],
04575                 Desc-&gt;u.DevicePrivate.Data[1],
04576                 Desc-&gt;u.DevicePrivate.Data[2]
04577                 );
04578             <span class="keywordflow">break</span>;
04579 
04580         <span class="keywordflow">default</span>:
04581             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"Unknown Descriptor type %x\n"</span>,
04582                 Desc-&gt;Type
04583                 );
04584             <span class="keywordflow">break</span>;
04585     }
04586 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a97" doxytag="pnpres.c::IopDumpResourceRequirementsList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopDumpResourceRequirementsList           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PIO_RESOURCE_REQUIREMENTS_LIST&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>IoResources</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l04480">4480</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.
<p>
References <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l04533">IopDumpResourceDescriptor()</a>, and <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l01066">IopGetResourceRequirementsForAssignTable()</a>, and <a class="el" href="../../d6/d0/pnpres_8c-source.html#l07198">IopReserveBootResourcesInternal()</a>.
<p>
<pre class="fragment"><div>04486                    :
04487 
04488     This routine dumps IoResources
04489 
04490 Parameters:
04491 
04492     IoResources - supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> IO resource requirements list
04493 
04494 Return Value:
04495 
04496     None.
04497 
04498 --*/
04499 
04500 {
04501     PIO_RESOURCE_LIST IoResourceList;
04502     PIO_RESOURCE_DESCRIPTOR IoResourceDescriptor;
04503     PIO_RESOURCE_DESCRIPTOR IoResourceDescriptorEnd;
04504     LONG IoResourceListCount;
04505 
04506     <span class="keywordflow">if</span> (IoResources == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04507         <span class="keywordflow">return</span>;
04508     }
04509     IoResourceList = IoResources-&gt;List;
04510     IoResourceListCount = (LONG) IoResources-&gt;AlternativeLists;
04511     <span class="comment">//</span>
04512     <span class="comment">// For old IO resource requirements list there is no assigned resources associated with</span>
04513     <span class="comment">// it.  We simply free the memory.</span>
04514     <span class="comment">//</span>
04515 
04516     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"** ResReqList: Interface: %x, Bus: %x, Slot: %x, AlternativeLists: %x\n"</span>,
04517              IoResources-&gt;InterfaceType,
04518              IoResources-&gt;BusNumber,
04519              IoResources-&gt;SlotNumber,
04520              IoResources-&gt;AlternativeLists);
04521     <span class="keywordflow">while</span> (--IoResourceListCount &gt;= 0) {
04522         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"  Alternative List: DescCount: %x\n"</span>, IoResourceList-&gt;Count);
04523         IoResourceDescriptor = IoResourceList-&gt;Descriptors;
04524         IoResourceDescriptorEnd = IoResourceDescriptor + IoResourceList-&gt;Count;
04525         <span class="keywordflow">for</span> (; IoResourceDescriptor &lt; IoResourceDescriptorEnd; ++IoResourceDescriptor) {
04526             <a class="code" href="../../d5/d1/pnpres_8c.html#a98">IopDumpResourceDescriptor</a>(<span class="stringliteral">"    "</span>, IoResourceDescriptor);
04527         }
04528         IoResourceList = (PIO_RESOURCE_LIST) IoResourceDescriptorEnd;
04529     }
04530     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n"</span>);
04531 }
<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a109" doxytag="pnpres.c::IopDuplicateDetection" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopDuplicateDetection           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN INTERFACE_TYPE&nbsp;</td>
          <td class="mdname" nowrap> <em>LegacyBusType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>BusNumber</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>SlotNumber</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceNode</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l06528">6528</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.
<p>
References <a class="el" href="../../d3/d6/hal_8h-source.html#l01170">BusNumber</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01943">_INTERFACE::Context</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01274">_DEVOBJ_EXTENSION::DeviceNode</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01210">_DEVICE_OBJECT::DeviceObjectExtension</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01945">_INTERFACE::InterfaceDereference</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l06408">IopFindBusDeviceNode()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l02617">IopQueryResourceHandlerInterface()</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00056">IopRootDeviceNode</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00151">_DEVICE_NODE::PhysicalDeviceObject</a>, and <a class="el" href="../../d9/d0/pnpiop_8h.html#a390a217">ResourceLegacyDeviceDetection</a>.
<p>
Referenced by <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l01548">IoReportDetectedDevice()</a>.
<p>
<pre class="fragment"><div>06537                    :
06538 
06539     This routine searches <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> bus device driver <span class="keywordflow">for</span> a given legacy device,
06540     sends a query interface <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> <span class="keywordflow">for</span> legacy device detection, and <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver
06541     implements <span class="keyword">this</span> interface, requests <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PDO <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> given legacy device.
06542 
06543 Parameters:
06544 
06545     LegacyBusType - The legacy device's interface <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a>.
06546 
06547     <a class="code" href="../../d2/d7/hal_8h.html#a75">BusNumber</a> - The legacy device's bus number.
06548 
06549     SlotNumber - The legacy device's slot number.
06550 
06551     DeviceNode - specifies a pointer to a variable to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> duplicated device node
06552 
06553 Return Value:
06554 
06555     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> code.
06556 
06557 --*/
06558 
06559 {
06560     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode;
06561     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> busDeviceObject;
06562     <a class="code" href="../../d0/d0/struct__LEGACY__DEVICE__DETECTION__INTERFACE.html">PLEGACY_DEVICE_DETECTION_INTERFACE</a> interface;
06563     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
06564     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceObject;
06565 
06566     <span class="comment">//</span>
06567     <span class="comment">// Initialize return parameter to "not found".</span>
06568     <span class="comment">//</span>
06569 
06570     *DeviceNode = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
06571 
06572     <span class="comment">//</span>
06573     <span class="comment">// Search the device tree for the bus of the legacy device.</span>
06574     <span class="comment">//</span>
06575 
06576     deviceNode = <a class="code" href="../../d5/d1/pnpres_8c.html#a108">IopFindBusDeviceNode</a>(
06577                      IopRootDeviceNode,
06578                      LegacyBusType,
06579                      BusNumber,
06580                      SlotNumber
06581                  );
06582 
06583     <span class="comment">//</span>
06584     <span class="comment">// Either a bus driver does not exist (or more likely, the legacy bus</span>
06585     <span class="comment">// type and bus number were unspecified).  Either way, we can't make</span>
06586     <span class="comment">// any further progress.</span>
06587     <span class="comment">//</span>
06588 
06589     <span class="keywordflow">if</span> (deviceNode == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
06590 
06591         <span class="keywordflow">return</span> STATUS_INVALID_DEVICE_REQUEST;
06592 
06593     }
06594 
06595     <span class="comment">//</span>
06596     <span class="comment">// We found the legacy device's bus driver.  Query it to determine</span>
06597     <span class="comment">// whether it implements the LEGACY_DEVICE_DETECTION interface.</span>
06598     <span class="comment">//</span>
06599 
06600     busDeviceObject = deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o9">PhysicalDeviceObject</a>;
06601 
06602     status = <a class="code" href="../../d0/d1/pnpirp_8c.html#a28">IopQueryResourceHandlerInterface</a>(
06603                  ResourceLegacyDeviceDetection,
06604                  busDeviceObject,
06605                  0,
06606                  (<a class="code" href="../../d8/d3/struct__INTERFACE.html">PINTERFACE</a> *)&amp;interface
06607              );
06608 
06609     <span class="comment">//</span>
06610     <span class="comment">// If it doesn't, we're stuck.</span>
06611     <span class="comment">//</span>
06612 
06613     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) || interface == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
06614 
06615         <span class="keywordflow">return</span> STATUS_INVALID_DEVICE_REQUEST;
06616 
06617     }
06618 
06619     <span class="comment">//</span>
06620     <span class="comment">// Invoke the bus driver's legacy device detection method.</span>
06621     <span class="comment">//</span>
06622 
06623     status = (*interface-&gt;<a class="code" href="../../d0/d0/struct__LEGACY__DEVICE__DETECTION__INTERFACE.html#o5">LegacyDeviceDetection</a>)(
06624                  interface-&gt;<a class="code" href="../../d0/d0/struct__LEGACY__DEVICE__DETECTION__INTERFACE.html#o2">Context</a>,
06625                  LegacyBusType,
06626                  <a class="code" href="../../d2/d7/hal_8h.html#a75">BusNumber</a>,
06627                  SlotNumber,
06628                  &amp;deviceObject
06629              );
06630 
06631     <span class="comment">//</span>
06632     <span class="comment">// If it found a legacy device, update the return parameter.</span>
06633     <span class="comment">//</span>
06634 
06635     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) &amp;&amp; deviceObject != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
06636 
06637         *DeviceNode =
06638             (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o6">DeviceNode</a>;
06639 
06640         status = STATUS_SUCCESS;
06641 
06642     } <span class="keywordflow">else</span> {
06643 
06644         status = STATUS_INVALID_DEVICE_REQUEST;
06645 
06646     }
06647 
06648     <span class="comment">//</span>
06649     <span class="comment">// Free the interface.</span>
06650     <span class="comment">//</span>
06651 
06652     (*interface-&gt;<a class="code" href="../../d0/d0/struct__LEGACY__DEVICE__DETECTION__INTERFACE.html#o4">InterfaceDereference</a>)(interface-&gt;<a class="code" href="../../d0/d0/struct__LEGACY__DEVICE__DETECTION__INTERFACE.html#o2">Context</a>);
06653 
06654     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(interface);
06655 
06656     <span class="keywordflow">return</span> status;
06657 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a104" doxytag="pnpres.c::IopEliminateBogusConflict" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN IopEliminateBogusConflict           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PhysicalDeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ConflictDeviceObject</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l07775">7775</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01181">_DEVICE_OBJECT::AttachedDevice</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00493">DNF_LEGACY_DRIVER</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01164">DO_BUS_ENUMERATED_DEVICE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01378">_DRIVER_OBJECT::DriverExtension</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00129">_DEVICE_NODE::Flags</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00054">IopDatabaseLock</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01520">RtlCompareUnicodeString()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01337">_DRIVER_EXTENSION::ServiceKeyName</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00185">_DEVICE_NODE::ServiceName</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l08022">IopQueryConflictFillConflicts()</a>.
<p>
<pre class="fragment"><div>07781                    :
07782 
07783     Determine <span class="keywordflow">if</span> we're really conflicting with ourselves
07784     <span class="keywordflow">if</span> <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keywordflow">case</span>, we ignore <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>
07785 
07786 Arguments:
07787 
07788     PhysicalDeviceObject  PDO we're performing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> test <span class="keywordflow">for</span>
07789     ConflictDeviceObject  The object we've determined <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> conflicting
07790 
07791 Return Value:
07792 
07793     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> to eliminate <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> conflict
07794 
07795 --*/
07796 {
07797     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status = STATUS_SUCCESS;
07798     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode;
07799     <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> driverObject;
07800     KIRQL           irql;
07801     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>  attachedDevice;
07802 
07803     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
07804 
07805     <span class="comment">//</span>
07806     <span class="comment">// simple cases</span>
07807     <span class="comment">//</span>
07808     <span class="keywordflow">if</span> (PhysicalDeviceObject == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || ConflictDeviceObject == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
07809         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
07810     }
07811     <span class="comment">//</span>
07812     <span class="comment">// if ConflictDeviceObject is on PDO's stack, this is a non-conflict</span>
07813     <span class="comment">// nb at least PDO has to be checked</span>
07814     <span class="comment">//</span>
07815     ExAcquireFastLock( &amp;IopDatabaseLock, &amp;irql );
07816 
07817     <span class="keywordflow">for</span> (attachedDevice = PhysicalDeviceObject;
07818          attachedDevice;
07819          attachedDevice = attachedDevice-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o5">AttachedDevice</a>) {
07820 
07821         <span class="keywordflow">if</span> (attachedDevice == ConflictDeviceObject) {
07822             ExReleaseFastLock( &amp;IopDatabaseLock, irql );
07823             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
07824         }
07825     }
07826 
07827     ExReleaseFastLock( &amp;IopDatabaseLock, irql );
07828 
07829     <span class="comment">//</span>
07830     <span class="comment">// legacy case</span>
07831     <span class="comment">//</span>
07832     deviceNode = PhysicalDeviceObject-&gt;DeviceObjectExtension-&gt;DeviceNode;
07833     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(deviceNode);
07834     <span class="keywordflow">if</span> (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a24">DNF_LEGACY_DRIVER</a>) {
07835         <span class="comment">//</span>
07836         <span class="comment">// hmmm, let's see if our ConflictDeviceObject is resources associated with a legacy device</span>
07837         <span class="comment">//</span>
07838         <span class="keywordflow">if</span> (ConflictDeviceObject-&gt;Flags &amp; <a class="code" href="../../d0/d5/io_8h.html#a133">DO_BUS_ENUMERATED_DEVICE</a>) {
07839             <span class="comment">//</span>
07840             <span class="comment">// if not, we have a legacy conflicting with non-legacy, we're interested!</span>
07841             <span class="comment">//</span>
07842             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
07843         }
07844         <span class="comment">//</span>
07845         <span class="comment">// FDO, report driver name</span>
07846         <span class="comment">//</span>
07847         driverObject = ConflictDeviceObject-&gt;DriverObject;
07848         <span class="keywordflow">if</span>(driverObject == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
07849             <span class="comment">//</span>
07850             <span class="comment">// should not be NULL</span>
07851             <span class="comment">//</span>
07852             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(driverObject);
07853             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
07854         }
07855         <span class="comment">//</span>
07856         <span class="comment">// compare deviceNode-&gt;Service with driverObject-&gt;Service</span>
07857         <span class="comment">//</span>
07858         <span class="keywordflow">if</span> (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o14">ServiceName</a>.Length != 0 &amp;&amp;
07859             deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o14">ServiceName</a>.Length == driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o7">DriverExtension</a>-&gt;<a class="code" href="../../d1/d9/struct__DRIVER__EXTENSION.html#o3">ServiceKeyName</a>.Length &amp;&amp;
07860             <a class="code" href="../../d6/d6/nls_8c.html#a41">RtlCompareUnicodeString</a>(&amp;deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o14">ServiceName</a>,&amp;driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o7">DriverExtension</a>-&gt;<a class="code" href="../../d1/d9/struct__DRIVER__EXTENSION.html#o3">ServiceKeyName</a>,TRUE)==0) {
07861             <span class="comment">//</span>
07862             <span class="comment">// the driver's service name is the same that this PDO is associated with</span>
07863             <span class="comment">// by ignoring it we could end up ignoring conflicts of simular types of legacy devices</span>
07864             <span class="comment">// but since these have to be hand-config'd anyhow, it's prob better than having false conflicts</span>
07865             <span class="comment">// (jamiehun)</span>
07866             <span class="comment">//</span>
07867             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
07868         }
07869 
07870     }
07871     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
07872 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a108" doxytag="pnpres.c::IopFindBusDeviceNode" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> IopFindBusDeviceNode           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceNode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN INTERFACE_TYPE&nbsp;</td>
          <td class="mdname" nowrap> <em>InterfaceType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>BusNumber</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>SlotNumber</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l06408">6408</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.
<p>
References <a class="el" href="../../d3/d6/hal_8h-source.html#l01170">BusNumber</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00275">DebugMessage</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00269">DUMP_DETAIL</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00177">_DEVICE_NODE::InstancePath</a>, <a class="el" href="../../d5/d9/cmconfig_8c-source.html#l00050">InterfaceType</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l06474">IopFindBusDeviceNodeInternal()</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00056">IopRootDeviceNode</a>, and <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l03933">IopChildToRootTranslation()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l06528">IopDuplicateDetection()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l05757">IopReleaseResourcesInternal()</a>, and <a class="el" href="../../d6/d0/pnpres_8c-source.html#l03534">IopSetupArbiterAndTranslators()</a>.
<p>
<pre class="fragment"><div>06417                    :
06418 
06419     This routine finds <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> bus PDO which performs <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a46">translation</a> and arbitration <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
06420     specified <a class="code" href="../../d4/d0/cmconfig_8c.html#a5">InterfaceType</a>, <a class="code" href="../../d2/d7/hal_8h.html#a75">BusNumber</a> and SlotNumber.
06421 
06422 Parameters:
06423 
06424     DeviceNode - <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> root of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PDO to start our search
06425 
06426     <a class="code" href="../../d4/d0/cmconfig_8c.html#a5">InterfaceType</a> - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PDO's interface <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a>.
06427 
06428     <a class="code" href="../../d2/d7/hal_8h.html#a75">BusNumber</a> - specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PDO's bus number.
06429 
06430     SlotNumber - specified <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PDO's slot number (UNUSED).
06431 
06432 Return Value:
06433 
06434     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> BUS PDO.
06435 
06436 --*/
06437 
06438 {
06439     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> busDeviceNode = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
06440 
06441     UNREFERENCED_PARAMETER(SlotNumber);
06442 
06443     <span class="keywordflow">if</span> (DeviceNode &amp;&amp; <a class="code" href="../../d4/d0/cmconfig_8c.html#a5">InterfaceType</a> != InterfaceTypeUndefined) {
06444 
06445         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/cmconfig_8c.html#a5">InterfaceType</a> == PNPBus) {
06446             <span class="comment">//</span>
06447             <span class="comment">// if we specified PnpBus as InterfaceType, we know nobody specifies such a bus</span>
06448             <span class="comment">// don't waste time looking for BusNumber because it doesn't exist</span>
06449             <span class="comment">//</span>
06450             busDeviceNode = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
06451         } <span class="keywordflow">else</span> {
06452             <span class="comment">//</span>
06453             <span class="comment">// search for bus (recursive)</span>
06454             <span class="comment">//</span>
06455             busDeviceNode = <a class="code" href="../../d5/d1/pnpres_8c.html#a55">IopFindBusDeviceNodeInternal</a>(DeviceNode, (InterfaceType == Eisa) ? Isa : InterfaceType, BusNumber);
06456         }
06457 
06458         <span class="keywordflow">if</span> (busDeviceNode == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; DeviceNode == <a class="code" href="../../d1/d0/pnpdata_8c.html#a5">IopRootDeviceNode</a>) {
06459 
06460             <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(DUMP_DETAIL, (<span class="stringliteral">"IopFindBusDeviceNode: Found %ws with interface=%08X &amp; bus=%08X\n"</span>, DeviceNode-&gt;InstancePath.Buffer, InterfaceType, BusNumber));
06461             <span class="keywordflow">return</span> DeviceNode;
06462         }
06463 
06464         <span class="keywordflow">if</span> (busDeviceNode) {
06465 
06466             <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(DUMP_DETAIL, (<span class="stringliteral">"IopFindBusDeviceNode: Found %ws with interface=%08X &amp; bus=%08X\n"</span>, busDeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o13">InstancePath</a>.Buffer, InterfaceType, BusNumber));
06467         }
06468     }
06469 
06470     <span class="keywordflow">return</span> busDeviceNode;
06471 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a55" doxytag="pnpres.c::IopFindBusDeviceNodeInternal" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> IopFindBusDeviceNodeInternal           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceNode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN INTERFACE_TYPE&nbsp;</td>
          <td class="mdname" nowrap> <em>InterfaceType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>BusNumber</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l06474">6474</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.
<p>
References <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00208">_DEVICE_NODE::BusNumber</a>, <a class="el" href="../../d3/d6/hal_8h-source.html#l01170">BusNumber</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00099">_DEVICE_NODE::Child</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00207">_DEVICE_NODE::InterfaceType</a>, <a class="el" href="../../d5/d9/cmconfig_8c-source.html#l00050">InterfaceType</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00093">_DEVICE_NODE::Sibling</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l06408">IopFindBusDeviceNode()</a>.
<p>
<pre class="fragment"><div>06482                    :
06483 
06484     This worker routine finds <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> bus PDO which performs <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a46">translation</a> and arbitration <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
06485     specified <a class="code" href="../../d4/d0/cmconfig_8c.html#a5">InterfaceType</a> and <a class="code" href="../../d2/d7/hal_8h.html#a75">BusNumber</a>.
06486 
06487 Parameters:
06488 
06489     DeviceNode - <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> root of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PDO to start our search
06490 
06491     <a class="code" href="../../d4/d0/cmconfig_8c.html#a5">InterfaceType</a> - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PDO's interface <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a>.
06492 
06493     <a class="code" href="../../d2/d7/hal_8h.html#a75">BusNumber</a> - specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PDO's bus number.
06494 
06495 Return Value:
06496 
06497     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> BUS PDO.
06498 
06499 --*/
06500 
06501 {
06502     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> current;
06503 
06504     <span class="keywordflow">for</span> (current = DeviceNode; current; current = current-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o0">Sibling</a>) {
06505 
06506         <span class="keywordflow">if</span> (    <a class="code" href="../../d2/d7/hal_8h.html#a75">BusNumber</a> == current-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o18">BusNumber</a> &amp;&amp;
06507                 (<a class="code" href="../../d4/d0/cmconfig_8c.html#a5">InterfaceType</a> == current-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o17">InterfaceType</a> ||
06508                     (<a class="code" href="../../d4/d0/cmconfig_8c.html#a5">InterfaceType</a> == Isa &amp;&amp; current-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o17">InterfaceType</a> == Eisa))) {
06509 
06510             <span class="keywordflow">return</span> current;
06511         }
06512 
06513         <span class="keywordflow">if</span> (current-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o1">Child</a>) {
06514 
06515             <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> busDeviceNode = <a class="code" href="../../d5/d1/pnpres_8c.html#a55">IopFindBusDeviceNodeInternal</a>(current-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o1">Child</a>, InterfaceType, BusNumber);
06516 
06517             <span class="keywordflow">if</span> (busDeviceNode) {
06518 
06519                 <span class="keywordflow">return</span> busDeviceNode;
06520             }
06521         }
06522     }
06523 
06524     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
06525 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a54" doxytag="pnpres.c::IopFindLegacyDeviceNode" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopFindLegacyDeviceNode           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DriverObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>LegacyDeviceNode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>LegacyPDO</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l05911">5911</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00275">DebugMessage</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00570">DNF_LEGACY_RESOURCE_DEVICENODE</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00370">DNF_MADEUP</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00390">DNF_PROCESSED</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01164">DO_BUS_ENUMERATED_DEVICE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01179">_DEVICE_OBJECT::DriverObject</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00267">DUMP_ERROR</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00268">DUMP_INFO</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00195">_DEVICE_NODE::DuplicatePDO</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01184">_DEVICE_OBJECT::Flags</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00129">_DEVICE_NODE::Flags</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l04073">IoCreateDevice()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l05951">IoDeleteDevice()</a>, <a class="el" href="../../d5/d6/devnode_8c-source.html#l00056">IopAllocateDeviceNode()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00239">IopLegacyDeviceNode</a>, <a class="el" href="../../d7/d8/pnp_8h-source.html#l00037">IoPnpDriverObject</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00098">IopNumberDeviceNodes</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l06660">IopSetLegacyDeviceInstance()</a>, <a class="el" href="../../d8/d9/ke_2miscc_8c-source.html#l00182">KeQueryTickCount()</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00151">_DEVICE_NODE::PhysicalDeviceObject</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l06180">IopLegacyResourceAllocation()</a>.
<p>
<pre class="fragment"><div>05920                    :
05921 
05922     This routine searches <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device node and device object created <span class="keywordflow">for</span> legacy resource
05923     allocation <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DriverObject and DeviceObject.
05924 
05925 Parameters:
05926 
05927     DriverObject - specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver object doing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> legacy allocation.
05928 
05929     DeviceObject - specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device object.
05930 
05931     LegacyDeviceNode - receives <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> legacy device node <span class="keywordflow">if</span> found.
05932 
05933     LegacyDeviceObject - receives <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> legacy device object <span class="keywordflow">if</span> found.
05934 
05935 
05936 Return Value:
05937 
05938     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> code that indicates whether or not <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function was successful.
05939 
05940 --*/
05941 
05942 {
05943     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>        status = STATUS_UNSUCCESSFUL;
05944     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>    deviceNode;
05945 
05946     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(LegacyDeviceNode &amp;&amp; LegacyPDO);
05947 
05948 
05949     <span class="comment">//</span>
05950     <span class="comment">// Use the device object if it exists.</span>
05951     <span class="comment">//</span>
05952 
05953     <span class="keywordflow">if</span> (DeviceObject) {
05954 
05955         deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)DeviceObject-&gt;DeviceObjectExtension-&gt;DeviceNode;
05956         <span class="keywordflow">if</span> (deviceNode) {
05957 
05958             *LegacyPDO = DeviceObject;
05959             *LegacyDeviceNode = deviceNode;
05960             status = STATUS_SUCCESS;
05961 
05962         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!(DeviceObject-&gt;Flags &amp; <a class="code" href="../../d0/d5/io_8h.html#a133">DO_BUS_ENUMERATED_DEVICE</a>)) {
05963 
05964             deviceNode = <a class="code" href="../../d9/d0/pnpiop_8h.html#a252">IopAllocateDeviceNode</a>(DeviceObject);
05965             <span class="keywordflow">if</span> (deviceNode) {
05966 
05967                 deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a34">DNF_LEGACY_RESOURCE_DEVICENODE</a>;
05968                 <a class="code" href="../../d5/d1/pnpres_8c.html#a90">IopSetLegacyDeviceInstance</a> (DriverObject, deviceNode);
05969                 *LegacyPDO = DeviceObject;
05970                 *LegacyDeviceNode = deviceNode;
05971                 status = STATUS_SUCCESS;
05972 
05973             } <span class="keywordflow">else</span> {
05974 
05975                 <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(DUMP_ERROR, (<span class="stringliteral">"PNPRES: Failed to allocate device node for PDO %08X\n"</span>, DeviceObject));
05976                 status = STATUS_INSUFFICIENT_RESOURCES;
05977 
05978             }
05979 
05980         } <span class="keywordflow">else</span> {
05981 
05982             <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(DUMP_ERROR, (<span class="stringliteral">"PNPRES: %08X PDO without a device node!\n"</span>, DeviceObject));
05983             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(DeviceObject-&gt;DeviceObjectExtension-&gt;DeviceNode);
05984 
05985         }
05986 
05987     } <span class="keywordflow">else</span> {
05988 
05989         <span class="comment">//</span>
05990         <span class="comment">// Search our list of legacy device nodes.</span>
05991         <span class="comment">//</span>
05992 
05993         <span class="keywordflow">for</span> (   deviceNode = <a class="code" href="../../d5/d1/pnpres_8c.html#a42">IopLegacyDeviceNode</a>;
05994                 deviceNode &amp;&amp; deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o15">DuplicatePDO</a> != (<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>)DriverObject;
05995                 deviceNode = deviceNode-&gt;NextDeviceNode);
05996 
05997         <span class="keywordflow">if</span> (deviceNode) {
05998 
05999             *LegacyPDO = deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o9">PhysicalDeviceObject</a>;
06000             *LegacyDeviceNode = deviceNode;
06001             status = STATUS_SUCCESS;
06002 
06003         } <span class="keywordflow">else</span> {
06004 
06005             WCHAR           buffer[60];
06006             UNICODE_STRING  deviceName;
06007             LARGE_INTEGER   tickCount;
06008             ULONG           length;
06009             <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>  pdo;
06010 
06011             <span class="comment">//</span>
06012             <span class="comment">// We are seeing this for the first time.</span>
06013             <span class="comment">// Create a madeup device node.</span>
06014             <span class="comment">//</span>
06015 
06016             <a class="code" href="../../d7/d0/ke_2miscc_8c.html#a4">KeQueryTickCount</a>(&amp;tickCount);
06017             length = _snwprintf(buffer, <span class="keyword">sizeof</span>(buffer) / <span class="keyword">sizeof</span>(WCHAR), L<span class="stringliteral">"\\Device\\Resource%04u%x"</span>, IopNumberDeviceNodes, tickCount.LowPart);
06018             deviceName.MaximumLength = <span class="keyword">sizeof</span>(buffer);
06019             deviceName.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(length * <span class="keyword">sizeof</span>(WCHAR));
06020             deviceName.Buffer = buffer;
06021 
06022             <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(DUMP_INFO, (<span class="stringliteral">"PNPRES: Creating dummy PDO %ws\n"</span>, deviceName.Buffer));
06023 
06024             status = <a class="code" href="../../d4/d6/iosubs_8c.html#a45">IoCreateDevice</a>( IoPnpDriverObject,
06025                                      <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d1/struct__IOPNP__DEVICE__EXTENSION.html">IOPNP_DEVICE_EXTENSION</a>),
06026                                      &amp;deviceName,
06027                                      FILE_DEVICE_CONTROLLER,
06028                                      0,
06029                                      FALSE,
06030                                      &amp;pdo);
06031 
06032             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
06033 
06034                 pdo-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o8">Flags</a> |= <a class="code" href="../../d0/d5/io_8h.html#a133">DO_BUS_ENUMERATED_DEVICE</a>;
06035                 deviceNode = <a class="code" href="../../d9/d0/pnpiop_8h.html#a252">IopAllocateDeviceNode</a>(pdo);
06036                 <span class="keywordflow">if</span> (deviceNode) {
06037 
06038                     <span class="comment">//</span>
06039                     <span class="comment">// Change driver object to the caller even though the owner</span>
06040                     <span class="comment">// of the pdo is IoPnpDriverObject.  This is to support</span>
06041                     <span class="comment">// DriverExclusive for legacy interface.</span>
06042                     <span class="comment">//</span>
06043 
06044                     pdo-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o3">DriverObject</a> = DriverObject;
06045                     deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> = <a class="code" href="../../d9/d0/pnpiop_8h.html#a5">DNF_MADEUP</a> | <a class="code" href="../../d9/d0/pnpiop_8h.html#a8">DNF_PROCESSED</a> | <a class="code" href="../../d9/d0/pnpiop_8h.html#a34">DNF_LEGACY_RESOURCE_DEVICENODE</a>;
06046                     deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o15">DuplicatePDO</a> = (<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>)DriverObject;
06047                     <a class="code" href="../../d5/d1/pnpres_8c.html#a90">IopSetLegacyDeviceInstance</a> (DriverObject, deviceNode);
06048 
06049                     <span class="comment">//</span>
06050                     <span class="comment">// Add it to our list of legacy device nodes rather than adding it to the HW tree.</span>
06051                     <span class="comment">//</span>
06052 
06053                     deviceNode-&gt;NextDeviceNode = <a class="code" href="../../d5/d1/pnpres_8c.html#a42">IopLegacyDeviceNode</a>;
06054                     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d1/pnpres_8c.html#a42">IopLegacyDeviceNode</a>) {
06055 
06056                         <a class="code" href="../../d5/d1/pnpres_8c.html#a42">IopLegacyDeviceNode</a>-&gt;PreviousDeviceNode = deviceNode;
06057 
06058                     }
06059                     <a class="code" href="../../d5/d1/pnpres_8c.html#a42">IopLegacyDeviceNode</a> = deviceNode;
06060                     *LegacyPDO = pdo;
06061                     *LegacyDeviceNode = deviceNode;
06062 
06063                 } <span class="keywordflow">else</span> {
06064 
06065                     <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(DUMP_ERROR, (<span class="stringliteral">"PNPRES: Failed to allocate device node for PDO %08X\n"</span>, pdo));
06066                     <a class="code" href="../../d4/d6/iosubs_8c.html#a55">IoDeleteDevice</a>(pdo);
06067                     status = STATUS_INSUFFICIENT_RESOURCES;
06068 
06069                 }
06070 
06071             } <span class="keywordflow">else</span> {
06072 
06073                 <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(DUMP_ERROR, (<span class="stringliteral">"PNPRES: IoCreateDevice failed for %ws with status %08X\n"</span>, deviceName.Buffer, status));
06074 
06075             }
06076         }
06077     }
06078 
06079     <span class="keywordflow">return</span> status;
06080 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a74" doxytag="pnpres.c::IopFindResourceHandlerInfo" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN IopFindResourceHandlerInfo           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d9/d0/pnpiop_8h.html#a126">RESOURCE_HANDLER_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>HandlerType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceNode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN UCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>ResourceType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>HandlerEntry</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l03424">3424</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.
<p>
References <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00709">_PI_RESOURCE_ARBITER_ENTRY::ArbiterInterface</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00698">PI_MAXIMUM_RESOURCE_TYPE_TRACKED</a>, <a class="el" href="../../d9/d0/pnpiop_8h.html#a390a216">ResourceArbiter</a>, <a class="el" href="../../d9/d0/pnpiop_8h.html#a390a215">ResourceTranslator</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00708">_PI_RESOURCE_ARBITER_ENTRY::ResourceType</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l03534">IopSetupArbiterAndTranslators()</a>.
<p>
<pre class="fragment"><div>03433                    :
03434 
03435     This routine finds <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> desired resource handler interface <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified
03436     resource <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified Device node.
03437 
03438 Parameters:
03439 
03440     HandlerType - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of handler needed.
03441 
03442     DeviceNode - specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device node from where to search <span class="keywordflow">for</span> handler
03443 
03444     ResourceTYpe - specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of resource.
03445 
03446     HandlerEntry - supplies a pointer to a variable to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handler.
03447 
03448 Return Value:
03449 
03450     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> + non-null HandlerEntry : Find handler info and there <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a handler
03451     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> + <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> HandlerEntry     : Find handler info and there <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> NO handler
03452     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> + <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> HandlerEntry    : No handler info found.
03453 
03454 --*/
03455 {
03456     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> resourceMask;
03457     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> noHandlerMask, queryHandlerMask;
03458     PLIST_ENTRY listHead, nextEntry;
03459     <a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html">PPI_RESOURCE_ARBITER_ENTRY</a> arbiterEntry;
03460 
03461     *HandlerEntry = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03462 
03463     <span class="keywordflow">switch</span> (HandlerType) {
03464     <span class="keywordflow">case</span> <a class="code" href="../../d9/d0/pnpiop_8h.html#a390a216">ResourceArbiter</a>:
03465         noHandlerMask = DeviceNode-&gt;NoArbiterMask;
03466         queryHandlerMask = DeviceNode-&gt;QueryArbiterMask;
03467         listHead = &amp;DeviceNode-&gt;DeviceArbiterList;
03468         <span class="keywordflow">break</span>;
03469 
03470     <span class="keywordflow">case</span> <a class="code" href="../../d9/d0/pnpiop_8h.html#a390a215">ResourceTranslator</a>:
03471         noHandlerMask = DeviceNode-&gt;NoTranslatorMask;
03472         queryHandlerMask = DeviceNode-&gt;QueryTranslatorMask;
03473         listHead = &amp;DeviceNode-&gt;DeviceTranslatorList;
03474         <span class="keywordflow">break</span>;
03475 
03476     <span class="keywordflow">default</span>:
03477         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03478     }
03479 
03480     resourceMask = 1 &lt;&lt; ResourceType;
03481     <span class="keywordflow">if</span> (noHandlerMask &amp; resourceMask) {
03482 
03483         <span class="comment">//</span>
03484         <span class="comment">// There is no desired handler for the resource type in this device node</span>
03485         <span class="comment">//</span>
03486 
03487         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03488     }
03489 
03490     <span class="keywordflow">if</span> (queryHandlerMask &amp; resourceMask) {
03491 
03492         <span class="comment">//</span>
03493         <span class="comment">// Has handler for the resource type in this device node.</span>
03494         <span class="comment">// look for it ...</span>
03495         <span class="comment">//</span>
03496 
03497         nextEntry = listHead-&gt;Flink;
03498         <span class="keywordflow">for</span> (; nextEntry != listHead; nextEntry = nextEntry-&gt;Flink) {
03499             arbiterEntry = CONTAINING_RECORD(nextEntry, <a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html">PI_RESOURCE_ARBITER_ENTRY</a>, DeviceArbiterList);
03500             <span class="keywordflow">if</span> (arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o1">ResourceType</a> == ResourceType) {
03501                 <span class="keywordflow">break</span>;
03502             }
03503         }
03504         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(nextEntry != listHead);     <span class="comment">// There must be one ...</span>
03505         *HandlerEntry = arbiterEntry;
03506         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03507 
03508     } <span class="keywordflow">else</span> {
03509 
03510         <span class="comment">//</span>
03511         <span class="comment">// If we are here there are two cases:</span>
03512         <span class="comment">//   We have not query the desired interface yet  or</span>
03513         <span class="comment">//   the resource type is out of the range we are tracking using masks.</span>
03514         <span class="comment">//   In this case, we need to go thru the link list.</span>
03515         <span class="comment">//</span>
03516 
03517         <span class="keywordflow">if</span> (ResourceType &gt; <a class="code" href="../../d9/d0/pnpiop_8h.html#a57">PI_MAXIMUM_RESOURCE_TYPE_TRACKED</a>) {
03518             nextEntry = listHead-&gt;Flink;
03519             <span class="keywordflow">for</span> (; nextEntry != listHead; nextEntry = nextEntry-&gt;Flink) {
03520                 arbiterEntry = CONTAINING_RECORD(nextEntry, <a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html">PI_RESOURCE_ARBITER_ENTRY</a>, DeviceArbiterList);
03521                 <span class="keywordflow">if</span> (arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o1">ResourceType</a> == ResourceType) {
03522                     <span class="keywordflow">if</span> (arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o2">ArbiterInterface</a>) {
03523                         *HandlerEntry = arbiterEntry;
03524                     }
03525                     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03526                 }
03527             }
03528         }
03529         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03530     }
03531 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a86" doxytag="pnpres.c::IopFindResourcesForArbiter" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopFindResourcesForArbiter           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceNode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN UCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>ResourceType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT ULONG *&nbsp;</td>
          <td class="mdname" nowrap> <em>Count</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PCM_PARTIAL_RESOURCE_DESCRIPTOR *&nbsp;</td>
          <td class="mdname" nowrap> <em>CmDesc</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l05121">5121</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.
<p>
References <a class="el" href="../../d5/d9/cmconfig_8c-source.html#l00051">Count</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00275">DebugMessage</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00487">DNF_STARTED</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00267">DUMP_ERROR</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00066">ExAllocatePoolPRD</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00765">_IOP_RESOURCE_REQUEST::PhysicalDevice</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00237">PiAssignTable</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00238">PiAssignTableCount</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00081">PREQ_ALTERNATIVE</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00079">PREQ_DESC</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00083">PREQ_LIST</a>, and <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00770">_IOP_RESOURCE_REQUEST::ReqList</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l05016">IopArbitrateDeviceResources()</a>.
<p>
<pre class="fragment"><div>05130                    :
05131 
05132     This routine returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resources required by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ResourceType arbiter in DeviceNode.
05133 
05134 Parameters:
05135 
05136     DeviceNode -specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device node whose ResourceType arbiter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> requesting <span class="keywordflow">for</span> resources
05137 
05138     ResourceType - specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resource <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a>
05139 
05140     <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> - specifies a pointer to a varaible to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> count of Cm descriptors returned
05141 
05142     CmDesc - specifies a pointer to a varibble to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> returned cm descriptor.
05143 
05144 Return Value:
05145 
05146     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> code that indicates whether or not <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function was successful.
05147 
05148 --*/
05149 
05150 {
05151     <a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a> assignEntry;
05152     <a class="code" href="../../d5/d1/pnpres_8c.html#a29">PREQ_ALTERNATIVE</a> reqAlternative;
05153     <a class="code" href="../../d5/d1/pnpres_8c.html#a28">PREQ_DESC</a> reqDesc;
05154     ULONG i, count = 0;
05155     PCM_PARTIAL_RESOURCE_DESCRIPTOR cmDescriptor;
05156 
05157     *<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> = 0;
05158     *CmDesc = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05159     <span class="keywordflow">if</span> (DeviceNode-&gt;Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a23">DNF_STARTED</a>) {
05160         <span class="keywordflow">return</span> STATUS_SUCCESS;
05161     }
05162 
05163     <span class="comment">//</span>
05164     <span class="comment">// Find this device node's IOP_RESOURCE_REQUEST structure first</span>
05165     <span class="comment">//</span>
05166 
05167     <span class="keywordflow">for</span> (assignEntry = <a class="code" href="../../d5/d1/pnpres_8c.html#a40">PiAssignTable</a> + <a class="code" href="../../d5/d1/pnpres_8c.html#a41">PiAssignTableCount</a> - 1;
05168          assignEntry &gt;= <a class="code" href="../../d5/d1/pnpres_8c.html#a40">PiAssignTable</a>;
05169          assignEntry--) {
05170         <span class="keywordflow">if</span> (assignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o0">PhysicalDevice</a> == DeviceNode-&gt;PhysicalDeviceObject) {
05171             <span class="keywordflow">break</span>;
05172         }
05173     }
05174     <span class="keywordflow">if</span> (assignEntry &lt; <a class="code" href="../../d5/d1/pnpres_8c.html#a40">PiAssignTable</a>) {
05175         <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(DUMP_ERROR, (<span class="stringliteral">"Rebalance: No resreqlist for Arbiter? Can not find Arbiter assign table entry\n"</span>));
05176         <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
05177     }
05178 
05179     reqAlternative = *((<a class="code" href="../../d5/d1/pnpres_8c.html#a30">PREQ_LIST</a>)assignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o5">ReqList</a>)-&gt;SelectedAlternative;
05180     <span class="keywordflow">for</span> (i = 0; i &lt; reqAlternative-&gt;ReqDescCount; i++) {
05181         reqDesc = reqAlternative-&gt;ReqDescTable[i]-&gt;TranslatedReqDesc;
05182         <span class="keywordflow">if</span> (reqDesc-&gt;Allocation.Type == ResourceType) {
05183             count++;
05184         }
05185     }
05186 
05187     cmDescriptor = (PCM_PARTIAL_RESOURCE_DESCRIPTOR) <a class="code" href="../../d5/d1/pnpres_8c.html#a7">ExAllocatePoolPRD</a>(
05188                        PagedPool,
05189                        <span class="keyword">sizeof</span>(CM_PARTIAL_RESOURCE_DESCRIPTOR) * count
05190                        );
05191     <span class="keywordflow">if</span> (!cmDescriptor) {
05192 
05193         <span class="comment">//</span>
05194         <span class="comment">// If we can not find memory, the resources will not be committed by arbiter.</span>
05195         <span class="comment">//</span>
05196 
05197         <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(DUMP_ERROR, (<span class="stringliteral">"Rebalance: Not enough memory to perform rebalance\n"</span>));
05198         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
05199     }
05200 
05201     *<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> = count;
05202     *CmDesc = cmDescriptor;
05203 
05204     <span class="keywordflow">for</span> (i = 0; i &lt; reqAlternative-&gt;ReqDescCount; i++) {
05205         reqDesc = reqAlternative-&gt;ReqDescTable[i]-&gt;TranslatedReqDesc;
05206         <span class="keywordflow">if</span> (reqDesc-&gt;Allocation.Type == ResourceType) {
05207             *cmDescriptor = reqDesc-&gt;Allocation;
05208             cmDescriptor++;
05209         }
05210     }
05211     <span class="keywordflow">return</span> STATUS_SUCCESS;
05212 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a62" doxytag="pnpres.c::IopFreeReqAlternative" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopFreeReqAlternative           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d5/d1/pnpres_8c.html#a29">PREQ_ALTERNATIVE</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>ReqAlternative</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l01922">1922</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.
<p>
References <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00151">IS_TRANSLATED_REQ_DESC</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00079">PREQ_DESC</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l01948">IopFreeReqList()</a>, and <a class="el" href="../../d6/d0/pnpres_8c-source.html#l01267">IopResourceRequirementsListToReqList()</a>.
<p>
<pre class="fragment"><div>01925 {
01926     <a class="code" href="../../d5/d1/pnpres_8c.html#a28">PREQ_DESC</a>   reqDesc, reqDescx;
01927     ULONG       i;
01928 
01929     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01930 
01931     <span class="keywordflow">if</span> (ReqAlternative) {
01932         <span class="keywordflow">for</span> (i = 0; i &lt; ReqAlternative-&gt;ReqDescCount; i++) {
01933             reqDesc = ReqAlternative-&gt;ReqDescTable[i];
01934             reqDescx = reqDesc-&gt;TranslatedReqDesc;
01935             <span class="keywordflow">while</span> (reqDescx &amp;&amp; <a class="code" href="../../d5/d1/pnpres_8c.html#a14">IS_TRANSLATED_REQ_DESC</a>(reqDescx)) {
01936                 reqDesc = reqDescx;
01937                 <span class="keywordflow">if</span> (reqDescx-&gt;AlternativeTable.Alternatives) {
01938                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(reqDescx-&gt;AlternativeTable.Alternatives);
01939                 }
01940                 reqDescx = reqDescx-&gt;TranslatedReqDesc;
01941                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(reqDesc);
01942             }
01943         }
01944     }
01945 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a63" doxytag="pnpres.c::IopFreeReqList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopFreeReqList           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d5/d1/pnpres_8c.html#a30">PREQ_LIST</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>ReqList</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l01948">1948</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.
<p>
References <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l01922">IopFreeReqAlternative()</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l01988">IopFreeResourceRequirementsForAssignTable()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l08336">IopQueryConflictListInternal()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l07198">IopReserveBootResourcesInternal()</a>, and <a class="el" href="../../d6/d0/pnpres_8c-source.html#l01267">IopResourceRequirementsListToReqList()</a>.
<p>
<pre class="fragment"><div>01954                    :
01955 
01956     This routine release <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ReqList associated with a resource requirements list
01957 
01958 Parameters:
01959 
01960     ReqList - supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> REQ_LIST.
01961 
01962 Return Value:
01963 
01964     None.
01965 
01966 --*/
01967 
01968 {
01969     ULONG i;
01970 
01971     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01972 
01973     <span class="keywordflow">if</span> (ReqList) {
01974 
01975         <span class="comment">//</span>
01976         <span class="comment">// First we need to free all the *extra* req descs for translators.</span>
01977         <span class="comment">// The default Req Desc will be freed when the ReqList is freed.</span>
01978         <span class="comment">//</span>
01979 
01980         <span class="keywordflow">for</span> (i = 0; i &lt; ReqList-&gt;ReqAlternativeCount; i++) {
01981             <a class="code" href="../../d5/d1/pnpres_8c.html#a62">IopFreeReqAlternative</a>(ReqList-&gt;ReqAlternativeTable[i]);
01982         }
01983         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(ReqList);
01984     }
01985 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a61" doxytag="pnpres.c::IopFreeResourceRequirementsForAssignTable" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopFreeResourceRequirementsForAssignTable           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>AssignTable</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>AssignTableEnd</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l01988">1988</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.
<p>
References <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00766">_IOP_RESOURCE_REQUEST::Flags</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00759">IOP_ASSIGN_KEEP_CURRENT_CONFIG</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l01948">IopFreeReqList()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00770">_IOP_RESOURCE_REQUEST::ReqList</a>, and <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00769">_IOP_RESOURCE_REQUEST::ResourceRequirements</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00720">IopAllocateResources()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l01066">IopGetResourceRequirementsForAssignTable()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l07470">IopReallocateResources()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l05215">IopRebalance()</a>, and <a class="el" href="../../d6/d0/pnpres_8c-source.html#l05660">IopRestoreResourcesInternal()</a>.
<p>
<pre class="fragment"><div>01995                    :
01996 
01997     For each AssignTable entry, <span class="keyword">this</span> routine frees its attached REQ_LIST.
01998 
01999 Parameters:
02000 
02001     AssignTable - supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first entry of a <a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">IOP_RESOURCE_REQUEST</a> table.
02002 
02003     AssignTableEnd - supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> end of <a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">IOP_RESOURCE_REQUEST</a> table.
02004 
02005 Return Value:
02006 
02007     None.
02008 
02009 --*/
02010 
02011 {
02012     <a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a> AssignEntry;
02013 
02014     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02015 
02016     <span class="keywordflow">for</span> (AssignEntry = AssignTable; AssignEntry &lt; AssignTableEnd; ++AssignEntry) {
02017         <a class="code" href="../../d5/d1/pnpres_8c.html#a63">IopFreeReqList</a>(AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o5">ReqList</a>);
02018         AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o5">ReqList</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02019         <span class="keywordflow">if</span> (AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o1">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a72">IOP_ASSIGN_KEEP_CURRENT_CONFIG</a> &amp;&amp;
02020             AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o4">ResourceRequirements</a>) {
02021 
02022             <span class="comment">//</span>
02023             <span class="comment">// The REAL resreq list is cached in DeviceNode-&gt;ResourceRequirements.</span>
02024             <span class="comment">// We need to free the filtered list.</span>
02025             <span class="comment">//</span>
02026 
02027             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o4">ResourceRequirements</a>);
02028             AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o4">ResourceRequirements</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02029         }
02030     }
02031 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a56" doxytag="pnpres.c::IopGetResourceRequirementsForAssignTable" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopGetResourceRequirementsForAssignTable           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>AssignTable</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>AssignTableEnd</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceCount</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l01066">1066</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.
<p>
References <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00767">_IOP_RESOURCE_REQUEST::AllocationType</a>, <a class="el" href="../../d6/d9/pnp_8h.html#a174a130">ArbiterRequestPnpEnumerated</a>, <a class="el" href="../../d5/d9/cmconfig_8c-source.html#l00051">Count</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00275">DebugMessage</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01274">_DEVOBJ_EXTENSION::DeviceNode</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01210">_DEVICE_OBJECT::DeviceObjectExtension</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00466">DNF_RESOURCE_REQUIREMENTS_CHANGED</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00440">DNF_RESOURCE_REQUIREMENTS_NEED_FILTERED</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00269">DUMP_DETAIL</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00268">DUMP_INFO</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00129">_DEVICE_NODE::Flags</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00766">_IOP_RESOURCE_REQUEST::Flags</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00177">_DEVICE_NODE::InstancePath</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00761">IOP_ASSIGN_CLEAR_RESOURCE_REQUIREMENTS_CHANGE_FLAG</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00756">IOP_ASSIGN_IGNORE</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00759">IOP_ASSIGN_KEEP_CURRENT_CONFIG</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l04480">IopDumpResourceRequirementsList()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l04479">IopFilterResourceRequirementsList()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l01988">IopFreeResourceRequirementsForAssignTable()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l02262">IopQueryDeviceResources()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l01811">IopRearrangeReqList()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l01267">IopResourceRequirementsListToReqList()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00765">_IOP_RESOURCE_REQUEST::PhysicalDevice</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00273">PnpResDebugLevel</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00083">PREQ_LIST</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00768">_IOP_RESOURCE_REQUEST::Priority</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00741">QUERY_RESOURCE_REQUIREMENTS</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00770">_IOP_RESOURCE_REQUEST::ReqList</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00771">_IOP_RESOURCE_REQUEST::ResourceAssignment</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00161">_DEVICE_NODE::ResourceList</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00769">_IOP_RESOURCE_REQUEST::ResourceRequirements</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00201">_DEVICE_NODE::ResourceRequirements</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00773">_IOP_RESOURCE_REQUEST::Status</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00772">_IOP_RESOURCE_REQUEST::TranslatedResourceAssignment</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00720">IopAllocateResources()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l07470">IopReallocateResources()</a>, and <a class="el" href="../../d6/d0/pnpres_8c-source.html#l05215">IopRebalance()</a>.
<p>
<pre class="fragment"><div>01074                    :
01075 
01076     For each AssignTable entry, <span class="keyword">this</span> routine queries device's IO resource requirements
01077     list and converts <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> to our internal REQ_LIST <a class="code" href="../../d8/d0/rtbatcr_8c.html#a8">format</a>.
01078 
01079 Parameters:
01080 
01081     AssignTable - supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first entry of a <a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">IOP_RESOURCE_REQUEST</a> table.
01082 
01083     AssignTableEnd - supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> end of <a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">IOP_RESOURCE_REQUEST</a> table.
01084 
01085 Return Value:
01086 
01087     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> code that indicates whether or not <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function was successful.
01088 
01089 --*/
01090 
01091 {
01092     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>, FinalStatus = STATUS_UNSUCCESSFUL;
01093     <a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a> AssignEntry;
01094     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> PhysicalDevice;
01095     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode;
01096     ULONG Length, <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> = 0;
01097 
01098     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01099 
01100     <span class="comment">//</span>
01101     <span class="comment">// Go thru each entry, if the io resource requirements is not established,</span>
01102     <span class="comment">// we will first see if the device node contains an io resreq, if yes, we will</span>
01103     <span class="comment">// use it.  Otherwise, we will query resource requirements from the driver and cache</span>
01104     <span class="comment">// it in our device node structure.</span>
01105     <span class="comment">//</span>
01106 
01107     <span class="keywordflow">for</span> (AssignEntry = AssignTable; AssignEntry &lt; AssignTableEnd; ++AssignEntry) {
01108 
01109         AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o5">ReqList</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01110         <span class="keywordflow">if</span> (AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o1">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a69">IOP_ASSIGN_IGNORE</a>) {
01111             FinalStatus = STATUS_SUCCESS;
01112             <span class="keywordflow">continue</span>;
01113         }
01114 
01115         AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o6">ResourceAssignment</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01116         AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o7">TranslatedResourceAssignment</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01117         PhysicalDevice = AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o0">PhysicalDevice</a>;
01118         DeviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)PhysicalDevice-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o6">DeviceNode</a>;
01119 
01120         <span class="keywordflow">if</span> (DeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a20">DNF_RESOURCE_REQUIREMENTS_CHANGED</a>) {
01121             <span class="keywordflow">if</span> (DeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o16">ResourceRequirements</a>) {
01122                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(DeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o16">ResourceRequirements</a>);
01123                 DeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o16">ResourceRequirements</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01124 
01125                 <span class="comment">//</span>
01126                 <span class="comment">// Mark that we need to cleare the resource requirements changed flag when</span>
01127                 <span class="comment">// succeed.</span>
01128                 <span class="comment">//</span>
01129 
01130                 AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o1">Flags</a> |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a73">IOP_ASSIGN_CLEAR_RESOURCE_REQUIREMENTS_CHANGE_FLAG</a>;
01131                 DeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp;= ~<a class="code" href="../../d9/d0/pnpiop_8h.html#a16">DNF_RESOURCE_REQUIREMENTS_NEED_FILTERED</a>;
01132                 <span class="comment">//DeviceNode-&gt;Flags &amp;= ~DNF_RESOURCE_REQUIREMENTS_CHANGED;</span>
01133             }
01134         }
01135 
01136         <span class="keywordflow">if</span> (!AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o4">ResourceRequirements</a>) {
01137             <span class="keywordflow">if</span> (DeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o16">ResourceRequirements</a> &amp;&amp;
01138                 !(DeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a16">DNF_RESOURCE_REQUIREMENTS_NEED_FILTERED</a>)) {
01139                 <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(DUMP_DETAIL, (<span class="stringliteral">"Pnpres: Resource requirements list already exists for %ws\n"</span>, DeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o13">InstancePath</a>.Buffer));
01140                 AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o4">ResourceRequirements</a> = DeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o16">ResourceRequirements</a>;
01141                 AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o2">AllocationType</a> = <a class="code" href="../../d6/d9/pnp_8h.html#a174a130">ArbiterRequestPnpEnumerated</a>;
01142             } <span class="keywordflow">else</span> {
01143                 <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(DUMP_INFO,(<span class="stringliteral">"Pnpres: Query Resource requirements list for %ws...\n"</span>, DeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o13">InstancePath</a>.Buffer));
01144                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d1/pnpirp_8c.html#a27">IopQueryDeviceResources</a> (PhysicalDevice,
01145                                                   QUERY_RESOURCE_REQUIREMENTS,
01146                                                   &amp;AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o4">ResourceRequirements</a>,
01147                                                   &amp;Length
01148                                                   );
01149                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01150                     AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o1">Flags</a> |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a69">IOP_ASSIGN_IGNORE</a>;
01151                     AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o8">Status</a> = <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01152                     <span class="keywordflow">continue</span>;
01153                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o4">ResourceRequirements</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01154 
01155                     <span class="comment">//</span>
01156                     <span class="comment">// Status Success with NULL ResourceRequirements means</span>
01157                     <span class="comment">// no resource required.</span>
01158                     <span class="comment">//</span>
01159 
01160                     AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o1">Flags</a> |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a69">IOP_ASSIGN_IGNORE</a>;
01161                     AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o8">Status</a> = <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01162                     <span class="keywordflow">continue</span>;
01163                 }
01164                 <span class="keywordflow">if</span> (DeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o16">ResourceRequirements</a>) {
01165                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(DeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o16">ResourceRequirements</a>);
01166                     DeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp;= ~<a class="code" href="../../d9/d0/pnpiop_8h.html#a16">DNF_RESOURCE_REQUIREMENTS_NEED_FILTERED</a>;
01167                 }
01168                 DeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o16">ResourceRequirements</a> = AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o4">ResourceRequirements</a>;
01169             }
01170         }
01171 
01172         <span class="comment">//</span>
01173         <span class="comment">// For non-stop case, even though the res req list has changed, we need</span>
01174         <span class="comment">// to guarantee that it still get its current setting, if possible.</span>
01175         <span class="comment">// Note, if the new resreq list does not cover the old setting.  It's bus</span>
01176         <span class="comment">// drivers' responsibility to guarantee that non of their child would be</span>
01177         <span class="comment">// affected. Otherwise, the bus drivers should not ask for non-stop.</span>
01178         <span class="comment">//</span>
01179 
01180         <span class="keywordflow">if</span> (AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o1">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a72">IOP_ASSIGN_KEEP_CURRENT_CONFIG</a>) {
01181             PIO_RESOURCE_REQUIREMENTS_LIST filteredList;
01182             BOOLEAN exactMatch;
01183 
01184             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a29">IopFilterResourceRequirementsList</a> (
01185                          AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o4">ResourceRequirements</a>,
01186                          DeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o10">ResourceList</a>,
01187                          &amp;filteredList,
01188                          &amp;exactMatch
01189                          );
01190             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
01191 
01192                 <span class="comment">//</span>
01193                 <span class="comment">// Do not free the original AssignEntry-&gt;ResourceRequirements.</span>
01194                 <span class="comment">// It is used by deviceNode-&gt;ResourceRequirements.</span>
01195                 <span class="comment">//</span>
01196 
01197                 AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o4">ResourceRequirements</a> = filteredList;
01198             } <span class="keywordflow">else</span> {
01199                 AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o1">Flags</a> &amp;= ~<a class="code" href="../../d9/d0/pnpiop_8h.html#a72">IOP_ASSIGN_KEEP_CURRENT_CONFIG</a>;
01200             }
01201         }
01202 
01203 <span class="preprocessor">#if DBG_SCOPE</span>
01204 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="../../d5/d1/pnpres_8c.html#a47">PnpResDebugLevel</a> &amp; <a class="code" href="../../d5/d1/pnpres_8c.html#a24">DUMP_INFO</a>) {
01205             <a class="code" href="../../d5/d1/pnpres_8c.html#a97">IopDumpResourceRequirementsList</a>(AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o4">ResourceRequirements</a>);
01206         }
01207 <span class="preprocessor">#endif</span>
01208 <span class="preprocessor"></span>
01209         <span class="comment">//</span>
01210         <span class="comment">// Convert Io resource requirements list to our internal representation.</span>
01211         <span class="comment">//</span>
01212 
01213         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d1/pnpres_8c.html#a57">IopResourceRequirementsListToReqList</a>(
01214                         AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o2">AllocationType</a>,
01215                         AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o4">ResourceRequirements</a>,
01216                         PhysicalDevice,
01217                         &amp;AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o5">ReqList</a>);
01218 
01219         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) || AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o5">ReqList</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01220             AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o1">Flags</a> |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a69">IOP_ASSIGN_IGNORE</a>;
01221             AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o8">Status</a> = <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01222             <span class="keywordflow">continue</span>;
01223         } <span class="keywordflow">else</span> {
01224             <a class="code" href="../../d5/d1/pnpres_8c.html#a30">PREQ_LIST</a> ReqList;
01225 
01226             ReqList = (<a class="code" href="../../d5/d1/pnpres_8c.html#a30">PREQ_LIST</a>)AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o5">ReqList</a>;
01227             ReqList-&gt;AssignEntry = AssignEntry;
01228 
01229             <span class="comment">//</span>
01230             <span class="comment">// Sort the ReqList such that the higher priority Alternative list are</span>
01231              <span class="comment">// placed in the front of the list.</span>
01232             <span class="comment">//</span>
01233 
01234             <a class="code" href="../../d5/d1/pnpres_8c.html#a58">IopRearrangeReqList</a>(ReqList);
01235             <span class="keywordflow">if</span> (ReqList-&gt;ReqBestAlternative == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01236 
01237                 AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o1">Flags</a> |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a69">IOP_ASSIGN_IGNORE</a>;
01238                 AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o8">Status</a> = STATUS_DEVICE_CONFIGURATION_ERROR;
01239                 <a class="code" href="../../d5/d1/pnpres_8c.html#a61">IopFreeResourceRequirementsForAssignTable</a>(AssignEntry, AssignEntry + 1);
01240                 <span class="keywordflow">continue</span>;
01241 
01242             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ReqList-&gt;ReqAlternativeCount &lt; 3) {
01243 
01244                 AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o3">Priority</a> = 0;
01245 
01246             } <span class="keywordflow">else</span> {
01247 
01248                 AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o3">Priority</a> = ReqList-&gt;ReqAlternativeCount;
01249 
01250             }
01251         }
01252 
01253         AssignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o8">Status</a> = STATUS_SUCCESS;
01254         <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>++;
01255 
01256         <span class="comment">//</span>
01257         <span class="comment">// As long as there is one entry established, we will return success.</span>
01258         <span class="comment">//</span>
01259 
01260         FinalStatus = STATUS_SUCCESS;
01261     }
01262     *DeviceCount = <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>;
01263     <span class="keywordflow">return</span> FinalStatus;
01264 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a71" doxytag="pnpres.c::IopIsBestConfiguration" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN IopIsBestConfiguration           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>VOID</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l02845">2845</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00766">_IOP_RESOURCE_REQUEST::Flags</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00755">IOP_ASSIGN_EXCLUDE</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00237">PiAssignTable</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00238">PiAssignTableCount</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00236">PiBestPriority</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00241">PiNoRetest</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00081">PREQ_ALTERNATIVE</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00083">PREQ_LIST</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00768">_IOP_RESOURCE_REQUEST::Priority</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00770">_IOP_RESOURCE_REQUEST::ReqList</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l03084">IopAssign()</a>.
<p>
<pre class="fragment"><div>02851                    :
02852 
02853     This routine checks <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current resource assignment yields <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> best score.
02854     If yes, <span class="keyword">this</span> routine updates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">static</span> variable to reflect <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> best score.
02855 
02856 Parameters:
02857 
02858     None.
02859 
02860 Return Value:
02861 
02862     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> or <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>.
02863 
02864 --*/
02865 
02866 {
02867     ULONG i, priority = 0;
02868     <a class="code" href="../../d5/d1/pnpres_8c.html#a29">PREQ_ALTERNATIVE</a> reqAlternative;
02869     <a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a> assignEntry;
02870 
02871     <span class="comment">//</span>
02872     <span class="comment">// If PiNoRetest is set.  There is only one.  So, it is the best.</span>
02873     <span class="comment">//</span>
02874 
02875     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d1/pnpres_8c.html#a43">PiNoRetest</a>) {
02876         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02877     }
02878 
02879     <span class="comment">//</span>
02880     <span class="comment">// Go thru all the assign tables to collect priority</span>
02881     <span class="comment">//</span>
02882 
02883     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d5/d1/pnpres_8c.html#a41">PiAssignTableCount</a>; i++) {
02884         assignEntry = <a class="code" href="../../d5/d1/pnpres_8c.html#a40">PiAssignTable</a> + i;
02885 
02886         <span class="keywordflow">if</span> (!(assignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o1">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a68">IOP_ASSIGN_EXCLUDE</a>)) {
02887             reqAlternative = *((<a class="code" href="../../d5/d1/pnpres_8c.html#a30">PREQ_LIST</a>)assignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o5">ReqList</a>)-&gt;SelectedAlternative;
02888             priority += reqAlternative-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o3">Priority</a>;
02889         }
02890     }
02891 
02892     <span class="comment">//</span>
02893     <span class="comment">// If the new priority is better than current best priority.</span>
02894     <span class="comment">// Update the current best.</span>
02895     <span class="comment">//</span>
02896 
02897     <span class="keywordflow">if</span> (priority &lt; <a class="code" href="../../d5/d1/pnpres_8c.html#a39">PiBestPriority</a>) {
02898         <a class="code" href="../../d5/d1/pnpres_8c.html#a39">PiBestPriority</a> = priority;
02899         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02900     } <span class="keywordflow">else</span> {
02901         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02902     }
02903 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a107" doxytag="pnpres.c::IopLegacyResourceAllocation" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopLegacyResourceAllocation           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d6/d9/pnp_8h.html#a58">ARBITER_REQUEST_SOURCE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>AllocationType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DriverObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PIO_RESOURCE_REQUIREMENTS_LIST&nbsp;</td>
          <td class="mdname" nowrap> <em>ResourceRequirements</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PCM_RESOURCE_LIST *AllocatedResources&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l06180">6180</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.
<p>
References <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00767">_IOP_RESOURCE_REQUEST::AllocationType</a>, <a class="el" href="../../d6/d9/pnp_8h.html#a174a129">ArbiterRequestPnpDetected</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00275">DebugMessage</a>, <a class="el" href="../../d4/d9/ke_8h.html#a407a202">DelayExecution</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00447">DNF_ASSIGNING_RESOURCES</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00453">DNF_RESOURCE_ASSIGNED</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00459">DNF_RESOURCE_REPORTED</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01306">DRVO_LEGACY_RESOURCES</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00267">DUMP_ERROR</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00071">ExAllocatePoolIORL</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00766">_IOP_RESOURCE_REQUEST::Flags</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00129">_DEVICE_NODE::Flags</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00757">IOP_ASSIGN_NO_REBALANCE</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00720">IopAllocateResources()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l06726">IopCombineLegacyResources()</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00054">IopDatabaseLock</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l03523">IopDetermineResourceListSize()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l05911">IopFindLegacyDeviceNode()</a>, <a class="el" href="../../d7/d8/pnp_8h-source.html#l00037">IoPnpDriverObject</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00337">IopRegistrySemaphore</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l07383">IopReleaseResources()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l06083">IopRemoveLegacyDeviceNode()</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00056">IopRootDeviceNode</a>, <a class="el" href="../../d9/d0/pnpiop_8h.html#a301">IopWriteAllocatedResourcesToRegistry()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01598">KeEnterCriticalRegion</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01628">KeLeaveCriticalRegion</a>, <a class="el" href="../../d2/d5/semphobj_8c-source.html#l00118">KeReleaseSemaphore()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html#o32">_DEVICE_NODE::OverUsed1</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00105">_DEVICE_NODE::Parent</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00765">_IOP_RESOURCE_REQUEST::PhysicalDevice</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00167">PnpDefaultInterfaceType</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00161">_DEVICE_NODE::ResourceList</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00163">_DEVICE_NODE::ResourceListTranslated</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00769">_IOP_RESOURCE_REQUEST::ResourceRequirements</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d8/d8/assign_8c-source.html#l00394">IoAssignResources()</a>, <a class="el" href="../../d3/d9/pnpdd_8c-source.html#l00263">IopReleaseDeviceResources()</a>, and <a class="el" href="../../d2/d7/report_8c-source.html#l00469">IoReportResourceUsageInternal()</a>.
<p>
<pre class="fragment"><div>06190                    :
06191 
06192     This routine handles legacy interface <a class="code" href="../../d0/d5/io_8h.html#a451">IoAssignResources</a> and IoReportResourcesUsage,
06193     It converts <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> request to call <a class="code" href="../../d9/d0/pnpiop_8h.html#a297">IopAllocateResources</a>.
06194 
06195 Parameters:
06196 
06197     AllocationType - Allocation <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> legacy request.
06198 
06199     DriverObject - Driver object doing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> legacy allocation.
06200 
06201     DeviceObject - Device object.
06202 
06203     ResourceRequirements - Legacy resource requirements. If <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, caller want to free resources.
06204 
06205     AllocatedResources - Pointer to a variable that receives pointer to allocated resources.
06206 
06207 Return Value:
06208 
06209     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> code that indicates whether or not <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function was successful.
06210 
06211 --*/
06212 
06213 {
06214     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>      pdo;
06215     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>        deviceNode;
06216     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>        legacyDeviceNode;
06217     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>            status;
06218     PCM_RESOURCE_LIST   combinedResources;
06219     KIRQL               irql;
06220 
06221     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(DriverObject);
06222 
06223     <span class="comment">//</span>
06224     <span class="comment">// Grab the IO registry semaphore to make sure no other device is</span>
06225     <span class="comment">// reporting it's resource usage while we are searching for conflicts.</span>
06226     <span class="comment">//</span>
06227 
06228     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
06229 
06230     status = <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;IopRegistrySemaphore,
06231                                     DelayExecution,
06232                                     KernelMode,
06233                                     FALSE,
06234                                     NULL);
06235     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
06236 
06237         status = <a class="code" href="../../d5/d1/pnpres_8c.html#a54">IopFindLegacyDeviceNode</a>(DriverObject, DeviceObject, &amp;deviceNode, &amp;pdo);
06238         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
06239 
06240             legacyDeviceNode = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
06241             <span class="keywordflow">if</span> (!deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o2">Parent</a> &amp;&amp; ResourceRequirements) {
06242 
06243                 <span class="comment">//</span>
06244                 <span class="comment">// Make IopRootDeviceNode the bus pdo so we will search the right bus pdo</span>
06245                 <span class="comment">// on resource descriptor level.</span>
06246                 <span class="comment">//</span>
06247 
06248                 <span class="keywordflow">if</span> (ResourceRequirements-&gt;InterfaceType == InterfaceTypeUndefined) {
06249 
06250                     ResourceRequirements-&gt;InterfaceType = <a class="code" href="../../d1/d0/pnpdata_8c.html#a23">PnpDefaultInterfaceType</a>;
06251 
06252                 }
06253                 deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o2">Parent</a> = <a class="code" href="../../d1/d0/pnpdata_8c.html#a5">IopRootDeviceNode</a>;
06254 
06255             }
06256 
06257             <span class="comment">//</span>
06258             <span class="comment">// Release resources for this device node.</span>
06259             <span class="comment">//</span>
06260 
06261             <span class="keywordflow">if</span> (    (!ResourceRequirements &amp;&amp; deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o2">Parent</a>) ||
06262                     (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; (<a class="code" href="../../d9/d0/pnpiop_8h.html#a19">DNF_RESOURCE_REPORTED</a> | <a class="code" href="../../d9/d0/pnpiop_8h.html#a18">DNF_RESOURCE_ASSIGNED</a>))) {
06263 
06264                 <a class="code" href="../../d5/d1/pnpres_8c.html#a88">IopReleaseResources</a>(deviceNode);
06265 
06266             }
06267 
06268             <span class="keywordflow">if</span> (ResourceRequirements) {
06269 
06270                 <a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">IOP_RESOURCE_REQUEST</a>    requestTable;
06271                 <a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">IOP_RESOURCE_REQUEST</a>    *requestTablep;
06272                 ULONG                   count;
06273 
06274                 <span class="comment">//</span>
06275                 <span class="comment">// Try to allocate these resource requirements.</span>
06276                 <span class="comment">//</span>
06277 
06278                 count = 1;
06279                 RtlZeroMemory(&amp;requestTable, <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">IOP_RESOURCE_REQUEST</a>));
06280                 requestTable.<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o4">ResourceRequirements</a> = ResourceRequirements;
06281                 requestTable.<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o0">PhysicalDevice</a> = pdo;
06282                 requestTable.<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o1">Flags</a> = <a class="code" href="../../d9/d0/pnpiop_8h.html#a70">IOP_ASSIGN_NO_REBALANCE</a>;
06283                 requestTable.<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o2">AllocationType</a> =  AllocationType;
06284 
06285                 deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a17">DNF_ASSIGNING_RESOURCES</a>;
06286                 requestTablep = &amp;requestTable;
06287                 <a class="code" href="../../d5/d1/pnpres_8c.html#a105">IopAllocateResources</a>(&amp;count, &amp;requestTablep, TRUE, TRUE);
06288                 deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp;= ~<a class="code" href="../../d9/d0/pnpiop_8h.html#a17">DNF_ASSIGNING_RESOURCES</a>;
06289                 status = requestTable.Status;
06290                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
06291 
06292                     deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a19">DNF_RESOURCE_REPORTED</a>;
06293                     <span class="comment">//deviceNode-&gt;Flags &amp;= ~DNF_INSUFFICIENT_RESOURCES;</span>
06294                     deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o11">ResourceListTranslated</a> = requestTable.TranslatedResourceAssignment;
06295                     count = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a21">IopDetermineResourceListSize</a>((*AllocatedResources) ? *AllocatedResources : requestTable.ResourceAssignment);
06296                     deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o10">ResourceList</a> = <a class="code" href="../../d5/d1/pnpres_8c.html#a12">ExAllocatePoolIORL</a>(PagedPool, count);
06297                     <span class="keywordflow">if</span> (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o10">ResourceList</a>) {
06298 
06299                         <span class="keywordflow">if</span> (*AllocatedResources) {
06300 
06301                             <span class="comment">//</span>
06302                             <span class="comment">// We got called from IoReportResourceUsage.</span>
06303                             <span class="comment">//</span>
06304 
06305                             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(requestTable.ResourceAssignment);
06306                             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(requestTable.ResourceAssignment);
06307 
06308                         } <span class="keywordflow">else</span> {
06309 
06310                             <span class="comment">//</span>
06311                             <span class="comment">// We got called from IoAssignResources.</span>
06312                             <span class="comment">//</span>
06313 
06314                             *AllocatedResources = requestTable.ResourceAssignment;
06315 
06316                         }
06317                         RtlCopyMemory(deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o10">ResourceList</a>, *AllocatedResources, count);
06318                         legacyDeviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o32">OverUsed1</a>.LegacyDeviceNode;
06319 
06320                     } <span class="keywordflow">else</span> {
06321 
06322                         deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o10">ResourceList</a> = requestTable.ResourceAssignment;
06323                         <a class="code" href="../../d5/d1/pnpres_8c.html#a88">IopReleaseResources</a>(deviceNode);
06324                         status = STATUS_INSUFFICIENT_RESOURCES;
06325 
06326                     }
06327                 }
06328 
06329                 <span class="comment">//</span>
06330                 <span class="comment">// Remove the madeup PDO and device node if there was some error.</span>
06331                 <span class="comment">//</span>
06332 
06333                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
06334 
06335                     <a class="code" href="../../d5/d1/pnpres_8c.html#a53">IopRemoveLegacyDeviceNode</a>(DeviceObject, deviceNode);
06336 
06337                 }
06338 
06339             } <span class="keywordflow">else</span> {
06340 
06341                 <span class="comment">//</span>
06342                 <span class="comment">// Caller wants to release resources.</span>
06343                 <span class="comment">//</span>
06344 
06345                 legacyDeviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o32">OverUsed1</a>.LegacyDeviceNode;
06346                 <a class="code" href="../../d5/d1/pnpres_8c.html#a53">IopRemoveLegacyDeviceNode</a>(DeviceObject, deviceNode);
06347 
06348             }
06349 
06350             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
06351 
06352                 <span class="keywordflow">if</span> (legacyDeviceNode) {
06353 
06354                     <span class="comment">//</span>
06355                     <span class="comment">// After the resource is modified, update the allocated resource list</span>
06356                     <span class="comment">// for the Root\Legacy_xxxx\0000 device instance.</span>
06357                     <span class="comment">//</span>
06358 
06359                     combinedResources = <a class="code" href="../../d5/d1/pnpres_8c.html#a91">IopCombineLegacyResources</a>(legacyDeviceNode);
06360                     <span class="keywordflow">if</span> (combinedResources) {
06361 
06362                         <a class="code" href="../../d9/d0/pnpiop_8h.html#a301">IopWriteAllocatedResourcesToRegistry</a>(   legacyDeviceNode,
06363                                                                 combinedResources,
06364                                                                 <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a21">IopDetermineResourceListSize</a>(combinedResources));
06365                         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(combinedResources);
06366                     }
06367                 }
06368 
06369                 <span class="comment">//</span>
06370                 <span class="comment">// BUGBUG: Santoshj 10/01/99</span>
06371                 <span class="comment">// Since IoReportDetectedDevice always uses IoPnpDriverObject instead of the one</span>
06372                 <span class="comment">// passed in, we put in this hack so that we dont taint ourselves. Other bugs need</span>
06373                 <span class="comment">// to be fixed before removing this hack (dont do resource allocation if this</span>
06374                 <span class="comment">// was already reported).</span>
06375                 <span class="comment">//</span>
06376 
06377                 <span class="keywordflow">if</span> (AllocationType != <a class="code" href="../../d6/d9/pnp_8h.html#a174a129">ArbiterRequestPnpDetected</a> &amp;&amp; DriverObject != <a class="code" href="../../d6/d9/pnp_8h.html#a14">IoPnpDriverObject</a>) {
06378                     <span class="comment">//</span>
06379                     <span class="comment">// Modify the DRVOBJ flags.</span>
06380                     <span class="comment">//</span>
06381                     ExAcquireFastLock(&amp;IopDatabaseLock, &amp;irql);
06382                     <span class="keywordflow">if</span> (ResourceRequirements) {
06383                         <span class="comment">//</span>
06384                         <span class="comment">// Once tainted, a driver can never lose it's legacy history</span>
06385                         <span class="comment">// (unless unloaded). This is because the device object</span>
06386                         <span class="comment">// field is optional, and we don't bother counting here...</span>
06387                         <span class="comment">//</span>
06388                         DriverObject-&gt;Flags |= <a class="code" href="../../d0/d5/io_8h.html#a149">DRVO_LEGACY_RESOURCES</a>;
06389                     }
06390                     ExReleaseFastLock(&amp;IopDatabaseLock, irql);
06391                 }
06392             }
06393         }
06394 
06395         <a class="code" href="../../d1/d6/semphobj_8c.html#a3">KeReleaseSemaphore</a>(&amp;IopRegistrySemaphore, 0, 1, FALSE);
06396 
06397     } <span class="keywordflow">else</span> {
06398 
06399         <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(DUMP_ERROR, (<span class="stringliteral">"PNPRES: IopLegacyResourceAllocation: Failed to acquire registry semaphore, status %08X\n"</span>, status));
06400     }
06401 
06402     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
06403 
06404     <span class="keywordflow">return</span> status;
06405 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a95" doxytag="pnpres.c::IopNeedToReleaseBootResources" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN IopNeedToReleaseBootResources           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceNode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PCM_RESOURCE_LIST&nbsp;</td>
          <td class="mdname" nowrap> <em>AllocatedResources</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l02391">2391</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.
<p>
References <a class="el" href="../../d0/d1/fedefs_8h-source.html#l00051">exit</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l02474">IopReleaseFilteredBootResources()</a>.
<p>
<pre class="fragment"><div>02398                    :
02399 
02400     This routine checks <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> AllocatedResources against boot allocated resources.
02401     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> allocated resources <span class="keywordflow">do</span> not cover all <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resource types in boot resources,
02402     in another words some types of boot resources have not been released by arbiter,
02403     we will <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> to indicate we need to release <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> boot resources manually.
02404 
02405 Parameters:
02406 
02407     DeviceNode -  <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> device node
02408 
02409     AllocatedResources - <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resources assigned to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> devicenode by arbiters.
02410 
02411 Return Value:
02412 
02413     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> or <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>.
02414 
02415 --*/
02416 
02417 {
02418     PCM_FULL_RESOURCE_DESCRIPTOR cmFullDesc_a, cmFullDesc_b;
02419     PCM_PARTIAL_RESOURCE_DESCRIPTOR cmDescriptor_a, cmDescriptor_b;
02420     ULONG size_a, size_b, i, j, k;
02421     BOOLEAN returnValue = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, found;
02422     PCM_RESOURCE_LIST bootResources;
02423 
02424     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02425 
02426     bootResources = DeviceNode-&gt;BootResources;
02427     <span class="keywordflow">if</span> (AllocatedResources-&gt;Count == 1 &amp;&amp; bootResources &amp;&amp; bootResources-&gt;Count != 0) {
02428 
02429         cmFullDesc_a = &amp;AllocatedResources-&gt;List[0];
02430         cmFullDesc_b = &amp;bootResources-&gt;List[0];
02431         <span class="keywordflow">for</span> (i = 0; i &lt; bootResources-&gt;Count; i++) {
02432             cmDescriptor_b = &amp;cmFullDesc_b-&gt;PartialResourceList.PartialDescriptors[0];
02433             <span class="keywordflow">for</span> (j = 0; j &lt; cmFullDesc_b-&gt;PartialResourceList.Count; j++) {
02434                 size_b = 0;
02435                 <span class="keywordflow">switch</span> (cmDescriptor_b-&gt;Type) {
02436                 <span class="keywordflow">case</span> CmResourceTypeNull:
02437                     <span class="keywordflow">break</span>;
02438                 <span class="keywordflow">case</span> CmResourceTypeDeviceSpecific:
02439                      size_b = cmDescriptor_b-&gt;u.DeviceSpecificData.DataSize;
02440                      <span class="keywordflow">break</span>;
02441                 <span class="keywordflow">default</span>:
02442                      <span class="keywordflow">if</span> (cmDescriptor_b-&gt;Type &lt; CmResourceTypeMaximum) {
02443                          found = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02444                          cmDescriptor_a = &amp;cmFullDesc_a-&gt;PartialResourceList.PartialDescriptors[0];
02445                          <span class="keywordflow">for</span> (k = 0; k &lt; cmFullDesc_a-&gt;PartialResourceList.Count; k++) {
02446                              size_a = 0;
02447                              <span class="keywordflow">if</span> (cmDescriptor_a-&gt;Type == CmResourceTypeDeviceSpecific) {
02448                                  size_a = cmDescriptor_a-&gt;u.DeviceSpecificData.DataSize;
02449                              } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cmDescriptor_b-&gt;Type == cmDescriptor_a-&gt;Type) {
02450                                  found = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02451                                  <span class="keywordflow">break</span>;
02452                              }
02453                              cmDescriptor_a++;
02454                              cmDescriptor_a = (PCM_PARTIAL_RESOURCE_DESCRIPTOR) ((PUCHAR)cmDescriptor_a + size_a);
02455                          }
02456                          <span class="keywordflow">if</span> (found == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
02457                              returnValue = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02458                              <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
02459                          }
02460                      }
02461                 }
02462                 cmDescriptor_b++;
02463                 cmDescriptor_b = (PCM_PARTIAL_RESOURCE_DESCRIPTOR) ((PUCHAR)cmDescriptor_b + size_b);
02464             }
02465             cmFullDesc_b = (PCM_FULL_RESOURCE_DESCRIPTOR)cmDescriptor_b;
02466         }
02467     }
02468 <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>:
02469     <span class="keywordflow">return</span> returnValue;
02470 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a76" doxytag="pnpres.c::IopParentToRawTranslation" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopParentToRawTranslation           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT <a class="el" href="../../d5/d1/pnpres_8c.html#a28">PREQ_DESC</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>ReqDesc</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l03868">3868</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d8/pnp_8h-source.html#l00891">_TRANSLATOR_INTERFACE::Context</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00275">DebugMessage</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00267">DUMP_ERROR</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00151">IS_TRANSLATED_REQ_DESC</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00079">PREQ_DESC</a>, <a class="el" href="../../d6/d9/pnp_8h.html#a176a136">TranslateParentToChild</a>, and <a class="el" href="../../d7/d8/pnp_8h-source.html#l00894">_TRANSLATOR_INTERFACE::TranslateResources</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l02034">IopBuildCmResourceList()</a>.
<p>
<pre class="fragment"><div>03874                    :
03875 
03876     This routine translates an CmPartialResourceDescriptors
03877     from their translated form to their raw counterparts..
03878 
03879 Parameters:
03880 
03881     ReqDesc - supplies a translated ReqDesc to be translated back to its raw form
03882 
03883 Return Value:
03884 
03885     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> code that indicates whether or not <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function was successful.
03886 
03887 --*/
03888 {
03889     <a class="code" href="../../d3/d2/struct__TRANSLATOR__INTERFACE.html">PTRANSLATOR_INTERFACE</a> translator;
03890     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status = STATUS_SUCCESS;
03891     <a class="code" href="../../d5/d1/pnpres_8c.html#a28">PREQ_DESC</a> rawReqDesc;
03892 
03893     <span class="keywordflow">if</span> (ReqDesc-&gt;AlternativeTable.AlternativeCount == 0 ||
03894         ReqDesc-&gt;Allocation.Type == CmResourceTypeMaximum) {
03895         <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(DUMP_ERROR, (<span class="stringliteral">"PnpRes : Invalid ReqDesc for parent-to-raw translation.\n"</span>));
03896         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
03897     }
03898 
03899     <span class="comment">//</span>
03900     <span class="comment">// If this ReqDesc is the raw reqDesc then we are done.</span>
03901     <span class="comment">// Else call its translator to translate the resource and leave the result</span>
03902     <span class="comment">// in its raw (next level) reqdesc.</span>
03903     <span class="comment">//</span>
03904 
03905     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d1/pnpres_8c.html#a14">IS_TRANSLATED_REQ_DESC</a>(ReqDesc)) {
03906         rawReqDesc = ReqDesc-&gt;TranslatedReqDesc;
03907         translator = ReqDesc-&gt;u.Translator-&gt;TranslatorInterface;
03908         status = (translator-&gt;<a class="code" href="../../d3/d2/struct__TRANSLATOR__INTERFACE.html#o5">TranslateResources</a>)(
03909                       translator-&gt;<a class="code" href="../../d3/d2/struct__TRANSLATOR__INTERFACE.html#o2">Context</a>,
03910                       ReqDesc-&gt;AlternativeTable.Assignment,
03911                       <a class="code" href="../../d6/d9/pnp_8h.html#a176a136">TranslateParentToChild</a>,
03912                       rawReqDesc-&gt;AlternativeTable.AlternativeCount,
03913                       rawReqDesc-&gt;AlternativeTable.Alternatives,
03914                       rawReqDesc-&gt;AlternativeTable.PhysicalDeviceObject,
03915                       rawReqDesc-&gt;AlternativeTable.Assignment
03916                       );
03917         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03918 
03919             <span class="comment">//</span>
03920             <span class="comment">// If the translator is non-hierarchial and performs a complete</span>
03921             <span class="comment">// translation to root (eg ISA interrups for PCI devices) then</span>
03922             <span class="comment">// don't pass translations to parent.</span>
03923             <span class="comment">//</span>
03924 
03925             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(status != STATUS_TRANSLATION_COMPLETE);
03926             status = <a class="code" href="../../d5/d1/pnpres_8c.html#a76">IopParentToRawTranslation</a>(rawReqDesc);
03927         }
03928     }
03929     <span class="keywordflow">return</span> status;
03930 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a68" doxytag="pnpres.c::IopPlacement" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopPlacement           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d6/d9/pnp_8h.html#a52">ARBITER_ACTION</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ArbiterAction</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>Rebalance</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l02554">2554</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.
<p>
References <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00713">_PI_RESOURCE_ARBITER_ENTRY::ActiveArbiterList</a>, <a class="el" href="../../d6/d9/pnp_8h.html#a173a117">ArbiterActionCommitAllocation</a>, <a class="el" href="../../d6/d9/pnp_8h.html#a173a116">ArbiterActionRetestAllocation</a>, <a class="el" href="../../d6/d9/pnp_8h.html#a173a115">ArbiterActionTestAllocation</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00712">_PI_RESOURCE_ARBITER_ENTRY::BestConfig</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00711">_PI_RESOURCE_ARBITER_ENTRY::BestResourceList</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l04339">IopCallArbiter()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l04946">IopPlacementForRebalance()</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00056">IopRootDeviceNode</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00722">PI_ARBITER_HAS_SOMETHING</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00723">PI_ARBITER_TEST_FAILED</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00234">PiActiveArbiterList</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00710">_PI_RESOURCE_ARBITER_ENTRY::ResourceList</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00715">_PI_RESOURCE_ARBITER_ENTRY::ResourcesChanged</a>, and <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00714">_PI_RESOURCE_ARBITER_ENTRY::State</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l03084">IopAssign()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l03292">IopAssignInner()</a>, and <a class="el" href="../../d6/d0/pnpres_8c-source.html#l05215">IopRebalance()</a>.
<p>
<pre class="fragment"><div>02561                    :
02562 
02563     This routine examines each arbiter <span class="keywordflow">if</span> its resreq list changed its test function will be
02564     called.
02565 
02566 Parameters:
02567 
02568     ArbiterAction - supplies an arbiter action code to perform TEST or RETEST.
02569 
02570 Return Value:
02571 
02572     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> code that indicates whether or not <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function was successful.
02573 
02574 --*/
02575 
02576 {
02577     PLIST_ENTRY listEntry;
02578     <a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html">PPI_RESOURCE_ARBITER_ENTRY</a> arbiterEntry;
02579     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
02580 
02581     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((ArbiterAction == ArbiterActionTestAllocation)   ||
02582            (ArbiterAction == ArbiterActionRetestAllocation) ||
02583            (ArbiterAction == ArbiterActionCommitAllocation));
02584 
02585     <span class="keywordflow">if</span> (Rebalance) {
02586 
02587         <span class="comment">//</span>
02588         <span class="comment">// For rebalance case, we always start from the root and work our way up.</span>
02589         <span class="comment">//</span>
02590 
02591         status = <a class="code" href="../../d5/d1/pnpres_8c.html#a83">IopPlacementForRebalance</a> (IopRootDeviceNode, ArbiterAction);
02592     } <span class="keywordflow">else</span> {
02593         listEntry = <a class="code" href="../../d5/d1/pnpres_8c.html#a37">PiActiveArbiterList</a>.Flink;
02594         <span class="keywordflow">while</span> (listEntry != &amp;<a class="code" href="../../d5/d1/pnpres_8c.html#a37">PiActiveArbiterList</a>) {
02595             arbiterEntry = CONTAINING_RECORD(listEntry, <a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html">PI_RESOURCE_ARBITER_ENTRY</a>, ActiveArbiterList);
02596             listEntry = listEntry-&gt;Flink;
02597             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(IsListEmpty(&amp;arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o3">ResourceList</a>) == FALSE);
02598             <span class="keywordflow">if</span> (arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o8">ResourcesChanged</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
02599 
02600                 <span class="comment">//</span>
02601                 <span class="comment">// If the resource requirements are the same and it failed before, we know it</span>
02602                 <span class="comment">// won't be able to succeed.  So, return failure.</span>
02603                 <span class="comment">//</span>
02604 
02605                 <span class="keywordflow">if</span> (arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o7">State</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a59">PI_ARBITER_TEST_FAILED</a>) {
02606                     <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
02607                 }
02608             } <span class="keywordflow">else</span> {
02609 
02610                 <span class="comment">//</span>
02611                 <span class="comment">// If the resource requirements are changed, we need to call arbiter to test it.</span>
02612                 <span class="comment">//</span>
02613 
02614                 status = <a class="code" href="../../d5/d1/pnpres_8c.html#a79">IopCallArbiter</a>(arbiterEntry,
02615                                         ArbiterAction,
02616                                         &amp;arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o3">ResourceList</a>,
02617                                         0,
02618                                         NULL
02619                                         );
02620                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02621                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ArbiterAction == ArbiterActionTestAllocation);
02622                     arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o7">State</a> |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a59">PI_ARBITER_TEST_FAILED</a>;
02623                     <span class="keywordflow">return</span> status;
02624                 } <span class="keywordflow">else</span> {
02625                     arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o7">State</a> &amp;= ~<a class="code" href="../../d9/d0/pnpiop_8h.html#a59">PI_ARBITER_TEST_FAILED</a>;
02626                     arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o8">ResourcesChanged</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02627                     <span class="keywordflow">if</span> (ArbiterAction == <a class="code" href="../../d6/d9/pnp_8h.html#a173a115">ArbiterActionTestAllocation</a>) {
02628                         arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o7">State</a> |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a58">PI_ARBITER_HAS_SOMETHING</a>;
02629                     } <span class="keywordflow">else</span> {
02630                         <span class="keywordflow">if</span> (ArbiterAction == <a class="code" href="../../d6/d9/pnp_8h.html#a173a116">ArbiterActionRetestAllocation</a>) {
02631                             status = <a class="code" href="../../d5/d1/pnpres_8c.html#a79">IopCallArbiter</a>(arbiterEntry, ArbiterActionCommitAllocation, NULL, NULL, NULL);
02632                             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(status == STATUS_SUCCESS);
02633                         }
02634                         arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o7">State</a> = 0;
02635                         InitializeListHead(&amp;arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o6">ActiveArbiterList</a>);
02636                         InitializeListHead(&amp;arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o5">BestConfig</a>);
02637                         InitializeListHead(&amp;arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o3">ResourceList</a>);
02638                         InitializeListHead(&amp;arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o4">BestResourceList</a>);
02639                     }
02640                 }
02641             }
02642         }
02643         status = STATUS_SUCCESS;
02644     }
02645     <span class="keywordflow">return</span> status;
02646 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a83" doxytag="pnpres.c::IopPlacementForRebalance" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopPlacementForRebalance           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceNode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d6/d9/pnp_8h.html#a52">ARBITER_ACTION</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ArbiterAction</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l04946">4946</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.
<p>
References <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00099">_DEVICE_NODE::Child</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l05016">IopArbitrateDeviceResources()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00301">_DEVICE_NODE::LockCount</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, and <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00093">_DEVICE_NODE::Sibling</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l02554">IopPlacement()</a>.
<p>
<pre class="fragment"><div>04953                    :
04954 
04955     This routine walks <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device tree bredth-first to arbitrate resources <span class="keywordflow">for</span>
04956     device node <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> visits.
04957 
04958 Parameters:
04959 
04960     DeviceNode - supplies a pointer to a device node whoes subtree needs to be rebalanced.
04961 
04962     ArbiterAction - specifies TEST or RETEST.
04963 
04964 Return Value:
04965 
04966     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> code that indicates whether or not <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function was successful.
04967 
04968 --*/
04969 
04970 {
04971     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status = STATUS_SUCCESS;
04972     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> node;
04973 
04974     <span class="comment">//</span>
04975     <span class="comment">// Perform breadth-first.  Arbitrate resource for the current device node;</span>
04976     <span class="comment">// Place resources for its sibling subtree and then child subtree.</span>
04977     <span class="comment">//</span>
04978 
04979     node = DeviceNode;
04980     <span class="keywordflow">while</span> (node) {
04981 
04982         <span class="comment">//</span>
04983         <span class="comment">// Arbitrate device resources iff its not locked for remove.</span>
04984         <span class="comment">//</span>
04985 
04986         <span class="keywordflow">if</span> (node-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o36">LockCount</a> == 0) {
04987 
04988             status = <a class="code" href="../../d5/d1/pnpres_8c.html#a84">IopArbitrateDeviceResources</a> (node, ArbiterAction);
04989             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04990                 <span class="keywordflow">return</span> status;
04991             }
04992         }
04993         node = node-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o0">Sibling</a>;
04994     }
04995     node = DeviceNode;
04996     <span class="keywordflow">while</span> (node) {
04997 
04998         <span class="comment">//</span>
04999         <span class="comment">// If this subtree is not being removed, then process it.</span>
05000         <span class="comment">//</span>
05001 
05002         <span class="keywordflow">if</span> (node-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o1">Child</a> &amp;&amp; node-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o36">LockCount</a> == 0) {
05003 
05004             status = <a class="code" href="../../d5/d1/pnpres_8c.html#a83">IopPlacementForRebalance</a> (node-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o1">Child</a>, ArbiterAction);
05005             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
05006                 <span class="keywordflow">return</span> status;
05007             }
05008         }
05009         node = node-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o0">Sibling</a>;
05010     }
05011 
05012     <span class="keywordflow">return</span> status;
05013 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a92" doxytag="pnpres.c::IopPlacementForReservation" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopPlacementForReservation           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l02649">2649</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.
<p>
References <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00713">_PI_RESOURCE_ARBITER_ENTRY::ActiveArbiterList</a>, <a class="el" href="../../d7/d8/pnp_8h-source.html#l00744">_ARBITER_LIST_ENTRY::AlternativeCount</a>, <a class="el" href="../../d7/d8/pnp_8h-source.html#l00749">_ARBITER_LIST_ENTRY::Alternatives</a>, <a class="el" href="../../d6/d9/pnp_8h.html#a173a124">ArbiterActionBootAllocation</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00712">_PI_RESOURCE_ARBITER_ENTRY::BestConfig</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00711">_PI_RESOURCE_ARBITER_ENTRY::BestResourceList</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l04339">IopCallArbiter()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l04533">IopDumpResourceDescriptor()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d8/pnp_8h-source.html#l00754">_ARBITER_LIST_ENTRY::PhysicalDeviceObject</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00234">PiActiveArbiterList</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00710">_PI_RESOURCE_ARBITER_ENTRY::ResourceList</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00715">_PI_RESOURCE_ARBITER_ENTRY::ResourcesChanged</a>, and <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00714">_PI_RESOURCE_ARBITER_ENTRY::State</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l03376">IopReserve()</a>.
<p>
<pre class="fragment"><div>02655                    :
02656 
02657     This routine examines each arbiter <span class="keywordflow">if</span> its resreq list changed its test function will be
02658     called.
02659 
02660 Parameters:
02661 
02662     None.
02663 
02664 Return Value:
02665 
02666     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> code that indicates whether or not <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function was successful.
02667 
02668 --*/
02669 
02670 {
02671     PLIST_ENTRY listEntry;
02672     <a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html">PPI_RESOURCE_ARBITER_ENTRY</a> arbiterEntry;
02673     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status, returnStatus = STATUS_SUCCESS;
02674 
02675     listEntry = <a class="code" href="../../d5/d1/pnpres_8c.html#a37">PiActiveArbiterList</a>.Flink;
02676     <span class="keywordflow">while</span> (listEntry != &amp;<a class="code" href="../../d5/d1/pnpres_8c.html#a37">PiActiveArbiterList</a>) {
02677         arbiterEntry = CONTAINING_RECORD(listEntry, <a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html">PI_RESOURCE_ARBITER_ENTRY</a>, ActiveArbiterList);
02678         listEntry = listEntry-&gt;Flink;
02679         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(IsListEmpty(&amp;arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o3">ResourceList</a>) == FALSE);
02680         <span class="keywordflow">if</span> (arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o8">ResourcesChanged</a>) {
02681 
02682             <span class="comment">//</span>
02683             <span class="comment">// If the resource requirements are changed, we need to call arbiter to reserve it.</span>
02684             <span class="comment">//</span>
02685 
02686             status = <a class="code" href="../../d5/d1/pnpres_8c.html#a79">IopCallArbiter</a>(arbiterEntry,
02687                                     ArbiterActionBootAllocation,
02688                                     &amp;arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o3">ResourceList</a>,
02689                                     0,
02690                                     NULL
02691                                     );
02692             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02693 <span class="preprocessor">#if MYDBG</span>
02694 <span class="preprocessor"></span>                <a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html">PARBITER_LIST_ENTRY</a> arbiterListEntry = (<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html">PARBITER_LIST_ENTRY</a>) arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o3">ResourceList</a>.Flink;
02695                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Allocate Boot Resources Failed ::\n"</span>);
02696                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"        Count = %x, PDO = %x\n"</span>,
02697                          arbiterListEntry-&gt;<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o1">AlternativeCount</a>, arbiterListEntry-&gt;<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o3">PhysicalDeviceObject</a>);
02698                 <a class="code" href="../../d5/d1/pnpres_8c.html#a98">IopDumpResourceDescriptor</a>(
02699                    <span class="stringliteral">"        "</span>,
02700                    arbiterListEntry-&gt;<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o2">Alternatives</a>);
02701 <span class="preprocessor">#endif</span>
02702 <span class="preprocessor"></span>                returnStatus = status;
02703             }
02704             arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o8">ResourcesChanged</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02705             arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o7">State</a> = 0;
02706             InitializeListHead(&amp;arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o6">ActiveArbiterList</a>);
02707             InitializeListHead(&amp;arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o5">BestConfig</a>);
02708             InitializeListHead(&amp;arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o3">ResourceList</a>);
02709             InitializeListHead(&amp;arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o4">BestResourceList</a>);
02710         }
02711     }
02712     <span class="keywordflow">return</span> returnStatus;
02713 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a102" doxytag="pnpres.c::IopQueryConflictFillConflicts" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopQueryConflictFillConflicts           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PhysicalDeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ConflictCount</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d7/d7/struct__ARBITER__CONFLICT__INFO.html">PARBITER_CONFLICT_INFO</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ConflictInfoList</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PPLUGPLAY_CONTROL_CONFLICT_LIST&nbsp;</td>
          <td class="mdname" nowrap> <em>ConflictList</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ConflictListSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Flags</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l08022">8022</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.
<p>
References <a class="el" href="../../d6/d9/pnp_8h.html#a54">ARBITER_CONFLICT_INFO</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00275">DebugMessage</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00269">DUMP_DETAIL</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l07775">IopEliminateBogusConflict()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l07876">IopQueryConflictFillString()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l08336">IopQueryConflictListInternal()</a>.
<p>
<pre class="fragment"><div>08032                    :
08033 
08034     Fill ConflictList with information on as many conflicts as possible
08035 
08036 Arguments:
08037 
08038     PhysicalDeviceObject The PDO we're performing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> test on
08039     ConflictCount       Number of Conflicts.
08040     ConflictInfoList    <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a> of conflicting device info, can be <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> <span class="keywordflow">if</span> ConflictCount <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> 0
08041     ConflictList        Structure to fill in with conflicts
08042     ConflictListSize    <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> of Conflict <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>
08043     Flags               <span class="keywordflow">if</span> non-zero, <a class="code" href="../../d0/d2/config_2test_2init386_8c.html#a0">dummy</a> conflict <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> created
08044 
08045 Return Value:
08046 
08047     Should be success in most cases
08048 
08049 --*/
08050 {
08051     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status = STATUS_SUCCESS;
08052     ULONG ConflictListIdealSize;
08053     ULONG ConflictListBaseSize;
08054     ULONG ConflictListCount;
08055     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
08056     ULONG ConflictIndex;
08057     ULONG EntrySize;
08058     ULONG ConflictStringsOffset;
08059     ULONG stringSize;
08060     ULONG stringTotalSize;
08061     ULONG DummyCount;
08062     PPLUGPLAY_CONTROL_CONFLICT_STRINGS ConfStrings;
08063 
08064     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
08065 
08066     <span class="comment">//</span>
08067     <span class="comment">// determine how many conflicts we can</span>
08068     <span class="comment">//</span>
08069     <span class="comment">// for each conflict</span>
08070     <span class="comment">// translate to bus/resource/address in respect to conflicting device</span>
08071     <span class="comment">// add to conflict list</span>
08072     <span class="comment">//</span>
08073     <span class="comment">//</span>
08074 
08075     <span class="comment">//</span>
08076     <span class="comment">// preprocessing - given our ConflictInfoList and ConflictCount</span>
08077     <span class="comment">// remove any that appear to be bogus - ie, that are the same device that we are testing against</span>
08078     <span class="comment">// this stops mostly legacy issues</span>
08079     <span class="comment">//</span>
08080     <span class="keywordflow">for</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0;<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; ConflictCount; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>++) {
08081         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d1/pnpres_8c.html#a104">IopEliminateBogusConflict</a>(PhysicalDeviceObject,ConflictInfoList[Index].OwningObject)) {
08082 
08083             <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(DUMP_DETAIL, (<span class="stringliteral">"IopQueryConflictFillConflicts: eliminating \"identical\" PDO %08x conflicting with self (%08x)\n"</span>,
08084                                         ConflictInfoList[Index].OwningObject,PhysicalDeviceObject));
08085             <span class="comment">//</span>
08086             <span class="comment">// move the last listed conflict into this space</span>
08087             <span class="comment">//</span>
08088             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>+1 &lt; ConflictCount) {
08089                 RtlCopyMemory(&amp;ConflictInfoList[Index],&amp;ConflictInfoList[ConflictCount-1],<span class="keyword">sizeof</span>(<a class="code" href="../../d7/d7/struct__ARBITER__CONFLICT__INFO.html">ARBITER_CONFLICT_INFO</a>));
08090             }
08091             <span class="comment">//</span>
08092             <span class="comment">// account for deleting this item</span>
08093             <span class="comment">//</span>
08094             ConflictCount--;
08095             <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>--;
08096         }
08097     }
08098 
08099     <span class="comment">//</span>
08100     <span class="comment">// preprocessing - in our conflict list, we may have PDO's for legacy devices, and resource nodes for the same</span>
08101     <span class="comment">// or other duplicate entities (we only ever want to report a conflict once, even if there's multiple conflicting ranges)</span>
08102     <span class="comment">//</span>
08103 
08104   RestartScan:
08105 
08106     <span class="keywordflow">for</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0;<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; ConflictCount; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>++) {
08107         <span class="keywordflow">if</span> (ConflictInfoList[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].OwningObject != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
08108 
08109             ULONG Index2;
08110 
08111             <span class="keywordflow">for</span> (Index2 = <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>+1; Index2 &lt; ConflictCount; Index2++) {
08112                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d1/pnpres_8c.html#a104">IopEliminateBogusConflict</a>(ConflictInfoList[Index].OwningObject,ConflictInfoList[Index2].OwningObject)) {
08113                     <span class="comment">//</span>
08114                     <span class="comment">// Index2 is considered a dup of Index</span>
08115                     <span class="comment">//</span>
08116 
08117                     <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(DUMP_DETAIL, (<span class="stringliteral">"IopQueryConflictFillConflicts: eliminating \"identical\" PDO %08x conflicting with PDO %08x\n"</span>,
08118                                                 ConflictInfoList[Index2].OwningObject,ConflictInfoList[Index].OwningObject));
08119                     <span class="comment">//</span>
08120                     <span class="comment">// move the last listed conflict into this space</span>
08121                     <span class="comment">//</span>
08122                     <span class="keywordflow">if</span> (Index2+1 &lt; ConflictCount) {
08123                         RtlCopyMemory(&amp;ConflictInfoList[Index2],&amp;ConflictInfoList[ConflictCount-1],<span class="keyword">sizeof</span>(<a class="code" href="../../d7/d7/struct__ARBITER__CONFLICT__INFO.html">ARBITER_CONFLICT_INFO</a>));
08124                     }
08125                     <span class="comment">//</span>
08126                     <span class="comment">// account for deleting this item</span>
08127                     <span class="comment">//</span>
08128                     ConflictCount--;
08129                     Index2--;
08130                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d5/d1/pnpres_8c.html#a104">IopEliminateBogusConflict</a>(ConflictInfoList[Index2].OwningObject,ConflictInfoList[Index].OwningObject)) {
08131                     <span class="comment">//</span>
08132                     <span class="comment">// Index is considered a dup of Index2 (some legacy case)</span>
08133                     <span class="comment">//</span>
08134                     <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(DUMP_DETAIL, (<span class="stringliteral">"IopQueryConflictFillConflicts: eliminating \"identical\" PDO %08x conflicting with PDO %08x\n"</span>,
08135                                                 ConflictInfoList[Index2].OwningObject,ConflictInfoList[Index].OwningObject));
08136                     <span class="comment">//</span>
08137                     <span class="comment">// move the one we want (Index2) into the space occupied by Index</span>
08138                     <span class="comment">//</span>
08139                     RtlCopyMemory(&amp;ConflictInfoList[Index],&amp;ConflictInfoList[Index2],<span class="keyword">sizeof</span>(<a class="code" href="../../d7/d7/struct__ARBITER__CONFLICT__INFO.html">ARBITER_CONFLICT_INFO</a>));
08140                     <span class="comment">//</span>
08141                     <span class="comment">// move the last listed conflict into the space we just created</span>
08142                     <span class="comment">//</span>
08143                     <span class="keywordflow">if</span> (Index2+1 &lt; ConflictCount) {
08144                         RtlCopyMemory(&amp;ConflictInfoList[Index2],&amp;ConflictInfoList[ConflictCount-1],<span class="keyword">sizeof</span>(<a class="code" href="../../d7/d7/struct__ARBITER__CONFLICT__INFO.html">ARBITER_CONFLICT_INFO</a>));
08145                     }
08146                     <span class="comment">//</span>
08147                     <span class="comment">// account for deleting this item</span>
08148                     <span class="comment">//</span>
08149                     ConflictCount--;
08150                     <span class="comment">//</span>
08151                     <span class="comment">// but as this is quirky, restart the scan</span>
08152                     <span class="comment">//</span>
08153                     <span class="keywordflow">goto</span> RestartScan;
08154                 }
08155             }
08156         }
08157     }
08158 
08159     <span class="comment">//</span>
08160     <span class="comment">// preprocessing - if we have any known reported conflicts, don't report back any unknown</span>
08161     <span class="comment">//</span>
08162 
08163     <span class="keywordflow">for</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0;<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; ConflictCount; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>++) {
08164         <span class="comment">//</span>
08165         <span class="comment">// find first unknown</span>
08166         <span class="comment">//</span>
08167         <span class="keywordflow">if</span> (ConflictInfoList[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].OwningObject == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
08168             <span class="comment">//</span>
08169             <span class="comment">// eliminate all other unknowns</span>
08170             <span class="comment">//</span>
08171 
08172             ULONG Index2;
08173 
08174             <span class="keywordflow">for</span> (Index2 = <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>+1; Index2 &lt; ConflictCount; Index2++) {
08175                 <span class="keywordflow">if</span> (ConflictInfoList[Index2].OwningObject == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
08176 
08177                     <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(DUMP_DETAIL, (<span class="stringliteral">"IopQueryConflictFillConflicts: eliminating extra unknown\n"</span>));
08178                     <span class="comment">//</span>
08179                     <span class="comment">// move the last listed conflict into this space</span>
08180                     <span class="comment">//</span>
08181                     <span class="keywordflow">if</span> (Index2+1 &lt; ConflictCount) {
08182                         RtlCopyMemory(&amp;ConflictInfoList[Index2],&amp;ConflictInfoList[ConflictCount-1],<span class="keyword">sizeof</span>(<a class="code" href="../../d7/d7/struct__ARBITER__CONFLICT__INFO.html">ARBITER_CONFLICT_INFO</a>));
08183                     }
08184                     <span class="comment">//</span>
08185                     <span class="comment">// account for deleting this item</span>
08186                     <span class="comment">//</span>
08187                     ConflictCount--;
08188                     Index2--;
08189                 }
08190             }
08191 
08192             <span class="keywordflow">if</span>(ConflictCount != 1) {
08193 
08194                 <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(DUMP_DETAIL, (<span class="stringliteral">"IopQueryConflictFillConflicts: eliminating first unknown\n"</span>));
08195                 <span class="comment">//</span>
08196                 <span class="comment">// there were others, so ignore the unknown</span>
08197                 <span class="comment">//</span>
08198                 <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>+1 &lt; ConflictCount) {
08199                     RtlCopyMemory(&amp;ConflictInfoList[Index],&amp;ConflictInfoList[ConflictCount-1],<span class="keyword">sizeof</span>(<a class="code" href="../../d7/d7/struct__ARBITER__CONFLICT__INFO.html">ARBITER_CONFLICT_INFO</a>));
08200                 }
08201                 ConflictCount --;
08202             }
08203 
08204             <span class="keywordflow">break</span>;
08205         }
08206     }
08207 
08208     <span class="comment">//</span>
08209     <span class="comment">// set number of actual and listed conflicts</span>
08210     <span class="comment">//</span>
08211 
08212     ConflictListIdealSize = (<span class="keyword">sizeof</span>(PLUGPLAY_CONTROL_CONFLICT_LIST) - <span class="keyword">sizeof</span>(PLUGPLAY_CONTROL_CONFLICT_ENTRY)) + <span class="keyword">sizeof</span>(PLUGPLAY_CONTROL_CONFLICT_STRINGS);
08213     ConflictListCount = 0;
08214     stringTotalSize = 0;
08215     DummyCount = 0;
08216 
08217     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ConflictListSize &gt;= ConflictListIdealSize); <span class="comment">// we should have checked to see if buffer is at least this big</span>
08218 
08219     <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(DUMP_DETAIL, (<span class="stringliteral">"IopQueryConflictFillConflicts: Detected %d conflicts\n"</span>, ConflictCount));
08220 
08221     <span class="comment">//</span>
08222     <span class="comment">// estimate sizes</span>
08223     <span class="comment">//</span>
08224     <span class="keywordflow">if</span> (Flags) {
08225         <span class="comment">//</span>
08226         <span class="comment">// flags entry required (ie resource not available for some specified reason)</span>
08227         <span class="comment">//</span>
08228         stringSize = 1; <span class="comment">// null-length string</span>
08229         DummyCount ++;
08230         EntrySize = <span class="keyword">sizeof</span>(PLUGPLAY_CONTROL_CONFLICT_ENTRY);
08231         EntrySize += <span class="keyword">sizeof</span>(WCHAR) * stringSize;
08232 
08233         <span class="keywordflow">if</span>((ConflictListIdealSize+EntrySize) &lt;= ConflictListSize) {
08234             <span class="comment">//</span>
08235             <span class="comment">// we can fit this one in</span>
08236             <span class="comment">//</span>
08237             ConflictListCount++;
08238             stringTotalSize += stringSize;
08239         }
08240         ConflictListIdealSize += EntrySize;
08241     }
08242     <span class="comment">//</span>
08243     <span class="comment">// report conflicts</span>
08244     <span class="comment">//</span>
08245     <span class="keywordflow">for</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; ConflictCount; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> ++) {
08246 
08247         stringSize = 0;
08248         <a class="code" href="../../d5/d1/pnpres_8c.html#a103">IopQueryConflictFillString</a>(ConflictInfoList[Index].OwningObject,NULL,&amp;stringSize,NULL);
08249 
08250         <span class="comment">//</span>
08251         <span class="comment">// account for entry</span>
08252         <span class="comment">//</span>
08253         EntrySize = <span class="keyword">sizeof</span>(PLUGPLAY_CONTROL_CONFLICT_ENTRY);
08254         EntrySize += <span class="keyword">sizeof</span>(WCHAR) * stringSize;
08255 
08256         <span class="keywordflow">if</span>((ConflictListIdealSize+EntrySize) &lt;= ConflictListSize) {
08257             <span class="comment">//</span>
08258             <span class="comment">// we can fit this one in</span>
08259             <span class="comment">//</span>
08260             ConflictListCount++;
08261             stringTotalSize += stringSize;
08262         }
08263         ConflictListIdealSize += EntrySize;
08264     }
08265 
08266     ConflictList-&gt;ConflictsCounted = ConflictCount+DummyCount; <span class="comment">// number of conflicts detected including any dummy conflict</span>
08267     ConflictList-&gt;ConflictsListed = ConflictListCount;         <span class="comment">// how many we could fit in</span>
08268     ConflictList-&gt;RequiredBufferSize = ConflictListIdealSize;  <span class="comment">// how much buffer space to supply on next call</span>
08269 
08270     <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(DUMP_DETAIL, (<span class="stringliteral">"IopQueryConflictFillConflicts: Listing %d conflicts\n"</span>, ConflictListCount));
08271     <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(DUMP_DETAIL, (<span class="stringliteral">"IopQueryConflictFillConflicts: Need %08x bytes to list all conflicts\n"</span>, ConflictListIdealSize));
08272 
08273     ConfStrings = (PPLUGPLAY_CONTROL_CONFLICT_STRINGS)&amp;(ConflictList-&gt;ConflictEntry[ConflictListCount]);
08274     ConfStrings-&gt;NullDeviceInstance = (ULONG)(-1);
08275     ConflictStringsOffset = 0;
08276 
08277     <span class="keywordflow">for</span>(ConflictIndex = 0; ConflictIndex &lt; DummyCount; ConflictIndex++) {
08278         <span class="comment">//</span>
08279         <span class="comment">// flags entry required (ie resource not available for some specified reason)</span>
08280         <span class="comment">//</span>
08281         <span class="keywordflow">if</span> (Flags &amp;&amp; ConflictIndex == 0) {
08282             ConflictList-&gt;ConflictEntry[ConflictIndex].DeviceInstance = ConflictStringsOffset;
08283             ConflictList-&gt;ConflictEntry[ConflictIndex].DeviceFlags = Flags;
08284             ConflictList-&gt;ConflictEntry[ConflictIndex].ResourceType = 0;
08285             ConflictList-&gt;ConflictEntry[ConflictIndex].ResourceStart = 0;
08286             ConflictList-&gt;ConflictEntry[ConflictIndex].ResourceEnd = 0;
08287             ConflictList-&gt;ConflictEntry[ConflictIndex].ResourceFlags = 0;
08288 
08289             ConfStrings-&gt;DeviceInstanceStrings[ConflictStringsOffset] = 0; <span class="comment">// null string</span>
08290             stringTotalSize --;
08291             ConflictStringsOffset ++;
08292             <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(DUMP_DETAIL, (<span class="stringliteral">"IopQueryConflictFillConflicts: Listing flags %08x\n"</span>, Flags));
08293         }
08294     }
08295     <span class="comment">//</span>
08296     <span class="comment">// get/fill in details for all those we can fit into the buffer</span>
08297     <span class="comment">//</span>
08298     <span class="keywordflow">for</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0; ConflictIndex &lt; ConflictListCount ; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> ++, ConflictIndex++) {
08299 
08300         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Index &lt; ConflictCount);
08301         <span class="comment">//</span>
08302         <span class="comment">// assign conflict information</span>
08303         <span class="comment">//</span>
08304         ConflictList-&gt;ConflictEntry[ConflictIndex].DeviceInstance = ConflictStringsOffset;
08305         ConflictList-&gt;ConflictEntry[ConflictIndex].DeviceFlags = 0;
08306         ConflictList-&gt;ConflictEntry[ConflictIndex].ResourceType = 0; <span class="comment">// BUGBUG!!! (jamiehun) remember to do this (post NT5)!</span>
08307         ConflictList-&gt;ConflictEntry[ConflictIndex].ResourceStart = (ULONGLONG)(1); <span class="comment">// for now, return totally invalid range (1-0)</span>
08308         ConflictList-&gt;ConflictEntry[ConflictIndex].ResourceEnd = 0;
08309         ConflictList-&gt;ConflictEntry[ConflictIndex].ResourceFlags = 0;
08310 
08311         <span class="comment">//</span>
08312         <span class="comment">// fill string details</span>
08313         <span class="comment">//</span>
08314         stringSize = stringTotalSize;
08315         <a class="code" href="../../d5/d1/pnpres_8c.html#a103">IopQueryConflictFillString</a>(ConflictInfoList[Index].OwningObject,
08316                                     &amp;(ConfStrings-&gt;DeviceInstanceStrings[ConflictStringsOffset]),
08317                                     &amp;stringSize,
08318                                     &amp;(ConflictList-&gt;ConflictEntry[ConflictIndex].DeviceFlags));
08319         stringTotalSize -= stringSize;
08320         <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(DUMP_DETAIL, (<span class="stringliteral">"IopQueryConflictFillConflicts: Listing \"%S\"\n"</span>, &amp;(ConfStrings-&gt;DeviceInstanceStrings[ConflictStringsOffset])));
08321         ConflictStringsOffset += stringSize;
08322     }
08323 
08324     <span class="comment">//</span>
08325     <span class="comment">// another NULL at end of strings (this is accounted for in the PPLUGPLAY_CONTROL_CONFLICT_STRINGS structure)</span>
08326     <span class="comment">//</span>
08327     ConfStrings-&gt;DeviceInstanceStrings[ConflictStringsOffset] = 0;
08328 
08329     <span class="comment">//Clean0:</span>
08330     ;
08331     <span class="keywordflow">return</span> status;
08332 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a103" doxytag="pnpres.c::IopQueryConflictFillString" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopQueryConflictFillString           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PWSTR&nbsp;</td>
          <td class="mdname" nowrap> <em>Buffer</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Flags</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l07876">7876</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d1/rtqkey_8c-source.html#l00042">Buffer</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01164">DO_BUS_ENUMERATED_DEVICE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01385">_DRIVER_OBJECT::DriverName</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00195">_DEVICE_NODE::DuplicatePDO</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00177">_DEVICE_NODE::InstancePath</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00056">IopRootDeviceNode</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l08022">IopQueryConflictFillConflicts()</a>.
<p>
<pre class="fragment"><div>07884                    :
07885 
07886     Obtain string or string-length <span class="keywordflow">for</span> details of conflicting device
07887 
07888 Arguments:
07889 
07890     DeviceObject        Device object we want Device-Instance-<a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a> or Service <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>
07891     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>              <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> to Fill, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> <span class="keywordflow">if</span> we just want length
07892     Length              Filled with length of <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>, including terminated <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> (Words)
07893     Flags               Apropriate flags set describing what the string represents
07894 
07895 Return Value:
07896 
07897     Should be success in most cases
07898 
07899 --*/
07900 {
07901     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status = STATUS_SUCCESS;
07902     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode;
07903     <a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a> driverObject;
07904     PUNICODE_STRING infoString = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
07905     ULONG MaxLength = 0;        <span class="comment">// words</span>
07906     ULONG ReqLength = 0;        <span class="comment">// words</span>
07907     ULONG flags = 0;
07908 
07909     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
07910 
07911     <span class="keywordflow">if</span> (Length != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
07912         MaxLength = *Length;
07913     }
07914 
07915     <span class="keywordflow">if</span> (Flags != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
07916         flags = *Flags;
07917     }
07918 
07919     <span class="keywordflow">if</span> (DeviceObject == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
07920         <span class="comment">//</span>
07921         <span class="comment">// unknown</span>
07922         <span class="comment">//</span>
07923         <span class="keywordflow">goto</span> <span class="keyword">final</span>;
07924 
07925     }
07926 
07927     <span class="keywordflow">if</span> ((DeviceObject-&gt;Flags &amp; <a class="code" href="../../d0/d5/io_8h.html#a133">DO_BUS_ENUMERATED_DEVICE</a>) == 0 ) {
07928         <span class="comment">//</span>
07929         <span class="comment">// FDO, report driver name</span>
07930         <span class="comment">//</span>
07931         driverObject = DeviceObject-&gt;DriverObject;
07932         <span class="keywordflow">if</span>(driverObject == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
07933             <span class="comment">//</span>
07934             <span class="comment">// should not be NULL</span>
07935             <span class="comment">//</span>
07936             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(driverObject);
07937             <span class="keywordflow">goto</span> <span class="keyword">final</span>;
07938         }
07939         infoString = &amp; (driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o8">DriverName</a>);
07940         flags |= PNP_CE_LEGACY_DRIVER;
07941         <span class="keywordflow">goto</span> <span class="keyword">final</span>;
07942     }
07943 
07944     <span class="comment">//</span>
07945     <span class="comment">// we should in actual fact have a PDO</span>
07946     <span class="comment">//</span>
07947     <span class="keywordflow">if</span> (DeviceObject-&gt;DeviceObjectExtension == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
07948         <span class="comment">//</span>
07949         <span class="comment">// should not be NULL</span>
07950         <span class="comment">//</span>
07951         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(DeviceObject-&gt;DeviceObjectExtension);
07952         <span class="keywordflow">goto</span> <span class="keyword">final</span>;
07953     }
07954 
07955     deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)DeviceObject-&gt;DeviceObjectExtension-&gt;DeviceNode;
07956     <span class="keywordflow">if</span> (deviceNode == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
07957         <span class="comment">//</span>
07958         <span class="comment">// should not be NULL</span>
07959         <span class="comment">//</span>
07960         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(deviceNode);
07961         <span class="keywordflow">goto</span> <span class="keyword">final</span>;
07962     }
07963 
07964     <span class="keywordflow">if</span> (deviceNode == <a class="code" href="../../d1/d0/pnpdata_8c.html#a5">IopRootDeviceNode</a>) {
07965         <span class="comment">//</span>
07966         <span class="comment">// owned by root device</span>
07967         <span class="comment">//</span>
07968         flags |= PNP_CE_ROOT_OWNED;
07969 
07970     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (deviceNode -&gt; Parent == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
07971         <span class="comment">//</span>
07972         <span class="comment">// faked out PDO - must be legacy device</span>
07973         <span class="comment">//</span>
07974         driverObject = (<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a>)(deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o15">DuplicatePDO</a>);
07975         <span class="keywordflow">if</span>(driverObject == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
07976             <span class="comment">//</span>
07977             <span class="comment">// should not be NULL</span>
07978             <span class="comment">//</span>
07979             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(driverObject);
07980             <span class="keywordflow">goto</span> <span class="keyword">final</span>;
07981         }
07982         infoString = &amp; (driverObject-&gt;<a class="code" href="../../d4/d9/struct__DRIVER__OBJECT.html#o8">DriverName</a>);
07983         flags |= PNP_CE_LEGACY_DRIVER;
07984         <span class="keywordflow">goto</span> <span class="keyword">final</span>;
07985     }
07986 
07987     <span class="comment">//</span>
07988     <span class="comment">// we should be happy with what we have</span>
07989     <span class="comment">//</span>
07990     infoString = &amp;deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o13">InstancePath</a>;
07991 
07992 <span class="keyword">final</span>:
07993 
07994     <span class="keywordflow">if</span> (infoString != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
07995         <span class="comment">//</span>
07996         <span class="comment">// we have a string to copy</span>
07997         <span class="comment">//</span>
07998         <span class="keywordflow">if</span> ((<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (MaxLength*<span class="keyword">sizeof</span>(WCHAR) &gt; infoString-&gt;Length)) {
07999             RtlCopyMemory(Buffer, infoString-&gt;Buffer, infoString-&gt;Length);
08000         }
08001         ReqLength += infoString-&gt;Length / <span class="keyword">sizeof</span>(WCHAR);
08002     }
08003 
08004     <span class="keywordflow">if</span> ((<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (MaxLength &gt; ReqLength)) {
08005         <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>[ReqLength] = 0;
08006     }
08007 
08008     ReqLength++;
08009 
08010     <span class="keywordflow">if</span> (Length != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
08011         *Length = ReqLength;
08012     }
08013     <span class="keywordflow">if</span> (Flags != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
08014         *Flags = flags;
08015     }
08016 
08017     <span class="keywordflow">return</span> status;
08018 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a114" doxytag="pnpres.c::IopQueryConflictList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopQueryConflictList           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PhysicalDeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PCM_RESOURCE_LIST&nbsp;</td>
          <td class="mdname" nowrap> <em>ResourceList</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ResourceListSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PPLUGPLAY_CONTROL_CONFLICT_LIST&nbsp;</td>
          <td class="mdname" nowrap> <em>ConflictList</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ConflictListSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Flags</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l07717">7717</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.
<p>
References <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00275">DebugMessage</a>, <a class="el" href="../../d4/d9/ke_8h.html#a407a202">DelayExecution</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00267">DUMP_ERROR</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l08336">IopQueryConflictListInternal()</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00337">IopRegistrySemaphore</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01598">KeEnterCriticalRegion</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01628">KeLeaveCriticalRegion</a>, <a class="el" href="../../d2/d5/semphobj_8c-source.html#l00118">KeReleaseSemaphore()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
<pre class="fragment"><div>07727                    :
07728 
07729     This routine performs <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> querying of device conflicts
07730     returning data in ConflictList
07731 
07732 Arguments:
07733 
07734     PhysicalDeviceObject PDO of device to Query
07735     ResourceList      CM resource list containing single resource to query
07736     ResourceListSize  <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> of ResourceList
07737     ConflictList      Conflict list to fill query details in
07738     ConflictListSize  <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> of buffer that we can fill with Conflict information
07739     Flags             Currently unused (zero) for future passing of flags
07740 
07741 Return Value:
07742 
07743     Should be success in most cases
07744 
07745 --*/
07746 {
07747     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
07748 
07749     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
07750 
07751     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>( );
07752 
07753     status = <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;IopRegistrySemaphore,
07754                                     DelayExecution,
07755                                     KernelMode,
07756                                     FALSE,
07757                                     NULL );
07758 
07759     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( status )) {
07760         <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(DUMP_ERROR, (<span class="stringliteral">"IopQueryConflictList: Get RegustrySemaphore failed. Status %x\n"</span>, status));
07761         <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>( );
07762         <span class="keywordflow">return</span> status;
07763     } <span class="keywordflow">else</span> {
07764         status = <a class="code" href="../../d5/d1/pnpres_8c.html#a101">IopQueryConflictListInternal</a>(PhysicalDeviceObject, ResourceList, ResourceListSize, ConflictList, ConflictListSize, Flags);
07765         <a class="code" href="../../d1/d6/semphobj_8c.html#a3">KeReleaseSemaphore</a>( &amp;IopRegistrySemaphore, 0, 1, FALSE );
07766         <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>( );
07767     }
07768 
07769     <span class="keywordflow">return</span> status;
07770 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a101" doxytag="pnpres.c::IopQueryConflictListInternal" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopQueryConflictListInternal           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PhysicalDeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PCM_RESOURCE_LIST&nbsp;</td>
          <td class="mdname" nowrap> <em>ResourceList</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ResourceListSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PPLUGPLAY_CONTROL_CONFLICT_LIST&nbsp;</td>
          <td class="mdname" nowrap> <em>ConflictList</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ConflictListSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Flags</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l08336">8336</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.
<p>
References <a class="el" href="../../d6/d9/pnp_8h.html#a173a121">ArbiterActionQueryConflict</a>, <a class="el" href="../../d6/d9/pnp_8h.html#a174a125">ArbiterRequestUndefined</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00215">_DEVICE_NODE::ChildBusNumber</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00214">_DEVICE_NODE::ChildInterfaceType</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00803">CmResourceTypeReserved</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01274">_DEVOBJ_EXTENSION::DeviceNode</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01210">_DEVICE_OBJECT::DeviceObjectExtension</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l04339">IopCallArbiter()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l07662">IopCheckDataStructures()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l04279">IopCmResourcesToIoResources()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l01948">IopFreeReqList()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l08022">IopQueryConflictFillConflicts()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l01267">IopResourceRequirementsListToReqList()</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00056">IopRootDeviceNode</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00167">PnpDefaultInterfaceType</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00273">PnpResDebugLevel</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00081">PREQ_ALTERNATIVE</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00079">PREQ_DESC</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00083">PREQ_LIST</a>, <a class="el" href="../../d9/d8/mips_2exdsptch_8c-source.html#l00048">RA</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00201">_DEVICE_NODE::ResourceRequirements</a>, and <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00270">STOP_ERROR</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l07717">IopQueryConflictList()</a>.
<p>
<pre class="fragment"><div>08346                    :
08347 
08348     <a class="code" href="../../d2/d5/editreg_8c.html#a50">Version</a> of <a class="code" href="../../d9/d0/pnpiop_8h.html#a337">IopQueryConflictList</a> without <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> locking
08349 
08350 --*/
08351 {
08352 
08353     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status = STATUS_SUCCESS;
08354     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
08355     PIO_RESOURCE_REQUIREMENTS_LIST ioResources;
08356     <a class="code" href="../../d5/d1/pnpres_8c.html#a30">PREQ_LIST</a> reqList;
08357     <a class="code" href="../../d5/d1/pnpres_8c.html#a28">PREQ_DESC</a> reqDesc, reqDescTranslated;
08358     PLIST_ENTRY listHead;
08359     <a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html">PPI_RESOURCE_ARBITER_ENTRY</a> arbiterEntry;
08360     <a class="code" href="../../d5/d1/pnpres_8c.html#a29">PREQ_ALTERNATIVE</a> <a class="code" href="../../d8/d9/mips_2exdsptch_8c.html#a1">RA</a>;
08361     <a class="code" href="../../d5/d1/pnpres_8c.html#a29">PREQ_ALTERNATIVE</a> *reqAlternative;
08362     ULONG ConflictCount = 0;
08363     <a class="code" href="../../d7/d7/struct__ARBITER__CONFLICT__INFO.html">PARBITER_CONFLICT_INFO</a> ConflictInfoList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
08364     PIO_RESOURCE_DESCRIPTOR ConflictDesc = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
08365     ULONG ReqDescCount = 0;
08366     <a class="code" href="../../d5/d1/pnpres_8c.html#a28">PREQ_DESC</a> *ReqDescTable = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
08367     PIO_RESOURCE_REQUIREMENTS_LIST pIoReqList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
08368     PVOID ExtParams[4];
08369 
08370     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
08371 
08372     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PhysicalDeviceObject);
08373     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ResourceList);
08374     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ResourceListSize);
08375     <span class="comment">//</span>
08376     <span class="comment">// these parameters were generated by umpnpmgr</span>
08377     <span class="comment">// so should be correct - one resource, and one resource only</span>
08378     <span class="comment">//</span>
08379     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ResourceList-&gt;Count == 1);
08380     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ResourceList-&gt;List[0].PartialResourceList.Count == 1);
08381 
08382     <span class="keywordflow">if</span> (ConflictList == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || (ConflictListSize &lt; (<span class="keyword">sizeof</span>(PLUGPLAY_CONTROL_CONFLICT_LIST) - <span class="keyword">sizeof</span>(PLUGPLAY_CONTROL_CONFLICT_ENTRY)) + <span class="keyword">sizeof</span>(PLUGPLAY_CONTROL_CONFLICT_STRINGS))) {
08383         <span class="comment">//</span>
08384         <span class="comment">// sanity check</span>
08385         <span class="comment">//</span>
08386         status = STATUS_BUFFER_TOO_SMALL;
08387         <span class="keywordflow">goto</span> Clean0;
08388     }
08389     <span class="comment">//</span>
08390     <span class="comment">// whatever other error we return, ensure that ConflictList is interpretable</span>
08391     <span class="comment">//</span>
08392 
08393     ConflictList-&gt;ConflictsCounted = 0;
08394     ConflictList-&gt;ConflictsListed = 0;
08395     ConflictList-&gt;RequiredBufferSize = (<span class="keyword">sizeof</span>(PLUGPLAY_CONTROL_CONFLICT_LIST) - <span class="keyword">sizeof</span>(PLUGPLAY_CONTROL_CONFLICT_ENTRY)) + <span class="keyword">sizeof</span>(PLUGPLAY_CONTROL_CONFLICT_STRINGS);
08396 
08397     <span class="comment">//</span>
08398     <span class="comment">// Retrieve the devnode from the PDO</span>
08399     <span class="comment">//</span>
08400     deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)PhysicalDeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o6">DeviceNode</a>;
08401     <span class="keywordflow">if</span> (!deviceNode) {
08402         status = STATUS_NO_SUCH_DEVICE;
08403         <span class="keywordflow">goto</span> Clean0;
08404     }
08405 
08406     <span class="comment">//</span>
08407     <span class="comment">// type-specific validation</span>
08408     <span class="comment">//</span>
08409     <span class="keywordflow">switch</span>(ResourceList-&gt;List[0].PartialResourceList.PartialDescriptors[0].Type) {
08410         <span class="keywordflow">case</span> CmResourceTypePort:
08411         <span class="keywordflow">case</span> CmResourceTypeMemory:
08412             <span class="keywordflow">if</span>(ResourceList-&gt;List[0].PartialResourceList.PartialDescriptors[0].u.Generic.Length == 0) {
08413                 <span class="comment">//</span>
08414                 <span class="comment">// zero-range resource can never conflict</span>
08415                 <span class="comment">//</span>
08416                 status = STATUS_SUCCESS;
08417                 <span class="keywordflow">goto</span> Clean0;
08418             }
08419             <span class="keywordflow">break</span>;
08420         <span class="keywordflow">case</span> CmResourceTypeInterrupt:
08421         <span class="keywordflow">case</span> CmResourceTypeDma:
08422             <span class="keywordflow">break</span>;
08423         <span class="keywordflow">default</span>:
08424             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(0);
08425             status = STATUS_INVALID_PARAMETER;
08426             <span class="keywordflow">goto</span> Clean0;
08427     }
08428 
08429     <span class="comment">//</span>
08430     <span class="comment">// apply bus details from node</span>
08431     <span class="comment">//</span>
08432     <span class="keywordflow">if</span> (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o19">ChildInterfaceType</a> == InterfaceTypeUndefined) {
08433         <span class="comment">//</span>
08434         <span class="comment">// we have to grovel around to find real Interface Type</span>
08435         <span class="comment">//</span>
08436         pIoReqList = deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o16">ResourceRequirements</a>;
08437         <span class="keywordflow">if</span> (pIoReqList != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; pIoReqList-&gt;InterfaceType != InterfaceTypeUndefined) {
08438             ResourceList-&gt;List[0].InterfaceType = pIoReqList-&gt;InterfaceType;
08439         } <span class="keywordflow">else</span> {
08440             <span class="comment">//</span>
08441             <span class="comment">// BUGBUG!!! (jamiehun)</span>
08442             <span class="comment">// we should never get here</span>
08443             <span class="comment">// if we do, I need to look at this more</span>
08444             <span class="comment">//</span>
08445 <span class="preprocessor">#if MYDBG</span>
08446 <span class="preprocessor"></span>            <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(0);
08447 <span class="preprocessor">#endif</span>
08448 <span class="preprocessor"></span>            ResourceList-&gt;List[0].InterfaceType = <a class="code" href="../../d1/d0/pnpdata_8c.html#a23">PnpDefaultInterfaceType</a>;
08449         }
08450 
08451     } <span class="keywordflow">else</span> {
08452         <span class="comment">//</span>
08453         <span class="comment">// we trust the deviceNode to tell us Interface Type</span>
08454         <span class="comment">//</span>
08455         ResourceList-&gt;List[0].InterfaceType = deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o19">ChildInterfaceType</a>;
08456     }
08457     <span class="comment">//</span>
08458     <span class="comment">// HACKHACK!!! (jamiehun) some bus-types we are better off considered as default</span>
08459     <span class="comment">//</span>
08460     <span class="keywordflow">switch</span>(ResourceList-&gt;List[0].InterfaceType) {
08461         <span class="keywordflow">case</span> InterfaceTypeUndefined:
08462         <span class="keywordflow">case</span> PCMCIABus:
08463             ResourceList-&gt;List[0].InterfaceType = <a class="code" href="../../d1/d0/pnpdata_8c.html#a23">PnpDefaultInterfaceType</a>;
08464     }
08465     <span class="keywordflow">if</span> ((deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o20">ChildBusNumber</a> &amp; 0x80000000) == 0x80000000) {
08466         <span class="comment">//</span>
08467         <span class="comment">// we have to grovel around to find real Bus Number</span>
08468         <span class="comment">//</span>
08469         pIoReqList = deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o16">ResourceRequirements</a>;
08470         <span class="keywordflow">if</span> (pIoReqList != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; (pIoReqList-&gt;BusNumber &amp; 0x80000000) != 0x80000000) {
08471             ResourceList-&gt;List[0].BusNumber = pIoReqList-&gt;BusNumber;
08472         } <span class="keywordflow">else</span> {
08473             <span class="comment">//</span>
08474             <span class="comment">// a resonable default, but assert is here so I remember to look at this more</span>
08475             <span class="comment">// BUGBUG!!! (jamiehun)</span>
08476             <span class="comment">//</span>
08477 <span class="preprocessor">#if MYDBG</span>
08478 <span class="preprocessor"></span>            <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(0);
08479 <span class="preprocessor">#endif</span>
08480 <span class="preprocessor"></span>            ResourceList-&gt;List[0].BusNumber = 0;
08481         }
08482 
08483     } <span class="keywordflow">else</span> {
08484         <span class="comment">//</span>
08485         <span class="comment">// we trust the deviceNode to tell us Bus Number</span>
08486         <span class="comment">//</span>
08487         ResourceList-&gt;List[0].BusNumber = deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o20">ChildBusNumber</a>;
08488     }
08489 
08490     <span class="comment">//</span>
08491     <span class="comment">// from our CM Resource List, obtain an IO Resource Requirements List</span>
08492     <span class="comment">//</span>
08493     ioResources = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a28">IopCmResourcesToIoResources</a>(0, ResourceList, LCPRI_FORCECONFIG);
08494     <span class="keywordflow">if</span> (!ioResources) {
08495         status = STATUS_INVALID_PARAMETER;
08496         <span class="keywordflow">goto</span> Clean0;
08497     }
08498     <span class="comment">//</span>
08499     <span class="comment">// Convert ioResources to a Request list</span>
08500     <span class="comment">// and in the processess, determine any Arbiters/Translators to use</span>
08501     <span class="comment">//</span>
08502     status = <a class="code" href="../../d5/d1/pnpres_8c.html#a57">IopResourceRequirementsListToReqList</a>(
08503                     ArbiterRequestUndefined,    <span class="comment">// BUGBUG!!! (jamiehun) better alternative???</span>
08504                     ioResources,
08505                     PhysicalDeviceObject,
08506                     &amp;reqList);
08507 
08508     <span class="comment">//</span>
08509     <span class="comment">// get arbitrator/translator for current device/bus</span>
08510     <span class="comment">//</span>
08511 
08512     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) &amp;&amp; reqList) {
08513 
08514         reqAlternative = reqList-&gt;ReqAlternativeTable;
08515         <a class="code" href="../../d8/d9/mips_2exdsptch_8c.html#a1">RA</a> = *reqAlternative;
08516         reqList-&gt;SelectedAlternative = reqAlternative;
08517 
08518         ReqDescCount = <a class="code" href="../../d8/d9/mips_2exdsptch_8c.html#a1">RA</a>-&gt;ReqDescCount;
08519         ReqDescTable = <a class="code" href="../../d8/d9/mips_2exdsptch_8c.html#a1">RA</a>-&gt;ReqDescTable;
08520 
08521         <span class="comment">//</span>
08522         <span class="comment">// we should have got only one descriptor, use only the first one</span>
08523         <span class="comment">//</span>
08524         <span class="keywordflow">if</span> (ReqDescCount&gt;0) {
08525 
08526             <span class="comment">//</span>
08527             <span class="comment">// get first descriptor &amp; it's arbitor</span>
08528             <span class="comment">//</span>
08529 
08530             reqDesc = *ReqDescTable;
08531             <span class="keywordflow">if</span> (reqDesc-&gt;ArbitrationRequired) {
08532                 reqDescTranslated = reqDesc-&gt;TranslatedReqDesc;  <span class="comment">// Could be reqDesc itself</span>
08533 
08534                 arbiterEntry = reqDesc-&gt;u.Arbiter;
08535                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(arbiterEntry);
08536                 <span class="comment">//</span>
08537                 <span class="comment">// the descriptor of interest - translated, first alternative in the table</span>
08538                 <span class="comment">//</span>
08539                 ConflictDesc = reqDescTranslated-&gt;AlternativeTable.Alternatives;
08540                 <span class="comment">//</span>
08541                 <span class="comment">// skip special descriptor</span>
08542                 <span class="comment">// to get to the actual descriptor</span>
08543                 <span class="comment">//</span>
08544                 <span class="keywordflow">if</span>(ConflictDesc-&gt;Type == CmResourceTypeConfigData || ConflictDesc-&gt;Type == <a class="code" href="../../d9/d0/pnpiop_8h.html#a74">CmResourceTypeReserved</a>)
08545                         ConflictDesc++;
08546 
08547                 <span class="comment">//</span>
08548                 <span class="comment">// finally we can call the arbiter to get a conflict list (returning PDO's and Global Address Ranges)</span>
08549                 <span class="comment">//</span>
08550                 ExtParams[0] = PhysicalDeviceObject;
08551                 ExtParams[1] = ConflictDesc;
08552                 ExtParams[2] = &amp;ConflictCount;
08553                 ExtParams[3] = &amp;ConflictInfoList;
08554                 status = <a class="code" href="../../d5/d1/pnpres_8c.html#a79">IopCallArbiter</a>(arbiterEntry, ArbiterActionQueryConflict , ExtParams, NULL , NULL);
08555 
08556                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
08557                     <span class="comment">//</span>
08558                     <span class="comment">// fill in user-memory buffer with conflict</span>
08559                     <span class="comment">//</span>
08560                     status = <a class="code" href="../../d5/d1/pnpres_8c.html#a102">IopQueryConflictFillConflicts</a>(PhysicalDeviceObject,ConflictCount,ConflictInfoList,ConflictList,ConflictListSize,0);
08561                     <span class="keywordflow">if</span>(ConflictInfoList != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
08562                         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(ConflictInfoList);
08563                     }
08564                 }
08565                 <span class="keywordflow">else</span> <span class="keywordflow">if</span>(status == STATUS_RANGE_NOT_FOUND) {
08566                     <span class="comment">//</span>
08567                     <span class="comment">// fill in with flag indicating bad range (this means range is not available)</span>
08568                     <span class="comment">// ConflictInfoList should not be allocated</span>
08569                     <span class="comment">//</span>
08570                     status = <a class="code" href="../../d5/d1/pnpres_8c.html#a102">IopQueryConflictFillConflicts</a>(NULL,0,NULL,ConflictList,ConflictListSize,PNP_CE_TRANSLATE_FAILED);
08571                 }
08572 
08573             } <span class="keywordflow">else</span> {
08574 <span class="preprocessor">#if MYDBG</span>
08575 <span class="preprocessor"></span>                <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(0);                         <span class="comment">// For now</span>
08576 <span class="preprocessor">#endif</span>
08577 <span class="preprocessor"></span>                status = STATUS_INVALID_PARAMETER;  <span class="comment">// if we failed, it's prob because ResourceList was invalid</span>
08578             }
08579         } <span class="keywordflow">else</span> {
08580 <span class="preprocessor">#if MYDBG</span>
08581 <span class="preprocessor"></span>            <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(0);                         <span class="comment">// For now</span>
08582 <span class="preprocessor">#endif</span>
08583 <span class="preprocessor"></span>            status = STATUS_INVALID_PARAMETER;  <span class="comment">// if we failed, it's prob because ResourceList was invalid</span>
08584         }
08585 
08586 <span class="preprocessor">#if DBG_SCOPE</span>
08587 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="../../d5/d1/pnpres_8c.html#a47">PnpResDebugLevel</a> &amp; <a class="code" href="../../d5/d1/pnpres_8c.html#a26">STOP_ERROR</a>) {
08588             <a class="code" href="../../d5/d1/pnpres_8c.html#a99">IopCheckDataStructures</a>(IopRootDeviceNode);
08589         }
08590 <span class="preprocessor">#endif</span>
08591 <span class="preprocessor"></span>
08592         <a class="code" href="../../d5/d1/pnpres_8c.html#a63">IopFreeReqList</a>(reqList);
08593     } <span class="keywordflow">else</span> {
08594 <span class="preprocessor">#if MYDBG</span>
08595 <span class="preprocessor"></span>        <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(0);                         <span class="comment">// For now</span>
08596 <span class="preprocessor">#endif</span>
08597 <span class="preprocessor"></span>        <span class="keywordflow">if</span>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
08598             <span class="comment">//</span>
08599             <span class="comment">// it was NULL because we had a zero resource count, must be invalid parameter</span>
08600             <span class="comment">//</span>
08601             status = STATUS_INVALID_PARAMETER;
08602         }
08603 
08604     }
08605     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(ioResources);
08606 
08607     Clean0:
08608     ;
08609 
08610     <span class="keywordflow">return</span> status;
08611 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a80" doxytag="pnpres.c::IopQueryRebalance" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopQueryRebalance           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceNode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Phase</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>RebalanceCount</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> **&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceTable</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l04589">4589</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.
<p>
References <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00069">ExAllocatePoolPDO</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l04667">IopQueryRebalanceWorker()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, and <a class="el" href="../../d1/d4/io_8h-source.html#l01213">PDEVICE_OBJECT</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l05215">IopRebalance()</a>.
<p>
<pre class="fragment"><div>04598                    :
04599 
04600     This routine walks hardware tree depth first.  For each device node <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> visits,
04601     <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> call IopQueryReconfigureDevice to query-stop device <span class="keywordflow">for</span> resource
04602     reconfiguration.
04603 
04604     Note, Under rebalancing situation, all <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> participated devices will be asked to
04605     stop.  Even they support non-stopped rebalancing.
04606 
04607 Parameters:
04608 
04609     DeviceNode - supplies a pionter a device node which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> root of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> tree to
04610                  be tested.
04611 
04612     Phase - Supplies a value to specify <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> phase of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> rebalance.
04613 
04614     RebalanceCount - supplies a pointer to a variable to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of devices
04615                  participating <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> rebalance.
04616 
04617 Return Value:
04618 
04619     None.
04620 
04621 --*/
04622 
04623 {
04624     LONG oldState;
04625     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> *deviceList, *deviceTable, *device;
04626     ULONG count;
04627     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode;
04628 
04629 
04630     <span class="comment">//</span>
04631     <span class="comment">// Call worker routine to get a list of devices to be rebalanced.</span>
04632     <span class="comment">//</span>
04633 
04634     deviceTable = *DeviceTable;
04635     <a class="code" href="../../d5/d1/pnpres_8c.html#a81">IopQueryRebalanceWorker</a> (DeviceNode, Phase, RebalanceCount, DeviceTable);
04636 
04637     count = *RebalanceCount;
04638     <span class="keywordflow">if</span> (count != 0 &amp;&amp; Phase == 0) {
04639 
04640         <span class="comment">//</span>
04641         <span class="comment">// At phase 0, we did not actually query-stop the device.</span>
04642         <span class="comment">// We need to do it now.</span>
04643         <span class="comment">//</span>
04644 
04645         deviceList = (<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> *)<a class="code" href="../../d5/d1/pnpres_8c.html#a10">ExAllocatePoolPDO</a>(PagedPool, count * <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>));
04646         <span class="keywordflow">if</span> (deviceList == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04647             *RebalanceCount = 0;
04648             <span class="keywordflow">return</span>;
04649         }
04650         RtlMoveMemory(deviceList, deviceTable, <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>) * count);
04651 
04652         <span class="comment">//</span>
04653         <span class="comment">// Rebuild the returned device list</span>
04654         <span class="comment">//</span>
04655 
04656         *RebalanceCount = 0;
04657         *DeviceTable = deviceTable;
04658         <span class="keywordflow">for</span> (device = deviceList; device &lt; (deviceList + count); device++) {
04659             deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)((*device)-&gt;DeviceObjectExtension-&gt;DeviceNode);
04660             <a class="code" href="../../d5/d1/pnpres_8c.html#a81">IopQueryRebalanceWorker</a> (deviceNode, 1, RebalanceCount, DeviceTable);
04661         }
04662         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(deviceList);
04663     }
04664     <span class="keywordflow">return</span>;
04665 }
<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a81" doxytag="pnpres.c::IopQueryRebalanceWorker" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopQueryRebalanceWorker           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceNode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>RebalancePhase</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>RebalanceCount</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> **&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceTable</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l04667">4667</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00099">_DEVICE_NODE::Child</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00275">DebugMessage</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00447">DNF_ASSIGNING_RESOURCES</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00621">DNF_ASYNC_REQUEST_PENDING</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00493">DNF_LEGACY_DRIVER</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00576">DNF_NEEDS_REBALANCE</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00480">DNF_STOPPED</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00267">DUMP_ERROR</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00170">_DEVICE_NODE::EnumerationMutex</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00177">_DEVICE_NODE::InstancePath</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00825">IopDoesDevNodeHaveProblem</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l04767">IopTestForReconfiguration()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d3/d7/eventobj_8c-source.html#l00343">KeSetEvent()</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00301">_DEVICE_NODE::LockCount</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00093">_DEVICE_NODE::Sibling</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l04589">IopQueryRebalance()</a>.
<p>
<pre class="fragment"><div>04676                    :
04677 
04678     This routine walks hardware tree depth first.  For each device node <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> visits,
04679     <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> call IopQueryReconfigureDevice to query-stop and stop device <span class="keywordflow">for</span> resource
04680     reconfiguration.
04681 
04682 Parameters:
04683 
04684     DeviceNode - supplies a pionter a device node which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> root of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> tree to
04685                  be tested.
04686 
04687     Phase - Supplies a value to specify <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> phase of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> rebalance.
04688 
04689     RebalanceCount - supplies a pointer to a variable to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of devices
04690                  participating <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> rebalance.
04691 
04692 Return Value:
04693 
04694     None.
04695 
04696 --*/
04697 
04698 {
04699     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> node;
04700 
04701     <span class="keywordflow">if</span> (DeviceNode == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
04702     {
04703         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(DeviceNode);
04704         <span class="keywordflow">return</span>;
04705     }
04706 
04707     <span class="comment">//</span>
04708     <span class="comment">// Include Insufficient_resources checking.  THis is because a driver (scsiminiport) may call</span>
04709     <span class="comment">// IoReportResourceUsage to perform detection and cause the (Isapnp) enumerated device</span>
04710     <span class="comment">// insufficient_resources to start.  At this point, the enumerated device resources should be locked down</span>
04711     <span class="comment">// for the detected instance.</span>
04712     <span class="comment">//</span>
04713 
04714     <span class="keywordflow">if</span> (((DeviceNode-&gt;Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a44">DNF_ASYNC_REQUEST_PENDING</a>)  ||
04715         (DeviceNode-&gt;Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a22">DNF_STOPPED</a>)                ||
04716         (<a class="code" href="../../d9/d0/pnpiop_8h.html#a77">IopDoesDevNodeHaveProblem</a>(DeviceNode))          ||
04717         (DeviceNode-&gt;Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a24">DNF_LEGACY_DRIVER</a>)          ||
04718         (DeviceNode-&gt;Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a17">DNF_ASSIGNING_RESOURCES</a>))   &amp;&amp;
04719         !(DeviceNode-&gt;Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a35">DNF_NEEDS_REBALANCE</a>)) {
04720 
04721         node = DeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o0">Sibling</a>;
04722 
04723     } <span class="keywordflow">else</span> {
04724 
04725         node = DeviceNode;
04726 
04727     }
04728 
04729     <span class="keywordflow">for</span> (; node; node = node-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o0">Sibling</a>) {
04730 
04731         <span class="keywordflow">if</span> (node-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o1">Child</a>) {
04732 
04733             <span class="comment">//</span>
04734             <span class="comment">// If this subtree is not being removed, wait for current enumeration to complete.</span>
04735             <span class="comment">//</span>
04736 
04737             <span class="keywordflow">if</span> (node-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o36">LockCount</a> == 0) {
04738 
04739                 <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;node-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o12">EnumerationMutex</a>,
04740                                        Executive,
04741                                        KernelMode,
04742                                        FALSE,
04743                                        NULL);
04744 
04745                 <a class="code" href="../../d5/d1/pnpres_8c.html#a81">IopQueryRebalanceWorker</a> (node-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o1">Child</a>, Phase, RebalanceCount, DeviceTable);
04746 
04747                 <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>(&amp;node-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o12">EnumerationMutex</a>, 0, FALSE);
04748             }
04749         }
04750     }
04751 
04752     <span class="keywordflow">for</span> (node = DeviceNode; node; node = node-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o0">Sibling</a>) {
04753 
04754         <span class="keywordflow">if</span> (node-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o36">LockCount</a> == 0) {
04755 
04756             <a class="code" href="../../d5/d1/pnpres_8c.html#a82">IopTestForReconfiguration</a> (node, Phase, RebalanceCount, DeviceTable);
04757 
04758         } <span class="keywordflow">else</span> {
04759 
04760             <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(DUMP_ERROR, (<span class="stringliteral">"PNPRES: %ws enum lock is taken, skipping during REBALANCE!\n"</span>, node-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o13">InstancePath</a>.Buffer));
04761 
04762         }
04763     }
04764 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a113" doxytag="pnpres.c::IopReallocateResources" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopReallocateResources           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>DeviceObject</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l07470">7470</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00275">DebugMessage</a>, <a class="el" href="../../d4/d9/ke_8h.html#a407a202">DelayExecution</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00447">DNF_ASSIGNING_RESOURCES</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00625">DNF_HAS_RESOURCE</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00473">DNF_NON_STOPPED_REBALANCE</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00453">DNF_RESOURCE_ASSIGNED</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00459">DNF_RESOURCE_REPORTED</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00466">DNF_RESOURCE_REQUIREMENTS_CHANGED</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00267">DUMP_ERROR</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02474">ExAcquireResourceShared</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02393">ExReleaseResource</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00766">_IOP_RESOURCE_REQUEST::Flags</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00129">_DEVICE_NODE::Flags</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00759">IOP_ASSIGN_KEEP_CURRENT_CONFIG</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00757">IOP_ASSIGN_NO_REBALANCE</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l01266">IopAcquireEnumerationLock</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l03292">IopAssignInner()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l02320">IopBuildCmResourceLists()</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00074">IopDeviceTreeLock</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l01988">IopFreeResourceRequirementsForAssignTable()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l01066">IopGetResourceRequirementsForAssignTable()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l05215">IopRebalance()</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00337">IopRegistrySemaphore</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l01276">IopReleaseEnumerationLock</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l05757">IopReleaseResourcesInternal()</a>, <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l01708">IopRequestDeviceRemoval()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l05660">IopRestoreResourcesInternal()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00510">IopStartDevice()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01598">KeEnterCriticalRegion</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01628">KeLeaveCriticalRegion</a>, <a class="el" href="../../d2/d5/semphobj_8c-source.html#l00118">KeReleaseSemaphore()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00765">_IOP_RESOURCE_REQUEST::PhysicalDevice</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00151">_DEVICE_NODE::PhysicalDeviceObject</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00771">_IOP_RESOURCE_REQUEST::ResourceAssignment</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00161">_DEVICE_NODE::ResourceList</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00163">_DEVICE_NODE::ResourceListTranslated</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00772">_IOP_RESOURCE_REQUEST::TranslatedResourceAssignment</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l00307">IopDeviceActionWorker()</a>.
<p>
<pre class="fragment"><div>07476                    :
07477 
07478     This routine performs <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> real work <span class="keywordflow">for</span> <a class="code" href="../../d6/d9/pnp_8h.html#a154">IoInvalidateDeviceState</a> - <a class="code" href="../../d9/d0/pnpiop_8h.html#a391a223">ResourceRequirementsChanged</a>.
07479 
07480 Arguments:
07481 
07482     DeviceObject - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device object.
07483 
07484 Return Value:
07485 
07486     None.
07487 
07488 --*/
07489 {
07490     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)DeviceObject-&gt;DeviceObjectExtension-&gt;DeviceNode;
07491     <a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">IOP_RESOURCE_REQUEST</a> requestTable, *requestTablep;
07492     ULONG deviceCount, oldFlags;
07493     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
07494 
07495     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
07496 
07497     <span class="comment">//</span>
07498     <span class="comment">// Grab the IO registry semaphore to make sure no other device is</span>
07499     <span class="comment">// reporting it's resource usage while we are searching for conflicts.</span>
07500     <span class="comment">//</span>
07501 
07502     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
07503     status = <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;IopRegistrySemaphore,
07504                                     DelayExecution,
07505                                     KernelMode,
07506                                     FALSE,
07507                                     NULL);
07508     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
07509 
07510         <span class="comment">//</span>
07511         <span class="comment">// Acquire the tree lock so we block remove for this device node.</span>
07512         <span class="comment">//</span>
07513 
07514         <a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a>(&amp;IopDeviceTreeLock, TRUE);
07515 
07516         <span class="comment">//</span>
07517         <span class="comment">// Check the flags after acquiring the semaphore.</span>
07518         <span class="comment">//</span>
07519 
07520         <span class="keywordflow">if</span> (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a20">DNF_RESOURCE_REQUIREMENTS_CHANGED</a>) {
07521             <span class="comment">//</span>
07522             <span class="comment">// Save the flags which we may have to restore in case of failure.</span>
07523             <span class="comment">//</span>
07524 
07525             oldFlags = deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a46">DNF_HAS_RESOURCE</a>;
07526             deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp;= ~(<a class="code" href="../../d9/d0/pnpiop_8h.html#a46">DNF_HAS_RESOURCE</a>);
07527 
07528             <span class="keywordflow">if</span> (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a21">DNF_NON_STOPPED_REBALANCE</a>) {
07529 
07530                 <a class="code" href="../../d9/d0/pnpiop_8h.html#a95">IopAcquireEnumerationLock</a>(deviceNode);
07531 
07532                 <span class="comment">//</span>
07533                 <span class="comment">// Set up parameters to call real routine</span>
07534                 <span class="comment">//</span>
07535 
07536                 deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a17">DNF_ASSIGNING_RESOURCES</a>;
07537 
07538                 RtlZeroMemory(&amp;requestTable, <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">IOP_RESOURCE_REQUEST</a>));
07539                 requestTable.<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o0">PhysicalDevice</a> = DeviceObject;
07540                 requestTablep = &amp;requestTable;
07541                 requestTable.<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o1">Flags</a> |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a70">IOP_ASSIGN_NO_REBALANCE</a> + <a class="code" href="../../d9/d0/pnpiop_8h.html#a72">IOP_ASSIGN_KEEP_CURRENT_CONFIG</a>;
07542 
07543                 status = <a class="code" href="../../d5/d1/pnpres_8c.html#a56">IopGetResourceRequirementsForAssignTable</a>(  requestTablep,
07544                                                                     requestTablep + 1,
07545                                                                     &amp;deviceCount);
07546                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) &amp;&amp; deviceCount) {
07547 
07548                     <span class="comment">//</span>
07549                     <span class="comment">// Release the current resources to the arbiters.</span>
07550                     <span class="comment">// Memory for ResourceList is not released.</span>
07551                     <span class="comment">//</span>
07552 
07553                     <span class="keywordflow">if</span> (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o10">ResourceList</a>) {
07554 
07555                         <a class="code" href="../../d5/d1/pnpres_8c.html#a87">IopReleaseResourcesInternal</a>(deviceNode);
07556                     }
07557 
07558                     <span class="comment">//</span>
07559                     <span class="comment">// Try to do the assignment.</span>
07560                     <span class="comment">//</span>
07561 
07562                     status = <a class="code" href="../../d5/d1/pnpres_8c.html#a67">IopAssignInner</a>(deviceCount, requestTablep, FALSE);
07563                     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
07564 
07565                         deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp;= ~(<a class="code" href="../../d9/d0/pnpiop_8h.html#a20">DNF_RESOURCE_REQUIREMENTS_CHANGED</a> | <a class="code" href="../../d9/d0/pnpiop_8h.html#a21">DNF_NON_STOPPED_REBALANCE</a>);
07566 
07567                         <a class="code" href="../../d5/d1/pnpres_8c.html#a65">IopBuildCmResourceLists</a>(requestTablep, requestTablep + 1);
07568 
07569                         <span class="comment">//</span>
07570                         <span class="comment">// We need to release the pool space for ResourceList and ResourceListTranslated.</span>
07571                         <span class="comment">// Because the earlier IopReleaseResourcesInternal does not release the pool.</span>
07572                         <span class="comment">//</span>
07573 
07574                         <span class="keywordflow">if</span> (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o10">ResourceList</a>) {
07575 
07576                             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o10">ResourceList</a>);
07577 
07578                         }
07579                         <span class="keywordflow">if</span> (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o11">ResourceListTranslated</a>) {
07580 
07581                             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o11">ResourceListTranslated</a>);
07582 
07583                         }
07584 
07585                         deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o10">ResourceList</a> = requestTablep-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o6">ResourceAssignment</a>;
07586                         deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o11">ResourceListTranslated</a> = requestTablep-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o7">TranslatedResourceAssignment</a>;
07587                         deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a18">DNF_RESOURCE_ASSIGNED</a>;
07588                         deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp;= ~<a class="code" href="../../d9/d0/pnpiop_8h.html#a19">DNF_RESOURCE_REPORTED</a>;
07589 
07590                         <a class="code" href="../../d0/d1/pnpirp_8c.html#a19">IopStartDevice</a>(deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o9">PhysicalDeviceObject</a>);
07591 
07592                     } <span class="keywordflow">else</span> {
07593 
07594                         <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> restoreResourcesStatus;
07595 
07596                         restoreResourcesStatus = <a class="code" href="../../d5/d1/pnpres_8c.html#a89">IopRestoreResourcesInternal</a>(deviceNode);
07597                         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(restoreResourcesStatus)) {
07598 
07599                             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(restoreResourcesStatus));
07600                             <a class="code" href="../../d9/d0/pnpiop_8h.html#a306">IopRequestDeviceRemoval</a>(DeviceObject, CM_PROB_NORMAL_CONFLICT);
07601 
07602                         }
07603 
07604                         <span class="comment">//</span>
07605                         <span class="comment">// BUGBUG - once we failed, what will trigger us to try again?</span>
07606                         <span class="comment">//</span>
07607                     }
07608 
07609                     <a class="code" href="../../d5/d1/pnpres_8c.html#a61">IopFreeResourceRequirementsForAssignTable</a>(requestTablep, requestTablep + 1);
07610 
07611 
07612                 } <span class="keywordflow">else</span> {
07613 
07614                     status = <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)? STATUS_UNSUCCESSFUL : status;
07615 
07616                 }
07617 
07618                 deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp;= ~<a class="code" href="../../d9/d0/pnpiop_8h.html#a17">DNF_ASSIGNING_RESOURCES</a>;
07619                 <a class="code" href="../../d9/d0/pnpiop_8h.html#a96">IopReleaseEnumerationLock</a>(deviceNode);
07620 
07621             } <span class="keywordflow">else</span> {
07622 
07623                 <span class="comment">//</span>
07624                 <span class="comment">// The device needs to be stopped to change resources.</span>
07625                 <span class="comment">//</span>
07626 
07627                 status = <a class="code" href="../../d5/d1/pnpres_8c.html#a85">IopRebalance</a>(0, NULL);
07628 
07629             }
07630 
07631             <span class="comment">//</span>
07632             <span class="comment">// Restore the flags in case of failure.</span>
07633             <span class="comment">//</span>
07634 
07635             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
07636 
07637                 deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp;= ~<a class="code" href="../../d9/d0/pnpiop_8h.html#a46">DNF_HAS_RESOURCE</a>;
07638                 deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> |= oldFlags;
07639 
07640             }
07641 
07642         } <span class="keywordflow">else</span> {
07643 
07644             <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(DUMP_ERROR, (<span class="stringliteral">"PNPRES: Resource requirements not changed in IopReallocateResources, returning error!\n"</span>));
07645         }
07646 
07647         <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>(&amp;IopDeviceTreeLock);
07648         <a class="code" href="../../d1/d6/semphobj_8c.html#a3">KeReleaseSemaphore</a>(&amp;IopRegistrySemaphore, 0, 1, FALSE);
07649 
07650     } <span class="keywordflow">else</span> {
07651 
07652         <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(DUMP_ERROR, (<span class="stringliteral">"PNPRES: IopReallocateResources failed to acquire Registry semaphore, status %08X\n"</span>, status));
07653 
07654     }
07655 
07656     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
07657 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a59" doxytag="pnpres.c::IopRearrangeAssignTable" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopRearrangeAssignTable           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>AssignTable</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Count</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l01878">1878</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.
<p>
References <a class="el" href="../../d5/d9/cmconfig_8c-source.html#l00051">Count</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l01767">IopCompareAlternativeCount()</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00720">IopAllocateResources()</a>.
<p>
<pre class="fragment"><div>01885                    :
01886 
01887     This routine sorts <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> REQ_ALTERNATIVE lists of REQ_LIST in increasing order (in terms of
01888     priority value.)  Priority 1 is considered better than priority 2.
01889 
01890     So, the better choice is placed in front of the list.
01891 
01892 Parameters:
01893 
01894     ReqList - Supplies a pointer to a REQ_LIST.
01895 
01896 Return Value:
01897 
01898     None.
01899 
01900 --*/
01901 
01902 {
01903     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01904 
01905     <span class="keywordflow">if</span> (Count == 1 || Count == 0) {
01906 
01907         <span class="comment">//</span>
01908         <span class="comment">// Most ReqLists only have one alternative...</span>
01909         <span class="comment">//</span>
01910 
01911         <span class="keywordflow">return</span>;
01912     }
01913 
01914     qsort((<span class="keywordtype">void</span> *)AssignTable,
01915           Count,
01916           <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">IOP_RESOURCE_REQUEST</a>),
01917           IopCompareAlternativeCount
01918           );
01919 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a58" doxytag="pnpres.c::IopRearrangeReqList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopRearrangeReqList           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d5/d1/pnpres_8c.html#a30">PREQ_LIST</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>ReqList</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l01811">1811</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.
<p>
References <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00275">DebugMessage</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00267">DUMP_ERROR</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00177">_DEVICE_NODE::InstancePath</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l01723">IopComparePriority()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00081">PREQ_ALTERNATIVE</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l01066">IopGetResourceRequirementsForAssignTable()</a>, and <a class="el" href="../../d6/d0/pnpres_8c-source.html#l05660">IopRestoreResourcesInternal()</a>.
<p>
<pre class="fragment"><div>01817                    :
01818 
01819     This routine sorts <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> REQ_ALTERNATIVE lists of REQ_LIST in increasing order (in terms of
01820     priority value.)  Priority 1 is considered better than priority 2.
01821 
01822     So, the better choice is placed in front of the list.
01823 
01824 Parameters:
01825 
01826     ReqList - Supplies a pointer to a REQ_LIST.
01827 
01828 Return Value:
01829 
01830     None.
01831 
01832 --*/
01833 
01834 {
01835     PREQ_ALTERNATIVE *alternative;
01836     PREQ_ALTERNATIVE *lastAlternative;
01837 
01838     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01839 
01840     <span class="keywordflow">if</span> (ReqList-&gt;ReqAlternativeCount &gt; 1) {
01841 
01842         qsort(  (<span class="keywordtype">void</span> *)ReqList-&gt;ReqAlternativeTable,
01843                 ReqList-&gt;ReqAlternativeCount,
01844                 <span class="keyword">sizeof</span>(PREQ_ALTERNATIVE),
01845                 IopComparePriority);
01846 
01847     }
01848 
01849     <span class="comment">//</span>
01850     <span class="comment">// Set the BestAlternative so that we try alternatives with priority &lt;= LCPRI_LASTSOFTCONFIG.</span>
01851     <span class="comment">//</span>
01852 
01853     alternative = &amp;ReqList-&gt;ReqAlternativeTable[0];
01854     <span class="keywordflow">for</span> (lastAlternative = alternative + ReqList-&gt;ReqAlternativeCount; alternative &lt; lastAlternative; alternative++) {
01855 
01856         <span class="keywordflow">if</span> ((*alternative)-&gt;Priority &gt; LCPRI_LASTSOFTCONFIG) {
01857 
01858             <span class="keywordflow">break</span>;
01859 
01860         }
01861     }
01862 
01863     <span class="keywordflow">if</span> (alternative == &amp;ReqList-&gt;ReqAlternativeTable[0]) {
01864 
01865         <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)ReqList-&gt;PhysicalDevice-&gt;DeviceObjectExtension-&gt;DeviceNode;
01866 
01867         <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(DUMP_ERROR, (<span class="stringliteral">"PNPRES: Invalid priorities in the logical configs for %ws\n"</span>, deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o13">InstancePath</a>.Buffer));
01868 <span class="comment">//        ASSERT(alternative != &amp;ReqList-&gt;ReqAlternativeTable[0]);</span>
01869         ReqList-&gt;ReqBestAlternative = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01870 
01871     } <span class="keywordflow">else</span> {
01872 
01873         ReqList-&gt;ReqBestAlternative = alternative;
01874     }
01875 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a85" doxytag="pnpres.c::IopRebalance" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopRebalance           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>AssignTableCont</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>AssignTable</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l05215">5215</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.
<p>
References <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00767">_IOP_RESOURCE_REQUEST::AllocationType</a>, <a class="el" href="../../d6/d9/pnp_8h.html#a173a117">ArbiterActionCommitAllocation</a>, <a class="el" href="../../d6/d9/pnp_8h.html#a174a130">ArbiterRequestPnpEnumerated</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00275">DebugMessage</a>, <a class="el" href="../../d4/d9/ke_8h.html#a407a202">DelayExecution</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01274">_DEVOBJ_EXTENSION::DeviceNode</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01210">_DEVICE_OBJECT::DeviceObjectExtension</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00433">DNF_NO_RESOURCE_REQUIRED</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00473">DNF_NON_STOPPED_REBALANCE</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00453">DNF_RESOURCE_ASSIGNED</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00459">DNF_RESOURCE_REPORTED</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00466">DNF_RESOURCE_REQUIREMENTS_CHANGED</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00480">DNF_STOPPED</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00269">DUMP_DETAIL</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00267">DUMP_ERROR</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00268">DUMP_INFO</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00070">ExAllocatePoolIORR</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00069">ExAllocatePoolPDO</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d0/d1/fedefs_8h-source.html#l00051">exit</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00129">_DEVICE_NODE::Flags</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00766">_IOP_RESOURCE_REQUEST::Flags</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00761">IOP_ASSIGN_CLEAR_RESOURCE_REQUIREMENTS_CHANGE_FLAG</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00755">IOP_ASSIGN_EXCLUDE</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00756">IOP_ASSIGN_IGNORE</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00758">IOP_ASSIGN_RESOURCES_RELEASED</a>, <a class="el" href="../../d9/d0/pnpiop_8h.html#a131">IOP_RESOURCE_REQUEST</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l03292">IopAssignInner()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l02320">IopBuildCmResourceLists()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l07662">IopCheckDataStructures()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l01988">IopFreeResourceRequirementsForAssignTable()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l01066">IopGetResourceRequirementsForAssignTable()</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00098">IopNumberDeviceNodes</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l02554">IopPlacement()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l04589">IopQueryRebalance()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l02733">IopQueryReconfiguration()</a>, <a class="el" href="../../d4/d4/iodata_8c-source.html#l00337">IopRegistrySemaphore</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l05757">IopReleaseResourcesInternal()</a>, <a class="el" href="../../d4/d9/pnpdel_8c-source.html#l01708">IopRequestDeviceRemoval()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l05660">IopRestoreResourcesInternal()</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00056">IopRootDeviceNode</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l00510">IopStartDevice()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00166">IRP_MN_CANCEL_STOP_DEVICE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00164">IRP_MN_STOP_DEVICE</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01598">KeEnterCriticalRegion</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01628">KeLeaveCriticalRegion</a>, <a class="el" href="../../d2/d5/semphobj_8c-source.html#l00118">KeReleaseSemaphore()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00765">_IOP_RESOURCE_REQUEST::PhysicalDevice</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00273">PnpResDebugLevel</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00771">_IOP_RESOURCE_REQUEST::ResourceAssignment</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00161">_DEVICE_NODE::ResourceList</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00163">_DEVICE_NODE::ResourceListTranslated</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00773">_IOP_RESOURCE_REQUEST::Status</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00270">STOP_ERROR</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00772">_IOP_RESOURCE_REQUEST::TranslatedResourceAssignment</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00720">IopAllocateResources()</a>, and <a class="el" href="../../d6/d0/pnpres_8c-source.html#l07470">IopReallocateResources()</a>.
<p>
<pre class="fragment"><div>05223                    :
05224 
05225     This routine performs rebalancing operation.  There are two rebalance phases:
05226     In <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> phase 0, we <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> consider <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> devices whoes resource requirements changed
05227     and their children; in phase 1, we consider anyone who succeeds <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> query-stop.
05228 
05229 Parameters:
05230 
05231     AssignTableCount,
05232     AssignTable - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of origianl AssignTableCout and AssignTable which
05233                   triggers <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> rebalance operation.
05234 
05235         (<span class="keywordflow">if</span> AssignTableCount == 0, we are processing device state change.)
05236 
05237 Return Value:
05238 
05239     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> code that indicates whether or not <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function was successful.
05240 
05241 --*/
05242 
05243 {
05244     ULONG count, i;
05245     <a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a> table = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, tableEnd, newEntry;
05246     <a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a> requestTable = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, requestTableEnd, entry1, entry2;
05247     ULONG phase0RebalanceCount = 0, rebalanceCount = 0, deviceCount;
05248     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status, statusx;
05249     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> *deviceTable, *deviceTablex;
05250     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode;
05251     ULONG rebalancePhase = 0;
05252 
05253     <span class="comment">//</span>
05254     <span class="comment">// Query all the device nodes to see who are willing to participate the rebalance</span>
05255     <span class="comment">// process.</span>
05256     <span class="comment">//</span>
05257 
05258     deviceTable = (<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> *) <a class="code" href="../../d5/d1/pnpres_8c.html#a10">ExAllocatePoolPDO</a>(
05259                       PagedPool,
05260                       <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>) * IopNumberDeviceNodes);
05261     <span class="keywordflow">if</span> (deviceTable == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05262         <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(DUMP_ERROR, (<span class="stringliteral">"Rebalance: Not enough memory to perform rebalance\n"</span>));
05263         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
05264     }
05265 
05266 
05267 tryAgain:
05268     deviceTablex = deviceTable + phase0RebalanceCount;
05269 
05270     <span class="comment">//</span>
05271     <span class="comment">// Walk device node tree depth-first to query-stop and stop devices.</span>
05272     <span class="comment">// At this point the resources of the stopped devices are not released yet.</span>
05273     <span class="comment">// Also, the leaf nodes are in the front of the device table and non leaf nodes</span>
05274     <span class="comment">// are at the end of the table.</span>
05275     <span class="comment">//</span>
05276 
05277     <a class="code" href="../../d5/d1/pnpres_8c.html#a80">IopQueryRebalance</a> (IopRootDeviceNode, rebalancePhase, &amp;rebalanceCount, &amp;deviceTablex);
05278     <span class="keywordflow">if</span> (rebalanceCount == 0) {
05279 
05280         <span class="comment">//</span>
05281         <span class="comment">// If no one is interested and we are not processing resources req change,</span>
05282         <span class="comment">// move to next phase.</span>
05283         <span class="comment">//</span>
05284 
05285         <span class="keywordflow">if</span> (rebalancePhase == 0 &amp;&amp; AssignTableCount != 0) {
05286             rebalancePhase = 1;
05287             <span class="keywordflow">goto</span> tryAgain;
05288         }
05289         <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(DUMP_INFO, (<span class="stringliteral">"Rebalance: No device participates in rebalance phase %x\n"</span>, rebalancePhase));
05290         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(deviceTable);
05291         deviceTable = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05292         status = STATUS_UNSUCCESSFUL;
05293         <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
05294     }
05295     <span class="keywordflow">if</span> (rebalanceCount == phase0RebalanceCount) {
05296 
05297         <span class="comment">//</span>
05298         <span class="comment">// Phase 0 failed and no new device participates. failed the rebalance.</span>
05299         <span class="comment">//</span>
05300 
05301         status = STATUS_UNSUCCESSFUL;
05302         <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
05303     }
05304     <span class="keywordflow">if</span> (rebalancePhase == 0) {
05305         phase0RebalanceCount = rebalanceCount;
05306     }
05307 
05308     <span class="comment">//</span>
05309     <span class="comment">// Allocate pool for the new reconfiguration requests and the original requests.</span>
05310     <span class="comment">//</span>
05311 
05312     table = (<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a>) <a class="code" href="../../d5/d1/pnpres_8c.html#a11">ExAllocatePoolIORR</a>(
05313                  PagedPool,
05314                  <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">IOP_RESOURCE_REQUEST</a>) * (AssignTableCount + rebalanceCount)
05315                  );
05316     <span class="keywordflow">if</span> (table == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05317         <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(DUMP_ERROR, (<span class="stringliteral">"Rebalance: Not enough memory to perform rebalance\n"</span>));
05318         status = STATUS_INSUFFICIENT_RESOURCES;
05319         <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
05320     }
05321     tableEnd = table + AssignTableCount + rebalanceCount;
05322 
05323     <span class="comment">//</span>
05324     <span class="comment">// Build a new resource request table.  The original requests will be at the beginning</span>
05325     <span class="comment">// of the table and new requests (reconfigured devices) are at the end.</span>
05326     <span class="comment">// After the new request table is built, the leaf nodes will be in front of the table,</span>
05327     <span class="comment">// and non leaf nodes will be close to the end of the table.  This is for optimization.</span>
05328     <span class="comment">//</span>
05329 
05330     <span class="comment">//</span>
05331     <span class="comment">// Copy the original request to the front of our new request table.</span>
05332     <span class="comment">//</span>
05333 
05334     <span class="keywordflow">if</span> (AssignTableCount != 0) {
05335         RtlMoveMemory(table, AssignTable, <span class="keyword">sizeof</span>(IOP_RESOURCE_REQUEST) * AssignTableCount);
05336     }
05337 
05338     <span class="comment">//</span>
05339     <span class="comment">// Initialize all the new entries of our new request table,</span>
05340     <span class="comment">//</span>
05341 
05342     newEntry = table + AssignTableCount;
05343     RtlZeroMemory(newEntry, <span class="keyword">sizeof</span>(IOP_RESOURCE_REQUEST) * rebalanceCount);
05344     <span class="keywordflow">for</span> (i = 0, deviceTablex = deviceTable; i &lt; rebalanceCount; i++, deviceTablex++) {
05345         newEntry[i].<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o2">AllocationType</a> = <a class="code" href="../../d6/d9/pnp_8h.html#a174a130">ArbiterRequestPnpEnumerated</a>;
05346         newEntry[i].<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o0">PhysicalDevice</a> = *deviceTablex;
05347     }
05348 
05349     status = <a class="code" href="../../d5/d1/pnpres_8c.html#a56">IopGetResourceRequirementsForAssignTable</a>(
05350                  newEntry,
05351                  tableEnd ,
05352                  &amp;deviceCount);
05353     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) || deviceCount == 0) {
05354          <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(DUMP_ERROR, (<span class="stringliteral">"Rebalance: GetResourceRequirementsForAssignTable failed\n"</span>));
05355          status = <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)? STATUS_UNSUCCESSFUL : status;
05356          <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
05357     }
05358 
05359     <span class="comment">//</span>
05360     <span class="comment">// Process the AssignTable to remove any entry which is marked as IOP_ASSIGN_IGNORE</span>
05361     <span class="comment">//</span>
05362 
05363     <span class="keywordflow">if</span> (deviceCount != rebalanceCount) {
05364 
05365         deviceCount += AssignTableCount;
05366         requestTable = (<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a>) <a class="code" href="../../d5/d1/pnpres_8c.html#a11">ExAllocatePoolIORR</a>(
05367                              PagedPool,
05368                              <span class="keyword">sizeof</span>(IOP_RESOURCE_REQUEST) * deviceCount
05369                              );
05370         <span class="keywordflow">if</span> (requestTable == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05371             <a class="code" href="../../d5/d1/pnpres_8c.html#a61">IopFreeResourceRequirementsForAssignTable</a>(newEntry, tableEnd);
05372             status = STATUS_INSUFFICIENT_RESOURCES;
05373             <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
05374         }
05375         <span class="keywordflow">for</span> (entry1 = table, entry2 = requestTable; entry1 &lt; tableEnd; entry1++) {
05376             <span class="keywordflow">if</span> (!(entry1-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o1">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a69">IOP_ASSIGN_IGNORE</a>)) {
05377                 *entry2 = *entry1;
05378                 entry2++;
05379             } <span class="keywordflow">else</span> {
05380                 <span class="comment">//</span>
05381                 <span class="comment">// BUGBUG!!! ??? (jamiehun)</span>
05382                 <span class="comment">// if this assert fails, parts of this code are broken</span>
05383                 <span class="comment">//</span>
05384                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(entry1 &gt;= newEntry);
05385             }
05386         }
05387         requestTableEnd = requestTable + deviceCount;
05388     } <span class="keywordflow">else</span> {
05389         requestTable = table;
05390         requestTableEnd = tableEnd;
05391         deviceCount += AssignTableCount;
05392     }
05393 
05394     <span class="comment">//</span>
05395     <span class="comment">// DO NOT Sort the AssignTable</span>
05396     <span class="comment">//</span>
05397 
05398     <span class="comment">//IopRearrangeAssignTable(requestTable, deviceCount);</span>
05399 
05400 <span class="preprocessor">#if 0</span>
05401 <span class="preprocessor"></span>
05402     <span class="comment">//</span>
05403     <span class="comment">// We are about to perform rebalance.  Release the resources of the reconfiguration devices</span>
05404     <span class="comment">//</span>
05405 
05406     <span class="keywordflow">for</span> (entry1 = newEntry; entry1 &lt; tableEnd; entry1++) {
05407         <span class="keywordflow">if</span> (!(entry1-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o1">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a69">IOP_ASSIGN_IGNORE</a>) &amp;&amp;
05408             !(entry1-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o1">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a71">IOP_ASSIGN_RESOURCES_RELEASED</a>)) {
05409             deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)entry1-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o0">PhysicalDevice</a>-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o6">DeviceNode</a>;
05410             <span class="keywordflow">if</span> (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o10">ResourceList</a>) {
05411 
05412                 <span class="comment">//</span>
05413                 <span class="comment">// Call IopReleaseResourcesInternal instead of IopReleaseResources such that</span>
05414                 <span class="comment">// the pool for devicenode-&gt;ResourceList is not freed.  We need it to restart</span>
05415                 <span class="comment">// the reconfigured devices in case rebalance failed.</span>
05416                 <span class="comment">//</span>
05417 
05418                 <a class="code" href="../../d5/d1/pnpres_8c.html#a87">IopReleaseResourcesInternal</a>(deviceNode);
05419                 entry1-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o1">Flags</a> |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a71">IOP_ASSIGN_RESOURCES_RELEASED</a>;
05420             }
05421         }
05422     }
05423 
05424 <span class="preprocessor">#endif</span>
05425 <span class="preprocessor"></span>
05426     <span class="comment">//</span>
05427     <span class="comment">// Assign the resources. If we succeed, or if</span>
05428     <span class="comment">// there is a memory shortage return immediately.</span>
05429     <span class="comment">//</span>
05430 
05431     status = <a class="code" href="../../d5/d1/pnpres_8c.html#a67">IopAssignInner</a>(deviceCount, requestTable, TRUE);
05432     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
05433 
05434         <span class="comment">//</span>
05435         <span class="comment">// If the rebalance succeeded, we need to restart all the reconfigured devices.</span>
05436         <span class="comment">// For the original devices, we will return and let IopAllocateResources to deal</span>
05437         <span class="comment">// with them.</span>
05438         <span class="comment">//</span>
05439 
05440         <a class="code" href="../../d5/d1/pnpres_8c.html#a65">IopBuildCmResourceLists</a>(requestTable, requestTableEnd);
05441 
05442         <span class="comment">//</span>
05443         <span class="comment">// Copy the new status back to the original AssignTable.</span>
05444         <span class="comment">//</span>
05445 
05446         <span class="keywordflow">if</span> (AssignTableCount != 0) {
05447             RtlMoveMemory(AssignTable, requestTable, <span class="keyword">sizeof</span>(IOP_RESOURCE_REQUEST) * AssignTableCount);
05448         }
05449         <span class="comment">//</span>
05450         <span class="comment">// free resource requirements we allocated while here</span>
05451         <span class="comment">//</span>
05452         <a class="code" href="../../d5/d1/pnpres_8c.html#a61">IopFreeResourceRequirementsForAssignTable</a>(requestTable+AssignTableCount, requestTableEnd);
05453 
05454         <span class="keywordflow">if</span> (table != requestTable) {
05455 
05456             <span class="comment">//</span>
05457             <span class="comment">// If we switched request table ... copy the contents of new table back to</span>
05458             <span class="comment">// the old table.</span>
05459             <span class="comment">//</span>
05460 
05461             <span class="keywordflow">for</span> (entry1 = table, entry2 = requestTable; entry2 &lt; requestTableEnd;) {
05462 
05463                 <span class="keywordflow">if</span> (entry1-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o1">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a69">IOP_ASSIGN_IGNORE</a>) {
05464                     entry1++;
05465                     <span class="keywordflow">continue</span>;
05466                 }
05467                 *entry1 = *entry2;
05468                 <span class="keywordflow">if</span> (entry2-&gt;Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a68">IOP_ASSIGN_EXCLUDE</a>) {
05469                     entry1-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o8">Status</a> = STATUS_CONFLICTING_ADDRESSES;
05470                 }
05471                 entry2++;
05472                 entry1++;
05473             }
05474         }
05475 
05476         <span class="comment">//</span>
05477         <span class="comment">// Go thru the origianl request table to stop each query-stopped/reconfigured device.</span>
05478         <span class="comment">//</span>
05479 
05480         <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(DUMP_DETAIL, (<span class="stringliteral">"PnpRes: STOP reconfigured devices during REBALANCE.\n"</span>));
05481 
05482         <span class="keywordflow">for</span> (entry1 = newEntry; entry1 &lt; tableEnd; entry1++) {
05483             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(entry1-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o8">Status</a>)) {
05484                 <a class="code" href="../../d0/d1/pnpirp_8c.html#a29">IopQueryReconfiguration</a> (IRP_MN_STOP_DEVICE, entry1-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o0">PhysicalDevice</a>);
05485             } <span class="keywordflow">else</span> {
05486                 <a class="code" href="../../d0/d1/pnpirp_8c.html#a29">IopQueryReconfiguration</a> (IRP_MN_CANCEL_STOP_DEVICE, entry1-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o0">PhysicalDevice</a>);
05487                 deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)entry1-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o0">PhysicalDevice</a>-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o6">DeviceNode</a>;
05488                 deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp;= ~<a class="code" href="../../d9/d0/pnpiop_8h.html#a22">DNF_STOPPED</a>;
05489             }
05490         }
05491 
05492         <span class="comment">//</span>
05493         <span class="comment">// Commit the allocation AFTER stopping rebalance candidates.</span>
05494         <span class="comment">//</span>
05495 
05496         <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(DUMP_DETAIL, (<span class="stringliteral">"PnpRes: Commit the new allocation during REBALANCE.\n"</span>));
05497 
05498         <a class="code" href="../../d5/d1/pnpres_8c.html#a68">IopPlacement</a>(ArbiterActionCommitAllocation, TRUE);
05499 
05500 <span class="preprocessor">#if DBG_SCOPE</span>
05501 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="../../d5/d1/pnpres_8c.html#a47">PnpResDebugLevel</a> &amp; <a class="code" href="../../d5/d1/pnpres_8c.html#a26">STOP_ERROR</a>) {
05502             <a class="code" href="../../d5/d1/pnpres_8c.html#a99">IopCheckDataStructures</a>(IopRootDeviceNode);
05503         }
05504 <span class="preprocessor">#endif</span>
05505 <span class="preprocessor"></span>
05506         <span class="comment">//</span>
05507         <span class="comment">// Go thru the origianl request table to start each stopped/reconfigured device.</span>
05508         <span class="comment">//</span>
05509 
05510         <span class="keywordflow">for</span> (entry1 = tableEnd - 1; entry1 &gt;= newEntry; entry1--) {
05511             deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)entry1-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o0">PhysicalDevice</a>-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o6">DeviceNode</a>;
05512 
05513             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(entry1-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o8">Status</a>)) {
05514 
05515                 <span class="comment">//</span>
05516                 <span class="comment">// We need to release the pool space for ResourceList and ResourceListTranslated.</span>
05517                 <span class="comment">// Because the earlier IopReleaseResourcesInternal does not release the pool.</span>
05518                 <span class="comment">//</span>
05519 
05520                 <span class="keywordflow">if</span> (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o10">ResourceList</a>) {
05521                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o10">ResourceList</a>);
05522                 }
05523                 deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o10">ResourceList</a> = entry1-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o6">ResourceAssignment</a>;
05524                 <span class="keywordflow">if</span> (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o11">ResourceListTranslated</a>) {
05525                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o11">ResourceListTranslated</a>);
05526                 }
05527                 deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o11">ResourceListTranslated</a> = entry1-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o7">TranslatedResourceAssignment</a>;
05528                 <span class="keywordflow">if</span> (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o10">ResourceList</a>) {
05529                     deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a18">DNF_RESOURCE_ASSIGNED</a>;
05530                     deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp;= ~<a class="code" href="../../d9/d0/pnpiop_8h.html#a19">DNF_RESOURCE_REPORTED</a>;
05531                 } <span class="keywordflow">else</span> {
05532                     deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a15">DNF_NO_RESOURCE_REQUIRED</a>;
05533                 }
05534                 <span class="keywordflow">if</span> (entry1-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o1">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a73">IOP_ASSIGN_CLEAR_RESOURCE_REQUIREMENTS_CHANGE_FLAG</a>) {
05535 
05536                     <span class="comment">//</span>
05537                     <span class="comment">// If we are processing the resource requirements change request,</span>
05538                     <span class="comment">// clear its related flags.</span>
05539                     <span class="comment">//</span>
05540 
05541                     deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp;= ~(<a class="code" href="../../d9/d0/pnpiop_8h.html#a20">DNF_RESOURCE_REQUIREMENTS_CHANGED</a> | <a class="code" href="../../d9/d0/pnpiop_8h.html#a21">DNF_NON_STOPPED_REBALANCE</a>);
05542                 }
05543 
05544                 <span class="comment">//</span>
05545                 <span class="comment">// Some drivers (like ndis) may want to do resource allocation during START.</span>
05546                 <span class="comment">// So let go of the IopRegistrySemaphore during the start.</span>
05547                 <span class="comment">//</span>
05548 
05549                 <a class="code" href="../../d1/d6/semphobj_8c.html#a3">KeReleaseSemaphore</a>(&amp;IopRegistrySemaphore, 0, 1, FALSE);
05550                 <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
05551                 <a class="code" href="../../d0/d1/pnpirp_8c.html#a19">IopStartDevice</a>(entry1-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o0">PhysicalDevice</a>);
05552                 <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
05553                 <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>(  &amp;IopRegistrySemaphore,
05554                                         DelayExecution,
05555                                         KernelMode,
05556                                         FALSE,
05557                                         NULL );
05558             }
05559         }
05560 
05561         <span class="comment">//</span>
05562         <span class="comment">// Finally release the references of the reconfigured device objects</span>
05563         <span class="comment">//</span>
05564 
05565         <span class="keywordflow">for</span> (deviceTablex = (deviceTable + rebalanceCount - 1);
05566              deviceTablex &gt;= deviceTable;
05567              deviceTablex--) {
05568              <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(*deviceTablex);
05569         }
05570         status = STATUS_SUCCESS;
05571     } <span class="keywordflow">else</span> {
05572 
05573         <span class="comment">//</span>
05574         <span class="comment">// Rebalance failed. Free our internal representation of the rebalance</span>
05575         <span class="comment">// candidates' resource requirements lists.</span>
05576         <span class="comment">// BugBug - should optimize the code.</span>
05577         <span class="comment">//</span>
05578 
05579         <a class="code" href="../../d5/d1/pnpres_8c.html#a61">IopFreeResourceRequirementsForAssignTable</a>(requestTable + AssignTableCount, requestTableEnd);
05580         <span class="keywordflow">if</span> (rebalancePhase == 0) {
05581             rebalancePhase++;
05582             <span class="keywordflow">if</span> (requestTable) {
05583                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(requestTable);
05584             }
05585             <span class="keywordflow">if</span> (table &amp;&amp; (table != requestTable)) {
05586                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(table);
05587             }
05588             table = requestTable = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05589             <span class="keywordflow">goto</span> tryAgain;
05590         }
05591 
05592         <span class="comment">//</span>
05593         <span class="comment">// Rebalance failed.  Restore the resources for the reconfiguration participated devices.</span>
05594         <span class="comment">// Note, for some devices, their resource requirements may already changed.  In this</span>
05595         <span class="comment">// case, the resources we restore do not reflect the new requirements.</span>
05596         <span class="comment">//</span>
05597 
05598         <span class="keywordflow">for</span> (deviceTablex = (deviceTable + rebalanceCount - 1);
05599              deviceTablex &gt;= deviceTable;
05600              deviceTablex--) {
05601              deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)((*deviceTablex)-&gt;DeviceObjectExtension-&gt;DeviceNode);
05602 <span class="preprocessor">#if 0</span>
05603 <span class="preprocessor"></span>             statusx = <a class="code" href="../../d5/d1/pnpres_8c.html#a89">IopRestoreResourcesInternal</a>(deviceNode);
05604              <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(statusx)) {
05605                  <a class="code" href="../../d0/d1/pnpirp_8c.html#a29">IopQueryReconfiguration</a> (IRP_MN_CANCEL_STOP_DEVICE, *deviceTablex);
05606                  deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp;= ~<a class="code" href="../../d9/d0/pnpiop_8h.html#a22">DNF_STOPPED</a>;
05607              } <span class="keywordflow">else</span> {
05608                  <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(0);
05609                  <a class="code" href="../../d9/d0/pnpiop_8h.html#a306">IopRequestDeviceRemoval</a>(*deviceTablex);
05610              }
05611 <span class="preprocessor">#else</span>
05612 <span class="preprocessor"></span>             <a class="code" href="../../d0/d1/pnpirp_8c.html#a29">IopQueryReconfiguration</a> (IRP_MN_CANCEL_STOP_DEVICE, *deviceTablex);
05613              deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp;= ~<a class="code" href="../../d9/d0/pnpiop_8h.html#a22">DNF_STOPPED</a>;
05614 <span class="preprocessor">#endif</span>
05615 <span class="preprocessor"></span>             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(*deviceTablex);
05616         }
05617     }
05618     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(deviceTable);
05619     deviceTable = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05620 
05621 <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>:
05622 
05623     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) &amp;&amp; deviceTable) {
05624 
05625         <span class="comment">//</span>
05626         <span class="comment">// If we failed before trying to perform resource assignment,</span>
05627         <span class="comment">// we will end up here.</span>
05628         <span class="comment">//</span>
05629 
05630         <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(DUMP_INFO, (<span class="stringliteral">"Rebalance: Rebalance failed\n"</span>));
05631 
05632         <span class="comment">//</span>
05633         <span class="comment">// Somehow we failed to start the rebalance operation.</span>
05634         <span class="comment">// We will cancel the query-stop request for the query-stopped devices bredth first.</span>
05635         <span class="comment">//</span>
05636 
05637         <span class="keywordflow">for</span> (deviceTablex = (deviceTable + rebalanceCount - 1);
05638              deviceTablex &gt;= deviceTable;
05639              deviceTablex--) {
05640 
05641              deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)((*deviceTablex)-&gt;DeviceObjectExtension-&gt;DeviceNode);
05642              <a class="code" href="../../d0/d1/pnpirp_8c.html#a29">IopQueryReconfiguration</a> (IRP_MN_CANCEL_STOP_DEVICE, *deviceTablex);
05643              deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp;= ~<a class="code" href="../../d9/d0/pnpiop_8h.html#a22">DNF_STOPPED</a>;
05644              <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(*deviceTablex);
05645         }
05646     }
05647     <span class="keywordflow">if</span> (deviceTable) {
05648         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(deviceTable);
05649     }
05650     <span class="keywordflow">if</span> (requestTable) {
05651         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(requestTable);
05652     }
05653     <span class="keywordflow">if</span> (table &amp;&amp; (table != requestTable)) {
05654         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(table);
05655     }
05656     <span class="keywordflow">return</span> status;
05657 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a96" doxytag="pnpres.c::IopReleaseFilteredBootResources" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopReleaseFilteredBootResources           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>AssignTable</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>AssignTableEnd</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l02474">2474</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.
<p>
References <a class="el" href="../../d6/d9/pnp_8h.html#a174a130">ArbiterRequestPnpEnumerated</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01274">_DEVOBJ_EXTENSION::DeviceNode</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01210">_DEVICE_OBJECT::DeviceObjectExtension</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00421">DNF_BOOT_CONFIG_RESERVED</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00766">_IOP_RESOURCE_REQUEST::Flags</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00129">_DEVICE_NODE::Flags</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00755">IOP_ASSIGN_EXCLUDE</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l02391">IopNeedToReleaseBootResources()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l05757">IopReleaseResourcesInternal()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l07198">IopReserveBootResourcesInternal()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l05660">IopRestoreResourcesInternal()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00765">_IOP_RESOURCE_REQUEST::PhysicalDevice</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00771">_IOP_RESOURCE_REQUEST::ResourceAssignment</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00161">_DEVICE_NODE::ResourceList</a>, and <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00773">_IOP_RESOURCE_REQUEST::Status</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00720">IopAllocateResources()</a>.
<p>
<pre class="fragment"><div>02481                    :
02482 
02483     For each AssignTable entry, <span class="keyword">this</span> routine checks <span class="keywordflow">if</span> we need to manually release <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device's
02484     boot resources.
02485 
02486 Parameters:
02487 
02488     AssignTable - supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first entry of a <a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">IOP_RESOURCE_REQUEST</a> table.
02489 
02490     AssignTableEnd - supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> end of <a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">IOP_RESOURCE_REQUEST</a> table.
02491 
02492 Return Value:
02493 
02494     None.
02495 
02496 --*/
02497 
02498 {
02499     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
02500     <a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a> assignEntry;
02501     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> physicalDevice;
02502     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode;
02503 
02504     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02505 
02506     <span class="comment">//</span>
02507     <span class="comment">// Go thru each entry, for each Physical device object, we build a CmResourceList</span>
02508     <span class="comment">// from its ListOfAssignedResources.</span>
02509     <span class="comment">//</span>
02510 
02511     <span class="keywordflow">for</span> (assignEntry = AssignTable; assignEntry &lt; AssignTableEnd; ++assignEntry) {
02512 
02513         <span class="keywordflow">if</span> (assignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o6">ResourceAssignment</a>) {
02514             physicalDevice = assignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o0">PhysicalDevice</a>;
02515             deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)physicalDevice-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o6">DeviceNode</a>;
02516 
02517             <span class="comment">//</span>
02518             <span class="comment">// Release the device's boot resources if desired</span>
02519             <span class="comment">// (If a driver filters its res req list and removes some boot resources, after arbiter satisfies</span>
02520             <span class="comment">// the new res req list, the filtered out boot resources do not get</span>
02521             <span class="comment">// released by arbiters.  Because they no longer passed to arbiters. )</span>
02522             <span class="comment">// I am not 100% sure we should release the filtered boot resources.  But that's what arbiters try</span>
02523             <span class="comment">// to achieve.  So, we will do it.</span>
02524             <span class="comment">//</span>
02525 
02526             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d1/pnpres_8c.html#a95">IopNeedToReleaseBootResources</a>(deviceNode, assignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o6">ResourceAssignment</a>)) {
02527                 <a class="code" href="../../d5/d1/pnpres_8c.html#a87">IopReleaseResourcesInternal</a>(deviceNode);
02528                 <a class="code" href="../../d5/d1/pnpres_8c.html#a94">IopReserveBootResourcesInternal</a>(
02529                         ArbiterRequestPnpEnumerated,
02530                         physicalDevice,
02531                         assignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o6">ResourceAssignment</a>);
02532                 deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp;= ~<a class="code" href="../../d9/d0/pnpiop_8h.html#a13">DNF_BOOT_CONFIG_RESERVED</a>;  <span class="comment">// Keep DeviceNode-&gt;BootResources</span>
02533                 deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o10">ResourceList</a> = assignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o6">ResourceAssignment</a>;
02534                 status = <a class="code" href="../../d5/d1/pnpres_8c.html#a89">IopRestoreResourcesInternal</a>(deviceNode);
02535                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(status == STATUS_SUCCESS);
02536                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
02537 
02538                     <span class="comment">//</span>
02539                     <span class="comment">// BUGBUG - according to arbiter design, we should bugcheck.</span>
02540                     <span class="comment">//</span>
02541 
02542                     assignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o1">Flags</a> = <a class="code" href="../../d9/d0/pnpiop_8h.html#a68">IOP_ASSIGN_EXCLUDE</a>;
02543                     assignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o8">Status</a> = status;
02544                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(assignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o6">ResourceAssignment</a>);
02545                     assignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o6">ResourceAssignment</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02546                 }
02547                 deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o10">ResourceList</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02548             }
02549         }
02550     }
02551 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a88" doxytag="pnpres.c::IopReleaseResources" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopReleaseResources           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>DeviceNode</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l07383">7383</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.
<p>
References <a class="el" href="../../d6/d9/pnp_8h.html#a174a130">ArbiterRequestPnpEnumerated</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00421">DNF_BOOT_CONFIG_RESERVED</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00563">DNF_DEVICE_GONE</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00415">DNF_HAS_BOOT_CONFIG</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00370">DNF_MADEUP</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00453">DNF_RESOURCE_ASSIGNED</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00459">DNF_RESOURCE_REPORTED</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l05757">IopReleaseResourcesInternal()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l07198">IopReserveBootResourcesInternal()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, and <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l06180">IopLegacyResourceAllocation()</a>.
<p>
<pre class="fragment"><div>07389                    :
07390 
07391     <a class="code" href="../../d5/d1/pnpres_8c.html#a88">IopReleaseResources</a> releases resources owned by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device and release
07392     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> memory <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a>.  We also release <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> cached resource requirements list.
07393     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a root enumerated device with BOOT config, we will preallocate
07394     boot config resources <span class="keywordflow">for</span> <span class="keyword">this</span> device.
07395 
07396     NOTE, <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a routine INTERNAL to <span class="keyword">this</span> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.  NO one should call <span class="keyword">this</span> function
07397     outside of <span class="keyword">this</span> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.  Outside of <span class="keyword">this</span> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>, <a class="code" href="../../d2/d0/pnpdd_8c.html#a11">IopReleaseDeviceResources</a> should be
07398     used.
07399 
07400 Arguments:
07401 
07402     DeviceNode - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device node.object.  If present, caller wants to
07403 
07404 Return Value:
07405 
07406     None.
07407 
07408 --*/
07409 {
07410 
07411     <span class="comment">//</span>
07412     <span class="comment">// Release the resources owned by the device</span>
07413     <span class="comment">//</span>
07414 
07415     <a class="code" href="../../d5/d1/pnpres_8c.html#a87">IopReleaseResourcesInternal</a>(DeviceNode);
07416     DeviceNode-&gt;Flags &amp;= ~<a class="code" href="../../d9/d0/pnpiop_8h.html#a18">DNF_RESOURCE_ASSIGNED</a>;
07417     DeviceNode-&gt;Flags &amp;= ~<a class="code" href="../../d9/d0/pnpiop_8h.html#a19">DNF_RESOURCE_REPORTED</a>;
07418 
07419 <span class="preprocessor">#if DBG_SCOPE</span>
07420 <span class="preprocessor"></span>
07421     <span class="keywordflow">if</span> (DeviceNode-&gt;PreviousResourceList) {
07422         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(DeviceNode-&gt;PreviousResourceList);
07423         DeviceNode-&gt;PreviousResourceList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
07424     }
07425     <span class="keywordflow">if</span> (DeviceNode-&gt;PreviousResourceRequirements) {
07426         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(DeviceNode-&gt;PreviousResourceRequirements);
07427         DeviceNode-&gt;PreviousResourceRequirements = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
07428     }
07429 <span class="preprocessor">#endif</span>
07430 <span class="preprocessor"></span>
07431     <span class="keywordflow">if</span> (DeviceNode-&gt;ResourceList) {
07432 
07433 <span class="preprocessor">#if DBG_SCOPE</span>
07434 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(DeviceNode-&gt;FailureStatus)) {
07435             DeviceNode-&gt;PreviousResourceList = DeviceNode-&gt;ResourceList;
07436         } <span class="keywordflow">else</span> {
07437             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(DeviceNode-&gt;ResourceList);
07438         }
07439 <span class="preprocessor">#else</span>
07440 <span class="preprocessor"></span>        <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(DeviceNode-&gt;ResourceList);
07441 <span class="preprocessor">#endif</span>
07442 <span class="preprocessor"></span>
07443         DeviceNode-&gt;ResourceList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
07444     }
07445     <span class="keywordflow">if</span> (DeviceNode-&gt;ResourceListTranslated) {
07446         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(DeviceNode-&gt;ResourceListTranslated);
07447         DeviceNode-&gt;ResourceListTranslated = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
07448     }
07449 
07450     <span class="comment">//</span>
07451     <span class="comment">// If this device is a root enumerated device, preallocate its BOOT resources</span>
07452     <span class="comment">//</span>
07453 
07454     <span class="keywordflow">if</span> ((DeviceNode-&gt;Flags &amp; (<a class="code" href="../../d9/d0/pnpiop_8h.html#a5">DNF_MADEUP</a> | <a class="code" href="../../d9/d0/pnpiop_8h.html#a33">DNF_DEVICE_GONE</a>)) == <a class="code" href="../../d9/d0/pnpiop_8h.html#a5">DNF_MADEUP</a>) {
07455         <span class="keywordflow">if</span> (DeviceNode-&gt;Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a12">DNF_HAS_BOOT_CONFIG</a> &amp;&amp; DeviceNode-&gt;BootResources) {
07456             <a class="code" href="../../d5/d1/pnpres_8c.html#a94">IopReserveBootResourcesInternal</a>(ArbiterRequestPnpEnumerated,
07457                                             DeviceNode-&gt;PhysicalDeviceObject,
07458                                             DeviceNode-&gt;BootResources);
07459         }
07460     } <span class="keywordflow">else</span> {
07461         DeviceNode-&gt;Flags &amp;= ~(<a class="code" href="../../d9/d0/pnpiop_8h.html#a12">DNF_HAS_BOOT_CONFIG</a> | <a class="code" href="../../d9/d0/pnpiop_8h.html#a13">DNF_BOOT_CONFIG_RESERVED</a>);
07462         <span class="keywordflow">if</span> (DeviceNode-&gt;BootResources) {
07463             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(DeviceNode-&gt;BootResources);
07464             DeviceNode-&gt;BootResources = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
07465         }
07466     }
07467 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a87" doxytag="pnpres.c::IopReleaseResourcesInternal" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopReleaseResourcesInternal           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>DeviceNode</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l05757">5757</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.
<p>
References <a class="el" href="../../d7/d8/pnp_8h-source.html#l00744">_ARBITER_LIST_ENTRY::AlternativeCount</a>, <a class="el" href="../../d7/d8/pnp_8h-source.html#l00749">_ARBITER_LIST_ENTRY::Alternatives</a>, <a class="el" href="../../d6/d9/pnp_8h.html#a173a117">ArbiterActionCommitAllocation</a>, <a class="el" href="../../d6/d9/pnp_8h.html#a173a115">ArbiterActionTestAllocation</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00709">_PI_RESOURCE_ARBITER_ENTRY::ArbiterInterface</a>, <a class="el" href="../../d6/d9/pnp_8h.html#a174a130">ArbiterRequestPnpEnumerated</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d8/pnp_8h-source.html#l00785">_ARBITER_LIST_ENTRY::Assignment</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00239">_DEVICE_NODE::DeviceArbiterList</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d7/d8/pnp_8h-source.html#l00764">_ARBITER_LIST_ENTRY::Flags</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l04339">IopCallArbiter()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l06408">IopFindBusDeviceNode()</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00056">IopRootDeviceNode</a>, <a class="el" href="../../d9/d0/pnpiop_8h.html#a301">IopWriteAllocatedResourcesToRegistry()</a>, <a class="el" href="../../d7/d8/pnp_8h-source.html#l00739">_ARBITER_LIST_ENTRY::ListEntry</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00105">_DEVICE_NODE::Parent</a>, <a class="el" href="../../d7/d8/pnp_8h-source.html#l00754">_ARBITER_LIST_ENTRY::PhysicalDeviceObject</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00167">PnpDefaultInterfaceType</a>, <a class="el" href="../../d7/d8/pnp_8h-source.html#l00759">_ARBITER_LIST_ENTRY::RequestSource</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00710">_PI_RESOURCE_ARBITER_ENTRY::ResourceList</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d7/d8/pnp_8h-source.html#l00770">_ARBITER_LIST_ENTRY::WorkSpace</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l07470">IopReallocateResources()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l05215">IopRebalance()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l02474">IopReleaseFilteredBootResources()</a>, and <a class="el" href="../../d6/d0/pnpres_8c-source.html#l07383">IopReleaseResources()</a>.
<p>
<pre class="fragment"><div>05763                    :
05764 
05765     This routine releases <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> assigned resources <span class="keywordflow">for</span> device specified by DeviceNode.
05766     Note, <span class="keyword">this</span> routine does not reset <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resource related fields in DeviceNode structure.
05767 
05768 Parameters:
05769 
05770     DeviceNode - specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device node whose resources are goint to be released.
05771 
05772 Return Value:
05773 
05774     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> code that indicates whether or not <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function was successful.
05775 
05776 --*/
05777 
05778 {
05779     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> device;
05780     PLIST_ENTRY listHead, listEntry;
05781     <a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html">PPI_RESOURCE_ARBITER_ENTRY</a> arbiterEntry;
05782     <a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html">ARBITER_LIST_ENTRY</a> arbiterListEntry;
05783     INTERFACE_TYPE interfaceType;
05784     ULONG busNumber, listCount, i, j, size;
05785     PCM_RESOURCE_LIST resourceList;
05786     PCM_FULL_RESOURCE_DESCRIPTOR cmFullDesc;
05787     PCM_PARTIAL_RESOURCE_DESCRIPTOR cmPartDesc;
05788     BOOLEAN search = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
05789 <span class="preprocessor">#if DBG</span>
05790 <span class="preprocessor"></span>    <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
05791 <span class="preprocessor">#endif</span>
05792 <span class="preprocessor"></span>
05793     InitializeListHead(&amp;arbiterListEntry.<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o0">ListEntry</a>);
05794     arbiterListEntry.<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o1">AlternativeCount</a> = 0;
05795     arbiterListEntry.<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o2">Alternatives</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05796     arbiterListEntry.<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o3">PhysicalDeviceObject</a> = DeviceNode-&gt;PhysicalDeviceObject;
05797     arbiterListEntry.<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o5">Flags</a> = 0;
05798     arbiterListEntry.<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o6">WorkSpace</a> = 0;
05799     arbiterListEntry.<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o10">Assignment</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05800     arbiterListEntry.<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o4">RequestSource</a> = <a class="code" href="../../d6/d9/pnp_8h.html#a174a130">ArbiterRequestPnpEnumerated</a>;
05801 
05802     resourceList = DeviceNode-&gt;ResourceList;
05803     <span class="keywordflow">if</span> (resourceList == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05804         resourceList = DeviceNode-&gt;BootResources;
05805     }
05806     <span class="keywordflow">if</span> (resourceList &amp;&amp; resourceList-&gt;Count &gt; 0) {
05807         listCount = resourceList-&gt;Count;
05808         cmFullDesc = &amp;resourceList-&gt;List[0];
05809     } <span class="keywordflow">else</span> {
05810         listCount = 1;
05811         resourceList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05812     }
05813     <span class="keywordflow">for</span> (i = 0; i &lt; listCount; i++) {
05814 
05815         <span class="keywordflow">if</span> (resourceList) {
05816             interfaceType = cmFullDesc-&gt;InterfaceType;
05817             busNumber = cmFullDesc-&gt;BusNumber;
05818             <span class="keywordflow">if</span> (interfaceType == InterfaceTypeUndefined) {
05819                 interfaceType = <a class="code" href="../../d1/d0/pnpdata_8c.html#a23">PnpDefaultInterfaceType</a>;
05820             }
05821         } <span class="keywordflow">else</span> {
05822             interfaceType = <a class="code" href="../../d1/d0/pnpdata_8c.html#a23">PnpDefaultInterfaceType</a>;
05823             busNumber = 0;
05824         }
05825 
05826         device = DeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o2">Parent</a>;
05827         <span class="keywordflow">while</span> (device) {
05828             <span class="keywordflow">if</span> ((device == <a class="code" href="../../d1/d0/pnpdata_8c.html#a5">IopRootDeviceNode</a>) &amp;&amp; search) {
05829                 device = <a class="code" href="../../d5/d1/pnpres_8c.html#a108">IopFindBusDeviceNode</a> (
05830                                  IopRootDeviceNode,
05831                                  interfaceType,
05832                                  busNumber,
05833                                  0
05834                                  );
05835 
05836                 <span class="comment">//</span>
05837                 <span class="comment">// If we did not find a PDO, try again with InterfaceType == Isa. This allows</span>
05838                 <span class="comment">// drivers that request Internal to get resources even if there is no PDO</span>
05839                 <span class="comment">// that is Internal. (but if there is an Internal PDO, they get that one)</span>
05840                 <span class="comment">//</span>
05841 
05842                 <span class="keywordflow">if</span> ((device == <a class="code" href="../../d1/d0/pnpdata_8c.html#a5">IopRootDeviceNode</a>) &amp;&amp; (interfaceType == Internal)) {
05843                     device = <a class="code" href="../../d5/d1/pnpres_8c.html#a108">IopFindBusDeviceNode</a>(IopRootDeviceNode, Isa, 0, 0);
05844                 }
05845                 search = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05846 
05847             }
05848             listHead = &amp;device-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o24">DeviceArbiterList</a>;
05849             listEntry = listHead-&gt;Flink;
05850             <span class="keywordflow">while</span> (listEntry != listHead) {
05851                 arbiterEntry = CONTAINING_RECORD(listEntry, <a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html">PI_RESOURCE_ARBITER_ENTRY</a>, DeviceArbiterList);
05852                 <span class="keywordflow">if</span> (arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o2">ArbiterInterface</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05853                     search = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05854                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(IsListEmpty(&amp;arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o3">ResourceList</a>));
05855                     InitializeListHead(&amp;arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o3">ResourceList</a>);  <span class="comment">// Recover from assert</span>
05856                     InsertTailList(&amp;arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o3">ResourceList</a>, &amp;arbiterListEntry.<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o0">ListEntry</a>);
05857 <span class="preprocessor">    #if DBG</span>
05858 <span class="preprocessor"></span>                    status =
05859 <span class="preprocessor">    #endif</span>
05860 <span class="preprocessor"></span>                    <a class="code" href="../../d5/d1/pnpres_8c.html#a79">IopCallArbiter</a>(arbiterEntry,
05861                                    ArbiterActionTestAllocation,
05862                                    &amp;arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o3">ResourceList</a>,
05863                                    NULL,
05864                                    NULL
05865                                    );
05866 <span class="preprocessor">    #if DBG</span>
05867 <span class="preprocessor"></span>                    <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(status == STATUS_SUCCESS);
05868                     status =
05869 <span class="preprocessor">    #endif</span>
05870 <span class="preprocessor"></span>                    <a class="code" href="../../d5/d1/pnpres_8c.html#a79">IopCallArbiter</a>(arbiterEntry,
05871                                    ArbiterActionCommitAllocation,
05872                                    NULL,
05873                                    NULL,
05874                                    NULL
05875                                    );
05876 <span class="preprocessor">    #if DBG</span>
05877 <span class="preprocessor"></span>                    <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(status == STATUS_SUCCESS);
05878 <span class="preprocessor">    #endif</span>
05879 <span class="preprocessor"></span>                    RemoveEntryList(&amp;arbiterListEntry.<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o0">ListEntry</a>);
05880                     InitializeListHead(&amp;arbiterListEntry.<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o0">ListEntry</a>);
05881                 }
05882                 listEntry = listEntry-&gt;Flink;
05883             }
05884             device = device-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o2">Parent</a>;
05885         }
05886 
05887         <span class="comment">//</span>
05888         <span class="comment">// If there are more than 1 list, move to next list</span>
05889         <span class="comment">//</span>
05890 
05891         <span class="keywordflow">if</span> (listCount &gt; 1) {
05892             cmPartDesc = &amp;cmFullDesc-&gt;PartialResourceList.PartialDescriptors[0];
05893             <span class="keywordflow">for</span> (j = 0; j &lt; cmFullDesc-&gt;PartialResourceList.Count; j++) {
05894                 size = 0;
05895                 <span class="keywordflow">switch</span> (cmPartDesc-&gt;Type) {
05896                 <span class="keywordflow">case</span> CmResourceTypeDeviceSpecific:
05897                      size = cmPartDesc-&gt;u.DeviceSpecificData.DataSize;
05898                      <span class="keywordflow">break</span>;
05899                 }
05900                 cmPartDesc++;
05901                 cmPartDesc = (PCM_PARTIAL_RESOURCE_DESCRIPTOR) ((PUCHAR)cmPartDesc + size);
05902             }
05903             cmFullDesc = (PCM_FULL_RESOURCE_DESCRIPTOR)cmPartDesc;
05904         }
05905     }
05906 
05907     <a class="code" href="../../d9/d0/pnpiop_8h.html#a301">IopWriteAllocatedResourcesToRegistry</a> (DeviceNode, NULL, 0);
05908 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a53" doxytag="pnpres.c::IopRemoveLegacyDeviceNode" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopRemoveLegacyDeviceNode           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>LegacyDeviceNode</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l06083">6083</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00275">DebugMessage</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01164">DO_BUS_ENUMERATED_DEVICE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01179">_DEVICE_OBJECT::DriverObject</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00267">DUMP_ERROR</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l05951">IoDeleteDevice()</a>, <a class="el" href="../../d9/d0/pnpiop_8h.html#a284">IopDestroyDeviceNode()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00239">IopLegacyDeviceNode</a>, <a class="el" href="../../d7/d8/pnp_8h-source.html#l00037">IoPnpDriverObject</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html#o32">_DEVICE_NODE::OverUsed1</a>, and <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html#o34">_DEVICE_NODE::OverUsed2</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l06180">IopLegacyResourceAllocation()</a>.
<p>
<pre class="fragment"><div>06090                    :
06091 
06092     This routine removes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device node and device object created <span class="keywordflow">for</span> legacy resource
06093     allocation <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> DeviceObject.
06094 
06095 Parameters:
06096 
06097     DeviceObject - specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device object.
06098 
06099     LegacyDeviceNode - receives <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> legacy device node <span class="keywordflow">if</span> found.
06100 
06101 Return Value:
06102 
06103     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> code that indicates whether or not <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function was successful.
06104 
06105 --*/
06106 
06107 {
06108     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(LegacyDeviceNode);
06109 
06110 
06111     <span class="keywordflow">if</span> (!DeviceObject) {
06112 
06113         <span class="keywordflow">if</span> (LegacyDeviceNode-&gt;DuplicatePDO) {
06114 
06115             LegacyDeviceNode-&gt;DuplicatePDO = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
06116             <span class="keywordflow">if</span> (LegacyDeviceNode-&gt;PreviousDeviceNode) {
06117 
06118                 LegacyDeviceNode-&gt;PreviousDeviceNode-&gt;NextDeviceNode = LegacyDeviceNode-&gt;NextDeviceNode;
06119 
06120             }
06121 
06122             <span class="keywordflow">if</span> (LegacyDeviceNode-&gt;NextDeviceNode) {
06123 
06124                 LegacyDeviceNode-&gt;NextDeviceNode-&gt;PreviousDeviceNode = LegacyDeviceNode-&gt;PreviousDeviceNode;
06125 
06126             }
06127 
06128             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d1/pnpres_8c.html#a42">IopLegacyDeviceNode</a> == LegacyDeviceNode) {
06129 
06130                 <a class="code" href="../../d5/d1/pnpres_8c.html#a42">IopLegacyDeviceNode</a> = LegacyDeviceNode-&gt;NextDeviceNode;
06131 
06132             }
06133 
06134         } <span class="keywordflow">else</span> {
06135 
06136             <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(DUMP_ERROR, (<span class="stringliteral">"PNPRES: %ws does not have a duplicate PDO\n"</span>, LegacyDeviceNode-&gt;InstancePath.Buffer));
06137             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(LegacyDeviceNode-&gt;DuplicatePDO);
06138             <span class="keywordflow">return</span>;
06139 
06140         }
06141     }
06142 
06143     <span class="keywordflow">if</span> (!(DeviceObject &amp;&amp; (DeviceObject-&gt;Flags &amp; <a class="code" href="../../d0/d5/io_8h.html#a133">DO_BUS_ENUMERATED_DEVICE</a>))) {
06144 
06145         <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>    resourceDeviceNode;
06146         <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>  pdo;
06147 
06148         <span class="keywordflow">for</span> (   resourceDeviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)LegacyDeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o32">OverUsed1</a>.LegacyDeviceNode;
06149                 resourceDeviceNode;
06150                 resourceDeviceNode = resourceDeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o34">OverUsed2</a>.NextResourceDeviceNode) {
06151 
06152                 <span class="keywordflow">if</span> (resourceDeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o34">OverUsed2</a>.NextResourceDeviceNode == LegacyDeviceNode) {
06153 
06154                     resourceDeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o34">OverUsed2</a>.NextResourceDeviceNode = LegacyDeviceNode-&gt;OverUsed2.NextResourceDeviceNode;
06155                     <span class="keywordflow">break</span>;
06156 
06157                 }
06158         }
06159 
06160         LegacyDeviceNode-&gt;Parent = LegacyDeviceNode-&gt;Sibling =
06161             LegacyDeviceNode-&gt;Child = LegacyDeviceNode-&gt;LastChild = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
06162 
06163         <span class="comment">//</span>
06164         <span class="comment">// Delete the dummy PDO and device node.</span>
06165         <span class="comment">//</span>
06166 
06167         pdo = LegacyDeviceNode-&gt;PhysicalDeviceObject;
06168         <a class="code" href="../../d9/d0/pnpiop_8h.html#a284">IopDestroyDeviceNode</a>(LegacyDeviceNode);
06169 
06170         <span class="keywordflow">if</span> (!DeviceObject) {
06171 
06172             pdo-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o3">DriverObject</a> = <a class="code" href="../../d6/d9/pnp_8h.html#a14">IoPnpDriverObject</a>;
06173             <a class="code" href="../../d4/d6/iosubs_8c.html#a55">IoDeleteDevice</a>(pdo);
06174         }
06175     }
06176 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a70" doxytag="pnpres.c::IopRemoveReqDescsFromArbiters" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopRemoveReqDescsFromArbiters           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ReqDescCount</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d5/d1/pnpres_8c.html#a28">PREQ_DESC</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>ReqDescTable</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l02780">2780</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.
<p>
References <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00713">_PI_RESOURCE_ARBITER_ENTRY::ActiveArbiterList</a>, <a class="el" href="../../d6/d9/pnp_8h.html#a173a118">ArbiterActionRollbackAllocation</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l04339">IopCallArbiter()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00722">PI_ARBITER_HAS_SOMETHING</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00079">PREQ_DESC</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00710">_PI_RESOURCE_ARBITER_ENTRY::ResourceList</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00715">_PI_RESOURCE_ARBITER_ENTRY::ResourcesChanged</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00714">_PI_RESOURCE_ARBITER_ENTRY::State</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00103">_REQ_DESC::TranslatedReqDesc</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l03084">IopAssign()</a>.
<p>
<pre class="fragment"><div>02787                    :
02788 
02789     This routine removes a list of a req descriptors from their arbiters.
02790 
02791 Parameters:
02792 
02793     P1 -
02794 
02795 Return Value:
02796 
02797     None.
02798 
02799 --*/
02800 {
02801     <a class="code" href="../../d5/d1/pnpres_8c.html#a28">PREQ_DESC</a>                   reqDesc;
02802     <a class="code" href="../../d5/d1/pnpres_8c.html#a28">PREQ_DESC</a>                   reqDescTranslated;
02803     PLIST_ENTRY                 listHead;
02804     <a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html">PPI_RESOURCE_ARBITER_ENTRY</a>  arbiterEntry;
02805     <a class="code" href="../../d5/d1/pnpres_8c.html#a28">PREQ_DESC</a>                   *reqDescTableEnd;
02806 
02807     <span class="keywordflow">for</span> (reqDescTableEnd = ReqDescTable + ReqDescCount; ReqDescTable &lt; reqDescTableEnd; ReqDescTable++) {
02808 
02809         <span class="comment">//</span>
02810         <span class="comment">// For each req desc, find its arbiter, remove the req desc from its arbiter.</span>
02811         <span class="comment">//</span>
02812 
02813         reqDesc = *ReqDescTable;
02814         <span class="keywordflow">if</span> (reqDesc-&gt;ArbitrationRequired) {
02815 
02816             reqDescTranslated = reqDesc-&gt;<a class="code" href="../../d0/d4/struct__REQ__DESC.html#o8">TranslatedReqDesc</a>;
02817             arbiterEntry = reqDesc-&gt;u.Arbiter;
02818             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(IsListEmpty(&amp;arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o3">ResourceList</a>) == FALSE);
02819 
02820             arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o8">ResourcesChanged</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02821             <span class="keywordflow">if</span> (arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o7">State</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a58">PI_ARBITER_HAS_SOMETHING</a>) {
02822 
02823                 <a class="code" href="../../d5/d1/pnpres_8c.html#a79">IopCallArbiter</a>(arbiterEntry, ArbiterActionRollbackAllocation, NULL, NULL, NULL);
02824                 arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o7">State</a> &amp;= ~<a class="code" href="../../d9/d0/pnpiop_8h.html#a58">PI_ARBITER_HAS_SOMETHING</a>;
02825             }
02826 
02827             RemoveEntryList(&amp;reqDescTranslated-&gt;AlternativeTable.ListEntry);
02828             InitializeListHead(&amp;reqDescTranslated-&gt;AlternativeTable.ListEntry);
02829             listHead = &amp;arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o3">ResourceList</a>;
02830             <span class="keywordflow">if</span> (IsListEmpty(listHead)) {
02831 
02832                 <span class="comment">//</span>
02833                 <span class="comment">// Remove the arbiter entry from our active arbiter list if it has no resource</span>
02834                 <span class="comment">// to arbitrate.</span>
02835                 <span class="comment">//</span>
02836 
02837                 RemoveEntryList(&amp;arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o6">ActiveArbiterList</a>);
02838                 InitializeListHead(&amp;arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o6">ActiveArbiterList</a>);
02839             }
02840         }
02841     }
02842 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a93" doxytag="pnpres.c::IopReserve" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopReserve           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d5/d1/pnpres_8c.html#a30">PREQ_LIST</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>ReqList</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l03376">3376</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.
<p>
References <a class="el" href="../../d6/d0/pnpres_8c-source.html#l02716">IopAddReqDescsToArbiters()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l07662">IopCheckDataStructures()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l02649">IopPlacementForReservation()</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00056">IopRootDeviceNode</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00234">PiActiveArbiterList</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00235">PiBestArbiterList</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00273">PnpResDebugLevel</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00081">PREQ_ALTERNATIVE</a>, <a class="el" href="../../d9/d8/mips_2exdsptch_8c-source.html#l00048">RA</a>, and <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00270">STOP_ERROR</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l07198">IopReserveBootResourcesInternal()</a>.
<p>
<pre class="fragment"><div>03382                    :
03383 
03384     This routine performs <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resource allocation <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> passed in AssignTables.
03385 
03386 Parameters:
03387 
03388 
03389 Return Value:
03390 
03391     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> code that indicates whether or not <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function was successful.
03392 
03393 --*/
03394 
03395 {
03396     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
03397     <a class="code" href="../../d5/d1/pnpres_8c.html#a29">PREQ_ALTERNATIVE</a> <a class="code" href="../../d8/d9/mips_2exdsptch_8c.html#a1">RA</a>;
03398     <a class="code" href="../../d5/d1/pnpres_8c.html#a29">PREQ_ALTERNATIVE</a> *reqAlternative;
03399 
03400     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03401 
03402     <span class="comment">//</span>
03403     <span class="comment">// Initialize static variable</span>
03404     <span class="comment">//</span>
03405 
03406     InitializeListHead(&amp;PiBestArbiterList);
03407     InitializeListHead(&amp;PiActiveArbiterList);
03408 
03409     reqAlternative = ReqList-&gt;ReqAlternativeTable;
03410 
03411     <a class="code" href="../../d8/d9/mips_2exdsptch_8c.html#a1">RA</a> = *reqAlternative;
03412     ReqList-&gt;SelectedAlternative = reqAlternative;
03413     <a class="code" href="../../d5/d1/pnpres_8c.html#a69">IopAddReqDescsToArbiters</a>(<a class="code" href="../../d8/d9/mips_2exdsptch_8c.html#a1">RA</a>-&gt;ReqDescCount, <a class="code" href="../../d8/d9/mips_2exdsptch_8c.html#a1">RA</a>-&gt;ReqDescTable);
03414     status = <a class="code" href="../../d5/d1/pnpres_8c.html#a92">IopPlacementForReservation</a>();
03415 <span class="preprocessor">#if DBG_SCOPE</span>
03416 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d5/d1/pnpres_8c.html#a47">PnpResDebugLevel</a> &amp; <a class="code" href="../../d5/d1/pnpres_8c.html#a26">STOP_ERROR</a>) {
03417         <a class="code" href="../../d5/d1/pnpres_8c.html#a99">IopCheckDataStructures</a>(IopRootDeviceNode);
03418     }
03419 <span class="preprocessor">#endif</span>
03420 <span class="preprocessor"></span>    <span class="keywordflow">return</span> status;
03421 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a112" doxytag="pnpres.c::IopReserveBootResources" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopReserveBootResources           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d6/d9/pnp_8h.html#a58">ARBITER_REQUEST_SOURCE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ArbiterRequestSource</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PCM_RESOURCE_LIST&nbsp;</td>
          <td class="mdname" nowrap> <em>BootResources</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l07291">7291</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00296">_DEVICE_NODE::BootResources</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00370">DNF_MADEUP</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00071">ExAllocatePoolIORL</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00072">ExAllocatePoolIORRR</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00129">_DEVICE_NODE::Flags</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l07141">IopAllocateBootResources()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l03523">IopDetermineResourceListSize()</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00042">IopInitReservedResourceList</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, and <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00937">PIOP_RESERVED_RESOURCES_RECORD</a>.
<p>
Referenced by <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00093">IopInitializePlugPlayServices()</a>.
<p>
<pre class="fragment"><div>07299                    :
07300 
07301     This routine reports boot resources <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified device to
07302     arbiters.  Since <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> real resource pre-alloc routine can <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> be called after
07303     all <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> arbiters and translators are present, all <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> calls to pre-alloc resources
07304     before <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> preallocation routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> available will be routed to <span class="keyword">this</span> routine.
07305 
07306 Arguments:
07307 
07308     DeviceObject - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device object.  If present, caller wants to
07309         preallocate BOOT resources <span class="keywordflow">for</span> a device object.  If <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, caller wants to reserved
07310         resources <span class="keywordflow">for</span> some unknown devices.
07311 
07312     BootResources - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Boot resources.
07313 
07314 Return Value:
07315 
07316     None.
07317 
07318 --*/
07319 {
07320     <a class="code" href="../../d9/d0/pnpiop_8h.html#a138">PIOP_RESERVED_RESOURCES_RECORD</a>  resourceRecord;
07321     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>                    deviceNode;
07322     ULONG                           size;
07323     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>                        status;
07324 
07325     status = STATUS_SUCCESS;;
07326     size = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a21">IopDetermineResourceListSize</a>(BootResources);
07327     <span class="keywordflow">if</span> (size != 0) {
07328 
07329         deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)((DeviceObject)?  DeviceObject-&gt;DeviceObjectExtension-&gt;DeviceNode : <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
07330 
07331         <span class="comment">//</span>
07332         <span class="comment">// Pre-allocate BOOT configs right away for non-madeup devices.</span>
07333         <span class="comment">//</span>
07334 
07335         <span class="keywordflow">if</span> (DeviceObject &amp;&amp; !(deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a5">DNF_MADEUP</a>)) {
07336 
07337             <span class="keywordflow">return</span> <a class="code" href="../../d5/d1/pnpres_8c.html#a111">IopAllocateBootResources</a>(ArbiterRequestSource, DeviceObject, BootResources);
07338 
07339         }
07340 
07341 
07342         <span class="keywordflow">if</span> (DeviceObject) {
07343 
07344             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(deviceNode);
07345             deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o35">BootResources</a> = <a class="code" href="../../d5/d1/pnpres_8c.html#a12">ExAllocatePoolIORL</a>(PagedPool, size);
07346             <span class="keywordflow">if</span> (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o35">BootResources</a>) {
07347 
07348                 RtlMoveMemory(deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o35">BootResources</a>, BootResources, size);
07349 
07350             } <span class="keywordflow">else</span> {
07351 
07352                 <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
07353 
07354             }
07355         }
07356 
07357         resourceRecord = (<a class="code" href="../../d9/d0/pnpiop_8h.html#a138">PIOP_RESERVED_RESOURCES_RECORD</a>) <a class="code" href="../../d5/d1/pnpres_8c.html#a13">ExAllocatePoolIORRR</a>(  PagedPool,
07358                                                                                 <span class="keyword">sizeof</span>(IOP_RESERVED_RESOURCES_RECORD));
07359         <span class="keywordflow">if</span> (resourceRecord) {
07360 
07361             resourceRecord-&gt;ReservedResources = (DeviceObject)? deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o35">BootResources</a> : BootResources;
07362             resourceRecord-&gt;DeviceObject = DeviceObject;
07363             resourceRecord-&gt;Next = <a class="code" href="../../d1/d0/pnpdata_8c.html#a4">IopInitReservedResourceList</a>;
07364             <a class="code" href="../../d1/d0/pnpdata_8c.html#a4">IopInitReservedResourceList</a> = resourceRecord;
07365 
07366         } <span class="keywordflow">else</span> {
07367 
07368             <span class="keywordflow">if</span> (deviceNode &amp;&amp; deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o35">BootResources</a>) {
07369 
07370                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o35">BootResources</a>);
07371 
07372             }
07373 
07374             <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
07375 
07376         }
07377     }
07378 
07379     <span class="keywordflow">return</span> status;
07380 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a94" doxytag="pnpres.c::IopReserveBootResourcesInternal" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopReserveBootResourcesInternal           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d6/d9/pnp_8h.html#a58">ARBITER_REQUEST_SOURCE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ArbiterRequestSource</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PCM_RESOURCE_LIST&nbsp;</td>
          <td class="mdname" nowrap> <em>BootResources</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l07198">7198</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00296">_DEVICE_NODE::BootResources</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00421">DNF_BOOT_CONFIG_RESERVED</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00071">ExAllocatePoolIORL</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00129">_DEVICE_NODE::Flags</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00177">_DEVICE_NODE::InstancePath</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l04279">IopCmResourcesToIoResources()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l03523">IopDetermineResourceListSize()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l04480">IopDumpResourceRequirementsList()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l01948">IopFreeReqList()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l03376">IopReserve()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l01267">IopResourceRequirementsListToReqList()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, and <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00083">PREQ_LIST</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l07141">IopAllocateBootResources()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l02474">IopReleaseFilteredBootResources()</a>, and <a class="el" href="../../d6/d0/pnpres_8c-source.html#l07383">IopReleaseResources()</a>.
<p>
<pre class="fragment"><div>07206                    :
07207 
07208     This routine reports boot resources <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified device to
07209     arbiters.
07210 
07211 Arguments:
07212 
07213     DeviceObject - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device object, could be <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
07214         <span class="keywordflow">if</span> DeviceObject <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> BootResources are reserved and will not be given
07215             to a device unless there <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> no other choice. The caller must release <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
07216             <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> <span class="keywordflow">for</span> BootResources.
07217         <span class="keywordflow">if</span> DeviceObject <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> NON_NULL, BootResources are BOOT reserved (preallocated.)
07218 
07219     BootResources - Supplies a pointer to the Boot resources.
07220 
07221 Return Value:
07222 
07223     None.
07224 
07225 --*/
07226 {
07227     PIO_RESOURCE_REQUIREMENTS_LIST ioResources;
07228     PREQ_LIST reqList;
07229     NTSTATUS status = STATUS_SUCCESS;
07230     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode;
07231 
07232     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
07233 
07234     <span class="keywordflow">if</span> (DeviceObject) {
07235         deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)DeviceObject-&gt;DeviceObjectExtension-&gt;DeviceNode;
07236     }
07237     ioResources = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a28">IopCmResourcesToIoResources</a>(0, BootResources, LCPRI_BOOTCONFIG);
07238     <span class="keywordflow">if</span> (ioResources) {
07239 <span class="preprocessor">#if MYDBG</span>
07240 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (deviceNode) {
07241             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\n===================================\n"</span>);
07242             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"PreAllocate Resource List for %wZ :: \n"</span>, &amp;deviceNode-&gt;InstancePath);
07243         } <span class="keywordflow">else</span> {
07244             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"Reserve Resource List :: "</span>);
07245         }
07246         <a class="code" href="../../d5/d1/pnpres_8c.html#a97">IopDumpResourceRequirementsList</a>(ioResources);
07247         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">" ++++++++++++++++++++++++++++++\n"</span>);
07248 <span class="preprocessor">#endif</span>
07249 <span class="preprocessor"></span>
07250         status = <a class="code" href="../../d5/d1/pnpres_8c.html#a57">IopResourceRequirementsListToReqList</a>(
07251                         ArbiterRequestSource,
07252                         ioResources,
07253                         DeviceObject,
07254                         &amp;reqList);
07255 
07256         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) &amp;&amp; reqList) {
07257             <a class="code" href="../../d5/d1/pnpres_8c.html#a93">IopReserve</a>(reqList);
07258             <span class="keywordflow">if</span> (DeviceObject) {
07259                 deviceNode-&gt;Flags |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a13">DNF_BOOT_CONFIG_RESERVED</a>;
07260                 <span class="keywordflow">if</span> (deviceNode-&gt;BootResources == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
07261                     ULONG size;
07262 
07263                     <span class="comment">//</span>
07264                     <span class="comment">// If we have not remember the root enumerated device's boot resources</span>
07265                     <span class="comment">// do it now.  We always need to pre-allocate boot config for root enumerated</span>
07266                     <span class="comment">// devices when their resources are released.</span>
07267                     <span class="comment">//</span>
07268 
07269                     size = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a21">IopDetermineResourceListSize</a> (BootResources);
07270                     deviceNode-&gt;BootResources = <a class="code" href="../../d5/d1/pnpres_8c.html#a12">ExAllocatePoolIORL</a>(PagedPool, size);
07271                     <span class="keywordflow">if</span> (deviceNode-&gt;BootResources) {
07272                         RtlMoveMemory(deviceNode-&gt;BootResources, BootResources, size);
07273                     } <span class="keywordflow">else</span> {
07274                         status = STATUS_INSUFFICIENT_RESOURCES;
07275                     }
07276                 }
07277             }
07278             <a class="code" href="../../d5/d1/pnpres_8c.html#a63">IopFreeReqList</a>(reqList);
07279         } <span class="keywordflow">else</span> {
07280 <span class="preprocessor">#if MYDBG</span>
07281 <span class="preprocessor"></span>            <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(0);                         <span class="comment">// For now</span>
07282 <span class="preprocessor">#endif</span>
07283 <span class="preprocessor"></span>        }
07284         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(ioResources);
07285     }
07286 
07287     <span class="keywordflow">return</span> status;
07288 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a110" doxytag="pnpres.c::IopReserveLegacyBootResources" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopReserveLegacyBootResources           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN INTERFACE_TYPE&nbsp;</td>
          <td class="mdname" nowrap> <em>InterfaceType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>BusNumber</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l06996">6996</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.
<p>
References <a class="el" href="../../d6/d9/pnp_8h.html#a174a127">ArbiterRequestHalReported</a>, <a class="el" href="../../d6/d9/pnp_8h.html#a174a130">ArbiterRequestPnpEnumerated</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00296">_DEVICE_NODE::BootResources</a>, <a class="el" href="../../d3/d6/hal_8h-source.html#l01170">BusNumber</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00275">DebugMessage</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00415">DNF_HAS_BOOT_CONFIG</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00268">DUMP_INFO</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00129">_DEVICE_NODE::Flags</a>, <a class="el" href="../../d5/d9/cmconfig_8c-source.html#l00050">InterfaceType</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l07141">IopAllocateBootResources()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l06955">IopCombineCmResourceList()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l06801">IopCreateCmResourceList()</a>, <a class="el" href="../../d2/d7/report_8c-source.html#l00929">IopDumpCmResourceList()</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00041">IopInitHalDeviceNode</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00040">IopInitHalResources</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00042">IopInitReservedResourceList</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00151">_DEVICE_NODE::PhysicalDeviceObject</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00937">PIOP_RESERVED_RESOURCES_RECORD</a>, and <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00273">PnpResDebugLevel</a>.
<p>
Referenced by <a class="el" href="../../d7/d9/pnpenum_8c-source.html#l01163">IopEnumerateDevice()</a>, and <a class="el" href="../../d0/d5/ioinit_8c-source.html#l02327">IopInitializeBootDrivers()</a>.
<p>
<pre class="fragment"><div>07003                    :
07004 
07005     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called to reserve legacy BOOT resources <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified <a class="code" href="../../d4/d0/cmconfig_8c.html#a5">InterfaceType</a>
07006     and <a class="code" href="../../d2/d7/hal_8h.html#a75">BusNumber</a>. This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> done everytime a <span class="keyword">new</span> bus with a legacy <a class="code" href="../../d4/d0/cmconfig_8c.html#a5">InterfaceType</a> gets enumerated.
07007 
07008 Arguments:
07009 
07010     <a class="code" href="../../d4/d0/cmconfig_8c.html#a5">InterfaceType</a> - Legacy <a class="code" href="../../d4/d0/cmconfig_8c.html#a5">InterfaceType</a>.
07011 
07012     <a class="code" href="../../d2/d7/hal_8h.html#a75">BusNumber</a> - Legacy <a class="code" href="../../d2/d7/hal_8h.html#a75">BusNumber</a>
07013 
07014 Return Value:
07015 
07016     The status returned <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">final</span> completion status of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation.
07017 
07018 --*/
07019 
07020 {
07021     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    status;
07022     <a class="code" href="../../d9/d0/pnpiop_8h.html#a138">PIOP_RESERVED_RESOURCES_RECORD</a>  resourceRecord, prevRecord;
07023     PCM_RESOURCE_LIST   newList, remainingList;
07024 
07025     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/pnpdata_8c.html#a3">IopInitHalDeviceNode</a> &amp;&amp; <a class="code" href="../../d1/d0/pnpdata_8c.html#a2">IopInitHalResources</a>) {
07026 
07027         remainingList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
07028         newList = <a class="code" href="../../d5/d1/pnpres_8c.html#a51">IopCreateCmResourceList</a>(IopInitHalResources, InterfaceType, BusNumber, &amp;remainingList);
07029         <span class="keywordflow">if</span> (newList) {
07030 
07031             <span class="keywordflow">if</span> (remainingList == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
07032 
07033                 <span class="comment">//</span>
07034                 <span class="comment">// Full match. Check for error.</span>
07035                 <span class="comment">//</span>
07036 
07037                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(newList == IopInitHalResources);
07038 
07039             } <span class="keywordflow">else</span> {
07040 
07041                 <span class="comment">//</span>
07042                 <span class="comment">// Partial match. Check for error.</span>
07043                 <span class="comment">//</span>
07044 
07045                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(IopInitHalResources != newList);
07046                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(IopInitHalResources != remainingList);
07047 
07048             }
07049 
07050             <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(DUMP_INFO, (<span class="stringliteral">"IopReserveLegacyBootResources: Allocating HAL BOOT config for interface %08X and bus %08X...\n"</span>, InterfaceType, BusNumber));
07051             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d1/pnpres_8c.html#a47">PnpResDebugLevel</a> &amp; <a class="code" href="../../d5/d1/pnpres_8c.html#a24">DUMP_INFO</a>) {
07052 
07053                 <a class="code" href="../../d1/d8/report_8c.html#a17">IopDumpCmResourceList</a>(newList);
07054 
07055             }
07056             <span class="keywordflow">if</span> (remainingList) {
07057                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(IopInitHalResources);
07058             }
07059             <a class="code" href="../../d1/d0/pnpdata_8c.html#a2">IopInitHalResources</a> = remainingList;
07060             remainingList = <a class="code" href="../../d1/d0/pnpdata_8c.html#a3">IopInitHalDeviceNode</a>-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o35">BootResources</a>;
07061             <a class="code" href="../../d1/d0/pnpdata_8c.html#a3">IopInitHalDeviceNode</a>-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a12">DNF_HAS_BOOT_CONFIG</a>;
07062             status = <a class="code" href="../../d5/d1/pnpres_8c.html#a111">IopAllocateBootResources</a>(  ArbiterRequestHalReported,
07063                                                 <a class="code" href="../../d1/d0/pnpdata_8c.html#a3">IopInitHalDeviceNode</a>-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o9">PhysicalDeviceObject</a>,
07064                                                 newList);
07065             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status));
07066             <a class="code" href="../../d1/d0/pnpdata_8c.html#a3">IopInitHalDeviceNode</a>-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o35">BootResources</a> = <a class="code" href="../../d5/d1/pnpres_8c.html#a52">IopCombineCmResourceList</a>(remainingList, newList);
07067             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/pnpdata_8c.html#a3">IopInitHalDeviceNode</a>-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o35">BootResources</a>);
07068 
07069             <span class="comment">//</span>
07070             <span class="comment">// Free previous BOOT config if any.</span>
07071             <span class="comment">//</span>
07072 
07073             <span class="keywordflow">if</span> (remainingList) {
07074 
07075                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(remainingList);
07076 
07077             }
07078         } <span class="keywordflow">else</span> {
07079 
07080             <span class="comment">//</span>
07081             <span class="comment">// No match. Check that there was no error.</span>
07082             <span class="comment">//</span>
07083 
07084             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(remainingList &amp;&amp; remainingList == IopInitHalResources);
07085         }
07086     }
07087 
07088     <span class="keywordflow">for</span> (prevRecord = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, resourceRecord = <a class="code" href="../../d1/d0/pnpdata_8c.html#a4">IopInitReservedResourceList</a>; resourceRecord;) {
07089 
07090         <span class="keywordflow">if</span> (    resourceRecord-&gt;ReservedResources &amp;&amp;
07091                 resourceRecord-&gt;ReservedResources-&gt;List[0].InterfaceType == <a class="code" href="../../d4/d0/cmconfig_8c.html#a5">InterfaceType</a> &amp;&amp;
07092                 resourceRecord-&gt;ReservedResources-&gt;List[0].BusNumber == <a class="code" href="../../d2/d7/hal_8h.html#a75">BusNumber</a>) {
07093 
07094             <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(DUMP_INFO, (<span class="stringliteral">"IopReserveLegacyBootResources: Allocating BOOT config...\n"</span>));
07095             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d1/pnpres_8c.html#a47">PnpResDebugLevel</a> &amp; <a class="code" href="../../d5/d1/pnpres_8c.html#a24">DUMP_INFO</a>) {
07096 
07097                 <a class="code" href="../../d1/d8/report_8c.html#a17">IopDumpCmResourceList</a>(resourceRecord-&gt;ReservedResources);
07098 
07099             }
07100 
07101             status = <a class="code" href="../../d5/d1/pnpres_8c.html#a111">IopAllocateBootResources</a>(  ArbiterRequestPnpEnumerated,
07102                                                 resourceRecord-&gt;DeviceObject,
07103                                                 resourceRecord-&gt;ReservedResources);
07104             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
07105 
07106                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"IopReserveLegacyBootResources: IopAllocateBootResources failed with status = %08X\n"</span>, status);
07107                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status));
07108 
07109             }
07110 
07111             <span class="keywordflow">if</span> (resourceRecord-&gt;DeviceObject == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
07112 
07113                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(resourceRecord-&gt;ReservedResources);
07114 
07115             }
07116 
07117             <span class="keywordflow">if</span> (prevRecord) {
07118 
07119                 prevRecord-&gt;Next = resourceRecord-&gt;Next;
07120 
07121             } <span class="keywordflow">else</span> {
07122 
07123                 <a class="code" href="../../d1/d0/pnpdata_8c.html#a4">IopInitReservedResourceList</a> = resourceRecord-&gt;Next;
07124 
07125             }
07126             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(resourceRecord);
07127             resourceRecord = (prevRecord)? prevRecord-&gt;Next : <a class="code" href="../../d1/d0/pnpdata_8c.html#a4">IopInitReservedResourceList</a>;
07128 
07129         } <span class="keywordflow">else</span> {
07130 
07131             prevRecord = resourceRecord;
07132             resourceRecord = resourceRecord-&gt;Next;
07133 
07134         }
07135     }
07136 
07137     <span class="keywordflow">return</span> STATUS_SUCCESS;
07138 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a57" doxytag="pnpres.c::IopResourceRequirementsListToReqList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopResourceRequirementsListToReqList           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d6/d9/pnp_8h.html#a58">ARBITER_REQUEST_SOURCE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>AllocationType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PIO_RESOURCE_REQUIREMENTS_LIST&nbsp;</td>
          <td class="mdname" nowrap> <em>IoResources</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PhysicalDevice</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>ResReqList</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l01267">1267</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.
<p>
References <a class="el" href="../../d7/d8/pnp_8h-source.html#l00744">_ARBITER_LIST_ENTRY::AlternativeCount</a>, <a class="el" href="../../d7/d8/pnp_8h-source.html#l00749">_ARBITER_LIST_ENTRY::Alternatives</a>, <a class="el" href="../../d7/d8/pnp_8h-source.html#l00719">ARBITER_FLAG_BOOT_CONFIG</a>, <a class="el" href="../../d6/d9/pnp_8h.html#a175a131">ArbiterResultUndefined</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d8/pnp_8h-source.html#l00785">_ARBITER_LIST_ENTRY::Assignment</a>, <a class="el" href="../../d7/d8/pnp_8h-source.html#l00778">_ARBITER_LIST_ENTRY::BusNumber</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00803">CmResourceTypeReserved</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00275">DebugMessage</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00267">DUMP_ERROR</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00268">DUMP_INFO</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00061">ExAllocatePoolRD</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d7/d8/pnp_8h-source.html#l00764">_ARBITER_LIST_ENTRY::Flags</a>, <a class="el" href="../../d7/d8/pnp_8h-source.html#l00776">_ARBITER_LIST_ENTRY::InterfaceType</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00225">IopAllocPool</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00215">IopAllocPoolAligned</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l01922">IopFreeReqAlternative()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l01948">IopFreeReqList()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00203">IopInitPool</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l03534">IopSetupArbiterAndTranslators()</a>, <a class="el" href="../../d7/d8/pnp_8h-source.html#l00739">_ARBITER_LIST_ENTRY::ListEntry</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d7/d8/pnp_8h-source.html#l00754">_ARBITER_LIST_ENTRY::PhysicalDeviceObject</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00167">PnpDefaultInterfaceType</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00273">PnpResDebugLevel</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00081">PREQ_ALTERNATIVE</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00079">PREQ_DESC</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00083">PREQ_LIST</a>, <a class="el" href="../../d7/d8/pnp_8h-source.html#l00759">_ARBITER_LIST_ENTRY::RequestSource</a>, <a class="el" href="../../d7/d8/pnp_8h-source.html#l00797">_ARBITER_LIST_ENTRY::Result</a>, <a class="el" href="../../d7/d8/pnp_8h-source.html#l00777">_ARBITER_LIST_ENTRY::SlotNumber</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00187">STRUCTURE_ALIGNMENT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d7/d8/pnp_8h-source.html#l00770">_ARBITER_LIST_ENTRY::WorkSpace</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l01066">IopGetResourceRequirementsForAssignTable()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l08336">IopQueryConflictListInternal()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l07198">IopReserveBootResourcesInternal()</a>, and <a class="el" href="../../d6/d0/pnpres_8c-source.html#l05660">IopRestoreResourcesInternal()</a>.
<p>
<pre class="fragment"><div>01276                    :
01277 
01278     This routine processes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> input Io resource requirements list and
01279     generates an internal REQ_LIST and its related structures.
01280 
01281 Parameters:
01282 
01283     IoResources - supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Io resource requirements <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>.
01284 
01285     PhysicalDevice - supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> physical device object requesting
01286             <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resources.
01287 
01288     ReqList - supplies a pointer to a variable to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> returned REQ_LIST.
01289 
01290 Return Value:
01291 
01292     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> code that indicates whether or not <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function was successful.
01293 
01294 --*/
01295 
01296 {
01297     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
01298     PIO_RESOURCE_LIST IoResourceList = IoResources-&gt;List;
01299     PIO_RESOURCE_DESCRIPTOR IoResourceDescriptor, BaseDescriptor, firstDescriptor;
01300     PIO_RESOURCE_DESCRIPTOR IoResourceDescriptorEnd;
01301     LONG IoResourceListCount = (LONG) IoResources-&gt;AlternativeLists;
01302     PUCHAR CoreEnd = (PUCHAR) IoResources + IoResources-&gt;ListSize;
01303     ULONG ReqAlternativeCount = IoResourceListCount;
01304     ULONG ReqDescAlternativeCount = 0;
01305     ULONG AlternativeDescriptorCount = 0;  <span class="comment">// count of descriptors with IO_RESOURCE_ALTERNATIVE flag set</span>
01306     <a class="code" href="../../d5/d1/pnpres_8c.html#a30">PREQ_LIST</a> ReqList;
01307     BOOLEAN NoAlternativeDescriptor;
01308     INTERFACE_TYPE interfaceType;
01309     ULONG busNumber;
01310     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    failureStatus = STATUS_UNSUCCESSFUL;
01311     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    finalStatus = STATUS_SUCCESS;
01312 
01313     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01314 
01315     *ResReqList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01316 
01317     <span class="comment">//</span>
01318     <span class="comment">// Make sure there is some resource requirements to be fulfilled.</span>
01319     <span class="comment">//</span>
01320 
01321     <span class="keywordflow">if</span> (IoResourceListCount == 0) {
01322         <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(DUMP_INFO, (<span class="stringliteral">"PnpRes: No ResReqList to convert to ReqList\n"</span>));
01323         <span class="keywordflow">return</span> STATUS_SUCCESS;
01324     }
01325 
01326     <span class="comment">//</span>
01327     <span class="comment">// ***** Phase 1 *****</span>
01328     <span class="comment">//</span>
01329     <span class="comment">// Parse the IO ResReq list to make sure it is valid and to determine the sizes of</span>
01330     <span class="comment">// internal structures.</span>
01331     <span class="comment">//</span>
01332 
01333     <span class="keywordflow">while</span> (--IoResourceListCount &gt;= 0) {
01334 
01335         IoResourceDescriptor = firstDescriptor = IoResourceList-&gt;Descriptors;
01336         IoResourceDescriptorEnd = IoResourceDescriptor + IoResourceList-&gt;Count;
01337 
01338         <span class="keywordflow">if</span> (IoResourceDescriptor == IoResourceDescriptorEnd) {
01339 
01340             <span class="comment">//</span>
01341             <span class="comment">// An alternative list with zero descriptor count</span>
01342             <span class="comment">//</span>
01343 
01344             <span class="keywordflow">return</span> STATUS_SUCCESS;
01345         }
01346         <span class="comment">//</span>
01347         <span class="comment">// Perform sanity check.  We have not allocated any pool space.</span>
01348         <span class="comment">// If failed, simply return failure status.</span>
01349         <span class="comment">//</span>
01350 
01351         <span class="keywordflow">if</span> ((PUCHAR) IoResourceDescriptor &gt; CoreEnd) {
01352 
01353             <span class="comment">//</span>
01354             <span class="comment">// The structure header (excluding the variable length Descriptors array) is</span>
01355             <span class="comment">// invalid.</span>
01356             <span class="comment">//</span>
01357 
01358             <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(DUMP_ERROR, (<span class="stringliteral">"PnpRes: Invalid ResReqList\n"</span>));
01359             <span class="keywordflow">goto</span> InvalidParameter;
01360         }
01361 
01362         <span class="keywordflow">if</span> (IoResourceDescriptor &gt; IoResourceDescriptorEnd ||
01363             (PUCHAR) IoResourceDescriptorEnd &gt; CoreEnd) {
01364 
01365             <span class="comment">//</span>
01366             <span class="comment">// IoResourceDescriptorEnd is the result of arithmetic overflow;</span>
01367             <span class="comment">// or, the descriptor array is outside of the valid memory.</span>
01368             <span class="comment">//</span>
01369 
01370             <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(DUMP_ERROR, (<span class="stringliteral">"PnpRes: Invalid ResReqList\n"</span>));
01371             <span class="keywordflow">goto</span> InvalidParameter;
01372         }
01373 
01374         <span class="keywordflow">if</span> (IoResourceDescriptor-&gt;Type == CmResourceTypeConfigData) {
01375             IoResourceDescriptor++;
01376             firstDescriptor++;
01377         }
01378         NoAlternativeDescriptor = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01379         <span class="keywordflow">while</span> (IoResourceDescriptor &lt; IoResourceDescriptorEnd) {
01380             <span class="keywordflow">switch</span> (IoResourceDescriptor-&gt;Type) {
01381             <span class="keywordflow">case</span> CmResourceTypeConfigData:
01382 <span class="preprocessor">#if DBG_SCOPE</span>
01383 <span class="preprocessor"></span>                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d1/pnpres_8c.html#a47">PnpResDebugLevel</a> &amp; <a class="code" href="../../d5/d1/pnpres_8c.html#a23">DUMP_ERROR</a>) {
01384                      <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"PnPRes: Invalid ResReq list !!!\n"</span>);
01385                      <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"        ConfigData descriptors are per-LogConf and\n"</span>);
01386                      <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"        should be at the beginning of an AlternativeList\n"</span>);
01387                      <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(0);
01388                  }
01389 <span class="preprocessor">#endif</span>
01390 <span class="preprocessor"></span>                 <span class="keywordflow">goto</span> InvalidParameter;
01391 
01392             <span class="keywordflow">case</span> CmResourceTypeDevicePrivate:
01393                  <span class="keywordflow">while</span> (IoResourceDescriptor &lt; IoResourceDescriptorEnd &amp;&amp;
01394                         IoResourceDescriptor-&gt;Type == CmResourceTypeDevicePrivate) {
01395                      <span class="keywordflow">if</span> (IoResourceDescriptor == firstDescriptor) {
01396 <span class="preprocessor">#if DBG_SCOPE</span>
01397 <span class="preprocessor"></span>                        <span class="keywordflow">if</span> (<a class="code" href="../../d5/d1/pnpres_8c.html#a47">PnpResDebugLevel</a> &amp; <a class="code" href="../../d5/d1/pnpres_8c.html#a23">DUMP_ERROR</a>) {
01398                             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"PnPRes: Invalid ResReq list !!!\n"</span>);
01399                             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"        The first descriptor of a LogConf can not be\n"</span>);
01400                             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"        a DevicePrivate descriptor.\n"</span>);
01401                             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(0);
01402                         }
01403 <span class="preprocessor">#endif</span>
01404 <span class="preprocessor"></span>                        <span class="keywordflow">goto</span> InvalidParameter;
01405                      }
01406                      ReqDescAlternativeCount++;   <span class="comment">// Count number of descriptors</span>
01407                      IoResourceDescriptor++;
01408                  }
01409                  NoAlternativeDescriptor = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01410                  <span class="keywordflow">break</span>;
01411 
01412             <span class="keywordflow">default</span>:
01413 
01414                 ++ReqDescAlternativeCount;        <span class="comment">// Count number of descriptors</span>
01415 
01416                 <span class="comment">//</span>
01417                 <span class="comment">// For non-arbitrated resource type, set its Option to preferred such</span>
01418                 <span class="comment">// that we won't get confused.</span>
01419                 <span class="comment">//</span>
01420 
01421                 <span class="keywordflow">if</span> ((IoResourceDescriptor-&gt;Type &amp; CmResourceTypeNonArbitrated) ||
01422                     (IoResourceDescriptor-&gt;Type == CmResourceTypeNull)) {
01423 
01424                     <span class="keywordflow">if</span> (IoResourceDescriptor-&gt;Type == <a class="code" href="../../d9/d0/pnpiop_8h.html#a74">CmResourceTypeReserved</a>) {
01425                         --ReqDescAlternativeCount;
01426                     }
01427                     IoResourceDescriptor-&gt;Option = IO_RESOURCE_PREFERRED;
01428                     IoResourceDescriptor++;
01429                     NoAlternativeDescriptor = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01430                     <span class="keywordflow">break</span>;
01431                 }
01432                 <span class="keywordflow">if</span> (IoResourceDescriptor-&gt;Option &amp; IO_RESOURCE_ALTERNATIVE) {
01433                     <span class="keywordflow">if</span> (NoAlternativeDescriptor) {
01434 <span class="preprocessor">#if DBG_SCOPE</span>
01435 <span class="preprocessor"></span>                        <span class="keywordflow">if</span> (<a class="code" href="../../d5/d1/pnpres_8c.html#a47">PnpResDebugLevel</a> &amp; <a class="code" href="../../d5/d1/pnpres_8c.html#a23">DUMP_ERROR</a>) {
01436                             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"PnPRes: Invalid ResReq list !!!\n"</span>);
01437                             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"        Alternative descriptor without Default or Preferred descriptor.\n"</span>);
01438                             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(0);
01439                         }
01440 <span class="preprocessor">#endif</span>
01441 <span class="preprocessor"></span>                       <span class="keywordflow">goto</span> InvalidParameter;
01442                     }
01443                     ++AlternativeDescriptorCount; <span class="comment">// Count number of Alternative descriptors</span>
01444                 } <span class="keywordflow">else</span> {
01445                     NoAlternativeDescriptor = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01446                 }
01447                 IoResourceDescriptor++;
01448                 <span class="keywordflow">break</span>;
01449             }
01450         }
01451         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(IoResourceDescriptor == IoResourceDescriptorEnd);
01452         IoResourceList = (PIO_RESOURCE_LIST) IoResourceDescriptorEnd;
01453     }
01454 
01455     <span class="comment">//</span>
01456     <span class="comment">// ***** Phase 2 *****</span>
01457     <span class="comment">//</span>
01458     <span class="comment">// Allocate structures and initialize them according to caller's Io ResReq list.</span>
01459     <span class="comment">//</span>
01460 
01461     {
01462         ULONG ReqDescCount = ReqDescAlternativeCount - AlternativeDescriptorCount;
01463         PUCHAR PoolStart;
01464         ULONG PoolSize;
01465         <a class="code" href="../../d2/d1/struct__IOP__POOL.html">IOP_POOL</a> OuterPool;
01466         <a class="code" href="../../d2/d1/struct__IOP__POOL.html">IOP_POOL</a> ReqAlternativePool;
01467         <a class="code" href="../../d2/d1/struct__IOP__POOL.html">IOP_POOL</a> ReqDescPool;
01468 
01469         <a class="code" href="../../d5/d1/pnpres_8c.html#a29">PREQ_ALTERNATIVE</a> ReqAlternative;
01470         <a class="code" href="../../d5/d1/pnpres_8c.html#a29">PREQ_ALTERNATIVE</a> *ReqAlternativePP;
01471 <span class="preprocessor">#if DBG</span>
01472 <span class="preprocessor"></span>        <a class="code" href="../../d5/d1/pnpres_8c.html#a29">PREQ_ALTERNATIVE</a> *ReqAlternativeEndPP;
01473 <span class="preprocessor">#endif</span>
01474 <span class="preprocessor"></span>        <a class="code" href="../../d5/d1/pnpres_8c.html#a28">PREQ_DESC</a> ReqDesc;
01475         <a class="code" href="../../d5/d1/pnpres_8c.html#a28">PREQ_DESC</a> *ReqDescPP;
01476         ULONG ReqAlternativeIndex;
01477         ULONG ReqDescIndex;
01478 
01479         <span class="comment">//</span>
01480         <span class="comment">// Each structure in the list has a variable length array.</span>
01481         <span class="comment">// Those arrays are declared in their typedefs as arrays with one element,</span>
01482         <span class="comment">// that extra element is not being substracted because it provides an</span>
01483         <span class="comment">// extra 4 bytes of memory that is 50% (statistically) wasted and 50%</span>
01484         <span class="comment">// (statistically) used to allow for 8 byte alignment of all the structures.</span>
01485         <span class="comment">//</span>
01486         <span class="comment">// Allocate the pool and fail if the allocation failed.</span>
01487         <span class="comment">//</span>
01488 
01489         {
01490             ULONG ReqListPoolSize =
01491                 (FIELD_OFFSET(REQ_LIST, ReqAlternativeTable) +
01492                 <span class="keyword">sizeof</span>(PVOID) * ReqAlternativeCount + <a class="code" href="../../d5/d1/pnpres_8c.html#a18">STRUCTURE_ALIGNMENT</a> - 1) &amp;
01493                 ~(<a class="code" href="../../d5/d1/pnpres_8c.html#a18">STRUCTURE_ALIGNMENT</a> - 1);
01494 
01495             ULONG ReqAlternativePoolSize = (ReqAlternativeCount *
01496                 (FIELD_OFFSET(REQ_ALTERNATIVE, ReqDescTable) +
01497                 + <span class="keyword">sizeof</span>(PVOID) * ReqDescCount + <a class="code" href="../../d5/d1/pnpres_8c.html#a18">STRUCTURE_ALIGNMENT</a> - 1))
01498                 &amp; ~(<a class="code" href="../../d5/d1/pnpres_8c.html#a18">STRUCTURE_ALIGNMENT</a> - 1);
01499 
01500             ULONG ReqDescPoolSize = (ReqDescCount * (<span class="keyword">sizeof</span>(REQ_DESC) + <a class="code" href="../../d5/d1/pnpres_8c.html#a18">STRUCTURE_ALIGNMENT</a> - 1))
01501                 &amp; ~(<a class="code" href="../../d5/d1/pnpres_8c.html#a18">STRUCTURE_ALIGNMENT</a> - 1);
01502 
01503             PoolSize = ReqListPoolSize + ReqAlternativePoolSize + ReqDescPoolSize;
01504 
01505             PoolStart = <a class="code" href="../../d5/d1/pnpres_8c.html#a2">ExAllocatePoolRD</a>(PagedPool, PoolSize);
01506             <span class="keywordflow">if</span> (!PoolStart) {
01507                 <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
01508             }
01509             <a class="code" href="../../d5/d1/pnpres_8c.html#a19">IopInitPool</a>(&amp;OuterPool, PoolStart, PoolSize);
01510 
01511             <span class="comment">//</span>
01512             <span class="comment">// Partition the OuterPool into inner pools.</span>
01513             <span class="comment">//</span>
01514 
01515             <a class="code" href="../../d5/d1/pnpres_8c.html#a20">IopAllocPoolAligned</a>(&amp;ReqList, &amp;OuterPool, ReqListPoolSize);
01516 
01517             <a class="code" href="../../d5/d1/pnpres_8c.html#a20">IopAllocPoolAligned</a>(&amp;PoolStart, &amp;OuterPool, ReqAlternativePoolSize);
01518             <a class="code" href="../../d5/d1/pnpres_8c.html#a19">IopInitPool</a>(&amp;ReqAlternativePool, PoolStart, ReqAlternativePoolSize);
01519 
01520             <a class="code" href="../../d5/d1/pnpres_8c.html#a20">IopAllocPoolAligned</a>(&amp;PoolStart, &amp;OuterPool, ReqDescPoolSize);
01521             <a class="code" href="../../d5/d1/pnpres_8c.html#a19">IopInitPool</a>(&amp;ReqDescPool, PoolStart, ReqDescPoolSize);
01522         }
01523 
01524         <span class="comment">//</span>
01525         <span class="comment">// Convert the IO_RESOURCE_REQUIREMENTS_LIST into the REQ_LIST.</span>
01526         <span class="comment">//</span>
01527 
01528         ReqAlternativePP = ReqList-&gt;ReqAlternativeTable;
01529         RtlZeroMemory(ReqAlternativePP, ReqAlternativeCount * <span class="keyword">sizeof</span>(PREQ_ALTERNATIVE));
01530 <span class="preprocessor">#if DBG</span>
01531 <span class="preprocessor"></span>        ReqAlternativeEndPP = ReqAlternativePP + ReqAlternativeCount;
01532 <span class="preprocessor">#endif</span>
01533 <span class="preprocessor"></span>        ReqList-&gt;ReqAlternativeCount = ReqAlternativeCount;
01534         ReqList-&gt;PhysicalDevice = PhysicalDevice;
01535         ReqList-&gt;InterfaceType = IoResources-&gt;InterfaceType;
01536         <span class="keywordflow">if</span> (ReqList-&gt;InterfaceType == InterfaceTypeUndefined) {
01537             ReqList-&gt;InterfaceType = <a class="code" href="../../d1/d0/pnpdata_8c.html#a23">PnpDefaultInterfaceType</a>;
01538         }
01539 
01540         ReqList-&gt;BusNumber = IoResources-&gt;BusNumber;
01541         ReqList-&gt;SelectedAlternative = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01542         ReqAlternativeIndex = 0;
01543 
01544         interfaceType = IoResources-&gt;InterfaceType;
01545         <span class="keywordflow">if</span> (interfaceType == InterfaceTypeUndefined) {
01546             interfaceType = <a class="code" href="../../d1/d0/pnpdata_8c.html#a23">PnpDefaultInterfaceType</a>;
01547         }
01548         busNumber = IoResources-&gt;BusNumber;
01549         IoResourceList = IoResources-&gt;List;
01550         IoResourceListCount = IoResources-&gt;AlternativeLists;
01551 
01552         <span class="keywordflow">while</span> (--IoResourceListCount &gt;= 0) {
01553             ULONG arbiterFlag;
01554 
01555             IoResourceDescriptor = IoResourceList-&gt;Descriptors;
01556             IoResourceDescriptorEnd = IoResourceDescriptor + IoResourceList-&gt;Count;
01557 
01558             <span class="comment">//</span>
01559             <span class="comment">// For each Io alternate list, we create a REQ_ALTERNATE table</span>
01560             <span class="comment">//</span>
01561 
01562             <a class="code" href="../../d5/d1/pnpres_8c.html#a20">IopAllocPoolAligned</a>(&amp;ReqAlternative, &amp;ReqAlternativePool, FIELD_OFFSET(REQ_ALTERNATIVE, ReqDescTable));
01563             ReqAlternative-&gt;ReqList = ReqList;
01564             ReqAlternative-&gt;ReqAlternativeIndex = ReqAlternativeIndex++;
01565             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ReqAlternativePP &lt; ReqAlternativeEndPP);
01566             *ReqAlternativePP++ = ReqAlternative;
01567             ReqAlternative-&gt;ReqDescCount = 0;
01568             ReqAlternative-&gt;ReqDescTableEnd = ReqAlternative-&gt;ReqDescTable;
01569 
01570             <span class="comment">//</span>
01571             <span class="comment">// If the first descriptor of the alternative is a CmResourceTypeConfigData</span>
01572             <span class="comment">// it contains priority information.</span>
01573             <span class="comment">//</span>
01574 
01575             <span class="keywordflow">if</span> (IoResourceDescriptor-&gt;Type == CmResourceTypeConfigData) {
01576                 ReqAlternative-&gt;Priority = IoResourceDescriptor-&gt;u.ConfigData.Priority;
01577                 IoResourceDescriptor++;
01578             } <span class="keywordflow">else</span> {
01579                 ReqAlternative-&gt;Priority = LCPRI_NORMAL;
01580             }
01581 
01582             <span class="keywordflow">if</span> (ReqAlternative-&gt;Priority == LCPRI_BOOTCONFIG) {
01583                 arbiterFlag = <a class="code" href="../../d6/d9/pnp_8h.html#a8">ARBITER_FLAG_BOOT_CONFIG</a>;
01584             } <span class="keywordflow">else</span> {
01585                 arbiterFlag = 0;
01586             }
01587 
01588             ReqDescPP = ReqAlternative-&gt;ReqDescTable;
01589             ReqDescIndex = 0;
01590 
01591             <span class="keywordflow">while</span> (IoResourceDescriptor &lt; IoResourceDescriptorEnd) {
01592 
01593                 <a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html">PARBITER_LIST_ENTRY</a> ArbiterListEntry;
01594 
01595                 <span class="keywordflow">if</span> (IoResourceDescriptor-&gt;Type == <a class="code" href="../../d9/d0/pnpiop_8h.html#a74">CmResourceTypeReserved</a>) {
01596                     interfaceType = IoResourceDescriptor-&gt;u.DevicePrivate.Data[0];
01597                     <span class="keywordflow">if</span> (interfaceType == InterfaceTypeUndefined) {
01598                         interfaceType = <a class="code" href="../../d1/d0/pnpdata_8c.html#a23">PnpDefaultInterfaceType</a>;
01599                     }
01600                     busNumber = IoResourceDescriptor-&gt;u.DevicePrivate.Data[1];
01601                     IoResourceDescriptor++;
01602                 } <span class="keywordflow">else</span> {
01603                     <a class="code" href="../../d5/d1/pnpres_8c.html#a20">IopAllocPoolAligned</a>(&amp;ReqDesc, &amp;ReqDescPool, <span class="keyword">sizeof</span>(REQ_DESC));
01604                     ReqDesc-&gt;ArbitrationRequired =
01605                         (IoResourceDescriptor-&gt;Type &amp; CmResourceTypeNonArbitrated ||
01606                          IoResourceDescriptor-&gt;Type == CmResourceTypeNull) ? <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> : <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01607                     ReqDesc-&gt;ReqAlternative = ReqAlternative;
01608                     ReqDesc-&gt;ReqDescIndex = ReqDescIndex++;
01609                     ReqDesc-&gt;DevicePrivateCount = 0;
01610                     ReqDesc-&gt;DevicePrivate = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01611                     ReqDesc-&gt;InterfaceType = interfaceType;
01612                     ReqDesc-&gt;BusNumber = busNumber;
01613 
01614                     <a class="code" href="../../d5/d1/pnpres_8c.html#a21">IopAllocPool</a>(&amp;PoolStart, &amp;ReqAlternativePool, <span class="keyword">sizeof</span>(PVOID));
01615 
01616                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PoolStart == (PUCHAR) ReqDescPP);
01617 
01618                     *ReqDescPP++ = ReqDesc;
01619                     ++ReqAlternative-&gt;ReqDescCount;
01620                     ++ReqAlternative-&gt;ReqDescTableEnd;
01621 
01622                     ReqDesc-&gt;TranslatedReqDesc = ReqDesc;  <span class="comment">// TranslatedReqDesc points to itself.</span>
01623 
01624                     ArbiterListEntry = &amp;ReqDesc-&gt;AlternativeTable;
01625                     InitializeListHead(&amp;ArbiterListEntry-&gt;<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o0">ListEntry</a>);
01626                     ArbiterListEntry-&gt;<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o1">AlternativeCount</a> = 0;
01627                     ArbiterListEntry-&gt;<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o2">Alternatives</a> = IoResourceDescriptor;
01628                     ArbiterListEntry-&gt;<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o3">PhysicalDeviceObject</a> = PhysicalDevice;
01629                     ArbiterListEntry-&gt;<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o4">RequestSource</a> = AllocationType;
01630                     ArbiterListEntry-&gt;<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o5">Flags</a> = arbiterFlag;
01631                     ArbiterListEntry-&gt;<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o6">WorkSpace</a> = 0;
01632                     ArbiterListEntry-&gt;<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o7">InterfaceType</a> = interfaceType;
01633                     ArbiterListEntry-&gt;<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o8">SlotNumber</a> = IoResources-&gt;SlotNumber;
01634                     ArbiterListEntry-&gt;<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o9">BusNumber</a> = IoResources-&gt;BusNumber;
01635                     ArbiterListEntry-&gt;<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o10">Assignment</a> = &amp;ReqDesc-&gt;Allocation;
01636                     ArbiterListEntry-&gt;<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o12">Result</a> = <a class="code" href="../../d6/d9/pnp_8h.html#a175a131">ArbiterResultUndefined</a>;
01637 
01638                     <span class="keywordflow">if</span> (ReqDesc-&gt;ArbitrationRequired) {
01639 
01640                         <span class="comment">//</span>
01641                         <span class="comment">// The BestAlternativeTable and BestAllocation are not initialized.</span>
01642                         <span class="comment">// They will be initialized when needed.</span>
01643 
01644                         <span class="comment">//</span>
01645                         <span class="comment">// Initialize the Cm partial resource descriptor to NOT_ALLOCATED.</span>
01646                         <span class="comment">//</span>
01647 
01648                         ReqDesc-&gt;Allocation.Type = CmResourceTypeMaximum;
01649 
01650                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((IoResourceDescriptor-&gt;Option &amp; IO_RESOURCE_ALTERNATIVE) == 0);
01651 
01652                         ArbiterListEntry-&gt;<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o1">AlternativeCount</a>++;
01653                         IoResourceDescriptor++;
01654                         <span class="keywordflow">while</span> (IoResourceDescriptor &lt; IoResourceDescriptorEnd) {
01655                             <span class="keywordflow">if</span> (IoResourceDescriptor-&gt;Type == CmResourceTypeDevicePrivate) {
01656                                 ReqDesc-&gt;DevicePrivate = IoResourceDescriptor;
01657                                 <span class="keywordflow">while</span> (IoResourceDescriptor &lt; IoResourceDescriptorEnd &amp;&amp;
01658                                        IoResourceDescriptor-&gt;Type == CmResourceTypeDevicePrivate) {
01659                                     ReqDesc-&gt;DevicePrivateCount++;
01660                                     ++IoResourceDescriptor;
01661                                 }
01662                                 <span class="keywordflow">break</span>;
01663                             }
01664                             <span class="keywordflow">if</span> (IoResourceDescriptor-&gt;Option &amp; IO_RESOURCE_ALTERNATIVE) {
01665                                 ArbiterListEntry-&gt;<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o1">AlternativeCount</a>++;
01666                                 IoResourceDescriptor++;
01667                             } <span class="keywordflow">else</span> {
01668                                 <span class="keywordflow">break</span>;
01669                             }
01670                         }
01671 
01672                         <span class="comment">//</span>
01673                         <span class="comment">// Next query Arbiter and Translator interfaces for the resource desc.</span>
01674                         <span class="comment">//</span>
01675 
01676                         status = <a class="code" href="../../d5/d1/pnpres_8c.html#a75">IopSetupArbiterAndTranslators</a>(ReqDesc);
01677                         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01678                             <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(DUMP_ERROR, (<span class="stringliteral">"PnpRes: Unable to setup Arbiter and Translators\n"</span>));
01679                             ReqAlternativeIndex--;
01680                             ReqAlternativePP--;
01681                             ReqList-&gt;ReqAlternativeCount--;
01682                             <a class="code" href="../../d5/d1/pnpres_8c.html#a62">IopFreeReqAlternative</a>(ReqAlternative);
01683                             failureStatus = status;
01684                             <span class="keywordflow">break</span>;
01685                         }
01686                     } <span class="keywordflow">else</span> {
01687                         ReqDesc-&gt;Allocation.Type = IoResourceDescriptor-&gt;Type;
01688                         ReqDesc-&gt;Allocation.ShareDisposition = IoResourceDescriptor-&gt;ShareDisposition;
01689                         ReqDesc-&gt;Allocation.Flags = IoResourceDescriptor-&gt;Flags;
01690                         ReqDesc-&gt;Allocation.u.DevicePrivate.Data[0] =
01691                             IoResourceDescriptor-&gt;u.DevicePrivate.Data[0];
01692                         ReqDesc-&gt;Allocation.u.DevicePrivate.Data[1] =
01693                             IoResourceDescriptor-&gt;u.DevicePrivate.Data[1];
01694                         ReqDesc-&gt;Allocation.u.DevicePrivate.Data[2] =
01695                             IoResourceDescriptor-&gt;u.DevicePrivate.Data[2];
01696 
01697                         IoResourceDescriptor++;
01698                     }
01699                 }
01700 
01701                 <span class="keywordflow">if</span> (IoResourceDescriptor &gt;= IoResourceDescriptorEnd) <span class="keywordflow">break</span>;
01702             }
01703             IoResourceList = (PIO_RESOURCE_LIST) IoResourceDescriptorEnd;
01704         }
01705         <span class="keywordflow">if</span> (ReqAlternativeIndex == 0) {
01706             finalStatus = failureStatus;
01707             <a class="code" href="../../d5/d1/pnpres_8c.html#a63">IopFreeReqList</a>(ReqList);
01708         }
01709     }
01710 
01711     <span class="keywordflow">if</span> (finalStatus == STATUS_SUCCESS) {
01712         *ResReqList = ReqList;
01713     }
01714 
01715     <span class="keywordflow">return</span> finalStatus;
01716 
01717 InvalidParameter:
01718     <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
01719 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a73" doxytag="pnpres.c::IopRestoreBestConfiguration" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopRestoreBestConfiguration           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>VOID</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l02997">2997</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.
<p>
References <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00713">_PI_RESOURCE_ARBITER_ENTRY::ActiveArbiterList</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00712">_PI_RESOURCE_ARBITER_ENTRY::BestConfig</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00711">_PI_RESOURCE_ARBITER_ENTRY::BestResourceList</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00766">_IOP_RESOURCE_REQUEST::Flags</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00755">IOP_ASSIGN_EXCLUDE</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00234">PiActiveArbiterList</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00237">PiAssignTable</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00238">PiAssignTableCount</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00235">PiBestArbiterList</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00241">PiNoRetest</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00081">PREQ_ALTERNATIVE</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00079">PREQ_DESC</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00083">PREQ_LIST</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00770">_IOP_RESOURCE_REQUEST::ReqList</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00710">_PI_RESOURCE_ARBITER_ENTRY::ResourceList</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00715">_PI_RESOURCE_ARBITER_ENTRY::ResourcesChanged</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l03292">IopAssignInner()</a>.
<p>
<pre class="fragment"><div>03003                    :
03004 
03005     This routine restores <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> arbiters info and all <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resources requirements
03006     info to prepare arbiter restest.
03007 
03008 Parameters:
03009 
03010     None.
03011 
03012 Return Value:
03013 
03014     None.
03015 
03016 --*/
03017 
03018 {
03019     <a class="code" href="../../d5/d1/pnpres_8c.html#a29">PREQ_ALTERNATIVE</a> reqAlternative;
03020     <a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a> assignEntry;
03021     <a class="code" href="../../d5/d1/pnpres_8c.html#a28">PREQ_DESC</a> reqDesc, *reqDescpp;
03022     <a class="code" href="../../d5/d1/pnpres_8c.html#a30">PREQ_LIST</a> reqList;
03023     PLIST_ENTRY listEntry;
03024     <a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html">PPI_RESOURCE_ARBITER_ENTRY</a> arbiterEntry;
03025     ULONG i;
03026 
03027     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d1/pnpres_8c.html#a43">PiNoRetest</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
03028 
03029         <span class="comment">//</span>
03030         <span class="comment">// Go thru all the assign tables to save the current configuration.</span>
03031         <span class="comment">//</span>
03032 
03033         <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d5/d1/pnpres_8c.html#a41">PiAssignTableCount</a>; i++) {
03034             assignEntry = <a class="code" href="../../d5/d1/pnpres_8c.html#a40">PiAssignTable</a> + i;
03035 
03036             <span class="keywordflow">if</span> (!(assignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o1">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a68">IOP_ASSIGN_EXCLUDE</a>)) {
03037                 reqList = assignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o5">ReqList</a>;
03038 
03039                 <span class="comment">//</span>
03040                 <span class="comment">// Set the BestAlternative as the current selection.</span>
03041                 <span class="comment">//</span>
03042 
03043                 reqAlternative = *reqList-&gt;ReqBestAlternative;
03044                 reqList-&gt;SelectedAlternative = reqList-&gt;ReqBestAlternative;
03045 
03046                 <span class="comment">//</span>
03047                 <span class="comment">// For each REQ_DESC in the best alternative list, restore its arbiter list entry</span>
03048                 <span class="comment">// and its assignments from saved area.</span>
03049                 <span class="comment">//</span>
03050 
03051                 <span class="keywordflow">for</span> (reqDescpp = reqAlternative-&gt;ReqDescTable;
03052                      reqDescpp &lt; reqAlternative-&gt;ReqDescTableEnd;
03053                      reqDescpp++) {
03054 
03055                      <span class="keywordflow">if</span> ((*reqDescpp)-&gt;ArbitrationRequired) {
03056                          reqDesc = (*reqDescpp)-&gt;TranslatedReqDesc;
03057                          reqDesc-&gt;AlternativeTable = reqDesc-&gt;BestAlternativeTable;
03058                          reqDesc-&gt;Allocation = reqDesc-&gt;BestAllocation;
03059                      }
03060                 }
03061             }
03062         }
03063         <a class="code" href="../../d5/d1/pnpres_8c.html#a37">PiActiveArbiterList</a> = <a class="code" href="../../d5/d1/pnpres_8c.html#a38">PiBestArbiterList</a>;
03064     }
03065 
03066     <span class="comment">//</span>
03067     <span class="comment">// Go throught the active arbiter list to restore the current configuration</span>
03068     <span class="comment">// for retest.</span>
03069     <span class="comment">//</span>
03070 
03071     listEntry = <a class="code" href="../../d5/d1/pnpres_8c.html#a37">PiActiveArbiterList</a>.Flink;
03072     <span class="keywordflow">while</span> (listEntry != &amp;<a class="code" href="../../d5/d1/pnpres_8c.html#a37">PiActiveArbiterList</a>) {
03073         arbiterEntry = CONTAINING_RECORD(listEntry, <a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html">PI_RESOURCE_ARBITER_ENTRY</a>, ActiveArbiterList);
03074         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d1/pnpres_8c.html#a43">PiNoRetest</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
03075             arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o3">ResourceList</a> = arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o4">BestResourceList</a>;
03076             arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o6">ActiveArbiterList</a> = arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o5">BestConfig</a>;
03077         }
03078         arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o8">ResourcesChanged</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03079         listEntry = listEntry-&gt;Flink;
03080     }
03081 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a89" doxytag="pnpres.c::IopRestoreResourcesInternal" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopRestoreResourcesInternal           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>DeviceNode</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l05660">5660</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.
<p>
References <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00767">_IOP_RESOURCE_REQUEST::AllocationType</a>, <a class="el" href="../../d6/d9/pnp_8h.html#a174a130">ArbiterRequestPnpEnumerated</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00275">DebugMessage</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00267">DUMP_ERROR</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00766">_IOP_RESOURCE_REQUEST::Flags</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l03292">IopAssignInner()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l04279">IopCmResourcesToIoResources()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l03631">IopDetermineResourceListSize()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l01988">IopFreeResourceRequirementsForAssignTable()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l01811">IopRearrangeReqList()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l01267">IopResourceRequirementsListToReqList()</a>, <a class="el" href="../../d9/d0/pnpiop_8h.html#a301">IopWriteAllocatedResourcesToRegistry()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00765">_IOP_RESOURCE_REQUEST::PhysicalDevice</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00083">PREQ_LIST</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00768">_IOP_RESOURCE_REQUEST::Priority</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00770">_IOP_RESOURCE_REQUEST::ReqList</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00771">_IOP_RESOURCE_REQUEST::ResourceAssignment</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00769">_IOP_RESOURCE_REQUEST::ResourceRequirements</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00773">_IOP_RESOURCE_REQUEST::Status</a>, and <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00772">_IOP_RESOURCE_REQUEST::TranslatedResourceAssignment</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l07470">IopReallocateResources()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l05215">IopRebalance()</a>, and <a class="el" href="../../d6/d0/pnpres_8c-source.html#l02474">IopReleaseFilteredBootResources()</a>.
<p>
<pre class="fragment"><div>05666                    :
05667 
05668     This routine reassigns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> released resources <span class="keywordflow">for</span> device specified by DeviceNode.
05669 
05670 Parameters:
05671 
05672     DeviceNode - specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device node whose resources are goint to be released.
05673 
05674 Return Value:
05675 
05676     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> code that indicates whether or not <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function was successful.
05677 
05678 --*/
05679 
05680 {
05681     <a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">IOP_RESOURCE_REQUEST</a> requestTable;
05682     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
05683 
05684     <span class="keywordflow">if</span> (DeviceNode-&gt;ResourceList == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05685         <span class="keywordflow">return</span> STATUS_SUCCESS;
05686     }
05687     requestTable.<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o4">ResourceRequirements</a> =
05688         <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a28">IopCmResourcesToIoResources</a> (0, DeviceNode-&gt;ResourceList, LCPRI_FORCECONFIG);
05689     <span class="keywordflow">if</span> (requestTable.<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o4">ResourceRequirements</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05690         <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(DUMP_ERROR, (<span class="stringliteral">"PnpRes: Not enough memory to clean up rebalance failure\n"</span>));
05691         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
05692     }
05693     requestTable.<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o3">Priority</a> = 0;
05694     requestTable.<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o1">Flags</a> = 0;
05695     requestTable.<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o2">AllocationType</a> = <a class="code" href="../../d6/d9/pnp_8h.html#a174a130">ArbiterRequestPnpEnumerated</a>;
05696     requestTable.<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o0">PhysicalDevice</a> = DeviceNode-&gt;PhysicalDeviceObject;
05697     requestTable.<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o5">ReqList</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05698     requestTable.<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o6">ResourceAssignment</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05699     requestTable.<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o7">TranslatedResourceAssignment</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05700     requestTable.<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o8">Status</a> = 0;
05701 
05702     <span class="comment">//</span>
05703     <span class="comment">// rebuild internal representation of the resource requirements list</span>
05704     <span class="comment">//</span>
05705 
05706     status = <a class="code" href="../../d5/d1/pnpres_8c.html#a57">IopResourceRequirementsListToReqList</a>(
05707                     requestTable.<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o2">AllocationType</a>,
05708                     requestTable.<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o4">ResourceRequirements</a>,
05709                     requestTable.<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o0">PhysicalDevice</a>,
05710                     &amp;requestTable.<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o5">ReqList</a>);
05711 
05712     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) || requestTable.<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o5">ReqList</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05713         <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(DUMP_ERROR, (<span class="stringliteral">"PnpRes: Not enough memory to restore previous resources\n"</span>));
05714         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (requestTable.<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o4">ResourceRequirements</a>);
05715         <span class="keywordflow">return</span> status;
05716     } <span class="keywordflow">else</span> {
05717         <a class="code" href="../../d5/d1/pnpres_8c.html#a30">PREQ_LIST</a> reqList;
05718 
05719         reqList = (<a class="code" href="../../d5/d1/pnpres_8c.html#a30">PREQ_LIST</a>)requestTable.<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o5">ReqList</a>;
05720         reqList-&gt;AssignEntry = &amp;requestTable;
05721 
05722         <span class="comment">//</span>
05723         <span class="comment">// Sort the ReqList such that the higher priority Alternative list are</span>
05724         <span class="comment">// placed in the front of the list.</span>
05725         <span class="comment">//</span>
05726 
05727         <a class="code" href="../../d5/d1/pnpres_8c.html#a58">IopRearrangeReqList</a>(reqList);
05728         <span class="keywordflow">if</span> (reqList-&gt;ReqBestAlternative == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05729 
05730             <a class="code" href="../../d5/d1/pnpres_8c.html#a61">IopFreeResourceRequirementsForAssignTable</a>(&amp;requestTable, (&amp;requestTable) + 1);
05731             <span class="keywordflow">return</span> STATUS_DEVICE_CONFIGURATION_ERROR;
05732 
05733         }
05734     }
05735 
05736     status = <a class="code" href="../../d5/d1/pnpres_8c.html#a67">IopAssignInner</a>(1, &amp;requestTable, FALSE);
05737     <a class="code" href="../../d5/d1/pnpres_8c.html#a61">IopFreeResourceRequirementsForAssignTable</a>(&amp;requestTable, (&amp;requestTable) + 1);
05738     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
05739         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"IopRestoreResourcesInternal: BOOT conflict for %ws\n"</span>, DeviceNode-&gt;InstancePath.Buffer);
05740         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status));
05741     }
05742     <span class="keywordflow">if</span> (requestTable.<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o6">ResourceAssignment</a>) {
05743         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(requestTable.<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o6">ResourceAssignment</a>);
05744     }
05745     <span class="keywordflow">if</span> (requestTable.<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o7">TranslatedResourceAssignment</a>) {
05746         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(requestTable.<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o7">TranslatedResourceAssignment</a>);
05747     }
05748     <a class="code" href="../../d9/d0/pnpiop_8h.html#a301">IopWriteAllocatedResourcesToRegistry</a> (
05749         DeviceNode,
05750         DeviceNode-&gt;ResourceList,
05751         <a class="code" href="../../d9/d0/pnpiop_8h.html#a254">IopDetermineResourceListSize</a>(DeviceNode-&gt;ResourceList)
05752         );
05753     <span class="keywordflow">return</span> status;
05754 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a72" doxytag="pnpres.c::IopSaveCurrentConfiguration" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopSaveCurrentConfiguration           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>VOID</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l02906">2906</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.
<p>
References <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00713">_PI_RESOURCE_ARBITER_ENTRY::ActiveArbiterList</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00712">_PI_RESOURCE_ARBITER_ENTRY::BestConfig</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00711">_PI_RESOURCE_ARBITER_ENTRY::BestResourceList</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00766">_IOP_RESOURCE_REQUEST::Flags</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00755">IOP_ASSIGN_EXCLUDE</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00234">PiActiveArbiterList</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00237">PiAssignTable</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00238">PiAssignTableCount</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00235">PiBestArbiterList</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00241">PiNoRetest</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00081">PREQ_ALTERNATIVE</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00079">PREQ_DESC</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00083">PREQ_LIST</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00770">_IOP_RESOURCE_REQUEST::ReqList</a>, and <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00710">_PI_RESOURCE_ARBITER_ENTRY::ResourceList</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l03084">IopAssign()</a>.
<p>
<pre class="fragment"><div>02912                    :
02913 
02914     This routine goes thru every resource requirememts list to save <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current
02915     best resource assignments.
02916 
02917 Parameters:
02918 
02919     None.
02920 
02921 Return Value:
02922 
02923     None.
02924 
02925 --*/
02926 
02927 {
02928     <a class="code" href="../../d5/d1/pnpres_8c.html#a29">PREQ_ALTERNATIVE</a> reqAlternative;
02929     <a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a> assignEntry;
02930     <a class="code" href="../../d5/d1/pnpres_8c.html#a28">PREQ_DESC</a> reqDesc, *reqDescpp;
02931     <a class="code" href="../../d5/d1/pnpres_8c.html#a30">PREQ_LIST</a> reqList;
02932     PLIST_ENTRY listEntry;
02933     <a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html">PPI_RESOURCE_ARBITER_ENTRY</a> arbiterEntry;
02934     ULONG i;
02935 
02936     <span class="comment">//</span>
02937     <span class="comment">// If PiNoRetest is set, do nothing.  We don't need to save/restore</span>
02938     <span class="comment">//</span>
02939 
02940     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d1/pnpres_8c.html#a43">PiNoRetest</a>) {
02941         <a class="code" href="../../d5/d1/pnpres_8c.html#a38">PiBestArbiterList</a> = <a class="code" href="../../d5/d1/pnpres_8c.html#a37">PiActiveArbiterList</a>;
02942         <span class="keywordflow">return</span>;
02943     }
02944 
02945     <span class="comment">//</span>
02946     <span class="comment">// Go thru all the assign tables to save the current assignment and mark</span>
02947     <span class="comment">// it as the current best selection.</span>
02948     <span class="comment">//</span>
02949 
02950     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d5/d1/pnpres_8c.html#a41">PiAssignTableCount</a>; i++) {
02951         assignEntry = <a class="code" href="../../d5/d1/pnpres_8c.html#a40">PiAssignTable</a> + i;
02952 
02953         <span class="keywordflow">if</span> (!(assignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o1">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a68">IOP_ASSIGN_EXCLUDE</a>)) {
02954             reqList = assignEntry-&gt;<a class="code" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html#o5">ReqList</a>;
02955 
02956             <span class="comment">//</span>
02957             <span class="comment">// Save the current selected Alternative as the BestAlternative.</span>
02958             <span class="comment">//</span>
02959 
02960             reqAlternative = *reqList-&gt;SelectedAlternative;
02961             reqList-&gt;ReqBestAlternative = reqList-&gt;SelectedAlternative;
02962 
02963             <span class="comment">//</span>
02964             <span class="comment">// For each REQ_DESC in the best alternative list, save its arbiter list entry</span>
02965             <span class="comment">// and its assignments.</span>
02966             <span class="comment">//</span>
02967 
02968             <span class="keywordflow">for</span> (reqDescpp = reqAlternative-&gt;ReqDescTable;
02969                  reqDescpp &lt; reqAlternative-&gt;ReqDescTableEnd;
02970                  reqDescpp++) {
02971 
02972                  <span class="keywordflow">if</span> ((*reqDescpp)-&gt;ArbitrationRequired) {
02973                      reqDesc = (*reqDescpp)-&gt;TranslatedReqDesc;
02974                      reqDesc-&gt;BestAlternativeTable = reqDesc-&gt;AlternativeTable;
02975                      reqDesc-&gt;BestAllocation = reqDesc-&gt;Allocation;
02976                  }
02977             }
02978         }
02979     }
02980 
02981     <span class="comment">//</span>
02982     <span class="comment">// Go throught the active arbiter list to save the current assignment</span>
02983     <span class="comment">// for retest.</span>
02984     <span class="comment">//</span>
02985 
02986     listEntry = <a class="code" href="../../d5/d1/pnpres_8c.html#a37">PiActiveArbiterList</a>.Flink;
02987     <span class="keywordflow">while</span> (listEntry != &amp;<a class="code" href="../../d5/d1/pnpres_8c.html#a37">PiActiveArbiterList</a>) {
02988         arbiterEntry = CONTAINING_RECORD(listEntry, <a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html">PI_RESOURCE_ARBITER_ENTRY</a>, ActiveArbiterList);
02989         arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o4">BestResourceList</a> = arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o3">ResourceList</a>;
02990         arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o5">BestConfig</a> = arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o6">ActiveArbiterList</a>;
02991         listEntry = listEntry-&gt;Flink;
02992     }
02993     <a class="code" href="../../d5/d1/pnpres_8c.html#a38">PiBestArbiterList</a> = <a class="code" href="../../d5/d1/pnpres_8c.html#a37">PiActiveArbiterList</a>;
02994 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a90" doxytag="pnpres.c::IopSetLegacyDeviceInstance" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopSetLegacyDeviceInstance           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d9/struct__DRIVER__OBJECT.html">PDRIVER_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DriverObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceNode</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l06660">6660</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.
<p>
References <a class="el" href="../../d1/d4/io_8h-source.html#l01274">_DEVOBJ_EXTENSION::DeviceNode</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01210">_DEVICE_OBJECT::DeviceObjectExtension</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l03651">IopDeviceObjectFromDeviceInstance()</a>, <a class="el" href="../../d1/d1/pri__bld_2pnpsubs_8c-source.html#l00964">IopServiceInstanceToDeviceInstance()</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html#o34">_DEVICE_NODE::OverUsed2</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01215">RtlFreeUnicodeString()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01690">RtlPrefixUnicodeString()</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l05911">IopFindLegacyDeviceNode()</a>.
<p>
<pre class="fragment"><div>06667                    :
06668 
06669     This routine sets <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Root\Legacy_xxxx\0000 device instance <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a> to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
06670     madeup PDO (i.e. DeviceNode) which is created only for legacy resource allocation.
06671     This routine also links the madeup PDO to the Root\Legacy_xxxx\0000 device node
06672     to keep track what resources are assigned to the driver which services the
06673     root\legacy_xxxx\0000 device.
06674 
06675 Parameters:
06676 
06677     P1 -
06678 
06679 Return Value:
06680 
06681     Status code that indicates whether or not the function was successful.
06682 
06683 --*/
06684 
06685 {
06686     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
06687     UNICODE_STRING instancePath, rootString;
06688     HANDLE handle;
06689     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> legacyDeviceNode;
06690     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> legacyPdo;
06691 
06692     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
06693 
06694     DeviceNode-&gt;OverUsed1.LegacyDeviceNode = 0;
06695     instancePath.Length = 0;
06696     instancePath.Buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
06697 
06698     status = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a6">IopServiceInstanceToDeviceInstance</a> (
06699                  NULL,
06700                  &amp;DriverObject-&gt;DriverExtension-&gt;ServiceKeyName,
06701                  0,
06702                  &amp;instancePath,
06703                  &amp;handle,
06704                  KEY_READ
06705                  );
06706     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) &amp;&amp; (instancePath.Length != 0)) {
06707         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;rootString, L<span class="stringliteral">"ROOT\\LEGACY"</span>);
06708         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/nls_8c.html#a43">RtlPrefixUnicodeString</a>(&amp;rootString, &amp;instancePath, TRUE) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
06709             <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;instancePath);
06710         } <span class="keywordflow">else</span> {
06711             DeviceNode-&gt;InstancePath = instancePath;
06712             legacyPdo = <a class="code" href="../../d0/d2/pri__bld_2pnpsubs_8c.html#a23">IopDeviceObjectFromDeviceInstance</a> (handle, NULL);
06713             <span class="keywordflow">if</span> (legacyPdo) {
06714                 legacyDeviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)legacyPdo-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o6">DeviceNode</a>;
06715                 DeviceNode-&gt;OverUsed2.NextResourceDeviceNode =
06716                     legacyDeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o34">OverUsed2</a>.NextResourceDeviceNode;
06717                 legacyDeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o34">OverUsed2</a>.NextResourceDeviceNode = DeviceNode;
06718                 DeviceNode-&gt;OverUsed1.LegacyDeviceNode = legacyDeviceNode;
06719             }
06720         }
06721         ZwClose(handle);
06722     }
06723 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a75" doxytag="pnpres.c::IopSetupArbiterAndTranslators" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopSetupArbiterAndTranslators           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d5/d1/pnpres_8c.html#a28">PREQ_DESC</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>ReqDesc</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l03534">3534</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.
<p>
References <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00713">_PI_RESOURCE_ARBITER_ENTRY::ActiveArbiterList</a>, <a class="el" href="../../d7/d8/pnp_8h-source.html#l00823">ARBITER_PARTIAL</a>, <a class="el" href="../../d6/d9/pnp_8h.html#a173a122">ArbiterActionQueryArbitrate</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00709">_PI_RESOURCE_ARBITER_ENTRY::ArbiterInterface</a>, <a class="el" href="../../d6/d9/pnp_8h.html#a174a127">ArbiterRequestHalReported</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00712">_PI_RESOURCE_ARBITER_ENTRY::BestConfig</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00711">_PI_RESOURCE_ARBITER_ENTRY::BestResourceList</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00275">DebugMessage</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00239">_DEVICE_NODE::DeviceArbiterList</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00707">_PI_RESOURCE_ARBITER_ENTRY::DeviceArbiterList</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00733">_PI_RESOURCE_TRANSLATOR_ENTRY::DeviceNode</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01274">_DEVOBJ_EXTENSION::DeviceNode</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01210">_DEVICE_OBJECT::DeviceObjectExtension</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00246">_DEVICE_NODE::DeviceTranslatorList</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00730">_PI_RESOURCE_TRANSLATOR_ENTRY::DeviceTranslatorList</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00267">DUMP_ERROR</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00268">DUMP_INFO</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00064">ExAllocatePoolAE</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00065">ExAllocatePoolTE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d7/d8/pnp_8h-source.html#l00845">_ARBITER_INTERFACE::Flags</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00207">_DEVICE_NODE::InterfaceType</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l04339">IopCallArbiter()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l06408">IopFindBusDeviceNode()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l03424">IopFindResourceHandlerInfo()</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l02617">IopQueryResourceHandlerInterface()</a>, <a class="el" href="../../d2/d9/pnpdata_8c-source.html#l00056">IopRootDeviceNode</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l04129">IopTranslateAndAdjustReqDesc()</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00267">_DEVICE_NODE::NoArbiterMask</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00253">_DEVICE_NODE::NoTranslatorMask</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00105">_DEVICE_NODE::Parent</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00151">_DEVICE_NODE::PhysicalDeviceObject</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00698">PI_MAXIMUM_RESOURCE_TYPE_TRACKED</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00079">PREQ_DESC</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00274">_DEVICE_NODE::QueryArbiterMask</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00260">_DEVICE_NODE::QueryTranslatorMask</a>, <a class="el" href="../../d9/d0/pnpiop_8h.html#a390a216">ResourceArbiter</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00710">_PI_RESOURCE_ARBITER_ENTRY::ResourceList</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00715">_PI_RESOURCE_ARBITER_ENTRY::ResourcesChanged</a>, <a class="el" href="../../d9/d0/pnpiop_8h.html#a390a215">ResourceTranslator</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00731">_PI_RESOURCE_TRANSLATOR_ENTRY::ResourceType</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00708">_PI_RESOURCE_ARBITER_ENTRY::ResourceType</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00714">_PI_RESOURCE_ARBITER_ENTRY::State</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00732">_PI_RESOURCE_TRANSLATOR_ENTRY::TranslatorInterface</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l01267">IopResourceRequirementsListToReqList()</a>.
<p>
<pre class="fragment"><div>03540                    :
03541 
03542     This routine searches <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> arbiter and translators which arbitrates and translate
03543     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resources <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified device.  This routine tries to find all <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
03544     translator on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a> of current device node to root device node
03545 
03546 Parameters:
03547 
03548     ReqDesc - supplies a pointer to REQ_DESC which contains all <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> required information
03549 
03550 Return Value:
03551 
03552     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> value to indicate success or <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a>.
03553 
03554 --*/
03555 
03556 {
03557     PLIST_ENTRY listHead, nextEntry;
03558     <a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html">PPI_RESOURCE_ARBITER_ENTRY</a> arbiterEntry;
03559     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> deviceObject = ReqDesc-&gt;AlternativeTable.PhysicalDeviceObject;
03560     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode;
03561     <a class="code" href="../../d5/d1/pnpres_8c.html#a28">PREQ_DESC</a> reqDesc = ReqDesc, translatedReqDesc;
03562     BOOLEAN found, arbiterFound = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, restartedAlready;
03563     BOOLEAN  searchTranslator = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, translatorFound = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03564     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
03565     <a class="code" href="../../d8/d5/struct__PI__RESOURCE__TRANSLATOR__ENTRY.html">PPI_RESOURCE_TRANSLATOR_ENTRY</a> translatorEntry;
03566     UCHAR resourceType = ReqDesc-&gt;TranslatedReqDesc-&gt;AlternativeTable.Alternatives-&gt;Type;
03567     <a class="code" href="../../d8/d3/struct__INTERFACE.html">PINTERFACE</a> interface;
03568     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> resourceMask;
03569 
03570     <span class="keywordflow">if</span> ((ReqDesc-&gt;AlternativeTable.RequestSource == <a class="code" href="../../d6/d9/pnp_8h.html#a174a127">ArbiterRequestHalReported</a>) &amp;&amp;
03571         (ReqDesc-&gt;InterfaceType == Internal)) {
03572 
03573         <span class="comment">// Trust hal if it says internal bus.</span>
03574 
03575         restartedAlready = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03576     } <span class="keywordflow">else</span> {
03577         restartedAlready = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03578     }
03579 
03580     <span class="comment">//</span>
03581     <span class="comment">// If ReqDesc contains DeviceObject, this is for regular resources allocation</span>
03582     <span class="comment">// or boot resources preallocation.  Otherwise, it is for resources reservation.</span>
03583     <span class="comment">//</span>
03584 
03585     <span class="keywordflow">if</span> (deviceObject &amp;&amp; ReqDesc-&gt;AlternativeTable.RequestSource != <a class="code" href="../../d6/d9/pnp_8h.html#a174a127">ArbiterRequestHalReported</a>) {
03586         deviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)deviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o6">DeviceNode</a>;
03587         <span class="comment">// We want to start with the deviceNode instead of its parent.  Because the</span>
03588         <span class="comment">// deviceNode may provide a translator interface.</span>
03589         <span class="comment">// deviceNode = deviceNode-&gt;Parent;</span>
03590     } <span class="keywordflow">else</span> {
03591 
03592         <span class="comment">//</span>
03593         <span class="comment">// For resource reservation, we always need to find the arbiter and translators</span>
03594         <span class="comment">// so set the device node to Root.</span>
03595         <span class="comment">//</span>
03596 
03597         deviceNode = <a class="code" href="../../d1/d0/pnpdata_8c.html#a5">IopRootDeviceNode</a>;
03598     }
03599     <span class="keywordflow">while</span> (deviceNode) {
03600         <span class="keywordflow">if</span> ((deviceNode == <a class="code" href="../../d1/d0/pnpdata_8c.html#a5">IopRootDeviceNode</a>) &amp;&amp; (translatorFound == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
03601 
03602             <span class="comment">//</span>
03603             <span class="comment">// If we reach the root and have not find any translator, the device is on the</span>
03604             <span class="comment">// wrong way.</span>
03605             <span class="comment">//</span>
03606 
03607             <span class="keywordflow">if</span> (restartedAlready == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
03608                 restartedAlready = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03609 
03610                 deviceNode = <a class="code" href="../../d5/d1/pnpres_8c.html#a108">IopFindBusDeviceNode</a> (
03611                                  IopRootDeviceNode,
03612                                  ReqDesc-&gt;InterfaceType,
03613                                  ReqDesc-&gt;BusNumber,
03614                                  0
03615                                  );
03616 
03617                 <span class="comment">//</span>
03618                 <span class="comment">// If we did not find a PDO, try again with InterfaceType == Isa. This allows</span>
03619                 <span class="comment">// drivers that request Internal to get resources even if there is no PDO</span>
03620                 <span class="comment">// that is Internal. (but if there is an Internal PDO, they get that one)</span>
03621                 <span class="comment">//</span>
03622 
03623                 <span class="keywordflow">if</span> ((deviceNode == <a class="code" href="../../d1/d0/pnpdata_8c.html#a5">IopRootDeviceNode</a>) &amp;&amp;
03624                     (ReqDesc-&gt;ReqAlternative-&gt;ReqList-&gt;InterfaceType == Internal)) {
03625                     deviceNode = <a class="code" href="../../d5/d1/pnpres_8c.html#a108">IopFindBusDeviceNode</a>(
03626                                  IopRootDeviceNode,
03627                                  Isa,
03628                                  0,
03629                                  0
03630                                  );
03631                 }
03632 
03633                 <span class="comment">//if ((PVOID)deviceNode == deviceObject-&gt;DeviceObjectExtension-&gt;DeviceNode) {</span>
03634                 <span class="comment">//    deviceNode = IopRootDeviceNode;</span>
03635                 <span class="comment">//} else {</span>
03636                     <span class="keywordflow">continue</span>;
03637                 <span class="comment">//}</span>
03638             }
03639         }
03640 
03641         <span class="comment">//</span>
03642         <span class="comment">// Check is there an arbiter for the device node?</span>
03643         <span class="comment">//   if yes, set up ReqDesc-&gt;u.Arbiter and set ArbiterFound to true.</span>
03644         <span class="comment">//   else move up to the parent of current device node.</span>
03645         <span class="comment">//</span>
03646 
03647         <span class="keywordflow">if</span> ((arbiterFound == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) &amp;&amp; (deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o9">PhysicalDeviceObject</a> != deviceObject)) {
03648             found = <a class="code" href="../../d5/d1/pnpres_8c.html#a74">IopFindResourceHandlerInfo</a>(
03649                                ResourceArbiter,
03650                                deviceNode,
03651                                resourceType,
03652                                &amp;arbiterEntry);
03653             <span class="keywordflow">if</span> (found == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
03654 
03655                 <span class="comment">//</span>
03656                 <span class="comment">// no information found on arbiter.  Try to query translator interface ...</span>
03657                 <span class="comment">//</span>
03658 
03659                 <span class="keywordflow">if</span> (resourceType &lt;= <a class="code" href="../../d9/d0/pnpiop_8h.html#a57">PI_MAXIMUM_RESOURCE_TYPE_TRACKED</a>) {
03660                     resourceMask = 1 &lt;&lt; resourceType;
03661                 } <span class="keywordflow">else</span> {
03662                     resourceMask = 0;
03663                 }
03664                 status = <a class="code" href="../../d0/d1/pnpirp_8c.html#a28">IopQueryResourceHandlerInterface</a>(ResourceArbiter,
03665                                                           deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o9">PhysicalDeviceObject</a>,
03666                                                           resourceType,
03667                                                           &amp;interface);
03668                 deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o29">QueryArbiterMask</a> |= resourceMask;
03669                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03670                     deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o28">NoArbiterMask</a> |= resourceMask;
03671                     <span class="keywordflow">if</span> (resourceType &lt;= <a class="code" href="../../d9/d0/pnpiop_8h.html#a57">PI_MAXIMUM_RESOURCE_TYPE_TRACKED</a>) {
03672                         found = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03673                     } <span class="keywordflow">else</span> {
03674                         interface = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03675                     }
03676                 }
03677                 <span class="keywordflow">if</span> (found == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
03678                     arbiterEntry = (<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html">PPI_RESOURCE_ARBITER_ENTRY</a>)<a class="code" href="../../d5/d1/pnpres_8c.html#a5">ExAllocatePoolAE</a>(
03679                                        PagedPool,
03680                                        <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html">PI_RESOURCE_ARBITER_ENTRY</a>));
03681                     <span class="keywordflow">if</span> (!arbiterEntry) {
03682                         status = STATUS_INSUFFICIENT_RESOURCES;
03683                         <span class="keywordflow">return</span> status;
03684                     }
03685                     InitializeListHead(&amp;arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o6">ActiveArbiterList</a>);
03686                     InitializeListHead(&amp;arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o0">DeviceArbiterList</a>);
03687                     InitializeListHead(&amp;arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o5">BestConfig</a>);
03688                     InitializeListHead(&amp;arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o3">ResourceList</a>);
03689                     InitializeListHead(&amp;arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o4">BestResourceList</a>);
03690                     arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o1">ResourceType</a> =resourceType;
03691                     arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o7">State</a> = 0;
03692                     arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o8">ResourcesChanged</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03693                     listHead = &amp;deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o24">DeviceArbiterList</a>;
03694                     InsertTailList(listHead, &amp;arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o0">DeviceArbiterList</a>);
03695                     arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o2">ArbiterInterface</a> = (<a class="code" href="../../d9/d7/struct__ARBITER__INTERFACE.html">PARBITER_INTERFACE</a>)interface;
03696                     <span class="keywordflow">if</span> (!interface) {
03697 
03698                         <span class="comment">//</span>
03699                         <span class="comment">// if interface is NULL we really don't have translator.</span>
03700                         <span class="comment">//</span>
03701 
03702                         arbiterEntry = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03703                     }
03704                 }
03705             }
03706 
03707             <span class="comment">//</span>
03708             <span class="comment">// If there is an desired resourcetype arbiter in the device node, make sure</span>
03709             <span class="comment">// it handle this resource requriements.</span>
03710             <span class="comment">//</span>
03711 
03712             <span class="keywordflow">if</span> (arbiterEntry) {
03713                 arbiterFound = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03714                 <span class="keywordflow">if</span> (arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o2">ArbiterInterface</a>-&gt;<a class="code" href="../../d9/d7/struct__ARBITER__INTERFACE.html#o6">Flags</a> &amp; <a class="code" href="../../d6/d9/pnp_8h.html#a9">ARBITER_PARTIAL</a>) {
03715 
03716                     <span class="comment">//</span>
03717                     <span class="comment">// If the arbiter is partial, ask if it handles the resources</span>
03718                     <span class="comment">// if not, goto its parent.</span>
03719                     <span class="comment">//</span>
03720 
03721                     status = <a class="code" href="../../d5/d1/pnpres_8c.html#a79">IopCallArbiter</a>(
03722                                 arbiterEntry,
03723                                 ArbiterActionQueryArbitrate,
03724                                 ReqDesc-&gt;TranslatedReqDesc,
03725                                 NULL,
03726                                 NULL
03727                                 );
03728                     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03729                         arbiterFound = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03730                     }
03731                 }
03732             }
03733             <span class="keywordflow">if</span> (arbiterFound) {
03734                 ReqDesc-&gt;u.Arbiter = arbiterEntry;
03735 
03736                 <span class="comment">//</span>
03737                 <span class="comment">// Initialize the arbiter entry</span>
03738                 <span class="comment">//</span>
03739 
03740                 arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o7">State</a> = 0;
03741                 arbiterEntry-&gt;<a class="code" href="../../d7/d5/struct__PI__RESOURCE__ARBITER__ENTRY.html#o8">ResourcesChanged</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03742             }
03743 
03744         }
03745 
03746         <span class="keywordflow">if</span> (searchTranslator) {
03747             <span class="comment">//</span>
03748             <span class="comment">// First, check if there is a translator for the device node?</span>
03749             <span class="comment">// If yes, translate the req desc and link it to the front of ReqDesc-&gt;TranslatedReqDesc</span>
03750             <span class="comment">// else do nothing.</span>
03751             <span class="comment">//</span>
03752 
03753             found = <a class="code" href="../../d5/d1/pnpres_8c.html#a74">IopFindResourceHandlerInfo</a>(
03754                         ResourceTranslator,
03755                         deviceNode,
03756                         resourceType,
03757                         &amp;translatorEntry);
03758 
03759             <span class="keywordflow">if</span> (found == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
03760 
03761                 <span class="comment">//</span>
03762                 <span class="comment">// no information found on translator.  Try to query translator interface ...</span>
03763                 <span class="comment">//</span>
03764 
03765                 <span class="keywordflow">if</span> (resourceType &lt;= <a class="code" href="../../d9/d0/pnpiop_8h.html#a57">PI_MAXIMUM_RESOURCE_TYPE_TRACKED</a>) {
03766                     resourceMask = 1 &lt;&lt; resourceType;
03767                 } <span class="keywordflow">else</span> {
03768                     resourceMask = 0;
03769                 }
03770                 status = <a class="code" href="../../d0/d1/pnpirp_8c.html#a28">IopQueryResourceHandlerInterface</a>(ResourceTranslator,
03771                                                           deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o9">PhysicalDeviceObject</a>,
03772                                                           resourceType,
03773                                                           &amp;interface);
03774                 deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o27">QueryTranslatorMask</a> |= resourceMask;
03775                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03776                     deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o26">NoTranslatorMask</a> |= resourceMask;
03777                     <span class="keywordflow">if</span> (resourceType &lt;= <a class="code" href="../../d9/d0/pnpiop_8h.html#a57">PI_MAXIMUM_RESOURCE_TYPE_TRACKED</a>) {
03778                         found = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03779                     } <span class="keywordflow">else</span> {
03780                         interface = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03781                     }
03782                 }
03783                 <span class="keywordflow">if</span> (found == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
03784                     translatorEntry = (<a class="code" href="../../d8/d5/struct__PI__RESOURCE__TRANSLATOR__ENTRY.html">PPI_RESOURCE_TRANSLATOR_ENTRY</a>)<a class="code" href="../../d5/d1/pnpres_8c.html#a6">ExAllocatePoolTE</a>(
03785                                        PagedPool,
03786                                        <span class="keyword">sizeof</span>(<a class="code" href="../../d8/d5/struct__PI__RESOURCE__TRANSLATOR__ENTRY.html">PI_RESOURCE_TRANSLATOR_ENTRY</a>));
03787                     <span class="keywordflow">if</span> (!translatorEntry) {
03788                         status = STATUS_INSUFFICIENT_RESOURCES;
03789                         <span class="keywordflow">return</span> status;
03790                     }
03791                     translatorEntry-&gt;<a class="code" href="../../d8/d5/struct__PI__RESOURCE__TRANSLATOR__ENTRY.html#o1">ResourceType</a> = resourceType;
03792                     InitializeListHead(&amp;translatorEntry-&gt;<a class="code" href="../../d8/d5/struct__PI__RESOURCE__TRANSLATOR__ENTRY.html#o0">DeviceTranslatorList</a>);
03793                     translatorEntry-&gt;<a class="code" href="../../d8/d5/struct__PI__RESOURCE__TRANSLATOR__ENTRY.html#o2">TranslatorInterface</a> = (<a class="code" href="../../d3/d2/struct__TRANSLATOR__INTERFACE.html">PTRANSLATOR_INTERFACE</a>)interface;
03794                     translatorEntry-&gt;<a class="code" href="../../d8/d5/struct__PI__RESOURCE__TRANSLATOR__ENTRY.html#o3">DeviceNode</a> = deviceNode;
03795                     listHead = &amp;deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o25">DeviceTranslatorList</a>;
03796                     InsertTailList(listHead, &amp;translatorEntry-&gt;<a class="code" href="../../d8/d5/struct__PI__RESOURCE__TRANSLATOR__ENTRY.html#o0">DeviceTranslatorList</a>);
03797                     <span class="keywordflow">if</span> (!interface) {
03798 
03799                         <span class="comment">//</span>
03800                         <span class="comment">// if interface is NULL we really don't have translator.</span>
03801                         <span class="comment">//</span>
03802 
03803                         translatorEntry = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03804                     }
03805                 }
03806             }
03807             <span class="keywordflow">if</span> (translatorEntry) {
03808                 translatorFound = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03809             }
03810             <span class="keywordflow">if</span> ((arbiterFound == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) &amp;&amp; translatorEntry) {
03811 
03812                 <span class="comment">//</span>
03813                 <span class="comment">// Find a translator to translate the req desc ... Translate it and link it to</span>
03814                 <span class="comment">// the front of ReqDesc-&gt;TranslatedReqDesc such that the first in the list is for</span>
03815                 <span class="comment">// the Arbiter to use.</span>
03816                 <span class="comment">//</span>
03817 
03818                 reqDesc = ReqDesc-&gt;TranslatedReqDesc;
03819                 status = <a class="code" href="../../d5/d1/pnpres_8c.html#a78">IopTranslateAndAdjustReqDesc</a>(
03820                               reqDesc,
03821                               translatorEntry,
03822                               &amp;translatedReqDesc);
03823                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
03824                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(translatedReqDesc);
03825                     resourceType = translatedReqDesc-&gt;AlternativeTable.Alternatives-&gt;Type;
03826                     translatedReqDesc-&gt;TranslatedReqDesc = ReqDesc-&gt;TranslatedReqDesc;
03827                     ReqDesc-&gt;TranslatedReqDesc = translatedReqDesc;
03828                     <span class="comment">//</span>
03829                     <span class="comment">// If the translator is non-hierarchial and performs a complete</span>
03830                     <span class="comment">// translation to root (eg ISA interrups for PCI devices) then</span>
03831                     <span class="comment">// don't pass translations to parent.</span>
03832                     <span class="comment">//</span>
03833 
03834                     <span class="keywordflow">if</span> (status == STATUS_TRANSLATION_COMPLETE) {
03835                         searchTranslator = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03836                     }
03837                 } <span class="keywordflow">else</span> {
03838                     <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(DUMP_INFO, (<span class="stringliteral">"PnpResr: resreq list TranslationAndAdjusted failed\n"</span>));
03839                     <span class="keywordflow">return</span> status;
03840                 }
03841             }
03842 
03843         }
03844 
03845         <span class="comment">//</span>
03846         <span class="comment">// Move up to current device node's parent</span>
03847         <span class="comment">//</span>
03848 
03849         deviceNode = deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o2">Parent</a>;
03850     }
03851 
03852     <span class="keywordflow">if</span> (arbiterFound) {
03853         <span class="keywordflow">return</span> STATUS_SUCCESS;
03854     } <span class="keywordflow">else</span> {
03855 
03856         <span class="comment">//</span>
03857         <span class="comment">// We should BugCheck in this case.</span>
03858         <span class="comment">//</span>
03859 
03860         <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(DUMP_ERROR, (<span class="stringliteral">"PnpResr: can not find resource type %x arbiter\n"</span>, resourceType));
03861         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(0);
03862         <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
03863     }
03864 
03865 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a82" doxytag="pnpres.c::IopTestForReconfiguration" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID IopTestForReconfiguration           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceNode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>RebalancePhase</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>RebalanceCount</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> **&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceTable</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l04767">4767</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00099">_DEVICE_NODE::Child</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00275">DebugMessage</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00408">DNF_ADDED</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00447">DNF_ASSIGNING_RESOURCES</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00621">DNF_ASYNC_REQUEST_PENDING</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00421">DNF_BOOT_CONFIG_RESERVED</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00415">DNF_HAS_BOOT_CONFIG</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00493">DNF_LEGACY_DRIVER</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00370">DNF_MADEUP</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00576">DNF_NEEDS_REBALANCE</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00473">DNF_NON_STOPPED_REBALANCE</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00466">DNF_RESOURCE_REQUIREMENTS_CHANGED</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00487">DNF_STARTED</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00480">DNF_STOPPED</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00268">DUMP_INFO</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00129">_DEVICE_NODE::Flags</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00177">_DEVICE_NODE::InstancePath</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00825">IopDoesDevNodeHaveProblem</a>, <a class="el" href="../../d1/d0/pnpirp_8c-source.html#l02733">IopQueryReconfiguration()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00157">IopReleaseBootResources</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00166">IRP_MN_CANCEL_STOP_DEVICE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00165">IRP_MN_QUERY_STOP_DEVICE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00164">IRP_MN_STOP_DEVICE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00514">ObReferenceObject</a>, <a class="el" href="../../d0/d0/pnpiop_8h-source.html#l00093">_DEVICE_NODE::Sibling</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l04667">IopQueryRebalanceWorker()</a>.
<p>
<pre class="fragment"><div>04777                    :
04778 
04779     This routine query-stops a device which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> started and owns resources.
04780     Note <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resources <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device are not released at <span class="keyword">this</span> point.
04781 
04782 Parameters:
04783 
04784     DeviceNode - supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device node to be tested <span class="keywordflow">for</span> reconfiguration.
04785 
04786     Phase - Supplies a value to specify <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> phase of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> rebalance.
04787 
04788     RebalanceCount - supplies a pointer to a variable to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of devices
04789                  participating <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> rebalance.
04790 
04791 Return Value:
04792 
04793     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> code that indicates whether or not <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function was successful.
04794 
04795 --*/
04796 
04797 {
04798     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> nodex;
04799     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
04800     BOOLEAN addToList = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04801 
04802     <span class="comment">//</span>
04803     <span class="comment">// We still need to perform the test for sibling nodes.</span>
04804     <span class="comment">//</span>
04805 
04806     <span class="keywordflow">if</span> ((DeviceNode-&gt;Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a44">DNF_ASYNC_REQUEST_PENDING</a>)  ||
04807         (DeviceNode-&gt;Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a22">DNF_STOPPED</a>)                ||
04808         (<a class="code" href="../../d9/d0/pnpiop_8h.html#a77">IopDoesDevNodeHaveProblem</a>(DeviceNode))          ||
04809         (DeviceNode-&gt;Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a24">DNF_LEGACY_DRIVER</a>)          ||
04810         (DeviceNode-&gt;Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a17">DNF_ASSIGNING_RESOURCES</a>)) {
04811         <span class="keywordflow">return</span>;
04812     }
04813 
04814     <span class="keywordflow">if</span> (Phase == 0) {
04815 
04816         <span class="comment">//</span>
04817         <span class="comment">// At phase zero, this routine only wants to find out which devices's resource</span>
04818         <span class="comment">// requirements lists chagned.  No one actually gets stopped.</span>
04819         <span class="comment">//</span>
04820 
04821         <span class="keywordflow">if</span> (DeviceNode-&gt;Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a20">DNF_RESOURCE_REQUIREMENTS_CHANGED</a> &amp;&amp;
04822             !(DeviceNode-&gt;Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a21">DNF_NON_STOPPED_REBALANCE</a>) ) {
04823 
04824             <span class="comment">//</span>
04825             <span class="comment">// It's too hard to handle non-stop rebalancing devices during rebalance.</span>
04826             <span class="comment">// So, We will skip it.</span>
04827             <span class="comment">//</span>
04828 
04829             addToList = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04830         } <span class="keywordflow">else</span> {
04831 
04832             <span class="keywordflow">if</span> (DeviceNode-&gt;Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a23">DNF_STARTED</a>) {
04833                 status = <a class="code" href="../../d0/d1/pnpirp_8c.html#a29">IopQueryReconfiguration</a> (IRP_MN_QUERY_STOP_DEVICE, DeviceNode-&gt;PhysicalDeviceObject);
04834                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04835                     <span class="keywordflow">if</span> (status == STATUS_RESOURCE_REQUIREMENTS_CHANGED) {
04836 
04837                         <span class="comment">//</span>
04838                         <span class="comment">// If we find out a device's resource requirements changed this way,</span>
04839                         <span class="comment">// it will be stopped and reassigned resources even if it supports</span>
04840                         <span class="comment">// non-stopped rebalance.</span>
04841                         <span class="comment">//</span>
04842 
04843                         DeviceNode-&gt;Flags |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a20">DNF_RESOURCE_REQUIREMENTS_CHANGED</a>;
04844                         addToList = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04845                     }
04846                 }
04847                 <a class="code" href="../../d0/d1/pnpirp_8c.html#a29">IopQueryReconfiguration</a> (IRP_MN_CANCEL_STOP_DEVICE, DeviceNode-&gt;PhysicalDeviceObject);
04848             }
04849         }
04850         <span class="keywordflow">if</span> (addToList) {
04851             *RebalanceCount = *RebalanceCount + 1;
04852             **DeviceTable = DeviceNode-&gt;PhysicalDeviceObject;
04853             *DeviceTable = *DeviceTable + 1;
04854         }
04855     } <span class="keywordflow">else</span> {
04856 
04857         <span class="comment">//</span>
04858         <span class="comment">// Phase 1</span>
04859         <span class="comment">//</span>
04860 
04861         <span class="keywordflow">if</span> (DeviceNode-&gt;Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a23">DNF_STARTED</a>) {
04862 
04863             <span class="comment">//</span>
04864             <span class="comment">// Make sure all the resources required children of the DeviceNode are stopped.</span>
04865             <span class="comment">//</span>
04866 
04867             nodex = DeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o1">Child</a>;
04868             <span class="keywordflow">while</span> (nodex) {
04869                 <span class="keywordflow">if</span> (!(nodex-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; (<a class="code" href="../../d9/d0/pnpiop_8h.html#a23">DNF_STARTED</a> | <a class="code" href="../../d9/d0/pnpiop_8h.html#a17">DNF_ASSIGNING_RESOURCES</a>)) ||
04870                     (nodex-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a22">DNF_STOPPED</a>) ||
04871                     (nodex-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a35">DNF_NEEDS_REBALANCE</a>)) {
04872                     nodex = nodex-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o0">Sibling</a>;
04873                 } <span class="keywordflow">else</span> {
04874                     <span class="keywordflow">break</span>;
04875                 }
04876             }
04877             <span class="keywordflow">if</span> (nodex) {
04878 
04879                 <span class="comment">//</span>
04880                 <span class="comment">// If any resource required child of the DeviceNode does not stopped,</span>
04881                 <span class="comment">// we won't ask the DeviceNode to stop.</span>
04882                 <span class="comment">// BUGBUG: We may want to restart the stopped subtrees.</span>
04883                 <span class="comment">//</span>
04884 
04885                 <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(DUMP_INFO, (<span class="stringliteral">"Rebalance: Child %ws not stopped for %ws\n"</span>, nodex-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o13">InstancePath</a>.Buffer, DeviceNode-&gt;InstancePath.Buffer));
04886                 <span class="keywordflow">return</span>;
04887             }
04888         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((DeviceNode-&gt;Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a12">DNF_HAS_BOOT_CONFIG</a>) == 0 ||
04889                    !(DeviceNode-&gt;Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a11">DNF_ADDED</a>) ||
04890                    DeviceNode-&gt;Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a5">DNF_MADEUP</a>) {
04891 
04892             <span class="comment">//</span>
04893             <span class="comment">// The device is not started and has no boot config.  There is no need to query-stop it.</span>
04894             <span class="comment">// Or if the device has BOOT config but there is no driver installed for it.  We don't query</span>
04895             <span class="comment">// stop it. (There may be legacy drivers are using the resources.)</span>
04896             <span class="comment">// We also don't want to query stop root enumerated devices (for performance reason.)</span>
04897             <span class="comment">// BUGBUG - We really want to query stop the root enumerated devices which do not have</span>
04898             <span class="comment">//          Boot Config and have resource requirement alternatives.  (But today some legacy</span>
04899             <span class="comment">//          driver installers do not create boot resources.)</span>
04900             <span class="comment">//</span>
04901 
04902             <span class="keywordflow">return</span>;
04903         }
04904         status = <a class="code" href="../../d0/d1/pnpirp_8c.html#a29">IopQueryReconfiguration</a> (IRP_MN_QUERY_STOP_DEVICE, DeviceNode-&gt;PhysicalDeviceObject);
04905         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
04906             <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(DUMP_INFO, (<span class="stringliteral">"Rebalance: %ws succeeded QueryStop\n"</span>, DeviceNode-&gt;InstancePath.Buffer));
04907             <span class="keywordflow">if</span> (DeviceNode-&gt;Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a23">DNF_STARTED</a>) {
04908 
04909                 <span class="comment">//DeviceNode-&gt;Flags &amp;= ~DNF_STARTED;</span>
04910                 DeviceNode-&gt;Flags |= <a class="code" href="../../d9/d0/pnpiop_8h.html#a22">DNF_STOPPED</a>;
04911                 *RebalanceCount = *RebalanceCount + 1;
04912                 **DeviceTable = DeviceNode-&gt;PhysicalDeviceObject;
04913 
04914                 <span class="comment">//</span>
04915                 <span class="comment">// Add a reference to the device object such that it won't disapear during rebalance.</span>
04916                 <span class="comment">//</span>
04917 
04918                 <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>(DeviceNode-&gt;PhysicalDeviceObject);
04919                 *DeviceTable = *DeviceTable + 1;
04920             } <span class="keywordflow">else</span> {
04921 
04922                 <span class="comment">//</span>
04923                 <span class="comment">// We need to release the device's prealloc boot config.  This device will NOT</span>
04924                 <span class="comment">// participate in resource rebalancing.</span>
04925                 <span class="comment">//</span>
04926 
04927                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(DeviceNode-&gt;Flags &amp; DNF_HAS_BOOT_CONFIG);
04928                 status = <a class="code" href="../../d0/d1/pnpirp_8c.html#a29">IopQueryReconfiguration</a> (IRP_MN_STOP_DEVICE, DeviceNode-&gt;PhysicalDeviceObject);
04929                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status));
04930                 <a class="code" href="../../d5/d1/pnpres_8c.html#a15">IopReleaseBootResources</a>(DeviceNode);
04931 
04932                 <span class="comment">//</span>
04933                 <span class="comment">// Reset BOOT CONFIG flags.  DO NOT set DNF_STOPPED.</span>
04934                 <span class="comment">//</span>
04935 
04936                 DeviceNode-&gt;Flags &amp;= ~(<a class="code" href="../../d9/d0/pnpiop_8h.html#a12">DNF_HAS_BOOT_CONFIG</a> + <a class="code" href="../../d9/d0/pnpiop_8h.html#a13">DNF_BOOT_CONFIG_RESERVED</a>);
04937             }
04938         } <span class="keywordflow">else</span> {
04939             <a class="code" href="../../d0/d1/pnpirp_8c.html#a29">IopQueryReconfiguration</a> (IRP_MN_CANCEL_STOP_DEVICE, DeviceNode-&gt;PhysicalDeviceObject);
04940         }
04941     }
04942 
04943 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a78" doxytag="pnpres.c::IopTranslateAndAdjustReqDesc" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS IopTranslateAndAdjustReqDesc           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d5/d1/pnpres_8c.html#a28">PREQ_DESC</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ReqDesc</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d8/d5/struct__PI__RESOURCE__TRANSLATOR__ENTRY.html">PPI_RESOURCE_TRANSLATOR_ENTRY</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>TranslatorEntry</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d5/d1/pnpres_8c.html#a28">PREQ_DESC</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>TranslatedReqDesc</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l04129">4129</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.
<p>
References <a class="el" href="../../d7/d8/pnp_8h-source.html#l00744">_ARBITER_LIST_ENTRY::AlternativeCount</a>, <a class="el" href="../../d7/d8/pnp_8h-source.html#l00749">_ARBITER_LIST_ENTRY::Alternatives</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d8/pnp_8h-source.html#l00785">_ARBITER_LIST_ENTRY::Assignment</a>, <a class="el" href="../../d7/d8/pnp_8h-source.html#l00891">_TRANSLATOR_INTERFACE::Context</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00275">DebugMessage</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00267">DUMP_ERROR</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00068">ExAllocatePool1RD</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00067">ExAllocatePoolIORD</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d0/d1/fedefs_8h-source.html#l00051">exit</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d7/d8/pnp_8h-source.html#l00739">_ARBITER_LIST_ENTRY::ListEntry</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00079">PREQ_DESC</a>, <a class="el" href="../../d7/d8/pnp_8h-source.html#l00895">_TRANSLATOR_INTERFACE::TranslateResourceRequirements</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l03534">IopSetupArbiterAndTranslators()</a>.
<p>
<pre class="fragment"><div>04137                    :
04138 
04139     This routine translates and adjusts ReqDesc IoResourceDescriptors to
04140     their translated and adjusted form.
04141 
04142 Parameters:
04143 
04144     ReqDesc - supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> REQ_DESC to be translated.
04145 
04146     TranslatorEntry - supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> translator infor structure.
04147 
04148     TranslatedReqDesc - supplies a pointer to a variable to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
04149                         translated REQ_DESC.
04150 
04151 Return Value:
04152 
04153     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> code that indicates whether or not <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function was successful.
04154 
04155 --*/
04156 {
04157     ULONG i, total = 0, *targetCount;
04158     <a class="code" href="../../d3/d2/struct__TRANSLATOR__INTERFACE.html">PTRANSLATOR_INTERFACE</a> translator = TranslatorEntry-&gt;TranslatorInterface;
04159     PIO_RESOURCE_DESCRIPTOR ioDesc, *target, tIoDesc;
04160     <a class="code" href="../../d5/d1/pnpres_8c.html#a28">PREQ_DESC</a> tReqDesc;
04161     <a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html">PARBITER_LIST_ENTRY</a> arbiterEntry;
04162     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status, returnStatus = STATUS_SUCCESS;
04163     BOOLEAN reqTranslated = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04164 
04165     <span class="keywordflow">if</span> (ReqDesc-&gt;AlternativeTable.AlternativeCount == 0) {
04166         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
04167     }
04168 
04169     *TranslatedReqDesc = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04170 
04171     target = (PIO_RESOURCE_DESCRIPTOR *) <a class="code" href="../../d5/d1/pnpres_8c.html#a8">ExAllocatePoolIORD</a>(
04172                            PagedPool,
04173                            <span class="keyword">sizeof</span>(PIO_RESOURCE_DESCRIPTOR) * ReqDesc-&gt;AlternativeTable.AlternativeCount
04174                            );
04175     <span class="keywordflow">if</span> (target == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04176         <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(DUMP_ERROR, (<span class="stringliteral">"PnpRes: Not Enough memory to perform resreqlist adjustment\n"</span>));
04177         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
04178     }
04179     RtlZeroMemory(target, <span class="keyword">sizeof</span>(PIO_RESOURCE_DESCRIPTOR) * ReqDesc-&gt;AlternativeTable.AlternativeCount);
04180 
04181     targetCount = (PULONG) <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(
04182                            PagedPool,
04183                            <span class="keyword">sizeof</span>(ULONG) * ReqDesc-&gt;AlternativeTable.AlternativeCount
04184                            );
04185     <span class="keywordflow">if</span> (targetCount == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04186         <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(DUMP_ERROR, (<span class="stringliteral">"PnpRes: Not Enough memory to perform resreqlist adjustment\n"</span>));
04187         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(target);
04188         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
04189     }
04190 
04191     RtlZeroMemory(targetCount, <span class="keyword">sizeof</span>(ULONG) * ReqDesc-&gt;AlternativeTable.AlternativeCount);
04192 
04193     <span class="comment">//</span>
04194     <span class="comment">// Determine the number of IO_RESOURCE_DESCRIPTORs after translation.</span>
04195     <span class="comment">//</span>
04196 
04197     ioDesc = ReqDesc-&gt;AlternativeTable.Alternatives;
04198     <span class="keywordflow">for</span> (i = 0; i &lt; ReqDesc-&gt;AlternativeTable.AlternativeCount; i++) {
04199         status = (translator-&gt;<a class="code" href="../../d3/d2/struct__TRANSLATOR__INTERFACE.html#o6">TranslateResourceRequirements</a>)(
04200                            translator-&gt;<a class="code" href="../../d3/d2/struct__TRANSLATOR__INTERFACE.html#o2">Context</a>,
04201                            ioDesc,
04202                            ReqDesc-&gt;AlternativeTable.PhysicalDeviceObject,
04203                            &amp;targetCount[i],
04204                            &amp;target[i]
04205                            );
04206         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) || targetCount[i] == 0) {
04207             <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(DUMP_ERROR, (<span class="stringliteral">"PnpRes:Translator failed to adjust resreqlist\n"</span>));
04208             target[i] = ioDesc;
04209             targetCount[i] = 0;
04210             total++;
04211         } <span class="keywordflow">else</span> {
04212             total += targetCount[i];
04213             reqTranslated = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04214         }
04215         ioDesc++;
04216         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) &amp;&amp; (returnStatus != STATUS_TRANSLATION_COMPLETE)) {
04217             returnStatus = status;
04218         }
04219     }
04220 
04221     <span class="keywordflow">if</span> (!reqTranslated) {
04222         <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(DUMP_ERROR, (<span class="stringliteral">"PnpRes:Failed to translate any requirement for %ws!\n"</span>, ((<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)(ReqDesc-&gt;AlternativeTable.PhysicalDeviceObject-&gt;DeviceObjectExtension-&gt;DeviceNode))-&gt;InstancePath.Buffer));
04223         returnStatus = status;
04224     }
04225 
04226     <span class="comment">//</span>
04227     <span class="comment">// Allocate memory for the adjusted/translated resources descriptors</span>
04228     <span class="comment">//</span>
04229 
04230     tIoDesc = (PIO_RESOURCE_DESCRIPTOR) <a class="code" href="../../d5/d1/pnpres_8c.html#a8">ExAllocatePoolIORD</a>(
04231                            PagedPool,
04232                            total * <span class="keyword">sizeof</span>(IO_RESOURCE_DESCRIPTOR));
04233     <span class="keywordflow">if</span> (!tIoDesc) {
04234         <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(DUMP_ERROR, (<span class="stringliteral">"PnpRes: Not Enough memory to perform resreqlist adjustment\n"</span>));
04235         returnStatus = STATUS_INSUFFICIENT_RESOURCES;
04236         <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
04237     }
04238 
04239     tReqDesc = (<a class="code" href="../../d5/d1/pnpres_8c.html#a28">PREQ_DESC</a>) <a class="code" href="../../d5/d1/pnpres_8c.html#a9">ExAllocatePool1RD</a> (PagedPool, <span class="keyword">sizeof</span>(REQ_DESC));
04240     <span class="keywordflow">if</span> (tReqDesc == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04241         <a class="code" href="../../d5/d1/pnpres_8c.html#a27">DebugMessage</a>(DUMP_ERROR, (<span class="stringliteral">"PnpRes: Not Enough memory to perform resreqlist adjustment\n"</span>));
04242         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(tIoDesc);
04243         returnStatus = STATUS_INSUFFICIENT_RESOURCES;
04244         <span class="keywordflow">goto</span> <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>;
04245     }
04246 
04247     <span class="comment">//</span>
04248     <span class="comment">// Create and initialize a new REQ_DESC for the translated/adjusted io resources</span>
04249     <span class="comment">//</span>
04250 
04251     RtlMoveMemory(tReqDesc, ReqDesc, <span class="keyword">sizeof</span>(REQ_DESC));
04252 
04253     <span class="comment">//</span>
04254     <span class="comment">// Set the translated req desc's ReqAlternative to NULL to indicated this</span>
04255     <span class="comment">// is not the original req desc.</span>
04256     <span class="comment">//</span>
04257 
04258     tReqDesc-&gt;ReqAlternative = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04259 
04260     tReqDesc-&gt;u.Translator = TranslatorEntry;
04261     tReqDesc-&gt;TranslatedReqDesc = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04262     arbiterEntry = &amp;tReqDesc-&gt;AlternativeTable;
04263     InitializeListHead(&amp;arbiterEntry-&gt;<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o0">ListEntry</a>);
04264     arbiterEntry-&gt;<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o1">AlternativeCount</a> = total;
04265     arbiterEntry-&gt;<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o2">Alternatives</a> = tIoDesc;
04266     arbiterEntry-&gt;<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o10">Assignment</a> = &amp;tReqDesc-&gt;Allocation;
04267 
04268     ioDesc = ReqDesc-&gt;AlternativeTable.Alternatives;
04269     <span class="keywordflow">for</span> (i = 0; i &lt; ReqDesc-&gt;AlternativeTable.AlternativeCount; i++) {
04270         <span class="keywordflow">if</span> (targetCount[i] != 0) {
04271             RtlMoveMemory(tIoDesc, target[i], targetCount[i] * <span class="keyword">sizeof</span>(IO_RESOURCE_DESCRIPTOR));
04272             tIoDesc += targetCount[i];
04273         } <span class="keywordflow">else</span> {
04274 
04275             <span class="comment">//</span>
04276             <span class="comment">// Make it become impossible to satisfy.</span>
04277             <span class="comment">//</span>
04278 
04279             RtlMoveMemory(tIoDesc, ioDesc, <span class="keyword">sizeof</span>(IO_RESOURCE_DESCRIPTOR));
04280             <span class="keywordflow">switch</span> (tIoDesc-&gt;Type) {
04281             <span class="keywordflow">case</span> CmResourceTypePort:
04282             <span class="keywordflow">case</span> CmResourceTypeMemory:
04283                 tIoDesc-&gt;u.Port.MinimumAddress.LowPart = 2;
04284                 tIoDesc-&gt;u.Port.MinimumAddress.HighPart = 0;
04285                 tIoDesc-&gt;u.Port.MaximumAddress.LowPart = 1;
04286                 tIoDesc-&gt;u.Port.MaximumAddress.HighPart = 0;
04287                 <span class="keywordflow">break</span>;
04288             <span class="keywordflow">case</span> CmResourceTypeBusNumber:
04289                 tIoDesc-&gt;u.BusNumber.MinBusNumber = 2;
04290                 tIoDesc-&gt;u.BusNumber.MaxBusNumber = 1;
04291                 <span class="keywordflow">break</span>;
04292 
04293             <span class="keywordflow">case</span> CmResourceTypeInterrupt:
04294                 tIoDesc-&gt;u.Interrupt.MinimumVector = 2;
04295                 tIoDesc-&gt;u.Interrupt.MaximumVector = 1;
04296                 <span class="keywordflow">break</span>;
04297 
04298             <span class="keywordflow">case</span> CmResourceTypeDma:
04299                 tIoDesc-&gt;u.Dma.MinimumChannel = 2;
04300                 tIoDesc-&gt;u.Dma.MaximumChannel = 1;
04301                 <span class="keywordflow">break</span>;
04302             <span class="keywordflow">default</span>:
04303                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(0);
04304                 <span class="keywordflow">break</span>;
04305             }
04306             tIoDesc += 1;
04307         }
04308         ioDesc++;
04309 
04310     }
04311 
04312 <span class="preprocessor">#if DBG</span>
04313 <span class="preprocessor"></span>    <span class="comment">//</span>
04314     <span class="comment">// Verify the adjusted resource descriptors are valid</span>
04315     <span class="comment">//</span>
04316 
04317     ioDesc = arbiterEntry-&gt;<a class="code" href="../../d0/d8/struct__ARBITER__LIST__ENTRY.html#o2">Alternatives</a>;
04318     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((ioDesc-&gt;Option &amp; IO_RESOURCE_ALTERNATIVE) == 0);
04319     ioDesc++;
04320     <span class="keywordflow">for</span> (i = 1; i &lt; total; i++) {
04321         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ioDesc-&gt;Option &amp; IO_RESOURCE_ALTERNATIVE);
04322         ioDesc++;
04323     }
04324 <span class="preprocessor">#endif</span>
04325 <span class="preprocessor"></span>    *TranslatedReqDesc = tReqDesc;
04326 <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>:
04327     <span class="keywordflow">for</span> (i = 0; i &lt; ReqDesc-&gt;AlternativeTable.AlternativeCount; i++) {
04328         <span class="keywordflow">if</span> (targetCount[i] != 0) {
04329             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(target[i]);
04330             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(target[i]);
04331         }
04332     }
04333     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(target);
04334     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(targetCount);
04335     <span class="keywordflow">return</span> returnStatus;
04336 }

</div></pre>    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a42" doxytag="pnpres.c::IopLegacyDeviceNode" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> <a class="el" href="../../d5/d1/pnpres_8c.html#a42">IopLegacyDeviceNode</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00239">239</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l05911">IopFindLegacyDeviceNode()</a>, and <a class="el" href="../../d6/d0/pnpres_8c-source.html#l06083">IopRemoveLegacyDeviceNode()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a46" doxytag="pnpres.c::IopWstrRaw" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> WCHAR <a class="el" href="../../d1/d8/report_8c.html#a1">IopWstrRaw</a>[]          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00259">259</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a45" doxytag="pnpres.c::IopWstrTranslated" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> WCHAR <a class="el" href="../../d1/d8/report_8c.html#a2">IopWstrTranslated</a>[]          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00258">258</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a37" doxytag="pnpres.c::PiActiveArbiterList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LIST_ENTRY <a class="el" href="../../d5/d1/pnpres_8c.html#a37">PiActiveArbiterList</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00234">234</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l02716">IopAddReqDescsToArbiters()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l03292">IopAssignInner()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l02554">IopPlacement()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l02649">IopPlacementForReservation()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l03376">IopReserve()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l02997">IopRestoreBestConfiguration()</a>, and <a class="el" href="../../d6/d0/pnpres_8c-source.html#l02906">IopSaveCurrentConfiguration()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a40" doxytag="pnpres.c::PiAssignTable" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d4/d1/struct__IOP__RESOURCE__REQUEST.html">PIOP_RESOURCE_REQUEST</a> <a class="el" href="../../d5/d1/pnpres_8c.html#a40">PiAssignTable</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00237">237</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l03292">IopAssignInner()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l05121">IopFindResourcesForArbiter()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l02845">IopIsBestConfiguration()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l02997">IopRestoreBestConfiguration()</a>, and <a class="el" href="../../d6/d0/pnpres_8c-source.html#l02906">IopSaveCurrentConfiguration()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a41" doxytag="pnpres.c::PiAssignTableCount" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d5/d1/pnpres_8c.html#a41">PiAssignTableCount</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00238">238</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l03292">IopAssignInner()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l05121">IopFindResourcesForArbiter()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l02845">IopIsBestConfiguration()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l02997">IopRestoreBestConfiguration()</a>, and <a class="el" href="../../d6/d0/pnpres_8c-source.html#l02906">IopSaveCurrentConfiguration()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a38" doxytag="pnpres.c::PiBestArbiterList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LIST_ENTRY <a class="el" href="../../d5/d1/pnpres_8c.html#a38">PiBestArbiterList</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00235">235</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l03292">IopAssignInner()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l03376">IopReserve()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l02997">IopRestoreBestConfiguration()</a>, and <a class="el" href="../../d6/d0/pnpres_8c-source.html#l02906">IopSaveCurrentConfiguration()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a39" doxytag="pnpres.c::PiBestPriority" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d5/d1/pnpres_8c.html#a39">PiBestPriority</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00236">236</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l03292">IopAssignInner()</a>, and <a class="el" href="../../d6/d0/pnpres_8c-source.html#l02845">IopIsBestConfiguration()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a43" doxytag="pnpres.c::PiNoRetest" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN <a class="el" href="../../d5/d1/pnpres_8c.html#a43">PiNoRetest</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00241">241</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l03084">IopAssign()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l03292">IopAssignInner()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l02845">IopIsBestConfiguration()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l02997">IopRestoreBestConfiguration()</a>, and <a class="el" href="../../d6/d0/pnpres_8c-source.html#l02906">IopSaveCurrentConfiguration()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a44" doxytag="pnpres.c::PiUseTimeout" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN <a class="el" href="../../d5/d1/pnpres_8c.html#a44">PiUseTimeout</a> = TRUE          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00245">245</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l03084">IopAssign()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a47" doxytag="pnpres.c::PnpResDebugLevel" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d5/d1/pnpres_8c.html#a47">PnpResDebugLevel</a> = 0          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00273">273</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l03292">IopAssignInner()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l02320">IopBuildCmResourceLists()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l03933">IopChildToRootTranslation()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l01066">IopGetResourceRequirementsForAssignTable()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l08336">IopQueryConflictListInternal()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l05215">IopRebalance()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l03376">IopReserve()</a>, <a class="el" href="../../d6/d0/pnpres_8c-source.html#l06996">IopReserveLegacyBootResources()</a>, and <a class="el" href="../../d6/d0/pnpres_8c-source.html#l01267">IopResourceRequirementsListToReqList()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a50" doxytag="pnpres.c::PnpResDebugTranslationFailure" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d3/d5/structPNPRESDEBUGTRANSLATIONFAILURE.html">PNPRESDEBUGTRANSLATIONFAILURE</a>* <a class="el" href="../../d5/d1/pnpres_8c.html#a50">PnpResDebugTranslationFailure</a> = <a class="el" href="../../d5/d1/pnpres_8c.html#a49">PnpResDebugTranslationFailureArray</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00287">287</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l03933">IopChildToRootTranslation()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a49" doxytag="pnpres.c::PnpResDebugTranslationFailureArray" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d3/d5/structPNPRESDEBUGTRANSLATIONFAILURE.html">PNPRESDEBUGTRANSLATIONFAILURE</a> <a class="el" href="../../d5/d1/pnpres_8c.html#a49">PnpResDebugTranslationFailureArray</a>[32]          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00286">286</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a48" doxytag="pnpres.c::PnpResDebugTranslationFailureCount" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d5/d1/pnpres_8c.html#a48">PnpResDebugTranslationFailureCount</a> = 32          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/pnpres_8c-source.html#l00285">285</a> of file <a class="el" href="../../d6/d0/pnpres_8c-source.html">pnpres.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/pnpres_8c-source.html#l03933">IopChildToRootTranslation()</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:45:15 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
