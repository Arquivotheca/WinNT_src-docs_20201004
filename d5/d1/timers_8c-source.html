<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: timers.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>timers.c</h1><a href="../../d4/d2/timers_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/****************************** Module Header ******************************\</span>
00002 <span class="comment">* Module Name: timers.c</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00005 <span class="comment">*</span>
00006 <span class="comment">* This module contains the user timer APIs and support routines.</span>
00007 <span class="comment">*</span>
00008 <span class="comment">* History:</span>
00009 <span class="comment">* 12-Nov-1990 DarrinM   Created.</span>
00010 <span class="comment">* 08-Apr-1992 DarrinM   Switched to PM/Win3-like ScanTimers model.</span>
00011 <span class="comment">\***************************************************************************/</span>
00012 
<a name="l00013"></a><a class="code" href="../../d4/d2/timers_8c.html#a0">00013</a> <span class="preprocessor">#define _TIMERS 1      // uses a LARGE_INTEGER</span>
00014 <span class="preprocessor"></span><span class="preprocessor">#include "<a class="code" href="../../d0/d4/w32_2ntuser_2kernel_2precomp_8h.html">precomp.h</a>"</span>
00015 <span class="preprocessor">#pragma hdrstop</span>
00016 <span class="preprocessor"></span>
00017 
00018 <span class="comment">/*</span>
00019 <span class="comment"> * Make sure that if we return a timer id that it is a WORD value. This</span>
00020 <span class="comment"> * will ensure that WOW doesn't need to handle-translate return values</span>
00021 <span class="comment"> * from SetTimer().</span>
00022 <span class="comment"> *</span>
00023 <span class="comment"> * Start with a large number so that FindTimer() doesn't find a timer we</span>
00024 <span class="comment"> * calculated with a low cTimerId if the app happens to pass in NULL pwnd</span>
00025 <span class="comment"> * and a low id (like 1).</span>
00026 <span class="comment"> */</span>
<a name="l00027"></a><a class="code" href="../../d4/d2/timers_8c.html#a1">00027</a> <span class="preprocessor">#define TIMERID_MAX   0x7FFF</span>
<a name="l00028"></a><a class="code" href="../../d4/d2/timers_8c.html#a2">00028</a> <span class="preprocessor"></span><span class="preprocessor">#define TIMERID_MIN   0x100</span>
00029 <span class="preprocessor"></span>
<a name="l00030"></a><a class="code" href="../../d4/d2/timers_8c.html#a3">00030</a> <span class="preprocessor">#define ELAPSED_MAX  0x7FFFFFFF</span>
00031 <span class="preprocessor"></span>
<a name="l00032"></a><a class="code" href="../../d4/d2/timers_8c.html#a4">00032</a> <span class="preprocessor">#define SYSRIT_TIMER  (TMRF_SYSTEM | TMRF_RIT)</span>
00033 <span class="preprocessor"></span>
<a name="l00034"></a><a class="code" href="../../d4/d2/timers_8c.html#a5">00034</a> WORD <a class="code" href="../../d4/d2/timers_8c.html#a5">cTimerId</a> = <a class="code" href="../../d4/d2/timers_8c.html#a1">TIMERID_MAX</a>;
00035 
00036 <span class="comment">/***************************************************************************\</span>
00037 <span class="comment">* _SetTimer (API)</span>
00038 <span class="comment">*</span>
00039 <span class="comment">* This API will start the specified timer.</span>
00040 <span class="comment">*</span>
00041 <span class="comment">* History:</span>
00042 <span class="comment">* 15-Nov-1990 DavidPe   Created.</span>
00043 <span class="comment">\***************************************************************************/</span>
00044 
<a name="l00045"></a><a class="code" href="../../d4/d1/userk_8h.html#a1241">00045</a> UINT_PTR <a class="code" href="../../d4/d1/userk_8h.html#a1241">_SetTimer</a>(
00046     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>         pwnd,
00047     UINT_PTR     nIDEvent,
00048     UINT         dwElapse,
00049     TIMERPROC_PWND pTimerFunc)
00050 {
00051     <span class="comment">/*</span>
00052 <span class="comment">     * Prevent apps from setting a Timer with a window proc to another app</span>
00053 <span class="comment">     */</span>
00054     <span class="keywordflow">if</span> (pwnd &amp;&amp; (<a class="code" href="../../d4/d1/userk_8h.html#a16">PpiCurrent</a>() != <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd)-&gt;ppi)) {
00055 
00056         RIPERR1(ERROR_ACCESS_DENIED,
00057                 RIP_WARNING,
00058                 <span class="stringliteral">"Calling SetTimer with window of another process %lX"</span>,
00059                 pwnd);
00060 
00061         <span class="keywordflow">return</span> 0;
00062     }
00063 
00064     <span class="keywordflow">return</span> <a class="code" href="../../d4/d1/userk_8h.html#a1044">InternalSetTimer</a>(pwnd, nIDEvent, dwElapse, pTimerFunc, 0);
00065 }
00066 
00067 <span class="comment">/***************************************************************************\</span>
00068 <span class="comment">* _SetSystemTimer</span>
00069 <span class="comment">*</span>
00070 <span class="comment">* This API will start start a system timer which will generate WM_SYSTIMER</span>
00071 <span class="comment">* messages rather than WM_TIMER</span>
00072 <span class="comment">*</span>
00073 <span class="comment">* History:</span>
00074 <span class="comment">* 15-Nov-1990 DavidPe   Created.</span>
00075 <span class="comment">* 21-Jan-1991 IanJa     Prefix '_' denotes export function (not API)</span>
00076 <span class="comment">\***************************************************************************/</span>
00077 
<a name="l00078"></a><a class="code" href="../../d4/d1/userk_8h.html#a1894">00078</a> UINT_PTR <a class="code" href="../../d4/d1/userk_8h.html#a1894">_SetSystemTimer</a>(
00079     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>         pwnd,
00080     UINT_PTR     nIDEvent,
00081     DWORD        dwElapse,
00082     TIMERPROC_PWND pTimerFunc)
00083 {
00084     <span class="comment">/*</span>
00085 <span class="comment">     * Prevent apps from setting a Timer with a window proc to another app</span>
00086 <span class="comment">     */</span>
00087     <span class="keywordflow">if</span> (pwnd &amp;&amp; <a class="code" href="../../d4/d1/userk_8h.html#a16">PpiCurrent</a>() != <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd)-&gt;ppi) {
00088 
00089         RIPERR1(ERROR_ACCESS_DENIED,
00090                 RIP_WARNING,
00091                 <span class="stringliteral">"Calling SetSystemTimer with window of another process %lX"</span>,
00092                 pwnd);
00093 
00094         <span class="keywordflow">return</span> 0;
00095     }
00096 
00097     <span class="keywordflow">return</span> <a class="code" href="../../d4/d1/userk_8h.html#a1044">InternalSetTimer</a>(pwnd, nIDEvent, dwElapse, pTimerFunc, TMRF_SYSTEM);
00098 }
00099 
00100 <span class="comment">/***************************************************************************\</span>
00101 <span class="comment">* FreeTimer</span>
00102 <span class="comment">*</span>
00103 <span class="comment">* This function does the actual unlinking and freeing of the timer structure.</span>
00104 <span class="comment">* I pulled it out of FindTimer() so it could be shared with DestroyQueues-</span>
00105 <span class="comment">* Timers.</span>
00106 <span class="comment">* Sets *pptmr to point to the next TIMER struct (NULL if none)</span>
00107 <span class="comment">*</span>
00108 <span class="comment">* History:</span>
00109 <span class="comment">* 15-Feb-1991 DarrinM   Pulled from FindTimer().</span>
00110 <span class="comment">\***************************************************************************/</span>
00111 
<a name="l00112"></a><a class="code" href="../../d4/d1/userk_8h.html#a1045">00112</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a1045">FreeTimer</a>(
00113     <a class="code" href="../../d4/d8/structtagTIMER.html">PTIMER</a> ptmr) {
00114 
00115     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
00116 
00117     <span class="comment">/*</span>
00118 <span class="comment">     * Mark it for destruction.  If it the object is locked it can't</span>
00119 <span class="comment">     * be freed right now.</span>
00120 <span class="comment">     */</span>
00121     <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/userk_8h.html#a971">HMMarkObjectDestroy</a>((PVOID)ptmr))
00122         <span class="keywordflow">return</span>;
00123 
00124     <span class="comment">/*</span>
00125 <span class="comment">     * If this timer was just about to be processed, decrement</span>
00126 <span class="comment">     * the ready-count since we're blowing it off.</span>
00127 <span class="comment">     */</span>
00128     <span class="keywordflow">if</span> (ptmr-&gt;flags &amp; TMRF_READY)
00129         <a class="code" href="../../d4/d1/userk_8h.html#a1244">DecTimerCount</a>(ptmr-&gt;pti);
00130 
00131     <span class="comment">/*</span>
00132 <span class="comment">     * Unlock the window</span>
00133 <span class="comment">     */</span>
00134     <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>(&amp;ptmr-&gt;spwnd);
00135 
00136     <span class="comment">/*</span>
00137 <span class="comment">     * Unlink this timer</span>
00138 <span class="comment">     */</span>
00139     <span class="keywordflow">if</span> (ptmr-&gt;ptmrPrev) {
00140         ptmr-&gt;ptmrPrev-&gt;ptmrNext = ptmr-&gt;ptmrNext;
00141     } <span class="keywordflow">else</span> {
00142         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a247">gptmrFirst</a> = ptmr-&gt;<a class="code" href="../../d4/d8/structtagTIMER.html#o1">ptmrNext</a>;
00143     }
00144 
00145     <span class="keywordflow">if</span> (ptmr-&gt;ptmrNext) {
00146         ptmr-&gt;<a class="code" href="../../d4/d8/structtagTIMER.html#o1">ptmrNext</a>-&gt;<a class="code" href="../../d4/d8/structtagTIMER.html#o2">ptmrPrev</a> = ptmr-&gt;<a class="code" href="../../d4/d8/structtagTIMER.html#o2">ptmrPrev</a>;
00147     }
00148 
00149     <span class="comment">/*</span>
00150 <span class="comment">     * Free up the TIMER structure.</span>
00151 <span class="comment">     */</span>
00152     <a class="code" href="../../d4/d1/userk_8h.html#a970">HMFreeObject</a>((PVOID)ptmr);
00153 }
00154 
00155 
00156 <span class="comment">/***************************************************************************\</span>
00157 <span class="comment">* FindTimer</span>
00158 <span class="comment">*</span>
00159 <span class="comment">* This function will find a timer that matches the parameters.  We also</span>
00160 <span class="comment">* deal with killing timers here since it's easier to remove items from</span>
00161 <span class="comment">* the list while we're scanning it.</span>
00162 <span class="comment">*</span>
00163 <span class="comment">* History:</span>
00164 <span class="comment">* 15-Nov-1990 DavidPe   Created.</span>
00165 <span class="comment">\***************************************************************************/</span>
00166 
<a name="l00167"></a><a class="code" href="../../d4/d1/userk_8h.html#a1721">00167</a> <a class="code" href="../../d4/d8/structtagTIMER.html">PTIMER</a> <a class="code" href="../../d4/d1/userk_8h.html#a1721">FindTimer</a>(
00168     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd,
00169     UINT_PTR nID,
00170     UINT flags,
00171     BOOL fKill)
00172 {
00173     <a class="code" href="../../d4/d8/structtagTIMER.html">PTIMER</a> ptmr;
00174 
00175     ptmr = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a247">gptmrFirst</a>;
00176 
00177     <span class="keywordflow">while</span> (ptmr != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00178 
00179         <span class="comment">/*</span>
00180 <span class="comment">         * Is this the timer we're looking for?</span>
00181 <span class="comment">         */</span>
00182         <span class="keywordflow">if</span> ((ptmr-&gt;<a class="code" href="../../d4/d8/structtagTIMER.html#o4">spwnd</a> == pwnd) &amp;&amp;
00183             (ptmr-&gt;<a class="code" href="../../d4/d8/structtagTIMER.html#o5">nID</a> == nID)    &amp;&amp;
00184             (ptmr-&gt;<a class="code" href="../../d4/d8/structtagTIMER.html#o8">flags</a> &amp; <a class="code" href="../../d4/d2/timers_8c.html#a4">SYSRIT_TIMER</a>) == (flags &amp; <a class="code" href="../../d4/d2/timers_8c.html#a4">SYSRIT_TIMER</a>)) {
00185 
00186             <span class="comment">/*</span>
00187 <span class="comment">             * Are we being called from KillTimer()? If so, destroy the</span>
00188 <span class="comment">             * timer.  return != 0 because *pptmr is gone.</span>
00189 <span class="comment">             */</span>
00190             <span class="keywordflow">if</span> (fKill) {
00191                 <a class="code" href="../../d4/d1/userk_8h.html#a1045">FreeTimer</a>(ptmr);
00192                 <span class="keywordflow">return</span> (<a class="code" href="../../d4/d8/structtagTIMER.html">PTIMER</a>)<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00193             }
00194 
00195             <span class="comment">/*</span>
00196 <span class="comment">             * Found the timer, break out of the loop.</span>
00197 <span class="comment">             */</span>
00198             <span class="keywordflow">break</span>;
00199         }
00200 
00201         <span class="comment">/*</span>
00202 <span class="comment">         * No, try the next one.</span>
00203 <span class="comment">         */</span>
00204         ptmr = ptmr-&gt;<a class="code" href="../../d4/d8/structtagTIMER.html#o1">ptmrNext</a>;
00205     }
00206 
00207     <span class="keywordflow">return</span> ptmr;
00208 }
00209 
00210 <span class="comment">/***************************************************************************\</span>
00211 <span class="comment">* InternalSetTimer</span>
00212 <span class="comment">*</span>
00213 <span class="comment">* This is the guts of SetTimer that actually gets things going.</span>
00214 <span class="comment">*</span>
00215 <span class="comment">* NOTE (darrinm): Technically there is a bit of latency (the time it takes</span>
00216 <span class="comment">* between SetTimer's NtSetEvent and when the RIT wakes up and calls ScanTimers)</span>
00217 <span class="comment">* between when SetTimer is called and when the counter starts counting down.</span>
00218 <span class="comment">* This is uncool but it should be a very short amount of time because the RIT</span>
00219 <span class="comment">* is high-priority.  If it becomes a problem I know how to fix it.</span>
00220 <span class="comment">*</span>
00221 <span class="comment">* History:</span>
00222 <span class="comment">* 15-Nov-1990 DavidPe      Created.</span>
00223 <span class="comment">\***************************************************************************/</span>
00224 
<a name="l00225"></a><a class="code" href="../../d4/d1/userk_8h.html#a1044">00225</a> UINT_PTR <a class="code" href="../../d4/d1/userk_8h.html#a1044">InternalSetTimer</a>(
00226     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>         pwnd,
00227     UINT_PTR     nIDEvent,
00228     UINT         dwElapse,
00229     TIMERPROC_PWND pTimerFunc,
00230     UINT         flags)
00231 {
00232     LARGE_INTEGER liT = {1, 0};
00233     <a class="code" href="../../d4/d8/structtagTIMER.html">PTIMER</a>        ptmr;
00234     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a>   ptiCurrent;
00235 
00236     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
00237 
00238     <span class="comment">/*</span>
00239 <span class="comment">     * Assert if someone tries to set a timer after InitiateWin32kCleanup</span>
00240 <span class="comment">     * killed the RIT.</span>
00241 <span class="comment">     */</span>
00242     UserAssert(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a175">gptiRit</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00243     
00244     <span class="comment">/*</span>
00245 <span class="comment">     * 1.0 compatibility weirdness. Also, don't allow negative elapse times</span>
00246 <span class="comment">     * because this'll cause ScanTimers() to generate negative elapse times</span>
00247 <span class="comment">     * between timers.</span>
00248 <span class="comment">     */</span>
00249     <span class="keywordflow">if</span> ((dwElapse == 0) || (dwElapse &gt; <a class="code" href="../../d4/d2/timers_8c.html#a3">ELAPSED_MAX</a>))
00250         dwElapse = 1;
00251 
00252     <span class="comment">/*</span>
00253 <span class="comment">     * Attempt to first locate the timer, then create a new one</span>
00254 <span class="comment">     * if one isn't found.</span>
00255 <span class="comment">     */</span>
00256     <span class="keywordflow">if</span> ((ptmr = <a class="code" href="../../d4/d1/userk_8h.html#a1721">FindTimer</a>(pwnd, nIDEvent, flags, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00257 
00258         <span class="comment">/*</span>
00259 <span class="comment">         * Not found.  Create a new one.</span>
00260 <span class="comment">         */</span>
00261         ptmr = (<a class="code" href="../../d4/d8/structtagTIMER.html">PTIMER</a>)<a class="code" href="../../d4/d1/userk_8h.html#a969">HMAllocObject</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a252">TYPE_TIMER</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d8/structtagTIMER.html">TIMER</a>));
00262         <span class="keywordflow">if</span> (ptmr == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00263             <span class="keywordflow">return</span> 0;
00264         }
00265 
00266         ptmr-&gt;<a class="code" href="../../d4/d8/structtagTIMER.html#o4">spwnd</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00267 
00268         <span class="keywordflow">if</span> (pwnd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00269 
00270             WORD timerIdInitial = <a class="code" href="../../d4/d2/timers_8c.html#a5">cTimerId</a>;
00271 
00272             <span class="comment">/*</span>
00273 <span class="comment">             * Pick a unique, unused timer ID.</span>
00274 <span class="comment">             */</span>
00275             <span class="keywordflow">do</span> {
00276 
00277                 <span class="keywordflow">if</span> (--<a class="code" href="../../d4/d2/timers_8c.html#a5">cTimerId</a> &lt;= <a class="code" href="../../d4/d2/timers_8c.html#a2">TIMERID_MIN</a>)
00278                     <a class="code" href="../../d4/d2/timers_8c.html#a5">cTimerId</a> = <a class="code" href="../../d4/d2/timers_8c.html#a1">TIMERID_MAX</a>;
00279 
00280                 <span class="keywordflow">if</span> (<a class="code" href="../../d4/d2/timers_8c.html#a5">cTimerId</a> == timerIdInitial) {
00281 
00282                     <span class="comment">/*</span>
00283 <span class="comment">                     * Flat out of timers bud.</span>
00284 <span class="comment">                     */</span>
00285                     <a class="code" href="../../d4/d1/userk_8h.html#a970">HMFreeObject</a>(ptmr);
00286                     <span class="keywordflow">return</span> 0;
00287                 }
00288 
00289             } <span class="keywordflow">while</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1721">FindTimer</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d2/timers_8c.html#a5">cTimerId</a>, flags, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00290 
00291             ptmr-&gt;<a class="code" href="../../d4/d8/structtagTIMER.html#o5">nID</a> = (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)<a class="code" href="../../d4/d2/timers_8c.html#a5">cTimerId</a>;
00292 
00293         } <span class="keywordflow">else</span> {
00294             ptmr-&gt;<a class="code" href="../../d4/d8/structtagTIMER.html#o5">nID</a> = nIDEvent;
00295         }
00296 
00297         <span class="comment">/*</span>
00298 <span class="comment">         * Link the new timer into the front of the list.</span>
00299 <span class="comment">         * Handily this works even when gptmrFirst is NULL.</span>
00300 <span class="comment">         */</span>
00301         ptmr-&gt;<a class="code" href="../../d4/d8/structtagTIMER.html#o1">ptmrNext</a> = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a247">gptmrFirst</a>;
00302         ptmr-&gt;<a class="code" href="../../d4/d8/structtagTIMER.html#o2">ptmrPrev</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00303         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a247">gptmrFirst</a>)
00304             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a247">gptmrFirst</a>-&gt;<a class="code" href="../../d4/d8/structtagTIMER.html#o2">ptmrPrev</a> = ptmr;
00305         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a247">gptmrFirst</a> = ptmr;
00306 
00307     } <span class="keywordflow">else</span> {
00308 
00309         <span class="comment">/*</span>
00310 <span class="comment">         * If this timer was just about to be processed,</span>
00311 <span class="comment">         * decrement cTimersReady since we're resetting it.</span>
00312 <span class="comment">         */</span>
00313         <span class="keywordflow">if</span> (ptmr-&gt;<a class="code" href="../../d4/d8/structtagTIMER.html#o8">flags</a> &amp; TMRF_READY)
00314             <a class="code" href="../../d4/d1/userk_8h.html#a1244">DecTimerCount</a>(ptmr-&gt;<a class="code" href="../../d4/d8/structtagTIMER.html#o3">pti</a>);
00315     }
00316 
00317     <span class="comment">/*</span>
00318 <span class="comment">     * If pwnd is NULL, create a unique id by</span>
00319 <span class="comment">     * using the timer handle.  RIT timers are 'owned' by the RIT pti</span>
00320 <span class="comment">     * so they are not deleted when the creating pti dies.</span>
00321 <span class="comment">     *</span>
00322 <span class="comment">     * We used to record the pti as the pti of the window if one was</span>
00323 <span class="comment">     * specified.  This is not what Win 3.1 does and it broke 10862</span>
00324 <span class="comment">     * where some merge app was setting the timer on winword's window</span>
00325 <span class="comment">     * it it still expected to get the messages not winword.</span>
00326 <span class="comment">     *</span>
00327 <span class="comment">     * MS Visual C NT was counting on this bug in the NT 3.1 so if</span>
00328 <span class="comment">     * a thread sets a timer for a window in another thread in the</span>
00329 <span class="comment">     * same process the timer goes off in the thread of the window.</span>
00330 <span class="comment">     * You can see this by doing a build in msvcnt and the files being</span>
00331 <span class="comment">     * compiled do not show up.</span>
00332 <span class="comment">     */</span>
00333     ptiCurrent = (<a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a>)(W32GetCurrentThread()); <span class="comment">/*</span>
00334 <span class="comment">                                                        * This will be NULL</span>
00335 <span class="comment">                                                        * for a non-GUI thread.</span>
00336 <span class="comment">                                                        */</span>
00337 
00338     <span class="keywordflow">if</span> (pwnd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00339 
00340         <span class="keywordflow">if</span> (flags &amp; TMRF_RIT) {
00341             ptmr-&gt;<a class="code" href="../../d4/d8/structtagTIMER.html#o3">pti</a> = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a175">gptiRit</a>;
00342         } <span class="keywordflow">else</span> {
00343             ptmr-&gt;<a class="code" href="../../d4/d8/structtagTIMER.html#o3">pti</a> = ptiCurrent;
00344             UserAssert(ptiCurrent);
00345         }
00346 
00347     } <span class="keywordflow">else</span> {
00348 
00349         <span class="comment">/*</span>
00350 <span class="comment">         * As enforced in the API wrappers.  We shouldn't get here</span>
00351 <span class="comment">         * any other way for an app timer.</span>
00352 <span class="comment">         *</span>
00353 <span class="comment">         * Always use pti of the window when TMRF_PTIWINDOW is passed in.</span>
00354 <span class="comment">         */</span>
00355         <span class="keywordflow">if</span> ((ptiCurrent-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o9">TIF_flags</a> &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a796">TIF_16BIT</a>) &amp;&amp; !(flags &amp; TMRF_PTIWINDOW)) {
00356             ptmr-&gt;<a class="code" href="../../d4/d8/structtagTIMER.html#o3">pti</a> = ptiCurrent;
00357             UserAssert(ptiCurrent);
00358         } <span class="keywordflow">else</span> {
00359             ptmr-&gt;<a class="code" href="../../d4/d8/structtagTIMER.html#o3">pti</a> = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd);
00360         }
00361     }
00362 
00363     <span class="comment">/*</span>
00364 <span class="comment">     * Initialize the timer-struct.</span>
00365 <span class="comment">     *</span>
00366 <span class="comment">     * NOTE: The ptiOptCreator is used to identify a JOURNAL-timer.  We</span>
00367 <span class="comment">     *       want to allow these timers to be destroyed when the creator</span>
00368 <span class="comment">     *       thread goes away.  For other threads that create timers across</span>
00369 <span class="comment">     *       threads, we do not want to destroy these timers when the</span>
00370 <span class="comment">     *       creator goes away.  Currently, we're only checking for a</span>
00371 <span class="comment">     *       TMRF_RIT.  However, in the future we might want to add this</span>
00372 <span class="comment">     *       same check for TMRF_SYSTEM.</span>
00373 <span class="comment">     */</span>
00374     <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>(&amp;(ptmr-&gt;<a class="code" href="../../d4/d8/structtagTIMER.html#o4">spwnd</a>), pwnd);
00375 
00376     ptmr-&gt;<a class="code" href="../../d4/d8/structtagTIMER.html#o6">cmsCountdown</a>  = ptmr-&gt;<a class="code" href="../../d4/d8/structtagTIMER.html#o7">cmsRate</a> = dwElapse;
00377     ptmr-&gt;<a class="code" href="../../d4/d8/structtagTIMER.html#o8">flags</a>         = flags | TMRF_INIT;
00378     ptmr-&gt;<a class="code" href="../../d4/d8/structtagTIMER.html#o9">pfn</a>           = pTimerFunc;
00379     ptmr-&gt;<a class="code" href="../../d4/d8/structtagTIMER.html#o10">ptiOptCreator</a> = (flags &amp; TMRF_RIT ? ptiCurrent : <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00380 
00381     <span class="comment">/*</span>
00382 <span class="comment">     * Force the RIT to scan timers.</span>
00383 <span class="comment">     *</span>
00384 <span class="comment">     * N.B. The following code sets the raw input thread timer to expire</span>
00385 <span class="comment">     *      at the absolute time 1 which is very far into the past. This</span>
00386 <span class="comment">     *      causes the timer to immediately expire before the set timer</span>
00387 <span class="comment">     *      call returns.</span>
00388 <span class="comment">     */</span>
00389     <span class="keywordflow">if</span> (ptiCurrent == <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a175">gptiRit</a>) {
00390         <span class="comment">/*</span>
00391 <span class="comment">         * Don't let RIT timer loop reset the master timer - we already have.</span>
00392 <span class="comment">         */</span>
00393         <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a251">gbMasterTimerSet</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00394     }
00395 
00396     UserAssert(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a248">gptmrMaster</a>);
00397     <a class="code" href="../../d3/d2/timerobj_8c.html#a6">KeSetTimer</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a248">gptmrMaster</a>, liT, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00398 
00399     <span class="comment">/*</span>
00400 <span class="comment">     * Windows 3.1 returns the timer ID if non-zero, otherwise it returns 1.</span>
00401 <span class="comment">     */</span>
00402     <span class="keywordflow">return</span> (ptmr-&gt;<a class="code" href="../../d4/d8/structtagTIMER.html#o5">nID</a> == 0 ? 1 : ptmr-&gt;<a class="code" href="../../d4/d8/structtagTIMER.html#o5">nID</a>);
00403 }
00404 
00405 <span class="comment">/***************************************************************************\</span>
00406 <span class="comment">* _KillTimer (API)</span>
00407 <span class="comment">*</span>
00408 <span class="comment">* This API will stop a timer from sending WM_TIMER messages.</span>
00409 <span class="comment">*</span>
00410 <span class="comment">* History:</span>
00411 <span class="comment">* 15-Nov-1990 DavidPe   Created.</span>
00412 <span class="comment">\***************************************************************************/</span>
00413 
<a name="l00414"></a><a class="code" href="../../d4/d1/userk_8h.html#a1720">00414</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1720">_KillTimer</a>(
00415     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd,
00416     UINT_PTR nIDEvent)
00417 {
00418     <span class="keywordflow">return</span> <a class="code" href="../../d4/d1/userk_8h.html#a1242">KillTimer2</a>(pwnd, nIDEvent, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00419 }
00420 
00421 <span class="comment">/***************************************************************************\</span>
00422 <span class="comment">* _KillSystemTimer</span>
00423 <span class="comment">*</span>
00424 <span class="comment">* This API will stop a system timer from sending WM_SYSTIMER messages.</span>
00425 <span class="comment">*</span>
00426 <span class="comment">* History:</span>
00427 <span class="comment">* 15-Nov-1990 DavidPe   Created.</span>
00428 <span class="comment">* 21-Jan-1991 IanJa     Prefix '_' denotes export function (not API)</span>
00429 <span class="comment">\***************************************************************************/</span>
00430 
<a name="l00431"></a><a class="code" href="../../d4/d1/userk_8h.html#a1567">00431</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1567">_KillSystemTimer</a>(
00432     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd,
00433     UINT_PTR nIDEvent)
00434 {
00435     <span class="keywordflow">return</span> <a class="code" href="../../d4/d1/userk_8h.html#a1242">KillTimer2</a>(pwnd, nIDEvent, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00436 }
00437 
00438 <span class="comment">/***************************************************************************\</span>
00439 <span class="comment">* KillTimer2</span>
00440 <span class="comment">*</span>
00441 <span class="comment">* This is the guts of KillTimer that actually kills the timer.</span>
00442 <span class="comment">*</span>
00443 <span class="comment">* History:</span>
00444 <span class="comment">* 15-Nov-1990 DavidPe       Created.</span>
00445 <span class="comment">\***************************************************************************/</span>
00446 
<a name="l00447"></a><a class="code" href="../../d4/d1/userk_8h.html#a1242">00447</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1242">KillTimer2</a>(
00448     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd,
00449     UINT_PTR nIDEvent,
00450     BOOL fSystemTimer)
00451 {
00452     <span class="comment">/*</span>
00453 <span class="comment">     * Call FindTimer() with fKill == TRUE.  This will</span>
00454 <span class="comment">     * basically delete the timer.</span>
00455 <span class="comment">     */</span>
00456     <span class="keywordflow">return</span> (<a class="code" href="../../d4/d1/userk_8h.html#a1721">FindTimer</a>(pwnd,
00457                       nIDEvent,
00458                       (fSystemTimer ? TMRF_SYSTEM : 0),
00459                       <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00460 }
00461 
00462 <span class="comment">/***************************************************************************\</span>
00463 <span class="comment">* DestroyQueuesTimers</span>
00464 <span class="comment">*</span>
00465 <span class="comment">* This function scans through all the timers and destroys any that are</span>
00466 <span class="comment">* associated with the specified queue.</span>
00467 <span class="comment">*</span>
00468 <span class="comment">* History:</span>
00469 <span class="comment">* 15-Feb-1991 DarrinM   Created.</span>
00470 <span class="comment">\***************************************************************************/</span>
00471 
<a name="l00472"></a><a class="code" href="../../d4/d1/userk_8h.html#a1243">00472</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a1243">DestroyThreadsTimers</a>(
00473     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti)
00474 {
00475     <a class="code" href="../../d4/d8/structtagTIMER.html">PTIMER</a> ptmr;
00476 
00477     ptmr = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a247">gptmrFirst</a>;
00478 
00479     <span class="keywordflow">while</span> (ptmr != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00480 
00481         <span class="comment">/*</span>
00482 <span class="comment">         * Is this one of the timers we're looking for?  If so, destroy it.</span>
00483 <span class="comment">         */</span>
00484         <span class="keywordflow">if</span> (ptmr-&gt;<a class="code" href="../../d4/d8/structtagTIMER.html#o3">pti</a> == pti || ptmr-&gt;<a class="code" href="../../d4/d8/structtagTIMER.html#o10">ptiOptCreator</a> == pti) {
00485             <a class="code" href="../../d4/d8/structtagTIMER.html">PTIMER</a> ptmrNext = ptmr-&gt;<a class="code" href="../../d4/d8/structtagTIMER.html#o1">ptmrNext</a>;
00486             <a class="code" href="../../d4/d1/userk_8h.html#a1045">FreeTimer</a>(ptmr);
00487             ptmr = ptmrNext;
00488         } <span class="keywordflow">else</span> {
00489             ptmr = ptmr-&gt;<a class="code" href="../../d4/d8/structtagTIMER.html#o1">ptmrNext</a>;
00490         }
00491     }
00492 }
00493 
00494 <span class="comment">/***************************************************************************\</span>
00495 <span class="comment">* DestroyWindowsTimers</span>
00496 <span class="comment">*</span>
00497 <span class="comment">* This function scans through all the timers and destroys any that are</span>
00498 <span class="comment">* associated with the specified window.</span>
00499 <span class="comment">*</span>
00500 <span class="comment">* History:</span>
00501 <span class="comment">* 04-Jun-1991 DarrinM       Created.</span>
00502 <span class="comment">\***************************************************************************/</span>
00503 
<a name="l00504"></a><a class="code" href="../../d4/d1/userk_8h.html#a1479">00504</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a1479">DestroyWindowsTimers</a>(
00505     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd)
00506 {
00507     <a class="code" href="../../d4/d8/structtagTIMER.html">PTIMER</a> ptmr;
00508 
00509     ptmr = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a247">gptmrFirst</a>;
00510 
00511     <span class="keywordflow">while</span> (ptmr != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00512 
00513         <span class="comment">/*</span>
00514 <span class="comment">         * Is this one of the timers we're looking for?  If so, destroy it.</span>
00515 <span class="comment">         */</span>
00516         <span class="keywordflow">if</span> (ptmr-&gt;<a class="code" href="../../d4/d8/structtagTIMER.html#o4">spwnd</a> == pwnd) {
00517             <a class="code" href="../../d4/d8/structtagTIMER.html">PTIMER</a> ptmrNext = ptmr-&gt;<a class="code" href="../../d4/d8/structtagTIMER.html#o1">ptmrNext</a>;
00518             <a class="code" href="../../d4/d1/userk_8h.html#a1045">FreeTimer</a>(ptmr);
00519             ptmr = ptmrNext;
00520         } <span class="keywordflow">else</span> {
00521             ptmr = ptmr-&gt;<a class="code" href="../../d4/d8/structtagTIMER.html#o1">ptmrNext</a>;
00522         }
00523     }
00524 }
00525 
00526 <span class="comment">/***************************************************************************\</span>
00527 <span class="comment">* DoTimer</span>
00528 <span class="comment">*</span>
00529 <span class="comment">* This function gets called from xxxPeekMessage() if the QS_TIMER bit is</span>
00530 <span class="comment">* set.  If this timer is okay with the filter specified the appropriate</span>
00531 <span class="comment">* WM_*TIMER message will be placed in 'pmsg' and the timer will be reset.</span>
00532 <span class="comment">*</span>
00533 <span class="comment">* History:</span>
00534 <span class="comment">* 15-Nov-1990 DavidPe   Created.</span>
00535 <span class="comment">* 27-NOv-1991 DavidPe   Changed to move 'found' timers to end of list.</span>
00536 <span class="comment">\***************************************************************************/</span>
00537 
<a name="l00538"></a><a class="code" href="../../d4/d1/userk_8h.html#a1219">00538</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1219">DoTimer</a>(
00539     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndFilter)
00540 {
00541     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti;
00542     <a class="code" href="../../d4/d8/structtagTIMER.html">PTIMER</a>      ptmr;
00543     <a class="code" href="../../d4/d8/structtagTIMER.html">PTIMER</a>      ptmrNext;
00544     <a class="code" href="../../d8/d4/structtagQMSG.html">PQMSG</a>       pqmsg;
00545 
00546     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
00547 
00548     pti = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
00549 
00550     <span class="comment">/*</span>
00551 <span class="comment">     * Search for a timer that belongs to this queue.</span>
00552 <span class="comment">     */</span>
00553     ptmr = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a247">gptmrFirst</a>;
00554 
00555     <span class="keywordflow">while</span> (ptmr != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00556 
00557         <span class="comment">/*</span>
00558 <span class="comment">         * Has this timer gone off and is it one we're looking for?</span>
00559 <span class="comment">         */</span>
00560         <span class="keywordflow">if</span> ((ptmr-&gt;<a class="code" href="../../d4/d8/structtagTIMER.html#o8">flags</a> &amp; TMRF_READY) &amp;&amp;
00561             (ptmr-&gt;<a class="code" href="../../d4/d8/structtagTIMER.html#o3">pti</a> == pti)         &amp;&amp;
00562             <a class="code" href="../../d4/d1/userk_8h.html#a1220">CheckPwndFilter</a>(ptmr-&gt;<a class="code" href="../../d4/d8/structtagTIMER.html#o4">spwnd</a>, pwndFilter)) {
00563 
00564             <span class="comment">/*</span>
00565 <span class="comment">             * We found an appropriate timer. Put it in the app's queue and</span>
00566 <span class="comment">             * return success.</span>
00567 <span class="comment">             */</span>
00568             <span class="keywordflow">if</span> ((pqmsg = <a class="code" href="../../d4/d1/userk_8h.html#a1210">AllocQEntry</a>(&amp;pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o43">mlPost</a>)) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00569 
00570                 <span class="comment">/*</span>
00571 <span class="comment">                 * Store the message and set the QS_POSTMESSAGE bit so the</span>
00572 <span class="comment">                 * thread knows it has a message.</span>
00573 <span class="comment">                 */</span>
00574                 <a class="code" href="../../d4/d1/userk_8h.html#a1503">StoreQMessage</a>(pqmsg,
00575                               ptmr-&gt;<a class="code" href="../../d4/d8/structtagTIMER.html#o4">spwnd</a>,
00576                               (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)((ptmr-&gt;<a class="code" href="../../d4/d8/structtagTIMER.html#o8">flags</a> &amp; TMRF_SYSTEM) ?
00577                                       <a class="code" href="../../d1/d1/bench_8c.html#a4">WM_SYSTIMER</a> : WM_TIMER),
00578                               (WPARAM)ptmr-&gt;<a class="code" href="../../d4/d8/structtagTIMER.html#o5">nID</a>,
00579                               (LPARAM)ptmr-&gt;<a class="code" href="../../d4/d8/structtagTIMER.html#o9">pfn</a>,
00580                               0, 0, 0);
00581 <span class="preprocessor">#ifdef REDIRECTION</span>
00582 <span class="preprocessor"></span>                <a class="code" href="../../d4/d1/userk_8h.html#a1504">StoreQMessagePti</a>(pqmsg, pti);
00583 <span class="preprocessor">#endif // REDIRECTION</span>
00584 <span class="preprocessor"></span>                <a class="code" href="../../d4/d1/userk_8h.html#a1197">SetWakeBit</a>(pti, QS_POSTMESSAGE | QS_ALLPOSTMESSAGE);
00585             }
00586 
00587             <span class="comment">/*</span>
00588 <span class="comment">             * Reset this timer.</span>
00589 <span class="comment">             */</span>
00590             ptmr-&gt;<a class="code" href="../../d4/d8/structtagTIMER.html#o8">flags</a> &amp;= ~TMRF_READY;
00591             <a class="code" href="../../d4/d1/userk_8h.html#a1244">DecTimerCount</a>(ptmr-&gt;<a class="code" href="../../d4/d8/structtagTIMER.html#o3">pti</a>);
00592 
00593             <span class="comment">/*</span>
00594 <span class="comment">             * If there are other timers in the system move this timer</span>
00595 <span class="comment">             * to the end of the list so other timers in for this queue</span>
00596 <span class="comment">             * get a chance to go off.</span>
00597 <span class="comment">             */</span>
00598             ptmrNext = ptmr-&gt;<a class="code" href="../../d4/d8/structtagTIMER.html#o1">ptmrNext</a>;
00599             <span class="keywordflow">if</span> (ptmrNext != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00600 
00601                 <span class="comment">/*</span>
00602 <span class="comment">                 * Remove ptmr from its place in the list.</span>
00603 <span class="comment">                 */</span>
00604                 <span class="keywordflow">if</span> (ptmr-&gt;<a class="code" href="../../d4/d8/structtagTIMER.html#o2">ptmrPrev</a>) {
00605                     ptmr-&gt;<a class="code" href="../../d4/d8/structtagTIMER.html#o2">ptmrPrev</a>-&gt;<a class="code" href="../../d4/d8/structtagTIMER.html#o1">ptmrNext</a> = ptmr-&gt;<a class="code" href="../../d4/d8/structtagTIMER.html#o1">ptmrNext</a>;
00606                 } <span class="keywordflow">else</span>
00607                     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a247">gptmrFirst</a> = ptmr-&gt;<a class="code" href="../../d4/d8/structtagTIMER.html#o1">ptmrNext</a>;
00608 
00609                 ptmrNext-&gt;<a class="code" href="../../d4/d8/structtagTIMER.html#o2">ptmrPrev</a> = ptmr-&gt;<a class="code" href="../../d4/d8/structtagTIMER.html#o2">ptmrPrev</a>;
00610 
00611                 <span class="comment">/*</span>
00612 <span class="comment">                 * Move to the last TIMER of the list.</span>
00613 <span class="comment">                 */</span>
00614                 <span class="keywordflow">while</span> (ptmrNext-&gt;<a class="code" href="../../d4/d8/structtagTIMER.html#o1">ptmrNext</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00615                     ptmrNext = ptmrNext-&gt;<a class="code" href="../../d4/d8/structtagTIMER.html#o1">ptmrNext</a>;
00616 
00617                 <span class="comment">/*</span>
00618 <span class="comment">                 * Insert this timer at the end.</span>
00619 <span class="comment">                 */</span>
00620                 ptmrNext-&gt;<a class="code" href="../../d4/d8/structtagTIMER.html#o1">ptmrNext</a> = ptmr;
00621                 ptmr-&gt;<a class="code" href="../../d4/d8/structtagTIMER.html#o2">ptmrPrev</a> = ptmrNext;
00622                 ptmr-&gt;<a class="code" href="../../d4/d8/structtagTIMER.html#o1">ptmrNext</a>     = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00623             }
00624 
00625             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00626         }
00627 
00628         ptmr = ptmr-&gt;<a class="code" href="../../d4/d8/structtagTIMER.html#o1">ptmrNext</a>;
00629     }
00630 
00631     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00632 }
00633 
00634 <span class="comment">/***************************************************************************\</span>
00635 <span class="comment">* DecTimerCount</span>
00636 <span class="comment">*</span>
00637 <span class="comment">* This routine decrements cTimersReady and clears QS_TIMER if the count</span>
00638 <span class="comment">* goes down to zero.</span>
00639 <span class="comment">*</span>
00640 <span class="comment">* History:</span>
00641 <span class="comment">* 21-Jan-1991 DavidPe   Created.</span>
00642 <span class="comment">\***************************************************************************/</span>
00643 
<a name="l00644"></a><a class="code" href="../../d4/d1/userk_8h.html#a1244">00644</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a1244">DecTimerCount</a>(
00645     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti)
00646 {
00647     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
00648 
00649     <span class="keywordflow">if</span> (--pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o20">cTimersReady</a> == 0)
00650         pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o5">pcti</a>-&gt;<a class="code" href="../../d4/d0/structtagCLIENTTHREADINFO.html#o2">fsWakeBits</a> &amp;= ~QS_TIMER;
00651 }
00652 
00653 <span class="comment">/***************************************************************************\</span>
00654 <span class="comment">* JournalTimer</span>
00655 <span class="comment">*</span>
00656 <span class="comment">*</span>
00657 <span class="comment">* History:</span>
00658 <span class="comment">* 04-Mar-1991 DavidPe       Created.</span>
00659 <span class="comment">\***************************************************************************/</span>
00660 
<a name="l00661"></a><a class="code" href="../../d4/d2/timers_8c.html#a18">00661</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d2/timers_8c.html#a18">JournalTimer</a>(
00662     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a>  pwnd,
00663     UINT  message,
00664     UINT_PTR nID,
00665     LPARAM lParam)
00666 {
00667     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti;
00668 
00669     DBG_UNREFERENCED_PARAMETER(pwnd);
00670     DBG_UNREFERENCED_PARAMETER(message);
00671     DBG_UNREFERENCED_PARAMETER(nID);
00672 
00673     <span class="comment">/*</span>
00674 <span class="comment">     * We've already entered the critical section.</span>
00675 <span class="comment">     */</span>
00676     <span class="keywordflow">if</span> (pti = ((<a class="code" href="../../d4/d8/structtagTIMER.html">PTIMER</a>)lParam)-&gt;ptiOptCreator)
00677         <a class="code" href="../../d4/d1/userk_8h.html#a1198">WakeSomeone</a>(pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>, pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o24">msgJournal</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00678 
00679     <span class="keywordflow">return</span>;
00680 }
00681 
00682 <span class="comment">/***************************************************************************\</span>
00683 <span class="comment">* SetJournalTimer</span>
00684 <span class="comment">*</span>
00685 <span class="comment">* Sets an NT timer that goes off in 'dt' milliseconds and will wake</span>
00686 <span class="comment">* up 'pti' at that time.  This is used in journal playback code to</span>
00687 <span class="comment">* simulate the timing in which events were originally given to the system.</span>
00688 <span class="comment">*</span>
00689 <span class="comment">* History:</span>
00690 <span class="comment">* 04-Mar-1991 DavidPe       Created.</span>
00691 <span class="comment">\***************************************************************************/</span>
00692 
<a name="l00693"></a><a class="code" href="../../d4/d1/userk_8h.html#a1526">00693</a> <span class="keywordtype">void</span> <a class="code" href="../../d4/d1/userk_8h.html#a1526">SetJournalTimer</a>(
00694     DWORD dt,
00695     UINT  msgJournal)
00696 {
00697     <span class="keyword">static</span> UINT_PTR idJournal = 0;
00698 
00699     <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>()-&gt;pq-&gt;msgJournal = msgJournal;
00700 
00701     <span class="comment">/*</span>
00702 <span class="comment">     * Remember idJournal - because TMRF_ONESHOT timers stay in the timer</span>
00703 <span class="comment">     * list - by remembering the idJournal, we always reuse the same timer</span>
00704 <span class="comment">     * rather than creating new ones always.</span>
00705 <span class="comment">     */</span>
00706     idJournal = <a class="code" href="../../d4/d1/userk_8h.html#a1044">InternalSetTimer</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00707                                  idJournal,
00708                                  <a class="code" href="../../d7/d4/conexts_8c.html#a26">dt</a>,
00709                                  <a class="code" href="../../d4/d2/timers_8c.html#a18">JournalTimer</a>,
00710                                  TMRF_RIT | TMRF_ONESHOT);
00711 }
00712 
00713 <span class="comment">/***************************************************************************\</span>
00714 <span class="comment">* StartTimers</span>
00715 <span class="comment">*</span>
00716 <span class="comment">* Prime the timer pump by starting the cursor restoration timer.</span>
00717 <span class="comment">*</span>
00718 <span class="comment">* History:</span>
00719 <span class="comment">* 02-Apr-1992 DarrinM   Created.</span>
00720 <span class="comment">\***************************************************************************/</span>
00721 
<a name="l00722"></a><a class="code" href="../../d4/d1/userk_8h.html#a1480">00722</a> UINT_PTR <a class="code" href="../../d4/d1/userk_8h.html#a1480">StartTimers</a>(VOID)
00723 {
00724     <span class="comment">/*</span>
00725 <span class="comment">     * Let GDI know that it can start settings timers on the RIT.</span>
00726 <span class="comment">     */</span>
00727     GreStartTimers();
00728 
00729     <span class="comment">/*</span>
00730 <span class="comment">     * TMRF_RIT timers are called directly from ScanTimers -- no nasty</span>
00731 <span class="comment">     * thread switching for these boys.</span>
00732 <span class="comment">     */</span>
00733     <span class="keywordflow">return</span> <a class="code" href="../../d4/d1/userk_8h.html#a1044">InternalSetTimer</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0, 1000, <a class="code" href="../../d5/d2/hungapp_8c.html#a6">xxxHungAppDemon</a>, TMRF_RIT);
00734 }
00735 
00736 
00737 <span class="comment">/***************************************************************************\</span>
00738 <span class="comment">* TimersProc</span>
00739 <span class="comment">*</span>
00740 <span class="comment">* Deal with the timers. Called from RawInputThread.</span>
00741 <span class="comment">*</span>
00742 <span class="comment">* History:</span>
00743 <span class="comment">* 11-11-1996 CLupu   Created.</span>
00744 <span class="comment">\***************************************************************************/</span>
00745 
<a name="l00746"></a><a class="code" href="../../d4/d1/userk_8h.html#a1477">00746</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a1477">TimersProc</a>(
00747     VOID)
00748 {
00749     <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>            dmsSinceLast;
00750     LARGE_INTEGER  liT;
00751     <a class="code" href="../../d4/d8/structtagTIMER.html">PTIMER</a>         ptmr;
00752     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>          cmsCur;
00753 
00754     <span class="comment">/*</span>
00755 <span class="comment">     * Calculate how long it was since the last time we</span>
00756 <span class="comment">     * processed timers so we can subtract that much time</span>
00757 <span class="comment">     * from each timer's countdown value.</span>
00758 <span class="comment">     */</span>
00759     <a class="code" href="../../d7/d1/usersrv_8h.html#a36">EnterCrit</a>();
00760 
00761     cmsCur = <a class="code" href="../../d9/d5/gettickc_8c.html#a0">NtGetTickCount</a>();
00762     dmsSinceLast = <a class="code" href="../../d4/d1/userk_8h.html#a2021">ComputePastTickDelta</a>(cmsCur, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a250">gcmsLastTimer</a>);
00763     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a250">gcmsLastTimer</a> = cmsCur;
00764 
00765     <span class="comment">/*</span>
00766 <span class="comment">     * dmsNextTimer is the time delta before the next</span>
00767 <span class="comment">     * timer should go off.  As we loop through the</span>
00768 <span class="comment">     * timers below this will shrink to the smallest</span>
00769 <span class="comment">     * cmsCountdown value in the list.</span>
00770 <span class="comment">     */</span>
00771     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a249">gdmsNextTimer</a> = 0x7FFFFFFF;
00772     ptmr = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a247">gptmrFirst</a>;
00773     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a251">gbMasterTimerSet</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00774     <span class="keywordflow">while</span> (ptmr != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00775 
00776         <span class="comment">/*</span>
00777 <span class="comment">         * ONESHOT timers go to a WAITING state after</span>
00778 <span class="comment">         * they go off. This allows us to leave them</span>
00779 <span class="comment">         * in the list but keep them from going off</span>
00780 <span class="comment">         * over and over.</span>
00781 <span class="comment">         */</span>
00782         <span class="keywordflow">if</span> (ptmr-&gt;<a class="code" href="../../d4/d8/structtagTIMER.html#o8">flags</a> &amp; TMRF_WAITING) {
00783             ptmr = ptmr-&gt;<a class="code" href="../../d4/d8/structtagTIMER.html#o1">ptmrNext</a>;
00784             <span class="keywordflow">continue</span>;
00785         }
00786 
00787         <span class="comment">/*</span>
00788 <span class="comment">         * The first time we encounter a timer we don't</span>
00789 <span class="comment">         * want to set it off, we just want to use it to</span>
00790 <span class="comment">         * compute the shortest countdown value.</span>
00791 <span class="comment">         */</span>
00792         <span class="keywordflow">if</span> (ptmr-&gt;<a class="code" href="../../d4/d8/structtagTIMER.html#o8">flags</a> &amp; TMRF_INIT) {
00793             ptmr-&gt;<a class="code" href="../../d4/d8/structtagTIMER.html#o8">flags</a> &amp;= ~TMRF_INIT;
00794 
00795         } <span class="keywordflow">else</span> {
00796             <span class="comment">/*</span>
00797 <span class="comment">             * If this timer is going off, wake up its</span>
00798 <span class="comment">             * owner.</span>
00799 <span class="comment">             */</span>
00800             ptmr-&gt;<a class="code" href="../../d4/d8/structtagTIMER.html#o6">cmsCountdown</a> -= dmsSinceLast;
00801             <span class="keywordflow">if</span> (ptmr-&gt;<a class="code" href="../../d4/d8/structtagTIMER.html#o6">cmsCountdown</a> &lt;= 0) {
00802                 ptmr-&gt;<a class="code" href="../../d4/d8/structtagTIMER.html#o6">cmsCountdown</a> = ptmr-&gt;<a class="code" href="../../d4/d8/structtagTIMER.html#o7">cmsRate</a>;
00803 
00804                 <span class="comment">/*</span>
00805 <span class="comment">                 * If the timer's owner hasn't handled the</span>
00806 <span class="comment">                 * last time it went off yet, throw this event</span>
00807 <span class="comment">                 * away.</span>
00808 <span class="comment">                 */</span>
00809                 <span class="keywordflow">if</span> (!(ptmr-&gt;<a class="code" href="../../d4/d8/structtagTIMER.html#o8">flags</a> &amp; TMRF_READY)) {
00810                     <span class="comment">/*</span>
00811 <span class="comment">                     * A ONESHOT timer goes into a WAITING state</span>
00812 <span class="comment">                     * until SetTimer is called again to reset it.</span>
00813 <span class="comment">                     */</span>
00814                     <span class="keywordflow">if</span> (ptmr-&gt;<a class="code" href="../../d4/d8/structtagTIMER.html#o8">flags</a> &amp; TMRF_ONESHOT)
00815                         ptmr-&gt;<a class="code" href="../../d4/d8/structtagTIMER.html#o8">flags</a> |= TMRF_WAITING;
00816 
00817                     <span class="comment">/*</span>
00818 <span class="comment">                     * RIT timers have the distinction of being</span>
00819 <span class="comment">                     * called directly and executing serially with</span>
00820 <span class="comment">                     * with incoming timer events.</span>
00821 <span class="comment">                     * NOTE: RIT timers get called while we're</span>
00822 <span class="comment">                     * inside the critical section.</span>
00823 <span class="comment">                     */</span>
00824                     <span class="keywordflow">if</span> (ptmr-&gt;<a class="code" href="../../d4/d8/structtagTIMER.html#o8">flags</a> &amp; TMRF_RIT) {
00825                         <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlTimer;
00826 
00827                         <a class="code" href="../../d6/d0/usercli_8h.html#a36">ThreadLock</a>(ptmr, &amp;tlTimer);
00828                         <span class="comment">/*</span>
00829 <span class="comment">                         * May set gbMasterTimerSet</span>
00830 <span class="comment">                         */</span>
00831                         (ptmr-&gt;<a class="code" href="../../d4/d8/structtagTIMER.html#o9">pfn</a>)(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00832                                     <a class="code" href="../../d1/d1/bench_8c.html#a4">WM_SYSTIMER</a>,
00833                                     ptmr-&gt;<a class="code" href="../../d4/d8/structtagTIMER.html#o5">nID</a>,
00834                                     (LPARAM)ptmr);
00835 
00836                         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a438">HMIsMarkDestroy</a>(ptmr)) {
00837                             ptmr = ptmr-&gt;<a class="code" href="../../d4/d8/structtagTIMER.html#o1">ptmrNext</a>;
00838                             <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlTimer);
00839                             <span class="keywordflow">continue</span>;
00840                         }
00841                         <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlTimer);
00842 
00843                     } <span class="keywordflow">else</span> {
00844                         ptmr-&gt;<a class="code" href="../../d4/d8/structtagTIMER.html#o8">flags</a> |= TMRF_READY;
00845                         ptmr-&gt;<a class="code" href="../../d4/d8/structtagTIMER.html#o3">pti</a>-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o20">cTimersReady</a>++;
00846                         <a class="code" href="../../d4/d1/userk_8h.html#a1197">SetWakeBit</a>(ptmr-&gt;<a class="code" href="../../d4/d8/structtagTIMER.html#o3">pti</a>, QS_TIMER);
00847                     }
00848                 }
00849             }
00850         }
00851 
00852         <span class="comment">/*</span>
00853 <span class="comment">         * Remember the shortest time left of the timers.</span>
00854 <span class="comment">         */</span>
00855         <span class="keywordflow">if</span> (ptmr-&gt;<a class="code" href="../../d4/d8/structtagTIMER.html#o6">cmsCountdown</a> &lt; <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a249">gdmsNextTimer</a>)
00856             <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a249">gdmsNextTimer</a> = ptmr-&gt;<a class="code" href="../../d4/d8/structtagTIMER.html#o6">cmsCountdown</a>;
00857 
00858         <span class="comment">/*</span>
00859 <span class="comment">         * Advance to the next timer structure.</span>
00860 <span class="comment">         */</span>
00861         ptmr = ptmr-&gt;<a class="code" href="../../d4/d8/structtagTIMER.html#o1">ptmrNext</a>;
00862     }
00863 
00864     <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a251">gbMasterTimerSet</a>) {
00865         <span class="comment">/*</span>
00866 <span class="comment">         * Time in NT should be negative to specify a relative</span>
00867 <span class="comment">         * time. It's also in hundred nanosecond units so multiply</span>
00868 <span class="comment">         * by 10000  to get the right value from milliseconds.</span>
00869 <span class="comment">         */</span>
00870         liT.QuadPart = Int32x32To64(-10000, <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a249">gdmsNextTimer</a>);
00871         <a class="code" href="../../d3/d2/timerobj_8c.html#a6">KeSetTimer</a>(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a248">gptmrMaster</a>, liT, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00872     }
00873 
00874     <a class="code" href="../../d7/d1/usersrv_8h.html#a37">LeaveCrit</a>();
00875 }
00876 
00877 <span class="comment">/***************************************************************************\</span>
00878 <span class="comment">*  xxxSystemTimerProc()</span>
00879 <span class="comment">*</span>
00880 <span class="comment">*  11/15/96 GerardoB  Created</span>
00881 <span class="comment">\***************************************************************************/</span>
<a name="l00882"></a><a class="code" href="../../d4/d1/userk_8h.html#a1722">00882</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/userk_8h.html#a1722">xxxSystemTimerProc</a>(<a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd, UINT msg, UINT_PTR <span class="keywordtype">id</span>, LPARAM lParam)
00883 {
00884     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwnd);
00885     UNREFERENCED_PARAMETER(<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>);
00886     UNREFERENCED_PARAMETER(<span class="keywordtype">id</span>);
00887     UNREFERENCED_PARAMETER(lParam);
00888 
00889     <span class="keywordflow">switch</span> (<span class="keywordtype">id</span>) {
00890         <span class="keywordflow">case</span> <a class="code" href="../../d1/d0/inc_2user_8h.html#a39">IDSYS_LAYER</a>: {
00891             <a class="code" href="../../d3/d2/structtagDCE.html">PDCE</a> pdce;
00892             
00893             <span class="keywordflow">for</span> (pdce = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a179">gpDispInfo</a>-&gt;<a class="code" href="../../d9/d3/structtagDISPLAYINFO.html#o9">pdceFirst</a>; pdce != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; pdce = pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o0">pdceNext</a>) {
00894 
00895                 <span class="keywordflow">if</span> (pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o7">DCX_flags</a> &amp; (DCX_INVALID | DCX_DESTROYTHIS))
00896                     <span class="keywordflow">continue</span>;
00897 
00898                 <span class="keywordflow">if</span> ((pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o7">DCX_flags</a> &amp; DCX_LAYERED) &amp;&amp; (pdce-&gt;<a class="code" href="../../d3/d2/structtagDCE.html#o7">DCX_flags</a> &amp; DCX_INUSE)) {
00899                     <a class="code" href="../../d4/d1/userk_8h.html#a1986">UpdateLayeredSprite</a>(pdce);
00900                 }
00901             }
00902         }
00903         <span class="keywordflow">return</span>;
00904 
00905         <span class="keywordflow">case</span> <a class="code" href="../../d1/d0/inc_2user_8h.html#a40">IDSYS_FADE</a>:
00906             <a class="code" href="../../d8/d4/sprite_8c.html#a23">AnimateFade</a>();
00907             <span class="keywordflow">return</span>;
00908 
00909         <span class="keywordflow">case</span> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a47">IDSYS_FLASHWND</a>:
00910             <a class="code" href="../../d9/d7/kernel_2winmgr_8c.html#a2">xxxFlashWindow</a>(pwnd, FLASHW_TIMERCALL, 0);
00911             <span class="keywordflow">return</span>;
00912 
00913         <span class="keywordflow">case</span> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a46">IDSYS_WNDTRACKING</a>: {
00914             <span class="comment">/*</span>
00915 <span class="comment">             * If the active track window hasn't changed,</span>
00916 <span class="comment">             *  it's time to active it.</span>
00917 <span class="comment">             * spwndTrack can be NULL if it got destroyed but we haven't</span>
00918 <span class="comment">             *  destroyed the timer.yet</span>
00919 <span class="comment">             */</span>
00920             <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd);
00921             UserAssert(<a class="code" href="../../d4/d1/userk_8h.html#a563">TestUP</a>(ACTIVEWINDOWTRACKING));
00922 
00923             <span class="keywordflow">if</span> ((pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o21">spwndTrack</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00924                     &amp;&amp; (pwnd == <a class="code" href="../../d4/d1/userk_8h.html#a1654">GetActiveTrackPwnd</a>(pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o21">spwndTrack</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>))) {
00925 
00926                 pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>-&gt;<a class="code" href="../../d7/d4/structtagQ.html#o21">QF_flags</a> |= (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a870">QF_ACTIVEWNDTRACKING</a> | <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a860">QF_MOUSEMOVED</a>);
00927 
00928 <span class="preprocessor">#ifdef REDIRECTION</span>
00929 <span class="preprocessor"></span>                <span class="comment">/*</span>
00930 <span class="comment">                 * Should we call the hit test hook here ?</span>
00931 <span class="comment">                 */</span>
00932                 PushMouseMove(pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>, <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;ptCursor);
00933 <span class="preprocessor">#endif // REDIRECTION</span>
00934 <span class="preprocessor"></span>                
00935                 <a class="code" href="../../d4/d1/userk_8h.html#a1197">SetWakeBit</a>(pti, QS_MOUSEMOVE);
00936             }
00937         }
00938         <span class="keywordflow">break</span>;
00939 
00940         <span class="keywordflow">case</span> <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a49">IDSYS_MOUSEHOVER</a>: {
00941             <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd);
00942             <a class="code" href="../../d0/d3/structtagDESKTOP.html">PDESKTOP</a> pdesk = pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o6">rpdesk</a>;
00943             <span class="comment">/*</span>
00944 <span class="comment">             * If hover hasn't been canceled, the mouse is still on</span>
00945 <span class="comment">             *  this window and the point is still on the rect, then</span>
00946 <span class="comment">             *  it's hover time!</span>
00947 <span class="comment">             */</span>
00948             <span class="keywordflow">if</span> ((pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o4">dwDTFlags</a> &amp; <a class="code" href="../../d4/d1/userk_8h.html#a293">DF_TRACKMOUSEHOVER</a>)
00949                     &amp;&amp; (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(pwnd) == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o21">spwndTrack</a>)
00950                     &amp;&amp; <a class="code" href="../../d3/d6/rect_8c.html#a5">PtInRect</a>(&amp;pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o23">rcMouseHover</a>, <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;ptCursor))) {
00951 
00952                 <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> message;
00953                 WPARAM wParam;
00954                 POINT pt = <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;ptCursor;
00955 
00956                 <span class="keywordflow">if</span> (pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o22">htEx</a> == HTCLIENT) {
00957                     message = WM_MOUSEHOVER;
00958                     wParam = (WPARAM)<a class="code" href="../../d4/d1/userk_8h.html#a1641">GetMouseKeyFlags</a>(pti-&gt;<a class="code" href="../../d2/d8/structtagTHREADINFO.html#o3">pq</a>);
00959 <span class="preprocessor">#ifdef USE_MIRRORING</span>
00960 <span class="preprocessor"></span>                    <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, WEFLAYOUTRTL)) {
00961                         pt.x = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.right - pt.x - 1;
00962                     } <span class="keywordflow">else</span>
00963 <span class="preprocessor">#endif</span>
00964 <span class="preprocessor"></span>                    {
00965                         pt.x -= pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.left;
00966                     }
00967                     pt.y -= pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o7">rcClient</a>.top;
00968                 } <span class="keywordflow">else</span> {
00969                     message = WM_NCMOUSEHOVER;
00970                     <span class="comment">/*</span>
00971 <span class="comment">                     * Map the extended hit test code to a public one.</span>
00972 <span class="comment">                     */</span>
00973                     wParam = (WPARAM)LOWORD(pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o22">htEx</a>);
00974                     <span class="keywordflow">if</span> ((wParam &gt;= <a class="code" href="../../d4/d1/userk_8h.html#a674">HTEXMENUFIRST</a>) &amp;&amp; (wParam &lt;= <a class="code" href="../../d4/d1/userk_8h.html#a680">HTEXMENULAST</a>)) {
00975                         wParam = (WPARAM)HTMENU;
00976                     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((wParam &gt;= <a class="code" href="../../d4/d1/userk_8h.html#a667">HTEXSCROLLFIRST</a>) &amp;&amp; (wParam &lt;= <a class="code" href="../../d4/d1/userk_8h.html#a673">HTEXSCROLLLAST</a>)) {
00977                         wParam = (WPARAM)(HIWORD(pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o22">htEx</a>) ? HTVSCROLL : HTHSCROLL);
00978                     }
00979                 }
00980 
00981                 <a class="code" href="../../d4/d1/userk_8h.html#a1642">_PostMessage</a>(pwnd, message, wParam, MAKELPARAM(pt.x, pt.y));
00982 
00983                 pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o4">dwDTFlags</a> &amp;= ~<a class="code" href="../../d4/d1/userk_8h.html#a293">DF_TRACKMOUSEHOVER</a>;
00984                 <span class="keywordflow">break</span>;
00985             }
00986         }
00987         <span class="keywordflow">return</span>;
00988 
00989 
00990         <span class="keywordflow">default</span>:
00991             RIPMSG1(RIP_ERROR, <span class="stringliteral">"xxxSystemTimerProc: unexpected id:%#lx"</span>, <span class="keywordtype">id</span>);
00992             <span class="keywordflow">break</span>;
00993     }
00994 
00995     <span class="comment">/*</span>
00996 <span class="comment">     * if we fell through, the timer got to go</span>
00997 <span class="comment">     */</span>
00998     <a class="code" href="../../d4/d1/userk_8h.html#a1567">_KillSystemTimer</a>(pwnd, <span class="keywordtype">id</span>);
00999     <span class="keywordflow">return</span>;
01000 }
01001 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:59 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
