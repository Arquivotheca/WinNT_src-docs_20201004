<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: hiveinit.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>hiveinit.c File Reference</h1><code>#include "<a class="el" href="../../d2/d1/cmp_8h-source.html">cmp.h</a>"</code><br>

<p>
<a href="../../d6/d0/hiveinit_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/hiveinit_8c.html#a0">HvpDumpFreeDisplay</a>(<a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>)</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/hiveinit_8c.html#a1">HvpFillFileName</a> (<a class="el" href="../../d6/d4/struct__HBASE__BLOCK.html">PHBASE_BLOCK</a> BaseBlock, PUNICODE_STRING <a class="el" href="../../d8/d1/hivestat_8c.html#a9">FileName</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/hiveinit_8c.html#a2">HvpFreeAllocatedBins</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/hiveinit_8c.html#a3">HvInitializeHive</a> (<a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> <a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>, ULONG OperationType, ULONG HiveFlags, ULONG FileType, PVOID HiveData OPTIONAL, <a class="el" href="../../d0/d1/hivedata_8h.html#a63">PALLOCATE_ROUTINE</a> AllocateRoutine, <a class="el" href="../../d0/d1/hivedata_8h.html#a64">PFREE_ROUTINE</a> FreeRoutine, <a class="el" href="../../d0/d1/hivedata_8h.html#a65">PFILE_SET_SIZE_ROUTINE</a> FileSetSizeRoutine, <a class="el" href="../../d0/d1/hivedata_8h.html#a67">PFILE_WRITE_ROUTINE</a> FileWriteRoutine, <a class="el" href="../../d0/d1/hivedata_8h.html#a68">PFILE_READ_ROUTINE</a> FileReadRoutine, <a class="el" href="../../d0/d1/hivedata_8h.html#a69">PFILE_FLUSH_ROUTINE</a> FileFlushRoutine, ULONG Cluster, PUNICODE_STRING <a class="el" href="../../d8/d1/hivestat_8c.html#a9">FileName</a> OPTIONAL)</td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a0" doxytag="hiveinit.c::HvpDumpFreeDisplay" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define HvpDumpFreeDisplay          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d1/hivemap_8c.html#a0">Hive</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/hiveinit_8c-source.html#l00080">80</a> of file <a class="el" href="../../d6/d0/hiveinit_8c-source.html">hiveinit.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/hiveinit_8c-source.html#l00158">HvInitializeHive()</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a3" doxytag="hiveinit.c::HvInitializeHive" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS HvInitializeHive           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Hive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>OperationType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>HiveFlags</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>FileType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PVOID HiveData&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a63">PALLOCATE_ROUTINE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>AllocateRoutine</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a64">PFREE_ROUTINE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FreeRoutine</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a65">PFILE_SET_SIZE_ROUTINE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileSetSizeRoutine</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a67">PFILE_WRITE_ROUTINE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileWriteRoutine</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a68">PFILE_READ_ROUTINE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileReadRoutine</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d1/hivedata_8h.html#a69">PFILE_FLUSH_ROUTINE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileFlushRoutine</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Cluster</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PUNICODE_STRING <a class="el" href="../../d8/d1/hivestat_8c.html#a9">FileName</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/hiveinit_8c-source.html#l00158">158</a> of file <a class="el" href="../../d6/d0/hiveinit_8c-source.html">hiveinit.c</a>.
<p>
References <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00597">_HHIVE::Allocate</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00620">_HHIVE::Alternate</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00605">_HHIVE::BaseBlock</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00348">_HBASE_BLOCK::CheckSum</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00345">_HBASE_BLOCK::Cluster</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00610">_HHIVE::Cluster</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00249">CML_BIN</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00246">CML_MAJOR</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00293">CMLOG</a>, <a class="el" href="../../d6/d0/cmgquota_8c-source.html#l00265">CmpReleaseGlobalQuota()</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00269">CMS_BIN_MAP</a>, <a class="el" href="../../d2/d1/cmp_8h-source.html#l00256">CMS_INIT</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00609">_HHIVE::DirtyAlloc</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00608">_HHIVE::DirtyCount</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00607">_HHIVE::DirtyVector</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00603">_HHIVE::FileFlush</a>, <a class="el" href="../../d3/d1/rtload_8c-source.html#l00047">FileName</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00602">_HHIVE::FileRead</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00600">_HHIVE::FileSetSize</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00601">_HHIVE::FileWrite</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00616">_HHIVE::Flat</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00342">_HBASE_BLOCK::Format</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00598">_HHIVE::Free</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00595">_HHIVE::GetCellRoutine</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00323">HBASE_BLOCK_SIGNATURE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00329">HBASE_FORMAT_MEMORY</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00122">HBLOCK_SIZE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00106">HCELL_INDEX</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00109">HCELL_NIL</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00569">HFILE_TYPE_ALTERNATE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00570">HFILE_TYPE_LOG</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00568">HFILE_TYPE_PRIMARY</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00577">HHIVE_FREE_DISPLAY_SIZE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00566">HHIVE_SIGNATURE</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00197">HINIT_CREATE</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00199">HINIT_FILE</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00201">HINIT_FLAT</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00198">HINIT_MEMORY</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00200">HINIT_MEMORY_INPLACE</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d7/d9/hive_8h-source.html#l00203">HIVE_VOLATILE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00622">_HHIVE::HiveFlags</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00130">HSECTOR_COUNT</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00129">HSECTOR_SIZE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00325">HSYS_MAJOR</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00326">HSYS_MINOR</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00076">HTYPE_COUNT</a>, <a class="el" href="../../d7/d0/hiveload_8c-source.html#l00100">HvLoadHive()</a>, <a class="el" href="../../d8/d0/hivemap_8c-source.html#l00536">HvpBuildMap()</a>, <a class="el" href="../../d8/d0/hivemap_8c-source.html#l00047">HvpBuildMapAndCopy()</a>, <a class="el" href="../../d1/d1/hivesync_8c-source.html#l00775">HvpDoWriteHive()</a>, <a class="el" href="../../d6/d0/hiveinit_8c-source.html#l00080">HvpDumpFreeDisplay</a>, <a class="el" href="../../d6/d0/hiveinit_8c-source.html#l00645">HvpFillFileName()</a>, <a class="el" href="../../d6/d0/hiveinit_8c-source.html#l00085">HvpFreeAllocatedBins()</a>, <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00221">HvpGetCellFlat()</a>, <a class="el" href="../../d9/d9/hivecell_8c-source.html#l00146">HvpGetCellPaged()</a>, <a class="el" href="../../d0/d1/hivesum_8c-source.html#l00031">HvpHeaderCheckSum()</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00344">_HBASE_BLOCK::Length</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00619">_HHIVE::Log</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00624">_HHIVE::LogSize</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00339">_HBASE_BLOCK::Major</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00340">_HBASE_BLOCK::Minor</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00617">_HHIVE::ReadOnly</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00626">_HHIVE::RefreshCount</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00343">_HBASE_BLOCK::RootCell</a>, <a class="el" href="../../d5/d0/rtl_2bitmap_8c-source.html#l00266">RtlClearAllBits()</a>, <a class="el" href="../../d5/d0/rtl_2bitmap_8c-source.html#l00219">RtlInitializeBitMap()</a>, <a class="el" href="../../d5/d0/rtl_2bitmap_8c-source.html#l00305">RtlSetAllBits()</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00336">_HBASE_BLOCK::Sequence1</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00337">_HBASE_BLOCK::Sequence2</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00335">_HBASE_BLOCK::Signature</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00593">_HHIVE::Signature</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00629">_HHIVE::StorageTypeCount</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00338">_HBASE_BLOCK::TimeStamp</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00341">_HBASE_BLOCK::Type</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00633">_HHIVE::Version</a>, and <a class="el" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>.
<p>
Referenced by <a class="el" href="../../d6/d9/cmcontrl_8c-source.html#l00050">CmGetSystemControlValues()</a>, and <a class="el" href="../../d9/d0/cminit_8c-source.html#l00471">CmpInitializeHive()</a>.
<p>
<pre class="fragment"><div>00175                    :
00176 
00177     Initialize a hive.
00178 
00179     Core HHive fields are always inited.
00180 
00181     <a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a> calls WILL be <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a> BEFORE <span class="keyword">this</span> call returns.
00182 
00183     Caller <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> expected to create/open files and store <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> handles
00184     in a way that can be derived from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive pointer.
00185 
00186     Three kinds of initialization can be done, selected by OperationType:
00187 
00188         <a class="code" href="../../d6/d0/hive_8h.html#a4">HINIT_CREATE</a>
00189 
00190             <a class="code" href="../../d4/d5/conimep_8h.html#a111">Create</a> a <span class="keyword">new</span> hive from scratch.  Will have 0 storage.
00191             [Used to <span class="keywordflow">do</span> things like create HARDWARE hive and <span class="keywordflow">for</span> parts
00192              of SaveKey and RestoreKey]
00193 
00194 
00195         <a class="code" href="../../d6/d0/hive_8h.html#a7">HINIT_MEMORY_INPLACE</a>
00196 
00197             Build a hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure which allows read <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a>
00198             access to a contiguous in-memory image of a hive.
00199             No part of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> image will be copied, but a map will
00200             be <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a>.
00201             [Used by osloader.]
00202 
00203 
00204         <a class="code" href="../../d6/d0/hive_8h.html#a8">HINIT_FLAT</a>
00205 
00206             Support very limited (read-only, no checking code) operation
00207             against a hive image.
00208 
00209 
00210         <a class="code" href="../../d6/d0/hive_8h.html#a5">HINIT_MEMORY</a>
00211 
00212             <a class="code" href="../../d4/d5/conimep_8h.html#a111">Create</a> a <span class="keyword">new</span> hive, <span class="keyword">using</span> a hive image already in memory,
00213             at address supplied by pointer HiveData.  The data will
00214             be copied.  Caller <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> expected to free HiveData.
00215             [Used <span class="keywordflow">for</span> SYSTEM hive]
00216 
00217 
00218         <a class="code" href="../../d6/d0/hive_8h.html#a6">HINIT_FILE</a>
00219 
00220             <a class="code" href="../../d4/d5/conimep_8h.html#a111">Create</a> a hive, reading its data from a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.  Recovery processing
00221             via log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> will be done <span class="keywordflow">if</span> a log <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> available.  If a log
00222             <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> recovered, flush and clear operation will proceed.
00223 
00224 
00225     NOTE:   The HHive <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not a completely opaque structure, because <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>
00226             <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> really <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> used by a limited set of code.  Do not assume
00227             that <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> <span class="keyword">this</span> routine sets all of these values.
00228 
00229 
00230 Arguments:
00231 
00232     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - supplies a pointer to hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure to be initialized
00233             to describe <span class="keyword">this</span> hive.
00234 
00235     OperationType - specifies whether to create a <span class="keyword">new</span> hive from scratch,
00236             from a memory image, or by reading a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> from disk.
00237 
00238     HiveFlags - <a class="code" href="../../d6/d0/hive_8h.html#a9">HIVE_VOLATILE</a> - Entire hive <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be <span class="keyword">volatile</span>, regardless
00239                                    of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> types of cells allocated
00240                 HIVE_NO_LAZY_FLUSH - Data in <span class="keyword">this</span> hive <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> never written
00241                                    to disk except by an <span class="keyword">explicit</span> FlushKey
00242 
00243     FileType - HFILE_TYPE_*, <a class="code" href="../../d0/d1/hivedata_8h.html#a40">HFILE_TYPE_LOG</a> or <a class="code" href="../../d0/d1/hivedata_8h.html#a39">HFILE_TYPE_ALTERNATE</a> set
00244             up <span class="keywordflow">for</span> logging or alternate support respectively.
00245 
00246     HiveData - <span class="keywordflow">if</span> present, supplies a pointer to an in memory image of
00247             from which to init <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hive.  Only useful when OperationType
00248             <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> set to <a class="code" href="../../d6/d0/hive_8h.html#a5">HINIT_MEMORY</a>.
00249 
00250     AllocateRoutine - supplies a pointer to routine called to allocate
00251                         memory.  WILL be called before <span class="keyword">this</span> routine returns.
00252 
00253     FreeRoutine - supplies a pointer to routine called to free memory.
00254                    CAN be called before <span class="keyword">this</span> routine returns.
00255 
00256     FileSetSizeRoutine - supplies a pointer to a routine used to set <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00257                          size of a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>. CAN be called before <span class="keyword">this</span>
00258                          routine returns.
00259 
00260     FileWriteRoutine - supplies a pointer to routine called to write memory
00261                         to a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
00262 
00263     FileReadRoutine - supplies a pointer to routine called to read from
00264                         a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> into memory. CAN be called before <span class="keyword">this</span>
00265                         routine returns.
00266 
00267     FileFlushRoutine - supplies a pointer to routine called to flush a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
00268 
00269     Cluster - clustering factor in <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a> units.  (i.e.  <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> of
00270             physical sector in media / <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a>.  1 <span class="keywordflow">for</span> 512 byte
00271             physical sectors (or smaller), 2 <span class="keywordflow">for</span> 1024, 4 <span class="keywordflow">for</span> 2048, etc.
00272             (Numbers greater than 8 won'<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> work.)
00273 
00274     <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a> - some <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a> like <span class="stringliteral">"...\system32\config\system"</span>, last
00275                 32 or so characters will be copied into baseblock
00276                 (and thus to disk) as a debugging aid.  May be null.
00277 
00278 
00279 Return Value:
00280 
00281     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> code.
00282 
00283 --*/
00284 {
00285     BOOLEAN         UseForIo;
00286     <a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html">PHBASE_BLOCK</a>    BaseBlock = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00287     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>        <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00288     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>        Status2;
00289     PVOID           Image;
00290     ULONG           i;
00291     <a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>           Pbin;
00292     ULONG           Alignment;
00293 
00294     <span class="comment">//</span>
00295     <span class="comment">// this array stores the last elements in each free cell list for the stable storage</span>
00296     <span class="comment">//</span>
00297     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a>     TailDisplay[<a class="code" href="../../d0/d1/hivedata_8h.html#a45">HHIVE_FREE_DISPLAY_SIZE</a>];
00298 
00299     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_MAJOR, CMS_INIT) {
00300         KdPrint((<span class="stringliteral">"HvInitializeHive:\n"</span>));
00301         KdPrint((<span class="stringliteral">"\tHive=%08lx\n"</span>, Hive));
00302     }
00303 
00304     <span class="comment">//</span>
00305     <span class="comment">// reject invalid parameter combinations</span>
00306     <span class="comment">//</span>
00307     <span class="keywordflow">if</span> ( (! ARGUMENT_PRESENT(HiveData)) &amp;&amp;
00308          ((OperationType == <a class="code" href="../../d6/d0/hive_8h.html#a5">HINIT_MEMORY</a>) ||
00309           (OperationType == <a class="code" href="../../d6/d0/hive_8h.html#a8">HINIT_FLAT</a>) ||
00310           (OperationType == <a class="code" href="../../d6/d0/hive_8h.html#a7">HINIT_MEMORY_INPLACE</a>))
00311        )
00312     {
00313         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00314     }
00315 
00316     <span class="keywordflow">if</span> ( ! ((OperationType == <a class="code" href="../../d6/d0/hive_8h.html#a4">HINIT_CREATE</a>) ||
00317             (OperationType == <a class="code" href="../../d6/d0/hive_8h.html#a5">HINIT_MEMORY</a>) ||
00318             (OperationType == <a class="code" href="../../d6/d0/hive_8h.html#a7">HINIT_MEMORY_INPLACE</a>) ||
00319             (OperationType == <a class="code" href="../../d6/d0/hive_8h.html#a8">HINIT_FLAT</a>) ||
00320             (OperationType == <a class="code" href="../../d6/d0/hive_8h.html#a6">HINIT_FILE</a>))
00321        )
00322     {
00323         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00324     }
00325 
00326 
00327     <span class="comment">//</span>
00328     <span class="comment">// static and global control values</span>
00329     <span class="comment">//</span>
00330     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o0">Signature</a> = <a class="code" href="../../d0/d1/hivedata_8h.html#a37">HHIVE_SIGNATURE</a>;
00331 
00332     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o2">Allocate</a> = AllocateRoutine;
00333     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o3">Free</a> = FreeRoutine;
00334     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o4">FileSetSize</a> = FileSetSizeRoutine;
00335     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o5">FileWrite</a> = FileWriteRoutine;
00336     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o6">FileRead</a> = FileReadRoutine;
00337     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o7">FileFlush</a> = FileFlushRoutine;
00338 
00339     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o15">Log</a> = (BOOLEAN)((FileType == <a class="code" href="../../d0/d1/hivedata_8h.html#a40">HFILE_TYPE_LOG</a>) ? <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> : <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00340     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o16">Alternate</a> = (BOOLEAN)((FileType == <a class="code" href="../../d0/d1/hivedata_8h.html#a39">HFILE_TYPE_ALTERNATE</a>) ? <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> : <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00341 
00342     <span class="keywordflow">if</span> ((<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o15">Log</a> || <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o16">Alternate</a>)  &amp;&amp; (HiveFlags &amp; <a class="code" href="../../d6/d0/hive_8h.html#a9">HIVE_VOLATILE</a>)) {
00343         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00344     }
00345 
00346     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o17">HiveFlags</a> = HiveFlags;
00347 
00348     <span class="keywordflow">if</span> ((Cluster == 0) || (Cluster &gt; <a class="code" href="../../d0/d1/hivedata_8h.html#a16">HSECTOR_COUNT</a>)) {
00349         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00350     }
00351     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o12">Cluster</a> = Cluster;
00352 
00353     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o19">RefreshCount</a> = 0;
00354 
00355     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o20">StorageTypeCount</a> = <a class="code" href="../../d0/d1/hivedata_8h.html#a5">HTYPE_COUNT</a>;
00356 
00357 
00358     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>].Length = 0;
00359     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>].Map = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00360     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>].SmallDir = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00361     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>].Guard = (ULONG)-1;
00362     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>].FreeSummary = 0;
00363     InitializeListHead(&amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[Volatile].FreeBins);
00364     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d0/d1/hivedata_8h.html#a45">HHIVE_FREE_DISPLAY_SIZE</a>; i++) {
00365         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>].FreeDisplay[i] = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
00366     }
00367 
00368     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].Length = 0;
00369     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].Map = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00370     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].SmallDir = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00371     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].Guard = (ULONG)-1;
00372     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].FreeSummary = 0;
00373     InitializeListHead(&amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[Stable].FreeBins);
00374     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d0/d1/hivedata_8h.html#a45">HHIVE_FREE_DISPLAY_SIZE</a>; i++) {
00375         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].FreeDisplay[i] = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
00376         TailDisplay[i] = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
00377     }
00378 
00379     <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a26">RtlInitializeBitMap</a>(&amp;(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>), NULL, 0);
00380     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o10">DirtyCount</a> = 0;
00381     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o11">DirtyAlloc</a> = 0;
00382     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o18">LogSize</a> = 0;
00383 
00384     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o1">GetCellRoutine</a> = <a class="code" href="../../d6/d0/hive_8h.html#a29">HvpGetCellPaged</a>;
00385     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o13">Flat</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00386     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o14">ReadOnly</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00387     UseForIo = (BOOLEAN)!(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o17">HiveFlags</a> &amp; <a class="code" href="../../d6/d0/hive_8h.html#a9">HIVE_VOLATILE</a>);
00388 
00389     <span class="comment">//</span>
00390     <span class="comment">// new create case</span>
00391     <span class="comment">//</span>
00392     <span class="keywordflow">if</span> (OperationType == <a class="code" href="../../d6/d0/hive_8h.html#a4">HINIT_CREATE</a>) {
00393 
00394         BaseBlock = (<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html">PHBASE_BLOCK</a>)((<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o2">Allocate</a>)(<span class="keyword">sizeof</span>(<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html">HBASE_BLOCK</a>), UseForIo));
00395         <span class="keywordflow">if</span> (BaseBlock == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00396             <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00397         }
00398         <span class="comment">//</span>
00399         <span class="comment">// Make sure the buffer we got back is cluster-aligned. If not, try</span>
00400         <span class="comment">// harder to get an aligned buffer.</span>
00401         <span class="comment">//</span>
00402         Alignment = Cluster * <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a> - 1;
00403         <span class="keywordflow">if</span> (((ULONG_PTR)BaseBlock &amp; Alignment) != 0) {
00404             (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o3">Free</a>)(BaseBlock, <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html">HBASE_BLOCK</a>));
00405             BaseBlock = (<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html">PHBASE_BLOCK</a>)((<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o2">Allocate</a>)(<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>));
00406             <span class="keywordflow">if</span> (BaseBlock == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00407                 <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00408             }
00409 
00410             <span class="comment">//</span>
00411             <span class="comment">// Return the quota for the extra allocation, as we are not really using</span>
00412             <span class="comment">// it and it will not be accounted for later when we free it.</span>
00413             <span class="comment">//</span>
00414             <a class="code" href="../../d1/d2/cmp_8h.html#a248">CmpReleaseGlobalQuota</a>(PAGE_SIZE - <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html">HBASE_BLOCK</a>));
00415         }
00416 
00417         BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o0">Signature</a> = <a class="code" href="../../d0/d1/hivedata_8h.html#a26">HBASE_BLOCK_SIGNATURE</a>;
00418         BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o1">Sequence1</a> = 1;
00419         BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o2">Sequence2</a> = 1;
00420         BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o3">TimeStamp</a>.HighPart = 0;
00421         BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o3">TimeStamp</a>.LowPart = 0;
00422         BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o4">Major</a> = <a class="code" href="../../d0/d1/hivedata_8h.html#a27">HSYS_MAJOR</a>;
00423         BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o5">Minor</a> = <a class="code" href="../../d0/d1/hivedata_8h.html#a28">HSYS_MINOR</a>;
00424         BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o6">Type</a> = <a class="code" href="../../d0/d1/hivedata_8h.html#a38">HFILE_TYPE_PRIMARY</a>;
00425         BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o7">Format</a> = <a class="code" href="../../d0/d1/hivedata_8h.html#a29">HBASE_FORMAT_MEMORY</a>;
00426         BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o8">RootCell</a> = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
00427         BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o9">Length</a> = 0;
00428         BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o10">Cluster</a> = Cluster;
00429         BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o13">CheckSum</a> = 0;
00430         <a class="code" href="../../d5/d1/hiveinit_8c.html#a1">HvpFillFileName</a>(BaseBlock, FileName);
00431         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a> = BaseBlock;
00432         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o21">Version</a> = <a class="code" href="../../d0/d1/hivedata_8h.html#a28">HSYS_MINOR</a>;
00433 
00434         <span class="keywordflow">return</span> STATUS_SUCCESS;
00435     }
00436 
00437     <span class="comment">//</span>
00438     <span class="comment">// flat image case</span>
00439     <span class="comment">//</span>
00440     <span class="keywordflow">if</span> (OperationType == <a class="code" href="../../d6/d0/hive_8h.html#a8">HINIT_FLAT</a>) {
00441         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a> = (<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html">PHBASE_BLOCK</a>)HiveData;
00442         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o21">Version</a> = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o5">Minor</a>;
00443         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o13">Flat</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00444         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o14">ReadOnly</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00445         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o1">GetCellRoutine</a> = <a class="code" href="../../d6/d0/hive_8h.html#a28">HvpGetCellFlat</a>;
00446         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].Length = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o9">Length</a>;
00447         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o20">StorageTypeCount</a> = 1;
00448         <span class="keywordflow">return</span> STATUS_SUCCESS;
00449     }
00450 
00451     <span class="comment">//</span>
00452     <span class="comment">// readonly image case</span>
00453     <span class="comment">//</span>
00454     <span class="keywordflow">if</span> (OperationType == <a class="code" href="../../d6/d0/hive_8h.html#a7">HINIT_MEMORY_INPLACE</a>) {
00455         BaseBlock = (<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html">PHBASE_BLOCK</a>)HiveData;
00456 
00457         <span class="keywordflow">if</span> ( (BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o0">Signature</a> != <a class="code" href="../../d0/d1/hivedata_8h.html#a26">HBASE_BLOCK_SIGNATURE</a>)   ||
00458              (BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o6">Type</a> != <a class="code" href="../../d0/d1/hivedata_8h.html#a38">HFILE_TYPE_PRIMARY</a>)           ||
00459              (BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o4">Major</a> != <a class="code" href="../../d0/d1/hivedata_8h.html#a27">HSYS_MAJOR</a>)                  ||
00460              (BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o5">Minor</a> &gt; <a class="code" href="../../d0/d1/hivedata_8h.html#a28">HSYS_MINOR</a>)                   ||
00461              (BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o7">Format</a> != <a class="code" href="../../d0/d1/hivedata_8h.html#a29">HBASE_FORMAT_MEMORY</a>)        ||
00462              (BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o1">Sequence1</a> != BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o2">Sequence2</a>)    ||
00463              (<a class="code" href="../../d9/d1/hivesum_8c.html#a0">HvpHeaderCheckSum</a>(BaseBlock) !=
00464               (BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o13">CheckSum</a>))
00465            )
00466         {
00467             <span class="keywordflow">return</span> STATUS_REGISTRY_CORRUPT;
00468         }
00469 
00470         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a> = BaseBlock;
00471         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o21">Version</a> = BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o5">Minor</a>;
00472         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o14">ReadOnly</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00473         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o20">StorageTypeCount</a> = 1;
00474 
00475         <span class="keywordflow">if</span> (FileType == <a class="code" href="../../d0/d1/hivedata_8h.html#a39">HFILE_TYPE_ALTERNATE</a>) {
00476             <span class="comment">//</span>
00477             <span class="comment">// Mark the baseblock with Type==HFILE_TYPE_ALTERNATE.  This</span>
00478             <span class="comment">// case will never show up on disk, because we always flush</span>
00479             <span class="comment">// Type==HFILE_TYPE_PRIMARY to the alternate file.  Any</span>
00480             <span class="comment">// baseblock with Type==HFILE_TYPE_ALTERNATE indicates that</span>
00481             <span class="comment">// the primary is corrupt and must be rewritten.</span>
00482             <span class="comment">//</span>
00483             BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o6">Type</a>=<a class="code" href="../../d0/d1/hivedata_8h.html#a39">HFILE_TYPE_ALTERNATE</a>;
00484 
00485             <span class="comment">//</span>
00486             <span class="comment">// baseblock has changed, recompute the checksum.</span>
00487             <span class="comment">//</span>
00488             BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o13">CheckSum</a>=<a class="code" href="../../d9/d1/hivesum_8c.html#a0">HvpHeaderCheckSum</a>(BaseBlock);
00489         }
00490 
00491         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d7/d1/hivemap_8c.html#a9">HvpBuildMap</a>(
00492                             Hive,
00493                             (PUCHAR)HiveData + HBLOCK_SIZE,
00494                             TailDisplay
00495                             )))
00496         {
00497             <span class="keywordflow">return</span> STATUS_REGISTRY_CORRUPT;
00498         }
00499 
00500         <span class="comment">// debug-only</span>
00501         <a class="code" href="../../d5/d1/hiveinit_8c.html#a0">HvpDumpFreeDisplay</a>(Hive);
00502 
00503         <span class="keywordflow">return</span>(STATUS_SUCCESS);
00504     }
00505 
00506     <span class="comment">//</span>
00507     <span class="comment">// memory copy case</span>
00508     <span class="comment">//</span>
00509     <span class="keywordflow">if</span> (OperationType == <a class="code" href="../../d6/d0/hive_8h.html#a5">HINIT_MEMORY</a>) {
00510         BaseBlock = (<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html">PHBASE_BLOCK</a>)HiveData;
00511 
00512         <span class="keywordflow">if</span> ( (BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o0">Signature</a> != <a class="code" href="../../d0/d1/hivedata_8h.html#a26">HBASE_BLOCK_SIGNATURE</a>)   ||
00513              ((BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o6">Type</a> != <a class="code" href="../../d0/d1/hivedata_8h.html#a38">HFILE_TYPE_PRIMARY</a>)    &amp;&amp;
00514               (BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o6">Type</a> != <a class="code" href="../../d0/d1/hivedata_8h.html#a39">HFILE_TYPE_ALTERNATE</a>))       ||
00515              (BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o7">Format</a> != <a class="code" href="../../d0/d1/hivedata_8h.html#a29">HBASE_FORMAT_MEMORY</a>)        ||
00516              (BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o4">Major</a> != <a class="code" href="../../d0/d1/hivedata_8h.html#a27">HSYS_MAJOR</a>)                  ||
00517              (BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o5">Minor</a> &gt; <a class="code" href="../../d0/d1/hivedata_8h.html#a28">HSYS_MINOR</a>)                   ||
00518              (<a class="code" href="../../d9/d1/hivesum_8c.html#a0">HvpHeaderCheckSum</a>(BaseBlock) !=
00519               (BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o13">CheckSum</a>))
00520            )
00521         {
00522             <span class="keywordflow">return</span> STATUS_REGISTRY_CORRUPT;
00523         }
00524 
00525         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a> = (<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html">PHBASE_BLOCK</a>)((<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o2">Allocate</a>)(<span class="keyword">sizeof</span>(<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html">HBASE_BLOCK</a>), UseForIo));
00526         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>==<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00527             <span class="keywordflow">return</span>(STATUS_INSUFFICIENT_RESOURCES);
00528         }
00529         <span class="comment">//</span>
00530         <span class="comment">// Make sure the buffer we got back is cluster-aligned. If not, try</span>
00531         <span class="comment">// harder to get an aligned buffer.</span>
00532         <span class="comment">//</span>
00533         Alignment = Cluster * <a class="code" href="../../d0/d1/hivedata_8h.html#a15">HSECTOR_SIZE</a> - 1;
00534         <span class="keywordflow">if</span> (((ULONG_PTR)<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a> &amp; Alignment) != 0) {
00535             (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o3">Free</a>)(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html">HBASE_BLOCK</a>));
00536             <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a> = (<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html">PHBASE_BLOCK</a>)((<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o2">Allocate</a>)(<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>));
00537             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00538                 <span class="keywordflow">return</span> (STATUS_INSUFFICIENT_RESOURCES);
00539             }
00540         }
00541         RtlCopyMemory(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>, BaseBlock, HSECTOR_SIZE);
00542 
00543         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o21">Version</a> = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o5">Minor</a>;
00544 
00545         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d7/d1/hivemap_8c.html#a6">HvpBuildMapAndCopy</a>(Hive,
00546                                             (PUCHAR)HiveData + HBLOCK_SIZE,
00547                                             TailDisplay))) {
00548 
00549             (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o3">Free</a>)(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>, <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html">HBASE_BLOCK</a>));
00550             <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00551             <span class="keywordflow">return</span> STATUS_REGISTRY_CORRUPT;
00552         }
00553 
00554         <span class="keywordflow">if</span> (BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o6">Type</a> == <a class="code" href="../../d0/d1/hivedata_8h.html#a39">HFILE_TYPE_ALTERNATE</a>) {
00555             <span class="comment">//</span>
00556             <span class="comment">// Note that Type==HFILE_TYPE_ALTERNATE will NEVER occur in</span>
00557             <span class="comment">// an on-disk image.  The only way this can show up in the</span>
00558             <span class="comment">// baseblock is when the osloader rejects the SYSTEM hive and</span>
00559             <span class="comment">// successfully loads SYSTEM.ALT.  When this happens, it</span>
00560             <span class="comment">// forces HFILE_TYPE_ALTERNATE into the in-memory image of</span>
00561             <span class="comment">// the baseblock.</span>
00562             <span class="comment">//</span>
00563             <span class="comment">// We've booted from SYSTEM.ALT.  Mark the whole hive dirty</span>
00564             <span class="comment">// so everything gets flushed to SYSTEM as soon as we can</span>
00565             <span class="comment">// do I/O.</span>
00566             <span class="comment">//</span>
00567             <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a28">RtlSetAllBits</a>(&amp;(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>));
00568             <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o10">DirtyCount</a>=<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>.SizeOfBitMap;
00569 
00570         }
00571         <a class="code" href="../../d5/d1/hiveinit_8c.html#a1">HvpFillFileName</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>, FileName);
00572         
00573         <span class="comment">// debug - only</span>
00574         <a class="code" href="../../d5/d1/hiveinit_8c.html#a0">HvpDumpFreeDisplay</a>(Hive);
00575        
00576         <span class="keywordflow">return</span>(STATUS_SUCCESS);
00577     }
00578 
00579     <span class="comment">//</span>
00580     <span class="comment">// file read case</span>
00581     <span class="comment">//</span>
00582     <span class="keywordflow">if</span> (OperationType == <a class="code" href="../../d6/d0/hive_8h.html#a6">HINIT_FILE</a>) {
00583 
00584         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_BIN, CMS_BIN_MAP) {
00585             KdPrint((<span class="stringliteral">"HvInitializeHive(%wZ,HINIT_FILE) :\n"</span>, FileName));
00586         }
00587         <span class="comment">//</span>
00588         <span class="comment">// get the file image (possible recovered via log) into memory</span>
00589         <span class="comment">//</span>
00590         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d1/hiveload_8c.html#a19">HvLoadHive</a>(Hive, TailDisplay);
00591         <span class="keywordflow">if</span> ((<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_SUCCESS) &amp;&amp; (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_REGISTRY_RECOVERED)) {
00592             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00593         }
00594 
00595         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(CML_BIN, CMS_BIN_MAP) {
00596             KdPrint((<span class="stringliteral">"\n"</span>));
00597         }
00598         
00599         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_REGISTRY_RECOVERED) {
00600 
00601             <span class="comment">//</span>
00602             <span class="comment">// We have a good hive, with a log, and a dirty map,</span>
00603             <span class="comment">// all set up.  Only problem is that we need to flush</span>
00604             <span class="comment">// the file so the log can be cleared and new writes</span>
00605             <span class="comment">// posted against the hive.  Since we know we have</span>
00606             <span class="comment">// a good log in hand, we just write the hive image.</span>
00607             <span class="comment">//</span>
00608             <span class="keywordflow">if</span> ( ! <a class="code" href="../../d0/d2/hivesync_8c.html#a14">HvpDoWriteHive</a>(Hive, HFILE_TYPE_PRIMARY)) {
00609                 <span class="comment">//</span>
00610                 <span class="comment">// DRAGOS: Here we need cleanup </span>
00611                 <span class="comment">// Clean up the bins already allocated </span>
00612                 <span class="comment">//</span>
00613                 <a class="code" href="../../d5/d1/hiveinit_8c.html#a2">HvpFreeAllocatedBins</a>( Hive );
00614 
00615                 <span class="keywordflow">return</span> STATUS_REGISTRY_IO_FAILED;
00616             }
00617 
00618             <span class="comment">//</span>
00619             <span class="comment">// If we get here, we have recovered the hive, and</span>
00620             <span class="comment">// written it out to disk correctly.  So we clear</span>
00621             <span class="comment">// the log here.</span>
00622             <span class="comment">//</span>
00623             <a class="code" href="../../d4/d1/rtl_2bitmap_8c.html#a27">RtlClearAllBits</a>(&amp;(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o9">DirtyVector</a>));
00624             <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o10">DirtyCount</a> = 0;
00625             (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o4">FileSetSize</a>)(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, <a class="code" href="../../d0/d1/hivedata_8h.html#a40">HFILE_TYPE_LOG</a>, 0);
00626             <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o18">LogSize</a> = 0;
00627         }
00628 
00629         <span class="comment">//</span>
00630         <span class="comment">// slam debug name data into base block</span>
00631         <span class="comment">//</span>
00632         <a class="code" href="../../d5/d1/hiveinit_8c.html#a1">HvpFillFileName</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o8">BaseBlock</a>, FileName);
00633 
00634         <span class="comment">// debug - only</span>
00635         <a class="code" href="../../d5/d1/hiveinit_8c.html#a0">HvpDumpFreeDisplay</a>(Hive);
00636 
00637         <span class="keywordflow">return</span> STATUS_SUCCESS;
00638     }
00639 
00640     <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00641 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="hiveinit.c::HvpFillFileName" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID HvpFillFileName           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d6/d4/struct__HBASE__BLOCK.html">PHBASE_BLOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>BaseBlock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>FileName</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/hiveinit_8c-source.html#l00645">645</a> of file <a class="el" href="../../d6/d0/hiveinit_8c-source.html">hiveinit.c</a>.
<p>
References <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00346">_HBASE_BLOCK::FileName</a>, <a class="el" href="../../d3/d1/rtload_8c-source.html#l00047">FileName</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00331">HBASE_NAME_ALLOC</a>, and <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/hiveinit_8c-source.html#l00158">HvInitializeHive()</a>.
<p>
<pre class="fragment"><div>00651                    :
00652 
00653     <a class="code" href="../../d6/d6/ttime_8c.html#a0">Zero</a> <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> filename portion of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base block.
00654     If <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, copy last 64 bytes into name tail
00655         field of base block
00656 
00657 Arguments:
00658 
00659     BaseBlock - supplies pointer to a base block
00660 
00661     <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a> - supplies pointer to a unicode STRING
00662 
00663 Return Value:
00664 
00665     None.
00666 
00667 --*/
00668 {
00669     ULONG   offset;
00670     ULONG   length;
00671     PUCHAR  sptr;
00672 
00673 <span class="preprocessor">#if 0</span>
00674 <span class="preprocessor"></span>    KdPrint((<span class="stringliteral">"HvpFillFileName: %wZ\n"</span>, FileName));
00675 <span class="preprocessor">#endif</span>
00676 <span class="preprocessor"></span>
00677     RtlZeroMemory((PVOID)&amp;(BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o11">FileName</a>[0]), HBASE_NAME_ALLOC);
00678 
00679     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00680         <span class="keywordflow">return</span>;
00681     }
00682 
00683     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Length &lt;= <a class="code" href="../../d0/d1/hivedata_8h.html#a30">HBASE_NAME_ALLOC</a>) {
00684         offset = 0;
00685         length = <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Length;
00686     } <span class="keywordflow">else</span> {
00687         offset = <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Length - <a class="code" href="../../d0/d1/hivedata_8h.html#a30">HBASE_NAME_ALLOC</a>;
00688         length = <a class="code" href="../../d0/d1/hivedata_8h.html#a30">HBASE_NAME_ALLOC</a>;
00689     }
00690 
00691     sptr = (PUCHAR)&amp;(<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Buffer[0]);
00692     RtlMoveMemory(
00693         (PVOID)&amp;(BaseBlock-&gt;<a class="code" href="../../d6/d4/struct__HBASE__BLOCK.html#o11">FileName</a>[0]),
00694         (PVOID)&amp;(sptr[offset]),
00695         length
00696         );
00697 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="hiveinit.c::HvpFreeAllocatedBins" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID HvpFreeAllocatedBins           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Hive</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/hiveinit_8c-source.html#l00085">85</a> of file <a class="el" href="../../d6/d0/hiveinit_8c-source.html">hiveinit.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00136">Bin</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00423">_HMAP_ENTRY::BinAddress</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00598">_HHIVE::Free</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00122">HBLOCK_SIZE</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00092">Hive</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00412">HMAP_BASE</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00413">HMAP_NEWALLOC</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00132">HTABLE_SLOTS</a>, <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00200">_HBIN::MemAlloc</a>, <a class="el" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>, and <a class="el" href="../../d1/d0/hivedata_8h-source.html#l00439">_HMAP_TABLE::Table</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/hiveinit_8c-source.html#l00158">HvInitializeHive()</a>, and <a class="el" href="../../d7/d0/hiveload_8c-source.html#l00100">HvLoadHive()</a>.
<p>
<pre class="fragment"><div>00090                    :
00091 
00092     Free all <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> bins allocated <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified hive.
00093     It applies <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> to stable storage. Not all bins are allocated.
00094     Those that are not allocated have BinAddress set to 0
00095     
00096 Arguments:
00097 
00098     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> - supplies a pointer to hive <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> structure <span class="keywordflow">for</span> hive who's bin to free.
00099 
00100 Return Value:
00101 
00102     NONE.
00103 
00104 --*/
00105 {
00106     ULONG           Length;
00107     <a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>           <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>;
00108     ULONG           MapSlots;
00109     ULONG           Tables;
00110     <a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html">PHMAP_ENTRY</a>     Me;
00111     <a class="code" href="../../d3/d8/struct__HMAP__TABLE.html">PHMAP_TABLE</a>     Tab;
00112     ULONG           i;
00113     ULONG           j;
00114 
00115     <span class="comment">//</span>
00116     <span class="comment">// calculate the number of tables in the map</span>
00117     <span class="comment">//</span>
00118     Length = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].Length;
00119     MapSlots = Length / <a class="code" href="../../d0/d1/hivedata_8h.html#a14">HBLOCK_SIZE</a>;
00120     <span class="keywordflow">if</span>( MapSlots &gt; 0 ) {
00121         Tables = (MapSlots-1) / <a class="code" href="../../d0/d1/hivedata_8h.html#a17">HTABLE_SLOTS</a>;
00122     } <span class="keywordflow">else</span> {
00123         Tables = 0;
00124     }
00125 
00126     <span class="keywordflow">if</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].Map ) {
00127         <span class="comment">//</span>
00128         <span class="comment">// iterate through the directory </span>
00129         <span class="comment">//</span>
00130         <span class="keywordflow">for</span> (i = 0; i &lt;= Tables; i++) {
00131             Tab = <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;Storage[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>].Map-&gt;Directory[i];
00132 
00133             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Tab);
00134             
00135             <span class="comment">//</span>
00136             <span class="comment">// iterate through the slots in the directory</span>
00137             <span class="comment">//</span>
00138             <span class="keywordflow">for</span>(j=0;j&lt;<a class="code" href="../../d0/d1/hivedata_8h.html#a17">HTABLE_SLOTS</a>;j++) {
00139                 Me = &amp;(Tab-&gt;<a class="code" href="../../d3/d8/struct__HMAP__TABLE.html#o0">Table</a>[j]);
00140                 <span class="comment">//</span>
00141                 <span class="comment">// BinAddress non-zero means allocated bin</span>
00142                 <span class="comment">//</span>
00143                 <span class="keywordflow">if</span>( Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> ) {
00144                     <span class="keywordflow">if</span>( Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a35">HMAP_NEWALLOC</a> ) {
00145                         <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a> = (<a class="code" href="../../d7/d4/struct__HBIN.html">PHBIN</a>)(Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> &amp; <a class="code" href="../../d0/d1/hivedata_8h.html#a34">HMAP_BASE</a>);
00146                         (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o3">Free</a>)(<a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>, <a class="code" href="../../d7/d0/cmdat2_8c.html#a36">Bin</a>-&gt;<a class="code" href="../../d7/d4/struct__HBIN.html#o5">MemAlloc</a>);
00147                     }
00148                     
00149                     Me-&gt;<a class="code" href="../../d2/d8/struct__HMAP__ENTRY.html#o1">BinAddress</a> = 0;
00150                 }
00151             }
00152         }
00153     }
00154    
00155 }

</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:44:05 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
