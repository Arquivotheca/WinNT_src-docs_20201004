<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: fat_rec.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>fat_rec.c File Reference</h1><code>#include "<a class="el" href="../../d8/d6/fs__rec_8h-source.html">fs_rec.h</a>"</code><br>
<code>#include "<a class="el" href="../../d7/d0/fat__rec_8h-source.html">fat_rec.h</a>"</code><br>

<p>
<a href="../../d6/d0/fat__rec_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/fat__rec_8c.html#a0">Dbg</a>&nbsp;&nbsp;&nbsp;(FSREC_DEBUG_LEVEL_FAT)</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/fat__rec_8c.html#a1">FatRecFsControl</a> (IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject, IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/fat__rec_8c.html#a2">IsFatVolume</a> (IN <a class="el" href="../../d9/d7/struct__PACKED__BOOT__SECTOR.html">PPACKED_BOOT_SECTOR</a> <a class="el" href="../../d8/d6/ttri_8c.html#a3">Buffer</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d1/fat__rec_8c.html#a3">UnpackBiosParameterBlock</a> (IN <a class="el" href="../../d8/d7/struct__PACKED__BIOS__PARAMETER__BLOCK.html">PPACKED_BIOS_PARAMETER_BLOCK</a> Bios, OUT <a class="el" href="../../d1/d1/structBIOS__PARAMETER__BLOCK.html">PBIOS_PARAMETER_BLOCK</a> UnpackedBios)</td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a0" doxytag="fat_rec.c::Dbg" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define Dbg&nbsp;&nbsp;&nbsp;(FSREC_DEBUG_LEVEL_FAT)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/fat__rec_8c-source.html#l00033">33</a> of file <a class="el" href="../../d6/d0/fat__rec_8c-source.html">fat_rec.c</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a1" doxytag="fat_rec.c::FatRecFsControl" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS FatRecFsControl           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/fat__rec_8c-source.html#l00043">43</a> of file <a class="el" href="../../d6/d0/fat__rec_8c-source.html">fat_rec.c</a>.
<p>
References <a class="el" href="../../d1/d4/io_8h-source.html#l01185">_DEVICE_OBJECT::Characteristics</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d7/d6/fs__rec_8c-source.html#l00800">FsRecGetDeviceSectorSize()</a>, <a class="el" href="../../d7/d6/fs__rec_8c-source.html#l00579">FsRecLoadFileSystem()</a>, <a class="el" href="../../d7/d6/fs__rec_8c-source.html#l00907">FsRecReadBlock()</a>, <a class="el" href="../../d8/d7/exboosts_8h-source.html#l00056">IO_NO_INCREMENT</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02960">IoCompleteRequest</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03252">IoGetCurrentIrpStackLocation</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01635">_IRP::IoStatus</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00115">IRP_MN_LOAD_FILE_SYSTEM</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00113">IRP_MN_MOUNT_VOLUME</a>, <a class="el" href="../../d6/d0/fat__rec_8c-source.html#l00184">IsFatVolume()</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02029">_IO_STACK_LOCATION::MinorFunction</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02069">_IO_STACK_LOCATION::Parameters</a>, <a class="el" href="../../d7/d0/fat__rec_8h-source.html#l00122">PPACKED_BOOT_SECTOR</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d7/d6/fs__rec_8c-source.html#l00446">FsRecFsControl()</a>.
<p>
<pre class="fragment"><div>00050                    :
00051 
00052     This function performs <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> mount and driver reload <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a16">functions</a> <span class="keywordflow">for</span> <span class="keyword">this</span> mini-
00053     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> system recognizer driver.
00054 
00055 Arguments:
00056 
00057     DeviceObject - Pointer to <span class="keyword">this</span> driver's device object.
00058 
00059     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> I/O <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a24">Request</a> Packet (<a class="code" href="../../d0/d2/struct__IRP.html">IRP</a>) representing the function to
00060         be performed.
00061 
00062 Return Value:
00063 
00064     The function value is the final status of the operation.
00065 
00066 
00067 --*/
00068 
00069 {
00070     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00071     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> irpSp;
00072     <a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html">PDEVICE_EXTENSION</a> deviceExtension;
00073     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> targetDevice;
00074     <a class="code" href="../../d9/d7/struct__PACKED__BOOT__SECTOR.html">PPACKED_BOOT_SECTOR</a> buffer;
00075     LARGE_INTEGER byteOffset;
00076     UNICODE_STRING driverName;
00077     ULONG bytesPerSector;
00078     BOOLEAN isDeviceFailure = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00079 
00080     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00081 
00082     <span class="comment">//</span>
00083     <span class="comment">// Begin by determining what function that is to be performed.</span>
00084     <span class="comment">//</span>
00085 
00086     deviceExtension = (<a class="code" href="../../d8/d3/struct__DEVICE__EXTENSION.html">PDEVICE_EXTENSION</a>) DeviceObject-&gt;DeviceExtension;
00087     irpSp = <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>( Irp );
00088 
00089     <span class="keywordflow">switch</span> ( irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o1">MinorFunction</a> ) {
00090 
00091     <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a47">IRP_MN_MOUNT_VOLUME</a>:
00092 
00093         <span class="comment">//</span>
00094         <span class="comment">// Attempt to mount a volume:  Determine whether or not the volume in</span>
00095         <span class="comment">// question is a FAT volume and, if so, let the I/O system know that it</span>
00096         <span class="comment">// is by returning a special status code so that this driver can get</span>
00097         <span class="comment">// called back to load the FAT file system.</span>
00098         <span class="comment">//</span>
00099 
00100         status = STATUS_UNRECOGNIZED_VOLUME;
00101 
00102         <span class="comment">//</span>
00103         <span class="comment">// Attempt to determine whether or not the target volume being mounted</span>
00104         <span class="comment">// is a FAT volume.  Note that if an error occurs, and this is a floppy</span>
00105         <span class="comment">// drive, and the error occurred on the actual read from the device,</span>
00106         <span class="comment">// then the FAT file system will actually be loaded to handle the</span>
00107         <span class="comment">// problem since this driver is a place holder and does not need to</span>
00108         <span class="comment">// know all of the protocols for handling floppy errors.</span>
00109         <span class="comment">//</span>
00110 
00111         targetDevice = irpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.MountVolume.DeviceObject;
00112 
00113         <span class="comment">//</span>
00114         <span class="comment">//  First retrieve the sector size for this media.</span>
00115         <span class="comment">//</span>
00116 
00117         <span class="keywordflow">if</span> (<a class="code" href="../../d7/d7/fs__rec_8h.html#a30">FsRecGetDeviceSectorSize</a>( targetDevice,
00118                                       &amp;bytesPerSector )) {
00119 
00120             byteOffset.QuadPart = 0;
00121             buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00122 
00123             <span class="keywordflow">if</span> (<a class="code" href="../../d7/d7/fs__rec_8h.html#a32">FsRecReadBlock</a>( targetDevice,
00124                                 &amp;byteOffset,
00125                                 512,
00126                                 bytesPerSector,
00127                                 &amp;buffer,
00128                                 &amp;isDeviceFailure ) &amp;&amp;
00129                 <a class="code" href="../../d6/d1/fat__rec_8h.html#a15">IsFatVolume</a>( buffer )) {
00130                     
00131                 status = STATUS_FS_DRIVER_REQUIRED;
00132                 
00133             }
00134 
00135             <span class="keywordflow">if</span> (buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00136                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( buffer );
00137             }
00138             
00139          } <span class="keywordflow">else</span> {
00140 
00141              <span class="comment">//</span>
00142              <span class="comment">//  Devices that can't get us this much ...</span>
00143              <span class="comment">//</span>
00144 
00145              isDeviceFailure = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00146          }
00147             
00148          <span class="comment">//</span>
00149          <span class="comment">//  See if we should make the real filesystem take a shot at a wacky floppy.</span>
00150          <span class="comment">//</span>
00151          
00152          <span class="keywordflow">if</span> (isDeviceFailure) {
00153              <span class="keywordflow">if</span> (targetDevice-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o9">Characteristics</a> &amp; FILE_FLOPPY_DISKETTE) {
00154                  status = STATUS_FS_DRIVER_REQUIRED;
00155              }
00156          }
00157 
00158          <span class="keywordflow">break</span>;
00159 
00160     <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a49">IRP_MN_LOAD_FILE_SYSTEM</a>:
00161 
00162         status = <a class="code" href="../../d7/d7/fs__rec_8h.html#a29">FsRecLoadFileSystem</a>( DeviceObject,
00163                                       L<span class="stringliteral">"\\Registry\\Machine\\System\\CurrentControlSet\\Services\\Fastfat"</span> );
00164         <span class="keywordflow">break</span>;
00165 
00166     <span class="keywordflow">default</span>:
00167         status = STATUS_INVALID_DEVICE_REQUEST;
00168 
00169     }
00170 
00171     <span class="comment">//</span>
00172     <span class="comment">// Finally, complete the request and return the same status code to the</span>
00173     <span class="comment">// caller.</span>
00174     <span class="comment">//</span>
00175 
00176     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status = status;
00177     <a class="code" href="../../d0/d5/io_8h.html#a224">IoCompleteRequest</a>( Irp, IO_NO_INCREMENT );
00178 
00179     <span class="keywordflow">return</span> status;
00180 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="fat_rec.c::IsFatVolume" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN IsFatVolume           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d9/d7/struct__PACKED__BOOT__SECTOR.html">PPACKED_BOOT_SECTOR</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Buffer</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/fat__rec_8c-source.html#l00184">184</a> of file <a class="el" href="../../d6/d0/fat__rec_8c-source.html">fat_rec.c</a>.
<p>
References <a class="el" href="../../d7/d1/rtqkey_8c-source.html#l00042">Buffer</a>, <a class="el" href="../../d7/d0/fat__rec_8h-source.html#l00092">BIOS_PARAMETER_BLOCK::BytesPerSector</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d7/d0/fat__rec_8h-source.html#l00095">BIOS_PARAMETER_BLOCK::Fats</a>, <a class="el" href="../../d7/d0/fat__rec_8h-source.html#l00103">BIOS_PARAMETER_BLOCK::LargeSectors</a>, <a class="el" href="../../d7/d0/fat__rec_8h-source.html#l00098">BIOS_PARAMETER_BLOCK::Media</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d7/d0/fat__rec_8h-source.html#l00094">BIOS_PARAMETER_BLOCK::ReservedSectors</a>, <a class="el" href="../../d7/d0/fat__rec_8h-source.html#l00096">BIOS_PARAMETER_BLOCK::RootEntries</a>, <a class="el" href="../../d7/d0/fat__rec_8h-source.html#l00097">BIOS_PARAMETER_BLOCK::Sectors</a>, <a class="el" href="../../d7/d0/fat__rec_8h-source.html#l00093">BIOS_PARAMETER_BLOCK::SectorsPerCluster</a>, <a class="el" href="../../d7/d0/fat__rec_8h-source.html#l00099">BIOS_PARAMETER_BLOCK::SectorsPerFat</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d6/d0/fat__rec_8c-source.html#l00309">UnpackBiosParameterBlock()</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/fat__rec_8c-source.html#l00043">FatRecFsControl()</a>.
<p>
<pre class="fragment"><div>00190                    :
00191 
00192     This routine looks at <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer passed in which contains <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> FAT boot
00193     sector and determines whether or not <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> represents an actual FAT boot
00194     sector.
00195 
00196 Arguments:
00197 
00198     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> - Pointer to buffer containing potential boot block.
00199 
00200 Return Value:
00201 
00202     The function returns <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer contains a recognizable FAT boot
00203     sector, otherwise <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> returns <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>.
00204 
00205 --*/
00206 
00207 {
00208     <a class="code" href="../../d1/d1/structBIOS__PARAMETER__BLOCK.html">BIOS_PARAMETER_BLOCK</a> bios;
00209     BOOLEAN result;
00210 
00211     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00212 
00213     <span class="comment">//</span>
00214     <span class="comment">// Begin by unpacking the Bios Parameter Block that is packed in the boot</span>
00215     <span class="comment">// sector so that it can be examined without incurring alignment faults.</span>
00216     <span class="comment">//</span>
00217 
00218     <a class="code" href="../../d6/d1/fat__rec_8h.html#a16">UnpackBiosParameterBlock</a>( &amp;<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;PackedBpb, &amp;bios );
00219 
00220     <span class="comment">//</span>
00221     <span class="comment">// Assume that the sector represents a FAT boot block and then determine</span>
00222     <span class="comment">// whether or not it really does.</span>
00223     <span class="comment">//</span>
00224 
00225     result = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00226 
00227     <span class="keywordflow">if</span> (bios.<a class="code" href="../../d1/d1/structBIOS__PARAMETER__BLOCK.html#o5">Sectors</a>) {
00228         bios.<a class="code" href="../../d1/d1/structBIOS__PARAMETER__BLOCK.html#o11">LargeSectors</a> = 0;
00229     }
00230 
00231     <span class="comment">// FMR Jul.11.1994 NaokiM - Fujitsu -</span>
00232     <span class="comment">// FMR boot sector has 'IPL1' string at the beginnig.</span>
00233 
00234     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;Jump[0] != 0x49 &amp;&amp; <span class="comment">/* FMR */</span>
00235         <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;Jump[0] != 0xe9 &amp;&amp;
00236         <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;Jump[0] != 0xeb) {
00237 
00238         result = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00239 
00240 
00241     <span class="comment">// FMR Jul.11.1994 NaokiM - Fujitsu -</span>
00242     <span class="comment">// Sector size of FMR partition is 2048.</span>
00243 
00244     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bios.<a class="code" href="../../d1/d1/structBIOS__PARAMETER__BLOCK.html#o0">BytesPerSector</a> !=  128 &amp;&amp;
00245                bios.<a class="code" href="../../d1/d1/structBIOS__PARAMETER__BLOCK.html#o0">BytesPerSector</a> !=  256 &amp;&amp;
00246                bios.<a class="code" href="../../d1/d1/structBIOS__PARAMETER__BLOCK.html#o0">BytesPerSector</a> !=  512 &amp;&amp;
00247                bios.<a class="code" href="../../d1/d1/structBIOS__PARAMETER__BLOCK.html#o0">BytesPerSector</a> != 1024 &amp;&amp;
00248                bios.<a class="code" href="../../d1/d1/structBIOS__PARAMETER__BLOCK.html#o0">BytesPerSector</a> != 2048 &amp;&amp; <span class="comment">/* FMR */</span>
00249                bios.<a class="code" href="../../d1/d1/structBIOS__PARAMETER__BLOCK.html#o0">BytesPerSector</a> != 4096) {
00250 
00251         result = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00252 
00253     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bios.<a class="code" href="../../d1/d1/structBIOS__PARAMETER__BLOCK.html#o1">SectorsPerCluster</a> !=  1 &amp;&amp;
00254                bios.<a class="code" href="../../d1/d1/structBIOS__PARAMETER__BLOCK.html#o1">SectorsPerCluster</a> !=  2 &amp;&amp;
00255                bios.<a class="code" href="../../d1/d1/structBIOS__PARAMETER__BLOCK.html#o1">SectorsPerCluster</a> !=  4 &amp;&amp;
00256                bios.<a class="code" href="../../d1/d1/structBIOS__PARAMETER__BLOCK.html#o1">SectorsPerCluster</a> !=  8 &amp;&amp;
00257                bios.<a class="code" href="../../d1/d1/structBIOS__PARAMETER__BLOCK.html#o1">SectorsPerCluster</a> != 16 &amp;&amp;
00258                bios.<a class="code" href="../../d1/d1/structBIOS__PARAMETER__BLOCK.html#o1">SectorsPerCluster</a> != 32 &amp;&amp;
00259                bios.<a class="code" href="../../d1/d1/structBIOS__PARAMETER__BLOCK.html#o1">SectorsPerCluster</a> != 64 &amp;&amp;
00260                bios.<a class="code" href="../../d1/d1/structBIOS__PARAMETER__BLOCK.html#o1">SectorsPerCluster</a> != 128) {
00261 
00262         result = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00263 
00264     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!bios.<a class="code" href="../../d1/d1/structBIOS__PARAMETER__BLOCK.html#o2">ReservedSectors</a>) {
00265 
00266         result = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00267 
00268     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!bios.<a class="code" href="../../d1/d1/structBIOS__PARAMETER__BLOCK.html#o3">Fats</a>) {
00269 
00270         result = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00271 
00272     <span class="comment">//</span>
00273     <span class="comment">// Prior to DOS 3.2 might contains value in both of Sectors and</span>
00274     <span class="comment">// Sectors Large.</span>
00275     <span class="comment">//</span>
00276     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!bios.<a class="code" href="../../d1/d1/structBIOS__PARAMETER__BLOCK.html#o5">Sectors</a> &amp;&amp; !bios.<a class="code" href="../../d1/d1/structBIOS__PARAMETER__BLOCK.html#o11">LargeSectors</a>) {
00277 
00278         result = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00279 
00280     <span class="comment">// FMR Jul.11.1994 NaokiM - Fujitsu -</span>
00281     <span class="comment">// 1. Media descriptor of FMR partitions is 0xfa.</span>
00282     <span class="comment">// 2. Media descriptor of partitions formated by FMR OS/2 is 0x00.</span>
00283     <span class="comment">// 3. Media descriptor of floppy disks formated by FMR DOS is 0x01.</span>
00284 
00285     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bios.<a class="code" href="../../d1/d1/structBIOS__PARAMETER__BLOCK.html#o6">Media</a> != 0x00 &amp;&amp; <span class="comment">/* FMR */</span>
00286                bios.<a class="code" href="../../d1/d1/structBIOS__PARAMETER__BLOCK.html#o6">Media</a> != 0x01 &amp;&amp; <span class="comment">/* FMR */</span>
00287                bios.<a class="code" href="../../d1/d1/structBIOS__PARAMETER__BLOCK.html#o6">Media</a> != 0xf0 &amp;&amp;
00288                bios.<a class="code" href="../../d1/d1/structBIOS__PARAMETER__BLOCK.html#o6">Media</a> != 0xf8 &amp;&amp;
00289                bios.<a class="code" href="../../d1/d1/structBIOS__PARAMETER__BLOCK.html#o6">Media</a> != 0xf9 &amp;&amp;
00290                bios.<a class="code" href="../../d1/d1/structBIOS__PARAMETER__BLOCK.html#o6">Media</a> != 0xfa &amp;&amp; <span class="comment">/* FMR */</span>
00291                bios.<a class="code" href="../../d1/d1/structBIOS__PARAMETER__BLOCK.html#o6">Media</a> != 0xfb &amp;&amp;
00292                bios.<a class="code" href="../../d1/d1/structBIOS__PARAMETER__BLOCK.html#o6">Media</a> != 0xfc &amp;&amp;
00293                bios.<a class="code" href="../../d1/d1/structBIOS__PARAMETER__BLOCK.html#o6">Media</a> != 0xfd &amp;&amp;
00294                bios.<a class="code" href="../../d1/d1/structBIOS__PARAMETER__BLOCK.html#o6">Media</a> != 0xfe &amp;&amp;
00295                bios.<a class="code" href="../../d1/d1/structBIOS__PARAMETER__BLOCK.html#o6">Media</a> != 0xff) {
00296 
00297         result = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00298 
00299     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bios.<a class="code" href="../../d1/d1/structBIOS__PARAMETER__BLOCK.html#o7">SectorsPerFat</a> != 0 &amp;&amp; bios.<a class="code" href="../../d1/d1/structBIOS__PARAMETER__BLOCK.html#o4">RootEntries</a> == 0) {
00300 
00301         result = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00302     }
00303 
00304     <span class="keywordflow">return</span> result;
00305 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="fat_rec.c::UnpackBiosParameterBlock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID UnpackBiosParameterBlock           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d7/struct__PACKED__BIOS__PARAMETER__BLOCK.html">PPACKED_BIOS_PARAMETER_BLOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Bios</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d1/d1/structBIOS__PARAMETER__BLOCK.html">PBIOS_PARAMETER_BLOCK</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>UnpackedBios</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d0/fat__rec_8c-source.html#l00309">309</a> of file <a class="el" href="../../d6/d0/fat__rec_8c-source.html">fat_rec.c</a>.
<p>
References <a class="el" href="../../d7/d0/fat__rec_8h-source.html#l00050">CopyUchar1</a>, <a class="el" href="../../d7/d0/fat__rec_8h-source.html#l00058">CopyUchar2</a>, <a class="el" href="../../d7/d0/fat__rec_8h-source.html#l00066">CopyUchar4</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d6/d1/fat__rec_8h.html#a12">PBIOS_PARAMETER_BLOCK</a>, and <a class="el" href="../../d7/d0/fat__rec_8h-source.html#l00089">PPACKED_BIOS_PARAMETER_BLOCK</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/fat__rec_8c-source.html#l00184">IsFatVolume()</a>.
<p>
<pre class="fragment"><div>00316                    :
00317 
00318     This routine copies a packed Bios Parameter Block to an unpacked Bios
00319     Parameter Block.
00320 
00321 Arguments:
00322 
00323     Bios - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> packed Bios Parameter Block.
00324 
00325     UnpackedBios - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> unpacked Bios Parameter Block.
00326 
00327 Return Value:
00328 
00329     None.
00330 
00331 --*/
00332 
00333 {
00334     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00335 
00336     <span class="comment">//</span>
00337     <span class="comment">// Unpack the Bios Parameter Block.</span>
00338     <span class="comment">//</span>
00339 
00340     <a class="code" href="../../d6/d1/fat__rec_8h.html#a1">CopyUchar2</a>( &amp;UnpackedBios-&gt;BytesPerSector, &amp;Bios-&gt;BytesPerSector[0] );
00341     <a class="code" href="../../d6/d1/fat__rec_8h.html#a1">CopyUchar2</a>( &amp;UnpackedBios-&gt;BytesPerSector, &amp;Bios-&gt;BytesPerSector[0] );
00342     <a class="code" href="../../d6/d1/fat__rec_8h.html#a0">CopyUchar1</a>( &amp;UnpackedBios-&gt;SectorsPerCluster, &amp;Bios-&gt;SectorsPerCluster[0] );
00343     <a class="code" href="../../d6/d1/fat__rec_8h.html#a1">CopyUchar2</a>( &amp;UnpackedBios-&gt;ReservedSectors, &amp;Bios-&gt;ReservedSectors[0] );
00344     <a class="code" href="../../d6/d1/fat__rec_8h.html#a0">CopyUchar1</a>( &amp;UnpackedBios-&gt;Fats, &amp;Bios-&gt;Fats[0] );
00345     <a class="code" href="../../d6/d1/fat__rec_8h.html#a1">CopyUchar2</a>( &amp;UnpackedBios-&gt;RootEntries, &amp;Bios-&gt;RootEntries[0] );
00346     <a class="code" href="../../d6/d1/fat__rec_8h.html#a1">CopyUchar2</a>( &amp;UnpackedBios-&gt;Sectors, &amp;Bios-&gt;Sectors[0] );
00347     <a class="code" href="../../d6/d1/fat__rec_8h.html#a0">CopyUchar1</a>( &amp;UnpackedBios-&gt;Media, &amp;Bios-&gt;Media[0] );
00348     <a class="code" href="../../d6/d1/fat__rec_8h.html#a1">CopyUchar2</a>( &amp;UnpackedBios-&gt;SectorsPerFat, &amp;Bios-&gt;SectorsPerFat[0] );
00349     <a class="code" href="../../d6/d1/fat__rec_8h.html#a1">CopyUchar2</a>( &amp;UnpackedBios-&gt;SectorsPerTrack, &amp;Bios-&gt;SectorsPerTrack[0] );
00350     <a class="code" href="../../d6/d1/fat__rec_8h.html#a1">CopyUchar2</a>( &amp;UnpackedBios-&gt;Heads, &amp;Bios-&gt;Heads[0] );
00351     <a class="code" href="../../d6/d1/fat__rec_8h.html#a2">CopyUchar4</a>( &amp;UnpackedBios-&gt;HiddenSectors, &amp;Bios-&gt;HiddenSectors[0] );
00352     <a class="code" href="../../d6/d1/fat__rec_8h.html#a2">CopyUchar4</a>( &amp;UnpackedBios-&gt;LargeSectors, &amp;Bios-&gt;LargeSectors[0] );
00353 }
}
</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:43:36 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
