<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: wsmanage.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>wsmanage.c File Reference</h1><code>#include "<a class="el" href="../../d5/d7/mi_8h-source.html">mi.h</a>"</code><br>

<p>
<a href="../../d6/d9/wsmanage_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Classes</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>union &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d8/d7/union__MMWS__TRIM__CRITERIA.html">_MMWS_TRIM_CRITERIA</a></td></tr>

<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d0/wsmanage_8c.html#a0">MM_TRIM_COUNTER_MAXIMUM_LARGE_MEM</a>&nbsp;&nbsp;&nbsp;(6)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d0/wsmanage_8c.html#a1">MM_REDUCE_FAULT_COUNT</a>&nbsp;&nbsp;&nbsp;(10000)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d0/wsmanage_8c.html#a2">MM_IGNORE_FAULT_COUNT</a>&nbsp;&nbsp;&nbsp;(100)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d0/wsmanage_8c.html#a3">MM_WS_REORG_BUCKETS_MAX</a>&nbsp;&nbsp;&nbsp;7</td></tr>

<tr><td colspan=2><br><h2>Typedefs</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d8/d7/union__MMWS__TRIM__CRITERIA.html">_MMWS_TRIM_CRITERIA</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d0/wsmanage_8c.html#a28">MMWS_TRIM_CRITERIA</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d8/d7/union__MMWS__TRIM__CRITERIA.html">_MMWS_TRIM_CRITERIA</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d0/wsmanage_8c.html#a29">PMMWS_TRIM_CRITERIA</a></td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d0/wsmanage_8c.html#a32">MiEmptyAllWorkingSetsWorker</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LOGICAL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d0/wsmanage_8c.html#a33">MiCheckAndSetSystemTrimCriteria</a> (IN OUT <a class="el" href="../../d8/d7/union__MMWS__TRIM__CRITERIA.html">PMMWS_TRIM_CRITERIA</a> Criteria)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d0/wsmanage_8c.html#a34">MiCheckSystemTrimEndCriteria</a> (IN OUT <a class="el" href="../../d8/d7/union__MMWS__TRIM__CRITERIA.html">PMMWS_TRIM_CRITERIA</a> Criteria, IN KIRQL OldIrql)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d0/wsmanage_8c.html#a35">MiCheckProcessTrimCriteria</a> (IN <a class="el" href="../../d8/d7/union__MMWS__TRIM__CRITERIA.html">PMMWS_TRIM_CRITERIA</a> Criteria, IN <a class="el" href="../../d3/d6/struct__MMSUPPORT.html">PMMSUPPORT</a> VmSupport, IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process, IN PLARGE_INTEGER CurrentTime)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LOGICAL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d0/wsmanage_8c.html#a36">MiCheckSystemCacheWsTrimCriteria</a> (IN <a class="el" href="../../d3/d6/struct__MMSUPPORT.html">PMMSUPPORT</a> VmSupport)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d0/wsmanage_8c.html#a37">MiDetermineWsTrimAmount</a> (IN <a class="el" href="../../d8/d7/union__MMWS__TRIM__CRITERIA.html">PMMWS_TRIM_CRITERIA</a> Criteria, IN <a class="el" href="../../d3/d6/struct__MMSUPPORT.html">PMMSUPPORT</a> VmSupport, IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d0/wsmanage_8c.html#a38">MiRearrangeWorkingSetExpansionList</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d0/wsmanage_8c.html#a39">MiAdjustWorkingSetManagerParameters</a> (BOOLEAN WorkStation)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d0/wsmanage_8c.html#a40">MiObtainFreePages</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d0/wsmanage_8c.html#a41">MmWorkingSetManager</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LOGICAL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d0/wsmanage_8c.html#a42">MiCheckAndSetSystemTrimCriteria</a> (<a class="el" href="../../d8/d7/union__MMWS__TRIM__CRITERIA.html">PMMWS_TRIM_CRITERIA</a> Criteria)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d0/wsmanage_8c.html#a43">MiCheckSystemTrimEndCriteria</a> (IN <a class="el" href="../../d8/d7/union__MMWS__TRIM__CRITERIA.html">PMMWS_TRIM_CRITERIA</a> Criteria, IN KIRQL OldIrql)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d0/wsmanage_8c.html#a44">MiCheckProcessTrimCriteria</a> (<a class="el" href="../../d8/d7/union__MMWS__TRIM__CRITERIA.html">PMMWS_TRIM_CRITERIA</a> Criteria, <a class="el" href="../../d3/d6/struct__MMSUPPORT.html">PMMSUPPORT</a> VmSupport, <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process, PLARGE_INTEGER CurrentTime)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LOGICAL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d0/wsmanage_8c.html#a45">MiCheckSystemCacheWsTrimCriteria</a> (<a class="el" href="../../d3/d6/struct__MMSUPPORT.html">PMMSUPPORT</a> VmSupport)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d0/wsmanage_8c.html#a46">MiDetermineWsTrimAmount</a> (<a class="el" href="../../d8/d7/union__MMWS__TRIM__CRITERIA.html">PMMWS_TRIM_CRITERIA</a> Criteria, <a class="el" href="../../d3/d6/struct__MMSUPPORT.html">PMMSUPPORT</a> VmSupport, <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d0/wsmanage_8c.html#a47">MiEmptyAllWorkingSets</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LOGICAL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d0/wsmanage_8c.html#a48">MmTrimAllSystemPagableMemory</a> (IN LOGICAL PurgeTransition)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d0/wsmanage_8c.html#a4">MiIdealPassFaultCountDisable</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d0/wsmanage_8c.html#a5">PsMinimumWorkingSet</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d0/wsmanage_8c.html#a6">ExpDefaultErrorPortProcess</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d2/d6/struct__KEVENT.html">KEVENT</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d0/wsmanage_8c.html#a7">MiWaitForEmptyEvent</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d0/wsmanage_8c.html#a8">MiWaitingForWorkingSetEmpty</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PFN_NUMBER&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d0/wsmanage_8c.html#a9">MmMoreThanEnoughFreePages</a> = 1000</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d0/wsmanage_8c.html#a10">MmAmpleFreePages</a> = 200</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d0/wsmanage_8c.html#a11">MmWorkingSetReductionMin</a> = 12</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d0/wsmanage_8c.html#a12">MmWorkingSetReductionMinCacheWs</a> = 12</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d0/wsmanage_8c.html#a13">MmWorkingSetReductionMax</a> = 60</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d0/wsmanage_8c.html#a14">MmWorkingSetReductionMaxCacheWs</a> = 60</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d0/wsmanage_8c.html#a15">MmWorkingSetReductionHuge</a> = (512*1024) &gt;&gt; PAGE_SHIFT</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d0/wsmanage_8c.html#a16">MmWorkingSetVolReductionMin</a> = 12</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d0/wsmanage_8c.html#a17">MmWorkingSetVolReductionMax</a> = 60</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d0/wsmanage_8c.html#a18">MmWorkingSetVolReductionMaxCacheWs</a> = 60</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d0/wsmanage_8c.html#a19">MmWorkingSetVolReductionHuge</a> = (2*1024*1024) &gt;&gt; PAGE_SHIFT</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d0/wsmanage_8c.html#a20">MmWorkingSetSwapReduction</a> = 75</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d0/wsmanage_8c.html#a21">MmWorkingSetSwapReductionHuge</a> = (4*1024*1024) &gt;&gt; PAGE_SHIFT</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d0/wsmanage_8c.html#a22">MmNumberOfForegroundProcesses</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d0/wsmanage_8c.html#a23">MiCheckCounter</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d0/wsmanage_8c.html#a24">MmLastFaultCount</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PVOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d0/wsmanage_8c.html#a25">MmPagableKernelStart</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PVOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d0/wsmanage_8c.html#a26">MmPagableKernelEnd</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d0/wsmanage_8c.html#a27">PERFINFO_WSMANAGE_GLOBAL_DECL</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d0/wsmanage_8c.html#a30">MiTrimInProgressCount</a> = 1</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d0/wsmanage_8c.html#a31">MiTrimAllPageFaultCount</a></td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a2" doxytag="wsmanage.c::MM_IGNORE_FAULT_COUNT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define MM_IGNORE_FAULT_COUNT&nbsp;&nbsp;&nbsp;(100)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00117">117</a> of file <a class="el" href="../../d6/d9/wsmanage_8c-source.html">wsmanage.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00996">MiCheckAndSetSystemTrimCriteria()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="wsmanage.c::MM_REDUCE_FAULT_COUNT" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define MM_REDUCE_FAULT_COUNT&nbsp;&nbsp;&nbsp;(10000)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00115">115</a> of file <a class="el" href="../../d6/d9/wsmanage_8c-source.html">wsmanage.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00996">MiCheckAndSetSystemTrimCriteria()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="wsmanage.c::MM_TRIM_COUNTER_MAXIMUM_LARGE_MEM" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define MM_TRIM_COUNTER_MAXIMUM_LARGE_MEM&nbsp;&nbsp;&nbsp;(6)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00101">101</a> of file <a class="el" href="../../d6/d9/wsmanage_8c-source.html">wsmanage.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00996">MiCheckAndSetSystemTrimCriteria()</a>, <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l01372">MiCheckProcessTrimCriteria()</a>, <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l01591">MiCheckSystemCacheWsTrimCriteria()</a>, <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l01644">MiDetermineWsTrimAmount()</a>, and <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00397">MmWorkingSetManager()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="wsmanage.c::MM_WS_REORG_BUCKETS_MAX" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define MM_WS_REORG_BUCKETS_MAX&nbsp;&nbsp;&nbsp;7          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l02458">2458</a> of file <a class="el" href="../../d6/d9/wsmanage_8c-source.html">wsmanage.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l02465">MiRearrangeWorkingSetExpansionList()</a>.    </td>
  </tr>
</table>
<hr><h2>Typedef Documentation</h2>
<a class="anchor" name="a28" doxytag="wsmanage.c::MMWS_TRIM_CRITERIA" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef union <a class="el" href="../../d8/d7/union__MMWS__TRIM__CRITERIA.html">_MMWS_TRIM_CRITERIA</a>  <a class="el" href="../../d8/d7/union__MMWS__TRIM__CRITERIA.html">MMWS_TRIM_CRITERIA</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a29" doxytag="wsmanage.c::PMMWS_TRIM_CRITERIA" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef union <a class="el" href="../../d8/d7/union__MMWS__TRIM__CRITERIA.html">_MMWS_TRIM_CRITERIA</a> * <a class="el" href="../../d8/d7/union__MMWS__TRIM__CRITERIA.html">PMMWS_TRIM_CRITERIA</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a39" doxytag="wsmanage.c::MiAdjustWorkingSetManagerParameters" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MiAdjustWorkingSetManagerParameters           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">BOOLEAN&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>WorkStation</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00259">259</a> of file <a class="el" href="../../d6/d9/wsmanage_8c-source.html">wsmanage.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01066">KeInitializeEvent</a>, <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00095">MiIdealPassFaultCountDisable</a>, <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00107">MiWaitForEmptyEvent</a>, <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00108">MiWaitingForWorkingSetEmpty</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00399">MmNumberOfPhysicalPages</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l00088">MmWorkingSetReductionMax</a>, <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00127">MmWorkingSetReductionMin</a>, <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00137">MmWorkingSetVolReductionMax</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/mminit_8c-source.html#l00184">MmInitSystem()</a>.
<p>
<pre class="fragment"><div>00264                    :
00265 
00266     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called from <a class="code" href="../../d2/d1/mm_8h.html#a186">MmInitSystem</a> to adjust <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> working set manager
00267     trim algorithms based on system <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> and size.
00268 
00269 Arguments:
00270 
00271     WorkStation - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a workstation, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <span class="keywordflow">if</span> not.
00272 
00273 Return Value:
00274 
00275     None.
00276 
00277 Environment:
00278 
00279     Kernel mode
00280 
00281 --*/
00282 {
00283 
00284 <span class="preprocessor">#ifdef _MI_USE_CLAIMS_</span>
00285 <span class="preprocessor"></span>
00286     <span class="keywordflow">if</span> (WorkStation &amp;&amp; <a class="code" href="../../d2/d1/mm_8h.html#a136">MmNumberOfPhysicalPages</a> &lt;= 63*1024*1024/<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>) {
00287         MiAgingShift = 4;
00288         MiEstimationShift = 5;
00289     }
00290     <span class="keywordflow">else</span> {
00291         MiAgingShift = 5;
00292         MiEstimationShift = 6;
00293     }
00294 
00295     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d1/mm_8h.html#a136">MmNumberOfPhysicalPages</a> &gt;= 63*1024*1024/<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>) {
00296         MmPlentyFreePages *= 2;
00297     }
00298 <span class="preprocessor">#else</span>
00299 <span class="preprocessor"></span>
00300     <span class="keywordflow">if</span> (WorkStation &amp;&amp; (<a class="code" href="../../d2/d1/mm_8h.html#a136">MmNumberOfPhysicalPages</a> &lt;= (31*1024*1024/<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>))) {
00301 
00302         <span class="comment">//</span>
00303         <span class="comment">// To get fault protection, you have to take 45 faults instead of</span>
00304         <span class="comment">// the old 15 fault protection threshold.</span>
00305         <span class="comment">//</span>
00306 
00307         <a class="code" href="../../d5/d0/wsmanage_8c.html#a4">MiIdealPassFaultCountDisable</a> = 45;
00308 
00309         <span class="comment">//</span>
00310         <span class="comment">// Take more away when you are over your working set in both</span>
00311         <span class="comment">// forced and voluntary mode, but leave cache WS trim amounts</span>
00312         <span class="comment">// alone.</span>
00313         <span class="comment">//</span>
00314 
00315         <a class="code" href="../../d5/d0/wsmanage_8c.html#a17">MmWorkingSetVolReductionMax</a> = 100;
00316         <a class="code" href="../../d4/d5/procsup_8c.html#a6">MmWorkingSetReductionMax</a> = 100;
00317 
00318         <span class="comment">//</span>
00319         <span class="comment">// In forced mode, even if you are within your working set, take</span>
00320         <span class="comment">// memory away more aggressively.</span>
00321         <span class="comment">//</span>
00322 
00323         <a class="code" href="../../d5/d0/wsmanage_8c.html#a11">MmWorkingSetReductionMin</a> = 40;
00324     }
00325     <span class="keywordflow">else</span> {
00326         <a class="code" href="../../d5/d0/wsmanage_8c.html#a4">MiIdealPassFaultCountDisable</a> = 15;
00327     }
00328 <span class="preprocessor">#endif</span>
00329 <span class="preprocessor"></span>
00330     <a class="code" href="../../d5/d0/wsmanage_8c.html#a8">MiWaitingForWorkingSetEmpty</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00331     <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a> (&amp;MiWaitForEmptyEvent, NotificationEvent, TRUE);
00332 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a42" doxytag="wsmanage.c::MiCheckAndSetSystemTrimCriteria" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LOGICAL MiCheckAndSetSystemTrimCriteria           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d8/d7/union__MMWS__TRIM__CRITERIA.html">PMMWS_TRIM_CRITERIA</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Criteria</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00996">996</a> of file <a class="el" href="../../d6/d9/wsmanage_8c-source.html">wsmanage.c</a>.
<p>
References <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00191">_MMWS_TRIM_CRITERIA::DesiredFreeGoal</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d8/d7/union__MMWS__TRIM__CRITERIA.html#o6">_MMWS_TRIM_CRITERIA::FaultBased</a>, <a class="el" href="../../d3/d7/eventobj_8c-source.html#l00343">KeSetEvent()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00957">LOCK_EXPANSION</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00163">MiCheckCounter</a>, <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l02788">MiEmptyAllWorkingSetsWorker()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04438">MiHydra</a>, <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00095">MiIdealPassFaultCountDisable</a>, <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l02465">MiRearrangeWorkingSetExpansionList()</a>, <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00107">MiWaitForEmptyEvent</a>, <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00108">MiWaitingForWorkingSetEmpty</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00168">MM_DBG_WS_EXPANSION</a>, <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00117">MM_IGNORE_FAULT_COUNT</a>, <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00115">MM_REDUCE_FAULT_COUNT</a>, <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00101">MM_TRIM_COUNTER_MAXIMUM_LARGE_MEM</a>, <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00125">MmAmpleFreePages</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00134">MmAvailablePages</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05120">MmFreeGoal</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00475">MmInfoCounters</a>, <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00164">MmLastFaultCount</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05118">MmMinimumFreePages</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04486">MmMoreThanEnoughFreePages</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00399">MmNumberOfPhysicalPages</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04506">MmPagesAboveWsMinimum</a>, <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00195">_MMWS_TRIM_CRITERIA::NumberOfForegroundProcesses</a>, <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00190">_MMWS_TRIM_CRITERIA::NumPasses</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00458">_MMINFO_COUNTERS::PageFaultCount</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l02220">PERFINFO_WSMANAGE_DECL</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l02222">PERFINFO_WSMANAGE_DUMPENTRIES_CLAIMS</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l02223">PERFINFO_WSMANAGE_DUMPENTRIES_FAULTS</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l02232">PERFINFO_WSMANAGE_STARTLOG_CLAIMS</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l02233">PERFINFO_WSMANAGE_STARTLOG_FAULTS</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l02235">PERFINFO_WSMANAGE_TRIMACTION</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l02244">PERFINFO_WSMANAGE_WILLTRIM_CLAIMS</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l02245">PERFINFO_WSMANAGE_WILLTRIM_FAULTS</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00961">UNLOCK_EXPANSION</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>.
<p>
Referenced by <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00397">MmWorkingSetManager()</a>.
<p>
<pre class="fragment"><div>01002                    :
01003 
01004     Decide whether to trim at <span class="keyword">this</span> time.  If <span class="keyword">using</span> claims, then <span class="keyword">this</span>
01005     routine may initiate aging and claim adjustments as well.
01006 
01007 Arguments:
01008 
01009     Criteria - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> trim criteria information.  Various
01010                fields in <span class="keyword">this</span> structure are set as needed by <span class="keyword">this</span> routine.
01011 
01012 Return Value:
01013 
01014     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller should initiate trimming, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <span class="keywordflow">if</span> not.
01015 
01016 Environment:
01017 
01018     Kernel mode.  No locks held.  APC level or below.
01019 
01020 --*/
01021 
01022 {
01023     PFN_NUMBER Available;
01024     ULONG PageFaultCount;
01025     KIRQL OldIrql;
01026     BOOLEAN InitiateTrim;
01027 
01028     <a class="code" href="../../d2/d1/mm_8h.html#a99">PERFINFO_WSMANAGE_DECL</a>();
01029 
01030     <span class="comment">//</span>
01031     <span class="comment">// See if an empty-all-working-sets request has been queued to us.</span>
01032     <span class="comment">// This only happens on Hydra.</span>
01033     <span class="comment">//</span>
01034 
01035     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d0/wsmanage_8c.html#a8">MiWaitingForWorkingSetEmpty</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01036 
01037         <a class="code" href="../../d5/d0/wsmanage_8c.html#a32">MiEmptyAllWorkingSetsWorker</a> ();
01038 
01039         <a class="code" href="../../d4/d8/mi_8h.html#a139">LOCK_EXPANSION</a> (OldIrql);
01040 
01041         <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a> (&amp;MiWaitForEmptyEvent, 0, FALSE);
01042         <a class="code" href="../../d5/d0/wsmanage_8c.html#a8">MiWaitingForWorkingSetEmpty</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01043 
01044         <a class="code" href="../../d4/d8/mi_8h.html#a140">UNLOCK_EXPANSION</a> (OldIrql);
01045 
01046 <span class="preprocessor">#ifdef _MI_USE_CLAIMS_</span>
01047 <span class="preprocessor"></span>        MiReplacing = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01048 <span class="preprocessor">#endif</span>
01049 <span class="preprocessor"></span>
01050         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01051     }
01052 
01053     <span class="comment">//</span>
01054     <span class="comment">// Check the number of pages available to see if any trimming</span>
01055     <span class="comment">// is really required.</span>
01056     <span class="comment">//</span>
01057 
01058     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
01059     Available = <a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a>;
01060     PageFaultCount = <a class="code" href="../../d2/d1/mm_8h.html#a145">MmInfoCounters</a>.<a class="code" href="../../d3/d2/struct__MMINFO__COUNTERS.html#o0">PageFaultCount</a>;
01061     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
01062 
01063 <span class="preprocessor">#ifdef _MI_USE_CLAIMS_</span>
01064 <span class="preprocessor"></span>    <a class="code" href="../../d2/d1/mm_8h.html#a111">PERFINFO_WSMANAGE_STARTLOG_CLAIMS</a>();
01065     <span class="keywordflow">if</span> (Available &gt; MmPlentyFreePages &amp;&amp; MiReplacing == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01066 
01067         <span class="comment">//</span>
01068         <span class="comment">// Don't trim but do age unused pages and estimate</span>
01069         <span class="comment">// the amount available in working sets.</span>
01070         <span class="comment">//</span>
01071 
01072         MiAgePagesAndEstimateClaims ();
01073         MiAdjustClaimParameters (TRUE);
01074         <a class="code" href="../../d2/d1/mm_8h.html#a114">PERFINFO_WSMANAGE_TRIMACTION</a> (WS_ACTION_RESET_COUNTER);
01075     }
01076     <span class="keywordflow">else</span> {
01077 
01078         <span class="comment">//</span>
01079         <span class="comment">// Inform our caller to start trimming since we're below</span>
01080         <span class="comment">// plenty pages - order the list so the bigger working sets are</span>
01081         <span class="comment">// in front so our caller trims those first.</span>
01082         <span class="comment">//</span>
01083 
01084         Criteria-&gt;ClaimBased.<a class="code" href="../../d8/d7/union__MMWS__TRIM__CRITERIA.html#o0">NumPasses</a> = 0;
01085         Criteria-&gt;ClaimBased.<a class="code" href="../../d8/d7/union__MMWS__TRIM__CRITERIA.html#o1">DesiredFreeGoal</a> = MmPlentyFreePages +
01086                                                     (MmPlentyFreePages / 2);
01087         Criteria-&gt;ClaimBased.NewTotalClaim = 0;
01088         Criteria-&gt;ClaimBased.NewTotalEstimatedAvailable = 0;
01089         Criteria-&gt;ClaimBased.<a class="code" href="../../d8/d7/union__MMWS__TRIM__CRITERIA.html#o5">NumberOfForegroundProcesses</a> = 0;
01090 
01091         <span class="comment">//</span>
01092         <span class="comment">// Start trimming the bigger working sets first.</span>
01093         <span class="comment">//</span>
01094 
01095         <a class="code" href="../../d5/d0/wsmanage_8c.html#a38">MiRearrangeWorkingSetExpansionList</a> ();
01096 
01097 <span class="preprocessor">#if DBG</span>
01098 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a60">MM_DBG_WS_EXPANSION</a>) {
01099             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\nMM-wsmanage: Desired = %ld, Avail %ld\n"</span>,
01100                     Criteria-&gt;ClaimBased.<a class="code" href="../../d8/d7/union__MMWS__TRIM__CRITERIA.html#o1">DesiredFreeGoal</a>, MmAvailablePages);
01101         }
01102 <span class="preprocessor">#endif //DBG</span>
01103 <span class="preprocessor"></span>
01104         <a class="code" href="../../d2/d1/mm_8h.html#a123">PERFINFO_WSMANAGE_WILLTRIM_CLAIMS</a>(Criteria);
01105 
01106         MiReplacing = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01107 
01108         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01109     }
01110     <a class="code" href="../../d2/d1/mm_8h.html#a101">PERFINFO_WSMANAGE_DUMPENTRIES_CLAIMS</a>();
01111 
01112     <span class="comment">//</span>
01113     <span class="comment">// If we've been replacing within a given working set, it's worth doing</span>
01114     <span class="comment">// a trim.  No need to lock synchronize the MiReplacing clearing as it</span>
01115     <span class="comment">// gets set every time a page replacement happens anyway.</span>
01116     <span class="comment">//</span>
01117 
01118     InitiateTrim = MiReplacing;
01119 
01120     MiReplacing = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01121 
01122     <span class="keywordflow">return</span> InitiateTrim;
01123 
01124 <span class="preprocessor">#else</span>
01125 <span class="preprocessor"></span>
01126     <a class="code" href="../../d2/d1/mm_8h.html#a112">PERFINFO_WSMANAGE_STARTLOG_FAULTS</a>();
01127 
01128     <span class="keywordflow">if</span> ((Available &gt; (<a class="code" href="../../d2/d1/mm_8h.html#a136">MmNumberOfPhysicalPages</a> &gt;&gt; 2)) ||
01129         ((Available &gt; <a class="code" href="../../d4/d8/mi_8h.html#a588">MmMoreThanEnoughFreePages</a>) &amp;&amp;
01130         ((PageFaultCount - <a class="code" href="../../d5/d0/wsmanage_8c.html#a24">MmLastFaultCount</a>) &lt; <a class="code" href="../../d5/d0/wsmanage_8c.html#a1">MM_REDUCE_FAULT_COUNT</a>))) {
01131 
01132         <span class="comment">//</span>
01133         <span class="comment">// Don't trim and zero the check counter.</span>
01134         <span class="comment">//</span>
01135 
01136         <a class="code" href="../../d5/d0/wsmanage_8c.html#a23">MiCheckCounter</a> = 0;
01137         <a class="code" href="../../d2/d1/mm_8h.html#a114">PERFINFO_WSMANAGE_TRIMACTION</a>(WS_ACTION_RESET_COUNTER);
01138 
01139     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((Available &gt; <a class="code" href="../../d5/d0/wsmanage_8c.html#a10">MmAmpleFreePages</a>) &amp;&amp;
01140         ((PageFaultCount - <a class="code" href="../../d5/d0/wsmanage_8c.html#a24">MmLastFaultCount</a>) &lt; <a class="code" href="../../d5/d0/wsmanage_8c.html#a2">MM_IGNORE_FAULT_COUNT</a>)) {
01141 
01142         <span class="comment">//</span>
01143         <span class="comment">// Don't do anything.</span>
01144         <span class="comment">//</span>
01145 
01146         NOTHING;
01147         <a class="code" href="../../d2/d1/mm_8h.html#a114">PERFINFO_WSMANAGE_TRIMACTION</a>(WS_ACTION_NOTHING);
01148 
01149     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((Available &gt; <a class="code" href="../../d4/d8/mi_8h.html#a727">MmFreeGoal</a>) &amp;&amp;
01150                (<a class="code" href="../../d5/d0/wsmanage_8c.html#a23">MiCheckCounter</a> &lt; <a class="code" href="../../d5/d0/wsmanage_8c.html#a0">MM_TRIM_COUNTER_MAXIMUM_LARGE_MEM</a>)) {
01151 
01152         <span class="comment">//</span>
01153         <span class="comment">// Don't trim, but increment the check counter.</span>
01154         <span class="comment">//</span>
01155 
01156         <a class="code" href="../../d5/d0/wsmanage_8c.html#a23">MiCheckCounter</a> += 1;
01157         <a class="code" href="../../d2/d1/mm_8h.html#a114">PERFINFO_WSMANAGE_TRIMACTION</a>(WS_ACTION_INCREMENT_COUNTER);
01158 
01159     }
01160     <span class="keywordflow">else</span> {
01161 
01162         <span class="comment">//</span>
01163         <span class="comment">// Initialize state variables.</span>
01164         <span class="comment">//</span>
01165 
01166         Criteria-&gt;<a class="code" href="../../d8/d7/union__MMWS__TRIM__CRITERIA.html#o6">FaultBased</a>.NumPasses = 0;
01167         Criteria-&gt;<a class="code" href="../../d8/d7/union__MMWS__TRIM__CRITERIA.html#o6">FaultBased</a>.TotalReduction = 0;
01168         Criteria-&gt;<a class="code" href="../../d8/d7/union__MMWS__TRIM__CRITERIA.html#o6">FaultBased</a>.NumberOfForegroundProcesses = 0;
01169 
01170         <span class="comment">//</span>
01171         <span class="comment">// Set the total reduction goals.</span>
01172         <span class="comment">//</span>
01173 
01174         Criteria-&gt;<a class="code" href="../../d8/d7/union__MMWS__TRIM__CRITERIA.html#o6">FaultBased</a>.DesiredReductionGoal = <a class="code" href="../../d4/d8/mi_8h.html#a590">MmPagesAboveWsMinimum</a> &gt;&gt; 2;
01175         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a590">MmPagesAboveWsMinimum</a> &gt; (<a class="code" href="../../d4/d8/mi_8h.html#a727">MmFreeGoal</a> &lt;&lt; 1)) {
01176             Criteria-&gt;<a class="code" href="../../d8/d7/union__MMWS__TRIM__CRITERIA.html#o6">FaultBased</a>.DesiredFreeGoal = <a class="code" href="../../d4/d8/mi_8h.html#a727">MmFreeGoal</a>;
01177         }
01178         <span class="keywordflow">else</span> {
01179             Criteria-&gt;<a class="code" href="../../d8/d7/union__MMWS__TRIM__CRITERIA.html#o6">FaultBased</a>.DesiredFreeGoal = <a class="code" href="../../d4/d8/mi_8h.html#a726">MmMinimumFreePages</a> + 10;
01180         }
01181 
01182         <span class="comment">//</span>
01183         <span class="comment">// Calculate the number of faults to be taken to not be trimmed.</span>
01184         <span class="comment">//</span>
01185 
01186         <span class="keywordflow">if</span> (Available &gt; <a class="code" href="../../d4/d8/mi_8h.html#a588">MmMoreThanEnoughFreePages</a>) {
01187             Criteria-&gt;<a class="code" href="../../d8/d7/union__MMWS__TRIM__CRITERIA.html#o6">FaultBased</a>.FaultCount = 1;
01188         }
01189         <span class="keywordflow">else</span> {
01190             Criteria-&gt;<a class="code" href="../../d8/d7/union__MMWS__TRIM__CRITERIA.html#o6">FaultBased</a>.FaultCount = <a class="code" href="../../d5/d0/wsmanage_8c.html#a4">MiIdealPassFaultCountDisable</a>;
01191         }
01192 
01193 <span class="preprocessor">#if DBG</span>
01194 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a60">MM_DBG_WS_EXPANSION</a>) {
01195             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"\nMM-wsmanage: checkcounter = %ld, Desired = %ld, Free = %ld Avail %ld\n"</span>,
01196                 MiCheckCounter, Criteria-&gt;<a class="code" href="../../d8/d7/union__MMWS__TRIM__CRITERIA.html#o6">FaultBased</a>.DesiredReductionGoal,
01197                 Criteria-&gt;<a class="code" href="../../d8/d7/union__MMWS__TRIM__CRITERIA.html#o6">FaultBased</a>.DesiredFreeGoal, MmAvailablePages);
01198         }
01199 <span class="preprocessor">#endif //DBG</span>
01200 <span class="preprocessor"></span>
01201         <a class="code" href="../../d2/d1/mm_8h.html#a124">PERFINFO_WSMANAGE_WILLTRIM_FAULTS</a>(Criteria);
01202 
01203         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a581">MiHydra</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01204             <a class="code" href="../../d5/d0/wsmanage_8c.html#a38">MiRearrangeWorkingSetExpansionList</a> ();
01205         }
01206 
01207         <a class="code" href="../../d5/d0/wsmanage_8c.html#a24">MmLastFaultCount</a> = PageFaultCount;
01208 
01209         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01210     }
01211     <a class="code" href="../../d2/d1/mm_8h.html#a102">PERFINFO_WSMANAGE_DUMPENTRIES_FAULTS</a>();
01212 
01213     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01214 <span class="preprocessor">#endif</span>
01215 <span class="preprocessor"></span>}

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a33" doxytag="wsmanage.c::MiCheckAndSetSystemTrimCriteria" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LOGICAL MiCheckAndSetSystemTrimCriteria           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT <a class="el" href="../../d8/d7/union__MMWS__TRIM__CRITERIA.html">PMMWS_TRIM_CRITERIA</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Criteria</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a44" doxytag="wsmanage.c::MiCheckProcessTrimCriteria" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN MiCheckProcessTrimCriteria           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d8/d7/union__MMWS__TRIM__CRITERIA.html">PMMWS_TRIM_CRITERIA</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Criteria</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d3/d6/struct__MMSUPPORT.html">PMMSUPPORT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>VmSupport</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Process</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PLARGE_INTEGER&nbsp;</td>
          <td class="mdname" nowrap> <em>CurrentTime</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l01372">1372</a> of file <a class="el" href="../../d6/d9/wsmanage_8c-source.html">wsmanage.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d8/d7/union__MMWS__TRIM__CRITERIA.html#o6">_MMWS_TRIM_CRITERIA::FaultBased</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00273">_EPROCESS::ImageFileName</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00058">_MMSUPPORT::LastTrimFaultCount</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00057">_MMSUPPORT::LastTrimTime</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00043">MEMORY_PRIORITY_FOREGROUND</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00069">_MMSUPPORT::MemoryPriority</a>, <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00163">MiCheckCounter</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04438">MiHydra</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00062">_MMSUPPORT::MinimumWorkingSetSize</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00168">MM_DBG_WS_EXPANSION</a>, <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00101">MM_TRIM_COUNTER_MAXIMUM_LARGE_MEM</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00134">MmAvailablePages</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05120">MmFreeGoal</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04486">MmMoreThanEnoughFreePages</a>, <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00146">MmNumberOfForegroundProcesses</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00212">MmWorkingSetProtectionTime</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00059">_MMSUPPORT::PageFaultCount</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l02230">PERFINFO_WSMANAGE_PROCESS_RESET</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00213">_EPROCESS::ProcessOutswapEnabled</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05416">_MM_SESSION_SPACE::SessionId</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d3/d6/struct__MMSUPPORT.html#o15">_MMSUPPORT::u</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00196">_EPROCESS::Vm</a>, and <a class="el" href="../../d2/d8/ps_8h-source.html#l00061">_MMSUPPORT::WorkingSetSize</a>.
<p>
Referenced by <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00397">MmWorkingSetManager()</a>.
<p>
<pre class="fragment"><div>01381                    :
01382 
01383     Determine whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified working set should be trimmed.
01384 
01385 Arguments:
01386 
01387     Criteria - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> trim criteria information.
01388 
01389     VmSupport - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> working set information <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> candidate process.
01390 
01391     Process - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process to trim.  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> <span class="keywordflow">if</span> <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <span class="keywordflow">for</span> a session.
01392 
01393     CurrentTime - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> time at <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> start of <span class="keyword">this</span> trim round.
01394 
01395 Return Value:
01396 
01397     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> trimming should be done on <span class="keyword">this</span> process, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise.
01398 
01399 Environment:
01400 
01401     Kernel mode.  Expansion lock held.  APC level or below.
01402 
01403 --*/
01404 
01405 {
01406     BOOLEAN Trim;
01407     BOOLEAN Reset;
01408     BOOLEAN Responsive;
01409 
01410 <span class="preprocessor">#if DBG</span>
01411 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (Process) {
01412         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.SessionSpace == 0);
01413     }
01414     <span class="keywordflow">else</span> {
01415         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.SessionSpace == 1);
01416     }
01417 <span class="preprocessor">#endif</span>
01418 <span class="preprocessor"></span>
01419     <span class="keywordflow">if</span> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.TrimHard == 1 &amp;&amp; VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o4">WorkingSetSize</a>) {
01420         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01421     }
01422 
01423 <span class="preprocessor">#ifdef _MI_USE_CLAIMS_</span>
01424 <span class="preprocessor"></span>
01425     <span class="comment">//</span>
01426     <span class="comment">// Always trim if there's anything left.  Note that the</span>
01427     <span class="comment">// foreground process is given priority by putting it last in the</span>
01428     <span class="comment">// working set list and stopping trimming when we have enough pages.</span>
01429     <span class="comment">//</span>
01430 
01431     <span class="keywordflow">if</span> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o4">WorkingSetSize</a> &lt;= 3) {
01432         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01433     }
01434 
01435     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01436 <span class="preprocessor">#else</span>
01437 <span class="preprocessor"></span>
01438     Trim = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01439     Reset = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01440 
01441     <span class="keywordflow">if</span> (Process &amp;&amp; Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o12">MemoryPriority</a> == <a class="code" href="../../d1/d9/ps_8h.html#a3">MEMORY_PRIORITY_FOREGROUND</a> &amp;&amp; Criteria-&gt;<a class="code" href="../../d8/d7/union__MMWS__TRIM__CRITERIA.html#o6">FaultBased</a>.NumPasses == 0) {
01442 
01443         Criteria-&gt;<a class="code" href="../../d8/d7/union__MMWS__TRIM__CRITERIA.html#o6">FaultBased</a>.NumberOfForegroundProcesses += 1;
01444     }
01445 
01446     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d0/wsmanage_8c.html#a23">MiCheckCounter</a> &gt;= <a class="code" href="../../d5/d0/wsmanage_8c.html#a0">MM_TRIM_COUNTER_MAXIMUM_LARGE_MEM</a>) {
01447 
01448         <span class="comment">//</span>
01449         <span class="comment">// This is a voluntary trim so don't trim if </span>
01450         <span class="comment">//  - the page fault count is too high</span>
01451         <span class="comment">//  - or the size is too small</span>
01452         <span class="comment">//  - or not enough time has elapsed since it was last trimmed</span>
01453         <span class="comment">//</span>
01454 
01455         <span class="keywordflow">if</span> (((VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o2">PageFaultCount</a> - VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o1">LastTrimFaultCount</a>) &gt;
01456                                                Criteria-&gt;<a class="code" href="../../d8/d7/union__MMWS__TRIM__CRITERIA.html#o6">FaultBased</a>.FaultCount)
01457                                 ||
01458               (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o4">WorkingSetSize</a> &lt;= 5)
01459 
01460                                 ||
01461               ((CurrentTime-&gt;QuadPart - VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o0">LastTrimTime</a>.QuadPart) &lt;
01462                         <a class="code" href="../../d4/d8/mi_8h.html#a417">MmWorkingSetProtectionTime</a>.QuadPart)) {
01463 
01464 <span class="preprocessor">#if DBG</span>
01465 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a60">MM_DBG_WS_EXPANSION</a>) {
01466                 <span class="keywordflow">if</span> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o4">WorkingSetSize</a> &gt; 5) {
01467 
01468                     <span class="keywordflow">if</span> (Process) {
01469                         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"     ***** Skipping Process %16s %5d Faults, WS %6d\n"</span>,
01470                         Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o65">ImageFileName</a>,
01471                         VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o2">PageFaultCount</a> - VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o1">LastTrimFaultCount</a>,
01472                         VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o4">WorkingSetSize</a>
01473                         );
01474                     }
01475                     <span class="keywordflow">else</span> {
01476                         <a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html">PMM_SESSION_SPACE</a> SessionSpace;
01477 
01478                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (MiHydra == TRUE);
01479                         SessionSpace = CONTAINING_RECORD(VmSupport,
01480                                                          <a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html">MM_SESSION_SPACE</a>,
01481                                                          Vm);
01482 
01483                         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"     ***** Skipping Session %d %5d Faults, WS %6d\n"</span>,
01484                         SessionSpace-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o4">SessionId</a>,
01485                         VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o2">PageFaultCount</a> - VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o1">LastTrimFaultCount</a>,
01486                         VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o4">WorkingSetSize</a>
01487                         );
01488                     }
01489                 }
01490             }
01491 <span class="preprocessor">#endif //DBG</span>
01492 <span class="preprocessor"></span>
01493             Reset = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01494             Trim = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01495         }
01496     } <span class="keywordflow">else</span> {
01497 
01498         <span class="comment">//</span>
01499         <span class="comment">// This is a forced trim.  If this process is above its</span>
01500         <span class="comment">// minimum it's a candidate.</span>
01501         <span class="comment">//</span>
01502 
01503         <span class="keywordflow">if</span> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o4">WorkingSetSize</a> &lt;= VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o5">MinimumWorkingSetSize</a>) {
01504 
01505             <span class="comment">//</span>
01506             <span class="comment">// If this process is below its minimum, don't trim it</span>
01507             <span class="comment">// unless stacks are swapped out or it's paging a bit.</span>
01508             <span class="comment">//</span>
01509 
01510             <span class="keywordflow">if</span> (((<a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> + 5) &gt;= <a class="code" href="../../d4/d8/mi_8h.html#a727">MmFreeGoal</a>) &amp;&amp;
01511                  (((VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o1">LastTrimFaultCount</a> !=
01512                                         VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o2">PageFaultCount</a>) ||
01513                   (Process &amp;&amp; Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o24">ProcessOutswapEnabled</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)))) {
01514 
01515                 <span class="comment">//</span>
01516                 <span class="comment">// If we've almost reached our goal and either this process</span>
01517                 <span class="comment">// has taken page faults since the last trim or it's</span>
01518                 <span class="comment">// not swap enabled, then don't trim it but do reset it.</span>
01519                 <span class="comment">//</span>
01520 
01521                 Reset = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01522                 Trim = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01523             } 
01524             <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o4">WorkingSetSize</a> &lt; 5) ||
01525                     ((CurrentTime-&gt;QuadPart - VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o0">LastTrimTime</a>.QuadPart) &lt;
01526                           <a class="code" href="../../d4/d8/mi_8h.html#a417">MmWorkingSetProtectionTime</a>.QuadPart)) {
01527 
01528                 <span class="comment">//</span>
01529                 <span class="comment">// If the working set is very small or it was trimmed</span>
01530                 <span class="comment">// recently don't trim it again.</span>
01531                 <span class="comment">//</span>
01532     
01533                 Reset = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01534                 Trim = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01535             }
01536         }
01537     }
01538 
01539     <span class="keywordflow">if</span> (Trim == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01540     
01541         <span class="comment">//</span>
01542         <span class="comment">// Fix to supply foreground responsiveness by not trimming</span>
01543         <span class="comment">// foreground priority applications as aggressively.</span>
01544         <span class="comment">//</span>
01545     
01546         Responsive = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01547     
01548         <span class="keywordflow">if</span> ((<a class="code" href="../../d5/d0/wsmanage_8c.html#a22">MmNumberOfForegroundProcesses</a> &lt;= 3) &amp;&amp;
01549             (Criteria-&gt;<a class="code" href="../../d8/d7/union__MMWS__TRIM__CRITERIA.html#o6">FaultBased</a>.NumberOfForegroundProcesses &lt;= 3) &amp;&amp;
01550             (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o12">MemoryPriority</a>)) {
01551     
01552             <span class="keywordflow">if</span> ((<a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> &gt; (<a class="code" href="../../d4/d8/mi_8h.html#a588">MmMoreThanEnoughFreePages</a> &gt;&gt; 2)) ||
01553                (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o12">MemoryPriority</a> &gt;= <a class="code" href="../../d1/d9/ps_8h.html#a3">MEMORY_PRIORITY_FOREGROUND</a>)) {
01554 
01555                 <span class="comment">//</span>
01556                 <span class="comment">// Indicate that memory responsiveness to the foreground</span>
01557                 <span class="comment">// process is important (not so for large console trees).</span>
01558                 <span class="comment">//</span>
01559     
01560                 Responsive = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01561             }
01562         }
01563     
01564         <span class="keywordflow">if</span> (Responsive == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> &amp;&amp; Criteria-&gt;<a class="code" href="../../d8/d7/union__MMWS__TRIM__CRITERIA.html#o6">FaultBased</a>.NumPasses == 0) {
01565     
01566             <span class="comment">//</span>
01567             <span class="comment">// Note that NumPasses yields a measurement of how</span>
01568             <span class="comment">// desperate we are for memory, if NumPasses is nonzero,</span>
01569             <span class="comment">// we are in trouble.</span>
01570             <span class="comment">//</span>
01571     
01572             Trim = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01573         }
01574     }
01575 
01576     <span class="keywordflow">if</span> (Trim == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01577         <span class="keywordflow">if</span> (Reset == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01578             VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o0">LastTrimTime</a> = *CurrentTime;
01579             VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o1">LastTrimFaultCount</a> = VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o2">PageFaultCount</a>;
01580         }
01581 
01582         <a class="code" href="../../d2/d1/mm_8h.html#a108">PERFINFO_WSMANAGE_PROCESS_RESET</a>(VmSupport);
01583     }
01584 
01585     <span class="keywordflow">return</span> Trim;
01586 <span class="preprocessor">#endif</span>
01587 <span class="preprocessor"></span>}
<span class="preprocessor">#ifndef _MI_USE_CLAIMS_</span>
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a35" doxytag="wsmanage.c::MiCheckProcessTrimCriteria" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN MiCheckProcessTrimCriteria           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d7/union__MMWS__TRIM__CRITERIA.html">PMMWS_TRIM_CRITERIA</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Criteria</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d3/d6/struct__MMSUPPORT.html">PMMSUPPORT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>VmSupport</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Process</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLARGE_INTEGER&nbsp;</td>
          <td class="mdname" nowrap> <em>CurrentTime</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a45" doxytag="wsmanage.c::MiCheckSystemCacheWsTrimCriteria" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LOGICAL MiCheckSystemCacheWsTrimCriteria           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d3/d6/struct__MMSUPPORT.html">PMMSUPPORT</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>VmSupport</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l01591">1591</a> of file <a class="el" href="../../d6/d9/wsmanage_8c-source.html">wsmanage.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00163">MiCheckCounter</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00062">_MMSUPPORT::MinimumWorkingSetSize</a>, <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00101">MM_TRIM_COUNTER_MAXIMUM_LARGE_MEM</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d2/d8/ps_8h-source.html#l00061">_MMSUPPORT::WorkingSetSize</a>.
<p>
Referenced by <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00397">MmWorkingSetManager()</a>.
<p>
<pre class="fragment"><div>01597                    :
01598 
01599      Determine whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system cache should be trimmed
01600 
01601 Arguments:
01602 
01603     VmSupport - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> working set information <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system cache.
01604 
01605 Return Value:
01606 
01607     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> trimming should be done on <span class="keyword">this</span> process, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise.
01608 
01609 Environment:
01610 
01611     Kernel mode.  Expansion lock held.  APC level or below.
01612 
01613 --*/
01614 
01615 {
01616     LOGICAL Trim;
01617 
01618     <span class="comment">//</span>
01619     <span class="comment">// Don't trim the system cache if this is a voluntary trim and</span>
01620     <span class="comment">// the working set is within 100 pages of the minimum or</span>
01621     <span class="comment">// if the cache is at its minimum.</span>
01622     <span class="comment">//</span>
01623 
01624     <span class="keywordflow">if</span> ((<a class="code" href="../../d5/d0/wsmanage_8c.html#a23">MiCheckCounter</a> &gt;= <a class="code" href="../../d5/d0/wsmanage_8c.html#a0">MM_TRIM_COUNTER_MAXIMUM_LARGE_MEM</a>) &amp;&amp;
01625         (((LONG)VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o4">WorkingSetSize</a> -
01626             (LONG)VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o5">MinimumWorkingSetSize</a>) &lt; 100)) {
01627 
01628         <span class="comment">//</span>
01629         <span class="comment">// Don't trim it if it's near its minimum and it's not a forced trim.</span>
01630         <span class="comment">//</span>
01631 
01632         Trim = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01633     }
01634     <span class="keywordflow">else</span> {
01635         Trim = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01636     }
01637 
01638     <span class="keywordflow">return</span> Trim;
01639 }
<span class="preprocessor">#endif</span>
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a36" doxytag="wsmanage.c::MiCheckSystemCacheWsTrimCriteria" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LOGICAL MiCheckSystemCacheWsTrimCriteria           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d3/d6/struct__MMSUPPORT.html">PMMSUPPORT</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>VmSupport</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a43" doxytag="wsmanage.c::MiCheckSystemTrimEndCriteria" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN MiCheckSystemTrimEndCriteria           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d7/union__MMWS__TRIM__CRITERIA.html">PMMWS_TRIM_CRITERIA</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Criteria</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN KIRQL&nbsp;</td>
          <td class="mdname" nowrap> <em>OldIrql</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l01218">1218</a> of file <a class="el" href="../../d6/d9/wsmanage_8c-source.html">wsmanage.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00140">KeDelayExecutionThread()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00957">LOCK_EXPANSION</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01681">MI_MAX_TRIM_PASSES</a>, <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00163">MiCheckCounter</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00134">MmAvailablePages</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05118">MmMinimumFreePages</a>, <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00146">MmNumberOfForegroundProcesses</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00215">MmShortTime</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l02220">PERFINFO_WSMANAGE_DECL</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l02235">PERFINFO_WSMANAGE_TRIMACTION</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l02241">PERFINFO_WSMANAGE_WAITFORWRITER_CLAIMS</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l02242">PERFINFO_WSMANAGE_WAITFORWRITER_FAULTS</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l00961">UNLOCK_EXPANSION</a>.
<p>
Referenced by <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00397">MmWorkingSetManager()</a>.
<p>
<pre class="fragment"><div>01225                    :
01226 
01227      Check <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ending criteria.  If we're not done, delay <span class="keywordflow">for</span> a little
01228      bit to let <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> modified write <span class="keywordflow">catch</span> up.
01229 
01230 Arguments:
01231 
01232     Criteria - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> trim criteria information.
01233 
01234     OldIrql - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> old IRQL to lower to <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> expansion lock needs
01235               to be released.
01236 
01237 Return Value:
01238 
01239     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> trimming can be stopped, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise.
01240 
01241 Environment:
01242 
01243     Kernel mode.  Expansion lock held.  APC level or below.
01244 
01245 --*/
01246 
01247 {
01248     BOOLEAN FinishedTrimming;
01249     <a class="code" href="../../d2/d1/mm_8h.html#a99">PERFINFO_WSMANAGE_DECL</a>();
01250 
01251     FinishedTrimming = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01252 
01253 <span class="preprocessor">#ifdef _MI_USE_CLAIMS_</span>
01254 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ((<a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> &gt; Criteria-&gt;ClaimBased.DesiredFreeGoal) ||
01255         (Criteria-&gt;ClaimBased.NumPasses &gt;= <a class="code" href="../../d4/d8/mi_8h.html#a199">MI_MAX_TRIM_PASSES</a>)) {
01256 
01257         <span class="comment">//</span>
01258         <span class="comment">// We have enough pages or we trimmed as many as we're going to get.</span>
01259         <span class="comment">//</span>
01260 
01261         FinishedTrimming = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01262     }
01263     <span class="keywordflow">else</span> {
01264 
01265         <span class="comment">//</span>
01266         <span class="comment">// Update the global claim and estimate before we wait.</span>
01267         <span class="comment">//</span>
01268 
01269         MmTotalClaim = Criteria-&gt;ClaimBased.NewTotalClaim;
01270         MmTotalEstimatedAvailable = Criteria-&gt;ClaimBased.NewTotalEstimatedAvailable;
01271     }
01272 <span class="preprocessor">#else</span>
01273 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> &gt; <a class="code" href="../../d4/d8/mi_8h.html#a726">MmMinimumFreePages</a>) {
01274 
01275         <span class="comment">//</span>
01276         <span class="comment">// Every process has been examined and ample pages</span>
01277         <span class="comment">// now exist.</span>
01278         <span class="comment">//</span>
01279 
01280         <a class="code" href="../../d5/d0/wsmanage_8c.html#a22">MmNumberOfForegroundProcesses</a> = Criteria-&gt;FaultBased.NumberOfForegroundProcesses;
01281 
01282         FinishedTrimming = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01283     }
01284 <span class="preprocessor">#endif</span>
01285 <span class="preprocessor"></span>
01286     <span class="keywordflow">if</span> (FinishedTrimming == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01287 
01288         <span class="comment">//</span>
01289         <span class="comment">// If we don't have enough pages wait 10 milliseconds</span>
01290         <span class="comment">// for the modified page writer to catch up.  The wait is also</span>
01291         <span class="comment">// important because a thread may have the system cache locked but</span>
01292         <span class="comment">// has been preempted by the balance set manager due to its higher</span>
01293         <span class="comment">// priority.  We must give this thread a shot at running so it can</span>
01294         <span class="comment">// release the system cache lock (all the trimmable pages may reside in</span>
01295         <span class="comment">// the system cache).</span>
01296         <span class="comment">//</span>
01297 
01298         <a class="code" href="../../d4/d8/mi_8h.html#a140">UNLOCK_EXPANSION</a> (OldIrql);
01299 
01300         <a class="code" href="../../d1/d7/wait_8c.html#a2">KeDelayExecutionThread</a> (KernelMode,
01301                                 FALSE,
01302                                 &amp;MmShortTime);
01303 
01304 <span class="preprocessor">#ifdef _MI_USE_CLAIMS_</span>
01305 <span class="preprocessor"></span>        <a class="code" href="../../d2/d1/mm_8h.html#a120">PERFINFO_WSMANAGE_WAITFORWRITER_CLAIMS</a>();
01306 <span class="preprocessor">#else</span>
01307 <span class="preprocessor"></span>        <a class="code" href="../../d2/d1/mm_8h.html#a121">PERFINFO_WSMANAGE_WAITFORWRITER_FAULTS</a>();
01308 <span class="preprocessor">#endif</span>
01309 <span class="preprocessor"></span>
01310         <span class="comment">//</span>
01311         <span class="comment">// Check again to see if we've met the criteria to stop trimming.</span>
01312         <span class="comment">//</span>
01313 
01314 <span class="preprocessor">#ifdef _MI_USE_CLAIMS_</span>
01315 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> &gt; Criteria-&gt;ClaimBased.DesiredFreeGoal) {
01316 
01317             <span class="comment">//</span>
01318             <span class="comment">// Now we have enough pages so break out.</span>
01319             <span class="comment">//</span>
01320 
01321             FinishedTrimming = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01322         }
01323         <span class="keywordflow">else</span> {
01324 
01325             <span class="comment">//</span>
01326             <span class="comment">// We don't have enough pages so let's do another pass.</span>
01327             <span class="comment">// Go get the next working set list which is probably the</span>
01328             <span class="comment">// one we put back before we gave up the processor.</span>
01329             <span class="comment">//</span>
01330     
01331             <span class="keywordflow">if</span> (Criteria-&gt;ClaimBased.NumPasses == 0) {
01332                 MiAdjustClaimParameters(FALSE);
01333             }
01334 
01335             Criteria-&gt;ClaimBased.NumPasses += 1;
01336             Criteria-&gt;ClaimBased.NewTotalClaim = 0;
01337             Criteria-&gt;ClaimBased.NewTotalEstimatedAvailable = 0;
01338     
01339             <a class="code" href="../../d2/d1/mm_8h.html#a114">PERFINFO_WSMANAGE_TRIMACTION</a>(WS_ACTION_FORCE_TRIMMING_PROCESS);
01340         }
01341 <span class="preprocessor">#else</span>
01342 <span class="preprocessor"></span>
01343         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> &gt; <a class="code" href="../../d4/d8/mi_8h.html#a726">MmMinimumFreePages</a>) {
01344 
01345             <span class="comment">//</span>
01346             <span class="comment">// Now we have enough pages so break out.</span>
01347             <span class="comment">//</span>
01348 
01349             FinishedTrimming = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01350         }
01351         <span class="keywordflow">else</span> {
01352 
01353             <span class="comment">//</span>
01354             <span class="comment">// Change this to a forced trim, so we get pages</span>
01355             <span class="comment">// available, and reset the current time.</span>
01356             <span class="comment">//</span>
01357 
01358             <a class="code" href="../../d2/d1/mm_8h.html#a114">PERFINFO_WSMANAGE_TRIMACTION</a>(WS_ACTION_FORCE_TRIMMING_PROCESS);
01359 
01360             <a class="code" href="../../d5/d0/wsmanage_8c.html#a23">MiCheckCounter</a> = 0;
01361             Criteria-&gt;FaultBased.NumPasses += 1;
01362         }
01363 <span class="preprocessor">#endif</span>
01364 <span class="preprocessor"></span>
01365         <a class="code" href="../../d4/d8/mi_8h.html#a139">LOCK_EXPANSION</a> (OldIrql);
01366     }
01367 
01368     <span class="keywordflow">return</span> FinishedTrimming;
01369 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a34" doxytag="wsmanage.c::MiCheckSystemTrimEndCriteria" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN MiCheckSystemTrimEndCriteria           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT <a class="el" href="../../d8/d7/union__MMWS__TRIM__CRITERIA.html">PMMWS_TRIM_CRITERIA</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Criteria</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN KIRQL&nbsp;</td>
          <td class="mdname" nowrap> <em>OldIrql</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a46" doxytag="wsmanage.c::MiDetermineWsTrimAmount" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG MiDetermineWsTrimAmount           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d8/d7/union__MMWS__TRIM__CRITERIA.html">PMMWS_TRIM_CRITERIA</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Criteria</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d3/d6/struct__MMSUPPORT.html">PMMSUPPORT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>VmSupport</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Process</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l01644">1644</a> of file <a class="el" href="../../d6/d9/wsmanage_8c-source.html">wsmanage.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00076">_MMSUPPORT::Claim</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00079">_MMSUPPORT::EstimatedAvailable</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01600">_MMWSL::FirstDynamic</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00063">_MMSUPPORT::MaximumWorkingSetSize</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00043">MEMORY_PRIORITY_FOREGROUND</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00069">_MMSUPPORT::MemoryPriority</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01704">MI_BACKGROUND_CLAIM_AVAILABLE_SHIFT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01698">MI_FOREGROUND_CLAIM_AVAILABLE_SHIFT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01682">MI_PASS0_TRIM_AGE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01683">MI_PASS1_TRIM_AGE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01684">MI_PASS2_TRIM_AGE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01685">MI_PASS3_TRIM_AGE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01686">MI_PASS4_TRIM_AGE</a>, <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00163">MiCheckCounter</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00062">_MMSUPPORT::MinimumWorkingSetSize</a>, <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00101">MM_TRIM_COUNTER_MAXIMUM_LARGE_MEM</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00134">MmAvailablePages</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00064">MmSystemCacheWs</a>, <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00133">MmWorkingSetReductionHuge</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l00088">MmWorkingSetReductionMax</a>, <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00131">MmWorkingSetReductionMaxCacheWs</a>, <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00127">MmWorkingSetReductionMin</a>, <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00128">MmWorkingSetReductionMinCacheWs</a>, <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00142">MmWorkingSetSwapReduction</a>, <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00144">MmWorkingSetSwapReductionHuge</a>, <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00140">MmWorkingSetVolReductionHuge</a>, <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00137">MmWorkingSetVolReductionMax</a>, <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00138">MmWorkingSetVolReductionMaxCacheWs</a>, <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00135">MmWorkingSetVolReductionMin</a>, <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00190">_MMWS_TRIM_CRITERIA::NumPasses</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00213">_EPROCESS::ProcessOutswapEnabled</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01598">_MMWSL::Quota</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d3/d6/struct__MMSUPPORT.html#o15">_MMSUPPORT::u</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00064">_MMSUPPORT::VmWorkingSetList</a>, and <a class="el" href="../../d2/d8/ps_8h-source.html#l00061">_MMSUPPORT::WorkingSetSize</a>.
<p>
Referenced by <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00397">MmWorkingSetManager()</a>.
<p>
<pre class="fragment"><div>01652                    :
01653 
01654      Determine whether <span class="keyword">this</span> process should be trimmed.
01655 
01656 Arguments:
01657 
01658     Criteria - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> trim criteria information.
01659 
01660     VmSupport - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> working set information <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> candidate process.
01661 
01662     Process - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> candidate process to be trimmed.
01663 
01664 Return Value:
01665 
01666     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> trimming should be done on <span class="keyword">this</span> process, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <span class="keywordflow">if</span> not.
01667 
01668 Environment:
01669 
01670     Kernel mode.  Expansion lock held.  APC level or below.
01671 
01672 --*/
01673 
01674 {
01675     <a class="code" href="../../d0/d8/struct__MMWSL.html">PMMWSL</a> WorkingSetList;
01676     ULONG MaxTrim;
01677     ULONG Trim;
01678     BOOLEAN OutswapEnabled;
01679 
01680     <span class="keywordflow">if</span> (Process) {
01681         OutswapEnabled = Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o24">ProcessOutswapEnabled</a>;
01682     }
01683     <span class="keywordflow">else</span> {
01684         <span class="keywordflow">if</span> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.TrimHard == 1) {
01685             OutswapEnabled = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01686         }
01687         <span class="keywordflow">else</span> {
01688             OutswapEnabled = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01689         }
01690     }
01691 
01692     WorkingSetList = VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o7">VmWorkingSetList</a>;
01693 
01694     <span class="keywordflow">if</span> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o4">WorkingSetSize</a> &lt;= WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>) {
01695         <span class="keywordflow">return</span> 0;
01696     }
01697 
01698 <span class="preprocessor">#ifdef _MI_USE_CLAIMS_</span>
01699 <span class="preprocessor"></span>    MaxTrim = VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o4">WorkingSetSize</a>;
01700 
01701     <span class="keywordflow">if</span> (OutswapEnabled == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01702         
01703         <span class="comment">//</span>
01704         <span class="comment">// Don't trim the cache or non-swapped sessions or processes</span>
01705         <span class="comment">// below their minimum.</span>
01706         <span class="comment">//</span>
01707 
01708         MaxTrim -= VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o5">MinimumWorkingSetSize</a>;
01709     }
01710 
01711     <span class="keywordflow">switch</span> (Criteria-&gt;ClaimBased.<a class="code" href="../../d8/d7/union__MMWS__TRIM__CRITERIA.html#o0">NumPasses</a>) {
01712     <span class="keywordflow">case</span> 0:
01713         Trim = VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o16">Claim</a> &gt;&gt; 
01714                     ((VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o12">MemoryPriority</a> == <a class="code" href="../../d1/d9/ps_8h.html#a3">MEMORY_PRIORITY_FOREGROUND</a>)
01715                         ? <a class="code" href="../../d4/d8/mi_8h.html#a206">MI_FOREGROUND_CLAIM_AVAILABLE_SHIFT</a>
01716                         : <a class="code" href="../../d4/d8/mi_8h.html#a207">MI_BACKGROUND_CLAIM_AVAILABLE_SHIFT</a>);
01717         Criteria-&gt;ClaimBased.TrimAge = <a class="code" href="../../d4/d8/mi_8h.html#a200">MI_PASS0_TRIM_AGE</a>;
01718         Criteria-&gt;ClaimBased.DoAging = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01719         <span class="keywordflow">break</span>;
01720     <span class="keywordflow">case</span> 1:
01721         Trim = VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o16">Claim</a> &gt;&gt; 
01722                     ((VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o12">MemoryPriority</a> == <a class="code" href="../../d1/d9/ps_8h.html#a3">MEMORY_PRIORITY_FOREGROUND</a>)
01723                         ? <a class="code" href="../../d4/d8/mi_8h.html#a206">MI_FOREGROUND_CLAIM_AVAILABLE_SHIFT</a>
01724                         : <a class="code" href="../../d4/d8/mi_8h.html#a207">MI_BACKGROUND_CLAIM_AVAILABLE_SHIFT</a>);
01725         Criteria-&gt;ClaimBased.TrimAge = <a class="code" href="../../d4/d8/mi_8h.html#a201">MI_PASS1_TRIM_AGE</a>;
01726         Criteria-&gt;ClaimBased.DoAging = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01727         <span class="keywordflow">break</span>;
01728     <span class="keywordflow">case</span> 2:
01729         Trim = VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o16">Claim</a>;
01730         Criteria-&gt;ClaimBased.TrimAge = <a class="code" href="../../d4/d8/mi_8h.html#a202">MI_PASS2_TRIM_AGE</a>;
01731         Criteria-&gt;ClaimBased.DoAging = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01732         <span class="keywordflow">break</span>;
01733     <span class="keywordflow">case</span> 3:
01734         Trim = VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o19">EstimatedAvailable</a>;
01735         Criteria-&gt;ClaimBased.TrimAge = <a class="code" href="../../d4/d8/mi_8h.html#a203">MI_PASS3_TRIM_AGE</a>;
01736         Criteria-&gt;ClaimBased.DoAging = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01737         <span class="keywordflow">break</span>;
01738     <span class="keywordflow">default</span>:
01739         Trim = VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o19">EstimatedAvailable</a>;
01740         Criteria-&gt;ClaimBased.TrimAge = <a class="code" href="../../d4/d8/mi_8h.html#a203">MI_PASS3_TRIM_AGE</a>;
01741         Criteria-&gt;ClaimBased.DoAging = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01742 
01743         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> &lt; 100) {
01744             <span class="keywordflow">if</span> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o4">WorkingSetSize</a> &gt; VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o5">MinimumWorkingSetSize</a>) {
01745                 Trim = (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o4">WorkingSetSize</a> - VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o5">MinimumWorkingSetSize</a>) &gt;&gt; 2;
01746             }
01747             Criteria-&gt;ClaimBased.TrimAge = <a class="code" href="../../d4/d8/mi_8h.html#a204">MI_PASS4_TRIM_AGE</a>;
01748             Criteria-&gt;ClaimBased.DoAging = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01749         }
01750 
01751         <span class="keywordflow">break</span>;
01752     }
01753 
01754     <span class="keywordflow">if</span> (Trim &gt; MaxTrim) {
01755         Trim = MaxTrim;
01756     }
01757 
01758 <span class="preprocessor">#else</span>
01759 <span class="preprocessor"></span>
01760     UNREFERENCED_PARAMETER (Criteria);
01761 
01762     <span class="comment">//</span>
01763     <span class="comment">// Calculate Trim size.</span>
01764     <span class="comment">//</span>
01765 
01766     <span class="keywordflow">if</span> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o4">WorkingSetSize</a> &lt;= VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o5">MinimumWorkingSetSize</a> &amp;&amp;
01767         OutswapEnabled == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01768 
01769         <span class="comment">//</span>
01770         <span class="comment">// Set the quota to the minimum and reduce the working</span>
01771         <span class="comment">// set size.</span>
01772         <span class="comment">//</span>
01773 
01774         WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o0">Quota</a> = VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o5">MinimumWorkingSetSize</a>;
01775         Trim = VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o4">WorkingSetSize</a> - WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o2">FirstDynamic</a>;
01776         <span class="keywordflow">if</span> (Trim &gt; <a class="code" href="../../d5/d0/wsmanage_8c.html#a20">MmWorkingSetSwapReduction</a>) {
01777             Trim = <a class="code" href="../../d5/d0/wsmanage_8c.html#a20">MmWorkingSetSwapReduction</a>;
01778         }
01779 
01780         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((LONG)Trim &gt;= 0);
01781 
01782     } <span class="keywordflow">else</span> {
01783 
01784         MaxTrim = VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o4">WorkingSetSize</a> -
01785                                      VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o5">MinimumWorkingSetSize</a>;
01786 
01787         <span class="keywordflow">if</span> (OutswapEnabled == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01788 
01789             <span class="comment">//</span>
01790             <span class="comment">// All thread stacks have been swapped out this process or</span>
01791             <span class="comment">// all the processes and threads have been swapped out of this</span>
01792             <span class="comment">// session.</span>
01793             <span class="comment">//</span>
01794 
01795             ULONG i;
01796 
01797             Trim = <a class="code" href="../../d5/d0/wsmanage_8c.html#a20">MmWorkingSetSwapReduction</a>;
01798             i = VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o4">WorkingSetSize</a> - VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o6">MaximumWorkingSetSize</a>;
01799             <span class="keywordflow">if</span> ((LONG)i &gt; 0) {
01800                 Trim = i;
01801                 <span class="keywordflow">if</span> (Trim &gt; <a class="code" href="../../d5/d0/wsmanage_8c.html#a21">MmWorkingSetSwapReductionHuge</a>) {
01802                     Trim = <a class="code" href="../../d5/d0/wsmanage_8c.html#a21">MmWorkingSetSwapReductionHuge</a>;
01803                 }
01804             }
01805 
01806         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d5/d0/wsmanage_8c.html#a23">MiCheckCounter</a> &gt;= <a class="code" href="../../d5/d0/wsmanage_8c.html#a0">MM_TRIM_COUNTER_MAXIMUM_LARGE_MEM</a>) {
01807 
01808             <span class="comment">//</span>
01809             <span class="comment">// Haven't faulted much, reduce a bit.</span>
01810             <span class="comment">//</span>
01811 
01812             <span class="keywordflow">if</span> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o4">WorkingSetSize</a> &gt;
01813                   (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o6">MaximumWorkingSetSize</a> +
01814                             (6 * <a class="code" href="../../d5/d0/wsmanage_8c.html#a19">MmWorkingSetVolReductionHuge</a>))) {
01815                 Trim = <a class="code" href="../../d5/d0/wsmanage_8c.html#a19">MmWorkingSetVolReductionHuge</a>;
01816 
01817             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( (VmSupport != &amp;<a class="code" href="../../d6/d8/sysinfo_8c.html#a21">MmSystemCacheWs</a>) &amp;&amp;
01818                     VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o4">WorkingSetSize</a> &gt;
01819                         ( VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o6">MaximumWorkingSetSize</a> + (2 * <a class="code" href="../../d5/d0/wsmanage_8c.html#a15">MmWorkingSetReductionHuge</a>))) {
01820                 Trim = <a class="code" href="../../d5/d0/wsmanage_8c.html#a15">MmWorkingSetReductionHuge</a>;
01821             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o4">WorkingSetSize</a> &gt; VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o6">MaximumWorkingSetSize</a>) {
01822                 <span class="keywordflow">if</span> (VmSupport != &amp;<a class="code" href="../../d6/d8/sysinfo_8c.html#a21">MmSystemCacheWs</a>) {
01823                     Trim = <a class="code" href="../../d5/d0/wsmanage_8c.html#a17">MmWorkingSetVolReductionMax</a>;
01824                 } <span class="keywordflow">else</span> {
01825                     Trim = <a class="code" href="../../d5/d0/wsmanage_8c.html#a18">MmWorkingSetVolReductionMaxCacheWs</a>;
01826                 }
01827             } <span class="keywordflow">else</span> {
01828                 Trim = <a class="code" href="../../d5/d0/wsmanage_8c.html#a16">MmWorkingSetVolReductionMin</a>;
01829             }
01830 
01831         } <span class="keywordflow">else</span> {
01832 
01833             <span class="keywordflow">if</span> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o4">WorkingSetSize</a> &gt;
01834                   (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o6">MaximumWorkingSetSize</a> +
01835                             (2 * <a class="code" href="../../d5/d0/wsmanage_8c.html#a15">MmWorkingSetReductionHuge</a>))) {
01836                 Trim = <a class="code" href="../../d5/d0/wsmanage_8c.html#a15">MmWorkingSetReductionHuge</a>;
01837 
01838             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o4">WorkingSetSize</a> &gt; VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o6">MaximumWorkingSetSize</a>) {
01839                 <span class="keywordflow">if</span> (VmSupport != &amp;<a class="code" href="../../d6/d8/sysinfo_8c.html#a21">MmSystemCacheWs</a>) {
01840                     Trim = <a class="code" href="../../d4/d5/procsup_8c.html#a6">MmWorkingSetReductionMax</a>;
01841                 } <span class="keywordflow">else</span> {
01842                     Trim = <a class="code" href="../../d5/d0/wsmanage_8c.html#a14">MmWorkingSetReductionMaxCacheWs</a>;
01843                 }
01844             } <span class="keywordflow">else</span> {
01845                 <span class="keywordflow">if</span> (VmSupport != &amp;<a class="code" href="../../d6/d8/sysinfo_8c.html#a21">MmSystemCacheWs</a>) {
01846                     Trim = <a class="code" href="../../d5/d0/wsmanage_8c.html#a11">MmWorkingSetReductionMin</a>;
01847                 } <span class="keywordflow">else</span> {
01848                     Trim = <a class="code" href="../../d5/d0/wsmanage_8c.html#a12">MmWorkingSetReductionMinCacheWs</a>;
01849                 }
01850             }
01851         }
01852 
01853         <span class="keywordflow">if</span> (MaxTrim &lt; Trim) {
01854             Trim = MaxTrim;
01855         }
01856     }
01857 <span class="preprocessor">#endif</span>
01858 <span class="preprocessor"></span>
01859     <span class="keywordflow">return</span> Trim;
01860 }
<span class="preprocessor">#ifdef _MI_USE_CLAIMS_</span>
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a37" doxytag="wsmanage.c::MiDetermineWsTrimAmount" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG MiDetermineWsTrimAmount           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d8/d7/union__MMWS__TRIM__CRITERIA.html">PMMWS_TRIM_CRITERIA</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Criteria</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d3/d6/struct__MMSUPPORT.html">PMMSUPPORT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>VmSupport</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Process</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a47" doxytag="wsmanage.c::MiEmptyAllWorkingSets" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MiEmptyAllWorkingSets           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l02715">2715</a> of file <a class="el" href="../../d6/d9/wsmanage_8c-source.html">wsmanage.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l03321">ExPageLockHandle</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01072">KeClearEvent</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d3/d7/eventobj_8c-source.html#l00343">KeSetEvent()</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00957">LOCK_EXPANSION</a>, <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l02788">MiEmptyAllWorkingSetsWorker()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04438">MiHydra</a>, <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00107">MiWaitForEmptyEvent</a>, <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00108">MiWaitingForWorkingSetEmpty</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l06284">MmLockPagableSectionByHandle()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l07065">MmUnlockPagableImageSection()</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00418">MmWorkingSetManagerEvent</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00961">UNLOCK_EXPANSION</a>, and <a class="el" href="../../d4/d9/ke_8h.html#a407a216">WrVirtualMemory</a>.
<p>
Referenced by <a class="el" href="../../d6/d5/iosup_8c-source.html#l04107">MiAllocateContiguousMemory()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l07930">MmGatherMemoryForHibernate()</a>, and <a class="el" href="../../d0/d3/dynmem_8c-source.html#l00437">MmRemovePhysicalMemory()</a>.
<p>
<pre class="fragment"><div>02721                    :
02722 
02723     This routine attempts to empty all <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> working sets on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02724     expansion list.
02725 
02726 Arguments:
02727 
02728     None.
02729 
02730 Return Value:
02731 
02732     None.
02733 
02734 Environment:
02735 
02736     Kernel mode.  No locks held.  APC level or below.
02737 
02738 --*/
02739 
02740 {
02741     KIRQL OldIrql;
02742 
02743     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a> ();
02744 
02745     <a class="code" href="../../d5/d6/iosup_8c.html#a76">MmLockPagableSectionByHandle</a> (ExPageLockHandle);
02746 
02747     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a581">MiHydra</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
02748         <a class="code" href="../../d5/d0/wsmanage_8c.html#a32">MiEmptyAllWorkingSetsWorker</a> ();
02749     }
02750     <span class="keywordflow">else</span> {
02751         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PsGetCurrentThread () != MmWorkingSetThread);
02752 
02753         <span class="comment">//</span>
02754         <span class="comment">// For Hydra, we cannot attach directly to the session space to be</span>
02755         <span class="comment">// trimmed because it would result in session space references by</span>
02756         <span class="comment">// other threads in this process to the attached session instead</span>
02757         <span class="comment">// of the (currently) correct one.  In fact, we cannot even queue</span>
02758         <span class="comment">// this to a worker thread because the working set manager</span>
02759         <span class="comment">// (who shares the same page directory) may be attaching or</span>
02760         <span class="comment">// detaching from a session (any session).  So this must be queued</span>
02761         <span class="comment">// to the working set manager.</span>
02762         <span class="comment">//</span>
02763     
02764         <a class="code" href="../../d4/d8/mi_8h.html#a139">LOCK_EXPANSION</a> (OldIrql);
02765 
02766         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d0/wsmanage_8c.html#a8">MiWaitingForWorkingSetEmpty</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
02767             <a class="code" href="../../d5/d0/wsmanage_8c.html#a8">MiWaitingForWorkingSetEmpty</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02768             <a class="code" href="../../d4/d9/ke_8h.html#a21">KeClearEvent</a> (&amp;MiWaitForEmptyEvent);
02769         }
02770 
02771         <a class="code" href="../../d4/d8/mi_8h.html#a140">UNLOCK_EXPANSION</a> (OldIrql);
02772 
02773         <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a> (&amp;MmWorkingSetManagerEvent, 0, FALSE);
02774 
02775         <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a> (&amp;MiWaitForEmptyEvent,
02776                                WrVirtualMemory,
02777                                KernelMode,
02778                                FALSE,
02779                                (PLARGE_INTEGER)0);
02780     }
02781 
02782     <a class="code" href="../../d5/d6/iosup_8c.html#a81">MmUnlockPagableImageSection</a> (ExPageLockHandle);
02783 
02784     <span class="keywordflow">return</span>;
02785 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a32" doxytag="wsmanage.c::MiEmptyAllWorkingSetsWorker" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MiEmptyAllWorkingSetsWorker           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l02788">2788</a> of file <a class="el" href="../../d6/d9/wsmanage_8c-source.html">wsmanage.c</a>.
<p>
References <a class="el" href="../../d2/d8/ps_8h-source.html#l00216">_EPROCESS::AddressSpaceDeleted</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00166">KeAttachProcess()</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00405">KeDetachProcess()</a>, <a class="el" href="../../d3/d7/eventobj_8c-source.html#l00343">KeSetEvent()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02222">_MMWORKING_SET_EXPANSION_HEAD::ListHead</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00957">LOCK_EXPANSION</a>, <a class="el" href="../../d4/d6/session_8c-source.html#l01181">MiAttachSession()</a>, <a class="el" href="../../d4/d6/session_8c-source.html#l01253">MiDetachSession()</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l04726">MiEmptyWorkingSet()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04438">MiHydra</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00099">MM_NO_WS_EXPANSION</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00100">MM_WS_EXPANSION_IN_PROGRESS</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00064">MmSystemCacheWs</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05071">MmWorkingSetExpansionHead</a>, <a class="el" href="../../d1/d8/miglobal_8c-source.html#l00442">MmWorkingSetList</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00166">_EPROCESS::Pcb</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d3/d6/struct__MMSUPPORT.html#o15">_MMSUPPORT::u</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00961">UNLOCK_EXPANSION</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00196">_EPROCESS::Vm</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00064">_MMSUPPORT::VmWorkingSetList</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00065">_MMSUPPORT::WorkingSetExpansionLinks</a>, and <a class="el" href="../../d2/d8/ps_8h-source.html#l00061">_MMSUPPORT::WorkingSetSize</a>.
<p>
Referenced by <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00996">MiCheckAndSetSystemTrimCriteria()</a>, and <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l02715">MiEmptyAllWorkingSets()</a>.
<p>
<pre class="fragment"><div>02794                    :
02795 
02796     This routine attempts to empty all <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> working sets on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> expansion list.
02797 
02798 Arguments:
02799 
02800     None.
02801 
02802 Return Value:
02803 
02804     None.
02805 
02806 Environment:
02807 
02808     Kernel mode.  No locks held.  APC level or below.
02809 
02810 --*/
02811 
02812 {
02813     <a class="code" href="../../d3/d6/struct__MMSUPPORT.html">PMMSUPPORT</a> VmSupport;
02814     <a class="code" href="../../d3/d6/struct__MMSUPPORT.html">PMMSUPPORT</a> FirstSeen;
02815     ULONG SystemCacheSeen;
02816     KIRQL OldIrql;
02817     PLIST_ENTRY ListEntry;
02818     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> ProcessToTrim;
02819     <a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html">PMM_SESSION_SPACE</a> SessionSpace;
02820     ULONG LoopCount;
02821 
02822     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a> ();
02823 
02824     FirstSeen = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02825     SystemCacheSeen = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02826     LoopCount = 0;
02827 
02828     <a class="code" href="../../d4/d8/mi_8h.html#a139">LOCK_EXPANSION</a> (OldIrql);
02829 
02830     <span class="keywordflow">while</span> (!IsListEmpty (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a710">MmWorkingSetExpansionHead</a>.<a class="code" href="../../d7/d7/struct__MMWORKING__SET__EXPANSION__HEAD.html#o0">ListHead</a>)) {
02831 
02832         <span class="comment">//</span>
02833         <span class="comment">// Remove the entry at the head and trim it.</span>
02834         <span class="comment">//</span>
02835 
02836         ListEntry = RemoveHeadList (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a710">MmWorkingSetExpansionHead</a>.<a class="code" href="../../d7/d7/struct__MMWORKING__SET__EXPANSION__HEAD.html#o0">ListHead</a>);
02837 
02838         <span class="keywordflow">if</span> (ListEntry == &amp;<a class="code" href="../../d6/d8/sysinfo_8c.html#a21">MmSystemCacheWs</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>) {
02839             VmSupport = &amp;<a class="code" href="../../d6/d8/sysinfo_8c.html#a21">MmSystemCacheWs</a>;
02840             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.SessionSpace == 0);
02841             ProcessToTrim = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02842             <span class="keywordflow">if</span> (SystemCacheSeen != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
02843 
02844                 <span class="comment">//</span>
02845                 <span class="comment">// Seen this one already.</span>
02846                 <span class="comment">//</span>
02847 
02848                 FirstSeen = VmSupport;
02849             }
02850             SystemCacheSeen = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02851         }
02852         <span class="keywordflow">else</span> {
02853             VmSupport = CONTAINING_RECORD(ListEntry,
02854                                           <a class="code" href="../../d3/d6/struct__MMSUPPORT.html">MMSUPPORT</a>,
02855                                           WorkingSetExpansionLinks);
02856 
02857             <span class="keywordflow">if</span> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.SessionSpace == 0) {
02858                 ProcessToTrim = CONTAINING_RECORD(VmSupport,
02859                                                   <a class="code" href="../../d0/d4/struct__EPROCESS.html">EPROCESS</a>,
02860                                                   Vm);
02861 
02862                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o7">VmWorkingSetList</a> == MmWorkingSetList);
02863                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (VmSupport == &amp;ProcessToTrim-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>);
02864                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ProcessToTrim-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o27">AddressSpaceDeleted</a> == 0);
02865                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.SessionSpace == 0);
02866             }
02867             <span class="keywordflow">else</span> {
02868                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (MiHydra == TRUE);
02869                 SessionSpace = CONTAINING_RECORD(VmSupport,
02870                                                  <a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html">MM_SESSION_SPACE</a>,
02871                                                  Vm);
02872 
02873                 ProcessToTrim = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02874             }
02875         }
02876 
02877         <span class="keywordflow">if</span> (VmSupport == FirstSeen) {
02878             InsertHeadList (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a710">MmWorkingSetExpansionHead</a>.<a class="code" href="../../d7/d7/struct__MMWORKING__SET__EXPANSION__HEAD.html#o0">ListHead</a>,
02879                         &amp;VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>);
02880             <span class="keywordflow">break</span>;
02881         }
02882 
02883         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.BeingTrimmed == 0);
02884         VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.BeingTrimmed = 1;
02885 
02886         VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>.Flink = <a class="code" href="../../d4/d8/mi_8h.html#a20">MM_NO_WS_EXPANSION</a>;
02887         VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>.Blink =
02888                                             <a class="code" href="../../d4/d8/mi_8h.html#a21">MM_WS_EXPANSION_IN_PROGRESS</a>;
02889         <a class="code" href="../../d4/d8/mi_8h.html#a140">UNLOCK_EXPANSION</a> (OldIrql);
02890 
02891         <span class="keywordflow">if</span> (FirstSeen == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02892             FirstSeen = VmSupport;
02893         }
02894 
02895         <span class="comment">//</span>
02896         <span class="comment">// Empty the working set.</span>
02897         <span class="comment">//</span>
02898 
02899         <span class="keywordflow">if</span> (ProcessToTrim == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02900             <span class="keywordflow">if</span> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.SessionSpace == 0) {
02901                 <a class="code" href="../../d4/d0/wslist_8c.html#a35">MiEmptyWorkingSet</a> (VmSupport, FALSE);
02902             }
02903             <span class="keywordflow">else</span> {
02904                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (MiHydra == TRUE);
02905                 <a class="code" href="../../d3/d7/session_8c.html#a16">MiAttachSession</a> (SessionSpace);
02906                 <a class="code" href="../../d4/d0/wslist_8c.html#a35">MiEmptyWorkingSet</a> (VmSupport, FALSE);
02907                 <a class="code" href="../../d3/d7/session_8c.html#a17">MiDetachSession</a> ();
02908             }
02909         }
02910         <span class="keywordflow">else</span> {
02911 
02912             <span class="keywordflow">if</span> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o4">WorkingSetSize</a> &gt; 4) {
02913                 <a class="code" href="../../d3/d5/procobj_8c.html#a4">KeAttachProcess</a> (&amp;ProcessToTrim-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>);
02914                 <a class="code" href="../../d4/d0/wslist_8c.html#a35">MiEmptyWorkingSet</a> (VmSupport, FALSE);
02915                 <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a> ();
02916             }
02917         }
02918 
02919         <span class="comment">//</span>
02920         <span class="comment">// Add back to the list.</span>
02921         <span class="comment">//</span>
02922 
02923         <a class="code" href="../../d4/d8/mi_8h.html#a139">LOCK_EXPANSION</a> (OldIrql);
02924         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>.Flink == MM_NO_WS_EXPANSION);
02925         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.BeingTrimmed == 1);
02926         VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.BeingTrimmed = 0;
02927 
02928         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>.Flink == MM_NO_WS_EXPANSION);
02929         <span class="keywordflow">if</span> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>.Blink ==
02930                                              <a class="code" href="../../d4/d8/mi_8h.html#a21">MM_WS_EXPANSION_IN_PROGRESS</a>) {
02931 
02932             <span class="comment">//</span>
02933             <span class="comment">// If the working set size is still above the minimum,</span>
02934             <span class="comment">// add this back at the tail of the list.</span>
02935             <span class="comment">//</span>
02936 
02937             InsertTailList (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a710">MmWorkingSetExpansionHead</a>.<a class="code" href="../../d7/d7/struct__MMWORKING__SET__EXPANSION__HEAD.html#o0">ListHead</a>,
02938                             &amp;VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>);
02939         }
02940         <span class="keywordflow">else</span> {
02941 
02942             <span class="comment">//</span>
02943             <span class="comment">// The value in the blink is the address of an event</span>
02944             <span class="comment">// to set.</span>
02945             <span class="comment">//</span>
02946 
02947             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (VmSupport != &amp;MmSystemCacheWs);
02948 
02949             <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a> ((<a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>)VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>.Blink,
02950                         0,
02951                         FALSE);
02952         }
02953 
02954         <span class="comment">//</span>
02955         <span class="comment">// The initial working set that was chosen for FirstSeen may have</span>
02956         <span class="comment">// been trimmed down under its minimum and been removed from the</span>
02957         <span class="comment">// ExpansionHead links.  It is possible that the system cache is not</span>
02958         <span class="comment">// on the links either.  This check detects this extremely rare</span>
02959         <span class="comment">// situation so that the system does not spin forever.</span>
02960         <span class="comment">//</span>
02961 
02962         LoopCount += 1;
02963         <span class="keywordflow">if</span> (LoopCount &gt; 200) {
02964             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d8/sysinfo_8c.html#a21">MmSystemCacheWs</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>.Blink == <a class="code" href="../../d4/d8/mi_8h.html#a21">MM_WS_EXPANSION_IN_PROGRESS</a>) {
02965                 <span class="keywordflow">break</span>;
02966             }
02967         }
02968     }
02969 
02970     <a class="code" href="../../d4/d8/mi_8h.html#a140">UNLOCK_EXPANSION</a> (OldIrql);
02971 
02972     <span class="keywordflow">return</span>;
02973 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a40" doxytag="wsmanage.c::MiObtainFreePages" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MiObtainFreePages           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00336">336</a> of file <a class="el" href="../../d6/d9/wsmanage_8c-source.html">wsmanage.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d7/eventobj_8c-source.html#l00343">KeSetEvent()</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00134">MmAvailablePages</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l01087">MmModifiedPageListHead</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05096">MmModifiedPageWriterEvent</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05126">MmModifiedWriteClusterSize</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04575">MmModNoWriteInsert</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04506">MmPagesAboveWsMinimum</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04520">MmPagesAboveWsThreshold</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00418">MmWorkingSetManagerEvent</a>, and <a class="el" href="../../d3/d0/mm_8h-source.html#l01079">_MMPFNLIST::Total</a>.
<p>
Referenced by <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l01567">MiRemovePageByColor()</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00521">MiRemovePageFromList()</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00821">MiUnlinkFreeOrZeroedPage()</a>, and <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00667">MiUnlinkPageFromList()</a>.
<p>
<pre class="fragment"><div>00342                    :
00343 
00344     This function examines <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> modified list and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00345     total number of pages in use because of working set increments
00346     and obtains pages by writing modified pages and/or reducing
00347     working sets.
00348 
00349 Arguments:
00350 
00351     None.
00352 
00353 Return Value:
00354 
00355     None.
00356 
00357 Environment:
00358 
00359     Kernel mode, APCs disabled, working set and PFN mutexes held.
00360 
00361 --*/
00362 
00363 {
00364 
00365     <span class="comment">//</span>
00366     <span class="comment">// Check to see if there are enough modified pages to institute a</span>
00367     <span class="comment">// write.</span>
00368     <span class="comment">//</span>
00369 
00370     <span class="keywordflow">if</span> ((<a class="code" href="../../d2/d1/mm_8h.html#a150">MmModifiedPageListHead</a>.<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o0">Total</a> &gt;= <a class="code" href="../../d4/d8/mi_8h.html#a730">MmModifiedWriteClusterSize</a>) ||
00371         (<a class="code" href="../../d4/d8/mi_8h.html#a608">MmModNoWriteInsert</a>)) {
00372 
00373         <span class="comment">//</span>
00374         <span class="comment">// Start the modified page writer.</span>
00375         <span class="comment">//</span>
00376 
00377         <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a> (&amp;MmModifiedPageWriterEvent, 0, FALSE);
00378     }
00379 
00380     <span class="comment">//</span>
00381     <span class="comment">// See if there are enough working sets above the minimum</span>
00382     <span class="comment">// threshold to make working set trimming worthwhile.</span>
00383     <span class="comment">//</span>
00384 
00385     <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d8/mi_8h.html#a590">MmPagesAboveWsMinimum</a> &gt; <a class="code" href="../../d4/d8/mi_8h.html#a592">MmPagesAboveWsThreshold</a>) ||
00386         (<a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> &lt; 5)) {
00387 
00388         <span class="comment">//</span>
00389         <span class="comment">// Start the working set manager to reduce working sets.</span>
00390         <span class="comment">//</span>
00391 
00392         <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a> (&amp;MmWorkingSetManagerEvent, 0, FALSE);
00393     }
00394 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a38" doxytag="wsmanage.c::MiRearrangeWorkingSetExpansionList" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MiRearrangeWorkingSetExpansionList           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l02465">2465</a> of file <a class="el" href="../../d6/d9/wsmanage_8c-source.html">wsmanage.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00076">_MMSUPPORT::Claim</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d8/d9/ke_2miscc_8c-source.html#l00153">KeQuerySystemTime()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05473">_MM_SESSION_SPACE::LastProcessSwappedOutTime</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02222">_MMWORKING_SET_EXPANSION_HEAD::ListHead</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00957">LOCK_EXPANSION</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00043">MEMORY_PRIORITY_FOREGROUND</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00069">_MMSUPPORT::MemoryPriority</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04438">MiHydra</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00191">MM_DBG_SESSIONS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00168">MM_DBG_WS_EXPANSION</a>, <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l02458">MM_WS_REORG_BUCKETS_MAX</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05071">MmWorkingSetExpansionHead</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05411">_MM_SESSION_SPACE::ReferenceCount</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05416">_MM_SESSION_SPACE::SessionId</a>, <a class="el" href="../../d9/d6/lh__open_2pi__mem_8h-source.html#l00017">Size</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d3/d6/struct__MMSUPPORT.html#o15">_MMSUPPORT::u</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00961">UNLOCK_EXPANSION</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00065">_MMSUPPORT::WorkingSetExpansionLinks</a>, and <a class="el" href="../../d2/d8/ps_8h-source.html#l00061">_MMSUPPORT::WorkingSetSize</a>.
<p>
Referenced by <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00996">MiCheckAndSetSystemTrimCriteria()</a>.
<p>
<pre class="fragment"><div>02471                    :
02472 
02473     This function arranges <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> working set list into different
02474     groups based upon <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> claim.  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> done so <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> working set
02475     trimming will take place on fat processes first.
02476 
02477     The working sets are sorted into buckets and then linked back up.
02478 
02479     Swapped <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a> sessions and processes are put at <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> front.
02480 
02481 Arguments:
02482 
02483     None.
02484 
02485 Return Value:
02486 
02487     None.
02488 
02489 Environment:
02490 
02491     Kernel mode, no locks held.
02492 
02493 --*/
02494 
02495 {
02496     KIRQL OldIrql;
02497     PLIST_ENTRY ListEntry;
02498     <a class="code" href="../../d3/d6/struct__MMSUPPORT.html">PMMSUPPORT</a> VmSupport;
02499     <span class="keywordtype">int</span> <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
02500     <span class="keywordtype">int</span> PreviousNonEmpty;
02501     <span class="keywordtype">int</span> NonEmpty;
02502     LIST_ENTRY ListHead[<a class="code" href="../../d5/d0/wsmanage_8c.html#a3">MM_WS_REORG_BUCKETS_MAX</a>];
02503     LARGE_INTEGER CurrentTime;
02504     LARGE_INTEGER SessionIdleTime;
02505     ULONG IdleTime;
02506     <a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html">PMM_SESSION_SPACE</a> SessionGlobal;
02507 
02508     <a class="code" href="../../d7/d0/ke_2miscc_8c.html#a3">KeQuerySystemTime</a> (&amp;CurrentTime);
02509 
02510     <span class="keywordflow">if</span> (IsListEmpty(&amp;<a class="code" href="../../d4/d8/mi_8h.html#a710">MmWorkingSetExpansionHead</a>.<a class="code" href="../../d7/d7/struct__MMWORKING__SET__EXPANSION__HEAD.html#o0">ListHead</a>)) {
02511         <span class="keywordflow">return</span>;
02512     }
02513 
02514     <span class="keywordflow">for</span> (<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = 0 ; <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> &lt; <a class="code" href="../../d5/d0/wsmanage_8c.html#a3">MM_WS_REORG_BUCKETS_MAX</a>; <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>++) {
02515         InitializeListHead(&amp;ListHead[Size]);
02516     }
02517 
02518     <a class="code" href="../../d4/d8/mi_8h.html#a139">LOCK_EXPANSION</a> (OldIrql);
02519 
02520     <span class="keywordflow">while</span> (!IsListEmpty (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a710">MmWorkingSetExpansionHead</a>.<a class="code" href="../../d7/d7/struct__MMWORKING__SET__EXPANSION__HEAD.html#o0">ListHead</a>)) {
02521         ListEntry = RemoveHeadList (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a710">MmWorkingSetExpansionHead</a>.<a class="code" href="../../d7/d7/struct__MMWORKING__SET__EXPANSION__HEAD.html#o0">ListHead</a>);
02522 
02523         VmSupport = CONTAINING_RECORD(ListEntry,
02524                                           <a class="code" href="../../d3/d6/struct__MMSUPPORT.html">MMSUPPORT</a>,
02525                                           WorkingSetExpansionLinks);
02526 
02527         <span class="keywordflow">if</span> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.TrimHard == 1) {
02528 
02529             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (MiHydra == TRUE);
02530             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.SessionSpace == 1);
02531 
02532             SessionGlobal = CONTAINING_RECORD (VmSupport,
02533                                                <a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html">MM_SESSION_SPACE</a>,
02534                                                Vm);
02535 
02536             SessionIdleTime.QuadPart = CurrentTime.QuadPart - SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o15">LastProcessSwappedOutTime</a>.QuadPart;
02537 
02538 <span class="preprocessor">#if DBG</span>
02539 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a83">MM_DBG_SESSIONS</a>) {
02540                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"Mm: Session %d heavily trim/aged - all its processes (%d) swapped out %d seconds ago\n"</span>,
02541                     SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o4">SessionId</a>,
02542                     SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o0">ReferenceCount</a>,
02543                     (ULONG)(SessionIdleTime.QuadPart / 10000000));
02544             }
02545 <span class="preprocessor">#endif</span>
02546 <span class="preprocessor"></span>
02547             <span class="keywordflow">if</span> (SessionIdleTime.QuadPart &lt; 0) {
02548 
02549                 <span class="comment">//</span>
02550                 <span class="comment">// The administrator has moved the system time backwards.</span>
02551                 <span class="comment">// Give this session a fresh start.</span>
02552                 <span class="comment">//</span>
02553 
02554                 SessionIdleTime.QuadPart = 0;
02555                 <a class="code" href="../../d7/d0/ke_2miscc_8c.html#a3">KeQuerySystemTime</a> (&amp;SessionGlobal-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o15">LastProcessSwappedOutTime</a>);
02556             }
02557 
02558             IdleTime = (ULONG) (SessionIdleTime.QuadPart / 10000000);
02559         }
02560         <span class="keywordflow">else</span> {
02561             IdleTime = 0;
02562         }
02563 
02564         <span class="keywordflow">if</span> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o12">MemoryPriority</a> == <a class="code" href="../../d1/d9/ps_8h.html#a3">MEMORY_PRIORITY_FOREGROUND</a>) {
02565 
02566             <span class="comment">//</span>
02567             <span class="comment">// Put the foreground processes at the end of the list,</span>
02568             <span class="comment">// to give them priority.</span>
02569             <span class="comment">//</span>
02570 
02571             <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = 6;
02572         }
02573 <span class="preprocessor">#ifdef _MI_USE_CLAIMS_</span>
02574 <span class="preprocessor"></span>        <span class="keywordflow">else</span> {
02575 
02576             <span class="keywordflow">if</span> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o16">Claim</a> &gt; 400) {
02577                 <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = 0;
02578             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (IdleTime &gt; 30) {
02579                 <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = 0;
02580 <span class="preprocessor">#if DBG</span>
02581 <span class="preprocessor"></span>                MiSessionIdleBuckets[<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>] += 1;
02582 <span class="preprocessor">#endif</span>
02583 <span class="preprocessor"></span>            } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o16">Claim</a> &gt; 200) {
02584                 <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = 1;
02585             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (IdleTime &gt; 20) {
02586                 <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = 1;
02587 <span class="preprocessor">#if DBG</span>
02588 <span class="preprocessor"></span>                MiSessionIdleBuckets[<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>] += 1;
02589 <span class="preprocessor">#endif</span>
02590 <span class="preprocessor"></span>            } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o16">Claim</a> &gt; 100) {
02591                 <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = 2;
02592             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (IdleTime &gt; 10) {
02593                 <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = 2;
02594 <span class="preprocessor">#if DBG</span>
02595 <span class="preprocessor"></span>                MiSessionIdleBuckets[<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>] += 1;
02596 <span class="preprocessor">#endif</span>
02597 <span class="preprocessor"></span>            } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o16">Claim</a> &gt; 50) {
02598                 <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = 3;
02599             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (IdleTime) {
02600                 <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = 3;
02601 <span class="preprocessor">#if DBG</span>
02602 <span class="preprocessor"></span>                MiSessionIdleBuckets[<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>] += 1;
02603 <span class="preprocessor">#endif</span>
02604 <span class="preprocessor"></span>            } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o16">Claim</a> &gt; 25) {
02605                 <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = 4;
02606             } <span class="keywordflow">else</span> {
02607                 <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = 5;
02608 <span class="preprocessor">#if DBG</span>
02609 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.SessionSpace == 1) {
02610                     MiSessionIdleBuckets[<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>] += 1;
02611                 }
02612 <span class="preprocessor">#endif</span>
02613 <span class="preprocessor"></span>            }
02614         }
02615 <span class="preprocessor">#else</span>
02616 <span class="preprocessor"></span>        <span class="keywordflow">else</span> {
02617 
02618             <span class="comment">//</span>
02619             <span class="comment">// Just put swapped out entries at the front and keep all other</span>
02620             <span class="comment">// entries in the same order, just in front of the foreground</span>
02621             <span class="comment">// processes.</span>
02622             <span class="comment">//</span>
02623 
02624             <span class="keywordflow">if</span> (IdleTime &gt; 40) {
02625                 <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = 0;
02626             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (IdleTime &gt; 30) {
02627                 <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = 1;
02628             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (IdleTime &gt; 20) {
02629                 <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = 2;
02630             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (IdleTime &gt; 10) {
02631                 <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = 3;
02632             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (IdleTime) {
02633                 <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = 4;
02634             } <span class="keywordflow">else</span> {
02635                 InsertTailList (&amp;ListHead[5],
02636                                 &amp;VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>);
02637                 <span class="keywordflow">continue</span>;
02638             }
02639 <span class="preprocessor">#if DBG</span>
02640 <span class="preprocessor"></span>            <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (MiHydra == TRUE);
02641             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.SessionSpace == 1);
02642             MiSessionIdleBuckets[<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>] += 1;
02643 <span class="preprocessor">#endif</span>
02644 <span class="preprocessor"></span>        }
02645 <span class="preprocessor">#endif</span>
02646 <span class="preprocessor"></span>
02647 <span class="preprocessor">#if DBG</span>
02648 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a60">MM_DBG_WS_EXPANSION</a>) {
02649             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"MM-rearrange: TrimHard = %d, WS Size = 0x%x, Claim 0x%x, Bucket %d\n"</span>,
02650                     VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.TrimHard,
02651                     VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o4">WorkingSetSize</a>,
02652                     VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o16">Claim</a>,
02653                     Size);
02654         }
02655 <span class="preprocessor">#endif //DBG</span>
02656 <span class="preprocessor"></span>
02657         <span class="comment">//</span>
02658         <span class="comment">// Note: this reverses the bucket order each time we</span>
02659         <span class="comment">// reorganize the lists.  This may be good or bad -</span>
02660         <span class="comment">// if you change it you may want to think about it.</span>
02661         <span class="comment">//</span>
02662 
02663         InsertHeadList (&amp;ListHead[Size],
02664                         &amp;VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>);
02665     }
02666 
02667     <span class="comment">//</span>
02668     <span class="comment">// Find the first non-empty list.</span>
02669     <span class="comment">//</span>
02670 
02671     <span class="keywordflow">for</span> (NonEmpty = 0 ; NonEmpty &lt; <a class="code" href="../../d5/d0/wsmanage_8c.html#a3">MM_WS_REORG_BUCKETS_MAX</a> ; NonEmpty += 1) {
02672         <span class="keywordflow">if</span> (!IsListEmpty (&amp;ListHead[NonEmpty])) {
02673             <span class="keywordflow">break</span>;
02674         }
02675     }
02676 
02677     <span class="comment">//</span>
02678     <span class="comment">// Put the head of first non-empty list at the beginning</span>
02679     <span class="comment">// of the MmWorkingSetExpansion list.</span>
02680     <span class="comment">//</span>
02681 
02682     <a class="code" href="../../d4/d8/mi_8h.html#a710">MmWorkingSetExpansionHead</a>.<a class="code" href="../../d7/d7/struct__MMWORKING__SET__EXPANSION__HEAD.html#o0">ListHead</a>.Flink = ListHead[NonEmpty].Flink;
02683     ListHead[NonEmpty].Flink-&gt;Blink = &amp;<a class="code" href="../../d4/d8/mi_8h.html#a710">MmWorkingSetExpansionHead</a>.<a class="code" href="../../d7/d7/struct__MMWORKING__SET__EXPANSION__HEAD.html#o0">ListHead</a>;
02684 
02685     PreviousNonEmpty = NonEmpty;
02686 
02687     <span class="comment">//</span>
02688     <span class="comment">// Link the rest of the lists together.</span>
02689     <span class="comment">//</span>
02690 
02691     <span class="keywordflow">for</span> (NonEmpty += 1; NonEmpty &lt; <a class="code" href="../../d5/d0/wsmanage_8c.html#a3">MM_WS_REORG_BUCKETS_MAX</a>; NonEmpty += 1) {
02692 
02693         <span class="keywordflow">if</span> (!IsListEmpty (&amp;ListHead[NonEmpty])) {
02694             
02695             ListHead[PreviousNonEmpty].Blink-&gt;Flink = ListHead[NonEmpty].Flink;
02696             ListHead[NonEmpty].Flink-&gt;Blink = ListHead[PreviousNonEmpty].Blink;
02697             PreviousNonEmpty = NonEmpty;
02698         }
02699     }
02700 
02701     <span class="comment">//</span>
02702     <span class="comment">// Link the tail of last non-empty to the MmWorkingSetExpansion list.</span>
02703     <span class="comment">//</span>
02704    
02705     <a class="code" href="../../d4/d8/mi_8h.html#a710">MmWorkingSetExpansionHead</a>.<a class="code" href="../../d7/d7/struct__MMWORKING__SET__EXPANSION__HEAD.html#o0">ListHead</a>.Blink = ListHead[PreviousNonEmpty].Blink;
02706     ListHead[PreviousNonEmpty].Blink-&gt;Flink = &amp;<a class="code" href="../../d4/d8/mi_8h.html#a710">MmWorkingSetExpansionHead</a>.<a class="code" href="../../d7/d7/struct__MMWORKING__SET__EXPANSION__HEAD.html#o0">ListHead</a>;
02707 
02708     <a class="code" href="../../d4/d8/mi_8h.html#a140">UNLOCK_EXPANSION</a> (OldIrql);
02709 
02710     <span class="keywordflow">return</span>;
02711 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a48" doxytag="wsmanage.c::MmTrimAllSystemPagableMemory" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LOGICAL MmTrimAllSystemPagableMemory           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN LOGICAL&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>PurgeTransition</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l02986">2986</a> of file <a class="el" href="../../d6/d9/wsmanage_8c-source.html">wsmanage.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00086">APC_LEVEL</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d9/d7/ex_2resource_8c-source.html#l01389">ExReleaseResourceLite()</a>, <a class="el" href="../../d9/d7/ex_2resource_8c-source.html#l00598">ExTryToAcquireResourceExclusiveLite()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql()</a>, <a class="el" href="../../d4/d9/ke_8h.html#a360">KeTryToAcquireSpinLock()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02222">_MMWORKING_SET_EXPANSION_HEAD::ListHead</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00957">LOCK_EXPANSION</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00909">MI_SET_PFN_DELETED</a>, <a class="el" href="../../d7/d4/pfndec_8c-source.html#l00167">MiDecrementReferenceCount()</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l04726">MiEmptyWorkingSet()</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00521">MiRemovePageFromList()</a>, <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l02982">MiTrimAllPageFaultCount</a>, <a class="el" href="../../d6/d0/mminit_8c-source.html#l00157">MiTrimInProgressCount</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00099">MM_NO_WS_EXPANSION</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00952">MM_SET_EXPANSION_OWNER</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00100">MM_WS_EXPANSION_IN_PROGRESS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04905">MmExpansionLock</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00082">MmStandbyPageListHead</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00064">MmSystemCacheWs</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00996">MmSystemLockOwner</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04887">MmSystemWsLock</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05071">MmWorkingSetExpansionHead</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01297">_MMPFN::OriginalPte</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00059">_MMSUPPORT::PageFaultCount</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l01079">_MMPFNLIST::Total</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d3/d6/struct__MMSUPPORT.html#o15">_MMSUPPORT::u</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o10">_MMPFN::u2</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o15">_MMPFN::u3</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00961">UNLOCK_EXPANSION</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00065">_MMSUPPORT::WorkingSetExpansionLinks</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00061">_MMSUPPORT::WorkingSetSize</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01231">WSLE_NUMBER</a>, and <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00030">ZeroPte</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/verifier_8c-source.html#l02333">ViTrimAllSystemPagableMemory()</a>.
<p>
<pre class="fragment"><div>02992                    :
02993 
02994     This routine unmaps all pagable system memory.  This does not unmap user
02995     memory or locked down kernel memory.  Thus, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> memory being unmapped
02996     resides in paged <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a>, pagable kernel/driver code &amp; data, special <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a>
02997     and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system cache.
02998 
02999     Note that pages with a reference count greater than 1 are skipped (ie:
03000     they remain valid, as they are assumed to be locked down).  This prevents
03001     us from unmapping all of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system cache entries, etc.
03002 
03003     Non-locked down kernel stacks must be outpaged by modifying <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> balance
03004     set manager to operate in conjunction with a support routine.  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not
03005     done here.
03006 
03007 Arguments:
03008 
03009     PurgeTransition - Supplies whether to purge all <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> clean pages from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
03010                       transition list.
03011 
03012 Return Value:
03013 
03014     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> accomplished, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <span class="keywordflow">if</span> not.
03015 
03016 Environment:
03017 
03018     Kernel mode.  <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a> or below.
03019 
03020 --*/
03021 
03022 {
03023     KIRQL OldIrql;
03024     KIRQL OldIrql2;
03025     PLIST_ENTRY Next;
03026     <a class="code" href="../../d3/d6/struct__MMSUPPORT.html">PMMSUPPORT</a> VmSupport;
03027     <a class="code" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a> PagesInUse;
03028     PFN_NUMBER PageFrameIndex;
03029     LOGICAL LockAvailable;
03030     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
03031     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> CurrentThread;
03032     ULONG flags;
03033 
03034     <span class="comment">//</span>
03035     <span class="comment">// It's ok to check this without acquiring the system WS lock.</span>
03036     <span class="comment">//</span>
03037 
03038     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d0/wsmanage_8c.html#a31">MiTrimAllPageFaultCount</a> == <a class="code" href="../../d6/d8/sysinfo_8c.html#a21">MmSystemCacheWs</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o2">PageFaultCount</a>) {
03039         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03040     }
03041 
03042     <span class="comment">//</span>
03043     <span class="comment">// Working set mutexes will be acquired which require APC_LEVEL or below.</span>
03044     <span class="comment">//</span>
03045 
03046     <span class="keywordflow">if</span> (KeGetCurrentIrql() &gt; <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>) {
03047         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03048     }
03049 
03050     <span class="comment">//</span>
03051     <span class="comment">// Just return if it's too early during system initialization or if</span>
03052     <span class="comment">// another thread/processor is racing here to do the work for us.</span>
03053     <span class="comment">//</span>
03054 
03055     <span class="keywordflow">if</span> (InterlockedIncrement (&amp;MiTrimInProgressCount) &gt; 1) {
03056         InterlockedDecrement (&amp;MiTrimInProgressCount);
03057         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03058     }
03059 
03060 <span class="preprocessor">#if defined(_X86_)</span>
03061 <span class="preprocessor"></span>
03062     _asm {
03063         pushfd
03064         pop     flags
03065     }
03066 
03067     <span class="keywordflow">if</span> ((flags &amp; EFLAGS_INTERRUPT_MASK) == 0) {
03068         InterlockedDecrement (&amp;MiTrimInProgressCount);
03069         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03070     }
03071 
03072 <span class="preprocessor">#endif</span>
03073 <span class="preprocessor"></span>
03074     LockAvailable = <a class="code" href="../../d4/d9/ke_8h.html#a360">KeTryToAcquireSpinLock</a> (&amp;MmExpansionLock, &amp;OldIrql);
03075 
03076     <span class="keywordflow">if</span> (LockAvailable == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
03077         InterlockedDecrement (&amp;MiTrimInProgressCount);
03078         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03079     }
03080 
03081     <a class="code" href="../../d4/d8/mi_8h.html#a137">MM_SET_EXPANSION_OWNER</a> ();
03082 
03083     CurrentThread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
03084 
03085     <span class="comment">//</span>
03086     <span class="comment">// If the system cache resource is owned by this thread then don't bother</span>
03087     <span class="comment">// trying to trim now.  Note that checking the MmSystemLockOwner is not</span>
03088     <span class="comment">// sufficient as this flag is cleared just before actually releasing it.</span>
03089     <span class="comment">//</span>
03090 
03091     <span class="keywordflow">if</span> ((CurrentThread == <a class="code" href="../../d4/d8/mi_8h.html#a434">MmSystemLockOwner</a>) ||
03092         (<a class="code" href="../../d5/d8/ex_8h.html#a272">ExTryToAcquireResourceExclusiveLite</a>(&amp;MmSystemWsLock) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
03093         <a class="code" href="../../d4/d8/mi_8h.html#a140">UNLOCK_EXPANSION</a> (OldIrql);
03094         InterlockedDecrement (&amp;MiTrimInProgressCount);
03095         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03096     }
03097 
03098     Next = <a class="code" href="../../d4/d8/mi_8h.html#a710">MmWorkingSetExpansionHead</a>.<a class="code" href="../../d7/d7/struct__MMWORKING__SET__EXPANSION__HEAD.html#o0">ListHead</a>.Flink;
03099 
03100     <span class="keywordflow">while</span> (Next != &amp;<a class="code" href="../../d4/d8/mi_8h.html#a710">MmWorkingSetExpansionHead</a>.<a class="code" href="../../d7/d7/struct__MMWORKING__SET__EXPANSION__HEAD.html#o0">ListHead</a>) {
03101         <span class="keywordflow">if</span> (Next == &amp;<a class="code" href="../../d6/d8/sysinfo_8c.html#a21">MmSystemCacheWs</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>) {
03102             <span class="keywordflow">break</span>;
03103         }
03104         Next = Next-&gt;Flink;
03105     }
03106 
03107     <span class="keywordflow">if</span> (Next != &amp;<a class="code" href="../../d6/d8/sysinfo_8c.html#a21">MmSystemCacheWs</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>) {
03108         <a class="code" href="../../d5/d8/ex_8h.html#a273">ExReleaseResourceLite</a>(&amp;MmSystemWsLock);
03109         <a class="code" href="../../d4/d8/mi_8h.html#a140">UNLOCK_EXPANSION</a> (OldIrql);
03110         InterlockedDecrement (&amp;MiTrimInProgressCount);
03111         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03112     }
03113 
03114     RemoveEntryList (Next);
03115 
03116     VmSupport = &amp;<a class="code" href="../../d6/d8/sysinfo_8c.html#a21">MmSystemCacheWs</a>;
03117     VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>.Flink = <a class="code" href="../../d4/d8/mi_8h.html#a20">MM_NO_WS_EXPANSION</a>;
03118     VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>.Blink = <a class="code" href="../../d4/d8/mi_8h.html#a21">MM_WS_EXPANSION_IN_PROGRESS</a>;
03119     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.BeingTrimmed == 0);
03120     VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.BeingTrimmed = 1;
03121 
03122     <a class="code" href="../../d5/d0/wsmanage_8c.html#a31">MiTrimAllPageFaultCount</a> = VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o2">PageFaultCount</a>;
03123 
03124     PagesInUse = VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o4">WorkingSetSize</a>;
03125 
03126     <span class="comment">//</span>
03127     <span class="comment">// There are 2 issues here that are carefully dealt with :</span>
03128     <span class="comment">//</span>
03129     <span class="comment">// 1.  APCs must be disabled while any resources are held to prevent</span>
03130     <span class="comment">//     suspend APCs from deadlocking the system.</span>
03131     <span class="comment">// 2.  Once the system cache has been marked MM_WS_EXPANSION_IN_PROGRESS,</span>
03132     <span class="comment">//     either the thread must not be preempted or the system cache working</span>
03133     <span class="comment">//     set lock must be held throughout.  Otherwise a high priority thread</span>
03134     <span class="comment">//     can fault on a system code and data address and the two pages will</span>
03135     <span class="comment">//     thrash forever (at high priority) because no system working set</span>
03136     <span class="comment">//     expansion is allowed while MM_WS_EXPANSION_IN_PROGRESS is set.</span>
03137     <span class="comment">//     The decision was to hold the system working set lock throughout.</span>
03138     <span class="comment">//</span>
03139 
03140     <a class="code" href="../../d4/d8/mi_8h.html#a434">MmSystemLockOwner</a> = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a> ();
03141 
03142     <a class="code" href="../../d4/d8/mi_8h.html#a140">UNLOCK_EXPANSION</a> (APC_LEVEL);
03143 
03144     <a class="code" href="../../d4/d0/wslist_8c.html#a35">MiEmptyWorkingSet</a> (VmSupport, FALSE);
03145 
03146     <a class="code" href="../../d4/d8/mi_8h.html#a139">LOCK_EXPANSION</a> (OldIrql2);
03147     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (OldIrql2 == APC_LEVEL);
03148 
03149     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>.Flink == MM_NO_WS_EXPANSION);
03150 
03151     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.BeingTrimmed == 1);
03152     VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.BeingTrimmed = 0;
03153 
03154     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>.Blink ==
03155                                         MM_WS_EXPANSION_IN_PROGRESS);
03156 
03157     InsertTailList (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a710">MmWorkingSetExpansionHead</a>.<a class="code" href="../../d7/d7/struct__MMWORKING__SET__EXPANSION__HEAD.html#o0">ListHead</a>,
03158                     &amp;VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>);
03159 
03160     <a class="code" href="../../d4/d8/mi_8h.html#a140">UNLOCK_EXPANSION</a> (APC_LEVEL);
03161 
03162     <span class="comment">//</span>
03163     <span class="comment">// Since MiEmptyWorkingSet will attempt to recursively acquire and release</span>
03164     <span class="comment">// the MmSystemWsLock, the MmSystemLockOwner field may get cleared.</span>
03165     <span class="comment">// This means here the resource must be explicitly released instead of</span>
03166     <span class="comment">// using UNLOCK_SYSTEM_WS.</span>
03167     <span class="comment">//</span>
03168 
03169     <a class="code" href="../../d4/d8/mi_8h.html#a434">MmSystemLockOwner</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03170     <a class="code" href="../../d5/d8/ex_8h.html#a273">ExReleaseResourceLite</a> (&amp;MmSystemWsLock);
03171     <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a> (OldIrql);
03172     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (KeGetCurrentIrql() &lt;= APC_LEVEL);
03173 
03174     <span class="keywordflow">if</span> (PurgeTransition == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
03175 
03176         <span class="comment">//</span>
03177         <span class="comment">// Run the transition list and free all the entries so transition</span>
03178         <span class="comment">// faults are not satisfied for any of the non modified pages that were</span>
03179         <span class="comment">// freed.</span>
03180         <span class="comment">//</span>
03181     
03182         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
03183     
03184         <span class="keywordflow">while</span> (<a class="code" href="../../d8/d5/kddata_8c.html#a38">MmStandbyPageListHead</a>.<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o0">Total</a> != 0) {
03185     
03186             PageFrameIndex = <a class="code" href="../../d7/d5/pfnlist_8c.html#a10">MiRemovePageFromList</a> (&amp;MmStandbyPageListHead);
03187     
03188             Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
03189     
03190             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount == 0);
03191             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 0);
03192     
03193             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount += 1;
03194             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a> = <a class="code" href="../../d4/d2/datalpha_8c.html#a0">ZeroPte</a>;
03195             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.Modified = 0;
03196             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a120">MI_SET_PFN_DELETED</a> (Pfn1);
03197         
03198             <a class="code" href="../../d6/d5/pfndec_8c.html#a2">MiDecrementReferenceCount</a> (PageFrameIndex);
03199         }
03200     
03201         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
03202     }
03203     
03204     InterlockedDecrement (&amp;MiTrimInProgressCount);
03205 
03206     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03207 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a41" doxytag="wsmanage.c::MmWorkingSetManager" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MmWorkingSetManager           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00397">397</a> of file <a class="el" href="../../d6/d9/wsmanage_8c-source.html">wsmanage.c</a>.
<p>
References <a class="el" href="../../d2/d8/ps_8h-source.html#l00216">_EPROCESS::AddressSpaceDeleted</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00066">_MMSUPPORT::AllowWorkingSetAdjustment</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00086">APC_LEVEL</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00191">_MMWS_TRIM_CRITERIA::DesiredFreeGoal</a>, <a class="el" href="../../d9/d7/ex_2resource_8c-source.html#l00598">ExTryToAcquireResourceExclusiveLite()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d8/d7/union__MMWS__TRIM__CRITERIA.html#o6">_MMWS_TRIM_CRITERIA::FaultBased</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00273">_EPROCESS::ImageFileName</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00140">KeDelayExecutionThread()</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00405">KeDetachProcess()</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00228">KeForceAttachProcess()</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql()</a>, <a class="el" href="../../d8/d9/ke_2miscc_8c-source.html#l00153">KeQuerySystemTime()</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d3/d7/eventobj_8c-source.html#l00343">KeSetEvent()</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00058">_MMSUPPORT::LastTrimFaultCount</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00057">_MMSUPPORT::LastTrimTime</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02222">_MMWORKING_SET_EXPANSION_HEAD::ListHead</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00957">LOCK_EXPANSION</a>, <a class="el" href="../../d4/d6/session_8c-source.html#l01181">MiAttachSession()</a>, <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00996">MiCheckAndSetSystemTrimCriteria()</a>, <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00163">MiCheckCounter</a>, <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l01372">MiCheckProcessTrimCriteria()</a>, <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l01591">MiCheckSystemCacheWsTrimCriteria()</a>, <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l01218">MiCheckSystemTrimEndCriteria()</a>, <a class="el" href="../../d4/d6/session_8c-source.html#l01253">MiDetachSession()</a>, <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l01644">MiDetermineWsTrimAmount()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04438">MiHydra</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00062">_MMSUPPORT::MinimumWorkingSetSize</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l03612">MiTrimWorkingSet()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00168">MM_DBG_WS_EXPANSION</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00117">MM_FORCE_TRIM</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00099">MM_NO_WS_EXPANSION</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05677">MM_SET_SESSION_RESOURCE_OWNER</a>, <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00101">MM_TRIM_COUNTER_MAXIMUM_LARGE_MEM</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00100">MM_WS_EXPANSION_IN_PROGRESS</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00134">MmAvailablePages</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l03883">MmIsAddressValid()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05118">MmMinimumFreePages</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l01087">MmModifiedPageListHead</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05122">MmModifiedPageMaximum</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05096">MmModifiedPageWriterEvent</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05609">MmSessionSpace</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00215">MmShortTime</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04752">MmSystemCacheWorkingSetList</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00064">MmSystemCacheWs</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00996">MmSystemLockOwner</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04887">MmSystemWsLock</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05071">MmWorkingSetExpansionHead</a>, <a class="el" href="../../d1/d8/miglobal_8c-source.html#l00442">MmWorkingSetList</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00059">_MMSUPPORT::PageFaultCount</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00166">_EPROCESS::Pcb</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l02219">PERFINFO_WSMANAGE_ACTUALTRIM</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l02220">PERFINFO_WSMANAGE_DECL</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l02225">PERFINFO_WSMANAGE_FINALACTION</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l02230">PERFINFO_WSMANAGE_PROCESS_RESET</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l02234">PERFINFO_WSMANAGE_TOTRIM</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l02236">PERFINFO_WSMANAGE_TRIMEND_CLAIMS</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l02237">PERFINFO_WSMANAGE_TRIMEND_FAULTS</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l02238">PERFINFO_WSMANAGE_TRIMWS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05524">_MM_SESSION_SPACE::ProcessOutSwapCount</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00213">_EPROCESS::ProcessOutswapEnabled</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00214">_EPROCESS::ProcessOutswapped</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01598">_MMWSL::Quota</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05416">_MM_SESSION_SPACE::SessionId</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l01079">_MMPFNLIST::Total</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d3/d6/struct__MMSUPPORT.html#o15">_MMSUPPORT::u</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00961">UNLOCK_EXPANSION</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05694">UNLOCK_SESSION_SPACE_WS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01005">UNLOCK_SYSTEM_WS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01081">UNLOCK_WS</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00196">_EPROCESS::Vm</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00064">_MMSUPPORT::VmWorkingSetList</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00065">_MMSUPPORT::WorkingSetExpansionLinks</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00211">_EPROCESS::WorkingSetLock</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00061">_MMSUPPORT::WorkingSetSize</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l05559">_MM_SESSION_SPACE::WsLock</a>.
<p>
Referenced by <a class="el" href="../../d0/d0/balmgr_8c-source.html#l00142">KeBalanceSetManager()</a>.
<p>
<pre class="fragment"><div>00403                    :
00404 
00405     Implements <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> NT working set manager thread.  When <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number
00406     of free pages becomes critical and ample pages can be obtained by
00407     reducing working sets, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> working set manager's event <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> set, and
00408     <span class="keyword">this</span> thread becomes active.
00409 
00410 Arguments:
00411 
00412     None.
00413 
00414 Return Value:
00415 
00416     None.
00417 
00418 Environment:
00419 
00420     Kernel mode.
00421 
00422 --*/
00423 
00424 {
00425 
00426     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> CurrentProcess;
00427     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> ProcessToTrim;
00428     PLIST_ENTRY ListEntry;
00429     LOGICAL Attached;
00430     ULONG Trim;
00431     KIRQL OldIrql;
00432     <a class="code" href="../../d3/d6/struct__MMSUPPORT.html">PMMSUPPORT</a> VmSupport;
00433     <a class="code" href="../../d0/d8/struct__MMWSL.html">PMMWSL</a> WorkingSetList;
00434     LARGE_INTEGER CurrentTime;
00435     ULONG count;
00436     LOGICAL DoTrimming;
00437     <a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html">PMM_SESSION_SPACE</a> SessionSpace;
00438     LOGICAL InformSessionOfRelease;
00439 <span class="preprocessor">#if DBG</span>
00440 <span class="preprocessor"></span>    ULONG LastTrimFaultCount;
00441 <span class="preprocessor">#endif // DBG</span>
00442 <span class="preprocessor"></span>    <a class="code" href="../../d8/d7/union__MMWS__TRIM__CRITERIA.html">MMWS_TRIM_CRITERIA</a> TrimCriteria;
00443     <a class="code" href="../../d2/d1/mm_8h.html#a99">PERFINFO_WSMANAGE_DECL</a>();
00444 
00445 <span class="preprocessor">#if DBG</span>
00446 <span class="preprocessor"></span>    MmWorkingSetThread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a> ();
00447 <span class="preprocessor">#endif</span>
00448 <span class="preprocessor"></span>
00449     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (MiHydra == FALSE || MmIsAddressValid (MmSessionSpace) == FALSE);
00450 
00451     CurrentProcess = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a> ();
00452 
00453     Trim = 0;
00454 
00455     <span class="comment">//</span>
00456     <span class="comment">// Set the trim criteria: If there are plenty of pages, the existing</span>
00457     <span class="comment">// sets are aged and FALSE is returned to signify no trim is necessary.</span>
00458     <span class="comment">// Otherwise, the working set expansion list is ordered so the best</span>
00459     <span class="comment">// candidates for trimming are placed at the front and TRUE is returned.</span>
00460     <span class="comment">//</span>
00461 
00462     DoTrimming = <a class="code" href="../../d5/d0/wsmanage_8c.html#a42">MiCheckAndSetSystemTrimCriteria</a>(&amp;TrimCriteria);
00463 
00464     <span class="keywordflow">if</span> (DoTrimming) {
00465  
00466         Attached = 0;
00467 
00468         <a class="code" href="../../d7/d0/ke_2miscc_8c.html#a3">KeQuerySystemTime</a> (&amp;CurrentTime);
00469 
00470         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (MiHydra == FALSE || MmIsAddressValid (MmSessionSpace) == FALSE);
00471 
00472         <a class="code" href="../../d4/d8/mi_8h.html#a139">LOCK_EXPANSION</a> (OldIrql);
00473         <span class="keywordflow">while</span> (!IsListEmpty (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a710">MmWorkingSetExpansionHead</a>.<a class="code" href="../../d7/d7/struct__MMWORKING__SET__EXPANSION__HEAD.html#o0">ListHead</a>)) {
00474 
00475             <span class="comment">//</span>
00476             <span class="comment">// Remove the entry at the head and trim it.</span>
00477             <span class="comment">//</span>
00478 
00479             ListEntry = RemoveHeadList (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a710">MmWorkingSetExpansionHead</a>.<a class="code" href="../../d7/d7/struct__MMWORKING__SET__EXPANSION__HEAD.html#o0">ListHead</a>);
00480 
00481             <span class="keywordflow">if</span> (ListEntry == &amp;<a class="code" href="../../d6/d8/sysinfo_8c.html#a21">MmSystemCacheWs</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>) {
00482                 VmSupport = &amp;<a class="code" href="../../d6/d8/sysinfo_8c.html#a21">MmSystemCacheWs</a>;
00483                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.SessionSpace == 0);
00484                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.TrimHard == 0);
00485                 SessionSpace = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00486             }
00487             <span class="keywordflow">else</span> {
00488                 VmSupport = CONTAINING_RECORD(ListEntry,
00489                                               <a class="code" href="../../d3/d6/struct__MMSUPPORT.html">MMSUPPORT</a>,
00490                                               WorkingSetExpansionLinks);
00491 
00492                 <span class="keywordflow">if</span> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.SessionSpace == 0) {
00493                     ProcessToTrim = CONTAINING_RECORD(VmSupport,
00494                                                       <a class="code" href="../../d0/d4/struct__EPROCESS.html">EPROCESS</a>,
00495                                                       Vm);
00496 
00497                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (VmSupport == &amp;ProcessToTrim-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>);
00498                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ProcessToTrim-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o27">AddressSpaceDeleted</a> == 0);
00499                     SessionSpace = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00500                 }
00501                 <span class="keywordflow">else</span> {
00502                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (MiHydra == TRUE);
00503                     SessionSpace = CONTAINING_RECORD(VmSupport,
00504                                                      <a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html">MM_SESSION_SPACE</a>,
00505                                                      Vm);
00506                 }
00507             }
00508 
00509             <span class="comment">//</span>
00510             <span class="comment">// Note that other routines that set this bit must remove the</span>
00511             <span class="comment">// entry from the expansion list first.</span>
00512             <span class="comment">//</span>
00513 
00514             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.BeingTrimmed == 0);
00515 
00516             <span class="comment">//</span>
00517             <span class="comment">// Check to see if we've been here before.</span>
00518             <span class="comment">//</span>
00519 
00520             <span class="keywordflow">if</span> ((*(PLARGE_INTEGER)&amp;VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o0">LastTrimTime</a>).QuadPart ==
00521                        (*(PLARGE_INTEGER)&amp;CurrentTime).QuadPart) {
00522 
00523                 InsertHeadList (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a710">MmWorkingSetExpansionHead</a>.<a class="code" href="../../d7/d7/struct__MMWORKING__SET__EXPANSION__HEAD.html#o0">ListHead</a>,
00524                             &amp;VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>);
00525 
00526                 <span class="comment">//</span>
00527                 <span class="comment">// If we aren't finished we may sleep in this call.</span>
00528                 <span class="comment">//</span>
00529 
00530                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d0/wsmanage_8c.html#a43">MiCheckSystemTrimEndCriteria</a>(&amp;TrimCriteria, OldIrql)) {
00531 
00532                     <span class="comment">//</span>
00533                     <span class="comment">// No more pages are needed so we're done.</span>
00534                     <span class="comment">//</span>
00535 
00536                     <span class="keywordflow">break</span>;
00537                 }
00538 
00539                 <span class="comment">//</span>
00540                 <span class="comment">// Start a new round of trimming.</span>
00541                 <span class="comment">//</span>
00542 
00543                 <a class="code" href="../../d7/d0/ke_2miscc_8c.html#a3">KeQuerySystemTime</a> (&amp;CurrentTime);
00544 
00545                 <span class="keywordflow">continue</span>;
00546             }
00547 
00548             <a class="code" href="../../d2/d1/mm_8h.html#a117">PERFINFO_WSMANAGE_TRIMWS</a>(ProcessToTrim, SessionSpace, VmSupport);
00549 
00550             <span class="keywordflow">if</span> (SessionSpace) {
00551 
00552                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d0/wsmanage_8c.html#a44">MiCheckProcessTrimCriteria</a>(&amp;TrimCriteria,
00553                                                 VmSupport,
00554                                                 NULL,
00555                                                 &amp;CurrentTime) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00556 
00557                     InsertTailList (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a710">MmWorkingSetExpansionHead</a>.<a class="code" href="../../d7/d7/struct__MMWORKING__SET__EXPANSION__HEAD.html#o0">ListHead</a>,
00558                                     &amp;VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>);
00559                     <span class="keywordflow">continue</span>;
00560                 }
00561 
00562                 VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o0">LastTrimTime</a> = CurrentTime;
00563                 VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.BeingTrimmed = 1;
00564 
00565                 VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>.Flink = <a class="code" href="../../d4/d8/mi_8h.html#a20">MM_NO_WS_EXPANSION</a>;
00566                 VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>.Blink =
00567                                                     <a class="code" href="../../d4/d8/mi_8h.html#a21">MM_WS_EXPANSION_IN_PROGRESS</a>;
00568                 <a class="code" href="../../d4/d8/mi_8h.html#a140">UNLOCK_EXPANSION</a> (OldIrql);
00569 
00570                 ProcessToTrim = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00571 
00572                 <span class="comment">//</span>
00573                 <span class="comment">// Attach directly to the session space to be trimmed.</span>
00574                 <span class="comment">//</span>
00575 
00576                 <a class="code" href="../../d3/d7/session_8c.html#a16">MiAttachSession</a> (SessionSpace);
00577 
00578                 <span class="comment">//</span>
00579                 <span class="comment">// Try for the session working set lock.</span>
00580                 <span class="comment">//</span>
00581 
00582                 WorkingSetList = VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o7">VmWorkingSetList</a>;
00583 
00584                 <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a> (APC_LEVEL, &amp;OldIrql);
00585 
00586                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d8/ex_8h.html#a272">ExTryToAcquireResourceExclusiveLite</a> (&amp;SessionSpace-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o32">WsLock</a>)) {
00587                     <span class="comment">//</span>
00588                     <span class="comment">// This session space's working set lock was not</span>
00589                     <span class="comment">// granted, don't trim it.</span>
00590                     <span class="comment">//</span>
00591 
00592                     <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a> (OldIrql);
00593 
00594                     <a class="code" href="../../d3/d7/session_8c.html#a17">MiDetachSession</a> ();
00595 
00596                     <a class="code" href="../../d4/d8/mi_8h.html#a139">LOCK_EXPANSION</a> (OldIrql);
00597 
00598                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.BeingTrimmed == 1);
00599 
00600                     VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.BeingTrimmed = 0;
00601 
00602                     VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o9">AllowWorkingSetAdjustment</a> = <a class="code" href="../../d4/d8/mi_8h.html#a31">MM_FORCE_TRIM</a>;
00603 
00604                     <span class="keywordflow">goto</span> WorkingSetLockFailed;
00605                 }
00606 
00607                 VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o1">LastTrimFaultCount</a> = VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o2">PageFaultCount</a>;
00608 
00609                 <a class="code" href="../../d4/d8/mi_8h.html#a404">MM_SET_SESSION_RESOURCE_OWNER</a>();
00610                 <a class="code" href="../../d2/d1/mm_8h.html#a108">PERFINFO_WSMANAGE_PROCESS_RESET</a>(VmSupport);
00611             }
00612             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (VmSupport != &amp;<a class="code" href="../../d6/d8/sysinfo_8c.html#a21">MmSystemCacheWs</a>) {
00613 
00614                 <span class="comment">//</span>
00615                 <span class="comment">// Check to see if this is a forced trim or</span>
00616                 <span class="comment">// if we are trimming because check counter is</span>
00617                 <span class="comment">// at the maximum.</span>
00618                 <span class="comment">//</span>
00619 
00620                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d0/wsmanage_8c.html#a44">MiCheckProcessTrimCriteria</a>(&amp;TrimCriteria,
00621                                                 VmSupport,
00622                                                 ProcessToTrim,
00623                                                 &amp;CurrentTime) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00624 
00625                     InsertTailList (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a710">MmWorkingSetExpansionHead</a>.<a class="code" href="../../d7/d7/struct__MMWORKING__SET__EXPANSION__HEAD.html#o0">ListHead</a>,
00626                                     &amp;VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>);
00627                     <span class="keywordflow">continue</span>;
00628                 }
00629 
00630                 VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o0">LastTrimTime</a> = CurrentTime;
00631                 VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.BeingTrimmed = 1;
00632 
00633                 VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>.Flink = <a class="code" href="../../d4/d8/mi_8h.html#a20">MM_NO_WS_EXPANSION</a>;
00634                 VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>.Blink =
00635                                                     <a class="code" href="../../d4/d8/mi_8h.html#a21">MM_WS_EXPANSION_IN_PROGRESS</a>;
00636                 <a class="code" href="../../d4/d8/mi_8h.html#a140">UNLOCK_EXPANSION</a> (OldIrql);
00637                 WorkingSetList = <a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>;
00638                 InformSessionOfRelease = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00639 
00640                 <span class="comment">//</span>
00641                 <span class="comment">// Attach to the process in preparation for trimming.</span>
00642                 <span class="comment">//</span>
00643 
00644                 <span class="keywordflow">if</span> (ProcessToTrim != CurrentProcess) {
00645 
00646                     Attached = <a class="code" href="../../d3/d5/procobj_8c.html#a5">KeForceAttachProcess</a> (&amp;ProcessToTrim-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>);
00647 
00648                     <span class="keywordflow">if</span> (Attached == 0) {
00649                         <a class="code" href="../../d4/d8/mi_8h.html#a139">LOCK_EXPANSION</a> (OldIrql);
00650                         VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.BeingTrimmed = 0;
00651                         VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o9">AllowWorkingSetAdjustment</a> = <a class="code" href="../../d4/d8/mi_8h.html#a31">MM_FORCE_TRIM</a>;
00652                         <span class="keywordflow">goto</span> WorkingSetLockFailed;
00653                     }
00654                     <span class="keywordflow">if</span> (ProcessToTrim-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o24">ProcessOutswapEnabled</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00655                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ProcessToTrim-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o25">ProcessOutswapped</a> == FALSE);
00656                         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a581">MiHydra</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> &amp;&amp; VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.ProcessInSession == 1 &amp;&amp; VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.SessionLeader == 0) {
00657                             InformSessionOfRelease = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00658                         }
00659                     }
00660                 }
00661 
00662                 <span class="comment">//</span>
00663                 <span class="comment">// Attempt to acquire the working set lock. If the</span>
00664                 <span class="comment">// lock cannot be acquired, skip over this process.</span>
00665                 <span class="comment">//</span>
00666 
00667                 count = 0;
00668                 <span class="keywordflow">do</span> {
00669                     <span class="keywordflow">if</span> (ExTryToAcquireFastMutex(&amp;ProcessToTrim-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o22">WorkingSetLock</a>) != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00670                         <span class="keywordflow">break</span>;
00671                     }
00672                     <a class="code" href="../../d1/d7/wait_8c.html#a2">KeDelayExecutionThread</a> (KernelMode, FALSE, &amp;MmShortTime);
00673                     count += 1;
00674                     <span class="keywordflow">if</span> (count == 5) {
00675 
00676                         <span class="comment">//</span>
00677                         <span class="comment">// Could not get the lock, skip this process.</span>
00678                         <span class="comment">//</span>
00679 
00680                         <span class="keywordflow">if</span> (InformSessionOfRelease == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00681                             <a class="code" href="../../d4/d8/mi_8h.html#a139">LOCK_EXPANSION</a> (OldIrql);
00682                             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ProcessToTrim-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o24">ProcessOutswapEnabled</a> == TRUE);
00683                             ProcessToTrim-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o24">ProcessOutswapEnabled</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00684                             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o23">ProcessOutSwapCount</a> &gt;= 1);
00685                             <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o23">ProcessOutSwapCount</a> -= 1;
00686                             <a class="code" href="../../d4/d8/mi_8h.html#a140">UNLOCK_EXPANSION</a> (OldIrql);
00687                             InformSessionOfRelease = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00688                         }
00689 
00690                         <span class="keywordflow">if</span> (Attached) {
00691                             <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a> ();
00692                             Attached = 0;
00693                         }
00694 
00695                         <a class="code" href="../../d4/d8/mi_8h.html#a139">LOCK_EXPANSION</a> (OldIrql);
00696                         VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.BeingTrimmed = 0;
00697                         VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o9">AllowWorkingSetAdjustment</a> = <a class="code" href="../../d4/d8/mi_8h.html#a31">MM_FORCE_TRIM</a>;
00698                         <span class="keywordflow">goto</span> WorkingSetLockFailed;
00699                     }
00700                 } <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00701 
00702                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.BeingTrimmed == 1);
00703 
00704 <span class="preprocessor">#if DBG</span>
00705 <span class="preprocessor"></span>                LastTrimFaultCount = VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o1">LastTrimFaultCount</a>;
00706 <span class="preprocessor">#endif // DBG</span>
00707 <span class="preprocessor"></span>                VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o1">LastTrimFaultCount</a> = VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o2">PageFaultCount</a>;
00708 
00709                 <a class="code" href="../../d2/d1/mm_8h.html#a108">PERFINFO_WSMANAGE_PROCESS_RESET</a>(VmSupport);
00710             }
00711             <span class="keywordflow">else</span> {
00712 
00713                 <span class="comment">//</span>
00714                 <span class="comment">// System cache,</span>
00715                 <span class="comment">//</span>
00716 
00717 <span class="preprocessor">#if DBG</span>
00718 <span class="preprocessor"></span>                LastTrimFaultCount = VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o1">LastTrimFaultCount</a>;
00719 <span class="preprocessor">#endif // DBG</span>
00720 <span class="preprocessor"></span>
00721                 <a class="code" href="../../d2/d1/mm_8h.html#a108">PERFINFO_WSMANAGE_PROCESS_RESET</a>(VmSupport);
00722 
00723                 <span class="comment">//</span>
00724                 <span class="comment">// Always try to trim the system cache when using claims.</span>
00725                 <span class="comment">// Fault-based trimming might skip it from time to time.</span>
00726                 <span class="comment">//</span>
00727 
00728 <span class="preprocessor">#ifndef _MI_USE_CLAIMS_</span>
00729 <span class="preprocessor"></span>
00730                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d0/wsmanage_8c.html#a45">MiCheckSystemCacheWsTrimCriteria</a>(VmSupport)) {
00731 
00732                     <span class="comment">//</span>
00733                     <span class="comment">// Don't trim the system cache.</span>
00734                     <span class="comment">//</span>
00735 
00736                     InsertTailList (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a710">MmWorkingSetExpansionHead</a>.<a class="code" href="../../d7/d7/struct__MMWORKING__SET__EXPANSION__HEAD.html#o0">ListHead</a>,
00737                                         &amp;VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>);
00738                     <span class="keywordflow">continue</span>;
00739                 }
00740 <span class="preprocessor">#endif</span>
00741 <span class="preprocessor"></span>
00742                 VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o0">LastTrimTime</a> = CurrentTime;
00743 
00744                 <span class="comment">//</span>
00745                 <span class="comment">// Indicate that this working set is being trimmed.</span>
00746                 <span class="comment">//</span>
00747 
00748                 VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.BeingTrimmed = 1;
00749 
00750                 <a class="code" href="../../d4/d8/mi_8h.html#a140">UNLOCK_EXPANSION</a> (OldIrql);
00751 
00752                 ProcessToTrim = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00753                 WorkingSetList = <a class="code" href="../../d4/d8/mi_8h.html#a657">MmSystemCacheWorkingSetList</a>;
00754 
00755                 <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a> (APC_LEVEL, &amp;OldIrql);
00756                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d8/ex_8h.html#a272">ExTryToAcquireResourceExclusiveLite</a> (&amp;MmSystemWsLock)) {
00757 
00758                     <span class="comment">//</span>
00759                     <span class="comment">// System working set lock was not granted, don't trim</span>
00760                     <span class="comment">// the system cache.</span>
00761                     <span class="comment">//</span>
00762 
00763                     <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a> (OldIrql);
00764                     <a class="code" href="../../d4/d8/mi_8h.html#a139">LOCK_EXPANSION</a> (OldIrql);
00765                     VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.BeingTrimmed = 0;
00766                     InsertTailList (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a710">MmWorkingSetExpansionHead</a>.<a class="code" href="../../d7/d7/struct__MMWORKING__SET__EXPANSION__HEAD.html#o0">ListHead</a>,
00767                                     &amp;VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>);
00768                     <span class="keywordflow">continue</span>;
00769                 }
00770 
00771                 <a class="code" href="../../d4/d8/mi_8h.html#a434">MmSystemLockOwner</a> = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
00772 
00773                 VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o1">LastTrimFaultCount</a> = VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o2">PageFaultCount</a>;
00774 
00775                 VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>.Flink = <a class="code" href="../../d4/d8/mi_8h.html#a20">MM_NO_WS_EXPANSION</a>;
00776                 VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>.Blink =
00777                                                     <a class="code" href="../../d4/d8/mi_8h.html#a21">MM_WS_EXPANSION_IN_PROGRESS</a>;
00778             }
00779 
00780             <span class="comment">//</span>
00781             <span class="comment">// Determine how many pages we want to trim from this working set.</span>
00782             <span class="comment">//</span>
00783 
00784             Trim = <a class="code" href="../../d5/d0/wsmanage_8c.html#a46">MiDetermineWsTrimAmount</a>(&amp;TrimCriteria,
00785                                            VmSupport,
00786                                            ProcessToTrim
00787                                            );
00788 
00789 <span class="preprocessor">#if DBG</span>
00790 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a60">MM_DBG_WS_EXPANSION</a>) {
00791                 <span class="keywordflow">if</span> (Trim) {
00792                   <span class="keywordflow">if</span> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.SessionSpace == 0) {
00793                       <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"           Trimming        Process %16s %5d Faults, WS %6d, Trimming %5d ==&gt; %5d\n"</span>,
00794                         ProcessToTrim ? ProcessToTrim-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o65">ImageFileName</a> : (PUCHAR)<span class="stringliteral">"System Cache"</span>,
00795                         VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o2">PageFaultCount</a> - LastTrimFaultCount,
00796                         VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o4">WorkingSetSize</a>,
00797                         Trim,
00798                         VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o4">WorkingSetSize</a>-Trim
00799                         );
00800                   }
00801                   <span class="keywordflow">else</span> {
00802                       <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"           Trimming        Session 0x%x (id %d) %5d Faults, WS %6d, Trimming %5d ==&gt; %5d\n"</span>,
00803                         SessionSpace,
00804                         SessionSpace-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o4">SessionId</a>,
00805                         VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o2">PageFaultCount</a> - LastTrimFaultCount,
00806                         VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o4">WorkingSetSize</a>,
00807                         Trim,
00808                         VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o4">WorkingSetSize</a>-Trim
00809                         );
00810                   }
00811                 }
00812             }
00813 <span class="preprocessor">#endif //DBG</span>
00814 <span class="preprocessor"></span>
00815 <span class="preprocessor">#ifdef _MI_USE_CLAIMS_</span>
00816 <span class="preprocessor"></span>
00817             <span class="comment">//</span>
00818             <span class="comment">// If there's something to trim...</span>
00819             <span class="comment">//</span>
00820 
00821             <span class="keywordflow">if</span> (Trim != 0 &amp;&amp;
00822                 (<a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> &lt; TrimCriteria.ClaimBased.<a class="code" href="../../d8/d7/union__MMWS__TRIM__CRITERIA.html#o1">DesiredFreeGoal</a>)) {
00823 
00824                 <span class="comment">//</span>
00825                 <span class="comment">// We haven't reached our goal, so trim now.</span>
00826                 <span class="comment">//</span>
00827 
00828                 <a class="code" href="../../d2/d1/mm_8h.html#a113">PERFINFO_WSMANAGE_TOTRIM</a>(Trim);
00829 
00830                 Trim = <a class="code" href="../../d4/d0/wslist_8c.html#a34">MiTrimWorkingSet</a> (Trim,
00831                                          VmSupport,
00832                                          TrimCriteria.ClaimBased.TrimAge
00833                                          );
00834 
00835                 <a class="code" href="../../d2/d1/mm_8h.html#a98">PERFINFO_WSMANAGE_ACTUALTRIM</a>(Trim);
00836             }
00837 
00838             <span class="comment">//</span>
00839             <span class="comment">// Estimating the current claim is always done here by taking a</span>
00840             <span class="comment">// sample of the working set.  Aging is only done if the trim</span>
00841             <span class="comment">// pass warrants it (ie: the first pass only).</span>
00842             <span class="comment">//</span>
00843 
00844             MiAgeAndEstimateAvailableInWorkingSet(
00845                                 VmSupport,
00846                                 TrimCriteria.ClaimBased.DoAging,
00847                                 &amp;TrimCriteria.ClaimBased.NewTotalClaim,
00848                                 &amp;TrimCriteria.ClaimBased.NewTotalEstimatedAvailable
00849                                 );
00850 <span class="preprocessor">#else</span>
00851 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (Trim != 0) {
00852 
00853                 <a class="code" href="../../d2/d1/mm_8h.html#a113">PERFINFO_WSMANAGE_TOTRIM</a>(Trim);
00854 
00855                 Trim = <a class="code" href="../../d4/d0/wslist_8c.html#a34">MiTrimWorkingSet</a> (
00856                             Trim,
00857                             VmSupport,
00858                             (BOOLEAN)(MiCheckCounter &lt; MM_TRIM_COUNTER_MAXIMUM_LARGE_MEM)
00859                             );
00860 
00861                 <a class="code" href="../../d2/d1/mm_8h.html#a98">PERFINFO_WSMANAGE_ACTUALTRIM</a>(Trim);
00862             }
00863 <span class="preprocessor">#endif</span>
00864 <span class="preprocessor"></span>
00865             <span class="comment">//</span>
00866             <span class="comment">// Set the quota to the current size.</span>
00867             <span class="comment">//</span>
00868 
00869             WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o0">Quota</a> = VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o4">WorkingSetSize</a>;
00870             <span class="keywordflow">if</span> (WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o0">Quota</a> &lt; VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o5">MinimumWorkingSetSize</a>) {
00871                 WorkingSetList-&gt;<a class="code" href="../../d0/d8/struct__MMWSL.html#o0">Quota</a> = VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o5">MinimumWorkingSetSize</a>;
00872             }
00873 
00874             <span class="keywordflow">if</span> (SessionSpace) {
00875 
00876                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.SessionSpace == 1);
00877 
00878                 <a class="code" href="../../d4/d8/mi_8h.html#a408">UNLOCK_SESSION_SPACE_WS</a> (OldIrql);
00879 
00880                 <a class="code" href="../../d3/d7/session_8c.html#a17">MiDetachSession</a> ();
00881             }
00882             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (VmSupport != &amp;<a class="code" href="../../d6/d8/sysinfo_8c.html#a21">MmSystemCacheWs</a>) {
00883 
00884                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.SessionSpace == 0);
00885                 <a class="code" href="../../d4/d8/mi_8h.html#a158">UNLOCK_WS</a> (ProcessToTrim);
00886 
00887                 <span class="keywordflow">if</span> (InformSessionOfRelease == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00888                     <a class="code" href="../../d4/d8/mi_8h.html#a139">LOCK_EXPANSION</a> (OldIrql);
00889                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ProcessToTrim-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o24">ProcessOutswapEnabled</a> == TRUE);
00890                     ProcessToTrim-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o24">ProcessOutswapEnabled</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00891                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o23">ProcessOutSwapCount</a> &gt;= 1);
00892                     <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o23">ProcessOutSwapCount</a> -= 1;
00893                     <a class="code" href="../../d4/d8/mi_8h.html#a140">UNLOCK_EXPANSION</a> (OldIrql);
00894                     InformSessionOfRelease = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00895                 }
00896 
00897                 <span class="keywordflow">if</span> (Attached) {
00898                     <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a> ();
00899                     Attached = 0;
00900                 }
00901 
00902             }
00903             <span class="keywordflow">else</span> {
00904                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.SessionSpace == 0);
00905                 <a class="code" href="../../d4/d8/mi_8h.html#a145">UNLOCK_SYSTEM_WS</a> (OldIrql);
00906             }
00907 
00908             <a class="code" href="../../d4/d8/mi_8h.html#a139">LOCK_EXPANSION</a> (OldIrql);
00909 
00910             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.BeingTrimmed == 1);
00911             VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o15">u</a>.Flags.BeingTrimmed = 0;
00912 
00913 WorkingSetLockFailed:
00914 
00915             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>.Flink == MM_NO_WS_EXPANSION);
00916 
00917             <span class="keywordflow">if</span> (VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>.Blink ==
00918                                                  <a class="code" href="../../d4/d8/mi_8h.html#a21">MM_WS_EXPANSION_IN_PROGRESS</a>) {
00919 
00920                 <span class="comment">//</span>
00921                 <span class="comment">// If the working set size is still above the minimum,</span>
00922                 <span class="comment">// add this back at the tail of the list.</span>
00923                 <span class="comment">//</span>
00924 
00925                 InsertTailList (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a710">MmWorkingSetExpansionHead</a>.<a class="code" href="../../d7/d7/struct__MMWORKING__SET__EXPANSION__HEAD.html#o0">ListHead</a>,
00926                                 &amp;VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>);
00927             }
00928             <span class="keywordflow">else</span> {
00929 
00930                 <span class="comment">//</span>
00931                 <span class="comment">// The value in the blink is the address of an event</span>
00932                 <span class="comment">// to set.</span>
00933                 <span class="comment">//</span>
00934 
00935                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (VmSupport != &amp;MmSystemCacheWs);
00936 
00937                 <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a> ((<a class="code" href="../../d2/d6/struct__KEVENT.html">PKEVENT</a>)VmSupport-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o8">WorkingSetExpansionLinks</a>.Blink,
00938                             0,
00939                             FALSE);
00940             }
00941 
00942 <span class="preprocessor">#ifndef _MI_USE_CLAIMS_</span>
00943 <span class="preprocessor"></span>            TrimCriteria.<a class="code" href="../../d8/d7/union__MMWS__TRIM__CRITERIA.html#o6">FaultBased</a>.TotalReduction += Trim;
00944 
00945             <span class="comment">//</span>
00946             <span class="comment">// Zero this in case the next attach fails.</span>
00947             <span class="comment">//</span>
00948 
00949             Trim = 0;
00950 
00951             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d0/wsmanage_8c.html#a23">MiCheckCounter</a> &lt; <a class="code" href="../../d5/d0/wsmanage_8c.html#a0">MM_TRIM_COUNTER_MAXIMUM_LARGE_MEM</a>) {
00952                 <span class="keywordflow">if</span> ((<a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> &gt; TrimCriteria.<a class="code" href="../../d8/d7/union__MMWS__TRIM__CRITERIA.html#o6">FaultBased</a>.DesiredFreeGoal) ||
00953                     (TrimCriteria.<a class="code" href="../../d8/d7/union__MMWS__TRIM__CRITERIA.html#o6">FaultBased</a>.TotalReduction &gt; TrimCriteria.<a class="code" href="../../d8/d7/union__MMWS__TRIM__CRITERIA.html#o6">FaultBased</a>.DesiredReductionGoal)) {
00954 
00955 
00956                     <span class="comment">//</span>
00957                     <span class="comment">// Ample pages now exist.</span>
00958                     <span class="comment">//</span>
00959 
00960                     <a class="code" href="../../d2/d1/mm_8h.html#a104">PERFINFO_WSMANAGE_FINALACTION</a>(WS_ACTION_AMPLE_PAGES_EXIST);
00961                     <span class="keywordflow">break</span>;
00962                 }
00963             }
00964 <span class="preprocessor">#endif</span>
00965 <span class="preprocessor"></span>
00966         }
00967 
00968 <span class="preprocessor">#ifdef _MI_USE_CLAIMS_</span>
00969 <span class="preprocessor"></span>        MmTotalClaim = TrimCriteria.ClaimBased.NewTotalClaim;
00970         MmTotalEstimatedAvailable = TrimCriteria.ClaimBased.NewTotalEstimatedAvailable;
00971         <a class="code" href="../../d2/d1/mm_8h.html#a115">PERFINFO_WSMANAGE_TRIMEND_CLAIMS</a>(&amp;TrimCriteria);
00972 <span class="preprocessor">#else</span>
00973 <span class="preprocessor"></span>        <a class="code" href="../../d5/d0/wsmanage_8c.html#a23">MiCheckCounter</a> = 0;
00974         <a class="code" href="../../d2/d1/mm_8h.html#a116">PERFINFO_WSMANAGE_TRIMEND_FAULTS</a>(&amp;TrimCriteria);
00975 <span class="preprocessor">#endif</span>
00976 <span class="preprocessor"></span>
00977         <a class="code" href="../../d4/d8/mi_8h.html#a140">UNLOCK_EXPANSION</a> (OldIrql);
00978     }
00979 
00980     <span class="comment">//</span>
00981     <span class="comment">// Signal the modified page writer as we have moved pages</span>
00982     <span class="comment">// to the modified list and memory was critical.</span>
00983     <span class="comment">//</span>
00984 
00985     <span class="keywordflow">if</span> ((<a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> &lt; <a class="code" href="../../d4/d8/mi_8h.html#a726">MmMinimumFreePages</a>) ||
00986         (<a class="code" href="../../d2/d1/mm_8h.html#a150">MmModifiedPageListHead</a>.<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o0">Total</a> &gt;= <a class="code" href="../../d4/d8/mi_8h.html#a728">MmModifiedPageMaximum</a>)) {
00987         <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a> (&amp;MmModifiedPageWriterEvent, 0, FALSE);
00988     }
00989 
00990     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (CurrentProcess == PsGetCurrentProcess ());
00991 
00992     <span class="keywordflow">return</span>;
00993 }

</div></pre>    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a6" doxytag="wsmanage.c::ExpDefaultErrorPortProcess" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> <a class="el" href="../../d9/d1/psquery_8c.html#a4">ExpDefaultErrorPortProcess</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00099">99</a> of file <a class="el" href="../../d6/d9/wsmanage_8c-source.html">wsmanage.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a23" doxytag="wsmanage.c::MiCheckCounter" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d5/d0/wsmanage_8c.html#a23">MiCheckCounter</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00163">163</a> of file <a class="el" href="../../d6/d9/wsmanage_8c-source.html">wsmanage.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00996">MiCheckAndSetSystemTrimCriteria()</a>, <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l01372">MiCheckProcessTrimCriteria()</a>, <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l01591">MiCheckSystemCacheWsTrimCriteria()</a>, <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l01218">MiCheckSystemTrimEndCriteria()</a>, <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l01644">MiDetermineWsTrimAmount()</a>, and <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00397">MmWorkingSetManager()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="wsmanage.c::MiIdealPassFaultCountDisable" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d5/d0/wsmanage_8c.html#a4">MiIdealPassFaultCountDisable</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00095">95</a> of file <a class="el" href="../../d6/d9/wsmanage_8c-source.html">wsmanage.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00259">MiAdjustWorkingSetManagerParameters()</a>, and <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00996">MiCheckAndSetSystemTrimCriteria()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a31" doxytag="wsmanage.c::MiTrimAllPageFaultCount" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d5/d0/wsmanage_8c.html#a31">MiTrimAllPageFaultCount</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l02982">2982</a> of file <a class="el" href="../../d6/d9/wsmanage_8c-source.html">wsmanage.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l02986">MmTrimAllSystemPagableMemory()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a30" doxytag="wsmanage.c::MiTrimInProgressCount" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LONG <a class="el" href="../../d5/d0/wsmanage_8c.html#a30">MiTrimInProgressCount</a> = 1          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l02980">2980</a> of file <a class="el" href="../../d6/d9/wsmanage_8c-source.html">wsmanage.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/mminit_8c-source.html#l00184">MmInitSystem()</a>, and <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l02986">MmTrimAllSystemPagableMemory()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="wsmanage.c::MiWaitForEmptyEvent" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> <a class="el" href="../../d5/d0/wsmanage_8c.html#a7">MiWaitForEmptyEvent</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00107">107</a> of file <a class="el" href="../../d6/d9/wsmanage_8c-source.html">wsmanage.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00259">MiAdjustWorkingSetManagerParameters()</a>, <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00996">MiCheckAndSetSystemTrimCriteria()</a>, and <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l02715">MiEmptyAllWorkingSets()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="wsmanage.c::MiWaitingForWorkingSetEmpty" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN <a class="el" href="../../d5/d0/wsmanage_8c.html#a8">MiWaitingForWorkingSetEmpty</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00108">108</a> of file <a class="el" href="../../d6/d9/wsmanage_8c-source.html">wsmanage.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00259">MiAdjustWorkingSetManagerParameters()</a>, <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00996">MiCheckAndSetSystemTrimCriteria()</a>, and <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l02715">MiEmptyAllWorkingSets()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="wsmanage.c::MmAmpleFreePages" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d5/d0/wsmanage_8c.html#a10">MmAmpleFreePages</a> = 200          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00125">125</a> of file <a class="el" href="../../d6/d9/wsmanage_8c-source.html">wsmanage.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00996">MiCheckAndSetSystemTrimCriteria()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a24" doxytag="wsmanage.c::MmLastFaultCount" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d5/d0/wsmanage_8c.html#a24">MmLastFaultCount</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00164">164</a> of file <a class="el" href="../../d6/d9/wsmanage_8c-source.html">wsmanage.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00996">MiCheckAndSetSystemTrimCriteria()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="wsmanage.c::MmMoreThanEnoughFreePages" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PFN_NUMBER <a class="el" href="../../d5/d0/wsmanage_8c.html#a9">MmMoreThanEnoughFreePages</a> = 1000          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00123">123</a> of file <a class="el" href="../../d6/d9/wsmanage_8c-source.html">wsmanage.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a22" doxytag="wsmanage.c::MmNumberOfForegroundProcesses" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d5/d0/wsmanage_8c.html#a22">MmNumberOfForegroundProcesses</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00146">146</a> of file <a class="el" href="../../d6/d9/wsmanage_8c-source.html">wsmanage.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l01372">MiCheckProcessTrimCriteria()</a>, and <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l01218">MiCheckSystemTrimEndCriteria()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a26" doxytag="wsmanage.c::MmPagableKernelEnd" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PVOID <a class="el" href="../../d5/d0/wsmanage_8c.html#a26">MmPagableKernelEnd</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00173">173</a> of file <a class="el" href="../../d6/d9/wsmanage_8c-source.html">wsmanage.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a25" doxytag="wsmanage.c::MmPagableKernelStart" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PVOID <a class="el" href="../../d5/d0/wsmanage_8c.html#a25">MmPagableKernelStart</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00172">172</a> of file <a class="el" href="../../d6/d9/wsmanage_8c-source.html">wsmanage.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a15" doxytag="wsmanage.c::MmWorkingSetReductionHuge" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d5/d0/wsmanage_8c.html#a15">MmWorkingSetReductionHuge</a> = (512*1024) &gt;&gt; PAGE_SHIFT          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00133">133</a> of file <a class="el" href="../../d6/d9/wsmanage_8c-source.html">wsmanage.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l01644">MiDetermineWsTrimAmount()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a13" doxytag="wsmanage.c::MmWorkingSetReductionMax" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d5/d0/wsmanage_8c.html#a13">MmWorkingSetReductionMax</a> = 60          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00130">130</a> of file <a class="el" href="../../d6/d9/wsmanage_8c-source.html">wsmanage.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00259">MiAdjustWorkingSetManagerParameters()</a>, <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l01644">MiDetermineWsTrimAmount()</a>, and <a class="el" href="../../d5/d4/procsup_8c-source.html#l05567">MmSetMemoryPriorityProcess()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a14" doxytag="wsmanage.c::MmWorkingSetReductionMaxCacheWs" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d5/d0/wsmanage_8c.html#a14">MmWorkingSetReductionMaxCacheWs</a> = 60          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00131">131</a> of file <a class="el" href="../../d6/d9/wsmanage_8c-source.html">wsmanage.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l01644">MiDetermineWsTrimAmount()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="wsmanage.c::MmWorkingSetReductionMin" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d5/d0/wsmanage_8c.html#a11">MmWorkingSetReductionMin</a> = 12          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00127">127</a> of file <a class="el" href="../../d6/d9/wsmanage_8c-source.html">wsmanage.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00259">MiAdjustWorkingSetManagerParameters()</a>, and <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l01644">MiDetermineWsTrimAmount()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a12" doxytag="wsmanage.c::MmWorkingSetReductionMinCacheWs" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d5/d0/wsmanage_8c.html#a12">MmWorkingSetReductionMinCacheWs</a> = 12          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00128">128</a> of file <a class="el" href="../../d6/d9/wsmanage_8c-source.html">wsmanage.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l01644">MiDetermineWsTrimAmount()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a20" doxytag="wsmanage.c::MmWorkingSetSwapReduction" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d5/d0/wsmanage_8c.html#a20">MmWorkingSetSwapReduction</a> = 75          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00142">142</a> of file <a class="el" href="../../d6/d9/wsmanage_8c-source.html">wsmanage.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l01644">MiDetermineWsTrimAmount()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a21" doxytag="wsmanage.c::MmWorkingSetSwapReductionHuge" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d5/d0/wsmanage_8c.html#a21">MmWorkingSetSwapReductionHuge</a> = (4*1024*1024) &gt;&gt; PAGE_SHIFT          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00144">144</a> of file <a class="el" href="../../d6/d9/wsmanage_8c-source.html">wsmanage.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l01644">MiDetermineWsTrimAmount()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a19" doxytag="wsmanage.c::MmWorkingSetVolReductionHuge" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d5/d0/wsmanage_8c.html#a19">MmWorkingSetVolReductionHuge</a> = (2*1024*1024) &gt;&gt; PAGE_SHIFT          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00140">140</a> of file <a class="el" href="../../d6/d9/wsmanage_8c-source.html">wsmanage.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l01644">MiDetermineWsTrimAmount()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a17" doxytag="wsmanage.c::MmWorkingSetVolReductionMax" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d5/d0/wsmanage_8c.html#a17">MmWorkingSetVolReductionMax</a> = 60          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00137">137</a> of file <a class="el" href="../../d6/d9/wsmanage_8c-source.html">wsmanage.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00259">MiAdjustWorkingSetManagerParameters()</a>, and <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l01644">MiDetermineWsTrimAmount()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a18" doxytag="wsmanage.c::MmWorkingSetVolReductionMaxCacheWs" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d5/d0/wsmanage_8c.html#a18">MmWorkingSetVolReductionMaxCacheWs</a> = 60          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00138">138</a> of file <a class="el" href="../../d6/d9/wsmanage_8c-source.html">wsmanage.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l01644">MiDetermineWsTrimAmount()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a16" doxytag="wsmanage.c::MmWorkingSetVolReductionMin" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d5/d0/wsmanage_8c.html#a16">MmWorkingSetVolReductionMin</a> = 12          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00135">135</a> of file <a class="el" href="../../d6/d9/wsmanage_8c-source.html">wsmanage.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l01644">MiDetermineWsTrimAmount()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a27" doxytag="wsmanage.c::PERFINFO_WSMANAGE_GLOBAL_DECL" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d5/d0/wsmanage_8c.html#a27">PERFINFO_WSMANAGE_GLOBAL_DECL</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00175">175</a> of file <a class="el" href="../../d6/d9/wsmanage_8c-source.html">wsmanage.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="wsmanage.c::PsMinimumWorkingSet" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d0/d1/psinit_8c.html#a2">PsMinimumWorkingSet</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l00097">97</a> of file <a class="el" href="../../d6/d9/wsmanage_8c-source.html">wsmanage.c</a>.
<p>
Referenced by <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l00969">PspCreateProcess()</a>, and <a class="el" href="../../d1/d0/psinit_8c-source.html#l00181">PspInitPhase0()</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:46:10 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
