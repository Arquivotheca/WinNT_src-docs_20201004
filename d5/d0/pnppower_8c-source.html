<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: pnppower.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>pnppower.c</h1><a href="../../d4/d1/pnppower_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1999 Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    pnppower.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This file contains the routines that integrate PnP and Power</span>
00012 <span class="comment"></span>
00013 <span class="comment">Author:</span>
00014 <span class="comment"></span>
00015 <span class="comment">    Adrian J. Oney (AdriaO) 01-19-1999</span>
00016 <span class="comment"></span>
00017 <span class="comment">Revision History:</span>
00018 <span class="comment"></span>
00019 <span class="comment">    Modified for nt kernel.</span>
00020 <span class="comment"></span>
00021 <span class="comment">--*/</span>
00022 
00023 <span class="preprocessor">#include "<a class="code" href="../../d0/d6/iop_8h.html">iop.h</a>"</span>
00024 
00025 <span class="comment">//</span>
00026 <span class="comment">// Internal References</span>
00027 <span class="comment">//</span>
00028 
00029 PWCHAR
00030 <a class="code" href="../../d4/d1/pnppower_8c.html#a0">IopCaptureObjectName</a> (
00031     IN PVOID    Object
00032     );
00033 
00034 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00035 <a class="code" href="../../d4/d1/pnppower_8c.html#a1">IopFreePoDeviceNotifyListHead</a> (
00036     PLIST_ENTRY ListHead
00037     );
00038 
00039 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00040 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopWarmEjectDevice)</span>
00041 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGELK, IoBuildPoDeviceNotifyList)</span>
00042 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGELK, IoFreePoDeviceNotifyList)</span>
00043 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGELK, IopFreePoDeviceNotifyListHead)</span>
00044 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGELK, IopCaptureObjectName)</span>
00045 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00046 <span class="preprocessor"></span>
00047 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00048"></a><a class="code" href="../../d4/d1/pnppower_8c.html#a2">00048</a> <a class="code" href="../../d4/d1/pnppower_8c.html#a2">IoBuildPoDeviceNotifyList</a> (
00049     IN OUT <a class="code" href="../../d8/d7/struct__PO__DEVICE__NOTIFY__ORDER.html">PPO_DEVICE_NOTIFY_ORDER</a>  Order
00050     )
00051 {
00052     PLIST_ENTRY             link;
00053     <a class="code" href="../../d7/d7/struct__PO__DEVICE__NOTIFY.html">PPO_DEVICE_NOTIFY</a>       notify;
00054     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>            node;
00055     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>            parent;
00056     ULONG                   noLists, listIndex;
00057     PLIST_ENTRY             notifyLists;
00058     LONG                    maxLevel, level;
00059     UCHAR                   orderLevel;
00060     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>          nonPaged;
00061 
00062     <span class="comment">//</span>
00063     <span class="comment">// Acquire device node lock</span>
00064     <span class="comment">//</span>
00065 
00066     <a class="code" href="../../d9/d0/pnpiop_8h.html#a98">IopAcquireDeviceTreeLock</a>();
00067     RtlZeroMemory (Order, <span class="keyword">sizeof</span> (*Order));
00068     Order-&gt;DevNodeSequence = <a class="code" href="../../d1/d0/pnpdata_8c.html#a21">IoDeviceNodeTreeSequence</a>;
00069     InitializeListHead (&amp;Order-&gt;Partial);
00070     InitializeListHead (&amp;Order-&gt;Rebase);
00071 
00072     <span class="comment">//</span>
00073     <span class="comment">// Allocate notification structures for all nodes, and determine</span>
00074     <span class="comment">// maximum depth.</span>
00075     <span class="comment">//</span>
00076 
00077     level = -1;
00078     node = <a class="code" href="../../d1/d0/pnpdata_8c.html#a5">IopRootDeviceNode</a>;
00079     <span class="keywordflow">while</span> (node-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o1">Child</a>) {
00080         node = node-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o1">Child</a>;
00081         level += 1;
00082     }
00083 
00084     <span class="comment">//</span>
00085     <span class="comment">// ADRIAO 01/12/1999 N.B. -</span>
00086     <span class="comment">// </span>
00087     <span class="comment">// Note that we include devices without the started flag. Now, we acquire</span>
00088     <span class="comment">// the tree lock exclusively, which prevents people from being in the middle</span>
00089     <span class="comment">// of a rebalance (actually it doesn't today - this is a bug!). However, two</span>
00090     <span class="comment">// things prevent us from excluding devices that aren't started:</span>
00091     <span class="comment">// 1) We must be able to send power messages to a device we are warm </span>
00092     <span class="comment">//    undocking.</span>
00093     <span class="comment">// 2) Many devices may not be started, that is no guarentee they are in D3!</span>
00094     <span class="comment">//    For example, they could easily have a boot config, and PNP still </span>
00095     <span class="comment">//    relies heavily on BIOS boot configs to keep us from placing hardware</span>
00096     <span class="comment">//    ontop of other devices with boot configs we haven't found or started</span>
00097     <span class="comment">//    yet!</span>
00098     <span class="comment">//</span>
00099 
00100     maxLevel = level;
00101     <span class="keywordflow">while</span> (node != <a class="code" href="../../d1/d0/pnpdata_8c.html#a5">IopRootDeviceNode</a>) {
00102         notify = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (
00103                       <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
00104                       <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d7/struct__PO__DEVICE__NOTIFY.html">PO_DEVICE_NOTIFY</a>),
00105                       <a class="code" href="../../d9/d0/pnpiop_8h.html#a2">IOP_DPWR_TAG</a>
00106                       );
00107 
00108         <span class="keywordflow">if</span> (!notify) {
00109             <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00110         }
00111 
00112         RtlZeroMemory (notify, <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d2/po_8h.html#a46">PO_DEVICE_NOTIFY</a>));
00113         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(node-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o5">Notify</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ;
00114         node-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o5">Notify</a> = notify;
00115         notify-&gt;<a class="code" href="../../d7/d7/struct__PO__DEVICE__NOTIFY.html#o5">Node</a> = node;
00116         notify-&gt;<a class="code" href="../../d7/d7/struct__PO__DEVICE__NOTIFY.html#o4">DeviceObject</a> = node-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o9">PhysicalDeviceObject</a>;
00117         notify-&gt;<a class="code" href="../../d7/d7/struct__PO__DEVICE__NOTIFY.html#o1">TargetDevice</a> = <a class="code" href="../../d4/d6/iosubs_8c.html#a66">IoGetAttachedDevice</a>(node-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o9">PhysicalDeviceObject</a>);
00118         notify-&gt;<a class="code" href="../../d7/d7/struct__PO__DEVICE__NOTIFY.html#o7">DriverName</a>   = <a class="code" href="../../d4/d1/pnppower_8c.html#a0">IopCaptureObjectName</a>(notify-&gt;<a class="code" href="../../d7/d7/struct__PO__DEVICE__NOTIFY.html#o1">TargetDevice</a>-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o3">DriverObject</a>);
00119         notify-&gt;<a class="code" href="../../d7/d7/struct__PO__DEVICE__NOTIFY.html#o6">DeviceName</a>   = <a class="code" href="../../d4/d1/pnppower_8c.html#a0">IopCaptureObjectName</a>(notify-&gt;<a class="code" href="../../d7/d7/struct__PO__DEVICE__NOTIFY.html#o1">TargetDevice</a>);
00120         <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a> (notify-&gt;<a class="code" href="../../d7/d7/struct__PO__DEVICE__NOTIFY.html#o4">DeviceObject</a>);
00121         <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a> (notify-&gt;<a class="code" href="../../d7/d7/struct__PO__DEVICE__NOTIFY.html#o1">TargetDevice</a>);
00122 
00123         orderLevel   = 0;
00124 
00125         <span class="keywordflow">if</span> (notify-&gt;<a class="code" href="../../d7/d7/struct__PO__DEVICE__NOTIFY.html#o1">TargetDevice</a>-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o12">DeviceType</a> != FILE_DEVICE_SCREEN &amp;&amp;
00126             notify-&gt;<a class="code" href="../../d7/d7/struct__PO__DEVICE__NOTIFY.html#o1">TargetDevice</a>-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o12">DeviceType</a> != FILE_DEVICE_VIDEO) {
00127             orderLevel |= <a class="code" href="../../d1/d2/po_8h.html#a34">PO_ORDER_NOT_VIDEO</a>;
00128         }
00129 
00130         <span class="keywordflow">if</span> (notify-&gt;<a class="code" href="../../d7/d7/struct__PO__DEVICE__NOTIFY.html#o1">TargetDevice</a>-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o8">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a134">DO_POWER_PAGABLE</a>) {
00131             orderLevel |= <a class="code" href="../../d1/d2/po_8h.html#a36">PO_ORDER_PAGABLE</a>;
00132         }
00133 
00134         notify-&gt;<a class="code" href="../../d7/d7/struct__PO__DEVICE__NOTIFY.html#o3">OrderLevel</a> = orderLevel;
00135         notify-&gt;<a class="code" href="../../d7/d7/struct__PO__DEVICE__NOTIFY.html#o8">NodeLevel</a>  = level;
00136 
00137         <span class="comment">//</span>
00138         <span class="comment">// If this is a level 0 node it's in the root.  Look for</span>
00139         <span class="comment">// non-bus stuff in the root as those guys need to be re-based</span>
00140         <span class="comment">// below everything else</span>
00141         <span class="comment">//</span>
00142 
00143         <span class="keywordflow">if</span> (level == 0  &amp;&amp;
00144             node-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o17">InterfaceType</a> != Internal &amp;&amp;
00145             !(node-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a7">DNF_HAL_NODE</a>)) {
00146 
00147             InsertTailList (&amp;Order-&gt;Rebase, &amp;notify-&gt;<a class="code" href="../../d7/d7/struct__PO__DEVICE__NOTIFY.html#o0">Link</a>);
00148         } <span class="keywordflow">else</span> {
00149             InsertTailList (&amp;Order-&gt;Partial, &amp;notify-&gt;<a class="code" href="../../d7/d7/struct__PO__DEVICE__NOTIFY.html#o0">Link</a>);
00150         }
00151 
00152         <span class="comment">//</span>
00153         <span class="comment">// Next node</span>
00154         <span class="comment">//</span>
00155 
00156         <span class="keywordflow">if</span> (node-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o0">Sibling</a>) {
00157             node = node-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o0">Sibling</a>;
00158             <span class="keywordflow">while</span> (node-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o1">Child</a>) {
00159                 node = node-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o1">Child</a>;
00160                 level += 1;
00161                 <span class="keywordflow">if</span> (level &gt; maxLevel) {
00162                     maxLevel = level;
00163                 }
00164             }
00165 
00166         } <span class="keywordflow">else</span> {
00167             node = node-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o2">Parent</a>;
00168             level -= 1;
00169         }
00170     }
00171 
00172     <span class="comment">//</span>
00173     <span class="comment">// Rebase anything on the rebase list to be after the normal pnp stuff</span>
00174     <span class="comment">//</span>
00175 
00176     <span class="keywordflow">while</span> (!IsListEmpty(&amp;Order-&gt;Rebase)) {
00177         link = Order-&gt;Rebase.Flink;
00178         notify = CONTAINING_RECORD (link, <a class="code" href="../../d7/d7/struct__PO__DEVICE__NOTIFY.html">PO_DEVICE_NOTIFY</a>, Link);
00179         RemoveEntryList (&amp;notify-&gt;<a class="code" href="../../d7/d7/struct__PO__DEVICE__NOTIFY.html#o0">Link</a>);
00180         InsertTailList (&amp;Order-&gt;Partial, &amp;notify-&gt;<a class="code" href="../../d7/d7/struct__PO__DEVICE__NOTIFY.html#o0">Link</a>);
00181 
00182         <span class="comment">//</span>
00183         <span class="comment">// Rebase this node</span>
00184         <span class="comment">//</span>
00185 
00186         node = notify-&gt;<a class="code" href="../../d7/d7/struct__PO__DEVICE__NOTIFY.html#o5">Node</a>;
00187         notify-&gt;<a class="code" href="../../d7/d7/struct__PO__DEVICE__NOTIFY.html#o3">OrderLevel</a> |= <a class="code" href="../../d1/d2/po_8h.html#a35">PO_ORDER_ROOT_ENUM</a>;
00188 
00189         <span class="comment">//</span>
00190         <span class="comment">// Now rebase all the node's children</span>
00191         <span class="comment">//</span>
00192 
00193         parent = node;
00194         <span class="keywordflow">while</span> (node-&gt;Child) {
00195             node = node-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o1">Child</a>;
00196         }
00197 
00198         <span class="keywordflow">while</span> (node != parent) {
00199             notify = node-&gt;Notify;
00200             <span class="keywordflow">if</span> (notify) {
00201                 notify-&gt;<a class="code" href="../../d7/d7/struct__PO__DEVICE__NOTIFY.html#o3">OrderLevel</a> |= <a class="code" href="../../d1/d2/po_8h.html#a35">PO_ORDER_ROOT_ENUM</a>;
00202             }
00203 
00204             <span class="comment">// next node</span>
00205             <span class="keywordflow">if</span> (node-&gt;Sibling) {
00206                 node = node-&gt;Sibling;
00207                 <span class="keywordflow">while</span> (node-&gt;Child) {
00208                     node = node-&gt;Child;
00209                 }
00210             } <span class="keywordflow">else</span> {
00211                 node = node-&gt;Parent;
00212             }
00213         }
00214     }
00215 
00216     <span class="comment">//</span>
00217     <span class="comment">// Allocate ordered notifcation lists</span>
00218     <span class="comment">//</span>
00219 
00220     maxLevel = maxLevel + 1;
00221     noLists  = maxLevel * (<a class="code" href="../../d1/d2/po_8h.html#a37">PO_ORDER_MAXIMUM</a> + 1);
00222     notifyLists = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (
00223                         <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
00224                         <span class="keyword">sizeof</span>(LIST_ENTRY) * noLists,
00225                         <a class="code" href="../../d9/d0/pnpiop_8h.html#a2">IOP_DPWR_TAG</a>
00226                         );
00227 
00228     <span class="keywordflow">if</span> (!notifyLists) {
00229         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00230     }
00231 
00232     <span class="keywordflow">for</span> (listIndex=0; listIndex &lt; noLists; listIndex++) {
00233         InitializeListHead (&amp;notifyLists[listIndex]);
00234     }
00235 
00236     Order-&gt;Notify   = notifyLists;
00237     Order-&gt;MaxLevel = maxLevel;
00238     Order-&gt;NoLists  = noLists;
00239 
00240     <span class="comment">//</span>
00241     <span class="comment">// Build ordered list</span>
00242     <span class="comment">//</span>
00243 
00244     <span class="keywordflow">while</span> (!IsListEmpty(&amp;Order-&gt;Partial)) {
00245         link = Order-&gt;Partial.Flink;
00246         notify = CONTAINING_RECORD (link, <a class="code" href="../../d7/d7/struct__PO__DEVICE__NOTIFY.html">PO_DEVICE_NOTIFY</a>, Link);
00247         RemoveEntryList (&amp;notify-&gt;<a class="code" href="../../d7/d7/struct__PO__DEVICE__NOTIFY.html#o0">Link</a>);
00248 
00249         orderLevel = notify-&gt;<a class="code" href="../../d7/d7/struct__PO__DEVICE__NOTIFY.html#o3">OrderLevel</a>;
00250         listIndex = orderLevel * maxLevel + notify-&gt;<a class="code" href="../../d7/d7/struct__PO__DEVICE__NOTIFY.html#o8">NodeLevel</a>;
00251         InsertTailList (&amp;notifyLists[listIndex], &amp;notify-&gt;<a class="code" href="../../d7/d7/struct__PO__DEVICE__NOTIFY.html#o0">Link</a>);
00252 
00253         <span class="comment">//</span>
00254         <span class="comment">// Sanity check that the pagable bit is set the same on the top</span>
00255         <span class="comment">// of the PDO stack and the bottom of it</span>
00256         <span class="comment">//</span>
00257 
00258         nonPaged = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00259         <span class="keywordflow">if</span> (!(notify-&gt;<a class="code" href="../../d7/d7/struct__PO__DEVICE__NOTIFY.html#o1">TargetDevice</a>-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o8">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a134">DO_POWER_PAGABLE</a>)) {
00260             nonPaged = notify-&gt;<a class="code" href="../../d7/d7/struct__PO__DEVICE__NOTIFY.html#o1">TargetDevice</a>;
00261         }
00262 
00263         <span class="keywordflow">if</span> (nonPaged  &amp;&amp;  (notify-&gt;<a class="code" href="../../d7/d7/struct__PO__DEVICE__NOTIFY.html#o4">DeviceObject</a>-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o8">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a134">DO_POWER_PAGABLE</a>)) {
00264             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (
00265                 DRIVER_POWER_STATE_FAILURE,
00266                 0x100,
00267                 (ULONG_PTR) nonPaged,
00268                 (ULONG_PTR) notify-&gt;<a class="code" href="../../d7/d7/struct__PO__DEVICE__NOTIFY.html#o1">TargetDevice</a>,
00269                 (ULONG_PTR) notify-&gt;<a class="code" href="../../d7/d7/struct__PO__DEVICE__NOTIFY.html#o4">DeviceObject</a>
00270                 );
00271         }
00272 
00273 
00274         <span class="comment">//</span>
00275         <span class="comment">// Make sure all parents are at least the level of this child</span>
00276         <span class="comment">// node or better</span>
00277         <span class="comment">//</span>
00278 
00279         node = notify-&gt;<a class="code" href="../../d7/d7/struct__PO__DEVICE__NOTIFY.html#o5">Node</a>;
00280         <span class="keywordflow">for</span> (parent = node-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o2">Parent</a>;
00281              parent != <a class="code" href="../../d1/d0/pnpdata_8c.html#a5">IopRootDeviceNode</a>;
00282              parent = parent-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o2">Parent</a>) {
00283 
00284             notify = parent-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o5">Notify</a>;
00285             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (notify != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00286             <span class="keywordflow">if</span> (notify-&gt;<a class="code" href="../../d7/d7/struct__PO__DEVICE__NOTIFY.html#o3">OrderLevel</a> &lt;= orderLevel) {
00287                 <span class="keywordflow">break</span>;
00288             }
00289 
00290             <span class="keywordflow">if</span> (nonPaged  &amp;&amp; (
00291                 (notify-&gt;<a class="code" href="../../d7/d7/struct__PO__DEVICE__NOTIFY.html#o4">DeviceObject</a>-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o8">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a134">DO_POWER_PAGABLE</a>) ||
00292                 (notify-&gt;<a class="code" href="../../d7/d7/struct__PO__DEVICE__NOTIFY.html#o1">TargetDevice</a>-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o8">Flags</a> &amp; <a class="code" href="../../d0/d5/io_8h.html#a134">DO_POWER_PAGABLE</a>) )) {
00293 
00294                 <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (
00295                     DRIVER_POWER_STATE_FAILURE,
00296                     0x100,
00297                     (ULONG_PTR) nonPaged,
00298                     (ULONG_PTR) notify-&gt;<a class="code" href="../../d7/d7/struct__PO__DEVICE__NOTIFY.html#o1">TargetDevice</a>,
00299                     (ULONG_PTR) notify-&gt;<a class="code" href="../../d7/d7/struct__PO__DEVICE__NOTIFY.html#o4">DeviceObject</a>
00300                     );
00301             }
00302 
00303             RemoveEntryList (&amp;notify-&gt;<a class="code" href="../../d7/d7/struct__PO__DEVICE__NOTIFY.html#o0">Link</a>);
00304 
00305             notify-&gt;<a class="code" href="../../d7/d7/struct__PO__DEVICE__NOTIFY.html#o3">OrderLevel</a> = orderLevel;
00306             listIndex = orderLevel * maxLevel + notify-&gt;<a class="code" href="../../d7/d7/struct__PO__DEVICE__NOTIFY.html#o8">NodeLevel</a>;
00307             InsertTailList (&amp;notifyLists[listIndex], &amp;notify-&gt;<a class="code" href="../../d7/d7/struct__PO__DEVICE__NOTIFY.html#o0">Link</a>);
00308         }
00309     }
00310 
00311     Order-&gt;WarmEjectPdoPointer = &amp;<a class="code" href="../../d1/d0/pnpdata_8c.html#a29">IopWarmEjectPdo</a>;
00312 
00313     <span class="comment">//</span>
00314     <span class="comment">// The device tree lock is release when the notify list is freed</span>
00315     <span class="comment">//</span>
00316 
00317     <span class="keywordflow">return</span> STATUS_SUCCESS;
00318 }
00319 
00320 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00321"></a><a class="code" href="../../d4/d1/pnppower_8c.html#a1">00321</a> <a class="code" href="../../d4/d1/pnppower_8c.html#a1">IopFreePoDeviceNotifyListHead</a> (
00322     PLIST_ENTRY ListHead
00323     )
00324 {
00325     PLIST_ENTRY             Link;
00326     <a class="code" href="../../d7/d7/struct__PO__DEVICE__NOTIFY.html">PPO_DEVICE_NOTIFY</a>       Notify;
00327     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>            Node;
00328 
00329     <span class="keywordflow">if</span> (ListHead-&gt;Flink) {
00330         <span class="keywordflow">while</span> (!IsListEmpty(ListHead)) {
00331             Link = ListHead-&gt;Flink;
00332             Notify = CONTAINING_RECORD (Link, <a class="code" href="../../d7/d7/struct__PO__DEVICE__NOTIFY.html">PO_DEVICE_NOTIFY</a>, Link);
00333             RemoveEntryList(&amp;Notify-&gt;<a class="code" href="../../d7/d7/struct__PO__DEVICE__NOTIFY.html#o0">Link</a>);
00334 
00335             Node = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>) Notify-&gt;<a class="code" href="../../d7/d7/struct__PO__DEVICE__NOTIFY.html#o5">Node</a>;
00336             Node-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o5">Notify</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00337 
00338             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a> (Notify-&gt;<a class="code" href="../../d7/d7/struct__PO__DEVICE__NOTIFY.html#o4">DeviceObject</a>);
00339             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a> (Notify-&gt;<a class="code" href="../../d7/d7/struct__PO__DEVICE__NOTIFY.html#o1">TargetDevice</a>);
00340             <span class="keywordflow">if</span> (Notify-&gt;<a class="code" href="../../d7/d7/struct__PO__DEVICE__NOTIFY.html#o6">DeviceName</a>) {
00341                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (Notify-&gt;<a class="code" href="../../d7/d7/struct__PO__DEVICE__NOTIFY.html#o6">DeviceName</a>);
00342             }
00343             <span class="keywordflow">if</span> (Notify-&gt;<a class="code" href="../../d7/d7/struct__PO__DEVICE__NOTIFY.html#o7">DriverName</a>) {
00344                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (Notify-&gt;<a class="code" href="../../d7/d7/struct__PO__DEVICE__NOTIFY.html#o7">DriverName</a>);
00345             }
00346             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(Notify);
00347         }
00348     }
00349 }
00350 
00351 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00352"></a><a class="code" href="../../d4/d1/pnppower_8c.html#a3">00352</a> <a class="code" href="../../d4/d1/pnppower_8c.html#a3">IoFreePoDeviceNotifyList</a> (
00353     IN OUT <a class="code" href="../../d8/d7/struct__PO__DEVICE__NOTIFY__ORDER.html">PPO_DEVICE_NOTIFY_ORDER</a>  Order
00354     )
00355 {
00356     ULONG                   i;
00357 
00358 
00359     <span class="keywordflow">if</span> (Order-&gt;DevNodeSequence) {
00360         <span class="comment">//</span>
00361         <span class="comment">// Release the device tree lock</span>
00362         <span class="comment">//</span>
00363 
00364         <a class="code" href="../../d9/d0/pnpiop_8h.html#a99">IopReleaseDeviceTreeLock</a>();
00365         Order-&gt;DevNodeSequence = 0;
00366     }
00367 
00368     <span class="comment">//</span>
00369     <span class="comment">// Free the resources from the notify list</span>
00370     <span class="comment">//</span>
00371 
00372     <a class="code" href="../../d4/d1/pnppower_8c.html#a1">IopFreePoDeviceNotifyListHead</a> (&amp;Order-&gt;Partial);
00373     <a class="code" href="../../d4/d1/pnppower_8c.html#a1">IopFreePoDeviceNotifyListHead</a> (&amp;Order-&gt;Rebase);
00374     <span class="keywordflow">if</span> (Order-&gt;Notify) {
00375         <span class="keywordflow">for</span> (i=0; i &lt; Order-&gt;NoLists; i++) {
00376             <a class="code" href="../../d4/d1/pnppower_8c.html#a1">IopFreePoDeviceNotifyListHead</a> (&amp;Order-&gt;Notify[i]);
00377         }
00378         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (Order-&gt;Notify);
00379     }
00380 
00381     RtlZeroMemory (Order, <span class="keyword">sizeof</span> (<a class="code" href="../../d8/d7/struct__PO__DEVICE__NOTIFY__ORDER.html">PO_DEVICE_NOTIFY_ORDER</a>));
00382 }
00383 
00384 
00385 PWCHAR
<a name="l00386"></a><a class="code" href="../../d4/d1/pnppower_8c.html#a0">00386</a> <a class="code" href="../../d4/d1/pnppower_8c.html#a0">IopCaptureObjectName</a> (
00387     IN PVOID    Object
00388     )
00389 {
00390     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>                    <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00391     UCHAR                       <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>[512];
00392     POBJECT_NAME_INFORMATION    ObName;
00393     ULONG                       len;
00394     PWCHAR                      <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>;
00395 
00396     ObName = (POBJECT_NAME_INFORMATION) <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
00397     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d1/obquery_8c.html#a7">ObQueryNameString</a> (
00398                 Object,
00399                 ObName,
00400                 <span class="keyword">sizeof</span> (<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>),
00401                 &amp;len
00402                 );
00403 
00404     <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00405     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) &amp;&amp; ObName-&gt;Name.Buffer) {
00406         <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a> = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (
00407                     <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
00408                     ObName-&gt;Name.Length + <span class="keyword">sizeof</span>(WCHAR),
00409                     <a class="code" href="../../d9/d0/pnpiop_8h.html#a2">IOP_DPWR_TAG</a>
00410                     );
00411 
00412         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>) {
00413             memcpy (<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>, ObName-&gt;Name.Buffer, ObName-&gt;Name.Length);
00414             <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>[ObName-&gt;Name.Length/<span class="keyword">sizeof</span>(WCHAR)] = 0;
00415         }
00416     }
00417 
00418     <span class="keywordflow">return</span> <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>;
00419 }
00420 
00421 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00422"></a><a class="code" href="../../d4/d1/pnppower_8c.html#a4">00422</a> <a class="code" href="../../d4/d1/pnppower_8c.html#a4">IopWarmEjectDevice</a>(
00423    IN <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>       DeviceToEject,
00424    IN SYSTEM_POWER_STATE   LightestSleepState
00425    )
00426 <span class="comment">/*++</span>
00427 <span class="comment"></span>
00428 <span class="comment">Routine Description:</span>
00429 <span class="comment"></span>
00430 <span class="comment">    This function is invoked to initiate a warm eject. The eject progresses</span>
00431 <span class="comment">    from S1 to the passed in lightest sleep state.</span>
00432 <span class="comment"></span>
00433 <span class="comment">Arguments:</span>
00434 <span class="comment"></span>
00435 <span class="comment">    DeviceToEject       - The device to eject</span>
00436 <span class="comment"></span>
00437 <span class="comment">    LightestSleepState  - The lightest S state (at least S1) that the device</span>
00438 <span class="comment">                          may be ejected in. This might be S4 if we are truely</span>
00439 <span class="comment">                          low on power.</span>
00440 <span class="comment"></span>
00441 <span class="comment">Return Value:</span>
00442 <span class="comment"></span>
00443 <span class="comment">    NTSTATUS value.</span>
00444 <span class="comment"></span>
00445 <span class="comment">--*/</span>
00446 {
00447     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>       status;
00448 
00449     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00450 
00451     <span class="comment">//</span>
00452     <span class="comment">// Acquire the warm eject device lock. A warm eject requires we enter a </span>
00453     <span class="comment">// specific S-state, and two different devices may have conflicting options.</span>
00454     <span class="comment">// Therefore only one is allowed to occur at once.</span>
00455     <span class="comment">//</span>
00456     status = <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>(
00457         &amp;<a class="code" href="../../d1/d0/pnpdata_8c.html#a28">IopWarmEjectLock</a>,
00458         <a class="code" href="../../d6/d7/halmips_8h.html#a455">Executive</a>,
00459         <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
00460         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00461         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00462         );
00463   
00464     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(status == STATUS_SUCCESS) ;
00465 
00466     <span class="comment">//</span>
00467     <span class="comment">// Acquire device node lock. We are not allowed to set or clear this field</span>
00468     <span class="comment">// unless we are under this lock.</span>
00469     <span class="comment">//</span>
00470     <a class="code" href="../../d9/d0/pnpiop_8h.html#a98">IopAcquireDeviceTreeLock</a>();
00471 
00472     <span class="comment">//</span>
00473     <span class="comment">// Set the current Pdo to eject. </span>
00474     <span class="comment">//</span>
00475     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d1/d0/pnpdata_8c.html#a29">IopWarmEjectPdo</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00476     <a class="code" href="../../d1/d0/pnpdata_8c.html#a29">IopWarmEjectPdo</a> = DeviceToEject;
00477 
00478     <span class="comment">//</span>
00479     <span class="comment">// Release the tree lock.</span>
00480     <span class="comment">//</span>
00481     <a class="code" href="../../d9/d0/pnpiop_8h.html#a99">IopReleaseDeviceTreeLock</a>();
00482 
00483     <span class="comment">//</span>
00484     <span class="comment">// Attempt to invalidate Po's cached notification list. This should cause</span>
00485     <span class="comment">// IoBuildPoDeviceNotifyList to be called at which time it will in theory </span>
00486     <span class="comment">// pickup the above placed warm eject Pdo. </span>
00487     <span class="comment">//</span>
00488     <span class="comment">// ADRIAO NOTE 01/07/1999 -</span>
00489     <span class="comment">//     Actually, this whole IoDeviceNodeTreeSequence stuff isn't neccessary. </span>
00490     <span class="comment">// PnP will make no changes to the tree while the device tree lock is owned,</span>
00491     <span class="comment">// and it's owned for the duration of a power notification.</span>
00492     <span class="comment">//</span>
00493     <a class="code" href="../../d1/d0/pnpdata_8c.html#a21">IoDeviceNodeTreeSequence</a>++;
00494 
00495     <span class="comment">//</span>
00496     <span class="comment">// Sleep...</span>
00497     <span class="comment">//</span>
00498     status = NtInitiatePowerAction(
00499         PowerActionWarmEject,
00500         LightestSleepState,
00501         POWER_ACTION_QUERY_ALLOWED |
00502         POWER_ACTION_UI_ALLOWED,
00503         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <span class="comment">// Asynchronous == FALSE</span>
00504         );   
00505 
00506     <span class="comment">//</span>
00507     <span class="comment">// Acquire device node lock. We are not allowed to set or clear this field</span>
00508     <span class="comment">// unless we are under this lock.</span>
00509     <span class="comment">//</span>
00510     <a class="code" href="../../d9/d0/pnpiop_8h.html#a98">IopAcquireDeviceTreeLock</a>();
00511 
00512     <span class="comment">//</span>
00513     <span class="comment">// Clear the current PDO to eject, and see if the Pdo was actually picked</span>
00514     <span class="comment">// up.</span>
00515     <span class="comment">//</span>
00516     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/pnpdata_8c.html#a29">IopWarmEjectPdo</a>) {
00517 
00518         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00519 
00520             <span class="comment">//</span>
00521             <span class="comment">// If our device wasn't picked up, the return of </span>
00522             <span class="comment">// NtInitiatePowerAction should *not* be successful!</span>
00523             <span class="comment">//</span>
00524             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(0);
00525             status = STATUS_UNSUCCESSFUL;
00526         }
00527 
00528         <a class="code" href="../../d1/d0/pnpdata_8c.html#a29">IopWarmEjectPdo</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00529     } 
00530 
00531     <span class="comment">//</span>
00532     <span class="comment">// Release the tree lock.</span>
00533     <span class="comment">//</span>
00534     <a class="code" href="../../d9/d0/pnpiop_8h.html#a99">IopReleaseDeviceTreeLock</a>();
00535     
00536     <span class="comment">//</span>
00537     <span class="comment">// Release the warm eject device lock</span>
00538     <span class="comment">//</span>
00539     <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>(                                        
00540         &amp;<a class="code" href="../../d1/d0/pnpdata_8c.html#a28">IopWarmEjectLock</a>,
00541         <a class="code" href="../../d7/d8/exboosts_8h.html#a3">IO_NO_INCREMENT</a>,
00542         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
00543         );        
00544    
00545     <span class="keywordflow">return</span> status;
00546 }
00547 
00548 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:22 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
