<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: pnpeisa.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>pnpeisa.c File Reference</h1><code>#include "<a class="el" href="../../d1/d5/iop_8h-source.html">iop.h</a>"</code><br>

<p>
<a href="../../d6/d9/pnpeisa_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d0/pnpeisa_8c.html#a0">EISA_DEVICE_NODE_NAME</a>&nbsp;&nbsp;&nbsp;L"EisaResources"</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d0/pnpeisa_8c.html#a1">BUFFER_LENGTH</a>&nbsp;&nbsp;&nbsp;50</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d0/pnpeisa_8c.html#a2">EisaGetEisaDevicesResources</a> (OUT PCM_RESOURCE_LIST *ResourceList, OUT PULONG ResourceLength)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d0/pnpeisa_8c.html#a3">EisaBuildSlotsResources</a> (IN ULONG SlotMasks, IN ULONG NumberMasks, OUT PCM_RESOURCE_LIST *<a class="el" href="../../d4/d0/tex_8c.html#a21">Resource</a>, OUT ULONG *Length)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d0/pnpeisa_8c.html#a4">EisaBuildEisaDeviceNode</a> (VOID)</td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a1" doxytag="pnpeisa.c::BUFFER_LENGTH" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define BUFFER_LENGTH&nbsp;&nbsp;&nbsp;50          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d9/pnpeisa_8c-source.html#l00036">36</a> of file <a class="el" href="../../d6/d9/pnpeisa_8c-source.html">pnpeisa.c</a>.
<p>
Referenced by <a class="el" href="../../d5/d3/tprefix_8c-source.html#l00282">AnotherPrefix()</a>, and <a class="el" href="../../d6/d9/pnpeisa_8c-source.html#l00059">EisaBuildEisaDeviceNode()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="pnpeisa.c::EISA_DEVICE_NODE_NAME" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define EISA_DEVICE_NODE_NAME&nbsp;&nbsp;&nbsp;L"EisaResources"          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d9/pnpeisa_8c-source.html#l00035">35</a> of file <a class="el" href="../../d6/d9/pnpeisa_8c-source.html">pnpeisa.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d9/pnpeisa_8c-source.html#l00059">EisaBuildEisaDeviceNode()</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a4" doxytag="pnpeisa.c::EisaBuildEisaDeviceNode" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS EisaBuildEisaDeviceNode           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d9/pnpeisa_8c-source.html#l00059">59</a> of file <a class="el" href="../../d6/d9/pnpeisa_8c-source.html">pnpeisa.c</a>.
<p>
References <a class="el" href="../../d6/d9/pnpeisa_8c-source.html#l00036">BUFFER_LENGTH</a>, <a class="el" href="../../d6/d9/pnpeisa_8c-source.html#l00035">EISA_DEVICE_NODE_NAME</a>, <a class="el" href="../../d6/d9/pnpeisa_8c-source.html#l00201">EisaGetEisaDevicesResources()</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l01156">IopCreateRegistryKeyEx()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l01104">IopOpenRegistryKeyEx()</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>, and <a class="el" href="../../d5/d0/config_2alpha_2init_8c-source.html#l00034">TITLE_INDEX_VALUE</a>.
<p>
Referenced by <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00093">IopInitializePlugPlayServices()</a>.
<p>
<pre class="fragment"><div>00065                    :
00066 
00067     This routine build an registry key to report eisa resources to arbiters.
00068 
00069 Arguments:
00070 
00071     None.
00072 
00073 Return Value:
00074 
00075     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> code.
00076 
00077 --*/
00078 
00079 {
00080     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>            status;
00081     ULONG               disposition, tmpValue;
00082     WCHAR               buffer[<a class="code" href="../../d5/d0/pnpeisa_8c.html#a1">BUFFER_LENGTH</a>];
00083 
00084     UNICODE_STRING      unicodeString;
00085     HANDLE              rootHandle, deviceHandle, instanceHandle, logConfHandle;
00086 
00087     PCM_RESOURCE_LIST   resourceList;
00088     ULONG               resourceLength;
00089 
00090     status = <a class="code" href="../../d5/d0/pnpeisa_8c.html#a2">EisaGetEisaDevicesResources</a>(&amp;resourceList, &amp;resourceLength);
00091     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) || resourceList == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00092         <span class="keywordflow">return</span> STATUS_UNSUCCESSFUL;
00093     }
00094 
00095     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;unicodeString, L<span class="stringliteral">"\\Registry\\Machine\\System\\CurrentControlSet\\Enum\\Root"</span>);
00096     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;rootHandle,
00097                                    NULL,
00098                                    &amp;unicodeString,
00099                                    KEY_ALL_ACCESS
00100                                    );
00101 
00102     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00103         <span class="keywordflow">if</span> (resourceList) {
00104             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (resourceList);
00105         }
00106         <span class="keywordflow">return</span> status;
00107     }
00108 
00109     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;unicodeString, EISA_DEVICE_NODE_NAME);
00110     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a8">IopCreateRegistryKeyEx</a>( &amp;deviceHandle,
00111                                      rootHandle,
00112                                      &amp;unicodeString,
00113                                      KEY_ALL_ACCESS,
00114                                      REG_OPTION_NON_VOLATILE,
00115                                      NULL
00116                                      );
00117 
00118     ZwClose(rootHandle);
00119     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00120         <span class="keywordflow">if</span> (resourceList) {
00121             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (resourceList);
00122         }
00123         <span class="keywordflow">return</span> status;
00124     }
00125 
00126     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;unicodeString, L<span class="stringliteral">"0000"</span> );
00127     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a8">IopCreateRegistryKeyEx</a>( &amp;instanceHandle,
00128                                      deviceHandle,
00129                                      &amp;unicodeString,
00130                                      KEY_ALL_ACCESS,
00131                                      REG_OPTION_NON_VOLATILE,
00132                                      &amp;disposition );
00133     ZwClose(deviceHandle);
00134     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status))  {
00135         <span class="keywordflow">if</span> (disposition == REG_CREATED_NEW_KEY) {
00136 
00137             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;unicodeString, L<span class="stringliteral">"DeviceDesc"</span> );
00138             swprintf(buffer, L<span class="stringliteral">"%s"</span>, L<span class="stringliteral">"Device to report Eisa Slot Resources"</span>);
00139 
00140             ZwSetValueKey(instanceHandle,
00141                           &amp;unicodeString,
00142                           0,
00143                           REG_SZ,
00144                           buffer,
00145                           (wcslen(buffer) + 1) * <span class="keyword">sizeof</span>(WCHAR)
00146                           );
00147 
00148             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;unicodeString, L<span class="stringliteral">"HardwareID"</span> );
00149             RtlZeroMemory(buffer, BUFFER_LENGTH * <span class="keyword">sizeof</span>(WCHAR));
00150             swprintf(buffer, L<span class="stringliteral">"%s"</span>, L<span class="stringliteral">"*Eisa_Resource_Device"</span>);
00151 
00152             ZwSetValueKey(instanceHandle,
00153                           &amp;unicodeString,
00154                           0,
00155                           REG_MULTI_SZ,
00156                           buffer,
00157                           (wcslen(buffer) + 2) * <span class="keyword">sizeof</span>(WCHAR)
00158                           );
00159 
00160             PiWstrToUnicodeString(&amp;unicodeString, REGSTR_VALUE_CONFIG_FLAGS);
00161             tmpValue = 0;
00162             ZwSetValueKey(instanceHandle,
00163                          &amp;unicodeString,
00164                          TITLE_INDEX_VALUE,
00165                          REG_DWORD,
00166                          &amp;tmpValue,
00167                          <span class="keyword">sizeof</span>(tmpValue)
00168                          );
00169 
00170         }
00171 
00172         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;unicodeString, REGSTR_KEY_LOGCONF );
00173         status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a8">IopCreateRegistryKeyEx</a>( &amp;logConfHandle,
00174                                          instanceHandle,
00175                                          &amp;unicodeString,
00176                                          KEY_ALL_ACCESS,
00177                                          REG_OPTION_NON_VOLATILE,
00178                                          NULL
00179                                          );
00180         ZwClose(instanceHandle);
00181         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status))  {
00182             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;unicodeString, REGSTR_VAL_BOOTCONFIG );
00183 
00184             status = ZwSetValueKey(logConfHandle,
00185                                    &amp;unicodeString,
00186                                    0,
00187                                    REG_RESOURCE_LIST,
00188                                    resourceList,
00189                                    resourceLength
00190                                    );
00191             ZwClose(logConfHandle);
00192         }
00193     }
00194     <span class="keywordflow">if</span> (resourceList) {
00195         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (resourceList);
00196     }
00197     <span class="keywordflow">return</span> status;
00198 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="pnpeisa.c::EisaBuildSlotsResources" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS EisaBuildSlotsResources           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>SlotMasks</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>NumberMasks</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PCM_RESOURCE_LIST *&nbsp;</td>
          <td class="mdname" nowrap> <em>Resource</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT ULONG *&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d9/pnpeisa_8c-source.html#l00304">304</a> of file <a class="el" href="../../d6/d9/pnpeisa_8c-source.html">pnpeisa.c</a>.
<p>
References <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>.
<p>
Referenced by <a class="el" href="../../d6/d9/pnpeisa_8c-source.html#l00201">EisaGetEisaDevicesResources()</a>.
<p>
<pre class="fragment"><div>00313                    :
00314 
00315     This routine build a cm resource list <span class="keywordflow">for</span> all <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> io resources used
00316     by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> eisa devices.
00317 
00318 Arguments:
00319 
00320     SlotMask - a mask to indicate <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> valid eisa slot.
00321 
00322 Return Value:
00323 
00324     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to a CM_RESOURCE_LIST.
00325 
00326 --*/
00327 
00328 {
00329     PCM_RESOURCE_LIST resources = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00330     PCM_PARTIAL_RESOURCE_DESCRIPTOR partialDesc;
00331     ULONG slot;
00332 
00333     *Length = <span class="keyword">sizeof</span>(CM_RESOURCE_LIST) + <span class="keyword">sizeof</span>(CM_PARTIAL_RESOURCE_DESCRIPTOR) * (NumberMasks - 1);
00334     resources = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(PagedPool, *Length);
00335     <span class="keywordflow">if</span> (resources) {
00336         resources-&gt;Count = 1;
00337         resources-&gt;List[0].InterfaceType = Eisa;
00338         resources-&gt;List[0].BusNumber = 0;
00339         resources-&gt;List[0].PartialResourceList.Version = 0;
00340         resources-&gt;List[0].PartialResourceList.Revision = 0;
00341         resources-&gt;List[0].PartialResourceList.Count = NumberMasks;
00342         partialDesc = resources-&gt;List[0].PartialResourceList.PartialDescriptors;
00343         slot = 0; <span class="comment">// ignore slot 0</span>
00344         <span class="keywordflow">while</span> (SlotMasks) {
00345             SlotMasks &gt;&gt;= 1;
00346             slot++;
00347             <span class="keywordflow">if</span> (SlotMasks &amp; 1) {
00348                 partialDesc-&gt;Type = CmResourceTypePort;
00349                 partialDesc-&gt;ShareDisposition = CmResourceShareDeviceExclusive;
00350                 partialDesc-&gt;Flags = CM_RESOURCE_PORT_16_BIT_DECODE + CM_RESOURCE_PORT_IO;
00351                 partialDesc-&gt;u.Port.Start.LowPart = slot &lt;&lt; 12;
00352                 partialDesc-&gt;u.Port.Start.HighPart = 0;
00353                 partialDesc-&gt;u.Port.Length = 0x1000;
00354                 partialDesc++;
00355             }
00356         }
00357         *Resources = resources;
00358         <span class="keywordflow">return</span> STATUS_SUCCESS;
00359     } <span class="keywordflow">else</span> {
00360         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00361     }
00362 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="pnpeisa.c::EisaGetEisaDevicesResources" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS EisaGetEisaDevicesResources           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">OUT PCM_RESOURCE_LIST *&nbsp;</td>
          <td class="mdname" nowrap> <em>ResourceList</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ResourceLength</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d9/pnpeisa_8c-source.html#l00201">201</a> of file <a class="el" href="../../d6/d9/pnpeisa_8c-source.html">pnpeisa.c</a>.
<p>
References <a class="el" href="../../d6/d9/pnpeisa_8c-source.html#l00304">EisaBuildSlotsResources()</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l02546">IopGetRegistryValue()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l01104">IopOpenRegistryKeyEx()</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d3/d6/string_8c-source.html#l00148">RtlInitUnicodeString()</a>.
<p>
Referenced by <a class="el" href="../../d6/d9/pnpeisa_8c-source.html#l00059">EisaBuildEisaDeviceNode()</a>.
<p>
<pre class="fragment"><div>00208                    :
00209 
00210     This routine builds a cm resource list <span class="keywordflow">for</span> all <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> eisa slots.
00211 
00212 Arguments:
00213 
00214     None.
00215 
00216 Return Value:
00217 
00218     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> CmResourceList.
00219 
00220 --*/
00221 
00222 {
00223     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status = STATUS_SUCCESS;
00224     PCM_RESOURCE_LIST resources = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00225     HANDLE handle;
00226     PKEY_VALUE_FULL_INFORMATION keyValueInformation;
00227     UNICODE_STRING unicodeString;
00228     ULONG slotMasks = 0, numberMasks = 0, i;
00229 
00230     *ResourceList = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00231     *ResourceLength = 0;
00232 
00233     <span class="comment">//</span>
00234     <span class="comment">// Open LocalMachine\Hardware\Description</span>
00235     <span class="comment">//</span>
00236 
00237     <span class="comment">//RtlInitUnicodeString(&amp;unicodeString, L"\\REGISTRY\\MACHINE\\HARDWARE\\DESCRIPTION\\SYSTEM\\EisaAdapter\\0");</span>
00238     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;unicodeString, L<span class="stringliteral">"\\REGISTRY\\MACHINE\\SYSTEM\\CurrentControlSet\\EisaAdapter"</span>);
00239     status = <a class="code" href="../../d9/d1/pnpsubs_8c.html#a7">IopOpenRegistryKeyEx</a>( &amp;handle,
00240                                    NULL,
00241                                    &amp;unicodeString,
00242                                    KEY_READ
00243                                    );
00244     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00245         status = <a class="code" href="../../d6/d5/ioep_8h.html#a52">IopGetRegistryValue</a>(handle,
00246                                      L<span class="stringliteral">"Configuration Data"</span>,
00247                                      &amp;keyValueInformation
00248                                      );
00249         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00250             PCM_FULL_RESOURCE_DESCRIPTOR resourceDescriptor;
00251             PCM_PARTIAL_RESOURCE_DESCRIPTOR partialResourceDescriptor;
00252 
00253             resourceDescriptor = (PCM_FULL_RESOURCE_DESCRIPTOR)
00254                 ((PUCHAR) keyValueInformation + keyValueInformation-&gt;DataOffset);
00255 
00256             <span class="keywordflow">if</span> ((keyValueInformation-&gt;DataLength &gt;= <span class="keyword">sizeof</span>(CM_FULL_RESOURCE_DESCRIPTOR)) &amp;&amp;
00257                 (resourceDescriptor-&gt;PartialResourceList.Count &gt; 0) ) {
00258                 LONG eisaInfoLength;
00259                 PCM_EISA_SLOT_INFORMATION eisaInfo;
00260 
00261                 partialResourceDescriptor = resourceDescriptor-&gt;PartialResourceList.PartialDescriptors;
00262                 <span class="keywordflow">if</span> (partialResourceDescriptor-&gt;Type == CmResourceTypeDeviceSpecific) {
00263                     eisaInfo = (PCM_EISA_SLOT_INFORMATION)
00264                         ((PUCHAR)partialResourceDescriptor + <span class="keyword">sizeof</span>(CM_PARTIAL_RESOURCE_DESCRIPTOR));
00265                     eisaInfoLength = (LONG)partialResourceDescriptor-&gt;u.DeviceSpecificData.DataSize;
00266 
00267                     <span class="comment">//</span>
00268                     <span class="comment">// Parse the eisa slot info to find the eisa slots with device installed.</span>
00269                     <span class="comment">//</span>
00270 
00271                     <span class="keywordflow">for</span> (i = 0; i &lt; 0x10 &amp;&amp; eisaInfoLength &gt; 0; i++) {
00272                         <span class="keywordflow">if</span> (eisaInfo-&gt;ReturnCode == EISA_INVALID_SLOT) {
00273                             <span class="keywordflow">break</span>;
00274                         }
00275                         <span class="keywordflow">if</span> (eisaInfo-&gt;ReturnCode != EISA_EMPTY_SLOT &amp;&amp; (i != 0)) {
00276                             slotMasks |= (1 &lt;&lt; i);
00277                             numberMasks++;
00278                         }
00279                         <span class="keywordflow">if</span> (eisaInfo-&gt;ReturnCode == EISA_EMPTY_SLOT) {
00280                             eisaInfoLength -= <span class="keyword">sizeof</span>(CM_EISA_SLOT_INFORMATION);
00281                             eisaInfo++;
00282                         } <span class="keywordflow">else</span> {
00283                             eisaInfoLength -= <span class="keyword">sizeof</span>(CM_EISA_SLOT_INFORMATION) + eisaInfo-&gt;NumberFunctions * <span class="keyword">sizeof</span>(CM_EISA_FUNCTION_INFORMATION);
00284                             eisaInfo = (PCM_EISA_SLOT_INFORMATION)
00285                                        ((PUCHAR)eisaInfo + eisaInfo-&gt;NumberFunctions * <span class="keyword">sizeof</span>(CM_EISA_FUNCTION_INFORMATION) +
00286                                            <span class="keyword">sizeof</span>(CM_EISA_SLOT_INFORMATION));
00287                         }
00288                     }
00289 
00290                     <span class="keywordflow">if</span> (slotMasks) {
00291                         status = <a class="code" href="../../d5/d0/pnpeisa_8c.html#a3">EisaBuildSlotsResources</a>(slotMasks, numberMasks, ResourceList, ResourceLength);
00292                     }
00293                 }
00294 
00295             }
00296             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(keyValueInformation);
00297         }
00298         ZwClose(handle);
00299     }
00300     <span class="keywordflow">return</span> status;
00301 }

</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:45:10 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
