<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: csrutil.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>csrutil.c File Reference</h1><code>#include "<a class="el" href="../../d0/d9/csrdll_8h-source.html">csrdll.h</a>"</code><br>

<p>
<a href="../../d6/d9/csrutil_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d0/csrutil_8c.html#a0">CsrClientCallServer</a> (IN OUT PCSR_API_MSG m, IN OUT PCSR_CAPTURE_HEADER CaptureBuffer OPTIONAL, IN CSR_API_NUMBER ApiNumber, IN ULONG ArgLength)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PCSR_CAPTURE_HEADER&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d0/csrutil_8c.html#a1">CsrAllocateCaptureBuffer</a> (IN ULONG CountMessagePointers, IN ULONG <a class="el" href="../../d9/d7/w98_2lh__open_2pi__mem_8h.html#a0">Size</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d0/csrutil_8c.html#a2">CsrFreeCaptureBuffer</a> (IN PCSR_CAPTURE_HEADER CaptureBuffer)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d0/csrutil_8c.html#a3">CsrAllocateMessagePointer</a> (IN OUT PCSR_CAPTURE_HEADER CaptureBuffer, IN ULONG Length, OUT PVOID *Pointer)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d0/csrutil_8c.html#a4">CsrCaptureMessageBuffer</a> (IN OUT PCSR_CAPTURE_HEADER CaptureBuffer, IN PVOID <a class="el" href="../../d8/d6/ttri_8c.html#a3">Buffer</a> OPTIONAL, IN ULONG Length, OUT PVOID *CapturedBuffer)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d0/csrutil_8c.html#a5">CsrCaptureMessageString</a> (IN OUT PCSR_CAPTURE_HEADER CaptureBuffer, IN PCSTR <a class="el" href="../../d0/d0/tdetach_8c.html#a0">String</a> OPTIONAL, IN ULONG Length, IN ULONG MaximumLength, OUT PSTRING CapturedString)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PLARGE_INTEGER&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d0/csrutil_8c.html#a6">CsrCaptureTimeout</a> (IN ULONG MilliSeconds, OUT PLARGE_INTEGER Timeout)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d0/csrutil_8c.html#a7">CsrProbeForWrite</a> (IN PVOID Address, IN ULONG Length, IN ULONG Alignment)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d0/csrutil_8c.html#a8">CsrProbeForRead</a> (IN PVOID Address, IN ULONG Length, IN ULONG Alignment)</td></tr>

</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a1" doxytag="csrutil.c::CsrAllocateCaptureBuffer" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PCSR_CAPTURE_HEADER CsrAllocateCaptureBuffer           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>CountMessagePointers</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Size</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d9/csrutil_8c-source.html#l00223">223</a> of file <a class="el" href="../../d6/d9/csrutil_8c-source.html">csrutil.c</a>.
<p>
References <a class="el" href="../../d0/d9/csrdll_8h-source.html#l00167">CAPTURE_TAG</a>, <a class="el" href="../../d0/d9/csrdll_8h-source.html#l00160">CsrPortHeap</a>, <a class="el" href="../../d0/d9/csrdll_8h-source.html#l00165">MAKE_CSRPORT_TAG</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d4/d6/config_2utils_2regutil_8c-source.html#l00022">RtlAllocateHeap</a>, and <a class="el" href="../../d9/d6/lh__open_2pi__mem_8h-source.html#l00017">Size</a>.
<p>
<pre class="fragment"><div>00230                    :
00231 
00232     This function allocates a buffer from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Port Memory section <span class="keywordflow">for</span>
00233     use by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client in capture arguments into Port Memory.  In addition to
00234     specifying <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data that needs to be captured, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller
00235     needs to specify how many pointers to captured data will be passed.
00236     Pointers can be located in either <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> request message itself, and/or
00237     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> capture buffer.
00238 
00239 Arguments:
00240 
00241     CountMessagePointers - Number of pointers within <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> request message
00242         that will point to locations within <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> allocated capture buffer.
00243 
00244     <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> - Total size of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data that will be captured into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> capture
00245         buffer.
00246 
00247 Return Value:
00248 
00249     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> capture buffer header.
00250 
00251 --*/
00252 
00253 {
00254     PCSR_CAPTURE_HEADER CaptureBuffer;
00255     ULONG CountPointers;
00256 
00257     <span class="comment">//</span>
00258     <span class="comment">// Calculate the total number of pointers that will be passed</span>
00259     <span class="comment">//</span>
00260 
00261     CountPointers = CountMessagePointers;
00262 
00263     <span class="comment">//</span>
00264     <span class="comment">// Calculate the total size of the capture buffer.  This includes the</span>
00265     <span class="comment">// header, the array of pointer offsets and the data length.  We round</span>
00266     <span class="comment">// the data length to a 32-bit boundary, assuming that each pointer</span>
00267     <span class="comment">// points to data whose length is not aligned on a 32-bit boundary.</span>
00268     <span class="comment">//</span>
00269 
00270     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> &gt;= MAXLONG) {
00271         <span class="comment">//</span>
00272         <span class="comment">// Bail early if too big</span>
00273         <span class="comment">//</span>
00274         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00275         }
00276     <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> += FIELD_OFFSET(CSR_CAPTURE_HEADER, MessagePointerOffsets) + (CountPointers * <span class="keyword">sizeof</span>( PVOID ));
00277     <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = (<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> + (3 * (CountPointers+1))) &amp; ~3;
00278 
00279     <span class="comment">//</span>
00280     <span class="comment">// Allocate the capture buffer from the Port Memory Heap.</span>
00281     <span class="comment">//</span>
00282 
00283     CaptureBuffer = <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>( CsrPortHeap, <a class="code" href="../../d9/d9/csrdll_8h.html#a5">MAKE_CSRPORT_TAG</a>( CAPTURE_TAG ), Size );
00284     <span class="keywordflow">if</span> (CaptureBuffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00285 
00286         <span class="comment">//</span>
00287         <span class="comment">// FIX, FIX - need to attempt the receive lost reply messages to</span>
00288         <span class="comment">// to see if they contain CaptureBuffer pointers that can be freed.</span>
00289         <span class="comment">//</span>
00290 
00291         <span class="keywordflow">return</span>( <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00292     }
00293 
00294     <span class="comment">//</span>
00295     <span class="comment">// Initialize the capture buffer header</span>
00296     <span class="comment">//</span>
00297 
00298     CaptureBuffer-&gt;Length = <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
00299     CaptureBuffer-&gt;CountMessagePointers = 0;
00300 
00301     <span class="comment">//</span>
00302     <span class="comment">// If there are pointers being passed then initialize the arrays of</span>
00303     <span class="comment">// pointer offsets to zero.  In either case set the free space pointer</span>
00304     <span class="comment">// in the capture buffer header to point to the first 32-bit aligned</span>
00305     <span class="comment">// location after the header, the arrays of pointer offsets are considered</span>
00306     <span class="comment">// part of the header.</span>
00307     <span class="comment">//</span>
00308 
00309     RtlZeroMemory( CaptureBuffer-&gt;MessagePointerOffsets,
00310                    CountPointers * <span class="keyword">sizeof</span>( ULONG_PTR )
00311                  );
00312 
00313     CaptureBuffer-&gt;FreeSpace = (PCHAR)
00314         (CaptureBuffer-&gt;MessagePointerOffsets + CountPointers);
00315 
00316     <span class="comment">//</span>
00317     <span class="comment">// Returned the address of the capture buffer.</span>
00318     <span class="comment">//</span>
00319 
00320     <span class="keywordflow">return</span>( CaptureBuffer );
00321 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="csrutil.c::CsrAllocateMessagePointer" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG CsrAllocateMessagePointer           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT PCSR_CAPTURE_HEADER&nbsp;</td>
          <td class="mdname" nowrap> <em>CaptureBuffer</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>Pointer</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d9/csrutil_8c-source.html#l00356">356</a> of file <a class="el" href="../../d6/d9/csrutil_8c-source.html">csrutil.c</a>.
<p>
References <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>.
<p>
<pre class="fragment"><div>00364                    :
00365 
00366     This function allocates space from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> capture buffer along with a
00367     pointer to point to <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>.  The pointer <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> presumed to be located in
00368     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> request message structure.
00369 
00370 Arguments:
00371 
00372     CaptureBuffer - Pointer to a capture buffer allocated by
00373         <a class="code" href="../../d5/d0/csrutil_8c.html#a1">CsrAllocateCaptureBuffer</a>.
00374 
00375     Length - <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> of data being allocated from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> capture buffer.
00376 
00377     Pointer - Address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pointer within <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> request message that
00378         <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to point to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> space allocated <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> capture buffer.
00379 
00380 Return Value:
00381 
00382     The actual length of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer allocated, after <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> has been rounded
00383     up to a multiple of 4.
00384 
00385 --*/
00386 
00387 {
00388     <span class="keywordflow">if</span> (Length == 0) {
00389         *Pointer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00390         Pointer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00391         }
00392 
00393     <span class="keywordflow">else</span> {
00394 
00395         <span class="comment">//</span>
00396         <span class="comment">// Set the returned pointer value to point to the next free byte in</span>
00397         <span class="comment">// the capture buffer.</span>
00398         <span class="comment">//</span>
00399 
00400         *Pointer = CaptureBuffer-&gt;FreeSpace;
00401 
00402         <span class="comment">//</span>
00403         <span class="comment">// Round the length up to a multiple of 4</span>
00404         <span class="comment">//</span>
00405 
00406         <span class="keywordflow">if</span> (Length &gt;= MAXLONG) {
00407             <span class="comment">//</span>
00408             <span class="comment">// Bail early if too big</span>
00409             <span class="comment">//</span>
00410             <span class="keywordflow">return</span> 0;
00411             }
00412 
00413         Length = (Length + 3) &amp; ~3;
00414 
00415         <span class="comment">//</span>
00416         <span class="comment">// Update the free space pointer to point to the next available byte</span>
00417         <span class="comment">// in the capture buffer.</span>
00418         <span class="comment">//</span>
00419 
00420         CaptureBuffer-&gt;FreeSpace += Length;
00421         }
00422 
00423 
00424     <span class="comment">//</span>
00425     <span class="comment">// Remember the location of this pointer so that CsrClientCallServer can</span>
00426     <span class="comment">// convert it into a server pointer prior to sending the request to</span>
00427     <span class="comment">// the server.</span>
00428     <span class="comment">//</span>
00429 
00430     CaptureBuffer-&gt;MessagePointerOffsets[ CaptureBuffer-&gt;CountMessagePointers++ ] =
00431         (ULONG_PTR)Pointer;
00432 
00433     <span class="comment">//</span>
00434     <span class="comment">// Returned the actual length allocated.</span>
00435     <span class="comment">//</span>
00436 
00437     <span class="keywordflow">return</span>( Length );
00438 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="csrutil.c::CsrCaptureMessageBuffer" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID CsrCaptureMessageBuffer           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT PCSR_CAPTURE_HEADER&nbsp;</td>
          <td class="mdname" nowrap> <em>CaptureBuffer</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID <a class="el" href="../../d8/d6/ttri_8c.html#a3">Buffer</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>CapturedBuffer</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d9/csrutil_8c-source.html#l00442">442</a> of file <a class="el" href="../../d6/d9/csrutil_8c-source.html">csrutil.c</a>.
<p>
References <a class="el" href="../../d7/d1/rtqkey_8c-source.html#l00042">Buffer</a>, and <a class="el" href="../../d9/d8/wow64csr_8c-source.html#l00109">CsrAllocateMessagePointer()</a>.
<p>
<pre class="fragment"><div>00451                    :
00452 
00453     This function captures an ASCII string into a counted string data
00454     structure located in an API request message.
00455 
00456 Arguments:
00457 
00458     CaptureBuffer - Pointer to a capture buffer allocated by
00459         <a class="code" href="../../d5/d0/csrutil_8c.html#a1">CsrAllocateCaptureBuffer</a>.
00460 
00461     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> - Optional pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer.  If <span class="keyword">this</span> parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00462         not present, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> counted string data structure <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> set to
00463         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> null string and no space <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> allocated from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> capture
00464         buffer.
00465 
00466     Length - Length of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer.
00467 
00468     CaptureString - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> field in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> message that will
00469         be filled in to point to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> capture buffer.
00470 
00471 Return Value:
00472 
00473     None.
00474 
00475 --*/
00476 
00477 {
00478     <span class="comment">//</span>
00479     <span class="comment">// Set the length fields of the captured string structure and allocated</span>
00480     <span class="comment">// the Length for the string from the capture buffer.</span>
00481     <span class="comment">//</span>
00482 
00483     <a class="code" href="../../d8/d9/wow64csr_8c.html#a7">CsrAllocateMessagePointer</a>( CaptureBuffer,
00484                                Length,
00485                                CapturedBuffer
00486                              );
00487 
00488     <span class="comment">//</span>
00489     <span class="comment">// If Buffer parameter is not present or the length of the data is zero,</span>
00490     <span class="comment">// return.</span>
00491     <span class="comment">//</span>
00492 
00493     <span class="keywordflow">if</span> (!ARGUMENT_PRESENT( Buffer ) || (Length == 0)) {
00494         <span class="keywordflow">return</span>;
00495         }
00496 
00497     <span class="comment">//</span>
00498     <span class="comment">// Copy the buffer data to the capture area.</span>
00499     <span class="comment">//</span>
00500 
00501     RtlMoveMemory( *CapturedBuffer, Buffer, Length );
00502 
00503     <span class="keywordflow">return</span>;
00504 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="csrutil.c::CsrCaptureMessageString" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID CsrCaptureMessageString           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT PCSR_CAPTURE_HEADER&nbsp;</td>
          <td class="mdname" nowrap> <em>CaptureBuffer</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PCSTR <a class="el" href="../../d0/d0/tdetach_8c.html#a0">String</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>MaximumLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PSTRING&nbsp;</td>
          <td class="mdname" nowrap> <em>CapturedString</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d9/csrutil_8c-source.html#l00507">507</a> of file <a class="el" href="../../d6/d9/csrutil_8c-source.html">csrutil.c</a>.
<p>
References <a class="el" href="../../d9/d8/wow64csr_8c-source.html#l00109">CsrAllocateMessagePointer()</a>, <a class="el" href="../../d5/d8/talloc_8c-source.html#l00027">String</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
<pre class="fragment"><div>00517                    :
00518 
00519     This function captures an ASCII string into a counted string data
00520     structure located in an API request message.
00521 
00522 Arguments:
00523 
00524     CaptureBuffer - Pointer to a capture buffer allocated by
00525         <a class="code" href="../../d5/d0/csrutil_8c.html#a1">CsrAllocateCaptureBuffer</a>.
00526 
00527     <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a> - Optional pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ASCII string.  If <span class="keyword">this</span> parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00528         not present, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> counted string data structure <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> set to
00529         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> null string and no space <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> allocated from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> capture
00530         buffer.
00531 
00532     Length - Length of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ASCII string.
00533 
00534     MaximumLength - Maximum length of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> string.  Different <span class="keywordflow">for</span> null
00535         terminated strings, where Length does not include <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> null and
00536         MaximumLength does.
00537 
00538     CaptureString - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> counted string data structure that will
00539         be filled in to point to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> capture ASCII string.
00540 
00541 Return Value:
00542 
00543     None.
00544 
00545 --*/
00546 
00547 {
00548     <span class="comment">//</span>
00549     <span class="comment">// If String parameter is not present, then set the captured string</span>
00550     <span class="comment">// to be the null string and returned.</span>
00551     <span class="comment">//</span>
00552 
00553     <span class="keywordflow">if</span> (!ARGUMENT_PRESENT( String )) {
00554         CapturedString-&gt;Length = 0;
00555         CapturedString-&gt;MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)MaximumLength;
00556         <a class="code" href="../../d8/d9/wow64csr_8c.html#a7">CsrAllocateMessagePointer</a>( CaptureBuffer,
00557                                    MaximumLength,
00558                                    (PVOID *)&amp;CapturedString-&gt;Buffer
00559                                  );
00560         <span class="keywordflow">return</span>;
00561         }
00562 
00563     <span class="comment">//</span>
00564     <span class="comment">// Set the length fields of the captured string structure and allocated</span>
00565     <span class="comment">// the MaximumLength for the string from the capture buffer.</span>
00566     <span class="comment">//</span>
00567 
00568     CapturedString-&gt;Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)Length;
00569     CapturedString-&gt;MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)
00570         <a class="code" href="../../d8/d9/wow64csr_8c.html#a7">CsrAllocateMessagePointer</a>( CaptureBuffer,
00571                                    MaximumLength,
00572                                    (PVOID *)&amp;CapturedString-&gt;Buffer
00573                                  );
00574     <span class="comment">//</span>
00575     <span class="comment">// If the Length of the ASCII string is non-zero then move it to the</span>
00576     <span class="comment">// capture area.</span>
00577     <span class="comment">//</span>
00578 
00579     <span class="keywordflow">if</span> (Length != 0) {
00580         RtlMoveMemory( CapturedString-&gt;Buffer, String, MaximumLength );
00581         <span class="keywordflow">if</span> (CapturedString-&gt;Length &lt; CapturedString-&gt;MaximumLength) {
00582             CapturedString-&gt;Buffer[ CapturedString-&gt;Length ] = <span class="charliteral">'\0'</span>;
00583             }
00584         }
00585 
00586     <span class="keywordflow">return</span>;
00587 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="csrutil.c::CsrCaptureTimeout" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PLARGE_INTEGER CsrCaptureTimeout           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>MilliSeconds</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PLARGE_INTEGER&nbsp;</td>
          <td class="mdname" nowrap> <em>Timeout</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d9/csrutil_8c-source.html#l00592">592</a> of file <a class="el" href="../../d6/d9/csrutil_8c-source.html">csrutil.c</a>.
<p>
References <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>.
<p>
<pre class="fragment"><div>00596 {
00597     <span class="keywordflow">if</span> (MilliSeconds == -1) {
00598         <span class="keywordflow">return</span>( <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00599         }
00600     <span class="keywordflow">else</span> {
00601         Timeout-&gt;QuadPart = Int32x32To64( MilliSeconds, -10000 );
00602         <span class="keywordflow">return</span>( (PLARGE_INTEGER)Timeout );
00603         }
00604 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="csrutil.c::CsrClientCallServer" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS CsrClientCallServer           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT PCSR_API_MSG&nbsp;</td>
          <td class="mdname" nowrap> <em>m</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PCSR_CAPTURE_HEADER CaptureBuffer&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN CSR_API_NUMBER&nbsp;</td>
          <td class="mdname" nowrap> <em>ApiNumber</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ArgLength</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d9/csrutil_8c-source.html#l00025">25</a> of file <a class="el" href="../../d6/d9/csrutil_8c-source.html">csrutil.c</a>.
<p>
References <a class="el" href="../../d0/d9/csrdll_8h-source.html#l00150">CsrPortHandle</a>, <a class="el" href="../../d0/d9/csrdll_8h-source.html#l00161">CsrPortMemoryRemoteDelta</a>, <a class="el" href="../../d0/d9/csrdll_8h-source.html#l00114">CsrServerApiRoutine</a>, <a class="el" href="../../d0/d9/csrdll_8h-source.html#l00107">CsrServerProcess</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00144">IF_DEBUG</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d7/d6/lpcsend_8c-source.html#l00395">NtRequestWaitReplyPort()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
<pre class="fragment"><div>00034                    :
00035 
00036     This function sends an API request to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Windows Emulation Subsystem
00037     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a22">Server</a> and waits <span class="keywordflow">for</span> a reply.
00038 
00039 Arguments:
00040 
00041     m - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> API request message to send.
00042 
00043     CaptureBuffer - Optional pointer to a capture buffer located in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00044         Port Memory section that contains additional data being sent
00045         to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> server.  Since Port Memory <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> also visible to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> server,
00046         no data needs to be copied, but pointers to locations within <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00047         capture buffer need to be converted into pointers valid in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00048         server's process context, since <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> server's view of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Port Memory
00049         <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not at <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> same <span class="keyword">virtual</span> address as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client's view.
00050 
00051     ApiNumber - Small integer that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> API being called.
00052 
00053     ArgLength - Length, in bytes, of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> argument portion located at <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00054         end of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> request message.  Used to calculate <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00055         request message.
00056 
00057 Return Value:
00058 
00059     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> Code from either client or server
00060 
00061 --*/
00062 
00063 {
00064     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00065     PULONG_PTR PointerOffsets;
00066     ULONG CountPointers;
00067     ULONG_PTR Pointer;
00068 
00069     <span class="comment">//</span>
00070     <span class="comment">// Initialize the header of the message.</span>
00071     <span class="comment">//</span>
00072 
00073     <span class="keywordflow">if</span> ((LONG)ArgLength &lt; 0) {
00074         ArgLength = (ULONG)(-(LONG)ArgLength);
00075         m-&gt;h.u2.s2.Type = 0;
00076         }
00077     <span class="keywordflow">else</span> {
00078         m-&gt;h.u2.ZeroInit = 0;
00079         }
00080 
00081     ArgLength |= (ArgLength &lt;&lt; 16);
00082     ArgLength +=     ((<span class="keyword">sizeof</span>( CSR_API_MSG ) - <span class="keyword">sizeof</span>( m-&gt;u )) &lt;&lt; 16) |
00083                      (FIELD_OFFSET( CSR_API_MSG, u ) - <span class="keyword">sizeof</span>( m-&gt;h ));
00084     m-&gt;h.u1.Length = ArgLength;
00085     m-&gt;CaptureBuffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00086     m-&gt;ApiNumber = ApiNumber;
00087 
00088     <span class="comment">//</span>
00089     <span class="comment">// if the caller is within the server process, do the API call directly</span>
00090     <span class="comment">// and skip the capture buffer fixups and LPC call.</span>
00091     <span class="comment">//</span>
00092 
00093     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d9/csrdll_8h.html#a9">CsrServerProcess</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00094 
00095         <span class="comment">//</span>
00096         <span class="comment">// If the CaptureBuffer argument is present, then there is data located</span>
00097         <span class="comment">// in the Port Memory section that is being passed to the server.  All</span>
00098         <span class="comment">// Port Memory pointers need to be converted so they are valid in the</span>
00099         <span class="comment">// Server's view of the Port Memory.</span>
00100         <span class="comment">//</span>
00101 
00102         <span class="keywordflow">if</span> (ARGUMENT_PRESENT( CaptureBuffer )) {
00103             <span class="comment">//</span>
00104             <span class="comment">// Store a pointer to the capture buffer in the message that is valid</span>
00105             <span class="comment">// in the server process's context.</span>
00106             <span class="comment">//</span>
00107 
00108             m-&gt;CaptureBuffer = (PCSR_CAPTURE_HEADER)
00109                 ((PCHAR)CaptureBuffer + <a class="code" href="../../d9/d9/csrdll_8h.html#a17">CsrPortMemoryRemoteDelta</a>);
00110 
00111             <span class="comment">//</span>
00112             <span class="comment">// Mark the fact that we are done allocating space from the end of</span>
00113             <span class="comment">// the capture buffer.</span>
00114             <span class="comment">//</span>
00115 
00116             CaptureBuffer-&gt;FreeSpace = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00117 
00118             <span class="comment">//</span>
00119             <span class="comment">// Loop over all of the pointers to Port Memory within the message</span>
00120             <span class="comment">// itself and convert them into server pointers.  Also, convert</span>
00121             <span class="comment">// the pointers to pointers into offsets.</span>
00122             <span class="comment">//</span>
00123 
00124             PointerOffsets = CaptureBuffer-&gt;MessagePointerOffsets;
00125             CountPointers = CaptureBuffer-&gt;CountMessagePointers;
00126             <span class="keywordflow">while</span> (CountPointers--) {
00127                 Pointer = *PointerOffsets++;
00128                 <span class="keywordflow">if</span> (Pointer != 0) {
00129                     *(PULONG_PTR)Pointer += <a class="code" href="../../d9/d9/csrdll_8h.html#a17">CsrPortMemoryRemoteDelta</a>;
00130                     PointerOffsets[ -1 ] = Pointer - (ULONG_PTR)m;
00131                     }
00132                 }
00133             }
00134 
00135         <span class="comment">//</span>
00136         <span class="comment">// Send the request to the server and wait for a reply.  The wait is</span>
00137         <span class="comment">// NOT alertable, because ? FIX,FIX</span>
00138         <span class="comment">//</span>
00139 
00140         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d7/lpcsend_8c.html#a1">NtRequestWaitReplyPort</a>( CsrPortHandle,
00141                                          (PPORT_MESSAGE)m,
00142                                          (PPORT_MESSAGE)m
00143                                        );
00144         <span class="comment">//</span>
00145         <span class="comment">// If the CaptureBuffer argument is present then reverse what we did</span>
00146         <span class="comment">// to the pointers above so that the client side code can use them</span>
00147         <span class="comment">// again.</span>
00148         <span class="comment">//</span>
00149 
00150         <span class="keywordflow">if</span> (ARGUMENT_PRESENT( CaptureBuffer )) {
00151             <span class="comment">//</span>
00152             <span class="comment">// Convert the capture buffer pointer back to a client pointer.</span>
00153             <span class="comment">//</span>
00154 
00155             m-&gt;CaptureBuffer = (PCSR_CAPTURE_HEADER)
00156                 ((PCHAR)m-&gt;CaptureBuffer - <a class="code" href="../../d9/d9/csrdll_8h.html#a17">CsrPortMemoryRemoteDelta</a>);
00157 
00158             <span class="comment">//</span>
00159             <span class="comment">// Loop over all of the pointers to Port Memory within the message</span>
00160             <span class="comment">// itself and convert them into client pointers.  Also, convert</span>
00161             <span class="comment">// the offsets pointers to pointers into back into pointers</span>
00162             <span class="comment">//</span>
00163 
00164             PointerOffsets = CaptureBuffer-&gt;MessagePointerOffsets;
00165             CountPointers = CaptureBuffer-&gt;CountMessagePointers;
00166             <span class="keywordflow">while</span> (CountPointers--) {
00167                 Pointer = *PointerOffsets++;
00168                 <span class="keywordflow">if</span> (Pointer != 0) {
00169                     Pointer += (ULONG_PTR)m;
00170                     PointerOffsets[ -1 ] = Pointer;
00171                     *(PULONG_PTR)Pointer -= <a class="code" href="../../d9/d9/csrdll_8h.html#a17">CsrPortMemoryRemoteDelta</a>;
00172                     }
00173                 }
00174             }
00175 
00176         <span class="comment">//</span>
00177         <span class="comment">// Check for failed status and do something.</span>
00178         <span class="comment">//</span>
00179         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00180             <a class="code" href="../../d0/d9/ntosdef_8h.html#a9">IF_DEBUG</a> {
00181                 <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_PORT_DISCONNECTED &amp;&amp;
00182                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_INVALID_HANDLE
00183                    ) {
00184                     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"CSRDLL: NtRequestWaitReplyPort failed - Status == %X\n"</span>,
00185                               Status
00186                             );
00187                     }
00188                 }
00189 
00190             m-&gt;ReturnValue = <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00191             }
00192         }
00193     <span class="keywordflow">else</span> {
00194         m-&gt;h.ClientId = NtCurrentTeb()-&gt;ClientId;
00195         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = (<a class="code" href="../../d9/d9/csrdll_8h.html#a10">CsrServerApiRoutine</a>)((PCSR_API_MSG)m,
00196                                        (PCSR_API_MSG)m
00197                                       );
00198 
00199         <span class="comment">//</span>
00200         <span class="comment">// Check for failed status and do something.</span>
00201         <span class="comment">//</span>
00202 
00203         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00204             <a class="code" href="../../d0/d9/ntosdef_8h.html#a9">IF_DEBUG</a> {
00205                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"CSRDLL: Server side client call failed - Status == %X\n"</span>,
00206                           Status
00207                         );
00208                 }
00209 
00210             m-&gt;ReturnValue = <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00211             }
00212         }
00213 
00214     <span class="comment">//</span>
00215     <span class="comment">// The value of this function is whatever the server function returned.</span>
00216     <span class="comment">//</span>
00217 
00218     <span class="keywordflow">return</span>( m-&gt;ReturnValue );
00219 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="csrutil.c::CsrFreeCaptureBuffer" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID CsrFreeCaptureBuffer           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PCSR_CAPTURE_HEADER&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>CaptureBuffer</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d9/csrutil_8c-source.html#l00325">325</a> of file <a class="el" href="../../d6/d9/csrutil_8c-source.html">csrutil.c</a>.
<p>
References <a class="el" href="../../d0/d9/csrdll_8h-source.html#l00160">CsrPortHeap</a>, and <a class="el" href="../../d4/d6/config_2utils_2regutil_8c-source.html#l00023">RtlFreeHeap</a>.
<p>
<pre class="fragment"><div>00331                    :
00332 
00333     This function frees a capture buffer allocated by <a class="code" href="../../d5/d0/csrutil_8c.html#a1">CsrAllocateCaptureBuffer</a>.
00334 
00335 Arguments:
00336 
00337     CaptureBuffer - Pointer to a capture buffer allocated by
00338         <a class="code" href="../../d5/d0/csrutil_8c.html#a1">CsrAllocateCaptureBuffer</a>.
00339 
00340 Return Value:
00341 
00342     None.
00343 
00344 --*/
00345 
00346 {
00347     <span class="comment">//</span>
00348     <span class="comment">// Free the capture buffer back to the Port Memory heap.</span>
00349     <span class="comment">//</span>
00350 
00351     <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>( CsrPortHeap, 0, CaptureBuffer );
00352 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="csrutil.c::CsrProbeForRead" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID CsrProbeForRead           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Address</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Alignment</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d9/csrutil_8c-source.html#l00678">678</a> of file <a class="el" href="../../d6/d9/csrutil_8c-source.html">csrutil.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d0/bench_8c-source.html#l00050">CHAR</a>, and <a class="el" href="../../d0/d9/ppc_2exdsptch_8c-source.html#l00563">RtlRaiseStatus()</a>.
<p>
<pre class="fragment"><div>00686                    :
00687 
00688     This function probes a structure <span class="keywordflow">for</span> read accessibility.
00689     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> structure <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not accessible, then an exception <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> raised.
00690 
00691 Arguments:
00692 
00693     Address - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> structure to be probed.
00694 
00695     Length - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> structure.
00696 
00697     Alignment - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> required alignment of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> structure expressed
00698         as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of bytes in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> primitive datatype (e.g., 1 <span class="keywordflow">for</span> <span class="keywordtype">char</span>,
00699         2 <span class="keywordflow">for</span> <span class="keywordtype">short</span>, 4 <span class="keywordflow">for</span> <span class="keywordtype">long</span>, and 8 <span class="keywordflow">for</span> quad).
00700 
00701 Return Value:
00702 
00703     None.
00704 
00705 --*/
00706 
00707 {
00708     <span class="keyword">volatile</span> <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> *StartAddress;
00709     <span class="keyword">volatile</span> <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> *EndAddress;
00710     <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> Temp;
00711 
00712     <span class="comment">//</span>
00713     <span class="comment">// If the structure has zero length, then do not probe the structure for</span>
00714     <span class="comment">// read accessibility or alignment.</span>
00715     <span class="comment">//</span>
00716 
00717     <span class="keywordflow">if</span> (Length != 0) {
00718 
00719         <span class="comment">//</span>
00720         <span class="comment">// If the structure is not properly aligned, then raise a data</span>
00721         <span class="comment">// misalignment exception.</span>
00722         <span class="comment">//</span>
00723 
00724         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((Alignment == 1) || (Alignment == 2) ||
00725                (Alignment == 4) || (Alignment == 8));
00726         StartAddress = (<span class="keyword">volatile</span> <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> *)Address;
00727 
00728         <span class="keywordflow">if</span> (((ULONG_PTR)StartAddress &amp; (Alignment - 1)) != 0) {
00729             <a class="code" href="../../d9/d9/ppc_2exdsptch_8c.html#a10">RtlRaiseStatus</a>(STATUS_DATATYPE_MISALIGNMENT);
00730         } <span class="keywordflow">else</span> {
00731             Temp = *StartAddress;
00732             EndAddress = StartAddress + Length - 1;
00733             Temp = *EndAddress;
00734         }
00735     }
00736 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="csrutil.c::CsrProbeForWrite" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID CsrProbeForWrite           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Address</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Alignment</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d9/csrutil_8c-source.html#l00607">607</a> of file <a class="el" href="../../d6/d9/csrutil_8c-source.html">csrutil.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d0/bench_8c-source.html#l00050">CHAR</a>, <a class="el" href="../../d0/d9/csrdll_8h-source.html#l00122">CsrNtSysInfo</a>, and <a class="el" href="../../d0/d9/ppc_2exdsptch_8c-source.html#l00563">RtlRaiseStatus()</a>.
<p>
<pre class="fragment"><div>00615                    :
00616 
00617     This function probes a structure <span class="keywordflow">for</span> read accessibility.
00618     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> structure <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not accessible, then an exception <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> raised.
00619 
00620 Arguments:
00621 
00622     Address - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> structure to be probed.
00623 
00624     Length - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> structure.
00625 
00626     Alignment - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> required alignment of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> structure expressed
00627         as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of bytes in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> primitive datatype (e.g., 1 <span class="keywordflow">for</span> <span class="keywordtype">char</span>,
00628         2 <span class="keywordflow">for</span> <span class="keywordtype">short</span>, 4 <span class="keywordflow">for</span> <span class="keywordtype">long</span>, and 8 <span class="keywordflow">for</span> quad).
00629 
00630 Return Value:
00631 
00632     None.
00633 
00634 --*/
00635 
00636 {
00637     <span class="keyword">volatile</span> <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> *StartAddress;
00638     <span class="keyword">volatile</span> <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> *EndAddress;
00639     <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> Temp;
00640 
00641     <span class="comment">//</span>
00642     <span class="comment">// If the structure has zero length, then do not probe the structure for</span>
00643     <span class="comment">// write accessibility or alignment.</span>
00644     <span class="comment">//</span>
00645 
00646     <span class="keywordflow">if</span> (Length != 0) {
00647 
00648         <span class="comment">//</span>
00649         <span class="comment">// If the structure is not properly aligned, then raise a data</span>
00650         <span class="comment">// misalignment exception.</span>
00651         <span class="comment">//</span>
00652 
00653         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((Alignment == 1) || (Alignment == 2) ||
00654                (Alignment == 4) || (Alignment == 8));
00655         StartAddress = (<span class="keyword">volatile</span> <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> *)Address;
00656 
00657         <span class="keywordflow">if</span> (((ULONG_PTR)StartAddress &amp; (Alignment - 1)) != 0) {
00658             <a class="code" href="../../d9/d9/ppc_2exdsptch_8c.html#a10">RtlRaiseStatus</a>(STATUS_DATATYPE_MISALIGNMENT);
00659         } <span class="keywordflow">else</span> {
00660             <span class="comment">//</span>
00661             <span class="comment">// BUG, BUG - this should not be necessary once the 386 kernel</span>
00662             <span class="comment">// makes system space inaccessable to user mode.</span>
00663             <span class="comment">//</span>
00664             <span class="keywordflow">if</span> ((ULONG_PTR)StartAddress &gt; <a class="code" href="../../d9/d9/csrdll_8h.html#a11">CsrNtSysInfo</a>.MaximumUserModeAddress) {
00665                 <a class="code" href="../../d9/d9/ppc_2exdsptch_8c.html#a10">RtlRaiseStatus</a>(STATUS_ACCESS_VIOLATION);
00666             }
00667 
00668             Temp = *StartAddress;
00669             *StartAddress = Temp;
00670             EndAddress = StartAddress + Length - 1;
00671             Temp = *EndAddress;
00672             *EndAddress = Temp;
00673         }
00674     }
00675 }

</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:43:20 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
