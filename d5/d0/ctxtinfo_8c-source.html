<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: ctxtinfo.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>ctxtinfo.c</h1><a href="../../d4/d1/ctxtinfo_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/**************************************************************************\</span>
00002 <span class="comment">* Module Name: ctxtinfo.c</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00005 <span class="comment">*</span>
00006 <span class="comment">* Get/set routines of various Input context information for imm32.dll</span>
00007 <span class="comment">*</span>
00008 <span class="comment">* History:</span>
00009 <span class="comment">* 26-Feb-1996 wkwok</span>
00010 <span class="comment">\**************************************************************************/</span>
00011 
00012 <span class="preprocessor">#include "<a class="code" href="../../d8/d3/w32_2ntuser_2imm_2precomp_8h.html">precomp.h</a>"</span>
00013 <span class="preprocessor">#pragma hdrstop</span>
00014 <span class="preprocessor"></span>
00015 <span class="comment">// Helper function:</span>
00016 <span class="comment">// Converts RECONVERTSTRING structure between ANSI and UNICODE.</span>
00017 <span class="keyword">extern</span> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a6">ImmReconversionWorker</a>(LPRECONVERTSTRING lpRecTo, LPRECONVERTSTRING lpRecFrom, BOOL bToAnsi, DWORD dwCodePage);
00018 
00019 
<a name="l00020"></a><a class="code" href="../../d4/d1/ctxtinfo_8c.html#a7">00020</a> <span class="keywordtype">int</span> <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a7">UnicodeToMultiByteSize</a>(DWORD dwCodePage, LPCWSTR pwstr)
00021 {
00022     <span class="keywordtype">char</span> <a class="code" href="../../d0/d2/config_2test_2init386_8c.html#a0">dummy</a>[2], *lpszDummy = <a class="code" href="../../d0/d2/config_2test_2init386_8c.html#a0">dummy</a>;
00023     <span class="keywordflow">return</span> WCSToMBEx((WORD)dwCodePage, pwstr, 1, &amp;lpszDummy, <span class="keyword">sizeof</span>(WCHAR), <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00024 }
00025 
00026 
00027 <span class="comment">/***************************************************************************\</span>
00028 <span class="comment">* ImmGetCompositionStringA</span>
00029 <span class="comment">*</span>
00030 <span class="comment">* Query composition string information specified by dwIndex.</span>
00031 <span class="comment">*</span>
00032 <span class="comment">* History:</span>
00033 <span class="comment">* 28-Feb-1995   wkwok   Created</span>
00034 <span class="comment">\***************************************************************************/</span>
00035 
<a name="l00036"></a><a class="code" href="../../d4/d1/ctxtinfo_8c.html#a8">00036</a> LONG WINAPI <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a8">ImmGetCompositionStringA</a>(
00037     HIMC   hImc,
00038     DWORD  dwIndex,
00039     LPVOID lpBuf,
00040     DWORD  dwBufLen)
00041 {
00042     <a class="code" href="../../d3/d0/structtagCLIENTIMC.html">PCLIENTIMC</a>     pClientImc;
00043     PINPUTCONTEXT  pInputContext;
00044     PCOMPOSITIONSTRING pCompStr;
00045     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>           fAnsi;
00046     LONG           lRet = 0;
00047     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>          dwCodePage;
00048 
00049     <span class="keywordflow">if</span> (dwBufLen != 0 &amp;&amp; lpBuf == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00050         RIPMSG0(RIP_WARNING, <span class="stringliteral">"ImmGetCompositionStringW: NULL lpBuf."</span>);
00051         <span class="keywordflow">return</span> lRet;
00052     }
00053 
00054     pClientImc = <a class="code" href="../../d9/d0/immuser_8h.html#a43">ImmLockClientImc</a>(hImc);
00055     <span class="keywordflow">if</span> (pClientImc == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00056         RIPMSG1(RIP_WARNING,
00057               <span class="stringliteral">"ImmGetCompositionStringA: Invalid hImc %lx."</span>, hImc);
00058         <span class="keywordflow">return</span> lRet;
00059     }
00060 
00061     fAnsi = !<a class="code" href="../../d4/d0/immcli_8h.html#a21">TestICF</a>(pClientImc, <a class="code" href="../../d8/d0/immstruc_8h.html#a4">IMCF_UNICODE</a>);
00062     dwCodePage = <a class="code" href="../../d4/d0/immcli_8h.html#a26">CImcCodePage</a>(pClientImc);
00063 
00064     <a class="code" href="../../d9/d0/immuser_8h.html#a44">ImmUnlockClientImc</a>(pClientImc);
00065 
00066     pInputContext = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a12">ImmLockIMC</a>(hImc);
00067     <span class="keywordflow">if</span> (pInputContext == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00068         RIPMSG1(RIP_WARNING, <span class="stringliteral">"ImmGetCompositionStringA: Lock hImc %lx failed."</span>, hImc);
00069         <span class="keywordflow">return</span> lRet;
00070     }
00071 
00072     pCompStr = (PCOMPOSITIONSTRING)<a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a17">ImmLockIMCC</a>(pInputContext-&gt;hCompStr);
00073     <span class="keywordflow">if</span> (pCompStr == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00074         RIPMSG1(RIP_WARNING, <span class="stringliteral">"ImmGetCompositionStringA: Lock hCompStr %x failed"</span>,
00075               pInputContext-&gt;hCompStr);
00076         <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a13">ImmUnlockIMC</a>(hImc);
00077         <span class="keywordflow">return</span> lRet;
00078     }
00079 
00080     lRet = <a class="code" href="../../d4/d0/immcli_8h.html#a77">InternalGetCompositionStringA</a>(pCompStr, dwIndex,
00081                      lpBuf, dwBufLen, fAnsi, dwCodePage);
00082 
00083     <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a18">ImmUnlockIMCC</a>(pInputContext-&gt;hCompStr);
00084     <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a13">ImmUnlockIMC</a>(hImc);
00085 
00086     <span class="keywordflow">return</span> lRet;
00087 }
00088 
00089 
00090 <span class="comment">/***************************************************************************\</span>
00091 <span class="comment">* ImmGetCompositionStringA</span>
00092 <span class="comment">*</span>
00093 <span class="comment">* Query composition string information specified by dwIndex.</span>
00094 <span class="comment">*</span>
00095 <span class="comment">* History:</span>
00096 <span class="comment">* 28-Feb-1995   wkwok   Created</span>
00097 <span class="comment">\***************************************************************************/</span>
00098 
<a name="l00099"></a><a class="code" href="../../d4/d1/ctxtinfo_8c.html#a9">00099</a> LONG WINAPI <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a9">ImmGetCompositionStringW</a>(
00100     HIMC   hImc,
00101     DWORD  dwIndex,
00102     LPVOID lpBuf,
00103     DWORD  dwBufLen)
00104 {
00105     <a class="code" href="../../d3/d0/structtagCLIENTIMC.html">PCLIENTIMC</a>     pClientImc;
00106     PINPUTCONTEXT  pInputContext;
00107     PCOMPOSITIONSTRING pCompStr;
00108     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>           fAnsi;
00109     LONG           lRet = 0;
00110     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>          dwCodePage;
00111 
00112     <span class="keywordflow">if</span> (dwBufLen != 0 &amp;&amp; lpBuf == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00113         RIPMSG0(RIP_WARNING, <span class="stringliteral">"ImmGetCompositionStringW: NULL lpBuf."</span>);
00114         <span class="keywordflow">return</span> lRet;
00115     }
00116 
00117     pClientImc = <a class="code" href="../../d9/d0/immuser_8h.html#a43">ImmLockClientImc</a>(hImc);
00118     <span class="keywordflow">if</span> (pClientImc == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00119         RIPMSG1(RIP_WARNING,
00120               <span class="stringliteral">"ImmGetCompositionStringW: Invalid hImc %lx."</span>, hImc);
00121         <span class="keywordflow">return</span> lRet;
00122     }
00123 
00124     fAnsi = !<a class="code" href="../../d4/d0/immcli_8h.html#a21">TestICF</a>(pClientImc, <a class="code" href="../../d8/d0/immstruc_8h.html#a4">IMCF_UNICODE</a>);
00125     dwCodePage = <a class="code" href="../../d4/d0/immcli_8h.html#a26">CImcCodePage</a>(pClientImc);
00126 
00127     <a class="code" href="../../d9/d0/immuser_8h.html#a44">ImmUnlockClientImc</a>(pClientImc);
00128 
00129     pInputContext = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a12">ImmLockIMC</a>(hImc);
00130     <span class="keywordflow">if</span> (pInputContext == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00131         RIPMSG1(RIP_WARNING, <span class="stringliteral">"ImmGetCompositionStringW: Lock hImc %lx failed."</span>, hImc);
00132         <span class="keywordflow">return</span> lRet;
00133     }
00134 
00135     pCompStr = (PCOMPOSITIONSTRING)<a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a17">ImmLockIMCC</a>(pInputContext-&gt;hCompStr);
00136     <span class="keywordflow">if</span> (pCompStr == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00137         RIPMSG1(RIP_WARNING, <span class="stringliteral">"ImmGetCompositionStringA: Lock hCompStr %x failed"</span>,
00138               pInputContext-&gt;hCompStr);
00139         <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a13">ImmUnlockIMC</a>(hImc);
00140         <span class="keywordflow">return</span> lRet;
00141     }
00142 
00143     lRet = <a class="code" href="../../d4/d0/immcli_8h.html#a78">InternalGetCompositionStringW</a>(pCompStr, dwIndex,
00144                      lpBuf, dwBufLen, fAnsi, dwCodePage);
00145 
00146     <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a18">ImmUnlockIMCC</a>(pInputContext-&gt;hCompStr);
00147     <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a13">ImmUnlockIMC</a>(hImc);
00148 
00149     <span class="keywordflow">return</span> lRet;
00150 }
00151 
00152 
00153 <span class="comment">/***************************************************************************\</span>
00154 <span class="comment">* ImmSetCompositionStringA</span>
00155 <span class="comment">*</span>
00156 <span class="comment">* Set composition string information specified by dwIndex.</span>
00157 <span class="comment">*</span>
00158 <span class="comment">* History:</span>
00159 <span class="comment">* 28-Feb-1995   wkwok   Created</span>
00160 <span class="comment">\***************************************************************************/</span>
00161 
<a name="l00162"></a><a class="code" href="../../d4/d1/ctxtinfo_8c.html#a10">00162</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> WINAPI <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a10">ImmSetCompositionStringA</a>(
00163     HIMC    hImc,
00164     DWORD   dwIndex,
00165     LPVOID lpComp,
00166     DWORD   dwCompLen,
00167     LPVOID lpRead,
00168     DWORD   dwReadLen)
00169 {
00170     <span class="keywordflow">return</span> <a class="code" href="../../d4/d0/immcli_8h.html#a73">ImmSetCompositionStringWorker</a>(hImc, dwIndex, lpComp,
00171                                 dwCompLen, lpRead, dwReadLen, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00172 }
00173 
00174 
00175 <span class="comment">/***************************************************************************\</span>
00176 <span class="comment">* ImmSetCompositionStringW</span>
00177 <span class="comment">*</span>
00178 <span class="comment">* Set composition string information specified by dwIndex.</span>
00179 <span class="comment">*</span>
00180 <span class="comment">* History:</span>
00181 <span class="comment">* 28-Feb-1995   wkwok   Created</span>
00182 <span class="comment">\***************************************************************************/</span>
00183 
<a name="l00184"></a><a class="code" href="../../d4/d1/ctxtinfo_8c.html#a11">00184</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> WINAPI <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a11">ImmSetCompositionStringW</a>(
00185     HIMC    hImc,
00186     DWORD   dwIndex,
00187     LPVOID lpComp,
00188     DWORD   dwCompLen,
00189     LPVOID lpRead,
00190     DWORD   dwReadLen)
00191 {
00192     <span class="keywordflow">return</span> <a class="code" href="../../d4/d0/immcli_8h.html#a73">ImmSetCompositionStringWorker</a>(hImc, dwIndex, lpComp,
00193                                 dwCompLen, lpRead, dwReadLen, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00194 }
00195 
00196 
<a name="l00197"></a><a class="code" href="../../d4/d1/ctxtinfo_8c.html#a12">00197</a> LONG <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a12">CompositionString</a>(
00198     HIMC               hImc,
00199     PINPUTCONTEXT      *ppInputContext,
00200     PCOMPOSITIONSTRING *ppCompStr,
00201     BOOL               fCheckSize)
00202 {
00203     PINPUTCONTEXT      pInputContext;
00204     PCOMPOSITIONSTRING pCompStr;
00205 
00206     pInputContext = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a12">ImmLockIMC</a>(hImc);
00207     <span class="keywordflow">if</span> (!pInputContext) {
00208         RIPMSG1(RIP_WARNING, <span class="stringliteral">"CompositionString: Lock hImc %lx failed."</span>, hImc);
00209         <span class="keywordflow">return</span> (LONG)IMM_ERROR_GENERAL;
00210     }
00211 
00212     <span class="keywordflow">if</span> (!pInputContext-&gt;hCompStr) {
00213         <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a13">ImmUnlockIMC</a>(hImc);
00214         <span class="keywordflow">return</span> (LONG)IMM_ERROR_NODATA;
00215     }
00216 
00217     pCompStr = (PCOMPOSITIONSTRING)<a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a17">ImmLockIMCC</a>(pInputContext-&gt;hCompStr);
00218     <span class="keywordflow">if</span> (!pCompStr) {
00219         RIPMSG1(RIP_WARNING,
00220               <span class="stringliteral">"CompositionString: Lock hCompStr %lx failed."</span>, pInputContext-&gt;hCompStr);
00221         <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a13">ImmUnlockIMC</a>(hImc);
00222         <span class="keywordflow">return</span> (LONG)IMM_ERROR_GENERAL;
00223     }
00224 
00225     <span class="keywordflow">if</span> (fCheckSize &amp;&amp; pCompStr-&gt;dwSize &lt; <span class="keyword">sizeof</span>(COMPOSITIONSTRING)) {
00226         RIPMSG0(RIP_WARNING, <span class="stringliteral">"CompositionString: no composition string."</span>);
00227         <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a18">ImmUnlockIMCC</a>(pInputContext-&gt;hCompStr);
00228         <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a13">ImmUnlockIMC</a>(hImc);
00229         <span class="keywordflow">return</span> (LONG)IMM_ERROR_NODATA;
00230     }
00231 
00232     *ppInputContext = pInputContext;
00233     *ppCompStr = pCompStr;
00234 
00235     <span class="keywordflow">return</span> (1);
00236 }
00237 
00238 
<a name="l00239"></a><a class="code" href="../../d4/d1/ctxtinfo_8c.html#a13">00239</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a13">CheckAttribute</a>(
00240     LPBYTE  lpComp,        <span class="comment">// the attr from apps</span>
00241     DWORD   dwCompLen,     <span class="comment">// the attr length from apps</span>
00242     LPBYTE  lpAttr,        <span class="comment">// the attr from IMC</span>
00243     DWORD   dwAttrLen,     <span class="comment">// the attr length from IMC</span>
00244     LPDWORD lpClause,      <span class="comment">// the clause from IMC</span>
00245     DWORD   dwClauseLen)   <span class="comment">// the clause length from IMC</span>
00246 {
00247     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwCnt;
00248     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwBound;
00249     <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> bAttr;
00250 
00251     UNREFERENCED_PARAMETER(dwClauseLen);
00252 
00253     <span class="keywordflow">if</span> (!lpClause) {
00254         RIPMSG0(RIP_WARNING, <span class="stringliteral">"CheckAttribute: no Clause. Pass it to IME."</span>);
00255         <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00256     }
00257 
00258     <span class="keywordflow">if</span> (!lpAttr) {
00259         RIPMSG0(RIP_WARNING, <span class="stringliteral">"CheckAttribute: no Attr. Not pass it to IME."</span>);
00260         <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00261     }
00262 
00263     <span class="keywordflow">if</span> (dwCompLen != dwAttrLen) {
00264         RIPMSG0(RIP_WARNING, <span class="stringliteral">"CheckAttribute: wrong length. Not pass it to IME."</span>);
00265         <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00266     }
00267 
00268     <span class="comment">/*</span>
00269 <span class="comment">     * The attr. of chars of one clause have to be same.</span>
00270 <span class="comment">     */</span>
00271     <span class="keywordflow">while</span> (*lpClause &lt; dwCompLen) {
00272         dwBound = *(lpClause+1) - *lpClause;
00273         bAttr = *lpComp++;
00274         <span class="keywordflow">for</span> (dwCnt = 1; dwCnt &lt; dwBound; dwCnt++)
00275             <span class="keywordflow">if</span> (bAttr != *lpComp++) {
00276                 RIPMSG0(RIP_WARNING,
00277                       <span class="stringliteral">"CheckAttribute: mismatch clause att. Not Pass it to IME"</span>);
00278                 <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00279             }
00280         lpClause++;
00281     }
00282 
00283     <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00284 }
00285 
00286 
<a name="l00287"></a><a class="code" href="../../d4/d1/ctxtinfo_8c.html#a14">00287</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a14">CheckClause</a>(
00288     LPDWORD lpComp,        <span class="comment">// the clause from apps</span>
00289     DWORD   dwCompLen,     <span class="comment">// the clause length from apps</span>
00290     LPDWORD lpClause,      <span class="comment">// the clause from IMC</span>
00291     DWORD   dwClauseLen)   <span class="comment">// the clause length from IMC</span>
00292 {
00293     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> nCnt;
00294     <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>  diff = 0;
00295 
00296     <span class="keywordflow">if</span> (!dwClauseLen || !dwCompLen) {
00297         RIPMSG0(RIP_WARNING, <span class="stringliteral">"CheckClause: no Clause. Not Pass it to IME."</span>);
00298         <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00299     }
00300 
00301     <span class="keywordflow">if</span> (*lpComp || *lpClause) {
00302         RIPMSG0(RIP_WARNING, <span class="stringliteral">"CheckClause: lpClause[0] have to be ZERO."</span>);
00303         <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00304     }
00305 
00306     <span class="keywordflow">for</span> (nCnt = 0; nCnt &lt; (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)(dwClauseLen/4); nCnt++)
00307     {
00308         <span class="keywordflow">if</span> (*lpComp++ != *lpClause++)
00309         {
00310             diff++;
00311             <span class="keywordflow">if</span> (dwCompLen &gt; dwClauseLen)
00312                 lpClause--;
00313             <span class="keywordflow">if</span> (dwCompLen &lt; dwClauseLen)
00314                 lpComp--;
00315         }
00316         <span class="keywordflow">if</span> (diff &gt; 1)
00317             <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00318     }
00319 
00320     <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00321 }
00322 
00323 
<a name="l00324"></a><a class="code" href="../../d4/d1/ctxtinfo_8c.html#a15">00324</a> LPBYTE <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a15">InternalSCS_SETSTR</a>(
00325     LPCVOID  lpCompRead,
00326     DWORD    dwCompReadLen,
00327     LPVOID  *lplpNewCompRead,
00328     DWORD   *lpdwNewCompReadLen,
00329     BOOL     fAnsi,
00330     DWORD    dwCodePage)
00331 {
00332     LPBYTE   lpBufRet;
00333     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>    dwBufSize;
00334     LPSTR    lpBufA;
00335     LPWSTR   lpBufW;
00336     <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>      i;
00337     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>     bUDC;
00338 
00339     <span class="keywordflow">if</span> (lpCompRead == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || dwCompReadLen == 0)
00340         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00341 
00342     dwBufSize = dwCompReadLen * <span class="keyword">sizeof</span>(WCHAR) * 2;
00343 
00344     lpBufRet = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a22">ImmLocalAlloc</a>(0, dwBufSize);
00345     <span class="keywordflow">if</span> (lpBufRet == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00346         RIPMSG0(RIP_WARNING, <span class="stringliteral">"InternalSCS_SETSTR: memory failure."</span>);
00347         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00348     }
00349 
00350     lpBufW = (LPWSTR)lpBufRet;
00351     lpBufA = (LPSTR)(lpBufW + dwCompReadLen);
00352 
00353     <span class="keywordflow">if</span> (fAnsi) {
00354 
00355         RtlCopyMemory(lpBufA, lpCompRead, dwCompReadLen);
00356 
00357         i = MultiByteToWideChar(dwCodePage,
00358                                 (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)MB_PRECOMPOSED,
00359                                 (LPSTR)lpBufA,                  <span class="comment">// src</span>
00360                                 (<a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>)dwCompReadLen,
00361                                 (LPWSTR)lpBufW,                 <span class="comment">// dest</span>
00362                                 (<a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>)dwCompReadLen);
00363 
00364         *lplpNewCompRead    = lpBufW;
00365         *lpdwNewCompReadLen = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)(i * <span class="keyword">sizeof</span>(WCHAR));
00366     }
00367     <span class="keywordflow">else</span> {
00368 
00369         RtlCopyMemory(lpBufW, lpCompRead, dwCompReadLen);
00370 
00371         i = WideCharToMultiByte(dwCodePage,
00372                                 (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)0,
00373                                 lpBufW,                         <span class="comment">// src</span>
00374                                 (<a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>)dwCompReadLen/<span class="keyword">sizeof</span>(WCHAR),
00375                                 (LPSTR)lpBufA,                  <span class="comment">// dest</span>
00376                                 (<a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>)dwCompReadLen,
00377                                 (LPSTR)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00378                                 (LPBOOL)&amp;bUDC);
00379 
00380         *lplpNewCompRead    = lpBufA;
00381         *lpdwNewCompReadLen = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)(i * <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>));
00382     }
00383 
00384     <span class="keywordflow">return</span> lpBufRet;
00385 }
00386 
00387 
<a name="l00388"></a><a class="code" href="../../d4/d1/ctxtinfo_8c.html#a16">00388</a> LPBYTE <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a16">InternalSCS_CHANGEATTR</a>(
00389     HIMC     hImc,
00390     LPCVOID  lpCompRead,
00391     DWORD    dwCompReadLen,
00392     DWORD    dwIndex,
00393     LPVOID  *lplpNewCompRead,
00394     DWORD   *lpdwNewCompReadLen,
00395     BOOL     fAnsi,
00396     DWORD    dwCodePage)
00397 {
00398     LPBYTE lpBufRet;
00399     LPBYTE lpAttr, lpAttrA, lpAttrW;
00400     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>  dwBufLenA, dwBufLenW;
00401     LPSTR  lpStrBufA, lpBufA;
00402     LPWSTR lpStrBufW, lpBufW;
00403     <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>   <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a>;
00404     WCHAR  wc;
00405     ULONG  MultiByteSize;
00406 
00407     <span class="keywordflow">if</span> (lpCompRead == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || dwCompReadLen == 0)
00408         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00409 
00410     <span class="keywordflow">if</span> (fAnsi) {
00411 
00412         dwBufLenA = <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a8">ImmGetCompositionStringA</a>(hImc, dwIndex, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0);
00413 
00414         lpStrBufA = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a22">ImmLocalAlloc</a>(0, dwBufLenA);
00415         <span class="keywordflow">if</span> (lpStrBufA == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00416             RIPMSG0(RIP_WARNING, <span class="stringliteral">"InternalSCS_CHANGEATTR: memory failure."</span>);
00417             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00418         }
00419 
00420         <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a8">ImmGetCompositionStringA</a>(hImc, dwIndex, lpStrBufA, dwBufLenA);
00421 
00422         lpBufRet = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a22">ImmLocalAlloc</a>(0, dwBufLenA);
00423         <span class="keywordflow">if</span> (lpBufRet == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00424             RIPMSG0(RIP_WARNING, <span class="stringliteral">"InternalSCS_CHANGEATTR: memory failure."</span>);
00425             <a class="code" href="../../d4/d0/immcli_8h.html#a8">ImmLocalFree</a>(lpStrBufA);
00426             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00427         }
00428 
00429         lpBufA  = lpStrBufA;
00430         lpAttrA = (LPBYTE)lpCompRead;
00431         lpAttr  = lpBufRet;
00432 
00433         <span class="keywordflow">while</span> (dwBufLenA != 0 &amp;&amp; (<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a>=*lpBufA++) != 0) {
00434             <span class="keywordflow">if</span> (IsDBCSLeadByteEx(dwCodePage, <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a>)) {
00435                 <span class="keywordflow">if</span> (dwBufLenA &gt;= 2) {
00436                     *lpAttr++ = *lpAttrA++;
00437                     dwBufLenA--;
00438                 } <span class="keywordflow">else</span> {
00439                     *lpAttr++ = *lpAttrA;
00440                 }
00441                 lpBufA++;
00442             } <span class="keywordflow">else</span> {
00443                 *lpAttr++ = *lpAttrA;
00444             }
00445             lpAttrA++;
00446             dwBufLenA--;
00447         }
00448 
00449         <a class="code" href="../../d4/d0/immcli_8h.html#a8">ImmLocalFree</a>(lpStrBufA);
00450     }
00451     <span class="keywordflow">else</span> {
00452 
00453         dwBufLenW = <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a9">ImmGetCompositionStringW</a>(hImc, dwIndex, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0);
00454 
00455         lpStrBufW = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a22">ImmLocalAlloc</a>(0, dwBufLenW);
00456         <span class="keywordflow">if</span> (lpStrBufW == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00457             RIPMSG0(RIP_WARNING, <span class="stringliteral">"InternalSCS_CHANGEATTR: memory failure."</span>);
00458             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00459         }
00460 
00461         <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a9">ImmGetCompositionStringW</a>(hImc, dwIndex, lpStrBufW, dwBufLenW);
00462 
00463         lpBufRet = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a22">ImmLocalAlloc</a>(0, dwBufLenW);
00464         <span class="keywordflow">if</span> (lpBufRet == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00465             RIPMSG0(RIP_WARNING, <span class="stringliteral">"InternalSCS_CHANGEATTR: memory failure."</span>);
00466             <a class="code" href="../../d4/d0/immcli_8h.html#a8">ImmLocalFree</a>(lpStrBufW);
00467             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00468         }
00469 
00470         lpBufW  = lpStrBufW;
00471         lpAttrW = (LPBYTE)lpCompRead;
00472         lpAttr  = lpBufRet;
00473 
00474         <span class="keywordflow">while</span> (dwBufLenW != 0 &amp;&amp; (wc=*lpBufW++) != <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>) {
00475             MultiByteSize = <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a7">UnicodeToMultiByteSize</a>(dwCodePage, &amp;wc);
00476             <span class="keywordflow">if</span> (MultiByteSize == 2) {
00477                 *lpAttr++ = *lpAttrW;
00478             }
00479             *lpAttr++ = *lpAttrW++;
00480             dwBufLenW -= <span class="keyword">sizeof</span>(WCHAR);
00481         }
00482 
00483         <a class="code" href="../../d4/d0/immcli_8h.html#a8">ImmLocalFree</a>(lpStrBufW);
00484     }
00485 
00486     *lplpNewCompRead    = lpBufRet;
00487     *lpdwNewCompReadLen = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)(lpAttr - (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)lpBufRet);
00488 
00489     <span class="keywordflow">return</span> lpBufRet;
00490 }
00491 
00492 
<a name="l00493"></a><a class="code" href="../../d4/d1/ctxtinfo_8c.html#a17">00493</a> LPBYTE <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a17">InternalSCS_CHANGECLAUSE</a>(
00494     HIMC     hImc,
00495     LPCVOID  lpCompRead,
00496     DWORD    dwCompReadLen,
00497     DWORD    dwIndex,
00498     LPDWORD *lplpNewCompRead,
00499     DWORD   *lpdwNewCompReadLen,
00500     BOOL     fAnsi,
00501     DWORD    dwCodePage)
00502 {
00503     LPDWORD lpdw, lpNewdw, lpBufRet;
00504     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>   dwBufLenA, dwBufLenW;
00505     LPSTR   lpStrBufA;
00506     LPWSTR  lpStrBufW;
00507     <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>     i;
00508 
00509     <span class="keywordflow">if</span> (lpCompRead == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || dwCompReadLen == 0)
00510         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00511 
00512     lpdw = (LPDWORD)lpCompRead;
00513 
00514     lpBufRet = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a22">ImmLocalAlloc</a>(0, dwCompReadLen);
00515     <span class="keywordflow">if</span> (lpBufRet == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00516         RIPMSG0(RIP_WARNING, <span class="stringliteral">"InternalSCS_CHANGECLAUSE: memory failure."</span>);
00517         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00518     }
00519 
00520     <span class="keywordflow">if</span> (fAnsi) {
00521 
00522         dwBufLenA = <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a8">ImmGetCompositionStringA</a>(hImc, dwIndex, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0);
00523 
00524         lpStrBufA = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a22">ImmLocalAlloc</a>(0, dwBufLenA);
00525         <span class="keywordflow">if</span> (lpStrBufA == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00526             RIPMSG0(RIP_WARNING, <span class="stringliteral">"InternalSCS_CHANGECLAUSE: memory failure."</span>);
00527             <a class="code" href="../../d4/d0/immcli_8h.html#a8">ImmLocalFree</a>(lpBufRet);
00528             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00529         }
00530 
00531         <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a8">ImmGetCompositionStringA</a>(hImc, dwIndex, lpStrBufA, dwBufLenA);
00532     }
00533     <span class="keywordflow">else</span> {
00534 
00535         dwBufLenW = <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a9">ImmGetCompositionStringW</a>(hImc, dwIndex, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0);
00536 
00537         lpStrBufW = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a22">ImmLocalAlloc</a>(0, dwBufLenW);
00538         <span class="keywordflow">if</span> (lpStrBufW == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00539             RIPMSG0(RIP_WARNING, <span class="stringliteral">"InternalSCS_CHANGECLAUSE: memory failure."</span>);
00540             <a class="code" href="../../d4/d0/immcli_8h.html#a8">ImmLocalFree</a>(lpBufRet);
00541             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00542         }
00543 
00544         <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a9">ImmGetCompositionStringW</a>(hImc, dwIndex, lpStrBufW, dwBufLenW);
00545     }
00546 
00547     *lplpNewCompRead = lpNewdw = lpBufRet;
00548     *lpdwNewCompReadLen = dwCompReadLen;
00549 
00550     <span class="keywordflow">for</span> (i = 0; i &lt; (<a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>)(dwCompReadLen / <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)); i++) {
00551         *lpNewdw++ = fAnsi ? <a class="code" href="../../d4/d0/immcli_8h.html#a81">CalcCharacterPositionAtoW</a>(*lpdw++, lpStrBufA, dwCodePage)
00552                            : <a class="code" href="../../d4/d0/immcli_8h.html#a82">CalcCharacterPositionWtoA</a>(*lpdw++, lpStrBufW, dwCodePage);
00553     }
00554 
00555     <span class="keywordflow">return</span> (LPBYTE)lpBufRet;
00556 }
00557 
00558 
<a name="l00559"></a><a class="code" href="../../d4/d1/ctxtinfo_8c.html#a18">00559</a> LPBYTE <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a18">InternalSCS_RECONVERTSTRING</a>(
00560     LPRECONVERTSTRING  lpReconv,
00561     DWORD              dwReconvLen,
00562     LPRECONVERTSTRING *lplpNewReconv,
00563     DWORD             *lpdwNewReconvLen,
00564     BOOL               fAnsi,
00565     DWORD              dwCodePage)
00566 {
00567     LPRECONVERTSTRING lpNewReconv;
00568     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwBufSize;
00569 
00570     <span class="keywordflow">if</span> (lpReconv == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || dwReconvLen == 0)
00571         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00572 
00573     <span class="keywordflow">if</span> (fAnsi) {
00574         <span class="comment">// AtoW</span>
00575         dwBufSize = (lpReconv-&gt;dwSize - <span class="keyword">sizeof</span> *lpReconv + 1) * <span class="keyword">sizeof</span>(WCHAR) + <span class="keyword">sizeof</span> *lpReconv;
00576     }
00577     <span class="keywordflow">else</span> {
00578         dwBufSize = lpReconv-&gt;dwSize + <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>);
00579     }
00580     lpNewReconv = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a22">ImmLocalAlloc</a>(0, dwBufSize);
00581     <span class="keywordflow">if</span> (lpNewReconv == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00582         RIPMSG0(RIP_WARNING, <span class="stringliteral">"InternalSCS_RECONVERTSTRING: memory failure."</span>);
00583         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00584     }
00585 
00586     lpNewReconv-&gt;dwVersion = 0;
00587     lpNewReconv-&gt;dwSize=  dwBufSize;
00588 
00589     lpNewReconv-&gt;dwSize = <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a6">ImmReconversionWorker</a>(lpNewReconv, lpReconv, !fAnsi, dwCodePage);
00590     <span class="keywordflow">if</span> (lpNewReconv-&gt;dwSize == 0) {
00591         <a class="code" href="../../d4/d0/immcli_8h.html#a8">ImmLocalFree</a>(lpNewReconv);
00592         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;;
00593     }
00594     *lpdwNewReconvLen = lpNewReconv-&gt;dwSize;
00595     *lplpNewReconv = lpNewReconv;
00596 
00597     <span class="keywordflow">return</span> (LPBYTE)lpNewReconv;
00598 }
00599 
00600 
00601 <span class="comment">/***************************************************************************\</span>
00602 <span class="comment">* ImmSetCompositionStringWorker</span>
00603 <span class="comment">*</span>
00604 <span class="comment">* Worker function of ImmSetCompositionStringA/ImmSetCompositionStringW</span>
00605 <span class="comment">*</span>
00606 <span class="comment">* History:</span>
00607 <span class="comment">* 28-Feb-1995   wkwok   Created</span>
00608 <span class="comment">\***************************************************************************/</span>
00609 
<a name="l00610"></a><a class="code" href="../../d4/d0/immcli_8h.html#a73">00610</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d0/immcli_8h.html#a73">ImmSetCompositionStringWorker</a>(
00611     HIMC    hImc,
00612     DWORD   dwIndex,
00613     LPVOID lpComp,
00614     DWORD   dwCompLen,
00615     LPVOID lpRead,
00616     DWORD   dwReadLen,
00617     BOOL    fAnsi)
00618 {
00619     PINPUTCONTEXT      pInputContext;
00620     PCOMPOSITIONSTRING pCompStr;
00621     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>              dwThreadId;
00622     <a class="code" href="../../d2/d7/structtagIMEDPI.html">PIMEDPI</a>            pImeDpi;
00623     LPBYTE             lpCompBuf, lpReadBuf;
00624     LPBYTE             lpNewComp = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, lpNewRead = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00625     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>              dwNewCompLen, dwNewReadLen;
00626     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>               fRet = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00627     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>               fCheckSize = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00628     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>               fNeedAWConversion;
00629     LPBYTE             lpOrgComp, lpOrgRead;
00630     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>              dwOrgCompLen, dwOrgReadLen;
00631 
00632     dwThreadId = <a class="code" href="../../d4/d0/immcli_8h.html#a15">GetInputContextThread</a>(hImc);
00633     <span class="keywordflow">if</span> (dwThreadId != GetCurrentThreadId()) {
00634         RIPMSG1(RIP_WARNING,
00635               <span class="stringliteral">"ImmSetCompositionString: Invalid input context access %lx."</span>, hImc);
00636         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00637     }
00638 
00639     pImeDpi = <a class="code" href="../../d9/d0/immuser_8h.html#a45">ImmLockImeDpi</a>(<a class="code" href="../../d3/d8/client_8c.html#a154">GetKeyboardLayout</a>(dwThreadId));
00640     <span class="keywordflow">if</span> (pImeDpi == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00641         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00642 
00643     lpCompBuf = lpReadBuf = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00644 
00645     <span class="comment">// Backup original pointers to copyback for QUERY.</span>
00646     lpOrgComp = lpComp;
00647     lpOrgRead = lpRead;
00648     dwOrgCompLen = dwCompLen;
00649     dwOrgReadLen = dwReadLen;
00650 
00651     <span class="comment">/*</span>
00652 <span class="comment">     * Check if we need ANSI/Unicode conversion</span>
00653 <span class="comment">     */</span>
00654     <span class="keywordflow">if</span> (( fAnsi &amp;&amp; !(pImeDpi-&gt;<a class="code" href="../../d2/d7/structtagIMEDPI.html#o3">ImeInfo</a>.fdwProperty &amp; IME_PROP_UNICODE)) ||
00655         (!fAnsi &amp;&amp;  (pImeDpi-&gt;<a class="code" href="../../d2/d7/structtagIMEDPI.html#o3">ImeInfo</a>.fdwProperty &amp; IME_PROP_UNICODE))) {
00656         <span class="comment">/*</span>
00657 <span class="comment">         * No A/W conversion needed.</span>
00658 <span class="comment">         */</span>
00659         fNeedAWConversion = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00660         <span class="keywordflow">goto</span> start_scs;
00661     }
00662     fNeedAWConversion = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00663 
00664     <span class="keywordflow">switch</span> (dwIndex) {
00665     <span class="keywordflow">case</span> SCS_SETSTR:
00666         <span class="keywordflow">if</span> ( lpComp &amp;&amp;
00667             (lpCompBuf = <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a15">InternalSCS_SETSTR</a>(lpComp, dwCompLen,
00668                                 &amp;lpNewComp, &amp;dwNewCompLen, fAnsi, <a class="code" href="../../d4/d0/immcli_8h.html#a25">IMECodePage</a>(pImeDpi))) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00669             <span class="keywordflow">goto</span> callime_scs;
00670         <span class="keywordflow">if</span> ( lpRead &amp;&amp;
00671             (lpReadBuf = <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a15">InternalSCS_SETSTR</a>(lpRead, dwReadLen,
00672                                 &amp;lpNewRead, &amp;dwNewReadLen, fAnsi, <a class="code" href="../../d4/d0/immcli_8h.html#a25">IMECodePage</a>(pImeDpi))) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00673             <span class="keywordflow">goto</span> callime_scs;
00674 
00675         fCheckSize = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00676         <span class="keywordflow">break</span>;
00677 
00678     <span class="keywordflow">case</span> SCS_CHANGEATTR:
00679         <span class="keywordflow">if</span> ( lpComp &amp;&amp;
00680             (lpCompBuf = <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a16">InternalSCS_CHANGEATTR</a>(
00681                                 hImc, lpComp, dwCompLen, GCS_COMPSTR,
00682                                 &amp;lpNewComp, &amp;dwNewCompLen, fAnsi, <a class="code" href="../../d4/d0/immcli_8h.html#a25">IMECodePage</a>(pImeDpi))) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00683             <span class="keywordflow">goto</span> callime_scs;
00684         <span class="keywordflow">if</span> ( lpRead &amp;&amp;
00685             (lpReadBuf = <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a16">InternalSCS_CHANGEATTR</a>(
00686                                 hImc, lpRead, dwReadLen, GCS_COMPREADSTR,
00687                                 &amp;lpNewRead, &amp;dwNewReadLen, fAnsi, <a class="code" href="../../d4/d0/immcli_8h.html#a25">IMECodePage</a>(pImeDpi))) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00688             <span class="keywordflow">goto</span> callime_scs;
00689         <span class="keywordflow">break</span>;
00690 
00691     <span class="keywordflow">case</span> SCS_CHANGECLAUSE:
00692        <span class="keywordflow">if</span> ( lpComp &amp;&amp;
00693            (lpCompBuf = <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a17">InternalSCS_CHANGECLAUSE</a>(
00694                                 hImc, lpComp, dwCompLen, GCS_COMPSTR,
00695                                 (LPDWORD *)&amp;lpNewComp, &amp;dwNewCompLen, fAnsi, <a class="code" href="../../d4/d0/immcli_8h.html#a25">IMECodePage</a>(pImeDpi))) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00696             <span class="keywordflow">goto</span> callime_scs;
00697         <span class="keywordflow">if</span> ( lpRead &amp;&amp;
00698             (lpReadBuf = <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a17">InternalSCS_CHANGECLAUSE</a>(
00699                                 hImc, lpRead, dwReadLen, GCS_COMPREADSTR,
00700                                 (LPDWORD *)&amp;lpNewRead, &amp;dwNewReadLen, fAnsi, <a class="code" href="../../d4/d0/immcli_8h.html#a25">IMECodePage</a>(pImeDpi))) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00701             <span class="keywordflow">goto</span> callime_scs;
00702         <span class="keywordflow">break</span>;
00703 
00704     <span class="keywordflow">case</span> SCS_SETRECONVERTSTRING:
00705     <span class="keywordflow">case</span> SCS_QUERYRECONVERTSTRING:
00706         <span class="keywordflow">if</span> (lpComp &amp;&amp;
00707             (lpCompBuf = <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a18">InternalSCS_RECONVERTSTRING</a>((LPRECONVERTSTRING)lpComp, dwCompLen,
00708                                 (LPRECONVERTSTRING *)&amp;lpNewComp, &amp;dwNewCompLen,
00709                                 fAnsi, <a class="code" href="../../d4/d0/immcli_8h.html#a25">IMECodePage</a>(pImeDpi))) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00710             <span class="keywordflow">goto</span> callime_scs;
00711         <span class="keywordflow">if</span> (lpRead &amp;&amp;
00712             (lpReadBuf = <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a18">InternalSCS_RECONVERTSTRING</a>((LPRECONVERTSTRING)lpRead, dwReadLen,
00713                                 (LPRECONVERTSTRING *)&amp;lpNewRead, &amp;dwNewReadLen,
00714                                 fAnsi, <a class="code" href="../../d4/d0/immcli_8h.html#a25">IMECodePage</a>(pImeDpi))) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00715             <span class="keywordflow">goto</span> callime_scs;
00716 
00717         fCheckSize = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00718         <span class="keywordflow">break</span>;
00719 
00720     <span class="keywordflow">default</span>:
00721         <span class="keywordflow">goto</span> callime_scs;
00722     }
00723 
00724     <span class="keywordflow">if</span> (lpCompBuf != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00725         lpComp    = lpNewComp;
00726         dwCompLen = dwNewCompLen;
00727     }
00728 
00729     <span class="keywordflow">if</span> (lpReadBuf != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00730         lpRead    = lpNewRead;
00731         dwReadLen = dwNewReadLen;
00732     }
00733 
00734 start_scs:
00735 
00736     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/ctxtinfo_8c.html#a12">CompositionString</a>(hImc, &amp;pInputContext, &amp;pCompStr, fCheckSize) &lt;= 0)
00737         <span class="keywordflow">goto</span> callime_scs;
00738 
00739     <span class="keywordflow">switch</span> (dwIndex)
00740     {
00741     <span class="keywordflow">case</span> SCS_SETSTR:
00742         fRet = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00743         <span class="keywordflow">break</span>;
00744 
00745     <span class="keywordflow">case</span> SCS_CHANGEATTR:
00746         <span class="keywordflow">if</span> ( lpComp &amp;&amp;
00747             !<a class="code" href="../../d4/d1/ctxtinfo_8c.html#a13">CheckAttribute</a>((LPBYTE)lpComp, dwCompLen,
00748                     (LPBYTE)((LPBYTE)pCompStr + pCompStr-&gt;dwCompAttrOffset),
00749                     pCompStr-&gt;dwCompAttrLen,
00750                     (LPDWORD)((LPBYTE)pCompStr + pCompStr-&gt;dwCompClauseOffset),
00751                     pCompStr-&gt;dwCompClauseLen)) <span class="keywordflow">break</span>;
00752 
00753         <span class="keywordflow">if</span> ( lpRead &amp;&amp;
00754             !<a class="code" href="../../d4/d1/ctxtinfo_8c.html#a13">CheckAttribute</a>((LPBYTE)lpRead, dwReadLen,
00755                     (LPBYTE)((LPBYTE)pCompStr + pCompStr-&gt;dwCompReadAttrOffset),
00756                     pCompStr-&gt;dwCompReadAttrLen,
00757                     (LPDWORD)((LPBYTE)pCompStr + pCompStr-&gt;dwCompReadClauseOffset),
00758                     pCompStr-&gt;dwCompReadClauseLen)) <span class="keywordflow">break</span>;
00759         fRet = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00760         <span class="keywordflow">break</span>;
00761 
00762     <span class="keywordflow">case</span> SCS_CHANGECLAUSE:
00763         <span class="keywordflow">if</span> ( lpComp &amp;&amp;
00764             !<a class="code" href="../../d4/d1/ctxtinfo_8c.html#a14">CheckClause</a>((LPDWORD)lpComp, dwCompLen,
00765                          (LPDWORD)((LPBYTE)pCompStr + pCompStr-&gt;dwCompClauseOffset),
00766                          pCompStr-&gt;dwCompClauseLen)) <span class="keywordflow">break</span>;
00767         <span class="keywordflow">if</span> ( lpRead &amp;&amp;
00768             !<a class="code" href="../../d4/d1/ctxtinfo_8c.html#a14">CheckClause</a>((LPDWORD)lpRead, dwReadLen,
00769                          (LPDWORD)((LPBYTE)pCompStr + pCompStr-&gt;dwCompReadClauseOffset),
00770                          pCompStr-&gt;dwCompReadClauseLen)) <span class="keywordflow">break</span>;
00771         fRet = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00772         <span class="keywordflow">break</span>;
00773 
00774     <span class="keywordflow">case</span> SCS_SETRECONVERTSTRING:
00775     <span class="keywordflow">case</span> SCS_QUERYRECONVERTSTRING:
00776         <span class="keywordflow">if</span> (pImeDpi-&gt;<a class="code" href="../../d2/d7/structtagIMEDPI.html#o3">ImeInfo</a>.fdwSCSCaps &amp; SCS_CAP_SETRECONVERTSTRING) {
00777             fRet = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00778         }
00779         <span class="keywordflow">break</span>;
00780 
00781     <span class="keywordflow">default</span>:
00782         <span class="keywordflow">break</span>;
00783     }
00784 
00785     <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a18">ImmUnlockIMCC</a>(pInputContext-&gt;hCompStr);
00786     <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a13">ImmUnlockIMC</a>(hImc);
00787 
00788 callime_scs:
00789 
00790     <span class="keywordflow">if</span> (fRet) {
00791         fRet = (*pImeDpi-&gt;<a class="code" href="../../d2/d7/structtagIMEDPI.html#o8">pfn</a>.<a class="code" href="../../d3/d7/structtagIMEDPI_1_1__tagImeFunctions.html#o27">ImeSetCompositionString</a>)(hImc, dwIndex,
00792                                     lpComp, dwCompLen, lpRead, dwReadLen);
00793     }
00794 
00795     <span class="comment">/*</span>
00796 <span class="comment">     * Check if we need ANSI/Unicode back conversion</span>
00797 <span class="comment">     */</span>
00798     <span class="keywordflow">if</span> (fNeedAWConversion) {
00799         LPBYTE lpCompBufBack = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, lpReadBufBack = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00800         <span class="comment">/*</span>
00801 <span class="comment">         * A/W back conversion needed.</span>
00802 <span class="comment">         */</span>
00803         <span class="keywordflow">switch</span> (dwIndex) {
00804         <span class="keywordflow">case</span> SCS_QUERYRECONVERTSTRING:
00805             <span class="keywordflow">if</span> (lpOrgComp &amp;&amp;
00806                 (lpCompBufBack = <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a18">InternalSCS_RECONVERTSTRING</a>((LPRECONVERTSTRING)lpComp, dwCompLen,
00807                                     (LPRECONVERTSTRING *)&amp;lpNewComp, &amp;dwNewCompLen,
00808                                     !fAnsi, <a class="code" href="../../d4/d0/immcli_8h.html#a25">IMECodePage</a>(pImeDpi)))) {
00809                 RtlCopyMemory(lpOrgComp, lpNewComp, dwNewCompLen);
00810             }
00811             <span class="keywordflow">if</span> (lpOrgRead &amp;&amp;
00812                 (lpReadBufBack = <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a18">InternalSCS_RECONVERTSTRING</a>(
00813                                     (LPRECONVERTSTRING)lpRead, dwReadLen,
00814                                     (LPRECONVERTSTRING *)&amp;lpNewRead, &amp;dwNewReadLen,
00815                                     !fAnsi, <a class="code" href="../../d4/d0/immcli_8h.html#a25">IMECodePage</a>(pImeDpi)))) {
00816                 RtlCopyMemory(lpOrgRead, lpNewRead, dwNewReadLen);
00817             }
00818         }
00819         <span class="keywordflow">if</span> (lpCompBufBack != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00820             LocalFree(lpCompBufBack);
00821         <span class="keywordflow">if</span> (lpReadBufBack != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00822             LocalFree(lpReadBufBack);
00823     }
00824 
00825     <span class="keywordflow">if</span> (lpCompBuf != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00826         <a class="code" href="../../d4/d0/immcli_8h.html#a8">ImmLocalFree</a>(lpCompBuf);
00827     <span class="keywordflow">if</span> (lpReadBuf != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00828         <a class="code" href="../../d4/d0/immcli_8h.html#a8">ImmLocalFree</a>(lpReadBuf);
00829 
00830     <a class="code" href="../../d9/d0/immuser_8h.html#a46">ImmUnlockImeDpi</a>(pImeDpi);
00831 
00832     <span class="keywordflow">return</span> fRet;
00833 }
00834 
00835 
00836 <span class="comment">/***************************************************************************\</span>
00837 <span class="comment">* ImmGetCandidateListCountA</span>
00838 <span class="comment">*</span>
00839 <span class="comment">* Query the byte count and list count to receive all candidate list.</span>
00840 <span class="comment">*</span>
00841 <span class="comment">* History:</span>
00842 <span class="comment">* 27-Feb-1995   wkwok   Created</span>
00843 <span class="comment">\***************************************************************************/</span>
00844 
<a name="l00845"></a><a class="code" href="../../d4/d1/ctxtinfo_8c.html#a20">00845</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> WINAPI <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a20">ImmGetCandidateListCountA</a>(
00846     HIMC    hImc,
00847     LPDWORD lpdwListCount)      <span class="comment">// the buffer pointer for list count</span>
00848 {
00849     <span class="keywordflow">return</span> <a class="code" href="../../d4/d0/immcli_8h.html#a74">ImmGetCandidateListCountWorker</a>(hImc, lpdwListCount, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00850 }
00851 
00852 
00853 <span class="comment">/***************************************************************************\</span>
00854 <span class="comment">* ImmGetCandidateListCountW</span>
00855 <span class="comment">*</span>
00856 <span class="comment">* Query the byte count and list count to receive all candidate list.</span>
00857 <span class="comment">*</span>
00858 <span class="comment">* History:</span>
00859 <span class="comment">* 27-Feb-1995   wkwok   Created</span>
00860 <span class="comment">\***************************************************************************/</span>
00861 
<a name="l00862"></a><a class="code" href="../../d4/d1/ctxtinfo_8c.html#a21">00862</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> WINAPI <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a21">ImmGetCandidateListCountW</a>(
00863     HIMC    hImc,
00864     LPDWORD lpdwListCount)      <span class="comment">// the buffer pointer for list count</span>
00865 {
00866     <span class="keywordflow">return</span> <a class="code" href="../../d4/d0/immcli_8h.html#a74">ImmGetCandidateListCountWorker</a>(hImc, lpdwListCount, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00867 }
00868 
00869 
00870 <span class="comment">/***************************************************************************\</span>
00871 <span class="comment">* ImmGetCandidateListCountWorker</span>
00872 <span class="comment">*</span>
00873 <span class="comment">* Worker function of ImmGetCandidateListCountA/ImmGetCandidateListCountW.</span>
00874 <span class="comment">*</span>
00875 <span class="comment">* History:</span>
00876 <span class="comment">* 27-Feb-1995   wkwok   Created</span>
00877 <span class="comment">\***************************************************************************/</span>
00878 
<a name="l00879"></a><a class="code" href="../../d4/d0/immcli_8h.html#a74">00879</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d4/d0/immcli_8h.html#a74">ImmGetCandidateListCountWorker</a>(
00880     HIMC    hImc,
00881     LPDWORD lpdwListCount,
00882     BOOL    fAnsi)
00883 {
00884     <a class="code" href="../../d3/d0/structtagCLIENTIMC.html">PCLIENTIMC</a>      pClientImc;
00885     PINPUTCONTEXT   pInputContext;
00886     LPCANDIDATEINFO lpCandInfo;
00887     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>           dwRet = 0;
00888     <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>             i;
00889     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>           dwCodePage;
00890 
00891     <span class="keywordflow">if</span> (lpdwListCount) {
00892         *lpdwListCount = 0;
00893     } <span class="keywordflow">else</span> {
00894         RIPMSG0(RIP_WARNING, <span class="stringliteral">"ImmGetCandidateListCount: NULL lpdwListCount."</span>);
00895         <span class="keywordflow">return</span> dwRet;
00896     }
00897 
00898     pClientImc = <a class="code" href="../../d9/d0/immuser_8h.html#a43">ImmLockClientImc</a>(hImc);
00899     <span class="keywordflow">if</span> (pClientImc == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00900         RIPMSG1(RIP_WARNING, <span class="stringliteral">"ImmGetCandidateListCount: Invalid hImc %lx."</span>, hImc);
00901         <span class="keywordflow">goto</span> GetCandListCntExit;
00902     }
00903     dwCodePage = <a class="code" href="../../d4/d0/immcli_8h.html#a26">CImcCodePage</a>(pClientImc);
00904 
00905     pInputContext = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a12">ImmLockIMC</a>(hImc);
00906     <span class="keywordflow">if</span> (pInputContext == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00907         RIPMSG1(RIP_WARNING, <span class="stringliteral">"ImmGetCandidateListCount: Lock hImc %lx failed."</span>, hImc);
00908         <span class="keywordflow">goto</span> GetCandListCntUnlockClientImc;
00909     }
00910 
00911     lpCandInfo = (LPCANDIDATEINFO)<a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a17">ImmLockIMCC</a>(pInputContext-&gt;hCandInfo);
00912     <span class="keywordflow">if</span> (!lpCandInfo) {
00913         RIPMSG1(RIP_WARNING,
00914               <span class="stringliteral">"ImmGetCandidateListCount: Lock hCandInfo %x failed."</span>,
00915               pInputContext-&gt;hCandInfo);
00916         <span class="keywordflow">goto</span> GetCandListCntUnlockIMC;
00917     }
00918 
00919     <span class="keywordflow">if</span> (lpCandInfo-&gt;dwSize &lt; <span class="keyword">sizeof</span>(CANDIDATEINFO)) {
00920         RIPMSG0(RIP_WARNING, <span class="stringliteral">"ImmGetCandidateListCount: no candidate list."</span>);
00921         <span class="keywordflow">goto</span> GetCandListCntUnlockIMC;
00922     }
00923 
00924     *lpdwListCount = lpCandInfo-&gt;dwCount;
00925 
00926     <span class="keywordflow">if</span> (fAnsi &amp;&amp; <a class="code" href="../../d4/d0/immcli_8h.html#a21">TestICF</a>(pClientImc, <a class="code" href="../../d8/d0/immstruc_8h.html#a4">IMCF_UNICODE</a>)) {
00927         LPCANDIDATELIST lpCandListW;
00928 
00929         dwRet = <a class="code" href="../../d4/d0/immcli_8h.html#a18">DWORD_ALIGN</a>(<span class="keyword">sizeof</span>(CANDIDATEINFO))
00930               + <a class="code" href="../../d4/d0/immcli_8h.html#a18">DWORD_ALIGN</a>(lpCandInfo-&gt;dwPrivateSize);
00931 
00932         <span class="keywordflow">for</span> (i = 0; i &lt; (<a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>)lpCandInfo-&gt;dwCount; i++) {
00933             lpCandListW = (LPCANDIDATELIST)((LPBYTE)lpCandInfo + lpCandInfo-&gt;dwOffset[i]);
00934             dwRet += <a class="code" href="../../d4/d0/immcli_8h.html#a80">InternalGetCandidateListWtoA</a>(lpCandListW, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0, dwCodePage);
00935         }
00936     }
00937     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!fAnsi &amp;&amp; !<a class="code" href="../../d4/d0/immcli_8h.html#a21">TestICF</a>(pClientImc, <a class="code" href="../../d8/d0/immstruc_8h.html#a4">IMCF_UNICODE</a>)) {
00938         LPCANDIDATELIST lpCandListA;
00939 
00940         dwRet = <a class="code" href="../../d4/d0/immcli_8h.html#a18">DWORD_ALIGN</a>(<span class="keyword">sizeof</span>(CANDIDATEINFO))
00941               + <a class="code" href="../../d4/d0/immcli_8h.html#a18">DWORD_ALIGN</a>(lpCandInfo-&gt;dwPrivateSize);
00942 
00943         <span class="keywordflow">for</span> (i = 0; i &lt; (<a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>)lpCandInfo-&gt;dwCount; i++) {
00944             lpCandListA = (LPCANDIDATELIST)((LPBYTE)lpCandInfo + lpCandInfo-&gt;dwOffset[i]);
00945             dwRet += <a class="code" href="../../d4/d0/immcli_8h.html#a79">InternalGetCandidateListAtoW</a>(lpCandListA, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0, dwCodePage);
00946         }
00947     }
00948     <span class="keywordflow">else</span> {
00949         dwRet = lpCandInfo-&gt;dwSize;
00950     }
00951 
00952     <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a18">ImmUnlockIMCC</a>(pInputContext-&gt;hCandInfo);
00953 
00954 GetCandListCntUnlockIMC:
00955     <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a13">ImmUnlockIMC</a>(hImc);
00956 
00957 GetCandListCntUnlockClientImc:
00958     <a class="code" href="../../d9/d0/immuser_8h.html#a44">ImmUnlockClientImc</a>(pClientImc);
00959 
00960 GetCandListCntExit:
00961     <span class="keywordflow">return</span> dwRet;
00962 }
00963 
00964 
00965 <span class="comment">/***************************************************************************\</span>
00966 <span class="comment">* ImmGetCandidateListA</span>
00967 <span class="comment">*</span>
00968 <span class="comment">* Gets the candidate list information specified by dwIndex.</span>
00969 <span class="comment">*</span>
00970 <span class="comment">* History:</span>
00971 <span class="comment">* 27-Feb-1995   wkwok   Created</span>
00972 <span class="comment">\***************************************************************************/</span>
00973 
<a name="l00974"></a><a class="code" href="../../d4/d1/ctxtinfo_8c.html#a23">00974</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> WINAPI <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a23">ImmGetCandidateListA</a>(
00975     HIMC            hImc,
00976     DWORD           dwIndex,
00977     LPCANDIDATELIST lpCandList,
00978     DWORD           dwBufLen)
00979 {
00980     <span class="keywordflow">return</span> <a class="code" href="../../d4/d0/immcli_8h.html#a75">ImmGetCandidateListWorker</a>(hImc, dwIndex,
00981                                      lpCandList, dwBufLen, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00982 }
00983 
00984 
00985 <span class="comment">/***************************************************************************\</span>
00986 <span class="comment">* ImmGetCandidateListW</span>
00987 <span class="comment">*</span>
00988 <span class="comment">* Gets the candidate list information specified by dwIndex.</span>
00989 <span class="comment">*</span>
00990 <span class="comment">* History:</span>
00991 <span class="comment">* 27-Feb-1995   wkwok   Created</span>
00992 <span class="comment">\***************************************************************************/</span>
00993 
<a name="l00994"></a><a class="code" href="../../d4/d1/ctxtinfo_8c.html#a24">00994</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> WINAPI <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a24">ImmGetCandidateListW</a>(
00995     HIMC            hImc,
00996     DWORD           dwIndex,
00997     LPCANDIDATELIST lpCandList,
00998     DWORD           dwBufLen)
00999 {
01000     <span class="keywordflow">return</span> <a class="code" href="../../d4/d0/immcli_8h.html#a75">ImmGetCandidateListWorker</a>(hImc, dwIndex,
01001                                      lpCandList, dwBufLen, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01002 }
01003 
01004 
01005 <span class="comment">/***************************************************************************\</span>
01006 <span class="comment">* ImmGetCandidateListWorker</span>
01007 <span class="comment">*</span>
01008 <span class="comment">* Worker function of ImmGetCandidateListA/ImmGetCandidateListW.</span>
01009 <span class="comment">*</span>
01010 <span class="comment">* History:</span>
01011 <span class="comment">* 27-Feb-1995   wkwok   Created</span>
01012 <span class="comment">\***************************************************************************/</span>
01013 
<a name="l01014"></a><a class="code" href="../../d4/d0/immcli_8h.html#a75">01014</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d4/d0/immcli_8h.html#a75">ImmGetCandidateListWorker</a>(
01015     HIMC            hImc,
01016     DWORD           dwIndex,
01017     LPCANDIDATELIST lpCandList,
01018     DWORD           dwBufLen,
01019     BOOL            fAnsi)
01020 {
01021     <a class="code" href="../../d3/d0/structtagCLIENTIMC.html">PCLIENTIMC</a>      pClientImc;
01022     PINPUTCONTEXT   pInputContext;
01023     LPCANDIDATEINFO lpCandInfo;
01024     LPCANDIDATELIST lpCandListTemp;
01025     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>           dwBufLenTemp;
01026     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>           dwRet = 0;
01027     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>           dwCodePage;
01028 
01029     pClientImc = <a class="code" href="../../d9/d0/immuser_8h.html#a43">ImmLockClientImc</a>(hImc);
01030     <span class="keywordflow">if</span> (pClientImc == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01031         RIPMSG1(RIP_WARNING, <span class="stringliteral">"ImmGetCandidateList: Invalid hImc %lx."</span>, hImc);
01032         <span class="keywordflow">goto</span> GetCandListExit;
01033 
01034     }
01035 
01036     dwCodePage = <a class="code" href="../../d4/d0/immcli_8h.html#a26">CImcCodePage</a>(pClientImc);
01037 
01038     pInputContext = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a12">ImmLockIMC</a>(hImc);
01039     <span class="keywordflow">if</span> (pInputContext == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01040         RIPMSG1(RIP_WARNING, <span class="stringliteral">"ImmGetCandidateList: Lock hImc %lx failed."</span>, hImc);
01041         <span class="keywordflow">goto</span> GetCandListUnlockClientImc;
01042     }
01043 
01044     lpCandInfo = (LPCANDIDATEINFO)<a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a17">ImmLockIMCC</a>(pInputContext-&gt;hCandInfo);
01045     <span class="keywordflow">if</span> (!lpCandInfo) {
01046         RIPMSG1(RIP_WARNING, <span class="stringliteral">"ImmGetCandidateList: Lock hCandInfo %x failed"</span>,
01047               pInputContext-&gt;hCandInfo);
01048         <span class="keywordflow">goto</span> GetCandListUnlockIMC;
01049     }
01050 
01051     <span class="keywordflow">if</span> (lpCandInfo-&gt;dwSize &lt; <span class="keyword">sizeof</span>(CANDIDATEINFO)) {
01052         RIPMSG0(RIP_WARNING, <span class="stringliteral">"ImmGetCandidateList: no candidate list."</span>);
01053         <span class="keywordflow">goto</span> GetCandListUnlockIMCC;
01054     }
01055 
01056     <span class="comment">/*</span>
01057 <span class="comment">     * invalid access</span>
01058 <span class="comment">     */</span>
01059     <span class="keywordflow">if</span> (dwIndex &gt;= lpCandInfo-&gt;dwCount) {
01060         RIPMSG0(RIP_WARNING, <span class="stringliteral">"ImmGetCandidateList: dwIndex &gt;= lpCandInfo-&gt;dwCount."</span>);
01061         <span class="keywordflow">goto</span> GetCandListUnlockIMCC;
01062     }
01063 
01064     lpCandListTemp = (LPCANDIDATELIST)((LPBYTE)lpCandInfo + lpCandInfo-&gt;dwOffset[dwIndex]);
01065 
01066     <span class="keywordflow">if</span> (fAnsi &amp;&amp; <a class="code" href="../../d4/d0/immcli_8h.html#a21">TestICF</a>(pClientImc, <a class="code" href="../../d8/d0/immstruc_8h.html#a4">IMCF_UNICODE</a>)) {
01067         <span class="comment">/*</span>
01068 <span class="comment">         * ANSI Caller with an Unicode hImc.</span>
01069 <span class="comment">         */</span>
01070         dwBufLenTemp = <a class="code" href="../../d4/d0/immcli_8h.html#a80">InternalGetCandidateListWtoA</a>(lpCandListTemp, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0, dwCodePage);
01071     }
01072     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!fAnsi &amp;&amp; !<a class="code" href="../../d4/d0/immcli_8h.html#a21">TestICF</a>(pClientImc, <a class="code" href="../../d8/d0/immstruc_8h.html#a4">IMCF_UNICODE</a>)) {
01073         <span class="comment">/*</span>
01074 <span class="comment">         * Unicode Caller with an ANSI hImc.</span>
01075 <span class="comment">         */</span>
01076         dwBufLenTemp = <a class="code" href="../../d4/d0/immcli_8h.html#a79">InternalGetCandidateListAtoW</a>(lpCandListTemp, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0, dwCodePage);
01077     }
01078     <span class="keywordflow">else</span> {
01079         <span class="comment">/*</span>
01080 <span class="comment">         * No conversion required.</span>
01081 <span class="comment">         */</span>
01082         dwBufLenTemp = lpCandListTemp-&gt;dwSize;
01083     }
01084 
01085     <span class="comment">/*</span>
01086 <span class="comment">     * Query buffer size or early exit on error</span>
01087 <span class="comment">     */</span>
01088     <span class="keywordflow">if</span> (dwBufLen == 0 || dwBufLenTemp == 0) {
01089         dwRet = dwBufLenTemp;
01090     }
01091     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!lpCandList) {
01092         RIPMSG0(RIP_WARNING, <span class="stringliteral">"ImmGetCandidateList: Null lpCandList."</span>);
01093     }
01094     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dwBufLen &lt; dwBufLenTemp) {
01095         RIPMSG2(RIP_WARNING, <span class="stringliteral">"ImmGetCandidateList: dwBufLen = %d too small, require = %d."</span>,
01096               dwBufLen, dwBufLenTemp);
01097     } <span class="keywordflow">else</span> {
01098         <span class="keywordflow">if</span> (fAnsi &amp;&amp; <a class="code" href="../../d4/d0/immcli_8h.html#a21">TestICF</a>(pClientImc, <a class="code" href="../../d8/d0/immstruc_8h.html#a4">IMCF_UNICODE</a>)) {
01099             dwRet = <a class="code" href="../../d4/d0/immcli_8h.html#a80">InternalGetCandidateListWtoA</a>(lpCandListTemp, lpCandList, dwBufLenTemp, dwCodePage);
01100         }
01101         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!fAnsi &amp;&amp; !<a class="code" href="../../d4/d0/immcli_8h.html#a21">TestICF</a>(pClientImc, <a class="code" href="../../d8/d0/immstruc_8h.html#a4">IMCF_UNICODE</a>)) {
01102             dwRet = <a class="code" href="../../d4/d0/immcli_8h.html#a79">InternalGetCandidateListAtoW</a>(lpCandListTemp, lpCandList, dwBufLenTemp, dwCodePage);
01103         }
01104         <span class="keywordflow">else</span> {
01105             RtlCopyMemory((LPBYTE)lpCandList, (LPBYTE)lpCandListTemp, dwBufLenTemp);
01106             dwRet = dwBufLenTemp;
01107         }
01108     }
01109 
01110 GetCandListUnlockIMCC:
01111     <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a18">ImmUnlockIMCC</a>(pInputContext-&gt;hCandInfo);
01112 
01113 GetCandListUnlockIMC:
01114     <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a13">ImmUnlockIMC</a>(hImc);
01115 
01116 GetCandListUnlockClientImc:
01117     <a class="code" href="../../d9/d0/immuser_8h.html#a44">ImmUnlockClientImc</a>(pClientImc);
01118 
01119 GetCandListExit:
01120     <span class="keywordflow">return</span> dwRet;
01121 }
01122 
01123 
01124 <span class="comment">/***************************************************************************\</span>
01125 <span class="comment">* ImmGetGuideLineA</span>
01126 <span class="comment">*</span>
01127 <span class="comment">* Gets the guide line information reported by the IME.</span>
01128 <span class="comment">*</span>
01129 <span class="comment">* History:</span>
01130 <span class="comment">* 26-Feb-1995   wkwok   Created</span>
01131 <span class="comment">\***************************************************************************/</span>
01132 
<a name="l01133"></a><a class="code" href="../../d4/d1/ctxtinfo_8c.html#a26">01133</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> WINAPI <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a26">ImmGetGuideLineA</a>(
01134     HIMC    hImc,
01135     DWORD   dwIndex,
01136     LPSTR   lpszBuf,
01137     DWORD   dwBufLen)
01138 {
01139     <span class="keywordflow">return</span> <a class="code" href="../../d4/d0/immcli_8h.html#a76">ImmGetGuideLineWorker</a>(hImc, dwIndex,
01140                                  (LPBYTE)lpszBuf, dwBufLen, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01141 }
01142 
01143 
01144 <span class="comment">/***************************************************************************\</span>
01145 <span class="comment">* ImmGetGuideLineW</span>
01146 <span class="comment">*</span>
01147 <span class="comment">* Gets the guide line information reported by the IME.</span>
01148 <span class="comment">*</span>
01149 <span class="comment">* History:</span>
01150 <span class="comment">* 26-Feb-1995   wkwok   Created</span>
01151 <span class="comment">\***************************************************************************/</span>
01152 
<a name="l01153"></a><a class="code" href="../../d4/d1/ctxtinfo_8c.html#a27">01153</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> WINAPI <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a27">ImmGetGuideLineW</a>(
01154     HIMC    hImc,
01155     DWORD   dwIndex,
01156     LPWSTR  lpwszBuf,
01157     DWORD   dwBufLen)
01158 {
01159     <span class="keywordflow">return</span> <a class="code" href="../../d4/d0/immcli_8h.html#a76">ImmGetGuideLineWorker</a>(hImc, dwIndex,
01160                                  (LPBYTE)lpwszBuf, dwBufLen, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01161 }
01162 
01163 
01164 <span class="comment">/***************************************************************************\</span>
01165 <span class="comment">* ImmGetGuideLineWorker</span>
01166 <span class="comment">*</span>
01167 <span class="comment">* Worker function of ImmGetGuideLineA/ImmGetGuideLineW.</span>
01168 <span class="comment">*</span>
01169 <span class="comment">* History:</span>
01170 <span class="comment">* 26-Feb-1995   wkwok   Created</span>
01171 <span class="comment">\***************************************************************************/</span>
01172 
<a name="l01173"></a><a class="code" href="../../d4/d0/immcli_8h.html#a76">01173</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d4/d0/immcli_8h.html#a76">ImmGetGuideLineWorker</a>(
01174     HIMC    hImc,
01175     DWORD   dwIndex,
01176     LPBYTE  lpBuf,
01177     DWORD   dwBufLen,
01178     BOOL    fAnsi)
01179 {
01180     <a class="code" href="../../d3/d0/structtagCLIENTIMC.html">PCLIENTIMC</a>    pClientImc;
01181     PINPUTCONTEXT pInputContext;
01182     LPGUIDELINE   lpGuideLine;
01183     LPBYTE        lpBufTemp;
01184     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>         dwRet = 0;
01185     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>         dwBufLenNeeded;
01186     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>          bUDC;
01187     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>         dwCodePage;
01188 
01189     pClientImc = <a class="code" href="../../d9/d0/immuser_8h.html#a43">ImmLockClientImc</a>(hImc);
01190     <span class="keywordflow">if</span> (pClientImc == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01191         RIPMSG1(RIP_WARNING, <span class="stringliteral">"ImmGetGuideLine: Invalid hImc %lx."</span>, hImc);
01192         <span class="keywordflow">goto</span> GetGuideLineExit;
01193     }
01194     dwCodePage = <a class="code" href="../../d4/d0/immcli_8h.html#a26">CImcCodePage</a>(pClientImc);
01195 
01196     pInputContext = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a12">ImmLockIMC</a>(hImc);
01197     <span class="keywordflow">if</span> (pInputContext == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01198         RIPMSG1(RIP_WARNING, <span class="stringliteral">"ImmGetGuideLine: Lock hImc %lx failed."</span>, hImc);
01199         <span class="keywordflow">goto</span> GetGuideLineUnlockClientImc;
01200     }
01201 
01202     lpGuideLine = (LPGUIDELINE)<a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a17">ImmLockIMCC</a>(pInputContext-&gt;hGuideLine);
01203     <span class="keywordflow">if</span> (!lpGuideLine) {
01204         RIPMSG1(RIP_WARNING, <span class="stringliteral">"ImmGetGuideLine: Lock hGuideLine %lx failed."</span>,
01205               pInputContext-&gt;hGuideLine);
01206         <span class="keywordflow">goto</span> GetGuideLineUnlockIMC;
01207     }
01208 
01209     <span class="keywordflow">switch</span> (dwIndex) {
01210     <span class="keywordflow">case</span> GGL_LEVEL:
01211         dwRet = lpGuideLine-&gt;dwLevel;
01212         <span class="keywordflow">break</span>;
01213 
01214     <span class="keywordflow">case</span> GGL_INDEX:
01215         dwRet = lpGuideLine-&gt;dwIndex;
01216         <span class="keywordflow">break</span>;
01217 
01218     <span class="keywordflow">case</span> GGL_STRING:
01219 
01220         lpBufTemp = (LPBYTE)lpGuideLine + lpGuideLine-&gt;dwStrOffset;
01221 
01222         <span class="comment">/*</span>
01223 <span class="comment">         * Calculate the required buffer length.</span>
01224 <span class="comment">         */</span>
01225         <span class="keywordflow">if</span> (fAnsi &amp;&amp; <a class="code" href="../../d4/d0/immcli_8h.html#a21">TestICF</a>(pClientImc, <a class="code" href="../../d8/d0/immstruc_8h.html#a4">IMCF_UNICODE</a>)) {
01226             dwBufLenNeeded = WideCharToMultiByte(dwCodePage,
01227                                                  (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)0,
01228                                                  (LPWSTR)lpBufTemp,
01229                                                  (<a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>)lpGuideLine-&gt;dwStrLen,
01230                                                  (LPSTR)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01231                                                  (<a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>)0,
01232                                                  (LPSTR)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01233                                                  (LPBOOL)&amp;bUDC);
01234         }
01235         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!fAnsi &amp;&amp; !<a class="code" href="../../d4/d0/immcli_8h.html#a21">TestICF</a>(pClientImc, <a class="code" href="../../d8/d0/immstruc_8h.html#a4">IMCF_UNICODE</a>)) {
01236             dwBufLenNeeded = MultiByteToWideChar(dwCodePage,
01237                                                  (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)MB_PRECOMPOSED,
01238                                                  (LPSTR)lpBufTemp,
01239                                                  (<a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>)lpGuideLine-&gt;dwStrLen,
01240                                                  (LPWSTR)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01241                                                  (<a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>)0);
01242             dwBufLenNeeded *= <span class="keyword">sizeof</span>(WCHAR);
01243         }
01244         <span class="keywordflow">else</span> {
01245             dwBufLenNeeded = lpGuideLine-&gt;dwStrLen;
01246             <span class="comment">/*</span>
01247 <span class="comment">             * The dwStrLen records the strlen and not the byte count.</span>
01248 <span class="comment">             */</span>
01249             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/immcli_8h.html#a21">TestICF</a>(pClientImc, <a class="code" href="../../d8/d0/immstruc_8h.html#a4">IMCF_UNICODE</a>))
01250                 dwBufLenNeeded *= <span class="keyword">sizeof</span>(WCHAR);
01251         }
01252 
01253         <span class="comment">/*</span>
01254 <span class="comment">         * Query GuideLine string size only or early exit on error</span>
01255 <span class="comment">         */</span>
01256         <span class="keywordflow">if</span> (dwBufLen == 0 || dwBufLenNeeded == 0) {
01257             dwRet = dwBufLenNeeded;
01258             <span class="keywordflow">goto</span> GetGuideLineUnlockIMCC;
01259         }
01260 
01261         <span class="keywordflow">if</span> (lpBuf == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || dwBufLen &lt; dwBufLenNeeded)
01262             <span class="keywordflow">goto</span> GetGuideLineUnlockIMCC;
01263 
01264         <span class="keywordflow">if</span> (fAnsi &amp;&amp; <a class="code" href="../../d4/d0/immcli_8h.html#a21">TestICF</a>(pClientImc, <a class="code" href="../../d8/d0/immstruc_8h.html#a4">IMCF_UNICODE</a>)) {
01265             dwRet = WideCharToMultiByte(dwCodePage,
01266                                         (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)0,
01267                                         (LPWSTR)lpBufTemp,
01268                                         (<a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>)lpGuideLine-&gt;dwStrLen,
01269                                         (LPSTR)lpBuf,
01270                                         (<a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>)dwBufLen,
01271                                         (LPSTR)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01272                                         (LPBOOL)&amp;bUDC);
01273         }
01274         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!fAnsi &amp;&amp; !<a class="code" href="../../d4/d0/immcli_8h.html#a21">TestICF</a>(pClientImc, <a class="code" href="../../d8/d0/immstruc_8h.html#a4">IMCF_UNICODE</a>)) {
01275             dwRet = MultiByteToWideChar(dwCodePage,
01276                                         (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)MB_PRECOMPOSED,
01277                                         (LPSTR)lpBufTemp,
01278                                         (<a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>)lpGuideLine-&gt;dwStrLen,
01279                                         (LPWSTR)lpBuf,
01280                                         (<a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>)dwBufLen/<span class="keyword">sizeof</span>(WCHAR));
01281             dwRet *= <span class="keyword">sizeof</span>(WCHAR);
01282         }
01283         <span class="keywordflow">else</span> {
01284             RtlCopyMemory(lpBuf, lpBufTemp, dwBufLenNeeded);
01285             dwRet = dwBufLenNeeded;
01286         }
01287 
01288         <span class="keywordflow">break</span>;
01289 
01290     <span class="keywordflow">case</span> GGL_PRIVATE:
01291 
01292         lpBufTemp = (LPBYTE)lpGuideLine + lpGuideLine-&gt;dwPrivateOffset;
01293 
01294         <span class="comment">/*</span>
01295 <span class="comment">         * The dwPrivateOffset is an offset to a CANDIDATELIST when</span>
01296 <span class="comment">         * lpGuideLine-&gt;dwIndex == GL_ID_REVERSECONVERSION. Do conversion</span>
01297 <span class="comment">         * for this case only.</span>
01298 <span class="comment">         */</span>
01299         <span class="keywordflow">if</span> (fAnsi &amp;&amp; <a class="code" href="../../d4/d0/immcli_8h.html#a21">TestICF</a>(pClientImc, <a class="code" href="../../d8/d0/immstruc_8h.html#a4">IMCF_UNICODE</a>) &amp;&amp;
01300                 lpGuideLine-&gt;dwIndex == GL_ID_REVERSECONVERSION) {
01301             dwBufLenNeeded = <a class="code" href="../../d4/d0/immcli_8h.html#a80">InternalGetCandidateListWtoA</a>(
01302                         (LPCANDIDATELIST)lpBufTemp, (LPCANDIDATELIST)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0, dwCodePage);
01303         }
01304         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!fAnsi &amp;&amp; !<a class="code" href="../../d4/d0/immcli_8h.html#a21">TestICF</a>(pClientImc, <a class="code" href="../../d8/d0/immstruc_8h.html#a4">IMCF_UNICODE</a>) &amp;&amp;
01305                 lpGuideLine-&gt;dwIndex == GL_ID_REVERSECONVERSION) {
01306             dwBufLenNeeded = <a class="code" href="../../d4/d0/immcli_8h.html#a79">InternalGetCandidateListAtoW</a>(
01307                         (LPCANDIDATELIST)lpBufTemp, (LPCANDIDATELIST)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0, dwCodePage);
01308         }
01309         <span class="keywordflow">else</span> {
01310             dwBufLenNeeded = lpGuideLine-&gt;dwPrivateSize;
01311         }
01312 
01313         <span class="comment">/*</span>
01314 <span class="comment">         * Query dwPrivateSize size only or early exit on error</span>
01315 <span class="comment">         */</span>
01316         <span class="keywordflow">if</span> (dwBufLen == 0 || dwBufLenNeeded == 0) {
01317             dwRet = dwBufLenNeeded;
01318             <span class="keywordflow">goto</span> GetGuideLineUnlockIMCC;
01319         }
01320 
01321         <span class="keywordflow">if</span> (lpBuf == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || dwBufLen &lt; dwBufLenNeeded)
01322             <span class="keywordflow">goto</span> GetGuideLineUnlockIMCC;
01323 
01324         <span class="keywordflow">if</span> (fAnsi &amp;&amp; <a class="code" href="../../d4/d0/immcli_8h.html#a21">TestICF</a>(pClientImc, <a class="code" href="../../d8/d0/immstruc_8h.html#a4">IMCF_UNICODE</a>) &amp;&amp;
01325                 lpGuideLine-&gt;dwIndex == GL_ID_REVERSECONVERSION) {
01326             dwRet = <a class="code" href="../../d4/d0/immcli_8h.html#a80">InternalGetCandidateListWtoA</a>(
01327                     (LPCANDIDATELIST)lpBufTemp, (LPCANDIDATELIST)lpBuf, dwBufLenNeeded, dwCodePage);
01328         }
01329         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!fAnsi &amp;&amp; !<a class="code" href="../../d4/d0/immcli_8h.html#a21">TestICF</a>(pClientImc, <a class="code" href="../../d8/d0/immstruc_8h.html#a4">IMCF_UNICODE</a>) &amp;&amp;
01330                 lpGuideLine-&gt;dwIndex == GL_ID_REVERSECONVERSION) {
01331             dwRet = <a class="code" href="../../d4/d0/immcli_8h.html#a79">InternalGetCandidateListAtoW</a>(
01332                     (LPCANDIDATELIST)lpBufTemp, (LPCANDIDATELIST)lpBuf, dwBufLenNeeded, dwCodePage);
01333         }
01334         <span class="keywordflow">else</span> {
01335             RtlCopyMemory(lpBuf, lpBufTemp, dwBufLenNeeded);
01336             dwRet = dwBufLenNeeded;
01337         }
01338 
01339         <span class="keywordflow">break</span>;
01340 
01341     <span class="keywordflow">default</span>:
01342         <span class="keywordflow">break</span>;
01343     }
01344 
01345 GetGuideLineUnlockIMCC:
01346     <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a18">ImmUnlockIMCC</a>(pInputContext-&gt;hGuideLine);
01347 
01348 GetGuideLineUnlockIMC:
01349     <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a13">ImmUnlockIMC</a>(hImc);
01350 
01351 GetGuideLineUnlockClientImc:
01352     <a class="code" href="../../d9/d0/immuser_8h.html#a44">ImmUnlockClientImc</a>(pClientImc);
01353 
01354 GetGuideLineExit:
01355     <span class="keywordflow">return</span> dwRet;
01356 }
01357 
01358 
01359 <span class="comment">/***************************************************************************\</span>
01360 <span class="comment">* ImmGetConversionStatus</span>
01361 <span class="comment">*</span>
01362 <span class="comment">* Gets current conversion status.</span>
01363 <span class="comment">*</span>
01364 <span class="comment">* History:</span>
01365 <span class="comment">* 26-Feb-1995   wkwok   Created</span>
01366 <span class="comment">\***************************************************************************/</span>
01367 
<a name="l01368"></a><a class="code" href="../../d4/d1/ctxtinfo_8c.html#a29">01368</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> WINAPI <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a29">ImmGetConversionStatus</a>(     <span class="comment">// Get the conversion status</span>
01369     HIMC    hImc,
01370     LPDWORD lpfdwConversion,
01371     LPDWORD lpfdwSentence)
01372 {
01373     PINPUTCONTEXT pInputContext;
01374 
01375     pInputContext = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a12">ImmLockIMC</a>(hImc);
01376     <span class="keywordflow">if</span> (pInputContext == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01377         RIPMSG1(RIP_WARNING, <span class="stringliteral">"ImmGetConversionStatus: Lock hImc %lx failed"</span>, hImc);
01378         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01379     }
01380 
01381     <span class="keywordflow">if</span> (lpfdwConversion != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01382         *lpfdwConversion = pInputContext-&gt;fdwConversion;
01383 
01384     <span class="keywordflow">if</span> (lpfdwSentence != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01385         *lpfdwSentence = pInputContext-&gt;fdwSentence;
01386 
01387     <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a13">ImmUnlockIMC</a>(hImc);
01388 
01389     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01390 }
01391 
01392 
01393 <span class="comment">/***************************************************************************\</span>
01394 <span class="comment">* ImmSetConversionStatus</span>
01395 <span class="comment">*</span>
01396 <span class="comment">* Sets current conversion status.</span>
01397 <span class="comment">*</span>
01398 <span class="comment">* History:</span>
01399 <span class="comment">* 26-Feb-1995   wkwok   Created</span>
01400 <span class="comment">\***************************************************************************/</span>
01401 
<a name="l01402"></a><a class="code" href="../../d4/d1/ctxtinfo_8c.html#a30">01402</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> WINAPI <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a30">ImmSetConversionStatus</a>(
01403     HIMC  hImc,
01404     DWORD fdwConversion,
01405     DWORD fdwSentence)
01406 {
01407     PINPUTCONTEXT pInputContext;
01408     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>         fdwOldConversion;
01409     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>         fdwOldSentence;
01410     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>          fConvModeChg;
01411     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>          fSentenceChg;
01412     HWND          <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>;
01413     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>         dwOpenStatus;
01414     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>         dwConversion;
01415 
01416     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/immcli_8h.html#a15">GetInputContextThread</a>(hImc) != GetCurrentThreadId()) {
01417         RIPMSG1(RIP_WARNING,
01418               <span class="stringliteral">"ImmSetConversionStatus: Invalid input context access %lx."</span>, hImc);
01419         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01420     }
01421 
01422     pInputContext = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a12">ImmLockIMC</a>(hImc);
01423     <span class="keywordflow">if</span> (pInputContext == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01424         RIPMSG1(RIP_WARNING,
01425               <span class="stringliteral">"ImmSetConversionStatus: Lock hImc %lx failed"</span>, hImc);
01426         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01427     }
01428 
01429     fConvModeChg = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01430     fSentenceChg = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01431 
01432     <span class="keywordflow">if</span> (pInputContext-&gt;fdwConversion != fdwConversion) {
01433         <span class="keywordflow">if</span> ((fdwConversion &amp; IME_CMODE_LANGUAGE) == IME_CMODE_KATAKANA) {
01434             RIPMSG0(RIP_WARNING, <span class="stringliteral">"ImmSetConversionStatus: wrong fdwConversion"</span>);
01435         }
01436         fdwOldConversion = pInputContext-&gt;fdwConversion;
01437         pInputContext-&gt;fdwConversion = fdwConversion;
01438         fConvModeChg = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01439     }
01440 
01441     <span class="keywordflow">if</span> (pInputContext-&gt;fdwSentence != fdwSentence) {
01442         fdwOldSentence = pInputContext-&gt;fdwSentence;
01443         pInputContext-&gt;fdwSentence = fdwSentence;
01444         fSentenceChg = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01445     }
01446 
01447     <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a> = pInputContext-&gt;hWnd;
01448     <span class="keywordflow">if</span> ( fConvModeChg ) {
01449 
01450         dwOpenStatus = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)pInputContext-&gt;fOpen;
01451         dwConversion = pInputContext-&gt;fdwConversion;
01452     }
01453 
01454     <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a13">ImmUnlockIMC</a>(hImc);
01455 
01456 <span class="preprocessor">#ifdef LATER</span>
01457 <span class="preprocessor"></span>    <span class="comment">// Do uNumLangVKey and uNumVKey checking later.</span>
01458 <span class="preprocessor">#endif</span>
01459 <span class="preprocessor"></span>
01460     <span class="comment">/*</span>
01461 <span class="comment">     * inform IME and UI about the conversion mode changes.</span>
01462 <span class="comment">     */</span>
01463     <span class="keywordflow">if</span> (fConvModeChg) {
01464         <a class="code" href="../../d4/d0/immcli_8h.html#a85">MakeIMENotify</a>(hImc, <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>, NI_CONTEXTUPDATED, fdwOldConversion,
01465                 IMC_SETCONVERSIONMODE, IMN_SETCONVERSIONMODE, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>);
01466 
01467         <span class="comment">/*</span>
01468 <span class="comment">         * notify shell and keyboard the conversion mode change</span>
01469 <span class="comment">         */</span>
01470         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a400">NtUserNotifyIMEStatus</a>( <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>, dwOpenStatus, dwConversion );
01471     }
01472 
01473     <span class="comment">/*</span>
01474 <span class="comment">     * inform IME and UI about the sentence mode changes.</span>
01475 <span class="comment">     */</span>
01476     <span class="keywordflow">if</span> (fSentenceChg) {
01477         <a class="code" href="../../d4/d0/immcli_8h.html#a85">MakeIMENotify</a>(hImc, <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>, NI_CONTEXTUPDATED, fdwOldSentence,
01478                 IMC_SETSENTENCEMODE, IMN_SETSENTENCEMODE, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>);
01479     }
01480 
01481     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01482 }
01483 
01484 
01485 <span class="comment">/***************************************************************************\</span>
01486 <span class="comment">* ImmGetOpenStatus</span>
01487 <span class="comment">*</span>
01488 <span class="comment">* Gets the open or close status of the IME.</span>
01489 <span class="comment">*</span>
01490 <span class="comment">* History:</span>
01491 <span class="comment">* 26-Feb-1995   wkwok   Created</span>
01492 <span class="comment">\***************************************************************************/</span>
01493 
<a name="l01494"></a><a class="code" href="../../d4/d1/ctxtinfo_8c.html#a31">01494</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> WINAPI <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a31">ImmGetOpenStatus</a>(
01495     HIMC hImc)
01496 {
01497     PINPUTCONTEXT pInputContext;
01498     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>          fOpen;
01499 
01500     <span class="keywordflow">if</span> (hImc == <a class="code" href="../../d8/d0/immstruc_8h.html#a0">NULL_HIMC</a>)
01501         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01502 
01503     pInputContext = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a12">ImmLockIMC</a>(hImc);
01504     <span class="keywordflow">if</span> (!pInputContext) {
01505         RIPMSG1(RIP_WARNING, <span class="stringliteral">"ImmGetOpenStatus: Lock hImc %lx failed"</span>, hImc);
01506         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01507     }
01508 
01509     fOpen = pInputContext-&gt;fOpen;
01510     <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a13">ImmUnlockIMC</a>(hImc);
01511 
01512     <span class="keywordflow">return</span> (fOpen);
01513 }
01514 
01515 
01516 <span class="comment">/***************************************************************************\</span>
01517 <span class="comment">* ImmSetOpenStatus</span>
01518 <span class="comment">*</span>
01519 <span class="comment">* Opens or closes the IME.</span>
01520 <span class="comment">*</span>
01521 <span class="comment">* History:</span>
01522 <span class="comment">* 26-Feb-1995   wkwok   Created</span>
01523 <span class="comment">\***************************************************************************/</span>
01524 
<a name="l01525"></a><a class="code" href="../../d4/d1/ctxtinfo_8c.html#a32">01525</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> WINAPI <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a32">ImmSetOpenStatus</a>(
01526     HIMC hImc,
01527     BOOL fOpen)
01528 {
01529     PINPUTCONTEXT pInputContext;
01530     HWND          <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>;
01531     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>         dwOpenStatus;
01532     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>         dwConversion;
01533     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>          fOpenChg = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01534 
01535     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/immcli_8h.html#a15">GetInputContextThread</a>(hImc) != GetCurrentThreadId()) {
01536         RIPMSG1(RIP_WARNING,
01537               <span class="stringliteral">"ImmSetOpenStatus: Invalid input context access %lx."</span>, hImc);
01538         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01539     }
01540 
01541     pInputContext = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a12">ImmLockIMC</a>(hImc);
01542     <span class="keywordflow">if</span> (!pInputContext) {
01543         RIPMSG1(RIP_WARNING, <span class="stringliteral">"ImmSetOpenStatus: Lock hImc %lx failed"</span>, hImc);
01544         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01545     }
01546 
01547     <span class="keywordflow">if</span> (pInputContext-&gt;fOpen != fOpen) {
01548         fOpenChg = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01549         pInputContext-&gt;fOpen = fOpen;
01550     }
01551 
01552     <span class="keywordflow">if</span> ( fOpenChg ) {
01553         <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a> = (HWND)pInputContext-&gt;hWnd;
01554         dwOpenStatus = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)pInputContext-&gt;fOpen;
01555         dwConversion = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)pInputContext-&gt;fdwConversion;
01556     }
01557 
01558     <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a13">ImmUnlockIMC</a>(hImc);
01559 
01560     <span class="comment">/*</span>
01561 <span class="comment">     * inform IME and UI about the conversion mode changes.</span>
01562 <span class="comment">     */</span>
01563     <span class="keywordflow">if</span> (fOpenChg) {
01564         <a class="code" href="../../d4/d0/immcli_8h.html#a85">MakeIMENotify</a>(hImc, <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>, NI_CONTEXTUPDATED, (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)0,
01565                 IMC_SETOPENSTATUS, IMN_SETOPENSTATUS, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>);
01566 
01567         <a class="code" href="../../d9/d9/kernel_2ntstubs_8c.html#a400">NtUserNotifyIMEStatus</a>( <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>, dwOpenStatus, dwConversion );
01568     }
01569 
01570     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01571 }
01572 
01573 
01574 <span class="comment">/***************************************************************************\</span>
01575 <span class="comment">* ImmGetCompositionFontA</span>
01576 <span class="comment">*</span>
01577 <span class="comment">* Opens or closes the IME.</span>
01578 <span class="comment">*</span>
01579 <span class="comment">* History:</span>
01580 <span class="comment">* 27-Feb-1995   wkwok   Created</span>
01581 <span class="comment">\***************************************************************************/</span>
01582 
<a name="l01583"></a><a class="code" href="../../d4/d1/ctxtinfo_8c.html#a33">01583</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> WINAPI <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a33">ImmGetCompositionFontA</a>(
01584     HIMC       hImc,
01585     LPLOGFONTA lpLogFontA)
01586 {
01587     <a class="code" href="../../d3/d0/structtagCLIENTIMC.html">PCLIENTIMC</a>    pClientImc;
01588     PINPUTCONTEXT pInputContext;
01589     LOGFONTW      LogFontW;
01590     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>          fUnicode, fRet;
01591 
01592     pClientImc = <a class="code" href="../../d9/d0/immuser_8h.html#a43">ImmLockClientImc</a>(hImc);
01593     <span class="keywordflow">if</span> (pClientImc == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01594         RIPMSG1(RIP_WARNING, <span class="stringliteral">"ImmGetCompositionFontA: Invalid hImc %lx."</span>, hImc);
01595         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01596     }
01597 
01598     fUnicode = <a class="code" href="../../d4/d0/immcli_8h.html#a21">TestICF</a>(pClientImc, <a class="code" href="../../d8/d0/immstruc_8h.html#a4">IMCF_UNICODE</a>);
01599 
01600     <a class="code" href="../../d9/d0/immuser_8h.html#a44">ImmUnlockClientImc</a>(pClientImc);
01601 
01602     pInputContext = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a12">ImmLockIMC</a>(hImc);
01603     <span class="keywordflow">if</span> (pInputContext == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01604         RIPMSG1(RIP_WARNING, <span class="stringliteral">"ImmGetCompositionFontA: Lock hImc %lx failed."</span>, hImc);
01605         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01606     }
01607 
01608     <span class="keywordflow">if</span> (fUnicode) {
01609 
01610         <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a13">ImmUnlockIMC</a>(hImc);
01611 
01612         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/ctxtinfo_8c.html#a34">ImmGetCompositionFontW</a>(hImc, &amp;LogFontW)) {
01613             <a class="code" href="../../d4/d0/immcli_8h.html#a84">LFontWtoLFontA</a>(&amp;LogFontW, lpLogFontA);
01614             <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01615         }
01616 
01617         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01618     }
01619 
01620     <span class="keywordflow">if</span> ((pInputContext-&gt;fdwInit &amp; INIT_LOGFONT) == INIT_LOGFONT) {
01621         *lpLogFontA = pInputContext-&gt;lfFont.A;
01622         fRet = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01623     }
01624     <span class="keywordflow">else</span> {
01625         fRet = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01626     }
01627 
01628     <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a13">ImmUnlockIMC</a>(hImc);
01629 
01630     <span class="keywordflow">return</span> fRet;
01631 }
01632 
01633 
01634 <span class="comment">/***************************************************************************\</span>
01635 <span class="comment">* ImmGetCompositionFontW</span>
01636 <span class="comment">*</span>
01637 <span class="comment">* Opens or closes the IME.</span>
01638 <span class="comment">*</span>
01639 <span class="comment">* History:</span>
01640 <span class="comment">* 27-Feb-1995   wkwok   Created</span>
01641 <span class="comment">\***************************************************************************/</span>
01642 
<a name="l01643"></a><a class="code" href="../../d4/d1/ctxtinfo_8c.html#a34">01643</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> WINAPI <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a34">ImmGetCompositionFontW</a>(
01644     HIMC       hImc,
01645     LPLOGFONTW lpLogFontW)
01646 {
01647     <a class="code" href="../../d3/d0/structtagCLIENTIMC.html">PCLIENTIMC</a>    pClientImc;
01648     PINPUTCONTEXT pInputContext;
01649     LOGFONTA      LogFontA;
01650     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>          fUnicode, fRet;
01651 
01652     pClientImc = <a class="code" href="../../d9/d0/immuser_8h.html#a43">ImmLockClientImc</a>(hImc);
01653     <span class="keywordflow">if</span> (pClientImc == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01654         RIPMSG1(RIP_WARNING, <span class="stringliteral">"ImmGetCompositionFontW: Invalid hImc %lx."</span>, hImc);
01655         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01656     }
01657 
01658     fUnicode = <a class="code" href="../../d4/d0/immcli_8h.html#a21">TestICF</a>(pClientImc, <a class="code" href="../../d8/d0/immstruc_8h.html#a4">IMCF_UNICODE</a>);
01659 
01660     <a class="code" href="../../d9/d0/immuser_8h.html#a44">ImmUnlockClientImc</a>(pClientImc);
01661 
01662     pInputContext = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a12">ImmLockIMC</a>(hImc);
01663     <span class="keywordflow">if</span> (!pInputContext) {
01664         RIPMSG1(RIP_WARNING, <span class="stringliteral">"ImmGetCompositionFontW: Lock hImc %lx failed."</span>, hImc);
01665         <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01666     }
01667 
01668     <span class="keywordflow">if</span> (!fUnicode) {
01669 
01670         <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a13">ImmUnlockIMC</a>(hImc);
01671 
01672         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/ctxtinfo_8c.html#a33">ImmGetCompositionFontA</a>(hImc, &amp;LogFontA)) {
01673             <a class="code" href="../../d4/d0/immcli_8h.html#a83">LFontAtoLFontW</a>(&amp;LogFontA, lpLogFontW);
01674             <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01675         }
01676 
01677         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01678     }
01679 
01680     <span class="keywordflow">if</span> ((pInputContext-&gt;fdwInit &amp; INIT_LOGFONT) == INIT_LOGFONT) {
01681         *lpLogFontW = pInputContext-&gt;lfFont.W;
01682         fRet = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01683     }
01684     <span class="keywordflow">else</span> {
01685         fRet = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01686     }
01687 
01688     <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a13">ImmUnlockIMC</a>(hImc);
01689 
01690     <span class="keywordflow">return</span> fRet;
01691 }
01692 
01693 
<a name="l01694"></a><a class="code" href="../../d4/d1/ctxtinfo_8c.html#a35">01694</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> WINAPI <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a35">ImmSetCompositionFontA</a>(
01695     HIMC       hImc,
01696     LPLOGFONTA lpLogFontA)
01697 {
01698     <a class="code" href="../../d3/d0/structtagCLIENTIMC.html">PCLIENTIMC</a>    pClientImc;
01699     PINPUTCONTEXT pInputContext;
01700     LOGFONTW      LogFontW;
01701     HWND          <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>;
01702     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>          fUnicode;
01703 
01704     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/immcli_8h.html#a15">GetInputContextThread</a>(hImc) != GetCurrentThreadId()) {
01705         RIPMSG1(RIP_WARNING,
01706               <span class="stringliteral">"ImmSetCompositionFontA: Invalid input context access %lx."</span>, hImc);
01707         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01708     }
01709 
01710     pClientImc = <a class="code" href="../../d9/d0/immuser_8h.html#a43">ImmLockClientImc</a>(hImc);
01711     <span class="keywordflow">if</span> (pClientImc == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01712         RIPMSG1(RIP_WARNING, <span class="stringliteral">"ImmSetCompositionFontA: Invalid hImc %lx."</span>, hImc);
01713         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01714     }
01715 
01716     fUnicode = <a class="code" href="../../d4/d0/immcli_8h.html#a21">TestICF</a>(pClientImc, <a class="code" href="../../d8/d0/immstruc_8h.html#a4">IMCF_UNICODE</a>);
01717 
01718     <a class="code" href="../../d9/d0/immuser_8h.html#a44">ImmUnlockClientImc</a>(pClientImc);
01719 
01720     pInputContext = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a12">ImmLockIMC</a>(hImc);
01721     <span class="keywordflow">if</span> (!pInputContext) {
01722         RIPMSG1(RIP_WARNING, <span class="stringliteral">"ImmSetCompositionFontA: Lock hImc %lx failed."</span>, hImc);
01723         <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01724     }
01725 
01726     <span class="keywordflow">if</span> (fUnicode) {
01727 
01728         <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a13">ImmUnlockIMC</a>(hImc);
01729 
01730         <a class="code" href="../../d4/d0/immcli_8h.html#a83">LFontAtoLFontW</a>(lpLogFontA, &amp;LogFontW);
01731 
01732         <span class="keywordflow">return</span> <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a36">ImmSetCompositionFontW</a>(hImc, &amp;LogFontW);
01733     }
01734 
01735     <span class="comment">/*</span>
01736 <span class="comment">     * Japanese 3.x applications need to receive 3.x compatible notification message.</span>
01737 <span class="comment">     *</span>
01738 <span class="comment">     */</span>
01739     <span class="keywordflow">if</span> ( (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a16">GetClientInfo</a>()-&gt;dwExpWinVer &lt; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a101">VER40</a>) &amp;&amp;
01740          (PRIMARYLANGID(LANGIDFROMLCID(GetSystemDefaultLCID())) == LANG_JAPANESE)   &amp;&amp;
01741          ! (pInputContext-&gt;fdw31Compat &amp; F31COMPAT_MCWHIDDEN) &amp;&amp;
01742          (pInputContext-&gt;cfCompForm.dwStyle != CFS_DEFAULT) ) {
01743 
01744         PostMessageA( pInputContext-&gt;hWnd, WM_IME_REPORT, IR_CHANGECONVERT, (LPARAM)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01745     }
01746 
01747     pInputContext-&gt;lfFont.A = *lpLogFontA;
01748     pInputContext-&gt;fdwInit |= INIT_LOGFONT;
01749     <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a> = pInputContext-&gt;hWnd;
01750 
01751     <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a13">ImmUnlockIMC</a>(hImc);
01752 
01753     <span class="comment">/*</span>
01754 <span class="comment">     * inform IME and UI about the change of composition font.</span>
01755 <span class="comment">     */</span>
01756     <a class="code" href="../../d4/d0/immcli_8h.html#a85">MakeIMENotify</a>(hImc, <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>, NI_CONTEXTUPDATED, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>,
01757             IMC_SETCOMPOSITIONFONT, IMN_SETCOMPOSITIONFONT, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>);
01758 
01759 
01760     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01761 }
01762 
01763 
<a name="l01764"></a><a class="code" href="../../d4/d1/ctxtinfo_8c.html#a36">01764</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> WINAPI <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a36">ImmSetCompositionFontW</a>(
01765     HIMC       hImc,
01766     LPLOGFONTW lpLogFontW)
01767 {
01768     <a class="code" href="../../d3/d0/structtagCLIENTIMC.html">PCLIENTIMC</a>    pClientImc;
01769     PINPUTCONTEXT pInputContext;
01770     LOGFONTA      LogFontA;
01771     HWND          <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>;
01772     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>          fUnicode;
01773 
01774     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/immcli_8h.html#a15">GetInputContextThread</a>(hImc) != GetCurrentThreadId()) {
01775         RIPMSG1(RIP_WARNING,
01776               <span class="stringliteral">"ImmSetCompositionFontW: Invalid input context access %lx."</span>, hImc);
01777         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01778     }
01779 
01780     pClientImc = <a class="code" href="../../d9/d0/immuser_8h.html#a43">ImmLockClientImc</a>(hImc);
01781     <span class="keywordflow">if</span> (pClientImc == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01782         RIPMSG1(RIP_WARNING, <span class="stringliteral">"ImmSetCompositionFontW: Invalid hImc %lx."</span>, hImc);
01783         <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01784     }
01785 
01786     fUnicode = <a class="code" href="../../d4/d0/immcli_8h.html#a21">TestICF</a>(pClientImc, <a class="code" href="../../d8/d0/immstruc_8h.html#a4">IMCF_UNICODE</a>);
01787 
01788     <a class="code" href="../../d9/d0/immuser_8h.html#a44">ImmUnlockClientImc</a>(pClientImc);
01789 
01790     pInputContext = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a12">ImmLockIMC</a>(hImc);
01791     <span class="keywordflow">if</span> (!pInputContext) {
01792         RIPMSG1(RIP_WARNING, <span class="stringliteral">"ImmSetCompositionFontW: Lock hImc %lx failed."</span>, hImc);
01793         <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01794     }
01795 
01796     <span class="keywordflow">if</span> (!fUnicode) {
01797 
01798         <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a13">ImmUnlockIMC</a>(hImc);
01799 
01800         <a class="code" href="../../d4/d0/immcli_8h.html#a84">LFontWtoLFontA</a>(lpLogFontW, &amp;LogFontA);
01801 
01802         <span class="keywordflow">return</span> <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a35">ImmSetCompositionFontA</a>(hImc, &amp;LogFontA);
01803     }
01804 
01805     <span class="comment">/*</span>
01806 <span class="comment">     * Japanese 3.x applications need to receive 3.x compatible notification message.</span>
01807 <span class="comment">     *</span>
01808 <span class="comment">     */</span>
01809     <span class="keywordflow">if</span> ( (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a16">GetClientInfo</a>()-&gt;dwExpWinVer &lt; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a101">VER40</a>) &amp;&amp;
01810          (PRIMARYLANGID(LANGIDFROMLCID(GetSystemDefaultLCID())) == LANG_JAPANESE)   &amp;&amp;
01811          ! (pInputContext-&gt;fdw31Compat &amp; F31COMPAT_MCWHIDDEN) &amp;&amp;
01812          (pInputContext-&gt;cfCompForm.dwStyle != CFS_DEFAULT) ) {
01813 
01814         PostMessageW( pInputContext-&gt;hWnd, WM_IME_REPORT, IR_CHANGECONVERT, (LPARAM)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01815     }
01816     pInputContext-&gt;lfFont.W = *lpLogFontW;
01817     pInputContext-&gt;fdwInit |= INIT_LOGFONT;
01818     <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a> = pInputContext-&gt;hWnd;
01819 
01820     <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a13">ImmUnlockIMC</a>(hImc);
01821 
01822     <span class="comment">/*</span>
01823 <span class="comment">     * inform IME and UI about the change of composition font.</span>
01824 <span class="comment">     */</span>
01825     <a class="code" href="../../d4/d0/immcli_8h.html#a85">MakeIMENotify</a>(hImc, <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>, NI_CONTEXTUPDATED, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>,
01826             IMC_SETCOMPOSITIONFONT, IMN_SETCOMPOSITIONFONT, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>);
01827 
01828     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01829 }
01830 
01831 
01832 <span class="comment">/***************************************************************************\</span>
01833 <span class="comment">* ImmGetConversionListA</span>
01834 <span class="comment">*</span>
01835 <span class="comment">* Obtains the list of FE character or word from one character or word.</span>
01836 <span class="comment">*</span>
01837 <span class="comment">* History:</span>
01838 <span class="comment">* 27-Feb-1995   wkwok   Created</span>
01839 <span class="comment">\***************************************************************************/</span>
01840 
<a name="l01841"></a><a class="code" href="../../d4/d1/ctxtinfo_8c.html#a37">01841</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> WINAPI <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a37">ImmGetConversionListA</a>(
01842     HKL             hKL,
01843     HIMC            hImc,
01844     LPCSTR          lpszSrc,
01845     LPCANDIDATELIST lpCandListA,
01846     DWORD           dwBufLen,
01847     UINT            uFlag)
01848 {
01849     <a class="code" href="../../d2/d7/structtagIMEDPI.html">PIMEDPI</a> pImeDpi;
01850     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>   dwRet;
01851     LPWSTR  lpwszSrc;
01852     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>   dwBufTemp;
01853     LPCANDIDATELIST lpCandListW;
01854     <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>     i;
01855     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>   dwCodePage;
01856 
01857     pImeDpi = <a class="code" href="../../d6/d0/immime_8c.html#a11">FindOrLoadImeDpi</a>(hKL);
01858 
01859     <span class="keywordflow">if</span> (pImeDpi == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01860         RIPMSG1(RIP_WARNING,
01861               <span class="stringliteral">"ImmGetConversionListA: cannot find DPI entry for hkl=%lx"</span>, hKL);
01862         <span class="keywordflow">return</span> (0);
01863     }
01864 
01865     dwCodePage = <a class="code" href="../../d4/d0/immcli_8h.html#a25">IMECodePage</a>(pImeDpi);
01866 
01867     <span class="keywordflow">if</span> (!(pImeDpi-&gt;<a class="code" href="../../d2/d7/structtagIMEDPI.html#o3">ImeInfo</a>.fdwProperty &amp; IME_PROP_UNICODE)) {
01868         <span class="comment">/*</span>
01869 <span class="comment">         * This is an ANSI call to an ANSI IME.</span>
01870 <span class="comment">         */</span>
01871         dwRet = (*pImeDpi-&gt;<a class="code" href="../../d2/d7/structtagIMEDPI.html#o8">pfn</a>.<a class="code" href="../../d3/d7/structtagIMEDPI_1_1__tagImeFunctions.html#o6">ImeConversionList</a>.a)(hImc, lpszSrc,
01872                                         lpCandListA, dwBufLen, uFlag);
01873         <a class="code" href="../../d9/d0/immuser_8h.html#a46">ImmUnlockImeDpi</a>(pImeDpi);
01874         <span class="keywordflow">return</span> dwRet;
01875     }
01876 
01877     <a class="code" href="../../d9/d0/immuser_8h.html#a46">ImmUnlockImeDpi</a>(pImeDpi);
01878 
01879     <span class="comment">/*</span>
01880 <span class="comment">     * This is an ANSI call to an Unicode IME.</span>
01881 <span class="comment">     */</span>
01882     <span class="keywordflow">if</span> (lpszSrc != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01883 
01884         dwBufTemp = (<a class="code" href="../../d2/d7/regtest_8c.html#a2">strlen</a>(lpszSrc) + 1) * <span class="keyword">sizeof</span>(WCHAR);
01885 
01886         lpwszSrc = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a22">ImmLocalAlloc</a>(0, dwBufTemp);
01887         <span class="keywordflow">if</span> (lpwszSrc == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
01888             <span class="keywordflow">return</span> (0);
01889 
01890         i = MultiByteToWideChar(dwCodePage,
01891                                 (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)MB_PRECOMPOSED,
01892                                 (LPSTR)lpszSrc,              <span class="comment">// src</span>
01893                                 (<a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>)<a class="code" href="../../d2/d7/regtest_8c.html#a2">strlen</a>(lpszSrc),
01894                                 (LPWSTR)lpwszSrc,            <span class="comment">// dest</span>
01895                                 (<a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>)dwBufTemp/<span class="keyword">sizeof</span>(WCHAR));
01896 
01897         lpwszSrc[i] = <span class="charliteral">'\0'</span>;
01898     }
01899     <span class="keywordflow">else</span> {
01900         lpwszSrc = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01901     }
01902 
01903     <span class="comment">/*</span>
01904 <span class="comment">     * Query the CandidateListW size required.</span>
01905 <span class="comment">     */</span>
01906     dwBufTemp = <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a38">ImmGetConversionListW</a>(hKL, hImc, lpwszSrc, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0, uFlag);
01907 
01908     <span class="keywordflow">if</span> (dwBufTemp == 0 || (lpCandListW = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a22">ImmLocalAlloc</a>(0, dwBufTemp)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01909         <span class="keywordflow">if</span> (lpwszSrc)
01910             <a class="code" href="../../d4/d0/immcli_8h.html#a8">ImmLocalFree</a>(lpwszSrc);
01911         <span class="keywordflow">return</span> (0);
01912     }
01913 
01914     <span class="comment">/*</span>
01915 <span class="comment">     * Now get the actual CandidateListW.</span>
01916 <span class="comment">     */</span>
01917     dwBufTemp = <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a38">ImmGetConversionListW</a>(hKL, hImc, lpwszSrc,
01918                                         lpCandListW, dwBufTemp, uFlag);
01919 
01920     <span class="comment">/*</span>
01921 <span class="comment">     * Query the CandidateListA size required.</span>
01922 <span class="comment">     */</span>
01923     <span class="keywordflow">if</span> (dwBufTemp != 0) {
01924         dwBufTemp = <a class="code" href="../../d4/d0/immcli_8h.html#a80">InternalGetCandidateListWtoA</a>(lpCandListW, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0, dwCodePage);
01925     }
01926 
01927     <span class="keywordflow">if</span> (dwBufLen == 0 || dwBufTemp == 0) {
01928         <span class="comment">/*</span>
01929 <span class="comment">         * Query required buffer size or error has happened.</span>
01930 <span class="comment">         */</span>
01931         dwRet = dwBufTemp;
01932     }
01933     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dwBufLen &lt; dwBufTemp) {
01934         <span class="comment">/*</span>
01935 <span class="comment">         * Not enough buffer area.</span>
01936 <span class="comment">         */</span>
01937         dwRet = 0;
01938     }
01939     <span class="keywordflow">else</span> {
01940         <span class="comment">/*</span>
01941 <span class="comment">         * Get the actual CandidateListA</span>
01942 <span class="comment">         */</span>
01943         dwRet = <a class="code" href="../../d4/d0/immcli_8h.html#a80">InternalGetCandidateListWtoA</a>(lpCandListW, lpCandListA, dwBufLen, dwCodePage);
01944     }
01945 
01946     <span class="keywordflow">if</span> (lpwszSrc)
01947         <a class="code" href="../../d4/d0/immcli_8h.html#a8">ImmLocalFree</a>(lpwszSrc);
01948     <a class="code" href="../../d4/d0/immcli_8h.html#a8">ImmLocalFree</a>(lpCandListW);
01949 
01950     <span class="keywordflow">return</span> dwRet;
01951 
01952 }
01953 
01954 
01955 <span class="comment">/***************************************************************************\</span>
01956 <span class="comment">* ImmGetConversionListW</span>
01957 <span class="comment">*</span>
01958 <span class="comment">* Obtains the list of FE character or word from one character or word.</span>
01959 <span class="comment">*</span>
01960 <span class="comment">* History:</span>
01961 <span class="comment">* 27-Feb-1995   wkwok   Created</span>
01962 <span class="comment">\***************************************************************************/</span>
01963 
<a name="l01964"></a><a class="code" href="../../d4/d1/ctxtinfo_8c.html#a38">01964</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> WINAPI <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a38">ImmGetConversionListW</a>(
01965     HKL             hKL,
01966     HIMC            hImc,
01967     LPCWSTR         lpwszSrc,
01968     LPCANDIDATELIST lpCandListW,
01969     DWORD           dwBufLen,
01970     UINT            uFlag)
01971 {
01972     <a class="code" href="../../d2/d7/structtagIMEDPI.html">PIMEDPI</a> pImeDpi;
01973     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>   dwRet;
01974     LPSTR   lpszSrc;
01975     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>   dwBufTemp;
01976     LPCANDIDATELIST lpCandListA;
01977     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>    bUDC;
01978     <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>     i;
01979     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>   dwCodePage;
01980 
01981     pImeDpi = <a class="code" href="../../d6/d0/immime_8c.html#a11">FindOrLoadImeDpi</a>(hKL);
01982 
01983     <span class="keywordflow">if</span> (pImeDpi == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01984         RIPMSG1(RIP_WARNING,
01985               <span class="stringliteral">"ImmGetConversionListW: cannot find DPI entry for hkl=%lx"</span>, hKL);
01986         <span class="keywordflow">return</span> (0);
01987     }
01988 
01989     dwCodePage = <a class="code" href="../../d4/d0/immcli_8h.html#a25">IMECodePage</a>(pImeDpi);
01990 
01991     <span class="keywordflow">if</span> (pImeDpi-&gt;<a class="code" href="../../d2/d7/structtagIMEDPI.html#o3">ImeInfo</a>.fdwProperty &amp; IME_PROP_UNICODE) {
01992         <span class="comment">/*</span>
01993 <span class="comment">         * This is an Unicode call to an Unicode IME.</span>
01994 <span class="comment">         */</span>
01995         dwRet = (*pImeDpi-&gt;<a class="code" href="../../d2/d7/structtagIMEDPI.html#o8">pfn</a>.<a class="code" href="../../d3/d7/structtagIMEDPI_1_1__tagImeFunctions.html#o6">ImeConversionList</a>.w)(hImc, lpwszSrc,
01996                                         lpCandListW, dwBufLen, uFlag);
01997         <a class="code" href="../../d9/d0/immuser_8h.html#a46">ImmUnlockImeDpi</a>(pImeDpi);
01998         <span class="keywordflow">return</span> dwRet;
01999     }
02000 
02001     <a class="code" href="../../d9/d0/immuser_8h.html#a46">ImmUnlockImeDpi</a>(pImeDpi);
02002 
02003     <span class="comment">/*</span>
02004 <span class="comment">     * This is an Unicode call to an ANSI IME.</span>
02005 <span class="comment">     */</span>
02006     <span class="keywordflow">if</span> (lpwszSrc != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02007 
02008         dwBufTemp = (wcslen(lpwszSrc) + 1) * <span class="keyword">sizeof</span>(WCHAR);
02009 
02010         lpszSrc = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a22">ImmLocalAlloc</a>(0, dwBufTemp);
02011         <span class="keywordflow">if</span> (lpszSrc == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
02012             <span class="keywordflow">return</span> (0);
02013 
02014         i = WideCharToMultiByte(dwCodePage,
02015                                 (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)0,
02016                                 lpwszSrc,
02017                                 (<a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>)wcslen(lpwszSrc),
02018                                 (LPSTR)lpszSrc,
02019                                 (<a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>)dwBufTemp,
02020                                 (LPSTR)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02021                                 (LPBOOL)&amp;bUDC);
02022 
02023         lpszSrc[i] = <span class="charliteral">'\0'</span>;
02024     }
02025     <span class="keywordflow">else</span> {
02026         lpszSrc = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02027     }
02028 
02029     <span class="comment">/*</span>
02030 <span class="comment">     * Query the CandidateListA size required.</span>
02031 <span class="comment">     */</span>
02032     dwBufTemp = <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a37">ImmGetConversionListA</a>(hKL, hImc, lpszSrc, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0, uFlag);
02033 
02034     <span class="keywordflow">if</span> (dwBufTemp == 0 || (lpCandListA = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a22">ImmLocalAlloc</a>(0, dwBufTemp)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02035         <span class="keywordflow">if</span> (lpszSrc)
02036             <a class="code" href="../../d4/d0/immcli_8h.html#a8">ImmLocalFree</a>(lpszSrc);
02037 
02038         <span class="keywordflow">return</span> (0);
02039     }
02040 
02041     <span class="comment">/*</span>
02042 <span class="comment">     * Now get the actual CandidateListA.</span>
02043 <span class="comment">     */</span>
02044     dwBufTemp = <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a37">ImmGetConversionListA</a>(hKL, hImc, lpszSrc,
02045                                         lpCandListA, dwBufTemp, uFlag);
02046 
02047     <span class="comment">/*</span>
02048 <span class="comment">     * Query the CandidateListW size required.</span>
02049 <span class="comment">     */</span>
02050     <span class="keywordflow">if</span> (dwBufTemp != 0) {
02051         dwBufTemp = <a class="code" href="../../d4/d0/immcli_8h.html#a79">InternalGetCandidateListAtoW</a>(lpCandListA, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0, dwCodePage);
02052     }
02053 
02054     <span class="keywordflow">if</span> (dwBufLen == 0 || dwBufTemp == 0) {
02055         <span class="comment">/*</span>
02056 <span class="comment">         * Query required buffer size or error has happened.</span>
02057 <span class="comment">         */</span>
02058         dwRet = dwBufTemp;
02059     }
02060     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dwBufLen &lt; dwBufTemp) {
02061         <span class="comment">/*</span>
02062 <span class="comment">         * Not enough buffer area.</span>
02063 <span class="comment">         */</span>
02064         dwRet = 0;
02065     }
02066     <span class="keywordflow">else</span> {
02067         <span class="comment">/*</span>
02068 <span class="comment">         * Get the actual CandidateListW</span>
02069 <span class="comment">         */</span>
02070         dwRet = <a class="code" href="../../d4/d0/immcli_8h.html#a79">InternalGetCandidateListAtoW</a>(lpCandListA, lpCandListW, dwBufLen, dwCodePage);
02071     }
02072 
02073     <span class="keywordflow">if</span> (lpszSrc)
02074         <a class="code" href="../../d4/d0/immcli_8h.html#a8">ImmLocalFree</a>(lpszSrc);
02075     <a class="code" href="../../d4/d0/immcli_8h.html#a8">ImmLocalFree</a>(lpCandListA);
02076 
02077     <span class="keywordflow">return</span> dwRet;
02078 }
02079 
02080 
02081 <span class="comment">/***************************************************************************\</span>
02082 <span class="comment">* ImmGetStatusWindowPos</span>
02083 <span class="comment">*</span>
02084 <span class="comment">* Gets the position, in screen coordinates, of the status window.</span>
02085 <span class="comment">*</span>
02086 <span class="comment">* History:</span>
02087 <span class="comment">* 27-Feb-1995   wkwok   Created</span>
02088 <span class="comment">\***************************************************************************/</span>
02089 
<a name="l02090"></a><a class="code" href="../../d4/d1/ctxtinfo_8c.html#a39">02090</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> WINAPI <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a39">ImmGetStatusWindowPos</a>(
02091     HIMC    hImc,
02092     LPPOINT lpptPos)
02093 {
02094     PINPUTCONTEXT pInputContext;
02095     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fStatusWndPosInited;
02096 
02097     pInputContext = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a12">ImmLockIMC</a>(hImc);
02098     <span class="keywordflow">if</span> (!pInputContext) {
02099         RIPMSG1(RIP_WARNING, <span class="stringliteral">"ImmGetStatusWindowPos: Lock hImc %lx failed"</span>, hImc);
02100         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02101     }
02102 
02103     fStatusWndPosInited = ((pInputContext-&gt;fdwInit &amp; INIT_STATUSWNDPOS) == INIT_STATUSWNDPOS);
02104     <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a13">ImmUnlockIMC</a>(hImc);
02105 
02106     <span class="keywordflow">if</span> (fStatusWndPosInited) {
02107         *lpptPos = pInputContext-&gt;ptStatusWndPos;
02108         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02109     }
02110 
02111     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02112 }
02113 
02114 
<a name="l02115"></a><a class="code" href="../../d4/d1/ctxtinfo_8c.html#a40">02115</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> WINAPI <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a40">ImmSetStatusWindowPos</a>(
02116     HIMC     hImc,
02117     LPPOINT  lpptPos)
02118 {
02119     PINPUTCONTEXT pInputContext;
02120     HWND          <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>;
02121 
02122     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/immcli_8h.html#a15">GetInputContextThread</a>(hImc) != GetCurrentThreadId()) {
02123         RIPMSG1(RIP_WARNING,
02124               <span class="stringliteral">"ImmSetStatusWindowPos: Invalid input context access %lx."</span>, hImc);
02125         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02126     }
02127 
02128     pInputContext = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a12">ImmLockIMC</a>(hImc);
02129     <span class="keywordflow">if</span> (!pInputContext) {
02130         RIPMSG1(RIP_WARNING, <span class="stringliteral">"ImmSetStatusWindowPos: Lock hImc %lx failed"</span>, hImc);
02131         <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02132     }
02133 
02134     pInputContext-&gt;ptStatusWndPos = *lpptPos;
02135     pInputContext-&gt;fdwInit |= INIT_STATUSWNDPOS;
02136 
02137     <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a> = pInputContext-&gt;hWnd;
02138 
02139     <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a13">ImmUnlockIMC</a>(hImc);
02140 
02141     <span class="comment">/*</span>
02142 <span class="comment">     * inform IME and UI about the change of composition font.</span>
02143 <span class="comment">     */</span>
02144     <a class="code" href="../../d4/d0/immcli_8h.html#a85">MakeIMENotify</a>(hImc, <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>, NI_CONTEXTUPDATED, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>,
02145             IMC_SETSTATUSWINDOWPOS, IMN_SETSTATUSWINDOWPOS, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>);
02146 
02147     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02148 }
02149 
02150 
02151 <span class="comment">/***************************************************************************\</span>
02152 <span class="comment">* ImmGetCompositionWindow</span>
02153 <span class="comment">*</span>
02154 <span class="comment">* Gets the information of the composition window.</span>
02155 <span class="comment">*</span>
02156 <span class="comment">* History:</span>
02157 <span class="comment">* 27-Feb-1995   wkwok   Created</span>
02158 <span class="comment">\***************************************************************************/</span>
02159 
<a name="l02160"></a><a class="code" href="../../d4/d1/ctxtinfo_8c.html#a41">02160</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> WINAPI <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a41">ImmGetCompositionWindow</a>(
02161     HIMC              hImc,
02162     LPCOMPOSITIONFORM lpCompForm)
02163 {
02164     PINPUTCONTEXT pInputContext;
02165     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fCompFormInited;
02166 
02167     pInputContext = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a12">ImmLockIMC</a>(hImc);
02168     <span class="keywordflow">if</span> (!pInputContext) {
02169         RIPMSG1(RIP_WARNING, <span class="stringliteral">"ImmGetCompositionWindow: Lock hImc %lx failed"</span>, hImc);
02170         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02171     }
02172 
02173     fCompFormInited = ((pInputContext-&gt;fdwInit &amp; INIT_COMPFORM) == INIT_COMPFORM);
02174     <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a13">ImmUnlockIMC</a>(hImc);
02175 
02176     <span class="keywordflow">if</span> (fCompFormInited) {
02177         *lpCompForm = pInputContext-&gt;cfCompForm;
02178         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02179     }
02180 
02181     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02182 }
02183 
02184 
<a name="l02185"></a><a class="code" href="../../d4/d1/ctxtinfo_8c.html#a42">02185</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> WINAPI <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a42">ImmSetCompositionWindow</a>(
02186     HIMC              hImc,
02187     LPCOMPOSITIONFORM lpCompForm)
02188 {
02189     PINPUTCONTEXT pInputContext;
02190     HWND          <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>;
02191 
02192     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/immcli_8h.html#a15">GetInputContextThread</a>(hImc) != GetCurrentThreadId()) {
02193         RIPMSG1(RIP_WARNING,
02194               <span class="stringliteral">"ImmSetCompositionWindow: Invalid input context access %lx."</span>, hImc);
02195         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02196     }
02197 
02198     pInputContext = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a12">ImmLockIMC</a>(hImc);
02199     <span class="keywordflow">if</span> (!pInputContext) {
02200         RIPMSG1(RIP_WARNING, <span class="stringliteral">"ImmSetCompositionWindow: Lock hImc %lx failed"</span>, hImc);
02201         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02202     }
02203 
02204     pInputContext-&gt;cfCompForm = *lpCompForm;
02205     pInputContext-&gt;fdwInit |= INIT_COMPFORM;
02206 
02207     <span class="comment">/*</span>
02208 <span class="comment">     * Only WINNLS.DLL set F31COMPAT_MCWHIDDEN.</span>
02209 <span class="comment">     * When the apps or edit control calls this API, we need to remove</span>
02210 <span class="comment">     * F31COMPAT_MCWHIDDEN.</span>
02211 <span class="comment">     */</span>
02212     <span class="keywordflow">if</span> (pInputContext-&gt;fdw31Compat &amp; F31COMPAT_CALLFROMWINNLS)
02213        pInputContext-&gt;fdw31Compat &amp;= ~F31COMPAT_CALLFROMWINNLS;
02214     <span class="keywordflow">else</span>
02215        pInputContext-&gt;fdw31Compat &amp;= ~F31COMPAT_MCWHIDDEN;
02216 
02217     <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a> = pInputContext-&gt;hWnd;
02218 
02219     <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a13">ImmUnlockIMC</a>(hImc);
02220 
02221     <span class="comment">/*</span>
02222 <span class="comment">     * inform IME and UI about the change of composition window.</span>
02223 <span class="comment">     */</span>
02224     <a class="code" href="../../d4/d0/immcli_8h.html#a85">MakeIMENotify</a>(hImc, <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>, NI_CONTEXTUPDATED, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>,
02225             IMC_SETCOMPOSITIONWINDOW, IMN_SETCOMPOSITIONWINDOW, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>);
02226 
02227     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02228 }
02229 
02230 
02231 <span class="comment">/***************************************************************************\</span>
02232 <span class="comment">* ImmGetCandidateWindow</span>
02233 <span class="comment">*</span>
02234 <span class="comment">* Gets the information of the candidate window specified by dwIndex.</span>
02235 <span class="comment">*</span>
02236 <span class="comment">* History:</span>
02237 <span class="comment">* 27-Feb-1995   wkwok   Created</span>
02238 <span class="comment">\***************************************************************************/</span>
02239 
<a name="l02240"></a><a class="code" href="../../d4/d1/ctxtinfo_8c.html#a43">02240</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> WINAPI <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a43">ImmGetCandidateWindow</a>(
02241     HIMC              hImc,
02242     DWORD             dwIndex,
02243     LPCANDIDATEFORM   lpCandForm)
02244 {
02245     PINPUTCONTEXT pInputContext;
02246 
02247     pInputContext = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a12">ImmLockIMC</a>(hImc);
02248     <span class="keywordflow">if</span> (!pInputContext) {
02249         RIPMSG1(RIP_WARNING, <span class="stringliteral">"ImmGetCandidateWindow: Lock hImc %lx failed"</span>, hImc);
02250         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02251     }
02252 
02253     <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a13">ImmUnlockIMC</a>(hImc);
02254 
02255     <span class="keywordflow">if</span> (pInputContext-&gt;cfCandForm[dwIndex].dwIndex == -1) {
02256         <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a13">ImmUnlockIMC</a>(hImc);
02257         <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02258     }
02259 
02260     *lpCandForm = pInputContext-&gt;cfCandForm[dwIndex];
02261     <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a13">ImmUnlockIMC</a>(hImc);
02262     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02263 }
02264 
02265 
<a name="l02266"></a><a class="code" href="../../d4/d1/ctxtinfo_8c.html#a44">02266</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> WINAPI <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a44">ImmSetCandidateWindow</a>(
02267     HIMC              hImc,
02268     LPCANDIDATEFORM   lpCandForm)
02269 {
02270     PINPUTCONTEXT pInputContext;
02271     HWND          <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>;
02272 
02273     <span class="keywordflow">if</span> (lpCandForm-&gt;dwIndex &gt;= 4)      <span class="comment">// over flow candidate index</span>
02274         <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02275 
02276     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/immcli_8h.html#a15">GetInputContextThread</a>(hImc) != GetCurrentThreadId()) {
02277         RIPMSG1(RIP_WARNING,
02278               <span class="stringliteral">"ImmSetCandidateWindow: Invalid input context access %lx."</span>, hImc);
02279         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02280     }
02281 
02282     pInputContext = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a12">ImmLockIMC</a>(hImc);
02283     <span class="keywordflow">if</span> (!pInputContext) {
02284         RIPMSG1(RIP_WARNING, <span class="stringliteral">"ImmSetCandidateWindow: Lock hImc %lx failed"</span>, hImc);
02285         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02286     }
02287 
02288     pInputContext-&gt;cfCandForm[lpCandForm-&gt;dwIndex] = *lpCandForm;
02289 
02290     <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a> = pInputContext-&gt;hWnd;
02291 
02292     <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a13">ImmUnlockIMC</a>(hImc);
02293 
02294     <span class="comment">/*</span>
02295 <span class="comment">     * inform IME and UI about the change of composition window.</span>
02296 <span class="comment">     */</span>
02297     <a class="code" href="../../d4/d0/immcli_8h.html#a85">MakeIMENotify</a>(hImc, <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>, NI_CONTEXTUPDATED, 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>, IMC_SETCANDIDATEPOS,
02298             IMN_SETCANDIDATEPOS, (LPARAM)(0x01 &lt;&lt; lpCandForm-&gt;dwIndex));
02299 
02300     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02301 }
02302 
02303 
<a name="l02304"></a><a class="code" href="../../d4/d1/ctxtinfo_8c.html#a0">02304</a> <span class="preprocessor">#define GetCompInfoA(Component)                                                \</span>
02305 <span class="preprocessor">        if (!dwBufLen) {    </span><span class="comment">/* query required buffer size */</span>                   \
02306                             <span class="comment">/* not include \0             */</span>                   \
02307             dwBufLen = pCompStr-&gt;dw ## Component ## Len * sizeof(CHAR);        \
02308         } else {                                                               \
02309             if (dwBufLen &gt; pCompStr-&gt;dw ## Component ## Len * sizeof(CHAR)) {  \
02310                 dwBufLen = pCompStr-&gt;dw ## Component ## Len * sizeof(CHAR);    \
02311             }                                                                  \
02312             <span class="comment">/* don't copy \0, maybe there is actually none */</span>                  \
02313             RtlCopyMemory((LPBYTE)lpBuf, (LPBYTE)pCompStr +                    \
02314                 pCompStr-&gt;dw ## Component ## Offset, dwBufLen);                \
02315         }
02316 
<a name="l02317"></a><a class="code" href="../../d4/d1/ctxtinfo_8c.html#a1">02317</a> <span class="preprocessor">#define GetCompInfoW(Component)                                                \</span>
02318 <span class="preprocessor">        if (!dwBufLen) {    </span><span class="comment">/* query required buffer size */</span>                   \
02319                             <span class="comment">/* not include \0             */</span>                   \
02320             dwBufLen = pCompStr-&gt;dw ## Component ## Len * sizeof(WCHAR);       \
02321         } else {                                                               \
02322             if (dwBufLen &gt; pCompStr-&gt;dw ## Component ## Len * sizeof(WCHAR)) { \
02323                 dwBufLen = pCompStr-&gt;dw ## Component ## Len * sizeof(WCHAR);   \
02324             }                                                                  \
02325             <span class="comment">/* don't copy \0, maybe there is actually none */</span>                  \
02326             RtlCopyMemory((LPBYTE)lpBuf, (LPBYTE)pCompStr +                    \
02327                 pCompStr-&gt;dw ## Component ## Offset, dwBufLen);                \
02328         }
02329 
02330 <span class="comment">/***************************************************************************\</span>
02331 <span class="comment">* InternalGetCompositionStringA</span>
02332 <span class="comment">*</span>
02333 <span class="comment">* Internal version of ImmGetCompositionStringA.</span>
02334 <span class="comment">*</span>
02335 <span class="comment">* History:</span>
02336 <span class="comment">* 28-Feb-1995   wkwok   Created</span>
02337 <span class="comment">\***************************************************************************/</span>
02338 
<a name="l02339"></a><a class="code" href="../../d4/d1/ctxtinfo_8c.html#a45">02339</a> LONG <a class="code" href="../../d4/d0/immcli_8h.html#a77">InternalGetCompositionStringA</a>(
02340     PCOMPOSITIONSTRING pCompStr,
02341     DWORD              dwIndex,
02342     LPVOID             lpBuf,
02343     DWORD              dwBufLen,
02344     BOOL               fAnsiImc,
02345     DWORD              dwCodePage)
02346 {
02347     <span class="keywordflow">if</span> (fAnsiImc) {
02348         <span class="comment">/*</span>
02349 <span class="comment">         * Composition string in input context is of ANSI style.</span>
02350 <span class="comment">         */</span>
02351         <span class="keywordflow">switch</span> (dwIndex) {
02352         <span class="keywordflow">case</span> GCS_COMPSTR:
02353             <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a0">GetCompInfoA</a>(CompStr);
02354             <span class="keywordflow">break</span>;
02355         <span class="keywordflow">case</span> GCS_COMPATTR:
02356             <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a0">GetCompInfoA</a>(CompAttr);
02357             <span class="keywordflow">break</span>;
02358         <span class="keywordflow">case</span> GCS_COMPREADSTR:
02359             <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a0">GetCompInfoA</a>(CompReadStr);
02360             <span class="keywordflow">break</span>;
02361         <span class="keywordflow">case</span> GCS_COMPREADATTR:
02362             <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a0">GetCompInfoA</a>(CompReadAttr);
02363             <span class="keywordflow">break</span>;
02364         <span class="keywordflow">case</span> GCS_COMPREADCLAUSE:
02365             <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a0">GetCompInfoA</a>(CompReadClause);
02366             <span class="keywordflow">break</span>;
02367         <span class="keywordflow">case</span> GCS_CURSORPOS:
02368             dwBufLen = (LONG)pCompStr-&gt;dwCursorPos;
02369             <span class="keywordflow">break</span>;
02370         <span class="keywordflow">case</span> GCS_DELTASTART:
02371             dwBufLen = (LONG)pCompStr-&gt;dwDeltaStart;
02372             <span class="keywordflow">break</span>;
02373         <span class="keywordflow">case</span> GCS_RESULTSTR:
02374             <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a0">GetCompInfoA</a>(ResultStr);
02375             <span class="keywordflow">break</span>;
02376         <span class="keywordflow">case</span> GCS_RESULTCLAUSE:
02377             <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a0">GetCompInfoA</a>(ResultClause);
02378             <span class="keywordflow">break</span>;
02379         <span class="keywordflow">case</span> GCS_RESULTREADSTR:
02380             <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a0">GetCompInfoA</a>(ResultReadStr);
02381             <span class="keywordflow">break</span>;
02382         <span class="keywordflow">case</span> GCS_RESULTREADCLAUSE:
02383             <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a0">GetCompInfoA</a>(ResultReadClause);
02384             <span class="keywordflow">break</span>;
02385         <span class="keywordflow">case</span> GCS_COMPCLAUSE:
02386             <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a0">GetCompInfoA</a>(CompClause);
02387             <span class="keywordflow">break</span>;
02388         <span class="keywordflow">default</span>:
02389             dwBufLen = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)(LONG)IMM_ERROR_GENERAL;
02390             <span class="keywordflow">break</span>;
02391         }
02392 
02393         <span class="keywordflow">return</span> (LONG)dwBufLen;
02394     }
02395 
02396     <span class="comment">/*</span>
02397 <span class="comment">     * ANSI caller, Unicode input context/composition string.</span>
02398 <span class="comment">     */</span>
02399     <span class="keywordflow">switch</span> (dwIndex) {
02400     <span class="keywordflow">case</span> GCS_COMPSTR:
02401     <span class="keywordflow">case</span> GCS_COMPREADSTR:
02402     <span class="keywordflow">case</span> GCS_RESULTSTR:
02403     <span class="keywordflow">case</span> GCS_RESULTREADSTR:
02404     {
02405         <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>  dwStrSize;
02406         LPWSTR lpStrW;
02407         <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>   bUDC;
02408 
02409         <span class="comment">/*</span>
02410 <span class="comment">         * Get ANSI string from Unicode composition string.</span>
02411 <span class="comment">         */</span>
02412         dwStrSize = <a class="code" href="../../d4/d0/immcli_8h.html#a78">InternalGetCompositionStringW</a>(pCompStr, dwIndex,
02413                                             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0, fAnsiImc, dwCodePage);
02414 
02415         lpStrW = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a22">ImmLocalAlloc</a>(HEAP_ZERO_MEMORY, dwStrSize + <span class="keyword">sizeof</span>(WCHAR));
02416         <span class="keywordflow">if</span> (lpStrW == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02417             RIPMSG0(RIP_WARNING, <span class="stringliteral">"InternalGetCompositionStringA: memory failure."</span>);
02418             <span class="keywordflow">return</span> (LONG)IMM_ERROR_GENERAL;
02419         }
02420 
02421         dwStrSize = <a class="code" href="../../d4/d0/immcli_8h.html#a78">InternalGetCompositionStringW</a>(pCompStr, dwIndex,
02422                                             lpStrW, dwStrSize, fAnsiImc, dwCodePage);
02423 
02424         dwBufLen = WideCharToMultiByte(dwCodePage,
02425                                        (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)0,
02426                                        lpStrW,          <span class="comment">// src</span>
02427                                        wcslen(lpStrW),
02428                                        (LPSTR)lpBuf,    <span class="comment">// dest</span>
02429                                        dwBufLen,
02430                                        (LPSTR)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02431                                        (LPBOOL)&amp;bUDC);
02432 
02433         <a class="code" href="../../d4/d0/immcli_8h.html#a8">ImmLocalFree</a>(lpStrW);
02434         <span class="keywordflow">break</span>;
02435     }
02436 
02437     <span class="keywordflow">case</span> GCS_COMPATTR:
02438     <span class="keywordflow">case</span> GCS_COMPREADATTR:
02439     {
02440         <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwAttrLenW, dwIndexStr, dwStrSize;
02441         <a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a> lpAttrA, lpAttrW;
02442         LPSTR lpStrA, lpStrT;
02443         <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>  <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a>;
02444 
02445         <span class="comment">/*</span>
02446 <span class="comment">         * Get ANSI attribute from Unicode composition attribute.</span>
02447 <span class="comment">         */</span>
02448         <span class="keywordflow">switch</span> (dwIndex) {
02449         <span class="keywordflow">case</span> GCS_COMPATTR:
02450             lpAttrW = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pCompStr + pCompStr-&gt;dwCompAttrOffset;
02451             dwAttrLenW = pCompStr-&gt;dwCompAttrLen;
02452             dwIndexStr = GCS_COMPSTR;
02453             <span class="keywordflow">break</span>;
02454         <span class="keywordflow">case</span> GCS_COMPREADATTR:
02455             lpAttrW = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pCompStr + pCompStr-&gt;dwCompReadAttrOffset;
02456             dwAttrLenW = pCompStr-&gt;dwCompReadAttrLen;
02457             dwIndexStr = GCS_COMPREADSTR;
02458             <span class="keywordflow">break</span>;
02459         }
02460 
02461         <span class="keywordflow">if</span> (dwAttrLenW == 0) {
02462             <span class="comment">/*</span>
02463 <span class="comment">             * No CompAttr or CompReadAttr exists, do nothing.</span>
02464 <span class="comment">             */</span>
02465             <span class="keywordflow">return</span> 0;
02466         }
02467 
02468         dwStrSize = <a class="code" href="../../d4/d0/immcli_8h.html#a77">InternalGetCompositionStringA</a>(pCompStr,
02469                                         dwIndexStr, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0, fAnsiImc, dwCodePage);
02470 
02471         <span class="keywordflow">if</span> (dwStrSize == (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)(LONG)IMM_ERROR_GENERAL) {
02472             RIPMSG0(RIP_WARNING, <span class="stringliteral">"InternalGetCompositionStringA: IMM_ERROR_GENERAL."</span>);
02473             <span class="keywordflow">return</span> (LONG)IMM_ERROR_GENERAL;
02474         }
02475 
02476         <span class="comment">/*</span>
02477 <span class="comment">         * Query required size or early exit on error.</span>
02478 <span class="comment">         */</span>
02479         <span class="keywordflow">if</span> (dwBufLen == 0 || dwStrSize == 0)
02480             <span class="keywordflow">return</span> dwStrSize;
02481 
02482         lpStrA = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a22">ImmLocalAlloc</a>(HEAP_ZERO_MEMORY, dwStrSize + <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>));
02483         <span class="keywordflow">if</span> (lpStrA == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02484             RIPMSG0(RIP_WARNING, <span class="stringliteral">"InternalGetCompositionStringA: memory failure."</span>);
02485             <span class="keywordflow">return</span> (LONG)IMM_ERROR_GENERAL;
02486         }
02487 
02488         dwStrSize = <a class="code" href="../../d4/d0/immcli_8h.html#a77">InternalGetCompositionStringA</a>(pCompStr,
02489                                         dwIndexStr, lpStrA, dwStrSize, fAnsiImc, dwCodePage);
02490 
02491         <span class="keywordflow">if</span> (dwStrSize == (LONG)IMM_ERROR_GENERAL) {
02492             RIPMSG0(RIP_WARNING, <span class="stringliteral">"InternalGetCompositionStringA: IMM_ERROR_GENERAL."</span>);
02493             <a class="code" href="../../d4/d0/immcli_8h.html#a8">ImmLocalFree</a>(lpStrA);
02494             <span class="keywordflow">return</span> (LONG)IMM_ERROR_GENERAL;
02495         }
02496 
02497         lpStrT = lpStrA;
02498         lpAttrA = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)lpBuf;
02499 
02500         <span class="keywordflow">while</span> ((<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a>=*lpStrT++) != <span class="charliteral">'\0'</span> &amp;&amp; dwBufLen != 0 &amp;&amp; dwAttrLenW-- != 0) {
02501             <span class="keywordflow">if</span> (IsDBCSLeadByteEx(dwCodePage, <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a>)) {
02502                 <span class="keywordflow">if</span> (dwBufLen &gt;= 2) {
02503                     *lpAttrA++ = *lpAttrW;
02504                     *lpAttrA++ = *lpAttrW;
02505                     dwBufLen--;
02506                 }
02507                 <span class="keywordflow">else</span> {
02508                     *lpAttrA++ = *lpAttrW;
02509                 }
02510                 lpStrT++;
02511             }
02512             <span class="keywordflow">else</span> {
02513                 *lpAttrA++ = *lpAttrW;
02514             }
02515             lpAttrW++;
02516             dwBufLen--;
02517         }
02518 
02519         dwBufLen = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)(lpAttrA - (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)lpBuf);
02520 
02521         <a class="code" href="../../d4/d0/immcli_8h.html#a8">ImmLocalFree</a>(lpStrA);
02522         <span class="keywordflow">break</span>;
02523     }
02524 
02525     <span class="keywordflow">case</span> GCS_COMPCLAUSE:
02526     <span class="keywordflow">case</span> GCS_COMPREADCLAUSE:
02527     <span class="keywordflow">case</span> GCS_RESULTCLAUSE:
02528     <span class="keywordflow">case</span> GCS_RESULTREADCLAUSE:
02529     {
02530         LPWSTR  lpStrW;
02531         <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>   dwClauseLen, dwBufLenA;
02532         LPDWORD lpdwSrc, lpdwDst;
02533         <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>    i;
02534 
02535         <span class="comment">/*</span>
02536 <span class="comment">         * Get ANSI clause from Unicode composition clause.</span>
02537 <span class="comment">         */</span>
02538         <span class="keywordflow">switch</span> (dwIndex) {
02539         <span class="keywordflow">case</span> GCS_COMPCLAUSE:
02540             lpStrW = (LPWSTR)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pCompStr + pCompStr-&gt;dwCompStrOffset);
02541             lpdwSrc = (LPDWORD)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pCompStr + pCompStr-&gt;dwCompClauseOffset);
02542             dwClauseLen = pCompStr-&gt;dwCompClauseLen;
02543             <span class="keywordflow">break</span>;
02544         <span class="keywordflow">case</span> GCS_COMPREADCLAUSE:
02545             lpStrW = (LPWSTR)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pCompStr + pCompStr-&gt;dwCompReadStrOffset);
02546             lpdwSrc = (LPDWORD)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pCompStr + pCompStr-&gt;dwCompReadClauseOffset);
02547             dwClauseLen = pCompStr-&gt;dwCompReadClauseLen;
02548             <span class="keywordflow">break</span>;
02549         <span class="keywordflow">case</span> GCS_RESULTCLAUSE:
02550             lpStrW = (LPWSTR)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pCompStr + pCompStr-&gt;dwResultStrOffset);
02551             lpdwSrc = (LPDWORD)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pCompStr + pCompStr-&gt;dwResultClauseOffset);
02552             dwClauseLen = pCompStr-&gt;dwResultClauseLen;
02553             <span class="keywordflow">break</span>;
02554         <span class="keywordflow">case</span> GCS_RESULTREADCLAUSE:
02555             lpStrW = (LPWSTR)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pCompStr + pCompStr-&gt;dwResultReadStrOffset);
02556             lpdwSrc = (LPDWORD)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pCompStr + pCompStr-&gt;dwResultReadClauseOffset);
02557             dwClauseLen = pCompStr-&gt;dwResultReadClauseLen;
02558             <span class="keywordflow">break</span>;
02559         }
02560 
02561         <span class="comment">/*</span>
02562 <span class="comment">         * Query clause length or early exit on error.</span>
02563 <span class="comment">         */</span>
02564         <span class="keywordflow">if</span> (dwBufLen == 0 || (LONG)dwClauseLen &lt; 0) {
02565             dwBufLen = dwClauseLen;
02566             <span class="keywordflow">break</span>;
02567         }
02568 
02569         lpdwDst = (LPDWORD)lpBuf;
02570         dwBufLenA = dwBufLen / <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>);
02571 
02572         <span class="keywordflow">for</span> (i = 0; i &lt; dwClauseLen / <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>) &amp;&amp; dwBufLenA != 0; i++) {
02573             *lpdwDst++ = <a class="code" href="../../d4/d0/immcli_8h.html#a82">CalcCharacterPositionWtoA</a>(*lpdwSrc++, lpStrW, dwCodePage);
02574             dwBufLenA--;
02575         }
02576 
02577         dwBufLen = i * <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>);
02578         <span class="keywordflow">break</span>;
02579     }
02580 
02581     <span class="keywordflow">case</span> GCS_CURSORPOS:
02582     <span class="keywordflow">case</span> GCS_DELTASTART:
02583         <span class="comment">/*</span>
02584 <span class="comment">         * Get ANSI cursor/delta start position from Unicode composition string.</span>
02585 <span class="comment">         */</span>
02586         <span class="keywordflow">switch</span> (dwIndex) {
02587         <span class="keywordflow">case</span> GCS_CURSORPOS:
02588             dwBufLen = pCompStr-&gt;dwCursorPos;
02589             <span class="keywordflow">break</span>;
02590         <span class="keywordflow">case</span> GCS_DELTASTART:
02591             dwBufLen = pCompStr-&gt;dwDeltaStart;
02592             <span class="keywordflow">break</span>;
02593         }
02594 
02595         <span class="keywordflow">if</span> ((LONG)dwBufLen &gt; 0) {
02596             dwBufLen = <a class="code" href="../../d4/d0/immcli_8h.html#a82">CalcCharacterPositionWtoA</a>(dwBufLen,
02597                             (LPWSTR)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pCompStr + pCompStr-&gt;dwCompStrOffset),
02598                             dwCodePage);
02599         }
02600         <span class="keywordflow">break</span>;
02601 
02602     <span class="keywordflow">default</span>:
02603         dwBufLen = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)(LONG)IMM_ERROR_GENERAL;
02604     }
02605 
02606     <span class="keywordflow">return</span> (LONG)dwBufLen;
02607 }
02608 
02609 
02610 <span class="comment">/***************************************************************************\</span>
02611 <span class="comment">* InternalGetCompositionStringW</span>
02612 <span class="comment">*</span>
02613 <span class="comment">* Internal version of ImmGetCompositionStringW.</span>
02614 <span class="comment">*</span>
02615 <span class="comment">* History:</span>
02616 <span class="comment">* 28-Feb-1995   wkwok   Created</span>
02617 <span class="comment">\***************************************************************************/</span>
02618 
<a name="l02619"></a><a class="code" href="../../d4/d1/ctxtinfo_8c.html#a46">02619</a> LONG <a class="code" href="../../d4/d0/immcli_8h.html#a78">InternalGetCompositionStringW</a>(
02620     PCOMPOSITIONSTRING pCompStr,
02621     DWORD              dwIndex,
02622     LPVOID             lpBuf,
02623     DWORD              dwBufLen,
02624     BOOL               fAnsiImc,
02625     DWORD              dwCodePage)
02626 {
02627     <span class="keywordflow">if</span> (!fAnsiImc) {
02628         <span class="comment">/*</span>
02629 <span class="comment">         * Composition string in input context is of Unicode style.</span>
02630 <span class="comment">         */</span>
02631         <span class="keywordflow">switch</span> (dwIndex) {
02632         <span class="keywordflow">case</span> GCS_COMPSTR:
02633             <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a1">GetCompInfoW</a>(CompStr);
02634             <span class="keywordflow">break</span>;
02635         <span class="keywordflow">case</span> GCS_COMPATTR:              <span class="comment">// ANSI-only</span>
02636             <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a0">GetCompInfoA</a>(CompAttr);
02637             <span class="keywordflow">break</span>;
02638         <span class="keywordflow">case</span> GCS_COMPREADSTR:
02639             <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a1">GetCompInfoW</a>(CompReadStr);
02640             <span class="keywordflow">break</span>;
02641         <span class="keywordflow">case</span> GCS_COMPREADATTR:          <span class="comment">// ANSI-only</span>
02642             <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a0">GetCompInfoA</a>(CompReadAttr);
02643             <span class="keywordflow">break</span>;
02644         <span class="keywordflow">case</span> GCS_COMPREADCLAUSE:        <span class="comment">// ANSI-only</span>
02645             <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a0">GetCompInfoA</a>(CompReadClause);
02646             <span class="keywordflow">break</span>;
02647         <span class="keywordflow">case</span> GCS_CURSORPOS:
02648             dwBufLen = (LONG)pCompStr-&gt;dwCursorPos;
02649             <span class="keywordflow">break</span>;
02650         <span class="keywordflow">case</span> GCS_DELTASTART:
02651             dwBufLen = (LONG)pCompStr-&gt;dwDeltaStart;
02652             <span class="keywordflow">break</span>;
02653         <span class="keywordflow">case</span> GCS_RESULTSTR:
02654             <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a1">GetCompInfoW</a>(ResultStr);
02655             <span class="keywordflow">break</span>;
02656         <span class="keywordflow">case</span> GCS_RESULTCLAUSE:          <span class="comment">// ANSI-only</span>
02657             <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a0">GetCompInfoA</a>(ResultClause);
02658             <span class="keywordflow">break</span>;
02659         <span class="keywordflow">case</span> GCS_RESULTREADSTR:
02660             <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a1">GetCompInfoW</a>(ResultReadStr);
02661             <span class="keywordflow">break</span>;
02662         <span class="keywordflow">case</span> GCS_RESULTREADCLAUSE:      <span class="comment">// ANSI-only</span>
02663             <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a0">GetCompInfoA</a>(ResultReadClause);
02664             <span class="keywordflow">break</span>;
02665         <span class="keywordflow">case</span> GCS_COMPCLAUSE:            <span class="comment">// ANSI-only</span>
02666             <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a0">GetCompInfoA</a>(CompClause);
02667             <span class="keywordflow">break</span>;
02668         <span class="keywordflow">default</span>:
02669             dwBufLen = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)IMM_ERROR_GENERAL;
02670             <span class="keywordflow">break</span>;
02671         }
02672 
02673         <span class="keywordflow">return</span> (LONG)dwBufLen;
02674     }
02675 
02676     <span class="comment">/*</span>
02677 <span class="comment">     * Unicode caller, ANSI input context/composition string.</span>
02678 <span class="comment">     */</span>
02679     <span class="keywordflow">switch</span> (dwIndex) {
02680     <span class="keywordflow">case</span> GCS_COMPSTR:
02681     <span class="keywordflow">case</span> GCS_COMPREADSTR:
02682     <span class="keywordflow">case</span> GCS_RESULTSTR:
02683     <span class="keywordflow">case</span> GCS_RESULTREADSTR:
02684     {
02685         <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>  dwStrSize;
02686         LPSTR lpStrA;
02687 
02688         <span class="comment">/*</span>
02689 <span class="comment">         * Get Unicode string from ANSI composition string.</span>
02690 <span class="comment">         */</span>
02691         dwStrSize = <a class="code" href="../../d4/d0/immcli_8h.html#a77">InternalGetCompositionStringA</a>(pCompStr, dwIndex,
02692                                             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0, fAnsiImc, dwCodePage);
02693 
02694         lpStrA = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a22">ImmLocalAlloc</a>(HEAP_ZERO_MEMORY, dwStrSize + <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>));
02695         <span class="keywordflow">if</span> (lpStrA == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02696             RIPMSG0(RIP_WARNING, <span class="stringliteral">"InternalGetCompositionStringW: memory failure."</span>);
02697             <span class="keywordflow">return</span> (LONG)IMM_ERROR_GENERAL;
02698         }
02699 
02700         dwStrSize = <a class="code" href="../../d4/d0/immcli_8h.html#a77">InternalGetCompositionStringA</a>(pCompStr, dwIndex,
02701                                             lpStrA, dwStrSize, fAnsiImc, dwCodePage);
02702 
02703         dwBufLen = MultiByteToWideChar(dwCodePage,
02704                                        (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)MB_PRECOMPOSED,
02705                                        lpStrA,              <span class="comment">// src</span>
02706                                        <a class="code" href="../../d2/d7/regtest_8c.html#a2">strlen</a>(lpStrA),
02707                                        (LPWSTR)lpBuf,        <span class="comment">// dest</span>
02708                                        (<a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>)dwBufLen);
02709 
02710         dwBufLen *= <span class="keyword">sizeof</span>(WCHAR);     <span class="comment">// return number of bytes required.</span>
02711 
02712         <a class="code" href="../../d4/d0/immcli_8h.html#a8">ImmLocalFree</a>(lpStrA);
02713         <span class="keywordflow">break</span>;
02714     }
02715 
02716     <span class="keywordflow">case</span> GCS_COMPATTR:
02717     <span class="keywordflow">case</span> GCS_COMPREADATTR:
02718     {
02719         <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>  dwAttrLenA, dwIndexStr, dwStrSize;
02720         <a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>  lpAttrA, lpAttrW;
02721         LPWSTR lpStrW, lpStrT;
02722         ULONG  MultiByteSize;
02723         WCHAR  wc;
02724 
02725         <span class="comment">/*</span>
02726 <span class="comment">         * Get Unicode attribute from ANSI composition attribute.</span>
02727 <span class="comment">         */</span>
02728         <span class="keywordflow">switch</span> (dwIndex) {
02729         <span class="keywordflow">case</span> GCS_COMPATTR:
02730             lpAttrA = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pCompStr + pCompStr-&gt;dwCompAttrOffset;
02731             dwAttrLenA = pCompStr-&gt;dwCompAttrLen;
02732             dwIndexStr = GCS_COMPSTR;
02733             <span class="keywordflow">break</span>;
02734         <span class="keywordflow">case</span> GCS_COMPREADATTR:
02735             lpAttrA = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pCompStr + pCompStr-&gt;dwCompReadAttrOffset;
02736             dwAttrLenA = pCompStr-&gt;dwCompReadAttrLen;
02737             dwIndexStr = GCS_COMPREADSTR;
02738             <span class="keywordflow">break</span>;
02739         }
02740 
02741         <span class="keywordflow">if</span> (dwAttrLenA == 0) {
02742             <span class="comment">/*</span>
02743 <span class="comment">             * No CompAttr or CompReadAttr exists, do nothing.</span>
02744 <span class="comment">             */</span>
02745             <span class="keywordflow">return</span> 0;
02746         }
02747 
02748         dwStrSize = <a class="code" href="../../d4/d0/immcli_8h.html#a78">InternalGetCompositionStringW</a>(pCompStr,
02749                                         dwIndexStr, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0, fAnsiImc, dwCodePage);
02750 
02751         <span class="keywordflow">if</span> (dwStrSize == (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)(LONG)IMM_ERROR_GENERAL) {
02752             RIPMSG0(RIP_WARNING, <span class="stringliteral">"InternalGetCompositionStringA: IMM_ERROR_GENERAL."</span>);
02753             <span class="keywordflow">return</span> (LONG)IMM_ERROR_GENERAL;
02754         }
02755 
02756         <span class="comment">/*</span>
02757 <span class="comment">         * Query required size or early exit on error.</span>
02758 <span class="comment">         */</span>
02759         <span class="keywordflow">if</span> (dwBufLen == 0 || dwStrSize == 0)
02760             <span class="keywordflow">return</span> dwStrSize / <span class="keyword">sizeof</span>(WCHAR);
02761 
02762         lpStrW = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a22">ImmLocalAlloc</a>(HEAP_ZERO_MEMORY, dwStrSize + <span class="keyword">sizeof</span>(WCHAR));
02763         <span class="keywordflow">if</span> (lpStrW == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02764             RIPMSG0(RIP_WARNING, <span class="stringliteral">"InternalGetCompositionStringW: memory failure."</span>);
02765             <span class="keywordflow">return</span> (LONG)IMM_ERROR_GENERAL;
02766         }
02767 
02768         dwStrSize = <a class="code" href="../../d4/d0/immcli_8h.html#a78">InternalGetCompositionStringW</a>(pCompStr,
02769                                         dwIndexStr, lpStrW, dwStrSize, fAnsiImc, dwCodePage);
02770 
02771         <span class="keywordflow">if</span> (dwStrSize == (LONG)IMM_ERROR_GENERAL) {
02772             RIPMSG0(RIP_WARNING, <span class="stringliteral">"InternalGetCompositionStringA: IMM_ERROR_GENERAL."</span>);
02773             <a class="code" href="../../d4/d0/immcli_8h.html#a8">ImmLocalFree</a>(lpStrW);
02774             <span class="keywordflow">return</span> (LONG)IMM_ERROR_GENERAL;
02775         }
02776 
02777         lpStrT = lpStrW;
02778         lpAttrW = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)lpBuf;
02779 
02780         <span class="keywordflow">while</span> ((wc=*lpStrT++) != <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span> &amp;&amp; dwBufLen != 0 &amp;&amp; dwAttrLenA-- != 0) {
02781             MultiByteSize = <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a7">UnicodeToMultiByteSize</a>(dwCodePage, &amp;wc);
02782             <span class="keywordflow">if</span> (MultiByteSize == 2 &amp;&amp; dwAttrLenA != 0) {
02783                 *lpAttrW++ = *lpAttrA++;
02784                 dwAttrLenA--;
02785             }
02786             <span class="keywordflow">else</span> {
02787                 *lpAttrW++ = *lpAttrA;
02788             }
02789             lpAttrA++;
02790             dwBufLen--;
02791         }
02792 
02793         dwBufLen = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)(lpAttrW - (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)lpBuf);
02794 
02795         <a class="code" href="../../d4/d0/immcli_8h.html#a8">ImmLocalFree</a>(lpStrW);
02796         <span class="keywordflow">break</span>;
02797     }
02798 
02799     <span class="keywordflow">case</span> GCS_COMPCLAUSE:
02800     <span class="keywordflow">case</span> GCS_COMPREADCLAUSE:
02801     <span class="keywordflow">case</span> GCS_RESULTCLAUSE:
02802     <span class="keywordflow">case</span> GCS_RESULTREADCLAUSE:
02803     {
02804         LPSTR   lpStrA;
02805         <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>   dwClauseLen, dwBufLenW;
02806         LPDWORD lpdwSrc, lpdwDst;
02807         <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>    i;
02808 
02809         <span class="comment">/*</span>
02810 <span class="comment">         * Get Unicode clause from ANSI composition clause.</span>
02811 <span class="comment">         */</span>
02812         <span class="keywordflow">switch</span> (dwIndex) {
02813         <span class="keywordflow">case</span> GCS_COMPCLAUSE:
02814             lpStrA = (LPSTR)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pCompStr + pCompStr-&gt;dwCompStrOffset);
02815             lpdwSrc = (LPDWORD)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pCompStr + pCompStr-&gt;dwCompClauseOffset);
02816             dwClauseLen = pCompStr-&gt;dwCompClauseLen;
02817             <span class="keywordflow">break</span>;
02818         <span class="keywordflow">case</span> GCS_COMPREADCLAUSE:
02819             lpStrA = (LPSTR)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pCompStr + pCompStr-&gt;dwCompReadStrOffset);
02820             lpdwSrc = (LPDWORD)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pCompStr + pCompStr-&gt;dwCompReadClauseOffset);
02821             dwClauseLen = pCompStr-&gt;dwCompReadClauseLen;
02822             <span class="keywordflow">break</span>;
02823         <span class="keywordflow">case</span> GCS_RESULTCLAUSE:
02824             lpStrA = (LPSTR)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pCompStr + pCompStr-&gt;dwResultStrOffset);
02825             lpdwSrc = (LPDWORD)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pCompStr + pCompStr-&gt;dwResultClauseOffset);
02826             dwClauseLen = pCompStr-&gt;dwResultClauseLen;
02827             <span class="keywordflow">break</span>;
02828         <span class="keywordflow">case</span> GCS_RESULTREADCLAUSE:
02829             lpStrA = (LPSTR)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pCompStr + pCompStr-&gt;dwResultReadStrOffset);
02830             lpdwSrc = (LPDWORD)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pCompStr + pCompStr-&gt;dwResultReadClauseOffset);
02831             dwClauseLen = pCompStr-&gt;dwResultReadClauseLen;
02832             <span class="keywordflow">break</span>;
02833         }
02834 
02835 
02836         <span class="comment">/*</span>
02837 <span class="comment">         * Query clause length or early exit on error.</span>
02838 <span class="comment">         */</span>
02839         <span class="keywordflow">if</span> (dwBufLen == 0 || (LONG)dwClauseLen &lt; 0) {
02840             dwBufLen = dwClauseLen;
02841             <span class="keywordflow">break</span>;
02842         }
02843 
02844         lpdwDst = (LPDWORD)lpBuf;
02845         dwBufLenW = dwBufLen / <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>);
02846 
02847         <span class="keywordflow">for</span> (i = 0; i &lt; dwClauseLen / <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>) &amp;&amp; dwBufLenW != 0; i++) {
02848             *lpdwDst++ = <a class="code" href="../../d4/d0/immcli_8h.html#a81">CalcCharacterPositionAtoW</a>(*lpdwSrc++, lpStrA, dwCodePage);
02849             dwBufLenW--;
02850         }
02851 
02852         dwBufLen = i * <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>);
02853         <span class="keywordflow">break</span>;
02854     }
02855 
02856     <span class="keywordflow">case</span> GCS_CURSORPOS:
02857     <span class="keywordflow">case</span> GCS_DELTASTART:
02858         <span class="comment">/*</span>
02859 <span class="comment">         * Get Unicode cursor/delta start position from ANSI composition string.</span>
02860 <span class="comment">         */</span>
02861         <span class="keywordflow">switch</span> (dwIndex) {
02862         <span class="keywordflow">case</span> GCS_CURSORPOS:
02863             dwBufLen = pCompStr-&gt;dwCursorPos;
02864             <span class="keywordflow">break</span>;
02865         <span class="keywordflow">case</span> GCS_DELTASTART:
02866             dwBufLen = pCompStr-&gt;dwDeltaStart;
02867             <span class="keywordflow">break</span>;
02868         }
02869 
02870         <span class="keywordflow">if</span> ((LONG)dwBufLen &gt; 0) {
02871             dwBufLen = <a class="code" href="../../d4/d0/immcli_8h.html#a81">CalcCharacterPositionAtoW</a>(dwBufLen,
02872                             (LPSTR)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pCompStr + pCompStr-&gt;dwCompStrOffset),
02873                             dwCodePage);
02874         }
02875         <span class="keywordflow">break</span>;
02876 
02877     <span class="keywordflow">default</span>:
02878         dwBufLen = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)(LONG)IMM_ERROR_GENERAL;
02879     }
02880 
02881     <span class="keywordflow">return</span> (LONG)dwBufLen;
02882 }
02883 
02884 
<a name="l02885"></a><a class="code" href="../../d4/d0/immcli_8h.html#a79">02885</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d4/d0/immcli_8h.html#a79">InternalGetCandidateListAtoW</a>(
02886     LPCANDIDATELIST     lpCandListA,
02887     LPCANDIDATELIST     lpCandListW,
02888     DWORD               dwBufLen,
02889     DWORD               dwCodePage)
02890 {
02891     LPWSTR lpCandStrW;
02892     LPSTR  lpCandStrA;
02893     <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>    i, j;
02894     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>  dwCandListLen;
02895 
02896     dwCandListLen = <span class="keyword">sizeof</span>(CANDIDATELIST);
02897 
02898     <span class="comment">/*</span>
02899 <span class="comment">     * CANDIDATELIST has already contained the dwOffset[0]</span>
02900 <span class="comment">     */</span>
02901     <span class="keywordflow">if</span> (lpCandListA-&gt;dwCount &gt; 0)
02902         dwCandListLen += <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>) * (lpCandListA-&gt;dwCount - 1);
02903 
02904     <span class="keywordflow">for</span> (i = 0; i &lt; (<a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>)lpCandListA-&gt;dwCount; i++) {
02905 
02906         lpCandStrA = (LPSTR)((LPBYTE)lpCandListA + lpCandListA-&gt;dwOffset[i]);
02907 
02908         j = MultiByteToWideChar(dwCodePage,
02909                                 (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)MB_PRECOMPOSED,
02910                                 lpCandStrA,
02911                                 -1,
02912                                 (LPWSTR)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02913                                 0);
02914 
02915         dwCandListLen += (j * <span class="keyword">sizeof</span>(WCHAR));
02916     }
02917 
02918     dwCandListLen = <a class="code" href="../../d4/d0/immcli_8h.html#a18">DWORD_ALIGN</a>(dwCandListLen);
02919 
02920     <span class="keywordflow">if</span> (dwBufLen == 0)
02921         <span class="keywordflow">return</span> dwCandListLen;
02922 
02923     <span class="keywordflow">if</span> (dwBufLen &lt; dwCandListLen) {
02924         RIPMSG0(RIP_WARNING, <span class="stringliteral">"InternalGetCandidateListAtoW: dwBufLen too small."</span>);
02925         <span class="keywordflow">return</span> 0;
02926     }
02927 
02928     lpCandListW-&gt;dwSize = dwBufLen;
02929     lpCandListW-&gt;dwStyle = lpCandListA-&gt;dwStyle;
02930     lpCandListW-&gt;dwCount = lpCandListA-&gt;dwCount;
02931     lpCandListW-&gt;dwSelection = lpCandListA-&gt;dwSelection;
02932     lpCandListW-&gt;dwPageStart = lpCandListA-&gt;dwPageStart;
02933     lpCandListW-&gt;dwPageSize = lpCandListA-&gt;dwPageSize;
02934     lpCandListW-&gt;dwOffset[0] = <span class="keyword">sizeof</span>(CANDIDATELIST);
02935     <span class="keywordflow">if</span> (lpCandListW-&gt;dwCount &gt; 0)
02936         lpCandListW-&gt;dwOffset[0] += <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>) * (lpCandListW-&gt;dwCount - 1);
02937 
02938     dwCandListLen = dwBufLen - lpCandListW-&gt;dwOffset[0];
02939 
02940     <span class="keywordflow">for</span>  (i = 0; i &lt; (<a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>)lpCandListW-&gt;dwCount; i++) {
02941 
02942         lpCandStrA = (LPSTR) ((LPBYTE)lpCandListA + lpCandListA-&gt;dwOffset[i]);
02943         lpCandStrW = (LPWSTR)((LPBYTE)lpCandListW + lpCandListW-&gt;dwOffset[i]);
02944 
02945         j = MultiByteToWideChar(dwCodePage,
02946                                 (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)MB_PRECOMPOSED,
02947                                 lpCandStrA,
02948                                 -1,
02949                                 lpCandStrW,
02950                                 (<a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>)dwCandListLen/<span class="keyword">sizeof</span>(WCHAR));
02951 
02952         dwCandListLen -= (j * <span class="keyword">sizeof</span>(WCHAR));
02953 
02954         <span class="keywordflow">if</span> (i &lt; (<a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>)lpCandListW-&gt;dwCount - 1)
02955             lpCandListW-&gt;dwOffset[i+1] = lpCandListW-&gt;dwOffset[i] + j * <span class="keyword">sizeof</span>(WCHAR);
02956     }
02957 
02958     <span class="keywordflow">return</span> dwBufLen;
02959 }
02960 
02961 
<a name="l02962"></a><a class="code" href="../../d4/d0/immcli_8h.html#a80">02962</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d4/d0/immcli_8h.html#a80">InternalGetCandidateListWtoA</a>(
02963     LPCANDIDATELIST     lpCandListW,
02964     LPCANDIDATELIST     lpCandListA,
02965     DWORD               dwBufLen,
02966     DWORD               dwCodePage)
02967 {
02968     LPWSTR lpCandStrW;
02969     LPSTR  lpCandStrA;
02970     <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>    i, j;
02971     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>  dwCandListLen;
02972     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>   bUDC;
02973 
02974     dwCandListLen = <span class="keyword">sizeof</span>(CANDIDATELIST);
02975 
02976     <span class="comment">/*</span>
02977 <span class="comment">     * CANDIDATELIST has already contained the dwOffset[0]</span>
02978 <span class="comment">     */</span>
02979     <span class="keywordflow">if</span> (lpCandListW-&gt;dwCount &gt; 0)
02980         dwCandListLen += <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>) * (lpCandListW-&gt;dwCount - 1);
02981 
02982     <span class="keywordflow">for</span> (i = 0; i &lt; (<a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>)lpCandListW-&gt;dwCount; i++) {
02983 
02984         lpCandStrW = (LPWSTR)((LPBYTE)lpCandListW + lpCandListW-&gt;dwOffset[i]);
02985 
02986         j = WideCharToMultiByte(dwCodePage,
02987                                 (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)0,
02988                                 lpCandStrW,
02989                                 -1,
02990                                 (LPSTR)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02991                                 (<a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>)0,
02992                                 (LPSTR)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
02993                                 (LPBOOL)&amp;bUDC);
02994 
02995         dwCandListLen += (j * <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>));
02996     }
02997 
02998     dwCandListLen = <a class="code" href="../../d4/d0/immcli_8h.html#a18">DWORD_ALIGN</a>(dwCandListLen);
02999 
03000     <span class="keywordflow">if</span> (dwBufLen == 0)
03001         <span class="keywordflow">return</span> dwCandListLen;
03002 
03003     <span class="keywordflow">if</span> (dwBufLen &lt; dwCandListLen) {
03004         RIPMSG0(RIP_WARNING, <span class="stringliteral">"InternalGetCandidateListWtoA: dwBufLen too small."</span>);
03005         <span class="keywordflow">return</span> 0;
03006     }
03007 
03008     lpCandListA-&gt;dwSize = dwBufLen;
03009     lpCandListA-&gt;dwStyle = lpCandListW-&gt;dwStyle;
03010     lpCandListA-&gt;dwCount = lpCandListW-&gt;dwCount;
03011     lpCandListA-&gt;dwSelection = lpCandListW-&gt;dwSelection;
03012     lpCandListA-&gt;dwPageStart = lpCandListW-&gt;dwPageStart;
03013     lpCandListA-&gt;dwPageSize = lpCandListW-&gt;dwPageSize;
03014     lpCandListA-&gt;dwOffset[0] = <span class="keyword">sizeof</span>(CANDIDATELIST);
03015     <span class="keywordflow">if</span> (lpCandListA-&gt;dwCount &gt; 0)
03016         lpCandListA-&gt;dwOffset[0] += <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>) * (lpCandListA-&gt;dwCount - 1);
03017 
03018     dwCandListLen = dwBufLen - lpCandListA-&gt;dwOffset[0];
03019 
03020     <span class="keywordflow">for</span>  (i = 0; i &lt; (<a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>)lpCandListA-&gt;dwCount; i++) {
03021 
03022         lpCandStrA = (LPSTR) ((LPBYTE)lpCandListA + lpCandListA-&gt;dwOffset[i]);
03023         lpCandStrW = (LPWSTR)((LPBYTE)lpCandListW + lpCandListW-&gt;dwOffset[i]);
03024 
03025         j = WideCharToMultiByte(dwCodePage,
03026                                 (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)0,
03027                                 lpCandStrW,
03028                                 -1,
03029                                 (LPSTR)lpCandStrA,
03030                                 (<a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>)dwCandListLen,
03031                                 (LPSTR)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
03032                                 (LPBOOL)&amp;bUDC);
03033 
03034         dwCandListLen -= (j * <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>));
03035 
03036         <span class="keywordflow">if</span> (i &lt; (<a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>)lpCandListA-&gt;dwCount - 1)
03037             lpCandListA-&gt;dwOffset[i+1] = lpCandListA-&gt;dwOffset[i] + j * <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>);
03038     }
03039 
03040     <span class="keywordflow">return</span> dwBufLen;
03041 }
03042 
03043 <span class="comment">/***************************************************************************\</span>
03044 <span class="comment">* CalcCharacterPositionAtoW</span>
03045 <span class="comment">*</span>
03046 <span class="comment">* Calculate Unicode character position to ANSI character position.</span>
03047 <span class="comment">*</span>
03048 <span class="comment">* History:</span>
03049 <span class="comment">* 28-Feb-1995   wkwok   Created</span>
03050 <span class="comment">\***************************************************************************/</span>
03051 
<a name="l03052"></a><a class="code" href="../../d4/d0/immcli_8h.html#a81">03052</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d4/d0/immcli_8h.html#a81">CalcCharacterPositionAtoW</a>(
03053     DWORD dwCharPosA,
03054     LPSTR lpszCharStr,
03055     DWORD dwCodePage)
03056 {
03057     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwCharPosW = 0;
03058 
03059     <span class="keywordflow">while</span> (dwCharPosA != 0) {
03060         <span class="keywordflow">if</span> (IsDBCSLeadByteEx(dwCodePage, *lpszCharStr)) {
03061             <span class="keywordflow">if</span> (dwCharPosA &gt;= 2) {
03062                 dwCharPosA -= 2;
03063             }
03064             <span class="keywordflow">else</span> {
03065                 dwCharPosA--;
03066             }
03067             lpszCharStr += 2;
03068         }
03069         <span class="keywordflow">else</span> {
03070             dwCharPosA--;
03071             lpszCharStr++;
03072         }
03073         dwCharPosW++;
03074     }
03075 
03076     <span class="keywordflow">return</span> dwCharPosW;
03077 }
03078 
03079 
03080 <span class="comment">/***************************************************************************\</span>
03081 <span class="comment">* CalcCharacterPositionWtoA</span>
03082 <span class="comment">*</span>
03083 <span class="comment">* Calculate ANSI character position to Unicode character position.</span>
03084 <span class="comment">*</span>
03085 <span class="comment">* History:</span>
03086 <span class="comment">* 28-Feb-1995   wkwok   Created</span>
03087 <span class="comment">\***************************************************************************/</span>
03088 
<a name="l03089"></a><a class="code" href="../../d4/d0/immcli_8h.html#a82">03089</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d4/d0/immcli_8h.html#a82">CalcCharacterPositionWtoA</a>(
03090     DWORD dwCharPosW,
03091     LPWSTR lpwszCharStr,
03092     DWORD  dwCodePage)
03093 {
03094     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwCharPosA = 0;
03095     ULONG MultiByteSize;
03096 
03097     <span class="keywordflow">while</span> (dwCharPosW != 0) {
03098         MultiByteSize = <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a7">UnicodeToMultiByteSize</a>(dwCodePage, lpwszCharStr);
03099         <span class="keywordflow">if</span> (MultiByteSize == 2) {
03100             dwCharPosA += 2;
03101         }
03102         <span class="keywordflow">else</span> {
03103             dwCharPosA++;
03104         }
03105         dwCharPosW--;
03106         lpwszCharStr++;
03107     }
03108 
03109     <span class="keywordflow">return</span> dwCharPosA;
03110 }
03111 
03112 
<a name="l03113"></a><a class="code" href="../../d4/d0/immcli_8h.html#a83">03113</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d0/immcli_8h.html#a83">LFontAtoLFontW</a>(
03114     LPLOGFONTA lpLogFontA,
03115     LPLOGFONTW lpLogFontW)
03116 {
03117     <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a> i;
03118 
03119     RtlCopyMemory(lpLogFontW, lpLogFontA, <span class="keyword">sizeof</span>(LOGFONTA)-LF_FACESIZE);
03120 
03121     i = MultiByteToWideChar(CP_ACP,     <span class="comment">// Note: font face name should use ACP for A/W conversion.</span>
03122                             MB_PRECOMPOSED,
03123                             lpLogFontA-&gt;lfFaceName,
03124                             <a class="code" href="../../d2/d7/regtest_8c.html#a2">strlen</a>(lpLogFontA-&gt;lfFaceName),
03125                             lpLogFontW-&gt;lfFaceName,
03126                             LF_FACESIZE);
03127 
03128     lpLogFontW-&gt;lfFaceName[i] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
03129 
03130     <span class="keywordflow">return</span>;
03131 }
03132 
03133 
<a name="l03134"></a><a class="code" href="../../d4/d0/immcli_8h.html#a84">03134</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d0/immcli_8h.html#a84">LFontWtoLFontA</a>(
03135     LPLOGFONTW lpLogFontW,
03136     LPLOGFONTA lpLogFontA)
03137 {
03138     <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>  i;
03139     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> bUDC;
03140 
03141     RtlCopyMemory(lpLogFontA, lpLogFontW, <span class="keyword">sizeof</span>(LOGFONTA)-LF_FACESIZE);
03142 
03143     i = WideCharToMultiByte(CP_ACP,     <span class="comment">// Note: font face name should use ACP for A/W conversion.</span>
03144                             0,
03145                             lpLogFontW-&gt;lfFaceName,
03146                             wcslen(lpLogFontW-&gt;lfFaceName),
03147                             lpLogFontA-&gt;lfFaceName,
03148                             LF_FACESIZE,
03149                             (LPSTR)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
03150                             &amp;bUDC);
03151 
03152     lpLogFontA-&gt;lfFaceName[i] = <span class="charliteral">'\0'</span>;
03153 
03154     <span class="keywordflow">return</span>;
03155 }
03156 
03157 
<a name="l03158"></a><a class="code" href="../../d4/d0/immcli_8h.html#a85">03158</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d0/immcli_8h.html#a85">MakeIMENotify</a>(
03159     HIMC   hImc,
03160     HWND   hWnd,
03161     DWORD  dwAction,
03162     DWORD  dwIndex,
03163     DWORD  dwValue,
03164     WPARAM wParam,
03165     LPARAM lParam)
03166 {
03167     <a class="code" href="../../d2/d7/structtagIMEDPI.html">PIMEDPI</a> pImeDpi;
03168     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>   dwThreadId;
03169 
03170 <span class="preprocessor">#ifdef LATER</span>
03171 <span class="preprocessor"></span>    <span class="comment">// implement MakeIMENotifyEvent() later</span>
03172 <span class="preprocessor">#endif</span>
03173 <span class="preprocessor"></span>
03174     <span class="keywordflow">if</span> (dwAction != 0 &amp;&amp; (dwThreadId = <a class="code" href="../../d4/d0/immcli_8h.html#a15">GetInputContextThread</a>(hImc)) != 0) {
03175 
03176         pImeDpi = <a class="code" href="../../d9/d0/immuser_8h.html#a45">ImmLockImeDpi</a>(<a class="code" href="../../d3/d8/client_8c.html#a154">GetKeyboardLayout</a>(dwThreadId));
03177 
03178         <span class="keywordflow">if</span> (pImeDpi != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03179             (*pImeDpi-&gt;<a class="code" href="../../d2/d7/structtagIMEDPI.html#o8">pfn</a>.<a class="code" href="../../d3/d7/structtagIMEDPI_1_1__tagImeFunctions.html#o26">NotifyIME</a>)(hImc, dwAction, dwIndex, dwValue);
03180             <a class="code" href="../../d9/d0/immuser_8h.html#a46">ImmUnlockImeDpi</a>(pImeDpi);
03181         }
03182     }
03183 
03184     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; wParam != 0)
03185         <a class="code" href="../../d5/d9/cltxt_8h.html#a16">SendMessage</a>(<a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a29">hWnd</a>, WM_IME_NOTIFY, wParam, lParam);
03186 
03187     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03188 }
03189 
03190 
03191 
03193 <span class="comment">// Reconversion support</span>
03195 <span class="comment"></span>
<a name="l03196"></a><a class="code" href="../../d4/d1/ctxtinfo_8c.html#a59">03196</a> <span class="keyword">typedef</span> <span class="keyword">enum</span> {<a class="code" href="../../d4/d1/ctxtinfo_8c.html#a59a4">FROM_IME</a>, <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a59a5">FROM_APP</a>} <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a59">REQ_CALLER</a>;
03197 
03199 <span class="comment">// ImmGetReconvertTotalSize</span>
03200 <span class="comment">//</span>
03201 <span class="comment">// calculate the appropriate size of the buffer, based on caller/ansi information</span>
03202 <span class="comment">//</span>
03203 <span class="comment">// History:</span>
03204 <span class="comment">// 28-Feb-1997   hiroyama   Created</span>
03206 <span class="comment"></span>
<a name="l03207"></a><a class="code" href="../../d4/d1/ctxtinfo_8c.html#a54">03207</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a54">ImmGetReconvertTotalSize</a>(DWORD dwSize, REQ_CALLER eCaller, BOOL bAnsiTarget)
03208 {
03209     <span class="keywordflow">if</span> (dwSize &lt; <span class="keyword">sizeof</span>(RECONVERTSTRING)) {
03210         <span class="keywordflow">return</span> 0;
03211     }
03212     <span class="keywordflow">if</span> (bAnsiTarget) {
03213         dwSize -= <span class="keyword">sizeof</span>(RECONVERTSTRING);
03214         <span class="keywordflow">if</span> (eCaller == <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a59a4">FROM_IME</a>) {
03215             dwSize /= 2;
03216         } <span class="keywordflow">else</span> {
03217             dwSize *= 2;
03218         }
03219         dwSize += <span class="keyword">sizeof</span>(RECONVERTSTRING);
03220     }
03221     <span class="keywordflow">return</span> dwSize;
03222 }
03223 
<a name="l03224"></a><a class="code" href="../../d4/d1/ctxtinfo_8c.html#a6">03224</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a6">ImmReconversionWorker</a>(
03225         LPRECONVERTSTRING lpRecTo,
03226         LPRECONVERTSTRING lpRecFrom,
03227         BOOL bToAnsi,
03228         DWORD dwCodePage)
03229 {
03230     <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a> i;
03231     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwSize = 0;
03232 
03233     UserAssert(lpRecTo);
03234     UserAssert(lpRecFrom);
03235 
03236     <span class="keywordflow">if</span> (lpRecFrom-&gt;dwVersion != 0 || lpRecTo-&gt;dwVersion != 0) {
03237         RIPMSG0(RIP_WARNING, <span class="stringliteral">"ImmReconversionWorker: dwVersion in lpRecTo or lpRecFrom is incorrect."</span>);
03238         <span class="keywordflow">return</span> 0;
03239     }
03240     <span class="comment">// Note:</span>
03241     <span class="comment">// In any IME related structures, use the following principal.</span>
03242     <span class="comment">// 1) xxxStrOffset is an actual offset, i.e. byte count.</span>
03243     <span class="comment">// 2) xxxStrLen is a number of characters, i.e. TCHAR count.</span>
03244     <span class="comment">//</span>
03245     <span class="comment">// CalcCharacterPositionXtoY() takes TCHAR count so that we</span>
03246     <span class="comment">// need to adjust xxxStrOffset if it's being converted. But you</span>
03247     <span class="comment">// should be careful, because the actual position of the string</span>
03248     <span class="comment">// is always at something like (LPBYTE)lpStruc + lpStruc-&gt;dwStrOffset.</span>
03249     <span class="comment">//</span>
03250     <span class="keywordflow">if</span> (bToAnsi) {
03251         <span class="comment">// Convert W to A</span>
03252         lpRecTo-&gt;dwStrOffset = <span class="keyword">sizeof</span> *lpRecTo;
03253         i = WideCharToMultiByte(dwCodePage,
03254                                 (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)0,
03255                                 (LPWSTR)((LPSTR)lpRecFrom + lpRecFrom-&gt;dwStrOffset), <span class="comment">// src</span>
03256                                 (<a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>)lpRecFrom-&gt;dwStrLen,
03257                                 (LPSTR)lpRecTo + lpRecTo-&gt;dwStrOffset,  <span class="comment">// dest</span>
03258                                 (<a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>)lpRecFrom-&gt;dwStrLen * <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a123">DBCS_CHARSIZE</a>,
03259                                 (LPSTR)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
03260                                 (LPBOOL)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
03261         lpRecTo-&gt;dwCompStrOffset =
03262             <a class="code" href="../../d4/d0/immcli_8h.html#a82">CalcCharacterPositionWtoA</a>(lpRecFrom-&gt;dwCompStrOffset / <span class="keyword">sizeof</span>(WCHAR),
03263                                       (LPWSTR)((LPBYTE)lpRecFrom + lpRecFrom-&gt;dwStrOffset),
03264                                       dwCodePage)
03265                             * <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>);
03266 
03267         lpRecTo-&gt;dwCompStrLen =
03268             (<a class="code" href="../../d4/d0/immcli_8h.html#a82">CalcCharacterPositionWtoA</a>(lpRecFrom-&gt;dwCompStrOffset / <span class="keyword">sizeof</span>(WCHAR) +
03269                                       lpRecFrom-&gt;dwCompStrLen,
03270                                       (LPWSTR)((LPBYTE)lpRecFrom + lpRecFrom-&gt;dwStrOffset),
03271                                       dwCodePage)
03272                             * <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>))
03273             - lpRecTo-&gt;dwCompStrOffset;
03274 
03275         lpRecTo-&gt;dwTargetStrOffset =
03276             <a class="code" href="../../d4/d0/immcli_8h.html#a82">CalcCharacterPositionWtoA</a>(lpRecFrom-&gt;dwTargetStrOffset / <span class="keyword">sizeof</span>(WCHAR),
03277                                       (LPWSTR)((LPBYTE)lpRecFrom +
03278                                                 lpRecFrom-&gt;dwStrOffset),
03279                                       dwCodePage)
03280                             * <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>);
03281 
03282         lpRecTo-&gt;dwTargetStrLen =
03283             (<a class="code" href="../../d4/d0/immcli_8h.html#a82">CalcCharacterPositionWtoA</a>(lpRecFrom-&gt;dwTargetStrOffset / <span class="keyword">sizeof</span>(WCHAR) +
03284                                       lpRecFrom-&gt;dwTargetStrLen,
03285                                       (LPWSTR)((LPBYTE)lpRecFrom + lpRecFrom-&gt;dwStrOffset),
03286                                        dwCodePage)
03287                             * <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>))
03288             - lpRecTo-&gt;dwTargetStrOffset;
03289 
03290         ((LPSTR)lpRecTo)[lpRecTo-&gt;dwStrOffset + i] = <span class="charliteral">'\0'</span>;
03291         lpRecTo-&gt;dwStrLen = i * <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>);
03292 
03293         dwSize = <span class="keyword">sizeof</span>(RECONVERTSTRING) + ((i + 1) * <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>));
03294 
03295     } <span class="keywordflow">else</span> {
03296 
03297         <span class="comment">// AtoW</span>
03298         lpRecTo-&gt;dwStrOffset = <span class="keyword">sizeof</span> *lpRecTo;
03299         i = MultiByteToWideChar(dwCodePage,
03300                                 (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)MB_PRECOMPOSED,
03301                                 (LPSTR)lpRecFrom + lpRecFrom-&gt;dwStrOffset,  <span class="comment">// src</span>
03302                                 (<a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>)lpRecFrom-&gt;dwStrLen,
03303                                 (LPWSTR)((LPSTR)lpRecTo + lpRecTo-&gt;dwStrOffset), <span class="comment">// dest</span>
03304                                 (<a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>)lpRecFrom-&gt;dwStrLen);
03305 
03306         lpRecTo-&gt;dwCompStrOffset =
03307             <a class="code" href="../../d4/d0/immcli_8h.html#a81">CalcCharacterPositionAtoW</a>(lpRecFrom-&gt;dwCompStrOffset,
03308                                       (LPSTR)lpRecFrom + lpRecFrom-&gt;dwStrOffset,
03309                                       dwCodePage) * <span class="keyword">sizeof</span>(WCHAR);
03310 
03311         lpRecTo-&gt;dwCompStrLen =
03312             ((<a class="code" href="../../d4/d0/immcli_8h.html#a81">CalcCharacterPositionAtoW</a>(lpRecFrom-&gt;dwCompStrOffset +
03313                                        lpRecFrom-&gt;dwCompStrLen,
03314                                        (LPSTR)lpRecFrom + lpRecFrom-&gt;dwStrOffset,
03315                                         dwCodePage)  * <span class="keyword">sizeof</span>(WCHAR))
03316             - lpRecTo-&gt;dwCompStrOffset) / <span class="keyword">sizeof</span>(WCHAR);
03317 
03318         lpRecTo-&gt;dwTargetStrOffset =
03319             <a class="code" href="../../d4/d0/immcli_8h.html#a81">CalcCharacterPositionAtoW</a>(lpRecFrom-&gt;dwTargetStrOffset,
03320                                       (LPSTR)lpRecFrom + lpRecFrom-&gt;dwStrOffset,
03321                                       dwCodePage) * <span class="keyword">sizeof</span>(WCHAR);
03322 
03323         lpRecTo-&gt;dwTargetStrLen =
03324             ((<a class="code" href="../../d4/d0/immcli_8h.html#a81">CalcCharacterPositionAtoW</a>(lpRecFrom-&gt;dwTargetStrOffset +
03325                                        lpRecFrom-&gt;dwTargetStrLen,
03326                                        (LPSTR)lpRecFrom + lpRecFrom-&gt;dwStrOffset,
03327                                        dwCodePage)  * <span class="keyword">sizeof</span>(WCHAR))
03328             - lpRecTo-&gt;dwTargetStrOffset) / <span class="keyword">sizeof</span>(WCHAR);
03329 
03330         lpRecTo-&gt;dwStrLen = i;  <span class="comment">// Length is TCHAR count.</span>
03331         <span class="keywordflow">if</span> (lpRecTo-&gt;dwSize &gt;= (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)(lpRecTo-&gt;dwStrOffset + (i + 1)* <span class="keyword">sizeof</span>(WCHAR))) {
03332             LPWSTR lpW = (LPWSTR)((LPSTR)lpRecTo + lpRecTo-&gt;dwStrOffset);
03333             lpW[i] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
03334         }
03335         dwSize = <span class="keyword">sizeof</span>(RECONVERTSTRING) + ((i + 1) * <span class="keyword">sizeof</span>(WCHAR));
03336     }
03337     <span class="keywordflow">return</span> dwSize;
03338 }
03339 
03341 <span class="comment">// ImmRequestMessageWorker</span>
03342 <span class="comment">//</span>
03343 <span class="comment">// worker function for WM_IME_REQUEST message</span>
03344 <span class="comment">//</span>
03345 <span class="comment">// History:</span>
03346 <span class="comment">// 30-Mar-1997   hiroyama   Created</span>
03348 <span class="comment"></span>
<a name="l03349"></a><a class="code" href="../../d4/d1/ctxtinfo_8c.html#a55">03349</a> LRESULT <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a55">ImmRequestMessageWorker</a>(HIMC hIMC, <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd, WPARAM wParam, LPARAM lParam, BOOL bAnsiOrigin)
03350 {
03351     <span class="comment">// the (least) size of the structure given in lParam: for valid pointer checking</span>
03352     <span class="keyword">static</span> CONST <span class="keywordtype">int</span> nReqBufSize[][7] = {
03353         {   <span class="comment">// sizes if IME is UNICODE</span>
03354             <span class="keyword">sizeof</span>(COMPOSITIONFORM),    <span class="comment">// IMR_COMPOSITIONWINDOW</span>
03355             <span class="keyword">sizeof</span>(CANDIDATEFORM),      <span class="comment">// IMR_CANDIDATEWINDOW</span>
03356             <span class="keyword">sizeof</span>(LOGFONTW),           <span class="comment">// IMR_COMPOSITIONFONT</span>
03357             <span class="keyword">sizeof</span>(RECONVERTSTRING),    <span class="comment">// IMR_RECONVERTSTRING</span>
03358             <span class="keyword">sizeof</span>(RECONVERTSTRING),    <span class="comment">// IMR_CONFIRMRECONVERTSTRING</span>
03359             <span class="keyword">sizeof</span>(IMECHARPOSITION),    <span class="comment">// IMR_QUERYCHARPOSITION</span>
03360             <span class="keyword">sizeof</span>(RECONVERTSTRING),    <span class="comment">// IMR_DOCUMENTFEED</span>
03361         },
03362         {   <span class="comment">// sizes if IME is ANSI</span>
03363             <span class="keyword">sizeof</span>(COMPOSITIONFORM),    <span class="comment">// IMR_COMPOSITIONWINDOW</span>
03364             <span class="keyword">sizeof</span>(CANDIDATEFORM),      <span class="comment">// IMR_CANDIDATEWINDOW</span>
03365             <span class="keyword">sizeof</span>(LOGFONTA),           <span class="comment">// IMR_COMPOSITIONFONT</span>
03366             <span class="keyword">sizeof</span>(RECONVERTSTRING),    <span class="comment">// IMR_RECONVERTSTRING</span>
03367             <span class="keyword">sizeof</span>(RECONVERTSTRING),    <span class="comment">// IMR_CONFIRMRECONVERTSTRING</span>
03368             <span class="keyword">sizeof</span>(IMECHARPOSITION),    <span class="comment">// IMR_QUERYCHARPOSITION</span>
03369             <span class="keyword">sizeof</span>(RECONVERTSTRING),    <span class="comment">// IMR_DOCUMENTFEED</span>
03370         }
03371     };
03372     LRESULT lRet = 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
03373     CONST BOOLEAN bAnsiTarget = !!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwnd, <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a570">WFANSIPROC</a>);    <span class="comment">// TRUE if the target Window Proc is ANSI</span>
03374     LPBYTE lpReq = (LPBYTE)lParam;                          <span class="comment">// return buffer (maybe allocated buffer)</span>
03375     LPBYTE lpNew = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;                                    <span class="comment">// buffer allocated within this function</span>
03376     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwSaveCharPos;
03377     <a class="code" href="../../d3/d0/structtagCLIENTIMC.html">PCLIENTIMC</a> pClientImc;
03378     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwCodePage;
03379 
03380 <span class="preprocessor">#define SEND_MESSAGE(bAnsi)   ((bAnsi) ? SendMessageA : SendMessageW)</span>
03381 <span class="preprocessor"></span>
03383     <span class="comment">// Parameter checking</span>
03384 
03385     <span class="comment">// check wParam as sub messages</span>
03386     <span class="keywordflow">if</span> (wParam == 0 || wParam &gt; IMR_DOCUMENTFEED) {  <span class="comment">// wParam is not a proper sub message</span>
03387         RIPMSG1(RIP_WARNING, <span class="stringliteral">"ImmRequestMessageWorker: wParam(%lx) out of range."</span>, wParam);
03388         <span class="keywordflow">return</span> 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
03389     }
03390 
03391     <span class="comment">// Check if the pointer which is given through lParam points the proper memory block.</span>
03392     UserAssert(bAnsiOrigin == 0 || bAnsiOrigin == 1);   <span class="comment">// we'll use bAnsiOrigin as an index</span>
03393 
03394     <span class="comment">// The first sub message IMR_COMPOSITIONWINDOW is 1, so substract 1 from wParam</span>
03395     <span class="keywordflow">if</span> (lpReq &amp;&amp; IsBadWritePtr(lpReq, nReqBufSize[bAnsiOrigin][wParam - 1])) {
03396         RIPMSG0(RIP_WARNING, <span class="stringliteral">"ImmRequestMessageWorker: Bad pointer passed from IME to write"</span>);
03397         <span class="keywordflow">return</span> 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
03398     }
03399 
03400     <span class="comment">// check the lpReq(==lParam): the spec does not allow lParam as NULL</span>
03401     <span class="comment">// except IMR_RECONVERTSTRING and IMR_DOCUMENTFEED</span>
03402     <span class="keywordflow">if</span> (wParam == IMR_RECONVERTSTRING || wParam == IMR_DOCUMENTFEED) {
03403         <span class="comment">//</span>
03404         <span class="comment">// check version number</span>
03405         <span class="comment">//</span>
03406         <span class="keywordflow">if</span> (lpReq != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03407             LPRECONVERTSTRING lpReconv = (LPRECONVERTSTRING)lParam;
03408             <span class="keywordflow">if</span> (lpReconv-&gt;dwVersion != 0) {
03409                 RIPERR1(ERROR_INVALID_PARAMETER, RIP_WARNING, <span class="stringliteral">"Invalid version number: %d"</span>,
03410                         lpReconv-&gt;dwVersion);
03411                 <span class="keywordflow">return</span> 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
03412             }
03413             <span class="keywordflow">if</span> (lpReconv-&gt;dwSize &lt; <span class="keyword">sizeof</span>(RECONVERTSTRING)) {
03414                 RIPERR1(ERROR_INVALID_PARAMETER, RIP_WARNING, <span class="stringliteral">"Invalid dwSize: %d"</span>,
03415                         lpReconv-&gt;dwSize);
03416                 <span class="keywordflow">return</span> 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
03417             }
03418         }
03419     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (wParam == IMR_CONFIRMRECONVERTSTRING) {
03420         <span class="comment">// check if lParam is not NULL, and version of the structure is correct.</span>
03421         <span class="keywordflow">if</span> (lpReq == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || ((LPRECONVERTSTRING)lpReq)-&gt;dwVersion != 0) {
03422             RIPERR0(ERROR_INVALID_PARAMETER, RIP_WARNING, <span class="stringliteral">"Invalid argument or invalid version number"</span>);
03423             <span class="keywordflow">return</span> 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
03424         }
03425     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (lpReq == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03426         RIPERR1(ERROR_INVALID_PARAMETER, RIP_WARNING,
03427                 <span class="stringliteral">"ImmRequestMessageWorker: lParam should not be NULL with this wParam(%lx)."</span>,
03428                 wParam);
03429         <span class="keywordflow">return</span> 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
03430     }
03431     <span class="comment">// end parameter checking</span>
03433 <span class="comment"></span>
03434     pClientImc = <a class="code" href="../../d9/d0/immuser_8h.html#a43">ImmLockClientImc</a>(hIMC);
03435     <span class="keywordflow">if</span> (pClientImc != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03436         dwCodePage = <a class="code" href="../../d4/d0/immcli_8h.html#a26">CImcCodePage</a>(pClientImc);
03437         <a class="code" href="../../d9/d0/immuser_8h.html#a44">ImmUnlockClientImc</a>(pClientImc);
03438     }
03439     <span class="keywordflow">else</span> {
03440         dwCodePage = CP_ACP;
03441     }
03442 
03443     <span class="comment">// allocate and prepare required buffer if we need A/W conversion</span>
03444     <span class="keywordflow">switch</span> (wParam) {
03445     <span class="keywordflow">case</span> IMR_CONFIRMRECONVERTSTRING:
03446     <span class="keywordflow">case</span> IMR_RECONVERTSTRING:
03447     <span class="keywordflow">case</span> IMR_DOCUMENTFEED:
03448         <span class="keywordflow">if</span> (bAnsiOrigin != bAnsiTarget) {
03449             <span class="keywordflow">if</span> (lpReq != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03450                 <span class="comment">// IME wants not only the buffer size but the real reconversion information</span>
03451                 <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwSize = <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a54">ImmGetReconvertTotalSize</a>(((LPRECONVERTSTRING)lpReq)-&gt;dwSize, <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a59a4">FROM_IME</a>, bAnsiTarget);
03452                 LPRECONVERTSTRING lpReconv;
03453 
03454                 lpNew = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a22">ImmLocalAlloc</a>(0, dwSize + <span class="keyword">sizeof</span>(WCHAR));
03455                 <span class="keywordflow">if</span> (lpNew == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03456                     RIPMSG0(RIP_WARNING, <span class="stringliteral">"ImmRequestMessageWorker: failed to allocate a buffer for reconversion."</span>);
03457                     <span class="keywordflow">return</span> 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
03458                 }
03459                 lpReconv = (LPRECONVERTSTRING)lpNew;
03460                 <span class="comment">// setup the information in the allocated structure</span>
03461                 lpReconv-&gt;dwVersion = 0;
03462                 lpReconv-&gt;dwSize = dwSize;
03463 
03464                 <span class="comment">//</span>
03465                 <span class="comment">// if it's confirmation message, we need to translate the contents</span>
03466                 <span class="comment">//</span>
03467                 <span class="keywordflow">if</span> (wParam == IMR_CONFIRMRECONVERTSTRING) {
03468                     <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a6">ImmReconversionWorker</a>(lpReconv, (LPRECONVERTSTRING)lParam, bAnsiTarget, dwCodePage);
03469                 }
03470             }
03471         }
03472         <span class="keywordflow">break</span>;
03473 
03474     <span class="keywordflow">case</span> IMR_COMPOSITIONFONT:
03475         UserAssert(lpReq != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);      <span class="comment">// has been checked so far</span>
03476         <span class="keywordflow">if</span> (bAnsiOrigin != bAnsiTarget) {
03477             <span class="keywordflow">if</span> (bAnsiTarget) {
03478                 lpNew = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a22">ImmLocalAlloc</a>(0, <span class="keyword">sizeof</span>(LOGFONTA));
03479             } <span class="keywordflow">else</span> {
03480                 lpNew = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a22">ImmLocalAlloc</a>(0, <span class="keyword">sizeof</span>(LOGFONTW));
03481             }
03482             <span class="keywordflow">if</span> (lpNew == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03483                 RIPMSG0(RIP_WARNING, <span class="stringliteral">"ImmRequestMessageWorker: IMR_COMPOSITIONFONT: failed to allocate memory for A/W conversion."</span>);
03484                 <span class="keywordflow">return</span> 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
03485             }
03486         }
03487         <span class="keywordflow">break</span>;
03488 
03489     <span class="keywordflow">case</span> IMR_QUERYCHARPOSITION:
03490         UserAssert(lpReq != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
03491         <span class="keywordflow">if</span> (bAnsiOrigin != bAnsiTarget) {
03492 <span class="preprocessor">#define lpIMEPOS    ((LPIMECHARPOSITION)lParam)</span>
03493 <span class="preprocessor"></span>            <a class="code" href="../../d0/d5/perfuser_8c.html#a5">LPVOID</a> lpstr;
03494             <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwLen;
03495 
03496             dwSaveCharPos = <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a3">lpIMEPOS</a>-&gt;dwCharPos;
03497 
03498             dwLen = (!bAnsiOrigin ? <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a9">ImmGetCompositionStringW</a> : <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a8">ImmGetCompositionStringA</a>)(hIMC, GCS_COMPSTR, 0, 0);
03499             <span class="keywordflow">if</span> (dwLen == 0) {
03500                 RIPMSG0(RIP_WARNING, <span class="stringliteral">"ImmRequestMessageWorker: IMR_QUERYCHARPOSITION no compositiong string."</span>);
03501                 <span class="keywordflow">return</span> 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
03502             }
03503 
03504             lpstr = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a22">ImmLocalAlloc</a>(0, (dwLen + 1) * (!bAnsiOrigin ? <span class="keyword">sizeof</span>(WCHAR) : <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>)));
03505             <span class="keywordflow">if</span> (lpstr == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03506                 RIPMSG0(RIP_WARNING, <span class="stringliteral">"ImmRequestMessageWorker: IMR_QUERYCHARPOSITION: failed to allocate memory for A/W conversion."</span>);
03507                 <span class="keywordflow">return</span> 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
03508             }
03509 
03510             (!bAnsiOrigin ? <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a9">ImmGetCompositionStringW</a> : <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a8">ImmGetCompositionStringA</a>)(hIMC, GCS_COMPSTR, lpstr, dwLen);
03511             <span class="keywordflow">if</span> (bAnsiTarget) {
03512                 <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a3">lpIMEPOS</a>-&gt;dwCharPos = <a class="code" href="../../d4/d0/immcli_8h.html#a82">CalcCharacterPositionWtoA</a>(<a class="code" href="../../d4/d1/ctxtinfo_8c.html#a3">lpIMEPOS</a>-&gt;dwCharPos, lpstr, dwCodePage);
03513             } <span class="keywordflow">else</span> {
03514                 <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a3">lpIMEPOS</a>-&gt;dwCharPos = <a class="code" href="../../d4/d0/immcli_8h.html#a81">CalcCharacterPositionAtoW</a>(<a class="code" href="../../d4/d1/ctxtinfo_8c.html#a3">lpIMEPOS</a>-&gt;dwCharPos, lpstr, dwCodePage);
03515             }
03516 
03517             <a class="code" href="../../d4/d0/immcli_8h.html#a8">ImmLocalFree</a>(lpstr);
03518         }
03519         <span class="keywordflow">break</span>;
03520 
03521     <span class="keywordflow">default</span>:
03522         UserAssert(lpReq != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);      <span class="comment">// has been checked so far</span>
03523         <span class="keywordflow">break</span>;
03524     }
03525 
03526     <span class="keywordflow">if</span> (lpNew) {
03527         <span class="comment">// if we allocated the buffer, let lpReq point it; lpNew is used later to free memory</span>
03528         lpReq = lpNew;
03529     }
03530 
03532     lRet = <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a2">SEND_MESSAGE</a>(bAnsiTarget)(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a450">HW</a>(pwnd), WM_IME_REQUEST, wParam, (LPARAM)lpReq);
03534 
03535     <span class="comment">// copy back the results from WinProc to IME's buffer (only if conversion is needed)</span>
03536     <span class="keywordflow">if</span> (bAnsiOrigin != bAnsiTarget) {
03537         <span class="keywordflow">switch</span> (wParam) {
03538         <span class="keywordflow">case</span> IMR_RECONVERTSTRING:
03539         <span class="keywordflow">case</span> IMR_DOCUMENTFEED:
03540             <span class="comment">// Note: by definition, we don't have to do back-conversion for IMR_CONFIRMRECONVERTSTRING</span>
03541             <span class="keywordflow">if</span> (lRet != 0) {
03542                 <span class="comment">// IME wants the buffer size</span>
03543                 lRet = <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a54">ImmGetReconvertTotalSize</a>((<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)lRet, <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a59a5">FROM_APP</a>, bAnsiTarget);
03544                 <span class="keywordflow">if</span> (lRet &lt; <span class="keyword">sizeof</span>(RECONVERTSTRING)) {
03545                     RIPMSG1(RIP_WARNING, <span class="stringliteral">"ImmRequestMessageWorker: return value from application %d is invalid."</span>, lRet);
03546                     lRet = 0;
03547                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (lpReq) {
03548                     <span class="comment">// We need to perform the A/W conversion of the contents</span>
03549                     <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/ctxtinfo_8c.html#a6">ImmReconversionWorker</a>((LPRECONVERTSTRING)lParam, (LPRECONVERTSTRING)lpReq, bAnsiOrigin, dwCodePage)) {
03550                         lRet = 0;   <span class="comment">// Error !</span>
03551                     }
03552                 }
03553             }
03554             <span class="keywordflow">break</span>;
03555         <span class="keywordflow">case</span> IMR_COMPOSITIONFONT:
03556             <span class="keywordflow">if</span> (bAnsiOrigin) {
03557                 <a class="code" href="../../d4/d0/immcli_8h.html#a84">LFontWtoLFontA</a>((LPLOGFONTW)lpNew, (LPLOGFONTA)lParam);
03558             } <span class="keywordflow">else</span> {
03559                 <a class="code" href="../../d4/d0/immcli_8h.html#a83">LFontAtoLFontW</a>((LPLOGFONTA)lpNew, (LPLOGFONTW)lParam);
03560             }
03561             <span class="keywordflow">break</span>;
03562         <span class="keywordflow">case</span> IMR_QUERYCHARPOSITION:
03563             UserAssert((<a class="code" href="../../d0/d5/perfuser_8c.html#a5">LPVOID</a>)lParam != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
03564             <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a3">lpIMEPOS</a>-&gt;dwCharPos = dwSaveCharPos;
03565 <span class="preprocessor">    #undef lpIMEPOS</span>
03566 <span class="preprocessor"></span>            <span class="keywordflow">break</span>;
03567         <span class="keywordflow">default</span>:
03568             <span class="keywordflow">break</span>;
03569         }
03570 
03571     }
03572     <span class="keywordflow">if</span> (lpNew) {
03573         <span class="comment">// buffer has been allocated, free it before returning</span>
03574         <a class="code" href="../../d4/d0/immcli_8h.html#a8">ImmLocalFree</a>(lpNew);
03575     }
03576     <span class="keywordflow">return</span> lRet;
03577 }
03578 
03579 <span class="comment">/**************************************************************************\</span>
03580 <span class="comment">* ImmRequestMessage: Send WM_IME_REQUEST message to the given HIMC window</span>
03581 <span class="comment">*</span>
03582 <span class="comment">* IME function</span>
03583 <span class="comment">*</span>
03584 <span class="comment">* 27-Feb-1997 hiroyama      Created</span>
03585 <span class="comment">\**************************************************************************/</span>
<a name="l03586"></a><a class="code" href="../../d4/d1/ctxtinfo_8c.html#a56">03586</a> LRESULT <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a56">ImmRequestMessageAorW</a>(HIMC hIMC, WPARAM wParam, LPARAM lParam, BOOL bAnsiOrigin)
03587 {
03588     LPINPUTCONTEXT lpInputContext;
03589     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
03590     LRESULT lRet = 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
03591     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwThreadId = <a class="code" href="../../d4/d0/immcli_8h.html#a15">GetInputContextThread</a>(hIMC);
03592 
03593     <span class="keywordflow">if</span> (dwThreadId != GetCurrentThreadId()) {
03594         RIPMSG1(RIP_WARNING,
03595               <span class="stringliteral">"ImmRequestMessageAorW:: Invalid input context access %lx."</span>, hIMC);
03596         <span class="keywordflow">return</span> lRet;
03597     }
03598 
03599     <span class="keywordflow">if</span> (hIMC == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || (lpInputContext = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a12">ImmLockIMC</a>(hIMC)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03600         RIPMSG1(RIP_WARNING, <span class="stringliteral">"ImmRequestMessage: Invalid hImc %lx."</span>, hIMC);
03601         <span class="keywordflow">return</span> 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
03602     }
03603 
03604     <span class="comment">// check if the window of the input context is valid</span>
03605     <span class="keywordflow">if</span> ((pwnd = <a class="code" href="../../d4/d0/immcli_8h.html#a4">ValidateHwnd</a>(lpInputContext-&gt;hWnd)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03606         RIPMSG1(RIP_WARNING, <span class="stringliteral">"ImmRequestMessage: Invalid hWnd %lx."</span>, lpInputContext-&gt;hWnd);
03607     } <span class="keywordflow">else</span> {
03608         <span class="comment">// check if the message is being sent inter thread</span>
03609         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>() != <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd)) {
03610             RIPMSG0(RIP_WARNING, <span class="stringliteral">"ImmRequestMessage: IME Attempt to send IMR_ message to different thread."</span>);
03611         } <span class="keywordflow">else</span> {
03612             lRet = <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a55">ImmRequestMessageWorker</a>(hIMC, pwnd, wParam, lParam, bAnsiOrigin);
03613         }
03614     }
03615 
03616     <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a13">ImmUnlockIMC</a>(hIMC);
03617 
03618     <span class="keywordflow">return</span> lRet;
03619 }
03620 
<a name="l03621"></a><a class="code" href="../../d4/d1/ctxtinfo_8c.html#a57">03621</a> LRESULT WINAPI <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a57">ImmRequestMessageA</a>(HIMC hIMC, WPARAM wParam, LPARAM lParam)
03622 {
03623     <span class="keywordflow">return</span> <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a56">ImmRequestMessageAorW</a>(hIMC, wParam, lParam, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="comment">/* ANSI */</span>);
03624 }
03625 
<a name="l03626"></a><a class="code" href="../../d4/d1/ctxtinfo_8c.html#a58">03626</a> LRESULT WINAPI <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a58">ImmRequestMessageW</a>(HIMC hIMC, WPARAM wParam, LPARAM lParam)
03627 {
03628     <span class="keywordflow">return</span> <a class="code" href="../../d4/d1/ctxtinfo_8c.html#a56">ImmRequestMessageAorW</a>(hIMC, wParam, lParam, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <span class="comment">/* not ANSI */</span>);
03629 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:38 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
