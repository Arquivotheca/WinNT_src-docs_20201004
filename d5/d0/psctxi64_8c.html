<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: psctxi64.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>psctxi64.c File Reference</h1><code>#include "<a class="el" href="../../d9/d0/psp_8h-source.html">psp.h</a>"</code><br>
<code>#include &lt;<a class="el" href="../../d4/d3/ia64_8h-source.html">ia64.h</a>&gt;</code><br>

<p>
<a href="../../d6/d9/psctxi64_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d0/psctxi64_8c.html#a0">ALIGN_NATS</a>(Result, Source, <a class="el" href="../../d5/d2/config_2ia64_2initia64_8c.html#a14">Start</a>, AddressOffset, Mask)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d0/psctxi64_8c.html#a1">EXTRACT_NATS</a>(Result, Source, <a class="el" href="../../d5/d2/config_2ia64_2initia64_8c.html#a14">Start</a>, AddressOffset, Mask)</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d0/psctxi64_8c.html#a2">KiGetDebugContext</a> (IN PKTRAP_FRAME TrapFrame, IN OUT PCONTEXT ContextFrame)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d0/psctxi64_8c.html#a3">KiSetDebugContext</a> (IN OUT PKTRAP_FRAME TrapFrame, IN PCONTEXT ContextFrame, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> ProcessorMode)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d0/psctxi64_8c.html#a4">KiFlushUserRseState</a> (IN PKTRAP_FRAME TrapFrame)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d0/psctxi64_8c.html#a5">PspGetContext</a> (IN PKTRAP_FRAME TrapFrame, IN PKNONVOLATILE_CONTEXT_POINTERS ContextPointers, IN OUT PCONTEXT ContextEM)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d0/psctxi64_8c.html#a6">PspSetContext</a> (IN OUT PKTRAP_FRAME TrapFrame, IN PKNONVOLATILE_CONTEXT_POINTERS ContextPointers, IN PCONTEXT ContextEM, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> ProcessorMode)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d0/psctxi64_8c.html#a7">PspGetSetContextSpecialApcMain</a> (IN <a class="el" href="../../d1/d5/struct__KAPC.html">PKAPC</a> Apc, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a41">PKNORMAL_ROUTINE</a> *NormalRoutine, IN PVOID *NormalContext, IN PVOID *SystemArgument1, IN PVOID *SystemArgument2)</td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a0" doxytag="psctxi64.c::ALIGN_NATS" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define ALIGN_NATS          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">Result,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>Source,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d5/d2/config_2ia64_2initia64_8c.html#a14">Start</a>,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>AddressOffset,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>Mask&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div><span class="keywordflow">if</span> (AddressOffset == <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>) {                                       \
        Result = (ULONGLONG)Source;                                     \
    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (AddressOffset &lt; <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>) {                                 \
        Result = (ULONGLONG)(Source &lt;&lt; (<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a> - AddressOffset));        \
    } <span class="keywordflow">else</span> {                                                            \
        Result = (ULONGLONG)((Source &gt;&gt; (AddressOffset - <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>)) |      \
                             (Source &lt;&lt; (64 + <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a> - AddressOffset))); \
    }                                                                   \
    Result = Result &amp; (ULONGLONG)Mask
</div></pre>
<p>
Definition at line <a class="el" href="../../d6/d9/psctxi64_8c-source.html#l00025">25</a> of file <a class="el" href="../../d6/d9/psctxi64_8c-source.html">psctxi64.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="psctxi64.c::EXTRACT_NATS" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define EXTRACT_NATS          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">Result,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>Source,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d5/d2/config_2ia64_2initia64_8c.html#a14">Start</a>,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>AddressOffset,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>Mask&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>Result = (ULONGLONG)(Source &amp; (ULONGLONG)Mask);                     \
    <span class="keywordflow">if</span> (AddressOffset &lt; <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>) {                                        \
        Result = Result &gt;&gt; (<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a> - AddressOffset);                     \
    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (AddressOffset &gt; <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>) {                                 \
        Result = ((Result &lt;&lt; (AddressOffset - <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>)) |                 \
                  (Result &gt;&gt; (64 + <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a> - AddressOffset)));            \
    }
</div></pre>
<p>
Definition at line <a class="el" href="../../d6/d9/psctxi64_8c-source.html#l00036">36</a> of file <a class="el" href="../../d6/d9/psctxi64_8c-source.html">psctxi64.c</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a4" doxytag="psctxi64.c::KiFlushUserRseState" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KiFlushUserRseState           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PKTRAP_FRAME&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>TrapFrame</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d5/ke_2ia64_2context_8c-source.html#l00646">646</a> of file <a class="el" href="../../d2/d5/ke_2ia64_2context_8c-source.html">ke/ia64/context.c</a>.
<p>
References <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d8/d0/rtl_2ia64_2miscc_8c.html#a0">RtlpFlushRSE()</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00062">SHORT</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d0/d3/mpipi_8c-source.html#l00085">KiSaveProcessorState()</a>, and <a class="el" href="../../d6/d9/psctxi64_8c-source.html#l00616">PspGetSetContextSpecialApcMain()</a>.
<p>
<pre class="fragment"><div>00652                    :
00653 
00654     This routine flushes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user rse state from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> kernel backing store to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00655     user backing store. The user context frame <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> update to reflect <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> 
00656     context state.
00657 
00658 Arguments:
00659 
00660     TrapFrame - Supplies a pointer to a trap frame.
00661 
00662 Return Value:
00663 
00664     None.
00665 
00666 --*/
00667 
00668 {
00669     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> BsFrameSize;
00670     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> RNatSaveIndex;
00671     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> Temp;
00672     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> TearPointOffset;
00673     ULONGLONG TopBound, BottomBound;
00674     ULONGLONG UserRnats1, UserRnats2;
00675     ULONGLONG Mask;
00676 
00677     <span class="comment">//</span>
00678     <span class="comment">// Copy user stacked registers' contents to user backing store.</span>
00679     <span class="comment">// N.B. Stack overflow could happen.</span>
00680     <span class="comment">//</span>
00681 
00682     <span class="keywordflow">try</span> {
00683 
00684         BsFrameSize = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(TrapFrame-&gt;RsBSP - TrapFrame-&gt;RsBSPSTORE);
00685 
00686         <span class="keywordflow">if</span> (BsFrameSize) {
00687 
00688             ULONGLONG Bsp, Rnat, KernelInitBsp;
00689 
00690             <span class="comment">//</span>
00691             <span class="comment">// Copy the dirty stacked registers back into the</span>
00692             <span class="comment">// user backing store</span>
00693             <span class="comment">//</span>
00694 
00695             <a class="code" href="../../d8/d0/rtl_2ia64_2miscc_8c.html#a0">RtlpFlushRSE</a>(&amp;Bsp, &amp;Rnat);
00696             TearPointOffset = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) TrapFrame-&gt;RsBSPSTORE &amp; 0x1F8;
00697 
00698             KernelInitBsp= (PCR-&gt;InitialBStore | TearPointOffset) + BsFrameSize;
00699             <span class="keywordflow">if</span> ((KernelInitBsp | RNAT_ALIGNMENT) != (Bsp | RNAT_ALIGNMENT)) {
00700                 Rnat = *(PULONGLONG)(KernelInitBsp | RNAT_ALIGNMENT);
00701             }
00702 
00703             RtlCopyMemory((PVOID)(TrapFrame-&gt;RsBSPSTORE),
00704                          (PVOID)(PCR-&gt;InitialBStore + TearPointOffset),
00705                          BsFrameSize);
00706 
00707             TopBound = TrapFrame-&gt;RsBSP | RNAT_ALIGNMENT;
00708             BottomBound = TrapFrame-&gt;RsBSPSTORE | RNAT_ALIGNMENT;
00709 
00710             RNatSaveIndex = TearPointOffset &gt;&gt; 3;
00711             Mask = (((1ULL &lt;&lt; (NAT_BITS_PER_RNAT_REG - RNatSaveIndex)) - 1) &lt;&lt; RNatSaveIndex);
00712             UserRnats1 = TrapFrame-&gt;RsRNAT &amp; ((1ULL &lt;&lt; RNatSaveIndex) - 1);
00713 
00714             <span class="keywordflow">if</span> (TopBound &gt; BottomBound) {
00715 
00716                 <span class="comment">//</span>
00717                 <span class="comment">// user dirty stacked GR span across at least one RNAT</span>
00718                 <span class="comment">// boundary; need to deposit the valid RNAT bits from</span>
00719                 <span class="comment">// the trap frame into the kernel backing store.  Also,</span>
00720                 <span class="comment">// the RNAT field in the trap frame has to be updated.</span>
00721                 <span class="comment">//</span>
00722 
00723                 UserRnats2 = *(PULONGLONG)BottomBound &amp; Mask;
00724                 *(PULONGLONG)BottomBound = UserRnats1 | UserRnats2;
00725                 TrapFrame-&gt;RsRNAT = Rnat;
00726                 
00727 <span class="preprocessor">#if DEBUG</span>
00728 <span class="preprocessor"></span>                <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"KiFlushUserRseState 1: UserRnats1 = 0x%I64x, UserRnats2 = 0x%I64x, TF-&gt;RsRNAT = 0x%I64x\n"</span>,
00729                          UserRnats1, UserRnats2, TrapFrame-&gt;RsRNAT);
00730 <span class="preprocessor">#endif // DEBUG</span>
00731 <span class="preprocessor"></span>
00732             } <span class="keywordflow">else</span> {
00733 
00734                 <span class="comment">//</span>
00735                 <span class="comment">// user stacked register region does not span across an</span>
00736                 <span class="comment">// RNAT boundary; combine the RNAT fields from both the</span>
00737                 <span class="comment">// trap frame and the context frame.</span>
00738                 <span class="comment">//</span>
00739 
00740                 UserRnats2 = Rnat &amp; Mask;
00741                 TrapFrame-&gt;RsRNAT = UserRnats1 | UserRnats2;
00742 
00743 <span class="preprocessor">#if DEBUG</span>
00744 <span class="preprocessor"></span>                <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"KiFlushUserRseState 2: UserRnats1 = 0x%I64x, UserRnats2 = 0x%I64x, TF-&gt;RsRNAT = 0x%I64x\n"</span>,
00745                          UserRnats1, UserRnats2, TrapFrame-&gt;RsRNAT);
00746 <span class="preprocessor">#endif // DEBUG</span>
00747 <span class="preprocessor"></span>
00748             }
00749         }
00750 
00751         <span class="comment">//</span>
00752         <span class="comment">// Successfully copied to user backing store; set the user's</span>
00753         <span class="comment">// bspstore to the value of its own bsp.</span>
00754         <span class="comment">//</span>
00755 
00756         TrapFrame-&gt;RsBSPSTORE = TrapFrame-&gt;RsBSP;
00757 
00758     } except (EXCEPTION_EXECUTE_HANDLER) {
00759         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"WARNING: Exception raised in krnl-to-user bstore copy\n"</span>);
00760     }
00761 
00762     <span class="keywordflow">return</span>;
00763 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="psctxi64.c::KiGetDebugContext" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KiGetDebugContext           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PKTRAP_FRAME&nbsp;</td>
          <td class="mdname" nowrap> <em>TrapFrame</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PCONTEXT&nbsp;</td>
          <td class="mdname" nowrap> <em>ContextFrame</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d5/ke_2ia64_2context_8c-source.html#l00054">54</a> of file <a class="el" href="../../d2/d5/ke_2ia64_2context_8c-source.html">ke/ia64/context.c</a>.
<p>
References <a class="el" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>.
<p>
Referenced by <a class="el" href="../../d2/d5/ke_2ia64_2context_8c-source.html#l00165">KeContextFromKframes()</a>, and <a class="el" href="../../d6/d9/psctxi64_8c-source.html#l00065">PspGetContext()</a>.
<p>
<pre class="fragment"><div>00061                    :
00062 
00063     This routine moves <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user mode h/w debug registers from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> debug <span class="keyword">register</span>
00064     save area in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> kernel stack to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> context record.
00065 
00066 Arguments:
00067 
00068     TrapFrame - Supplies a pointer to a trap frame from which <span class="keyword">volatile</span> context
00069         should be copied into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> context record.
00070 
00071     ContextFrame - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> context frame that receives <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00072         context.
00073 
00074 Return Value:
00075 
00076     None.
00077 
00078 Note:
00079     
00080     <a class="code" href="../../d9/d2/festate_8h.html#a2">PSR</a>.db must be set to activate <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> debug registers.
00081 
00082     This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used <span class="keywordflow">for</span> getting user mode debug registers.
00083 
00084 --*/
00085 
00086 {
00087     PKDEBUG_REGISTERS DebugRegistersSaveArea;
00088 
00089     <span class="keywordflow">if</span> (TrapFrame-&gt;PreviousMode == <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>) {
00090         DebugRegistersSaveArea = GET_DEBUG_REGISTER_SAVEAREA();
00091 
00092         RtlCopyMemory(&amp;ContextFrame-&gt;DbI0, 
00093                       (PVOID)DebugRegistersSaveArea,
00094                       <span class="keyword">sizeof</span>(KDEBUG_REGISTERS));
00095     }
00096 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="psctxi64.c::KiSetDebugContext" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KiSetDebugContext           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT PKTRAP_FRAME&nbsp;</td>
          <td class="mdname" nowrap> <em>TrapFrame</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PCONTEXT&nbsp;</td>
          <td class="mdname" nowrap> <em>ContextFrame</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ProcessorMode</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d5/ke_2ia64_2context_8c-source.html#l00099">99</a> of file <a class="el" href="../../d2/d5/ke_2ia64_2context_8c-source.html">ke/ia64/context.c</a>.
<p>
References <a class="el" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>.
<p>
Referenced by <a class="el" href="../../d2/d5/ke_2ia64_2context_8c-source.html#l00393">KeContextToKframes()</a>, <a class="el" href="../../d2/d5/ke_2ia64_2context_8c-source.html#l00766">KeContextToKframesSpecial()</a>, and <a class="el" href="../../d6/d9/psctxi64_8c-source.html#l00304">PspSetContext()</a>.
<p>
<pre class="fragment"><div>00106                    :
00107 
00108     This routine moves <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> debug context from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified context frame into
00109     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> debug registers save area in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> kernel stack.
00110 
00111 Arguments:
00112 
00113     TrapFrame - Supplies a pointer to a trap frame.
00114 
00115     ContextFrame - Supplies a pointer to a context frame that contains <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00116         context that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be copied.
00117 
00118     PreviousMode - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> processor mode <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target context.
00119 
00120 Return Value:
00121 
00122     None.
00123 
00124 Notes:
00125 
00126    <a class="code" href="../../d9/d2/festate_8h.html#a2">PSR</a>.db must be set to activate <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> debug registers.
00127    
00128    This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used <span class="keywordflow">for</span> setting up debug registers <span class="keywordflow">for</span> user mode.
00129 
00130 --*/
00131 
00132 {
00133     PKDEBUG_REGISTERS DebugRegistersSaveArea;  <span class="comment">// User mode h/w debug registers</span>
00134 
00135     <span class="keywordflow">if</span> (PreviousMode == <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>) {
00136 
00137         DebugRegistersSaveArea = GET_DEBUG_REGISTER_SAVEAREA();
00138 
00139         <span class="comment">//</span>
00140         <span class="comment">// Sanitize the debug control regs. Leave the addresses unchanged.</span>
00141         <span class="comment">//</span>
00142 
00143         DebugRegistersSaveArea-&gt;DbI0 = ContextFrame-&gt;DbI0;
00144         DebugRegistersSaveArea-&gt;DbI1 = SANITIZE_DR(ContextFrame-&gt;DbI1,UserMode);
00145         DebugRegistersSaveArea-&gt;DbI2 = ContextFrame-&gt;DbI2;
00146         DebugRegistersSaveArea-&gt;DbI3 = SANITIZE_DR(ContextFrame-&gt;DbI3,UserMode);
00147         DebugRegistersSaveArea-&gt;DbI4 = ContextFrame-&gt;DbI4;
00148         DebugRegistersSaveArea-&gt;DbI5 = SANITIZE_DR(ContextFrame-&gt;DbI5,UserMode);
00149         DebugRegistersSaveArea-&gt;DbI6 = ContextFrame-&gt;DbI6;
00150         DebugRegistersSaveArea-&gt;DbI7 = SANITIZE_DR(ContextFrame-&gt;DbI7,UserMode);
00151 
00152         DebugRegistersSaveArea-&gt;DbD0 = ContextFrame-&gt;DbD0;
00153         DebugRegistersSaveArea-&gt;DbD1 = SANITIZE_DR(ContextFrame-&gt;DbD1,UserMode);
00154         DebugRegistersSaveArea-&gt;DbD2 = ContextFrame-&gt;DbD2;
00155         DebugRegistersSaveArea-&gt;DbD3 = SANITIZE_DR(ContextFrame-&gt;DbD3,UserMode);
00156         DebugRegistersSaveArea-&gt;DbD4 = ContextFrame-&gt;DbD4;
00157         DebugRegistersSaveArea-&gt;DbD5 = SANITIZE_DR(ContextFrame-&gt;DbD5,UserMode);
00158         DebugRegistersSaveArea-&gt;DbD6 = ContextFrame-&gt;DbD6;
00159         DebugRegistersSaveArea-&gt;DbD7 = SANITIZE_DR(ContextFrame-&gt;DbD7,UserMode);
00160 
00161     }
00162 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="psctxi64.c::PspGetContext" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID PspGetContext           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PKTRAP_FRAME&nbsp;</td>
          <td class="mdname" nowrap> <em>TrapFrame</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PKNONVOLATILE_CONTEXT_POINTERS&nbsp;</td>
          <td class="mdname" nowrap> <em>ContextPointers</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PCONTEXT&nbsp;</td>
          <td class="mdname" nowrap> <em>ContextEM</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d9/psctxi64_8c-source.html#l00065">65</a> of file <a class="el" href="../../d6/d9/psctxi64_8c-source.html">psctxi64.c</a>.
<p>
References <a class="el" href="../../d2/d5/ke_2ia64_2context_8c-source.html#l00032">ALIGN_NATS</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00240">CONTEXT_CONTROL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00242">CONTEXT_INTEGER</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d2/d5/ke_2ia64_2context_8c-source.html#l00054">KiGetDebugContext()</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00062">SHORT</a>, <a class="el" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
<pre class="fragment"><div>00073                    :
00074 
00075     This function selectively moves <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> contents of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified trap frame
00076     and nonvolatile context to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified context record.
00077 
00078 Arguments:
00079 
00080     TrapFrame -         Supplies a pointer to a trap frame.
00081 
00082     ContextPointers -   Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of context pointers record.
00083 
00084     ContextEM -         Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of a context record.
00085 
00086 Return Value:
00087 
00088     None.
00089 
00090     N.B. The side effect of <span class="keyword">this</span> routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> dirty user stacked
00091          registers that were flushed into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> kernel backing store are
00092          copied backed into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user backing store and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> trap frame
00093          will be modified as a result of that.
00094 
00095 --*/
00096 
00097 {
00098 
00099     ULONGLONG IntNats1, IntNats2 = 0;
00100     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> R1Offset, R4Offset;
00101     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> Temp, BsFrameSize;
00102 
00103     <span class="keywordflow">if</span> ((ContextEM-&gt;ContextFlags &amp; <a class="code" href="../../d6/d7/halmips_8h.html#a153">CONTEXT_CONTROL</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a153">CONTEXT_CONTROL</a>) {
00104 
00105         ContextEM-&gt;IntGp = TrapFrame-&gt;IntGp;
00106         ContextEM-&gt;IntSp = TrapFrame-&gt;IntSp;
00107         ContextEM-&gt;ApUNAT = TrapFrame-&gt;ApUNAT;
00108         ContextEM-&gt;BrRp = TrapFrame-&gt;BrRp;
00109         ContextEM-&gt;ApCCV = TrapFrame-&gt;ApCCV;
00110         ContextEM-&gt;ApDCR = TrapFrame-&gt;ApDCR;
00111 
00112         ContextEM-&gt;StFPSR = TrapFrame-&gt;StFPSR;
00113         ContextEM-&gt;StIPSR = TrapFrame-&gt;StIPSR;
00114         ContextEM-&gt;StIIP = TrapFrame-&gt;StIIP;
00115         ContextEM-&gt;StIFS = TrapFrame-&gt;StIFS;
00116 
00117         <span class="comment">//</span>
00118         <span class="comment">// Get RSE control states from the trap frame.</span>
00119         <span class="comment">//</span>
00120 
00121         ContextEM-&gt;RsPFS = TrapFrame-&gt;RsPFS;
00122         ContextEM-&gt;RsRSC = TrapFrame-&gt;RsRSC;
00123         ContextEM-&gt;RsRNAT = TrapFrame-&gt;RsRNAT;
00124         
00125         <span class="keywordflow">if</span> (TRAP_FRAME_TYPE(TrapFrame) == SYSCALL_FRAME) {
00126             BsFrameSize = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>) (TrapFrame-&gt;StIFS &gt;&gt; PFS_SIZE_SHIFT) &amp; PFS_SIZE_MASK;
00127         } <span class="keywordflow">else</span> {
00128             BsFrameSize = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>) TrapFrame-&gt;StIFS &amp; PFS_SIZE_MASK;
00129         }
00130         Temp = BsFrameSize - (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)((TrapFrame-&gt;RsBSP &gt;&gt; 3) &amp; NAT_BITS_PER_RNAT_REG);
00131         <span class="keywordflow">while</span> (Temp &gt; 0) {
00132             BsFrameSize++;
00133             Temp -= NAT_BITS_PER_RNAT_REG;
00134         }
00135 
00136         ContextEM-&gt;RsBSP = TrapFrame-&gt;RsBSP - (BsFrameSize * 8);
00137         ContextEM-&gt;RsBSPSTORE = ContextEM-&gt;RsBSP;
00138 
00139         <span class="comment">//</span>
00140         <span class="comment">// Get preserved applicaton registers</span>
00141         <span class="comment">//</span>
00142 
00143         ContextEM-&gt;ApLC = *ContextPointers-&gt;ApLC;
00144         ContextEM-&gt;ApEC = (*ContextPointers-&gt;ApEC &gt;&gt; PFS_EC_SHIFT) &amp; PFS_EC_MASK;
00145 
00146         <span class="comment">//</span>
00147         <span class="comment">// Get iA status</span>
00148         <span class="comment">//</span>
00149 
00150         ContextEM-&gt;StFSR = *ContextPointers-&gt;StFSR;
00151         ContextEM-&gt;StFIR = *ContextPointers-&gt;StFIR;
00152         ContextEM-&gt;StFDR = *ContextPointers-&gt;StFDR;
00153         ContextEM-&gt;Cflag = *ContextPointers-&gt;Cflag;
00154 
00155     }
00156 
00157     <span class="keywordflow">if</span> ((ContextEM-&gt;ContextFlags &amp; <a class="code" href="../../d6/d7/halmips_8h.html#a155">CONTEXT_INTEGER</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a155">CONTEXT_INTEGER</a>) {
00158 
00159         ContextEM-&gt;IntT0 = TrapFrame-&gt;IntT0;
00160         ContextEM-&gt;IntT1 = TrapFrame-&gt;IntT1;
00161         ContextEM-&gt;IntT2 = TrapFrame-&gt;IntT2;
00162         ContextEM-&gt;IntT3 = TrapFrame-&gt;IntT3;
00163         ContextEM-&gt;IntT4 = TrapFrame-&gt;IntT4;
00164         ContextEM-&gt;IntV0 = TrapFrame-&gt;IntV0;
00165         ContextEM-&gt;IntTeb = TrapFrame-&gt;IntTeb;
00166         ContextEM-&gt;Preds = TrapFrame-&gt;Preds;
00167         
00168         <span class="comment">//</span>
00169         <span class="comment">// t5 - t22</span>
00170         <span class="comment">//</span>
00171 
00172         memcpy(&amp;ContextEM-&gt;IntT5, &amp;TrapFrame-&gt;IntT5, 18*<span class="keyword">sizeof</span>(ULONGLONG));
00173 
00174 
00175         <span class="comment">//</span>
00176         <span class="comment">// Get branch registers</span>
00177         <span class="comment">//</span>
00178 
00179         ContextEM-&gt;BrT0 = TrapFrame-&gt;BrT0;
00180         ContextEM-&gt;BrT1 = TrapFrame-&gt;BrT1;
00181 
00182         ContextEM-&gt;BrS0 = *ContextPointers-&gt;BrS0;
00183         ContextEM-&gt;BrS1 = *ContextPointers-&gt;BrS1;
00184         ContextEM-&gt;BrS2 = *ContextPointers-&gt;BrS2;
00185         ContextEM-&gt;BrS3 = *ContextPointers-&gt;BrS3;
00186         ContextEM-&gt;BrS4 = *ContextPointers-&gt;BrS4;
00187 
00188         <span class="comment">//</span>
00189         <span class="comment">// Get integer registers s0 - s3 from exception frame.</span>
00190         <span class="comment">//</span>
00191 
00192         ContextEM-&gt;IntS0 = *ContextPointers-&gt;IntS0;
00193         ContextEM-&gt;IntS1 = *ContextPointers-&gt;IntS1;
00194         ContextEM-&gt;IntS2 = *ContextPointers-&gt;IntS2;
00195         ContextEM-&gt;IntS3 = *ContextPointers-&gt;IntS3;
00196         IntNats2 |= (((*ContextPointers-&gt;IntS0Nat &gt;&gt; (((ULONG_PTR)ContextPointers-&gt;IntS0 &amp; 0x1F8) &gt;&gt; 3)) &amp; 0x1) &lt;&lt; 4);
00197         IntNats2 |= (((*ContextPointers-&gt;IntS1Nat &gt;&gt; (((ULONG_PTR)ContextPointers-&gt;IntS1 &amp; 0x1F8) &gt;&gt; 3)) &amp; 0x1) &lt;&lt; 5);
00198         IntNats2 |= (((*ContextPointers-&gt;IntS2Nat &gt;&gt; (((ULONG_PTR)ContextPointers-&gt;IntS2 &amp; 0x1F8) &gt;&gt; 3)) &amp; 0x1) &lt;&lt; 6);
00199         IntNats2 |= (((*ContextPointers-&gt;IntS3Nat &gt;&gt; (((ULONG_PTR)ContextPointers-&gt;IntS3 &amp; 0x1F8) &gt;&gt; 3)) &amp; 0x1) &lt;&lt; 7);
00200 
00201         <span class="comment">//</span>
00202         <span class="comment">// Get the integer nats field in the context </span>
00203         <span class="comment">// *ContextPointers-&gt;IntNats has Nats for preserved regs</span>
00204         <span class="comment">//</span>
00205 
00206         R1Offset = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)((ULONG_PTR)(&amp;TrapFrame-&gt;IntGp) &gt;&gt; 3) &amp; 0x3f;
00207         R4Offset = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)((ULONG_PTR)(ContextPointers-&gt;IntS0) &gt;&gt; 3) &amp; 0x3f;
00208         <a class="code" href="../../d1/d6/ke_2ia64_2context_8c.html#a0">ALIGN_NATS</a>(IntNats1, TrapFrame-&gt;IntNats, 1, R1Offset, 0xFFFFFF0E);
00209 
00210         ContextEM-&gt;IntNats = IntNats1 | IntNats2;
00211 
00212 <span class="preprocessor">#ifdef DEBUG</span>
00213 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"PspGetContext INTEGER: R1Offset = 0x%x, TF-&gt;IntNats = 0x%I64x, IntNats1 = 0x%I64x\n"</span>,
00214                R1Offset, TrapFrame-&gt;IntNats, IntNats1);
00215 <span class="preprocessor">#endif</span>
00216 <span class="preprocessor"></span>
00217     }
00218 
00219     <span class="keywordflow">if</span> ((ContextEM-&gt;ContextFlags &amp; CONTEXT_LOWER_FLOATING_POINT) == CONTEXT_LOWER_FLOATING_POINT) {
00220 
00221         <span class="comment">//</span>
00222         <span class="comment">// Get EM + ia32 FP status</span>
00223         <span class="comment">//</span>
00224         
00225         ContextEM-&gt;StFPSR = TrapFrame-&gt;StFPSR;
00226         ContextEM-&gt;StFSR  = *ContextPointers-&gt;StFSR;
00227         ContextEM-&gt;StFIR  = *ContextPointers-&gt;StFIR;
00228         ContextEM-&gt;StFDR  = *ContextPointers-&gt;StFDR;
00229 
00230         <span class="comment">//</span>
00231         <span class="comment">// Get floating registers fs0 - fs19</span>
00232         <span class="comment">//</span>
00233 
00234         ContextEM-&gt;FltS0 = *ContextPointers-&gt;FltS0;
00235         ContextEM-&gt;FltS1 = *ContextPointers-&gt;FltS1;
00236         ContextEM-&gt;FltS2 = *ContextPointers-&gt;FltS2;
00237         ContextEM-&gt;FltS3 = *ContextPointers-&gt;FltS3;
00238 
00239         ContextEM-&gt;FltS4 = *ContextPointers-&gt;FltS4;
00240         ContextEM-&gt;FltS5 = *ContextPointers-&gt;FltS5;
00241         ContextEM-&gt;FltS6 = *ContextPointers-&gt;FltS6;
00242         ContextEM-&gt;FltS7 = *ContextPointers-&gt;FltS7;
00243 
00244         ContextEM-&gt;FltS8 = *ContextPointers-&gt;FltS8;
00245         ContextEM-&gt;FltS9 = *ContextPointers-&gt;FltS9;
00246         ContextEM-&gt;FltS10 = *ContextPointers-&gt;FltS10;
00247         ContextEM-&gt;FltS11 = *ContextPointers-&gt;FltS11;
00248 
00249         ContextEM-&gt;FltS12 = *ContextPointers-&gt;FltS12;
00250         ContextEM-&gt;FltS13 = *ContextPointers-&gt;FltS13;
00251         ContextEM-&gt;FltS14 = *ContextPointers-&gt;FltS14;
00252         ContextEM-&gt;FltS15 = *ContextPointers-&gt;FltS15;
00253 
00254         ContextEM-&gt;FltS16 = *ContextPointers-&gt;FltS16;
00255         ContextEM-&gt;FltS17 = *ContextPointers-&gt;FltS17;
00256         ContextEM-&gt;FltS18 = *ContextPointers-&gt;FltS18;
00257         ContextEM-&gt;FltS19 = *ContextPointers-&gt;FltS19;
00258 
00259         <span class="comment">//</span>
00260         <span class="comment">// Get floating registers ft0 - ft9 from trap frame.</span>
00261         <span class="comment">//</span>
00262 
00263         RtlCopyIa64FloatRegisterContext(&amp;ContextEM-&gt;FltT0,
00264                                         &amp;TrapFrame-&gt;FltT0,
00265                                         <span class="keyword">sizeof</span>(FLOAT128) * (10));
00266     }
00267 
00268     <span class="keywordflow">if</span> ((ContextEM-&gt;ContextFlags &amp; CONTEXT_HIGHER_FLOATING_POINT) == CONTEXT_HIGHER_FLOATING_POINT) {
00269 
00270         <span class="comment">//</span>
00271         <span class="comment">// Get EM + ia32 FP status</span>
00272         <span class="comment">//</span>
00273         
00274         ContextEM-&gt;StFPSR = TrapFrame-&gt;StFPSR;
00275         ContextEM-&gt;StFSR  = *ContextPointers-&gt;StFSR;
00276         ContextEM-&gt;StFIR  = *ContextPointers-&gt;StFIR;
00277         ContextEM-&gt;StFDR  = *ContextPointers-&gt;StFDR;
00278 
00279         <span class="comment">//</span>
00280         <span class="comment">// Get floating regs f32 - f127 from higher floating point save area</span>
00281         <span class="comment">//</span>
00282 
00283         <span class="keywordflow">if</span> (TrapFrame-&gt;PreviousMode == <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>) {
00284             RtlCopyIa64FloatRegisterContext(
00285                 &amp;ContextEM-&gt;FltF32, 
00286                 (PFLOAT128)GET_HIGH_FLOATING_POINT_REGISTER_SAVEAREA(),
00287                 96*<span class="keyword">sizeof</span>(FLOAT128)
00288                 );
00289         }
00290     }
00291 
00292     <span class="comment">//</span>
00293     <span class="comment">// Get h/w debug register context</span>
00294     <span class="comment">//</span>
00295 
00296     <span class="keywordflow">if</span> ((ContextEM-&gt;ContextFlags &amp; CONTEXT_DEBUG) == CONTEXT_DEBUG) {
00297         <a class="code" href="../../d5/d0/psctxi64_8c.html#a2">KiGetDebugContext</a>(TrapFrame, ContextEM);
00298     }
00299 
00300     <span class="keywordflow">return</span>;
00301 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="psctxi64.c::PspGetSetContextSpecialApcMain" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID PspGetSetContextSpecialApcMain           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d5/struct__KAPC.html">PKAPC</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Apc</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a41">PKNORMAL_ROUTINE</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>NormalRoutine</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>NormalContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemArgument1</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>SystemArgument2</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d9/psctxi64_8c-source.html#l00616">616</a> of file <a class="el" href="../../d6/d9/psctxi64_8c-source.html">psctxi64.c</a>.
<p>
References <a class="el" href="../../d9/d0/psp_8h-source.html#l00080">_GETSETCONTEXT::Context</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d7/eventobj_8c-source.html#l00343">KeSetEvent()</a>, <a class="el" href="../../d2/d5/ke_2ia64_2context_8c-source.html#l00646">KiFlushUserRseState()</a>, <a class="el" href="../../d9/d0/psp_8h-source.html#l00078">_GETSETCONTEXT::Mode</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d9/d0/psp_8h-source.html#l00079">_GETSETCONTEXT::OperationComplete</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d5/d9/psctxalp_8c-source.html#l00029">PspGetContext()</a>, <a class="el" href="../../d4/d9/psctx386_8c-source.html#l00088">PspSetContext()</a>, <a class="el" href="../../d0/d9/ppc_2exdsptch_8c-source.html#l00348">RtlLookupFunctionEntry()</a>, <a class="el" href="../../d1/d6/ppc_2vunwind_8c-source.html#l00467">RtlVirtualUnwind()</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00062">SHORT</a>.
<p>
<pre class="fragment"><div>00626                    :
00627 
00628     This function either captures <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user mode state of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current
00629     thread, or sets <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user mode state of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current thread. The
00630     operation <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> determined by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value of SystemArgument1. <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a>
00631     zero value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used <span class="keywordflow">for</span> get context, and a nonzero value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used
00632     <span class="keywordflow">for</span> set context.
00633 
00634 Arguments:
00635 
00636     Apc - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> APC <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> object that caused entry
00637           into <span class="keyword">this</span> routine.
00638 
00639     NormalRoutine - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> normal routine function that
00640         was specified when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> APC was initialized. This parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not
00641         used.
00642 
00643     NormalContext - Supplies a pointer to an arbitrary data structure that
00644         was specified when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> APC was initialized. This parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not
00645         used.
00646 
00647     SystemArgument1, SystemArgument2 - Supplies a set of two pointers to two
00648         arguments that contain untyped data.
00649         The first arguement <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to distinguish between get and set requests.
00650             <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> value of zero  signifies that GetThreadContext was requested.
00651             <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> non-zero value signifies that SetThreadContext was requested.
00652         The Second arguement has <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread handle. The second arguement <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00653         not used.
00654 
00655 Return Value:
00656 
00657     None.
00658 
00659 --*/
00660 
00661 {
00662     <a class="code" href="../../d1/d2/struct__GETSETCONTEXT.html">PGETSETCONTEXT</a>                ContextInfo;
00663     KNONVOLATILE_CONTEXT_POINTERS ContextPointers;  <span class="comment">// Not currently used, needed later.</span>
00664     CONTEXT                       ContextRecord;
00665     ULONGLONG                     ControlPc;
00666     FRAME_POINTERS                EstablisherFrame;
00667     PRUNTIME_FUNCTION             FunctionEntry;
00668     BOOLEAN                       InFunction;
00669     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a>                      Thread;
00670     PKTRAP_FRAME                  TrFrame1;
00671     ULONGLONG                     ImageBase;
00672     ULONGLONG                     TargetGp;
00673 
00674     <span class="comment">//</span>
00675     <span class="comment">// Get the address of the context frame and compute the address of the</span>
00676     <span class="comment">// system entry trap frame.</span>
00677     <span class="comment">//</span>
00678 
00679     ContextInfo = CONTAINING_RECORD(Apc, <a class="code" href="../../d1/d2/struct__GETSETCONTEXT.html">GETSETCONTEXT</a>, Apc);
00680 
00681     TrFrame1 = (PKTRAP_FRAME)(((ULONG_PTR)<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;Tcb.InitialStack
00682                     - KTHREAD_STATE_SAVEAREA_LENGTH - KTRAP_FRAME_LENGTH));
00683 
00684     <span class="comment">//</span>
00685     <span class="comment">// Capture the current thread context and set the initial control PC</span>
00686     <span class="comment">// value.</span>
00687     <span class="comment">//</span>
00688 
00689     RtlCaptureContext(&amp;ContextRecord);
00690     ControlPc = ContextRecord.BrRp;
00691 
00692     <span class="comment">//</span>
00693     <span class="comment">// Initialize context pointers for the nonvolatile integer and floating</span>
00694     <span class="comment">// registers.</span>
00695     <span class="comment">//</span>
00696 
00697     ContextPointers.FltS0 = &amp;ContextRecord.FltS0;
00698     ContextPointers.FltS1 = &amp;ContextRecord.FltS1;
00699     ContextPointers.FltS2 = &amp;ContextRecord.FltS2;
00700     ContextPointers.FltS3 = &amp;ContextRecord.FltS3;
00701     ContextPointers.FltS4 = &amp;ContextRecord.FltS4;
00702     ContextPointers.FltS5 = &amp;ContextRecord.FltS5;
00703     ContextPointers.FltS6 = &amp;ContextRecord.FltS6;
00704     ContextPointers.FltS7 = &amp;ContextRecord.FltS7;
00705     ContextPointers.FltS8 = &amp;ContextRecord.FltS8;
00706     ContextPointers.FltS9 = &amp;ContextRecord.FltS9;
00707     ContextPointers.FltS10 = &amp;ContextRecord.FltS10;
00708     ContextPointers.FltS11 = &amp;ContextRecord.FltS11;
00709     ContextPointers.FltS12 = &amp;ContextRecord.FltS12;
00710     ContextPointers.FltS13 = &amp;ContextRecord.FltS13;
00711     ContextPointers.FltS14 = &amp;ContextRecord.FltS14;
00712     ContextPointers.FltS15 = &amp;ContextRecord.FltS15;
00713     ContextPointers.FltS16 = &amp;ContextRecord.FltS16;
00714     ContextPointers.FltS17 = &amp;ContextRecord.FltS17;
00715     ContextPointers.FltS18 = &amp;ContextRecord.FltS18;
00716     ContextPointers.FltS19 = &amp;ContextRecord.FltS19;
00717 
00718     ContextPointers.IntS0 = &amp;ContextRecord.IntS0;
00719     ContextPointers.IntS1 = &amp;ContextRecord.IntS1;
00720     ContextPointers.IntS2 = &amp;ContextRecord.IntS2;
00721     ContextPointers.IntS3 = &amp;ContextRecord.IntS3;
00722     ContextPointers.IntSp = &amp;ContextRecord.IntSp;
00723 
00724     ContextPointers.BrS0 = &amp;ContextRecord.BrS0;
00725     ContextPointers.BrS1 = &amp;ContextRecord.BrS1;
00726     ContextPointers.BrS2 = &amp;ContextRecord.BrS2;
00727     ContextPointers.BrS3 = &amp;ContextRecord.BrS3;
00728     ContextPointers.BrS4 = &amp;ContextRecord.BrS4;
00729 
00730     ContextPointers.ApLC = &amp;ContextRecord.ApLC;
00731     ContextPointers.ApEC = &amp;ContextRecord.ApEC;
00732 
00733     ContextPointers.StFSR = &amp;ContextRecord.StFSR;
00734     ContextPointers.StFIR = &amp;ContextRecord.StFIR;
00735     ContextPointers.StFDR = &amp;ContextRecord.StFDR;
00736     ContextPointers.Cflag = &amp;ContextRecord.Cflag;
00737 
00738     <span class="comment">//</span>
00739     <span class="comment">// Start with the frame specified by the context record and virtually</span>
00740     <span class="comment">// unwind call frames until the system entry trap frame is encountered.</span>
00741     <span class="comment">//</span>
00742 
00743     <span class="keywordflow">do</span> {
00744 
00745         <span class="comment">//</span>
00746         <span class="comment">// Lookup the function table entry using the point at which control</span>
00747         <span class="comment">// left the procedure.</span>
00748         <span class="comment">//</span>
00749 
00750         FunctionEntry = <a class="code" href="../../d9/d9/ppc_2exdsptch_8c.html#a8">RtlLookupFunctionEntry</a>(ControlPc, &amp;ImageBase, &amp;TargetGp);
00751 
00752         <span class="comment">//</span>
00753         <span class="comment">// If there is a function table entry for the routine, then virtually</span>
00754         <span class="comment">// unwind to the caller of the current routine to obtain the address</span>
00755         <span class="comment">// where control left the caller.</span>
00756         <span class="comment">//</span>
00757 
00758         <span class="keywordflow">if</span> (FunctionEntry != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00759             ControlPc = <a class="code" href="../../d0/d7/ppc_2vunwind_8c.html#a38">RtlVirtualUnwind</a>(ImageBase,
00760                                          ControlPc,
00761                                          FunctionEntry,
00762                                          &amp;ContextRecord,
00763                                          &amp;InFunction,
00764                                          &amp;EstablisherFrame,
00765                                          &amp;ContextPointers);
00766 
00767         } <span class="keywordflow">else</span> {
00768             <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> BsFrameSize, TempFrameSize;
00769 
00770             ControlPc = ContextRecord.BrRp;
00771             ContextRecord.StIFS = ContextRecord.RsPFS;
00772             BsFrameSize = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)(ContextRecord.StIFS &gt;&gt; PFS_SIZE_SHIFT) &amp; PFS_SIZE_MASK;
00773             TempFrameSize = BsFrameSize - (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)((ContextRecord.RsBSP &gt;&gt; 3) &amp; NAT_BITS_PER_RNAT_REG);
00774             <span class="keywordflow">while</span> (TempFrameSize &gt; 0) {
00775                 BsFrameSize++;
00776                 TempFrameSize -= NAT_BITS_PER_RNAT_REG;
00777             }
00778             ContextRecord.RsBSP -= BsFrameSize * <span class="keyword">sizeof</span>(ULONGLONG);
00779         }
00780 
00781     } <span class="keywordflow">while</span> ((PVOID)ContextRecord.IntSp != TrFrame1);
00782 
00783     <span class="comment">//</span>
00784     <span class="comment">// Process GetThreadContext or SetThreadContext as specified.</span>
00785     <span class="comment">//</span>
00786 
00787     <span class="keywordflow">if</span> (*SystemArgument1 != 0) {
00788 
00789         <span class="comment">//</span>
00790         <span class="comment">// Set Context from proper Context mode</span>
00791         <span class="comment">//</span>
00792 
00793         <a class="code" href="../../d8/d1/psp_8h.html#a72">PspSetContext</a>(TrFrame1, &amp;ContextPointers, &amp;ContextInfo-&gt;<a class="code" href="../../d1/d2/struct__GETSETCONTEXT.html#o3">Context</a>,
00794                       ContextInfo-&gt;<a class="code" href="../../d1/d2/struct__GETSETCONTEXT.html#o1">Mode</a>);
00795 
00796     } <span class="keywordflow">else</span> {
00797 
00798         <span class="comment">//</span>
00799         <span class="comment">// Get Context from proper Context mode</span>
00800         <span class="comment">//</span>
00801 
00802         <a class="code" href="../../d5/d0/psctxi64_8c.html#a4">KiFlushUserRseState</a>(TrFrame1);
00803         <a class="code" href="../../d8/d1/psp_8h.html#a73">PspGetContext</a>(TrFrame1, &amp;ContextPointers, &amp;ContextInfo-&gt;<a class="code" href="../../d1/d2/struct__GETSETCONTEXT.html#o3">Context</a>);
00804 
00805     }
00806 
00807     <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>(&amp;ContextInfo-&gt;<a class="code" href="../../d1/d2/struct__GETSETCONTEXT.html#o2">OperationComplete</a>, 0, FALSE);
00808     <span class="keywordflow">return</span>;
00809 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="psctxi64.c::PspSetContext" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID PspSetContext           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT PKTRAP_FRAME&nbsp;</td>
          <td class="mdname" nowrap> <em>TrapFrame</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PKNONVOLATILE_CONTEXT_POINTERS&nbsp;</td>
          <td class="mdname" nowrap> <em>ContextPointers</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PCONTEXT&nbsp;</td>
          <td class="mdname" nowrap> <em>ContextEM</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ProcessorMode</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d9/psctxi64_8c-source.html#l00304">304</a> of file <a class="el" href="../../d6/d9/psctxi64_8c-source.html">psctxi64.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00240">CONTEXT_CONTROL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00242">CONTEXT_INTEGER</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d2/d5/ke_2ia64_2context_8c-source.html#l00043">EXTRACT_NATS</a>, <a class="el" href="../../d3/d6/alpha_2kdpcpu_8h-source.html#l00070">KeGetCurrentThread</a>, <a class="el" href="../../d2/d5/ke_2ia64_2context_8c-source.html#l00099">KiSetDebugContext()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01209">ProbeForRead</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00062">SHORT</a>, <a class="el" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
<pre class="fragment"><div>00313                    :
00314 
00315     This function selectively moves <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> contents of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified context
00316     record to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified trap frame and nonvolatile context.
00317 
00318     We're expecting a plabel to have been passed in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> IIP (we won't have a valid
00319     Global pointer) and <span class="keywordflow">if</span> we have a plabel we fill in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> correct Global pointer and
00320     IIP. Technically, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> GP <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> part of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d6/d7/halmips_8h.html#a153">CONTEXT_CONTROL</a> with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> EM architecture
00321     so we <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> need to check to see <span class="keywordflow">if</span> <a class="code" href="../../d6/d7/halmips_8h.html#a153">CONTEXT_CONTROL</a> has been specified. 
00322 
00323 Arguments:
00324 
00325     TrapFrame -           Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> trap frame.
00326 
00327     ContextPointers -   Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of context pointers record.
00328 
00329     ContextEM -         Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of a context record.
00330 
00331     ProcessorMode -     Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> processor mode to use when sanitizing
00332                         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d9/d2/festate_8h.html#a2">PSR</a> and FSR.
00333 
00334 Return Value:
00335 
00336     None.
00337 
00338 --*/
00339 
00340 {
00341     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> BsFrameSize;
00342     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a> TempFrameSize;
00343     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> R1Offset, R4Offset;
00344     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> RNatSaveIndex;
00345 
00346     <span class="keywordflow">if</span> ((ContextEM-&gt;ContextFlags &amp; <a class="code" href="../../d6/d7/halmips_8h.html#a153">CONTEXT_CONTROL</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a153">CONTEXT_CONTROL</a>) {
00347 
00348         <span class="keywordflow">if</span> (ContextEM-&gt;IntGp == 0) {
00349             <span class="keywordflow">try</span> {
00350 
00351                 <span class="comment">//</span>
00352                 <span class="comment">// Make sure we have read access to the plabel</span>
00353                 <span class="comment">//</span>
00354 
00355                 <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(ContextEM-&gt;StIIP, 
00356                              <span class="keyword">sizeof</span>(PLABEL_DESCRIPTOR),
00357                              <span class="keyword">sizeof</span>(ULONGLONG));
00358                 ContextEM-&gt;IntGp = ((PPLABEL_DESCRIPTOR)(ContextEM-&gt;StIIP))-&gt;GlobalPointer;
00359                 ContextEM-&gt;StIIP = ((PPLABEL_DESCRIPTOR)(ContextEM-&gt;StIIP))-&gt;EntryPoint;
00360 
00361             } except(EXCEPTION_EXECUTE_HANDLER) {
00362 
00363                 <span class="comment">//</span>
00364                 <span class="comment">// Remote thread does not have access to the plabel. Just</span>
00365                 <span class="comment">// let the thread take the exception.</span>
00366                 <span class="comment">//</span>
00367 
00368                 ;
00369             }
00370         }
00371 
00372         TrapFrame-&gt;IntGp = ContextEM-&gt;IntGp;
00373         TrapFrame-&gt;IntSp = ContextEM-&gt;IntSp;
00374         TrapFrame-&gt;ApUNAT = ContextEM-&gt;ApUNAT;
00375         TrapFrame-&gt;BrRp = ContextEM-&gt;BrRp;
00376         TrapFrame-&gt;ApCCV = ContextEM-&gt;ApCCV;
00377         TrapFrame-&gt;ApDCR = SANITIZE_DCR(ContextEM-&gt;ApDCR, ProcessorMode);
00378 
00379         <span class="comment">//</span>
00380         <span class="comment">// Set preserved applicaton registers.</span>
00381         <span class="comment">//</span>
00382 
00383         *ContextPointers-&gt;ApLC = ContextEM-&gt;ApLC;
00384         *ContextPointers-&gt;ApEC &amp;= ~(PFS_EC_MASK &lt;&lt; PFS_EC_SHIFT);
00385         *ContextPointers-&gt;ApEC |= ((ContextEM-&gt;ApEC &amp; PFS_EC_MASK) &lt;&lt; PFS_EC_SHIFT);
00386 
00387         TrapFrame-&gt;StFPSR = SANITIZE_FSR(ContextEM-&gt;StFPSR, ProcessorMode);
00388         TrapFrame-&gt;StIIP = ContextEM-&gt;StIIP;
00389         TrapFrame-&gt;StIFS = SANITIZE_IFS(ContextEM-&gt;StIFS, ProcessorMode);
00390         TrapFrame-&gt;StIPSR = SANITIZE_PSR(ContextEM-&gt;StIPSR, ProcessorMode);
00391 
00392         <span class="keywordflow">if</span> (((TrapFrame-&gt;StIPSR &gt;&gt; PSR_RI) &amp; 3) == 3) {
00393 
00394             <span class="comment">//</span>
00395             <span class="comment">// 3 is an invalid slot number; sanitize it to zero</span>
00396             <span class="comment">//</span>
00397 
00398             TrapFrame-&gt;StIPSR &amp;= ~(3i64 &lt;&lt; PSR_RI);
00399         }
00400 
00401         TrapFrame-&gt;RsPFS = ContextEM-&gt;RsPFS;
00402 
00403         <span class="keywordflow">if</span> (TRAP_FRAME_TYPE(TrapFrame) == SYSCALL_FRAME) {
00404             <span class="keywordflow">if</span> (TrapFrame-&gt;StIPSR &amp; (1i64 &lt;&lt; PSR_SS)) {
00405 
00406                 <span class="comment">//</span>
00407                 <span class="comment">// if the psr.ss bit is set when the target thread is in a</span>
00408                 <span class="comment">// system call, the psr.lp bit has to be set in order for</span>
00409                 <span class="comment">// the target thread to pick up its setting when it returns</span>
00410                 <span class="comment">// from the system call.  i.e. psr.ss is not saved and</span>
00411                 <span class="comment">// and restored by the EPC system call handler.</span>
00412                 <span class="comment">//</span>
00413 
00414                 TrapFrame-&gt;StIPSR |= (1i64 &lt;&lt; PSR_LP);
00415             }
00416 
00417             <span class="comment">//</span>
00418             <span class="comment">// in the case of EPC system call, the frame size that needs to be</span>
00419             <span class="comment">// adjusted is the local frame size, not the total framze size.</span>
00420             <span class="comment">//</span>
00421 
00422             BsFrameSize = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>) (ContextEM-&gt;StIFS &gt;&gt; PFS_SIZE_SHIFT) &amp; PFS_SIZE_MASK;
00423         } <span class="keywordflow">else</span> {
00424             BsFrameSize = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>) ContextEM-&gt;StIFS &amp; PFS_SIZE_MASK;
00425         }
00426         RNatSaveIndex = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)((ContextEM-&gt;RsBSP &gt;&gt; 3) &amp; NAT_BITS_PER_RNAT_REG);
00427 
00428         TempFrameSize = RNatSaveIndex + BsFrameSize - NAT_BITS_PER_RNAT_REG;
00429         <span class="keywordflow">while</span> (TempFrameSize &gt;= 0) {
00430             BsFrameSize++;
00431             TempFrameSize -= NAT_BITS_PER_RNAT_REG;
00432         }
00433 
00434         TrapFrame-&gt;RsBSPSTORE = ContextEM-&gt;RsBSPSTORE + BsFrameSize * 8;
00435         TrapFrame-&gt;RsBSP = TrapFrame-&gt;RsBSPSTORE;
00436         TrapFrame-&gt;RsRSC = ContextEM-&gt;RsRSC;
00437         TrapFrame-&gt;RsRNAT = ContextEM-&gt;RsRNAT;
00438 
00439 <span class="preprocessor">#ifdef DEBUG</span>
00440 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"PspSetContext CONTROL: TrapFrame-&gt;RsRNAT = 0x%I64x\n"</span>,
00441                 TrapFrame-&gt;RsRNAT);
00442 <span class="preprocessor">#endif</span>
00443 <span class="preprocessor"></span>
00444         <span class="comment">//</span>
00445         <span class="comment">// DebugActive controls h/w debug registers. Set if new psr.db = 1</span>
00446         <span class="comment">//</span>
00447 
00448         <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>()-&gt;DebugActive = ((TrapFrame-&gt;StIPSR &amp; (1I64 &lt;&lt; PSR_DB)) != 0);
00449 
00450         <span class="comment">//</span>
00451         <span class="comment">// Set iA status</span>
00452         <span class="comment">// *** TBD SANATIZE??</span>
00453         <span class="comment">//</span>
00454 
00455         *ContextPointers-&gt;StFSR = ContextEM-&gt;StFSR;
00456         *ContextPointers-&gt;StFIR = ContextEM-&gt;StFIR;
00457         *ContextPointers-&gt;StFDR = ContextEM-&gt;StFDR;
00458         *ContextPointers-&gt;Cflag = ContextEM-&gt;Cflag;
00459 
00460     }
00461 
00462     <span class="keywordflow">if</span> ((ContextEM-&gt;ContextFlags &amp; <a class="code" href="../../d6/d7/halmips_8h.html#a155">CONTEXT_INTEGER</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a155">CONTEXT_INTEGER</a>) {
00463 
00464         TrapFrame-&gt;IntT0 = ContextEM-&gt;IntT0;
00465         TrapFrame-&gt;IntT1 = ContextEM-&gt;IntT1;
00466         TrapFrame-&gt;IntT2 = ContextEM-&gt;IntT2;
00467         TrapFrame-&gt;IntT3 = ContextEM-&gt;IntT3;
00468         TrapFrame-&gt;IntT4 = ContextEM-&gt;IntT4;
00469         TrapFrame-&gt;IntV0 = ContextEM-&gt;IntV0;
00470         TrapFrame-&gt;IntTeb = ContextEM-&gt;IntTeb;
00471         TrapFrame-&gt;Preds = ContextEM-&gt;Preds;
00472 
00473         <span class="comment">//</span>
00474         <span class="comment">//  t5 - t2</span>
00475         <span class="comment">//</span>
00476 
00477         RtlCopyMemory(&amp;TrapFrame-&gt;IntT5, &amp;ContextEM-&gt;IntT5, 18*<span class="keyword">sizeof</span>(ULONGLONG));
00478 
00479         <span class="comment">//</span>
00480         <span class="comment">// Set the integer nats fields</span>
00481         <span class="comment">//</span>
00482 
00483         R1Offset = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)((ULONG_PTR)(&amp;TrapFrame-&gt;IntGp) &gt;&gt; 3) &amp; 0x3f;
00484 
00485         <a class="code" href="../../d1/d6/ke_2ia64_2context_8c.html#a1">EXTRACT_NATS</a>(TrapFrame-&gt;IntNats, ContextEM-&gt;IntNats,
00486                      1, R1Offset, 0xFFFFFF0E);
00487 
00488         <span class="comment">//</span>
00489         <span class="comment">// Set the preserved integer NAT fields</span>
00490         <span class="comment">//</span>
00491 
00492         R4Offset = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)((ULONG_PTR)(ContextPointers-&gt;IntS0) &gt;&gt; 3) &amp; 0x3f;
00493 
00494         <span class="comment">//</span>
00495         <span class="comment">// BUGBUG: TBD</span>
00496         <span class="comment">//</span>
00497         <span class="comment">// EXTRACT_NATS(*ContextPointers-&gt;IntNats, ContextEM-&gt;IntNats,</span>
00498         <span class="comment">//           4, R4Offset, 0xF0);</span>
00499 
00500         *ContextPointers-&gt;IntS0 = ContextEM-&gt;IntS0;
00501         *ContextPointers-&gt;IntS1 = ContextEM-&gt;IntS1;
00502         *ContextPointers-&gt;IntS2 = ContextEM-&gt;IntS2;
00503         *ContextPointers-&gt;IntS3 = ContextEM-&gt;IntS3;
00504 
00505         *ContextPointers-&gt;IntS0Nat &amp;= ~(0x1 &lt;&lt; (((ULONG_PTR)ContextPointers-&gt;IntS0 &amp; 0x1F8) &gt;&gt; 3));
00506         *ContextPointers-&gt;IntS1Nat &amp;= ~(0x1 &lt;&lt; (((ULONG_PTR)ContextPointers-&gt;IntS1 &amp; 0x1F8) &gt;&gt; 3));
00507         *ContextPointers-&gt;IntS2Nat &amp;= ~(0x1 &lt;&lt; (((ULONG_PTR)ContextPointers-&gt;IntS2 &amp; 0x1F8) &gt;&gt; 3));
00508         *ContextPointers-&gt;IntS3Nat &amp;= ~(0x1 &lt;&lt; (((ULONG_PTR)ContextPointers-&gt;IntS3 &amp; 0x1F8) &gt;&gt; 3));
00509 
00510         *ContextPointers-&gt;IntS0Nat |= (((ContextEM-&gt;IntNats &gt;&gt; 4) &amp; 0x1) &lt;&lt; (((ULONG_PTR)ContextPointers-&gt;IntS0 &amp; 0x1F8) &gt;&gt; 3));
00511         *ContextPointers-&gt;IntS1Nat |= (((ContextEM-&gt;IntNats &gt;&gt; 4) &amp; 0x1) &lt;&lt; (((ULONG_PTR)ContextPointers-&gt;IntS1 &amp; 0x1F8) &gt;&gt; 3));
00512         *ContextPointers-&gt;IntS2Nat |= (((ContextEM-&gt;IntNats &gt;&gt; 4) &amp; 0x1) &lt;&lt; (((ULONG_PTR)ContextPointers-&gt;IntS2 &amp; 0x1F8) &gt;&gt; 3));
00513         *ContextPointers-&gt;IntS3Nat |= (((ContextEM-&gt;IntNats &gt;&gt; 4) &amp; 0x1) &lt;&lt; (((ULONG_PTR)ContextPointers-&gt;IntS3 &amp; 0x1F8) &gt;&gt; 3));
00514 
00515 <span class="preprocessor">#ifdef DEBUG</span>
00516 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"PspSetContext INTEGER: R1Offset = 0x%x, TF-&gt;IntNats = 0x%I64x, Context-&gt;IntNats = 0x%I64x\n"</span>,
00517                R1Offset, TrapFrame-&gt;IntNats, ContextEM-&gt;IntNats);
00518 <span class="preprocessor">#endif</span>
00519 <span class="preprocessor"></span>
00520         *ContextPointers-&gt;BrS0 = ContextEM-&gt;BrS0;
00521         *ContextPointers-&gt;BrS1 = ContextEM-&gt;BrS1;
00522         *ContextPointers-&gt;BrS2 = ContextEM-&gt;BrS2;
00523         *ContextPointers-&gt;BrS3 = ContextEM-&gt;BrS3;
00524         *ContextPointers-&gt;BrS4 = ContextEM-&gt;BrS4;
00525         TrapFrame-&gt;BrT0 = ContextEM-&gt;BrT0;
00526         TrapFrame-&gt;BrT1 = ContextEM-&gt;BrT1;
00527     }
00528 
00529     <span class="keywordflow">if</span> ((ContextEM-&gt;ContextFlags &amp; CONTEXT_LOWER_FLOATING_POINT) == CONTEXT_LOWER_FLOATING_POINT) {
00530 
00531         TrapFrame-&gt;StFPSR = SANITIZE_FSR(ContextEM-&gt;StFPSR, ProcessorMode);
00532         *ContextPointers-&gt;StFSR = ContextEM-&gt;StFSR;
00533         *ContextPointers-&gt;StFIR = ContextEM-&gt;StFIR;
00534         *ContextPointers-&gt;StFDR = ContextEM-&gt;StFDR;
00535 
00536         <span class="comment">//</span>
00537         <span class="comment">// Set floating registers fs0 - fs19.</span>
00538         <span class="comment">//</span>
00539 
00540         *ContextPointers-&gt;FltS0 = ContextEM-&gt;FltS0;
00541         *ContextPointers-&gt;FltS1 = ContextEM-&gt;FltS1;
00542         *ContextPointers-&gt;FltS2 = ContextEM-&gt;FltS2;
00543         *ContextPointers-&gt;FltS3 = ContextEM-&gt;FltS3;
00544 
00545         *ContextPointers-&gt;FltS4 = ContextEM-&gt;FltS4;
00546         *ContextPointers-&gt;FltS5 = ContextEM-&gt;FltS5;
00547         *ContextPointers-&gt;FltS6 = ContextEM-&gt;FltS6;
00548         *ContextPointers-&gt;FltS7 = ContextEM-&gt;FltS7;
00549 
00550         *ContextPointers-&gt;FltS8 = ContextEM-&gt;FltS8;
00551         *ContextPointers-&gt;FltS9 = ContextEM-&gt;FltS9;
00552         *ContextPointers-&gt;FltS10 = ContextEM-&gt;FltS10;
00553         *ContextPointers-&gt;FltS11 = ContextEM-&gt;FltS11;
00554 
00555         *ContextPointers-&gt;FltS12 = ContextEM-&gt;FltS12;
00556         *ContextPointers-&gt;FltS13 = ContextEM-&gt;FltS13;
00557         *ContextPointers-&gt;FltS14 = ContextEM-&gt;FltS14;
00558         *ContextPointers-&gt;FltS15 = ContextEM-&gt;FltS15;
00559 
00560         *ContextPointers-&gt;FltS16 = ContextEM-&gt;FltS16;
00561         *ContextPointers-&gt;FltS17 = ContextEM-&gt;FltS17;
00562         *ContextPointers-&gt;FltS18 = ContextEM-&gt;FltS18;
00563         *ContextPointers-&gt;FltS19 = ContextEM-&gt;FltS19;
00564 
00565         <span class="comment">//</span>
00566         <span class="comment">// Set floating registers ft0 - ft9.</span>
00567         <span class="comment">//</span>
00568 
00569         RtlCopyIa64FloatRegisterContext(&amp;TrapFrame-&gt;FltT0, 
00570                                         &amp;ContextEM-&gt;FltT0,
00571                                         <span class="keyword">sizeof</span>(FLOAT128) * (10));
00572     }
00573 
00574     <span class="keywordflow">if</span> ((ContextEM-&gt;ContextFlags &amp; CONTEXT_HIGHER_FLOATING_POINT) == CONTEXT_HIGHER_FLOATING_POINT) {
00575 
00576 
00577         TrapFrame-&gt;StFPSR = SANITIZE_FSR(ContextEM-&gt;StFPSR, ProcessorMode);
00578         *ContextPointers-&gt;StFSR = ContextEM-&gt;StFSR;
00579         *ContextPointers-&gt;StFIR = ContextEM-&gt;StFIR;
00580         *ContextPointers-&gt;StFDR = ContextEM-&gt;StFDR;
00581 
00582         <span class="keywordflow">if</span> (ProcessorMode == <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>) {
00583 
00584             <span class="comment">//</span>
00585             <span class="comment">// Update the higher floating point save area (f32-f127) and </span>
00586             <span class="comment">// set the corresponding modified bit in the PSR to 1.</span>
00587             <span class="comment">//</span>
00588 
00589             RtlCopyIa64FloatRegisterContext(
00590                 (PFLOAT128)GET_HIGH_FLOATING_POINT_REGISTER_SAVEAREA(),
00591                 &amp;ContextEM-&gt;FltF32,
00592                 96*<span class="keyword">sizeof</span>(FLOAT128));
00593 
00594             <span class="comment">//</span>
00595             <span class="comment">// set the dfh bit to force a reload of the high fp register</span>
00596             <span class="comment">// set on the next user access</span>
00597             <span class="comment">//</span>
00598 
00599             TrapFrame-&gt;StIPSR |= (1i64 &lt;&lt; PSR_DFH);
00600         }
00601 
00602     }
00603 
00604     <span class="comment">//</span>
00605     <span class="comment">// Set debug register contents if specified.</span>
00606     <span class="comment">//</span>
00607 
00608     <span class="keywordflow">if</span> ((ContextEM-&gt;ContextFlags &amp; CONTEXT_DEBUG) == CONTEXT_DEBUG) {
00609         <a class="code" href="../../d5/d0/psctxi64_8c.html#a3">KiSetDebugContext</a> (TrapFrame, ContextEM, ProcessorMode);
00610     }
00611 
00612     <span class="keywordflow">return</span>;
00613 }

</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:45:22 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
