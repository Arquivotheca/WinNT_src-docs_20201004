<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: mmfault.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>mmfault.c</h1><a href="../../d4/d1/mmfault_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">   mmfault.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module contains the handlers for access check, page faults</span>
00012 <span class="comment">    and write faults.</span>
00013 <span class="comment"></span>
00014 <span class="comment">Author:</span>
00015 <span class="comment"></span>
00016 <span class="comment">    Lou Perazzoli (loup) 6-Apr-1989</span>
00017 <span class="comment">    Landy Wang (landyw) 02-June-1997</span>
00018 <span class="comment"></span>
00019 <span class="comment">Revision History:</span>
00020 <span class="comment"></span>
00021 <span class="comment">--*/</span>
00022 
00023 <span class="preprocessor">#include "<a class="code" href="../../d4/d8/mi_8h.html">mi.h</a>"</span>
00024 
<a name="l00025"></a><a class="code" href="../../d4/d1/mmfault_8c.html#a0">00025</a> <span class="preprocessor">#define PROCESS_FOREGROUND_PRIORITY (9)</span>
00026 <span class="preprocessor"></span>
<a name="l00027"></a><a class="code" href="../../d4/d1/mmfault_8c.html#a1">00027</a> ULONG <a class="code" href="../../d4/d8/mi_8h.html#a598">MiDelayPageFaults</a>;
00028 
00029 <span class="preprocessor">#if DBG</span>
00030 <span class="preprocessor"></span>ULONG MmProtoPteVadLookups = 0;
00031 ULONG MmProtoPteDirect = 0;
00032 ULONG MmAutoEvaluate = 0;
00033 
00034 <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> MmPteHit = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00035 
00036 ULONG MmLargePageFaultError;
00037 <span class="preprocessor">#endif</span>
00038 <span class="preprocessor"></span>
00039 
00040 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00041"></a><a class="code" href="../../d4/d1/mmfault_8c.html#a2">00041</a> <a class="code" href="../../d4/d1/mmfault_8c.html#a2">MmAccessFault</a> (
00042     IN BOOLEAN StoreInstruction,
00043     IN PVOID VirtualAddress,
00044     IN KPROCESSOR_MODE PreviousMode,
00045     IN PVOID TrapInformation
00046     )
00047 
00048 <span class="comment">/*++</span>
00049 <span class="comment"></span>
00050 <span class="comment">Routine Description:</span>
00051 <span class="comment"></span>
00052 <span class="comment">    This function is called by the kernel on data or instruction</span>
00053 <span class="comment">    access faults.  The access fault was detected due to either</span>
00054 <span class="comment">    an access violation, a PTE with the present bit clear, or a</span>
00055 <span class="comment">    valid PTE with the dirty bit clear and a write operation.</span>
00056 <span class="comment"></span>
00057 <span class="comment">    Also note that the access violation and the page fault could</span>
00058 <span class="comment">    occur because of the Page Directory Entry contents as well.</span>
00059 <span class="comment"></span>
00060 <span class="comment">    This routine determines what type of fault it is and calls</span>
00061 <span class="comment">    the appropriate routine to handle the page fault or the write</span>
00062 <span class="comment">    fault.</span>
00063 <span class="comment"></span>
00064 <span class="comment">Arguments:</span>
00065 <span class="comment"></span>
00066 <span class="comment">    StoreInstruction - Supplies TRUE (1) if the operation causes a write into</span>
00067 <span class="comment">                       memory.  Note this value must be 1 or 0.</span>
00068 <span class="comment"></span>
00069 <span class="comment">    VirtualAddress - Supplies the virtual address which caused the fault.</span>
00070 <span class="comment"></span>
00071 <span class="comment">    PreviousMode - Supplies the mode (kernel or user) in which the fault</span>
00072 <span class="comment">                   occurred.</span>
00073 <span class="comment"></span>
00074 <span class="comment">    TrapInformation - Opaque information about the trap, interpreted by the</span>
00075 <span class="comment">                      kernel, not Mm.  Needed to allow fast interlocked access</span>
00076 <span class="comment">                      to operate correctly.</span>
00077 <span class="comment"></span>
00078 <span class="comment">Return Value:</span>
00079 <span class="comment"></span>
00080 <span class="comment">    Returns the status of the fault handling operation.  Can be one of:</span>
00081 <span class="comment">        - Success.</span>
00082 <span class="comment">        - Access Violation.</span>
00083 <span class="comment">        - Guard Page Violation.</span>
00084 <span class="comment">        - In-page Error.</span>
00085 <span class="comment"></span>
00086 <span class="comment">Environment:</span>
00087 <span class="comment"></span>
00088 <span class="comment">    Kernel mode, APCs disabled.</span>
00089 <span class="comment"></span>
00090 <span class="comment">--*/</span>
00091 
00092 {
00093     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPpe;
00094     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPde;
00095     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
00096     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerProtoPte;
00097     ULONG ProtectionCode;
00098     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
00099     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> CurrentProcess;
00100     KIRQL PreviousIrql;
00101     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00102     ULONG ProtectCode;
00103     PFN_NUMBER PageFrameIndex;
00104     <a class="code" href="../../d4/d8/mi_8h.html#a435">WSLE_NUMBER</a> WorkingSetIndex;
00105     KIRQL OldIrql;
00106     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
00107     <a class="code" href="../../d2/d1/mm_8h.html#a163">PPAGE_FAULT_NOTIFY_ROUTINE</a> NotifyRoutine;
00108     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> SessionStatus;
00109     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> FaultProcess;
00110     <a class="code" href="../../d3/d6/struct__MMSUPPORT.html">PMMSUPPORT</a> Ws;
00111     BOOLEAN SessionAddress;
00112     PVOID UsedPageTableHandle;
00113     ULONG BarrierStamp;
00114     LOGICAL ApcNeeded;
00115 
00116 <span class="preprocessor">#if defined(_IA64_)</span>
00117 <span class="preprocessor"></span>    LOGICAL ExecutionFault = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00118 
00119     <span class="comment">//</span>
00120     <span class="comment">// If StoreInstruction indicates it was an execution fault, set</span>
00121     <span class="comment">// ExecutionFault TRUE and StoreInstruction FALSE.</span>
00122     <span class="comment">//</span>
00123 
00124     <span class="keywordflow">if</span> (StoreInstruction == 2) {
00125         ExecutionFault = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00126         StoreInstruction = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00127     }
00128 <span class="preprocessor">#endif</span>
00129 <span class="preprocessor"></span>
00130     PointerProtoPte = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00131 
00132 <span class="preprocessor">#if defined (_WIN64)</span>
00133 <span class="preprocessor"></span>
00134     <span class="comment">//</span>
00135     <span class="comment">// Perform address sanity checks.</span>
00136     <span class="comment">//</span>
00137 
00138     <span class="keywordflow">if</span> (PreviousMode == <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>) {
00139 
00140         <span class="keywordflow">if</span> (VirtualAddress &gt;= MM_HIGHEST_USER_ADDRESS) {
00141             <span class="keywordflow">return</span> STATUS_ACCESS_VIOLATION;
00142         }
00143 
00144     } <span class="keywordflow">else</span> {
00145 
00146         <span class="keywordflow">if</span> (!((VirtualAddress &lt;= (PVOID)((ULONG_PTR)MM_HIGHEST_USER_ADDRESS + 1)) ||
00147 
00148 <span class="preprocessor">#if defined (_IA64_)</span>
00149 <span class="preprocessor"></span>
00150             <span class="comment">//</span>
00151             <span class="comment">// Page table pages are in the user region space for IA64.</span>
00152             <span class="comment">//</span>
00153 
00154             (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a190">MI_IS_PAGE_TABLE_ADDRESS</a>(VirtualAddress)) ||
00155             (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a193">MI_IS_HYPER_SPACE_ADDRESS</a>(VirtualAddress)) ||
00156             (<a class="code" href="../../d4/d8/mi_8h.html#a354">MI_IS_SESSION_ADDRESS</a>(VirtualAddress)) ||
00157 <span class="preprocessor">#endif</span>
00158 <span class="preprocessor"></span>
00159             ((VirtualAddress &gt;= MM_SYSTEM_RANGE_START) &amp;&amp;
00160             (VirtualAddress &lt; (PVOID)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a25">MM_SYSTEM_SPACE_END</a>)))) {
00161 
00162             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/ke_8h.html#a373">KeInvalidAccessAllowed</a>(TrapInformation) == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00163                 <span class="keywordflow">return</span> STATUS_ACCESS_VIOLATION;
00164             }
00165 
00166             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (MEMORY_MANAGEMENT,
00167                           (ULONG_PTR) VirtualAddress,
00168                           StoreInstruction,
00169                           PreviousMode,
00170                           0xdead);
00171         }
00172     }
00173 
00174 <span class="preprocessor">#endif</span>
00175 <span class="preprocessor"></span>
00176     <span class="comment">//</span>
00177     <span class="comment">// Block APCs and acquire the working set mutex.  This prevents any</span>
00178     <span class="comment">// changes to the address space and it prevents valid PTEs from becoming</span>
00179     <span class="comment">// invalid.</span>
00180     <span class="comment">//</span>
00181 
00182     CurrentProcess = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a> ();
00183 
00184 <span class="preprocessor">#if DBG</span>
00185 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a82">MM_DBG_SHOW_FAULTS</a>) {
00186 
00187         <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> CurThread;
00188 
00189         CurThread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
00190         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"MM:**access fault - va %p process %p thread %p\n"</span>,
00191                  VirtualAddress, CurrentProcess, CurThread);
00192     }
00193 <span class="preprocessor">#endif //DBG</span>
00194 <span class="preprocessor"></span>
00195     PreviousIrql = KeGetCurrentIrql ();
00196 
00197     <span class="comment">//</span>
00198     <span class="comment">// Get the pointer to the PDE and the PTE for this page.</span>
00199     <span class="comment">//</span>
00200 
00201     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (VirtualAddress);
00202     PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (VirtualAddress);
00203     PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a150">MiGetPpeAddress</a> (VirtualAddress);
00204 
00205 <span class="preprocessor">#if PFN_CONSISTENCY</span>
00206 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (PointerPte &gt;= MiPfnStartPte &amp;&amp; PointerPte &lt; MiPfnStartPte + MiPfnPtes) {
00207         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"MM: Unsynchronized access to the PFN database - va %p process %p\n"</span>,
00208                  VirtualAddress, CurrentProcess);
00209 
00210         <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>, &amp;OldIrql);
00211         MiMapInPfnDatabase();
00212         MiPfnProtectionEnabled = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00213         <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a> (OldIrql);
00214 
00215         DbgBreakPoint();
00216     }
00217 <span class="preprocessor">#endif</span>
00218 <span class="preprocessor"></span>
00219 <span class="preprocessor">#if DBG</span>
00220 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (PointerPte == MmPteHit) {
00221         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"MM:pte hit at %p\n"</span>, MmPteHit);
00222         DbgBreakPoint();
00223     }
00224 <span class="preprocessor">#endif</span>
00225 <span class="preprocessor"></span>
00226     ApcNeeded = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00227 
00228     <span class="keywordflow">if</span> (PreviousIrql &gt; <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>) {
00229 
00230         <span class="comment">//</span>
00231         <span class="comment">// The PFN database lock is an executive spin-lock.  The pager could</span>
00232         <span class="comment">// get dirty faults or lock faults while servicing and it already owns</span>
00233         <span class="comment">// the PFN database lock.</span>
00234         <span class="comment">//</span>
00235 
00236 <span class="preprocessor">#if !defined (_WIN64)</span>
00237 <span class="preprocessor"></span>        <a class="code" href="../../d8/d2/pagfault_8c.html#a20">MiCheckPdeForPagedPool</a> (VirtualAddress);
00238 <span class="preprocessor">#endif</span>
00239 <span class="preprocessor"></span>
00240 <span class="preprocessor">#ifdef _X86_</span>
00241 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1) {
00242             <span class="keywordflow">if</span> (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.LargePage == 1) {
00243 <span class="preprocessor">#if DBG</span>
00244 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (MmLargePageFaultError &lt; 10) {
00245                     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"MM - fault on Large page %p\n"</span>, VirtualAddress);
00246                 }
00247                 MmLargePageFaultError += 1;
00248 <span class="preprocessor">#endif //DBG</span>
00249 <span class="preprocessor"></span>                <span class="keywordflow">return</span> STATUS_SUCCESS;
00250             }
00251         }
00252 <span class="preprocessor">#endif //X86</span>
00253 <span class="preprocessor"></span>
00254         <span class="keywordflow">if</span> (
00255 <span class="preprocessor">#if defined (_WIN64)</span>
00256 <span class="preprocessor"></span>            (PointerPpe-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) ||
00257 <span class="preprocessor">#endif</span>
00258 <span class="preprocessor"></span>            (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) ||
00259             (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0)) {
00260 
00261             KdPrint((<span class="stringliteral">"MM:***PAGE FAULT AT IRQL &gt; 1  Va %p, IRQL %lx\n"</span>,
00262                      VirtualAddress,
00263                      PreviousIrql));
00264 
00265             <span class="comment">//</span>
00266             <span class="comment">// use reserved bit to signal fatal error to trap handlers</span>
00267             <span class="comment">//</span>
00268 
00269             <span class="keywordflow">return</span> STATUS_IN_PAGE_ERROR | 0x10000000;
00270 
00271         }
00272 
00273         <span class="keywordflow">if</span> (StoreInstruction &amp;&amp; (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.CopyOnWrite != 0)) {
00274             KdPrint((<span class="stringliteral">"MM:***PAGE FAULT AT IRQL &gt; 1  Va %p, IRQL %lx\n"</span>,
00275                      VirtualAddress,
00276                      PreviousIrql));
00277 
00278             <span class="comment">//</span>
00279             <span class="comment">// use reserved bit to signal fatal error to trap handlers</span>
00280             <span class="comment">//</span>
00281 
00282             <span class="keywordflow">return</span> STATUS_IN_PAGE_ERROR | 0x10000000;
00283         }
00284 
00285         <span class="comment">//</span>
00286         <span class="comment">// The PTE is valid and accessible, another thread must</span>
00287         <span class="comment">// have faulted the PTE in already, or the access bit</span>
00288         <span class="comment">// is clear and this is a access fault; Blindly set the</span>
00289         <span class="comment">// access bit and dismiss the fault.</span>
00290         <span class="comment">//</span>
00291 <span class="preprocessor">#if DBG</span>
00292 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a82">MM_DBG_SHOW_FAULTS</a>) {
00293             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"MM:no fault found - pte is %p\n"</span>, PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long);
00294         }
00295 <span class="preprocessor">#endif //DBG</span>
00296 <span class="preprocessor"></span>
00297         <span class="keywordflow">if</span> (StoreInstruction) {
00298 
00299             Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber);
00300 
00301             <span class="keywordflow">if</span> (((PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long &amp; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a77">MM_PTE_WRITE_MASK</a>) == 0) &amp;&amp;
00302                 ((Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection &amp; <a class="code" href="../../d4/d8/mi_8h.html#a39">MM_READWRITE</a>) == 0)) {
00303                 
00304                 <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (ATTEMPTED_WRITE_TO_READONLY_MEMORY,
00305                               (ULONG_PTR)VirtualAddress,
00306                               (ULONG_PTR)PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long,
00307                               (ULONG_PTR)TrapInformation,
00308                               10);
00309             }
00310         }
00311 
00312         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a176">MI_NO_FAULT_FOUND</a> (TempPte, PointerPte, VirtualAddress, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00313         <span class="keywordflow">return</span> STATUS_SUCCESS;
00314     }
00315 
00316     <span class="keywordflow">if</span> (VirtualAddress &gt;= <a class="code" href="../../d0/d9/miglobal_8c.html#a1">MmSystemRangeStart</a>) {
00317 
00318         <span class="comment">//</span>
00319         <span class="comment">// This is a fault in the system address space.  User</span>
00320         <span class="comment">// mode access is not allowed.</span>
00321         <span class="comment">//</span>
00322 
00323         <span class="keywordflow">if</span> (PreviousMode == <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>) {
00324             <span class="keywordflow">return</span> STATUS_ACCESS_VIOLATION;
00325         }
00326 
00327 <span class="preprocessor">#if defined (_WIN64)</span>
00328 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (PointerPpe-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) {
00329 
00330             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/ke_8h.html#a373">KeInvalidAccessAllowed</a>(TrapInformation) == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00331                 <span class="keywordflow">return</span> STATUS_ACCESS_VIOLATION;
00332             }
00333 
00334             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (PAGE_FAULT_IN_NONPAGED_AREA,
00335                           (ULONG_PTR)VirtualAddress,
00336                           StoreInstruction,
00337                           (ULONG_PTR)TrapInformation,
00338                           5);
00339         }
00340 <span class="preprocessor">#endif</span>
00341 <span class="preprocessor"></span>
00342 RecheckPde:
00343 
00344         <span class="keywordflow">if</span> (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1) {
00345 <span class="preprocessor">#ifdef _X86_</span>
00346 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.LargePage == 1) {
00347 <span class="preprocessor">#if DBG</span>
00348 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (MmLargePageFaultError &lt; 10) {
00349                     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"MM - fault on Large page %p\n"</span>,VirtualAddress);
00350                 }
00351                 MmLargePageFaultError += 1;
00352 <span class="preprocessor">#endif //DBG</span>
00353 <span class="preprocessor"></span>                <span class="keywordflow">return</span> STATUS_SUCCESS;
00354             }
00355 <span class="preprocessor">#endif //X86</span>
00356 <span class="preprocessor"></span>
00357             <span class="keywordflow">if</span> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1) {
00358 
00359                 <span class="comment">//</span>
00360                 <span class="comment">// Session space faults cannot early exit here because</span>
00361                 <span class="comment">// it may be a copy on write which must be checked for</span>
00362                 <span class="comment">// and handled below.</span>
00363                 <span class="comment">//</span>
00364 
00365                 <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a354">MI_IS_SESSION_ADDRESS</a> (VirtualAddress) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00366 
00367                     <span class="comment">//</span>
00368                     <span class="comment">// Acquire the PFN lock, check to see if the address is</span>
00369                     <span class="comment">// still valid if writable, update dirty bit.</span>
00370                     <span class="comment">//</span>
00371 
00372                     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00373                     TempPte = *(<span class="keyword">volatile</span> <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> *)PointerPte;
00374                     <span class="keywordflow">if</span> (TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1) {
00375 
00376                         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber);
00377     
00378                         <span class="keywordflow">if</span> ((StoreInstruction) &amp;&amp;
00379                             ((TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long &amp; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a77">MM_PTE_WRITE_MASK</a>) == 0) &amp;&amp;
00380                             ((Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection &amp; <a class="code" href="../../d4/d8/mi_8h.html#a39">MM_READWRITE</a>) == 0)) {
00381                 
00382                             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (ATTEMPTED_WRITE_TO_READONLY_MEMORY,
00383                                           (ULONG_PTR)VirtualAddress,
00384                                           (ULONG_PTR)TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long,
00385                                           (ULONG_PTR)TrapInformation,
00386                                           11);
00387                         }
00388                         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a176">MI_NO_FAULT_FOUND</a> (TempPte, PointerPte, VirtualAddress, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00389                     }
00390                     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00391                     <span class="keywordflow">return</span> STATUS_SUCCESS;
00392                 }
00393             }
00394 <span class="preprocessor">#if !defined (_WIN64)</span>
00395 <span class="preprocessor"></span>            <span class="keywordflow">else</span> {
00396 
00397                 <span class="comment">//</span>
00398                 <span class="comment">// Handle trimmer references to paged pool PTEs where the PDE</span>
00399                 <span class="comment">// might not be present.  Only needed for</span>
00400                 <span class="comment">// MmTrimAllSystemPagable memory.</span>
00401                 <span class="comment">//</span>
00402 
00403                 <a class="code" href="../../d8/d2/pagfault_8c.html#a20">MiCheckPdeForPagedPool</a> (VirtualAddress);
00404                 TempPte = *(<span class="keyword">volatile</span> <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> *)PointerPte;
00405                 <span class="keywordflow">if</span> (TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1) {
00406                     <span class="keywordflow">return</span> STATUS_SUCCESS;
00407                 }
00408             }
00409 <span class="preprocessor">#endif</span>
00410 <span class="preprocessor"></span>        } <span class="keywordflow">else</span> {
00411 
00412             <span class="comment">//</span>
00413             <span class="comment">// Due to G-bits in kernel mode code, accesses to paged pool</span>
00414             <span class="comment">// PDEs may not fault even though the PDE is not valid.  Make</span>
00415             <span class="comment">// sure the PDE is valid so PteFrames in the PFN database are</span>
00416             <span class="comment">// tracked properly.</span>
00417             <span class="comment">//</span>
00418 
00419 <span class="preprocessor">#if defined (_WIN64)</span>
00420 <span class="preprocessor"></span>            <span class="keywordflow">if</span> ((VirtualAddress &gt;= (PVOID)PTE_BASE) &amp;&amp; (VirtualAddress &lt; (PVOID)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a63">HYPER_SPACE</a>))) {
00421                 <span class="comment">//</span>
00422                 <span class="comment">// This is a user mode PDE entry being faulted in by the Mm</span>
00423                 <span class="comment">// referencing the page table page.  This needs to be done</span>
00424                 <span class="comment">// with the working set lock so that the PPE validity can be</span>
00425                 <span class="comment">// relied on throughout the fault processing.</span>
00426                 <span class="comment">//</span>
00427                 <span class="comment">// The case when Mm faults in PPE entries by referencing the</span>
00428                 <span class="comment">// page directory page is correctly handled by falling through</span>
00429                 <span class="comment">// the below code.</span>
00430                 <span class="comment">//</span>
00431     
00432                 <span class="keywordflow">goto</span> UserFault;
00433             }
00434 <span class="preprocessor">#else</span>
00435 <span class="preprocessor"></span>            <a class="code" href="../../d8/d2/pagfault_8c.html#a20">MiCheckPdeForPagedPool</a> (VirtualAddress);
00436 <span class="preprocessor">#endif</span>
00437 <span class="preprocessor"></span>
00438             <span class="keywordflow">if</span> (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) {
00439                 <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/ke_8h.html#a373">KeInvalidAccessAllowed</a>(TrapInformation) == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00440                     <span class="keywordflow">return</span> STATUS_ACCESS_VIOLATION;
00441                 }
00442                 <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (PAGE_FAULT_IN_NONPAGED_AREA,
00443                               (ULONG_PTR)VirtualAddress,
00444                               StoreInstruction,
00445                               (ULONG_PTR)TrapInformation,
00446                               2);
00447                 <span class="keywordflow">return</span> STATUS_SUCCESS;
00448             }
00449 
00450             <span class="comment">//</span>
00451             <span class="comment">// Now that the PDE is valid, go look at the PTE again.</span>
00452             <span class="comment">//</span>
00453 
00454             <span class="keywordflow">goto</span> RecheckPde;
00455         }
00456 
00457         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a581">MiHydra</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00458 
00459 <span class="preprocessor">#if !defined (_WIN64)</span>
00460 <span class="preprocessor"></span>
00461             <span class="comment">//</span>
00462             <span class="comment">// First check to see if it's in the session space data</span>
00463             <span class="comment">// structures or page table pages.</span>
00464             <span class="comment">//</span>
00465 
00466             SessionStatus = <a class="code" href="../../d8/d2/pagfault_8c.html#a21">MiCheckPdeForSessionSpace</a> (VirtualAddress);
00467 
00468             <span class="keywordflow">if</span> (SessionStatus == STATUS_ACCESS_VIOLATION) {
00469 
00470                 <span class="comment">//</span>
00471                 <span class="comment">// This thread faulted on a session space access, but this</span>
00472                 <span class="comment">// process does not have one.  This could be the system</span>
00473                 <span class="comment">// process attempting to access a working buffer passed</span>
00474                 <span class="comment">// to it from WIN32K or a driver loaded in session space</span>
00475                 <span class="comment">// (video, printer, etc).</span>
00476                 <span class="comment">//</span>
00477                 <span class="comment">// The system process which contains the worker threads</span>
00478                 <span class="comment">// NEVER has a session space - if code accidentally queues a</span>
00479                 <span class="comment">// worker thread that points to a session space buffer, a</span>
00480                 <span class="comment">// fault will occur.  This must be bug checked since drivers</span>
00481                 <span class="comment">// are responsible for making sure this never occurs.</span>
00482                 <span class="comment">//</span>
00483                 <span class="comment">// The only exception to this is when the working set manager</span>
00484                 <span class="comment">// attaches to a session to age or trim it.  However, the</span>
00485                 <span class="comment">// working set manager will never fault and so the bugcheck</span>
00486                 <span class="comment">// below is always valid.  Note that a worker thread can get</span>
00487                 <span class="comment">// away with a bad access if it happens while the working set</span>
00488                 <span class="comment">// manager is attached, but there's really no way to prevent</span>
00489                 <span class="comment">// this case which is a driver bug anyway.</span>
00490                 <span class="comment">//</span>
00491 
00492                 <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/ke_8h.html#a373">KeInvalidAccessAllowed</a>(TrapInformation) == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00493                     <span class="keywordflow">return</span> STATUS_ACCESS_VIOLATION;
00494                 }
00495 
00496                 <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (PAGE_FAULT_IN_NONPAGED_AREA,
00497                               (ULONG_PTR)VirtualAddress,
00498                               StoreInstruction,
00499                               (ULONG_PTR)TrapInformation,
00500                               6);
00501             }
00502 
00503 <span class="preprocessor">#endif</span>
00504 <span class="preprocessor"></span>
00505             <span class="comment">//</span>
00506             <span class="comment">// Fall though to further fault handling.</span>
00507             <span class="comment">//</span>
00508 
00509             SessionAddress = <a class="code" href="../../d4/d8/mi_8h.html#a354">MI_IS_SESSION_ADDRESS</a> (VirtualAddress);
00510         }
00511         <span class="keywordflow">else</span> {
00512             SessionAddress = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00513         }
00514 
00515         <span class="keywordflow">if</span> (SessionAddress == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> ||
00516             ((!<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a190">MI_IS_PAGE_TABLE_ADDRESS</a>(VirtualAddress)) &amp;&amp;
00517              (!<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a193">MI_IS_HYPER_SPACE_ADDRESS</a>(VirtualAddress)))) {
00518 
00519             <span class="keywordflow">if</span> (SessionAddress == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00520 
00521                 <span class="comment">//</span>
00522                 <span class="comment">// Acquire system working set lock.  While this lock</span>
00523                 <span class="comment">// is held, no pages may go from valid to invalid.</span>
00524                 <span class="comment">//</span>
00525                 <span class="comment">// HOWEVER - transition pages may go to valid, but</span>
00526                 <span class="comment">// may not be added to the working set list.  This</span>
00527                 <span class="comment">// is done in the cache manager support routines to</span>
00528                 <span class="comment">// shortcut faults on transition prototype PTEs.</span>
00529                 <span class="comment">//</span>
00530 
00531                 <span class="keywordflow">if</span> (<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>() == <a class="code" href="../../d4/d8/mi_8h.html#a434">MmSystemLockOwner</a>) {
00532 
00533                     <span class="comment">//</span>
00534                     <span class="comment">// Recursively trying to acquire the system working set</span>
00535                     <span class="comment">// fast mutex - cause an IRQL &gt; 1 bug check.</span>
00536                     <span class="comment">//</span>
00537 
00538                     <span class="keywordflow">return</span> STATUS_IN_PAGE_ERROR | 0x10000000;
00539                 }
00540 
00541                 <a class="code" href="../../d4/d8/mi_8h.html#a144">LOCK_SYSTEM_WS</a> (PreviousIrql);
00542             }
00543 
00544             <span class="comment">//</span>
00545             <span class="comment">// Note that for session space the below check is done without</span>
00546             <span class="comment">// acquiring the session WSL lock.  This is because this thread</span>
00547             <span class="comment">// may already own it - ie: it may be adding a page to the</span>
00548             <span class="comment">// session space working set and the session's working set list is</span>
00549             <span class="comment">// not mapped in and causes a fault.  The MiCheckPdeForSessionSpace</span>
00550             <span class="comment">// call above will fill in the PDE and then we must check the PTE</span>
00551             <span class="comment">// below - if that's not present then we couldn't possibly be</span>
00552             <span class="comment">// holding the session WSL lock, so we'll acquire it below.</span>
00553             <span class="comment">//</span>
00554 
00555 <span class="preprocessor">#if defined (_X86PAE_)</span>
00556 <span class="preprocessor"></span>            <span class="comment">//</span>
00557             <span class="comment">// PAE PTEs are subject to write tearing due to the cache manager</span>
00558             <span class="comment">// shortcut routines that insert PTEs without acquiring the working</span>
00559             <span class="comment">// set lock.  Synchronize here via the PFN lock.</span>
00560             <span class="comment">//</span>
00561             <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00562 <span class="preprocessor">#endif</span>
00563 <span class="preprocessor"></span>            TempPte = *PointerPte;
00564 <span class="preprocessor">#if defined (_X86PAE_)</span>
00565 <span class="preprocessor"></span>            <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00566 <span class="preprocessor">#endif</span>
00567 <span class="preprocessor"></span>
00568             <span class="comment">//</span>
00569             <span class="comment">// If the PTE is valid, make sure we do not have a copy on</span>
00570             <span class="comment">// write.</span>
00571             <span class="comment">//</span>
00572 
00573             <span class="keywordflow">if</span> (TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid != 0) {
00574 
00575                 <span class="comment">//</span>
00576                 <span class="comment">// PTE is already valid, return.  Unless it's Hydra where</span>
00577                 <span class="comment">// kernel mode copy-on-write must be handled properly.</span>
00578                 <span class="comment">//</span>
00579 
00580                 BOOLEAN FaultHandled;
00581 
00582                 FaultHandled = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00583 
00584                 <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00585                 TempPte = *(<span class="keyword">volatile</span> <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> *)PointerPte;
00586                 <span class="keywordflow">if</span> (TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1) {
00587 
00588                     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber);
00589 
00590                     <span class="keywordflow">if</span> ((StoreInstruction) &amp;&amp;
00591                         (TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.CopyOnWrite == 0) &amp;&amp;
00592                         ((TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long &amp; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a77">MM_PTE_WRITE_MASK</a>) == 0) &amp;&amp;
00593                         ((Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection &amp; <a class="code" href="../../d4/d8/mi_8h.html#a39">MM_READWRITE</a>) == 0)) {
00594                 
00595                             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (ATTEMPTED_WRITE_TO_READONLY_MEMORY,
00596                                           (ULONG_PTR)VirtualAddress,
00597                                           (ULONG_PTR)TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long,
00598                                           (ULONG_PTR)TrapInformation,
00599                                           12);
00600                     }
00601 
00602                     <span class="comment">//</span>
00603                     <span class="comment">// Set the dirty bit in the PTE and the page frame.</span>
00604                     <span class="comment">//</span>
00605 
00606 <span class="preprocessor">#if defined(_ALPHA_)</span>
00607 <span class="preprocessor"></span>                    <span class="keywordflow">if</span> (SessionAddress == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> || (TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Write == 1 &amp;&amp; TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.CopyOnWrite == 0))
00608 <span class="preprocessor">#else</span>
00609 <span class="preprocessor"></span>                    <span class="keywordflow">if</span> (SessionAddress == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> || TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Write == 1)
00610 <span class="preprocessor">#endif</span>
00611 <span class="preprocessor"></span>                    {
00612                         FaultHandled = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00613                         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a176">MI_NO_FAULT_FOUND</a> (TempPte, PointerPte, VirtualAddress, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00614                     }
00615                 }
00616                 <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00617                 <span class="keywordflow">if</span> (SessionAddress == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00618                     <a class="code" href="../../d4/d8/mi_8h.html#a145">UNLOCK_SYSTEM_WS</a> (PreviousIrql);
00619                 }
00620                 <span class="keywordflow">if</span> (SessionAddress == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> || FaultHandled == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00621                     <span class="keywordflow">return</span> STATUS_SUCCESS;
00622                 }
00623             }
00624 
00625             <span class="keywordflow">if</span> (SessionAddress == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00626 
00627                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a581">MiHydra</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00628 
00629                 <span class="comment">//</span>
00630                 <span class="comment">// Acquire the session space working set lock.  While this lock</span>
00631                 <span class="comment">// is held, no session pages may go from valid to invalid.</span>
00632                 <span class="comment">//</span>
00633 
00634                 <span class="keywordflow">if</span> (<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>() == <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o36">WorkingSetLockOwner</a>) {
00635 
00636                     <span class="comment">//</span>
00637                     <span class="comment">// Recursively trying to acquire the session working set</span>
00638                     <span class="comment">// lock - cause an IRQL &gt; 1 bug check.</span>
00639                     <span class="comment">//</span>
00640 
00641                     <span class="keywordflow">return</span> STATUS_IN_PAGE_ERROR | 0x10000000;
00642                 }
00643 
00644                 <a class="code" href="../../d4/d8/mi_8h.html#a407">LOCK_SESSION_SPACE_WS</a> (PreviousIrql);
00645 
00646                 TempPte = *PointerPte;
00647 
00648                 <span class="comment">//</span>
00649                 <span class="comment">// The PTE could have become valid while we waited</span>
00650                 <span class="comment">// for the session space working set lock.</span>
00651                 <span class="comment">//</span>
00652 
00653                 <span class="keywordflow">if</span> (TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1) {
00654 
00655                     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00656                     TempPte = *(<span class="keyword">volatile</span> <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> *)PointerPte;
00657 
00658                     <span class="comment">//</span>
00659                     <span class="comment">// Check for copy-on-write.</span>
00660                     <span class="comment">//</span>
00661 
00662                     <span class="keywordflow">if</span> (TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1) {
00663 
00664 <span class="preprocessor">#if defined(_ALPHA_)</span>
00665 <span class="preprocessor"></span>                        <span class="keywordflow">if</span> (StoreInstruction &amp;&amp; TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.CopyOnWrite == 1)
00666 <span class="preprocessor">#else</span>
00667 <span class="preprocessor"></span>                        <span class="keywordflow">if</span> (StoreInstruction &amp;&amp; TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Write == 0)
00668 <span class="preprocessor">#endif</span>
00669 <span class="preprocessor"></span>                        {
00670 <span class="preprocessor">#if defined(_ALPHA_)</span>
00671 <span class="preprocessor"></span>                            TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Write = 0;
00672                             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a188">MI_WRITE_VALID_PTE_NEW_PROTECTION</a> (PointerPte, TempPte);
00673 <span class="preprocessor">#endif</span>
00674 <span class="preprocessor"></span>
00675                             <span class="comment">//</span>
00676                             <span class="comment">// Copy on write only for loaded drivers...</span>
00677                             <span class="comment">//</span>
00678 
00679                             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a352">MI_IS_SESSION_IMAGE_ADDRESS</a> (VirtualAddress));
00680 
00681                             <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00682 
00683                             <span class="keywordflow">if</span> (TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.CopyOnWrite == 0) {
00684                     
00685                                 <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (ATTEMPTED_WRITE_TO_READONLY_MEMORY,
00686                                               (ULONG_PTR)VirtualAddress,
00687                                               (ULONG_PTR)TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long,
00688                                               (ULONG_PTR)TrapInformation,
00689                                               13);
00690                             }
00691 
00692                             <a class="code" href="../../d8/d2/pagfault_8c.html#a32">MiSessionCopyOnWrite</a> (<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>,
00693                                                   VirtualAddress,
00694                                                   PointerPte);
00695 
00696                             <a class="code" href="../../d4/d8/mi_8h.html#a408">UNLOCK_SESSION_SPACE_WS</a> (PreviousIrql);
00697 
00698                             <span class="keywordflow">return</span> STATUS_SUCCESS;
00699                         }
00700 
00701 <span class="preprocessor">#if DBG</span>
00702 <span class="preprocessor"></span>                        <span class="comment">//</span>
00703                         <span class="comment">// If we are allowing a store, it better be writable.</span>
00704                         <span class="comment">//</span>
00705 
00706                         <span class="keywordflow">if</span> (StoreInstruction) {
00707                             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Write == 1);
00708                         }
00709 <span class="preprocessor">#endif</span>
00710 <span class="preprocessor"></span>                        <span class="comment">//</span>
00711                         <span class="comment">// PTE is already valid, return.</span>
00712                         <span class="comment">//</span>
00713 
00714                         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a176">MI_NO_FAULT_FOUND</a> (TempPte, PointerPte, VirtualAddress, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00715                     }
00716 
00717                     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00718                     <a class="code" href="../../d4/d8/mi_8h.html#a408">UNLOCK_SESSION_SPACE_WS</a> (PreviousIrql);
00719                     <span class="keywordflow">return</span> STATUS_SUCCESS;
00720                 }
00721             }
00722 
00723             <span class="keywordflow">if</span> (TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype != 0) {
00724 
00725                 <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a36">MmProtectFreedNonPagedPool</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00726 
00727                     PVOID StartVa;
00728     
00729                     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a178">MI_IS_PHYSICAL_ADDRESS</a>(<a class="code" href="../../d8/d5/kddata_8c.html#a23">MmNonPagedPoolStart</a>)) {
00730                         StartVa = <a class="code" href="../../d1/d6/allocpag_8c.html#a7">MmNonPagedPoolExpansionStart</a>;
00731                     }
00732                     <span class="keywordflow">else</span> {
00733                         StartVa = <a class="code" href="../../d8/d5/kddata_8c.html#a23">MmNonPagedPoolStart</a>;
00734                     }
00735     
00736                     <span class="keywordflow">if</span> (VirtualAddress &gt;= StartVa &amp;&amp; VirtualAddress &lt; <a class="code" href="../../d8/d5/kddata_8c.html#a24">MmNonPagedPoolEnd</a>) {
00737                         <span class="comment">//</span>
00738                         <span class="comment">// This is an access to previously freed</span>
00739                         <span class="comment">// non paged pool - bugcheck!</span>
00740                         <span class="comment">//</span>
00741     
00742                         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/ke_8h.html#a373">KeInvalidAccessAllowed</a>(TrapInformation) == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00743                             <span class="keywordflow">goto</span> AccessViolation;
00744                         }
00745     
00746                         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (DRIVER_CAUGHT_MODIFYING_FREED_POOL,
00747                                       (ULONG_PTR)VirtualAddress,
00748                                       StoreInstruction,
00749                                       PreviousMode,
00750                                       4);
00751                     }
00752                 }
00753 
00754                 <span class="comment">//</span>
00755                 <span class="comment">// This is a PTE in prototype format, locate the corresponding</span>
00756                 <span class="comment">// prototype PTE.</span>
00757                 <span class="comment">//</span>
00758 
00759                 PointerProtoPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a144">MiPteToProto</a> (&amp;TempPte);
00760 
00761                 <span class="keywordflow">if</span> (SessionAddress == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00762 
00763                     <span class="keywordflow">if</span> (TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.PageFileHigh == <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a181">MI_PTE_LOOKUP_NEEDED</a>) {
00764                         PointerProtoPte = <a class="code" href="../../d8/d2/pagfault_8c.html#a19">MiCheckVirtualAddress</a> (VirtualAddress,
00765                                                                  &amp;ProtectionCode);
00766                         <span class="keywordflow">if</span> (PointerProtoPte == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00767                             <a class="code" href="../../d4/d8/mi_8h.html#a408">UNLOCK_SESSION_SPACE_WS</a> (PreviousIrql);
00768                             <span class="keywordflow">return</span> STATUS_IN_PAGE_ERROR | 0x10000000;
00769                         }
00770                     }
00771                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Proto.ReadOnly == 1) {
00772         
00773                         <span class="comment">//</span>
00774                         <span class="comment">// Writes are not allowed to this page.</span>
00775                         <span class="comment">//</span>
00776 
00777                     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a352">MI_IS_SESSION_IMAGE_ADDRESS</a> (VirtualAddress)) {
00778 
00779                         <span class="comment">//</span>
00780                         <span class="comment">// Copy on write this page.</span>
00781                         <span class="comment">//</span>
00782     
00783                         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (PointerPte, <a class="code" href="../../d4/d2/datalpha_8c.html#a12">PrototypePte</a>);
00784                         PointerPte-&gt;u.Soft.Protection = <a class="code" href="../../d4/d8/mi_8h.html#a42">MM_EXECUTE_WRITECOPY</a>;
00785                     }
00786                 }
00787             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Transition == 0) &amp;&amp;
00788                         (TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection == 0)) {
00789 
00790                 <span class="comment">//</span>
00791                 <span class="comment">// Page file format.  If the protection is ZERO, this</span>
00792                 <span class="comment">// is a page of free system PTEs - bugcheck!</span>
00793                 <span class="comment">//</span>
00794 
00795                 <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/ke_8h.html#a373">KeInvalidAccessAllowed</a>(TrapInformation) == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00796                     <span class="keywordflow">goto</span> AccessViolation;
00797                 }
00798 
00799                 <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (PAGE_FAULT_IN_NONPAGED_AREA,
00800                               (ULONG_PTR)VirtualAddress,
00801                               StoreInstruction,
00802                               (ULONG_PTR)TrapInformation,
00803                               0);
00804                 <span class="keywordflow">return</span> STATUS_SUCCESS;
00805             }
00806             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection == <a class="code" href="../../d4/d8/mi_8h.html#a46">MM_NOACCESS</a>) {
00807 
00808                 <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/ke_8h.html#a373">KeInvalidAccessAllowed</a>(TrapInformation) == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00809                     <span class="keywordflow">goto</span> AccessViolation;
00810                 }
00811 
00812                 <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (PAGE_FAULT_IN_NONPAGED_AREA,
00813                               (ULONG_PTR)VirtualAddress,
00814                               StoreInstruction,
00815                               (ULONG_PTR)TrapInformation,
00816                               1);
00817                 <span class="keywordflow">return</span> STATUS_SUCCESS;
00818             }
00819 
00820 <span class="preprocessor">#ifdef PROTECT_KSTACKS</span>
00821 <span class="preprocessor"></span>            <span class="keywordflow">else</span> {
00822                  <span class="keywordflow">if</span> (TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection == <a class="code" href="../../d4/d8/mi_8h.html#a50">MM_KSTACK_OUTSWAPPED</a>) {
00823 
00824                     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/ke_8h.html#a373">KeInvalidAccessAllowed</a>(TrapInformation) == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00825                         <span class="keywordflow">goto</span> AccessViolation;
00826                     }
00827 
00828                     <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (PAGE_FAULT_IN_NONPAGED_AREA,
00829                                   (ULONG_PTR)VirtualAddress,
00830                                   StoreInstruction,
00831                                   (ULONG_PTR)TrapInformation,
00832                                   3);
00833                  }
00834             }
00835 <span class="preprocessor">#endif</span>
00836 <span class="preprocessor"></span>
00837             <span class="keywordflow">if</span> (SessionAddress == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00838 
00839                 <a class="code" href="../../d4/d8/mi_8h.html#a406">MM_SESSION_SPACE_WS_LOCK_ASSERT</a> ();
00840 
00841                 <span class="comment">//</span>
00842                 <span class="comment">// If it's a write to a session space page that is ultimately</span>
00843                 <span class="comment">// mapped by a prototype PTE, it's a copy-on-write piece of</span>
00844                 <span class="comment">// a session driver.  Since the page isn't even present yet,</span>
00845                 <span class="comment">// turn the write access into a read access to fault it in.</span>
00846                 <span class="comment">// We'll get a write fault on the present page when we retry</span>
00847                 <span class="comment">// the operation at which point we'll sever the copy on write.</span>
00848                 <span class="comment">//</span>
00849 
00850                 <span class="keywordflow">if</span> (PointerProtoPte &amp;&amp;
00851                     StoreInstruction &amp;&amp;
00852                     <a class="code" href="../../d4/d8/mi_8h.html#a352">MI_IS_SESSION_IMAGE_ADDRESS</a> (VirtualAddress)) {
00853                         StoreInstruction = 0;
00854                 }
00855 
00856                 FaultProcess = <a class="code" href="../../d4/d8/mi_8h.html#a332">HYDRA_PROCESS</a>;
00857             }
00858             <span class="keywordflow">else</span> {
00859                 FaultProcess = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00860 
00861                 <span class="keywordflow">if</span> (StoreInstruction) {
00862 
00863                     <span class="keywordflow">if</span> ((TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) &amp;&amp; (PointerProtoPte == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00864                         <span class="keywordflow">if</span> (TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Transition == 1) {
00865             
00866                             <span class="keywordflow">if</span> ((TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Trans.Protection &amp; <a class="code" href="../../d4/d8/mi_8h.html#a39">MM_READWRITE</a>) == 0) {
00867                                 <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (ATTEMPTED_WRITE_TO_READONLY_MEMORY,
00868                                               (ULONG_PTR)VirtualAddress,
00869                                               (ULONG_PTR)TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long,
00870                                               (ULONG_PTR)TrapInformation,
00871                                               14);
00872                             }
00873                         }
00874                         <span class="keywordflow">else</span> {
00875                             <span class="keywordflow">if</span> ((TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection &amp; <a class="code" href="../../d4/d8/mi_8h.html#a39">MM_READWRITE</a>) == 0) {
00876                     
00877                                 <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (ATTEMPTED_WRITE_TO_READONLY_MEMORY,
00878                                               (ULONG_PTR)VirtualAddress,
00879                                               (ULONG_PTR)TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long,
00880                                               (ULONG_PTR)TrapInformation,
00881                                               15);
00882                             }
00883                         }
00884                     }
00885                 }
00886             }
00887 
00888             status = <a class="code" href="../../d8/d2/pagfault_8c.html#a11">MiDispatchFault</a> (StoreInstruction,
00889                                       VirtualAddress,
00890                                       PointerPte,
00891                                       PointerProtoPte,
00892                                       FaultProcess,
00893                                       &amp;ApcNeeded);
00894 
00895             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ApcNeeded == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00896             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (KeGetCurrentIrql() == <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>);
00897 
00898             <span class="keywordflow">if</span> (SessionAddress == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00899                 Ws = &amp;<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>;
00900                 PageFrameIndex = Ws-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o2">PageFaultCount</a>;
00901                 <a class="code" href="../../d4/d8/mi_8h.html#a406">MM_SESSION_SPACE_WS_LOCK_ASSERT</a>();
00902             }
00903             <span class="keywordflow">else</span> {
00904                 Ws = &amp;<a class="code" href="../../d6/d8/sysinfo_8c.html#a21">MmSystemCacheWs</a>;
00905                 PageFrameIndex = <a class="code" href="../../d6/d8/sysinfo_8c.html#a21">MmSystemCacheWs</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o2">PageFaultCount</a>;
00906             }
00907 
00908             <span class="keywordflow">if</span> (Ws-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o9">AllowWorkingSetAdjustment</a> == <a class="code" href="../../d4/d8/mi_8h.html#a32">MM_GROW_WSLE_HASH</a>) {
00909                 <a class="code" href="../../d4/d0/wslist_8c.html#a33">MiGrowWsleHash</a> (Ws);
00910                 <a class="code" href="../../d4/d8/mi_8h.html#a142">LOCK_EXPANSION_IF_ALPHA</a> (OldIrql);
00911                 Ws-&gt;<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o9">AllowWorkingSetAdjustment</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00912                 <a class="code" href="../../d4/d8/mi_8h.html#a143">UNLOCK_EXPANSION_IF_ALPHA</a> (OldIrql);
00913             }
00914 
00915             <span class="keywordflow">if</span> (SessionAddress == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00916                 <a class="code" href="../../d4/d8/mi_8h.html#a408">UNLOCK_SESSION_SPACE_WS</a> (PreviousIrql);
00917             }
00918             <span class="keywordflow">else</span> {
00919                 <a class="code" href="../../d4/d8/mi_8h.html#a145">UNLOCK_SYSTEM_WS</a> (PreviousIrql);
00920             }
00921 
00922             <span class="keywordflow">if</span> ((PageFrameIndex &amp; 0x3FFFF) == 0x30000) {
00923 
00924                 <span class="comment">//</span>
00925                 <span class="comment">// The system cache or this session is taking too many faults,</span>
00926                 <span class="comment">// delay execution so the modified page writer gets a quick</span>
00927                 <span class="comment">// shot and increase the working set size.</span>
00928                 <span class="comment">//</span>
00929 
00930                 <a class="code" href="../../d1/d7/wait_8c.html#a2">KeDelayExecutionThread</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, &amp;<a class="code" href="../../d4/d8/mi_8h.html#a420">MmShortTime</a>);
00931             }
00932             NotifyRoutine = <a class="code" href="../../d4/d8/mi_8h.html#a746">MmPageFaultNotifyRoutine</a>;
00933             <span class="keywordflow">if</span> (NotifyRoutine) {
00934                 <span class="keywordflow">if</span> (status != STATUS_SUCCESS) {
00935                     (*NotifyRoutine) (
00936                         status,
00937                         VirtualAddress,
00938                         TrapInformation
00939                         );
00940                 }
00941             }
00942             <span class="keywordflow">return</span> status;
00943         } <span class="keywordflow">else</span> {
00944 <span class="preprocessor">#if !defined (_WIN64)</span>
00945 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (<a class="code" href="../../d8/d2/pagfault_8c.html#a20">MiCheckPdeForPagedPool</a> (VirtualAddress) == STATUS_WAIT_1) {
00946                 <span class="keywordflow">return</span> STATUS_SUCCESS;
00947             }
00948 <span class="preprocessor">#endif</span>
00949 <span class="preprocessor"></span>        }
00950     }
00951 
00952 <span class="preprocessor">#if defined (_WIN64)</span>
00953 <span class="preprocessor"></span>UserFault:
00954 <span class="preprocessor">#endif</span>
00955 <span class="preprocessor"></span>
00956     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a598">MiDelayPageFaults</a> ||
00957         ((<a class="code" href="../../d2/d1/mm_8h.html#a150">MmModifiedPageListHead</a>.<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o0">Total</a> &gt;= (<a class="code" href="../../d4/d8/mi_8h.html#a728">MmModifiedPageMaximum</a> + 100)) &amp;&amp;
00958         (<a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> &lt; (1024*1024 / <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>)) &amp;&amp;
00959             (CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o37">ModifiedPageCount</a> &gt; ((64*1024)/<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>)))) {
00960 
00961         <span class="comment">//</span>
00962         <span class="comment">// This process has placed more than 64k worth of pages on the modified</span>
00963         <span class="comment">// list.  Delay for a short period and set the count to zero.</span>
00964         <span class="comment">//</span>
00965 
00966         <a class="code" href="../../d1/d7/wait_8c.html#a2">KeDelayExecutionThread</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
00967                                 <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00968              (CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>.<a class="code" href="../../d5/d7/struct__KPROCESS.html#o12">BasePriority</a> &lt; <a class="code" href="../../d4/d1/mmfault_8c.html#a0">PROCESS_FOREGROUND_PRIORITY</a>) ?
00969                                     &amp;<a class="code" href="../../d4/d8/mi_8h.html#a421">MmHalfSecond</a> : &amp;<a class="code" href="../../d4/d8/mi_8h.html#a422">Mm30Milliseconds</a>);
00970         CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o37">ModifiedPageCount</a> = 0;
00971     }
00972 
00973     <span class="comment">//</span>
00974     <span class="comment">// FAULT IN USER SPACE OR PAGE DIRECTORY/PAGE TABLE PAGES.</span>
00975     <span class="comment">//</span>
00976 
00977     <span class="comment">//</span>
00978     <span class="comment">// Block APCs and acquire the working set lock.</span>
00979     <span class="comment">//</span>
00980 
00981     <a class="code" href="../../d4/d8/mi_8h.html#a154">LOCK_WS</a> (CurrentProcess);
00982 
00983 <span class="preprocessor">#if defined (_WIN64)</span>
00984 <span class="preprocessor"></span>
00985     <span class="comment">//</span>
00986     <span class="comment">// Locate the Page Directory Parent Entry which maps this virtual</span>
00987     <span class="comment">// address and check for accessibility and validity.  The page directory</span>
00988     <span class="comment">// page must be made valid before any other checks are made.</span>
00989     <span class="comment">//</span>
00990 
00991     <span class="keywordflow">if</span> (PointerPpe-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) {
00992 
00993         <span class="comment">//</span>
00994         <span class="comment">// If the PPE is zero, check to see if there is a virtual address</span>
00995         <span class="comment">// mapped at this location, and if so create the necessary</span>
00996         <span class="comment">// structures to map it.</span>
00997         <span class="comment">//</span>
00998 
00999         <span class="keywordflow">if</span> ((PointerPpe-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a93">MM_ZERO_PTE</a>) ||
01000             (PointerPpe-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a94">MM_ZERO_KERNEL_PTE</a>)) {
01001             PointerProtoPte = <a class="code" href="../../d8/d2/pagfault_8c.html#a19">MiCheckVirtualAddress</a> (VirtualAddress,
01002                                                      &amp;ProtectCode);
01003 
01004 <span class="preprocessor">#ifdef LARGE_PAGES</span>
01005 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (ProtectCode == <a class="code" href="../../d4/d8/mi_8h.html#a48">MM_LARGE_PAGES</a>) {
01006                 status = STATUS_SUCCESS;
01007                 <span class="keywordflow">goto</span> ReturnStatus2;
01008             }
01009 <span class="preprocessor">#endif //LARGE_PAGES</span>
01010 <span class="preprocessor"></span>
01011             <span class="keywordflow">if</span> (ProtectCode == <a class="code" href="../../d4/d8/mi_8h.html#a46">MM_NOACCESS</a>) {
01012                 status = STATUS_ACCESS_VIOLATION;
01013 <span class="comment">//                MiCheckPpeForPagedPool (VirtualAddress);</span>
01014                 <span class="keywordflow">if</span> (PointerPpe-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1) {
01015                     status = STATUS_SUCCESS;
01016                 }
01017 
01018 <span class="preprocessor">#if DBG</span>
01019 <span class="preprocessor"></span>                <span class="keywordflow">if</span> ((MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a79">MM_DBG_STOP_ON_ACCVIO</a>) &amp;&amp;
01020                     (status == STATUS_ACCESS_VIOLATION)) {
01021                     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"MM:access violation - %p\n"</span>,VirtualAddress);
01022                     <a class="code" href="../../d4/d8/mi_8h.html#a968">MiFormatPte</a>(PointerPpe);
01023                     DbgBreakPoint();
01024                 }
01025 <span class="preprocessor">#endif //DEBUG</span>
01026 <span class="preprocessor"></span>
01027                 <span class="keywordflow">goto</span> ReturnStatus2;
01028 
01029             } <span class="keywordflow">else</span> {
01030 
01031                 <span class="comment">//</span>
01032                 <span class="comment">// Build a demand zero PPE and operate on it.</span>
01033                 <span class="comment">//</span>
01034 
01035                 *PointerPpe = <a class="code" href="../../d4/d2/datalpha_8c.html#a9">DemandZeroPde</a>;
01036             }
01037         }
01038 
01039         <span class="comment">//</span>
01040         <span class="comment">// The PPE is not valid, call the page fault routine passing</span>
01041         <span class="comment">// in the address of the PPE.  If the PPE is valid, determine</span>
01042         <span class="comment">// the status of the corresponding PDE.</span>
01043         <span class="comment">//</span>
01044         <span class="comment">// Note this call may result in ApcNeeded getting set to TRUE.</span>
01045         <span class="comment">// This is deliberate as there may be another call to MiDispatchFault</span>
01046         <span class="comment">// issued later in this routine and we don't want to lose the APC</span>
01047         <span class="comment">// status.</span>
01048         <span class="comment">//</span>
01049 
01050         status = <a class="code" href="../../d8/d2/pagfault_8c.html#a11">MiDispatchFault</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,  <span class="comment">//page table page always written</span>
01051                                   PointerPde,   <span class="comment">//Virtual address</span>
01052                                   PointerPpe,   <span class="comment">// PTE (PPE in this case)</span>
01053                                   <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01054                                   CurrentProcess,
01055                                   &amp;ApcNeeded);
01056 
01057 <span class="preprocessor">#if DBG</span>
01058 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (ApcNeeded == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01059             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;NestedFaultCount == 0);
01060             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;ApcNeeded == 0);
01061         }
01062 <span class="preprocessor">#endif</span>
01063 <span class="preprocessor"></span>
01064         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (KeGetCurrentIrql() == <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>);
01065         <span class="keywordflow">if</span> (PointerPpe-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) {
01066 
01067             <span class="comment">//</span>
01068             <span class="comment">// The PPE is not valid, return the status.</span>
01069             <span class="comment">//</span>
01070             <span class="keywordflow">goto</span> ReturnStatus1;
01071         }
01072 
01073 <span class="preprocessor">#if PFN_CONSISTENCY</span>
01074 <span class="preprocessor"></span>        {
01075             <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
01076 
01077             <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
01078             Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PointerPpe-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber);
01079             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageTablePage = 1;
01080             <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
01081         }
01082 <span class="preprocessor">#endif</span>
01083 <span class="preprocessor"></span>        <span class="comment">//KeFillEntryTb ((PHARDWARE_PTE)PointerPpe, (PVOID)PointerPde, TRUE);</span>
01084 
01085         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a175">MI_SET_PAGE_DIRTY</a> (PointerPpe, PointerPde, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01086 
01087         <span class="comment">//</span>
01088         <span class="comment">// Now that the PPE is accessible, get the PDE - let this fall</span>
01089         <span class="comment">// through.</span>
01090         <span class="comment">//</span>
01091     }
01092 <span class="preprocessor">#endif</span>
01093 <span class="preprocessor"></span>
01094     <span class="comment">//</span>
01095     <span class="comment">// Locate the Page Directory Entry which maps this virtual</span>
01096     <span class="comment">// address and check for accessibility and validity.</span>
01097     <span class="comment">//</span>
01098 
01099     <span class="comment">//</span>
01100     <span class="comment">// Check to see if the page table page (PDE entry) is valid.</span>
01101     <span class="comment">// If not, the page table page must be made valid first.</span>
01102     <span class="comment">//</span>
01103 
01104     <span class="keywordflow">if</span> (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) {
01105 
01106         <span class="comment">//</span>
01107         <span class="comment">// If the PDE is zero, check to see if there is a virtual address</span>
01108         <span class="comment">// mapped at this location, and if so create the necessary</span>
01109         <span class="comment">// structures to map it.</span>
01110         <span class="comment">//</span>
01111 
01112         <span class="keywordflow">if</span> ((PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a93">MM_ZERO_PTE</a>) ||
01113             (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a94">MM_ZERO_KERNEL_PTE</a>)) {
01114             PointerProtoPte = <a class="code" href="../../d8/d2/pagfault_8c.html#a19">MiCheckVirtualAddress</a> (VirtualAddress,
01115                                                      &amp;ProtectCode);
01116 
01117 <span class="preprocessor">#ifdef LARGE_PAGES</span>
01118 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (ProtectCode == <a class="code" href="../../d4/d8/mi_8h.html#a48">MM_LARGE_PAGES</a>) {
01119                 status = STATUS_SUCCESS;
01120                 <span class="keywordflow">goto</span> ReturnStatus2;
01121             }
01122 <span class="preprocessor">#endif //LARGE_PAGES</span>
01123 <span class="preprocessor"></span>
01124             <span class="keywordflow">if</span> (ProtectCode == <a class="code" href="../../d4/d8/mi_8h.html#a46">MM_NOACCESS</a>) {
01125                 status = STATUS_ACCESS_VIOLATION;
01126 <span class="preprocessor">#if !defined (_WIN64)</span>
01127 <span class="preprocessor"></span>                <a class="code" href="../../d8/d2/pagfault_8c.html#a20">MiCheckPdeForPagedPool</a> (VirtualAddress);
01128 <span class="preprocessor">#endif</span>
01129 <span class="preprocessor"></span>
01130                 <span class="keywordflow">if</span> (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1) {
01131                     status = STATUS_SUCCESS;
01132                 }
01133 
01134 <span class="preprocessor">#if DBG</span>
01135 <span class="preprocessor"></span>                <span class="keywordflow">if</span> ((MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a79">MM_DBG_STOP_ON_ACCVIO</a>) &amp;&amp;
01136                     (status == STATUS_ACCESS_VIOLATION)) {
01137                     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"MM:access violation - %p\n"</span>,VirtualAddress);
01138                     <a class="code" href="../../d4/d8/mi_8h.html#a968">MiFormatPte</a>(PointerPde);
01139                     DbgBreakPoint();
01140                 }
01141 <span class="preprocessor">#endif //DEBUG</span>
01142 <span class="preprocessor"></span>
01143                 <span class="keywordflow">goto</span> ReturnStatus2;
01144 
01145             }
01146 
01147             <span class="comment">//</span>
01148             <span class="comment">// Build a demand zero PDE and operate on it.</span>
01149             <span class="comment">//</span>
01150 
01151             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (PointerPde, <a class="code" href="../../d4/d2/datalpha_8c.html#a9">DemandZeroPde</a>);
01152 
01153 <span class="preprocessor">#if defined (_WIN64)</span>
01154 <span class="preprocessor"></span>
01155             <span class="comment">//</span>
01156             <span class="comment">// Increment the count of non-zero page directory entries for this</span>
01157             <span class="comment">// page directory.</span>
01158             <span class="comment">//</span>
01159 
01160             <span class="keywordflow">if</span> (VirtualAddress &lt;= MM_HIGHEST_USER_ADDRESS) {
01161                 UsedPageTableHandle = <a class="code" href="../../d4/d8/mi_8h.html#a180">MI_GET_USED_PTES_HANDLE</a> (PointerPte);
01162                 <a class="code" href="../../d4/d8/mi_8h.html#a182">MI_INCREMENT_USED_PTES_BY_HANDLE</a> (UsedPageTableHandle);
01163             }
01164 <span class="preprocessor">#endif</span>
01165 <span class="preprocessor"></span>
01166         }
01167 
01168         <span class="comment">//</span>
01169         <span class="comment">// The PDE is not valid, call the page fault routine passing</span>
01170         <span class="comment">// in the address of the PDE.  If the PDE is valid, determine</span>
01171         <span class="comment">// the status of the corresponding PTE.</span>
01172         <span class="comment">//</span>
01173 
01174         status = <a class="code" href="../../d8/d2/pagfault_8c.html#a11">MiDispatchFault</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,  <span class="comment">//page table page always written</span>
01175                                   PointerPte,   <span class="comment">//Virtual address</span>
01176                                   PointerPde,   <span class="comment">// PTE (PDE in this case)</span>
01177                                   <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01178                                   CurrentProcess,
01179                                   &amp;ApcNeeded);
01180 
01181 <span class="preprocessor">#if DBG</span>
01182 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (ApcNeeded == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01183             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;NestedFaultCount == 0);
01184             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;ApcNeeded == 0);
01185         }
01186 <span class="preprocessor">#endif</span>
01187 <span class="preprocessor"></span>
01188         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (KeGetCurrentIrql() == <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>);
01189         <span class="keywordflow">if</span> (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) {
01190 
01191             <span class="comment">//</span>
01192             <span class="comment">// The PDE is not valid, return the status.</span>
01193             <span class="comment">//</span>
01194             <span class="keywordflow">goto</span> ReturnStatus1;
01195         }
01196 
01197 <span class="preprocessor">#if PFN_CONSISTENCY</span>
01198 <span class="preprocessor"></span>        {
01199             <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
01200 
01201             <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
01202             Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber);
01203             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageTablePage = 1;
01204             <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
01205         }
01206 <span class="preprocessor">#endif</span>
01207 <span class="preprocessor"></span>        <span class="comment">//KeFillEntryTb ((PHARDWARE_PTE)PointerPde, (PVOID)PointerPte, TRUE);</span>
01208 
01209         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a175">MI_SET_PAGE_DIRTY</a> (PointerPde, PointerPte, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01210 
01211         <span class="comment">//</span>
01212         <span class="comment">// Now that the PDE is accessible, get the PTE - let this fall</span>
01213         <span class="comment">// through.</span>
01214         <span class="comment">//</span>
01215     }
01216 
01217     <span class="comment">//</span>
01218     <span class="comment">// The PDE is valid and accessible, get the PTE contents.</span>
01219     <span class="comment">//</span>
01220 
01221     TempPte = *PointerPte;
01222     <span class="keywordflow">if</span> (TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid != 0) {
01223 
01224         <span class="comment">//</span>
01225         <span class="comment">// The PTE is valid and accessible, is this a write fault</span>
01226         <span class="comment">// copy on write or setting of some dirty bit?</span>
01227         <span class="comment">//</span>
01228 
01229 <span class="preprocessor">#if DBG</span>
01230 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a57">MM_DBG_PTE_UPDATE</a>) {
01231             <a class="code" href="../../d4/d8/mi_8h.html#a968">MiFormatPte</a>(PointerPte);
01232         }
01233 <span class="preprocessor">#endif //DBG</span>
01234 <span class="preprocessor"></span>
01235         status = STATUS_SUCCESS;
01236 
01237         <span class="keywordflow">if</span> (StoreInstruction) {
01238 
01239             <span class="comment">//</span>
01240             <span class="comment">// This was a write operation.  If the copy on write</span>
01241             <span class="comment">// bit is set in the PTE perform the copy on write,</span>
01242             <span class="comment">// else check to ensure write access to the PTE.</span>
01243             <span class="comment">//</span>
01244 
01245             <span class="keywordflow">if</span> (TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.CopyOnWrite != 0) {
01246                 <a class="code" href="../../d3/d0/wrtfault_8c.html#a0">MiCopyOnWrite</a> (VirtualAddress, PointerPte);
01247                 status = STATUS_PAGE_FAULT_COPY_ON_WRITE;
01248                 <span class="keywordflow">goto</span> ReturnStatus2;
01249 
01250             } <span class="keywordflow">else</span> {
01251                 <span class="keywordflow">if</span> (TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Write == 0) {
01252                     status = STATUS_ACCESS_VIOLATION;
01253                 }
01254             }
01255 <span class="preprocessor">#if defined(_IA64_)</span>
01256 <span class="preprocessor"></span>        } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ExecutionFault) {
01257 
01258             <span class="comment">//</span>
01259             <span class="comment">// It also checks to ensure execute access to the PTE.</span>
01260             <span class="comment">//</span>
01261 
01262             <span class="keywordflow">if</span> (TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Execute == 0) {
01263                 status = STATUS_ACCESS_VIOLATION;
01264             }
01265 <span class="preprocessor">#endif</span>
01266 <span class="preprocessor"></span><span class="preprocessor">#if DBG</span>
01267 <span class="preprocessor"></span>        } <span class="keywordflow">else</span> {
01268 
01269             <span class="comment">//</span>
01270             <span class="comment">// The PTE is valid and accessible, another thread must</span>
01271             <span class="comment">// have faulted the PTE in already, or the access bit</span>
01272             <span class="comment">// is clear and this is a access fault; Blindly set the</span>
01273             <span class="comment">// access bit and dismiss the fault.</span>
01274             <span class="comment">//</span>
01275 
01276             <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a82">MM_DBG_SHOW_FAULTS</a>) {
01277                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"MM:no fault found - pte is %p\n"</span>, PointerPte-&gt;u.Long);
01278             }
01279 <span class="preprocessor">#endif //DBG</span>
01280 <span class="preprocessor"></span>        }
01281 
01282         <span class="keywordflow">if</span> (status == STATUS_SUCCESS) {
01283             <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
01284             <span class="keywordflow">if</span> (PointerPte-&gt;u.Hard.Valid != 0) {
01285                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a176">MI_NO_FAULT_FOUND</a> (TempPte, PointerPte, VirtualAddress, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01286             }
01287             <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
01288         }
01289 
01290         <span class="keywordflow">goto</span> ReturnStatus2;
01291     }
01292 
01293     <span class="comment">//</span>
01294     <span class="comment">// If the PTE is zero, check to see if there is a virtual address</span>
01295     <span class="comment">// mapped at this location, and if so create the necessary</span>
01296     <span class="comment">// structures to map it.</span>
01297     <span class="comment">//</span>
01298 
01299     <span class="comment">//</span>
01300     <span class="comment">// Check explicitly for demand zero pages.</span>
01301     <span class="comment">//</span>
01302 
01303     <span class="keywordflow">if</span> (TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a95">MM_DEMAND_ZERO_WRITE_PTE</a>) {
01304         <a class="code" href="../../d8/d2/pagfault_8c.html#a12">MiResolveDemandZeroFault</a> (VirtualAddress,
01305                                   PointerPte,
01306                                   CurrentProcess,
01307                                   0);
01308 
01309         status = STATUS_PAGE_FAULT_DEMAND_ZERO;
01310         <span class="keywordflow">goto</span> ReturnStatus1;
01311     }
01312 
01313     <span class="keywordflow">if</span> ((TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a93">MM_ZERO_PTE</a>) ||
01314         (TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a94">MM_ZERO_KERNEL_PTE</a>)) {
01315 
01316         <span class="comment">//</span>
01317         <span class="comment">// PTE is needs to be evaluated with respect to its virtual</span>
01318         <span class="comment">// address descriptor (VAD).  At this point there are 3</span>
01319         <span class="comment">// possibilities, bogus address, demand zero, or refers to</span>
01320         <span class="comment">// a prototype PTE.</span>
01321         <span class="comment">//</span>
01322 
01323         PointerProtoPte = <a class="code" href="../../d8/d2/pagfault_8c.html#a19">MiCheckVirtualAddress</a> (VirtualAddress,
01324                                                  &amp;ProtectionCode);
01325         <span class="keywordflow">if</span> (ProtectionCode == <a class="code" href="../../d4/d8/mi_8h.html#a46">MM_NOACCESS</a>) {
01326             status = STATUS_ACCESS_VIOLATION;
01327 
01328             <span class="comment">//</span>
01329             <span class="comment">// Check to make sure this is not a page table page for</span>
01330             <span class="comment">// paged pool which needs extending.</span>
01331             <span class="comment">//</span>
01332 
01333 <span class="preprocessor">#if !defined (_WIN64)</span>
01334 <span class="preprocessor"></span>            <a class="code" href="../../d8/d2/pagfault_8c.html#a20">MiCheckPdeForPagedPool</a> (VirtualAddress);
01335 <span class="preprocessor">#endif</span>
01336 <span class="preprocessor"></span>
01337             <span class="keywordflow">if</span> (PointerPte-&gt;u.Hard.Valid == 1) {
01338                 status = STATUS_SUCCESS;
01339             }
01340 
01341 <span class="preprocessor">#if DBG</span>
01342 <span class="preprocessor"></span>            <span class="keywordflow">if</span> ((MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a79">MM_DBG_STOP_ON_ACCVIO</a>) &amp;&amp;
01343                 (status == STATUS_ACCESS_VIOLATION)) {
01344                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"MM:access vio - %p\n"</span>,VirtualAddress);
01345                 <a class="code" href="../../d4/d8/mi_8h.html#a968">MiFormatPte</a>(PointerPte);
01346                 DbgBreakPoint();
01347             }
01348 <span class="preprocessor">#endif //DEBUG</span>
01349 <span class="preprocessor"></span>            <span class="keywordflow">goto</span> ReturnStatus2;
01350         }
01351 
01352         <span class="comment">//</span>
01353         <span class="comment">// Increment the count of non-zero page table entries for this</span>
01354         <span class="comment">// page table.</span>
01355         <span class="comment">//</span>
01356 
01357         <span class="keywordflow">if</span> (VirtualAddress &lt;= MM_HIGHEST_USER_ADDRESS) {
01358             UsedPageTableHandle = <a class="code" href="../../d4/d8/mi_8h.html#a180">MI_GET_USED_PTES_HANDLE</a> (VirtualAddress);
01359             <a class="code" href="../../d4/d8/mi_8h.html#a182">MI_INCREMENT_USED_PTES_BY_HANDLE</a> (UsedPageTableHandle);
01360         }
01361 
01362         <span class="comment">//</span>
01363         <span class="comment">// Is this page a guard page?</span>
01364         <span class="comment">//</span>
01365 
01366         <span class="keywordflow">if</span> (ProtectionCode &amp; <a class="code" href="../../d4/d8/mi_8h.html#a44">MM_GUARD_PAGE</a>) {
01367 
01368             <span class="comment">//</span>
01369             <span class="comment">// This is a guard page exception.</span>
01370             <span class="comment">//</span>
01371 
01372             PointerPte-&gt;u.Soft.Protection = ProtectionCode &amp; ~<a class="code" href="../../d4/d8/mi_8h.html#a44">MM_GUARD_PAGE</a>;
01373 
01374             <span class="keywordflow">if</span> (PointerProtoPte != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01375 
01376                 <span class="comment">//</span>
01377                 <span class="comment">// This is a prototype PTE, build the PTE to not</span>
01378                 <span class="comment">// be a guard page.</span>
01379                 <span class="comment">//</span>
01380 
01381                 PointerPte-&gt;u.Soft.PageFileHigh = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a181">MI_PTE_LOOKUP_NEEDED</a>;
01382                 PointerPte-&gt;u.Soft.Prototype = 1;
01383             }
01384 
01385             <a class="code" href="../../d4/d8/mi_8h.html#a158">UNLOCK_WS</a> (CurrentProcess);
01386             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (KeGetCurrentIrql() == PreviousIrql);
01387 
01388             <span class="keywordflow">if</span> (ApcNeeded == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01389                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;NestedFaultCount == 0);
01390                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;ApcNeeded == 0);
01391                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (KeGetCurrentIrql() == <a class="code" href="../../d1/d3/ppcdef_8h.html#a21">PASSIVE_LEVEL</a>);
01392                 <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>, &amp;PreviousIrql);
01393                 <a class="code" href="../../d4/d6/iosubs_8c.html#a136">IoRetryIrpCompletions</a> ();
01394                 <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a> (PreviousIrql);
01395             }
01396 
01397             <span class="keywordflow">return</span> <a class="code" href="../../d4/d8/mi_8h.html#a834">MiCheckForUserStackOverflow</a> (VirtualAddress);
01398         }
01399 
01400         <span class="keywordflow">if</span> (PointerProtoPte == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01401 
01402             <span class="comment">//ASSERT (KeReadStateMutant (&amp;CurrentProcess-&gt;WorkingSetLock) == 0);</span>
01403 
01404             <span class="comment">//</span>
01405             <span class="comment">// Assert that this is not for a PDE.</span>
01406             <span class="comment">//</span>
01407 
01408             <span class="keywordflow">if</span> (PointerPde == <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a>(PTE_BASE)) {
01409 
01410                 <span class="comment">//</span>
01411                 <span class="comment">// This PTE is really a PDE, set contents as such.</span>
01412                 <span class="comment">//</span>
01413 
01414                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (PointerPte, <a class="code" href="../../d4/d2/datalpha_8c.html#a9">DemandZeroPde</a>);
01415             } <span class="keywordflow">else</span> {
01416                 PointerPte-&gt;u.Soft.Protection = ProtectionCode;
01417             }
01418 
01419             <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
01420 
01421             <span class="comment">//</span>
01422             <span class="comment">// If a fork operation is in progress and the faulting thread</span>
01423             <span class="comment">// is not the thread performing the fork operation, block until</span>
01424             <span class="comment">// the fork is completed.</span>
01425             <span class="comment">//</span>
01426 
01427             <span class="keywordflow">if</span> ((CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o30">ForkInProgress</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
01428                 (CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o30">ForkInProgress</a> != <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>())) {
01429                 <a class="code" href="../../d4/d8/mi_8h.html#a855">MiWaitForForkToComplete</a> (CurrentProcess);
01430                 status = STATUS_SUCCESS;
01431                 <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
01432                 <span class="keywordflow">goto</span> ReturnStatus1;
01433             }
01434 
01435             <span class="keywordflow">if</span> (!<a class="code" href="../../d7/d5/pfnlist_8c.html#a13">MiEnsureAvailablePageOrWait</a> (CurrentProcess,
01436                                               VirtualAddress)) {
01437 
01438                 ULONG Color;
01439                 Color = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a128">MI_PAGE_COLOR_VA_PROCESS</a> (VirtualAddress,
01440                                                 &amp;CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o43">NextPageColor</a>);
01441                 PageFrameIndex = <a class="code" href="../../d4/d8/mi_8h.html#a243">MiRemoveZeroPageIfAny</a> (Color);
01442                 <span class="keywordflow">if</span> (PageFrameIndex == 0) {
01443                     PageFrameIndex = <a class="code" href="../../d7/d5/pfnlist_8c.html#a15">MiRemoveAnyPage</a> (Color);
01444                     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
01445                     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
01446                     <a class="code" href="../../d0/d2/mmsup_8c.html#a14">MiZeroPhysicalPage</a> (PageFrameIndex, Color);
01447 
01448                     <span class="comment">//</span>
01449                     <span class="comment">// Note the stamping must occur after the page is zeroed.</span>
01450                     <span class="comment">//</span>
01451 
01452                     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a198">MI_BARRIER_STAMP_ZEROED_PAGE</a> (&amp;Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a>);
01453 
01454                     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
01455                 }
01456 
01457                 Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
01458 
01459                 CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o41">NumberOfPrivatePages</a> += 1;
01460                 <a class="code" href="../../d2/d1/mm_8h.html#a145">MmInfoCounters</a>.<a class="code" href="../../d3/d2/struct__MMINFO__COUNTERS.html#o4">DemandZeroCount</a> += 1;
01461 
01462                 <span class="comment">//</span>
01463                 <span class="comment">// This barrier check is needed after zeroing the page and</span>
01464                 <span class="comment">// before setting the PTE valid.</span>
01465                 <span class="comment">// Capture it now, check it at the last possible moment.</span>
01466                 <span class="comment">//</span>
01467 
01468                 BarrierStamp = (ULONG)Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a>;
01469 
01470                 <a class="code" href="../../d8/d2/pagfault_8c.html#a22">MiInitializePfn</a> (PageFrameIndex, PointerPte, 1);
01471 
01472                 <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
01473 
01474                 <span class="comment">//</span>
01475                 <span class="comment">// As this page is demand zero, set the modified bit in the</span>
01476                 <span class="comment">// PFN database element and set the dirty bit in the PTE.</span>
01477                 <span class="comment">//</span>
01478 
01479 <span class="preprocessor">#if PFN_CONSISTENCY</span>
01480 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (PointerPde == <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a>(PTE_BASE)) {
01481                     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
01482                     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageTablePage = 1;
01483                     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
01484                 }
01485 <span class="preprocessor">#endif</span>
01486 <span class="preprocessor"></span>
01487                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a105">MI_MAKE_VALID_PTE</a> (TempPte,
01488                                    PageFrameIndex,
01489                                    PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection,
01490                                    PointerPte);
01491 
01492                 <span class="keywordflow">if</span> (TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Write != 0) {
01493                     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a112">MI_SET_PTE_DIRTY</a> (TempPte);
01494                 }
01495 
01496                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a197">MI_BARRIER_SYNCHRONIZE</a> (BarrierStamp);
01497 
01498                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a> (PointerPte, TempPte);
01499 
01500                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Event == 0);
01501 
01502                 <a class="code" href="../../d4/d8/mi_8h.html#a121">CONSISTENCY_LOCK_PFN</a> (OldIrql);
01503 
01504                 Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Event = (PVOID)<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
01505 
01506                 <a class="code" href="../../d4/d8/mi_8h.html#a122">CONSISTENCY_UNLOCK_PFN</a> (OldIrql);
01507 
01508                 WorkingSetIndex = <a class="code" href="../../d4/d0/wslist_8c.html#a21">MiLocateAndReserveWsle</a> (&amp;CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>);
01509                 <a class="code" href="../../d4/d0/wslist_8c.html#a25">MiUpdateWsle</a> (&amp;WorkingSetIndex,
01510                               VirtualAddress,
01511                               <a class="code" href="../../d4/d8/mi_8h.html#a672">MmWorkingSetList</a>,
01512                               Pfn1);
01513 
01514                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a109">MI_SET_PTE_IN_WORKING_SET</a> (PointerPte, WorkingSetIndex);
01515 
01516                 KeFillEntryTb ((PHARDWARE_PTE)PointerPte,
01517                                 VirtualAddress,
01518                                 <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01519             } <span class="keywordflow">else</span> {
01520                 <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
01521             }
01522 
01523             status = STATUS_PAGE_FAULT_DEMAND_ZERO;
01524             <span class="keywordflow">goto</span> ReturnStatus1;
01525 
01526         } <span class="keywordflow">else</span> {
01527 
01528             <span class="comment">//</span>
01529             <span class="comment">// This is a prototype PTE.</span>
01530             <span class="comment">//</span>
01531 
01532             <span class="keywordflow">if</span> (ProtectionCode == <a class="code" href="../../d4/d8/mi_8h.html#a47">MM_UNKNOWN_PROTECTION</a>) {
01533 
01534                 <span class="comment">//</span>
01535                 <span class="comment">// The protection field is stored in the prototype PTE.</span>
01536                 <span class="comment">//</span>
01537 
01538                 PointerPte-&gt;u.Long = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a145">MiProtoAddressForPte</a> (PointerProtoPte);
01539 
01540             } <span class="keywordflow">else</span> {
01541 
01542                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (PointerPte, <a class="code" href="../../d4/d2/datalpha_8c.html#a12">PrototypePte</a>);
01543                 PointerPte-&gt;u.Soft.Protection = ProtectionCode;
01544             }
01545             TempPte = *PointerPte;
01546         }
01547 
01548     } <span class="keywordflow">else</span> {
01549 
01550         <span class="comment">//</span>
01551         <span class="comment">// The PTE is non-zero and not valid, see if it is a prototype PTE.</span>
01552         <span class="comment">//</span>
01553 
01554         ProtectionCode = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a184">MI_GET_PROTECTION_FROM_SOFT_PTE</a>(&amp;TempPte);
01555 
01556         <span class="keywordflow">if</span> (TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype != 0) {
01557             <span class="keywordflow">if</span> (TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.PageFileHigh == <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a181">MI_PTE_LOOKUP_NEEDED</a>) {
01558 <span class="preprocessor">#if DBG</span>
01559 <span class="preprocessor"></span>                MmProtoPteVadLookups += 1;
01560 <span class="preprocessor">#endif //DBG</span>
01561 <span class="preprocessor"></span>                PointerProtoPte = <a class="code" href="../../d8/d2/pagfault_8c.html#a19">MiCheckVirtualAddress</a> (VirtualAddress,
01562                                                          &amp;ProtectCode);
01563                 <span class="keywordflow">if</span> (PointerProtoPte == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01564                     status = STATUS_ACCESS_VIOLATION;
01565                     <span class="keywordflow">goto</span> ReturnStatus1;
01566                 }
01567 
01568             } <span class="keywordflow">else</span> {
01569 <span class="preprocessor">#if DBG</span>
01570 <span class="preprocessor"></span>                MmProtoPteDirect += 1;
01571 <span class="preprocessor">#endif //DBG</span>
01572 <span class="preprocessor"></span>
01573                 <span class="comment">//</span>
01574                 <span class="comment">// Protection is in the prototype PTE, indicate an</span>
01575                 <span class="comment">// access check should not be performed on the current PTE.</span>
01576                 <span class="comment">//</span>
01577 
01578                 PointerProtoPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a144">MiPteToProto</a> (&amp;TempPte);
01579                 ProtectionCode = <a class="code" href="../../d4/d8/mi_8h.html#a47">MM_UNKNOWN_PROTECTION</a>;
01580 
01581                 <span class="comment">//</span>
01582                 <span class="comment">// Check to see if the proto protection has been overridden.</span>
01583                 <span class="comment">//</span>
01584 
01585                 <span class="keywordflow">if</span> (TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Proto.ReadOnly != 0) {
01586                     ProtectionCode = <a class="code" href="../../d4/d8/mi_8h.html#a36">MM_READONLY</a>;
01587                 }
01588             }
01589         }
01590     }
01591 
01592     <span class="keywordflow">if</span> (ProtectionCode != <a class="code" href="../../d4/d8/mi_8h.html#a47">MM_UNKNOWN_PROTECTION</a>) {
01593         status = <a class="code" href="../../d4/d8/mi_8h.html#a833">MiAccessCheck</a> (PointerPte,
01594                                 StoreInstruction,
01595                                 PreviousMode,
01596                                 ProtectionCode,
01597                                 <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
01598 
01599         <span class="keywordflow">if</span> (status != STATUS_SUCCESS) {
01600 <span class="preprocessor">#if DBG</span>
01601 <span class="preprocessor"></span>            <span class="keywordflow">if</span> ((MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a79">MM_DBG_STOP_ON_ACCVIO</a>) &amp;&amp; (status == STATUS_ACCESS_VIOLATION)) {
01602                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"MM:access violate - %p\n"</span>,VirtualAddress);
01603                 <a class="code" href="../../d4/d8/mi_8h.html#a968">MiFormatPte</a>(PointerPte);
01604                 DbgBreakPoint();
01605             }
01606 <span class="preprocessor">#endif //DEBUG</span>
01607 <span class="preprocessor"></span>
01608             <a class="code" href="../../d4/d8/mi_8h.html#a158">UNLOCK_WS</a> (CurrentProcess);
01609             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (KeGetCurrentIrql() == PreviousIrql);
01610 
01611             <span class="keywordflow">if</span> (ApcNeeded == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01612                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;NestedFaultCount == 0);
01613                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;ApcNeeded == 0);
01614                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (KeGetCurrentIrql() == <a class="code" href="../../d1/d3/ppcdef_8h.html#a21">PASSIVE_LEVEL</a>);
01615                 <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>, &amp;PreviousIrql);
01616                 <a class="code" href="../../d4/d6/iosubs_8c.html#a136">IoRetryIrpCompletions</a> ();
01617                 <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a> (PreviousIrql);
01618             }
01619 
01620             <span class="comment">//</span>
01621             <span class="comment">// Check to see if this is a guard page violation</span>
01622             <span class="comment">// and if so, should the user's stack be extended.</span>
01623             <span class="comment">//</span>
01624 
01625             <span class="keywordflow">if</span> (status == STATUS_GUARD_PAGE_VIOLATION) {
01626                 <span class="keywordflow">return</span> <a class="code" href="../../d4/d8/mi_8h.html#a834">MiCheckForUserStackOverflow</a> (VirtualAddress);
01627             }
01628 
01629             <span class="keywordflow">return</span> status;
01630         }
01631     }
01632 
01633     <span class="comment">//</span>
01634     <span class="comment">// This is a page fault, invoke the page fault handler.</span>
01635     <span class="comment">//</span>
01636 
01637     <span class="keywordflow">if</span> (PointerProtoPte != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01638 
01639         <span class="comment">//</span>
01640         <span class="comment">// Lock page containing prototype PTEs in memory by</span>
01641         <span class="comment">// incrementing the reference count for the page.</span>
01642         <span class="comment">//</span>
01643 
01644 
01645         <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a178">MI_IS_PHYSICAL_ADDRESS</a>(PointerProtoPte)) {
01646             PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerProtoPte);
01647             <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
01648             <span class="keywordflow">if</span> (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) {
01649                 <a class="code" href="../../d0/d2/mmsup_8c.html#a11">MiMakeSystemAddressValidPfn</a> (PointerProtoPte);
01650             }
01651             Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber);
01652             <a class="code" href="../../d4/d8/mi_8h.html#a186">MI_ADD_LOCKED_PAGE_CHARGE</a>(Pfn1, 2);
01653             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount += 1;
01654             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount &gt; 1);
01655             <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
01656         }
01657     }
01658     status = <a class="code" href="../../d8/d2/pagfault_8c.html#a11">MiDispatchFault</a> (StoreInstruction,
01659                               VirtualAddress,
01660                               PointerPte,
01661                               PointerProtoPte,
01662                               CurrentProcess,
01663                               &amp;ApcNeeded);
01664 
01665 <span class="preprocessor">#if DBG</span>
01666 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (ApcNeeded == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01667         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;NestedFaultCount == 0);
01668         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;ApcNeeded == 0);
01669     }
01670 <span class="preprocessor">#endif</span>
01671 <span class="preprocessor"></span>
01672     <span class="keywordflow">if</span> (PointerProtoPte != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01673 
01674         <span class="comment">//</span>
01675         <span class="comment">// Unlock page containing prototype PTEs.</span>
01676         <span class="comment">//</span>
01677 
01678         <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a178">MI_IS_PHYSICAL_ADDRESS</a>(PointerProtoPte)) {
01679             <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
01680             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount &gt; 1);
01681             <a class="code" href="../../d4/d8/mi_8h.html#a189">MI_REMOVE_LOCKED_PAGE_CHARGE</a>(Pfn1, 3);
01682             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount -= 1;
01683             <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
01684         }
01685     }
01686 
01687 ReturnStatus1:
01688 
01689     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (KeGetCurrentIrql() &lt;= <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>);
01690     <span class="keywordflow">if</span> (CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o9">AllowWorkingSetAdjustment</a> == <a class="code" href="../../d4/d8/mi_8h.html#a32">MM_GROW_WSLE_HASH</a>) {
01691         <a class="code" href="../../d4/d0/wslist_8c.html#a33">MiGrowWsleHash</a> (&amp;CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>);
01692         <a class="code" href="../../d4/d8/mi_8h.html#a142">LOCK_EXPANSION_IF_ALPHA</a> (OldIrql);
01693         CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o9">AllowWorkingSetAdjustment</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01694         <a class="code" href="../../d4/d8/mi_8h.html#a143">UNLOCK_EXPANSION_IF_ALPHA</a> (OldIrql);
01695     }
01696 
01697 ReturnStatus2:
01698 
01699     PageFrameIndex = CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o4">WorkingSetSize</a> - CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o16">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o5">MinimumWorkingSetSize</a>;
01700 
01701     <a class="code" href="../../d4/d8/mi_8h.html#a158">UNLOCK_WS</a> (CurrentProcess);
01702     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (KeGetCurrentIrql() == PreviousIrql);
01703 
01704     <span class="keywordflow">if</span> (ApcNeeded == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01705         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;NestedFaultCount == 0);
01706         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;ApcNeeded == 0);
01707         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (KeGetCurrentIrql() == <a class="code" href="../../d1/d3/ppcdef_8h.html#a21">PASSIVE_LEVEL</a>);
01708         <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>, &amp;PreviousIrql);
01709         <a class="code" href="../../d4/d6/iosubs_8c.html#a136">IoRetryIrpCompletions</a> ();
01710         <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a> (PreviousIrql);
01711     }
01712 
01713     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> &lt; <a class="code" href="../../d4/d8/mi_8h.html#a588">MmMoreThanEnoughFreePages</a>) {
01714 
01715         <span class="keywordflow">if</span> (((SPFN_NUMBER)PageFrameIndex &gt; 100) &amp;&amp;
01716             (<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;Tcb.Priority &gt;= LOW_REALTIME_PRIORITY)) {
01717 
01718             <span class="comment">//</span>
01719             <span class="comment">// This thread is realtime and is well over the process'</span>
01720             <span class="comment">// working set minimum.  Delay execution so the trimmer &amp; the</span>
01721             <span class="comment">// modified page writer get a quick shot at making pages.</span>
01722             <span class="comment">//</span>
01723 
01724             <a class="code" href="../../d1/d7/wait_8c.html#a2">KeDelayExecutionThread</a> (<a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, &amp;<a class="code" href="../../d4/d8/mi_8h.html#a420">MmShortTime</a>);
01725         }
01726     }
01727 
01728     NotifyRoutine = <a class="code" href="../../d4/d8/mi_8h.html#a746">MmPageFaultNotifyRoutine</a>;
01729     <span class="keywordflow">if</span> (NotifyRoutine) {
01730         <span class="keywordflow">if</span> (status != STATUS_SUCCESS) {
01731             (*NotifyRoutine) (
01732                 status,
01733                 VirtualAddress,
01734                 TrapInformation
01735                 );
01736         }
01737     }
01738 
01739     <span class="keywordflow">return</span> status;
01740 
01741 AccessViolation:
01742     <span class="keywordflow">if</span> (SessionAddress == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01743         <a class="code" href="../../d4/d8/mi_8h.html#a408">UNLOCK_SESSION_SPACE_WS</a> (PreviousIrql);
01744     }
01745     <span class="keywordflow">else</span> {
01746         <a class="code" href="../../d4/d8/mi_8h.html#a145">UNLOCK_SYSTEM_WS</a> (PreviousIrql);
01747     }
01748     <span class="keywordflow">return</span> STATUS_ACCESS_VIOLATION;
01749 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:50 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
