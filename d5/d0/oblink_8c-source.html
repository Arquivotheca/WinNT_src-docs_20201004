<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: oblink.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>oblink.c</h1><a href="../../d4/d1/oblink_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    oblink.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    Symbolic Link Object routines</span>
00012 <span class="comment"></span>
00013 <span class="comment">Author:</span>
00014 <span class="comment"></span>
00015 <span class="comment">    Steve Wood (stevewo) 3-Aug-1989</span>
00016 <span class="comment"></span>
00017 <span class="comment">Revision History:</span>
00018 <span class="comment"></span>
00019 <span class="comment">--*/</span>
00020 
00021 <span class="preprocessor">#include "<a class="code" href="../../d5/d1/obp_8h.html">obp.h</a>"</span>
00022 
00023 <span class="preprocessor">#if defined(ALLOC_PRAGMA)</span>
00024 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,NtCreateSymbolicLinkObject)</span>
00025 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,NtOpenSymbolicLinkObject)</span>
00026 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,NtQuerySymbolicLinkObject)</span>
00027 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,ObpParseSymbolicLink)</span>
00028 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,ObpDeleteSymbolicLink)</span>
00029 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00030 <span class="preprocessor"></span>
00031 <span class="comment">//</span>
00032 <span class="comment">//  This is the object type for device objects.</span>
00033 <span class="comment">//</span>
00034 
<a name="l00035"></a><a class="code" href="../../d4/d1/oblink_8c.html#a3">00035</a> <span class="keyword">extern</span> <a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> <a class="code" href="../../d3/d5/iodata_8c.html#a35">IoDeviceObjectType</a>;
00036 
00037 <span class="comment">//</span>
00038 <span class="comment">//  Local procedure prototypes</span>
00039 <span class="comment">//</span>
00040 
<a name="l00041"></a><a class="code" href="../../d4/d1/oblink_8c.html#a0">00041</a> <span class="preprocessor">#define CREATE_SYMBOLIC_LINK 0</span>
<a name="l00042"></a><a class="code" href="../../d4/d1/oblink_8c.html#a1">00042</a> <span class="preprocessor"></span><span class="preprocessor">#define DELETE_SYMBOLIC_LINK 1</span>
00043 <span class="preprocessor"></span>
00044 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00045 <a class="code" href="../../d4/d1/oblink_8c.html#a4">ObpProcessDosDeviceSymbolicLink</a> (
00046     <a class="code" href="../../d2/d6/struct__OBJECT__SYMBOLIC__LINK.html">POBJECT_SYMBOLIC_LINK</a> SymbolicLink,
00047     ULONG Action
00048     );
00049 
00050 
00051 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00052"></a><a class="code" href="../../d4/d1/oblink_8c.html#a5">00052</a> <a class="code" href="../../d4/d1/oblink_8c.html#a5">NtCreateSymbolicLinkObject</a> (
00053     OUT PHANDLE LinkHandle,
00054     IN ACCESS_MASK DesiredAccess,
00055     IN POBJECT_ATTRIBUTES ObjectAttributes,
00056     IN PUNICODE_STRING LinkTarget
00057     )
00058 
00059 <span class="comment">/*++</span>
00060 <span class="comment"></span>
00061 <span class="comment">Routine Description:</span>
00062 <span class="comment"></span>
00063 <span class="comment">    This function creates a symbolic link object, sets it initial value to</span>
00064 <span class="comment">    value specified in the LinkTarget parameter, and opens a handle to the</span>
00065 <span class="comment">    object with the specified desired access.</span>
00066 <span class="comment"></span>
00067 <span class="comment">Arguments:</span>
00068 <span class="comment"></span>
00069 <span class="comment">    LinkHandle - Supplies a pointer to a variable that will receive the</span>
00070 <span class="comment">        symbolic link object handle.</span>
00071 <span class="comment"></span>
00072 <span class="comment">    DesiredAccess - Supplies the desired types of access for the symbolic link</span>
00073 <span class="comment">        object.</span>
00074 <span class="comment"></span>
00075 <span class="comment">    ObjectAttributes - Supplies a pointer to an object attributes structure.</span>
00076 <span class="comment"></span>
00077 <span class="comment">    LinkTarget - Supplies the target name for the symbolic link object.</span>
00078 <span class="comment"></span>
00079 <span class="comment">Return Value:</span>
00080 <span class="comment"></span>
00081 <span class="comment">    An appropriate status value</span>
00082 <span class="comment"></span>
00083 <span class="comment">--*/</span>
00084 
00085 {
00086     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00087     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00088     <a class="code" href="../../d2/d6/struct__OBJECT__SYMBOLIC__LINK.html">POBJECT_SYMBOLIC_LINK</a> SymbolicLink;
00089     PVOID Object;
00090     HANDLE <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>;
00091     UNICODE_STRING CapturedLinkTarget;
00092 
00093     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00094 
00095     <span class="comment">//</span>
00096     <span class="comment">//  Get previous processor mode and probe output arguments if necessary.</span>
00097     <span class="comment">//</span>
00098 
00099     PreviousMode = KeGetPreviousMode();
00100 
00101     <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00102 
00103         <span class="keywordflow">try</span> {
00104 
00105             <span class="comment">//</span>
00106             <span class="comment">//  **** we probably don't need to do this first one because</span>
00107             <span class="comment">//  the ob create object will cause the probe to happen for us</span>
00108             <span class="comment">//</span>
00109 
00110             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>( <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00111                           <span class="keyword">sizeof</span>( OBJECT_ATTRIBUTES ),
00112                           <span class="keyword">sizeof</span>( ULONG ));
00113 
00114             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>( LinkTarget,
00115                           <span class="keyword">sizeof</span>( *LinkTarget ),
00116                           <span class="keyword">sizeof</span>( UCHAR ));
00117 
00118             CapturedLinkTarget = *LinkTarget;
00119 
00120             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>( CapturedLinkTarget.Buffer,
00121                           CapturedLinkTarget.MaximumLength,
00122                           <span class="keyword">sizeof</span>( UCHAR ));
00123 
00124             <a class="code" href="../../d5/d8/ex_8h.html#a35">ProbeForWriteHandle</a>( LinkHandle );
00125 
00126         } except( <a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a> ) {
00127 
00128             <span class="keywordflow">return</span>( GetExceptionCode() );
00129         }
00130 
00131     } <span class="keywordflow">else</span> {
00132 
00133         CapturedLinkTarget = *LinkTarget;
00134     }
00135 
00136     <span class="comment">//</span>
00137     <span class="comment">//  Check if there is an odd MaximumLength</span>
00138     <span class="comment">//</span>
00139 
00140     <span class="keywordflow">if</span> (CapturedLinkTarget.MaximumLength % <span class="keyword">sizeof</span>( WCHAR )) {
00141 
00142         <span class="comment">//</span>
00143         <span class="comment">//  Round down the MaximumLength to a valid even size</span>
00144         <span class="comment">//</span>
00145 
00146         CapturedLinkTarget.MaximumLength = (CapturedLinkTarget.MaximumLength / <span class="keyword">sizeof</span>( WCHAR )) * <span class="keyword">sizeof</span>( WCHAR );
00147     }
00148 
00149     <span class="comment">//</span>
00150     <span class="comment">//  Error if link target name length is odd, the length is greater than</span>
00151     <span class="comment">//  the maximum length, or zero and creating.</span>
00152     <span class="comment">//</span>
00153 
00154     <span class="keywordflow">if</span> ((CapturedLinkTarget.MaximumLength == 0) ||
00155         (CapturedLinkTarget.Length &gt; CapturedLinkTarget.MaximumLength) ||
00156         (CapturedLinkTarget.Length % <span class="keyword">sizeof</span>( WCHAR ))) {
00157         
00158         KdPrint(( <span class="stringliteral">"OB: Invalid symbolic link target - %wZ\n"</span>, &amp;CapturedLinkTarget ));
00159 
00160         <span class="keywordflow">return</span>( STATUS_INVALID_PARAMETER );
00161     }
00162 
00163     <span class="comment">//</span>
00164     <span class="comment">//  Create the symbolic link object</span>
00165     <span class="comment">//</span>
00166 
00167     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d0/obcreate_8c.html#a5">ObCreateObject</a>( PreviousMode,
00168                              <a class="code" href="../../d5/d1/obp_8h.html#a43">ObpSymbolicLinkObjectType</a>,
00169                              <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00170                              PreviousMode,
00171                              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00172                              <span class="keyword">sizeof</span>( *SymbolicLink ),
00173                              0,
00174                              0,
00175                              (PVOID *)&amp;SymbolicLink );
00176 
00177     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00178 
00179         <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00180     }
00181 
00182     <span class="comment">//</span>
00183     <span class="comment">//  Fill in symbolic link object with link target name string</span>
00184     <span class="comment">//</span>
00185 
00186     <a class="code" href="../../d7/d0/ke_2miscc_8c.html#a3">KeQuerySystemTime</a>( &amp;SymbolicLink-&gt;CreationTime );
00187 
00188     SymbolicLink-&gt;DosDeviceDriveIndex = 0;
00189     SymbolicLink-&gt;LinkTargetObject = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00190 
00191     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;SymbolicLink-&gt;LinkTargetRemaining,  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00192 
00193     SymbolicLink-&gt;LinkTarget.MaximumLength = CapturedLinkTarget.MaximumLength;
00194     SymbolicLink-&gt;LinkTarget.Length = CapturedLinkTarget.Length;
00195     SymbolicLink-&gt;LinkTarget.Buffer = (PWCH)<a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
00196                                                                    CapturedLinkTarget.MaximumLength,
00197                                                                    'tmyS' );
00198 
00199     <span class="keywordflow">if</span> (SymbolicLink-&gt;LinkTarget.Buffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00200 
00201         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( SymbolicLink );
00202 
00203         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00204     }
00205 
00206     <span class="keywordflow">try</span> {
00207 
00208         RtlMoveMemory( SymbolicLink-&gt;LinkTarget.Buffer,
00209                        CapturedLinkTarget.Buffer,
00210                        CapturedLinkTarget.MaximumLength );
00211 
00212     } except( <a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a> ) {
00213 
00214         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( SymbolicLink );
00215 
00216         <span class="keywordflow">return</span>( GetExceptionCode() );
00217     }
00218 
00219     <span class="comment">//</span>
00220     <span class="comment">//  Insert symbolic link object in the current processes object table,</span>
00221     <span class="comment">//  set symbolic link handle value and return status.</span>
00222     <span class="comment">//</span>
00223 
00224     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d1/obinsert_8c.html#a0">ObInsertObject</a>( SymbolicLink,
00225                              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00226                              DesiredAccess,
00227                              0,
00228                              (PVOID *)&amp;Object,
00229                              &amp;<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> );
00230 
00231     <span class="keywordflow">try</span> {
00232 
00233         *LinkHandle = <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>;
00234 
00235     } except( <a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a> ) {
00236 
00237         <span class="comment">//</span>
00238         <span class="comment">// Fall through, since we do not want to undo what we have done.</span>
00239         <span class="comment">//</span>
00240     }
00241 
00242     <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00243 }
00244 
00245 
00246 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00247"></a><a class="code" href="../../d4/d1/oblink_8c.html#a6">00247</a> <a class="code" href="../../d4/d1/oblink_8c.html#a6">NtOpenSymbolicLinkObject</a> (
00248     OUT PHANDLE LinkHandle,
00249     IN ACCESS_MASK DesiredAccess,
00250     IN POBJECT_ATTRIBUTES ObjectAttributes
00251     )
00252 
00253 <span class="comment">/*++</span>
00254 <span class="comment"></span>
00255 <span class="comment">Routine Description:</span>
00256 <span class="comment"></span>
00257 <span class="comment">    This function opens a handle to an symbolic link object with the specified</span>
00258 <span class="comment">    desired access.</span>
00259 <span class="comment"></span>
00260 <span class="comment">Arguments:</span>
00261 <span class="comment"></span>
00262 <span class="comment">    LinkHandle - Supplies a pointer to a variable that will receive the</span>
00263 <span class="comment">        symbolic link object handle.</span>
00264 <span class="comment"></span>
00265 <span class="comment">    DesiredAccess - Supplies the desired types of access for the symbolic link</span>
00266 <span class="comment">        object.</span>
00267 <span class="comment"></span>
00268 <span class="comment">    ObjectAttributes - Supplies a pointer to an object attributes structure.</span>
00269 <span class="comment"></span>
00270 <span class="comment">Return Value:</span>
00271 <span class="comment"></span>
00272 <span class="comment">    An appropriate status value</span>
00273 <span class="comment"></span>
00274 <span class="comment">--*/</span>
00275 
00276 {
00277     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00278     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00279     HANDLE <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>;
00280 
00281     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00282 
00283     <span class="comment">//</span>
00284     <span class="comment">//  Get previous processor mode and probe output arguments if necessary.</span>
00285     <span class="comment">//  The object attributes does not need to be probed because the</span>
00286     <span class="comment">//  ObOpenObjectByName does the probe for us</span>
00287     <span class="comment">//</span>
00288 
00289     PreviousMode = KeGetPreviousMode();
00290 
00291     <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00292 
00293         <span class="keywordflow">try</span> {
00294 
00295             <a class="code" href="../../d5/d8/ex_8h.html#a35">ProbeForWriteHandle</a>( LinkHandle );
00296 
00297         } except( <a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a> ) {
00298 
00299             <span class="keywordflow">return</span>( GetExceptionCode() );
00300         }
00301     }
00302 
00303     <span class="comment">//</span>
00304     <span class="comment">//  Open handle to the symbolic link object with the specified desired</span>
00305     <span class="comment">//  access, set symbolic link handle value, and return service completion</span>
00306     <span class="comment">//  status.</span>
00307     <span class="comment">//</span>
00308 
00309     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a2">ObOpenObjectByName</a>( <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00310                                  <a class="code" href="../../d5/d1/obp_8h.html#a43">ObpSymbolicLinkObjectType</a>,
00311                                  PreviousMode,
00312                                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00313                                  DesiredAccess,
00314                                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00315                                  &amp;<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> );
00316 
00317     <span class="keywordflow">try</span> {
00318 
00319         *LinkHandle = <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>;
00320 
00321     } except( <a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a> ) {
00322 
00323         <span class="comment">//</span>
00324         <span class="comment">//  Fall through, since we do not want to undo what we have done.</span>
00325         <span class="comment">//</span>
00326     }
00327 
00328     <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00329 }
00330 
00331 
00332 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00333"></a><a class="code" href="../../d4/d1/oblink_8c.html#a7">00333</a> <a class="code" href="../../d4/d1/oblink_8c.html#a7">NtQuerySymbolicLinkObject</a> (
00334     IN HANDLE LinkHandle,
00335     IN OUT PUNICODE_STRING LinkTarget,
00336     OUT PULONG ReturnedLength OPTIONAL
00337     )
00338 
00339 <span class="comment">/*++</span>
00340 <span class="comment"></span>
00341 <span class="comment">Routine Description:</span>
00342 <span class="comment"></span>
00343 <span class="comment">    This function queries the state of a symbolic link object and returns the</span>
00344 <span class="comment">    requested information in the specified record structure.</span>
00345 <span class="comment"></span>
00346 <span class="comment">Arguments:</span>
00347 <span class="comment"></span>
00348 <span class="comment">    LinkHandle - Supplies a handle to a symbolic link object.  This handle</span>
00349 <span class="comment">        must have SYMBOLIC_LINK_QUERY access granted.</span>
00350 <span class="comment"></span>
00351 <span class="comment">    LinkTarget - Supplies a pointer to a record that is to receive the</span>
00352 <span class="comment">        target name of the symbolic link object.</span>
00353 <span class="comment"></span>
00354 <span class="comment">    ReturnedLength - Optionally receives the maximum length, in bytes, of</span>
00355 <span class="comment">        the link target on return</span>
00356 <span class="comment"></span>
00357 <span class="comment">Return Value:</span>
00358 <span class="comment"></span>
00359 <span class="comment">    An appropriate status value</span>
00360 <span class="comment"></span>
00361 <span class="comment">--*/</span>
00362 
00363 {
00364     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00365     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00366     <a class="code" href="../../d2/d6/struct__OBJECT__SYMBOLIC__LINK.html">POBJECT_SYMBOLIC_LINK</a> SymbolicLink;
00367     UNICODE_STRING CapturedLinkTarget;
00368 
00369     <span class="comment">//</span>
00370     <span class="comment">//  Get previous processor mode and probe output arguments if necessary.</span>
00371     <span class="comment">//</span>
00372 
00373     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00374 
00375     PreviousMode = KeGetPreviousMode();
00376 
00377     <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00378 
00379         <span class="keywordflow">try</span> {
00380 
00381             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>( LinkTarget,
00382                           <span class="keyword">sizeof</span>( *LinkTarget ),
00383                           <span class="keyword">sizeof</span>( WCHAR ) );
00384 
00385             <a class="code" href="../../d5/d8/ex_8h.html#a34">ProbeForWriteUshort</a>( &amp;LinkTarget-&gt;Length );
00386 
00387             <a class="code" href="../../d5/d8/ex_8h.html#a34">ProbeForWriteUshort</a>( &amp;LinkTarget-&gt;MaximumLength );
00388 
00389             CapturedLinkTarget = *LinkTarget;
00390 
00391             <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>( CapturedLinkTarget.Buffer,
00392                            CapturedLinkTarget.MaximumLength,
00393                            <span class="keyword">sizeof</span>( UCHAR ) );
00394 
00395             <span class="keywordflow">if</span> (ARGUMENT_PRESENT( ReturnedLength )) {
00396 
00397                 <a class="code" href="../../d5/d8/ex_8h.html#a40">ProbeForWriteUlong</a>( ReturnedLength );
00398             }
00399 
00400         } except( <a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a> ) {
00401 
00402             <span class="keywordflow">return</span>( GetExceptionCode() );
00403         }
00404 
00405     } <span class="keywordflow">else</span> {
00406 
00407         CapturedLinkTarget = *LinkTarget;
00408     }
00409 
00410     <span class="comment">//</span>
00411     <span class="comment">//  Reference symbolic link object by handle, read current state, deference</span>
00412     <span class="comment">//  symbolic link object, fill in target name structure and return service</span>
00413     <span class="comment">//  status.</span>
00414     <span class="comment">//</span>
00415 
00416     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>( LinkHandle,
00417                                         SYMBOLIC_LINK_QUERY,
00418                                         <a class="code" href="../../d5/d1/obp_8h.html#a43">ObpSymbolicLinkObjectType</a>,
00419                                         PreviousMode,
00420                                         (PVOID *)&amp;SymbolicLink,
00421                                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00422 
00423     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00424 
00425         <a class="code" href="../../d5/d1/obp_8h.html#a8">ObpEnterObjectTypeMutex</a>( <a class="code" href="../../d5/d1/obp_8h.html#a43">ObpSymbolicLinkObjectType</a> );
00426 
00427         <span class="comment">//</span>
00428         <span class="comment">//  If the caller wants a return length and what we found can easily</span>
00429         <span class="comment">//  fit in the output buffer then we copy into the output buffer all</span>
00430         <span class="comment">//  the bytes from the link.</span>
00431         <span class="comment">//</span>
00432         <span class="comment">//  If the caller did not want a return length and we found can still</span>
00433         <span class="comment">//  easily fit in the output buffer then copy over the bytes that just</span>
00434         <span class="comment">//  make up the string and nothing extra</span>
00435         <span class="comment">//</span>
00436 
00437         <span class="keywordflow">if</span> ((ARGUMENT_PRESENT( ReturnedLength ) &amp;&amp;
00438                 (SymbolicLink-&gt;LinkTarget.MaximumLength &lt;= CapturedLinkTarget.MaximumLength))
00439 
00440                     ||
00441 
00442             (!ARGUMENT_PRESENT( ReturnedLength ) &amp;&amp;
00443                 (SymbolicLink-&gt;LinkTarget.Length &lt;= CapturedLinkTarget.MaximumLength)) ) {
00444 
00445             <span class="keywordflow">try</span> {
00446 
00447                 RtlMoveMemory( CapturedLinkTarget.Buffer,
00448                                SymbolicLink-&gt;LinkTarget.Buffer,
00449                                ARGUMENT_PRESENT( ReturnedLength ) ? SymbolicLink-&gt;LinkTarget.MaximumLength
00450                                                                   : SymbolicLink-&gt;LinkTarget.Length );
00451 
00452                 LinkTarget-&gt;Length = SymbolicLink-&gt;LinkTarget.Length;
00453 
00454                 <span class="keywordflow">if</span> (ARGUMENT_PRESENT( ReturnedLength )) {
00455 
00456                     *ReturnedLength = SymbolicLink-&gt;LinkTarget.MaximumLength;
00457                 }
00458 
00459             } except( <a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a> ) {
00460 
00461                 <span class="comment">//</span>
00462                 <span class="comment">// Fall through, since we do cannot undo what we have done.</span>
00463                 <span class="comment">//</span>
00464             }
00465 
00466         } <span class="keywordflow">else</span> {
00467 
00468             <span class="comment">//</span>
00469             <span class="comment">//  The output buffer is just too small for the link target, but</span>
00470             <span class="comment">//  we'll tell the user how much is needed if they asked for that</span>
00471             <span class="comment">//  return value</span>
00472             <span class="comment">//</span>
00473 
00474             <span class="keywordflow">if</span> (ARGUMENT_PRESENT( ReturnedLength )) {
00475 
00476                 <span class="keywordflow">try</span> {
00477 
00478                     *ReturnedLength = SymbolicLink-&gt;LinkTarget.MaximumLength;
00479 
00480                 } except( <a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a> ) {
00481 
00482                     <span class="comment">//</span>
00483                     <span class="comment">// Fall through, since we do cannot undo what we have done.</span>
00484                     <span class="comment">//</span>
00485                 }
00486             }
00487 
00488             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_BUFFER_TOO_SMALL;
00489         }
00490 
00491         <a class="code" href="../../d5/d1/obp_8h.html#a9">ObpLeaveObjectTypeMutex</a>( <a class="code" href="../../d5/d1/obp_8h.html#a43">ObpSymbolicLinkObjectType</a> );
00492 
00493         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( SymbolicLink );
00494     }
00495 
00496     <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00497 }
00498 
00499 
00500 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00501"></a><a class="code" href="../../d5/d1/obp_8h.html#a64">00501</a> <a class="code" href="../../d5/d1/obp_8h.html#a64">ObpParseSymbolicLink</a> (
00502     IN PVOID ParseObject,
00503     IN PVOID ObjectType,
00504     IN <a class="code" href="../../d2/d5/struct__ACCESS__STATE.html">PACCESS_STATE</a> AccessState,
00505     IN KPROCESSOR_MODE AccessMode,
00506     IN ULONG Attributes,
00507     IN OUT PUNICODE_STRING CompleteName,
00508     IN OUT PUNICODE_STRING RemainingName,
00509     IN OUT PVOID Context OPTIONAL,
00510     IN PSECURITY_QUALITY_OF_SERVICE SecurityQos OPTIONAL,
00511     OUT PVOID *Object
00512     )
00513 
00514 <span class="comment">/*++</span>
00515 <span class="comment"></span>
00516 <span class="comment">Routine Description:</span>
00517 <span class="comment"></span>
00518 <span class="comment">    This is the call back routine for parsing symbolic link objects.  It is invoked</span>
00519 <span class="comment">    as part of ObpLookupObjectName</span>
00520 <span class="comment"></span>
00521 <span class="comment">Arguments:</span>
00522 <span class="comment"></span>
00523 <span class="comment">    ParseObject - This will actually be a symbolic link object</span>
00524 <span class="comment"></span>
00525 <span class="comment">    ObjectType - Specifies the type of the object to lookup</span>
00526 <span class="comment"></span>
00527 <span class="comment">    AccessState - Current access state, describing already granted access</span>
00528 <span class="comment">        types, the privileges used to get them, and any access types yet to</span>
00529 <span class="comment">        be granted.  The access masks may not contain any generic access</span>
00530 <span class="comment">        types.</span>
00531 <span class="comment"></span>
00532 <span class="comment">    AccessMode - Specifies the callers processor mode</span>
00533 <span class="comment"></span>
00534 <span class="comment">    Attributes - Specifies the attributes for the lookup (e.g., case</span>
00535 <span class="comment">        insensitive)</span>
00536 <span class="comment"></span>
00537 <span class="comment">    CompleteName - Supplies a pointer to the complete name that we are trying</span>
00538 <span class="comment">        to open.  On return this could be modified to fit the new reparse</span>
00539 <span class="comment">        buffer</span>
00540 <span class="comment"></span>
00541 <span class="comment">    RemainingName - Supplies a pointer to the remaining name that we are</span>
00542 <span class="comment">        trying to open.  On return this will point to what remains after</span>
00543 <span class="comment">        we processed the symbolic link.</span>
00544 <span class="comment"></span>
00545 <span class="comment">    Context - Unused</span>
00546 <span class="comment"></span>
00547 <span class="comment">    SecurityQos - Unused</span>
00548 <span class="comment"></span>
00549 <span class="comment">    Object - Receives a pointer to the symbolic link object that we</span>
00550 <span class="comment">        resolve to</span>
00551 <span class="comment"></span>
00552 <span class="comment">Return Value:</span>
00553 <span class="comment"></span>
00554 <span class="comment">    STATUS_REPARSE_OBJECT if the parse object is already a snapped</span>
00555 <span class="comment">        symbolic link meaning we've modified the remaining name and</span>
00556 <span class="comment">        and have returned the target object of the symbolic link</span>
00557 <span class="comment"></span>
00558 <span class="comment"></span>
00559 <span class="comment">    STATUS_REPARSE if the parse object has not been snapped.  In this</span>
00560 <span class="comment">        case the Complete name has been modified with the link target</span>
00561 <span class="comment">        name added in front of the remaining name.  The parameters</span>
00562 <span class="comment">        remaining name and object must now be ignored by the caller</span>
00563 <span class="comment"></span>
00564 <span class="comment">    An appropriate error value</span>
00565 <span class="comment"></span>
00566 <span class="comment">--*/</span>
00567 
00568 {
00569     ULONG NewLength;
00570     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> Length;
00571     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> MaximumLength;
00572     PWCHAR <a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a>, NewRemainingName;
00573     ULONG InsertAmount;
00574     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00575     <a class="code" href="../../d2/d6/struct__OBJECT__SYMBOLIC__LINK.html">POBJECT_SYMBOLIC_LINK</a> SymbolicLink;
00576     PUNICODE_STRING LinkTargetName;
00577 
00578     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00579 
00580     <span class="comment">//</span>
00581     <span class="comment">//  This routine needs to be synchonized with the delete symbolic link</span>
00582     <span class="comment">//  operation.  Which uses the root directory mutex.</span>
00583     <span class="comment">//</span>
00584 
00585     <a class="code" href="../../d5/d1/obp_8h.html#a10">ObpEnterRootDirectoryMutex</a>();
00586 
00587     <span class="keywordflow">try</span> {
00588 
00589         *Object = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00590 
00591         <span class="comment">//</span>
00592         <span class="comment">//  If there isn't any name remaining and the caller gave us</span>
00593         <span class="comment">//  an object type then we'll reference the parse object.  If</span>
00594         <span class="comment">//  this is successful then that's the object we return.  Otherwise</span>
00595         <span class="comment">//  if the status is anything but a type mismatch then we'll</span>
00596         <span class="comment">//  return that error status</span>
00597         <span class="comment">//</span>
00598 
00599         <span class="keywordflow">if</span> (RemainingName-&gt;Length == 0) {
00600 
00601             <span class="keywordflow">if</span> ( ObjectType ) {
00602 
00603                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a6">ObReferenceObjectByPointer</a>( ParseObject,
00604                                                      0,
00605                                                      ObjectType,
00606                                                      AccessMode );
00607 
00608                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00609 
00610                     *Object = ParseObject;
00611 
00612                     leave;
00613 
00614                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_OBJECT_TYPE_MISMATCH) {
00615 
00616                     leave;
00617                 }
00618            }
00619 
00620         <span class="comment">//</span>
00621         <span class="comment">//  If the remaining name does not start with a "\" then</span>
00622         <span class="comment">//  its is illformed and we'll call it a type mismatch</span>
00623         <span class="comment">//</span>
00624 
00625         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*(RemainingName-&gt;Buffer) != OBJ_NAME_PATH_SEPARATOR) {
00626 
00627             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_OBJECT_TYPE_MISMATCH;
00628             leave;
00629         }
00630 
00631         <span class="comment">//</span>
00632         <span class="comment">//  A symbolic link has been encountered. See if this link has been snapped</span>
00633         <span class="comment">//  to a particular object.</span>
00634         <span class="comment">//</span>
00635 
00636         SymbolicLink = (<a class="code" href="../../d2/d6/struct__OBJECT__SYMBOLIC__LINK.html">POBJECT_SYMBOLIC_LINK</a>)ParseObject;
00637 
00638         <span class="keywordflow">if</span> (SymbolicLink-&gt;<a class="code" href="../../d2/d6/struct__OBJECT__SYMBOLIC__LINK.html#o3">LinkTargetObject</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00639 
00640             <span class="comment">//</span>
00641             <span class="comment">//  This is a snapped link.  Get the remaining portion of the</span>
00642             <span class="comment">//  symbolic link target, if any.</span>
00643             <span class="comment">//</span>
00644 
00645             LinkTargetName = &amp;SymbolicLink-&gt;<a class="code" href="../../d2/d6/struct__OBJECT__SYMBOLIC__LINK.html#o2">LinkTargetRemaining</a>;
00646 
00647             <span class="keywordflow">if</span> (LinkTargetName-&gt;Length == 0) {
00648 
00649                 <span class="comment">//</span>
00650                 <span class="comment">//  Remaining link target string is zero, so return to caller</span>
00651                 <span class="comment">//  quickly with snapped object pointer and remaining object name</span>
00652                 <span class="comment">//  which we haven't touched yet.</span>
00653                 <span class="comment">//</span>
00654 
00655                 *Object = SymbolicLink-&gt;<a class="code" href="../../d2/d6/struct__OBJECT__SYMBOLIC__LINK.html#o3">LinkTargetObject</a>;
00656 
00657                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_REPARSE_OBJECT;
00658                 leave;
00659             }
00660 
00661             <span class="comment">//</span>
00662             <span class="comment">//  We have a snapped symbolic link that has additional text.</span>
00663             <span class="comment">//  Insert that in front of the current remaining name, preserving</span>
00664             <span class="comment">//  and text between CompleteName and RemainingName</span>
00665             <span class="comment">//</span>
00666 
00667             InsertAmount = LinkTargetName-&gt;Length;
00668 
00669             <span class="keywordflow">if</span> ((LinkTargetName-&gt;Buffer[ (InsertAmount / <span class="keyword">sizeof</span>( WCHAR )) - 1 ] == OBJ_NAME_PATH_SEPARATOR)
00670 
00671                     &amp;&amp;
00672 
00673                 (*(RemainingName-&gt;Buffer) == OBJ_NAME_PATH_SEPARATOR)) {
00674 
00675                 <span class="comment">//</span>
00676                 <span class="comment">//  Both the link target name ends in a "\" and the remaining</span>
00677                 <span class="comment">//  starts with a "\" but we only need one when we're done</span>
00678                 <span class="comment">//</span>
00679 
00680                 InsertAmount -= <span class="keyword">sizeof</span>( WCHAR );
00681             }
00682 
00683             <span class="comment">//</span>
00684             <span class="comment">//  **** don't see why we need to bias the differnce between two</span>
00685             <span class="comment">//  pointers with * sizeof(wchar)</span>
00686             <span class="comment">//</span>
00687 
00688             NewLength = (ULONG)(((RemainingName-&gt;Buffer - CompleteName-&gt;Buffer) * <span class="keyword">sizeof</span>( WCHAR )) +
00689                         InsertAmount +
00690                         RemainingName-&gt;Length);
00691 
00692             <span class="keywordflow">if</span> (NewLength &gt; 0xFFF0) {
00693 
00694                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NAME_TOO_LONG;
00695                 leave;
00696             }
00697 
00698             Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)NewLength;
00699 
00700             <span class="comment">//</span>
00701             <span class="comment">//  Now check if the new computed length is too big for the input</span>
00702             <span class="comment">//  buffer containing the complete name</span>
00703             <span class="comment">//</span>
00704 
00705             <span class="keywordflow">if</span> (CompleteName-&gt;MaximumLength &lt;= Length) {
00706 
00707                 <span class="comment">//</span>
00708                 <span class="comment">//  The new concatentated name is larger than the buffer supplied for</span>
00709                 <span class="comment">//  the complete name.  Allocate space for this new string</span>
00710                 <span class="comment">//</span>
00711 
00712                 MaximumLength = Length + <span class="keyword">sizeof</span>( UNICODE_NULL );
00713                 <a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a> = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, MaximumLength, 'mNbO' );
00714 
00715                 <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00716 
00717                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
00718                     leave;
00719                 }
00720 
00721                 <span class="comment">//</span>
00722                 <span class="comment">//  Calculate the pointer within this buffer for the remaining</span>
00723                 <span class="comment">//  name.  This value has not been biased by the new link</span>
00724                 <span class="comment">//  target name</span>
00725                 <span class="comment">//</span>
00726 
00727                 NewRemainingName = <a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a> + (RemainingName-&gt;Buffer - CompleteName-&gt;Buffer);
00728 
00729                 <span class="comment">//</span>
00730                 <span class="comment">//  Copy over all the names that we've processed so far</span>
00731                 <span class="comment">//</span>
00732 
00733                 RtlMoveMemory( <a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a>,
00734                                CompleteName-&gt;Buffer,
00735                                ((RemainingName-&gt;Buffer - CompleteName-&gt;Buffer) * <span class="keyword">sizeof</span>( WCHAR )));
00736 
00737                 <span class="comment">//</span>
00738                 <span class="comment">//  If we have some remaining names then those over at the</span>
00739                 <span class="comment">//  the location offset to hold the link target name</span>
00740                 <span class="comment">//</span>
00741 
00742                 <span class="keywordflow">if</span> (RemainingName-&gt;Length != 0) {
00743 
00744                     RtlMoveMemory( (PVOID)((PUCHAR)NewRemainingName + InsertAmount),
00745                                    RemainingName-&gt;Buffer,
00746                                    RemainingName-&gt;Length );
00747                 }
00748 
00749                 <span class="comment">//</span>
00750                 <span class="comment">//  Now insert the link target name</span>
00751                 <span class="comment">//</span>
00752 
00753                 RtlMoveMemory( NewRemainingName, LinkTargetName-&gt;Buffer, InsertAmount );
00754 
00755                 <span class="comment">//</span>
00756                 <span class="comment">//  Free the old complete name buffer and reset the input</span>
00757                 <span class="comment">//  strings to use the new buffer</span>
00758                 <span class="comment">//</span>
00759 
00760                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( CompleteName-&gt;Buffer );
00761 
00762                 CompleteName-&gt;Buffer = <a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a>;
00763                 CompleteName-&gt;Length = Length;
00764                 CompleteName-&gt;MaximumLength = MaximumLength;
00765 
00766                 RemainingName-&gt;Buffer = NewRemainingName;
00767                 RemainingName-&gt;Length = Length - (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)((PCHAR)NewRemainingName - (PCHAR)<a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a>);
00768                 RemainingName-&gt;MaximumLength = RemainingName-&gt;Length + <span class="keyword">sizeof</span>( UNICODE_NULL );
00769 
00770             } <span class="keywordflow">else</span> {
00771 
00772                 <span class="comment">//</span>
00773                 <span class="comment">//  Insert extra text associated with this symbolic link name before</span>
00774                 <span class="comment">//  existing remaining name, if any.</span>
00775                 <span class="comment">//</span>
00776                 <span class="comment">//  First shove over the remaining name to make a hole for the</span>
00777                 <span class="comment">//  link target name</span>
00778                 <span class="comment">//</span>
00779 
00780                 <span class="keywordflow">if</span> (RemainingName-&gt;Length != 0) {
00781 
00782                     RtlMoveMemory( (PVOID)((PUCHAR)RemainingName-&gt;Buffer + InsertAmount),
00783                                    RemainingName-&gt;Buffer,
00784                                    RemainingName-&gt;Length );
00785                 }
00786 
00787                 <span class="comment">//</span>
00788                 <span class="comment">//  Now insert the link target name</span>
00789                 <span class="comment">//</span>
00790 
00791                 RtlMoveMemory( RemainingName-&gt;Buffer, LinkTargetName-&gt;Buffer, InsertAmount );
00792 
00793                 <span class="comment">//</span>
00794                 <span class="comment">//  Adjust input strings to account for this inserted text</span>
00795                 <span class="comment">//</span>
00796 
00797                 CompleteName-&gt;Length += LinkTargetName-&gt;Length;
00798 
00799                 RemainingName-&gt;Length += LinkTargetName-&gt;Length;
00800                 RemainingName-&gt;MaximumLength += RemainingName-&gt;Length + <span class="keyword">sizeof</span>( UNICODE_NULL );
00801 
00802                 CompleteName-&gt;Buffer[ CompleteName-&gt;Length / <span class="keyword">sizeof</span>( WCHAR ) ] = UNICODE_NULL;
00803             }
00804 
00805             <span class="comment">//</span>
00806             <span class="comment">//  Return the object address associated with snapped symbolic link</span>
00807             <span class="comment">//  and the reparse object status code.</span>
00808             <span class="comment">//</span>
00809 
00810             *Object = SymbolicLink-&gt;<a class="code" href="../../d2/d6/struct__OBJECT__SYMBOLIC__LINK.html#o3">LinkTargetObject</a>;
00811 
00812             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_REPARSE_OBJECT;
00813             leave;
00814         }
00815 
00816         <span class="comment">//</span>
00817         <span class="comment">//  The symbolic has not yet been snapped</span>
00818         <span class="comment">//</span>
00819         <span class="comment">//  Compute the size of the new name and check if the name will</span>
00820         <span class="comment">//  fit in the existing complete name buffer.</span>
00821         <span class="comment">//</span>
00822 
00823         LinkTargetName = &amp;SymbolicLink-&gt;<a class="code" href="../../d2/d6/struct__OBJECT__SYMBOLIC__LINK.html#o1">LinkTarget</a>;
00824         NewLength = LinkTargetName-&gt;Length + RemainingName-&gt;Length;
00825 
00826         <span class="keywordflow">if</span> (NewLength &gt; 0xFFF0) {
00827 
00828             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NAME_TOO_LONG;
00829             leave;
00830         }
00831 
00832         Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)NewLength;
00833 
00834         <span class="keywordflow">if</span> (CompleteName-&gt;MaximumLength &lt;= Length) {
00835 
00836             <span class="comment">//</span>
00837             <span class="comment">//  The new concatentated name is larger than the buffer supplied for</span>
00838             <span class="comment">//  the complete name.</span>
00839             <span class="comment">//</span>
00840 
00841             MaximumLength = Length + <span class="keyword">sizeof</span>( UNICODE_NULL );
00842             <a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a> = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, MaximumLength, 'mNbO' );
00843 
00844             <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00845 
00846                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
00847                 leave;
00848             }
00849 
00850         } <span class="keywordflow">else</span> {
00851 
00852             MaximumLength = CompleteName-&gt;MaximumLength;
00853             <a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a> = CompleteName-&gt;Buffer;
00854         }
00855 
00856         <span class="comment">//</span>
00857         <span class="comment">//  Concatenate the symbolic link name with the remaining name,</span>
00858         <span class="comment">//  if any.  What this does is overwrite the front of the complete</span>
00859         <span class="comment">//  name up to the remaining name with the links target name</span>
00860         <span class="comment">//</span>
00861 
00862         <span class="keywordflow">if</span> (RemainingName-&gt;Length != 0) {
00863 
00864             RtlMoveMemory( (PVOID)((PUCHAR)<a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a> + LinkTargetName-&gt;Length),
00865                            RemainingName-&gt;Buffer,
00866                            RemainingName-&gt;Length );
00867         }
00868 
00869         RtlMoveMemory( <a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a>, LinkTargetName-&gt;Buffer, LinkTargetName-&gt;Length );
00870 
00871         <a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a>[ Length / <span class="keyword">sizeof</span>( WCHAR ) ] = UNICODE_NULL;
00872 
00873         <span class="comment">//</span>
00874         <span class="comment">//  If a new name buffer was allocated, then free the original complete</span>
00875         <span class="comment">//  name buffer.</span>
00876         <span class="comment">//</span>
00877 
00878         <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a> != CompleteName-&gt;Buffer) {
00879 
00880             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( CompleteName-&gt;Buffer );
00881         }
00882 
00883         <span class="comment">//</span>
00884         <span class="comment">//  Set the new complete name buffer parameters and return a reparse</span>
00885         <span class="comment">//  status.</span>
00886         <span class="comment">//</span>
00887 
00888         CompleteName-&gt;Buffer = <a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a>;
00889         CompleteName-&gt;Length = Length;
00890         CompleteName-&gt;MaximumLength = MaximumLength;
00891 
00892         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_REPARSE;
00893 
00894     } finally {
00895 
00896         <a class="code" href="../../d5/d1/obp_8h.html#a11">ObpLeaveRootDirectoryMutex</a>();
00897     }
00898 
00899     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00900 }
00901 
00902 
00903 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00904"></a><a class="code" href="../../d5/d1/obp_8h.html#a65">00904</a> <a class="code" href="../../d5/d1/obp_8h.html#a65">ObpDeleteSymbolicLink</a> (
00905     IN PVOID Object
00906     )
00907 
00908 <span class="comment">/*++</span>
00909 <span class="comment"></span>
00910 <span class="comment">Routine Description:</span>
00911 <span class="comment"></span>
00912 <span class="comment">    This routine is called when a reference to a symbolic link goes to zero.</span>
00913 <span class="comment">    Its job is to clean up the memory used to the symbolic link string</span>
00914 <span class="comment"></span>
00915 <span class="comment">Arguments:</span>
00916 <span class="comment"></span>
00917 <span class="comment">    Object - Supplies a pointer to the symbolic link object being deleted</span>
00918 <span class="comment"></span>
00919 <span class="comment">Return Value:</span>
00920 <span class="comment"></span>
00921 <span class="comment">    None.</span>
00922 <span class="comment"></span>
00923 <span class="comment">--*/</span>
00924 
00925 {
00926     <a class="code" href="../../d2/d6/struct__OBJECT__SYMBOLIC__LINK.html">POBJECT_SYMBOLIC_LINK</a> SymbolicLink = (<a class="code" href="../../d2/d6/struct__OBJECT__SYMBOLIC__LINK.html">POBJECT_SYMBOLIC_LINK</a>)Object;
00927 
00928     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00929 
00930     <span class="comment">//</span>
00931     <span class="comment">//  The only cleaning up we need to do is to free the link target</span>
00932     <span class="comment">//  buffer</span>
00933     <span class="comment">//</span>
00934 
00935     <span class="keywordflow">if</span> (SymbolicLink-&gt;<a class="code" href="../../d2/d6/struct__OBJECT__SYMBOLIC__LINK.html#o1">LinkTarget</a>.Buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00936 
00937         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( SymbolicLink-&gt;<a class="code" href="../../d2/d6/struct__OBJECT__SYMBOLIC__LINK.html#o1">LinkTarget</a>.Buffer );
00938     }
00939 
00940     SymbolicLink-&gt;<a class="code" href="../../d2/d6/struct__OBJECT__SYMBOLIC__LINK.html#o1">LinkTarget</a>.Buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00941 
00942     <span class="comment">//</span>
00943     <span class="comment">//  And return to our caller</span>
00944     <span class="comment">//</span>
00945 
00946     <span class="keywordflow">return</span>;
00947 }
00948 
00949 
00950 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00951"></a><a class="code" href="../../d5/d1/obp_8h.html#a67">00951</a> <a class="code" href="../../d5/d1/obp_8h.html#a67">ObpDeleteSymbolicLinkName</a> (
00952     <a class="code" href="../../d2/d6/struct__OBJECT__SYMBOLIC__LINK.html">POBJECT_SYMBOLIC_LINK</a> SymbolicLink
00953     )
00954 
00955 <span class="comment">/*++</span>
00956 <span class="comment"></span>
00957 <span class="comment">Routine Description:</span>
00958 <span class="comment"></span>
00959 <span class="comment">    This routine delete the symbolic from the system</span>
00960 <span class="comment"></span>
00961 <span class="comment">Arguments:</span>
00962 <span class="comment"></span>
00963 <span class="comment">    SymbolicLink - Supplies a pointer to the object body for the symbolic</span>
00964 <span class="comment">        link object to delete</span>
00965 <span class="comment"></span>
00966 <span class="comment">Return Value:</span>
00967 <span class="comment"></span>
00968 <span class="comment">    None.</span>
00969 <span class="comment"></span>
00970 <span class="comment">--*/</span>
00971 
00972 {
00973     PVOID CapturedLinkTargetObject;
00974 
00975     CapturedLinkTargetObject = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00976 
00977     <span class="comment">//</span>
00978     <span class="comment">//  Lock the root directory mutex while we look at the target path to</span>
00979     <span class="comment">//  prevent names from disappearing out from under us.  Also protects</span>
00980     <span class="comment">//  against collisions with NtCreateSymbolicLink</span>
00981     <span class="comment">//</span>
00982 
00983     <a class="code" href="../../d5/d1/obp_8h.html#a10">ObpEnterRootDirectoryMutex</a>();
00984 
00985     <span class="comment">//</span>
00986     <span class="comment">//  Capture the link target object and referenced one more time</span>
00987     <span class="comment">//  to avoid destroying while the RootDirectoryMutex is hold</span>
00988     <span class="comment">//</span>
00989 
00990     CapturedLinkTargetObject = SymbolicLink-&gt;<a class="code" href="../../d2/d6/struct__OBJECT__SYMBOLIC__LINK.html#o3">LinkTargetObject</a>;
00991 
00992     <span class="keywordflow">if</span> (CapturedLinkTargetObject != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00993 
00994         <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>(CapturedLinkTargetObject);
00995     }
00996 
00997     <a class="code" href="../../d4/d1/oblink_8c.html#a4">ObpProcessDosDeviceSymbolicLink</a>( SymbolicLink, <a class="code" href="../../d4/d1/oblink_8c.html#a1">DELETE_SYMBOLIC_LINK</a> );
00998 
00999     <a class="code" href="../../d5/d1/obp_8h.html#a11">ObpLeaveRootDirectoryMutex</a>();
01000 
01001     <span class="comment">//</span>
01002     <span class="comment">//  Remove the extra-reference for the link target object</span>
01003     <span class="comment">//</span>
01004 
01005     <span class="keywordflow">if</span> (CapturedLinkTargetObject != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01006 
01007         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(CapturedLinkTargetObject);
01008     }
01009 
01010     <span class="keywordflow">return</span>;
01011 }
01012 
01013 
01014 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01015"></a><a class="code" href="../../d5/d1/obp_8h.html#a66">01015</a> <a class="code" href="../../d5/d1/obp_8h.html#a66">ObpCreateSymbolicLinkName</a> (
01016     <a class="code" href="../../d2/d6/struct__OBJECT__SYMBOLIC__LINK.html">POBJECT_SYMBOLIC_LINK</a> SymbolicLink
01017     )
01018 
01019 <span class="comment">/*++</span>
01020 <span class="comment"></span>
01021 <span class="comment">Routine Description:</span>
01022 <span class="comment"></span>
01023 <span class="comment">    This routine does extra processing for symbolic links being created in</span>
01024 <span class="comment">    object directories controlled by device map objects.</span>
01025 <span class="comment"></span>
01026 <span class="comment">    This processing consists of:</span>
01027 <span class="comment"></span>
01028 <span class="comment">    1.  Determine if the name of the symbolic link is a drive letter.</span>
01029 <span class="comment">        If so, then we will need to update the drive type in the</span>
01030 <span class="comment">        associated device map object.</span>
01031 <span class="comment"></span>
01032 <span class="comment">    2.  Process the link target, trying to resolve it into a pointer to</span>
01033 <span class="comment">        an object other than a object directory object.  All object</span>
01034 <span class="comment">        directories traversed must grant world traverse access other</span>
01035 <span class="comment">        wise we bail out.  If we successfully find a non object</span>
01036 <span class="comment">        directory object, then reference the object pointer and store it</span>
01037 <span class="comment">        in the symbolic link object, along with a remaining string if</span>
01038 <span class="comment">        any.  ObpLookupObjectName will used this cache object pointer to</span>
01039 <span class="comment">        short circuit the name lookup directly to the cached object's</span>
01040 <span class="comment">        parse routine.  For any object directory objects traversed along</span>
01041 <span class="comment">        the way, increment their symbolic link SymbolicLinkUsageCount</span>
01042 <span class="comment">        field.  This field is used whenever an object directory is</span>
01043 <span class="comment">        deleted or its security is changed such that it no longer grants</span>
01044 <span class="comment">        world traverse access.  In either case, if the field is non-zero</span>
01045 <span class="comment">        we walk all the symbolic links and resnap them.</span>
01046 <span class="comment"></span>
01047 <span class="comment">Arguments:</span>
01048 <span class="comment"></span>
01049 <span class="comment">    SymbolicLink - pointer to symbolic link object being created.</span>
01050 <span class="comment"></span>
01051 <span class="comment">Return Value:</span>
01052 <span class="comment"></span>
01053 <span class="comment">    None.</span>
01054 <span class="comment"></span>
01055 <span class="comment">--*/</span>
01056 
01057 {
01058     <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> ObjectHeader;
01059     <a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html">POBJECT_HEADER_NAME_INFO</a> NameInfo;
01060     WCHAR DosDeviceDriveLetter;
01061     ULONG DosDeviceDriveIndex;
01062 
01063     <span class="comment">//</span>
01064     <span class="comment">//  Now see if this symbolic link is being created in an object directory</span>
01065     <span class="comment">//  controlled by a device map object.  Since we are only called from</span>
01066     <span class="comment">//  NtCreateSymbolicLinkObject, after the handle to this symbolic link</span>
01067     <span class="comment">//  has been created but before it is returned to the caller the handle can't</span>
01068     <span class="comment">//  be closed while we are executing, unless via a random close,</span>
01069     <span class="comment">//  So no need to hold the type specific mutex while we look at the name.</span>
01070     <span class="comment">//</span>
01071 
01072     ObjectHeader = <a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>( SymbolicLink );
01073     NameInfo = <a class="code" href="../../d4/d0/ob_8h.html#a12">OBJECT_HEADER_TO_NAME_INFO</a>( ObjectHeader );
01074 
01075     <span class="keywordflow">if</span> ((NameInfo == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
01076         (NameInfo-&gt;<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html#o0">Directory</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
01077         (NameInfo-&gt;<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html#o0">Directory</a>-&gt;<a class="code" href="../../d8/d4/struct__OBJECT__DIRECTORY.html#o4">DeviceMap</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
01078 
01079         <span class="keywordflow">return</span>;
01080     }
01081 
01082     <span class="comment">//</span>
01083     <span class="comment">//  Here if we are creating a symbolic link in an object directory controlled</span>
01084     <span class="comment">//  by a device map object.  See if this is a drive letter definition.  If so</span>
01085     <span class="comment">//  calculate the drive letter index and remember in the symbolic link object.</span>
01086     <span class="comment">//</span>
01087 
01088     DosDeviceDriveIndex = 0;
01089 
01090     <span class="keywordflow">if</span> ((NameInfo-&gt;<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html#o1">Name</a>.Length == (2 * <span class="keyword">sizeof</span>( WCHAR ))) &amp;&amp;
01091         (NameInfo-&gt;<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html#o1">Name</a>.Buffer[ 1 ] == <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">':'</span>)) {
01092 
01093         DosDeviceDriveLetter = <a class="code" href="../../d6/d6/nls_8c.html#a33">RtlUpcaseUnicodeChar</a>( NameInfo-&gt;<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html#o1">Name</a>.Buffer[ 0 ] );
01094 
01095         <span class="keywordflow">if</span> ((DosDeviceDriveLetter &gt;= <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'A'</span>) &amp;&amp; (DosDeviceDriveLetter &lt;= <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'Z'</span>)) {
01096 
01097             DosDeviceDriveIndex = DosDeviceDriveLetter - <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'A'</span>;
01098             DosDeviceDriveIndex += 1;
01099 
01100             SymbolicLink-&gt;<a class="code" href="../../d2/d6/struct__OBJECT__SYMBOLIC__LINK.html#o4">DosDeviceDriveIndex</a> = DosDeviceDriveIndex;
01101         }
01102     }
01103 
01104     <span class="comment">//</span>
01105     <span class="comment">//  Now traverse the target path seeing if we can snap the link now.</span>
01106     <span class="comment">//</span>
01107 
01108     <a class="code" href="../../d4/d1/oblink_8c.html#a4">ObpProcessDosDeviceSymbolicLink</a>( SymbolicLink, <a class="code" href="../../d4/d1/oblink_8c.html#a0">CREATE_SYMBOLIC_LINK</a> );
01109 
01110     <span class="keywordflow">return</span>;
01111 }
01112 
01113 
01114 <span class="comment">//</span>
01115 <span class="comment">//  Local support routine</span>
01116 <span class="comment">//</span>
01117 
<a name="l01118"></a><a class="code" href="../../d4/d1/oblink_8c.html#a2">01118</a> <span class="preprocessor">#define MAX_DEPTH 16</span>
01119 <span class="preprocessor"></span>
01120 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01121"></a><a class="code" href="../../d4/d1/oblink_8c.html#a4">01121</a> <a class="code" href="../../d4/d1/oblink_8c.html#a4">ObpProcessDosDeviceSymbolicLink</a> (
01122     <a class="code" href="../../d2/d6/struct__OBJECT__SYMBOLIC__LINK.html">POBJECT_SYMBOLIC_LINK</a> SymbolicLink,
01123     ULONG Action
01124     )
01125 
01126 <span class="comment">/*++</span>
01127 <span class="comment"></span>
01128 <span class="comment">Routine Description:</span>
01129 <span class="comment"></span>
01130 <span class="comment">    This function is called whenever a symbolic link is created or deleted</span>
01131 <span class="comment">    in an object directory controlled by a device map object.</span>
01132 <span class="comment"></span>
01133 <span class="comment">    For creates, it attempts to snap the symbolic link to a non-object</span>
01134 <span class="comment">    directory object.  It does this by walking the symbolic link target</span>
01135 <span class="comment">    string, until it sees a non-directory object or a directory object</span>
01136 <span class="comment">    that does NOT allow World traverse access.  It stores a referenced</span>
01137 <span class="comment">    pointer to this object in the symbolic link object.  It also</span>
01138 <span class="comment">    increments a count in each of the object directory objects that it</span>
01139 <span class="comment">    walked over.  This count is used to disallow any attempt to remove</span>
01140 <span class="comment">    World traverse access from a directory object after it has</span>
01141 <span class="comment">    participated in a snapped symbolic link.</span>
01142 <span class="comment"></span>
01143 <span class="comment">    For deletes, it repeats the walk of the target string, decrementing</span>
01144 <span class="comment">    the count associated with each directory object walked over.  It also</span>
01145 <span class="comment">    dereferences the snapped object pointer.</span>
01146 <span class="comment"></span>
01147 <span class="comment">Arguments:</span>
01148 <span class="comment"></span>
01149 <span class="comment">    SymbolicLink - pointer to symbolic link object being created or deleted.</span>
01150 <span class="comment"></span>
01151 <span class="comment">    Action - describes whether this is a create or a delete action</span>
01152 <span class="comment"></span>
01153 <span class="comment">Return Value:</span>
01154 <span class="comment"></span>
01155 <span class="comment">    None.</span>
01156 <span class="comment"></span>
01157 <span class="comment">--*/</span>
01158 
01159 {
01160     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01161     PVOID Object;
01162     <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> ObjectHeader;
01163     <a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html">POBJECT_HEADER_NAME_INFO</a> NameInfo;
01164     PSECURITY_DESCRIPTOR SecurityDescriptor;
01165     BOOLEAN MemoryAllocated;
01166     UNICODE_STRING RemainingName;
01167     UNICODE_STRING ComponentName;
01168     BOOLEAN HaveWorldTraverseAccess;
01169     ULONG Depth;
01170     <a class="code" href="../../d8/d4/struct__OBJECT__DIRECTORY.html">POBJECT_DIRECTORY</a> Directories[ <a class="code" href="../../d4/d1/oblink_8c.html#a2">MAX_DEPTH</a> ], <a class="code" href="../../d2/d5/editreg_8c.html#a68">Directory</a>, ParentDirectory;
01171     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject;
01172     <a class="code" href="../../d2/d4/struct__DEVICE__MAP.html">PDEVICE_MAP</a> DeviceMap = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01173     ULONG DosDeviceDriveType;
01174     BOOLEAN DeviceMapUsed = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;    
01175     
01176 
01177     Object = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01178 
01179     <span class="comment">//</span>
01180     <span class="comment">//  Check if we are creating a symbolic link or if the link has already</span>
01181     <span class="comment">//  been snapped</span>
01182     <span class="comment">//</span>
01183 
01184     <span class="keywordflow">if</span> ((<a class="code" href="../../d7/d0/cmdat2_8c.html#a18">Action</a> == <a class="code" href="../../d4/d1/oblink_8c.html#a0">CREATE_SYMBOLIC_LINK</a>) ||
01185         (SymbolicLink-&gt;<a class="code" href="../../d2/d6/struct__OBJECT__SYMBOLIC__LINK.html#o3">LinkTargetObject</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
01186 
01187         ParentDirectory = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01188         Depth    = 0;
01189         <a class="code" href="../../d2/d5/editreg_8c.html#a68">Directory</a> = <a class="code" href="../../d8/d5/kddata_8c.html#a9">ObpRootDirectoryObject</a>;
01190         RemainingName = SymbolicLink-&gt;<a class="code" href="../../d2/d6/struct__OBJECT__SYMBOLIC__LINK.html#o1">LinkTarget</a>;
01191 
01192         DeviceMap = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;DeviceMap;
01193 
01194 
01195 ReCalcDeviceMap:
01196 
01197         <span class="keywordflow">if</span> (DeviceMap) {
01198 
01199 
01200             <span class="keywordflow">if</span> (!((ULONG_PTR)(RemainingName.Buffer) &amp; (<span class="keyword">sizeof</span>(ULONGLONG)-1))
01201 
01202                         &amp;&amp;
01203 
01204                 (DeviceMap-&gt;<a class="code" href="../../d2/d4/struct__DEVICE__MAP.html#o1">DosDevicesDirectory</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> )) {
01205 
01206                 <span class="comment">//</span>
01207                 <span class="comment">//  Check if the object name is actually equal to the</span>
01208                 <span class="comment">//  global dos devices short name prefix "\??\"</span>
01209                 <span class="comment">//</span>
01210 
01211                 <span class="keywordflow">if</span> ((RemainingName.Length &gt;= <a class="code" href="../../d0/d1/obinit_8c.html#a8">ObpDosDevicesShortName</a>.Length)
01212 
01213                         &amp;&amp;
01214 
01215                     (*(PULONGLONG)(RemainingName.Buffer) == <a class="code" href="../../d0/d1/obinit_8c.html#a9">ObpDosDevicesShortNamePrefix</a>.QuadPart)) {
01216 
01217                     <span class="comment">//</span>
01218                     <span class="comment">//  The user gave us the dos short name prefix so we'll</span>
01219                     <span class="comment">//  look down the directory, and start the search at the</span>
01220                     <span class="comment">//  dos device directory</span>
01221                     <span class="comment">//</span>
01222 
01223                     <a class="code" href="../../d2/d5/editreg_8c.html#a68">Directory</a> = DeviceMap-&gt;<a class="code" href="../../d2/d4/struct__DEVICE__MAP.html#o1">DosDevicesDirectory</a>;
01224 
01225                     RemainingName.Buffer += (<a class="code" href="../../d0/d1/obinit_8c.html#a8">ObpDosDevicesShortName</a>.Length / <span class="keyword">sizeof</span>( WCHAR ));
01226                     RemainingName.Length -= <a class="code" href="../../d0/d1/obinit_8c.html#a8">ObpDosDevicesShortName</a>.Length;
01227 
01228                     DeviceMapUsed = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01229 
01230                 } 
01231             }
01232         }
01233 
01234         <span class="comment">//</span>
01235         <span class="comment">//  The following loop will dissect the link target checking</span>
01236         <span class="comment">//  that each directory exists and that we have access to</span>
01237         <span class="comment">//  the directory.  When we pop out the local directories</span>
01238         <span class="comment">//  array will contain a list of directories that we need</span>
01239         <span class="comment">//  to traverse to process this action.</span>
01240         <span class="comment">//</span>
01241 
01242         <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01243                         
01244             <span class="comment">//</span>
01245             <span class="comment">//  Gobble up the "\" in the remaining name</span>
01246             <span class="comment">//</span>
01247 
01248             <span class="keywordflow">if</span> (*(RemainingName.Buffer) == OBJ_NAME_PATH_SEPARATOR) {
01249 
01250                 RemainingName.Buffer++;
01251                 RemainingName.Length -= <span class="keyword">sizeof</span>( OBJ_NAME_PATH_SEPARATOR );
01252             }
01253 
01254             <span class="comment">//</span>
01255             <span class="comment">//  And dissect the name into its first component and any</span>
01256             <span class="comment">//  remaining part</span>
01257             <span class="comment">//</span>
01258 
01259             ComponentName = RemainingName;
01260 
01261             <span class="keywordflow">while</span> (RemainingName.Length != 0) {
01262 
01263                 <span class="keywordflow">if</span> (*(RemainingName.Buffer) == OBJ_NAME_PATH_SEPARATOR) {
01264 
01265                     <span class="keywordflow">break</span>;
01266                 }
01267 
01268                 RemainingName.Buffer++;
01269                 RemainingName.Length -= <span class="keyword">sizeof</span>( OBJ_NAME_PATH_SEPARATOR );
01270             }
01271 
01272             ComponentName.Length -= RemainingName.Length;
01273 
01274             <span class="keywordflow">if</span> (ComponentName.Length == 0) {
01275 
01276                 <span class="keywordflow">return</span>;
01277             }
01278 
01279             <span class="comment">//</span>
01280             <span class="comment">//  See if we have world traverse access to look this name up</span>
01281             <span class="comment">//</span>
01282 
01283             <span class="keywordflow">if</span> (ParentDirectory != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01284 
01285                 HaveWorldTraverseAccess = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01286 
01287                 <span class="comment">//</span>
01288                 <span class="comment">//  Obtain the object's security descriptor</span>
01289                 <span class="comment">//</span>
01290 
01291                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d1/obse_8c.html#a8">ObGetObjectSecurity</a>( ParentDirectory,
01292                                               &amp;SecurityDescriptor,
01293                                               &amp;MemoryAllocated );
01294 
01295                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
01296 
01297                     <span class="comment">//</span>
01298                     <span class="comment">//  Check to see if WORLD has TRAVERSE access and then release</span>
01299                     <span class="comment">//  the security descriptor</span>
01300                     <span class="comment">//</span>
01301 
01302                     HaveWorldTraverseAccess = <a class="code" href="../../d0/d4/accessck_8c.html#a22">SeFastTraverseCheck</a>( SecurityDescriptor,
01303                                                                    DIRECTORY_TRAVERSE,
01304                                                                    <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a> );
01305 
01306                     <a class="code" href="../../d9/d1/obse_8c.html#a9">ObReleaseObjectSecurity</a>( SecurityDescriptor,
01307                                              MemoryAllocated );
01308                 }
01309 
01310                 <span class="keywordflow">if</span> (!HaveWorldTraverseAccess) {
01311 
01312                     Object = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01313                     <span class="keywordflow">break</span>;
01314                 }
01315 
01316                 <span class="keywordflow">if</span> (Depth &gt;= <a class="code" href="../../d4/d1/oblink_8c.html#a2">MAX_DEPTH</a>) {
01317 
01318                     Object = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01319                     <span class="keywordflow">break</span>;
01320                 }
01321 
01322                 Directories[ Depth++ ] = ParentDirectory;
01323             }
01324 
01325             <span class="comment">//</span>
01326             <span class="comment">//  Look this component name up in this directory.  If not found, then</span>
01327             <span class="comment">//  bail.</span>
01328             <span class="comment">//</span>
01329 
01330             Object = <a class="code" href="../../d5/d1/obp_8h.html#a68">ObpLookupDirectoryEntry</a>( <a class="code" href="../../d2/d5/editreg_8c.html#a68">Directory</a>, &amp;ComponentName, 0 );
01331 
01332             <span class="keywordflow">if</span> (Object == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01333 
01334                 <span class="keywordflow">break</span>;
01335             }
01336 
01337             <span class="comment">//</span>
01338             <span class="comment">//  See if this is a object directory object.  If so, keep going</span>
01339             <span class="comment">//</span>
01340 
01341             ObjectHeader = <a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>( Object );
01342 
01343             <span class="keywordflow">if</span> (ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o3">Type</a> == <a class="code" href="../../d5/d1/obp_8h.html#a42">ObpDirectoryObjectType</a>) {
01344 
01345                 ParentDirectory = <a class="code" href="../../d2/d5/editreg_8c.html#a68">Directory</a>;
01346                 <a class="code" href="../../d2/d5/editreg_8c.html#a68">Directory</a> = (<a class="code" href="../../d8/d4/struct__OBJECT__DIRECTORY.html">POBJECT_DIRECTORY</a>)Object;
01347 
01348             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o3">Type</a> == <a class="code" href="../../d5/d1/obp_8h.html#a43">ObpSymbolicLinkObjectType</a>) &amp;&amp;
01349                        (((<a class="code" href="../../d2/d6/struct__OBJECT__SYMBOLIC__LINK.html">POBJECT_SYMBOLIC_LINK</a>)Object)-&gt;DosDeviceDriveIndex == 0)) {
01350 
01351                 <span class="comment">//</span>
01352                 <span class="comment">//  Found a symbolic link to another symbolic link that is</span>
01353                 <span class="comment">//  not already snapped.  So switch to its target string</span>
01354                 <span class="comment">//  so we can chase down the real device object</span>
01355                 <span class="comment">//</span>
01356 
01357                 ParentDirectory = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01358                 Depth = 0;
01359                 <a class="code" href="../../d2/d5/editreg_8c.html#a68">Directory</a> = <a class="code" href="../../d8/d5/kddata_8c.html#a9">ObpRootDirectoryObject</a>;
01360                 RemainingName = ((<a class="code" href="../../d2/d6/struct__OBJECT__SYMBOLIC__LINK.html">POBJECT_SYMBOLIC_LINK</a>)Object)-&gt;LinkTarget;
01361 
01362                 <span class="keywordflow">goto</span> ReCalcDeviceMap;
01363 
01364             } <span class="keywordflow">else</span> {
01365 
01366                 <span class="comment">//</span>
01367                 <span class="comment">//  Not an object directory object, or a symbolic link to an</span>
01368                 <span class="comment">//  unsnapped symbolic link, so all done.  Exit the loop</span>
01369                 <span class="comment">//</span>
01370 
01371                 <span class="keywordflow">break</span>;
01372             }
01373         }
01374 
01375         <span class="comment">//</span>
01376         <span class="comment">//  Done walking the target path.  Now update the counts associated</span>
01377         <span class="comment">//  with each directory object walked over.</span>
01378         <span class="comment">//</span>
01379 
01380         <span class="keywordflow">while</span> (Depth--) {
01381 
01382             <a class="code" href="../../d2/d5/editreg_8c.html#a68">Directory</a> = Directories[ Depth ];
01383 
01384             <span class="keywordflow">if</span> (<a class="code" href="../../d7/d0/cmdat2_8c.html#a18">Action</a> == <a class="code" href="../../d4/d1/oblink_8c.html#a0">CREATE_SYMBOLIC_LINK</a>) {
01385 
01386                 <span class="keywordflow">if</span> (Object != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01387 
01388                     <a class="code" href="../../d2/d5/editreg_8c.html#a68">Directory</a>-&gt;SymbolicLinkUsageCount += 1;
01389                 }
01390 
01391             } <span class="keywordflow">else</span> {
01392 
01393                 <a class="code" href="../../d2/d5/editreg_8c.html#a68">Directory</a>-&gt;SymbolicLinkUsageCount -= 1;
01394             }
01395         }
01396     }
01397 
01398     <span class="comment">//</span>
01399     <span class="comment">//  Done processing symbolic link target path.  Update symbolic link</span>
01400     <span class="comment">//  object as appropriate for passed in reason</span>
01401     <span class="comment">//</span>
01402 
01403     <span class="comment">//</span>
01404     <span class="comment">//  If this is a drive letter symbolic link, get the address of the device</span>
01405     <span class="comment">//  map object that is controlling the containing object directory so we</span>
01406     <span class="comment">//  can update the drive type in the device map.</span>
01407     <span class="comment">//</span>
01408 
01409     DeviceMap = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01410 
01411     <span class="keywordflow">if</span> (SymbolicLink-&gt;<a class="code" href="../../d2/d6/struct__OBJECT__SYMBOLIC__LINK.html#o4">DosDeviceDriveIndex</a> != 0) {
01412 
01413         ObjectHeader = <a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>( SymbolicLink );
01414         NameInfo = <a class="code" href="../../d4/d0/ob_8h.html#a12">OBJECT_HEADER_TO_NAME_INFO</a>( ObjectHeader );
01415 
01416         <span class="keywordflow">if</span> (NameInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; NameInfo-&gt;<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html#o0">Directory</a>) {
01417 
01418             DeviceMap = NameInfo-&gt;<a class="code" href="../../d0/d6/struct__OBJECT__HEADER__NAME__INFO.html#o0">Directory</a>-&gt;<a class="code" href="../../d8/d4/struct__OBJECT__DIRECTORY.html#o4">DeviceMap</a>;
01419         }
01420     }
01421 
01422     <span class="comment">//</span>
01423     <span class="comment">//  Check if we are creating a symbolic link</span>
01424     <span class="comment">//</span>
01425 
01426     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d0/cmdat2_8c.html#a18">Action</a> == <a class="code" href="../../d4/d1/oblink_8c.html#a0">CREATE_SYMBOLIC_LINK</a>) {
01427 
01428         DosDeviceDriveType = DOSDEVICE_DRIVE_CALCULATE;
01429 
01430         <span class="keywordflow">if</span> (Object != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01431 
01432 
01433             <span class="comment">//</span>
01434             <span class="comment">// We only want to do snapping for console session. When we create a</span>
01435             <span class="comment">// remote session all the symbolic links stored in the console dos devices</span>
01436             <span class="comment">// directory (\??) are copied into the per session DosDevices object directory</span>
01437             <span class="comment">// (\Session&lt;id&gt;\DosDevices). We don't want to do snapping for the copied</span>
01438             <span class="comment">// symbolic links since for each copy we will increment the ref count on the</span>
01439             <span class="comment">// target object. All these counts have to go to zero before the device can be</span>
01440             <span class="comment">// deleted.</span>
01441             <span class="comment">//</span>
01442             <span class="keywordflow">if</span> ((<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;SessionId == 0) || (DeviceMapUsed)) {
01443                 <span class="comment">//</span>
01444                 <span class="comment">//  Create action.  Store a referenced pointer to the snapped object</span>
01445                 <span class="comment">//  along with the description of any remaining name string.  Also,</span>
01446                 <span class="comment">//  for Dos drive letters, update the drive type in the appropriate</span>
01447                 <span class="comment">//  device map object.</span>
01448                 <span class="comment">//</span>
01449 
01450                 <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>( Object );
01451 
01452                 SymbolicLink-&gt;<a class="code" href="../../d2/d6/struct__OBJECT__SYMBOLIC__LINK.html#o3">LinkTargetObject</a> = Object;
01453 
01454                 <span class="keywordflow">if</span> ((*(RemainingName.Buffer) == OBJ_NAME_PATH_SEPARATOR) &amp;&amp;
01455                     (RemainingName.Length == <span class="keyword">sizeof</span>( OBJ_NAME_PATH_SEPARATOR))) {
01456 
01457                     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;SymbolicLink-&gt;<a class="code" href="../../d2/d6/struct__OBJECT__SYMBOLIC__LINK.html#o2">LinkTargetRemaining</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
01458 
01459                 } <span class="keywordflow">else</span> {
01460 
01461                     SymbolicLink-&gt;<a class="code" href="../../d2/d6/struct__OBJECT__SYMBOLIC__LINK.html#o2">LinkTargetRemaining</a> = RemainingName;
01462                 }
01463             }
01464 
01465             <span class="keywordflow">if</span> (SymbolicLink-&gt;<a class="code" href="../../d2/d6/struct__OBJECT__SYMBOLIC__LINK.html#o4">DosDeviceDriveIndex</a> != 0) {
01466 
01467                 <span class="comment">//</span>
01468                 <span class="comment">//  Default is to calculate the drive type in user mode if we are</span>
01469                 <span class="comment">//  unable to snap the symbolic link or it does not resolve to a</span>
01470                 <span class="comment">//  DEVICE_OBJECT we know about.</span>
01471                 <span class="comment">//</span>
01472 
01473                 ObjectHeader = <a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>( Object );
01474 
01475                 <span class="keywordflow">if</span> (ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o3">Type</a> == <a class="code" href="../../d3/d5/iodata_8c.html#a35">IoDeviceObjectType</a>) {
01476 
01477                     DeviceObject = (<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>)Object;
01478 
01479                     <span class="keywordflow">switch</span> (DeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o12">DeviceType</a>) {
01480 
01481                     <span class="keywordflow">case</span> FILE_DEVICE_CD_ROM:
01482                     <span class="keywordflow">case</span> FILE_DEVICE_CD_ROM_FILE_SYSTEM:
01483 
01484                         DosDeviceDriveType = DOSDEVICE_DRIVE_CDROM;
01485 
01486                         <span class="keywordflow">break</span>;
01487 
01488                     <span class="keywordflow">case</span> FILE_DEVICE_DISK:
01489                     <span class="keywordflow">case</span> FILE_DEVICE_DISK_FILE_SYSTEM:
01490                     <span class="keywordflow">case</span> FILE_DEVICE_FILE_SYSTEM:
01491 
01492                         <span class="keywordflow">if</span> (DeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o9">Characteristics</a> &amp; FILE_REMOVABLE_MEDIA) {
01493 
01494                             DosDeviceDriveType = DOSDEVICE_DRIVE_REMOVABLE;
01495 
01496                         } <span class="keywordflow">else</span> {
01497 
01498                             DosDeviceDriveType = DOSDEVICE_DRIVE_FIXED;
01499                         }
01500 
01501                         <span class="keywordflow">break</span>;
01502 
01503                     <span class="keywordflow">case</span> FILE_DEVICE_MULTI_UNC_PROVIDER:
01504                     <span class="keywordflow">case</span> FILE_DEVICE_NETWORK:
01505                     <span class="keywordflow">case</span> FILE_DEVICE_NETWORK_BROWSER:
01506                     <span class="keywordflow">case</span> FILE_DEVICE_NETWORK_REDIRECTOR:
01507 
01508                         DosDeviceDriveType = DOSDEVICE_DRIVE_REMOTE;
01509 
01510                         <span class="keywordflow">break</span>;
01511 
01512                     <span class="keywordflow">case</span> FILE_DEVICE_NETWORK_FILE_SYSTEM:
01513 
01514 <span class="preprocessor">#if defined(REMOTE_BOOT)</span>
01515 <span class="preprocessor"></span>                        <span class="comment">//</span>
01516                         <span class="comment">//  If this is a remote boot workstation, the X:</span>
01517                         <span class="comment">//  drive is a redirected drive, but needs to look</span>
01518                         <span class="comment">//  like a local drive.</span>
01519                         <span class="comment">//</span>
01520 
01521                         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d5/io_8h.html#a399">IoRemoteBootClient</a> &amp;&amp;
01522                             (SymbolicLink-&gt;<a class="code" href="../../d2/d6/struct__OBJECT__SYMBOLIC__LINK.html#o4">DosDeviceDriveIndex</a> == 24)) {
01523 
01524                             DosDeviceDriveType = DOSDEVICE_DRIVE_FIXED;
01525 
01526                         } <span class="keywordflow">else</span>
01527 <span class="preprocessor">#endif // defined(REMOTE_BOOT)</span>
01528 <span class="preprocessor"></span>                        {
01529                             DosDeviceDriveType = DOSDEVICE_DRIVE_REMOTE;
01530                         }
01531 
01532                         <span class="keywordflow">break</span>;
01533 
01534                     <span class="keywordflow">case</span> FILE_DEVICE_VIRTUAL_DISK:
01535 
01536                         DosDeviceDriveType = DOSDEVICE_DRIVE_RAMDISK;
01537 
01538                         <span class="keywordflow">break</span>;
01539 
01540                     <span class="keywordflow">default</span>:
01541 
01542                         DosDeviceDriveType = DOSDEVICE_DRIVE_UNKNOWN;
01543 
01544                         <span class="keywordflow">break</span>;
01545                     }
01546                 }
01547             }
01548         }
01549 
01550         <span class="comment">//</span>
01551         <span class="comment">//  If this is a drive letter symbolic link, update the drive type and</span>
01552         <span class="comment">//  and mark as valid drive letter.</span>
01553         <span class="comment">//</span>
01554 
01555         <span class="keywordflow">if</span> (DeviceMap != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01556 
01557             DeviceMap-&gt;<a class="code" href="../../d2/d4/struct__DEVICE__MAP.html#o3">DriveType</a>[ SymbolicLink-&gt;<a class="code" href="../../d2/d6/struct__OBJECT__SYMBOLIC__LINK.html#o4">DosDeviceDriveIndex</a>-1 ] = (UCHAR)DosDeviceDriveType;
01558             DeviceMap-&gt;<a class="code" href="../../d2/d4/struct__DEVICE__MAP.html#o2">DriveMap</a> |= 1 &lt;&lt; (SymbolicLink-&gt;<a class="code" href="../../d2/d6/struct__OBJECT__SYMBOLIC__LINK.html#o4">DosDeviceDriveIndex</a>-1) ;
01559         }
01560 
01561     } <span class="keywordflow">else</span> {
01562 
01563         <span class="comment">//</span>
01564         <span class="comment">//  Deleting the symbolic link.  Dereference the snapped object pointer if any</span>
01565         <span class="comment">//  and zero out the snapped object fields.</span>
01566         <span class="comment">//</span>
01567 
01568         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;SymbolicLink-&gt;<a class="code" href="../../d2/d6/struct__OBJECT__SYMBOLIC__LINK.html#o2">LinkTargetRemaining</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
01569 
01570         Object = SymbolicLink-&gt;<a class="code" href="../../d2/d6/struct__OBJECT__SYMBOLIC__LINK.html#o3">LinkTargetObject</a>;
01571 
01572         <span class="keywordflow">if</span> (Object != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01573 
01574             SymbolicLink-&gt;<a class="code" href="../../d2/d6/struct__OBJECT__SYMBOLIC__LINK.html#o3">LinkTargetObject</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01575             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Object );
01576         }
01577 
01578         <span class="comment">//</span>
01579         <span class="comment">//  If this is a drive letter symbolic link, set the drive type to</span>
01580         <span class="comment">//  unknown and clear the bit in the drive letter bit map.</span>
01581         <span class="comment">//</span>
01582 
01583         <span class="keywordflow">if</span> (DeviceMap != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01584 
01585             DeviceMap-&gt;<a class="code" href="../../d2/d4/struct__DEVICE__MAP.html#o2">DriveMap</a> &amp;= ~(1 &lt;&lt; (SymbolicLink-&gt;<a class="code" href="../../d2/d6/struct__OBJECT__SYMBOLIC__LINK.html#o4">DosDeviceDriveIndex</a>-1));
01586             DeviceMap-&gt;<a class="code" href="../../d2/d4/struct__DEVICE__MAP.html#o3">DriveType</a>[ SymbolicLink-&gt;<a class="code" href="../../d2/d6/struct__OBJECT__SYMBOLIC__LINK.html#o4">DosDeviceDriveIndex</a>-1 ] = DOSDEVICE_DRIVE_UNKNOWN;
01587 
01588             SymbolicLink-&gt;<a class="code" href="../../d2/d6/struct__OBJECT__SYMBOLIC__LINK.html#o4">DosDeviceDriveIndex</a> = 0;
01589         }
01590 
01591         <span class="comment">//</span>
01592         <span class="comment">//  If we allocated a target buffer, free it.</span>
01593         <span class="comment">//</span>
01594 
01595         <span class="keywordflow">if</span> (SymbolicLink-&gt;<a class="code" href="../../d2/d6/struct__OBJECT__SYMBOLIC__LINK.html#o1">LinkTarget</a>.Buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01596 
01597             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( SymbolicLink-&gt;<a class="code" href="../../d2/d6/struct__OBJECT__SYMBOLIC__LINK.html#o1">LinkTarget</a>.Buffer );
01598 
01599             <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;SymbolicLink-&gt;<a class="code" href="../../d2/d6/struct__OBJECT__SYMBOLIC__LINK.html#o1">LinkTarget</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
01600         }
01601     }
01602     
01603     <span class="keywordflow">return</span>;
01604 }
01605 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:05 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
