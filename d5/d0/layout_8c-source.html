<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: layout.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>layout.c</h1><a href="../../d4/d1/layout_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/**************************************************************************\</span>
00002 <span class="comment">* Module Name: layout.c (corresponds to Win95 ime.c)</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00005 <span class="comment">*</span>
00006 <span class="comment">* IME Keyboard Layout related functionality</span>
00007 <span class="comment">*</span>
00008 <span class="comment">* History:</span>
00009 <span class="comment">* 03-Jan-1996 wkwok       Created</span>
00010 <span class="comment">\**************************************************************************/</span>
00011 
00012 <span class="preprocessor">#include "<a class="code" href="../../d8/d3/w32_2ntuser_2imm_2precomp_8h.html">precomp.h</a>"</span>
00013 <span class="preprocessor">#pragma hdrstop</span>
00014 <span class="preprocessor"></span>
00015 <span class="comment">/*</span>
00016 <span class="comment"> * Local Defines.</span>
00017 <span class="comment"> */</span>
<a name="l00018"></a><a class="code" href="../../d4/d1/layout_8c.html#a0">00018</a> <span class="preprocessor">#define szLZOpenFileW "LZOpenFileW"</span>
<a name="l00019"></a><a class="code" href="../../d4/d1/layout_8c.html#a1">00019</a> <span class="preprocessor"></span><span class="preprocessor">#define szLZCopy      "LZCopy"</span>
<a name="l00020"></a><a class="code" href="../../d4/d1/layout_8c.html#a2">00020</a> <span class="preprocessor"></span><span class="preprocessor">#define szLZClose     "LZClose"</span>
00021 <span class="preprocessor"></span>
<a name="l00022"></a><a class="code" href="../../d4/d1/layout_8c.html#a4">00022</a> <span class="keyword">typedef</span> HFILE (WINAPI *<a class="code" href="../../d4/d1/layout_8c.html#a4">LPFNLZOPENFILEW</a>)(LPTSTR, LPOFSTRUCT, WORD);
<a name="l00023"></a><a class="code" href="../../d4/d1/layout_8c.html#a5">00023</a> <span class="keyword">typedef</span> LONG  (WINAPI *<a class="code" href="../../d4/d1/layout_8c.html#a5">LPFNLZCOPY</a>)(<a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>, <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>);
<a name="l00024"></a><a class="code" href="../../d4/d1/layout_8c.html#a6">00024</a> <span class="keyword">typedef</span> <a class="code" href="../../d0/d6/iop_8h.html#a145">VOID</a>  (WINAPI *<a class="code" href="../../d4/d1/layout_8c.html#a6">LPFNLZCLOSE</a>)(<a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>);
00025 
00026 <span class="comment">/*</span>
00027 <span class="comment"> * Local Routines.</span>
00028 <span class="comment"> */</span>
00029 <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> <a class="code" href="../../d4/d1/layout_8c.html#a7">StrToUInt</a>(LPWSTR);
00030 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/layout_8c.html#a8">UIntToStr</a>(UINT, ULONG, LPWSTR, USHORT);
00031 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/layout_8c.html#a9">CopyImeFile</a>(LPWSTR, LPCWSTR);
00032 <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>  <a class="code" href="../../d4/d1/layout_8c.html#a10">GetImeLayout</a>(<a class="code" href="../../d1/d8/structtagIMELAYOUT.html">PIMELAYOUT</a>, INT);
00033 <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/layout_8c.html#a11">WriteImeLayout</a>(HKL, LPCWSTR, LPCWSTR);
00034 HKL  <a class="code" href="../../d4/d1/layout_8c.html#a12">AssignNewLayout</a>(INT, <a class="code" href="../../d1/d8/structtagIMELAYOUT.html">PIMELAYOUT</a>, HKL);
00035 
00036 
00037 <span class="comment">/***************************************************************************\</span>
00038 <span class="comment">* ImmGetIMEFileNameW</span>
00039 <span class="comment">*</span>
00040 <span class="comment">* Gets the description of the IME with the specified HKL.</span>
00041 <span class="comment">*</span>
00042 <span class="comment">* History:</span>
00043 <span class="comment">* 28-Feb-1995   wkwok   Created</span>
00044 <span class="comment">\***************************************************************************/</span>
00045 
<a name="l00046"></a><a class="code" href="../../d4/d1/layout_8c.html#a13">00046</a> <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> WINAPI <a class="code" href="../../d4/d1/layout_8c.html#a13">ImmGetDescriptionW</a>(
00047     HKL    hKL,
00048     LPWSTR lpwszDescription,
00049     UINT   uBufLen)
00050 {
00051     <a class="code" href="../../d0/d8/structtagIMEINFOEX.html">IMEINFOEX</a> iiex;
00052     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> uRet;
00053 
00054     <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d0/immuser_8h.html#a47">ImmGetImeInfoEx</a>(&amp;iiex, <a class="code" href="../../d8/d0/immstruc_8h.html#a75a52">ImeInfoExKeyboardLayout</a>, &amp;hKL))
00055         <span class="keywordflow">return</span> 0;
00056 
00057     uRet = wcslen(iiex.<a class="code" href="../../d0/d8/structtagIMEINFOEX.html#o8">wszImeDescription</a>);
00058 
00059     <span class="comment">/*</span>
00060 <span class="comment">     * ask buffer length</span>
00061 <span class="comment">     */</span>
00062     <span class="keywordflow">if</span> (uBufLen == 0)
00063         <span class="keywordflow">return</span> uRet;
00064 
00065     <span class="keywordflow">if</span> (uBufLen &gt; uRet) {
00066         wcscpy(lpwszDescription, iiex.<a class="code" href="../../d0/d8/structtagIMEINFOEX.html#o8">wszImeDescription</a>);
00067     }
00068     <span class="keywordflow">else</span> {
00069         uRet = uBufLen - 1;
00070         wcsncpy(lpwszDescription, iiex.<a class="code" href="../../d0/d8/structtagIMEINFOEX.html#o8">wszImeDescription</a>, uRet);
00071         lpwszDescription[uRet] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
00072     }
00073 
00074     <span class="keywordflow">return</span> uRet;
00075 }
00076 
00077 
00078 <span class="comment">/***************************************************************************\</span>
00079 <span class="comment">* ImmGetIMEFileNameA</span>
00080 <span class="comment">*</span>
00081 <span class="comment">* Gets the description of the IME with the specified HKL.</span>
00082 <span class="comment">*</span>
00083 <span class="comment">* History:</span>
00084 <span class="comment">* 28-Feb-1995   wkwok   Created</span>
00085 <span class="comment">\***************************************************************************/</span>
00086 
<a name="l00087"></a><a class="code" href="../../d4/d1/layout_8c.html#a14">00087</a> <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> WINAPI <a class="code" href="../../d4/d1/layout_8c.html#a14">ImmGetDescriptionA</a>(
00088     HKL   hKL,
00089     LPSTR lpszDescription,
00090     UINT  uBufLen)
00091 {
00092     <a class="code" href="../../d0/d8/structtagIMEINFOEX.html">IMEINFOEX</a> iiex;
00093     <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>       i;
00094     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>      bUDC;
00095 
00096     <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d0/immuser_8h.html#a47">ImmGetImeInfoEx</a>(&amp;iiex, <a class="code" href="../../d8/d0/immstruc_8h.html#a75a52">ImeInfoExKeyboardLayout</a>, &amp;hKL))
00097         <span class="keywordflow">return</span> 0;
00098 
00099     i = WideCharToMultiByte(CP_ACP,
00100                             (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)0,
00101                             (LPWSTR)iiex.<a class="code" href="../../d0/d8/structtagIMEINFOEX.html#o8">wszImeDescription</a>,       <span class="comment">// src</span>
00102                             wcslen(iiex.<a class="code" href="../../d0/d8/structtagIMEINFOEX.html#o8">wszImeDescription</a>),
00103                             lpszDescription,                      <span class="comment">// dest</span>
00104                             uBufLen,
00105                             (LPSTR)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00106                             (LPBOOL)&amp;bUDC);
00107 
00108     <span class="keywordflow">if</span> (uBufLen != 0)
00109         lpszDescription[i] = <span class="charliteral">'\0'</span>;
00110 
00111     <span class="keywordflow">return</span> (<a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a>)i;
00112 }
00113 
00114 
00115 <span class="comment">/***************************************************************************\</span>
00116 <span class="comment">* ImmGetIMEFileNameW</span>
00117 <span class="comment">*</span>
00118 <span class="comment">* Gets the file name of the IME with the specified HKL.</span>
00119 <span class="comment">*</span>
00120 <span class="comment">* History:</span>
00121 <span class="comment">* 28-Feb-1995   wkwok   Created</span>
00122 <span class="comment">\***************************************************************************/</span>
00123 
<a name="l00124"></a><a class="code" href="../../d4/d1/layout_8c.html#a15">00124</a> <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> WINAPI <a class="code" href="../../d4/d1/layout_8c.html#a15">ImmGetIMEFileNameW</a>(
00125     HKL    hKL,
00126     LPWSTR lpwszFile,
00127     UINT   uBufLen)
00128 {
00129     <a class="code" href="../../d0/d8/structtagIMEINFOEX.html">IMEINFOEX</a> iiex;
00130     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> uRet;
00131 
00132     <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d0/immuser_8h.html#a47">ImmGetImeInfoEx</a>(&amp;iiex, <a class="code" href="../../d8/d0/immstruc_8h.html#a75a52">ImeInfoExKeyboardLayout</a>, &amp;hKL))
00133         <span class="keywordflow">return</span> 0;
00134 
00135     uRet = wcslen(iiex.<a class="code" href="../../d0/d8/structtagIMEINFOEX.html#o9">wszImeFile</a>);
00136 
00137     <span class="comment">/*</span>
00138 <span class="comment">     * ask buffer length</span>
00139 <span class="comment">     */</span>
00140     <span class="keywordflow">if</span> (uBufLen == 0)
00141         <span class="keywordflow">return</span> uRet;
00142 
00143     <span class="keywordflow">if</span> (uBufLen &gt; uRet) {
00144         wcscpy(lpwszFile, iiex.<a class="code" href="../../d0/d8/structtagIMEINFOEX.html#o9">wszImeFile</a>);
00145     }
00146     <span class="keywordflow">else</span> {
00147         uRet = uBufLen - 1;
00148         wcsncpy(lpwszFile, iiex.<a class="code" href="../../d0/d8/structtagIMEINFOEX.html#o9">wszImeFile</a>, uRet);
00149         lpwszFile[uRet] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
00150     }
00151 
00152     <span class="keywordflow">return</span> uRet;
00153 }
00154 
00155 
00156 <span class="comment">/***************************************************************************\</span>
00157 <span class="comment">* ImmGetIMEFileNameA</span>
00158 <span class="comment">*</span>
00159 <span class="comment">* Gets the file name of the IME with the specified HKL.</span>
00160 <span class="comment">*</span>
00161 <span class="comment">* History:</span>
00162 <span class="comment">* 28-Feb-1995   wkwok   Created</span>
00163 <span class="comment">\***************************************************************************/</span>
00164 
<a name="l00165"></a><a class="code" href="../../d4/d1/layout_8c.html#a16">00165</a> <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> WINAPI <a class="code" href="../../d4/d1/layout_8c.html#a16">ImmGetIMEFileNameA</a>(
00166     HKL   hKL,
00167     LPSTR lpszFile,
00168     UINT  uBufLen)
00169 {
00170     <a class="code" href="../../d0/d8/structtagIMEINFOEX.html">IMEINFOEX</a> iiex;
00171     <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>       i;
00172     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>      bUDC;
00173 
00174     <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d0/immuser_8h.html#a47">ImmGetImeInfoEx</a>(&amp;iiex, <a class="code" href="../../d8/d0/immstruc_8h.html#a75a52">ImeInfoExKeyboardLayout</a>, &amp;hKL))
00175         <span class="keywordflow">return</span> 0;
00176 
00177     i = WideCharToMultiByte(CP_ACP,
00178                             (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)0,
00179                             (LPWSTR)iiex.<a class="code" href="../../d0/d8/structtagIMEINFOEX.html#o9">wszImeFile</a>,       <span class="comment">// src</span>
00180                             wcslen(iiex.<a class="code" href="../../d0/d8/structtagIMEINFOEX.html#o9">wszImeFile</a>),
00181                             lpszFile,                      <span class="comment">// dest</span>
00182                             uBufLen,
00183                             (LPSTR)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00184                             (LPBOOL)&amp;bUDC);
00185 
00186     <span class="keywordflow">if</span> (uBufLen != 0)
00187         lpszFile[i] = <span class="charliteral">'\0'</span>;
00188 
00189     <span class="keywordflow">return</span> i;
00190 }
00191 
00192 
00193 <span class="comment">/***************************************************************************\</span>
00194 <span class="comment">* ImmGetProperty</span>
00195 <span class="comment">*</span>
00196 <span class="comment">* Gets the property and capability of the IME with the specified HKL.</span>
00197 <span class="comment">*</span>
00198 <span class="comment">* History:</span>
00199 <span class="comment">* 28-Feb-1995   wkwok   Created</span>
00200 <span class="comment">\***************************************************************************/</span>
00201 
<a name="l00202"></a><a class="code" href="../../d4/d1/layout_8c.html#a17">00202</a> <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> WINAPI <a class="code" href="../../d4/d1/layout_8c.html#a17">ImmGetProperty</a>(
00203     HKL     hKL,
00204     DWORD   dwIndex)
00205 {
00206     <a class="code" href="../../d0/d8/structtagIMEINFOEX.html">IMEINFOEX</a> iiex;
00207     <a class="code" href="../../d2/d7/structtagIMEDPI.html">PIMEDPI</a>   pImeDpi = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00208     PIMEINFO  pImeInfo;
00209     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>     dwRet;
00210 
00211     <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d0/immuser_8h.html#a47">ImmGetImeInfoEx</a>(&amp;iiex, <a class="code" href="../../d8/d0/immstruc_8h.html#a75a52">ImeInfoExKeyboardLayout</a>, &amp;hKL))
00212         <span class="keywordflow">return</span> 0;
00213 
00214     <span class="keywordflow">if</span> (dwIndex == IGP_GETIMEVERSION)
00215         <span class="keywordflow">return</span> iiex.<a class="code" href="../../d0/d8/structtagIMEINFOEX.html#o7">dwImeWinVersion</a>;
00216 
00217     <span class="keywordflow">if</span> (iiex.<a class="code" href="../../d0/d8/structtagIMEINFOEX.html#o5">fLoadFlag</a> != <a class="code" href="../../d8/d0/immstruc_8h.html#a20">IMEF_LOADED</a>) {
00218         pImeDpi = <a class="code" href="../../d6/d0/immime_8c.html#a11">FindOrLoadImeDpi</a>(hKL);
00219         <span class="keywordflow">if</span> (pImeDpi == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00220             RIPMSG0(RIP_WARNING, <span class="stringliteral">"ImmGetProperty: load IME failure."</span>);
00221             <span class="keywordflow">return</span> 0;
00222         }
00223         pImeInfo = &amp;pImeDpi-&gt;<a class="code" href="../../d2/d7/structtagIMEDPI.html#o3">ImeInfo</a>;
00224     }
00225     <span class="keywordflow">else</span> {
00226         pImeInfo = &amp;iiex.<a class="code" href="../../d0/d8/structtagIMEINFOEX.html#o1">ImeInfo</a>;
00227     }
00228 
00229     <span class="keywordflow">switch</span> (dwIndex) {
00230     <span class="keywordflow">case</span> IGP_PROPERTY:
00231         dwRet = pImeInfo-&gt;fdwProperty;
00232         <span class="keywordflow">break</span>;
00233 
00234     <span class="keywordflow">case</span> IGP_CONVERSION:
00235         dwRet = pImeInfo-&gt;fdwConversionCaps;
00236         <span class="keywordflow">break</span>;
00237 
00238     <span class="keywordflow">case</span> IGP_SENTENCE:
00239         dwRet = pImeInfo-&gt;fdwSentenceCaps;
00240         <span class="keywordflow">break</span>;
00241 
00242     <span class="keywordflow">case</span> IGP_UI:
00243         dwRet = pImeInfo-&gt;fdwUICaps;
00244         <span class="keywordflow">break</span>;
00245 
00246     <span class="keywordflow">case</span> IGP_SETCOMPSTR:
00247         dwRet = pImeInfo-&gt;fdwSCSCaps;
00248         <span class="keywordflow">break</span>;
00249 
00250     <span class="keywordflow">case</span> IGP_SELECT:
00251         dwRet = pImeInfo-&gt;fdwSelectCaps;
00252         <span class="keywordflow">break</span>;
00253 
00254     <span class="keywordflow">default</span>:
00255         RIPMSG1(RIP_WARNING, <span class="stringliteral">"ImmGetProperty: wrong index %lx."</span>, dwIndex);
00256         dwRet = 0;
00257         <span class="keywordflow">break</span>;
00258     }
00259 
00260     <a class="code" href="../../d9/d0/immuser_8h.html#a46">ImmUnlockImeDpi</a>(pImeDpi);
00261 
00262     <span class="keywordflow">return</span> dwRet;
00263 }
00264 
00265 
<a name="l00266"></a><a class="code" href="../../d4/d1/layout_8c.html#a18">00266</a> HKL WINAPI <a class="code" href="../../d4/d1/layout_8c.html#a18">ImmInstallIMEW</a>(
00267     LPCWSTR lpszIMEFileName,
00268     LPCWSTR lpszLayoutText)
00269 {
00270     LPWSTR     lpwszImeFileName;
00271     LPWSTR     lpwszImeFilePart;
00272     LPWSTR     lpwszImeCopiedPath;
00273     <span class="keywordtype">int</span>        i, nIMEs;
00274     <a class="code" href="../../d1/d8/structtagIMELAYOUT.html">PIMELAYOUT</a> pImeLayout = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00275     HKL        hImeKL, hLangKL;
00276     WCHAR      szKeyName[<a class="code" href="../../d4/d0/immcli_8h.html#a1">HEX_ASCII_SIZE</a>];
00277     <a class="code" href="../../d0/d8/structtagIMEINFOEX.html">IMEINFOEX</a>  iiex;
00278 
00279     lpwszImeFileName = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a22">ImmLocalAlloc</a>(0, (<a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>+1) * <span class="keyword">sizeof</span>(WCHAR));
00280     <span class="keywordflow">if</span> (lpwszImeFileName == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00281         <span class="keywordflow">return</span> (HKL)0;
00282 
00283     lpwszImeCopiedPath = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a22">ImmLocalAlloc</a>(0, (<a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>+1) * <span class="keyword">sizeof</span>(WCHAR));
00284     <span class="keywordflow">if</span> (lpwszImeCopiedPath == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00285         <a class="code" href="../../d4/d0/immcli_8h.html#a8">ImmLocalFree</a>(lpwszImeFileName);
00286         <span class="keywordflow">return</span> (HKL)0;
00287     }
00288 
00289     <span class="comment">/*</span>
00290 <span class="comment">     * Get the file name only into lpwszImeFilePart</span>
00291 <span class="comment">     */</span>
00292     GetFullPathNameW(lpszIMEFileName, <a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>,
00293                 lpwszImeFileName, &amp;lpwszImeFilePart);
00294 
00295     CharUpper(lpwszImeFileName);
00296 
00297     <span class="keywordflow">if</span> (lpwszImeFilePart == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00298         <a class="code" href="../../d4/d0/immcli_8h.html#a8">ImmLocalFree</a>(lpwszImeFileName);
00299         <a class="code" href="../../d4/d0/immcli_8h.html#a8">ImmLocalFree</a>(lpwszImeCopiedPath);
00300         <span class="keywordflow">return</span> (HKL)0;
00301     }
00302 
00303     hImeKL = hLangKL = iiex.<a class="code" href="../../d0/d8/structtagIMEINFOEX.html#o0">hkl</a> = (HKL)0;
00304 
00305     wcsncpy(iiex.<a class="code" href="../../d0/d8/structtagIMEINFOEX.html#o9">wszImeFile</a>, lpwszImeFilePart, <a class="code" href="../../d8/d0/immstruc_8h.html#a22">IM_FILE_SIZE</a>-1);
00306     iiex.<a class="code" href="../../d0/d8/structtagIMEINFOEX.html#o9">wszImeFile</a>[<a class="code" href="../../d8/d0/immstruc_8h.html#a22">IM_FILE_SIZE</a> - 1] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
00307 
00308     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d1/layime_8c.html#a22">LoadVersionInfo</a>(&amp;iiex) &amp;&amp; iiex.<a class="code" href="../../d0/d8/structtagIMEINFOEX.html#o0">hkl</a> != (HKL)0) {
00309         hLangKL = iiex.<a class="code" href="../../d0/d8/structtagIMEINFOEX.html#o0">hkl</a>;
00310     }
00311     <span class="keywordflow">else</span> {
00312         <a class="code" href="../../d4/d0/immcli_8h.html#a8">ImmLocalFree</a>(lpwszImeFileName);
00313         <a class="code" href="../../d4/d0/immcli_8h.html#a8">ImmLocalFree</a>(lpwszImeCopiedPath);
00314         <span class="keywordflow">return</span> (HKL)0;
00315     }
00316 
00317     nIMEs = <a class="code" href="../../d4/d1/layout_8c.html#a10">GetImeLayout</a>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0);
00318     <span class="keywordflow">if</span> (nIMEs != 0) {
00319         pImeLayout = (<a class="code" href="../../d1/d8/structtagIMELAYOUT.html">PIMELAYOUT</a>)<a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a22">ImmLocalAlloc</a>(0, nIMEs * <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d8/structtagIMELAYOUT.html">IMELAYOUT</a>));
00320         <span class="keywordflow">if</span> (pImeLayout == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00321             <a class="code" href="../../d4/d0/immcli_8h.html#a8">ImmLocalFree</a>(lpwszImeFileName);
00322             <a class="code" href="../../d4/d0/immcli_8h.html#a8">ImmLocalFree</a>(lpwszImeCopiedPath);
00323             <span class="keywordflow">return</span> (HKL)0;
00324         }
00325 
00326         <a class="code" href="../../d4/d1/layout_8c.html#a10">GetImeLayout</a>(pImeLayout, nIMEs);
00327 
00328         <span class="keywordflow">for</span> (i=0; i &lt; nIMEs; i++) {
00329             <span class="keywordflow">if</span> (_wcsicmp(pImeLayout[i].szImeName, lpwszImeFilePart) == 0) {
00330                 <span class="comment">/*</span>
00331 <span class="comment">                 * We got the same IME name, ISV wants to upgrade.</span>
00332 <span class="comment">                 */</span>
00333                 <span class="keywordflow">if</span> (LOWORD(HandleToUlong(hLangKL)) != LOWORD(HandleToUlong(pImeLayout[i].hImeKL))) {
00334                     <span class="comment">/*</span>
00335 <span class="comment">                     * IME name conflict, blow out!</span>
00336 <span class="comment">                     */</span>
00337                     RIPMSG0(RIP_WARNING, <span class="stringliteral">"ImmInstallIME: different language!"</span>);
00338                     <span class="keywordflow">goto</span> ImmInstallIMEWFailed;
00339                 }
00340 
00341                 hImeKL = pImeLayout[i].<a class="code" href="../../d1/d8/structtagIMELAYOUT.html#o0">hImeKL</a>;
00342                 <span class="keywordflow">break</span>;
00343             }
00344         }
00345     }
00346 
00347     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d0/immuser_8h.html#a47">ImmGetImeInfoEx</a>(&amp;iiex, <a class="code" href="../../d8/d0/immstruc_8h.html#a75a54">ImeInfoExImeFileName</a>, lpwszImeFilePart)) {
00348         <span class="comment">/*</span>
00349 <span class="comment">         * The specified IME has been activated. Unload it first.</span>
00350 <span class="comment">         */</span>
00351         <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d8/client_8c.html#a153">UnloadKeyboardLayout</a>(iiex.<a class="code" href="../../d0/d8/structtagIMEINFOEX.html#o0">hkl</a>)) {
00352             hImeKL = (HKL)0;
00353             <span class="keywordflow">goto</span> ImmInstallIMEWFailed;
00354         }
00355     }
00356 
00357     <span class="comment">/*</span>
00358 <span class="comment">     * We will copy to system directory</span>
00359 <span class="comment">     */</span>
00360 <span class="preprocessor">#if 0</span>
00361 <span class="preprocessor"></span>    i = (<a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>)GetSystemDirectory(lpwszImeCopiedPath, <a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>);
00362     lpwszImeCopiedPath[i] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
00363     AddBackslash(lpwszImeCopiedPath);
00364     wcscat(lpwszImeCopiedPath, lpwszImeFilePart);
00365 <span class="preprocessor">#else</span>
00366 <span class="preprocessor"></span>    <a class="code" href="../../d3/d1/layime_8c.html#a17">GetSystemPathName</a>(lpwszImeCopiedPath, lpwszImeFilePart, <a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>);
00367 <span class="preprocessor">#endif</span>
00368 <span class="preprocessor"></span>    CharUpper(lpwszImeCopiedPath);
00369 
00370     <span class="keywordflow">if</span> (_wcsicmp(lpwszImeFileName, lpwszImeCopiedPath) != 0) {
00371         <span class="comment">/*</span>
00372 <span class="comment">         * path is different, need to copy into system directory</span>
00373 <span class="comment">         */</span>
00374         <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d1/layout_8c.html#a9">CopyImeFile</a>(lpwszImeFileName, lpwszImeCopiedPath)) {
00375             hImeKL = (HKL)0;
00376             <span class="keywordflow">goto</span> ImmInstallIMEWFailed;
00377         }
00378     }
00379 
00380     <span class="keywordflow">if</span> (hImeKL == 0) {
00381         hImeKL = <a class="code" href="../../d4/d1/layout_8c.html#a12">AssignNewLayout</a>(nIMEs, pImeLayout, hLangKL);
00382     }
00383 
00384     <span class="keywordflow">if</span> (hImeKL != 0) {
00385         <span class="comment">/*</span>
00386 <span class="comment">         * Write HKL under "keyboard layouts"</span>
00387 <span class="comment">         */</span>
00388         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d1/layout_8c.html#a11">WriteImeLayout</a>(hImeKL, lpwszImeFilePart, lpszLayoutText)) {
00389             <a class="code" href="../../d4/d1/layout_8c.html#a8">UIntToStr</a>(HandleToUlong(hImeKL), 16, szKeyName, <span class="keyword">sizeof</span>(szKeyName));
00390             hImeKL = LoadKeyboardLayout(szKeyName, KLF_REPLACELANG);
00391         }
00392         <span class="keywordflow">else</span> {
00393             hImeKL = (HKL)0;
00394         }
00395     }
00396 
00397 ImmInstallIMEWFailed:
00398     <span class="keywordflow">if</span> (pImeLayout != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00399         <a class="code" href="../../d4/d0/immcli_8h.html#a8">ImmLocalFree</a>(pImeLayout);
00400     <a class="code" href="../../d4/d0/immcli_8h.html#a8">ImmLocalFree</a>(lpwszImeFileName);
00401     <a class="code" href="../../d4/d0/immcli_8h.html#a8">ImmLocalFree</a>(lpwszImeCopiedPath);
00402 
00403     <span class="keywordflow">return</span> (HKL)hImeKL;
00404 }
00405 
00406 
<a name="l00407"></a><a class="code" href="../../d4/d1/layout_8c.html#a19">00407</a> HKL WINAPI <a class="code" href="../../d4/d1/layout_8c.html#a19">ImmInstallIMEA</a>(
00408     LPCSTR lpszIMEFileName,
00409     LPCSTR lpszLayoutText)
00410 {
00411     HKL    hKL;
00412     LPWSTR lpwszIMEFileName;
00413     LPWSTR lpwszLayoutText;
00414     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>  cbIMEFileName;
00415     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>  cbLayoutText;
00416     <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>    i;
00417 
00418     cbIMEFileName = <a class="code" href="../../d2/d7/regtest_8c.html#a2">strlen</a>(lpszIMEFileName) + <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>);
00419     cbLayoutText  = <a class="code" href="../../d2/d7/regtest_8c.html#a2">strlen</a>(lpszLayoutText)  + <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>);
00420 
00421     lpwszIMEFileName = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a22">ImmLocalAlloc</a>(0, cbIMEFileName * <span class="keyword">sizeof</span>(WCHAR));
00422     <span class="keywordflow">if</span> (lpwszIMEFileName == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00423         RIPMSG0(RIP_WARNING, <span class="stringliteral">"ImmInstallIMEA: memory failure!"</span>);
00424         <span class="keywordflow">return</span> (HKL)0;
00425     }
00426 
00427     lpwszLayoutText = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a22">ImmLocalAlloc</a>(0, cbLayoutText * <span class="keyword">sizeof</span>(WCHAR));
00428     <span class="keywordflow">if</span> (lpwszLayoutText == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00429         RIPMSG0(RIP_WARNING, <span class="stringliteral">"ImmInstallIMEA: memory failure!"</span>);
00430         <a class="code" href="../../d4/d0/immcli_8h.html#a8">ImmLocalFree</a>(lpwszIMEFileName);
00431         <span class="keywordflow">return</span> (HKL)0;
00432     }
00433 
00434     i = MultiByteToWideChar(CP_ACP,
00435                             (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)MB_PRECOMPOSED,
00436                             (LPSTR)lpszIMEFileName,              <span class="comment">// src</span>
00437                             (<a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>)<a class="code" href="../../d2/d7/regtest_8c.html#a2">strlen</a>(lpszIMEFileName),
00438                             (LPWSTR)lpwszIMEFileName,            <span class="comment">// dest</span>
00439                             (<a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>)cbIMEFileName);
00440     lpwszIMEFileName[i] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
00441 
00442     i = MultiByteToWideChar(CP_ACP,
00443                             (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)MB_PRECOMPOSED,
00444                             (LPSTR)lpszLayoutText,              <span class="comment">// src</span>
00445                             (<a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>)<a class="code" href="../../d2/d7/regtest_8c.html#a2">strlen</a>(lpszLayoutText),
00446                             (LPWSTR)lpwszLayoutText,            <span class="comment">// dest</span>
00447                             (<a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>)cbLayoutText);
00448     lpwszLayoutText[i] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
00449 
00450     hKL = <a class="code" href="../../d4/d1/layout_8c.html#a18">ImmInstallIMEW</a>(lpwszIMEFileName, lpwszLayoutText);
00451 
00452     <a class="code" href="../../d4/d0/immcli_8h.html#a8">ImmLocalFree</a>(lpwszLayoutText);
00453     <a class="code" href="../../d4/d0/immcli_8h.html#a8">ImmLocalFree</a>(lpwszIMEFileName);
00454 
00455     <span class="keywordflow">return</span> hKL;
00456 }
00457 
00458 
00459 <span class="comment">/***************************************************************************\</span>
00460 <span class="comment">* ImmIsIME</span>
00461 <span class="comment">*</span>
00462 <span class="comment">* Checks whether the specified hKL is a HKL of an IME or not.</span>
00463 <span class="comment">*</span>
00464 <span class="comment">* History:</span>
00465 <span class="comment">* 28-Feb-1995   wkwok   Created</span>
00466 <span class="comment">\***************************************************************************/</span>
00467 
<a name="l00468"></a><a class="code" href="../../d4/d1/layout_8c.html#a20">00468</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> WINAPI <a class="code" href="../../d4/d1/layout_8c.html#a20">ImmIsIME</a>(
00469     HKL hKL)
00470 {
00471     <a class="code" href="../../d0/d8/structtagIMEINFOEX.html">IMEINFOEX</a> iiex;
00472 
00473     <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d0/immuser_8h.html#a47">ImmGetImeInfoEx</a>(&amp;iiex, <a class="code" href="../../d8/d0/immstruc_8h.html#a75a52">ImeInfoExKeyboardLayout</a>, &amp;hKL))
00474         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00475 
00476     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00477 }
00478 
00479 
<a name="l00480"></a><a class="code" href="../../d4/d1/layout_8c.html#a7">00480</a> <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> <a class="code" href="../../d4/d1/layout_8c.html#a7">StrToUInt</a>(
00481     LPWSTR lpsz)
00482 {
00483     UNICODE_STRING Value;
00484     <a class="code" href="../../d9/d5/ndismain_8h.html#a265">UINT</a> ReturnValue;
00485 
00486     Value.Length = wcslen(lpsz) * <span class="keyword">sizeof</span>(WCHAR);
00487     Value.Buffer = lpsz;
00488 
00489     <span class="comment">/*</span>
00490 <span class="comment">     * Convert string to int.</span>
00491 <span class="comment">     */</span>
00492     <a class="code" href="../../d9/d3/cnvint_8c.html#a4">RtlUnicodeStringToInteger</a>(&amp;Value, 16, &amp;ReturnValue);
00493     <span class="keywordflow">return</span>(ReturnValue);
00494 }
00495 
00496 
<a name="l00497"></a><a class="code" href="../../d4/d1/layout_8c.html#a8">00497</a> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a> <a class="code" href="../../d4/d1/layout_8c.html#a8">UIntToStr</a>(
00498     UINT   Value,
00499     ULONG  Base,
00500     LPWSTR lpsz,
00501     USHORT dwBufLen)
00502 {
00503     UNICODE_STRING <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>;
00504 
00505     <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>.Length = dwBufLen;
00506     <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>.MaximumLength = dwBufLen;
00507     <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>.Buffer = lpsz;
00508 
00509     <span class="comment">/*</span>
00510 <span class="comment">     * Convert int to string.</span>
00511 <span class="comment">     */</span>
00512     <a class="code" href="../../d9/d3/cnvint_8c.html#a6">RtlIntegerToUnicodeString</a>(Value, Base, &amp;<a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>);
00513 }
00514 
00515 
<a name="l00516"></a><a class="code" href="../../d4/d1/layout_8c.html#a9">00516</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/layout_8c.html#a9">CopyImeFile</a>(
00517     LPWSTR lpwszImeFileName,
00518     LPCWSTR lpwszImeCopiedPath)
00519 {
00520     HMODULE         hLzExpandDll;
00521     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>            fUnloadExpandDll;
00522     <a class="code" href="../../d4/d1/layout_8c.html#a4">LPFNLZOPENFILEW</a> lpfnLZOpenFileW;
00523     <a class="code" href="../../d4/d1/layout_8c.html#a5">LPFNLZCOPY</a>      lpfnLZCopy;
00524     <a class="code" href="../../d4/d1/layout_8c.html#a6">LPFNLZCLOSE</a>     lpfnLZClose;
00525     OFSTRUCT        ofStruc;
00526     HFILE           hfSource, hfDest;
00527     LPSTR           lpszImeCopiedPath;
00528     <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>             i, cbBuffer;
00529     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>            fRet = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00530 
00531     hLzExpandDll = GetModuleHandle(<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"LZ32"</span>);
00532     <span class="keywordflow">if</span> (hLzExpandDll) {
00533         fUnloadExpandDll = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00534     } <span class="keywordflow">else</span> {
00535         WCHAR szLzExpand[<a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>];
00536 
00537         <a class="code" href="../../d3/d1/layime_8c.html#a17">GetSystemPathName</a>(szLzExpand, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"LZ32"</span>, <a class="code" href="../../d3/d9/arcinst_8c.html#a6">MAX_PATH</a>);
00538         hLzExpandDll = LoadLibrary(szLzExpand);
00539         <span class="keywordflow">if</span> (!hLzExpandDll) {
00540             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00541         }
00542 
00543         fUnloadExpandDll = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00544     }
00545 
00546 <span class="preprocessor">#define GET_PROC(x) \</span>
00547 <span class="preprocessor">    if (!(lpfn##x = (PVOID) GetProcAddress(hLzExpandDll, sz##x))) { \</span>
00548 <span class="preprocessor">        goto CopyImeFileFailed; }</span>
00549 <span class="preprocessor"></span>
00550     <a class="code" href="../../d3/d1/layime_8c.html#a8">GET_PROC</a>(LZOpenFileW);
00551     <a class="code" href="../../d3/d1/layime_8c.html#a8">GET_PROC</a>(LZCopy);
00552     <a class="code" href="../../d3/d1/layime_8c.html#a8">GET_PROC</a>(LZClose);
00553 
00554 <span class="preprocessor">#undef GET_PROC</span>
00555 <span class="preprocessor"></span>
00556     cbBuffer = (wcslen(lpwszImeCopiedPath) + 1) * <span class="keyword">sizeof</span>(WCHAR);
00557 
00558     <span class="keywordflow">if</span> ((lpszImeCopiedPath = <a class="code" href="../../d5/d0/w32_2ntuser_2imm_2misc_8c.html#a22">ImmLocalAlloc</a>(0, cbBuffer)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00559         <span class="keywordflow">goto</span> CopyImeFileFailed;
00560 
00561     i = WideCharToMultiByte(CP_ACP,
00562                             (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)0,
00563                             lpwszImeCopiedPath,          <span class="comment">// src</span>
00564                             wcslen(lpwszImeCopiedPath),
00565                             lpszImeCopiedPath,           <span class="comment">// dest</span>
00566                             cbBuffer,
00567                             (LPSTR)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00568                             (LPBOOL)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00569     <span class="keywordflow">if</span> (i == 0) {
00570         <a class="code" href="../../d4/d0/immcli_8h.html#a8">ImmLocalFree</a>(lpszImeCopiedPath);
00571         <span class="keywordflow">goto</span> CopyImeFileFailed;
00572     }
00573 
00574     lpszImeCopiedPath[i] = <span class="charliteral">'\0'</span>;
00575 
00576     hfSource = (*lpfnLZOpenFileW)(lpwszImeFileName, &amp;ofStruc, OF_READ);
00577     <span class="keywordflow">if</span> (hfSource &lt; 0) {
00578         <a class="code" href="../../d4/d0/immcli_8h.html#a8">ImmLocalFree</a>(lpszImeCopiedPath);
00579         <span class="keywordflow">goto</span> CopyImeFileFailed;
00580     }
00581 
00582     hfDest = OpenFile(lpszImeCopiedPath, &amp;ofStruc, OF_CREATE);
00583     <span class="keywordflow">if</span> (hfDest != HFILE_ERROR) {
00584         <span class="keywordflow">if</span> ((*lpfnLZCopy)(hfSource, hfDest) &gt;= 0) {
00585             fRet = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00586         }
00587         _lclose(hfDest);
00588     }
00589 
00590     (*lpfnLZClose)(hfSource);
00591 
00592     <a class="code" href="../../d4/d0/immcli_8h.html#a8">ImmLocalFree</a>(lpszImeCopiedPath);
00593 
00594 CopyImeFileFailed:
00595     <span class="keywordflow">if</span> (fUnloadExpandDll)
00596         FreeLibrary(hLzExpandDll);
00597 
00598     <span class="keywordflow">return</span> fRet;
00599 }
00600 
00601 
<a name="l00602"></a><a class="code" href="../../d4/d1/layout_8c.html#a10">00602</a> <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a> <a class="code" href="../../d4/d1/layout_8c.html#a10">GetImeLayout</a>(
00603     <a class="code" href="../../d1/d8/structtagIMELAYOUT.html">PIMELAYOUT</a> pImeLayout,
00604     INT        cEntery)
00605 {
00606     <span class="keywordtype">int</span>      i, nIMEs;
00607     HKEY     hKeyKbdLayout;
00608     HKEY     hKeyOneIME;
00609     WCHAR    szKeyName[<a class="code" href="../../d4/d0/immcli_8h.html#a1">HEX_ASCII_SIZE</a>];
00610     WCHAR    szImeFileName[<a class="code" href="../../d8/d0/immstruc_8h.html#a22">IM_FILE_SIZE</a>];
00611     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>    dwKeyNameSize;
00612     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>    dwTmp;
00613 
00614     RegOpenKey(HKEY_LOCAL_MACHINE, <a class="code" href="../../d2/d6/ntuser_2imm_2globals_8c.html#a11">gszRegKbdLayout</a>, &amp;hKeyKbdLayout);
00615 
00616     dwKeyNameSize = <span class="keyword">sizeof</span>(szKeyName);
00617 
00618     <span class="keywordflow">for</span> (i = 0, nIMEs = 0;
00619          RegEnumKey(hKeyKbdLayout, i, szKeyName, dwKeyNameSize) == ERROR_SUCCESS;
00620          i++)
00621     {
00622         <span class="keywordflow">if</span> (szKeyName[0] != <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'E'</span> &amp;&amp; szKeyName[0] != <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'e'</span>)
00623             <span class="keywordflow">continue</span>;   <span class="comment">// this is not an IME based keyboard layout.</span>
00624 
00625         <span class="keywordflow">if</span> (pImeLayout != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00626 
00627             <span class="keywordflow">if</span> (nIMEs &gt;= cEntery)
00628                 <span class="keywordflow">break</span>;
00629 
00630             RegOpenKey(hKeyKbdLayout, szKeyName, &amp;hKeyOneIME);
00631 
00632             dwTmp = <a class="code" href="../../d8/d0/immstruc_8h.html#a22">IM_FILE_SIZE</a>;
00633 
00634             RegQueryValueEx(hKeyOneIME,
00635                     <a class="code" href="../../d2/d6/ntuser_2imm_2globals_8c.html#a15">gszValImeFile</a>,
00636                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00637                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00638                     (LPBYTE)szImeFileName,
00639                     &amp;dwTmp);
00640 
00641             <span class="comment">// avoid length problem</span>
00642             szImeFileName[<a class="code" href="../../d8/d0/immstruc_8h.html#a22">IM_FILE_SIZE</a> - 1] = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\0'</span>;
00643 
00644             RegCloseKey(hKeyOneIME);
00645 
00646             CharUpper(szImeFileName);
00647 
00648             pImeLayout[nIMEs].<a class="code" href="../../d1/d8/structtagIMELAYOUT.html#o0">hImeKL</a> = (HKL)IntToPtr( <a class="code" href="../../d4/d1/layout_8c.html#a7">StrToUInt</a>(szKeyName) );
00649             wcscpy(pImeLayout[nIMEs].szKeyName, szKeyName);
00650             wcscpy(pImeLayout[nIMEs].szImeName, szImeFileName);
00651         }
00652 
00653         nIMEs++;
00654     }
00655 
00656     RegCloseKey(hKeyKbdLayout);
00657 
00658     <span class="keywordflow">return</span> nIMEs;
00659 }
00660 
00661 
<a name="l00662"></a><a class="code" href="../../d4/d1/layout_8c.html#a11">00662</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/layout_8c.html#a11">WriteImeLayout</a>(
00663     HKL     hImeKL,
00664     LPCWSTR lpwszImeFilePart,
00665     LPCWSTR lpszLayoutText)
00666 {
00667     <span class="keywordtype">int</span>      i;
00668     HKEY     hKeyKbdLayout;
00669     HKEY     hKeyOneIME;
00670     HKEY     hKeyKbdOrder;
00671     WCHAR    szKeyName[<a class="code" href="../../d4/d0/immcli_8h.html#a1">HEX_ASCII_SIZE</a>];
00672     WCHAR    szImeFileName[<a class="code" href="../../d8/d0/immstruc_8h.html#a22">IM_FILE_SIZE</a>];
00673     WCHAR    szOrderNum[<a class="code" href="../../d4/d0/immcli_8h.html#a1">HEX_ASCII_SIZE</a>];
00674     WCHAR    szOrderKeyName[<a class="code" href="../../d4/d0/immcli_8h.html#a1">HEX_ASCII_SIZE</a>];
00675     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>    dwTmp;
00676 
00677     <span class="keywordflow">if</span> (RegOpenKey(HKEY_LOCAL_MACHINE,
00678                    <a class="code" href="../../d2/d6/ntuser_2imm_2globals_8c.html#a11">gszRegKbdLayout</a>,
00679                    &amp;hKeyKbdLayout) != ERROR_SUCCESS) {
00680         RIPMSG0(RIP_WARNING, <span class="stringliteral">"WriteImeLayout: RegOpenKey() failed!"</span>);
00681         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00682     }
00683 
00684     <a class="code" href="../../d4/d1/layout_8c.html#a8">UIntToStr</a>(HandleToUlong(hImeKL), 16, szKeyName, <span class="keyword">sizeof</span>(szKeyName));
00685 
00686     <span class="keywordflow">if</span> (RegCreateKey(hKeyKbdLayout,
00687                 szKeyName,
00688                 &amp;hKeyOneIME) != ERROR_SUCCESS) {
00689         RIPMSG0(RIP_WARNING, <span class="stringliteral">"WriteImeLayout: RegCreateKey() failed!"</span>);
00690         RegCloseKey(hKeyKbdLayout);
00691         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00692     }
00693 
00694     <span class="keywordflow">if</span> (RegSetValueExW(hKeyOneIME,
00695                 <a class="code" href="../../d2/d6/ntuser_2imm_2globals_8c.html#a15">gszValImeFile</a>,
00696                 0,
00697                 REG_SZ,
00698                 (CONST <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>*)lpwszImeFilePart,
00699                 (wcslen(lpwszImeFilePart) + 1) * <span class="keyword">sizeof</span>(WCHAR)) != ERROR_SUCCESS) {
00700         <span class="keywordflow">goto</span> WriteImeLayoutFail;
00701     }
00702 
00703     <span class="keywordflow">if</span> (RegSetValueExW(hKeyOneIME,
00704                 <a class="code" href="../../d2/d6/ntuser_2imm_2globals_8c.html#a13">gszValLayoutText</a>,
00705                 0,
00706                 REG_SZ,
00707                 (CONST <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>*)lpszLayoutText,
00708                 (wcslen(lpszLayoutText) + 1) * <span class="keyword">sizeof</span>(WCHAR)) != ERROR_SUCCESS) {
00709         <span class="keywordflow">goto</span> WriteImeLayoutFail;
00710     }
00711 
00712     <span class="keywordflow">switch</span> (<a class="code" href="../../d4/d0/immcli_8h.html#a24">LANGIDFROMHKL</a>(hImeKL)) {
00713         <span class="keywordflow">case</span> LANG_JAPANESE:
00714             wcscpy(szImeFileName, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"kbdjpn.dll"</span>);
00715             <span class="keywordflow">break</span>;
00716         <span class="keywordflow">case</span> LANG_KOREAN:
00717             wcscpy(szImeFileName, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"kbdkor.dll"</span>);
00718             <span class="keywordflow">break</span>;
00719         <span class="keywordflow">case</span> LANG_CHINESE:
00720         <span class="keywordflow">default</span>:
00721             wcscpy(szImeFileName, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"kbdus.dll"</span>);
00722             <span class="keywordflow">break</span>;
00723     }
00724 
00725     <span class="keywordflow">if</span> (RegSetValueExW(hKeyOneIME,
00726                 <a class="code" href="../../d2/d6/ntuser_2imm_2globals_8c.html#a14">gszValLayoutFile</a>,
00727                 0,
00728                 REG_SZ,
00729                 (CONST <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>*)szImeFileName,
00730                 (wcslen(szImeFileName) + 1) * <span class="keyword">sizeof</span>(WCHAR)) != ERROR_SUCCESS) {
00731         <span class="keywordflow">goto</span> WriteImeLayoutFail;
00732     }
00733 
00734     RegCloseKey(hKeyOneIME);
00735     RegCloseKey(hKeyKbdLayout);
00736 
00737     <span class="comment">/*</span>
00738 <span class="comment">     * Update CurrentUser's preload keyboard layout setting</span>
00739 <span class="comment">     */</span>
00740     RegCreateKey(HKEY_CURRENT_USER, <a class="code" href="../../d2/d6/ntuser_2imm_2globals_8c.html#a12">gszRegKbdOrder</a>, &amp;hKeyKbdOrder);
00741 
00742     <span class="keywordflow">for</span> (i = 1; i &lt; 1024; i++) {
00743         <a class="code" href="../../d4/d1/layout_8c.html#a8">UIntToStr</a>(i, 10, szOrderNum, <span class="keyword">sizeof</span>(szOrderNum));
00744 
00745         dwTmp = <span class="keyword">sizeof</span>(szOrderKeyName);
00746         <span class="keywordflow">if</span> (RegQueryValueEx(hKeyKbdOrder,
00747                     szOrderNum,
00748                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00749                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00750                     (LPBYTE)szOrderKeyName,
00751                     &amp;dwTmp) != ERROR_SUCCESS) {
00752             <span class="keywordflow">break</span>;
00753         }
00754 
00755         <span class="keywordflow">if</span> (_wcsicmp(szKeyName, szOrderKeyName) == 0) {
00756             <span class="comment">/*</span>
00757 <span class="comment">             * We have the same value in the preload!</span>
00758 <span class="comment">             * OK, ISV is developing their IMEs</span>
00759 <span class="comment">             * so even it is in preload, but it can not be loaded</span>
00760 <span class="comment">             */</span>
00761             <span class="keywordflow">break</span>;
00762         }
00763     }
00764 
00765     <span class="keywordflow">if</span> (i &lt; 1024) {
00766         <span class="comment">/*</span>
00767 <span class="comment">         * Write a subkey under "preload"</span>
00768 <span class="comment">         */</span>
00769         RegSetValueExW(hKeyKbdOrder,
00770                        szOrderNum,
00771                        0,
00772                        REG_SZ,
00773                        (CONST <a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a>*)szKeyName,
00774                        (lstrlen(szKeyName) + 1) * <span class="keyword">sizeof</span>(WCHAR));
00775         RegCloseKey(hKeyKbdOrder);
00776     }
00777     <span class="keywordflow">else</span> {
00778         RegCloseKey(hKeyKbdOrder);
00779         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00780     }
00781 
00782     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00783 
00784 WriteImeLayoutFail:
00785     RegCloseKey(hKeyOneIME);
00786     RegDeleteKey(hKeyKbdLayout, szKeyName);
00787     RegCloseKey(hKeyKbdLayout);
00788 
00789     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00790 }
00791 
00792 
<a name="l00793"></a><a class="code" href="../../d4/d1/layout_8c.html#a12">00793</a> HKL <a class="code" href="../../d4/d1/layout_8c.html#a12">AssignNewLayout</a>(
00794     INT        nIMEs,
00795     <a class="code" href="../../d1/d8/structtagIMELAYOUT.html">PIMELAYOUT</a> pImeLayout,
00796     HKL        hLangKL)
00797 {
00798     <span class="keywordtype">int</span>   i;
00799     HKL   hHighKL, hLowKL;
00800     HKL   hImeNewKL;
00801 
00802     <span class="comment">/*</span>
00803 <span class="comment">     * We prefer the value higher than E01F for ISVs, we will use</span>
00804 <span class="comment">     * E001 ~ E01F in Microsoft .INF file</span>
00805 <span class="comment">     */</span>
00806     hHighKL = (HKL)((<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)0xE01F0000 + (ULONG_PTR)hLangKL);
00807     hLowKL  = (HKL)((<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)0xE0FF0000 + (ULONG_PTR)hLangKL);
00808 
00809     <span class="comment">/*</span>
00810 <span class="comment">     * Find out the high and low one</span>
00811 <span class="comment">     */</span>
00812     <span class="keywordflow">for</span> (i = 0; i &lt; nIMEs; i++) {
00813         <span class="keywordflow">if</span> (pImeLayout[i].<a class="code" href="../../d1/d8/structtagIMELAYOUT.html#o0">hImeKL</a> &gt; hHighKL) {
00814             hHighKL = pImeLayout[i].<a class="code" href="../../d1/d8/structtagIMELAYOUT.html#o0">hImeKL</a>;
00815         }
00816 
00817         <span class="keywordflow">if</span> (pImeLayout[i].<a class="code" href="../../d1/d8/structtagIMELAYOUT.html#o0">hImeKL</a> &lt; hLowKL) {
00818             hLowKL = pImeLayout[i].<a class="code" href="../../d1/d8/structtagIMELAYOUT.html#o0">hImeKL</a>;
00819         }
00820     }
00821 
00822     <span class="comment">/*</span>
00823 <span class="comment">     * This way is more preferable for app consideration</span>
00824 <span class="comment">     * we don't want app think this is a old keyboard layout</span>
00825 <span class="comment">     * some apps will put hKL into their documents.</span>
00826 <span class="comment">     */</span>
00827     <span class="keywordflow">if</span> (hHighKL &lt; (HKL)UIntToPtr( 0xE0FF0000 )) {
00828         hImeNewKL = (HKL)((ULONG_PTR)hHighKL + (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)0x10000);
00829     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (hLowKL  &gt; (HKL)UIntToPtr( 0xE0010000 )) {
00830         hImeNewKL = (HKL)((ULONG_PTR)hLowKL  - (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)0x10000);
00831     } <span class="keywordflow">else</span> {
00832         <span class="comment">/*</span>
00833 <span class="comment">         * find out a hKL using search, find it one by one</span>
00834 <span class="comment">         */</span>
00835         <span class="keywordflow">for</span> (hLowKL = (HKL)((<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)0xE0200000 + (ULONG_PTR)hLangKL);
00836              hLowKL &lt; (HKL)UIntToPtr( 0xE1000000 );
00837              hLowKL = (HKL)((ULONG_PTR)hLowKL + (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)0x10000)) {
00838 
00839             <span class="keywordflow">for</span> (i = 0; i &lt; nIMEs; i++) {
00840                  <span class="keywordflow">if</span> (HIWORD(HandleToUlong(pImeLayout[i].hImeKL)) == HIWORD(HandleToUlong(hLowKL))) {
00841                      <span class="comment">// conflict with existing IME, try next hLowKL</span>
00842                      <span class="keywordflow">break</span>;
00843                  }
00844             }
00845 
00846             <span class="keywordflow">if</span> (i &gt;= nIMEs) {
00847                 <span class="keywordflow">break</span>;
00848             }
00849         }
00850 
00851         <span class="keywordflow">if</span> (hLowKL &gt;= (HKL)UIntToPtr( 0xE1000000 )) {
00852             hImeNewKL = (HKL)0;
00853         }
00854         <span class="keywordflow">else</span> {
00855             hImeNewKL = hLowKL;
00856         }
00857     }
00858 
00859     <span class="keywordflow">return</span> hImeNewKL;
00860 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:36 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
