<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: rtdmpsec.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>rtdmpsec.c</h1><a href="../../d4/d1/rtdmpsec_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1991  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    rtdmpsec.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    NT level registry security test program #1, basic non-error paths.</span>
00012 <span class="comment"></span>
00013 <span class="comment">    Dump out the security descriptors of a sub-tree of the registry.</span>
00014 <span class="comment"></span>
00015 <span class="comment">    rtdmpsec &lt;KeyPath&gt;</span>
00016 <span class="comment"></span>
00017 <span class="comment">    Will ennumerate and dump out the subkeys and values of KeyPath,</span>
00018 <span class="comment">    and then apply itself recursively to each subkey it finds.</span>
00019 <span class="comment"></span>
00020 <span class="comment">    It assumes data values are null terminated strings.</span>
00021 <span class="comment"></span>
00022 <span class="comment">    Example:</span>
00023 <span class="comment"></span>
00024 <span class="comment">        rtdmpsec \REGISTRY\MACHINE\TEST\bigkey</span>
00025 <span class="comment"></span>
00026 <span class="comment">Author:</span>
00027 <span class="comment"></span>
00028 <span class="comment">    John Vert (jvert) 24-Jan-92</span>
00029 <span class="comment"></span>
00030 <span class="comment">        based on rtdmp.c by</span>
00031 <span class="comment"></span>
00032 <span class="comment">    Bryan Willman (bryanwi)  10-Dec-91</span>
00033 <span class="comment"></span>
00034 <span class="comment">        and getdacl.c by RobertRe</span>
00035 <span class="comment"></span>
00036 <span class="comment">Revision History:</span>
00037 <span class="comment"></span>
00038 <span class="comment">    Richard Ward (richardw)  14 April 1992   Changed ACE_HEADER</span>
00039 <span class="comment"></span>
00040 <span class="comment">--*/</span>
00041 
00042 <span class="preprocessor">#include "<a class="code" href="../../d1/d2/cmp_8h.html">cmp.h</a>"</span>
00043 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00044 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
00045 <span class="preprocessor">#include &lt;string.h&gt;</span>
00046 
<a name="l00047"></a><a class="code" href="../../d4/d1/rtdmpsec_8c.html#a0">00047</a> <span class="preprocessor">#define WORK_SIZE   1024</span>
00048 <span class="preprocessor"></span>
00049 <span class="comment">//</span>
00050 <span class="comment">//  Get a pointer to the first ace in an acl</span>
00051 <span class="comment">//</span>
00052 
<a name="l00053"></a><a class="code" href="../../d4/d1/rtdmpsec_8c.html#a1">00053</a> <span class="preprocessor">#define FirstAce(Acl) ((PVOID)((PUCHAR)(Acl) + sizeof(ACL)))</span>
00054 <span class="preprocessor"></span>
00055 <span class="comment">//</span>
00056 <span class="comment">//  Get a pointer to the following ace</span>
00057 <span class="comment">//</span>
00058 
<a name="l00059"></a><a class="code" href="../../d4/d1/rtdmpsec_8c.html#a2">00059</a> <span class="preprocessor">#define NextAce(Ace) ((PVOID)((PUCHAR)(Ace) + ((PACE_HEADER)(Ace))-&gt;AceSize))</span>
00060 <span class="preprocessor"></span>
00061 <span class="comment">//</span>
00062 <span class="comment">// Generic ACE structure, to be used for casting ACE's of known types</span>
00063 <span class="comment">//</span>
00064 
<a name="l00065"></a><a class="code" href="../../d4/d7/struct__KNOWN__ACE.html">00065</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d4/d7/struct__KNOWN__ACE.html">_KNOWN_ACE</a> {
<a name="l00066"></a><a class="code" href="../../d4/d7/struct__KNOWN__ACE.html#o0">00066</a>    ACE_HEADER <a class="code" href="../../d4/d7/struct__KNOWN__ACE.html#o0">Header</a>;
<a name="l00067"></a><a class="code" href="../../d4/d7/struct__KNOWN__ACE.html#o1">00067</a>    ACCESS_MASK <a class="code" href="../../d4/d7/struct__KNOWN__ACE.html#o1">Mask</a>;
<a name="l00068"></a><a class="code" href="../../d4/d7/struct__KNOWN__ACE.html#o2">00068</a>    ULONG <a class="code" href="../../d4/d7/struct__KNOWN__ACE.html#o2">SidStart</a>;
00069    } <a class="code" href="../../d4/d7/struct__KNOWN__ACE.html">KNOWN_ACE</a>, *<a class="code" href="../../d4/d7/struct__KNOWN__ACE.html">PKNOWN_ACE</a>;
00070 
00071 
00072 
00073 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00074 <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a17">InitVars</a>();
00075 
00076 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00077 <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a18">PrintAcl</a> (
00078     IN PACL Acl
00079     );
00080 
00081 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00082 <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a19">PrintAccessMask</a>(
00083     IN ACCESS_MASK AccessMask
00084     );
00085 
00086 <span class="keywordtype">void</span> __cdecl <a class="code" href="../../d2/d5/editreg_8c.html#a87">main</a>(<span class="keywordtype">int</span>, <span class="keywordtype">char</span> *);
00087 <span class="keywordtype">void</span> <a class="code" href="../../d8/d0/rtbatcr_8c.html#a13">processargs</a>();
00088 
00089 <span class="keywordtype">void</span> <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a22">print</a>(PUNICODE_STRING);
00090 
00091 <span class="keywordtype">void</span>
00092 <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a23">DumpSecurity</a>(
00093     HANDLE  Handle
00094     );
00095 
00096 <span class="keywordtype">void</span>
00097 <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a24">Dump</a>(
00098     HANDLE  Handle
00099     );
00100 
<a name="l00101"></a><a class="code" href="../../d4/d1/rtdmpsec_8c.html#a5">00101</a> UNICODE_STRING  <a class="code" href="../../d8/d0/rtbatcr_8c.html#a10">WorkName</a>;
<a name="l00102"></a><a class="code" href="../../d4/d1/rtdmpsec_8c.html#a6">00102</a> WCHAR           <a class="code" href="../../d8/d0/rtbatcr_8c.html#a11">workbuffer</a>[<a class="code" href="../../d8/d0/rtbatcr_8c.html#a0">WORK_SIZE</a>];
00103 
00104 <span class="comment">//</span>
00105 <span class="comment">// Universal well known SIDs</span>
00106 <span class="comment">//</span>
00107 
<a name="l00108"></a><a class="code" href="../../d4/d1/rtdmpsec_8c.html#a7">00108</a> PSID  <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a7">NullSid</a>;
<a name="l00109"></a><a class="code" href="../../d4/d1/rtdmpsec_8c.html#a8">00109</a> PSID  <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a8">WorldSid</a>;
<a name="l00110"></a><a class="code" href="../../d4/d1/rtdmpsec_8c.html#a9">00110</a> PSID  <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a9">LocalSid</a>;
<a name="l00111"></a><a class="code" href="../../d4/d1/rtdmpsec_8c.html#a10">00111</a> PSID  <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a10">CreatorOwnerSid</a>;
00112 
00113 <span class="comment">//</span>
00114 <span class="comment">// Sids defined by NT</span>
00115 <span class="comment">//</span>
00116 
<a name="l00117"></a><a class="code" href="../../d4/d1/rtdmpsec_8c.html#a11">00117</a> PSID <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a11">NtAuthoritySid</a>;
00118 
<a name="l00119"></a><a class="code" href="../../d4/d1/rtdmpsec_8c.html#a12">00119</a> PSID <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a12">DialupSid</a>;
<a name="l00120"></a><a class="code" href="../../d4/d1/rtdmpsec_8c.html#a13">00120</a> PSID <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a13">NetworkSid</a>;
<a name="l00121"></a><a class="code" href="../../d4/d1/rtdmpsec_8c.html#a14">00121</a> PSID <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a14">BatchSid</a>;
<a name="l00122"></a><a class="code" href="../../d4/d1/rtdmpsec_8c.html#a15">00122</a> PSID <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a15">InteractiveSid</a>;
<a name="l00123"></a><a class="code" href="../../d4/d1/rtdmpsec_8c.html#a16">00123</a> PSID <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a16">LocalSystemSid</a>;
00124 
00125 <span class="keywordtype">void</span>
<a name="l00126"></a><a class="code" href="../../d4/d1/rtdmpsec_8c.html#a25">00126</a> __cdecl <a class="code" href="../../d2/d5/editreg_8c.html#a87">main</a>(
00127     <span class="keywordtype">int</span> argc,
00128     <span class="keywordtype">char</span> *argv[]
00129     )
00130 {
00131     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00132     OBJECT_ATTRIBUTES <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>;
00133     HANDLE          BaseHandle;
00134 
00135     <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a17">InitVars</a>();
00136 
00137     <span class="comment">//</span>
00138     <span class="comment">// Process args</span>
00139     <span class="comment">//</span>
00140 
00141     <a class="code" href="../../d8/d0/rtbatcr_8c.html#a10">WorkName</a>.MaximumLength = <a class="code" href="../../d8/d0/rtbatcr_8c.html#a0">WORK_SIZE</a>;
00142     <a class="code" href="../../d8/d0/rtbatcr_8c.html#a10">WorkName</a>.Length = 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00143     <a class="code" href="../../d8/d0/rtbatcr_8c.html#a10">WorkName</a>.Buffer = &amp;(<a class="code" href="../../d8/d0/rtbatcr_8c.html#a11">workbuffer</a>[0]);
00144 
00145     <a class="code" href="../../d8/d0/rtbatcr_8c.html#a13">processargs</a>(argc, argv);
00146 
00147 
00148     <span class="comment">//</span>
00149     <span class="comment">// Set up and open KeyPath</span>
00150     <span class="comment">//</span>
00151 
00152     printf(<span class="stringliteral">"rtdmpsec: starting\n"</span>);
00153 
00154     InitializeObjectAttributes(
00155         &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00156         &amp;<a class="code" href="../../d8/d0/rtbatcr_8c.html#a10">WorkName</a>,
00157         0,
00158         (HANDLE)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00159         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00160         );
00161     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>.Attributes |= OBJ_CASE_INSENSITIVE;
00162 
00163     status = <a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a>(
00164                 &amp;BaseHandle,
00165                 MAXIMUM_ALLOWED,
00166                 &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>
00167                 );
00168     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00169         printf(<span class="stringliteral">"rtdmpsec: t0: %08lx\n"</span>, status);
00170         <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>(1);
00171     }
00172 
00173     <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a24">Dump</a>(BaseHandle);
00174 }
00175 
00176 
00177 <span class="keywordtype">void</span>
00178 <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a24">Dump</a>(
00179     HANDLE  Handle
00180     )
00181 {
00182     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    status;
00183     PKEY_BASIC_INFORMATION KeyInformation;
00184     OBJECT_ATTRIBUTES <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>;
00185     ULONG   NamePos;
00186     ULONG   index;
00187     STRING  enumname;
00188     HANDLE  WorkHandle;
00189     ULONG   ResultLength;
00190     <span class="keyword">static</span>  <span class="keywordtype">char</span> buffer[<a class="code" href="../../d8/d0/rtbatcr_8c.html#a0">WORK_SIZE</a>];
00191     PUCHAR  p;
00192 
00193     KeyInformation = (PKEY_BASIC_INFORMATION)buffer;
00194     NamePos = <a class="code" href="../../d8/d0/rtbatcr_8c.html#a10">WorkName</a>.Length;
00195 
00196     <span class="comment">//</span>
00197     <span class="comment">// Print name of node we are about to dump out</span>
00198     <span class="comment">//</span>
00199     printf(<span class="stringliteral">"\n"</span>);
00200     <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a22">print</a>(&amp;WorkName);
00201     printf(<span class="stringliteral">"::\n"</span>);
00202 
00203     <span class="comment">//</span>
00204     <span class="comment">// Print out node's values</span>
00205     <span class="comment">//</span>
00206     <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a23">DumpSecurity</a>(Handle);
00207 
00208     <span class="comment">//</span>
00209     <span class="comment">// Enumerate node's children and apply ourselves to each one</span>
00210     <span class="comment">//</span>
00211 
00212     <span class="keywordflow">for</span> (index = 0; <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>; index++) {
00213 
00214         RtlZeroMemory(KeyInformation, WORK_SIZE);
00215         status = <a class="code" href="../../d7/d7/ntapi_8c.html#a17">NtEnumerateKey</a>(
00216                     Handle,
00217                     index,
00218                     KeyBasicInformation,
00219                     KeyInformation,
00220                     WORK_SIZE,
00221                     &amp;ResultLength
00222                     );
00223 
00224         <span class="keywordflow">if</span> (status == STATUS_NO_MORE_ENTRIES) {
00225 
00226             <a class="code" href="../../d8/d0/rtbatcr_8c.html#a10">WorkName</a>.Length = NamePos;
00227             <span class="keywordflow">return</span>;
00228 
00229         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00230 
00231             printf(<span class="stringliteral">"rtdmpsec: dump1: status = %08lx\n"</span>, status);
00232             <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>(1);
00233 
00234         }
00235 
00236         enumname.Buffer = &amp;(KeyInformation-&gt;Name[0]);
00237         enumname.Length = KeyInformation-&gt;NameLength;
00238         enumname.MaximumLength = KeyInformation-&gt;NameLength;
00239 
00240         p = <a class="code" href="../../d8/d0/rtbatcr_8c.html#a10">WorkName</a>.Buffer;
00241         p += <a class="code" href="../../d8/d0/rtbatcr_8c.html#a10">WorkName</a>.Length;
00242         *p = <span class="charliteral">'\\'</span>;
00243         p++;
00244         *p = <span class="charliteral">'\0'</span>;
00245         <a class="code" href="../../d8/d0/rtbatcr_8c.html#a10">WorkName</a>.Length += 2;
00246 
00247         <a class="code" href="../../d2/d7/string_8c.html#a16">RtlAppendStringToString</a>((PSTRING)&amp;WorkName, (PSTRING)&amp;enumname);
00248 
00249         InitializeObjectAttributes(
00250             &amp;ObjectAttributes,
00251             &amp;enumname,
00252             0,
00253             Handle,
00254             NULL
00255             );
00256         <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>.Attributes |= OBJ_CASE_INSENSITIVE;
00257 
00258         status = <a class="code" href="../../d7/d7/ntapi_8c.html#a23">NtOpenKey</a>(
00259                     &amp;WorkHandle,
00260                     MAXIMUM_ALLOWED,
00261                     &amp;ObjectAttributes
00262                     );
00263         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00264             <span class="keywordflow">if</span> (status == STATUS_ACCESS_DENIED) {
00265                 printf(<span class="stringliteral">"\n"</span>);
00266                 <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a22">print</a>(&amp;WorkName);
00267                 printf(<span class="stringliteral">"::\n\tAccess denied!\n"</span>);
00268             } <span class="keywordflow">else</span> {
00269                 printf(<span class="stringliteral">"rtdmpsec: dump2: %08lx\n"</span>, status);
00270                 <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>(1);
00271             }
00272         } <span class="keywordflow">else</span> {
00273             <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a24">Dump</a>(WorkHandle);
00274             <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>(WorkHandle);
00275         }
00276 
00277         <a class="code" href="../../d8/d0/rtbatcr_8c.html#a10">WorkName</a>.Length = NamePos;
00278     }
00279 }
00280 
00281 
00282 <span class="keywordtype">void</span>
<a name="l00283"></a><a class="code" href="../../d4/d1/rtdmpsec_8c.html#a23">00283</a> <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a23">DumpSecurity</a>(
00284     HANDLE  Handle
00285     )
00286 {
00287     PSECURITY_DESCRIPTOR SecurityDescriptor;
00288     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00289     ULONG Length;
00290     PACL <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a>;
00291     BOOLEAN DaclPresent;
00292     BOOLEAN DaclDefaulted;
00293 
00294     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d1/obse_8c.html#a2">NtQuerySecurityObject</a>( <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>,
00295                                     DACL_SECURITY_INFORMATION,
00296                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00297                                     0,
00298                                     &amp;Length );
00299 
00300     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_BUFFER_TOO_SMALL) {
00301         printf(<span class="stringliteral">"DumpSecurity t0: NtQuerySecurityObject failed %lx\n"</span>,<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00302         <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>(1);
00303     }
00304 
00305     SecurityDescriptor = malloc(Length);
00306     <span class="keywordflow">if</span> (SecurityDescriptor == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00307         printf(<span class="stringliteral">"DumpSecurity: couldn't malloc buffer\n"</span>);
00308         <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>(1);
00309     }
00310 
00311     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d1/obse_8c.html#a2">NtQuerySecurityObject</a>( <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>,
00312                                     DACL_SECURITY_INFORMATION,
00313                                     SecurityDescriptor,
00314                                     Length,
00315                                     &amp;Length );
00316 
00317     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00318         printf(<span class="stringliteral">"DumpSecurity t1: NtQuerySecurityObject failed %lx\n"</span>,<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00319         <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>(1);
00320     }
00321 
00322     <a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00323 
00324     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a61">RtlGetDaclSecurityDescriptor</a>( SecurityDescriptor,
00325                                            &amp;DaclPresent,
00326                                            &amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a>,
00327                                            &amp;DaclDefaulted );
00328     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00329         printf(<span class="stringliteral">"DumpSecurity t2: RtlGetDaclSecurityDescriptor failed %lx\n"</span>,<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00330     }
00331 
00332     <span class="keywordflow">if</span> (DaclPresent) {
00333         <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a18">PrintAcl</a>(<a class="code" href="../../d6/d0/ctaccess_8c.html#a55">Dacl</a>);
00334     } <span class="keywordflow">else</span> {
00335         printf(<span class="stringliteral">"\tAcl not present\n"</span>);
00336     }
00337 
00338 }
00339 
00340 
00341 <span class="keywordtype">void</span>
00342 <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a22">print</a>(
00343     PUNICODE_STRING  String
00344     )
00345 {
00346     <span class="keyword">static</span>  ANSI_STRING temp;
00347     <span class="keyword">static</span>  <span class="keywordtype">char</span>        tempbuffer[<a class="code" href="../../d8/d0/rtbatcr_8c.html#a0">WORK_SIZE</a>];
00348 
00349     temp.MaximumLength = <a class="code" href="../../d8/d0/rtbatcr_8c.html#a0">WORK_SIZE</a>;
00350     temp.Length = 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00351     temp.Buffer = tempbuffer;
00352 
00353     <a class="code" href="../../d6/d6/nls_8c.html#a23">RtlUnicodeStringToAnsiString</a>(&amp;temp, String, FALSE);
00354     printf(<span class="stringliteral">"%s"</span>, temp.Buffer);
00355     <span class="keywordflow">return</span>;
00356 }
00357 
00358 
00359 <span class="keywordtype">void</span>
<a name="l00360"></a><a class="code" href="../../d4/d1/rtdmpsec_8c.html#a26">00360</a> <a class="code" href="../../d8/d0/rtbatcr_8c.html#a13">processargs</a>(
00361     <span class="keywordtype">int</span> argc,
00362     <span class="keywordtype">char</span> *argv[]
00363     )
00364 {
00365     ANSI_STRING temp;
00366 
00367     <span class="keywordflow">if</span> ( (argc != 2) )
00368     {
00369         printf(<span class="stringliteral">"Usage: %s &lt;KeyPath&gt;\n"</span>,
00370                 argv[0]);
00371         <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>(1);
00372     }
00373 
00374     <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>(
00375         &amp;temp,
00376         argv[1]
00377         );
00378 
00379     <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(
00380         &amp;<a class="code" href="../../d8/d0/rtbatcr_8c.html#a10">WorkName</a>,
00381         &amp;temp,
00382         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
00383         );
00384 
00385     <span class="keywordflow">return</span>;
00386 }
00387 
00388 
00389 BOOLEAN
<a name="l00390"></a><a class="code" href="../../d1/d9/uipers_8c.html#a6">00390</a> <a class="code" href="../../d1/d9/uipers_8c.html#a6">SidTranslation</a>(
00391     PSID Sid,
00392     PSTRING AccountName
00393     )
00394 <span class="comment">// AccountName is expected to have a large maximum length</span>
00395 
00396 {
00397     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>(Sid, <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a8">WorldSid</a>)) {
00398         <a class="code" href="../../d2/d7/string_8c.html#a5">RtlInitString</a>( AccountName, <span class="stringliteral">"WORLD"</span>);
00399         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00400     }
00401 
00402     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>(Sid, <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a9">LocalSid</a>)) {
00403         <a class="code" href="../../d2/d7/string_8c.html#a5">RtlInitString</a>( AccountName, <span class="stringliteral">"LOCAL"</span>);
00404 
00405         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00406     }
00407 
00408     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>(Sid, <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a13">NetworkSid</a>)) {
00409         <a class="code" href="../../d2/d7/string_8c.html#a5">RtlInitString</a>( AccountName, <span class="stringliteral">"NETWORK"</span>);
00410 
00411         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00412     }
00413 
00414     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>(Sid, <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a14">BatchSid</a>)) {
00415         <a class="code" href="../../d2/d7/string_8c.html#a5">RtlInitString</a>( AccountName, <span class="stringliteral">"BATCH"</span>);
00416 
00417         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00418     }
00419 
00420     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>(Sid, <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a15">InteractiveSid</a>)) {
00421         <a class="code" href="../../d2/d7/string_8c.html#a5">RtlInitString</a>( AccountName, <span class="stringliteral">"INTERACTIVE"</span>);
00422         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00423     }
00424 
00425     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>(Sid, <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a16">LocalSystemSid</a>)) {
00426         <a class="code" href="../../d2/d7/string_8c.html#a5">RtlInitString</a>( AccountName, <span class="stringliteral">"SYSTEM"</span>);
00427         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00428     }
00429 
00430 <span class="comment">//</span>
00431 <span class="comment">//    if (RtlEqualSid(Sid, LocalManagerSid)) {</span>
00432 <span class="comment">//      RtlInitString( AccountName, "LOCAL MANAGER");</span>
00433 <span class="comment">//      return(TRUE);</span>
00434 <span class="comment">//  }</span>
00435 
00436 <span class="comment">//  if (RtlEqualSid(Sid, LocalAdminSid)) {</span>
00437 <span class="comment">//      RtlInitString( AccountName, "LOCAL ADMIN");</span>
00438 <span class="comment">//      return(TRUE);</span>
00439 <span class="comment">//  }</span>
00440 
00441     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00442 
00443 }
00444 
00445 
00446 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00447"></a><a class="code" href="../../d4/d1/rtdmpsec_8c.html#a28">00447</a> <a class="code" href="../../d1/d9/uipers_8c.html#a5">DisplayAccountSid</a>(
00448     PSID Sid
00449     )
00450 {
00451     UCHAR <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>[128];
00452     STRING AccountName;
00453     UCHAR i;
00454     ULONG Tmp;
00455     PSID_IDENTIFIER_AUTHORITY IdentifierAuthority;
00456     UCHAR SubAuthorityCount;
00457 
00458     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>[0] = 0;
00459 
00460     AccountName.MaximumLength = 127;
00461     AccountName.Length = 0;
00462     AccountName.Buffer = (PVOID)&amp;<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>[0];
00463 
00464 
00465 
00466     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d9/uipers_8c.html#a6">SidTranslation</a>( (PSID)Sid, &amp;AccountName) ) {
00467 
00468         printf(<span class="stringliteral">"%s\n"</span>, AccountName.Buffer );
00469 
00470     } <span class="keywordflow">else</span> {
00471         IdentifierAuthority = <a class="code" href="../../d8/d6/sertl_8c.html#a42">RtlIdentifierAuthoritySid</a>(Sid);
00472 
00473         <span class="comment">//</span>
00474         <span class="comment">// HACK! HACK!</span>
00475         <span class="comment">// The next line prints the revision of the SID.  Since there is no</span>
00476         <span class="comment">// rtl routine which gives us the SID revision, we must make due.</span>
00477         <span class="comment">// luckily, the revision field is the first field in the SID, so we</span>
00478         <span class="comment">// can just cast the pointer.</span>
00479         <span class="comment">//</span>
00480 
00481         printf(<span class="stringliteral">"S-%u-"</span>, (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) *((PUCHAR) Sid) );
00482 
00483         <span class="keywordflow">if</span> (  (IdentifierAuthority-&gt;Value[0] != 0)  ||
00484               (IdentifierAuthority-&gt;Value[1] != 0)     ){
00485             printf(<span class="stringliteral">"0x%02hx%02hx%02hx%02hx%02hx%02hx"</span>,
00486                         IdentifierAuthority-&gt;Value[0],
00487                         IdentifierAuthority-&gt;Value[1],
00488                         IdentifierAuthority-&gt;Value[2],
00489                         IdentifierAuthority-&gt;Value[3],
00490                         IdentifierAuthority-&gt;Value[4],
00491                         IdentifierAuthority-&gt;Value[5] );
00492         } <span class="keywordflow">else</span> {
00493             Tmp = IdentifierAuthority-&gt;Value[5]          +
00494                   (IdentifierAuthority-&gt;Value[4] &lt;&lt;  8)  +
00495                   (IdentifierAuthority-&gt;Value[3] &lt;&lt; 16)  +
00496                   (IdentifierAuthority-&gt;Value[2] &lt;&lt; 24);
00497             printf(<span class="stringliteral">"%lu"</span>, Tmp);
00498         }
00499 
00500         SubAuthorityCount = *<a class="code" href="../../d8/d6/sertl_8c.html#a44">RtlSubAuthorityCountSid</a>(Sid);
00501         <span class="keywordflow">for</span> (i=0;i&lt;SubAuthorityCount ;i++ ) {
00502             printf(<span class="stringliteral">"-%lu"</span>, (*<a class="code" href="../../d8/d6/sertl_8c.html#a43">RtlSubAuthoritySid</a>(Sid, i)));
00503         }
00504         printf(<span class="stringliteral">"\n"</span>);
00505 
00506     }
00507 
00508 }
00509 
00510 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00511"></a><a class="code" href="../../d4/d1/rtdmpsec_8c.html#a17">00511</a> <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a17">InitVars</a>()
00512 {
00513     ULONG SidWithZeroSubAuthorities;
00514     ULONG SidWithOneSubAuthority;
00515     ULONG SidWithThreeSubAuthorities;
00516     ULONG SidWithFourSubAuthorities;
00517 
00518     SID_IDENTIFIER_AUTHORITY NullSidAuthority    = SECURITY_NULL_SID_AUTHORITY;
00519     SID_IDENTIFIER_AUTHORITY WorldSidAuthority   = SECURITY_WORLD_SID_AUTHORITY;
00520     SID_IDENTIFIER_AUTHORITY LocalSidAuthority   = SECURITY_LOCAL_SID_AUTHORITY;
00521     SID_IDENTIFIER_AUTHORITY CreatorSidAuthority = SECURITY_CREATOR_SID_AUTHORITY;
00522 
00523     SID_IDENTIFIER_AUTHORITY NtAuthority = SECURITY_NT_AUTHORITY;
00524 
00525 
00526     <span class="comment">//</span>
00527     <span class="comment">//  The following SID sizes need to be allocated</span>
00528     <span class="comment">//</span>
00529 
00530     SidWithZeroSubAuthorities  = <a class="code" href="../../d8/d6/sertl_8c.html#a38">RtlLengthRequiredSid</a>( 0 );
00531     SidWithOneSubAuthority     = <a class="code" href="../../d8/d6/sertl_8c.html#a38">RtlLengthRequiredSid</a>( 1 );
00532     SidWithThreeSubAuthorities = <a class="code" href="../../d8/d6/sertl_8c.html#a38">RtlLengthRequiredSid</a>( 3 );
00533     SidWithFourSubAuthorities  = <a class="code" href="../../d8/d6/sertl_8c.html#a38">RtlLengthRequiredSid</a>( 4 );
00534 
00535     <span class="comment">//</span>
00536     <span class="comment">//  Allocate and initialize the universal SIDs</span>
00537     <span class="comment">//</span>
00538 
00539     <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a7">NullSid</a>         = (PSID)malloc(SidWithOneSubAuthority);
00540     <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a8">WorldSid</a>        = (PSID)malloc(SidWithOneSubAuthority);
00541     <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a9">LocalSid</a>        = (PSID)malloc(SidWithOneSubAuthority);
00542     <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a10">CreatorOwnerSid</a> = (PSID)malloc(SidWithOneSubAuthority);
00543 
00544     <a class="code" href="../../d8/d6/sertl_8c.html#a40">RtlInitializeSid</a>( <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a7">NullSid</a>,    &amp;NullSidAuthority, 1 );
00545     <a class="code" href="../../d8/d6/sertl_8c.html#a40">RtlInitializeSid</a>( <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a8">WorldSid</a>,   &amp;WorldSidAuthority, 1 );
00546     <a class="code" href="../../d8/d6/sertl_8c.html#a40">RtlInitializeSid</a>( <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a9">LocalSid</a>,   &amp;LocalSidAuthority, 1 );
00547     <a class="code" href="../../d8/d6/sertl_8c.html#a40">RtlInitializeSid</a>( <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a10">CreatorOwnerSid</a>, &amp;CreatorSidAuthority, 1 );
00548 
00549     *(<a class="code" href="../../d8/d6/sertl_8c.html#a43">RtlSubAuthoritySid</a>( <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a7">NullSid</a>, 0 ))         = SECURITY_NULL_RID;
00550     *(<a class="code" href="../../d8/d6/sertl_8c.html#a43">RtlSubAuthoritySid</a>( <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a8">WorldSid</a>, 0 ))        = SECURITY_WORLD_RID;
00551     *(<a class="code" href="../../d8/d6/sertl_8c.html#a43">RtlSubAuthoritySid</a>( <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a9">LocalSid</a>, 0 ))        = SECURITY_LOCAL_RID;
00552     *(<a class="code" href="../../d8/d6/sertl_8c.html#a43">RtlSubAuthoritySid</a>( <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a10">CreatorOwnerSid</a>, 0 )) = SECURITY_CREATOR_OWNER_RID;
00553 
00554     <span class="comment">//</span>
00555     <span class="comment">// Allocate and initialize the NT defined SIDs</span>
00556     <span class="comment">//</span>
00557 
00558     <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a11">NtAuthoritySid</a>  = (PSID)malloc(SidWithZeroSubAuthorities);
00559     <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a12">DialupSid</a>       = (PSID)malloc(SidWithOneSubAuthority);
00560     <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a13">NetworkSid</a>      = (PSID)malloc(SidWithOneSubAuthority);
00561     <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a14">BatchSid</a>        = (PSID)malloc(SidWithOneSubAuthority);
00562     <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a15">InteractiveSid</a>  = (PSID)malloc(SidWithOneSubAuthority);
00563     <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a16">LocalSystemSid</a>  = (PSID)malloc(SidWithOneSubAuthority);
00564 
00565     <a class="code" href="../../d8/d6/sertl_8c.html#a40">RtlInitializeSid</a>( <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a11">NtAuthoritySid</a>,   &amp;NtAuthority, 0 );
00566     <a class="code" href="../../d8/d6/sertl_8c.html#a40">RtlInitializeSid</a>( <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a12">DialupSid</a>,        &amp;NtAuthority, 1 );
00567     <a class="code" href="../../d8/d6/sertl_8c.html#a40">RtlInitializeSid</a>( <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a13">NetworkSid</a>,       &amp;NtAuthority, 1 );
00568     <a class="code" href="../../d8/d6/sertl_8c.html#a40">RtlInitializeSid</a>( <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a14">BatchSid</a>,         &amp;NtAuthority, 1 );
00569     <a class="code" href="../../d8/d6/sertl_8c.html#a40">RtlInitializeSid</a>( <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a15">InteractiveSid</a>,   &amp;NtAuthority, 1 );
00570     <a class="code" href="../../d8/d6/sertl_8c.html#a40">RtlInitializeSid</a>( <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a16">LocalSystemSid</a>,   &amp;NtAuthority, 1 );
00571 
00572     *(<a class="code" href="../../d8/d6/sertl_8c.html#a43">RtlSubAuthoritySid</a>( <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a12">DialupSid</a>,       0 )) = SECURITY_DIALUP_RID;
00573     *(<a class="code" href="../../d8/d6/sertl_8c.html#a43">RtlSubAuthoritySid</a>( <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a13">NetworkSid</a>,      0 )) = SECURITY_NETWORK_RID;
00574     *(<a class="code" href="../../d8/d6/sertl_8c.html#a43">RtlSubAuthoritySid</a>( <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a14">BatchSid</a>,        0 )) = SECURITY_BATCH_RID;
00575     *(<a class="code" href="../../d8/d6/sertl_8c.html#a43">RtlSubAuthoritySid</a>( <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a15">InteractiveSid</a>,  0 )) = SECURITY_INTERACTIVE_RID;
00576     *(<a class="code" href="../../d8/d6/sertl_8c.html#a43">RtlSubAuthoritySid</a>( <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a16">LocalSystemSid</a>,  0 )) = SECURITY_LOCAL_SYSTEM_RID;
00577 
00578     <span class="keywordflow">return</span>;
00579 
00580 }
00581 
00582 
00583 
00584 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00585"></a><a class="code" href="../../d4/d1/rtdmpsec_8c.html#a18">00585</a> <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a18">PrintAcl</a> (
00586     IN PACL Acl
00587     )
00588 
00589 <span class="comment">/*++</span>
00590 <span class="comment"></span>
00591 <span class="comment">Routine Description:</span>
00592 <span class="comment"></span>
00593 <span class="comment">    This routine dumps an Acl for debug purposes (via printf).  It is</span>
00594 <span class="comment">    specialized to dump standard aces.</span>
00595 <span class="comment"></span>
00596 <span class="comment">Arguments:</span>
00597 <span class="comment"></span>
00598 <span class="comment">    Acl - Supplies the Acl to dump</span>
00599 <span class="comment"></span>
00600 <span class="comment">Return Value:</span>
00601 <span class="comment"></span>
00602 <span class="comment">    None</span>
00603 <span class="comment"></span>
00604 <span class="comment">--*/</span>
00605 
00606 
00607 {
00608     ULONG i;
00609     <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a4">PKNOWN_ACE</a> Ace;
00610     BOOLEAN KnownType;
00611     PCHAR AceTypes[] = { <span class="stringliteral">"Access Allowed"</span>,
00612                          <span class="stringliteral">"Access Denied "</span>,
00613                          <span class="stringliteral">"System Audit  "</span>,
00614                          <span class="stringliteral">"System Alarm  "</span>
00615                        };
00616 
00617     <span class="keywordflow">if</span> (Acl == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00618 
00619         printf(<span class="stringliteral">"\tAcl == ALL ACCESS GRANTED!\n"</span>);
00620         <span class="keywordflow">return</span>;
00621 
00622     }
00623 
00624     <span class="comment">//</span>
00625     <span class="comment">//  Dump the Acl header</span>
00626     <span class="comment">//</span>
00627 
00628     printf(<span class="stringliteral">"\tRevision: %02x"</span>, Acl-&gt;AclRevision);
00629     printf(<span class="stringliteral">" Size: %04x"</span>, Acl-&gt;AclSize);
00630     printf(<span class="stringliteral">" AceCount: %04x\n"</span>, Acl-&gt;AceCount);
00631 
00632     <span class="comment">//</span>
00633     <span class="comment">//  Now for each Ace we want do dump it</span>
00634     <span class="comment">//</span>
00635 
00636     <span class="keywordflow">for</span> (i = 0, Ace = <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a1">FirstAce</a>(Acl);
00637          i &lt; Acl-&gt;AceCount;
00638          i++, Ace = <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a2">NextAce</a>(Ace) ) {
00639 
00640         <span class="comment">//</span>
00641         <span class="comment">//  print out the ace header</span>
00642         <span class="comment">//</span>
00643 
00644         printf(<span class="stringliteral">"\n\tAceHeader: %08lx "</span>, *(PULONG)Ace);
00645 
00646         <span class="comment">//</span>
00647         <span class="comment">//  special case on the standard ace types</span>
00648         <span class="comment">//</span>
00649 
00650         <span class="keywordflow">if</span> ((Ace-&gt;Header.AceType == ACCESS_ALLOWED_ACE_TYPE) ||
00651             (Ace-&gt;Header.AceType == ACCESS_DENIED_ACE_TYPE) ||
00652             (Ace-&gt;Header.AceType == SYSTEM_AUDIT_ACE_TYPE) ||
00653             (Ace-&gt;Header.AceType == SYSTEM_ALARM_ACE_TYPE)) {
00654 
00655             <span class="comment">//</span>
00656             <span class="comment">//  The following array is indexed by ace types and must</span>
00657             <span class="comment">//  follow the allowed, denied, audit, alarm seqeuence</span>
00658             <span class="comment">//</span>
00659 
00660             PCHAR AceTypes[] = { <span class="stringliteral">"Access Allowed"</span>,
00661                                  <span class="stringliteral">"Access Denied "</span>,
00662                                  <span class="stringliteral">"System Audit  "</span>,
00663                                  <span class="stringliteral">"System Alarm  "</span>
00664                                };
00665 
00666             printf(AceTypes[Ace-&gt;Header.AceType]);
00667             <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a19">PrintAccessMask</a>(Ace-&gt;Mask);
00668             KnownType = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00669 
00670         } <span class="keywordflow">else</span> {
00671 
00672             KnownType = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00673             printf(<span class="stringliteral">" Unknown Ace Type\n"</span>);
00674 
00675         }
00676 
00677         printf(<span class="stringliteral">"\n"</span>);
00678 
00679         printf(<span class="stringliteral">"\tAceSize = %d\n"</span>,Ace-&gt;Header.AceSize);
00680 
00681         printf(<span class="stringliteral">"\tAce Flags = "</span>);
00682         <span class="keywordflow">if</span> (Ace-&gt;Header.AceFlags &amp; OBJECT_INHERIT_ACE) {
00683             printf(<span class="stringliteral">"OBJECT_INHERIT_ACE\n"</span>);
00684             printf(<span class="stringliteral">"                   "</span>);
00685         }
00686 
00687         <span class="keywordflow">if</span> (Ace-&gt;Header.AceFlags &amp; CONTAINER_INHERIT_ACE) {
00688             printf(<span class="stringliteral">"CONTAINER_INHERIT_ACE\n"</span>);
00689             printf(<span class="stringliteral">"                   "</span>);
00690         }
00691 
00692         <span class="keywordflow">if</span> (Ace-&gt;Header.AceFlags &amp; NO_PROPAGATE_INHERIT_ACE) {
00693             printf(<span class="stringliteral">"NO_PROPAGATE_INHERIT_ACE\n"</span>);
00694             printf(<span class="stringliteral">"                   "</span>);
00695         }
00696 
00697         <span class="keywordflow">if</span> (Ace-&gt;Header.AceFlags &amp; INHERIT_ONLY_ACE) {
00698             printf(<span class="stringliteral">"INHERIT_ONLY_ACE\n"</span>);
00699             printf(<span class="stringliteral">"                   "</span>);
00700         }
00701 
00702         <span class="keywordflow">if</span> (Ace-&gt;Header.AceFlags &amp; SUCCESSFUL_ACCESS_ACE_FLAG) {
00703             printf(<span class="stringliteral">"SUCCESSFUL_ACCESS_ACE_FLAG\n"</span>);
00704             printf(<span class="stringliteral">"            "</span>);
00705         }
00706 
00707         <span class="keywordflow">if</span> (Ace-&gt;Header.AceFlags &amp; FAILED_ACCESS_ACE_FLAG) {
00708             printf(<span class="stringliteral">"FAILED_ACCESS_ACE_FLAG\n"</span>);
00709             printf(<span class="stringliteral">"            "</span>);
00710         }
00711 
00712         printf(<span class="stringliteral">"\n"</span>);
00713 
00714         printf(<span class="stringliteral">"\tSid = "</span>);
00715         <a class="code" href="../../d1/d9/uipers_8c.html#a5">DisplayAccountSid</a>(&amp;Ace-&gt;SidStart);
00716     }
00717 
00718 }
00719 
00720 
00721 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00722"></a><a class="code" href="../../d4/d1/rtdmpsec_8c.html#a19">00722</a> <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a19">PrintAccessMask</a>(
00723     IN ACCESS_MASK AccessMask
00724     )
00725 {
00726     printf(<span class="stringliteral">"\n\tAccess Mask: "</span>);
00727 
00728     <span class="keywordflow">if</span> (AccessMask == KEY_ALL_ACCESS) {
00729         printf(<span class="stringliteral">"KEY_ALL_ACCESS\n\t             "</span>);
00730         <span class="keywordflow">return</span>;
00731     }
00732     <span class="keywordflow">if</span> (AccessMask == KEY_READ) {
00733         printf(<span class="stringliteral">"KEY_READ\n\t             "</span>);
00734         <span class="keywordflow">return</span>;
00735     }
00736     <span class="keywordflow">if</span> (AccessMask == KEY_WRITE) {
00737         printf(<span class="stringliteral">"KEY_WRITE\n\t             "</span>);
00738         <span class="keywordflow">return</span>;
00739     }
00740 
00741     <span class="keywordflow">if</span> (AccessMask &amp; KEY_QUERY_VALUE) {
00742         printf(<span class="stringliteral">"KEY_QUERY_VALUE\n\t             "</span>);
00743     }
00744     <span class="keywordflow">if</span> (AccessMask &amp; KEY_SET_VALUE) {
00745         printf(<span class="stringliteral">"KEY_SET_VALUE\n\t             "</span>);
00746     }
00747     <span class="keywordflow">if</span> (AccessMask &amp; KEY_CREATE_SUB_KEY) {
00748         printf(<span class="stringliteral">"KEY_CREATE_SUB_KEY\n\t             "</span>);
00749     }
00750     <span class="keywordflow">if</span> (AccessMask &amp; KEY_ENUMERATE_SUB_KEYS) {
00751         printf(<span class="stringliteral">"KEY_ENUMERATE_SUB_KEYS\n\t             "</span>);
00752     }
00753     <span class="keywordflow">if</span> (AccessMask &amp; KEY_NOTIFY) {
00754         printf(<span class="stringliteral">"KEY_NOTIFY\n\t             "</span>);
00755     }
00756     <span class="keywordflow">if</span> (AccessMask &amp; KEY_CREATE_LINK) {
00757         printf(<span class="stringliteral">"KEY_CREATE_LINK\n\t             "</span>);
00758     }
00759     <span class="keywordflow">if</span> (AccessMask &amp; GENERIC_ALL) {
00760         printf(<span class="stringliteral">"GENERIC_ALL\n\t             "</span>);
00761     }
00762     <span class="keywordflow">if</span> (AccessMask &amp; GENERIC_EXECUTE) {
00763         printf(<span class="stringliteral">"GENERIC_EXECUTE\n\t             "</span>);
00764     }
00765     <span class="keywordflow">if</span> (AccessMask &amp; GENERIC_WRITE) {
00766         printf(<span class="stringliteral">"GENERIC_WRITE\n\t             "</span>);
00767     }
00768     <span class="keywordflow">if</span> (AccessMask &amp; GENERIC_READ) {
00769         printf(<span class="stringliteral">"GENERIC_READ\n\t             "</span>);
00770     }
00771     <span class="keywordflow">if</span> (AccessMask &amp; GENERIC_READ) {
00772         printf(<span class="stringliteral">"GENERIC_READ\n\t             "</span>);
00773     }
00774     <span class="keywordflow">if</span> (AccessMask &amp; MAXIMUM_ALLOWED) {
00775         printf(<span class="stringliteral">"MAXIMUM_ALLOWED\n\t             "</span>);
00776     }
00777     <span class="keywordflow">if</span> (AccessMask &amp; ACCESS_SYSTEM_SECURITY) {
00778         printf(<span class="stringliteral">"ACCESS_SYSTEM_SECURITY\n\t             "</span>);
00779     }
00780     <span class="keywordflow">if</span> (AccessMask &amp; WRITE_OWNER) {
00781         printf(<span class="stringliteral">"WRITE_OWNER\n\t             "</span>);
00782     }
00783     <span class="keywordflow">if</span> (AccessMask &amp; WRITE_DAC) {
00784         printf(<span class="stringliteral">"WRITE_DAC\n\t             "</span>);
00785     }
00786     <span class="keywordflow">if</span> (AccessMask &amp; READ_CONTROL) {
00787         printf(<span class="stringliteral">"READ_CONTROL\n\t             "</span>);
00788     }
00789     <span class="keywordflow">if</span> (AccessMask &amp; DELETE) {
00790         printf(<span class="stringliteral">"DELETE\n\t             "</span>);
00791     }
00792 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:40 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
