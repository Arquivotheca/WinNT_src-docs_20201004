<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: obclose.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>obclose.c File Reference</h1><code>#include "<a class="el" href="../../d6/d0/obp_8h-source.html">obp.h</a>"</code><br>

<p>
<a href="../../d6/d9/obclose_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d0/obclose_8c.html#a1">NtClose</a> (IN HANDLE <a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a29">Handle</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d0/obclose_8c.html#a2">NtMakeTemporaryObject</a> (IN HANDLE <a class="el" href="../../d5/d6/w98_2lh__open_2pi__basic_8h.html#a29">Handle</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d0/obclose_8c.html#a3">ObMakeTemporaryObject</a> (IN PVOID Object)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d0/obclose_8c.html#a0">SepAdtAuditingEnabled</a></td></tr>

</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a1" doxytag="obclose.c::NtClose" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtClose           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Handle</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">37</a> of file <a class="el" href="../../d6/d9/obclose_8c-source.html">obclose.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00313">_OBJECT_HEADER::Body</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00418">DecodeKernelHandle</a>, <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l01227">ExDestroyHandle()</a>, <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l01403">ExMapHandleToPointer()</a>, <a class="el" href="../../d1/d7/ex_2handle_8c-source.html#l00336">ExUnlockHandleTableEntry()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02690">_HANDLE_TABLE_ENTRY::GrantedAccess</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02694">_HANDLE_TABLE_ENTRY::GrantedAccessIndex</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00091">Handle</a>, <a class="el" href="../../d7/d5/ioverifier_8c-source.html#l00057">IsKernelHandle</a>, <a class="el" href="../../d8/d2/kd_8h-source.html#l00134">KdDebuggerEnabled</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01598">KeEnterCriticalRegion</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01628">KeLeaveCriticalRegion</a>, <a class="el" href="../../d3/d8/ppc_2exceptn_8c-source.html#l00925">KeRaiseUserException()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00324">KeStackAttachProcess()</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00512">KeUnstackDetachProcess()</a>, <a class="el" href="../../d0/d2/ldrp_8h-source.html#l00370">NtGlobalFlag</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02674">_HANDLE_TABLE_ENTRY::ObAttributes</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00408">OBJ_AUDIT_OBJECT_CLOSE</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00289">OBJ_HANDLE_ATTRIBUTES</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00261">OBJ_PROTECT_CLOSE</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02672">_HANDLE_TABLE_ENTRY::Object</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00056">ObpBeginTypeSpecificCallOut</a>, <a class="el" href="../../d0/d0/obhandle_8c-source.html#l01967">ObpDecrementHandleCount()</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00057">ObpEndTypeSpecificCallOut</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00213">ObpGetObjectTable</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00399">ObpKernelHandleTable</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00047">ObpTypeObjectType</a>, <a class="el" href="../../d6/d0/obp_8h-source.html#l00071">ObpValidateIrql</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00183">_OBJECT_TYPE_INITIALIZER::OkayToCloseProcedure</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00166">_EPROCESS::Pcb</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00579">PsInitialSystemProcess</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00875">PsIsThreadTerminating</a>, <a class="el" href="../../d4/d4/seaudit_8c-source.html#l03826">SeCloseObjectAuditAlarm()</a>, <a class="el" href="../../d8/d3/adt_8h-source.html#l00134">SepAdtAuditingEnabled</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00302">_OBJECT_HEADER::Type</a>, and <a class="el" href="../../d5/d9/ob_8h-source.html#l00196">_OBJECT_TYPE::TypeInfo</a>.
<p>
Referenced by <a class="el" href="../../d7/d1/output_8c-source.html#l04423">AbortCreateConsole()</a>, <a class="el" href="../../d3/d7/w32_2ntcon_2server_2handle_8c-source.html#l00789">AllocateConsole()</a>, <a class="el" href="../../d9/d8/dllinit_8c-source.html#l00656">AllocConsoleInternal()</a>, <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00996">bCleanConvertedTTFs()</a>, <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00818">bLoadableFontDrivers()</a>, <a class="el" href="../../d3/d4/editreg_8c-source.html#l01771">ChangeMemberState()</a>, <a class="el" href="../../d7/d8/restrfil_8c-source.html#l00129">CheckRestricted()</a>, <a class="el" href="../../d4/d7/client_8c-source.html#l04516">CheckValidLayoutName()</a>, <a class="el" href="../../d7/d1/output_8c-source.html#l04375">CleanupConsoleMessages()</a>, <a class="el" href="../../d3/d7/api_8c-source.html#l01169">CleanupSessionObjectDirectories()</a>, <a class="el" href="../../d6/d9/immhotky_8c-source.html#l00260">CliGetImeHotKeysFromRegistry()</a>, <a class="el" href="../../d6/d9/immhotky_8c-source.html#l00353">CliSetSingleHotKey()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l02169">CmGetSystemDriverList()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l00293">CmInitSystem1()</a>, <a class="el" href="../../d7/d1/hwprofil_8c-source.html#l00544">CmpAddAcpiAliasEntry()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l02606">CmpAddAliasEntry()</a>, <a class="el" href="../../d7/d0/cmhvlist_8c-source.html#l00042">CmpAddToHiveFileList()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l03262">CmpCloneControlSet()</a>, <a class="el" href="../../d7/d1/hwprofil_8c-source.html#l01869">CmpCloneHwProfile()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l02786">CmpCreateControlSet()</a>, <a class="el" href="../../d7/d1/hwprofil_8c-source.html#l00076">CmpGetAcpiProfileInformation()</a>, <a class="el" href="../../d5/d9/cmconfig_8c-source.html#l00087">CmpInitializeHardwareConfiguration()</a>, <a class="el" href="../../d0/d1/config_2i386_2init386_8c-source.html#l00465">CmpInitializeMachineDependentConfiguration()</a>, <a class="el" href="../../d5/d9/cmconfig_8c-source.html#l00458">CmpInitializeRegistryNode()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l01845">CmpInterlockedFunction()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l03983">CmpLinkKeyToHive()</a>, <a class="el" href="../../d9/d9/geninst_8c-source.html#l00311">CmpProcessAddRegLine()</a>, <a class="el" href="../../d9/d9/geninst_8c-source.html#l00776">CmpProcessBitRegLine()</a>, <a class="el" href="../../d9/d9/geninst_8c-source.html#l00658">CmpProcessDelRegLine()</a>, <a class="el" href="../../d7/d0/cmhvlist_8c-source.html#l00188">CmpRemoveFromHiveFileList()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l03458">CmpSaveBootControlSet()</a>, <a class="el" href="../../d5/d9/cmconfig_8c-source.html#l00294">CmpSetupConfigurationTree()</a>, <a class="el" href="../../d2/d2/cmsysini_8c-source.html#l01545">CmpSetVersionData()</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00323">CmpWorkerCommand()</a>, <a class="el" href="../../d4/d7/client_8c-source.html#l02154">CommonCreateWindowStation()</a>, <a class="el" href="../../d4/d7/client_8c-source.html#l02336">CommonOpenWindowStation()</a>, <a class="el" href="../../d9/d8/dllinit_8c-source.html#l00373">ConnectConsoleInternal()</a>, <a class="el" href="../../d1/d4/srvinit_8c-source.html#l01912">ConsoleClientShutdown()</a>, <a class="el" href="../../d7/d1/output_8c-source.html#l04700">ConsoleWindowProc()</a>, <a class="el" href="../../d7/d2/rttrecpy_8c-source.html#l00114">Copy()</a>, <a class="el" href="../../d7/d8/restrfil_8c-source.html#l01596">CopyRestrictedFile()</a>, <a class="el" href="../../d7/d8/restrfil_8c-source.html#l01451">CopyStream()</a>, <a class="el" href="../../d6/d0/w32_2ntcon_2server_2bitmap_8c-source.html#l00027">CreateConsoleBitmap()</a>, <a class="el" href="../../d7/d8/restrfil_8c-source.html#l01311">CreateDirectories()</a>, <a class="el" href="../../d2/d9/csrinit_8c-source.html#l00359">CsrpConnectToServer()</a>, <a class="el" href="../../d1/d0/rtdeltre_8c-source.html#l00103">Delete()</a>, <a class="el" href="../../d7/d1/output_8c-source.html#l04454">DestroyWindowsWindow()</a>, <a class="el" href="../../d3/d8/uipriv_8c-source.html#l00432">DisableAllPrivileges()</a>, <a class="el" href="../../d3/d4/editreg_8c-source.html#l01597">DiskDump()</a>, <a class="el" href="../../d5/d9/tex_8c-source.html#l00072">DoEventTest()</a>, <a class="el" href="../../d5/d9/tex_8c-source.html#l00362">DoMutantTest()</a>, <a class="el" href="../../d5/d9/tex_8c-source.html#l00591">DoSemaphoreTest()</a>, <a class="el" href="../../d5/d9/tex_8c-source.html#l00817">DoTimerTest()</a>, <a class="el" href="../../d3/d0/rtdmp_8c-source.html#l00126">Dump()</a>, <a class="el" href="../../d8/d8/uob_8c-source.html#l00039">DumpObjectDirs()</a>, <a class="el" href="../../d0/d4/edithive_8c-source.html#l00124">EhCloseHive()</a>, <a class="el" href="../../d3/d8/uipriv_8c-source.html#l00225">EnableAllPrivileges()</a>, <a class="el" href="../../d4/d9/csrstubs_8c-source.html#l00084">ExitWindowsWorker()</a>, <a class="el" href="../../d3/d3/ex_2callback_8c-source.html#l00101">ExpInitializeCallbacks()</a>, <a class="el" href="../../d3/d4/editreg_8c-source.html#l01990">FixDisk()</a>, <a class="el" href="../../d6/d0/w32_2ntcon_2server_2bitmap_8c-source.html#l00353">FreeConsoleBitmap()</a>, <a class="el" href="../../d3/d4/editreg_8c-source.html#l00453">FtCreateKey()</a>, <a class="el" href="../../d3/d4/editreg_8c-source.html#l00411">FtDeleteKey()</a>, <a class="el" href="../../d4/d7/client_8c-source.html#l03729">GetActiveKeyboardName()</a>, <a class="el" href="../../d7/d7/clinit_8c-source.html#l00598">GetBadAppCmdLine()</a>, <a class="el" href="../../d3/d4/editreg_8c-source.html#l02163">GetDiskInfo()</a>, <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html#l00255">GetErrorMode()</a>, <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html#l00423">GetHardErrorText()</a>, <a class="el" href="../../d5/d2/rtsetsec_8c-source.html#l00273">GetMySid()</a>, <a class="el" href="../../d6/d1/fekbdcom_8c-source.html#l00118">GetRealDllFileNameWorker()</a>, <a class="el" href="../../d1/d4/srvinit_8c-source.html#l02210">GetRegistryValues()</a>, <a class="el" href="../../d4/d7/client_8c-source.html#l01983">GetServerIMEKeyboardLayout()</a>, <a class="el" href="../../d1/d6/server_2server_8c-source.html#l01068">GetTimeouts()</a>, <a class="el" href="../../d0/d9/imectl_8c-source.html#l00361">ImeRunHelp()</a>, <a class="el" href="../../d7/d8/restrfil_8c-source.html#l00879">InitializeRestrictedStuff()</a>, <a class="el" href="../../d1/d4/srvinit_8c-source.html#l00626">InitWindowsStuff()</a>, <a class="el" href="../../d3/d9/server_2exitwin_8c-source.html#l01865">InternalCreateCallbackThread()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l03917">IoCreateController()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l04073">IoCreateDevice()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l05378">IoCreateStreamFileObject()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l07705">IoIsValidNameGraftingBuffer()</a>, <a class="el" href="../../d5/d5/netboot_8c-source.html#l00314">IopAddRemoteBootValuesToRegistry()</a>, <a class="el" href="../../d6/d8/arcsec_8c-source.html#l00168">IopApplySystemPartitionProt()</a>, <a class="el" href="../../d5/d5/netboot_8c-source.html#l04247">IopCacheNetbiosNameForIpAddress()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l01506">IopConnectLinkTrackingPort()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l02155">IopCreateRootDirectories()</a>, <a class="el" href="../../d8/d6/errorlog_8c-source.html#l00566">IopErrorLogConnectPort()</a>, <a class="el" href="../../d8/d6/errorlog_8c-source.html#l00088">IopErrorLogThread()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l04120">IopGetDriverTagPriority()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l02327">IopInitializeBootDrivers()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l02812">IopInitializeBuiltinDriver()</a>, <a class="el" href="../../d8/d9/pnpinit_8c-source.html#l00093">IopInitializePlugPlayServices()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l03200">IopLoadDriver()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l03479">IopMarkBootPartition()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l05126">IopOpenLinkOrRenameTarget()</a>, <a class="el" href="../../d6/d8/arcsec_8c-source.html#l00053">IopProtectSystemPartition()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l04379">IopReadDumpRegistry()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l03612">IopReassignSystemRoot()</a>, <a class="el" href="../../d0/d1/pnpsubs_8c-source.html#l03686">IopReferenceDriverObjectByName()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l08822">IopSafebootDriverLoad()</a>, <a class="el" href="../../d5/d5/netboot_8c-source.html#l04017">IopSetDefaultGateway()</a>, <a class="el" href="../../d5/d5/netboot_8c-source.html#l00770">IopStartNetworkForRemoteBoot()</a>, <a class="el" href="../../d5/d5/netboot_8c-source.html#l01834">IopStartTcpIpForRemoteBoot()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l03862">IopStoreSystemPartitionInformation()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l09835">IoSetInformation()</a>, <a class="el" href="../../d3/d9/server_2exitwin_8c-source.html#l02001">IsPrivileged()</a>, <a class="el" href="../../d6/d1/fekbdcom_8c-source.html#l00199">KbdLayerRealDllFileForWBT()</a>, <a class="el" href="../../d2/d9/client_2help_8c-source.html#l00183">LaunchHelper()</a>, <a class="el" href="../../d2/d2/ldrrsrc_8c-source.html#l01563">LdrLoadAlternateResourceModule()</a>, <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l00832">LdrpCheckForLoadedDll()</a>, <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l02150">LdrpCreateDllSection()</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l00616">LdrpInitializeProcess()</a>, <a class="el" href="../../d3/d2/ldrsnap_8c-source.html#l01261">LdrpMapDll()</a>, <a class="el" href="../../d9/d1/ldrinit_8c-source.html#l01796">LdrQueryImageFileExecutionOptions()</a>, <a class="el" href="../../d5/d1/ldrapi_8c-source.html#l01069">LdrVerifyImageMatchesChecksum()</a>, <a class="el" href="../../d3/d4/editreg_8c-source.html#l02369">ListDrivers()</a>, <a class="el" href="../../d7/d7/clinit_8c-source.html#l00933">LoadAppDlls()</a>, <a class="el" href="../../d4/d7/client_8c-source.html#l04385">LoadKeyboardLayoutWorker()</a>, <a class="el" href="../../d7/d5/lpccreat_8c-source.html#l00136">LpcpCreatePort()</a>, <a class="el" href="../../d3/d4/editreg_8c-source.html#l02460">main()</a>, <a class="el" href="../../d8/d3/server_2private_8c-source.html#l01407">MapViewOfSection()</a>, <a class="el" href="../../d6/d4/sectsup_8c-source.html#l00768">MiSectionInitialization()</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00405">MyCmpInitHiveFromFile()</a>, <a class="el" href="../../d5/d5/lpccompl_8c-source.html#l00040">NtAcceptConnectPort()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00166">NtCreateKey()</a>, <a class="el" href="../../d0/d0/obhandle_8c-source.html#l00163">NtDuplicateObject()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l01319">NtNotifyChangeMultipleKeys()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l01870">NtOpenKey()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l04090">NtQueryOpenSubKeys()</a>, <a class="el" href="../../d6/d5/lpcconn_8c-source.html#l00084">NtSecureConnectPort()</a>, <a class="el" href="../../d0/d2/qsinfo_8c-source.html#l00849">NtSetInformationFile()</a>, <a class="el" href="../../d9/d3/loadunld_8c-source.html#l00244">NtUnloadDriver()</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l03093">NtUnloadKey()</a>, <a class="el" href="../../d1/d0/obinit_8c-source.html#l00117">ObInitSystem()</a>, <a class="el" href="../../d1/d0/obinit_8c-source.html#l01349">ObpCreateDosDevicesDirectory()</a>, <a class="el" href="../../d4/d2/tob_8c-source.html#l00187">obtest()</a>, <a class="el" href="../../d3/d8/uipriv_8c-source.html#l00148">OpenAppropriateToken()</a>, <a class="el" href="../../d4/d7/client_8c-source.html#l04019">OpenKeyboardLayoutFile()</a>, <a class="el" href="../../d4/d2/ntcon_2server_2input_8c-source.html#l03865">ProcessCtrlEvents()</a>, <a class="el" href="../../d2/d6/ntcon_2server_2menu_8c-source.html#l00287">PropertiesDlgShow()</a>, <a class="el" href="../../d2/d6/ntcon_2server_2menu_8c-source.html#l00459">PropertiesUpdate()</a>, <a class="el" href="../../d4/d6/config_2utils_2regutil_8c-source.html#l00259">RegLoadAsciiFileAsUnicode()</a>, <a class="el" href="../../d4/d6/config_2utils_2regutil_8c-source.html#l00158">RegReadBinaryFile()</a>, <a class="el" href="../../d7/d3/icamsg_8c-source.html#l00167">RemoteMessageThread()</a>, <a class="el" href="../../d1/d4/srvinit_8c-source.html#l01355">RemoveConsole()</a>, <a class="el" href="../../d6/d3/icadis_8c-source.html#l00168">ReplyMessageToTerminalServer()</a>, <a class="el" href="../../d3/d8/uipriv_8c-source.html#l00322">ResetAllPrivileges()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l00639">RtlAdjustPrivilege()</a>, <a class="el" href="../../d2/d2/dll_2query_8c-source.html#l00316">RtlCreateQueryDebugBuffer()</a>, <a class="el" href="../../d5/d7/seurtl_8c-source.html#l01624">RtlCreateUserSecurityObject()</a>, <a class="el" href="../../d5/d7/seurtl_8c-source.html#l01860">RtlDefaultNpAcl()</a>, <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l01474">RtlDeleteCriticalSection()</a>, <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l01158">RtlDeleteResource()</a>, <a class="el" href="../../d2/d2/dll_2query_8c-source.html#l00399">RtlDestroyQueryDebugBuffer()</a>, <a class="el" href="../../d6/d4/prodtype_8c-source.html#l00030">RtlGetNtProductType()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l03446">RtlImpersonateSelf()</a>, <a class="el" href="../../d8/d7/dll_2resource_8c-source.html#l01266">RtlInitializeCriticalSectionAndSpinCount()</a>, <a class="el" href="../../d6/d3/rxact_8c-source.html#l00341">RtlInitializeRXact()</a>, <a class="el" href="../../d5/d7/seurtl_8c-source.html#l00818">RtlNewSecurityGrantedAccess()</a>, <a class="el" href="../../d2/d2/dll_2query_8c-source.html#l00099">RtlpChangeQueryDebugBufferTarget()</a>, <a class="el" href="../../d6/d0/curdir_8c-source.html#l02341">RtlpCheckRelativeDrive()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l03851">RtlpFindWaitThread()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l05648">RtlpFreeWaitEvent()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l08795">RtlpGetDefaultsSubjectContext()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l02370">RtlpIOWorkerThread()</a>, <a class="el" href="../../d8/d6/lpcsvr_8c-source.html#l00046">RtlpLpcDerefContext()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l10195">RtlpSetSecurityObject()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l01820">RtlpStartIOWorkerThread()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l01763">RtlpStartWorkerThread()</a>, <a class="el" href="../../d6/d0/curdir_8c-source.html#l00839">RtlpValidateCurrentDirectory()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l03544">RtlpValidOwnerSubjectContext()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l02824">RtlpWaitThread()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l02137">RtlpWorkerThread()</a>, <a class="el" href="../../d2/d2/dll_2query_8c-source.html#l00469">RtlQueryProcessDebugInformation()</a>, <a class="el" href="../../d5/d6/rtl_2regutil_8c-source.html#l00744">RtlQueryRegistryValues()</a>, <a class="el" href="../../d6/d0/curdir_8c-source.html#l00225">RtlSetCurrentDirectory_U()</a>, <a class="el" href="../../d8/d6/lpcsvr_8c-source.html#l00552">RtlShutdownLpcServer()</a>, <a class="el" href="../../d3/d0/threads_8c-source.html#l01320">RtlThreadPoolCleanup()</a>, <a class="el" href="../../d6/d3/rxact_8c-source.html#l01461">RXactpCommit()</a>, <a class="el" href="../../d7/d2/tokendup_8c-source.html#l01634">SeFilterToken()</a>, <a class="el" href="../../d0/d4/adtinit_8c-source.html#l00425">SepAdtInitializeAuditingOptions()</a>, <a class="el" href="../../d0/d4/adtinit_8c-source.html#l00117">SepAdtInitializeBounds()</a>, <a class="el" href="../../d0/d4/adtinit_8c-source.html#l00242">SepAdtInitializeCrashOnFail()</a>, <a class="el" href="../../d0/d4/adtinit_8c-source.html#l00329">SepAdtInitializePrivilegeAuditing()</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00252">SepClientDropConnection()</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00553">SepClientInitialize()</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l01582">SepClientOpenPipe()</a>, <a class="el" href="../../d0/d5/seinit_8c-source.html#l00184">SepInitializationPhase1()</a>, <a class="el" href="../../d1/d9/rmmain_8c-source.html#l00466">SepRmCommandServerThreadInit()</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l01520">SepServerDisconnectPipe()</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l01028">SepServerInitialize()</a>, <a class="el" href="../../d9/d3/ntcon_2client_2getset_8c-source.html#l01356">SetConsoleCP()</a>, <a class="el" href="../../d7/d3/client_2private_8c-source.html#l00225">SetConsoleDisplayMode()</a>, <a class="el" href="../../d8/d3/server_2private_8c-source.html#l01094">SrvRegisterConsoleVDM()</a>, <a class="el" href="../../d0/d4/ntcon_2server_2getset_8c-source.html#l01229">SrvSetConsoleCP()</a>, <a class="el" href="../../d8/d3/server_2private_8c-source.html#l00853">SrvSetConsoleDisplayMode()</a>, <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html#l00191">SubstituteDeviceName()</a>, <a class="el" href="../../d3/d7/api_8c-source.html#l00279">TerminalServerRequestThread()</a>, <a class="el" href="../../d8/d8/uob_8c-source.html#l00232">TestParent()</a>, <a class="el" href="../../d1/d0/ctseacc_8c-source.html#l00636">TestSeAccess()</a>, <a class="el" href="../../d1/d0/ctseacc_8c-source.html#l00213">TestSeNamedCreate()</a>, <a class="el" href="../../d1/d0/ctseacc_8c-source.html#l00129">TestSeUnnamedCreate()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l07648">TestTokenAssignPrimary()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00421">TestTokenCreate()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l07402">TestTokenDuplicate()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l01085">TestTokenFilter()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l07982">TestTokenImpersonation()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l01276">TestTokenOpenPrimary()</a>, <a class="el" href="../../d9/d6/udbgk_8c-source.html#l00069">UdbgTest1()</a>, <a class="el" href="../../d9/d6/udbgk_8c-source.html#l00280">UdbgTest2()</a>, <a class="el" href="../../d8/d3/server_2private_8c-source.html#l00980">UnregisterVDM()</a>, <a class="el" href="../../d8/d7/w32_2ntuser_2server_2harderr_8c-source.html#l01686">UserHardErrorEx()</a>, <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l01132">vCleanConvertedTTFs()</a>, <a class="el" href="../../d3/d5/fntsweep_8c-source.html#l00577">vSweepFonts()</a>, <a class="el" href="../../d3/d7/api_8c-source.html#l00818">W32WinStationTerminate()</a>, <a class="el" href="../../d5/d3/command_8c-source.html#l00035">Win32CommandChannelThread()</a>, and <a class="el" href="../../d3/d9/server_2exitwin_8c-source.html#l01791">WowExitTask()</a>.
<p>
<pre class="fragment"><div>00043                    :
00044 
00045     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to close access to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified handle
00046 
00047 Arguments:
00048 
00049     <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle being closed
00050 
00051 Return Value:
00052 
00053     An appropriate status value
00054 
00055 --*/
00056 
00057 {
00058     <a class="code" href="../../d6/d3/struct__HANDLE__TABLE.html">PHANDLE_TABLE</a> ObjectTable;
00059     <a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html">PHANDLE_TABLE_ENTRY</a> ObjectTableEntry;
00060     PVOID Object;
00061     ULONG CapturedGrantedAccess;
00062     ULONG CapturedAttributes;
00063     <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> ObjectHeader;
00064     <a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> ObjectType;
00065     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00066     BOOLEAN AttachedToProcess = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00067     <a class="code" href="../../d3/d5/struct__KAPC__STATE.html">KAPC_STATE</a> ApcState;
00068 
00069     <span class="comment">//</span>
00070     <span class="comment">//  Protect ourselves from being interrupted while we hold a handle table</span>
00071     <span class="comment">//  entry lock</span>
00072     <span class="comment">//</span>
00073 
00074     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
00075 
00076     <span class="keywordflow">try</span> {
00077 
00078 <span class="preprocessor">    #if DBG</span>
00079 <span class="preprocessor"></span>        KIRQL SaveIrql;
00080 <span class="preprocessor">    #endif // DBG</span>
00081 <span class="preprocessor"></span>
00082         <a class="code" href="../../d5/d1/obp_8h.html#a2">ObpValidateIrql</a>( <span class="stringliteral">"NtClose"</span> );
00083 
00084         <a class="code" href="../../d5/d1/obp_8h.html#a0">ObpBeginTypeSpecificCallOut</a>( SaveIrql );
00085 
00086 <span class="preprocessor">    #if DBG</span>
00087 <span class="preprocessor"></span>
00088         <span class="comment">//</span>
00089         <span class="comment">//  On checked builds, check that if the Kernel handle bit is set, then</span>
00090         <span class="comment">//  we're coming from Kernel mode. We should probably fail the call if</span>
00091         <span class="comment">//  bit set &amp;&amp; !Kmode</span>
00092         <span class="comment">//</span>
00093 
00094         <span class="keywordflow">if</span> ((<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> != NtCurrentThread()) &amp;&amp; (<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> != NtCurrentProcess())) {
00095 
00096             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((Handle &lt; 0 ) ? (KeGetPreviousMode() == KernelMode) : TRUE);
00097         }
00098 
00099 <span class="preprocessor">    #endif</span>
00100 <span class="preprocessor"></span>        <span class="comment">//</span>
00101         <span class="comment">//  For the current process we will grab its handle/object table and</span>
00102         <span class="comment">//  translate the handle to its corresponding table entry.  If the</span>
00103         <span class="comment">//  call is successful it also lock down the handle table.  But first</span>
00104         <span class="comment">//  check for a kernel handle and attach and use that table if so.</span>
00105         <span class="comment">//</span>
00106 
00107         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/ioverifier_8c.html#a14">IsKernelHandle</a>( Handle, KeGetPreviousMode() ))  {
00108 
00109             <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> = <a class="code" href="../../d5/d1/obp_8h.html#a27">DecodeKernelHandle</a>( Handle );
00110 
00111             ObjectTable = <a class="code" href="../../d5/d1/obp_8h.html#a54">ObpKernelHandleTable</a>;
00112 
00113             <span class="comment">//</span>
00114             <span class="comment">//  Go to the system process if we have to</span>
00115             <span class="comment">//</span>
00116             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>() != <a class="code" href="../../d1/d9/ps_8h.html#a53">PsInitialSystemProcess</a>) {
00117                <a class="code" href="../../d3/d5/procobj_8c.html#a6">KeStackAttachProcess</a> (&amp;<a class="code" href="../../d1/d9/ps_8h.html#a53">PsInitialSystemProcess</a>-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>, &amp;ApcState);
00118                AttachedToProcess = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00119             }
00120 
00121         } <span class="keywordflow">else</span> {
00122 
00123             ObjectTable = <a class="code" href="../../d5/d1/obp_8h.html#a12">ObpGetObjectTable</a>();
00124         }
00125 
00126         ObjectTableEntry = <a class="code" href="../../d5/d8/ex_8h.html#a299">ExMapHandleToPointer</a>( ObjectTable,
00127                                                  Handle );
00128 
00129         <span class="comment">//</span>
00130         <span class="comment">//  Check that the specified handle is legitimate otherwise we can</span>
00131         <span class="comment">//  assume the caller just passed in some bogus handle value</span>
00132         <span class="comment">//</span>
00133 
00134         <span class="keywordflow">if</span> (ObjectTableEntry != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00135 
00136             <span class="comment">//</span>
00137             <span class="comment">//  From the object table entry we can grab a pointer to the object</span>
00138             <span class="comment">//  header, get its type and its body</span>
00139             <span class="comment">//</span>
00140 
00141             ObjectHeader = (<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a>)(((ULONG_PTR)(ObjectTableEntry-&gt;<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o0">Object</a>)) &amp; ~<a class="code" href="../../d5/d1/obp_8h.html#a17">OBJ_HANDLE_ATTRIBUTES</a>);
00142             ObjectType = ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o3">Type</a>;
00143             Object = &amp;ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o11">Body</a>;
00144 
00145             <span class="comment">//</span>
00146             <span class="comment">//  If the object type specifies an okay to close procedure then we</span>
00147             <span class="comment">//  need to invoke that callback.  If the callback doesn't want us to</span>
00148             <span class="comment">//  close handle then unlock the object table and return the error</span>
00149             <span class="comment">//  to our caller</span>
00150             <span class="comment">//</span>
00151 
00152             <span class="keywordflow">if</span> (ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o19">OkayToCloseProcedure</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00153 
00154                 <span class="keywordflow">if</span> (!(*ObjectType-&gt;<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html#o9">TypeInfo</a>.<a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html#o19">OkayToCloseProcedure</a>)( <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>(), Object, <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> )) {
00155 
00156                     <a class="code" href="../../d5/d1/obp_8h.html#a1">ObpEndTypeSpecificCallOut</a>( SaveIrql, <span class="stringliteral">"NtClose"</span>, ObjectType, Object );
00157 
00158                     <a class="code" href="../../d5/d8/ex_8h.html#a288">ExUnlockHandleTableEntry</a>( ObjectTable, ObjectTableEntry );
00159 
00160                     <span class="comment">//</span>
00161                     <span class="comment">//  If we are attached to the system process then return</span>
00162                     <span class="comment">//  back to our caller</span>
00163                     <span class="comment">//</span>
00164 
00165                     <span class="keywordflow">if</span> (AttachedToProcess) {
00166 
00167                         <a class="code" href="../../d3/d5/procobj_8c.html#a8">KeUnstackDetachProcess</a>(&amp;ApcState);
00168                         AttachedToProcess = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00169                     }
00170 
00171                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_HANDLE_NOT_CLOSABLE;
00172                     leave;
00173                 }
00174             }
00175 
00176             CapturedAttributes = ObjectTableEntry-&gt;<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o1">ObAttributes</a>;
00177 
00178             <span class="comment">//</span>
00179             <span class="comment">//  If the previous mode was user and the handle is protected from</span>
00180             <span class="comment">//  being closed, then we'll either raise or return an error depending</span>
00181             <span class="comment">//  on the global flags and debugger port situation.</span>
00182             <span class="comment">//</span>
00183 
00184             <span class="keywordflow">if</span> ((CapturedAttributes &amp; <a class="code" href="../../d5/d1/obp_8h.html#a15">OBJ_PROTECT_CLOSE</a>) != 0) {
00185 
00186                 <span class="keywordflow">if</span> (KeGetPreviousMode() != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00187 
00188                     <a class="code" href="../../d5/d8/ex_8h.html#a288">ExUnlockHandleTableEntry</a>( ObjectTable, ObjectTableEntry );
00189 
00190                     <span class="keywordflow">if</span> ((<a class="code" href="../../d9/d2/ldrp_8h.html#a33">NtGlobalFlag</a> &amp; FLG_ENABLE_CLOSE_EXCEPTIONS) ||
00191                         (<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;DebugPort != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00192 
00193                         <span class="comment">//</span>
00194                         <span class="comment">//  If we are attached to the system process then return</span>
00195                         <span class="comment">//  back to our caller</span>
00196                         <span class="comment">//</span>
00197 
00198                         <span class="keywordflow">if</span> (AttachedToProcess) {
00199                             <a class="code" href="../../d3/d5/procobj_8c.html#a8">KeUnstackDetachProcess</a>(&amp;ApcState);
00200                             AttachedToProcess = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00201                         }
00202 
00203                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d9/ppc_2exceptn_8c.html#a13">KeRaiseUserException</a>(STATUS_HANDLE_NOT_CLOSABLE);
00204                         leave;
00205 
00206                     } <span class="keywordflow">else</span> {
00207 
00208                         <span class="comment">//</span>
00209                         <span class="comment">//  If we are attached to the system process then return</span>
00210                         <span class="comment">//  back to our caller</span>
00211                         <span class="comment">//</span>
00212 
00213                         <span class="keywordflow">if</span> (AttachedToProcess) {
00214                             <a class="code" href="../../d3/d5/procobj_8c.html#a8">KeUnstackDetachProcess</a>(&amp;ApcState);
00215                             AttachedToProcess = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00216                         }
00217 
00218                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_HANDLE_NOT_CLOSABLE;
00219                         leave;
00220                     }
00221 
00222                 } <span class="keywordflow">else</span> {
00223 
00224                     <span class="keywordflow">if</span> ((!<a class="code" href="../../d1/d9/ps_8h.html#a27">PsIsThreadTerminating</a>(<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>())) &amp;&amp;
00225                         (<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;Peb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00226 
00227                         <a class="code" href="../../d5/d8/ex_8h.html#a288">ExUnlockHandleTableEntry</a>( ObjectTable, ObjectTableEntry );
00228 
00229 <span class="preprocessor">    #if DBG</span>
00230 <span class="preprocessor"></span>                        <span class="comment">//</span>
00231                         <span class="comment">//  bugcheck here on checked builds if kernel mode code is</span>
00232                         <span class="comment">//  closing a protected handle and process is not exiting.</span>
00233                         <span class="comment">//  Ignore if no PEB as this occurs if process is killed</span>
00234                         <span class="comment">//  before really starting.</span>
00235                         <span class="comment">//</span>
00236 
00237                         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(INVALID_KERNEL_HANDLE, (ULONG_PTR)Handle, 0, 0, 0);
00238 <span class="preprocessor">    #else</span>
00239 <span class="preprocessor"></span>                        <span class="comment">//</span>
00240                         <span class="comment">//  If we are attached to the system process then return</span>
00241                         <span class="comment">//  back to our caller</span>
00242                         <span class="comment">//</span>
00243 
00244                         <span class="keywordflow">if</span> (AttachedToProcess) {
00245                             <a class="code" href="../../d3/d5/procobj_8c.html#a8">KeUnstackDetachProcess</a>(&amp;ApcState);
00246                             AttachedToProcess = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00247                         }
00248 
00249                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_HANDLE_NOT_CLOSABLE;
00250                         leave;
00251 <span class="preprocessor">    #endif // DBG</span>
00252 <span class="preprocessor"></span>
00253                     }
00254                 }
00255             }
00256 
00257             <span class="comment">//</span>
00258             <span class="comment">//  Get the granted access for the handle</span>
00259             <span class="comment">//</span>
00260 
00261 <span class="preprocessor">    #if i386 &amp;&amp; !FPO</span>
00262 <span class="preprocessor"></span>
00263             <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a33">NtGlobalFlag</a> &amp; FLG_KERNEL_STACK_TRACE_DB) {
00264 
00265                 CapturedGrantedAccess = ObpTranslateGrantedAccessIndex( ObjectTableEntry-&gt;<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o3">GrantedAccessIndex</a> );
00266 
00267             } <span class="keywordflow">else</span> {
00268 
00269                 CapturedGrantedAccess = ObjectTableEntry-&gt;<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o2">GrantedAccess</a>;
00270             }
00271 
00272 <span class="preprocessor">    #else</span>
00273 <span class="preprocessor"></span>
00274             CapturedGrantedAccess = ObjectTableEntry-&gt;<a class="code" href="../../d7/d3/struct__HANDLE__TABLE__ENTRY.html#o2">GrantedAccess</a>;
00275 
00276 <span class="preprocessor">    #endif // i386 &amp;&amp; !FPO</span>
00277 <span class="preprocessor"></span>
00278             <span class="comment">//</span>
00279             <span class="comment">//  Now remove the handle from the handle table</span>
00280             <span class="comment">//</span>
00281 
00282             <a class="code" href="../../d5/d8/ex_8h.html#a297">ExDestroyHandle</a>( ObjectTable,
00283                              Handle,
00284                              ObjectTableEntry );
00285 
00286             <span class="comment">//</span>
00287             <span class="comment">//  perform any auditing required</span>
00288             <span class="comment">//</span>
00289 
00290             <span class="comment">//</span>
00291             <span class="comment">//  Extract the value of the GenerateOnClose bit stored</span>
00292             <span class="comment">//  after object open auditing is performed.  This value</span>
00293             <span class="comment">//  was stored by a call to ObSetGenerateOnClosed.</span>
00294             <span class="comment">//</span>
00295 
00296             <span class="keywordflow">if</span> (CapturedAttributes &amp; <a class="code" href="../../d7/d7/ntapi_8c.html#a2">OBJ_AUDIT_OBJECT_CLOSE</a>) {
00297 
00298                 <span class="keywordflow">if</span> ( <a class="code" href="../../d7/d4/adt_8h.html#a3">SepAdtAuditingEnabled</a> ) {
00299 
00300                     <a class="code" href="../../d3/d5/seaudit_8c.html#a29">SeCloseObjectAuditAlarm</a>( Object,
00301                                              (HANDLE)((ULONG_PTR)Handle &amp; ~OBJ_HANDLE_TAGBITS),  <span class="comment">// Mask off the tagbits defined for OB objects.</span>
00302                                              TRUE );
00303                 }
00304             }
00305 
00306             <span class="comment">//</span>
00307             <span class="comment">//  Since we took the handle away we need to decrement the objects</span>
00308             <span class="comment">//  handle count, and remove a reference</span>
00309             <span class="comment">//</span>
00310 
00311             <a class="code" href="../../d5/d1/obp_8h.html#a78">ObpDecrementHandleCount</a>( <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>(),
00312                                      ObjectHeader,
00313                                      ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o3">Type</a>,
00314                                      CapturedGrantedAccess );
00315 
00316             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Object );
00317 
00318             <a class="code" href="../../d5/d1/obp_8h.html#a1">ObpEndTypeSpecificCallOut</a>( SaveIrql, <span class="stringliteral">"NtClose"</span>, ObjectType, Object );
00319 
00320             <span class="comment">//</span>
00321             <span class="comment">//  If we are attached to the system process then return</span>
00322             <span class="comment">//  back to our caller</span>
00323             <span class="comment">//</span>
00324 
00325             <span class="keywordflow">if</span> (AttachedToProcess) {
00326                 <a class="code" href="../../d3/d5/procobj_8c.html#a8">KeUnstackDetachProcess</a>(&amp;ApcState);
00327                 AttachedToProcess = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00328             }
00329 
00330             <span class="comment">//</span>
00331             <span class="comment">//  And return to our caller</span>
00332             <span class="comment">//</span>
00333 
00334             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00335             leave;
00336 
00337         } <span class="keywordflow">else</span> {
00338 
00339             <span class="comment">//</span>
00340             <span class="comment">//  At this point the input handle did not translate to a valid</span>
00341             <span class="comment">//  object table entry</span>
00342             <span class="comment">//</span>
00343 
00344             <a class="code" href="../../d5/d1/obp_8h.html#a1">ObpEndTypeSpecificCallOut</a>( SaveIrql, <span class="stringliteral">"NtClose"</span>, ObpTypeObjectType, Handle );
00345 
00346             <span class="comment">//</span>
00347             <span class="comment">//  If we are attached to the system process then return</span>
00348             <span class="comment">//  back to our caller</span>
00349             <span class="comment">//</span>
00350 
00351             <span class="keywordflow">if</span> (AttachedToProcess) {
00352                 <a class="code" href="../../d3/d5/procobj_8c.html#a8">KeUnstackDetachProcess</a>(&amp;ApcState);
00353                 AttachedToProcess = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00354             }
00355 
00356             <span class="comment">//</span>
00357             <span class="comment">//  Now if the handle is not null and it does not represent the</span>
00358             <span class="comment">//  current thread or process then if we're user mode we either raise</span>
00359             <span class="comment">//  or return an error</span>
00360             <span class="comment">//</span>
00361 
00362             <span class="keywordflow">if</span> ((<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
00363                 (<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> != NtCurrentThread()) &amp;&amp;
00364                 (<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> != NtCurrentProcess())) {
00365 
00366                 <span class="keywordflow">if</span> (KeGetPreviousMode() != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00367 
00368                     <span class="keywordflow">if</span> ((<a class="code" href="../../d9/d2/ldrp_8h.html#a33">NtGlobalFlag</a> &amp; FLG_ENABLE_CLOSE_EXCEPTIONS) ||
00369                         (<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;DebugPort != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00370 
00371                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d9/ppc_2exceptn_8c.html#a13">KeRaiseUserException</a>(STATUS_INVALID_HANDLE);
00372                         leave;
00373 
00374                     } <span class="keywordflow">else</span> {
00375 
00376                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_HANDLE;
00377                         leave;
00378                     }
00379 
00380                 } <span class="keywordflow">else</span> {
00381 
00382                     <span class="comment">//</span>
00383                     <span class="comment">//  bugcheck here if kernel debugger is enabled and if kernel mode code is</span>
00384                     <span class="comment">//  closing a bogus handle and process is not exiting.  Ignore</span>
00385                     <span class="comment">//  if no PEB as this occurs if process is killed before</span>
00386                     <span class="comment">//  really starting.</span>
00387                     <span class="comment">//</span>
00388 
00389                     <span class="keywordflow">if</span> (( !<a class="code" href="../../d1/d9/ps_8h.html#a27">PsIsThreadTerminating</a>(<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>())) &amp;&amp;
00390                         (<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;Peb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00391 
00392                         <span class="keywordflow">if</span> (<a class="code" href="../../d7/d3/kd_8h.html#a13">KdDebuggerEnabled</a>) {
00393                             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(INVALID_KERNEL_HANDLE, (ULONG_PTR)Handle, 1, 0, 0);
00394                         }
00395                     }
00396 
00397                 }
00398             }
00399 
00400             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_HANDLE;
00401             leave;
00402         }
00403 
00404     } finally {
00405 
00406         <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
00407     }
00408 
00409     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00410 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="obclose.c::NtMakeTemporaryObject" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtMakeTemporaryObject           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Handle</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d9/obclose_8c-source.html#l00414">414</a> of file <a class="el" href="../../d6/d9/obclose_8c-source.html">obclose.c</a>.
<p>
References <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00091">Handle</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00056">_OBJECT_HANDLE_INFORMATION::HandleAttributes</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d8/d6/ntapi_8c-source.html#l00408">OBJ_AUDIT_OBJECT_CLOSE</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00484">ObMakeTemporaryObject()</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d4/d4/seaudit_8c-source.html#l03892">SeDeleteObjectAuditAlarm()</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
Referenced by <a class="el" href="../../d3/d7/api_8c-source.html#l01169">CleanupSessionObjectDirectories()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l03612">IopReassignSystemRoot()</a>, and <a class="el" href="../../d8/d8/uob_8c-source.html#l00232">TestParent()</a>.
<p>
<pre class="fragment"><div>00420                    :
00421 
00422     This routine makes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified object non permanent.
00423 
00424 Arguments:
00425 
00426     <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> - Supplies a handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object being modified
00427 
00428 Return Value:
00429 
00430     An appropriate status value.
00431 
00432 --*/
00433 
00434 {
00435     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00436     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00437     PVOID Object;
00438     <a class="code" href="../../d3/d5/struct__OBJECT__HANDLE__INFORMATION.html">OBJECT_HANDLE_INFORMATION</a> HandleInformation;
00439 
00440     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00441 
00442     <span class="comment">//</span>
00443     <span class="comment">//  Get previous processor mode and probe output argument if necessary.</span>
00444     <span class="comment">//</span>
00445 
00446     PreviousMode = KeGetPreviousMode();
00447 
00448     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>( Handle,
00449                                         DELETE,
00450                                         (<a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a>)NULL,
00451                                         PreviousMode,
00452                                         &amp;Object,
00453                                         &amp;HandleInformation );
00454     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00455 
00456         <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00457     }
00458 
00459     <span class="comment">//</span>
00460     <span class="comment">//  Make the object temporary.  Note that the object should still</span>
00461     <span class="comment">//  have a name and directory entry because its handle count is not</span>
00462     <span class="comment">//  zero</span>
00463     <span class="comment">//</span>
00464 
00465     <a class="code" href="../../d5/d0/obclose_8c.html#a3">ObMakeTemporaryObject</a>( Object );
00466 
00467     <span class="comment">//</span>
00468     <span class="comment">//  Check if we need to generate a delete object audit/alarm</span>
00469     <span class="comment">//</span>
00470 
00471     <span class="keywordflow">if</span> (HandleInformation.<a class="code" href="../../d3/d5/struct__OBJECT__HANDLE__INFORMATION.html#o0">HandleAttributes</a> &amp; <a class="code" href="../../d7/d7/ntapi_8c.html#a2">OBJ_AUDIT_OBJECT_CLOSE</a>) {
00472 
00473         <a class="code" href="../../d3/d5/seaudit_8c.html#a30">SeDeleteObjectAuditAlarm</a>( Object,
00474                                   Handle );
00475     }
00476 
00477     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Object );
00478 
00479     <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00480 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="obclose.c::ObMakeTemporaryObject" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID ObMakeTemporaryObject           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Object</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d9/obclose_8c-source.html#l00484">484</a> of file <a class="el" href="../../d6/d9/obclose_8c-source.html">obclose.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00306">_OBJECT_HEADER::Flags</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00351">OB_FLAG_PERMANENT_OBJECT</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00355">OBJECT_TO_OBJECT_HEADER</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l01497">ObpDeleteNameCheck()</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d9/d9/pnpioapi_8c-source.html#l01071">IoCreateDriver()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l05951">IoDeleteDevice()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l00657">IopCompleteUnloadOrDelete()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l02327">IopInitializeBootDrivers()</a>, <a class="el" href="../../d0/d5/ioinit_8c-source.html#l02812">IopInitializeBuiltinDriver()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l03200">IopLoadDriver()</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00414">NtMakeTemporaryObject()</a>, and <a class="el" href="../../d9/d3/loadunld_8c-source.html#l00244">NtUnloadDriver()</a>.
<p>
<pre class="fragment"><div>00490                    :
00491 
00492     This routine removes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object from its parent
00493     directory.  The object <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> removed <span class="keywordflow">if</span> <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> has a non zero
00494     handle count and a name.  Otherwise <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> simply
00495     <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a> non permanent
00496 
00497 Arguments:
00498 
00499     Object - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object being modified
00500 
00501 Return Value:
00502 
00503     None.
00504 
00505 --*/
00506 
00507 {
00508     <a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html">POBJECT_HEADER</a> ObjectHeader;
00509 
00510     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00511 
00512     ObjectHeader = <a class="code" href="../../d4/d0/ob_8h.html#a8">OBJECT_TO_OBJECT_HEADER</a>( Object );
00513     ObjectHeader-&gt;<a class="code" href="../../d4/d5/struct__OBJECT__HEADER.html#o7">Flags</a> &amp;= ~<a class="code" href="../../d4/d0/ob_8h.html#a5">OB_FLAG_PERMANENT_OBJECT</a>;
00514 
00515     <a class="code" href="../../d7/d1/obref_8c.html#a11">ObpDeleteNameCheck</a>( Object, FALSE );
00516 
00517     <span class="keywordflow">return</span>;
00518 }

</div></pre>    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a0" doxytag="obclose.c::SepAdtAuditingEnabled" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN <a class="el" href="../../d8/d5/seglobal_8c.html#a89">SepAdtAuditingEnabled</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d9/obclose_8c-source.html#l00033">33</a> of file <a class="el" href="../../d6/d9/obclose_8c-source.html">obclose.c</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:44:57 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
