<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: 4/kdinit.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>kdinit.c File Reference</h1><code>#include "<a class="el" href="../../d2/d6/4_2kdp_8h-source.html">kdp.h</a>"</code><br>

<p>
<a href="../../d6/d5/4_2kdinit_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/4_2kdinit_8c.html#a0">BAUD_OPTION</a>&nbsp;&nbsp;&nbsp;"BAUDRATE"</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/4_2kdinit_8c.html#a1">PORT_OPTION</a>&nbsp;&nbsp;&nbsp;"DEBUGPORT"</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/4_2kdinit_8c.html#a2">KdUpdateDataBlock</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG_PTR&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/4_2kdinit_8c.html#a3">KdGetDataBlock</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/4_2kdinit_8c.html#a4">KdInitSystem</a> (IN <a class="el" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a> LoaderBlock OPTIONAL, BOOLEAN StopInDebugger)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/4_2kdinit_8c.html#a5">KdRegisterDebuggerDataBlock</a> (IN ULONG Tag, IN <a class="el" href="../../d7/d3/kd_8h.html#a15">PDBGKD_DEBUG_DATA_HEADER64</a> DataHeader, IN ULONG <a class="el" href="../../d9/d7/w98_2lh__open_2pi__mem_8h.html#a0">Size</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/4_2kdinit_8c.html#a6">KdDeregisterDebuggerDataBlock</a> (IN <a class="el" href="../../d7/d3/kd_8h.html#a15">PDBGKD_DEBUG_DATA_HEADER64</a> DataHeader)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/4_2kdinit_8c.html#a7">KdLogDbgPrint</a> (IN PSTRING <a class="el" href="../../d0/d0/tdetach_8c.html#a0">String</a>)</td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a0" doxytag="4/kdinit.c::BAUD_OPTION" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define BAUD_OPTION&nbsp;&nbsp;&nbsp;"BAUDRATE"          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/4_2kdinit_8c-source.html#l00027">27</a> of file <a class="el" href="../../d6/d5/4_2kdinit_8c-source.html">4/kdinit.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="4/kdinit.c::PORT_OPTION" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PORT_OPTION&nbsp;&nbsp;&nbsp;"DEBUGPORT"          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/4_2kdinit_8c-source.html#l00028">28</a> of file <a class="el" href="../../d6/d5/4_2kdinit_8c-source.html">4/kdinit.c</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a6" doxytag="4/kdinit.c::KdDeregisterDebuggerDataBlock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KdDeregisterDebuggerDataBlock           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d3/kd_8h.html#a15">PDBGKD_DEBUG_DATA_HEADER64</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>DataHeader</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/4_2kdinit_8c-source.html#l00363">363</a> of file <a class="el" href="../../d6/d5/4_2kdinit_8c-source.html">4/kdinit.c</a>.
<p>
References <a class="el" href="../../d4/d2/dumpuser_8c-source.html#l00048">Header</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00279">KdpDataSpinLock</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00280">KdpDebuggerDataListHead</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02007">KeAcquireSpinLock</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a119">KeReleaseSpinLock()</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00094">List</a>, and <a class="el" href="../../d8/d2/kd_8h-source.html#l00167">PDBGKD_DEBUG_DATA_HEADER64</a>.
<p>
<pre class="fragment"><div>00368                    :
00369 
00370     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called to deregister a data block previously
00371     registered with <a class="code" href="../../d7/d3/kd_8h.html#a26">KdRegisterDebuggerDataBlock</a>.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> block <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00372     found in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> list, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> removed.
00373 
00374 Arguments:
00375 
00376     DataHeader - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data block which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00377                 to be removed from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> list.
00378 
00379 Return Value:
00380 
00381     None
00382 
00383 --*/
00384 
00385 {
00386     KIRQL OldIrql;
00387     PLIST_ENTRY <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>;
00388     <a class="code" href="../../d7/d3/kd_8h.html#a15">PDBGKD_DEBUG_DATA_HEADER64</a> <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>;
00389 
00390     <a class="code" href="../../d4/d9/ke_8h.html#a37">KeAcquireSpinLock</a>(&amp;KdpDataSpinLock, &amp;OldIrql);
00391 
00392     <span class="comment">//</span>
00393     <span class="comment">// Make sure the data block is on our list before removing it.</span>
00394     <span class="comment">//</span>
00395 
00396     <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a> = <a class="code" href="../../d8/d5/kddata_8c.html#a97">KdpDebuggerDataListHead</a>.Flink;
00397 
00398     <span class="keywordflow">while</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a> != &amp;<a class="code" href="../../d8/d5/kddata_8c.html#a97">KdpDebuggerDataListHead</a>) {
00399 
00400         <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a> = CONTAINING_RECORD(List, DBGKD_DEBUG_DATA_HEADER64, List);
00401         <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a> = <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;Flink;
00402 
00403         <span class="keywordflow">if</span> (DataHeader == <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>) {
00404             RemoveEntryList((PLIST_ENTRY)(&amp;DataHeader-&gt;List));
00405             <span class="keywordflow">break</span>;
00406         }
00407     }
00408 
00409     <a class="code" href="../../d9/d5/verifier_8c.html#a119">KeReleaseSpinLock</a>(&amp;KdpDataSpinLock, OldIrql);
00410 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="4/kdinit.c::KdGetDataBlock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG_PTR KdGetDataBlock           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/4_2kdinit_8c-source.html#l00055">55</a> of file <a class="el" href="../../d6/d5/4_2kdinit_8c-source.html">4/kdinit.c</a>.
<p>
References <a class="el" href="../../d9/d4/kddata_8c-source.html#l00106">KdDebuggerDataBlock</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l01519">IoWriteCrashDump()</a>.
<p>
<pre class="fragment"><div>00060                    :
00061 
00062     We have to update <span class="keyword">this</span> variable seperately since <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> initialized at a
00063     later time by PS.  PS will call us to update <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data block.
00064 
00065 --*/
00066 {
00067     <span class="keywordflow">return</span> (ULONG_PTR)(&amp;<a class="code" href="../../d8/d5/kddata_8c.html#a50">KdDebuggerDataBlock</a>);
00068 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="4/kdinit.c::KdInitSystem" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN KdInitSystem           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">PLOADER_PARAMETER_BLOCK</a> LoaderBlock&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>StopInDebugger</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/4_2kdinit_8c-source.html#l00072">72</a> of file <a class="el" href="../../d6/d5/4_2kdinit_8c-source.html">4/kdinit.c</a>.
<p>
References <a class="el" href="../../d2/d6/4_2kdp_8h-source.html#l00173">_BREAKPOINT_ENTRY::Address</a>, <a class="el" href="../../d5/d5/kdinit_8c-source.html#l00027">BAUD_OPTION</a>, <a class="el" href="../../d8/d2/kd_8h-source.html#l00115">_DEBUG_PARAMETERS::BaudRate</a>, <a class="el" href="../../d8/d2/kd_8h-source.html#l00114">_DEBUG_PARAMETERS::CommunicationPort</a>, <a class="el" href="../../d2/d6/4_2kdp_8h-source.html#l00172">_BREAKPOINT_ENTRY::DirectoryTableBase</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01961">ExInitializeWorkItem</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d6/4_2kdp_8h-source.html#l00171">_BREAKPOINT_ENTRY::Flags</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00106">KdDebuggerDataBlock</a>, <a class="el" href="../../d8/d2/kd_8h-source.html#l00134">KdDebuggerEnabled</a>, <a class="el" href="../../d8/d2/kd_8h-source.html#l00142">KdDebugParameters</a>, <a class="el" href="../../d3/d6/alpha_2kdpcpu_8h-source.html#l00082">KDP_BREAKPOINT_VALUE</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00263">KdpBreakpointInstruction</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00201">KdpBreakpointTable</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00280">KdpDebuggerDataListHead</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00299">KdpDebuggerStructuresInitialized</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00206">KdPerformanceCounterRate</a>, <a class="el" href="../../d8/d2/kd_8h-source.html#l00066">KdPitchDebugger</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00264">KdpNextPacketIdToSend</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00266">KdpNtosImageBase</a>, <a class="el" href="../../d2/d7/hal_8h.html#a199">KdPortInitialize()</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00300">KdpOweBreakpoint</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00265">KdpPacketIdExpected</a>, <a class="el" href="../../d8/d7/alpha_2kdtrap_8c-source.html#l00386">KdpStub()</a>, <a class="el" href="../../d9/d2/kdapi_8c-source.html#l02318">KdpSwitchProcessor()</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00290">KdpTimeSlipDpc</a>, <a class="el" href="../../d9/d2/kdapi_8c-source.html#l00494">KdpTimeSlipDpcRoutine()</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00292">KdpTimeSlipTimer</a>, <a class="el" href="../../d9/d2/kdapi_8c-source.html#l00528">KdpTimeSlipWork()</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00291">KdpTimeSlipWorkItem</a>, <a class="el" href="../../d8/d7/alpha_2kdtrap_8c-source.html#l00028">KdpTrap()</a>, <a class="el" href="../../d6/d5/4_2kdinit_8c-source.html#l00287">KdRegisterDebuggerDataBlock()</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00207">KdTimerStart</a>, <a class="el" href="../../d5/d0/dpcobj_8c-source.html#l00039">KeInitializeDpc()</a>, <a class="el" href="../../d4/d1/timerobj_8c-source.html#l00043">KeInitializeTimer()</a>, <a class="el" href="../../d2/d7/hal_8h.html#a205">KeQueryPerformanceCounter()</a>, <a class="el" href="../../d1/d6/kdp_8h-source.html#l00437">KiDebugRoutine</a>, <a class="el" href="../../d1/d6/kdp_8h-source.html#l00438">KiDebugSwitchRoutine</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d5/kdinit_8c-source.html#l00028">PORT_OPTION</a>, <a class="el" href="../../d2/d7/regtest_8c.html#a2">strlen()</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d9/d2/kdapi_8c-source.html#l03282">KdEnableDebugger()</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>, <a class="el" href="../../d9/d9/ppc_2dmpstate_8c-source.html#l00067">KeDumpMachineState()</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l01015">KeEnterKernelDebugger()</a>, and <a class="el" href="../../d8/d1/alpha_2initkr_8c-source.html#l00065">KiInitializeKernel()</a>.
<p>
<pre class="fragment"><div>00079                    :
00080 
00081     This routine initializes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> portable kernel debugger.
00082 
00083 Arguments:
00084 
00085     LoaderBlock - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d1/d2/struct__LOADER__PARAMETER__BLOCK.html">LOADER_PARAMETER_BLOCK</a> passed
00086         in from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> OS Loader.
00087 
00088     StopInDebugger - Supplies a <span class="keywordtype">boolean</span> value that determines whether a
00089         debug message and breakpoint are generated.
00090 
00091 Return Value:
00092 
00093     None.
00094 
00095 --*/
00096 
00097 {
00098 
00099     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00100     BOOLEAN Initialize;
00101     PCHAR Options;
00102     PCHAR BaudOption;
00103     PCHAR PortOption;
00104 
00105     <span class="comment">//</span>
00106     <span class="comment">// If kernel debugger is already initialized, then return.</span>
00107     <span class="comment">//</span>
00108 
00109     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d3/kd_8h.html#a13">KdDebuggerEnabled</a> != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00110         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00111     }
00112 
00113     <a class="code" href="../../d0/d7/kdp_8h.html#a24">KiDebugRoutine</a> = <a class="code" href="../../d7/d8/alpha_2kdtrap_8c.html#a2">KdpStub</a>;
00114 
00115     <span class="comment">//</span>
00116     <span class="comment">// Determine whether or not the debugger should be enabled.</span>
00117     <span class="comment">//</span>
00118     <span class="comment">// Note that if LoaderBlock == NULL, then KdInitSystem was called</span>
00119     <span class="comment">// from BugCheck code. For this case the debugger is always enabled</span>
00120     <span class="comment">// to report the bugcheck if possible.</span>
00121     <span class="comment">//</span>
00122 
00123     <span class="keywordflow">if</span> (LoaderBlock != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00124 
00125         <a class="code" href="../../d8/d5/kddata_8c.html#a94">KdpNtosImageBase</a> =  CONTAINING_RECORD(
00126                                     (LoaderBlock-&gt;LoadOrderListHead.Flink),
00127                                     LDR_DATA_TABLE_ENTRY,
00128                                     InLoadOrderLinks)-&gt;DllBase;
00129 
00130         <span class="comment">//</span>
00131         <span class="comment">// Initialize the debugger data block list when called at startup time.</span>
00132         <span class="comment">//</span>
00133 
00134         InitializeListHead(&amp;KdpDebuggerDataListHead);
00135 
00136         <span class="comment">//</span>
00137         <span class="comment">// Fill in and register the debugger's debugger data block.</span>
00138         <span class="comment">// Most fields are already initialized, some fields will not be</span>
00139         <span class="comment">// filled in until later.</span>
00140         <span class="comment">//</span>
00141 
00142         <a class="code" href="../../d8/d5/kddata_8c.html#a50">KdDebuggerDataBlock</a>.KernBase = (ULONG_PTR) <a class="code" href="../../d8/d5/kddata_8c.html#a94">KdpNtosImageBase</a>;
00143 
00144         <a class="code" href="../../d5/d6/4_2kdinit_8c.html#a5">KdRegisterDebuggerDataBlock</a>(KDBG_TAG,
00145                                     &amp;<a class="code" href="../../d8/d5/kddata_8c.html#a50">KdDebuggerDataBlock</a>.Header,
00146                                     <span class="keyword">sizeof</span>(KdDebuggerDataBlock));
00147 
00148         <span class="keywordflow">if</span> (LoaderBlock-&gt;LoadOptions != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00149             Options = LoaderBlock-&gt;LoadOptions;
00150             _strupr(Options);
00151 
00152             <span class="comment">//</span>
00153             <span class="comment">// If any of the port option, baud option, or debug is specified,</span>
00154             <span class="comment">// then enable the debugger unless it is explictly disabled.</span>
00155             <span class="comment">//</span>
00156 
00157             Initialize = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00158             PortOption = strstr(Options, PORT_OPTION);
00159             BaudOption = strstr(Options, BAUD_OPTION);
00160             <span class="keywordflow">if</span> ((PortOption == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (BaudOption == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00161                 <span class="keywordflow">if</span> (strstr(Options, <span class="stringliteral">"DEBUG"</span>) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00162                     Initialize = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00163                 }
00164 
00165             } <span class="keywordflow">else</span> {
00166                 <span class="keywordflow">if</span> (PortOption) {
00167                     PortOption = strstr(PortOption, <span class="stringliteral">"COM"</span>);
00168                     <span class="keywordflow">if</span> (PortOption) {
00169                         <a class="code" href="../../d7/d3/kd_8h.html#a14">KdDebugParameters</a>.<a class="code" href="../../d0/d2/struct__DEBUG__PARAMETERS.html#o0">CommunicationPort</a> =
00170                                                      atol(PortOption + 3);
00171                     }
00172                 }
00173 
00174                 <span class="keywordflow">if</span> (BaudOption) {
00175                     BaudOption += <a class="code" href="../../d2/d7/regtest_8c.html#a2">strlen</a>(BAUD_OPTION);
00176                     <span class="keywordflow">while</span> (*BaudOption == <span class="charliteral">' '</span>) {
00177                         BaudOption++;
00178                     }
00179 
00180                     <span class="keywordflow">if</span> (*BaudOption != <span class="charliteral">'\0'</span>) {
00181                         <a class="code" href="../../d7/d3/kd_8h.html#a14">KdDebugParameters</a>.<a class="code" href="../../d0/d2/struct__DEBUG__PARAMETERS.html#o1">BaudRate</a> = atol(BaudOption + 1);
00182                     }
00183                 }
00184             }
00185 
00186             <span class="comment">//</span>
00187             <span class="comment">// If the debugger is explicitly disabled, then set to NODEBUG.</span>
00188             <span class="comment">//</span>
00189 
00190             <span class="keywordflow">if</span> (strstr(Options, <span class="stringliteral">"NODEBUG"</span>)) {
00191                 Initialize = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00192                 <a class="code" href="../../d7/d3/kd_8h.html#a7">KdPitchDebugger</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00193             }
00194 
00195             <span class="keywordflow">if</span> (strstr(Options, <span class="stringliteral">"CRASHDEBUG"</span>)) {
00196                 Initialize = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00197                 <a class="code" href="../../d7/d3/kd_8h.html#a7">KdPitchDebugger</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00198             }
00199 
00200         } <span class="keywordflow">else</span> {
00201 
00202             <span class="comment">//</span>
00203             <span class="comment">// If the load options are not specified, then set to NODEBUG.</span>
00204             <span class="comment">//</span>
00205 
00206             <a class="code" href="../../d7/d3/kd_8h.html#a7">KdPitchDebugger</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00207             Initialize = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00208         }
00209 
00210     } <span class="keywordflow">else</span> {
00211         Initialize = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00212     }
00213 
00214     <span class="keywordflow">if</span> ((<a class="code" href="../../d2/d7/hal_8h.html#a199">KdPortInitialize</a>(&amp;KdDebugParameters, LoaderBlock, Initialize) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) ||
00215         (Initialize == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
00216         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00217     }
00218 
00219     <span class="comment">//</span>
00220     <span class="comment">// Set address of kernel debugger trap routine.</span>
00221     <span class="comment">//</span>
00222 
00223     <a class="code" href="../../d0/d7/kdp_8h.html#a24">KiDebugRoutine</a> = <a class="code" href="../../d7/d8/alpha_2kdtrap_8c.html#a0">KdpTrap</a>;
00224 
00225     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d5/kddata_8c.html#a107">KdpDebuggerStructuresInitialized</a>) {
00226 
00227         <a class="code" href="../../d0/d7/kdp_8h.html#a25">KiDebugSwitchRoutine</a> = <a class="code" href="../../d8/d3/kdapi_8c.html#a30">KdpSwitchProcessor</a>;
00228         <a class="code" href="../../d8/d5/kddata_8c.html#a91">KdpBreakpointInstruction</a> = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a6">KDP_BREAKPOINT_VALUE</a>;
00229         <a class="code" href="../../d8/d5/kddata_8c.html#a108">KdpOweBreakpoint</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00230 
00231         <span class="comment">//</span>
00232         <span class="comment">// Initialize the breakpoint table.</span>
00233         <span class="comment">//</span>
00234 
00235         <span class="keywordflow">for</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; BREAKPOINT_TABLE_SIZE; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1) {
00236             <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o0">Flags</a> = 0;
00237             <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o2">Address</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00238             <a class="code" href="../../d8/d5/kddata_8c.html#a51">KdpBreakpointTable</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d3/d5/struct__BREAKPOINT__ENTRY.html#o1">DirectoryTableBase</a> = 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00239         }
00240 
00241         <span class="comment">//</span>
00242         <span class="comment">// Initialize TimeSlip</span>
00243         <span class="comment">//</span>
00244         <a class="code" href="../../d4/d1/dpcobj_8c.html#a1">KeInitializeDpc</a>(&amp;KdpTimeSlipDpc, KdpTimeSlipDpcRoutine, NULL);
00245         <a class="code" href="../../d3/d2/timerobj_8c.html#a1">KeInitializeTimer</a>(&amp;KdpTimeSlipTimer);
00246         <a class="code" href="../../d5/d8/ex_8h.html#a55">ExInitializeWorkItem</a>(&amp;KdpTimeSlipWorkItem, KdpTimeSlipWork, NULL);
00247 
00248         <a class="code" href="../../d8/d5/kddata_8c.html#a107">KdpDebuggerStructuresInitialized</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> ;
00249     }
00250 
00251     <span class="comment">//</span>
00252     <span class="comment">//  Initialize timer facility - HACKHACK</span>
00253     <span class="comment">//</span>
00254 
00255     <a class="code" href="../../d2/d7/hal_8h.html#a205">KeQueryPerformanceCounter</a>(&amp;KdPerformanceCounterRate);
00256     <a class="code" href="../../d8/d5/kddata_8c.html#a56">KdTimerStart</a>.HighPart = 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00257     <a class="code" href="../../d8/d5/kddata_8c.html#a56">KdTimerStart</a>.LowPart = 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
00258 
00259     <span class="comment">//</span>
00260     <span class="comment">// Initialize ID for NEXT packet to send and Expect ID of next incoming</span>
00261     <span class="comment">// packet.</span>
00262     <span class="comment">//</span>
00263 
00264     <a class="code" href="../../d8/d5/kddata_8c.html#a92">KdpNextPacketIdToSend</a> = INITIAL_PACKET_ID | SYNC_PACKET_ID;
00265     <a class="code" href="../../d8/d5/kddata_8c.html#a93">KdpPacketIdExpected</a> = INITIAL_PACKET_ID;
00266 
00267     <span class="comment">//</span>
00268     <span class="comment">// Mark debugger enabled.</span>
00269     <span class="comment">//</span>
00270     <a class="code" href="../../d7/d3/kd_8h.html#a7">KdPitchDebugger</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00271     <a class="code" href="../../d7/d3/kd_8h.html#a13">KdDebuggerEnabled</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00272     SharedUserData-&gt;KdDebuggerEnabled = 0x00000001;
00273 
00274     <span class="comment">//</span>
00275     <span class="comment">// If requested, stop in the kernel debugger.</span>
00276     <span class="comment">//</span>
00277 
00278     <span class="keywordflow">if</span> (StopInDebugger) {
00279         DbgBreakPoint();
00280     }
00281 
00282     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00283 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="4/kdinit.c::KdLogDbgPrint" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KdLogDbgPrint           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PSTRING&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>String</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/4_2kdinit_8c-source.html#l00414">414</a> of file <a class="el" href="../../d6/d5/4_2kdinit_8c-source.html">4/kdinit.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00091">HIGH_LEVEL</a>, <a class="el" href="../../d9/d5/kdmove_8c-source.html#l00031">KdpMoveMemory()</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00104">KdpPrintSpinLock</a>, <a class="el" href="../../d8/d2/kd_8h-source.html#l00203">KDPRINTBUFFERSIZE</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00101">KdPrintCircularBuffer</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00103">KdPrintRolloverCount</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00102">KdPrintWritePointer</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql()</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql()</a>, <a class="el" href="../../d0/d0/ki_8h.html#a155">KiTryToAcquireSpinLock()</a>, and <a class="el" href="../../d5/d8/talloc_8c-source.html#l00027">String</a>.
<p>
Referenced by <a class="el" href="../../d8/d7/alpha_2kdtrap_8c-source.html#l00028">KdpTrap()</a>.
<p>
<pre class="fragment"><div>00417 {
00418     KIRQL OldIrql;
00419     ULONG Length;
00420     ULONG LengthCopied;
00421 
00422     <span class="keywordflow">for</span> (; ;) {
00423         <span class="keywordflow">if</span> (KeTestSpinLock (&amp;KdpPrintSpinLock)) {
00424             <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a> (HIGH_LEVEL, &amp;OldIrql);
00425             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/ki_8h.html#a155">KiTryToAcquireSpinLock</a>(&amp;KdpPrintSpinLock)) {
00426                 <span class="keywordflow">break</span>;          <span class="comment">// got the lock</span>
00427             }
00428             <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>(OldIrql);
00429         }
00430     }
00431 
00432     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/kddata_8c.html#a46">KdPrintCircularBuffer</a>) {
00433         Length = <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>-&gt;Length;
00434         <span class="comment">//</span>
00435         <span class="comment">// truncate ridiculous strings</span>
00436         <span class="comment">//</span>
00437         <span class="keywordflow">if</span> (Length &gt; <a class="code" href="../../d7/d3/kd_8h.html#a6">KDPRINTBUFFERSIZE</a>) {
00438             Length = <a class="code" href="../../d7/d3/kd_8h.html#a6">KDPRINTBUFFERSIZE</a>;
00439         }
00440 
00441         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/kddata_8c.html#a47">KdPrintWritePointer</a> + Length &lt;= <a class="code" href="../../d8/d5/kddata_8c.html#a46">KdPrintCircularBuffer</a>+<a class="code" href="../../d7/d3/kd_8h.html#a6">KDPRINTBUFFERSIZE</a>) {
00442             LengthCopied = <a class="code" href="../../d1/d7/4_2kdp_8h.html#a110">KdpMoveMemory</a>(KdPrintWritePointer, <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>-&gt;Buffer, Length);
00443             <a class="code" href="../../d8/d5/kddata_8c.html#a47">KdPrintWritePointer</a> += LengthCopied;
00444             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/kddata_8c.html#a47">KdPrintWritePointer</a> &gt;= <a class="code" href="../../d8/d5/kddata_8c.html#a46">KdPrintCircularBuffer</a>+<a class="code" href="../../d7/d3/kd_8h.html#a6">KDPRINTBUFFERSIZE</a>) {
00445                 <a class="code" href="../../d8/d5/kddata_8c.html#a47">KdPrintWritePointer</a> = <a class="code" href="../../d8/d5/kddata_8c.html#a46">KdPrintCircularBuffer</a>;
00446                 <a class="code" href="../../d8/d5/kddata_8c.html#a48">KdPrintRolloverCount</a>++;
00447             }
00448         } <span class="keywordflow">else</span> {
00449             ULONG First = (ULONG)(<a class="code" href="../../d8/d5/kddata_8c.html#a46">KdPrintCircularBuffer</a> + <a class="code" href="../../d7/d3/kd_8h.html#a6">KDPRINTBUFFERSIZE</a> - <a class="code" href="../../d8/d5/kddata_8c.html#a47">KdPrintWritePointer</a>);
00450             LengthCopied = <a class="code" href="../../d1/d7/4_2kdp_8h.html#a110">KdpMoveMemory</a>(KdPrintWritePointer,
00451                                          <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>-&gt;Buffer,
00452                                          First);
00453             <span class="keywordflow">if</span> (LengthCopied == First) {
00454                 LengthCopied += <a class="code" href="../../d1/d7/4_2kdp_8h.html#a110">KdpMoveMemory</a>(KdPrintCircularBuffer,
00455                                               <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>-&gt;Buffer + First,
00456                                               Length - First);
00457             }
00458             <span class="keywordflow">if</span> (LengthCopied &gt; First) {
00459                 <a class="code" href="../../d8/d5/kddata_8c.html#a47">KdPrintWritePointer</a> = <a class="code" href="../../d8/d5/kddata_8c.html#a46">KdPrintCircularBuffer</a> + LengthCopied - First;
00460                 <a class="code" href="../../d8/d5/kddata_8c.html#a48">KdPrintRolloverCount</a>++;
00461             } <span class="keywordflow">else</span> {
00462                 <a class="code" href="../../d8/d5/kddata_8c.html#a47">KdPrintWritePointer</a> += LengthCopied;
00463                 <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/kddata_8c.html#a47">KdPrintWritePointer</a> &gt;= <a class="code" href="../../d8/d5/kddata_8c.html#a46">KdPrintCircularBuffer</a>+<a class="code" href="../../d7/d3/kd_8h.html#a6">KDPRINTBUFFERSIZE</a>) {
00464                     <a class="code" href="../../d8/d5/kddata_8c.html#a47">KdPrintWritePointer</a> = <a class="code" href="../../d8/d5/kddata_8c.html#a46">KdPrintCircularBuffer</a>;
00465                     <a class="code" href="../../d8/d5/kddata_8c.html#a48">KdPrintRolloverCount</a>++;
00466                 }
00467             }
00468         }
00469     }
00470 
00471     KiReleaseSpinLock(&amp;KdpPrintSpinLock);
00472     <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>(OldIrql);
00473 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="4/kdinit.c::KdRegisterDebuggerDataBlock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN KdRegisterDebuggerDataBlock           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Tag</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d7/d3/kd_8h.html#a15">PDBGKD_DEBUG_DATA_HEADER64</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DataHeader</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Size</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/4_2kdinit_8c-source.html#l00287">287</a> of file <a class="el" href="../../d6/d5/4_2kdinit_8c-source.html">4/kdinit.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d4/d2/dumpuser_8c-source.html#l00048">Header</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00279">KdpDataSpinLock</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00280">KdpDebuggerDataListHead</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02007">KeAcquireSpinLock</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a119">KeReleaseSpinLock()</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00094">List</a>, <a class="el" href="../../d8/d2/kd_8h-source.html#l00167">PDBGKD_DEBUG_DATA_HEADER64</a>, <a class="el" href="../../d9/d6/lh__open_2pi__mem_8h-source.html#l00017">Size</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d5/d5/kdinit_8c-source.html#l00036">KdInitSystem()</a>.
<p>
<pre class="fragment"><div>00294                    :
00295 
00296     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called by a component or driver to <span class="keyword">register</span> a
00297     debugger data block.  The data block <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a> accessible to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00298     kernel debugger, thus providing a reliable method of exposing
00299     random data to debugger extensions.
00300 
00301 Arguments:
00302 
00303     Tag - Supplies a unique 4 byte tag which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to identify <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00304             data block.
00305 
00306     DataHeader - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> debugger data block header.
00307             The OwnerTag field must contain a unique value, and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>
00308             field must contain <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data block, including <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00309             header.  If <span class="keyword">this</span> block <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> already present, or there <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00310             already a block with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> same value <span class="keywordflow">for</span> OwnerTag, <span class="keyword">this</span> one
00311             will not be inserted.  If <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> incorrect, <span class="keyword">this</span> code will
00312             not notice, but <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> usermode side of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> debugger might not
00313             function correctly.
00314 
00315     <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data block, including <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> header.
00316 
00317 Return Value:
00318 
00319     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> block was added to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> list, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <span class="keywordflow">if</span> not.
00320 
00321 --*/
00322 {
00323     KIRQL OldIrql;
00324     PLIST_ENTRY <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>;
00325     <a class="code" href="../../d7/d3/kd_8h.html#a15">PDBGKD_DEBUG_DATA_HEADER64</a> <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>;
00326 
00327     <a class="code" href="../../d4/d9/ke_8h.html#a37">KeAcquireSpinLock</a>(&amp;KdpDataSpinLock, &amp;OldIrql);
00328 
00329     <span class="comment">//</span>
00330     <span class="comment">// Look for a record with the same tag or address</span>
00331     <span class="comment">//</span>
00332 
00333     <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a> = <a class="code" href="../../d8/d5/kddata_8c.html#a97">KdpDebuggerDataListHead</a>.Flink;
00334 
00335     <span class="keywordflow">while</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a> != &amp;<a class="code" href="../../d8/d5/kddata_8c.html#a97">KdpDebuggerDataListHead</a>) {
00336 
00337         <a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a> = CONTAINING_RECORD(List, DBGKD_DEBUG_DATA_HEADER64, List);
00338 
00339         <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a> = <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>-&gt;Flink;
00340 
00341         <span class="keywordflow">if</span> ((<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a> == DataHeader) || (<a class="code" href="../../d3/d3/dumpuser_8c.html#a17">Header</a>-&gt;OwnerTag == Tag)) {
00342             <a class="code" href="../../d9/d5/verifier_8c.html#a119">KeReleaseSpinLock</a>(&amp;KdpDataSpinLock, OldIrql);
00343             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00344         }
00345     }
00346 
00347     <span class="comment">//</span>
00348     <span class="comment">// It wasn't already there, so add it.</span>
00349     <span class="comment">//</span>
00350 
00351     DataHeader-&gt;OwnerTag = Tag;
00352     DataHeader-&gt;Size = <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
00353 
00354     InsertTailList(&amp;KdpDebuggerDataListHead, (PLIST_ENTRY)(&amp;DataHeader-&gt;List));
00355 
00356     <a class="code" href="../../d9/d5/verifier_8c.html#a119">KeReleaseSpinLock</a>(&amp;KdpDataSpinLock, OldIrql);
00357 
00358     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00359 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="4/kdinit.c::KdUpdateDataBlock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID KdUpdateDataBlock           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/4_2kdinit_8c-source.html#l00038">38</a> of file <a class="el" href="../../d6/d5/4_2kdinit_8c-source.html">4/kdinit.c</a>.
<p>
References <a class="el" href="../../d9/d4/kddata_8c-source.html#l00106">KdDebuggerDataBlock</a>, and <a class="el" href="../../d5/d8/ke_8h-source.html#l02809">KeUserCallbackDispatcher</a>.
<p>
Referenced by <a class="el" href="../../d1/d0/psinit_8c-source.html#l00745">PspInitializeSystemDll()</a>.
<p>
<pre class="fragment"><div>00043                    :
00044 
00045     We have to update <span class="keyword">this</span> variable seperately since <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> initialized at a
00046     later time by PS.  PS will call us to update <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data block.
00047 
00048 --*/
00049 {
00050     <a class="code" href="../../d8/d5/kddata_8c.html#a50">KdDebuggerDataBlock</a>.KeUserCallbackDispatcher = (ULONG_PTR) <a class="code" href="../../d4/d9/ke_8h.html#a149">KeUserCallbackDispatcher</a>;
00051 }

</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:44:26 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
