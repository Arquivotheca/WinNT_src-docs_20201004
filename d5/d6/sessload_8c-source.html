<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: sessload.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>sessload.c</h1><a href="../../d4/d7/sessload_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1997  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">   sessload.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module contains the routines which implement the loading of</span>
00012 <span class="comment">    session space drivers.</span>
00013 <span class="comment"></span>
00014 <span class="comment">Author:</span>
00015 <span class="comment"></span>
00016 <span class="comment">    Landy Wang (landyw) 05-Dec-1997</span>
00017 <span class="comment"></span>
00018 <span class="comment">Revision History:</span>
00019 <span class="comment"></span>
00020 <span class="comment">--*/</span>
00021 
00022 <span class="preprocessor">#include "<a class="code" href="../../d4/d8/mi_8h.html">mi.h</a>"</span>
00023 
00024 <span class="comment">//</span>
00025 <span class="comment">// This tracks allocated group virtual addresses.  The term SESSIONWIDE is used</span>
00026 <span class="comment">// to denote data that is the same across all sessions (as opposed to</span>
00027 <span class="comment">// per-session data which can vary from session to session).</span>
00028 <span class="comment">//</span>
00029 <span class="comment">// Since each driver loaded into a session space is linked and fixed up</span>
00030 <span class="comment">// against the system image, it must remain at the same virtual address</span>
00031 <span class="comment">// across the system regardless of the session.</span>
00032 <span class="comment">//</span>
00033 <span class="comment">// A list is maintained by the group allocator of which virtual</span>
00034 <span class="comment">// addresses are in use and by which DLL.</span>
00035 <span class="comment">//</span>
00036 <span class="comment">// The reference count tracks the number of sessions that have loaded</span>
00037 <span class="comment">// this image.</span>
00038 <span class="comment">//</span>
00039 <span class="comment">// Access to this structure is guarded by the MmSystemLoadLock.</span>
00040 <span class="comment">//</span>
00041 
<a name="l00042"></a><a class="code" href="../../d3/d2/struct__SESSIONWIDE__DRIVER__ADDRESS.html">00042</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d3/d2/struct__SESSIONWIDE__DRIVER__ADDRESS.html">_SESSIONWIDE_DRIVER_ADDRESS</a> {
<a name="l00043"></a><a class="code" href="../../d3/d2/struct__SESSIONWIDE__DRIVER__ADDRESS.html#o0">00043</a>     LIST_ENTRY <a class="code" href="../../d3/d2/struct__SESSIONWIDE__DRIVER__ADDRESS.html#o0">Link</a>;
<a name="l00044"></a><a class="code" href="../../d3/d2/struct__SESSIONWIDE__DRIVER__ADDRESS.html#o1">00044</a>     ULONG <a class="code" href="../../d3/d2/struct__SESSIONWIDE__DRIVER__ADDRESS.html#o1">ReferenceCount</a>;
<a name="l00045"></a><a class="code" href="../../d3/d2/struct__SESSIONWIDE__DRIVER__ADDRESS.html#o2">00045</a>     PVOID <a class="code" href="../../d3/d2/struct__SESSIONWIDE__DRIVER__ADDRESS.html#o2">Address</a>;
<a name="l00046"></a><a class="code" href="../../d3/d2/struct__SESSIONWIDE__DRIVER__ADDRESS.html#o3">00046</a>     ULONG_PTR <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
<a name="l00047"></a><a class="code" href="../../d3/d2/struct__SESSIONWIDE__DRIVER__ADDRESS.html#o4">00047</a>     ULONG_PTR <a class="code" href="../../d3/d2/struct__SESSIONWIDE__DRIVER__ADDRESS.html#o4">WritablePages</a>;
<a name="l00048"></a><a class="code" href="../../d3/d2/struct__SESSIONWIDE__DRIVER__ADDRESS.html#o5">00048</a>     UNICODE_STRING <a class="code" href="../../d3/d2/struct__SESSIONWIDE__DRIVER__ADDRESS.html#o5">FullDllName</a>;
00049 } <a class="code" href="../../d3/d2/struct__SESSIONWIDE__DRIVER__ADDRESS.html">SESSIONWIDE_DRIVER_ADDRESS</a>, *<a class="code" href="../../d3/d2/struct__SESSIONWIDE__DRIVER__ADDRESS.html">PSESSIONWIDE_DRIVER_ADDRESS</a>;
00050 
<a name="l00051"></a><a class="code" href="../../d4/d7/sessload_8c.html#a2">00051</a> LIST_ENTRY <a class="code" href="../../d4/d7/sessload_8c.html#a2">MmSessionWideAddressList</a>;
00052 
00053 <span class="comment">//</span>
00054 <span class="comment">// External data references</span>
00055 <span class="comment">//</span>
00056 
<a name="l00057"></a><a class="code" href="../../d4/d7/sessload_8c.html#a3">00057</a> <span class="keyword">extern</span> KSPIN_LOCK <a class="code" href="../../d4/d4/alpha_2splocks_8c.html#a18">PsLoadedModuleSpinLock</a>;
00058 
<a name="l00059"></a><a class="code" href="../../d4/d7/sessload_8c.html#a4">00059</a> <span class="keyword">extern</span> LIST_ENTRY <a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>;
00060 
00061 <span class="comment">//</span>
00062 <span class="comment">// External function references</span>
00063 <span class="comment">//</span>
00064 
00065 ULONG
00066 <a class="code" href="../../d8/d8/sysload_8c.html#a41">MiSetProtectionOnTransitionPte</a> (
00067     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte,
00068     IN ULONG ProtectionMask
00069     );
00070 
00071 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00072 <a class="code" href="../../d4/d7/sessload_8c.html#a6">MiSessionInsertImage</a>(
00073     IN PVOID BaseAddress
00074     );
00075 
00076 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00077 <a class="code" href="../../d4/d7/sessload_8c.html#a12">MiSessionRemoveImage</a>(
00078     IN PVOID BaseAddress
00079     );
00080 
00081 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00082 <a class="code" href="../../d4/d7/sessload_8c.html#a8">MiSessionWideInsertImageAddress</a> (
00083     IN PVOID BaseAddress,
00084     IN ULONG_PTR Size,
00085     IN ULONG WritablePages,
00086     IN PUNICODE_STRING ImageName,
00087     IN BOOLEAN AtPreferredAddress
00088     );
00089 
00090 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00091 <a class="code" href="../../d4/d7/sessload_8c.html#a9">MiSessionWideDereferenceImage</a>(
00092     IN PVOID BaseAddress
00093     );
00094 
00095 PLDR_DATA_TABLE_ENTRY
00096 <a class="code" href="../../d4/d7/sessload_8c.html#a10">MiLookupPsLoadedModule</a> (
00097     IN PVOID Address
00098     );
00099 
00100 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00101 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT, MiSessionWideInitializeAddresses)</span>
00102 <span class="preprocessor"></span>
00103 <span class="preprocessor">#pragma alloc_text(PAGEHYDRA, MiSessionWideInsertImageAddress)</span>
00104 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEHYDRA, MiSessionWideReserveImageAddress)</span>
00105 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEHYDRA, MiSessionWideDereferenceImage)</span>
00106 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEHYDRA, MiSessionWideGetImageSize)</span>
00107 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEHYDRA, MiRemoveImageSessionWide)</span>
00108 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEHYDRA, MiLookupPsLoadedModule)</span>
00109 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEHYDRA, MiShareSessionImage)</span>
00110 <span class="preprocessor"></span>
00111 <span class="preprocessor">#pragma alloc_text(PAGEHYDRA, MiSessionInsertImage)</span>
00112 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEHYDRA, MiSessionRemoveImage)</span>
00113 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEHYDRA, MiSessionLookupImage)</span>
00114 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEHYDRA, MiSessionUnloadAllImages)</span>
00115 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00116 <span class="preprocessor"></span>
00117 
00118 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00119"></a><a class="code" href="../../d4/d7/sessload_8c.html#a11">00119</a> <a class="code" href="../../d4/d7/sessload_8c.html#a11">MiShareSessionImage</a> (
00120     IN PSECTION Section,
00121     IN OUT PSIZE_T ViewSize
00122     )
00123 
00124 <span class="comment">/*++</span>
00125 <span class="comment"></span>
00126 <span class="comment">Routine Description:</span>
00127 <span class="comment"></span>
00128 <span class="comment">    This routine maps the given image into the current session space.</span>
00129 <span class="comment">    This allows the image to be executed backed by the image file in the</span>
00130 <span class="comment">    filesystem and allow code and read-only data to be shared.</span>
00131 <span class="comment"></span>
00132 <span class="comment">Arguments:</span>
00133 <span class="comment"></span>
00134 <span class="comment">    Section - Supplies a pointer to a section.</span>
00135 <span class="comment"></span>
00136 <span class="comment">    ViewSize - Supplies the size in bytes of the view desired.</span>
00137 <span class="comment"></span>
00138 <span class="comment">Return Value:</span>
00139 <span class="comment"></span>
00140 <span class="comment">    Returns STATUS_SUCCESS on success, various NTSTATUS codes on failure.</span>
00141 <span class="comment"></span>
00142 <span class="comment">Environment:</span>
00143 <span class="comment"></span>
00144 <span class="comment">    Kernel mode, APC_LEVEL and below, MmSystemLoadLock held.</span>
00145 <span class="comment"></span>
00146 <span class="comment">--*/</span>
00147 
00148 {
00149     KIRQL WsIrql;
00150     KIRQL OldIrql;
00151     <a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a> Subsection;
00152     <a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a> ControlArea;
00153     ULONG NumberOfPtes;
00154     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> StartPte;
00155     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> EndPte;
00156     PVOID AllocationStart;
00157     SIZE_T AllocationSize;
00158     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00159     BOOLEAN FirstMapped;
00160     PVOID MappedBase;
00161     SIZE_T CommittedPages;
00162     <a class="code" href="../../d1/d1/struct__IMAGE__ENTRY__IN__SESSION.html">PIMAGE_ENTRY_IN_SESSION</a> DriverImage;
00163 
00164     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00165 
00166     <a class="code" href="../../d4/d8/mi_8h.html#a135">SYSLOAD_LOCK_OWNED_BY_ME</a> ();
00167 
00168     <span class="keywordflow">if</span> (*ViewSize == 0) {
00169         <span class="keywordflow">return</span> STATUS_SUCCESS;
00170     }
00171 
00172     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d2/d1/mm_8h.html#a302">MmIsAddressValid</a> (<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00173 
00174     MappedBase = Section-&gt;Segment-&gt;BasedAddress;
00175 
00176     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (((ULONG_PTR)MappedBase % <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>) == 0);
00177     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((*ViewSize % <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>) == 0);
00178 
00179     <a class="code" href="../../d5/d6/iosup_8c.html#a76">MmLockPagableSectionByHandle</a> (<a class="code" href="../../d5/d8/ex_8h.html#a166">ExPageLockHandle</a>);
00180 
00181     <a class="code" href="../../d4/d8/mi_8h.html#a407">LOCK_SESSION_SPACE_WS</a> (WsIrql);
00182 
00183     <span class="comment">//</span>
00184     <span class="comment">// Check to see if a purge operation is in progress and if so, wait</span>
00185     <span class="comment">// for the purge to complete.  In addition, up the count of mapped</span>
00186     <span class="comment">// views for this control area.</span>
00187     <span class="comment">//</span>
00188 
00189     ControlArea = Section-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o0">Segment</a>-&gt;<a class="code" href="../../d1/d1/struct__SEGMENT.html#o0">ControlArea</a>;
00190 
00191     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.GlobalOnlyPerSession == 0);
00192 
00193     Subsection = (<a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a>)(ControlArea + 1);
00194 
00195     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a928">MiCheckPurgeAndUpMapCount</a> (ControlArea) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00196         <a class="code" href="../../d4/d8/mi_8h.html#a408">UNLOCK_SESSION_SPACE_WS</a>(WsIrql);
00197         <a class="code" href="../../d5/d6/iosup_8c.html#a81">MmUnlockPagableImageSection</a>(<a class="code" href="../../d5/d8/ex_8h.html#a166">ExPageLockHandle</a>);
00198         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00199     }
00200 
00201     <span class="keywordflow">if</span> (*ViewSize == 0) {
00202 
00203         *ViewSize = Section-&gt;SizeOfSection.LowPart;
00204 
00205     }
00206     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*ViewSize &gt; Section-&gt;SizeOfSection.LowPart) {
00207 
00208         <span class="comment">//</span>
00209         <span class="comment">// Section offset or view size past size of section.</span>
00210         <span class="comment">//</span>
00211 
00212         <a class="code" href="../../d4/d8/mi_8h.html#a408">UNLOCK_SESSION_SPACE_WS</a>(WsIrql);
00213         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00214         ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o4">NumberOfMappedViews</a> -= 1;
00215         ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o7">NumberOfUserReferences</a> -= 1;
00216 
00217         <span class="comment">//</span>
00218         <span class="comment">// Check to see if the control area (segment) should be deleted.</span>
00219         <span class="comment">// This routine releases the PFN lock.</span>
00220         <span class="comment">//</span>
00221     
00222         <a class="code" href="../../d5/d5/sectsup_8c.html#a24">MiCheckControlArea</a> (ControlArea, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, OldIrql);
00223 
00224         <a class="code" href="../../d5/d6/iosup_8c.html#a81">MmUnlockPagableImageSection</a>(<a class="code" href="../../d5/d8/ex_8h.html#a166">ExPageLockHandle</a>);
00225         <span class="keywordflow">return</span> STATUS_INVALID_VIEW_SIZE;
00226     }
00227 
00228     AllocationStart = MappedBase;
00229 
00230     AllocationSize = *ViewSize;
00231 
00232     <span class="comment">//</span>
00233     <span class="comment">// Calculate the PTE ranges and amount.</span>
00234     <span class="comment">//</span>
00235 
00236     StartPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (AllocationStart);
00237 
00238     EndPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> ((PCHAR)AllocationStart + AllocationSize);
00239 
00240     NumberOfPtes = <a class="code" href="../../d2/d1/mm_8h.html#a5">BYTES_TO_PAGES</a> (AllocationSize);
00241 
00242     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d7/sessload_8c.html#a16">MiSessionWideGetImageSize</a> (MappedBase,
00243                                         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00244                                         &amp;CommittedPages);
00245 
00246     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00247         CommittedPages = NumberOfPtes;
00248     }
00249 
00250     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00251 
00252     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d1/mmquota_8c.html#a17">MiChargeCommitment</a> (CommittedPages, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00253         <a class="code" href="../../d4/d8/mi_8h.html#a396">MM_BUMP_SESSION_FAILURES</a> (<a class="code" href="../../d4/d8/mi_8h.html#a387">MM_SESSION_FAILURE_NO_COMMIT</a>);
00254         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_MEMORY;
00255     }
00256 
00257     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00258 
00259         <span class="comment">//</span>
00260         <span class="comment">// Don't bother releasing the page tables or their commit here, another</span>
00261         <span class="comment">// load will happen shortly or the whole session will go away.  On</span>
00262         <span class="comment">// session exit everything will be released automatically.</span>
00263         <span class="comment">//</span>
00264 
00265         <a class="code" href="../../d4/d8/mi_8h.html#a408">UNLOCK_SESSION_SPACE_WS</a>(WsIrql);
00266 
00267         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00268         ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o4">NumberOfMappedViews</a> -= 1;
00269         ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o7">NumberOfUserReferences</a> -= 1;
00270 
00271         <span class="comment">//</span>
00272         <span class="comment">// Check to see if the control area (segment) should be deleted.</span>
00273         <span class="comment">// This routine releases the PFN lock.</span>
00274         <span class="comment">//</span>
00275     
00276         <a class="code" href="../../d5/d5/sectsup_8c.html#a24">MiCheckControlArea</a> (ControlArea, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, OldIrql);
00277 
00278         <a class="code" href="../../d5/d6/iosup_8c.html#a81">MmUnlockPagableImageSection</a>(<a class="code" href="../../d5/d8/ex_8h.html#a166">ExPageLockHandle</a>);
00279         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00280     }
00281 
00282     <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o14">CommittedPages</a> += CommittedPages;
00283 
00284     <span class="comment">//</span>
00285     <span class="comment">// Make sure we have page tables for the PTE</span>
00286     <span class="comment">// entries we must fill in the session space structure.</span>
00287     <span class="comment">//</span>
00288 
00289     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d7/session_8c.html#a9">MiSessionCommitPageTables</a> (AllocationStart,
00290                                         (PVOID)((PCHAR)AllocationStart + AllocationSize));
00291 
00292     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00293 
00294         <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o14">CommittedPages</a> -= CommittedPages;
00295         <a class="code" href="../../d4/d8/mi_8h.html#a408">UNLOCK_SESSION_SPACE_WS</a> (WsIrql);
00296 
00297         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00298         ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o4">NumberOfMappedViews</a> -= 1;
00299         ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o7">NumberOfUserReferences</a> -= 1;
00300 
00301         <span class="comment">//</span>
00302         <span class="comment">// Check to see if the control area (segment) should be deleted.</span>
00303         <span class="comment">// This routine releases the PFN lock.</span>
00304         <span class="comment">//</span>
00305     
00306         <a class="code" href="../../d5/d5/sectsup_8c.html#a24">MiCheckControlArea</a> (ControlArea, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, OldIrql);
00307 
00308         <a class="code" href="../../d5/d6/iosup_8c.html#a81">MmUnlockPagableImageSection</a> (<a class="code" href="../../d5/d8/ex_8h.html#a166">ExPageLockHandle</a>);
00309         <a class="code" href="../../d6/d1/mmquota_8c.html#a19">MiReturnCommitment</a> (CommittedPages);
00310 
00311         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00312     }
00313 
00314     <a class="code" href="../../d4/d8/mi_8h.html#a254">MM_TRACK_COMMIT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a280">MM_DBG_COMMIT_SESSION_SHARED_IMAGE</a>, CommittedPages);
00315 
00316     <a class="code" href="../../d4/d8/mi_8h.html#a384">MM_BUMP_SESS_COUNTER</a> (<a class="code" href="../../d4/d8/mi_8h.html#a376">MM_DBG_SESSION_SYSMAPPED_PAGES_COMMITTED</a>, CommittedPages);
00317 
00318     <a class="code" href="../../d4/d8/mi_8h.html#a384">MM_BUMP_SESS_COUNTER</a> (<a class="code" href="../../d4/d8/mi_8h.html#a364">MM_DBG_SESSION_SYSMAPPED_PAGES_ALLOC</a>, NumberOfPtes);
00319 
00320 <span class="preprocessor">#if DBG</span>
00321 <span class="preprocessor"></span>    <span class="keywordflow">while</span> (StartPte &lt; EndPte) {
00322         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (StartPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == 0);
00323         StartPte += 1;
00324     }
00325     StartPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (AllocationStart);
00326 <span class="preprocessor">#endif</span>
00327 <span class="preprocessor"></span>
00328     <span class="comment">//</span>
00329     <span class="comment">// Flag that the image is mapped into system space.</span>
00330     <span class="comment">//</span>
00331 
00332     <span class="keywordflow">if</span> (Section-&gt;u.Flags.Image) {
00333 
00334         FirstMapped = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00335 
00336         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00337         <span class="keywordflow">if</span> (ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.ImageMappedInSystemSpace == 0) {
00338             FirstMapped = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00339             ControlArea-&gt;<a class="code" href="../../d8/d7/struct__CONTROL__AREA.html#o10">u</a>.Flags.ImageMappedInSystemSpace = 1;
00340         }
00341         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00342 
00343         <span class="comment">//</span>
00344         <span class="comment">// Initialize all of the pages to copy on write - later read only</span>
00345         <span class="comment">// protections will be set on the code pages.</span>
00346         <span class="comment">//</span>
00347     
00348         <span class="keywordflow">if</span> (FirstMapped == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00349             <a class="code" href="../../d8/d8/sysload_8c.html#a62">MiSetImageProtect</a> (Section-&gt;Segment, <a class="code" href="../../d4/d8/mi_8h.html#a38">MM_EXECUTE_READ</a>);
00350         }
00351     }
00352 
00353     <span class="comment">//</span>
00354     <span class="comment">// Initialize the PTEs as copy on write, pointing at the prototype PTEs.</span>
00355     <span class="comment">//</span>
00356 
00357     <a class="code" href="../../d4/d8/mi_8h.html#a816">MiAddMappedPtes</a> (StartPte,
00358                      NumberOfPtes,
00359                      ControlArea);
00360 
00361     <a class="code" href="../../d4/d8/mi_8h.html#a408">UNLOCK_SESSION_SPACE_WS</a>(WsIrql);
00362 
00363     <span class="comment">//</span>
00364     <span class="comment">// No session space image faults may be taken until these fields of the</span>
00365     <span class="comment">// image entry are initialized.</span>
00366     <span class="comment">//</span>
00367 
00368     DriverImage = <a class="code" href="../../d4/d7/sessload_8c.html#a13">MiSessionLookupImage</a> (AllocationStart);
00369     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (DriverImage);
00370 
00371     DriverImage-&gt;<a class="code" href="../../d1/d1/struct__IMAGE__ENTRY__IN__SESSION.html#o2">LastAddress</a> = (PVOID)((PCHAR)AllocationStart + AllocationSize - 1);
00372     DriverImage-&gt;<a class="code" href="../../d1/d1/struct__IMAGE__ENTRY__IN__SESSION.html#o4">PrototypePtes</a> = Section-&gt;Segment-&gt;PrototypePte;
00373 
00374     <a class="code" href="../../d5/d6/iosup_8c.html#a81">MmUnlockPagableImageSection</a>(<a class="code" href="../../d5/d8/ex_8h.html#a166">ExPageLockHandle</a>);
00375 
00376     <span class="keywordflow">return</span> STATUS_SUCCESS;
00377 }
00378 
00379 
00380 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00381"></a><a class="code" href="../../d4/d7/sessload_8c.html#a6">00381</a> <a class="code" href="../../d4/d7/sessload_8c.html#a6">MiSessionInsertImage</a>(
00382     IN PVOID BaseAddress
00383     )
00384 
00385 <span class="comment">/*++</span>
00386 <span class="comment"></span>
00387 <span class="comment">Routine Description:</span>
00388 <span class="comment"></span>
00389 <span class="comment">    This routine allocates an image entry for the specified address in the</span>
00390 <span class="comment">    current session space.</span>
00391 <span class="comment"></span>
00392 <span class="comment">Arguments:</span>
00393 <span class="comment"></span>
00394 <span class="comment">    BaseAddress - Supplies the base address for the executable image.</span>
00395 <span class="comment"></span>
00396 <span class="comment">Return Value:</span>
00397 <span class="comment"></span>
00398 <span class="comment">    STATUS_SUCCESS or various NTSTATUS error codes on failure.</span>
00399 <span class="comment"></span>
00400 <span class="comment">Environment:</span>
00401 <span class="comment"></span>
00402 <span class="comment">    Kernel mode, APC_LEVEL and below, MmSystemLoadLock held.</span>
00403 <span class="comment"></span>
00404 <span class="comment">--*/</span>
00405 
00406 {
00407     PLIST_ENTRY NextEntry;
00408     <a class="code" href="../../d1/d1/struct__IMAGE__ENTRY__IN__SESSION.html">PIMAGE_ENTRY_IN_SESSION</a> Image;
00409     KIRQL OldIrql;
00410 
00411     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00412 
00413     <a class="code" href="../../d4/d8/mi_8h.html#a135">SYSLOAD_LOCK_OWNED_BY_ME</a> ();
00414 
00415     <span class="comment">//</span>
00416     <span class="comment">// Check to see if the address is already loaded.</span>
00417     <span class="comment">//</span>
00418 
00419     <a class="code" href="../../d4/d8/mi_8h.html#a407">LOCK_SESSION_SPACE_WS</a> (OldIrql);
00420 
00421     NextEntry = <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o24">ImageList</a>.Flink;
00422 
00423     <span class="keywordflow">while</span> (NextEntry != &amp;<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o24">ImageList</a>) {
00424         Image = CONTAINING_RECORD (NextEntry, <a class="code" href="../../d1/d1/struct__IMAGE__ENTRY__IN__SESSION.html">IMAGE_ENTRY_IN_SESSION</a>, Link);
00425 
00426         <span class="keywordflow">if</span> (Image-&gt;<a class="code" href="../../d1/d1/struct__IMAGE__ENTRY__IN__SESSION.html#o1">Address</a> == BaseAddress) {
00427             Image-&gt;<a class="code" href="../../d1/d1/struct__IMAGE__ENTRY__IN__SESSION.html#o3">ImageCountInThisSession</a> += 1;
00428             <a class="code" href="../../d4/d8/mi_8h.html#a408">UNLOCK_SESSION_SPACE_WS</a> (OldIrql);
00429             <span class="keywordflow">return</span> STATUS_ALREADY_COMMITTED;
00430         }
00431         NextEntry = NextEntry-&gt;Flink;
00432     }
00433 
00434     <span class="comment">//</span>
00435     <span class="comment">// Create and insert the image entry into the session space structure</span>
00436     <span class="comment">//</span>
00437 
00438     Image = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
00439                                    <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d1/struct__IMAGE__ENTRY__IN__SESSION.html">IMAGE_ENTRY_IN_SESSION</a>),
00440                                    'iHmM');
00441 
00442     <span class="keywordflow">if</span> (Image == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00443         <a class="code" href="../../d4/d8/mi_8h.html#a408">UNLOCK_SESSION_SPACE_WS</a> (OldIrql);
00444         <a class="code" href="../../d4/d8/mi_8h.html#a396">MM_BUMP_SESSION_FAILURES</a> (<a class="code" href="../../d4/d8/mi_8h.html#a392">MM_SESSION_FAILURE_NO_NONPAGED_POOL</a>);
00445         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00446     }
00447 
00448     RtlZeroMemory (Image, <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d8/mi_8h.html#a759">IMAGE_ENTRY_IN_SESSION</a>));
00449 
00450     Image-&gt;<a class="code" href="../../d1/d1/struct__IMAGE__ENTRY__IN__SESSION.html#o1">Address</a> = BaseAddress;
00451     Image-&gt;<a class="code" href="../../d1/d1/struct__IMAGE__ENTRY__IN__SESSION.html#o3">ImageCountInThisSession</a> = 1;
00452 
00453     InsertTailList (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o24">ImageList</a>, &amp;Image-&gt;<a class="code" href="../../d1/d1/struct__IMAGE__ENTRY__IN__SESSION.html#o0">Link</a>);
00454 
00455     <a class="code" href="../../d4/d8/mi_8h.html#a408">UNLOCK_SESSION_SPACE_WS</a> (OldIrql);
00456     <span class="keywordflow">return</span> STATUS_SUCCESS;
00457 }
00458 
00459 
00460 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00461"></a><a class="code" href="../../d4/d7/sessload_8c.html#a12">00461</a> <a class="code" href="../../d4/d7/sessload_8c.html#a12">MiSessionRemoveImage</a>(
00462     PVOID BaseAddr
00463     )
00464 
00465 <span class="comment">/*++</span>
00466 <span class="comment"></span>
00467 <span class="comment">Routine Description:</span>
00468 <span class="comment"></span>
00469 <span class="comment">    This routine removes the given image entry from the current session space.</span>
00470 <span class="comment"></span>
00471 <span class="comment">Arguments:</span>
00472 <span class="comment"></span>
00473 <span class="comment">    BaseAddress - Supplies the base address for the executable image.</span>
00474 <span class="comment"></span>
00475 <span class="comment">Return Value:</span>
00476 <span class="comment"></span>
00477 <span class="comment">    Returns STATUS_SUCCESS on success, STATUS_NOT_FOUND if the image is not</span>
00478 <span class="comment">    in the current session space.</span>
00479 <span class="comment"></span>
00480 <span class="comment">Environment:</span>
00481 <span class="comment"></span>
00482 <span class="comment">    Kernel mode, APC_LEVEL and below.</span>
00483 <span class="comment"></span>
00484 <span class="comment">--*/</span>
00485 
00486 {
00487     PLIST_ENTRY NextEntry;
00488     <a class="code" href="../../d1/d1/struct__IMAGE__ENTRY__IN__SESSION.html">PIMAGE_ENTRY_IN_SESSION</a> Image;
00489     KIRQL OldIrql;
00490 
00491     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00492 
00493     <a class="code" href="../../d4/d8/mi_8h.html#a135">SYSLOAD_LOCK_OWNED_BY_ME</a> ();
00494 
00495     <a class="code" href="../../d4/d8/mi_8h.html#a407">LOCK_SESSION_SPACE_WS</a> (OldIrql);
00496     NextEntry = <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o24">ImageList</a>.Flink;
00497 
00498     <span class="keywordflow">while</span> (NextEntry != &amp;<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o24">ImageList</a>) {
00499 
00500         Image = CONTAINING_RECORD(NextEntry, <a class="code" href="../../d1/d1/struct__IMAGE__ENTRY__IN__SESSION.html">IMAGE_ENTRY_IN_SESSION</a>, Link);
00501 
00502         <span class="keywordflow">if</span> (Image-&gt;<a class="code" href="../../d1/d1/struct__IMAGE__ENTRY__IN__SESSION.html#o1">Address</a> == BaseAddr) {
00503             RemoveEntryList (NextEntry);
00504             <a class="code" href="../../d4/d8/mi_8h.html#a408">UNLOCK_SESSION_SPACE_WS</a> (OldIrql);
00505             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (Image);
00506             <span class="keywordflow">return</span> STATUS_SUCCESS;
00507         }
00508 
00509         NextEntry = NextEntry-&gt;Flink;
00510     }
00511 
00512     <a class="code" href="../../d4/d8/mi_8h.html#a408">UNLOCK_SESSION_SPACE_WS</a> (OldIrql);
00513     <span class="keywordflow">return</span> STATUS_NOT_FOUND;
00514 }
00515 
00516 
00517 <a class="code" href="../../d1/d1/struct__IMAGE__ENTRY__IN__SESSION.html">PIMAGE_ENTRY_IN_SESSION</a>
<a name="l00518"></a><a class="code" href="../../d4/d7/sessload_8c.html#a13">00518</a> <a class="code" href="../../d4/d7/sessload_8c.html#a13">MiSessionLookupImage</a> (
00519     IN PVOID BaseAddress
00520     )
00521 
00522 <span class="comment">/*++</span>
00523 <span class="comment"></span>
00524 <span class="comment">Routine Description:</span>
00525 <span class="comment"></span>
00526 <span class="comment">    This routine looks up the image entry within the current session by the </span>
00527 <span class="comment">    specified base address.</span>
00528 <span class="comment"></span>
00529 <span class="comment">Arguments:</span>
00530 <span class="comment"></span>
00531 <span class="comment">    BaseAddress - Supplies the base address for the executable image.</span>
00532 <span class="comment"></span>
00533 <span class="comment">Return Value:</span>
00534 <span class="comment"></span>
00535 <span class="comment">    The image entry within this session on success or NULL on failure.</span>
00536 <span class="comment"></span>
00537 <span class="comment">Environment:</span>
00538 <span class="comment"></span>
00539 <span class="comment">    Kernel mode, APC_LEVEL and below, MmSystemLoadLock held.</span>
00540 <span class="comment"></span>
00541 <span class="comment">--*/</span>
00542 
00543 {
00544     PLIST_ENTRY NextEntry;
00545     <a class="code" href="../../d1/d1/struct__IMAGE__ENTRY__IN__SESSION.html">PIMAGE_ENTRY_IN_SESSION</a> Image;
00546     KIRQL OldIrql;
00547 
00548     <a class="code" href="../../d4/d8/mi_8h.html#a135">SYSLOAD_LOCK_OWNED_BY_ME</a> ();
00549 
00550     <a class="code" href="../../d4/d8/mi_8h.html#a407">LOCK_SESSION_SPACE_WS</a> (OldIrql);
00551 
00552     NextEntry = <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o24">ImageList</a>.Flink;
00553 
00554     <span class="keywordflow">while</span> (NextEntry != &amp;<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o24">ImageList</a>) {
00555 
00556         Image = CONTAINING_RECORD(NextEntry, <a class="code" href="../../d1/d1/struct__IMAGE__ENTRY__IN__SESSION.html">IMAGE_ENTRY_IN_SESSION</a>, Link);
00557 
00558         <span class="keywordflow">if</span> (Image-&gt;<a class="code" href="../../d1/d1/struct__IMAGE__ENTRY__IN__SESSION.html#o1">Address</a> == BaseAddress) {
00559             <a class="code" href="../../d4/d8/mi_8h.html#a408">UNLOCK_SESSION_SPACE_WS</a> (OldIrql);
00560             <span class="keywordflow">return</span> Image;
00561         }
00562 
00563         NextEntry = NextEntry-&gt;Flink;
00564     }
00565 
00566     <a class="code" href="../../d4/d8/mi_8h.html#a408">UNLOCK_SESSION_SPACE_WS</a> (OldIrql);
00567     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00568 }
00569 
00570 
00571 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00572"></a><a class="code" href="../../d4/d7/sessload_8c.html#a14">00572</a> <a class="code" href="../../d4/d7/sessload_8c.html#a14">MiSessionUnloadAllImages</a> (
00573     VOID
00574     )
00575 
00576 <span class="comment">/*++</span>
00577 <span class="comment"></span>
00578 <span class="comment">Routine Description:</span>
00579 <span class="comment"></span>
00580 <span class="comment">    This routine dereferences each image that has been loaded in the</span>
00581 <span class="comment">    current session space.</span>
00582 <span class="comment"></span>
00583 <span class="comment">    As each image is dereferenced, checks are made:</span>
00584 <span class="comment"></span>
00585 <span class="comment">    If this session's reference count to the image reaches zero, the VA</span>
00586 <span class="comment">    range in this session is deleted.  If the reference count to the image</span>
00587 <span class="comment">    in the SESSIONWIDE list drops to zero, then the SESSIONWIDE's VA</span>
00588 <span class="comment">    reservation is removed and the address space is made available to any</span>
00589 <span class="comment">    new image.</span>
00590 <span class="comment"></span>
00591 <span class="comment">    If this is the last systemwide reference to the driver then the driver</span>
00592 <span class="comment">    is deleted from memory.</span>
00593 <span class="comment"></span>
00594 <span class="comment">Arguments:</span>
00595 <span class="comment"></span>
00596 <span class="comment">    None.</span>
00597 <span class="comment"></span>
00598 <span class="comment">Return Value:</span>
00599 <span class="comment"></span>
00600 <span class="comment">    None.</span>
00601 <span class="comment"></span>
00602 <span class="comment">Environment:</span>
00603 <span class="comment"></span>
00604 <span class="comment">    Kernel mode.  This is called in one of two contexts:</span>
00605 <span class="comment">        1. the last thread in the last process of the current session space.</span>
00606 <span class="comment">        2. or by any thread in the SMSS process.</span>
00607 <span class="comment"></span>
00608 <span class="comment">--*/</span>
00609 
00610 {
00611     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00612     PLIST_ENTRY NextEntry;
00613     <a class="code" href="../../d1/d1/struct__IMAGE__ENTRY__IN__SESSION.html">PIMAGE_ENTRY_IN_SESSION</a> Module;
00614     PLDR_DATA_TABLE_ENTRY ImageHandle;
00615 
00616     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o0">ReferenceCount</a> == 1);
00617 
00618     <span class="comment">//</span>
00619     <span class="comment">// The session's working set lock does not need to be acquired here since</span>
00620     <span class="comment">// no thread can be faulting on these addresses.</span>
00621     <span class="comment">//</span>
00622 
00623     NextEntry = <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o24">ImageList</a>.Flink;
00624 
00625     <span class="keywordflow">while</span> (NextEntry != &amp;<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o24">ImageList</a>) {
00626 
00627         Module = CONTAINING_RECORD(NextEntry, <a class="code" href="../../d1/d1/struct__IMAGE__ENTRY__IN__SESSION.html">IMAGE_ENTRY_IN_SESSION</a>, Link);
00628 
00629         <span class="comment">//</span>
00630         <span class="comment">// Lookup the image entry in the system PsLoadedModuleList,</span>
00631         <span class="comment">// unload the image and delete it.</span>
00632         <span class="comment">//</span>
00633 
00634         ImageHandle = <a class="code" href="../../d4/d7/sessload_8c.html#a10">MiLookupPsLoadedModule</a> (Module-&gt;<a class="code" href="../../d1/d1/struct__IMAGE__ENTRY__IN__SESSION.html#o1">Address</a>);
00635 
00636         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ImageHandle);
00637 
00638         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d8/sysload_8c.html#a59">MmUnloadSystemImage</a> (ImageHandle);
00639 
00640         <span class="comment">//</span>
00641         <span class="comment">// Restart the search at the beginning since the entry has been deleted.</span>
00642         <span class="comment">//</span>
00643 
00644         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o0">ReferenceCount</a> == 1);
00645 
00646         NextEntry = <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o24">ImageList</a>.Flink;
00647     }
00648 }
00649 
00650 
00651 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00652"></a><a class="code" href="../../d4/d7/sessload_8c.html#a15">00652</a> <a class="code" href="../../d4/d7/sessload_8c.html#a15">MiSessionWideInitializeAddresses</a> (
00653     VOID
00654     )
00655 
00656 <span class="comment">/*++</span>
00657 <span class="comment"></span>
00658 <span class="comment">Routine Description:</span>
00659 <span class="comment"></span>
00660 <span class="comment">    This routine is called at system initialization to set up the group</span>
00661 <span class="comment">    address list.</span>
00662 <span class="comment"></span>
00663 <span class="comment">Arguments:</span>
00664 <span class="comment"></span>
00665 <span class="comment">    None.</span>
00666 <span class="comment"></span>
00667 <span class="comment">Return Value:</span>
00668 <span class="comment"></span>
00669 <span class="comment">    None.</span>
00670 <span class="comment"></span>
00671 <span class="comment">Environment:</span>
00672 <span class="comment"></span>
00673 <span class="comment">    Kernel mode.</span>
00674 <span class="comment"></span>
00675 <span class="comment">--*/</span>
00676 
00677 {
00678     InitializeListHead (&amp;<a class="code" href="../../d4/d7/sessload_8c.html#a2">MmSessionWideAddressList</a>);
00679 }
00680 
00681 
00682 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00683"></a><a class="code" href="../../d4/d7/sessload_8c.html#a8">00683</a> <a class="code" href="../../d4/d7/sessload_8c.html#a8">MiSessionWideInsertImageAddress</a> (
00684     IN PVOID BaseAddress,
00685     IN ULONG_PTR NumberOfBytes,
00686     IN ULONG WritablePages,
00687     IN PUNICODE_STRING ImageName,
00688     IN BOOLEAN AtPreferredAddress
00689     )
00690 
00691 <span class="comment">/*++</span>
00692 <span class="comment"></span>
00693 <span class="comment">Routine Description:</span>
00694 <span class="comment"></span>
00695 <span class="comment">    Allocate and add a SessionWide Entry reference to the global address</span>
00696 <span class="comment">    allocation list for the current process' session space.</span>
00697 <span class="comment"></span>
00698 <span class="comment">Arguments:</span>
00699 <span class="comment"></span>
00700 <span class="comment">    BaseAddress - Supplies the base address to allocate an entry for.</span>
00701 <span class="comment"></span>
00702 <span class="comment">    NumberOfBytes - Supplies the number of bytes the entry spans.</span>
00703 <span class="comment"></span>
00704 <span class="comment">    WritablePages - Supplies the number of pages to charge commit for.</span>
00705 <span class="comment"></span>
00706 <span class="comment">    ImageName - Supplies the name of the image in the PsLoadedModuleList</span>
00707 <span class="comment">                that is represented by the virtual region.</span>
00708 <span class="comment"></span>
00709 <span class="comment">    AtPreferredAddress - Supplies TRUE if the image is based at its preferred</span>
00710 <span class="comment">                         address.</span>
00711 <span class="comment"></span>
00712 <span class="comment">Return Value:</span>
00713 <span class="comment"></span>
00714 <span class="comment">    Returns STATUS_SUCCESS on success, STATUS_NO_MEMORY on failure.</span>
00715 <span class="comment"></span>
00716 <span class="comment">Environment:</span>
00717 <span class="comment"></span>
00718 <span class="comment">    Kernel mode, APC_LEVEL and below, MmSystemLoadLock held.</span>
00719 <span class="comment"></span>
00720 <span class="comment">--*/</span>
00721 
00722 {
00723     PVOID LastAddress;
00724     PLIST_ENTRY NextEntry;
00725     <a class="code" href="../../d4/d7/sessload_8c.html#a1">PSESSIONWIDE_DRIVER_ADDRESS</a> Vaddr;
00726     <a class="code" href="../../d4/d7/sessload_8c.html#a1">PSESSIONWIDE_DRIVER_ADDRESS</a> New;
00727     PWCHAR <a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a>;
00728 
00729     <a class="code" href="../../d4/d8/mi_8h.html#a135">SYSLOAD_LOCK_OWNED_BY_ME</a> ();
00730 
00731     New = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
00732                                  <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d2/struct__SESSIONWIDE__DRIVER__ADDRESS.html">SESSIONWIDE_DRIVER_ADDRESS</a>),
00733                                  'vHmM');
00734 
00735     <span class="keywordflow">if</span> (New == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00736         <a class="code" href="../../d4/d8/mi_8h.html#a396">MM_BUMP_SESSION_FAILURES</a> (<a class="code" href="../../d4/d8/mi_8h.html#a392">MM_SESSION_FAILURE_NO_NONPAGED_POOL</a>);
00737         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00738     }
00739 
00740     RtlZeroMemory (New, <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d7/sessload_8c.html#a0">SESSIONWIDE_DRIVER_ADDRESS</a>));
00741 
00742     New-&gt;<a class="code" href="../../d3/d2/struct__SESSIONWIDE__DRIVER__ADDRESS.html#o1">ReferenceCount</a> = 1;
00743     New-&gt;<a class="code" href="../../d3/d2/struct__SESSIONWIDE__DRIVER__ADDRESS.html#o2">Address</a> = BaseAddress;
00744     New-&gt;<a class="code" href="../../d3/d2/struct__SESSIONWIDE__DRIVER__ADDRESS.html#o3">Size</a> = NumberOfBytes;
00745     <span class="keywordflow">if</span> (AtPreferredAddress == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00746         New-&gt;<a class="code" href="../../d3/d2/struct__SESSIONWIDE__DRIVER__ADDRESS.html#o4">WritablePages</a> = WritablePages;
00747     }
00748     <span class="keywordflow">else</span> {
00749         New-&gt;<a class="code" href="../../d3/d2/struct__SESSIONWIDE__DRIVER__ADDRESS.html#o4">WritablePages</a> = (<a class="code" href="../../d4/d8/mi_8h.html#a90">MI_ROUND_TO_SIZE</a> (NumberOfBytes, <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>)) &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
00750     }
00751 
00752     <span class="keywordflow">if</span> (ImageName) {
00753 
00754         <a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a> = (PWCHAR) <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
00755                                       ImageName-&gt;Length + <span class="keyword">sizeof</span>(UNICODE_NULL),
00756                                       'nHmM');
00757 
00758         <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00759             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (New);
00760             <a class="code" href="../../d4/d8/mi_8h.html#a396">MM_BUMP_SESSION_FAILURES</a> (<a class="code" href="../../d4/d8/mi_8h.html#a391">MM_SESSION_FAILURE_NO_PAGED_POOL</a>);
00761             <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00762         }
00763 
00764         RtlMoveMemory (<a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a>, ImageName-&gt;Buffer, ImageName-&gt;Length);
00765         <a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a> [ImageName-&gt;Length / <span class="keyword">sizeof</span>(WCHAR)] = UNICODE_NULL;
00766 
00767         New-&gt;<a class="code" href="../../d3/d2/struct__SESSIONWIDE__DRIVER__ADDRESS.html#o5">FullDllName</a>.Buffer = <a class="code" href="../../d9/d2/rtreplac_8c.html#a3">NewName</a>;
00768         New-&gt;<a class="code" href="../../d3/d2/struct__SESSIONWIDE__DRIVER__ADDRESS.html#o5">FullDllName</a>.Length = ImageName-&gt;Length;
00769         New-&gt;<a class="code" href="../../d3/d2/struct__SESSIONWIDE__DRIVER__ADDRESS.html#o5">FullDllName</a>.MaximumLength = ImageName-&gt;Length;
00770     }
00771     <span class="keywordflow">else</span> {
00772         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a> (&amp;New-&gt;<a class="code" href="../../d3/d2/struct__SESSIONWIDE__DRIVER__ADDRESS.html#o5">FullDllName</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00773     }
00774 
00775     <span class="comment">//</span>
00776     <span class="comment">// Insert the entry in the memory-ordered list.</span>
00777     <span class="comment">//</span>
00778 
00779     LastAddress = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00780     NextEntry = <a class="code" href="../../d4/d7/sessload_8c.html#a2">MmSessionWideAddressList</a>.Flink;
00781 
00782     <span class="keywordflow">while</span> (NextEntry != &amp;<a class="code" href="../../d4/d7/sessload_8c.html#a2">MmSessionWideAddressList</a>) {
00783 
00784         Vaddr = CONTAINING_RECORD (NextEntry,
00785                                    <a class="code" href="../../d4/d7/sessload_8c.html#a0">SESSIONWIDE_DRIVER_ADDRESS</a>,
00786                                    Link);
00787 
00788         <span class="keywordflow">if</span> (LastAddress &lt; Vaddr-&gt;<a class="code" href="../../d3/d2/struct__SESSIONWIDE__DRIVER__ADDRESS.html#o2">Address</a> &amp;&amp; Vaddr-&gt;<a class="code" href="../../d3/d2/struct__SESSIONWIDE__DRIVER__ADDRESS.html#o2">Address</a> &gt; New-&gt;<a class="code" href="../../d3/d2/struct__SESSIONWIDE__DRIVER__ADDRESS.html#o2">Address</a>) {
00789             <span class="keywordflow">break</span>;
00790         }
00791 
00792         LastAddress = Vaddr-&gt;<a class="code" href="../../d3/d2/struct__SESSIONWIDE__DRIVER__ADDRESS.html#o2">Address</a>;
00793         NextEntry = NextEntry-&gt;Flink;
00794     }
00795 
00796     InsertTailList (NextEntry, &amp;New-&gt;<a class="code" href="../../d3/d2/struct__SESSIONWIDE__DRIVER__ADDRESS.html#o0">Link</a>);
00797 
00798     <span class="keywordflow">return</span> STATUS_SUCCESS;
00799 }
00800 
00801 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00802"></a><a class="code" href="../../d4/d7/sessload_8c.html#a9">00802</a> <a class="code" href="../../d4/d7/sessload_8c.html#a9">MiSessionWideDereferenceImage</a>(
00803     IN PVOID BaseAddress
00804     )
00805 
00806 <span class="comment">/*++</span>
00807 <span class="comment"></span>
00808 <span class="comment">Routine Description:</span>
00809 <span class="comment"></span>
00810 <span class="comment">    Dereference the SessionWide entry for the specified address, potentially</span>
00811 <span class="comment">    resulting in a deletion of the image.</span>
00812 <span class="comment"></span>
00813 <span class="comment">Arguments:</span>
00814 <span class="comment"></span>
00815 <span class="comment">    BaseAddress - Supplies the address for the driver to dereference.</span>
00816 <span class="comment"></span>
00817 <span class="comment">Return Value:</span>
00818 <span class="comment"></span>
00819 <span class="comment">    Returns STATUS_SUCCESS on success, STATUS_NOT_FOUND on failure.</span>
00820 <span class="comment"></span>
00821 <span class="comment">Environment:</span>
00822 <span class="comment"></span>
00823 <span class="comment">    Kernel mode, APC_LEVEL and below, MmSystemLoadLock held.</span>
00824 <span class="comment"></span>
00825 <span class="comment">--*/</span>
00826 
00827 {
00828     PLIST_ENTRY NextEntry;
00829     <a class="code" href="../../d4/d7/sessload_8c.html#a1">PSESSIONWIDE_DRIVER_ADDRESS</a> SessionWideImageEntry;
00830 
00831     <a class="code" href="../../d4/d8/mi_8h.html#a135">SYSLOAD_LOCK_OWNED_BY_ME</a> ();
00832 
00833     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (BaseAddress);
00834 
00835     NextEntry = <a class="code" href="../../d4/d7/sessload_8c.html#a2">MmSessionWideAddressList</a>.Flink;
00836 
00837     <span class="keywordflow">while</span> (NextEntry != &amp;<a class="code" href="../../d4/d7/sessload_8c.html#a2">MmSessionWideAddressList</a>) {
00838 
00839         SessionWideImageEntry = CONTAINING_RECORD (NextEntry,
00840                                                    <a class="code" href="../../d3/d2/struct__SESSIONWIDE__DRIVER__ADDRESS.html">SESSIONWIDE_DRIVER_ADDRESS</a>,
00841                                                    Link);
00842 
00843         <span class="keywordflow">if</span> (BaseAddress == SessionWideImageEntry-&gt;<a class="code" href="../../d3/d2/struct__SESSIONWIDE__DRIVER__ADDRESS.html#o2">Address</a>) {
00844     
00845             SessionWideImageEntry-&gt;<a class="code" href="../../d3/d2/struct__SESSIONWIDE__DRIVER__ADDRESS.html#o1">ReferenceCount</a> -= 1;
00846     
00847             <span class="comment">//</span>
00848             <span class="comment">// If reference count is 0, delete the node.</span>
00849             <span class="comment">//</span>
00850 
00851             <span class="keywordflow">if</span> (SessionWideImageEntry-&gt;<a class="code" href="../../d3/d2/struct__SESSIONWIDE__DRIVER__ADDRESS.html#o1">ReferenceCount</a> == 0) {
00852                 RemoveEntryList (NextEntry);
00853                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (SessionWideImageEntry);
00854             }
00855             <span class="keywordflow">return</span> STATUS_SUCCESS;
00856         }
00857 
00858         NextEntry = NextEntry-&gt;Flink;
00859     }
00860 
00861     <span class="keywordflow">return</span> STATUS_NOT_FOUND;
00862 }
00863 
00864 
00865 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00866"></a><a class="code" href="../../d4/d7/sessload_8c.html#a16">00866</a> <a class="code" href="../../d4/d7/sessload_8c.html#a16">MiSessionWideGetImageSize</a>(
00867     IN PVOID BaseAddress,
00868     OUT PSIZE_T NumberOfBytes OPTIONAL,
00869     OUT PSIZE_T CommitPages OPTIONAL
00870     )
00871 
00872 <span class="comment">/*++</span>
00873 <span class="comment"></span>
00874 <span class="comment">Routine Description:</span>
00875 <span class="comment"></span>
00876 <span class="comment">    Lookup the size allocated and committed for the image at the base address.</span>
00877 <span class="comment">    This ensures that we free every page that may have been allocated due</span>
00878 <span class="comment">    to rounding up.</span>
00879 <span class="comment"></span>
00880 <span class="comment">Arguments:</span>
00881 <span class="comment"></span>
00882 <span class="comment">    BaseAddress - Supplies the preferred address that the driver has</span>
00883 <span class="comment">                  been linked (rebased) at.  If this address is available,</span>
00884 <span class="comment">                  the driver will require no relocation.</span>
00885 <span class="comment"></span>
00886 <span class="comment">    NumberOfBytes - Supplies a pointer to store the image size into.</span>
00887 <span class="comment"></span>
00888 <span class="comment">    CommitPages - Supplies a pointer to store the number of committed pages</span>
00889 <span class="comment">                  that were charged for this image.</span>
00890 <span class="comment"></span>
00891 <span class="comment">Return Value:</span>
00892 <span class="comment"></span>
00893 <span class="comment">    Returns STATUS_SUCCESS on success, STATUS_NOT_FOUND on failure.</span>
00894 <span class="comment"></span>
00895 <span class="comment">Environment:</span>
00896 <span class="comment"></span>
00897 <span class="comment">    Kernel mode, APC_LEVEL and below, MmSystemLoadLock held.</span>
00898 <span class="comment"></span>
00899 <span class="comment">--*/</span>
00900 
00901 {
00902     PLIST_ENTRY NextEntry;
00903     <a class="code" href="../../d4/d7/sessload_8c.html#a1">PSESSIONWIDE_DRIVER_ADDRESS</a> SessionWideEntry;
00904 
00905     <a class="code" href="../../d4/d8/mi_8h.html#a135">SYSLOAD_LOCK_OWNED_BY_ME</a> ();
00906 
00907     NextEntry = <a class="code" href="../../d4/d7/sessload_8c.html#a2">MmSessionWideAddressList</a>.Flink;
00908 
00909     <span class="keywordflow">while</span> (NextEntry != &amp;<a class="code" href="../../d4/d7/sessload_8c.html#a2">MmSessionWideAddressList</a>) {
00910 
00911         SessionWideEntry = CONTAINING_RECORD (NextEntry,
00912                                               <a class="code" href="../../d3/d2/struct__SESSIONWIDE__DRIVER__ADDRESS.html">SESSIONWIDE_DRIVER_ADDRESS</a>,
00913                                               Link);
00914 
00915         <span class="keywordflow">if</span> (BaseAddress == SessionWideEntry-&gt;<a class="code" href="../../d3/d2/struct__SESSIONWIDE__DRIVER__ADDRESS.html#o2">Address</a>) {
00916 
00917             <span class="keywordflow">if</span> (ARGUMENT_PRESENT (NumberOfBytes)) {
00918                 *NumberOfBytes = SessionWideEntry-&gt;<a class="code" href="../../d3/d2/struct__SESSIONWIDE__DRIVER__ADDRESS.html#o3">Size</a>;
00919             }
00920 
00921             <span class="keywordflow">if</span> (ARGUMENT_PRESENT (CommitPages)) {
00922                 *CommitPages = SessionWideEntry-&gt;<a class="code" href="../../d3/d2/struct__SESSIONWIDE__DRIVER__ADDRESS.html#o4">WritablePages</a>;
00923             }
00924 
00925             <span class="keywordflow">return</span> STATUS_SUCCESS;
00926         }
00927 
00928         NextEntry = NextEntry-&gt;Flink;
00929     }
00930 
00931     <span class="keywordflow">return</span> STATUS_NOT_FOUND;
00932 }
00933 
00934 
00935 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00936"></a><a class="code" href="../../d4/d7/sessload_8c.html#a17">00936</a> <a class="code" href="../../d4/d7/sessload_8c.html#a17">MiSessionWideReserveImageAddress</a> (
00937     IN PUNICODE_STRING ImageName,
00938     IN PSECTION Section,
00939     IN ULONG_PTR Alignment,
00940     OUT PVOID *AssignedAddress,
00941     OUT PBOOLEAN AlreadyLoaded
00942     )
00943 
00944 <span class="comment">/*++</span>
00945 <span class="comment"></span>
00946 <span class="comment">Routine Description:</span>
00947 <span class="comment"></span>
00948 <span class="comment">    This routine allocates a range of virtual address space within</span>
00949 <span class="comment">    session space.  This address range is unique system-wide and in this</span>
00950 <span class="comment">    manner, code and pristine data of session drivers can be shared across</span>
00951 <span class="comment">    multiple sessions.</span>
00952 <span class="comment"></span>
00953 <span class="comment">    This routine does not actually commit pages, but reserves the virtual</span>
00954 <span class="comment">    address region for the named image.  An entry is created here and attached</span>
00955 <span class="comment">    to the current session space to track the loaded image.  Thus if all</span>
00956 <span class="comment">    the references to a given range go away, the range can then be reused.</span>
00957 <span class="comment"></span>
00958 <span class="comment">Arguments:</span>
00959 <span class="comment"></span>
00960 <span class="comment">    ImageName - Supplies the name of the driver that will be loaded into</span>
00961 <span class="comment">                the allocated space.</span>
00962 <span class="comment"></span>
00963 <span class="comment">    Section - Supplies the section (and thus, the preferred address that the</span>
00964 <span class="comment">              driver has been linked (rebased) at.  If this address is</span>
00965 <span class="comment">              available, the driver will require no relocation.  The section</span>
00966 <span class="comment">              is also used to derive the number of bytes to reserve.</span>
00967 <span class="comment"></span>
00968 <span class="comment">    Alignment - Supplies the virtual address alignment for the address.</span>
00969 <span class="comment"></span>
00970 <span class="comment">    AssignedAddress - Supplies a pointer to a variable that receives the</span>
00971 <span class="comment">                      allocated address if the routine succeeds.</span>
00972 <span class="comment"></span>
00973 <span class="comment">    AlreadyLoaded - Supplies a pointer to a variable that receives TRUE if the</span>
00974 <span class="comment">                    specified image name has already been loaded.</span>
00975 <span class="comment"></span>
00976 <span class="comment">Return Value:</span>
00977 <span class="comment"></span>
00978 <span class="comment">    Returns STATUS_SUCCESS on success, various NTSTATUS codes on failure.</span>
00979 <span class="comment"></span>
00980 <span class="comment">Environment:</span>
00981 <span class="comment"></span>
00982 <span class="comment">    Kernel mode, APC_LEVEL and below, MmSystemLoadLock held.</span>
00983 <span class="comment"></span>
00984 <span class="comment">--*/</span>
00985 
00986 {
00987     PLIST_ENTRY NextEntry;
00988     <a class="code" href="../../d4/d7/sessload_8c.html#a1">PSESSIONWIDE_DRIVER_ADDRESS</a> Vaddr;
00989     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00990     PWCHAR pName;
00991     PVOID NewAddress;
00992     ULONG_PTR AvailableAddress;
00993     ULONG_PTR SessionSpaceEnd;
00994     PVOID PreferredAddress;
00995     ULONG_PTR NumberOfBytes;
00996     ULONG WritablePages;
00997     BOOLEAN AtPreferredAddress;
00998 
00999     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01000 
01001     <a class="code" href="../../d4/d8/mi_8h.html#a135">SYSLOAD_LOCK_OWNED_BY_ME</a> ();
01002 
01003     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;Vm.u.Flags.ProcessInSession == 1);
01004     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d2/d1/mm_8h.html#a302">MmIsAddressValid</a> (<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01005 
01006     pName = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01007     *AlreadyLoaded = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01008     PreferredAddress = Section-&gt;Segment-&gt;BasedAddress;
01009     NumberOfBytes = Section-&gt;Segment-&gt;TotalNumberOfPtes &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
01010 
01011     AvailableAddress = <a class="code" href="../../d4/d8/mi_8h.html#a347">MI_SESSION_IMAGE_START</a>;
01012     NumberOfBytes = <a class="code" href="../../d4/d8/mi_8h.html#a90">MI_ROUND_TO_SIZE</a> (NumberOfBytes, Alignment);
01013     SessionSpaceEnd = AvailableAddress + <a class="code" href="../../d4/d8/mi_8h.html#a335">MI_SESSION_IMAGE_SIZE</a>;
01014 
01015     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d8/mi_8h.html#a812">MiGetWritablePagesInSection</a>(Section, &amp;WritablePages);
01016 
01017     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01018         WritablePages = Section-&gt;Segment-&gt;TotalNumberOfPtes;
01019     }
01020 
01021     <span class="comment">//</span>
01022     <span class="comment">// If the requested address is not properly aligned or not in the session</span>
01023     <span class="comment">// space region, pick an address for it.  This image will not be shared.</span>
01024     <span class="comment">//</span>
01025 
01026     <span class="keywordflow">if</span> ((ULONG_PTR)PreferredAddress &amp; (Alignment - 1)) {
01027 
01028 <span class="preprocessor">#if DBG</span>
01029 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"MiSessionWideReserveImageAddress: Bad alignment 0x%x for PreferredAddress 0x%x\n"</span>,
01030             Alignment,
01031             PreferredAddress);
01032 <span class="preprocessor">#endif</span>
01033 <span class="preprocessor"></span>
01034         PreferredAddress = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01035     }
01036     <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((ULONG_PTR)PreferredAddress &lt; AvailableAddress ||
01037              ((ULONG_PTR)PreferredAddress + NumberOfBytes &gt;= SessionSpaceEnd)) {
01038 
01039 <span class="preprocessor">#if DBG</span>
01040 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a83">MM_DBG_SESSIONS</a>) {
01041             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"MiSessionWideReserveImageAddress: PreferredAddress 0x%x not in session space\n"</span>, PreferredAddress);
01042         }
01043 <span class="preprocessor">#endif</span>
01044 <span class="preprocessor"></span>
01045         PreferredAddress = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01046     }
01047 
01048     <span class="comment">//</span>
01049     <span class="comment">// Check the system wide session space image list to see if the</span>
01050     <span class="comment">// image name has already been given a slot.</span>
01051     <span class="comment">//</span>
01052 
01053     NextEntry = <a class="code" href="../../d4/d7/sessload_8c.html#a2">MmSessionWideAddressList</a>.Flink;
01054 
01055     <span class="keywordflow">while</span> (NextEntry != &amp;<a class="code" href="../../d4/d7/sessload_8c.html#a2">MmSessionWideAddressList</a>) {
01056 
01057         Vaddr = CONTAINING_RECORD (NextEntry,
01058                                    <a class="code" href="../../d3/d2/struct__SESSIONWIDE__DRIVER__ADDRESS.html">SESSIONWIDE_DRIVER_ADDRESS</a>,
01059                                    Link);
01060 
01061         <span class="keywordflow">if</span> (Vaddr-&gt;<a class="code" href="../../d3/d2/struct__SESSIONWIDE__DRIVER__ADDRESS.html#o5">FullDllName</a>.Buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01062 
01063             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/nls_8c.html#a42">RtlEqualUnicodeString</a>(ImageName, &amp;Vaddr-&gt;<a class="code" href="../../d3/d2/struct__SESSIONWIDE__DRIVER__ADDRESS.html#o5">FullDllName</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
01064 
01065                 <span class="comment">//</span>
01066                 <span class="comment">// The size requested should be the same.</span>
01067                 <span class="comment">//</span>
01068 
01069                 <span class="keywordflow">if</span> (Vaddr-&gt;<a class="code" href="../../d3/d2/struct__SESSIONWIDE__DRIVER__ADDRESS.html#o3">Size</a> &lt; NumberOfBytes) {
01070 <span class="preprocessor">#if DBG</span>
01071 <span class="preprocessor"></span>                    <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"MiSessionWideReserveImageAddress: Size %d Larger than Entry %d, DLL %wZ\n"</span>,
01072                         NumberOfBytes,
01073                         Vaddr-&gt;<a class="code" href="../../d3/d2/struct__SESSIONWIDE__DRIVER__ADDRESS.html#o3">Size</a>,
01074                         ImageName);
01075 <span class="preprocessor">#endif</span>
01076 <span class="preprocessor"></span>
01077                     <span class="keywordflow">return</span> STATUS_CONFLICTING_ADDRESSES;
01078                 }
01079         
01080                 <span class="comment">//</span>
01081                 <span class="comment">// This image has already been loaded systemwide.  If it's</span>
01082                 <span class="comment">// already been loaded in this session space as well, just</span>
01083                 <span class="comment">// bump the reference count using the already allocated</span>
01084                 <span class="comment">// address.  Otherwise, insert it into this session space.</span>
01085                 <span class="comment">//</span>
01086 
01087                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d7/sessload_8c.html#a6">MiSessionInsertImage</a> (Vaddr-&gt;<a class="code" href="../../d3/d2/struct__SESSIONWIDE__DRIVER__ADDRESS.html#o2">Address</a>);
01088 
01089                 <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_ALREADY_COMMITTED) {
01090 
01091                     *AlreadyLoaded = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01092                     *AssignedAddress = Vaddr-&gt;<a class="code" href="../../d3/d2/struct__SESSIONWIDE__DRIVER__ADDRESS.html#o2">Address</a>;
01093 
01094                     <span class="keywordflow">return</span> STATUS_SUCCESS;
01095                 }
01096 
01097                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01098                     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01099                 }
01100 
01101                 <span class="comment">//</span>
01102                 <span class="comment">// Bump the reference count as this is a new entry.</span>
01103                 <span class="comment">//</span>
01104 
01105                 Vaddr-&gt;<a class="code" href="../../d3/d2/struct__SESSIONWIDE__DRIVER__ADDRESS.html#o1">ReferenceCount</a> += 1;
01106 
01107                 *AssignedAddress = Vaddr-&gt;<a class="code" href="../../d3/d2/struct__SESSIONWIDE__DRIVER__ADDRESS.html#o2">Address</a>;
01108 
01109                 <span class="keywordflow">return</span> STATUS_SUCCESS;
01110             }
01111         }
01112 
01113         <span class="comment">//</span>
01114         <span class="comment">// Note this list must be sorted by ascending address.</span>
01115         <span class="comment">// See if the PreferredAddress and size collide with any entries.</span>
01116         <span class="comment">//</span>
01117 
01118         <span class="keywordflow">if</span> (PreferredAddress) {
01119 
01120             <span class="keywordflow">if</span> ((PreferredAddress &gt;= Vaddr-&gt;<a class="code" href="../../d3/d2/struct__SESSIONWIDE__DRIVER__ADDRESS.html#o2">Address</a>) &amp;&amp;
01121                  (PreferredAddress &lt; (PVOID)((ULONG_PTR)Vaddr-&gt;<a class="code" href="../../d3/d2/struct__SESSIONWIDE__DRIVER__ADDRESS.html#o2">Address</a> + Vaddr-&gt;<a class="code" href="../../d3/d2/struct__SESSIONWIDE__DRIVER__ADDRESS.html#o3">Size</a>))) {
01122                     PreferredAddress = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01123             }
01124             <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((PreferredAddress &lt; Vaddr-&gt;<a class="code" href="../../d3/d2/struct__SESSIONWIDE__DRIVER__ADDRESS.html#o2">Address</a>) &amp;&amp;
01125                     ((PVOID)((ULONG_PTR)PreferredAddress + NumberOfBytes) &gt; Vaddr-&gt;<a class="code" href="../../d3/d2/struct__SESSIONWIDE__DRIVER__ADDRESS.html#o2">Address</a>)) {
01126                     PreferredAddress = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01127             }
01128         }
01129 
01130         <span class="comment">//</span>
01131         <span class="comment">// Check for an available general allocation slot.</span>
01132         <span class="comment">//</span>
01133 
01134         <span class="keywordflow">if</span> (((PVOID)AvailableAddress &gt;= Vaddr-&gt;<a class="code" href="../../d3/d2/struct__SESSIONWIDE__DRIVER__ADDRESS.html#o2">Address</a>) &amp;&amp;
01135             (AvailableAddress &lt;= (ULONG_PTR)Vaddr-&gt;<a class="code" href="../../d3/d2/struct__SESSIONWIDE__DRIVER__ADDRESS.html#o2">Address</a> + Vaddr-&gt;<a class="code" href="../../d3/d2/struct__SESSIONWIDE__DRIVER__ADDRESS.html#o3">Size</a>)) {
01136 
01137             AvailableAddress = (ULONG_PTR)Vaddr-&gt;<a class="code" href="../../d3/d2/struct__SESSIONWIDE__DRIVER__ADDRESS.html#o2">Address</a> + Vaddr-&gt;<a class="code" href="../../d3/d2/struct__SESSIONWIDE__DRIVER__ADDRESS.html#o3">Size</a>;
01138 
01139             <span class="keywordflow">if</span> (AvailableAddress &amp; (Alignment - 1)) {
01140                 AvailableAddress = <a class="code" href="../../d4/d8/mi_8h.html#a90">MI_ROUND_TO_SIZE</a> (AvailableAddress, Alignment);
01141             }
01142         }
01143         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (AvailableAddress + NumberOfBytes &gt; (ULONG_PTR)Vaddr-&gt;<a class="code" href="../../d3/d2/struct__SESSIONWIDE__DRIVER__ADDRESS.html#o2">Address</a>) {
01144 
01145             AvailableAddress = (ULONG_PTR)Vaddr-&gt;<a class="code" href="../../d3/d2/struct__SESSIONWIDE__DRIVER__ADDRESS.html#o2">Address</a> + Vaddr-&gt;<a class="code" href="../../d3/d2/struct__SESSIONWIDE__DRIVER__ADDRESS.html#o3">Size</a>;
01146 
01147             <span class="keywordflow">if</span> (AvailableAddress &amp; (Alignment - 1)) {
01148                 AvailableAddress = <a class="code" href="../../d4/d8/mi_8h.html#a90">MI_ROUND_TO_SIZE</a> (AvailableAddress, Alignment);
01149             }
01150         }
01151 
01152         NextEntry = NextEntry-&gt;Flink;
01153     }
01154 
01155     <span class="keywordflow">if</span> (PreferredAddress == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; (AvailableAddress + NumberOfBytes &gt; (<a class="code" href="../../d4/d8/mi_8h.html#a347">MI_SESSION_IMAGE_START</a> + <a class="code" href="../../d4/d8/mi_8h.html#a335">MI_SESSION_IMAGE_SIZE</a>))) {
01156         <a class="code" href="../../d4/d8/mi_8h.html#a396">MM_BUMP_SESSION_FAILURES</a> (<a class="code" href="../../d4/d8/mi_8h.html#a393">MM_SESSION_FAILURE_NO_IMAGE_VA_SPACE</a>);
01157         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
01158     }
01159 
01160     <span class="comment">//</span>
01161     <span class="comment">// Try to put the module into its requested address so it can be shared.</span>
01162     <span class="comment">//</span>
01163 
01164     <span class="keywordflow">if</span> (PreferredAddress) {
01165 
01166 <span class="preprocessor">#if DBG</span>
01167 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a83">MM_DBG_SESSIONS</a>) {
01168             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"MiSessionWideReserveImageAddress: Code Sharing on %wZ, Address 0x%x\n"</span>,ImageName,PreferredAddress);
01169         }
01170 <span class="preprocessor">#endif</span>
01171 <span class="preprocessor"></span>
01172         NewAddress = PreferredAddress;
01173     }
01174     <span class="keywordflow">else</span> {
01175         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (AvailableAddress != 0);
01176         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((AvailableAddress &amp; (Alignment - 1)) == 0);
01177 
01178 <span class="preprocessor">#if DBG</span>
01179 <span class="preprocessor"></span>        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"MiSessionWideReserveImageAddress: NO Code Sharing on %wZ, Address 0x%x\n"</span>,ImageName,AvailableAddress);
01180 <span class="preprocessor">#endif</span>
01181 <span class="preprocessor"></span>
01182         NewAddress = (PVOID)AvailableAddress;
01183     }
01184 
01185     <span class="comment">//</span>
01186     <span class="comment">// Create a new node entry for the address range.</span>
01187     <span class="comment">//</span>
01188 
01189     <span class="keywordflow">if</span> (NewAddress == PreferredAddress) {
01190         AtPreferredAddress = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01191     }
01192     <span class="keywordflow">else</span> {
01193         AtPreferredAddress = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01194     }
01195 
01196     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d7/sessload_8c.html#a8">MiSessionWideInsertImageAddress</a> (NewAddress,
01197                                               NumberOfBytes,
01198                                               WritablePages,
01199                                               ImageName,
01200                                               AtPreferredAddress);
01201 
01202     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01203         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01204     }
01205 
01206     <span class="comment">//</span>
01207     <span class="comment">// Create an entry for this image in the current session space.</span>
01208     <span class="comment">//</span>
01209 
01210     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d7/sessload_8c.html#a6">MiSessionInsertImage</a> (NewAddress);
01211 
01212     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01213         <a class="code" href="../../d4/d7/sessload_8c.html#a9">MiSessionWideDereferenceImage</a> (NewAddress);
01214         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01215     }
01216 
01217     *AssignedAddress = NewAddress;
01218 
01219     <span class="keywordflow">return</span> STATUS_SUCCESS;
01220 }
01221 
01222 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01223"></a><a class="code" href="../../d4/d7/sessload_8c.html#a18">01223</a> <a class="code" href="../../d4/d7/sessload_8c.html#a18">MiRemoveImageSessionWide</a>(
01224     IN PVOID BaseAddress
01225     )
01226 
01227 <span class="comment">/*++</span>
01228 <span class="comment"></span>
01229 <span class="comment">Routine Description:</span>
01230 <span class="comment"></span>
01231 <span class="comment">    Delete the image space region from the current session space.</span>
01232 <span class="comment">    This dereferences the globally allocated SessionWide region.</span>
01233 <span class="comment">    </span>
01234 <span class="comment">    The SessionWide region will be deleted if the reference count goes to zero.</span>
01235 <span class="comment">    </span>
01236 <span class="comment">Arguments:</span>
01237 <span class="comment"></span>
01238 <span class="comment">    BaseAddress - Supplies the address the driver is loaded at.</span>
01239 <span class="comment"></span>
01240 <span class="comment">Return Value:</span>
01241 <span class="comment"></span>
01242 <span class="comment">    Returns STATUS_SUCCESS on success, STATUS_NOT_FOUND on failure.</span>
01243 <span class="comment"></span>
01244 <span class="comment">Environment:</span>
01245 <span class="comment"></span>
01246 <span class="comment">    Kernel mode, APC_LEVEL and below, MmSystemLoadLock held.</span>
01247 <span class="comment"></span>
01248 <span class="comment">--*/</span>
01249 
01250 {
01251     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01252 
01253     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01254 
01255     <a class="code" href="../../d4/d8/mi_8h.html#a135">SYSLOAD_LOCK_OWNED_BY_ME</a> ();
01256 
01257     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d8/d2/pagfault_8c.html#a26">MmIsAddressValid</a>(<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01258 
01259     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d7/sessload_8c.html#a9">MiSessionWideDereferenceImage</a> (BaseAddress);
01260 
01261     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
01262 
01263     <span class="comment">//</span>
01264     <span class="comment">// Remove the image reference from the current session space.</span>
01265     <span class="comment">//</span>
01266 
01267     <a class="code" href="../../d4/d7/sessload_8c.html#a12">MiSessionRemoveImage</a> (BaseAddress);
01268 
01269     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01270 }
01271 
01272 PLDR_DATA_TABLE_ENTRY
<a name="l01273"></a><a class="code" href="../../d4/d7/sessload_8c.html#a10">01273</a> <a class="code" href="../../d4/d7/sessload_8c.html#a10">MiLookupPsLoadedModule</a> (
01274     IN PVOID Address
01275     )
01276 
01277 <span class="comment">/*++</span>
01278 <span class="comment"></span>
01279 <span class="comment">Routine Description:</span>
01280 <span class="comment"></span>
01281 <span class="comment">    Lookup the loader data table entry for the image by its address.</span>
01282 <span class="comment"></span>
01283 <span class="comment">Arguments:</span>
01284 <span class="comment"></span>
01285 <span class="comment">    BaseAddress - Supplies the address that the driver is loaded at.</span>
01286 <span class="comment"></span>
01287 <span class="comment">Return Value:</span>
01288 <span class="comment"></span>
01289 <span class="comment">    Returns a non-NULL loader data table entry on success, NULL on failure.</span>
01290 <span class="comment"></span>
01291 <span class="comment">Environment:</span>
01292 <span class="comment"></span>
01293 <span class="comment">    Kernel mode, APC_LEVEL and below.</span>
01294 <span class="comment"></span>
01295 <span class="comment">--*/</span>
01296 
01297 {
01298     PLIST_ENTRY NextEntry;
01299     PLDR_DATA_TABLE_ENTRY DataTableEntry;
01300     PLDR_DATA_TABLE_ENTRY FoundDataTableEntry;
01301 
01302     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Address);
01303 
01304     FoundDataTableEntry = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01305 
01306     <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a> (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a432">MmSystemLoadLock</a>,
01307                            <a class="code" href="../../d4/d9/ke_8h.html#a407a216">WrVirtualMemory</a>,
01308                            <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
01309                            <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
01310                            (PLARGE_INTEGER)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01311 
01312     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
01313     <a class="code" href="../../d5/d8/ex_8h.html#a70">ExAcquireResourceExclusive</a> (&amp;<a class="code" href="../../d1/d9/ps_8h.html#a57">PsLoadedModuleResource</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01314 
01315     NextEntry = <a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>.Flink;
01316     <span class="keywordflow">while</span> (NextEntry != &amp;<a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>) {
01317         DataTableEntry = CONTAINING_RECORD(NextEntry,
01318                                            LDR_DATA_TABLE_ENTRY,
01319                                            InLoadOrderLinks);
01320 
01321         <span class="keywordflow">if</span> (DataTableEntry-&gt;DllBase == Address) {
01322 
01323             FoundDataTableEntry = DataTableEntry;
01324             <span class="keywordflow">break</span>;
01325         }
01326 
01327         NextEntry = NextEntry-&gt;Flink;
01328     }
01329 
01330     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a> (&amp;<a class="code" href="../../d1/d9/ps_8h.html#a57">PsLoadedModuleResource</a>);
01331     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
01332 
01333     <a class="code" href="../../d3/d5/mutntobj_8c.html#a4">KeReleaseMutant</a> (&amp;<a class="code" href="../../d4/d8/mi_8h.html#a432">MmSystemLoadLock</a>, 1, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01334 
01335     <span class="keywordflow">return</span> FoundDataTableEntry;
01336 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:48 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
