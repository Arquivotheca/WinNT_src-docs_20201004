<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: devnode.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>devnode.c</h1><a href="../../d4/d7/devnode_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1996 Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    devnode.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This file contains routines to maintain our private device node list.</span>
00012 <span class="comment"></span>
00013 <span class="comment">Author:</span>
00014 <span class="comment"></span>
00015 <span class="comment">    Forrest Foltz (forrestf) 27-Mar-1996</span>
00016 <span class="comment"></span>
00017 <span class="comment">Revision History:</span>
00018 <span class="comment"></span>
00019 <span class="comment">    Modified for nt kernel.</span>
00020 <span class="comment"></span>
00021 <span class="comment">--*/</span>
00022 
00023 <span class="preprocessor">#include "<a class="code" href="../../d0/d6/iop_8h.html">iop.h</a>"</span>
00024 
00025 <span class="comment">//</span>
00026 <span class="comment">// Internal definitions</span>
00027 <span class="comment">//</span>
00028 
<a name="l00029"></a><a class="code" href="../../d6/d3/struct__ENUM__CONTEXT.html">00029</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d6/d3/struct__ENUM__CONTEXT.html">_ENUM_CONTEXT</a>{
<a name="l00030"></a><a class="code" href="../../d6/d3/struct__ENUM__CONTEXT.html#o0">00030</a>     <a class="code" href="../../d9/d0/pnpiop_8h.html#a118">PENUM_CALLBACK</a> <a class="code" href="../../d6/d3/struct__ENUM__CONTEXT.html#o0">CallersCallback</a>;
<a name="l00031"></a><a class="code" href="../../d6/d3/struct__ENUM__CONTEXT.html#o1">00031</a>     PVOID <a class="code" href="../../d6/d3/struct__ENUM__CONTEXT.html#o1">CallersContext</a>;
00032 } <a class="code" href="../../d6/d3/struct__ENUM__CONTEXT.html">ENUM_CONTEXT</a>, *<a class="code" href="../../d6/d3/struct__ENUM__CONTEXT.html">PENUM_CONTEXT</a>;
00033 
00034 <span class="comment">//</span>
00035 <span class="comment">// Internal References</span>
00036 <span class="comment">//</span>
00037 
00038 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00039 <a class="code" href="../../d4/d7/devnode_8c.html#a2">IopForAllDeviceNodesCallback</a>(
00040     IN <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode,
00041     IN PVOID Context
00042     );
00043 
00044 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00045 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopAllocateDeviceNode)</span>
00046 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopForAllDeviceNodes)</span>
00047 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopForAllChildDeviceNodes)</span>
00048 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopForAllDeviceNodesCallback)</span>
00049 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopDestroyDeviceNode)</span>
00050 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopInsertTreeDeviceNode)</span>
00051 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, IopRemoveTreeDeviceNode)</span>
00052 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00053 <span class="preprocessor"></span>
00054 
00055 <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>
<a name="l00056"></a><a class="code" href="../../d9/d0/pnpiop_8h.html#a252">00056</a> <a class="code" href="../../d9/d0/pnpiop_8h.html#a252">IopAllocateDeviceNode</a>(
00057     IN <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> PhysicalDeviceObject
00058     )
00059 
00060 <span class="comment">/*++</span>
00061 <span class="comment"></span>
00062 <span class="comment">Routine Description:</span>
00063 <span class="comment"></span>
00064 <span class="comment">    This function allocates a device node from nonpaged pool and initializes</span>
00065 <span class="comment">    the fields which do not require to hold lock to do so.  Since adding</span>
00066 <span class="comment">    the device node to pnp mgr's device node tree requires acquiring lock,</span>
00067 <span class="comment">    this routine does not add the device node to device node tree.</span>
00068 <span class="comment"></span>
00069 <span class="comment">Arguments:</span>
00070 <span class="comment"></span>
00071 <span class="comment">    PhysicalDeviceObject - Supplies a pointer to its corresponding physical device</span>
00072 <span class="comment">        object.</span>
00073 <span class="comment"></span>
00074 <span class="comment">Return Value:</span>
00075 <span class="comment"></span>
00076 <span class="comment">    a pointer to the newly created device node. Null is returned if failed.</span>
00077 <span class="comment"></span>
00078 <span class="comment">--*/</span>
00079 {
00080     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> deviceNode;
00081 
00082     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00083 
00084     deviceNode = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(
00085                     <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
00086                     <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">DEVICE_NODE</a>),
00087                     <a class="code" href="../../d9/d0/pnpiop_8h.html#a0">IOP_DNOD_TAG</a>
00088                     );
00089 
00090     <span class="keywordflow">if</span> (deviceNode == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ){
00091         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00092     }
00093 
00094     InterlockedIncrement (&amp;<a class="code" href="../../d1/d0/pnpdata_8c.html#a12">IopNumberDeviceNodes</a>);
00095 
00096     RtlZeroMemory(deviceNode, <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d0/pnpiop_8h.html#a117">DEVICE_NODE</a>));
00097     deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o17">InterfaceType</a> = InterfaceTypeUndefined;
00098     deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o18">BusNumber</a> = (ULONG)-1;
00099     deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o19">ChildInterfaceType</a> = InterfaceTypeUndefined;
00100     deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o20">ChildBusNumber</a> = (ULONG)-1;
00101     deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o21">ChildBusTypeIndex</a> = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)-1;
00102 
00103     <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>( &amp;deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o12">EnumerationMutex</a>,
00104                        SynchronizationEvent,
00105                        <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
00106 
00107     InitializeListHead(&amp;deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o24">DeviceArbiterList</a>);
00108     InitializeListHead(&amp;deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o25">DeviceTranslatorList</a>);
00109 
00110     <span class="keywordflow">if</span> (PhysicalDeviceObject){
00111 
00112         deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o9">PhysicalDeviceObject</a> = PhysicalDeviceObject;
00113         PhysicalDeviceObject-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o25">DeviceObjectExtension</a>-&gt;<a class="code" href="../../d3/d5/struct__DEVOBJ__EXTENSION.html#o6">DeviceNode</a> = (PVOID)deviceNode;
00114         PhysicalDeviceObject-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o6">Flags</a> &amp;= ~<a class="code" href="../../d0/d5/io_8h.html#a128">DO_DEVICE_INITIALIZING</a>;
00115     }
00116 
00117     InitializeListHead(&amp;deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o23">TargetDeviceNotify</a>);
00118 
00119     InitializeListHead(&amp;deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o42">DockInfo</a>.ListEntry);
00120 
00121     InitializeListHead(&amp;deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o44">PendedSetInterfaceState</a>);
00122 
00123     <span class="keywordflow">return</span> deviceNode;
00124 }
00125 
00126 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00127"></a><a class="code" href="../../d9/d0/pnpiop_8h.html#a253">00127</a> <a class="code" href="../../d9/d0/pnpiop_8h.html#a253">IopForAllDeviceNodes</a>(
00128     IN <a class="code" href="../../d9/d0/pnpiop_8h.html#a118">PENUM_CALLBACK</a> Callback,
00129     IN PVOID Context
00130     )
00131 
00132 <span class="comment">/*++</span>
00133 <span class="comment"></span>
00134 <span class="comment">Routine Description:</span>
00135 <span class="comment"></span>
00136 <span class="comment">    This function walks the device node tree and perform caller specified</span>
00137 <span class="comment">    'Callback' function for each device node.</span>
00138 <span class="comment"></span>
00139 <span class="comment">    Note, this routine (or its worker routine) traverses the tree in a top</span>
00140 <span class="comment">    down manner.</span>
00141 <span class="comment"></span>
00142 <span class="comment">Arguments:</span>
00143 <span class="comment"></span>
00144 <span class="comment">    Callback - Supplies the call back routine for each device node.</span>
00145 <span class="comment"></span>
00146 <span class="comment">    Context - Supplies a parameter/context for the callback function.</span>
00147 <span class="comment"></span>
00148 <span class="comment">Return Value:</span>
00149 <span class="comment"></span>
00150 <span class="comment">    Status returned from Callback, if not successfull then the tree walking stops.</span>
00151 <span class="comment"></span>
00152 <span class="comment">--*/</span>
00153 {
00154     <a class="code" href="../../d6/d3/struct__ENUM__CONTEXT.html">ENUM_CONTEXT</a> enumContext;
00155     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00156 
00157     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00158 
00159     enumContext.<a class="code" href="../../d6/d3/struct__ENUM__CONTEXT.html#o0">CallersCallback</a> = Callback;
00160     enumContext.<a class="code" href="../../d6/d3/struct__ENUM__CONTEXT.html#o1">CallersContext</a> = Context;
00161 
00162     <span class="comment">//</span>
00163     <span class="comment">// Start with a pointer to the root device node, recursively examine all the</span>
00164     <span class="comment">// children until we the callback function says stop or we've looked at all</span>
00165     <span class="comment">// of them.</span>
00166     <span class="comment">//</span>
00167 
00168     <a class="code" href="../../d9/d0/pnpiop_8h.html#a95">IopAcquireEnumerationLock</a>(<a class="code" href="../../d1/d0/pnpdata_8c.html#a5">IopRootDeviceNode</a>);
00169 
00170     status = <a class="code" href="../../d9/d0/pnpiop_8h.html#a270">IopForAllChildDeviceNodes</a>(<a class="code" href="../../d1/d0/pnpdata_8c.html#a5">IopRootDeviceNode</a>,
00171                                        <a class="code" href="../../d4/d7/devnode_8c.html#a2">IopForAllDeviceNodesCallback</a>,
00172                                        (PVOID)&amp;enumContext );
00173 
00174     <a class="code" href="../../d9/d0/pnpiop_8h.html#a96">IopReleaseEnumerationLock</a>(<a class="code" href="../../d1/d0/pnpdata_8c.html#a5">IopRootDeviceNode</a>);
00175     <span class="keywordflow">return</span> status;
00176 }
00177 
00178 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00179"></a><a class="code" href="../../d9/d0/pnpiop_8h.html#a270">00179</a> <a class="code" href="../../d9/d0/pnpiop_8h.html#a270">IopForAllChildDeviceNodes</a>(
00180     IN <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> Parent,
00181     IN PENUM_CALLBACK Callback,
00182     IN PVOID Context
00183     )
00184 
00185 <span class="comment">/*++</span>
00186 <span class="comment"></span>
00187 <span class="comment">Routine Description:</span>
00188 <span class="comment"></span>
00189 <span class="comment">    This function walks the Parent's device node subtree and perform caller specified</span>
00190 <span class="comment">    'Callback' function for each device node under Parent.</span>
00191 <span class="comment"></span>
00192 <span class="comment">    Note, befor calling this rotuine, callers must acquire the enumeration mutex</span>
00193 <span class="comment">    of the 'Parent' device node to make sure its children won't go away unless the</span>
00194 <span class="comment">    call tells them to.</span>
00195 <span class="comment"></span>
00196 <span class="comment">Arguments:</span>
00197 <span class="comment"></span>
00198 <span class="comment">    Parent - Supplies a pointer to the device node whose subtree is to be walked.</span>
00199 <span class="comment"></span>
00200 <span class="comment">    Callback - Supplies the call back routine for each device node.</span>
00201 <span class="comment"></span>
00202 <span class="comment">    Context - Supplies a parameter/context for the callback function.</span>
00203 <span class="comment"></span>
00204 <span class="comment">Return Value:</span>
00205 <span class="comment"></span>
00206 <span class="comment">    NTSTATUS value.</span>
00207 <span class="comment"></span>
00208 <span class="comment">--*/</span>
00209 
00210 {
00211     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> nextChild = Parent-&gt;Child;
00212     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> child;
00213     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status = STATUS_SUCCESS;
00214 
00215     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00216 
00217     <span class="comment">//</span>
00218     <span class="comment">// Process siblings until we find the end of the sibling list or</span>
00219     <span class="comment">// the Callback() returns FALSE.  Set result = TRUE at the top of</span>
00220     <span class="comment">// the loop so that if there are no siblings we will return TRUE,</span>
00221     <span class="comment">// e.g. Keep Enumerating.</span>
00222     <span class="comment">//</span>
00223     <span class="comment">// Note, we need to find next child before calling Callback function</span>
00224     <span class="comment">// in case the current child is deleted by the Callback function.</span>
00225     <span class="comment">//</span>
00226 
00227     <span class="keywordflow">while</span> (nextChild &amp;&amp; <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00228         child = nextChild;
00229         nextChild = child-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o0">Sibling</a>;
00230         status = Callback(child, Context);
00231     }
00232 
00233     <span class="keywordflow">return</span> status;
00234 }
00235 
00236 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00237"></a><a class="code" href="../../d4/d7/devnode_8c.html#a2">00237</a> <a class="code" href="../../d4/d7/devnode_8c.html#a2">IopForAllDeviceNodesCallback</a>(
00238     IN <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode,
00239     IN PVOID Context
00240     )
00241 
00242 <span class="comment">/*++</span>
00243 <span class="comment"></span>
00244 <span class="comment">Routine Description:</span>
00245 <span class="comment"></span>
00246 <span class="comment">    This function is the worker routine for IopForAllChildDeviceNodes routine.</span>
00247 <span class="comment"></span>
00248 <span class="comment">Arguments:</span>
00249 <span class="comment"></span>
00250 <span class="comment">    DeviceNode - Supplies a pointer to the device node whose subtree is to be walked.</span>
00251 <span class="comment"></span>
00252 <span class="comment">    Context - Supplies a context which contains the caller specified call back</span>
00253 <span class="comment">              function and parameter.</span>
00254 <span class="comment"></span>
00255 <span class="comment">Return Value:</span>
00256 <span class="comment"></span>
00257 <span class="comment">    NTSTATUS value.</span>
00258 <span class="comment"></span>
00259 <span class="comment">--*/</span>
00260 
00261 {
00262     <a class="code" href="../../d4/d7/devnode_8c.html#a1">PENUM_CONTEXT</a> enumContext;
00263     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00264 
00265     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00266 
00267     enumContext = (<a class="code" href="../../d4/d7/devnode_8c.html#a1">PENUM_CONTEXT</a>)Context;
00268 
00269     <span class="comment">//</span>
00270     <span class="comment">// First call the caller's callback for this devnode</span>
00271     <span class="comment">//</span>
00272 
00273     status =
00274         enumContext-&gt;<a class="code" href="../../d6/d3/struct__ENUM__CONTEXT.html#o0">CallersCallback</a>(DeviceNode, enumContext-&gt;<a class="code" href="../../d6/d3/struct__ENUM__CONTEXT.html#o1">CallersContext</a>);
00275 
00276     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00277 
00278         <span class="comment">//</span>
00279         <span class="comment">// Now enumerate the children, if any.</span>
00280         <span class="comment">//</span>
00281 
00282         <a class="code" href="../../d9/d0/pnpiop_8h.html#a95">IopAcquireEnumerationLock</a>(DeviceNode);
00283 
00284         <span class="keywordflow">if</span>( DeviceNode-&gt;Child) {
00285 
00286             status = <a class="code" href="../../d9/d0/pnpiop_8h.html#a270">IopForAllChildDeviceNodes</a>(
00287                                         DeviceNode,
00288                                         <a class="code" href="../../d4/d7/devnode_8c.html#a2">IopForAllDeviceNodesCallback</a>,
00289                                         Context);
00290         }
00291         <a class="code" href="../../d9/d0/pnpiop_8h.html#a96">IopReleaseEnumerationLock</a>(DeviceNode);
00292     }
00293 
00294     <span class="keywordflow">return</span> status;
00295 }
00296 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00297"></a><a class="code" href="../../d4/d7/devnode_8c.html#a6">00297</a> <a class="code" href="../../d9/d0/pnpiop_8h.html#a284">IopDestroyDeviceNode</a>(
00298     IN <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a> DeviceNode
00299     )
00300 
00301 <span class="comment">/*++</span>
00302 <span class="comment"></span>
00303 <span class="comment">Routine Description:</span>
00304 <span class="comment"></span>
00305 <span class="comment">    This function is invoked by IopDeleteDevice to clean up the device object's</span>
00306 <span class="comment">    device node structure.</span>
00307 <span class="comment"></span>
00308 <span class="comment">Arguments:</span>
00309 <span class="comment"></span>
00310 <span class="comment">    DeviceNode - Supplies a pointer to the device node whose subtree is to be walked.</span>
00311 <span class="comment"></span>
00312 <span class="comment">    Context - Supplies a context which contains the caller specified call back</span>
00313 <span class="comment">              function and parameter.</span>
00314 <span class="comment"></span>
00315 <span class="comment">Return Value:</span>
00316 <span class="comment"></span>
00317 <span class="comment">    NTSTATUS value.</span>
00318 <span class="comment"></span>
00319 <span class="comment">--*/</span>
00320 
00321 {
00322     PLIST_ENTRY listHead, nextEntry, entry;
00323     <a class="code" href="../../d8/d5/struct__PI__RESOURCE__TRANSLATOR__ENTRY.html">PPI_RESOURCE_TRANSLATOR_ENTRY</a> handlerEntry;
00324     <a class="code" href="../../d8/d3/struct__INTERFACE.html">PINTERFACE</a> interface;
00325 
00326     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00327 
00328     <span class="keywordflow">if</span> (DeviceNode) {
00329 
00330         <span class="keywordflow">if</span> ((DeviceNode-&gt;PhysicalDeviceObject-&gt;Flags &amp; <a class="code" href="../../d0/d5/io_8h.html#a133">DO_BUS_ENUMERATED_DEVICE</a>) &amp;&amp;
00331             DeviceNode-&gt;Parent != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)  {
00332 
00333             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>( PNP_DETECTED_FATAL_ERROR,
00334                           <a class="code" href="../../d9/d0/pnpiop_8h.html#a51">PNP_ERR_ACTIVE_PDO_FREED</a>,
00335                           (ULONG_PTR)DeviceNode-&gt;PhysicalDeviceObject,
00336                           0,
00337                           0);
00338         }
00339 
00340 <span class="preprocessor">#if DBG</span>
00341 <span class="preprocessor"></span>
00342         <span class="comment">//</span>
00343         <span class="comment">// If Only Parent is NOT NULL, most likely the driver forgot to</span>
00344         <span class="comment">// release resources before deleting its FDO.  (The driver previously</span>
00345         <span class="comment">// call legacy assign resource interface.)</span>
00346         <span class="comment">//</span>
00347 
00348         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(DeviceNode-&gt;Child == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp;
00349                DeviceNode-&gt;Sibling == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp;
00350                DeviceNode-&gt;LastChild == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00351                );
00352 
00353         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(DeviceNode-&gt;DockInfo.SerialNumber == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp;
00354                IsListEmpty(&amp;DeviceNode-&gt;DockInfo.ListEntry));
00355 
00356         <span class="keywordflow">if</span> (DeviceNode-&gt;PhysicalDeviceObject-&gt;Flags &amp; <a class="code" href="../../d0/d5/io_8h.html#a133">DO_BUS_ENUMERATED_DEVICE</a>) {
00357             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (DeviceNode-&gt;Parent == 0);
00358         }
00359 
00360         <span class="keywordflow">if</span> (DeviceNode-&gt;PreviousResourceList) {
00361             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(DeviceNode-&gt;PreviousResourceList);
00362         }
00363         <span class="keywordflow">if</span> (DeviceNode-&gt;PreviousResourceRequirements) {
00364             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(DeviceNode-&gt;PreviousResourceRequirements);
00365         }
00366 
00367         <span class="comment">//</span>
00368         <span class="comment">// device should not appear to be not-disableable if/when we get here</span>
00369         <span class="comment">// if either of these two lines ASSERT, email: jamiehun</span>
00370         <span class="comment">//</span>
00371 
00372         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((DeviceNode-&gt;UserFlags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a40">DNUF_NOT_DISABLEABLE</a>) == 0);
00373         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(DeviceNode-&gt;DisableableDepends == 0);
00374 
00375 <span class="preprocessor">#endif</span>
00376 <span class="preprocessor"></span>        <span class="comment">//</span>
00377         <span class="comment">// If this devicenode is our internal one used for legacy</span>
00378         <span class="comment">// resource allocation, then clean up. Find this devicenode </span>
00379         <span class="comment">// in the list of legacy resource devnodes hanging off the</span>
00380         <span class="comment">// legacy devicenode in the tree and remove it.</span>
00381         <span class="comment">//</span>
00382         <span class="comment">// BUGBUG: SantoshJ 10/15/99: We should be releasing</span>
00383         <span class="comment">// resources assigned to this device.</span>
00384         <span class="comment">//</span>
00385         
00386         <span class="keywordflow">if</span> (DeviceNode-&gt;Flags &amp; <a class="code" href="../../d9/d0/pnpiop_8h.html#a34">DNF_LEGACY_RESOURCE_DEVICENODE</a>) {
00387 
00388             <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>    resourceDeviceNode;
00389 
00390             <span class="keywordflow">for</span> (   resourceDeviceNode = (<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>)DeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o32">OverUsed1</a>.LegacyDeviceNode;
00391                     resourceDeviceNode;
00392                     resourceDeviceNode = resourceDeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o34">OverUsed2</a>.NextResourceDeviceNode) {
00393 
00394                     <span class="keywordflow">if</span> (resourceDeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o34">OverUsed2</a>.NextResourceDeviceNode == DeviceNode) {
00395 
00396                         resourceDeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o34">OverUsed2</a>.NextResourceDeviceNode = DeviceNode-&gt;OverUsed2.NextResourceDeviceNode;
00397                         <span class="keywordflow">break</span>;
00398 
00399                     }
00400             }
00401         }
00402 
00403         <span class="keywordflow">if</span> (DeviceNode-&gt;DuplicatePDO) {
00404             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(DeviceNode-&gt;DuplicatePDO);
00405         }
00406         <span class="keywordflow">if</span> (DeviceNode-&gt;ServiceName.Length != 0) {
00407             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(DeviceNode-&gt;ServiceName.Buffer);
00408         }
00409         <span class="keywordflow">if</span> (DeviceNode-&gt;InstancePath.Length != 0) {
00410             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(DeviceNode-&gt;InstancePath.Buffer);
00411         }
00412         <span class="keywordflow">if</span> (DeviceNode-&gt;ResourceRequirements) {
00413             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(DeviceNode-&gt;ResourceRequirements);
00414         }
00415 
00416         <span class="comment">//</span>
00417         <span class="comment">// Dereference all the arbiters and translators on this PDO.</span>
00418         <span class="comment">//</span>
00419         <a class="code" href="../../d0/d1/pnpirp_8c.html#a17">IopUncacheInterfaceInformation</a>(DeviceNode-&gt;PhysicalDeviceObject) ;
00420 
00421         <span class="comment">//</span>
00422         <span class="comment">// Release any pended IoSetDeviceInterface structures</span>
00423         <span class="comment">//</span>
00424 
00425         <span class="keywordflow">while</span> (!IsListEmpty(&amp;DeviceNode-&gt;PendedSetInterfaceState)) {
00426 
00427             <a class="code" href="../../d9/d4/struct__PENDING__SET__INTERFACE__STATE.html">PPENDING_SET_INTERFACE_STATE</a> entry;
00428 
00429             entry = (<a class="code" href="../../d9/d4/struct__PENDING__SET__INTERFACE__STATE.html">PPENDING_SET_INTERFACE_STATE</a>)RemoveHeadList(&amp;DeviceNode-&gt;PendedSetInterfaceState);
00430 
00431             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(entry-&gt;<a class="code" href="../../d9/d4/struct__PENDING__SET__INTERFACE__STATE.html#o1">LinkName</a>.Buffer);
00432 
00433             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(entry);
00434         }
00435 
00436         DeviceNode-&gt;PhysicalDeviceObject-&gt;DeviceObjectExtension-&gt;DeviceNode = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00437         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(DeviceNode);
00438         <a class="code" href="../../d1/d0/pnpdata_8c.html#a12">IopNumberDeviceNodes</a>--;
00439     }
00440 }
00441 <span class="comment">//</span>
00442 <span class="comment">// Code to support Power manager's need to traverse the device node tree in inverse order,</span>
00443 <span class="comment">// (from the leaves towards the root.)</span>
00444 <span class="comment">//</span>
00445 
00446 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00447"></a><a class="code" href="../../d9/d0/pnpiop_8h.html#a250">00447</a> <a class="code" href="../../d9/d0/pnpiop_8h.html#a250">IopInsertTreeDeviceNode</a> (
00448     IN <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>     ParentNode,
00449     IN <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>     DeviceNode
00450     )
00451 <span class="comment">//    N.B. Caller must own the device tree lock</span>
00452 {
00453     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>    deviceNode;
00454     PLIST_ENTRY     *p;
00455     LONG            i;
00456 
00457     <span class="comment">//</span>
00458     <span class="comment">// Put this devnode at the end of the parent's list of children.</span>
00459     <span class="comment">//</span>
00460 
00461     DeviceNode-&gt;Parent = ParentNode;
00462     <span class="keywordflow">if</span> (ParentNode-&gt;LastChild) {
00463         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ParentNode-&gt;LastChild-&gt;Sibling == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00464         ParentNode-&gt;LastChild-&gt;Sibling = DeviceNode;
00465         ParentNode-&gt;LastChild = DeviceNode;
00466     } <span class="keywordflow">else</span> {
00467         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ParentNode-&gt;Child == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00468         ParentNode-&gt;Child = ParentNode-&gt;LastChild = DeviceNode;
00469     }
00470 
00471     <span class="comment">//</span>
00472     <span class="comment">// Determine the depth of the devnode.</span>
00473     <span class="comment">//</span>
00474 
00475     <span class="keywordflow">for</span> (deviceNode = DeviceNode;
00476          deviceNode != <a class="code" href="../../d1/d0/pnpdata_8c.html#a5">IopRootDeviceNode</a>;
00477          deviceNode = deviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o2">Parent</a>) {
00478         DeviceNode-&gt;Level++;
00479     }
00480 
00481     <span class="keywordflow">if</span> (DeviceNode-&gt;Level &gt; <a class="code" href="../../d1/d0/pnpdata_8c.html#a25">IopMaxDeviceNodeLevel</a>) {
00482         <a class="code" href="../../d1/d0/pnpdata_8c.html#a25">IopMaxDeviceNodeLevel</a> = DeviceNode-&gt;Level;
00483     }
00484 
00485     <span class="comment">//</span>
00486     <span class="comment">// Tree has changed</span>
00487     <span class="comment">//</span>
00488 
00489     <a class="code" href="../../d1/d0/pnpdata_8c.html#a21">IoDeviceNodeTreeSequence</a> += 1;
00490 }
00491 
00492 
00493 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00494"></a><a class="code" href="../../d9/d0/pnpiop_8h.html#a251">00494</a> <a class="code" href="../../d9/d0/pnpiop_8h.html#a251">IopRemoveTreeDeviceNode</a> (
00495     IN <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>     DeviceNode
00496     )
00497 <span class="comment">/*++</span>
00498 <span class="comment"></span>
00499 <span class="comment">Routine Description:</span>
00500 <span class="comment"></span>
00501 <span class="comment">    This function removes the device node from the device node tree</span>
00502 <span class="comment"></span>
00503 <span class="comment">    N.B. The caller must own the device tree lock of the parent's enumeration lock</span>
00504 <span class="comment"></span>
00505 <span class="comment">Arguments:</span>
00506 <span class="comment"></span>
00507 <span class="comment">    DeviceNode      - Device node to remove</span>
00508 <span class="comment"></span>
00509 <span class="comment">Return Value:</span>
00510 <span class="comment"></span>
00511 <span class="comment"></span>
00512 <span class="comment">--*/</span>
00513 {
00514     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>        *Node;
00515 
00516     <span class="comment">//</span>
00517     <span class="comment">// Ulink the pointer to this device node.  (If this is the</span>
00518     <span class="comment">// first entry, unlink it from the parents child pointer, else</span>
00519     <span class="comment">// remove it from the sibling list)</span>
00520     <span class="comment">//</span>
00521 
00522     Node = &amp;DeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o2">Parent</a>-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o1">Child</a>;
00523     <span class="keywordflow">while</span> (*Node != DeviceNode) {
00524         Node = &amp;(*Node)-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o0">Sibling</a>;
00525     }
00526     *Node = DeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o0">Sibling</a>;
00527 
00528     <span class="keywordflow">if</span> (DeviceNode-&gt;Parent-&gt;Child == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00529         DeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o2">Parent</a>-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o3">LastChild</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00530     } <span class="keywordflow">else</span> {
00531         <span class="keywordflow">while</span> (*Node) {
00532             Node = &amp;(*Node)-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o0">Sibling</a>;
00533         }
00534         DeviceNode-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o2">Parent</a>-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o3">LastChild</a> = CONTAINING_RECORD(Node, <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">DEVICE_NODE</a>, Sibling);
00535     }
00536 
00537 
00538     <span class="comment">//</span>
00539     <span class="comment">// Orphan any outstanding device change notifications on these nodes.</span>
00540     <span class="comment">//</span>
00541     <a class="code" href="../../d9/d0/pnpiop_8h.html#a385">IopOrphanNotification</a>(DeviceNode);
00542 
00543     <span class="comment">//</span>
00544     <span class="comment">// No longer linked</span>
00545     <span class="comment">//</span>
00546 
00547     DeviceNode-&gt;Parent    = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00548     DeviceNode-&gt;Child     = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00549     DeviceNode-&gt;Sibling   = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00550     DeviceNode-&gt;LastChild = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00551 }
00552 
00553 <span class="preprocessor">#if DBG</span>
00554 <span class="preprocessor"></span>
00555 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00556 IopCheckForTargetDevice (
00557     IN <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>   TargetDevice,
00558     IN <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>   DeviceObject
00559     )
00560 {
00561     <span class="keywordflow">if</span> (!TargetDevice || !DeviceObject) {
00562         <span class="keywordflow">return</span> ;
00563     }
00564 
00565     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (DeviceObject != TargetDevice);
00566 
00567     <span class="keywordflow">while</span> (DeviceObject-&gt;AttachedDevice) {
00568         DeviceObject = DeviceObject-&gt;AttachedDevice;
00569         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (DeviceObject != TargetDevice);
00570     }
00571 }
00572 
00573 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00574 IopCheckDeviceNodeTree (
00575     IN <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> TargetDevice OPTIONAL,
00576     IN <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>   TargetNode OPTIONAL
00577     )
00578 <span class="comment">// scan the device node tree and make sure this TargetDevice and TargetNode</span>
00579 <span class="comment">// are not in the tree</span>
00580 {
00581     KIRQL               OldIrql;
00582     <a class="code" href="../../d4/d4/struct__DEVICE__NODE.html">PDEVICE_NODE</a>        Node;
00583 
00584     <span class="keywordflow">return</span> ;        <span class="comment">// bugbug: not tested</span>
00585 
00586     <a class="code" href="../../d9/d0/pnpiop_8h.html#a98">IopAcquireDeviceTreeLock</a>();
00587     ExAcquireSpinLock (&amp;IopDatabaseLock, &amp;OldIrql);
00588 
00589     <span class="comment">//</span>
00590     <span class="comment">// Find left most node</span>
00591     <span class="comment">//</span>
00592 
00593     Node = <a class="code" href="../../d1/d0/pnpdata_8c.html#a5">IopRootDeviceNode</a>;
00594     <span class="keywordflow">while</span> (Node-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o1">Child</a>) {
00595         Node = Node-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o1">Child</a>;
00596     }
00597 
00598     <span class="comment">//</span>
00599     <span class="comment">// Run the entire tree</span>
00600     <span class="comment">//</span>
00601 
00602     <span class="keywordflow">while</span> (Node != <a class="code" href="../../d1/d0/pnpdata_8c.html#a5">IopRootDeviceNode</a>) {
00603 
00604         <span class="comment">//</span>
00605         <span class="comment">// Verify this isn't the target node</span>
00606         <span class="comment">//</span>
00607 
00608         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Node != TargetNode);
00609 
00610         <span class="comment">//</span>
00611         <span class="comment">// Verify target device isn't on the node somehow</span>
00612         <span class="comment">//</span>
00613 
00614         IopCheckForTargetDevice (TargetDevice, Node-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o9">PhysicalDeviceObject</a>);
00615         IopCheckForTargetDevice (TargetDevice, Node-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o15">DuplicatePDO</a>);
00616 
00617         <span class="comment">//</span>
00618         <span class="comment">// Next node</span>
00619         <span class="comment">//</span>
00620 
00621         <span class="keywordflow">if</span> (Node-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o0">Sibling</a>) {
00622             Node = Node-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o0">Sibling</a>;
00623             <span class="keywordflow">while</span> (Node-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o1">Child</a>) {
00624                 Node = Node-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o1">Child</a>;
00625             }
00626         } <span class="keywordflow">else</span> {
00627             Node = Node-&gt;<a class="code" href="../../d4/d4/struct__DEVICE__NODE.html#o2">Parent</a>;
00628         }
00629     }
00630 
00631     ExReleaseSpinLock (&amp;IopDatabaseLock, OldIrql);
00632     <a class="code" href="../../d9/d0/pnpiop_8h.html#a99">IopReleaseDeviceTreeLock</a> ();
00633 
00634 }
00635 <span class="preprocessor">#endif</span>
00636 <span class="preprocessor"></span>
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:40 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
