<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: enumwin.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>enumwin.c</h1><a href="../../d4/d7/enumwin_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/****************************** Module Header ******************************\</span>
00002 <span class="comment">* Module Name: enumwin.c</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00005 <span class="comment">*</span>
00006 <span class="comment">* Contains the EnumWindows API, BuildHwndList and related functions.</span>
00007 <span class="comment">*</span>
00008 <span class="comment">* History:</span>
00009 <span class="comment">* 10-20-90 darrinm      Created.</span>
00010 <span class="comment">* ??-??-?? ianja        Added Revalidation code</span>
00011 <span class="comment">* 02-19-91 JimA         Added enum access checks</span>
00012 <span class="comment">\***************************************************************************/</span>
00013 
00014 <span class="preprocessor">#include "<a class="code" href="../../d0/d4/w32_2ntuser_2kernel_2precomp_8h.html">precomp.h</a>"</span>
00015 <span class="preprocessor">#pragma hdrstop</span>
00016 <span class="preprocessor"></span>
<a name="l00017"></a><a class="code" href="../../d4/d7/enumwin_8c.html#a2">00017</a> <a class="code" href="../../d4/d9/structtagBWL.html">PBWL</a> <a class="code" href="../../d4/d7/enumwin_8c.html#a2">pbwlCache</a>;
00018 
00019 <span class="preprocessor">#if DBG</span>
00020 <span class="preprocessor"></span><a class="code" href="../../d4/d9/structtagBWL.html">PBWL</a> pbwlCachePrev;
00021 <span class="preprocessor">#endif</span>
00022 <span class="preprocessor"></span>
00023 <a class="code" href="../../d4/d9/structtagBWL.html">PBWL</a> <a class="code" href="../../d4/d7/enumwin_8c.html#a3">InternalBuildHwndList</a>(<a class="code" href="../../d4/d9/structtagBWL.html">PBWL</a> pbwl, <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd, UINT flags);
00024 <a class="code" href="../../d4/d9/structtagBWL.html">PBWL</a> <a class="code" href="../../d4/d7/enumwin_8c.html#a4">InternalBuildHwndOwnerList</a>(<a class="code" href="../../d4/d9/structtagBWL.html">PBWL</a> pbwl, <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndStart, <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndOwner);
00025 <span class="preprocessor">#ifdef FE_IME</span>
00026 <span class="preprocessor"></span><a class="code" href="../../d4/d9/structtagBWL.html">PBWL</a> InternalRebuildHwndListForIMEClass(<a class="code" href="../../d4/d9/structtagBWL.html">PBWL</a> pbwl, BOOL fRemoveChild);
00027 <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> InternalGetIMEOwner(HWND hwnd, BOOL fRetIMEWnd);
00028 <span class="preprocessor">#endif</span>
00029 <span class="preprocessor"></span>
00030 
00031 <span class="comment">/***************************************************************************\</span>
00032 <span class="comment">* xxxInternalEnumWindow</span>
00033 <span class="comment">*</span>
00034 <span class="comment">* History:</span>
00035 <span class="comment">* 10-20-90 darrinm      Ported from Win 3.0 sources.</span>
00036 <span class="comment">* 02-06-91 IanJa        rename: the call to lpfn can leave the critsect.</span>
00037 <span class="comment">* 02-19-91 JimA         Added enum access check</span>
00038 <span class="comment">\***************************************************************************/</span>
00039 
<a name="l00040"></a><a class="code" href="../../d4/d1/userk_8h.html#a1428">00040</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1428">xxxInternalEnumWindow</a>(
00041     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndNext,
00042     <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a990">WNDENUMPROC_PWND</a> lpfn,
00043     LPARAM lParam,
00044     UINT flags)
00045 {
00046     HWND *phwnd;
00047     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd;
00048     <a class="code" href="../../d4/d9/structtagBWL.html">PBWL</a> pbwl;
00049     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> fSuccess;
00050     <a class="code" href="../../d5/d1/struct__TL.html">TL</a> tlpwnd;
00051 
00052     <a class="code" href="../../d6/d0/usercli_8h.html#a35">CheckLock</a>(pwndNext);
00053 
00054     <span class="keywordflow">if</span> ((pbwl = <a class="code" href="../../d4/d1/userk_8h.html#a1157">BuildHwndList</a>(pwndNext, flags, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00055         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00056 
00057     fSuccess = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00058     <span class="keywordflow">for</span> (phwnd = pbwl-&gt;<a class="code" href="../../d4/d9/structtagBWL.html#o4">rghwnd</a>; *phwnd != (HWND)1; phwnd++) {
00059 
00060         <span class="comment">/*</span>
00061 <span class="comment">         * Lock the window before we pass it off to the app.</span>
00062 <span class="comment">         */</span>
00063         <span class="keywordflow">if</span> ((pwnd = <a class="code" href="../../d6/d0/usercli_8h.html#a21">RevalidateHwnd</a>(*phwnd)) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00064 
00065             <span class="comment">/*</span>
00066 <span class="comment">             * Call the application.</span>
00067 <span class="comment">             */</span>
00068             <a class="code" href="../../d6/d0/usercli_8h.html#a37">ThreadLockAlways</a>(pwnd, &amp;tlpwnd);
00069             fSuccess = (*lpfn)(pwnd, lParam);
00070             <a class="code" href="../../d6/d0/usercli_8h.html#a40">ThreadUnlock</a>(&amp;tlpwnd);
00071             <span class="keywordflow">if</span> (!fSuccess)
00072                 <span class="keywordflow">break</span>;
00073         }
00074     }
00075 
00076     <a class="code" href="../../d4/d1/userk_8h.html#a1158">FreeHwndList</a>(pbwl);
00077 
00078     <span class="keywordflow">return</span> fSuccess;
00079 }
00080 
00081 
00082 <span class="comment">/***************************************************************************\</span>
00083 <span class="comment">* BuildHwndList</span>
00084 <span class="comment">*</span>
00085 <span class="comment">* History:</span>
00086 <span class="comment">* 10-20-90 darrinm      Ported from Win 3.0 sources.</span>
00087 <span class="comment">\***************************************************************************/</span>
00088 
<a name="l00089"></a><a class="code" href="../../d4/d7/enumwin_8c.html#a0">00089</a> <span class="preprocessor">#define CHWND_BWLCREATE 32</span>
00090 <span class="preprocessor"></span>
<a name="l00091"></a><a class="code" href="../../d4/d1/userk_8h.html#a1157">00091</a> <a class="code" href="../../d4/d9/structtagBWL.html">PBWL</a> <a class="code" href="../../d4/d1/userk_8h.html#a1157">BuildHwndList</a>(
00092     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd,
00093     UINT flags,
00094     <a class="code" href="../../d2/d8/structtagTHREADINFO.html">PTHREADINFO</a> pti)
00095 {
00096     <a class="code" href="../../d4/d9/structtagBWL.html">PBWL</a> pbwl;
00097 
00098     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
00099 
00100     <span class="keywordflow">if</span> ((pbwl = <a class="code" href="../../d4/d7/enumwin_8c.html#a2">pbwlCache</a>) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00101 
00102         <span class="comment">/*</span>
00103 <span class="comment">         * We're using the cache now; zero it out.</span>
00104 <span class="comment">         */</span>
00105 <span class="preprocessor">#if DBG</span>
00106 <span class="preprocessor"></span>        pbwlCachePrev = <a class="code" href="../../d4/d7/enumwin_8c.html#a2">pbwlCache</a>;
00107 <span class="preprocessor">#endif</span>
00108 <span class="preprocessor"></span>        <a class="code" href="../../d4/d7/enumwin_8c.html#a2">pbwlCache</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00109 
00110 <span class="preprocessor">#if DBG</span>
00111 <span class="preprocessor"></span>        {
00112             <a class="code" href="../../d4/d9/structtagBWL.html">PBWL</a> pbwlT;
00113             <span class="comment">/*</span>
00114 <span class="comment">             * pbwlCache shouldn't be in the global linked list.</span>
00115 <span class="comment">             */</span>
00116             <span class="keywordflow">for</span> (pbwlT = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a99">gpbwlList</a>; pbwlT != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; pbwlT = pbwlT-&gt;<a class="code" href="../../d4/d9/structtagBWL.html#o0">pbwlNext</a>) {
00117                 UserAssert(pbwlT != pbwl);
00118             }
00119         }
00120 <span class="preprocessor">#endif</span>
00121 <span class="preprocessor"></span>    } <span class="keywordflow">else</span> {
00122 
00123         <span class="comment">/*</span>
00124 <span class="comment">         * sizeof(BWL) includes the first element of array.</span>
00125 <span class="comment">         */</span>
00126         pbwl = (<a class="code" href="../../d4/d9/structtagBWL.html">PBWL</a>)UserAllocPool(<span class="keyword">sizeof</span>(<a class="code" href="../../d4/d9/structtagBWL.html">BWL</a>) + <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d9/structtagWND.html">PWND</a>) * <a class="code" href="../../d4/d7/enumwin_8c.html#a0">CHWND_BWLCREATE</a>,
00127                 TAG_WINDOWLIST);
00128         <span class="keywordflow">if</span> (pbwl == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00129             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00130 
00131         pbwl-&gt;<a class="code" href="../../d4/d9/structtagBWL.html#o2">phwndMax</a> = &amp;pbwl-&gt;<a class="code" href="../../d4/d9/structtagBWL.html#o4">rghwnd</a>[<a class="code" href="../../d4/d7/enumwin_8c.html#a0">CHWND_BWLCREATE</a> - 1];
00132     }
00133     pbwl-&gt;<a class="code" href="../../d4/d9/structtagBWL.html#o1">phwndNext</a> = pbwl-&gt;<a class="code" href="../../d4/d9/structtagBWL.html#o4">rghwnd</a>;
00134 
00135     <span class="comment">/*</span>
00136 <span class="comment">     * We'll use ptiOwner as temporary storage for the thread we're</span>
00137 <span class="comment">     * scanning for. It will get reset to the proper thing at the bottom</span>
00138 <span class="comment">     * of this routine.</span>
00139 <span class="comment">     */</span>
00140     pbwl-&gt;<a class="code" href="../../d4/d9/structtagBWL.html#o3">ptiOwner</a> = pti;
00141 
00142 <span class="preprocessor">#ifdef OWNERLIST</span>
00143 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (flags &amp; <a class="code" href="../../d4/d1/userk_8h.html#a411">BWL_ENUMOWNERLIST</a>) {
00144         pbwl = <a class="code" href="../../d4/d7/enumwin_8c.html#a4">InternalBuildHwndOwnerList</a>(pbwl, pwnd, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00145     } <span class="keywordflow">else</span> {
00146         pbwl = <a class="code" href="../../d4/d7/enumwin_8c.html#a3">InternalBuildHwndList</a>(pbwl, pwnd, flags);
00147     }
00148 <span class="preprocessor">#else</span>
00149 <span class="preprocessor"></span>    pbwl = <a class="code" href="../../d4/d7/enumwin_8c.html#a3">InternalBuildHwndList</a>(pbwl, pwnd, flags);
00150 <span class="preprocessor">#endif</span>
00151 <span class="preprocessor"></span>
00152     <span class="comment">/*</span>
00153 <span class="comment">     * If phwndNext == phwndMax, it indicates that the pbwl has failed to expand.</span>
00154 <span class="comment">     * The list is no longer valid, so we should just bail.</span>
00155 <span class="comment">     */</span>
00156     <span class="keywordflow">if</span> (pbwl-&gt;<a class="code" href="../../d4/d9/structtagBWL.html#o1">phwndNext</a> &gt;= pbwl-&gt;<a class="code" href="../../d4/d9/structtagBWL.html#o2">phwndMax</a>) {
00157         UserAssert(pbwl-&gt;<a class="code" href="../../d4/d9/structtagBWL.html#o1">phwndNext</a> == pbwl-&gt;<a class="code" href="../../d4/d9/structtagBWL.html#o2">phwndMax</a>);
00158         <span class="comment">/*</span>
00159 <span class="comment">         * Even if we had picked pbwl from the global single cache (pbwlCache),</span>
00160 <span class="comment">         * it should have already been unlinked from the global link list when it was put in the cache.</span>
00161 <span class="comment">         * So we should just free it without manupilating the link pointers.</span>
00162 <span class="comment">         * If we have allocated the pwbl for ourselves, we can simply free it.</span>
00163 <span class="comment">         * In both cases, we should just call UserFreePool().</span>
00164 <span class="comment">         * As the side effect, it may make some room by providing a free pool block.</span>
00165 <span class="comment">         */</span>
00166         UserFreePool(pbwl);
00167         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00168     }
00169 
00170     <span class="comment">/*</span>
00171 <span class="comment">     * Stick in the terminator.</span>
00172 <span class="comment">     */</span>
00173     *pbwl-&gt;<a class="code" href="../../d4/d9/structtagBWL.html#o1">phwndNext</a> = (HWND)1;
00174 
00175 <span class="preprocessor">#ifdef FE_IME</span>
00176 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (flags &amp; <a class="code" href="../../d4/d1/userk_8h.html#a412">BWL_ENUMIMELAST</a>) {
00177         UserAssert(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a126">IS_IME_ENABLED</a>());
00178         <span class="comment">/*</span>
00179 <span class="comment">         * For IME windows.</span>
00180 <span class="comment">         * Rebuild window list for EnumWindows API. Because ACCESS 2.0 assumes</span>
00181 <span class="comment">         * the first window that is called CallBack Functions in the task is</span>
00182 <span class="comment">         * Q-Card Wnd. We should change the order of IME windows</span>
00183 <span class="comment">         */</span>
00184         pbwl = InternalRebuildHwndListForIMEClass(pbwl,
00185                     (flags &amp; <a class="code" href="../../d4/d1/userk_8h.html#a413">BWL_REMOVEIMECHILD</a>) == <a class="code" href="../../d4/d1/userk_8h.html#a413">BWL_REMOVEIMECHILD</a>);
00186     }
00187 <span class="preprocessor">#endif</span>
00188 <span class="preprocessor"></span>
00189     <span class="comment">/*</span>
00190 <span class="comment">     * Finally link this guy into the list.</span>
00191 <span class="comment">     */</span>
00192     pbwl-&gt;<a class="code" href="../../d4/d9/structtagBWL.html#o3">ptiOwner</a> = <a class="code" href="../../d4/d1/userk_8h.html#a9">PtiCurrent</a>();
00193     pbwl-&gt;<a class="code" href="../../d4/d9/structtagBWL.html#o0">pbwlNext</a> = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a99">gpbwlList</a>;
00194     <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a99">gpbwlList</a> = pbwl;
00195 
00196 
00197     <span class="comment">/*</span>
00198 <span class="comment">     * We should have given out the cache if it was available</span>
00199 <span class="comment">     */</span>
00200     UserAssert(<a class="code" href="../../d4/d7/enumwin_8c.html#a2">pbwlCache</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00201 
00202     <span class="keywordflow">return</span> pbwl;
00203 }
00204 
00205 <span class="comment">/***************************************************************************\</span>
00206 <span class="comment">* ExpandWindowList</span>
00207 <span class="comment">*</span>
00208 <span class="comment">* This routine expands a window list.</span>
00209 <span class="comment">*</span>
00210 <span class="comment">* 01-16-92 ScottLu      Created.</span>
00211 <span class="comment">\***************************************************************************/</span>
00212 
<a name="l00213"></a><a class="code" href="../../d4/d7/enumwin_8c.html#a7">00213</a> <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a> <a class="code" href="../../d4/d7/enumwin_8c.html#a7">ExpandWindowList</a>(
00214     <a class="code" href="../../d4/d9/structtagBWL.html">PBWL</a> *ppbwl)
00215 {
00216     <a class="code" href="../../d4/d9/structtagBWL.html">PBWL</a> pbwl;
00217     <a class="code" href="../../d4/d9/structtagBWL.html">PBWL</a> pbwlT;
00218     HWND *phwnd;
00219 
00220     pbwl = *ppbwl;
00221     phwnd = pbwl-&gt;<a class="code" href="../../d4/d9/structtagBWL.html#o1">phwndNext</a>;
00222 
00223     <span class="comment">/*</span>
00224 <span class="comment">     * Map phwnd to an offset.</span>
00225 <span class="comment">     */</span>
00226     phwnd = (HWND *)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> *)phwnd - (<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> *)pbwl);
00227 
00228     <span class="comment">/*</span>
00229 <span class="comment">     * Increase size of BWL by 8 slots.  (8 + 1) is</span>
00230 <span class="comment">     * added since phwnd is "sizeof(HWND)" less</span>
00231 <span class="comment">     * than actual size of handle.</span>
00232 <span class="comment">     */</span>
00233     pbwlT = (<a class="code" href="../../d4/d9/structtagBWL.html">PBWL</a>)UserReAllocPool((HANDLE)pbwl,
00234             PtrToUlong(phwnd) + <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d9/structtagWND.html">PWND</a>),
00235             PtrToUlong(phwnd) + (<a class="code" href="../../d4/d1/userk_8h.html#a408">BWL_CHWNDMORE</a> + 1) * <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a943">PWND</a>),
00236             TAG_WINDOWLIST);
00237 
00238     <span class="comment">/*</span>
00239 <span class="comment">     * Did alloc succeed?</span>
00240 <span class="comment">     */</span>
00241     <span class="keywordflow">if</span> (pbwlT != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00242         pbwl = pbwlT;                 <span class="comment">/* Yes, use new block. */</span>
00243 
00244     <span class="comment">/*</span>
00245 <span class="comment">     * Map phwnd back into a pointer.</span>
00246 <span class="comment">     */</span>
00247     phwnd = (HWND *)((ULONG_PTR)pbwl + (ULONG_PTR)phwnd);
00248 
00249     <span class="comment">/*</span>
00250 <span class="comment">     * Did ReAlloc() fail?</span>
00251 <span class="comment">     */</span>
00252     <span class="keywordflow">if</span> (pbwlT == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00253         RIPMSG0(RIP_WARNING, <span class="stringliteral">"ExpandWindowList: out of memory."</span>);
00254         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00255     }
00256 
00257     <span class="comment">/*</span>
00258 <span class="comment">     * Reset phwndMax.</span>
00259 <span class="comment">     */</span>
00260     pbwl-&gt;phwndNext = phwnd;
00261     pbwl-&gt;phwndMax = phwnd + <a class="code" href="../../d4/d1/userk_8h.html#a408">BWL_CHWNDMORE</a>;
00262 
00263     *ppbwl = pbwl;
00264 
00265     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00266 }
00267 
00268 <span class="preprocessor">#ifdef OWNERLIST</span>
00269 <span class="preprocessor"></span>
00270 <span class="comment">/***************************************************************************\</span>
00271 <span class="comment">* InternalBuildHwndOwnerList</span>
00272 <span class="comment">*</span>
00273 <span class="comment">* Builds an hwnd list sorted by owner. Ownees go first. Shutdown uses this for</span>
00274 <span class="comment">* WM_CLOSE messages.</span>
00275 <span class="comment">*</span>
00276 <span class="comment">* 01-16-93 ScottLu      Created.</span>
00277 <span class="comment">\***************************************************************************/</span>
00278 
00279 <a class="code" href="../../d4/d9/structtagBWL.html">PBWL</a> <a class="code" href="../../d4/d7/enumwin_8c.html#a4">InternalBuildHwndOwnerList</a>(
00280     <a class="code" href="../../d4/d9/structtagBWL.html">PBWL</a> pbwl,
00281     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndStart,
00282     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndOwner)
00283 {
00284     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndT;
00285 
00286     <span class="comment">/*</span>
00287 <span class="comment">     * Put ownees first in the list.</span>
00288 <span class="comment">     */</span>
00289     <span class="keywordflow">for</span> (pwndT = pwndStart; pwndT != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; pwndT = pwndT-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o2">spwndNext</a>) {
00290 
00291         <span class="comment">/*</span>
00292 <span class="comment">         * Not the ownee we're looking for? Continue.</span>
00293 <span class="comment">         */</span>
00294         <span class="keywordflow">if</span> (pwndT-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o5">spwndOwner</a> != pwndOwner)
00295             <span class="keywordflow">continue</span>;
00296 
00297         <span class="comment">/*</span>
00298 <span class="comment">         * Only top level windows that have system menus (the ones that can</span>
00299 <span class="comment">         * receive a WM_CLOSE message).</span>
00300 <span class="comment">         */</span>
00301         <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a731">TestWF</a>(pwndT, WFSYSMENU))
00302             <span class="keywordflow">continue</span>;
00303 
00304         <span class="comment">/*</span>
00305 <span class="comment">         * Add it and its ownees to our list.</span>
00306 <span class="comment">         */</span>
00307         pbwl = <a class="code" href="../../d4/d7/enumwin_8c.html#a4">InternalBuildHwndOwnerList</a>(pbwl, pwndStart, pwndT);
00308 
00309         <span class="comment">/*</span>
00310 <span class="comment">         * If ExpandWindowList() failed in recursive calls,</span>
00311 <span class="comment">         * just bail here.</span>
00312 <span class="comment">         */</span>
00313         <span class="keywordflow">if</span> (pbwl-&gt;<a class="code" href="../../d4/d9/structtagBWL.html#o1">phwndNext</a> &gt;= pbwl-&gt;<a class="code" href="../../d4/d9/structtagBWL.html#o2">phwndMax</a>) {
00314             UserAssert(pbwl-&gt;<a class="code" href="../../d4/d9/structtagBWL.html#o1">phwndNext</a> == pbwl-&gt;<a class="code" href="../../d4/d9/structtagBWL.html#o2">phwndMax</a>);
00315             <span class="keywordflow">return</span> pbwl;
00316         }
00317         UserAssert(pbwl-&gt;<a class="code" href="../../d4/d9/structtagBWL.html#o1">phwndNext</a> &lt; pbwl-&gt;<a class="code" href="../../d4/d9/structtagBWL.html#o2">phwndMax</a>);
00318     }
00319 
00320     <span class="comment">/*</span>
00321 <span class="comment">     * Finally add this owner to our list.</span>
00322 <span class="comment">     */</span>
00323     <span class="keywordflow">if</span> (pwndOwner != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00324         UserAssert(pbwl-&gt;<a class="code" href="../../d4/d9/structtagBWL.html#o1">phwndNext</a> &lt; pbwl-&gt;<a class="code" href="../../d4/d9/structtagBWL.html#o2">phwndMax</a>);
00325         *pbwl-&gt;<a class="code" href="../../d4/d9/structtagBWL.html#o1">phwndNext</a> = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(pwndOwner);
00326         pbwl-&gt;<a class="code" href="../../d4/d9/structtagBWL.html#o1">phwndNext</a>++;
00327         <span class="keywordflow">if</span> (pbwl-&gt;<a class="code" href="../../d4/d9/structtagBWL.html#o1">phwndNext</a> == pbwl-&gt;<a class="code" href="../../d4/d9/structtagBWL.html#o2">phwndMax</a>) {
00328             <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d7/enumwin_8c.html#a7">ExpandWindowList</a>(&amp;pbwl))
00329                 <span class="keywordflow">return</span> pbwl;
00330         }
00331     }
00332 
00333     <span class="keywordflow">return</span> pbwl;
00334 }
00335 
00336 <span class="preprocessor">#endif</span>
00337 <span class="preprocessor"></span>
00338 <span class="comment">/***************************************************************************\</span>
00339 <span class="comment">* InternalBuildHwndList</span>
00340 <span class="comment">*</span>
00341 <span class="comment">* History:</span>
00342 <span class="comment">* 10-20-90 darrinm      Ported from Win 3.0 sources.</span>
00343 <span class="comment">\***************************************************************************/</span>
00344 
<a name="l00345"></a><a class="code" href="../../d4/d7/enumwin_8c.html#a1">00345</a> <span class="preprocessor">#define BWLGROW 8</span>
00346 <span class="preprocessor"></span>
<a name="l00347"></a><a class="code" href="../../d4/d7/enumwin_8c.html#a3">00347</a> <a class="code" href="../../d4/d9/structtagBWL.html">PBWL</a> <a class="code" href="../../d4/d7/enumwin_8c.html#a3">InternalBuildHwndList</a>(
00348     <a class="code" href="../../d4/d9/structtagBWL.html">PBWL</a> pbwl,
00349     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd,
00350     UINT flags)
00351 {
00352     <span class="comment">/*</span>
00353 <span class="comment">     * NOTE: pbwl-&gt;phwndNext is used as a place to keep</span>
00354 <span class="comment">     *       the phwnd across calls to InternalBuildHwndList().</span>
00355 <span class="comment">     *       This is OK since we don't link pbwl into the list</span>
00356 <span class="comment">     *       of pbwl's until after we've finished enumerating windows.</span>
00357 <span class="comment">     */</span>
00358 
00359     <span class="keywordflow">while</span> (pwnd != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00360         <span class="comment">/*</span>
00361 <span class="comment">         * Make sure it matches the thread id, if there is one.</span>
00362 <span class="comment">         */</span>
00363         <span class="keywordflow">if</span> (pbwl-&gt;<a class="code" href="../../d4/d9/structtagBWL.html#o3">ptiOwner</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> || pbwl-&gt;<a class="code" href="../../d4/d9/structtagBWL.html#o3">ptiOwner</a> == <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a455">GETPTI</a>(pwnd)) {
00364             UserAssert(pbwl-&gt;<a class="code" href="../../d4/d9/structtagBWL.html#o1">phwndNext</a> &lt; pbwl-&gt;<a class="code" href="../../d4/d9/structtagBWL.html#o2">phwndMax</a>);
00365             *pbwl-&gt;<a class="code" href="../../d4/d9/structtagBWL.html#o1">phwndNext</a> = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a451">HWq</a>(pwnd);
00366             pbwl-&gt;<a class="code" href="../../d4/d9/structtagBWL.html#o1">phwndNext</a>++;
00367             <span class="keywordflow">if</span> (pbwl-&gt;<a class="code" href="../../d4/d9/structtagBWL.html#o1">phwndNext</a> == pbwl-&gt;<a class="code" href="../../d4/d9/structtagBWL.html#o2">phwndMax</a>) {
00368 <span class="preprocessor">#if EMULATE_EXPAND_FAILURE</span>
00369 <span class="preprocessor"></span>                <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a> = 0;
00370                 <span class="keywordflow">if</span> (++<a class="code" href="../../d7/d0/exts_8h.html#a0">n</a> % 32 == 0) {
00371                     RIPMSG0(RIP_WARNING, <span class="stringliteral">"InternalBuildHwndList: emulating ExpandWindowList failure."</span>);
00372                     <span class="keywordflow">break</span>;
00373                 }
00374 <span class="preprocessor">#endif</span>
00375 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d7/enumwin_8c.html#a7">ExpandWindowList</a>(&amp;pbwl))
00376                     <span class="keywordflow">break</span>;
00377             }
00378         }
00379 
00380         <span class="comment">/*</span>
00381 <span class="comment">         * Should we step through the Child windows?</span>
00382 <span class="comment">         */</span>
00383         <span class="keywordflow">if</span> ((flags &amp; <a class="code" href="../../d4/d1/userk_8h.html#a409">BWL_ENUMCHILDREN</a>) &amp;&amp; pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o4">spwndChild</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00384             pbwl = <a class="code" href="../../d4/d7/enumwin_8c.html#a3">InternalBuildHwndList</a>(pbwl, pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o4">spwndChild</a>, <a class="code" href="../../d4/d1/userk_8h.html#a410">BWL_ENUMLIST</a> | <a class="code" href="../../d4/d1/userk_8h.html#a409">BWL_ENUMCHILDREN</a>);
00385             <span class="comment">/*</span>
00386 <span class="comment">             * If ExpandWindowList() failed in the recursive call,</span>
00387 <span class="comment">             * we should just bail.</span>
00388 <span class="comment">             */</span>
00389             <span class="keywordflow">if</span> (pbwl-&gt;<a class="code" href="../../d4/d9/structtagBWL.html#o1">phwndNext</a> &gt;= pbwl-&gt;<a class="code" href="../../d4/d9/structtagBWL.html#o2">phwndMax</a>) {
00390                 UserAssert(pbwl-&gt;<a class="code" href="../../d4/d9/structtagBWL.html#o1">phwndNext</a> == pbwl-&gt;<a class="code" href="../../d4/d9/structtagBWL.html#o2">phwndMax</a>);
00391                 RIPMSG1(RIP_WARNING, <span class="stringliteral">"InternalBuildHwndList: failed to expand BWL in enumerating children. pbwl=%#p"</span>, pbwl);
00392                 <span class="keywordflow">break</span>;
00393             }
00394             UserAssert(pbwl-&gt;<a class="code" href="../../d4/d9/structtagBWL.html#o1">phwndNext</a> &lt; pbwl-&gt;<a class="code" href="../../d4/d9/structtagBWL.html#o2">phwndMax</a>);
00395         }
00396 
00397         <span class="comment">/*</span>
00398 <span class="comment">         * Are we enumerating only one window?</span>
00399 <span class="comment">         */</span>
00400         <span class="keywordflow">if</span> (!(flags &amp; <a class="code" href="../../d4/d1/userk_8h.html#a410">BWL_ENUMLIST</a>))
00401             <span class="keywordflow">break</span>;
00402 
00403         pwnd = pwnd-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o2">spwndNext</a>;
00404     }
00405 
00406     <span class="keywordflow">return</span> pbwl;
00407 }
00408 
00409 
00410 <span class="comment">/***************************************************************************\</span>
00411 <span class="comment">* FreeHwndList</span>
00412 <span class="comment">*</span>
00413 <span class="comment">* History:</span>
00414 <span class="comment">* 10-20-90 darrinm      Ported from Win 3.0 sources.</span>
00415 <span class="comment">\***************************************************************************/</span>
00416 
<a name="l00417"></a><a class="code" href="../../d4/d1/userk_8h.html#a1158">00417</a> <span class="keywordtype">void</span> <a class="code" href="../../d4/d1/userk_8h.html#a1158">FreeHwndList</a>(
00418     <a class="code" href="../../d4/d9/structtagBWL.html">PBWL</a> pbwl)
00419 {
00420     <a class="code" href="../../d4/d9/structtagBWL.html">PBWL</a> *ppbwl;
00421     <a class="code" href="../../d4/d9/structtagBWL.html">PBWL</a> pbwlT;
00422 
00423     <a class="code" href="../../d4/d1/userk_8h.html#a154">CheckCritIn</a>();
00424 
00425     <span class="comment">/*</span>
00426 <span class="comment">     * We should never have an active bwl that is the free cached bwl</span>
00427 <span class="comment">     */</span>
00428     UserAssert(pbwl != <a class="code" href="../../d4/d7/enumwin_8c.html#a2">pbwlCache</a>);
00429 
00430     <span class="comment">/*</span>
00431 <span class="comment">     * Unlink this bwl from the list.</span>
00432 <span class="comment">     */</span>
00433     <span class="keywordflow">for</span> (ppbwl = &amp;<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a99">gpbwlList</a>; *ppbwl != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; ppbwl = &amp;(*ppbwl)-&gt;<a class="code" href="../../d4/d9/structtagBWL.html#o0">pbwlNext</a>) {
00434         <span class="keywordflow">if</span> (*ppbwl == pbwl) {
00435             *ppbwl = pbwl-&gt;<a class="code" href="../../d4/d9/structtagBWL.html#o0">pbwlNext</a>;
00436 
00437             <span class="comment">/*</span>
00438 <span class="comment">             * If the cache is empty or this pbwl is larger than the</span>
00439 <span class="comment">             * cached one, save the pbwl there.</span>
00440 <span class="comment">             */</span>
00441             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d7/enumwin_8c.html#a2">pbwlCache</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00442                 <a class="code" href="../../d4/d7/enumwin_8c.html#a2">pbwlCache</a> = pbwl;
00443             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((pbwl-&gt;<a class="code" href="../../d4/d9/structtagBWL.html#o2">phwndMax</a> - pbwl-&gt;<a class="code" href="../../d4/d9/structtagBWL.html#o4">rghwnd</a>) &gt;
00444                        (<a class="code" href="../../d4/d7/enumwin_8c.html#a2">pbwlCache</a>-&gt;<a class="code" href="../../d4/d9/structtagBWL.html#o2">phwndMax</a> - <a class="code" href="../../d4/d7/enumwin_8c.html#a2">pbwlCache</a>-&gt;<a class="code" href="../../d4/d9/structtagBWL.html#o4">rghwnd</a>)) {
00445                 pbwlT = <a class="code" href="../../d4/d7/enumwin_8c.html#a2">pbwlCache</a>;
00446                 <a class="code" href="../../d4/d7/enumwin_8c.html#a2">pbwlCache</a> = pbwl;
00447                 UserFreePool((HANDLE)pbwlT);
00448             } <span class="keywordflow">else</span> {
00449                 UserFreePool((HANDLE)pbwl);
00450             }
00451             <span class="keywordflow">return</span>;
00452         }
00453     }
00454 
00455     <span class="comment">/*</span>
00456 <span class="comment">     * Assert if we couldn't find the pbwl in the list...</span>
00457 <span class="comment">     */</span>
00458     UserAssert(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00459 }
00460 
00461 <span class="preprocessor">#ifdef FE_IME</span>
00462 <span class="preprocessor"></span>
00463 <a class="code" href="../../d4/d9/structtagBWL.html">PBWL</a> InternalRebuildHwndListForIMEClass(
00464     <a class="code" href="../../d4/d9/structtagBWL.html">PBWL</a> pbwl,
00465     BOOL fRemoveChild)
00466 {
00467     <a class="code" href="../../d4/d1/userk_8h.html#a944">PHWND</a> phwndIME, phwndIMECur, phwnd, phwndCur;
00468     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwSize = (<a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> *)pbwl-&gt;<a class="code" href="../../d4/d9/structtagBWL.html#o2">phwndMax</a> - (<a class="code" href="../../d9/d7/halvprnt_8c.html#a0">BYTE</a> *)pbwl) + <span class="keyword">sizeof</span>(HWND);
00469 
00470     phwndIMECur = phwndIME = (<a class="code" href="../../d4/d1/userk_8h.html#a944">PHWND</a>)UserAllocPool(dwSize, TAG_WINDOWLIST);
00471     <span class="keywordflow">if</span> (phwndIME == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00472         RIPMSG0(RIP_WARNING, <span class="stringliteral">"RebuildHwndListForIMEClass: invalid phwndIME"</span>);
00473         <span class="keywordflow">return</span> pbwl;
00474     }
00475 
00476     phwndCur = pbwl-&gt;<a class="code" href="../../d4/d9/structtagBWL.html#o4">rghwnd</a>;
00477 
00478     <span class="keywordflow">for</span> (phwnd = pbwl-&gt;<a class="code" href="../../d4/d9/structtagBWL.html#o4">rghwnd</a>; *phwnd != (HWND)1; phwnd++) {
00479         <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwndIMEOwner;
00480 
00481         <span class="comment">// Find the IME class or CS_IME window in the owners of hwnd.</span>
00482         <span class="comment">// When fRemoveChild is TRUE, we want IME class window as the return</span>
00483         <span class="comment">// of InternalGetIMEOwner.</span>
00484         <span class="keywordflow">if</span> (pwndIMEOwner = InternalGetIMEOwner(*phwnd, fRemoveChild)) {
00485             <span class="keywordflow">try</span> {
00486                 <span class="keywordflow">if</span> (!fRemoveChild ||
00487                     (pwndIMEOwner-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o9">pcls</a>-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o1">atomClassName</a> == <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o12">atomSysClass</a>[<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a89">ICLS_IME</a>] &amp;&amp;
00488                       ((<a class="code" href="../../d5/d8/structtagIMEWND.html">PIMEWND</a>)pwndIMEOwner)-&gt;pimeui != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp;
00489                      !<a class="code" href="../../d5/d8/ex_8h.html#a27">ProbeAndReadStructure</a>(((<a class="code" href="../../d5/d8/structtagIMEWND.html">PIMEWND</a>)pwndIMEOwner)-&gt;pimeui, <a class="code" href="../../d4/d8/structtagIMEUI.html">IMEUI</a>).fChildThreadDef))
00490                 {
00491                     *phwndIMECur++ = *phwnd;
00492                 }
00493             } except (W32ExceptionHandler(FALSE, RIP_WARNING)) {
00494             }
00495         } <span class="keywordflow">else</span> {
00496             *phwndCur++ = *phwnd;
00497         }
00498     }
00499 
00500     <span class="comment">// Here NULL s used as terminator.</span>
00501     *phwndIMECur = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00502 
00503     phwndIMECur = phwndIME;
00504     <span class="keywordflow">while</span>(*phwndIMECur != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00505         *phwndCur++ = *phwndIMECur++;
00506 
00507     <span class="keywordflow">if</span> (*phwndCur != (HWND)1) {
00508         RIPMSG0(RIP_WARNING, <span class="stringliteral">"RebuildHwndListForIMEClass: Where is terminator?"</span>);
00509         *phwndCur = (HWND)1;
00510     }
00511 
00512     UserFreePool((HANDLE)phwndIME);
00513     <span class="keywordflow">return</span> pbwl;
00514 }
00515 
00516 <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> InternalGetIMEOwner(
00517     HWND hwnd,
00518     BOOL fRetIMEWnd)
00519 {
00520     <a class="code" href="../../d6/d9/structtagWND.html">PWND</a> pwnd, pwndT, pwndIME;
00521 
00522     pwnd = <a class="code" href="../../d6/d0/usercli_8h.html#a21">RevalidateHwnd</a>(hwnd);
00523     <span class="keywordflow">if</span> (pwnd == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00524         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00525 
00526     <span class="keywordflow">for</span> (pwndT = pwnd; pwndT != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; pwndT = pwndT-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o5">spwndOwner</a>) {
00527         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a485">TestCF</a>(pwndT,CFIME) ||
00528                 pwndT-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o9">pcls</a>-&gt;<a class="code" href="../../d7/d0/structtagCLS.html#o1">atomClassName</a> == <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o12">atomSysClass</a>[<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a89">ICLS_IME</a>]) {
00529 
00530             <span class="keywordflow">if</span> (!fRetIMEWnd)
00531                 <span class="keywordflow">return</span> pwndT;
00532 
00533             pwndIME = pwndT;
00534 
00535             <span class="keywordflow">while</span> (pwndT &amp;&amp; (pwndT-&gt;pcls-&gt;atomClassName != <a class="code" href="../../d1/d8/clglobal_8c.html#a4">gpsi</a>-&gt;<a class="code" href="../../d2/d6/structtagSERVERINFO.html#o12">atomSysClass</a>[<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a89">ICLS_IME</a>]))
00536                 pwndT = pwndT-&gt;<a class="code" href="../../d6/d9/structtagWND.html#o5">spwndOwner</a>;
00537 
00538             <span class="keywordflow">if</span> (pwndT)
00539                 pwndIME = pwndT;
00540             <span class="keywordflow">else</span>
00541                 RIPMSG0(RIP_WARNING, <span class="stringliteral">"Can't find IME Class window"</span>);
00542 
00543             <span class="keywordflow">return</span> pwndIME;
00544         }
00545     }
00546 
00547     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00548 }
00549 
00550 <span class="preprocessor">#endif</span>
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:56 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
