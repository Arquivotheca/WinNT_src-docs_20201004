<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: altperm.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>altperm.c</h1><a href="../../d4/d7/altperm_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Module Name:</span>
00004 <span class="comment"></span>
00005 <span class="comment">    altperm.c</span>
00006 <span class="comment"></span>
00007 <span class="comment">Abstract:</span>
00008 <span class="comment"></span>
00009 <span class="comment">    This module contains the routines needed to implement 4K pages on IA64</span>
00010 <span class="comment"></span>
00011 <span class="comment">    The idea is for an alternate set of permissions be kept that are on</span>
00012 <span class="comment">    4K boundaries. Permissions are kept for all memory, not just split pages</span>
00013 <span class="comment">    and the information is updated on any call to NtVirtualProtect()</span>
00014 <span class="comment">    and NtVirtualAllocate().</span>
00015 <span class="comment"></span>
00016 <span class="comment"></span>
00017 <span class="comment">Author:</span>
00018 <span class="comment"></span>
00019 <span class="comment">    ky 18-Aug-98</span>
00020 <span class="comment"></span>
00021 <span class="comment">Revision History:</span>
00022 <span class="comment"></span>
00023 <span class="comment"></span>
00024 <span class="comment">--*/</span>
00025 
00026 <span class="preprocessor">#include "<a class="code" href="../../d4/d8/mi_8h.html">mi.h</a>"</span>
00027 
<a name="l00028"></a><a class="code" href="../../d4/d7/altperm_8c.html#a0">00028</a> <span class="keyword">extern</span> ULONG <a class="code" href="../../d3/d6/allocvm_8c.html#a0">MMVADKEY</a>;
00029 
00030 <span class="preprocessor">#if defined(_MIALT4K_)</span>
00031 <span class="preprocessor"></span>
00032 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00033 MiCheckPoint(ULONG Number);
00034 
00035 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00036 MiCheckPointBreak(VOID);
00037 
00038 
00039 ULONG MmCheckPointNumber = 100;
00040 PVOID MmAddressBreak = (PVOID)0x7ecd0000;
00041 LOGICAL _MiMakeRtlBoot = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00042 
00043 ULONG
00044 MiFindProtectionForNativePte( 
00045     PVOID VirtualAddress
00046     );
00047 
00048 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00049 MiFillZeroFor4kPage (
00050     IN PVOID BaseAddress,
00051     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process
00052     );
00053 
00054 MiCheckPointBreakVirtualAddress (
00055     PVOID VirtualAddress
00056 );
00057 
00058 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00059 MiResetAccessBitForNativePtes(
00060     IN PVOID StartVirtual,
00061     IN PVOID EndVirtual,
00062     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process
00063     );
00064 
00065 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00066 <a class="code" href="../../d3/d5/mapview_8c.html#a24">MiMapViewOfDataSection</a> (
00067     IN <a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a> ControlArea,
00068     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process,
00069     IN PVOID *CapturedBase,
00070     IN PLARGE_INTEGER SectionOffset,
00071     IN PSIZE_T CapturedViewSize,
00072     IN <a class="code" href="../../d5/d3/parseini_8c.html#a2">PSECTION</a> Section,
00073     IN SECTION_INHERIT InheritDisposition,
00074     IN ULONG ProtectionMask,
00075     IN SIZE_T CommitSize,
00076     IN ULONG_PTR ZeroBits,
00077     IN ULONG AllocationType,
00078     OUT PBOOLEAN ReleasedWsMutex
00079     );
00080 
00081 BOOLEAN
00082 MiIsSplitPage(
00083     IN PVOID Virtual
00084     );
00085 
00086 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00087 MiCopyOnWriteFor4kPage(
00088     PVOID VirtualAddress,
00089     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process
00090     
00091     );
00092 
00093 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00094 MiCheckDemandZeroCopyOnWriteFor4kPage(
00095     PVOID VirtualAddress,
00096     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process
00097     );
00098 
00099 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00100 MiCheckVirtualAddressFor4kPage(
00101     PVOID VirtualAddress,
00102     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process
00103     );
00104 
00105 <a class="code" href="../../d2/d9/miia64_8h.html#a302">MmX86Fault</a> (
00106     IN BOOLEAN StoreInstruction,
00107     IN PVOID VirtualAddress, 
00108     IN KPROCESSOR_MODE PreviousMode,
00109     IN PVOID TrapInformation
00110     )
00111 
00112 <span class="comment">/*++</span>
00113 <span class="comment"></span>
00114 <span class="comment">Routine Description:</span>
00115 <span class="comment"></span>
00116 <span class="comment">    This function is called by the kernel on data or instruction</span>
00117 <span class="comment">    access faults if CurrentProcess-&gt;Vm.u.Flags.AltPerm is set. </span>
00118 <span class="comment"></span>
00119 <span class="comment">    This routine determines what type of fault by checking the alternate</span>
00120 <span class="comment">    4Kb granular page table and calls MmAccessFault() if necessary to </span>
00121 <span class="comment">    handle the page fault or the write fault.</span>
00122 <span class="comment"></span>
00123 <span class="comment">Arguments:</span>
00124 <span class="comment"></span>
00125 <span class="comment">    StoreInstruction - Supplies TRUE (1) if the operation causes a write into</span>
00126 <span class="comment">                       memory.  Note this value must be 1 or 0.</span>
00127 <span class="comment"></span>
00128 <span class="comment">    VirtualAddress - Supplies the virtual address which caused the fault.</span>
00129 <span class="comment"></span>
00130 <span class="comment">    PreviousMode - Supplies the mode (kernel or user) in which the fault</span>
00131 <span class="comment">                   occurred.</span>
00132 <span class="comment"></span>
00133 <span class="comment">    TrapInformation - Opaque information about the trap, interpreted by the</span>
00134 <span class="comment">                      kernel, not Mm.  Needed to allow fast interlocked access</span>
00135 <span class="comment">                      to operate correctly.</span>
00136 <span class="comment"></span>
00137 <span class="comment">Return Value:</span>
00138 <span class="comment"></span>
00139 <span class="comment">    Returns the status of the fault handling operation.  Can be one of:</span>
00140 <span class="comment">        - Success.</span>
00141 <span class="comment">        - Access Violation.</span>
00142 <span class="comment">        - Guard Page Violation.</span>
00143 <span class="comment">        - In-page Error.</span>
00144 <span class="comment"></span>
00145 <span class="comment">Environment:</span>
00146 <span class="comment"></span>
00147 <span class="comment">    Kernel mode, APCs disabled.</span>
00148 <span class="comment"></span>
00149 <span class="comment">--*/</span>
00150 
00151 {
00152     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerAltPte;
00153     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> AltPteContents;
00154     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> PteContents;
00155     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
00156     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPde;
00157     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPpe;
00158     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerProtoPte = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00159     ULONG ProtectCode;
00160     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
00161     ULONG NewPteProtection = 0;
00162     ULONG AteProtection;
00163     LOGICAL ExecutionFault = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00164     LOGICAL FillZero = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00165     LOGICAL SetNewProtection = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00166     LOGICAL PageIsSplit = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00167     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> CurrentProcess;
00168     <a class="code" href="../../d8/d9/struct__WOW64__PROCESS.html">PWOW64_PROCESS</a> Wow64Process;
00169     KIRQL PreviousIrql;
00170     KIRQL OldIrql;
00171     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00172     <a class="code" href="../../d4/d2/struct__MMINPAGE__SUPPORT.html">PMMINPAGE_SUPPORT</a> ReadBlock;
00173     ULONG Waited;
00174     ULONG OriginalProtection;
00175     ULONGLONG ProtectionMaskOriginal;
00176     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> ProtoPte;
00177     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
00178     ULONG i;
00179 
00180     <span class="comment">//</span>
00181     <span class="comment">// debug checking</span>
00182     <span class="comment">//</span>
00183 
00184     MiCheckPointBreakVirtualAddress (VirtualAddress);
00185 
00186     PreviousIrql = KeGetCurrentIrql ();
00187     
00188     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PreviousIrql &lt;= APC_LEVEL);
00189 
00190     CurrentProcess = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a> ();
00191 
00192     Wow64Process = CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o78">Wow64Process</a>;
00193 
00194     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (VirtualAddress &lt; (PVOID)_MAX_WOW64_ADDRESS);
00195 
00196     <span class="keywordflow">if</span> (StoreInstruction == 2) { 
00197         ExecutionFault = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00198         StoreInstruction = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00199     }
00200 
00201     <span class="comment">//</span>
00202     <span class="comment">// lock the alternate table and this also blocks APCs.</span>
00203     <span class="comment">//</span>
00204 
00205     <a class="code" href="../../d2/d9/miia64_8h.html#a262">LOCK_ALTERNATE_TABLE</a> (Wow64Process);
00206 
00207     <span class="comment">//</span>
00208     <span class="comment">// check to see if the protection is registered in the alternate entry</span>
00209     <span class="comment">//</span>
00210 
00211     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a167">MI_CHECK_BIT</a>(Wow64Process-&gt;AltPermBitmap, 
00212                      <a class="code" href="../../d4/d8/mi_8h.html#a107">MI_VA_TO_VPN</a>(VirtualAddress)) == 0) { 
00213 
00214         MiCheckVirtualAddressFor4kPage(VirtualAddress, CurrentProcess);
00215 
00216     }
00217 
00218     <span class="comment">//</span>
00219     <span class="comment">// </span>
00220     <span class="comment">//</span>
00221 
00222     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(VirtualAddress);
00223     PointerAltPte = <a class="code" href="../../d2/d9/miia64_8h.html#a238">MiGetAltPteAddress</a>(VirtualAddress);
00224 
00225     <span class="comment">//</span>
00226     <span class="comment">// read alternate PTE contents</span>
00227     <span class="comment">//</span>
00228 
00229     AltPteContents = *PointerAltPte;
00230 
00231     <span class="comment">//</span>
00232     <span class="comment">// check to see if alternate entry is empty</span>
00233     <span class="comment">//</span>
00234 
00235     <span class="keywordflow">if</span> (AltPteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == 0) {
00236 
00237         MiCheckPoint(10);
00238 
00239         <span class="comment">//</span>
00240         <span class="comment">// if empty, get the protection info from OS and fill the entry</span>
00241         <span class="comment">//</span>
00242 
00243         <a class="code" href="../../d4/d8/mi_8h.html#a154">LOCK_WS</a> (CurrentProcess);
00244 
00245         ProtoPte = <a class="code" href="../../d8/d2/pagfault_8c.html#a19">MiCheckVirtualAddress</a> (VirtualAddress, &amp;OriginalProtection);
00246 
00247         <span class="keywordflow">if</span> (OriginalProtection == <a class="code" href="../../d4/d8/mi_8h.html#a47">MM_UNKNOWN_PROTECTION</a>) {
00248 
00249             <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a178">MI_IS_PHYSICAL_ADDRESS</a>(ProtoPte)) {
00250                 PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (ProtoPte);
00251                 <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00252                 <span class="keywordflow">if</span> (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) {
00253                     <a class="code" href="../../d0/d2/mmsup_8c.html#a11">MiMakeSystemAddressValidPfn</a> (ProtoPte);
00254                 }
00255                 Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber);
00256                 Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount += 1;
00257                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount &gt; 1);
00258                 <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00259             }
00260 
00261             OriginalProtection = 
00262                 <a class="code" href="../../d0/d2/mmsup_8c.html#a5">MiMakeProtectionMask</a>(<a class="code" href="../../d0/d9/protect_8c.html#a7">MiGetPageProtection</a>(ProtoPte, CurrentProcess));
00263 
00264             <span class="comment">//</span>
00265             <span class="comment">// Unlock page containing prototype PTEs.</span>
00266             <span class="comment">//</span>
00267 
00268             <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a178">MI_IS_PHYSICAL_ADDRESS</a>(ProtoPte)) {
00269                 <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
00270                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount &gt; 1);
00271                 Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount -= 1;
00272                 <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
00273             }
00274         }
00275         
00276         <a class="code" href="../../d4/d8/mi_8h.html#a158">UNLOCK_WS</a> (CurrentProcess);
00277 
00278         <span class="keywordflow">if</span> (OriginalProtection != <a class="code" href="../../d4/d8/mi_8h.html#a46">MM_NOACCESS</a>) {
00279 
00280             ProtectionMaskOriginal = <a class="code" href="../../d2/d9/miia64_8h.html#a258">MiMakeProtectionAteMask</a> (OriginalProtection);
00281             ProtectionMaskOriginal |= <a class="code" href="../../d2/d9/miia64_8h.html#a243">MM_ATE_COMMIT</a>;
00282 
00283             AltPteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = ProtectionMaskOriginal;
00284             AltPteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Alt.Protection = OriginalProtection;
00285 
00286             <span class="comment">//</span>
00287             <span class="comment">// atomic PTE update</span>
00288             <span class="comment">//</span>
00289 
00290             PointerAltPte-&gt;u.Long = AltPteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long;
00291         }
00292     } 
00293 
00294     <span class="keywordflow">if</span> (AltPteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Alt.NoAccess != 0) {
00295 
00296         <span class="comment">//</span>
00297         <span class="comment">// this 4KB page is no access</span>
00298         <span class="comment">//</span>
00299 
00300         status = STATUS_ACCESS_VIOLATION;
00301         
00302         <span class="keywordflow">goto</span> return_status;
00303 
00304     }
00305     
00306     <span class="keywordflow">if</span> (AltPteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Alt.PteIndirect != 0) {
00307 
00308         MiCheckPoint(3);
00309 
00310         <span class="comment">//</span>
00311         <span class="comment">// make PPE and PDE exist and valid</span>
00312         <span class="comment">//</span>
00313 
00314         PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a>(VirtualAddress);
00315         PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a150">MiGetPpeAddress</a>(VirtualAddress);
00316 
00317         <span class="comment">//</span>
00318         <span class="comment">// make the page table for the original PTE exit to satisfy </span>
00319         <span class="comment">// the TLB forward progress for the TLB indirect fault</span>
00320         <span class="comment">// </span>
00321 
00322         <a class="code" href="../../d4/d8/mi_8h.html#a154">LOCK_WS</a> (CurrentProcess);
00323 
00324         (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>)<a class="code" href="../../d4/d8/mi_8h.html#a245">MiMakePpeExistAndMakeValid</a> (PointerPpe,
00325                                           CurrentProcess,
00326                                           FALSE);
00327     
00328         (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>)<a class="code" href="../../d0/d2/mmsup_8c.html#a7">MiMakePdeExistAndMakeValid</a> (PointerPde,
00329                                           CurrentProcess,
00330                                           FALSE);
00331 
00332         <a class="code" href="../../d4/d8/mi_8h.html#a158">UNLOCK_WS</a> (CurrentProcess);
00333 
00334         PointerPte = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)(AltPteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Alt.PteOffset + PTE_UBASE);
00335 
00336         VirtualAddress = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a>(PointerPte);
00337 
00338         <span class="keywordflow">goto</span> Check_Pte;
00339 
00340     }
00341         
00342     <span class="keywordflow">if</span> ((_MiMakeRtlBoot == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) &amp;&amp; (AltPteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Alt.Commit == 0)) {
00343       
00344         <span class="comment">//</span>
00345         <span class="comment">// This is supposed to be an access to an uncommmitted page and should </span>
00346         <span class="comment">// result in STATUS_ACCESS_VIOLATION.  As long as we test in IA64, </span>
00347         <span class="comment">// we cannot make a fault here. Some code assume PAGE_SIZE is given at least </span>
00348         <span class="comment">// for commitment.</span>
00349         <span class="comment">// </span>
00350 
00351         MiCheckPoint(0);
00352 
00353         PointerAltPte-&gt;u.Alt.Commit = 1;
00354 
00355         AltPteContents = *PointerAltPte;
00356 
00357     }
00358 
00359     <span class="keywordflow">if</span> (AltPteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Alt.Commit == 0) {
00360         
00361         <span class="comment">//</span>
00362         <span class="comment">// if the page is no commit, return as STATUS_ACCESS_VIOLATION.</span>
00363         <span class="comment">//</span>
00364 
00365         status = STATUS_ACCESS_VIOLATION;
00366 
00367         <span class="keywordflow">goto</span> return_status;
00368 
00369     }
00370 
00371     <span class="comment">//</span>
00372     <span class="comment">// check to see if the faulting page is split to 4k pages</span>
00373     <span class="comment">//</span>
00374 
00375     PageIsSplit = MiIsSplitPage(VirtualAddress);
00376 
00377     <span class="comment">//</span>
00378     <span class="comment">// get a real protection for the native PTE</span>
00379     <span class="comment">//</span>
00380 
00381     NewPteProtection = MiFindProtectionForNativePte (VirtualAddress);
00382 
00383 Check_Pte:
00384 
00385     <span class="comment">//</span>
00386     <span class="comment">// Block APCs and acquire the working set lock.</span>
00387     <span class="comment">//</span>
00388 
00389     <a class="code" href="../../d4/d8/mi_8h.html#a154">LOCK_WS</a> (CurrentProcess);
00390 
00391     <span class="comment">//</span>
00392     <span class="comment">// make PPE and PDE exist and valid</span>
00393     <span class="comment">//</span>
00394 
00395     PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a>(VirtualAddress);
00396     PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a150">MiGetPpeAddress</a>(VirtualAddress);
00397 
00398     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a168">MiDoesPpeExistAndMakeValid</a> (PointerPpe,
00399                                     CurrentProcess,
00400                                     FALSE,
00401                                     &amp;Waited) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00402         PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = 0;
00403     
00404     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d0/d2/mmsup_8c.html#a6">MiDoesPdeExistAndMakeValid</a> (PointerPde,
00405                                            CurrentProcess,
00406                                            FALSE,
00407                                            &amp;Waited) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00408 
00409         PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = 0;
00410 
00411     } <span class="keywordflow">else</span> {
00412 
00413         <span class="comment">//</span>
00414         <span class="comment">// if it is safe to read PointerPte</span>
00415         <span class="comment">//</span>
00416 
00417         PteContents = *PointerPte;
00418 
00419     }
00420 
00421     <span class="comment">//</span>
00422     <span class="comment">// Check to see if the protection for the native page should be set</span>
00423     <span class="comment">// and if the access-bit of the PTE should be set.</span>
00424     <span class="comment">//</span>
00425 
00426     <span class="keywordflow">if</span> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid != 0) { 
00427 
00428         TempPte = PteContents;
00429 
00430         <span class="comment">//</span>
00431         <span class="comment">// perfom PTE protection mask corrections</span>
00432         <span class="comment">//</span>
00433 
00434         TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long |= NewPteProtection;
00435 
00436         <span class="keywordflow">if</span> (PteContents.u.Hard.Accessed == 0) {
00437 
00438             TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Accessed = 1;
00439 
00440             <span class="keywordflow">if</span> (PageIsSplit == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00441 
00442                 TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Cache = <a class="code" href="../../d2/d9/miia64_8h.html#a77">MM_PTE_CACHE_RESERVED</a>;
00443 
00444             } 
00445         }
00446 
00447         <span class="comment">//</span>
00448         <span class="comment">// if the private page has been assigned to COW, remove the COW bit</span>
00449         <span class="comment">//</span>
00450 
00451         <span class="keywordflow">if</span> ((TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.CopyOnWrite != 0) &amp;&amp; (PteContents.u.Hard.Write != 0)) { 
00452 
00453             TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.CopyOnWrite = 0;
00454             
00455         }
00456 
00457         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a188">MI_WRITE_VALID_PTE_NEW_PROTECTION</a>(PointerPte, TempPte); 
00458     }
00459 
00460     <a class="code" href="../../d4/d8/mi_8h.html#a158">UNLOCK_WS</a> (CurrentProcess);
00461     
00462     <span class="comment">//</span>
00463     <span class="comment">// faulting 4kb page must be a valid page, but we need to resolve it </span>
00464     <span class="comment">// case by case.</span>
00465     <span class="comment">//</span>
00466 
00467     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (AltPteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long != 0);
00468     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (AltPteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Alt.Commit != 0);
00469         
00470     <span class="keywordflow">if</span> (AltPteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Alt.Accessed == 0) {
00471 
00472         <span class="comment">//</span>
00473         <span class="comment">// When PointerAte-&gt;u.Hard.Accessed is zero, there are the following 4 cases:</span>
00474         <span class="comment">// </span>
00475         <span class="comment">//  1. Lowest Protection </span>
00476         <span class="comment">//  2. 4kb Demand Zero </span>
00477         <span class="comment">//  3. GUARD page fault</span>
00478         <span class="comment">//  4. this 4kb page is no access, but the other 4K page(s) within a native page </span>
00479         <span class="comment">//     has accessible permission.</span>
00480         <span class="comment">//</span>
00481 
00482         <span class="keywordflow">if</span> (AltPteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Alt.FillZero != 0) {
00483 
00484             <span class="comment">//</span>
00485             <span class="comment">// schedule it later</span>
00486             <span class="comment">//</span>
00487 
00488             FillZero = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00489             
00490         } 
00491 
00492         <span class="keywordflow">if</span> ((AltPteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Alt.Protection &amp; <a class="code" href="../../d4/d8/mi_8h.html#a44">MM_GUARD_PAGE</a>) != 0) {
00493         
00494             MiCheckPoint(5);
00495 
00496             <span class="comment">//</span>
00497             <span class="comment">// if 4k page is guard page then call MmAccessFault() to handle the faults</span>
00498             <span class="comment">//</span>
00499         
00500             <span class="keywordflow">if</span> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) {
00501 
00502                 <a class="code" href="../../d2/d9/miia64_8h.html#a263">UNLOCK_ALTERNATE_TABLE</a> (Wow64Process);
00503 
00504                 <span class="comment">//</span>
00505                 <span class="comment">// Let MmAccessFault() perform a page-in, dirty-bit setting, etc.</span>
00506                 <span class="comment">//</span>
00507 
00508                 status = <a class="code" href="../../d4/d1/mmfault_8c.html#a2">MmAccessFault</a> (StoreInstruction,
00509                                         VirtualAddress,
00510                                         PreviousMode,
00511                                         TrapInformation);
00512 
00513                 <a class="code" href="../../d2/d9/miia64_8h.html#a262">LOCK_ALTERNATE_TABLE</a> (Wow64Process);
00514 
00515                 <span class="keywordflow">if</span> (status == STATUS_PAGE_FAULT_GUARD_PAGE) {
00516                     
00517                     PointerAltPte = <a class="code" href="../../d2/d9/miia64_8h.html#a238">MiGetAltPteAddress</a>(<a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a>(VirtualAddress));
00518                 
00519                     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d2/d9/miia64_8h.html#a234">SPLITS_PER_PAGE</a>; i += 1) {
00520                     
00521                         AltPteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = PointerAltPte-&gt;u.Long;
00522 
00523                         <span class="keywordflow">if</span> ((AltPteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Alt.Protection &amp; <a class="code" href="../../d4/d8/mi_8h.html#a44">MM_GUARD_PAGE</a>) != 0) {
00524 
00525                             AltPteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Alt.Protection &amp;= ~<a class="code" href="../../d4/d8/mi_8h.html#a44">MM_GUARD_PAGE</a>;
00526                             AltPteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Alt.Accessed = 1;
00527                             PointerAltPte-&gt;u.Long = AltPteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long;
00528 
00529                         }
00530 
00531                         PointerAltPte += 1;
00532 
00533                     } 
00534                     
00535                     <span class="keywordflow">goto</span> return_status;
00536                 }
00537 
00538             }
00539 
00540             AltPteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Alt.Protection &amp;= ~<a class="code" href="../../d4/d8/mi_8h.html#a44">MM_GUARD_PAGE</a>;
00541             AltPteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Alt.Accessed = 1;
00542 
00543             PointerAltPte-&gt;u.Long = AltPteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long;
00544 
00545             status =  STATUS_GUARD_PAGE_VIOLATION;           
00546 
00547             <span class="keywordflow">goto</span> return_status;
00548 
00549         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (FillZero == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00550 
00551             <span class="comment">//</span>
00552             <span class="comment">// this 4kb page has no access permission</span>
00553             <span class="comment">//</span>
00554 
00555             status = STATUS_ACCESS_VIOLATION;
00556             
00557             <span class="keywordflow">goto</span> return_status;
00558 
00559         }
00560     }
00561 
00562     <span class="keywordflow">if</span> (ExecutionFault == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00563         
00564         <span class="comment">//</span>
00565         <span class="comment">// As execute permission is already given to IA32 by setting it in </span>
00566         <span class="comment">// MI_MAKE_VALID_PTE().</span>
00567         <span class="comment">//</span>
00568 
00569     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (StoreInstruction == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00570         
00571         <span class="comment">//</span>
00572         <span class="comment">// Check to see if this is the copy-on-write page.</span>
00573         <span class="comment">//</span>
00574 
00575         <span class="keywordflow">if</span> (AltPteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Alt.CopyOnWrite != 0) {
00576 
00577 <span class="preprocessor">#if 0</span>
00578 <span class="preprocessor"></span>            MiCheckDemandZeroCopyOnWriteFor4kPage(VirtualAddress, CurrentProcess);
00579 <span class="preprocessor">#endif</span>
00580 <span class="preprocessor"></span>            <span class="comment">//</span>
00581             <span class="comment">// let MmAccessFault() perform a copy-on-write</span>
00582             <span class="comment">//</span>
00583 
00584             status = <a class="code" href="../../d4/d1/mmfault_8c.html#a2">MmAccessFault</a> (StoreInstruction,
00585                                     VirtualAddress,
00586                                     PreviousMode,
00587                                     TrapInformation);
00588 
00589 <span class="preprocessor">#if 0</span>
00590 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid != 0) {
00591                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"copyonwrite original page = %p, %p\n"</span>, VirtualAddress, PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long);
00592             }
00593 <span class="preprocessor">#endif</span>
00594 <span class="preprocessor"></span>
00595             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00596 
00597                 MiCheckPointBreak();
00598                 <span class="keywordflow">goto</span> return_status;
00599                 
00600             }
00601 
00602             <span class="keywordflow">if</span> (status == STATUS_PAGE_FAULT_COPY_ON_WRITE) {
00603                 MiCopyOnWriteFor4kPage(VirtualAddress, CurrentProcess);
00604             } <span class="keywordflow">else</span> {
00605                 MiCheckPointBreak();
00606             }
00607             
00608             <span class="comment">//</span>
00609             <span class="comment">// write debug code to check the consistency</span>
00610             <span class="comment">//</span>
00611 
00612             status = STATUS_SUCCESS;
00613 
00614             <span class="keywordflow">goto</span> return_status;
00615         }
00616             
00617         <span class="keywordflow">if</span> (AltPteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Write == 0) {
00618 
00619             status = STATUS_ACCESS_VIOLATION;
00620             
00621             <span class="keywordflow">goto</span> return_status;
00622         }
00623 
00624     }
00625 
00626     <span class="comment">//</span>
00627     <span class="comment">// Let MmAccessFault() perform a page-in, dirty-bit setting, etc.</span>
00628     <span class="comment">//</span>
00629 
00630     <a class="code" href="../../d2/d9/miia64_8h.html#a263">UNLOCK_ALTERNATE_TABLE</a> (Wow64Process);
00631     
00632     status = <a class="code" href="../../d4/d1/mmfault_8c.html#a2">MmAccessFault</a> (StoreInstruction,
00633                             VirtualAddress,
00634                             PreviousMode,
00635                             TrapInformation);
00636 
00637     <span class="keywordflow">if</span> ((status == STATUS_PAGE_FAULT_GUARD_PAGE) ||
00638         (status == STATUS_GUARD_PAGE_VIOLATION)) {
00639 
00640         <a class="code" href="../../d2/d9/miia64_8h.html#a262">LOCK_ALTERNATE_TABLE</a> (Wow64Process);
00641 
00642         AltPteContents = *PointerAltPte;
00643 
00644         <span class="keywordflow">if</span> ((AltPteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Alt.Protection &amp; <a class="code" href="../../d4/d8/mi_8h.html#a44">MM_GUARD_PAGE</a>) != 0) {
00645         
00646             AltPteContents = *PointerAltPte;
00647             AltPteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Alt.Protection &amp;= ~<a class="code" href="../../d4/d8/mi_8h.html#a44">MM_GUARD_PAGE</a>;
00648             AltPteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Alt.Accessed = 1;
00649         
00650             PointerAltPte-&gt;u.Long = AltPteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long;
00651 
00652         }
00653 
00654         <a class="code" href="../../d2/d9/miia64_8h.html#a263">UNLOCK_ALTERNATE_TABLE</a> (Wow64Process);
00655 
00656         <span class="keywordflow">if</span> (status == STATUS_GUARD_PAGE_VIOLATION) {
00657 
00658             status = STATUS_SUCCESS;
00659 
00660         }
00661 
00662     }
00663 
00664     <a class="code" href="../../d0/d0/ki_8h.html#a114">KiFlushSingleTb</a>(TRUE, VirtualAddress);
00665 
00666     <span class="keywordflow">if</span> (FillZero == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00667 
00668         MiFillZeroFor4kPage (VirtualAddress, CurrentProcess);
00669 
00670     }
00671 
00672     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00673 
00674         MiCheckPointBreak();
00675 
00676     } 
00677 
00678     <span class="keywordflow">return</span> status;
00679 
00680  return_status:
00681 
00682     <a class="code" href="../../d0/d0/ki_8h.html#a114">KiFlushSingleTb</a>(TRUE, VirtualAddress);
00683 
00684     <a class="code" href="../../d2/d9/miia64_8h.html#a263">UNLOCK_ALTERNATE_TABLE</a> (Wow64Process);
00685 
00686     <span class="keywordflow">if</span> (FillZero == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00687 
00688         MiFillZeroFor4kPage (VirtualAddress, CurrentProcess);
00689 
00690     }
00691 
00692     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00693 
00694         MiCheckPointBreak();
00695 
00696     } 
00697 
00698     <span class="keywordflow">return</span> status;
00699 }
00700 
00701 ULONG
00702 MiFindProtectionForNativePte( 
00703     PVOID VirtualAddress
00704     )
00705 
00706 <span class="comment">/*++</span>
00707 <span class="comment"></span>
00708 <span class="comment">Routine Description:</span>
00709 <span class="comment"></span>
00710 <span class="comment">    This function finds the protection for the native PTE</span>
00711 <span class="comment"></span>
00712 <span class="comment">Arguments:</span>
00713 <span class="comment"></span>
00714 <span class="comment">    VirtualAddress - Supplies a virtual address to be examined for the protection </span>
00715 <span class="comment">         of the PTE.</span>
00716 <span class="comment"></span>
00717 <span class="comment">Return Value:</span>
00718 <span class="comment"></span>
00719 <span class="comment">    none</span>
00720 <span class="comment"></span>
00721 <span class="comment">Environment:</span>
00722 <span class="comment"></span>
00723 <span class="comment"></span>
00724 <span class="comment">--*/</span>
00725 
00726 {
00727     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerAltPte;
00728     ULONG i;
00729     ULONG ProtectionCode = 0;
00730 
00731     PointerAltPte = <a class="code" href="../../d2/d9/miia64_8h.html#a238">MiGetAltPteAddress</a>(<a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a>(VirtualAddress));
00732     
00733     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d2/d9/miia64_8h.html#a234">SPLITS_PER_PAGE</a>; i++) {
00734 
00735         ProtectionCode |= (PointerAltPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long &amp; <a class="code" href="../../d2/d9/miia64_8h.html#a237">ALT_PROTECTION_MASK</a>);
00736 
00737         <span class="keywordflow">if</span> (PointerAltPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Alt.CopyOnWrite != 0) {
00738             ProtectionCode |= <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a78">MM_PTE_COPY_ON_WRITE_MASK</a>;
00739         }
00740 
00741         PointerAltPte += 1;
00742     }
00743 
00744     <span class="keywordflow">return</span> ProtectionCode;
00745 
00746 }
00747 
00748 
00749 <span class="comment">//</span>
00750 <span class="comment">// Define and initialize the protection convertion table for </span>
00751 <span class="comment">// Alternate Permision Table Entries.</span>
00752 <span class="comment">//</span>
00753 
00754 ULONGLONG <a class="code" href="../../d2/d9/miia64_8h.html#a299">MmProtectToAteMask</a>[32] = {
00755                        <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a80">MM_PTE_NOACCESS</a> | <a class="code" href="../../d2/d9/miia64_8h.html#a253">MM_ATE_NOACCESS</a>,
00756                        <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a85">MM_PTE_EXECUTE_READ</a> | <a class="code" href="../../d6/d8/mi386_8h.html#a77">MM_PTE_ACCESS_MASK</a>,
00757                        <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a85">MM_PTE_EXECUTE_READ</a> | <a class="code" href="../../d6/d8/mi386_8h.html#a77">MM_PTE_ACCESS_MASK</a>,
00758                        <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a85">MM_PTE_EXECUTE_READ</a> | <a class="code" href="../../d6/d8/mi386_8h.html#a77">MM_PTE_ACCESS_MASK</a>,
00759                        <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a86">MM_PTE_EXECUTE_READWRITE</a> | <a class="code" href="../../d6/d8/mi386_8h.html#a77">MM_PTE_ACCESS_MASK</a>,
00760                        <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a85">MM_PTE_EXECUTE_READ</a> | <a class="code" href="../../d6/d8/mi386_8h.html#a77">MM_PTE_ACCESS_MASK</a> | <a class="code" href="../../d2/d9/miia64_8h.html#a254">MM_ATE_COPY_ON_WRITE</a>,
00761                        <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a86">MM_PTE_EXECUTE_READWRITE</a> | <a class="code" href="../../d6/d8/mi386_8h.html#a77">MM_PTE_ACCESS_MASK</a>,
00762                        <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a85">MM_PTE_EXECUTE_READ</a> | <a class="code" href="../../d6/d8/mi386_8h.html#a77">MM_PTE_ACCESS_MASK</a> | <a class="code" href="../../d2/d9/miia64_8h.html#a254">MM_ATE_COPY_ON_WRITE</a>,
00763                        <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a80">MM_PTE_NOACCESS</a> | <a class="code" href="../../d2/d9/miia64_8h.html#a253">MM_ATE_NOACCESS</a>,
00764                        <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a85">MM_PTE_EXECUTE_READ</a> | <a class="code" href="../../d6/d8/mi386_8h.html#a77">MM_PTE_ACCESS_MASK</a>,
00765                        <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a85">MM_PTE_EXECUTE_READ</a> | <a class="code" href="../../d6/d8/mi386_8h.html#a77">MM_PTE_ACCESS_MASK</a>,
00766                        <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a85">MM_PTE_EXECUTE_READ</a> | <a class="code" href="../../d6/d8/mi386_8h.html#a77">MM_PTE_ACCESS_MASK</a>,
00767                        <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a86">MM_PTE_EXECUTE_READWRITE</a> | <a class="code" href="../../d6/d8/mi386_8h.html#a77">MM_PTE_ACCESS_MASK</a>,
00768                        <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a85">MM_PTE_EXECUTE_READ</a> | <a class="code" href="../../d6/d8/mi386_8h.html#a77">MM_PTE_ACCESS_MASK</a> | <a class="code" href="../../d2/d9/miia64_8h.html#a254">MM_ATE_COPY_ON_WRITE</a>,
00769                        <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a86">MM_PTE_EXECUTE_READWRITE</a> | <a class="code" href="../../d6/d8/mi386_8h.html#a77">MM_PTE_ACCESS_MASK</a>,
00770                        <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a85">MM_PTE_EXECUTE_READ</a> | <a class="code" href="../../d6/d8/mi386_8h.html#a77">MM_PTE_ACCESS_MASK</a> | <a class="code" href="../../d2/d9/miia64_8h.html#a254">MM_ATE_COPY_ON_WRITE</a>,
00771                        <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a80">MM_PTE_NOACCESS</a> | <a class="code" href="../../d2/d9/miia64_8h.html#a253">MM_ATE_NOACCESS</a>,
00772                        <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a85">MM_PTE_EXECUTE_READ</a>,
00773                        <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a85">MM_PTE_EXECUTE_READ</a>,
00774                        <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a85">MM_PTE_EXECUTE_READ</a>,
00775                        <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a86">MM_PTE_EXECUTE_READWRITE</a>,
00776                        <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a85">MM_PTE_EXECUTE_READ</a> | <a class="code" href="../../d2/d9/miia64_8h.html#a254">MM_ATE_COPY_ON_WRITE</a>,
00777                        <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a86">MM_PTE_EXECUTE_READWRITE</a>,
00778                        <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a85">MM_PTE_EXECUTE_READ</a> | <a class="code" href="../../d2/d9/miia64_8h.html#a254">MM_ATE_COPY_ON_WRITE</a>,
00779                        <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a80">MM_PTE_NOACCESS</a> | <a class="code" href="../../d2/d9/miia64_8h.html#a253">MM_ATE_NOACCESS</a>,
00780                        <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a85">MM_PTE_EXECUTE_READ</a>,
00781                        <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a85">MM_PTE_EXECUTE_READ</a>,
00782                        <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a85">MM_PTE_EXECUTE_READ</a>,
00783                        <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a86">MM_PTE_EXECUTE_READWRITE</a>,
00784                        <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a85">MM_PTE_EXECUTE_READ</a> | <a class="code" href="../../d2/d9/miia64_8h.html#a254">MM_ATE_COPY_ON_WRITE</a>,
00785                        <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a86">MM_PTE_EXECUTE_READWRITE</a>,
00786                        <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a85">MM_PTE_EXECUTE_READ</a> | <a class="code" href="../../d2/d9/miia64_8h.html#a254">MM_ATE_COPY_ON_WRITE</a>
00787                     };
00788 
00789 <span class="preprocessor">#define MiMakeProtectionAteMask(NewProtect) MmProtectToAteMask[NewProtect]</span>
00790 <span class="preprocessor"></span>
00791 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00792 <a class="code" href="../../d2/d9/miia64_8h.html#a303">MiProtectFor4kPage</a>(
00793     IN PVOID Base,
00794     IN SIZE_T Size,
00795     IN ULONG NewProtect,
00796     IN ULONG Flags,
00797     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process
00798     )
00799 <span class="comment">/*++</span>
00800 <span class="comment"></span>
00801 <span class="comment">Routine Description:</span>
00802 <span class="comment"></span>
00803 <span class="comment">    This routine sets the permissions on the alternate bitmap (based on</span>
00804 <span class="comment">    4K page sizes). The base and size are assumed to be aligned for</span>
00805 <span class="comment">    4K pages already.</span>
00806 <span class="comment"></span>
00807 <span class="comment">Arguments:</span>
00808 <span class="comment"></span>
00809 <span class="comment">    Base - The base address (assumed to be 4K aligned already)</span>
00810 <span class="comment"></span>
00811 <span class="comment">    Size - The size to be protected (assumed to be 4K aligned already)</span>
00812 <span class="comment"></span>
00813 <span class="comment">    NewProtect - The protection for the new pages</span>
00814 <span class="comment"></span>
00815 <span class="comment">    Flags - The alternate table entry request flags</span>
00816 <span class="comment"></span>
00817 <span class="comment">    Process - Supplies a pointer to the process in which to create the </span>
00818 <span class="comment">            protections on the alternate table</span>
00819 <span class="comment"></span>
00820 <span class="comment">    ChangeProtection - if the protection on the existing entries to be </span>
00821 <span class="comment">             changed. FALSE if new alternate entries are allocated.</span>
00822 <span class="comment"></span>
00823 <span class="comment">Return Value:</span>
00824 <span class="comment"> </span>
00825 <span class="comment">    None</span>
00826 <span class="comment"></span>
00827 <span class="comment">Environment:</span>
00828 <span class="comment"></span>
00829 <span class="comment">    Kernel mode.  All arguments are assumed to be in kernel space.</span>
00830 <span class="comment"></span>
00831 <span class="comment">--*/</span>
00832 
00833 {
00834     PVOID Starting4KAddress;
00835     PVOID Ending4KAddress;
00836     PVOID VirtualAddress;
00837     ULONG NewProtectNotCopy;
00838     ULONGLONG ProtectionMask;
00839     ULONGLONG ProtectionMaskNotCopy;
00840     ULONGLONG HardwareProtectionMask;
00841     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> StartAltPte, EndAltPte;
00842     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> StartAltPte0, EndAltPte0;
00843     <a class="code" href="../../d8/d9/struct__WOW64__PROCESS.html">PWOW64_PROCESS</a> Wow64Process = Process-&gt;Wow64Process;
00844     PVOID <a class="code" href="../../d5/d9/alpha_2exdsptch_8c.html#a2">Virtual</a>[<a class="code" href="../../d4/d8/mi_8h.html#a34">MM_MAXIMUM_FLUSH_COUNT</a>];
00845     ULONG FlushCount;
00846     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> AltPteContents;
00847     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempAltPte;
00848 
00849 
00850     Starting4KAddress = Base;
00851     Ending4KAddress = (PCHAR)Base + <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> - 1;
00852 
00853     <span class="comment">//</span>
00854     <span class="comment">// Make sure we don't over run the table</span>
00855     <span class="comment">//</span>
00856     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( ((ULONG_PTR) Starting4KAddress) &lt; _MAX_WOW64_ADDRESS);
00857     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( ((ULONG_PTR) Ending4KAddress) &lt; _MAX_WOW64_ADDRESS);
00858 
00859     <span class="comment">//</span>
00860     <span class="comment">// for free builds, until this is more tested</span>
00861     <span class="comment">//</span>
00862     <span class="keywordflow">if</span> ((((UINT_PTR) Starting4KAddress) &gt;= <a class="code" href="../../d2/d9/miia64_8h.html#a257">_MAX_WOW64_ADDRESS</a>)
00863              || (((UINT_PTR) Ending4KAddress) &gt;= <a class="code" href="../../d2/d9/miia64_8h.html#a257">_MAX_WOW64_ADDRESS</a>)) {
00864         <span class="keywordflow">return</span>;
00865     }
00866 
00867     <span class="comment">//</span>
00868     <span class="comment">// Set up the protection to be used for this range of addresses</span>
00869     <span class="comment">//</span>
00870 
00871     <span class="keywordflow">if</span> ((NewProtect &amp; <a class="code" href="../../d4/d8/mi_8h.html#a84">MM_COPY_ON_WRITE_MASK</a>) == <a class="code" href="../../d4/d8/mi_8h.html#a84">MM_COPY_ON_WRITE_MASK</a>) {
00872         NewProtectNotCopy = NewProtect &amp; ~<a class="code" href="../../d4/d8/mi_8h.html#a52">MM_PROTECTION_COPY_MASK</a>;
00873     } <span class="keywordflow">else</span> {
00874         NewProtectNotCopy = NewProtect;
00875     }    
00876 
00877     ProtectionMask = <a class="code" href="../../d2/d9/miia64_8h.html#a258">MiMakeProtectionAteMask</a> (NewProtect);
00878     ProtectionMaskNotCopy = <a class="code" href="../../d2/d9/miia64_8h.html#a258">MiMakeProtectionAteMask</a> (NewProtectNotCopy);
00879 
00880     <span class="keywordflow">if</span> (Flags &amp; <a class="code" href="../../d2/d9/miia64_8h.html#a241">ALT_COMMIT</a>) {
00881 
00882         ProtectionMask |= <a class="code" href="../../d2/d9/miia64_8h.html#a243">MM_ATE_COMMIT</a>;
00883         ProtectionMaskNotCopy |= <a class="code" href="../../d2/d9/miia64_8h.html#a243">MM_ATE_COMMIT</a>; 
00884 
00885     }
00886 
00887     <span class="comment">//</span>
00888     <span class="comment">// Get the entry in the table for each of these addresses</span>
00889     <span class="comment">//</span>
00890 
00891     StartAltPte = <a class="code" href="../../d2/d9/miia64_8h.html#a238">MiGetAltPteAddress</a> (Starting4KAddress);
00892     EndAltPte = <a class="code" href="../../d2/d9/miia64_8h.html#a238">MiGetAltPteAddress</a> (Ending4KAddress);
00893 
00894     StartAltPte0 = <a class="code" href="../../d2/d9/miia64_8h.html#a238">MiGetAltPteAddress</a>(<a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a>(Starting4KAddress) );
00895     EndAltPte0 = <a class="code" href="../../d2/d9/miia64_8h.html#a238">MiGetAltPteAddress</a>((ULONG_PTR)<a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a>(Ending4KAddress)+PAGE_SIZE-1);
00896 
00897     <span class="comment">//</span>
00898     <span class="comment">// lock the alternate page table</span>
00899     <span class="comment">//</span>
00900 
00901     <a class="code" href="../../d2/d9/miia64_8h.html#a262">LOCK_ALTERNATE_TABLE</a> (Wow64Process);
00902 
00903     <span class="keywordflow">if</span> (!(Flags &amp; <a class="code" href="../../d2/d9/miia64_8h.html#a240">ALT_ALLOCATE</a>) &amp;&amp; 
00904         (<a class="code" href="../../d4/d8/mi_8h.html#a167">MI_CHECK_BIT</a>(Wow64Process-&gt;AltPermBitmap, <a class="code" href="../../d4/d8/mi_8h.html#a107">MI_VA_TO_VPN</a>(Starting4KAddress)) == 0)) {
00905 
00906         <a class="code" href="../../d2/d9/miia64_8h.html#a263">UNLOCK_ALTERNATE_TABLE</a> (Wow64Process);
00907         <span class="keywordflow">return</span>;
00908 
00909     }
00910 
00911     <span class="comment">//</span>
00912     <span class="comment">// And then change all of the protections</span>
00913     <span class="comment">//</span>
00914 
00915     VirtualAddress = Starting4KAddress;
00916 
00917     <span class="keywordflow">while</span> (StartAltPte &lt;= EndAltPte) {
00918 
00919         AltPteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = StartAltPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long;
00920 
00921         <span class="keywordflow">if</span> (!(Flags &amp; <a class="code" href="../../d2/d9/miia64_8h.html#a240">ALT_ALLOCATE</a>) &amp;&amp; (AltPteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Alt.Private != 0)) {
00922 
00923 
00924             <span class="comment">//</span>
00925             <span class="comment">// if it is already private, don't make it writecopy</span>
00926             <span class="comment">//</span>
00927                 
00928             TempAltPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = ProtectionMaskNotCopy;
00929             TempAltPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Alt.Protection = NewProtectNotCopy;
00930 
00931             <span class="comment">//</span>
00932             <span class="comment">// Private is sticky bit</span>
00933             <span class="comment">//</span>
00934 
00935             TempAltPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Alt.Private = 1;
00936 
00937         } <span class="keywordflow">else</span> {             
00938                 
00939             TempAltPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = ProtectionMask;
00940             TempAltPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Alt.Protection = NewProtect;
00941 
00942         } 
00943 
00944         <span class="keywordflow">if</span> (Flags &amp; <a class="code" href="../../d2/d9/miia64_8h.html#a242">ALT_CHANGE</a>) {
00945 
00946             <span class="comment">//</span>
00947             <span class="comment">// if it is a change request, make Commit sticky</span>
00948             <span class="comment">//</span>
00949 
00950             TempAltPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Alt.Commit = AltPteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Alt.Commit;
00951             
00952         }
00953 
00954         <span class="keywordflow">if</span> (!(Flags &amp; <a class="code" href="../../d2/d9/miia64_8h.html#a240">ALT_ALLOCATE</a>) &amp;&amp; (AltPteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Alt.FillZero != 0)) {
00955 
00956             TempAltPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Alt.Accessed = 0;
00957             TempAltPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Alt.FillZero = 1;
00958 
00959         }
00960             
00961         <span class="comment">//</span>
00962         <span class="comment">// atomic PTE update</span>
00963         <span class="comment">//</span>
00964 
00965         StartAltPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = TempAltPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long;
00966 
00967         StartAltPte++;
00968         VirtualAddress = (PVOID)((ULONG_PTR)VirtualAddress + <a class="code" href="../../d2/d9/miia64_8h.html#a227">PAGE_4K</a>);
00969 
00970     }
00971 
00972     <span class="keywordflow">if</span> (Flags &amp; <a class="code" href="../../d2/d9/miia64_8h.html#a240">ALT_ALLOCATE</a>) {
00973 
00974         <span class="comment">//</span>
00975         <span class="comment">// fill the empty Alt Pte as NoAccess ATE at the end</span>
00976         <span class="comment">//</span>
00977 
00978         <span class="keywordflow">while</span> (EndAltPte &lt;= EndAltPte0) {
00979 
00980             <span class="keywordflow">if</span> (EndAltPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == 0) {
00981 
00982                 TempAltPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = EndAltPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long;
00983                 TempAltPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Alt.NoAccess = 1;
00984 
00985                 <span class="comment">//</span>
00986                 <span class="comment">// atomic PTE update</span>
00987                 <span class="comment">//</span>
00988 
00989                 EndAltPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = TempAltPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long;
00990 
00991             }
00992 
00993             EndAltPte++;
00994         }
00995 
00996         <span class="comment">//</span>
00997         <span class="comment">// update the permission bitmap</span>
00998         <span class="comment">//</span>
00999 
01000         <a class="code" href="../../d2/d9/miia64_8h.html#a316">MiMarkSplitPages</a>(Base, 
01001                          (PVOID)((ULONG_PTR)Base + Size - 1), 
01002                          Wow64Process-&gt;AltPermBitmap,
01003                          TRUE);
01004     }
01005 
01006     <span class="comment">// </span>
01007     <span class="comment">// As OS always perform MI_MAKE_VLID_PTE to change a valid PTE</span>
01008     <span class="comment">// and the macro always reset the access-bit, we don't need to </span>
01009     <span class="comment">// call MiResetAccessBitForNativePtes.</span>
01010     <span class="comment">// </span>
01011     <span class="comment">// MiResetAccessBitForNativePtes(Starting4KAddress, </span>
01012     <span class="comment">//                              Ending4KAddress, </span>
01013     <span class="comment">//                              Process);</span>
01014 
01015 
01016 
01017     <span class="comment">//</span>
01018     <span class="comment">// flush the TB since the page protections has been changed.</span>
01019     <span class="comment">//</span>
01020 
01021     VirtualAddress = <a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a>(Starting4KAddress);
01022 
01023     FlushCount = 0;
01024     <span class="keywordflow">while</span> (VirtualAddress &lt;= Ending4KAddress) {
01025         <span class="keywordflow">if</span> (FlushCount != <a class="code" href="../../d4/d8/mi_8h.html#a34">MM_MAXIMUM_FLUSH_COUNT</a>) {
01026             <a class="code" href="../../d5/d9/alpha_2exdsptch_8c.html#a2">Virtual</a>[FlushCount] = VirtualAddress;
01027             FlushCount += 1;
01028         } 
01029         VirtualAddress = (PVOID)((ULONG_PTR)VirtualAddress + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
01030     }
01031     
01032     <span class="keywordflow">if</span> (FlushCount != 0) {
01033         
01034         <span class="keywordflow">if</span> (FlushCount &lt;= <a class="code" href="../../d4/d8/mi_8h.html#a34">MM_MAXIMUM_FLUSH_COUNT</a>) {
01035 
01036             <a class="code" href="../../d0/d6/ppc_2flushtb_8c.html#a1">KeFlushMultipleTb</a>(FlushCount,
01037                               &amp;Virtual[0],
01038                               TRUE,
01039                               TRUE,
01040                               NULL,
01041                               <a class="code" href="../../d4/d2/datalpha_8c.html#a0">ZeroPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Flush);                          
01042         } <span class="keywordflow">else</span> {
01043 
01044             <a class="code" href="../../d0/d6/ppc_2flushtb_8c.html#a0">KeFlushEntireTb</a>(TRUE, TRUE);
01045 
01046         }
01047     }
01048 
01049     <a class="code" href="../../d2/d9/miia64_8h.html#a263">UNLOCK_ALTERNATE_TABLE</a> (Wow64Process);
01050 }
01051 
01052 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
01053 <a class="code" href="../../d2/d9/miia64_8h.html#a304">MiProtectMapFileFor4kPage</a>(
01054     IN PVOID Base,
01055     IN SIZE_T Size,
01056     IN ULONG NewProtect,
01057     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte,
01058     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process
01059     )
01060 <span class="comment">/*++</span>
01061 <span class="comment"></span>
01062 <span class="comment">Routine Description:</span>
01063 <span class="comment"></span>
01064 <span class="comment">    This routine sets the permissions on the alternate bitmap (based on</span>
01065 <span class="comment">    4K page sizes). The base and size are assumed to be aligned for</span>
01066 <span class="comment">    4K pages already.</span>
01067 <span class="comment"></span>
01068 <span class="comment">Arguments:</span>
01069 <span class="comment"></span>
01070 <span class="comment">    Base - The base address (assumed to be 4K aligned already)</span>
01071 <span class="comment"></span>
01072 <span class="comment">    Size - The size to be protected (assumed to be 4K aligned already)</span>
01073 <span class="comment"></span>
01074 <span class="comment">    NewProtect - The protection for the new pages</span>
01075 <span class="comment"></span>
01076 <span class="comment">    Commit - True if the page is commited, false otherwise</span>
01077 <span class="comment"></span>
01078 <span class="comment">    Process - Supplies a pointer to the process in which to create the </span>
01079 <span class="comment">            protections on the alternate table</span>
01080 <span class="comment"></span>
01081 <span class="comment">Return Value:</span>
01082 <span class="comment"> </span>
01083 <span class="comment">    None</span>
01084 <span class="comment"></span>
01085 <span class="comment">Environment:</span>
01086 <span class="comment"></span>
01087 <span class="comment">    Kernel mode.  All arguments are assumed to be in kernel space.</span>
01088 <span class="comment"></span>
01089 <span class="comment">--*/</span>
01090 
01091 {
01092     PVOID Starting4KAddress;
01093     PVOID Ending4KAddress;
01094     ULONGLONG ProtectionMask;
01095     ULONGLONG HardwareProtectionMask;
01096     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> StartAltPte, EndAltPte;
01097     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> StartAltPte0, EndAltPte0;
01098     <a class="code" href="../../d8/d9/struct__WOW64__PROCESS.html">PWOW64_PROCESS</a> Wow64Process = Process-&gt;Wow64Process;
01099     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempAltPte;
01100 
01101     Starting4KAddress = Base;
01102     Ending4KAddress = (PCHAR)Base + <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> - 1;
01103 
01104     <span class="comment">//</span>
01105     <span class="comment">// Make sure we don't over run the table</span>
01106     <span class="comment">//</span>
01107     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( ((ULONG_PTR) Starting4KAddress) &lt; _MAX_WOW64_ADDRESS);
01108     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( ((ULONG_PTR) Ending4KAddress) &lt; _MAX_WOW64_ADDRESS);
01109 
01110     <span class="comment">//</span>
01111     <span class="comment">// for free builds, until this is more tested</span>
01112     <span class="comment">//</span>
01113     <span class="keywordflow">if</span> ((((UINT_PTR) Starting4KAddress) &gt;= <a class="code" href="../../d2/d9/miia64_8h.html#a257">_MAX_WOW64_ADDRESS</a>)
01114              || (((UINT_PTR) Ending4KAddress) &gt;= <a class="code" href="../../d2/d9/miia64_8h.html#a257">_MAX_WOW64_ADDRESS</a>)) {
01115         <span class="keywordflow">return</span>;
01116     }
01117 
01118     <span class="comment">//</span>
01119     <span class="comment">// Set up the protection to be used for this range of addresses</span>
01120     <span class="comment">//</span>
01121 
01122     ProtectionMask = <a class="code" href="../../d2/d9/miia64_8h.html#a258">MiMakeProtectionAteMask</a> (NewProtect);
01123 
01124     <span class="comment">//</span>
01125     <span class="comment">// Get the entry in the table for each of these addresses</span>
01126     <span class="comment">//</span>
01127 
01128     StartAltPte = <a class="code" href="../../d2/d9/miia64_8h.html#a238">MiGetAltPteAddress</a> (Starting4KAddress);
01129     EndAltPte = <a class="code" href="../../d2/d9/miia64_8h.html#a238">MiGetAltPteAddress</a> (Ending4KAddress);
01130     EndAltPte0 = <a class="code" href="../../d2/d9/miia64_8h.html#a238">MiGetAltPteAddress</a>((ULONG_PTR)<a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a>(Ending4KAddress)+PAGE_SIZE-1);
01131 
01132     <a class="code" href="../../d2/d9/miia64_8h.html#a262">LOCK_ALTERNATE_TABLE</a> (Wow64Process);
01133 
01134     <a class="code" href="../../d5/d8/ex_8h.html#a231">ExAcquireFastMutexUnsafe</a> (&amp;MmSectionCommitMutex);
01135 
01136     <span class="comment">//</span>
01137     <span class="comment">// And then change all of the protections</span>
01138     <span class="comment">//</span>
01139 
01140     <span class="keywordflow">while</span> (StartAltPte &lt;= EndAltPte) {
01141 
01142         TempAltPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = ProtectionMask;
01143         TempAltPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Alt.Protection = NewProtect;
01144 
01145         <span class="keywordflow">if</span> (PointerPte-&gt;u.Long != 0) {
01146 
01147             TempAltPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Alt.Commit = 1;
01148 
01149         } <span class="keywordflow">else</span> {
01150 
01151             TempAltPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Alt.Commit = 0;
01152 
01153         }
01154 
01155         <span class="comment">//</span>
01156         <span class="comment">// atomic PTE update</span>
01157         <span class="comment">//</span>
01158 
01159         StartAltPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = TempAltPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long;
01160 
01161         StartAltPte++;
01162 
01163         <span class="keywordflow">if</span> (((ULONG_PTR)StartAltPte &amp; ((<a class="code" href="../../d2/d9/miia64_8h.html#a234">SPLITS_PER_PAGE</a> * <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>))-1)) == 0) {
01164 
01165             PointerPte++;
01166 
01167         }
01168     }
01169 
01170     <a class="code" href="../../d5/d8/ex_8h.html#a232">ExReleaseFastMutexUnsafe</a> (&amp;MmSectionCommitMutex);
01171 
01172     <span class="comment">//</span>
01173     <span class="comment">// fill the empty Alt Pte as NoAccess ATE at the end</span>
01174     <span class="comment">//</span>
01175 
01176     <span class="keywordflow">while</span> (EndAltPte &lt;= EndAltPte0) {
01177 
01178         <span class="keywordflow">if</span> (EndAltPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == 0) {
01179 
01180             TempAltPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = EndAltPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long;
01181             TempAltPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Alt.NoAccess = 1;
01182 
01183             <span class="comment">//</span>
01184             <span class="comment">// atomic PTE size update</span>
01185             <span class="comment">//</span>
01186 
01187             EndAltPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = TempAltPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long;
01188 
01189         }
01190 
01191         EndAltPte++;
01192     }
01193     
01194     <a class="code" href="../../d2/d9/miia64_8h.html#a316">MiMarkSplitPages</a>(Base, 
01195                      (PVOID)((ULONG_PTR)Base + Size - 1), 
01196                      Wow64Process-&gt;AltPermBitmap,
01197                      TRUE);
01198 
01199     <a class="code" href="../../d2/d9/miia64_8h.html#a263">UNLOCK_ALTERNATE_TABLE</a> (Wow64Process);
01200 }
01201 
01202 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
01203 <a class="code" href="../../d2/d9/miia64_8h.html#a305">MiProtectImageFileFor4kPage</a>(
01204     IN PVOID Base,
01205     IN SIZE_T Size,
01206     IN <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte,
01207     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process
01208     )
01209 {
01210     PVOID Starting4KAddress;
01211     PVOID Ending4KAddress;
01212     ULONGLONG ProtectionMask;
01213     ULONGLONG HardwareProtectionMask;
01214     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> StartAltPte;
01215     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> EndAltPte;
01216     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> EndAltPte0;
01217     <a class="code" href="../../d8/d9/struct__WOW64__PROCESS.html">PWOW64_PROCESS</a> Wow64Process = Process-&gt;Wow64Process;
01218     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempAltPte;
01219     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
01220     ULONG NewProtect;
01221     KIRQL OldIrql;
01222     ULONG i;
01223 
01224     Starting4KAddress = Base;
01225     Ending4KAddress = (PCHAR)Base + <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> - 1;
01226 
01227     <span class="comment">//</span>
01228     <span class="comment">// Make sure we don't over run the table</span>
01229     <span class="comment">//</span>
01230     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( ((ULONG_PTR) Starting4KAddress) &lt; _MAX_WOW64_ADDRESS);
01231     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( ((ULONG_PTR) Ending4KAddress) &lt; _MAX_WOW64_ADDRESS);
01232 
01233     <span class="comment">//</span>
01234     <span class="comment">// for free builds, until this is more tested</span>
01235     <span class="comment">//</span>
01236     <span class="keywordflow">if</span> ((((UINT_PTR) Starting4KAddress) &gt;= <a class="code" href="../../d2/d9/miia64_8h.html#a257">_MAX_WOW64_ADDRESS</a>)
01237              || (((UINT_PTR) Ending4KAddress) &gt;= <a class="code" href="../../d2/d9/miia64_8h.html#a257">_MAX_WOW64_ADDRESS</a>)) {
01238         <span class="keywordflow">return</span>;
01239     }
01240 
01241     <span class="comment">//</span>
01242     <span class="comment">// Get the entry in the table for each of these addresses</span>
01243     <span class="comment">//</span>
01244 
01245     StartAltPte = <a class="code" href="../../d2/d9/miia64_8h.html#a238">MiGetAltPteAddress</a> (Starting4KAddress);
01246     EndAltPte = <a class="code" href="../../d2/d9/miia64_8h.html#a238">MiGetAltPteAddress</a> (Ending4KAddress);
01247     EndAltPte0 = <a class="code" href="../../d2/d9/miia64_8h.html#a238">MiGetAltPteAddress</a>((ULONG_PTR)<a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a>(Ending4KAddress)+PAGE_SIZE-1);
01248 
01249     <a class="code" href="../../d2/d9/miia64_8h.html#a262">LOCK_ALTERNATE_TABLE</a> (Wow64Process);
01250 
01251     <span class="comment">//</span>
01252     <span class="comment">// And then change all of the protections</span>
01253     <span class="comment">//</span>
01254 
01255     <span class="keywordflow">while</span> (StartAltPte &lt;= EndAltPte) {
01256 
01257         <span class="comment">//</span>
01258         <span class="comment">// Get the original protection information from the prototype PTEs</span>
01259         <span class="comment">//</span>
01260 
01261         <a class="code" href="../../d4/d8/mi_8h.html#a155">LOCK_WS_UNSAFE</a> (Process);
01262 
01263         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
01264         <a class="code" href="../../d0/d2/mmsup_8c.html#a9">MiMakeSystemAddressValidPfnWs</a> (PointerPte, Process);
01265         TempPte = *PointerPte;
01266         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
01267 
01268         NewProtect = 
01269             <a class="code" href="../../d0/d2/mmsup_8c.html#a5">MiMakeProtectionMask</a>(<a class="code" href="../../d0/d9/protect_8c.html#a7">MiGetPageProtection</a>(&amp;TempPte, Process));
01270 
01271         <a class="code" href="../../d4/d8/mi_8h.html#a159">UNLOCK_WS_UNSAFE</a> (Process);
01272 
01273         <span class="comment">//</span>
01274         <span class="comment">// if demand-zero and copy-on-write, remove copy-on-write</span>
01275         <span class="comment">//</span>
01276 
01277         <span class="keywordflow">if</span> ((!<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a171">IS_PTE_NOT_DEMAND_ZERO</a>(TempPte)) &amp;&amp; 
01278             (TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection &amp; <a class="code" href="../../d4/d8/mi_8h.html#a84">MM_COPY_ON_WRITE_MASK</a>)) {
01279             NewProtect = NewProtect &amp; ~<a class="code" href="../../d4/d8/mi_8h.html#a52">MM_PROTECTION_COPY_MASK</a>;
01280         }
01281 
01282         ProtectionMask = <a class="code" href="../../d2/d9/miia64_8h.html#a258">MiMakeProtectionAteMask</a> (NewProtect);
01283         ProtectionMask |= <a class="code" href="../../d2/d9/miia64_8h.html#a243">MM_ATE_COMMIT</a>;
01284 
01285         TempAltPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = ProtectionMask;
01286         TempAltPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Alt.Protection = NewProtect;
01287 
01288         <span class="keywordflow">if</span> ((NewProtect &amp; <a class="code" href="../../d4/d8/mi_8h.html#a52">MM_PROTECTION_COPY_MASK</a>) == 0) {
01289 
01290             <span class="comment">//</span>
01291             <span class="comment">// if the copy-on-write is removed, make it private</span>
01292             <span class="comment">//</span>
01293 
01294             TempAltPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Alt.Private = 1;
01295 
01296         }
01297 
01298         <span class="comment">//</span>
01299         <span class="comment">// atomic PTE update</span>
01300         <span class="comment">//</span>
01301 
01302         <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d2/d9/miia64_8h.html#a234">SPLITS_PER_PAGE</a>; i += 1) { 
01303 
01304             StartAltPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = TempAltPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long;
01305             StartAltPte++;
01306 
01307         }
01308 
01309         PointerPte++;
01310     }
01311 
01312     <span class="comment">//</span>
01313     <span class="comment">// fill the empty Alt Pte as NoAccess ATE at the end</span>
01314     <span class="comment">//</span>
01315 
01316     <span class="keywordflow">while</span> (EndAltPte &lt;= EndAltPte0) {
01317 
01318         <span class="keywordflow">if</span> (EndAltPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == 0) {
01319 
01320             TempAltPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = EndAltPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long;
01321             TempAltPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Alt.NoAccess = 1;
01322 
01323             <span class="comment">//</span>
01324             <span class="comment">// atomic PTE size update</span>
01325             <span class="comment">//</span>
01326 
01327             EndAltPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = TempAltPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long;
01328 
01329         }
01330 
01331         EndAltPte++;
01332     }
01333     
01334     <a class="code" href="../../d2/d9/miia64_8h.html#a316">MiMarkSplitPages</a>(Base, 
01335                      (PVOID)((ULONG_PTR)Base + Size - 1), 
01336                      Wow64Process-&gt;AltPermBitmap,
01337                      TRUE);
01338 
01339     <a class="code" href="../../d2/d9/miia64_8h.html#a263">UNLOCK_ALTERNATE_TABLE</a> (Wow64Process);
01340 }
01341 
01342 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
01343 <a class="code" href="../../d2/d9/miia64_8h.html#a306">MiReleaseFor4kPage</a>(
01344     IN PVOID StartVirtual,
01345     IN PVOID EndVirtual,
01346     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process
01347     )
01348 <span class="comment">/*++</span>
01349 <span class="comment"></span>
01350 <span class="comment">Routine Description:</span>
01351 <span class="comment"></span>
01352 <span class="comment">    This function releases a region of pages within the virtual address</span>
01353 <span class="comment">    space of a subject process.</span>
01354 <span class="comment"></span>
01355 <span class="comment">Arguments:</span>
01356 <span class="comment"></span>
01357 <span class="comment"></span>
01358 <span class="comment">   StartVirtual - the start address of the region of pages</span>
01359 <span class="comment">        to be released.</span>
01360 <span class="comment"></span>
01361 <span class="comment">   EndVirtual - the end address of the region of pages </span>
01362 <span class="comment">        to be released.</span>
01363 <span class="comment"></span>
01364 <span class="comment">    Process - Supplies a pointer to the process in which to release a </span>
01365 <span class="comment">            region of pages.</span>
01366 <span class="comment"></span>
01367 <span class="comment">Return Value:</span>
01368 <span class="comment"></span>
01369 <span class="comment">    None</span>
01370 <span class="comment"></span>
01371 <span class="comment"></span>
01372 <span class="comment">--*/</span>
01373 
01374 {
01375     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> StartAltPte;
01376     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> EndAltPte;
01377     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempAltPte;
01378     ULONG_PTR VirtualAddress;
01379     ULONG i;
01380     <a class="code" href="../../d8/d9/struct__WOW64__PROCESS.html">PWOW64_PROCESS</a> Wow64Process = Process-&gt;Wow64Process;
01381     PVOID <a class="code" href="../../d5/d9/alpha_2exdsptch_8c.html#a2">Virtual</a>[<a class="code" href="../../d4/d8/mi_8h.html#a34">MM_MAXIMUM_FLUSH_COUNT</a>];
01382     ULONG FlushCount = 0;
01383 
01384     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(StartVirtual &lt;= EndVirtual);
01385 
01386     StartAltPte = <a class="code" href="../../d2/d9/miia64_8h.html#a238">MiGetAltPteAddress</a> (StartVirtual);
01387     EndAltPte = <a class="code" href="../../d2/d9/miia64_8h.html#a238">MiGetAltPteAddress</a> (EndVirtual);
01388 
01389     <a class="code" href="../../d2/d9/miia64_8h.html#a262">LOCK_ALTERNATE_TABLE</a> (Wow64Process);
01390 
01391     VirtualAddress = (ULONG_PTR)StartVirtual;
01392 
01393     <span class="keywordflow">while</span> (StartAltPte &lt;= EndAltPte) {
01394 
01395         StartAltPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = 0;
01396         StartAltPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Alt.NoAccess = 1;
01397         StartAltPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Alt.FillZero = 1;
01398         StartAltPte++;
01399 
01400     }
01401 
01402     StartVirtual = <a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a>(StartVirtual);
01403 
01404     VirtualAddress = (ULONG_PTR)StartVirtual;
01405 
01406     <span class="keywordflow">while</span> (VirtualAddress &lt;= (ULONG_PTR)EndVirtual) {
01407 
01408         StartAltPte = <a class="code" href="../../d2/d9/miia64_8h.html#a238">MiGetAltPteAddress</a>(VirtualAddress);
01409         TempAltPte = *StartAltPte;
01410 
01411         i = 0;
01412 
01413         <span class="keywordflow">while</span> (TempAltPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == StartAltPte-&gt;u.Long) {
01414             i += 1;
01415             StartAltPte++;
01416         }
01417 
01418         <span class="keywordflow">if</span> (i == <a class="code" href="../../d2/d9/miia64_8h.html#a234">SPLITS_PER_PAGE</a>) {
01419 
01420             StartAltPte = <a class="code" href="../../d2/d9/miia64_8h.html#a238">MiGetAltPteAddress</a>(VirtualAddress);
01421             
01422             <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d2/d9/miia64_8h.html#a234">SPLITS_PER_PAGE</a>; i += 1) {
01423                 StartAltPte-&gt;u.Long = 0;
01424                 StartAltPte++;
01425             }
01426             
01427         }
01428         
01429         VirtualAddress  += <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
01430         
01431         <span class="keywordflow">if</span> (FlushCount != <a class="code" href="../../d4/d8/mi_8h.html#a34">MM_MAXIMUM_FLUSH_COUNT</a>) {
01432             <a class="code" href="../../d5/d9/alpha_2exdsptch_8c.html#a2">Virtual</a>[FlushCount] = (PVOID)VirtualAddress;
01433             FlushCount += 1;
01434         } 
01435     }
01436 
01437     MiResetAccessBitForNativePtes(StartVirtual, EndVirtual, Process);
01438 
01439     <span class="keywordflow">if</span> (FlushCount != 0) {
01440         
01441         <span class="keywordflow">if</span> (FlushCount &lt;= <a class="code" href="../../d4/d8/mi_8h.html#a34">MM_MAXIMUM_FLUSH_COUNT</a>) {
01442 
01443             <a class="code" href="../../d0/d6/ppc_2flushtb_8c.html#a1">KeFlushMultipleTb</a>(FlushCount,
01444                               &amp;Virtual[0],
01445                               TRUE,
01446                               TRUE,
01447                               NULL,
01448                               <a class="code" href="../../d4/d2/datalpha_8c.html#a0">ZeroPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Flush);                          
01449         } <span class="keywordflow">else</span> {
01450 
01451             <a class="code" href="../../d0/d6/ppc_2flushtb_8c.html#a0">KeFlushEntireTb</a>(TRUE, TRUE);
01452 
01453         }
01454     }
01455 
01456     <a class="code" href="../../d2/d9/miia64_8h.html#a263">UNLOCK_ALTERNATE_TABLE</a> (Wow64Process);
01457 }
01458 
01459 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
01460 <a class="code" href="../../d2/d9/miia64_8h.html#a307">MiDecommitFor4kPage</a>(
01461     IN PVOID StartVirtual,
01462     IN PVOID EndVirtual,
01463     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process
01464     )
01465 <span class="comment">/*++</span>
01466 <span class="comment"></span>
01467 <span class="comment">Routine Description:</span>
01468 <span class="comment"></span>
01469 <span class="comment">    This function decommits a region of pages within the virtual address</span>
01470 <span class="comment">    space of a subject process.</span>
01471 <span class="comment"></span>
01472 <span class="comment">Arguments:</span>
01473 <span class="comment"></span>
01474 <span class="comment"></span>
01475 <span class="comment">   StartVirtual - the start address of the region of pages</span>
01476 <span class="comment">        to be decommitted.</span>
01477 <span class="comment"></span>
01478 <span class="comment">   EndVirtual - the end address of the region of the pages </span>
01479 <span class="comment">        to be decommitted.</span>
01480 <span class="comment"></span>
01481 <span class="comment">    Process - Supplies a pointer to the process in which to decommit a</span>
01482 <span class="comment">            a region of pages.</span>
01483 <span class="comment"></span>
01484 <span class="comment">Return Value:</span>
01485 <span class="comment"></span>
01486 <span class="comment">    None</span>
01487 <span class="comment"></span>
01488 <span class="comment"></span>
01489 <span class="comment">--*/</span>
01490 
01491 {
01492     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> StartAltPte;
01493     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> EndAltPte;
01494     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempAltPte;
01495     ULONG_PTR VirtualAddress;
01496     <a class="code" href="../../d8/d9/struct__WOW64__PROCESS.html">PWOW64_PROCESS</a> Wow64Process = Process-&gt;Wow64Process;
01497     PVOID <a class="code" href="../../d5/d9/alpha_2exdsptch_8c.html#a2">Virtual</a>[<a class="code" href="../../d4/d8/mi_8h.html#a34">MM_MAXIMUM_FLUSH_COUNT</a>];
01498     ULONG FlushCount = 0;
01499 
01500     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(StartVirtual &lt;= EndVirtual);
01501 
01502     StartAltPte = <a class="code" href="../../d2/d9/miia64_8h.html#a238">MiGetAltPteAddress</a> (StartVirtual);
01503     EndAltPte = <a class="code" href="../../d2/d9/miia64_8h.html#a238">MiGetAltPteAddress</a> (EndVirtual);
01504 
01505     <a class="code" href="../../d2/d9/miia64_8h.html#a262">LOCK_ALTERNATE_TABLE</a> (Wow64Process);
01506 
01507     <span class="keywordflow">while</span> (StartAltPte &lt;= EndAltPte) {
01508 
01509         TempAltPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = StartAltPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long;
01510         TempAltPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Alt.Commit = 0;
01511         TempAltPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Alt.FillZero = 1;
01512 
01513         <span class="comment">//</span>
01514         <span class="comment">// atomic PTE update</span>
01515         <span class="comment">//</span>
01516 
01517         StartAltPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = TempAltPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long;
01518 
01519         StartAltPte++;
01520     }
01521 
01522     <span class="comment">//</span>
01523     <span class="comment">// Flush the tb for virtual addreses</span>
01524     <span class="comment">//</span>
01525 
01526     VirtualAddress = (ULONG_PTR)StartVirtual;
01527 
01528     <span class="keywordflow">while</span> ((PVOID)VirtualAddress &lt;= EndVirtual) {
01529 
01530         <span class="keywordflow">if</span> (FlushCount != <a class="code" href="../../d4/d8/mi_8h.html#a34">MM_MAXIMUM_FLUSH_COUNT</a>) {
01531             <a class="code" href="../../d5/d9/alpha_2exdsptch_8c.html#a2">Virtual</a>[FlushCount] = (PVOID)VirtualAddress;
01532             FlushCount += 1;
01533         } 
01534         VirtualAddress += <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
01535 
01536     }
01537 
01538     MiResetAccessBitForNativePtes(StartVirtual, EndVirtual, Process);
01539 
01540     <span class="keywordflow">if</span> (FlushCount != 0) {
01541         
01542         <span class="keywordflow">if</span> (FlushCount &lt;= <a class="code" href="../../d4/d8/mi_8h.html#a34">MM_MAXIMUM_FLUSH_COUNT</a>) {
01543 
01544             <a class="code" href="../../d0/d6/ppc_2flushtb_8c.html#a1">KeFlushMultipleTb</a>(FlushCount,
01545                               &amp;Virtual[0],
01546                               TRUE,
01547                               TRUE,
01548                               NULL,
01549                               <a class="code" href="../../d4/d2/datalpha_8c.html#a0">ZeroPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Flush);                          
01550         } <span class="keywordflow">else</span> {
01551 
01552             <a class="code" href="../../d0/d6/ppc_2flushtb_8c.html#a0">KeFlushEntireTb</a>(TRUE, TRUE);
01553 
01554         }
01555     }
01556 
01557     <a class="code" href="../../d2/d9/miia64_8h.html#a263">UNLOCK_ALTERNATE_TABLE</a> (Wow64Process);
01558 }
01559 
01560 
01561 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
01562 <a class="code" href="../../d2/d9/miia64_8h.html#a308">MiDeleteFor4kPage</a>(
01563     IN PVOID StartVirtual,
01564     IN PVOID EndVirtual,
01565     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process
01566     )
01567 <span class="comment">/*++</span>
01568 <span class="comment"></span>
01569 <span class="comment">Routine Description:</span>
01570 <span class="comment"></span>
01571 <span class="comment">    This function deletes a region of pages within the virtual address</span>
01572 <span class="comment">    space of a subject process.</span>
01573 <span class="comment"></span>
01574 <span class="comment">Arguments:</span>
01575 <span class="comment"></span>
01576 <span class="comment"></span>
01577 <span class="comment">   StartVirtual - the start address of the region of pages</span>
01578 <span class="comment">        to be deleted</span>
01579 <span class="comment"></span>
01580 <span class="comment">   EndVirtual - the end address of the region of the pages </span>
01581 <span class="comment">        to be deleted.</span>
01582 <span class="comment"></span>
01583 <span class="comment">    Process - Supplies a pointer to the process in which to delete a</span>
01584 <span class="comment">            a region of pages.</span>
01585 <span class="comment"></span>
01586 <span class="comment">Return Value:</span>
01587 <span class="comment"></span>
01588 <span class="comment">    None</span>
01589 <span class="comment"></span>
01590 <span class="comment"></span>
01591 <span class="comment">--*/</span>
01592 
01593 {
01594     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> StartAltPte;
01595     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> EndAltPte;
01596     ULONG_PTR VirtualAddress;
01597     <a class="code" href="../../d8/d9/struct__WOW64__PROCESS.html">PWOW64_PROCESS</a> Wow64Process = Process-&gt;Wow64Process;
01598     PVOID <a class="code" href="../../d5/d9/alpha_2exdsptch_8c.html#a2">Virtual</a>[<a class="code" href="../../d4/d8/mi_8h.html#a34">MM_MAXIMUM_FLUSH_COUNT</a>];
01599     ULONG FlushCount = 0;
01600 
01601     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(StartVirtual &lt;= EndVirtual);
01602 
01603     StartAltPte = <a class="code" href="../../d2/d9/miia64_8h.html#a238">MiGetAltPteAddress</a> (StartVirtual);
01604     EndAltPte = <a class="code" href="../../d2/d9/miia64_8h.html#a238">MiGetAltPteAddress</a> (EndVirtual);
01605 
01606     <a class="code" href="../../d2/d9/miia64_8h.html#a262">LOCK_ALTERNATE_TABLE</a> (Wow64Process);
01607 
01608     VirtualAddress = (ULONG_PTR)StartVirtual;
01609 
01610     <span class="keywordflow">while</span> (StartAltPte &lt;= EndAltPte) {
01611 
01612         StartAltPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long= 0;
01613         StartAltPte++;
01614     }
01615 
01616 
01617     <span class="comment">//</span>
01618     <span class="comment">// Flush the tb for virtual addreses</span>
01619     <span class="comment">//</span>
01620 
01621     VirtualAddress = (ULONG_PTR)StartVirtual;
01622 
01623     <span class="keywordflow">while</span> ((PVOID)VirtualAddress &lt;= EndVirtual) {
01624 
01625         <span class="keywordflow">if</span> (FlushCount != <a class="code" href="../../d4/d8/mi_8h.html#a34">MM_MAXIMUM_FLUSH_COUNT</a>) {
01626             <a class="code" href="../../d5/d9/alpha_2exdsptch_8c.html#a2">Virtual</a>[FlushCount] = (PVOID)VirtualAddress;
01627             FlushCount += 1;
01628         } 
01629         VirtualAddress += <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
01630 
01631     }
01632 
01633     <a class="code" href="../../d2/d9/miia64_8h.html#a316">MiMarkSplitPages</a>(StartVirtual, 
01634                      EndVirtual, 
01635                      Wow64Process-&gt;AltPermBitmap,
01636                      TRUE);
01637 
01638     MiResetAccessBitForNativePtes(StartVirtual, EndVirtual, Process);
01639 
01640     <span class="keywordflow">if</span> (FlushCount != 0) {
01641         
01642         <span class="keywordflow">if</span> (FlushCount &lt;= <a class="code" href="../../d4/d8/mi_8h.html#a34">MM_MAXIMUM_FLUSH_COUNT</a>) {
01643 
01644             <a class="code" href="../../d0/d6/ppc_2flushtb_8c.html#a1">KeFlushMultipleTb</a>(FlushCount,
01645                               &amp;Virtual[0],
01646                               TRUE,
01647                               TRUE,
01648                               NULL,
01649                               <a class="code" href="../../d4/d2/datalpha_8c.html#a0">ZeroPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Flush);                          
01650         } <span class="keywordflow">else</span> {
01651 
01652             <a class="code" href="../../d0/d6/ppc_2flushtb_8c.html#a0">KeFlushEntireTb</a>(TRUE, TRUE);
01653 
01654         }
01655     }
01656 
01657     <a class="code" href="../../d2/d9/miia64_8h.html#a263">UNLOCK_ALTERNATE_TABLE</a> (Wow64Process);
01658 }
01659 
01660 BOOLEAN
01661 MiIsSplitPage(
01662     IN PVOID Virtual
01663     )
01664 {
01665     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> AltPte;
01666     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> PteContents;
01667     BOOLEAN IsSplit;
01668     ULONG i;
01669 
01670     <a class="code" href="../../d5/d9/alpha_2exdsptch_8c.html#a2">Virtual</a> = <a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a>(Virtual);
01671     AltPte = <a class="code" href="../../d2/d9/miia64_8h.html#a238">MiGetAltPteAddress</a>(Virtual);
01672     PteContents = *AltPte;
01673 
01674     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d2/d9/miia64_8h.html#a234">SPLITS_PER_PAGE</a>; i++) {
01675 
01676         <span class="keywordflow">if</span> ((AltPte-&gt;u.Long != 0) &amp;&amp; 
01677             ((AltPte-&gt;u.Alt.Commit == 0) || 
01678              (AltPte-&gt;u.Alt.Accessed == 0) ||
01679              (AltPte-&gt;u.Alt.CopyOnWrite != 0) || 
01680              (AltPte-&gt;u.Alt.FillZero != 0))) {
01681 
01682             <span class="comment">//</span>
01683             <span class="comment">// if it is a NoAccess, FillZero or Guard page, CopyONWrite,</span>
01684             <span class="comment">// mark it as a split page</span>
01685             <span class="comment">//</span>
01686 
01687             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01688 
01689         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long != AltPte-&gt;u.Long) {
01690 
01691             <span class="comment">//</span>
01692             <span class="comment">// if the next 4kb page is different from the 1st 4k page</span>
01693             <span class="comment">// the page is split</span>
01694             <span class="comment">//</span>
01695 
01696             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01697 
01698         }
01699 
01700         AltPte++;
01701 
01702     }
01703 
01704     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01705 }
01706 
01707 
01708 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
01709 <a class="code" href="../../d2/d9/miia64_8h.html#a316">MiMarkSplitPages</a>(
01710     IN PVOID StartVirtual,
01711     IN PVOID EndVirtual,
01712     IN PULONG Bitmap,
01713     IN BOOLEAN SetBit
01714     )
01715 <span class="comment">/*++</span>
01716 <span class="comment"></span>
01717 <span class="comment">Routine Description:</span>
01718 <span class="comment"></span>
01719 <span class="comment">    This function sets the corresponding bit on the bitmap table if a split </span>
01720 <span class="comment">    page condition within a native page is detected. </span>
01721 <span class="comment"></span>
01722 <span class="comment">Arguments:</span>
01723 <span class="comment"></span>
01724 <span class="comment"></span>
01725 <span class="comment">   StartVirtual - the start address of the region of pages</span>
01726 <span class="comment">        to be inspected. </span>
01727 <span class="comment"></span>
01728 <span class="comment">   EndVirtual - the end address of the region of the pages </span>
01729 <span class="comment">        to be inspected.</span>
01730 <span class="comment"></span>
01731 <span class="comment">   Bitmap - Supplies a pointer to the alternate bitmap table.</span>
01732 <span class="comment"></span>
01733 <span class="comment">   SetBit - if TRUE, set the bit on the bitmap table. Otherwise, the bit </span>
01734 <span class="comment">        is set when only when a split contidition is found.</span>
01735 <span class="comment"></span>
01736 <span class="comment">Return Value:</span>
01737 <span class="comment"></span>
01738 <span class="comment">    None</span>
01739 <span class="comment"></span>
01740 <span class="comment">--*/</span>
01741 
01742 {
01743     ULONG i;
01744     
01745     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(StartVirtual &lt;= EndVirtual);
01746     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((ULONG_PTR)StartVirtual &lt; _MAX_WOW64_ADDRESS);
01747     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((ULONG_PTR)EndVirtual &lt; _MAX_WOW64_ADDRESS);
01748 
01749     StartVirtual = <a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a>(StartVirtual);
01750 
01751     <span class="keywordflow">while</span> (StartVirtual &lt;= EndVirtual) {
01752         
01753         <span class="keywordflow">if</span> (SetBit == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01754 
01755             <span class="comment">//</span>
01756             <span class="comment">// set the bit, marking it as a split page</span>
01757             <span class="comment">//</span>
01758 
01759             <a class="code" href="../../d4/d8/mi_8h.html#a168">MI_SET_BIT</a>(Bitmap, <a class="code" href="../../d4/d8/mi_8h.html#a107">MI_VA_TO_VPN</a>(StartVirtual));
01760 
01761         } <span class="keywordflow">else</span> {
01762 
01763             <span class="comment">//</span>
01764             <span class="comment">// clear the bit, marking it as a non split page</span>
01765             <span class="comment">//</span>
01766 
01767             <a class="code" href="../../d4/d8/mi_8h.html#a169">MI_CLEAR_BIT</a>(Bitmap, <a class="code" href="../../d4/d8/mi_8h.html#a107">MI_VA_TO_VPN</a>(StartVirtual)); 
01768                 
01769         }
01770             
01771         StartVirtual = (PVOID)((ULONG_PTR)StartVirtual + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
01772     }
01773 }
01774 
01775 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
01776 MiResetAccessBitForNativePtes(
01777     IN PVOID StartVirtual,
01778     IN PVOID EndVirtual,
01779     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process
01780     )
01781 <span class="comment">/*++</span>
01782 <span class="comment"></span>
01783 <span class="comment">Routine Description:</span>
01784 <span class="comment"></span>
01785 <span class="comment">    This function resets the access bit of the native PTEs if the bitmap </span>
01786 <span class="comment">    indicates it is a split page.</span>
01787 <span class="comment"></span>
01788 <span class="comment">Arguments:</span>
01789 <span class="comment"></span>
01790 <span class="comment"></span>
01791 <span class="comment">   StartVirtual - the start address of the region of pages</span>
01792 <span class="comment">        to be inspected. </span>
01793 <span class="comment"></span>
01794 <span class="comment">   EndVirtual - the end address of the region of the pages </span>
01795 <span class="comment">        to be inspected.</span>
01796 <span class="comment"></span>
01797 <span class="comment">   Bitmap - Supplies a pointer to the process.</span>
01798 <span class="comment"></span>
01799 <span class="comment">Return Value:</span>
01800 <span class="comment"></span>
01801 <span class="comment">    None</span>
01802 <span class="comment"></span>
01803 <span class="comment">--*/</span>
01804 {
01805     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
01806     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPde;
01807     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPpe;
01808     BOOLEAN FirstTime;
01809     ULONG Waited;
01810     <a class="code" href="../../d8/d9/struct__WOW64__PROCESS.html">PWOW64_PROCESS</a> Wow64Process = Process-&gt;Wow64Process;
01811 
01812     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (StartVirtual);
01813 
01814     <a class="code" href="../../d4/d8/mi_8h.html#a155">LOCK_WS_UNSAFE</a> (Process);
01815 
01816     FirstTime = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01817 
01818     <span class="keywordflow">while</span> (StartVirtual &lt;= EndVirtual) {
01819 
01820         <span class="keywordflow">if</span> ((FirstTime == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) || <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a167">MiIsPteOnPdeBoundary</a> (PointerPte)) {
01821 
01822             PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPte);
01823             PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (PointerPte);
01824 
01825             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a168">MiDoesPpeExistAndMakeValid</a> (PointerPpe, 
01826                                             Process, 
01827                                             FALSE,
01828                                              &amp;Waited) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01829 
01830                 <span class="comment">//</span>
01831                 <span class="comment">// This page directory parent entry is empty,</span>
01832                 <span class="comment">// go to the next one.</span>
01833                 <span class="comment">//</span>
01834 
01835                 PointerPpe += 1;
01836                 PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPpe);
01837                 PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPde);
01838                 StartVirtual = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPte);
01839                 <span class="keywordflow">continue</span>;
01840             }
01841 
01842             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d2/mmsup_8c.html#a6">MiDoesPdeExistAndMakeValid</a> (PointerPde, 
01843                                             Process,
01844                                             FALSE,
01845                                             &amp;Waited) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01846 
01847 
01848                 <span class="comment">//</span>
01849                 <span class="comment">// This page directory entry is empty,</span>
01850                 <span class="comment">// go to the next one.</span>
01851                 <span class="comment">//</span>
01852 
01853                 PointerPde++;
01854                 PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a>(PointerPde);
01855                 StartVirtual = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a>(PointerPte);
01856                 <span class="keywordflow">continue</span>;
01857             }
01858                     
01859             FirstTime = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01860 
01861         }
01862             
01863         <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d8/mi_8h.html#a167">MI_CHECK_BIT</a>(Wow64Process-&gt;AltPermBitmap, <a class="code" href="../../d4/d8/mi_8h.html#a107">MI_VA_TO_VPN</a>(StartVirtual))) &amp;&amp;
01864             ((PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid != 0) &amp;&amp; (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Accessed != 0))) {
01865 
01866             PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Accessed = 0;
01867 
01868         }
01869 
01870         PointerPte += 1;
01871         StartVirtual = (PVOID)((ULONG_PTR)StartVirtual + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>); 
01872         
01873     }
01874 
01875     <a class="code" href="../../d4/d8/mi_8h.html#a159">UNLOCK_WS_UNSAFE</a> (Process);
01876 }
01877 
01878 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
01879 <a class="code" href="../../d2/d9/miia64_8h.html#a309">MiQueryRegionFor4kPage</a>(
01880     IN PVOID BaseAddress,
01881     IN PVOID EndAddress,
01882     IN OUT PSIZE_T RegionSize,
01883     IN OUT PULONG RegionState,
01884     IN OUT PULONG RegionProtect,
01885     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process
01886     )
01887 
01888 <span class="comment">/*++</span>
01889 <span class="comment"></span>
01890 <span class="comment">Routine Description:</span>
01891 <span class="comment"></span>
01892 <span class="comment">    This function checks the size of region which has the same memory </span>
01893 <span class="comment">    state.</span>
01894 <span class="comment"></span>
01895 <span class="comment">Arguments:</span>
01896 <span class="comment"></span>
01897 <span class="comment">    BaseAddress - The base address of the region of pages to be</span>
01898 <span class="comment">        queried.</span>
01899 <span class="comment"> </span>
01900 <span class="comment">    EndAddress - The end of address of the region of pages to be queried.</span>
01901 <span class="comment"></span>
01902 <span class="comment">    RegionSize - Original region size. Returns a region size for 4k pages </span>
01903 <span class="comment">                 if different.</span>
01904 <span class="comment"></span>
01905 <span class="comment">    RegionState - Original region state. Returns a region state for 4k pages </span>
01906 <span class="comment">                 if different.</span>
01907 <span class="comment"></span>
01908 <span class="comment">    RegionProtect - Original protection. Returns a protection for 4k pages </span>
01909 <span class="comment">                 if different.</span>
01910 <span class="comment"></span>
01911 <span class="comment">    Process - Supplies a pointer to the process to be queried.</span>
01912 <span class="comment"></span>
01913 <span class="comment">Return Value:</span>
01914 <span class="comment"></span>
01915 <span class="comment">    Returns the size of the region</span>
01916 <span class="comment"></span>
01917 <span class="comment">Environment:</span>
01918 <span class="comment"></span>
01919 <span class="comment"></span>
01920 <span class="comment">--*/</span>
01921 
01922 {
01923    <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> AltPte;
01924    <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> AltContents;
01925    PVOID Va;
01926    <a class="code" href="../../d8/d9/struct__WOW64__PROCESS.html">PWOW64_PROCESS</a> Wow64Process = Process-&gt;Wow64Process;
01927 
01928    AltPte = <a class="code" href="../../d2/d9/miia64_8h.html#a238">MiGetAltPteAddress</a>(BaseAddress);
01929 
01930    <a class="code" href="../../d2/d9/miia64_8h.html#a262">LOCK_ALTERNATE_TABLE</a> (Wow64Process);
01931 
01932    <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a167">MI_CHECK_BIT</a>(Wow64Process-&gt;AltPermBitmap, 
01933                      <a class="code" href="../../d4/d8/mi_8h.html#a107">MI_VA_TO_VPN</a>(BaseAddress)) == 0) {
01934 
01935        <a class="code" href="../../d2/d9/miia64_8h.html#a263">UNLOCK_ALTERNATE_TABLE</a> (Wow64Process);
01936        <span class="keywordflow">return</span>;
01937        
01938    }
01939 
01940 
01941    AltContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = AltPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long;
01942 
01943    <span class="keywordflow">if</span> (AltContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == 0) {
01944 
01945        <a class="code" href="../../d2/d9/miia64_8h.html#a263">UNLOCK_ALTERNATE_TABLE</a> (Wow64Process);
01946 
01947        <span class="keywordflow">return</span>;
01948 
01949    }
01950 
01951    <span class="keywordflow">if</span> (AltContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Alt.Commit != 0) {
01952 
01953        *RegionState = MEM_COMMIT;
01954 
01955        *RegionProtect = 
01956            <a class="code" href="../../d4/d8/mi_8h.html#a86">MI_CONVERT_FROM_PTE_PROTECTION</a>(AltContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Alt.Protection);
01957 
01958    } <span class="keywordflow">else</span> {
01959 
01960        *RegionState = MEM_RESERVE;
01961        
01962        *RegionProtect = 0;
01963 
01964    }
01965 
01966    Va = BaseAddress;
01967 
01968    <span class="keywordflow">while</span> ((ULONG_PTR)Va &lt; (ULONG_PTR)EndAddress) {
01969 
01970        Va = (PVOID)((ULONG_PTR)Va + <a class="code" href="../../d2/d9/miia64_8h.html#a227">PAGE_4K</a>);
01971        AltPte++;
01972 
01973        <span class="keywordflow">if</span> ((AltPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Alt.Protection != AltContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Alt.Protection) ||
01974            (AltPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Alt.Commit != AltContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Alt.Commit)) {
01975 
01976             <span class="comment">//</span>
01977             <span class="comment">// The state for this address does not match, calculate</span>
01978             <span class="comment">// size and return.</span>
01979             <span class="comment">//</span>
01980 
01981             <span class="keywordflow">break</span>;
01982        }
01983        
01984    } <span class="comment">// end while</span>
01985 
01986    <a class="code" href="../../d2/d9/miia64_8h.html#a263">UNLOCK_ALTERNATE_TABLE</a> (Wow64Process);
01987 
01988    *RegionSize = (SIZE_T)((ULONG_PTR)Va - (ULONG_PTR)BaseAddress);
01989 }
01990 
01991 ULONG
01992 <a class="code" href="../../d2/d9/miia64_8h.html#a310">MiQueryProtectionFor4kPage</a> (
01993     IN PVOID BaseAddress,
01994     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process
01995     )
01996 
01997 <span class="comment">/*++</span>
01998 <span class="comment"></span>
01999 <span class="comment">Routine Description:</span>
02000 <span class="comment"></span>
02001 <span class="comment">    This function queries the protection for a specified 4k page.</span>
02002 <span class="comment"></span>
02003 <span class="comment">Arguments:</span>
02004 <span class="comment"></span>
02005 <span class="comment">    BaseAddress - Supplies a base address of the 4k page. </span>
02006 <span class="comment"></span>
02007 <span class="comment">    Process - Supplies a pointer to the process to query the 4k page.</span>
02008 <span class="comment"></span>
02009 <span class="comment">Return Value:</span>
02010 <span class="comment"></span>
02011 <span class="comment">    Returns the protection of the 4k page.</span>
02012 <span class="comment"></span>
02013 <span class="comment">Environment:</span>
02014 <span class="comment"></span>
02015 <span class="comment"></span>
02016 <span class="comment">--*/</span>
02017 
02018 {
02019 
02020     ULONG Protection;
02021     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerAltPte;
02022     <a class="code" href="../../d8/d9/struct__WOW64__PROCESS.html">PWOW64_PROCESS</a> Wow64Process = Process-&gt;Wow64Process;
02023 
02024     PointerAltPte = <a class="code" href="../../d2/d9/miia64_8h.html#a238">MiGetAltPteAddress</a>(BaseAddress);
02025 
02026     <a class="code" href="../../d2/d9/miia64_8h.html#a262">LOCK_ALTERNATE_TABLE</a> (Process-&gt;Wow64Process);
02027     
02028    <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a167">MI_CHECK_BIT</a>(Wow64Process-&gt;AltPermBitmap, 
02029                      <a class="code" href="../../d4/d8/mi_8h.html#a107">MI_VA_TO_VPN</a>(BaseAddress)) == 0) {
02030 
02031        <a class="code" href="../../d2/d9/miia64_8h.html#a263">UNLOCK_ALTERNATE_TABLE</a> (Wow64Process);
02032        <span class="keywordflow">return</span> 0;
02033        
02034    }
02035 
02036     Protection = (ULONG)PointerAltPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Alt.Protection;
02037 
02038     <a class="code" href="../../d2/d9/miia64_8h.html#a263">UNLOCK_ALTERNATE_TABLE</a> (Process-&gt;Wow64Process);
02039     
02040     <span class="keywordflow">return</span> Protection;
02041     
02042 }
02043 
02044 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
02045 MiCheckPointBreak(VOID)
02046 {
02047 }
02048 
02049 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
02050 MiCheckPoint(
02051     ULONG Number
02052     )
02053 {
02054     <span class="keywordflow">if</span> (Number == MmCheckPointNumber) {
02055         
02056         MiCheckPointBreak();
02057 
02058     }
02059 }
02060 
02061 
02062 MiCheckPointBreakVirtualAddress (
02063     PVOID VirtualAddress
02064 )
02065 {
02066     ULONG Value;
02067 
02068     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d9/miia64_8h.html#a230">PAGE_4K_ALIGN</a>(VirtualAddress) == MmAddressBreak) {
02069 
02070         MiCheckPointBreak();
02071 
02072     }
02073 }
02074 
02075 
02076 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
02077 <a class="code" href="../../d2/d9/miia64_8h.html#a311">MiInitializeAlternateTable</a>(
02078     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process
02079     )
02080 <span class="comment">/*++</span>
02081 <span class="comment"></span>
02082 <span class="comment">Routine Description:</span>
02083 <span class="comment"></span>
02084 <span class="comment">    This function initializes the alternate table for the specified process.</span>
02085 <span class="comment"></span>
02086 <span class="comment">Arguments:</span>
02087 <span class="comment"></span>
02088 <span class="comment">    Process - Supplies a pointer to the process to initialize the alternate </span>
02089 <span class="comment">         table.</span>
02090 <span class="comment"></span>
02091 <span class="comment">Return Value:</span>
02092 <span class="comment"></span>
02093 <span class="comment">    STATUS_SUCCESS is returned if the alternate table was successfully initialized.</span>
02094 <span class="comment"></span>
02095 <span class="comment">    STATUS_NO_MEMORY is returned if there was not enough physical memory in the </span>
02096 <span class="comment">    system.</span>
02097 <span class="comment"></span>
02098 <span class="comment">Environment:</span>
02099 <span class="comment"></span>
02100 <span class="comment"></span>
02101 <span class="comment">--*/</span>
02102 {
02103     PULONG AltTablePointer; 
02104     <a class="code" href="../../d8/d9/struct__WOW64__PROCESS.html">PWOW64_PROCESS</a> Wow64Process = Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o78">Wow64Process</a>;
02105 
02106     AltTablePointer = (PULONG)<a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (NonPagedPool,
02107                                                     (_MAX_WOW64_ADDRESS &gt;&gt; PTI_SHIFT)/8,
02108                                                     'AlmM');
02109 
02110     <span class="keywordflow">if</span> (AltTablePointer == (PULONG) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02111         <span class="keywordflow">return</span>  STATUS_NO_MEMORY;
02112     }
02113 
02114     Wow64Process-&gt;AltPermBitmap = AltTablePointer;
02115 
02116     RtlZeroMemory(AltTablePointer, (_MAX_WOW64_ADDRESS &gt;&gt; PTI_SHIFT)/8);
02117 
02118     <a class="code" href="../../d5/d8/ex_8h.html#a8">ExInitializeFastMutex</a>(&amp;Wow64Process-&gt;AlternateTableLock);
02119 
02120     <span class="keywordflow">return</span> STATUS_SUCCESS;
02121 }
02122 
02123 
02124 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
02125 <a class="code" href="../../d2/d9/miia64_8h.html#a312">MiDeleteAlternateTable</a>(
02126     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process
02127     )
02128 <span class="comment">/*++</span>
02129 <span class="comment"></span>
02130 <span class="comment">Routine Description:</span>
02131 <span class="comment"></span>
02132 <span class="comment">    This function deletes the alternate table for the specified process.</span>
02133 <span class="comment"></span>
02134 <span class="comment">Arguments:</span>
02135 <span class="comment"></span>
02136 <span class="comment">    Process - Supplies a pointer to the process to delete the alternate </span>
02137 <span class="comment">         table.</span>
02138 <span class="comment"></span>
02139 <span class="comment">Return Value:</span>
02140 <span class="comment"></span>
02141 <span class="comment">    none</span>
02142 <span class="comment"></span>
02143 <span class="comment">Environment:</span>
02144 <span class="comment"></span>
02145 <span class="comment">    Kernel mode, APCs disabled, working set mutex held.</span>
02146 <span class="comment"></span>
02147 <span class="comment">--*/</span>
02148 
02149 {
02150 
02151     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
02152     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPde;
02153     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPpe;
02154     ULONG_PTR Va;
02155     ULONG_PTR TempVa;
02156     ULONG i;
02157     ULONG Waited;
02158     <a class="code" href="../../d9/d4/struct__MMPTE__FLUSH__LIST.html">MMPTE_FLUSH_LIST</a> PteFlushList;
02159     <a class="code" href="../../d8/d9/struct__WOW64__PROCESS.html">PWOW64_PROCESS</a> Wow64Process = Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o78">Wow64Process</a>;
02160     KIRQL OldIrql;
02161 
02162     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Wow64Process-&gt;AltPermBitmap != NULL);
02163     
02164     <span class="comment">//</span>
02165     <span class="comment">// Since Ppe for Alternate Table is shared with the hyper space,</span>
02166     <span class="comment">// we can assume it is always present without performing </span>
02167     <span class="comment">// MiDoesPpeExistAndMakeValid().</span>
02168     <span class="comment">//</span>
02169 
02170     PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a150">MiGetPpeAddress</a> (ALT4KB_PERMISSION_TABLE_START);
02171     PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (ALT4KB_PERMISSION_TABLE_START);
02172     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (ALT4KB_PERMISSION_TABLE_START);
02173 
02174     Va = <a class="code" href="../../d2/d9/miia64_8h.html#a17">ALT4KB_PERMISSION_TABLE_START</a>;
02175 
02176     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a>(OldIrql);
02177 
02178     <span class="keywordflow">while</span> (Va &lt; <a class="code" href="../../d2/d9/miia64_8h.html#a18">ALT4KB_PERMISSION_TABLE_END</a>) {
02179 
02180         <span class="keywordflow">while</span> (<a class="code" href="../../d0/d2/mmsup_8c.html#a6">MiDoesPdeExistAndMakeValid</a> (PointerPde,
02181                                            Process,
02182                                            TRUE,
02183                                            &amp;Waited) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
02184 
02185             <span class="comment">//</span>
02186             <span class="comment">// this page directory entry is empty, go to the next one.</span>
02187             <span class="comment">//</span>
02188 
02189             PointerPde += 1;
02190             PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPde);
02191             Va = (ULONG_PTR)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPte);
02192 
02193             <span class="keywordflow">if</span> (Va &gt; <a class="code" href="../../d2/d9/miia64_8h.html#a17">ALT4KB_PERMISSION_TABLE_START</a>) {
02194                 
02195                 <span class="keywordflow">goto</span> delete_end;
02196 
02197             }
02198 
02199         }
02200     
02201         <span class="comment">//</span>
02202         <span class="comment">// delete PTE entries for Altnerate Table</span>
02203         <span class="comment">//</span>
02204 
02205         TempVa = Va;
02206         <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a103">PTE_PER_PAGE</a>; i++) {
02207 
02208             <span class="keywordflow">if</span> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long != 0) {
02209 
02210                 <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a171">IS_PTE_NOT_DEMAND_ZERO</a> (*PointerPte)) {
02211 
02212                     <a class="code" href="../../d4/d8/mi_8h.html#a886">MiDeletePte</a> (PointerPte,
02213                                  (PVOID)TempVa,
02214                                  TRUE,
02215                                  Process,
02216                                  NULL,
02217                                  &amp;PteFlushList);
02218                 } <span class="keywordflow">else</span> {
02219 
02220                     *PointerPte = <a class="code" href="../../d4/d2/datalpha_8c.html#a0">ZeroPte</a>;
02221                 }
02222                                     
02223             }
02224             
02225             TempVa = <a class="code" href="../../d2/d9/miia64_8h.html#a227">PAGE_4K</a>;
02226             PointerPte += 1;
02227         }
02228 
02229         <span class="comment">//</span>
02230         <span class="comment">// delete PDE entries for Alternate Table</span>
02231         <span class="comment">//</span>
02232 
02233         TempVa = (ULONG_PTR)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a>(PointerPde);
02234         <a class="code" href="../../d4/d8/mi_8h.html#a886">MiDeletePte</a> (PointerPde,
02235                      (PVOID)TempVa,
02236                      TRUE,
02237                      Process,
02238                      NULL,
02239                      &amp;PteFlushList);
02240        
02241         
02242         <a class="code" href="../../d4/d8/mi_8h.html#a888">MiFlushPteList</a> (&amp;PteFlushList, FALSE, ZeroPte);
02243 
02244         PointerPde += 1;
02245         PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPde);
02246         Va = (ULONG_PTR)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPte);
02247         
02248     }
02249 
02250  delete_end:
02251 
02252     <a class="code" href="../../d4/d8/mi_8h.html#a888">MiFlushPteList</a> (&amp;PteFlushList, FALSE, ZeroPte);
02253 
02254     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a>(OldIrql);
02255     
02256     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (Wow64Process-&gt;AltPermBitmap);
02257 
02258     Wow64Process-&gt;AltPermBitmap = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02259 }
02260 
02261 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
02262 MiFillZeroFor4kPage (
02263     IN PVOID VirtualAddress,
02264     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process
02265     )
02266 
02267 <span class="comment">/*++</span>
02268 <span class="comment"></span>
02269 <span class="comment">Routine Description:</span>
02270 <span class="comment"></span>
02271 <span class="comment">    This function performs bzero for a specified 4k page.</span>
02272 <span class="comment"></span>
02273 <span class="comment">Arguments:</span>
02274 <span class="comment"></span>
02275 <span class="comment">    BaseAddress - Supplies a base address of the 4k page. </span>
02276 <span class="comment"></span>
02277 <span class="comment">    Process - Supplies a pointer to the process to perform bzero.</span>
02278 <span class="comment"></span>
02279 <span class="comment">Return Value:</span>
02280 <span class="comment"></span>
02281 <span class="comment">    None.</span>
02282 <span class="comment"></span>
02283 <span class="comment">Environment:</span>
02284 <span class="comment"></span>
02285 <span class="comment"></span>
02286 <span class="comment">--*/</span>
02287 
02288 {
02289     SIZE_T RegionSize = <a class="code" href="../../d2/d9/miia64_8h.html#a227">PAGE_4K</a>;
02290     PVOID BaseAddress;
02291     ULONG OldProtect;
02292     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02293     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerAltPte;
02294     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPde;
02295     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPpe;
02296     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
02297     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempAltContents;
02298     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> PteContents;
02299     ULONG Waited;
02300     <a class="code" href="../../d8/d9/struct__WOW64__PROCESS.html">PWOW64_PROCESS</a> Wow64Process = Process-&gt;Wow64Process;
02301 
02302     PointerAltPte = <a class="code" href="../../d2/d9/miia64_8h.html#a238">MiGetAltPteAddress</a> (VirtualAddress);
02303 
02304     <a class="code" href="../../d2/d9/miia64_8h.html#a262">LOCK_ALTERNATE_TABLE</a> (Wow64Process);
02305 
02306     <span class="keywordflow">if</span> (PointerAltPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Alt.FillZero == 0) {
02307 
02308         <span class="comment">//</span>
02309         <span class="comment">// Some one has already completed the bzero operations.</span>
02310         <span class="comment">//</span>
02311 
02312         <a class="code" href="../../d2/d9/miia64_8h.html#a263">UNLOCK_ALTERNATE_TABLE</a> (Wow64Process);
02313 
02314         <span class="keywordflow">return</span>;
02315 
02316     }
02317 
02318     <span class="comment">//</span>
02319     <span class="comment">// make PPE and PDE exist and valid</span>
02320     <span class="comment">//</span>
02321 
02322     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(VirtualAddress);
02323     PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a>(VirtualAddress);
02324     PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a150">MiGetPpeAddress</a>(VirtualAddress);
02325 
02326     <span class="comment">//</span>
02327     <span class="comment">// make the page table for the original PTE exit to satisfy </span>
02328     <span class="comment">// the TLB forward progress for the TLB indirect fault</span>
02329     <span class="comment">// </span>
02330 
02331     <a class="code" href="../../d4/d8/mi_8h.html#a154">LOCK_WS</a> (Process);
02332 
02333     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a168">MiDoesPpeExistAndMakeValid</a> (PointerPpe,
02334                                     Process,
02335                                     FALSE,
02336                                     &amp;Waited) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
02337         PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = 0;
02338     
02339     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d0/d2/mmsup_8c.html#a6">MiDoesPdeExistAndMakeValid</a> (PointerPde,
02340                                            Process,
02341                                            FALSE,
02342                                            &amp;Waited) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
02343 
02344         PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = 0;
02345 
02346     } <span class="keywordflow">else</span> {
02347 
02348         <span class="comment">//</span>
02349         <span class="comment">// if it is safe to read PointerPte</span>
02350         <span class="comment">//</span>
02351 
02352         PteContents = *PointerPte;
02353 
02354     }
02355 
02356     TempAltContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = PointerAltPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long;
02357 
02358     <span class="keywordflow">if</span> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid != 0) { 
02359 
02360         BaseAddress = KSEG_ADDRESS(PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber);
02361 
02362         BaseAddress = 
02363             (PVOID)((ULONG_PTR)BaseAddress + 
02364                     ((ULONG_PTR)<a class="code" href="../../d2/d9/miia64_8h.html#a230">PAGE_4K_ALIGN</a>(VirtualAddress) &amp; (<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>-1)));
02365 
02366         RtlZeroMemory(BaseAddress, PAGE_4K);
02367 
02368         <a class="code" href="../../d4/d8/mi_8h.html#a158">UNLOCK_WS</a> (Process);
02369 
02370         TempAltContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Alt.FillZero = 0;
02371         TempAltContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Alt.Accessed = 1;
02372 
02373     } <span class="keywordflow">else</span> {
02374 
02375         <a class="code" href="../../d4/d8/mi_8h.html#a158">UNLOCK_WS</a> (Process);
02376 
02377         TempAltContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Alt.Accessed = 0;
02378 
02379     }
02380 
02381     PointerAltPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = TempAltContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long;
02382 
02383     <a class="code" href="../../d2/d9/miia64_8h.html#a263">UNLOCK_ALTERNATE_TABLE</a> (Wow64Process);
02384 }
02385 
02386 <span class="preprocessor">#define USE_MAPVIEW 1</span>
02387 <span class="preprocessor"></span>
02388 <span class="preprocessor">#if !USE_MAPVIEW</span>
02389 <span class="preprocessor"></span><a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
02390 MiCreateAliasOfDataSection(
02391     IN <a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a> ControlArea,
02392     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process,
02393     IN PVOID *CapturedBase,
02394     IN PLARGE_INTEGER SectionOffset,
02395     IN PSIZE_T CapturedViewSize,
02396     IN ULONG ProtectionMask,
02397     OUT <a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a> *Vad
02398     )
02399 <span class="comment">/*++</span>
02400 <span class="comment"></span>
02401 <span class="comment">Routine Description:</span>
02402 <span class="comment"></span>
02403 <span class="comment">    This is a simplified version of MiMapViewOfSection and creates an alias  </span>
02404 <span class="comment">    map view for the exsiting map view space. </span>
02405 <span class="comment"></span>
02406 <span class="comment">Arguments:</span>
02407 <span class="comment"></span>
02408 <span class="comment">    See MmMapViewOfSection.</span>
02409 <span class="comment"></span>
02410 <span class="comment">    ControlArea - Supplies the control area for the section.</span>
02411 <span class="comment"></span>
02412 <span class="comment">    Process - Supplies the process pointer which is receiving the section.</span>
02413 <span class="comment"></span>
02414 <span class="comment">    ProtectionMask - Supplies the initial page protection-mask.</span>
02415 <span class="comment"></span>
02416 <span class="comment">    Vad - Returns a pointer to the pointer to the VAD containing the new alias</span>
02417 <span class="comment">          map view.</span>
02418 <span class="comment">   </span>
02419 <span class="comment">Return Value:</span>
02420 <span class="comment"></span>
02421 <span class="comment">    Returns a NT status code.</span>
02422 <span class="comment"></span>
02423 <span class="comment">Environment:</span>
02424 <span class="comment"></span>
02425 <span class="comment">    Kernel mode, address creating mutex held.</span>
02426 <span class="comment">    APCs disabled.</span>
02427 <span class="comment"></span>
02428 <span class="comment">--*/</span>
02429 
02430 {
02431     ULONG_PTR Alignment;
02432     KIRQL OldIrql;
02433     <a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a> Subsection;
02434     ULONG PteOffset;
02435     PVOID NewStartingAddress;
02436     PVOID NewEndingAddress;
02437     <a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a> NewVad;
02438     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> TheFirstPrototypePte;
02439 
02440     <span class="comment">//</span>
02441     <span class="comment">// Calculate the first prototype PTE field in the Vad.</span>
02442     <span class="comment">//</span>
02443 
02444     Subsection = (<a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a>)(ControlArea + 1);
02445 
02446     Alignment = <a class="code" href="../../d4/d8/mi_8h.html#a18">X64K</a>;
02447 
02448     SectionOffset-&gt;LowPart = SectionOffset-&gt;LowPart &amp; ~((ULONG)Alignment - 1);
02449     PteOffset = (ULONG)(SectionOffset-&gt;QuadPart &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
02450 
02451     <span class="comment">//</span>
02452     <span class="comment">// Make sure the PTEs are not in the extended part of the</span>
02453     <span class="comment">// segment.</span>
02454     <span class="comment">//</span>
02455 
02456     <span class="keywordflow">if</span> (PteOffset &gt;= ControlArea-&gt;Segment-&gt;TotalNumberOfPtes) {
02457         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02458         ControlArea-&gt;NumberOfMappedViews -= 1;
02459         ControlArea-&gt;NumberOfUserReferences -= 1;
02460         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02461         <span class="keywordflow">return</span> STATUS_INVALID_VIEW_SIZE;
02462     }
02463 
02464     <span class="keywordflow">while</span> (PteOffset &gt;= Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o8">PtesInSubsection</a>) {
02465         PteOffset -= Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o8">PtesInSubsection</a>;
02466         Subsection = Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o9">NextSubsection</a>;
02467         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Subsection != NULL);
02468     }
02469 
02470     TheFirstPrototypePte = &amp;Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o6">SubsectionBase</a>[PteOffset];
02471 
02472     <a class="code" href="../../d4/d8/mi_8h.html#a155">LOCK_WS_UNSAFE</a> (Process);
02473 
02474     <span class="keywordflow">try</span> {
02475 
02476         <span class="comment">//</span>
02477         <span class="comment">// Find a starting address on a 64k boundary.</span>
02478         <span class="comment">//</span>
02479 
02480         NewStartingAddress = <a class="code" href="../../d6/d3/vadtree_8c.html#a3">MiFindEmptyAddressRange</a> (*CapturedViewSize,
02481                                                       X64K,
02482                                                       (ULONG)0);
02483     } except (EXCEPTION_EXECUTE_HANDLER) {
02484 
02485         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02486         ControlArea-&gt;NumberOfMappedViews -= 1;
02487         ControlArea-&gt;NumberOfUserReferences -= 1;
02488         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02489 
02490         <a class="code" href="../../d4/d8/mi_8h.html#a159">UNLOCK_WS_UNSAFE</a>(Process);
02491 
02492         <span class="keywordflow">return</span> GetExceptionCode();
02493     }
02494 
02495     NewEndingAddress = (PVOID)(((ULONG_PTR)NewStartingAddress +
02496                                 *CapturedViewSize - 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>) | (<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>));
02497 
02498     <span class="comment">//</span>
02499     <span class="comment">// An unoccupied address range has been found, build the virtual</span>
02500     <span class="comment">// address descriptor to describe this range.</span>
02501     <span class="comment">//</span>
02502 
02503     <span class="keywordflow">try</span>  {
02504 
02505         NewVad = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (NonPagedPool,
02506                                         <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d6/struct__MMVAD.html">MMVAD</a>),
02507                                         MMVADKEY);
02508         <span class="keywordflow">if</span> (NewVad == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02509             <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a> (STATUS_INSUFFICIENT_RESOURCES);
02510         }
02511         RtlZeroMemory (NewVad, <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d6/struct__MMVAD.html">MMVAD</a>));
02512 
02513         NewVad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o0">StartingVpn</a> = <a class="code" href="../../d4/d8/mi_8h.html#a107">MI_VA_TO_VPN</a> (NewStartingAddress);
02514         NewVad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o1">EndingVpn</a> = <a class="code" href="../../d4/d8/mi_8h.html#a107">MI_VA_TO_VPN</a> (NewEndingAddress);
02515         NewVad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o9">FirstPrototypePte</a> = TheFirstPrototypePte;
02516 
02517         <span class="comment">//</span>
02518         <span class="comment">// Set the protection in the PTE template field of the VAD.</span>
02519         <span class="comment">//</span>
02520 
02521         NewVad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o8">ControlArea</a> = ControlArea;
02522 
02523         NewVad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.VadFlags2.Inherit = 1;
02524         NewVad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.Protection = ProtectionMask;
02525         NewVad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.VadFlags2.CopyOnWrite = 0;
02526 
02527         <span class="comment">//</span>
02528         <span class="comment">// Note that for MEM_DOS_LIM significance is lost here, but those</span>
02529         <span class="comment">// files are not mapped MEM_RESERVE.</span>
02530         <span class="comment">//</span>
02531 
02532         NewVad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o13">u2</a>.VadFlags2.FileOffset = (ULONG)(SectionOffset-&gt;QuadPart &gt;&gt; 16);
02533 
02534         <span class="comment">//</span>
02535         <span class="comment">// If this is a page file backed section, charge the process's page</span>
02536         <span class="comment">// file quota as if all the pages have been committed.  This solves</span>
02537         <span class="comment">// the problem when other processes commit all the pages and leave</span>
02538         <span class="comment">// only one process around who may not have been charged the proper</span>
02539         <span class="comment">// quota.  This is solved by charging everyone the maximum quota.</span>
02540         <span class="comment">//</span>
02541 
02542         PteOffset += (ULONG)(NewVad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o1">EndingVpn</a> - NewVad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o0">StartingVpn</a>);
02543 
02544         <span class="keywordflow">if</span> (PteOffset &lt; Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o8">PtesInSubsection</a> ) {
02545             NewVad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o10">LastContiguousPte</a> = &amp;Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o6">SubsectionBase</a>[PteOffset];
02546 
02547         } <span class="keywordflow">else</span> {
02548             NewVad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o10">LastContiguousPte</a> = &amp;Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o6">SubsectionBase</a>[
02549                                         (Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o8">PtesInSubsection</a> - 1) +
02550                                         Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o7">UnusedPtes</a>];
02551         }
02552 
02553         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (NewVad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o9">FirstPrototypePte</a> &lt;= NewVad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o10">LastContiguousPte</a>);
02554         <a class="code" href="../../d6/d3/vadtree_8c.html#a0">MiInsertVad</a> (NewVad);
02555 
02556     } except (EXCEPTION_EXECUTE_HANDLER) {
02557 
02558         <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
02559         ControlArea-&gt;NumberOfMappedViews -= 1;
02560         ControlArea-&gt;NumberOfUserReferences -= 1;
02561         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
02562 
02563         <span class="keywordflow">if</span> (NewVad != (<a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02564 
02565             <span class="comment">//</span>
02566             <span class="comment">// The pool allocation succeeded, but the quota charge</span>
02567             <span class="comment">// in InsertVad failed, deallocate the pool and return</span>
02568             <span class="comment">// an error.</span>
02569             <span class="comment">//</span>
02570 
02571             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (NewVad);
02572 
02573             <a class="code" href="../../d4/d8/mi_8h.html#a159">UNLOCK_WS_UNSAFE</a> (Process);
02574 
02575             <span class="keywordflow">return</span> GetExceptionCode();
02576         }
02577         
02578         <a class="code" href="../../d4/d8/mi_8h.html#a159">UNLOCK_WS_UNSAFE</a> (Process);
02579 
02580         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
02581     }
02582 
02583     <a class="code" href="../../d4/d8/mi_8h.html#a159">UNLOCK_WS_UNSAFE</a> (Process);
02584 
02585     <span class="comment">//</span>
02586     <span class="comment">// Update the current virtual size in the process header.</span>
02587     <span class="comment">//</span>
02588 
02589     *CapturedViewSize = (PCHAR)NewEndingAddress - (PCHAR)NewStartingAddress + 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
02590 
02591     Process-&gt;VirtualSize += *CapturedViewSize;
02592 
02593     <span class="keywordflow">if</span> (Process-&gt;VirtualSize &gt; Process-&gt;PeakVirtualSize) {
02594         Process-&gt;PeakVirtualSize = Process-&gt;VirtualSize;
02595     }
02596 
02597     *CapturedBase = NewStartingAddress;
02598 
02599     *Vad = NewVad;
02600 
02601     <span class="keywordflow">return</span> STATUS_SUCCESS;
02602 }
02603 <span class="preprocessor">#endif</span>
02604 <span class="preprocessor"></span>
02605 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
02606 MiSetCopyPagesFor4kPage(
02607     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process,
02608     IN OUT <a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a> *Vad,
02609     IN OUT PVOID *StartingAddress,
02610     IN OUT PVOID *EndingAddress,
02611     IN ULONG NewProtection
02612     )
02613 <span class="comment">/*++</span>
02614 <span class="comment"></span>
02615 <span class="comment">Routine Description:</span>
02616 <span class="comment"></span>
02617 <span class="comment">    This function creates another map for the existing mapped view space then give </span>
02618 <span class="comment">    copy-on-write protection. This function is called when SetProtectionOnSection() </span>
02619 <span class="comment">    tries to change the protection from non copy-on-write to copy-on-write. Since a </span>
02620 <span class="comment">    large native page cannot be broken to shared and copy-on-written 4kb pages, </span>
02621 <span class="comment">    references to the copy-on-written page(s) needs to fixed to reference to </span>
02622 <span class="comment">    the new mapped view space and this should be done through the smart tlb handler</span>
02623 <span class="comment">    and the alternate page table entries.</span>
02624 <span class="comment"></span>
02625 <span class="comment">Arguments:</span>
02626 <span class="comment"></span>
02627 <span class="comment">    Process - Supplies a EPROCESS pointer of the current process.</span>
02628 <span class="comment"></span>
02629 <span class="comment">    Vad - Supplies a pointer to the pointer to the VAD containing the range to </span>
02630 <span class="comment">          protect.</span>
02631 <span class="comment">   </span>
02632 <span class="comment">    StartingAddress - Supplies a pointer to the starting address to protect.</span>
02633 <span class="comment"></span>
02634 <span class="comment">    EndingAddress - Supplies a pointer to the ending address to the protect.</span>
02635 <span class="comment"></span>
02636 <span class="comment">    NewProtect - Supplies the new protection to set.</span>
02637 <span class="comment"></span>
02638 <span class="comment">Return Value:</span>
02639 <span class="comment"></span>
02640 <span class="comment">    Returns a NT status code.</span>
02641 <span class="comment"></span>
02642 <span class="comment">Environment:</span>
02643 <span class="comment"></span>
02644 <span class="comment">    Kernel mode, working set mutex held, address creating mutex held</span>
02645 <span class="comment">    APCs disabled.</span>
02646 <span class="comment"></span>
02647 <span class="comment">--*/</span>
02648 {
02649     LARGE_INTEGER SectionOffset;
02650     SIZE_T CapturedViewSize;
02651     PVOID CapturedBase;
02652     PVOID Va;
02653     PVOID VaEnd;
02654     PVOID Alias;
02655     <a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a> NewVad;
02656     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
02657     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> AltPte;
02658 <span class="preprocessor">#if USE_MAPVIEW</span>
02659 <span class="preprocessor"></span>    BOOLEAN ReleasedWsMutex;
02660     <a class="code" href="../../d5/d0/struct__SECTION.html">SECTION</a> Section;
02661     <a class="code" href="../../d8/d7/struct__CONTROL__AREA.html">PCONTROL_AREA</a> ControlArea;
02662 <span class="preprocessor">#endif</span>
02663 <span class="preprocessor"></span>    <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
02664 
02665     SectionOffset.QuadPart = (ULONG_PTR)*StartingAddress - 
02666         (ULONG_PTR)((*Vad)-&gt;StartingVpn &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
02667 
02668     CapturedBase = (PVOID)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02669     CapturedViewSize = (ULONG_PTR)*EndingAddress - (ULONG_PTR)*StartingAddress + 1;
02670 
02671 <span class="preprocessor">#if USE_MAPVIEW</span>
02672 <span class="preprocessor"></span>
02673     ControlArea = (*Vad)-&gt;ControlArea;
02674 
02675     RtlZeroMemory((PVOID)&amp;Section, <span class="keyword">sizeof</span>(Section));
02676 
02677     ReleasedWsMutex = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02678 
02679     <a class="code" href="../../d4/d8/mi_8h.html#a159">UNLOCK_WS_UNSAFE</a> (Process);
02680 
02681     status = <a class="code" href="../../d3/d5/mapview_8c.html#a24">MiMapViewOfDataSection</a> (ControlArea,
02682                                      Process,
02683                                      &amp;CapturedBase,
02684                                      &amp;SectionOffset,
02685                                      &amp;CapturedViewSize,
02686                                      &amp;Section,
02687                                      ViewShare,
02688                                      (ULONG)(*Vad)-&gt;u.VadFlags.Protection,
02689                                      0,
02690                                      0,
02691                                      0,
02692                                      &amp;ReleasedWsMutex);
02693         
02694     <span class="keywordflow">if</span> (!ReleasedWsMutex) {
02695         <a class="code" href="../../d4/d8/mi_8h.html#a159">UNLOCK_WS_UNSAFE</a> (Process);
02696     }
02697 
02698     <span class="keywordflow">if</span> (status != STATUS_SUCCESS) {
02699 
02700         <span class="keywordflow">return</span> status;
02701     }    
02702 
02703     NewVad = <a class="code" href="../../d6/d3/vadtree_8c.html#a2">MiLocateAddress</a>(CapturedBase);
02704 
02705     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(NewVad != (<a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a>)NULL);
02706 
02707 <span class="preprocessor">#else</span>
02708 <span class="preprocessor"></span>
02709     <a class="code" href="../../d4/d8/mi_8h.html#a159">UNLOCK_WS_UNSAFE</a> (Process);
02710 
02711     status = MiCreateAliasOfDataSection((*Vad)-&gt;ControlArea,
02712                                         Process,
02713                                         &amp;CapturedBase,
02714                                         &amp;SectionOffset,
02715                                         &amp;CapturedViewSize,
02716                                         (ULONG)(*Vad)-&gt;u.VadFlags.Protection,
02717                                         &amp;NewVad);
02718     <span class="keywordflow">if</span> (status != STATUS_SUCCESS) {
02719 
02720         <a class="code" href="../../d4/d8/mi_8h.html#a155">LOCK_WS_UNSAFE</a> (Process);
02721         <span class="keywordflow">return</span> status;
02722     }    
02723 
02724 
02725 <span class="preprocessor">#endif</span>
02726 <span class="preprocessor"></span>
02727     <a class="code" href="../../d2/d9/miia64_8h.html#a262">LOCK_ALTERNATE_TABLE</a> (Process-&gt;Wow64Process);
02728 
02729     Va = *StartingAddress;
02730     VaEnd = *EndingAddress;
02731     Alias = CapturedBase;
02732 
02733     <span class="keywordflow">while</span> (Va &lt;= VaEnd) {
02734 
02735         AltPte = <a class="code" href="../../d2/d9/miia64_8h.html#a238">MiGetAltPteAddress</a> (Va);
02736         PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (Alias);
02737         <span class="keywordflow">if</span> (AltPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Alt.CopyOnWrite == 1) {
02738             AltPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Alt.PteOffset = (ULONG_PTR)PointerPte - PTE_UBASE;
02739             AltPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Alt.PteIndirect = 1;
02740         }
02741 
02742         Va = (PVOID)((ULONG_PTR)Va + <a class="code" href="../../d2/d9/miia64_8h.html#a227">PAGE_4K</a>);
02743         Alias = (PVOID)((ULONG_PTR)Alias + <a class="code" href="../../d2/d9/miia64_8h.html#a227">PAGE_4K</a>);
02744     }
02745         
02746     <a class="code" href="../../d2/d9/miia64_8h.html#a316">MiMarkSplitPages</a>(*StartingAddress, 
02747                      *EndingAddress,
02748                      Process-&gt;Wow64Process-&gt;AltPermBitmap,
02749                      TRUE);
02750 
02751     <a class="code" href="../../d2/d9/miia64_8h.html#a263">UNLOCK_ALTERNATE_TABLE</a> (Process-&gt;Wow64Process);
02752 
02753     <a class="code" href="../../d4/d8/mi_8h.html#a155">LOCK_WS_UNSAFE</a> (Process);
02754 
02755     Process-&gt;Wow64Process-&gt;AltFlags |= <a class="code" href="../../d2/d9/miia64_8h.html#a239">MI_ALTFLG_FLUSH2G</a>;
02756 
02757     *Vad = NewVad;
02758     *StartingAddress = CapturedBase;
02759     *EndingAddress = (PVOID)((ULONG_PTR)CapturedBase + CapturedViewSize - 1<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>);
02760 
02761     <span class="keywordflow">return</span> STATUS_SUCCESS;
02762 }    
02763 
02764 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
02765 <a class="code" href="../../d2/d9/miia64_8h.html#a313">MiLockFor4kPage</a>(
02766     PVOID CapturedBase,
02767     SIZE_T CapturedRegionSize,
02768     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process
02769     )
02770 <span class="comment">/*++</span>
02771 <span class="comment"></span>
02772 <span class="comment">Routine Description:</span>
02773 <span class="comment"></span>
02774 <span class="comment">    This function adds the page locked attributes to the alternate table entries.</span>
02775 <span class="comment"></span>
02776 <span class="comment">Arguments:</span>
02777 <span class="comment"></span>
02778 <span class="comment">    CapturedBase - Supplies the base address to be locked.</span>
02779 <span class="comment"></span>
02780 <span class="comment">    CapturedREgionSize - Supplies the size of the region to be locked.</span>
02781 <span class="comment"></span>
02782 <span class="comment">    Process - Supplies a pointer to the process object.</span>
02783 <span class="comment">   </span>
02784 <span class="comment">    </span>
02785 <span class="comment">Return Value:</span>
02786 <span class="comment"></span>
02787 <span class="comment">    None.</span>
02788 <span class="comment"></span>
02789 <span class="comment">Environment:</span>
02790 <span class="comment"></span>
02791 <span class="comment">    Kernel mode, the address creation mutex is held.</span>
02792 <span class="comment"></span>
02793 <span class="comment">--*/</span>
02794 {
02795     <a class="code" href="../../d8/d9/struct__WOW64__PROCESS.html">PWOW64_PROCESS</a> Wow64Process = Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o78">Wow64Process</a>;
02796     PVOID EndingAddress;
02797     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> StartAltPte;
02798     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> EndAltPte;
02799 
02800     EndingAddress = (PVOID)((ULONG_PTR)CapturedBase + CapturedRegionSize - 1);
02801 
02802     StartAltPte = <a class="code" href="../../d2/d9/miia64_8h.html#a238">MiGetAltPteAddress</a>(CapturedBase);
02803     EndAltPte = <a class="code" href="../../d2/d9/miia64_8h.html#a238">MiGetAltPteAddress</a>(EndingAddress);
02804 
02805     <a class="code" href="../../d2/d9/miia64_8h.html#a262">LOCK_ALTERNATE_TABLE</a> (Wow64Process);
02806     
02807     <span class="keywordflow">while</span> (StartAltPte &lt;= EndAltPte) {
02808 
02809         StartAltPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Alt.Lock = 1;
02810         StartAltPte++;
02811 
02812     }
02813 
02814     <a class="code" href="../../d2/d9/miia64_8h.html#a263">UNLOCK_ALTERNATE_TABLE</a> (Wow64Process);
02815 
02816 }
02817 
02818 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
02819 <a class="code" href="../../d2/d9/miia64_8h.html#a314">MiUnlockFor4kPage</a>(
02820     PVOID CapturedBase,
02821     SIZE_T CapturedRegionSize,
02822     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process
02823     )
02824 <span class="comment">/*++</span>
02825 <span class="comment"></span>
02826 <span class="comment">Routine Description:</span>
02827 <span class="comment"></span>
02828 <span class="comment">    This function removes the page locked attributes from the alternate table entries.</span>
02829 <span class="comment"></span>
02830 <span class="comment">Arguments:</span>
02831 <span class="comment"></span>
02832 <span class="comment">    CapturedBase - Supplies the base address to be unlocked.</span>
02833 <span class="comment"></span>
02834 <span class="comment">    CapturedREgionSize - Supplies the size of the region to be unlocked.</span>
02835 <span class="comment"></span>
02836 <span class="comment">    Process - Supplies a pointer to the process object.</span>
02837 <span class="comment">   </span>
02838 <span class="comment">    </span>
02839 <span class="comment">Return Value:</span>
02840 <span class="comment"></span>
02841 <span class="comment">    None.</span>
02842 <span class="comment"></span>
02843 <span class="comment">Environment:</span>
02844 <span class="comment"></span>
02845 <span class="comment">    Kernel mode, the address creation mutex is held.</span>
02846 <span class="comment"></span>
02847 <span class="comment">--*/</span>
02848 {
02849     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> StartAltPte;
02850     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> EndAltPte;
02851     <a class="code" href="../../d8/d9/struct__WOW64__PROCESS.html">PWOW64_PROCESS</a> Wow64Process = Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o78">Wow64Process</a>;
02852     PVOID EndingAddress;
02853     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
02854 
02855     EndingAddress = (PVOID)((ULONG_PTR)CapturedBase + CapturedRegionSize - 1);
02856 
02857     StartAltPte = <a class="code" href="../../d2/d9/miia64_8h.html#a238">MiGetAltPteAddress</a>(CapturedBase);
02858     EndAltPte = <a class="code" href="../../d2/d9/miia64_8h.html#a238">MiGetAltPteAddress</a>(EndingAddress);
02859 
02860     <span class="comment">//</span>
02861     <span class="comment">// unlock the working set mutex</span>
02862     <span class="comment">//</span>
02863 
02864     <a class="code" href="../../d4/d8/mi_8h.html#a159">UNLOCK_WS_UNSAFE</a> (Process);
02865 
02866     <a class="code" href="../../d2/d9/miia64_8h.html#a262">LOCK_ALTERNATE_TABLE</a> (Wow64Process);
02867     
02868     <span class="keywordflow">while</span> (StartAltPte &lt;= EndAltPte) {
02869 
02870         <span class="keywordflow">if</span> (StartAltPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Alt.Lock == 0) {
02871 
02872             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NOT_LOCKED;
02873             <span class="keywordflow">goto</span> StatusReturn;
02874 
02875         }
02876 
02877         StartAltPte++;
02878     }
02879 
02880     StartAltPte = <a class="code" href="../../d2/d9/miia64_8h.html#a238">MiGetAltPteAddress</a>(CapturedBase);
02881 
02882     <span class="keywordflow">while</span> (StartAltPte &lt;= EndAltPte) {
02883 
02884         StartAltPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Alt.Lock = 0;
02885 
02886         StartAltPte++;
02887     }
02888 
02889 StatusReturn:
02890 
02891     <a class="code" href="../../d2/d9/miia64_8h.html#a263">UNLOCK_ALTERNATE_TABLE</a> (Wow64Process);
02892 
02893     <a class="code" href="../../d4/d8/mi_8h.html#a155">LOCK_WS_UNSAFE</a> (Process);
02894 
02895     <span class="keywordflow">return</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
02896 }
02897 
02898 BOOLEAN
02899 <a class="code" href="../../d2/d9/miia64_8h.html#a315">MiShouldBeUnlockedFor4kPage</a>(
02900     PVOID VirtualAddress,
02901     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process
02902     )
02903 <span class="comment">/*++</span>
02904 <span class="comment"></span>
02905 <span class="comment">Routine Description:</span>
02906 <span class="comment"></span>
02907 <span class="comment">    This function examines whether the pape should be unlocked.</span>
02908 <span class="comment"></span>
02909 <span class="comment">Arguments:</span>
02910 <span class="comment"></span>
02911 <span class="comment">    VirtualAddress - Supplies the virtual address to be examined.</span>
02912 <span class="comment"></span>
02913 <span class="comment">    Process - Supplies a pointer to the process object.</span>
02914 <span class="comment">   </span>
02915 <span class="comment">    </span>
02916 <span class="comment">Return Value:</span>
02917 <span class="comment"></span>
02918 <span class="comment">    None.</span>
02919 <span class="comment"></span>
02920 <span class="comment">Environment:</span>
02921 <span class="comment"></span>
02922 <span class="comment">    Kernel mode, the working set mutex is held and the address </span>
02923 <span class="comment">    creation mutex is held.</span>
02924 <span class="comment"></span>
02925 <span class="comment">--*/</span>
02926 {
02927     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerAltPte;
02928     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> StartAltPte;
02929     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> EndAltPte;
02930     <a class="code" href="../../d8/d9/struct__WOW64__PROCESS.html">PWOW64_PROCESS</a> Wow64Process = Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o78">Wow64Process</a>;
02931     PVOID VirtualAligned;
02932     PVOID EndingAddress;
02933     BOOLEAN PageUnlocked = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02934 
02935     VirtualAligned = <a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a>(VirtualAddress);
02936     EndingAddress = (PVOID)((ULONG_PTR)VirtualAligned + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1);
02937 
02938     StartAltPte = <a class="code" href="../../d2/d9/miia64_8h.html#a238">MiGetAltPteAddress</a>(VirtualAligned);
02939     EndAltPte = <a class="code" href="../../d2/d9/miia64_8h.html#a238">MiGetAltPteAddress</a>(EndingAddress);
02940 
02941     <span class="comment">//</span>
02942     <span class="comment">// unlock the working set mutex</span>
02943     <span class="comment">//</span>
02944 
02945     <a class="code" href="../../d4/d8/mi_8h.html#a159">UNLOCK_WS_UNSAFE</a> (Process);
02946 
02947     <a class="code" href="../../d2/d9/miia64_8h.html#a262">LOCK_ALTERNATE_TABLE</a> (Wow64Process);
02948 
02949     <span class="keywordflow">while</span> (StartAltPte &lt;= EndAltPte) {
02950 
02951         <span class="keywordflow">if</span> (StartAltPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Alt.Lock != 0) {
02952             PageUnlocked = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02953         }
02954 
02955         StartAltPte++;
02956     }
02957 
02958     <a class="code" href="../../d2/d9/miia64_8h.html#a263">UNLOCK_ALTERNATE_TABLE</a> (Wow64Process);
02959 
02960     <a class="code" href="../../d4/d8/mi_8h.html#a155">LOCK_WS_UNSAFE</a> (Process);
02961 
02962     <span class="keywordflow">return</span> (PageUnlocked);
02963 }
02964 
02965 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
02966 MiCopyOnWriteFor4kPage(
02967     PVOID VirtualAddress,
02968     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process
02969     )
02970 <span class="comment">/*++</span>
02971 <span class="comment"></span>
02972 <span class="comment">Routine Description:</span>
02973 <span class="comment"></span>
02974 <span class="comment">    This function changes the protection of the alt pages for a copy on </span>
02975 <span class="comment">    written native page. </span>
02976 <span class="comment"></span>
02977 <span class="comment">Arguments:</span>
02978 <span class="comment"></span>
02979 <span class="comment">    VirtualAddress - Supplies the virtual address which caused the </span>
02980 <span class="comment">                     copy-on-written.</span>
02981 <span class="comment"></span>
02982 <span class="comment">    Process - Supplies a pointer to the process object.</span>
02983 <span class="comment"></span>
02984 <span class="comment">Return Value: </span>
02985 <span class="comment"></span>
02986 <span class="comment">    None.</span>
02987 <span class="comment"></span>
02988 <span class="comment">Environment:</span>
02989 <span class="comment"></span>
02990 <span class="comment">    Kernel mode, alternate table lock is held.</span>
02991 <span class="comment"></span>
02992 <span class="comment">--**/</span>
02993 {
02994     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerAltPte;
02995     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempAltPte;
02996     ULONG i;
02997     
02998     PointerAltPte = <a class="code" href="../../d2/d9/miia64_8h.html#a238">MiGetAltPteAddress</a>(<a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a>(VirtualAddress));
02999     
03000     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d2/d9/miia64_8h.html#a234">SPLITS_PER_PAGE</a>; i++) {
03001      
03002         TempAltPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = PointerAltPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long;
03003 
03004         <span class="keywordflow">if</span> ((TempAltPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Alt.Commit != 0) &amp;&amp; 
03005             (TempAltPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Alt.CopyOnWrite != 0)) {
03006 
03007             TempAltPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Alt.CopyOnWrite = 0;
03008             TempAltPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Alt.Private = 1;
03009             TempAltPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Write = 1;
03010 
03011             TempAltPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Alt.Protection = 
03012                     <a class="code" href="../../d4/d8/mi_8h.html#a112">MI_MAKE_PROTECT_NOT_WRITE_COPY</a>(PointerAltPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Alt.Protection);
03013 
03014         } <span class="keywordflow">else</span> {
03015 
03016             <span class="comment">//</span>
03017             <span class="comment">// make IA64 binary work</span>
03018             <span class="comment">//</span>
03019 
03020             TempAltPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Alt.Private = 1;
03021 
03022             MiCheckPointBreak();
03023 
03024         }
03025         
03026         <span class="comment">//</span>
03027         <span class="comment">// atomic PTE update</span>
03028         <span class="comment">//</span>
03029 
03030         PointerAltPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = TempAltPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long;
03031         PointerAltPte++;
03032     }
03033 }
03034 
03035 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
03036 MiCheckDemandZeroCopyOnWriteFor4kPage(
03037     PVOID VirtualAddress,
03038     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process
03039     )
03040 <span class="comment">/*++</span>
03041 <span class="comment"></span>
03042 <span class="comment">Routine Description:</span>
03043 <span class="comment"></span>
03044 <span class="comment">    This function changes the protection of the alt pages for a copy on </span>
03045 <span class="comment">    written native page. </span>
03046 <span class="comment"></span>
03047 <span class="comment">Arguments:</span>
03048 <span class="comment"></span>
03049 <span class="comment">    VirtualAddress - Supplies the virtual address which caused the </span>
03050 <span class="comment">                     copy-on-written.</span>
03051 <span class="comment"></span>
03052 <span class="comment">    Process - Supplies a pointer to the process object.</span>
03053 <span class="comment"></span>
03054 <span class="comment">Return Value: </span>
03055 <span class="comment"></span>
03056 <span class="comment">    None.</span>
03057 <span class="comment"></span>
03058 <span class="comment">Environment:</span>
03059 <span class="comment"></span>
03060 <span class="comment">    Kernel mode, alternate table lock is held.</span>
03061 <span class="comment"></span>
03062 <span class="comment">--**/</span>
03063 {
03064     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPpe;
03065     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPde;
03066     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
03067     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> PteContents;
03068     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> ProtoPte;
03069     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
03070     KIRQL OldIrql;
03071     ULONG OriginalProtection;
03072     ULONGLONG ProtectionMaskOriginal;
03073     ULONG Waited;
03074 
03075     <span class="comment">//</span>
03076     <span class="comment">// get the original protection from the OS</span>
03077     <span class="comment">//</span>
03078 
03079     <a class="code" href="../../d4/d8/mi_8h.html#a154">LOCK_WS</a> (Process);
03080 
03081     ProtoPte = <a class="code" href="../../d8/d2/pagfault_8c.html#a19">MiCheckVirtualAddress</a> (VirtualAddress, &amp;OriginalProtection);
03082 
03083     <span class="keywordflow">if</span> (OriginalProtection == <a class="code" href="../../d4/d8/mi_8h.html#a47">MM_UNKNOWN_PROTECTION</a>) {
03084 
03085         <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a178">MI_IS_PHYSICAL_ADDRESS</a>(ProtoPte)) {
03086             PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (ProtoPte);
03087             <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
03088             <span class="keywordflow">if</span> (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) {
03089                 <a class="code" href="../../d0/d2/mmsup_8c.html#a11">MiMakeSystemAddressValidPfn</a> (ProtoPte);
03090             }
03091             Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber);
03092             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount += 1;
03093             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount &gt; 1);
03094             <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
03095         }
03096 
03097         <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a171">IS_PTE_NOT_DEMAND_ZERO</a>(*ProtoPte)) {
03098 
03099             PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a>(VirtualAddress);
03100             PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a150">MiGetPpeAddress</a>(VirtualAddress);
03101             PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(VirtualAddress);
03102 
03103             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a168">MiDoesPpeExistAndMakeValid</a> (PointerPpe,
03104                                             Process,
03105                                             FALSE,
03106                                             &amp;Waited) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
03107                 PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = 0;
03108     
03109             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d0/d2/mmsup_8c.html#a6">MiDoesPdeExistAndMakeValid</a> (PointerPde,
03110                                                    Process,
03111                                                    FALSE,
03112                                                    &amp;Waited) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
03113 
03114                 PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = 0;
03115 
03116             } <span class="keywordflow">else</span> {
03117 
03118                 <span class="comment">//</span>
03119                 <span class="comment">// if it is safe to read PointerPte</span>
03120                 <span class="comment">//</span>
03121 
03122                 PteContents = *PointerPte;
03123 
03124             }
03125 
03126             <span class="keywordflow">if</span> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid != 0) {
03127 
03128                 PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.CopyOnWrite = 0;
03129                 PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Write = 1;
03130                 PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long;
03131 
03132             }
03133         }
03134 
03135         <span class="comment">//</span>
03136         <span class="comment">// Unlock page containing prototype PTEs.</span>
03137         <span class="comment">//</span>
03138 
03139         <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a178">MI_IS_PHYSICAL_ADDRESS</a>(ProtoPte)) {
03140             <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
03141             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount &gt; 1);
03142             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount -= 1;
03143             <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
03144         }
03145     }
03146         
03147     <a class="code" href="../../d4/d8/mi_8h.html#a158">UNLOCK_WS</a> (Process);
03148 }
03149 
03150 ULONG
03151 <a class="code" href="../../d2/d9/miia64_8h.html#a317">MiMakeProtectForNativePage</a>(
03152     IN PVOID VirtualAddress,
03153     IN ULONG NewProtect,
03154     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process
03155     )
03156 <span class="comment">/*++</span>
03157 <span class="comment"></span>
03158 <span class="comment">Routine Description:</span>
03159 <span class="comment"></span>
03160 <span class="comment">    This function makes a PAGE protection mask for native pages. </span>
03161 <span class="comment"></span>
03162 <span class="comment">Arguments:</span>
03163 <span class="comment"></span>
03164 <span class="comment">    VirtualAddress - Supplies the virtual address to make the PAGE</span>
03165 <span class="comment">             protection mask.</span>
03166 <span class="comment"></span>
03167 <span class="comment">    NewProtect - Supplies the protection originally given.</span>
03168 <span class="comment"></span>
03169 <span class="comment">    Process - Supplies a pointer to the process object.</span>
03170 <span class="comment"></span>
03171 <span class="comment">Return Value: </span>
03172 <span class="comment"></span>
03173 <span class="comment">    None.</span>
03174 <span class="comment"></span>
03175 <span class="comment">Environment:</span>
03176 <span class="comment"></span>
03177 <span class="comment">    Kernel mode.</span>
03178 <span class="comment"></span>
03179 <span class="comment">--**/</span>
03180 {
03181     <a class="code" href="../../d8/d9/struct__WOW64__PROCESS.html">PWOW64_PROCESS</a> Wow64Process = Process-&gt;Wow64Process;
03182 
03183 <span class="preprocessor">#if 0</span>
03184 <span class="preprocessor"></span>    <a class="code" href="../../d2/d9/miia64_8h.html#a262">LOCK_ALTERNATE_TABLE</a> (Wow64Process);
03185 <span class="preprocessor">#endif </span>
03186 <span class="preprocessor"></span>    
03187     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a167">MI_CHECK_BIT</a>(Wow64Process-&gt;AltPermBitmap, 
03188                      <a class="code" href="../../d4/d8/mi_8h.html#a107">MI_VA_TO_VPN</a>(VirtualAddress)) != 0) {
03189 
03190         <span class="keywordflow">if</span> (NewProtect &amp; PAGE_NOACCESS) {
03191             NewProtect &amp;= ~PAGE_NOACCESS;
03192             NewProtect |= PAGE_EXECUTE_READWRITE;
03193         }
03194 
03195         <span class="keywordflow">if</span> (NewProtect &amp; PAGE_READONLY) {
03196             NewProtect &amp;= ~PAGE_READONLY;
03197             NewProtect |= PAGE_EXECUTE_READWRITE;
03198         }
03199 
03200         <span class="keywordflow">if</span> (NewProtect &amp; PAGE_EXECUTE) {
03201             NewProtect &amp;= ~PAGE_EXECUTE;
03202             NewProtect |= PAGE_EXECUTE_READWRITE;
03203         }
03204 
03205         <span class="keywordflow">if</span> (NewProtect &amp; PAGE_EXECUTE_READ) {
03206             NewProtect &amp;= ~PAGE_EXECUTE_READ;
03207             NewProtect |= PAGE_EXECUTE_READWRITE;
03208         }
03209 
03210 <span class="preprocessor">#if 0            </span>
03211 <span class="preprocessor"></span>        <span class="comment">//</span>
03212         <span class="comment">// Remove PAGE_GUARD as it is emulated by Altenate Table.</span>
03213         <span class="comment">//</span>
03214 
03215         <span class="keywordflow">if</span> (NewProtect &amp; PAGE_GUARD) {
03216             NewProtect &amp;= ~PAGE_GUARD;
03217         }
03218 <span class="preprocessor">#endif</span>
03219 <span class="preprocessor"></span>    }
03220 
03221 <span class="preprocessor">#if 0</span>
03222 <span class="preprocessor"></span>    <a class="code" href="../../d2/d9/miia64_8h.html#a263">UNLOCK_ALTERNATE_TABLE</a> (Wow64Process);
03223 <span class="preprocessor">#endif</span>
03224 <span class="preprocessor"></span>
03225     <span class="keywordflow">return</span> NewProtect;
03226 }
03227 
03228 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
03229 MiCheckVirtualAddressFor4kPage(
03230     PVOID VirtualAddress,
03231     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process
03232     )
03233 {
03234     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> ProtoPte;
03235     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerAltPte;
03236     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPde;
03237     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> AltPteContents;
03238     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
03239     ULONG OriginalProtection;
03240     ULONGLONG ProtectionMaskOriginal;
03241     <a class="code" href="../../d8/d9/struct__WOW64__PROCESS.html">PWOW64_PROCESS</a> Wow64Process;
03242     KIRQL OldIrql;
03243     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
03244     ULONG i;
03245 
03246     Wow64Process = Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o78">Wow64Process</a>;
03247 
03248     <a class="code" href="../../d4/d8/mi_8h.html#a154">LOCK_WS</a> (Process);
03249 
03250     ProtoPte = <a class="code" href="../../d8/d2/pagfault_8c.html#a19">MiCheckVirtualAddress</a> (VirtualAddress, &amp;OriginalProtection);
03251 
03252     <span class="keywordflow">if</span> (OriginalProtection == <a class="code" href="../../d4/d8/mi_8h.html#a47">MM_UNKNOWN_PROTECTION</a>) {
03253 
03254         <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a178">MI_IS_PHYSICAL_ADDRESS</a>(ProtoPte)) {
03255             PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (ProtoPte);
03256             <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
03257             <span class="keywordflow">if</span> (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) {
03258                 <a class="code" href="../../d0/d2/mmsup_8c.html#a11">MiMakeSystemAddressValidPfn</a> (ProtoPte);
03259             }
03260             Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber);
03261             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount += 1;
03262             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount &gt; 1);
03263             <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
03264         }
03265 
03266         OriginalProtection = 
03267             <a class="code" href="../../d0/d2/mmsup_8c.html#a5">MiMakeProtectionMask</a>(<a class="code" href="../../d0/d9/protect_8c.html#a7">MiGetPageProtection</a>(ProtoPte, Process));
03268 
03269         <span class="comment">//</span>
03270         <span class="comment">// Unlock page containing prototype PTEs.</span>
03271         <span class="comment">//</span>
03272 
03273         <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a178">MI_IS_PHYSICAL_ADDRESS</a>(ProtoPte)) {
03274             <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
03275             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount &gt; 1);
03276             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount -= 1;
03277             <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
03278         }
03279 
03280     }
03281         
03282     <a class="code" href="../../d4/d8/mi_8h.html#a158">UNLOCK_WS</a> (Process);
03283 
03284     ProtectionMaskOriginal = <a class="code" href="../../d2/d9/miia64_8h.html#a258">MiMakeProtectionAteMask</a> (OriginalProtection);
03285     ProtectionMaskOriginal |= <a class="code" href="../../d2/d9/miia64_8h.html#a243">MM_ATE_COMMIT</a>;
03286 
03287     PointerAltPte = <a class="code" href="../../d2/d9/miia64_8h.html#a238">MiGetAltPteAddress</a>(<a class="code" href="../../d2/d1/mm_8h.html#a7">PAGE_ALIGN</a>(VirtualAddress));
03288 
03289     AltPteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = ProtectionMaskOriginal;
03290     AltPteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Alt.Protection = OriginalProtection;
03291         
03292     <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d2/d9/miia64_8h.html#a234">SPLITS_PER_PAGE</a>; i += 1) {
03293 
03294         <span class="comment">//</span>
03295         <span class="comment">// atomic PTE update</span>
03296         <span class="comment">//</span>
03297 
03298         PointerAltPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = AltPteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long;
03299         PointerAltPte += 1;
03300     }
03301 
03302     <span class="comment">//</span>
03303     <span class="comment">// Update the bitmap</span>
03304     <span class="comment">//</span>
03305 
03306     <a class="code" href="../../d2/d9/miia64_8h.html#a316">MiMarkSplitPages</a>(
03307         VirtualAddress,
03308         VirtualAddress,
03309         Wow64Process-&gt;AltPermBitmap,
03310         TRUE);
03311 }
03312 
03313 MiIsEntireRangeCommittedFor4kPage(
03314     IN PVOID StartVirtual,
03315     IN PVOID EndVirtual,
03316     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process
03317     )
03318 {
03319     <a class="code" href="../../d8/d9/struct__WOW64__PROCESS.html">PWOW64_PROCESS</a> Wow64Process = Process-&gt;Wow64Process;
03320 
03321     <a class="code" href="../../d2/d9/miia64_8h.html#a262">LOCK_ALTERNATE_TABLE</a> (Wow64Process);
03322 
03323     <a class="code" href="../../d2/d9/miia64_8h.html#a263">UNLOCK_ALTERNATE_TABLE</a> (Wow64Process);
03324 }
03325 
03326 <span class="preprocessor">#endif</span>
03327 <span class="preprocessor"></span>
03328 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:15 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
