<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: iosup.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>iosup.c File Reference</h1><code>#include "<a class="el" href="../../d5/d7/mi_8h-source.html">mi.h</a>"</code><br>

<p>
<a href="../../d6/d5/iosup_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Classes</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d1/struct__PTE__TRACKER.html">_PTE_TRACKER</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d7/struct__SYSPTES__HEADER.html">_SYSPTES_HEADER</a></td></tr>

<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/iosup_8c.html#a0">MI_PROBE_RAISE_SIZE</a>&nbsp;&nbsp;&nbsp;10</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/iosup_8c.html#a1">MI_INSTRUMENT_PROBE_RAISES</a>(i)</td></tr>

<tr><td colspan=2><br><h2>Typedefs</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d7/d1/struct__PTE__TRACKER.html">_PTE_TRACKER</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/iosup_8c.html#a4">PTE_TRACKER</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d7/d1/struct__PTE__TRACKER.html">_PTE_TRACKER</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/iosup_8c.html#a5">PPTE_TRACKER</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d9/d7/struct__SYSPTES__HEADER.html">_SYSPTES_HEADER</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/iosup_8c.html#a6">SYSPTES_HEADER</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d9/d7/struct__SYSPTES__HEADER.html">_SYSPTES_HEADER</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/iosup_8c.html#a7">PSYSPTES_HEADER</a></td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/iosup_8c.html#a27">MmIsRecursiveIoFault</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PVOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/iosup_8c.html#a28">MiAllocateContiguousMemory</a> (IN SIZE_T NumberOfBytes, IN PFN_NUMBER LowestAcceptablePfn, IN PFN_NUMBER HighestAcceptablePfn, IN PFN_NUMBER BoundaryPfn, PVOID CallingAddress)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PVOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/iosup_8c.html#a29">MiMapLockedPagesInUserSpace</a> (IN <a class="el" href="../../d6/d7/struct__MDL.html">PMDL</a> MemoryDescriptorList, IN PVOID StartingVa, IN <a class="el" href="../../d4/d9/ke_8h.html#a156">MEMORY_CACHING_TYPE</a> CacheType, IN PVOID BaseVa)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/iosup_8c.html#a30">MiUnmapLockedPagesInUserSpace</a> (IN PVOID BaseAddress, IN <a class="el" href="../../d6/d7/struct__MDL.html">PMDL</a> MemoryDescriptorList)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LOGICAL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/iosup_8c.html#a31">MiGetSystemPteAvailability</a> (IN ULONG NumberOfPtes, IN <a class="el" href="../../d2/d1/mm_8h.html#a154">MM_PAGE_PRIORITY</a> Priority)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/iosup_8c.html#a32">MiAddMdlTracker</a> (IN <a class="el" href="../../d6/d7/struct__MDL.html">PMDL</a> MemoryDescriptorList, IN PVOID CallingAddress, IN PVOID CallersCaller, IN PFN_NUMBER NumberOfPagesToLock, IN ULONG Who)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/iosup_8c.html#a33">MiInsertPteTracker</a> (IN PVOID PoolBlock, IN <a class="el" href="../../d6/d7/struct__MDL.html">PMDL</a> MemoryDescriptorList, IN PFN_NUMBER NumberOfPtes, IN PVOID MyCaller, IN PVOID MyCallersCaller)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PVOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/iosup_8c.html#a34">MiRemovePteTracker</a> (IN <a class="el" href="../../d6/d7/struct__MDL.html">PMDL</a> MemoryDescriptorList, IN PVOID PteAddress, IN PFN_NUMBER NumberOfPtes)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/iosup_8c.html#a35">MiReleaseDeadPteTrackers</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/iosup_8c.html#a36">MiInsertDeadPteTrackingBlock</a> (IN PVOID PoolBlock)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/iosup_8c.html#a37">MiProtectFreeNonPagedPool</a> (IN PVOID VirtualAddress, IN ULONG SizeInPages)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LOGICAL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/iosup_8c.html#a38">MiUnProtectFreeNonPagedPool</a> (IN PVOID VirtualAddress, IN ULONG SizeInPages)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PVOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/iosup_8c.html#a39">MiAllocateLowMemory</a> (IN SIZE_T NumberOfBytes, IN PFN_NUMBER LowestAcceptablePfn, IN PFN_NUMBER HighestAcceptablePfn, IN PFN_NUMBER BoundaryPfn, IN PVOID CallingAddress, IN ULONG Tag)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LOGICAL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/iosup_8c.html#a40">MiFreeLowMemory</a> (IN PVOID BaseAddress, IN ULONG Tag)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/iosup_8c.html#a41">MmProbeAndLockPages</a> (IN OUT <a class="el" href="../../d6/d7/struct__MDL.html">PMDL</a> MemoryDescriptorList, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> AccessMode, IN <a class="el" href="../../d2/d1/mm_8h.html#a141">LOCK_OPERATION</a> Operation)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/iosup_8c.html#a42">MmProbeAndLockProcessPages</a> (IN OUT <a class="el" href="../../d6/d7/struct__MDL.html">PMDL</a> MemoryDescriptorList, IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> AccessMode, IN <a class="el" href="../../d2/d1/mm_8h.html#a141">LOCK_OPERATION</a> Operation)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LOGICAL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/iosup_8c.html#a43">MiFreeMdlTracker</a> (IN OUT <a class="el" href="../../d6/d7/struct__MDL.html">PMDL</a> MemoryDescriptorList, IN PFN_NUMBER NumberOfPages)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/iosup_8c.html#a44">MmProbeAndLockSelectedPages</a> (IN OUT <a class="el" href="../../d6/d7/struct__MDL.html">PMDL</a> MemoryDescriptorList, IN PFILE_SEGMENT_ELEMENT SegmentArray, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> AccessMode, IN <a class="el" href="../../d2/d1/mm_8h.html#a141">LOCK_OPERATION</a> Operation)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/iosup_8c.html#a45">MmUnlockPages</a> (IN OUT <a class="el" href="../../d6/d7/struct__MDL.html">PMDL</a> MemoryDescriptorList)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/iosup_8c.html#a46">MmBuildMdlForNonPagedPool</a> (IN OUT <a class="el" href="../../d6/d7/struct__MDL.html">PMDL</a> MemoryDescriptorList)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/iosup_8c.html#a47">MiInitializeIoTrackers</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PVOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/iosup_8c.html#a48">MiGetHighestPteConsumer</a> (OUT PULONG_PTR NumberOfPtes)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PVOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/iosup_8c.html#a49">MmMapLockedPages</a> (IN <a class="el" href="../../d6/d7/struct__MDL.html">PMDL</a> MemoryDescriptorList, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> AccessMode)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PVOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/iosup_8c.html#a50">MmMapLockedPagesSpecifyCache</a> (IN <a class="el" href="../../d6/d7/struct__MDL.html">PMDL</a> MemoryDescriptorList, IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> AccessMode, IN <a class="el" href="../../d4/d9/ke_8h.html#a156">MEMORY_CACHING_TYPE</a> CacheType, IN PVOID RequestedAddress, IN ULONG BugCheckOnFailure, IN <a class="el" href="../../d2/d1/mm_8h.html#a154">MM_PAGE_PRIORITY</a> Priority)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PVOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/iosup_8c.html#a51">MiMapSinglePage</a> (IN PVOID VirtualAddress OPTIONAL, IN PFN_NUMBER PageFrameIndex, IN <a class="el" href="../../d4/d9/ke_8h.html#a156">MEMORY_CACHING_TYPE</a> CacheType, IN <a class="el" href="../../d2/d1/mm_8h.html#a154">MM_PAGE_PRIORITY</a> Priority)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/iosup_8c.html#a52">MiUnmapSinglePage</a> (IN PVOID VirtualAddress)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/iosup_8c.html#a53">MiPhysicalViewInserter</a> (IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process, IN <a class="el" href="../../d3/d9/struct__MI__PHYSICAL__VIEW.html">PMI_PHYSICAL_VIEW</a> PhysicalView)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/iosup_8c.html#a54">MiPhysicalViewRemover</a> (IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process, IN <a class="el" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a> Vad)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/iosup_8c.html#a55">MiPhysicalViewAdjuster</a> (IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process, IN <a class="el" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a> OldVad, IN <a class="el" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a> NewVad)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/iosup_8c.html#a56">MmUnmapLockedPages</a> (IN PVOID BaseAddress, IN <a class="el" href="../../d6/d7/struct__MDL.html">PMDL</a> MemoryDescriptorList)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PVOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/iosup_8c.html#a57">MmMapIoSpace</a> (IN PHYSICAL_ADDRESS PhysicalAddress, IN SIZE_T NumberOfBytes, IN <a class="el" href="../../d4/d9/ke_8h.html#a156">MEMORY_CACHING_TYPE</a> CacheType)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/iosup_8c.html#a58">MmUnmapIoSpace</a> (IN PVOID BaseAddress, IN SIZE_T NumberOfBytes)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PVOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/iosup_8c.html#a59">MmAllocateContiguousMemorySpecifyCache</a> (IN SIZE_T NumberOfBytes, IN PHYSICAL_ADDRESS LowestAcceptableAddress, IN PHYSICAL_ADDRESS HighestAcceptableAddress, IN PHYSICAL_ADDRESS BoundaryAddressMultiple OPTIONAL, IN <a class="el" href="../../d4/d9/ke_8h.html#a156">MEMORY_CACHING_TYPE</a> CacheType)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PVOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/iosup_8c.html#a60">MmAllocateContiguousMemory</a> (IN SIZE_T NumberOfBytes, IN PHYSICAL_ADDRESS HighestAcceptableAddress)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PVOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/iosup_8c.html#a61">MmAllocateIndependentPages</a> (IN SIZE_T NumberOfBytes)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/iosup_8c.html#a62">MmSetPageProtection</a> (IN PVOID VirtualAddress, IN SIZE_T NumberOfBytes, IN ULONG NewProtect)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d6/d7/struct__MDL.html">PMDL</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/iosup_8c.html#a63">MmAllocatePagesForMdl</a> (IN PHYSICAL_ADDRESS LowAddress, IN PHYSICAL_ADDRESS HighAddress, IN PHYSICAL_ADDRESS SkipBytes, IN SIZE_T TotalBytes)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/iosup_8c.html#a64">MmFreePagesFromMdl</a> (IN <a class="el" href="../../d6/d7/struct__MDL.html">PMDL</a> MemoryDescriptorList)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/iosup_8c.html#a65">MmMapUserAddressesToPage</a> (IN PVOID BaseAddress, IN SIZE_T NumberOfBytes, IN PVOID PageAddress)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/iosup_8c.html#a66">MmFreeContiguousMemory</a> (IN PVOID BaseAddress)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/iosup_8c.html#a67">MmFreeContiguousMemorySpecifyCache</a> (IN PVOID BaseAddress, IN SIZE_T NumberOfBytes, IN <a class="el" href="../../d4/d9/ke_8h.html#a156">MEMORY_CACHING_TYPE</a> CacheType)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PHYSICAL_ADDRESS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/iosup_8c.html#a68">MmGetPhysicalAddress</a> (IN PVOID BaseAddress)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PVOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/iosup_8c.html#a69">MmGetVirtualForPhysical</a> (IN PHYSICAL_ADDRESS PhysicalAddress)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PVOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/iosup_8c.html#a70">MmAllocateNonCachedMemory</a> (IN SIZE_T NumberOfBytes)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/iosup_8c.html#a71">MmFreeNonCachedMemory</a> (IN PVOID BaseAddress, IN SIZE_T NumberOfBytes)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>SIZE_T&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/iosup_8c.html#a72">MmSizeOfMdl</a> (IN PVOID Base, IN SIZE_T Length)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d6/d7/struct__MDL.html">PMDL</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/iosup_8c.html#a73">MmCreateMdl</a> (IN <a class="el" href="../../d6/d7/struct__MDL.html">PMDL</a> MemoryDescriptorList OPTIONAL, IN PVOID Base, IN SIZE_T Length)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/iosup_8c.html#a74">MmSetAddressRangeModified</a> (IN PVOID Address, IN SIZE_T Length)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PVOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/iosup_8c.html#a75">MiCheckForContiguousMemory</a> (IN PVOID BaseAddress, IN PFN_NUMBER BaseAddressPages, IN PFN_NUMBER SizeInPages, IN PFN_NUMBER LowestPfn, IN PFN_NUMBER HighestPfn, IN PFN_NUMBER BoundaryPfn)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/iosup_8c.html#a76">MmLockPagableSectionByHandle</a> (IN PVOID ImageSectionHandle)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/iosup_8c.html#a77">MiLockCode</a> (IN <a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> FirstPte, IN <a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastPte, IN ULONG LockType)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/iosup_8c.html#a78">MmGetSectionRange</a> (IN PVOID AddressWithinSection, OUT PVOID *StartingSectionAddress, OUT PULONG SizeofSection)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PVOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/iosup_8c.html#a79">MmLockPagableDataSection</a> (IN PVOID AddressWithinSection)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PLDR_DATA_TABLE_ENTRY&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/iosup_8c.html#a80">MiLookupDataTableEntry</a> (IN PVOID AddressWithinSection, IN ULONG ResourceHeld)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/iosup_8c.html#a81">MmUnlockPagableImageSection</a> (IN PVOID ImageSectionHandle)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/iosup_8c.html#a82">MmMapMemoryDumpMdl</a> (IN OUT <a class="el" href="../../d6/d7/struct__MDL.html">PMDL</a> MemoryDumpMdl)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/iosup_8c.html#a83">MmReleaseDumpAddresses</a> (IN PFN_NUMBER Pages)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/iosup_8c.html#a84">MmSetBankedSection</a> (IN HANDLE ProcessHandle, IN PVOID VirtualAddress, IN ULONG BankLength, IN BOOLEAN ReadWriteBank, IN <a class="el" href="../../d2/d1/mm_8h.html#a162">PBANKED_SECTION_ROUTINE</a> BankRoutine, IN PVOID Context)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PVOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/iosup_8c.html#a85">MmMapVideoDisplay</a> (IN PHYSICAL_ADDRESS PhysicalAddress, IN SIZE_T NumberOfBytes, IN <a class="el" href="../../d4/d9/ke_8h.html#a156">MEMORY_CACHING_TYPE</a> CacheType)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/iosup_8c.html#a86">MmUnmapVideoDisplay</a> (IN PVOID BaseAddress, IN SIZE_T NumberOfBytes)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/iosup_8c.html#a87">MmLockPagedPool</a> (IN PVOID Address, IN SIZE_T SizeInBytes)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/iosup_8c.html#a88">MmUnlockPagedPool</a> (IN PVOID Address, IN SIZE_T SizeInBytes)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/iosup_8c.html#a89">MmGatherMemoryForHibernate</a> (IN <a class="el" href="../../d6/d7/struct__MDL.html">PMDL</a> Mdl, IN BOOLEAN Wait)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTKERNELAPI VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/iosup_8c.html#a90">MmReturnMemoryForHibernate</a> (IN <a class="el" href="../../d6/d7/struct__MDL.html">PMDL</a> Mdl)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/iosup_8c.html#a91">MmSetKernelDumpRange</a> (IN OUT PVOID pDumpContext)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>PFN_NUMBER&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/iosup_8c.html#a2">MmSystemLockPagesCount</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/iosup_8c.html#a3">MmTotalSystemDriverPages</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LOGICAL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/iosup_8c.html#a8">MmTrackPtes</a> = FALSE</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/iosup_8c.html#a9">MiTrackPtesAborted</a> = FALSE</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d9/d7/struct__SYSPTES__HEADER.html">SYSPTES_HEADER</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/iosup_8c.html#a10">MiPteHeader</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LIST_ENTRY&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/iosup_8c.html#a11">MiDeadPteTrackerListHead</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>KSPIN_LOCK&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/iosup_8c.html#a12">MiPteTrackerLock</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d5/d2/struct__LOCK__HEADER.html">LOCK_HEADER</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/iosup_8c.html#a13">MmLockedPagesHead</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/iosup_8c.html#a14">MiTrackingAborted</a> = FALSE</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LOGICAL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/iosup_8c.html#a15">MiNoLowMemory</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d4/d8/struct__POOL__DESCRIPTOR.html">POOL_DESCRIPTOR</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/iosup_8c.html#a16">NonPagedPoolDescriptor</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PFN_NUMBER&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/iosup_8c.html#a17">MmMdlPagesAllocated</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d2/d6/struct__KEVENT.html">KEVENT</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/iosup_8c.html#a18">MmCollidedLockEvent</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/iosup_8c.html#a19">MmCollidedLockWait</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>SIZE_T&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/iosup_8c.html#a20">MmLockedCode</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/iosup_8c.html#a21">MiWriteCombiningPtes</a> = FALSE</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/iosup_8c.html#a22">MiProbeRaises</a> [MI_PROBE_RAISE_SIZE]</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/iosup_8c.html#a23">MmReferenceCountCheck</a> = 2500</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PFN_NUMBER&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/iosup_8c.html#a24">MiLastCallLowPage</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PFN_NUMBER&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/iosup_8c.html#a25">MiLastCallHighPage</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/iosup_8c.html#a26">MiLastCallColor</a></td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a1" doxytag="iosup.c::MI_INSTRUMENT_PROBE_RAISES" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define MI_INSTRUMENT_PROBE_RAISES          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">i&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div><a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (i &lt; MI_PROBE_RAISE_SIZE);   \
        <a class="code" href="../../d5/d6/iosup_8c.html#a22">MiProbeRaises</a>[i] += 1;
</div></pre>
<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l00225">225</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d5/iosup_8c-source.html#l00238">MmProbeAndLockPages()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="iosup.c::MI_PROBE_RAISE_SIZE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define MI_PROBE_RAISE_SIZE&nbsp;&nbsp;&nbsp;10          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l00221">221</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.    </td>
  </tr>
</table>
<hr><h2>Typedef Documentation</h2>
<a class="anchor" name="a5" doxytag="iosup.c::PPTE_TRACKER" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d7/d1/struct__PTE__TRACKER.html">_PTE_TRACKER</a> * <a class="el" href="../../d7/d1/struct__PTE__TRACKER.html">PPTE_TRACKER</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d6/d5/iosup_8c-source.html#l01901">MiGetHighestPteConsumer()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l01611">MiInsertPteTracker()</a>, and <a class="el" href="../../d6/d5/iosup_8c-source.html#l01675">MiRemovePteTracker()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="iosup.c::PSYSPTES_HEADER" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d9/d7/struct__SYSPTES__HEADER.html">_SYSPTES_HEADER</a> * <a class="el" href="../../d9/d7/struct__SYSPTES__HEADER.html">PSYSPTES_HEADER</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="iosup.c::PTE_TRACKER" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d7/d1/struct__PTE__TRACKER.html">_PTE_TRACKER</a>  <a class="el" href="../../d7/d1/struct__PTE__TRACKER.html">PTE_TRACKER</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="iosup.c::SYSPTES_HEADER" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d9/d7/struct__SYSPTES__HEADER.html">_SYSPTES_HEADER</a>  <a class="el" href="../../d9/d7/struct__SYSPTES__HEADER.html">SYSPTES_HEADER</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a32" doxytag="iosup.c::MiAddMdlTracker" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MiAddMdlTracker           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d6/d7/struct__MDL.html">PMDL</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>MemoryDescriptorList</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>CallingAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>CallersCaller</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PFN_NUMBER&nbsp;</td>
          <td class="mdname" nowrap> <em>NumberOfPagesToLock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Who</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l00879">879</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02669">_LOCK_TRACKER::CallersCaller</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02668">_LOCK_TRACKER::CallingAddress</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02680">_LOCK_HEADER::Count</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02664">_LOCK_TRACKER::Count</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02670">_LOCK_TRACKER::GlobalListEntry</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02666">_LOCK_TRACKER::Length</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02661">_LOCK_TRACKER::ListEntry</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02679">_LOCK_HEADER::ListHead</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00901">LOCK_PFN2</a>, <a class="el" href="../../d4/d8/mi_8h.html#a524">LOCK_TRACKER</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00288">_EPROCESS::LockedPagesList</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02662">_LOCK_TRACKER::Mdl</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l00099">MiTrackingAborted</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l00098">MmLockedPagesHead</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00089">MmTrackLockedPages</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02665">_LOCK_TRACKER::Offset</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02667">_LOCK_TRACKER::Page</a>, <a class="el" href="../../d4/d8/mi_8h.html#a529">PLOCK_HEADER</a>, <a class="el" href="../../d4/d8/mi_8h.html#a525">PLOCK_TRACKER</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02672">_LOCK_TRACKER::Process</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02663">_LOCK_TRACKER::StartVa</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00905">UNLOCK_PFN2</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l02671">_LOCK_TRACKER::Who</a>.
<p>
Referenced by <a class="el" href="../../d6/d5/iosup_8c-source.html#l00238">MmProbeAndLockPages()</a>, and <a class="el" href="../../d6/d5/iosup_8c-source.html#l01152">MmProbeAndLockSelectedPages()</a>.
<p>
<pre class="fragment"><div>00889                    :
00890 
00891     This routine adds an <a class="code" href="../../d6/d7/struct__MDL.html">MDL</a> to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified process' chain.
00892 
00893 Arguments:
00894 
00895     MemoryDescriptorList - Supplies a pointer to a Memory Descriptor <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>
00896                            (<a class="code" href="../../d6/d7/struct__MDL.html">MDL</a>). The <a class="code" href="../../d6/d7/struct__MDL.html">MDL</a> must supply <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length. The
00897                            physical page portion of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d6/d7/struct__MDL.html">MDL</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> updated when
00898                            <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pages are locked in memory.
00899 
00900     CallingAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller of our caller.
00901 
00902     CallersCaller - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller of CallingAddress.
00903 
00904     NumberOfPagesToLock - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of pages to lock.
00905 
00906     Who - Specifies which routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> adding <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> entry.
00907 
00908 Return Value:
00909 
00910     None - exceptions are raised.
00911 
00912 Environment:
00913 
00914     Kernel mode.  <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a> and below.
00915 
00916 --*/
00917 
00918 {
00919     KIRQL OldIrql;
00920     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
00921     <a class="code" href="../../d5/d2/struct__LOCK__HEADER.html">PLOCK_HEADER</a> LockedPagesHeader;
00922     <a class="code" href="../../d0/d3/struct__LOCK__TRACKER.html">PLOCK_TRACKER</a> Tracker;
00923     <a class="code" href="../../d0/d3/struct__LOCK__TRACKER.html">PLOCK_TRACKER</a> P;
00924     PLIST_ENTRY NextEntry;
00925 
00926     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (MmTrackLockedPages == TRUE);
00927 
00928     Process = MemoryDescriptorList-&gt;Process;
00929 
00930     <span class="keywordflow">if</span> (Process == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00931         <span class="keywordflow">return</span>;
00932     }
00933 
00934     LockedPagesHeader = Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o76">LockedPagesList</a>;
00935 
00936     <span class="keywordflow">if</span> (LockedPagesHeader == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00937         <span class="keywordflow">return</span>;
00938     }
00939 
00940     <span class="comment">//</span>
00941     <span class="comment">// It's ok to check unsynchronized for aborted tracking as the worst case</span>
00942     <span class="comment">// is just that one more entry gets added which will be freed later anyway.</span>
00943     <span class="comment">// The main purpose behind aborted tracking is that frees and exits don't</span>
00944     <span class="comment">// mistakenly bugcheck when an entry cannot be found.</span>
00945     <span class="comment">//</span>
00946 
00947     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/iosup_8c.html#a14">MiTrackingAborted</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00948         <span class="keywordflow">return</span>;
00949     }
00950 
00951     Tracker = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (NonPagedPool,
00952                                      <span class="keyword">sizeof</span> (<a class="code" href="../../d0/d3/struct__LOCK__TRACKER.html">LOCK_TRACKER</a>),
00953                                      'kLmM');
00954 
00955     <span class="keywordflow">if</span> (Tracker == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00956 
00957         <span class="comment">//</span>
00958         <span class="comment">// It's ok to set this without synchronization as the worst case</span>
00959         <span class="comment">// is just that a few more entries gets added which will be freed</span>
00960         <span class="comment">// later anyway.  The main purpose behind aborted tracking is that</span>
00961         <span class="comment">// frees and exits don't mistakenly bugcheck when an entry cannot</span>
00962         <span class="comment">// be found.</span>
00963         <span class="comment">//</span>
00964     
00965         <a class="code" href="../../d5/d6/iosup_8c.html#a14">MiTrackingAborted</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00966 
00967         <span class="keywordflow">return</span>;
00968     }
00969 
00970     Tracker-&gt;<a class="code" href="../../d0/d3/struct__LOCK__TRACKER.html#o1">Mdl</a> = MemoryDescriptorList;
00971     Tracker-&gt;<a class="code" href="../../d0/d3/struct__LOCK__TRACKER.html#o3">Count</a> = NumberOfPagesToLock;
00972     Tracker-&gt;<a class="code" href="../../d0/d3/struct__LOCK__TRACKER.html#o2">StartVa</a> = MemoryDescriptorList-&gt;StartVa;
00973     Tracker-&gt;<a class="code" href="../../d0/d3/struct__LOCK__TRACKER.html#o4">Offset</a> = MemoryDescriptorList-&gt;ByteOffset;
00974     Tracker-&gt;<a class="code" href="../../d0/d3/struct__LOCK__TRACKER.html#o5">Length</a> = MemoryDescriptorList-&gt;ByteCount;
00975     Tracker-&gt;<a class="code" href="../../d0/d3/struct__LOCK__TRACKER.html#o6">Page</a> = *(PPFN_NUMBER)(MemoryDescriptorList + 1);
00976 
00977     Tracker-&gt;<a class="code" href="../../d0/d3/struct__LOCK__TRACKER.html#o7">CallingAddress</a> = CallingAddress;
00978     Tracker-&gt;<a class="code" href="../../d0/d3/struct__LOCK__TRACKER.html#o8">CallersCaller</a> = CallersCaller;
00979 
00980     Tracker-&gt;<a class="code" href="../../d0/d3/struct__LOCK__TRACKER.html#o10">Who</a> = Who;
00981     Tracker-&gt;<a class="code" href="../../d0/d3/struct__LOCK__TRACKER.html#o11">Process</a> = Process;
00982 
00983     <a class="code" href="../../d4/d8/mi_8h.html#a130">LOCK_PFN2</a> (OldIrql);
00984 
00985     <span class="comment">//</span>
00986     <span class="comment">// Update the list for this process.  First make sure it's not already</span>
00987     <span class="comment">// inserted.</span>
00988     <span class="comment">//</span>
00989 
00990     NextEntry = LockedPagesHeader-&gt;<a class="code" href="../../d5/d2/struct__LOCK__HEADER.html#o0">ListHead</a>.Flink;
00991     <span class="keywordflow">while</span> (NextEntry != &amp;LockedPagesHeader-&gt;<a class="code" href="../../d5/d2/struct__LOCK__HEADER.html#o0">ListHead</a>) {
00992 
00993         P = CONTAINING_RECORD (NextEntry,
00994                                <a class="code" href="../../d0/d3/struct__LOCK__TRACKER.html">LOCK_TRACKER</a>,
00995                                ListEntry);
00996 
00997         <span class="keywordflow">if</span> (P-&gt;<a class="code" href="../../d0/d3/struct__LOCK__TRACKER.html#o1">Mdl</a> == MemoryDescriptorList) {
00998             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (LOCKED_PAGES_TRACKER_CORRUPTION,
00999                           0x1,
01000                           (ULONG_PTR)P,
01001                           (ULONG_PTR)MemoryDescriptorList,
01002                           (ULONG_PTR)<a class="code" href="../../d5/d6/iosup_8c.html#a13">MmLockedPagesHead</a>.<a class="code" href="../../d5/d2/struct__LOCK__HEADER.html#o1">Count</a>);
01003         }
01004         NextEntry = NextEntry-&gt;Flink;
01005     }
01006 
01007     InsertHeadList (&amp;LockedPagesHeader-&gt;<a class="code" href="../../d5/d2/struct__LOCK__HEADER.html#o0">ListHead</a>, &amp;Tracker-&gt;<a class="code" href="../../d0/d3/struct__LOCK__TRACKER.html#o0">ListEntry</a>);
01008     LockedPagesHeader-&gt;<a class="code" href="../../d5/d2/struct__LOCK__HEADER.html#o1">Count</a> += NumberOfPagesToLock;
01009 
01010     <span class="comment">//</span>
01011     <span class="comment">// Update the systemwide global list.  First make sure it's not</span>
01012     <span class="comment">// already inserted.</span>
01013     <span class="comment">//</span>
01014 
01015     NextEntry = <a class="code" href="../../d5/d6/iosup_8c.html#a13">MmLockedPagesHead</a>.<a class="code" href="../../d5/d2/struct__LOCK__HEADER.html#o0">ListHead</a>.Flink;
01016     <span class="keywordflow">while</span> (NextEntry != &amp;<a class="code" href="../../d5/d6/iosup_8c.html#a13">MmLockedPagesHead</a>.<a class="code" href="../../d5/d2/struct__LOCK__HEADER.html#o0">ListHead</a>) {
01017 
01018         P = CONTAINING_RECORD(NextEntry,
01019                               <a class="code" href="../../d0/d3/struct__LOCK__TRACKER.html">LOCK_TRACKER</a>,
01020                               GlobalListEntry);
01021 
01022         <span class="keywordflow">if</span> (P-&gt;<a class="code" href="../../d0/d3/struct__LOCK__TRACKER.html#o1">Mdl</a> == MemoryDescriptorList) {
01023             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (LOCKED_PAGES_TRACKER_CORRUPTION,
01024                           0x2,
01025                           (ULONG_PTR)P,
01026                           (ULONG_PTR)MemoryDescriptorList,
01027                           (ULONG_PTR)<a class="code" href="../../d5/d6/iosup_8c.html#a13">MmLockedPagesHead</a>.<a class="code" href="../../d5/d2/struct__LOCK__HEADER.html#o1">Count</a>);
01028         }
01029 
01030         NextEntry = NextEntry-&gt;Flink;
01031     }
01032 
01033     InsertHeadList (&amp;<a class="code" href="../../d5/d6/iosup_8c.html#a13">MmLockedPagesHead</a>.<a class="code" href="../../d5/d2/struct__LOCK__HEADER.html#o0">ListHead</a>,
01034                     &amp;Tracker-&gt;<a class="code" href="../../d0/d3/struct__LOCK__TRACKER.html#o9">GlobalListEntry</a>);
01035     <a class="code" href="../../d5/d6/iosup_8c.html#a13">MmLockedPagesHead</a>.<a class="code" href="../../d5/d2/struct__LOCK__HEADER.html#o1">Count</a> += NumberOfPagesToLock;
01036 
01037     <a class="code" href="../../d4/d8/mi_8h.html#a131">UNLOCK_PFN2</a> (OldIrql);
01038 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a28" doxytag="iosup.c::MiAllocateContiguousMemory" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PVOID MiAllocateContiguousMemory           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN SIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>NumberOfBytes</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PFN_NUMBER&nbsp;</td>
          <td class="mdname" nowrap> <em>LowestAcceptablePfn</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PFN_NUMBER&nbsp;</td>
          <td class="mdname" nowrap> <em>HighestAcceptablePfn</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PFN_NUMBER&nbsp;</td>
          <td class="mdname" nowrap> <em>BoundaryPfn</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>CallingAddress</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l04107">4107</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00086">APC_LEVEL</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00141">BYTES_TO_PAGES</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00140">KeDelayExecutionThread()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d4/d5/procsup_8c.html#a27">MiAllocateLowMemory()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l06052">MiCheckForContiguousMemory()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04555">MiDelayPageFaults</a>, <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l02715">MiEmptyAllWorkingSets()</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l04569">MiFindContiguousMemory()</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l04870">MiFlushAllPages()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l00141">MiNoLowMemory</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00216">MmHalfSecond</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a177">NonPagedPoolCacheAligned</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d6/d5/iosup_8c-source.html#l03881">MmAllocateContiguousMemory()</a>, and <a class="el" href="../../d6/d5/iosup_8c-source.html#l03744">MmAllocateContiguousMemorySpecifyCache()</a>.
<p>
<pre class="fragment"><div>04117                    :
04118 
04119     This function allocates a range of physically contiguous non-paged
04120     <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a>.  It relies on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> fact that non-paged <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> built at
04121     system initialization time from a contiguous range of physical
04122     memory.  It allocates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified size of non-paged <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> and
04123     then checks to ensure <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> contiguous as <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> expansion does
04124     not maintain <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> contiguous nature of non-paged <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a>.
04125 
04126     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> designed to be used by a driver's initialization
04127     routine to allocate a contiguous block of physical memory <span class="keywordflow">for</span>
04128     issuing DMA requests from.
04129 
04130 Arguments:
04131 
04132     NumberOfBytes - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of bytes to allocate.
04133 
04134     LowestAcceptablePfn - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> lowest page frame number
04135                           which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> valid <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> allocation.
04136 
04137     HighestAcceptablePfn - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> highest page frame number
04138                            which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> valid <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> allocation.
04139 
04140     BoundaryPfn - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> page frame number multiple <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> allocation must
04141                   not cross.  0 indicates <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> can cross any boundary.
04142 
04143     CallingAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> calling address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> allocator.
04144 
04145 Return Value:
04146 
04147     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> - a contiguous range could not be found to satisfy <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> request.
04148 
04149     NON-<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> - Returns a pointer (<span class="keyword">virtual</span> address in the nonpaged portion
04150                of the system) to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> allocated physically contiguous
04151                memory.
04152 
04153 Environment:
04154 
04155     Kernel mode, IRQL of <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a> or below.
04156 
04157 --*/
04158 
04159 {
04160     PVOID BaseAddress;
04161     PFN_NUMBER SizeInPages;
04162     PFN_NUMBER LowestPfn;
04163     PFN_NUMBER HighestPfn;
04164     PFN_NUMBER i;
04165 
04166     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (NumberOfBytes != 0);
04167 
04168 <span class="preprocessor">#if defined (_X86PAE_)</span>
04169 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/iosup_8c.html#a15">MiNoLowMemory</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
04170         <span class="keywordflow">if</span> (HighestAcceptablePfn &lt;= 0xFFFFF) {
04171             <span class="keywordflow">return</span> <a class="code" href="../../d4/d5/procsup_8c.html#a27">MiAllocateLowMemory</a> (NumberOfBytes,
04172                                         LowestAcceptablePfn,
04173                                         HighestAcceptablePfn,
04174                                         BoundaryPfn,
04175                                         CallingAddress,
04176                                         'tnoC');
04177         }
04178         LowestPfn = 0x100000;
04179     }
04180 <span class="preprocessor">#endif</span>
04181 <span class="preprocessor"></span>
04182     BaseAddress = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (NonPagedPoolCacheAligned,
04183                                          NumberOfBytes,
04184                                          'mCmM');
04185 
04186     <span class="comment">//</span>
04187     <span class="comment">// N.B. This setting of SizeInPages to exactly the request size means the</span>
04188     <span class="comment">// non-NULL return value from MiCheckForContiguousMemory is guaranteed to</span>
04189     <span class="comment">// be the BaseAddress.  If this size is ever changed, then the non-NULL</span>
04190     <span class="comment">// return value must be checked and split/returned accordingly.</span>
04191     <span class="comment">//</span>
04192 
04193     SizeInPages = <a class="code" href="../../d2/d1/mm_8h.html#a5">BYTES_TO_PAGES</a> (NumberOfBytes);
04194 
04195     LowestPfn = LowestAcceptablePfn;
04196     HighestPfn = HighestAcceptablePfn;
04197 
04198     <span class="keywordflow">if</span> (BaseAddress != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04199         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a795">MiCheckForContiguousMemory</a>( BaseAddress,
04200                                         SizeInPages,
04201                                         SizeInPages,
04202                                         LowestPfn,
04203                                         HighestPfn,
04204                                         BoundaryPfn)) {
04205 
04206             <span class="keywordflow">return</span> BaseAddress;
04207         }
04208 
04209         <span class="comment">//</span>
04210         <span class="comment">// The allocation from pool does not meet the contiguous</span>
04211         <span class="comment">// requirements. Free the page and see if any of the free</span>
04212         <span class="comment">// pool pages meet the requirement.</span>
04213         <span class="comment">//</span>
04214 
04215         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (BaseAddress);
04216 
04217     } <span class="keywordflow">else</span> {
04218 
04219         <span class="comment">//</span>
04220         <span class="comment">// No pool was available, return NULL.</span>
04221         <span class="comment">//</span>
04222 
04223         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04224     }
04225 
04226     <span class="keywordflow">if</span> (KeGetCurrentIrql() &gt; <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>) {
04227         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04228     }
04229 
04230     BaseAddress = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
04231 
04232     i = 3;
04233 
04234     InterlockedIncrement (&amp;MiDelayPageFaults);
04235 
04236     <span class="keywordflow">for</span> (; ; ) {
04237         BaseAddress = <a class="code" href="../../d4/d8/mi_8h.html#a794">MiFindContiguousMemory</a> (LowestPfn,
04238                                               HighestPfn,
04239                                               BoundaryPfn,
04240                                               SizeInPages,
04241                                               CallingAddress);
04242 
04243         <span class="keywordflow">if</span> ((BaseAddress != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) || (i == 0)) {
04244             <span class="keywordflow">break</span>;
04245         }
04246 
04247         <span class="comment">//</span>
04248         <span class="comment">// Attempt to move pages to the standby list.</span>
04249         <span class="comment">//</span>
04250 
04251         <a class="code" href="../../d5/d0/wsmanage_8c.html#a47">MiEmptyAllWorkingSets</a> ();
04252         <a class="code" href="../../d6/d3/modwrite_8c.html#a57">MiFlushAllPages</a>();
04253 
04254         <a class="code" href="../../d1/d7/wait_8c.html#a2">KeDelayExecutionThread</a> (KernelMode,
04255                                 FALSE,
04256                                 (PLARGE_INTEGER)&amp;MmHalfSecond);
04257 
04258         i -= 1;
04259     }
04260     InterlockedDecrement (&amp;MiDelayPageFaults);
04261     <span class="keywordflow">return</span> BaseAddress;
04262 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a39" doxytag="iosup.c::MiAllocateLowMemory" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PVOID MiAllocateLowMemory           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN SIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>NumberOfBytes</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PFN_NUMBER&nbsp;</td>
          <td class="mdname" nowrap> <em>LowestAcceptablePfn</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PFN_NUMBER&nbsp;</td>
          <td class="mdname" nowrap> <em>HighestAcceptablePfn</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PFN_NUMBER&nbsp;</td>
          <td class="mdname" nowrap> <em>BoundaryPfn</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>CallingAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Tag</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a75" doxytag="iosup.c::MiCheckForContiguousMemory" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PVOID MiCheckForContiguousMemory           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>BaseAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PFN_NUMBER&nbsp;</td>
          <td class="mdname" nowrap> <em>BaseAddressPages</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PFN_NUMBER&nbsp;</td>
          <td class="mdname" nowrap> <em>SizeInPages</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PFN_NUMBER&nbsp;</td>
          <td class="mdname" nowrap> <em>LowestPfn</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PFN_NUMBER&nbsp;</td>
          <td class="mdname" nowrap> <em>HighestPfn</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PFN_NUMBER&nbsp;</td>
          <td class="mdname" nowrap> <em>BoundaryPfn</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l06052">6052</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02287">MI_CONVERT_PHYSICAL_TO_PFN</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02410">MI_GET_PAGE_FRAME_FROM_PTE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02262">MI_IS_PHYSICAL_ADDRESS</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01842">MiGetVirtualAddressMappedByPte</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, and <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>.
<p>
Referenced by <a class="el" href="../../d6/d5/iosup_8c-source.html#l04107">MiAllocateContiguousMemory()</a>, and <a class="el" href="../../d2/d5/allocpag_8c-source.html#l04569">MiFindContiguousMemory()</a>.
<p>
<pre class="fragment"><div>06063                    :
06064 
06065     This routine checks to see <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> physical memory mapped
06066     by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified BaseAddress <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified size <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
06067     contiguous and that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first page <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> greater than or equal to
06068     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified LowestPfn and that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> last page of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> physical memory <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
06069     less than or equal to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified HighestPfn.
06070 
06071 Arguments:
06072 
06073     BaseAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base address to start checking at.
06074 
06075     BaseAddressPages - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of pages to scan from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
06076                        BaseAddress.
06077 
06078     SizeInPages - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of pages in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> range.
06079 
06080     LowestPfn - Supplies lowest PFN acceptable as a physical page.
06081 
06082     HighestPfn - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> highest PFN acceptable as a physical page.
06083 
06084     BoundaryPfn - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PFN multiple <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> allocation must
06085                   not cross.  0 indicates <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> can cross any boundary.
06086 
06087 Return Value:
06088 
06089     Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> usable <span class="keyword">virtual</span> address within <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> argument range that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
06090     caller should <span class="keywordflow">return</span> to his caller.  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> <span class="keywordflow">if</span> there <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> no usable address.
06091 
06092 Environment:
06093 
06094     Kernel mode, memory management internal.
06095 
06096 --*/
06097 
06098 {
06099     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
06100     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastPte;
06101     PFN_NUMBER PreviousPage;
06102     PFN_NUMBER Page;
06103     PFN_NUMBER HighestStartPage;
06104     PFN_NUMBER LastPage;
06105     PFN_NUMBER OriginalPage;
06106     PFN_NUMBER OriginalLastPage;
06107     PVOID BoundaryAllocation;
06108     PFN_NUMBER BoundaryMask;
06109     ULONG PageCount;
06110     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> PteContents;
06111 
06112     BoundaryMask = ~(BoundaryPfn - 1);
06113 
06114     <span class="keywordflow">if</span> (LowestPfn &gt; HighestPfn) {
06115         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
06116     }
06117 
06118     <span class="keywordflow">if</span> (LowestPfn + SizeInPages &lt;= LowestPfn) {
06119         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
06120     }
06121 
06122     <span class="keywordflow">if</span> (LowestPfn + SizeInPages &gt; HighestPfn + 1) {
06123         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
06124     }
06125 
06126     <span class="keywordflow">if</span> (BaseAddressPages &lt; SizeInPages) {
06127         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
06128     }
06129 
06130     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a178">MI_IS_PHYSICAL_ADDRESS</a> (BaseAddress)) {
06131 
06132         OriginalPage = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a179">MI_CONVERT_PHYSICAL_TO_PFN</a>(BaseAddress);
06133         OriginalLastPage = OriginalPage + BaseAddressPages;
06134 
06135         Page = OriginalPage;
06136         LastPage = OriginalLastPage;
06137 
06138         <span class="comment">//</span>
06139         <span class="comment">// Close the gaps, then examine the range for a fit.</span>
06140         <span class="comment">//</span>
06141 
06142         <span class="keywordflow">if</span> (Page &lt; LowestPfn) {
06143             Page = LowestPfn;
06144         }
06145 
06146         <span class="keywordflow">if</span> (LastPage &gt; HighestPfn + 1) {
06147             LastPage = HighestPfn + 1;
06148         }
06149 
06150         HighestStartPage = LastPage - SizeInPages;
06151 
06152         <span class="keywordflow">if</span> (Page &gt; HighestStartPage) {
06153             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
06154         }
06155 
06156         <span class="keywordflow">if</span> (BoundaryPfn != 0) {
06157             <span class="keywordflow">do</span> {
06158                 <span class="keywordflow">if</span> (((Page ^ (Page + SizeInPages - 1)) &amp; BoundaryMask) == 0) {
06159 
06160                     <span class="comment">//</span>
06161                     <span class="comment">// This portion of the range meets the alignment</span>
06162                     <span class="comment">// requirements.</span>
06163                     <span class="comment">//</span>
06164 
06165                     <span class="keywordflow">break</span>;
06166                 }
06167                 Page |= (BoundaryPfn - 1);
06168                 Page += 1;
06169             } <span class="keywordflow">while</span> (Page &lt;= HighestStartPage);
06170 
06171             <span class="keywordflow">if</span> (Page &gt; HighestStartPage) {
06172                 <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
06173             }
06174             BoundaryAllocation = (PVOID)((PCHAR)BaseAddress + ((Page - OriginalPage) &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>));
06175 
06176             <span class="comment">//</span>
06177             <span class="comment">// The request can be satisfied.  Since specific alignment was</span>
06178             <span class="comment">// requested, return the fit now without getting fancy.</span>
06179             <span class="comment">//</span>
06180 
06181             <span class="keywordflow">return</span> BoundaryAllocation;
06182         }
06183 
06184         <span class="comment">//</span>
06185         <span class="comment">// If possible return a chunk on the end to reduce fragmentation.</span>
06186         <span class="comment">//</span>
06187     
06188         <span class="keywordflow">if</span> (LastPage == OriginalLastPage) {
06189             <span class="keywordflow">return</span> (PVOID)((PCHAR)BaseAddress + ((BaseAddressPages - SizeInPages) &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>));
06190         }
06191     
06192         <span class="comment">//</span>
06193         <span class="comment">// The end chunk did not satisfy the requirements.  The next best option</span>
06194         <span class="comment">// is to return a chunk from the beginning.  Since that's where the search</span>
06195         <span class="comment">// began, just return the current chunk.</span>
06196         <span class="comment">//</span>
06197 
06198         <span class="keywordflow">return</span> (PVOID)((PCHAR)BaseAddress + ((Page - OriginalPage) &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>));
06199     }
06200 
06201     <span class="comment">//</span>
06202     <span class="comment">// Check the virtual addresses for physical contiguity.</span>
06203     <span class="comment">//</span>
06204 
06205     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (BaseAddress);
06206     LastPte = PointerPte + BaseAddressPages;
06207 
06208     HighestStartPage = HighestPfn + 1 - SizeInPages;
06209     PageCount = 0;
06210 
06211     <span class="keywordflow">while</span> (PointerPte &lt; LastPte) {
06212 
06213         PteContents = *PointerPte;
06214         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1);
06215         Page = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (&amp;PteContents);
06216 
06217         <span class="comment">//</span>
06218         <span class="comment">// Before starting a new run, ensure that it</span>
06219         <span class="comment">// can satisfy the location &amp; boundary requirements (if any).</span>
06220         <span class="comment">//</span>
06221 
06222         <span class="keywordflow">if</span> (PageCount == 0) {
06223 
06224             <span class="keywordflow">if</span> ((Page &gt;= LowestPfn) &amp;&amp; (Page &lt;= HighestStartPage)) {
06225 
06226                 <span class="keywordflow">if</span> (BoundaryPfn == 0) {
06227                     PageCount += 1;
06228                 }
06229                 <span class="keywordflow">else</span> <span class="keywordflow">if</span> (((Page ^ (Page + SizeInPages - 1)) &amp; BoundaryMask) == 0) {
06230                     <span class="comment">//</span>
06231                     <span class="comment">// This run's physical address meets the alignment</span>
06232                     <span class="comment">// requirement.</span>
06233                     <span class="comment">//</span>
06234 
06235                     PageCount += 1;
06236                 }
06237             }
06238 
06239             <span class="keywordflow">if</span> (PageCount == SizeInPages) {
06240 
06241                 <span class="comment">//</span>
06242                 <span class="comment">// Success - found a single page satifying the requirements.</span>
06243                 <span class="comment">//</span>
06244 
06245                 BaseAddress = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPte);
06246                 <span class="keywordflow">return</span> BaseAddress;
06247             }
06248 
06249             PreviousPage = Page;
06250             PointerPte += 1;
06251             <span class="keywordflow">continue</span>;
06252         }
06253 
06254         <span class="keywordflow">if</span> (Page != PreviousPage + 1) {
06255 
06256             <span class="comment">//</span>
06257             <span class="comment">// This page is not physically contiguous.  Start over.</span>
06258             <span class="comment">//</span>
06259 
06260             PageCount = 0;
06261             <span class="keywordflow">continue</span>;
06262         }
06263 
06264         PageCount += 1;
06265 
06266         <span class="keywordflow">if</span> (PageCount == SizeInPages) {
06267 
06268             <span class="comment">//</span>
06269             <span class="comment">// Success - found a page range satifying the requirements.</span>
06270             <span class="comment">//</span>
06271 
06272             BaseAddress = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPte - PageCount + 1);
06273             <span class="keywordflow">return</span> BaseAddress;
06274         }
06275 
06276         PointerPte += 1;
06277     }
06278 
06279     <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
06280 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a40" doxytag="iosup.c::MiFreeLowMemory" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LOGICAL MiFreeLowMemory           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>BaseAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Tag</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a43" doxytag="iosup.c::MiFreeMdlTracker" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LOGICAL MiFreeMdlTracker           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT <a class="el" href="../../d6/d7/struct__MDL.html">PMDL</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>MemoryDescriptorList</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PFN_NUMBER&nbsp;</td>
          <td class="mdname" nowrap> <em>NumberOfPages</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l01041">1041</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02680">_LOCK_HEADER::Count</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02664">_LOCK_TRACKER::Count</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02670">_LOCK_TRACKER::GlobalListEntry</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02661">_LOCK_TRACKER::ListEntry</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02679">_LOCK_HEADER::ListHead</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00901">LOCK_PFN2</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02662">_LOCK_TRACKER::Mdl</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l00099">MiTrackingAborted</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l00098">MmLockedPagesHead</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02667">_LOCK_TRACKER::Page</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l00905">UNLOCK_PFN2</a>.
<p>
Referenced by <a class="el" href="../../d6/d5/iosup_8c-source.html#l01152">MmProbeAndLockSelectedPages()</a>, and <a class="el" href="../../d6/d5/iosup_8c-source.html#l01347">MmUnlockPages()</a>.
<p>
<pre class="fragment"><div>01048                    :
01049 
01050     This deletes an <a class="code" href="../../d6/d7/struct__MDL.html">MDL</a> from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified process' chain.  Used specifically
01051     by <a class="code" href="../../d5/d6/iosup_8c.html#a44">MmProbeAndLockSelectedPages</a> () because it builds an <a class="code" href="../../d6/d7/struct__MDL.html">MDL</a> in its local
01052     stack and then copies the requested pages into the real <a class="code" href="../../d6/d7/struct__MDL.html">MDL</a>.  this lets
01053     us track these pages.
01054 
01055 Arguments:
01056 
01057     MemoryDescriptorList - Supplies a pointer to a Memory Descriptor List
01058                            (<a class="code" href="../../d6/d7/struct__MDL.html">MDL</a>). The <a class="code" href="../../d6/d7/struct__MDL.html">MDL</a> must supply the length.
01059 
01060     NumberOfPages - Supplies the number of pages to be freed.
01061 
01062 Return Value:
01063 
01064     TRUE.
01065 
01066 Environment:
01067 
01068     Kernel mode.  APC_LEVEL and below.
01069 
01070 --*/
01071 {
01072     KIRQL OldIrql;
01073     <a class="code" href="../../d0/d3/struct__LOCK__TRACKER.html">PLOCK_TRACKER</a> Tracker;
01074     PLIST_ENTRY NextEntry;
01075     <a class="code" href="../../d5/d2/struct__LOCK__HEADER.html">PLOCK_HEADER</a> LockedPagesHeader;
01076     PPFN_NUMBER Page;
01077     <a class="code" href="../../d0/d3/struct__LOCK__TRACKER.html">PLOCK_TRACKER</a> Found;
01078     PVOID PoolToFree;
01079 
01080     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (MemoryDescriptorList-&gt;Process != NULL);
01081 
01082     LockedPagesHeader = (<a class="code" href="../../d5/d2/struct__LOCK__HEADER.html">PLOCK_HEADER</a>)MemoryDescriptorList-&gt;Process-&gt;LockedPagesList;
01083 
01084     <span class="keywordflow">if</span> (LockedPagesHeader == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01085         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01086     }
01087 
01088     Found = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01089     Page = (PPFN_NUMBER) (MemoryDescriptorList + 1);
01090 
01091     <a class="code" href="../../d4/d8/mi_8h.html#a130">LOCK_PFN2</a> (OldIrql);
01092 
01093     NextEntry = LockedPagesHeader-&gt;<a class="code" href="../../d5/d2/struct__LOCK__HEADER.html#o0">ListHead</a>.Flink;
01094     <span class="keywordflow">while</span> (NextEntry != &amp;LockedPagesHeader-&gt;<a class="code" href="../../d5/d2/struct__LOCK__HEADER.html#o0">ListHead</a>) {
01095 
01096         Tracker = CONTAINING_RECORD (NextEntry,
01097                                      <a class="code" href="../../d0/d3/struct__LOCK__TRACKER.html">LOCK_TRACKER</a>,
01098                                      ListEntry);
01099 
01100         <span class="keywordflow">if</span> (MemoryDescriptorList == Tracker-&gt;<a class="code" href="../../d0/d3/struct__LOCK__TRACKER.html#o1">Mdl</a>) {
01101 
01102             <span class="keywordflow">if</span> (Found != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01103                 <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (LOCKED_PAGES_TRACKER_CORRUPTION,
01104                               0x3,
01105                               (ULONG_PTR)Found,
01106                               (ULONG_PTR)Tracker,
01107                               (ULONG_PTR)MemoryDescriptorList);
01108             }
01109 
01110             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Tracker-&gt;<a class="code" href="../../d0/d3/struct__LOCK__TRACKER.html#o6">Page</a> == *Page);
01111             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (NumberOfPages == Tracker-&gt;<a class="code" href="../../d0/d3/struct__LOCK__TRACKER.html#o3">Count</a>);
01112             Tracker-&gt;<a class="code" href="../../d0/d3/struct__LOCK__TRACKER.html#o3">Count</a> = (PFN_NUMBER)-1;
01113             RemoveEntryList (NextEntry);
01114             LockedPagesHeader-&gt;<a class="code" href="../../d5/d2/struct__LOCK__HEADER.html#o1">Count</a> -= NumberOfPages;
01115 
01116             RemoveEntryList (&amp;Tracker-&gt;<a class="code" href="../../d0/d3/struct__LOCK__TRACKER.html#o9">GlobalListEntry</a>);
01117             <a class="code" href="../../d5/d6/iosup_8c.html#a13">MmLockedPagesHead</a>.<a class="code" href="../../d5/d2/struct__LOCK__HEADER.html#o1">Count</a> -= NumberOfPages;
01118 
01119             Found = Tracker;
01120             PoolToFree = (PVOID)NextEntry;
01121         }
01122         NextEntry = Tracker-&gt;<a class="code" href="../../d0/d3/struct__LOCK__TRACKER.html#o0">ListEntry</a>.Flink;
01123     }
01124 
01125     <a class="code" href="../../d4/d8/mi_8h.html#a131">UNLOCK_PFN2</a> (OldIrql);
01126 
01127     <span class="keywordflow">if</span> (Found == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01128 
01129         <span class="comment">//</span>
01130         <span class="comment">// A driver is trying to unlock pages that aren't locked.</span>
01131         <span class="comment">//</span>
01132 
01133         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/iosup_8c.html#a14">MiTrackingAborted</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01134             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01135         }
01136 
01137         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (PROCESS_HAS_LOCKED_PAGES,
01138                       1,
01139                       (ULONG_PTR)MemoryDescriptorList,
01140                       MemoryDescriptorList-&gt;Process-&gt;NumberOfLockedPages,
01141                       (ULONG_PTR)MemoryDescriptorList-&gt;Process-&gt;LockedPagesList);
01142     }
01143 
01144     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (PoolToFree);
01145 
01146     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01147 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a48" doxytag="iosup.c::MiGetHighestPteConsumer" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PVOID MiGetHighestPteConsumer           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">OUT PULONG_PTR&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>NumberOfPtes</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l01901">1901</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
References <a class="el" href="../../d6/d5/iosup_8c-source.html#l00082">_PTE_TRACKER::CallingAddress</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l00076">_PTE_TRACKER::Count</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l00088">_SYSPTES_HEADER::ListHead</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l00094">MiPteHeader</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l00093">MiTrackPtesAborted</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00093">MmTrackPtes</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d6/iosup_8c.html#a5">PPTE_TRACKER</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00582">PsLoadedModuleList</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d1/d8/sysptes_8c-source.html#l00843">MiReserveSystemPtes2()</a>.
<p>
<pre class="fragment"><div>01907                    :
01908 
01909     This function examines <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PTE tracking blocks and returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> biggest
01910     consumer.
01911 
01912 Arguments:
01913 
01914     None.
01915 
01916 Return Value:
01917 
01918     The loaded module entry of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> biggest consumer.
01919 
01920 Environment:
01921 
01922     Kernel mode, called during bugcheck <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a>.  Many locks may be held.
01923 
01924 --*/
01925 
01926 {
01927     <a class="code" href="../../d7/d1/struct__PTE__TRACKER.html">PPTE_TRACKER</a> Tracker;
01928     PVOID BaseAddress;
01929     PFN_NUMBER NumberOfPages;
01930     PLIST_ENTRY NextEntry;
01931     PLIST_ENTRY NextEntry2;
01932     PLDR_DATA_TABLE_ENTRY DataTableEntry;
01933     ULONG_PTR Highest;
01934     ULONG_PTR PagesByThisModule;
01935     PLDR_DATA_TABLE_ENTRY HighDataTableEntry;
01936 
01937     *NumberOfPtes = 0;
01938 
01939     <span class="comment">//</span>
01940     <span class="comment">// No locks are acquired as this is only called during a bugcheck.</span>
01941     <span class="comment">//</span>
01942 
01943     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a37">MmTrackPtes</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01944         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01945     }
01946 
01947     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/iosup_8c.html#a9">MiTrackPtesAborted</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01948         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01949     }
01950 
01951     <span class="keywordflow">if</span> (IsListEmpty(&amp;<a class="code" href="../../d5/d6/iosup_8c.html#a10">MiPteHeader</a>.<a class="code" href="../../d9/d7/struct__SYSPTES__HEADER.html#o0">ListHead</a>)) {
01952         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01953     }
01954 
01955     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>.Flink == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01956         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01957     }
01958 
01959     Highest = 0;
01960     HighDataTableEntry = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01961 
01962     NextEntry = <a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>.Flink;
01963     <span class="keywordflow">while</span> (NextEntry != &amp;<a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>) {
01964 
01965         DataTableEntry = CONTAINING_RECORD(NextEntry,
01966                                            LDR_DATA_TABLE_ENTRY,
01967                                            InLoadOrderLinks);
01968 
01969         PagesByThisModule = 0;
01970 
01971         <span class="comment">//</span>
01972         <span class="comment">// Walk the PTE mapping list and update each driver's counts.</span>
01973         <span class="comment">//</span>
01974     
01975         NextEntry2 = <a class="code" href="../../d5/d6/iosup_8c.html#a10">MiPteHeader</a>.<a class="code" href="../../d9/d7/struct__SYSPTES__HEADER.html#o0">ListHead</a>.Flink;
01976         <span class="keywordflow">while</span> (NextEntry2 != &amp;<a class="code" href="../../d5/d6/iosup_8c.html#a10">MiPteHeader</a>.<a class="code" href="../../d9/d7/struct__SYSPTES__HEADER.html#o0">ListHead</a>) {
01977     
01978             Tracker = (<a class="code" href="../../d7/d1/struct__PTE__TRACKER.html">PPTE_TRACKER</a>) CONTAINING_RECORD (NextEntry2,
01979                                                         <a class="code" href="../../d7/d1/struct__PTE__TRACKER.html">PTE_TRACKER</a>,
01980                                                         ListEntry.Flink);
01981     
01982             BaseAddress = Tracker-&gt;<a class="code" href="../../d7/d1/struct__PTE__TRACKER.html#o8">CallingAddress</a>;
01983             NumberOfPages = Tracker-&gt;<a class="code" href="../../d7/d1/struct__PTE__TRACKER.html#o2">Count</a>;
01984     
01985             <span class="keywordflow">if</span> ((BaseAddress &gt;= DataTableEntry-&gt;DllBase) &amp;&amp;
01986                 (BaseAddress &lt; (PVOID)((ULONG_PTR)(DataTableEntry-&gt;DllBase) + DataTableEntry-&gt;SizeOfImage))) {
01987 
01988                 PagesByThisModule += NumberOfPages;
01989             }
01990         
01991             NextEntry2 = NextEntry2-&gt;Flink;
01992     
01993         }
01994     
01995         <span class="keywordflow">if</span> (PagesByThisModule &gt; Highest) {
01996             Highest = PagesByThisModule;
01997             HighDataTableEntry = DataTableEntry;
01998         }
01999 
02000         NextEntry = NextEntry-&gt;Flink;
02001     }
02002 
02003     *NumberOfPtes = Highest;
02004 
02005     <span class="keywordflow">return</span> (PVOID)HighDataTableEntry;
02006 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a31" doxytag="iosup.c::MiGetSystemPteAvailability" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LOGICAL MiGetSystemPteAvailability           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>NumberOfPtes</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d1/mm_8h.html#a154">MM_PAGE_PRIORITY</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Priority</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d8/sysptes_8c-source.html#l02030">2030</a> of file <a class="el" href="../../d1/d8/sysptes_8c-source.html">sysptes.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d1/mm_8h.html#a347a183">HighPagePriority</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l00116">MM_PTE_TABLE_LIMIT</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l00103">MmSysPteListBySizeCount</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l00104">MmSysPteMinimumFree</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l00098">MmSysPteTables</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00045">MmTotalFreeSystemPtes</a>, <a class="el" href="../../d2/d1/mm_8h.html#a347a182">NormalPagePriority</a>, <a class="el" href="../../d4/d8/mi_8h.html#a1003a769">SystemPteSpace</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d6/d5/iosup_8c-source.html#l02395">MiMapSinglePage()</a>, and <a class="el" href="../../d6/d5/iosup_8c-source.html#l02058">MmMapLockedPagesSpecifyCache()</a>.
<p>
<pre class="fragment"><div>02037                    :
02038 
02039     This routine checks how many <a class="code" href="../../d4/d8/mi_8h.html#a1003a769">SystemPteSpace</a> PTEs are available <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02040     requested size.  If plenty are available then <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned.
02041     If we are reaching a <a class="code" href="../../d2/d3/fetypes_8h.html#a457a418">low</a> resource situation, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> request <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> evaluated
02042     based on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> argument priority.
02043 
02044 Arguments:
02045 
02046     NumberOfPtes - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of PTEs needed.
02047 
02048     Priority - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> priority of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> request.
02049 
02050 Return Value:
02051 
02052     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller should allocate <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PTEs, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <span class="keywordflow">if</span> not.
02053 
02054 Environment:
02055 
02056     Kernel mode.
02057 
02058 --*/
02059 
02060 {
02061     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
02062     ULONG FreePtes;
02063     ULONG FreeBinnedPtes;
02064 
02065     <span class="keywordflow">if</span> (Priority == <a class="code" href="../../d2/d1/mm_8h.html#a347a183">HighPagePriority</a>) {
02066         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02067     }
02068 
02069 <span class="preprocessor">#ifdef _MI_GUARD_PTE_</span>
02070 <span class="preprocessor"></span>    NumberOfPtes += 1;
02071 <span class="preprocessor">#endif</span>
02072 <span class="preprocessor"></span>
02073     FreePtes = <a class="code" href="../../d6/d8/sysinfo_8c.html#a8">MmTotalFreeSystemPtes</a>[<a class="code" href="../../d4/d8/mi_8h.html#a1003a769">SystemPteSpace</a>];
02074 
02075     <span class="keywordflow">if</span> (NumberOfPtes &lt;= <a class="code" href="../../d0/d9/sysptes_8c.html#a7">MM_PTE_TABLE_LIMIT</a>) {
02076         <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = <a class="code" href="../../d0/d9/sysptes_8c.html#a14">MmSysPteTables</a> [NumberOfPtes];
02077         FreeBinnedPtes = <a class="code" href="../../d0/d9/sysptes_8c.html#a17">MmSysPteListBySizeCount</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>];
02078 
02079         <span class="keywordflow">if</span> (FreeBinnedPtes &gt; <a class="code" href="../../d0/d9/sysptes_8c.html#a18">MmSysPteMinimumFree</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>]) {
02080             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02081         }
02082         <span class="keywordflow">if</span> (FreeBinnedPtes != 0) {
02083             <span class="keywordflow">if</span> (Priority == <a class="code" href="../../d2/d1/mm_8h.html#a347a182">NormalPagePriority</a>) {
02084                 <span class="keywordflow">if</span> (FreeBinnedPtes &gt; 1 || FreePtes &gt; 512) {
02085                     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02086                 }
02087                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02088             }
02089             <span class="keywordflow">if</span> (FreePtes &gt; 2048) {
02090                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02091             }
02092             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02093         }
02094     }
02095 
02096     <span class="keywordflow">if</span> (Priority == <a class="code" href="../../d2/d1/mm_8h.html#a347a182">NormalPagePriority</a>) {
02097         <span class="keywordflow">if</span> ((LONG)NumberOfPtes &lt; (LONG)FreePtes - 512) {
02098             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02099         }
02100         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02101     }
02102 
02103     <span class="keywordflow">if</span> ((LONG)NumberOfPtes &lt; (LONG)FreePtes - 2048) {
02104         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02105     }
02106     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02107 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a47" doxytag="iosup.c::MiInitializeIoTrackers" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MiInitializeIoTrackers           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l01595">1595</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
References <a class="el" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l00088">_SYSPTES_HEADER::ListHead</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02679">_LOCK_HEADER::ListHead</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l00095">MiDeadPteTrackerListHead</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l00094">MiPteHeader</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l00096">MiPteTrackerLock</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l00098">MmLockedPagesHead</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00089">MmTrackLockedPages</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00093">MmTrackPtes</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/mminit_8c-source.html#l00184">MmInitSystem()</a>.
<p>
<pre class="fragment"><div>01598 {
01599     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a37">MmTrackPtes</a> != 0) {
01600         InitializeListHead (&amp;MiDeadPteTrackerListHead);
01601         <a class="code" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock</a> (&amp;MiPteTrackerLock);
01602         InitializeListHead (&amp;<a class="code" href="../../d5/d6/iosup_8c.html#a10">MiPteHeader</a>.<a class="code" href="../../d9/d7/struct__SYSPTES__HEADER.html#o0">ListHead</a>);
01603     }
01604 
01605     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a33">MmTrackLockedPages</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01606         InitializeListHead (&amp;<a class="code" href="../../d5/d6/iosup_8c.html#a13">MmLockedPagesHead</a>.<a class="code" href="../../d5/d2/struct__LOCK__HEADER.html#o0">ListHead</a>);
01607     }
01608 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a36" doxytag="iosup.c::MiInsertDeadPteTrackingBlock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MiInsertDeadPteTrackingBlock           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>PoolBlock</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l01823">1823</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
References <a class="el" href="../../d6/d5/iosup_8c-source.html#l00095">MiDeadPteTrackerListHead</a>, and <a class="el" href="../../d6/d5/iosup_8c-source.html#l00096">MiPteTrackerLock</a>.
<p>
Referenced by <a class="el" href="../../d6/d5/iosup_8c-source.html#l03678">MmUnmapIoSpace()</a>, and <a class="el" href="../../d6/d5/iosup_8c-source.html#l03124">MmUnmapLockedPages()</a>.
<p>
<pre class="fragment"><div>01829                    :
01830 
01831     This routine inserts a tracking block into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> dead PTE list <span class="keywordflow">for</span> later
01832     release.  Locks (including the PFN lock) may be held on entry, thus <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01833     block cannot be directly freed to <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> at <span class="keyword">this</span> time.
01834 
01835 Arguments:
01836 
01837     PoolBlock - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> address to free.
01838 
01839 Return Value:
01840 
01841     None.
01842 
01843 Environment:
01844 
01845     Kernel mode.  <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a> or below, locks may be held.
01846 
01847 --*/
01848 {
01849     KIRQL OldIrql;
01850 
01851     ExAcquireSpinLock (&amp;MiPteTrackerLock, &amp;OldIrql);
01852 
01853     InsertTailList (&amp;MiDeadPteTrackerListHead, (PLIST_ENTRY)PoolBlock);
01854 
01855     ExReleaseSpinLock (&amp;MiPteTrackerLock, OldIrql);
01856 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a33" doxytag="iosup.c::MiInsertPteTracker" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MiInsertPteTracker           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>PoolBlock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d6/d7/struct__MDL.html">PMDL</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>MemoryDescriptorList</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PFN_NUMBER&nbsp;</td>
          <td class="mdname" nowrap> <em>NumberOfPtes</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>MyCaller</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>MyCallersCaller</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l01611">1611</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
References <a class="el" href="../../d6/d5/iosup_8c-source.html#l00083">_PTE_TRACKER::CallersCaller</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l00082">_PTE_TRACKER::CallingAddress</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l00089">_SYSPTES_HEADER::Count</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l00076">_PTE_TRACKER::Count</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l00080">_PTE_TRACKER::Length</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l00074">_PTE_TRACKER::ListEntry</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l00088">_SYSPTES_HEADER::ListHead</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l00075">_PTE_TRACKER::Mdl</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l00094">MiPteHeader</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l00079">_PTE_TRACKER::Offset</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l00081">_PTE_TRACKER::Page</a>, <a class="el" href="../../d5/d6/iosup_8c.html#a5">PPTE_TRACKER</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l00084">_PTE_TRACKER::PteAddress</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l00078">_PTE_TRACKER::StartVa</a>, and <a class="el" href="../../d6/d5/iosup_8c-source.html#l00077">_PTE_TRACKER::SystemVa</a>.
<p>
Referenced by <a class="el" href="../../d6/d5/iosup_8c-source.html#l03415">MmMapIoSpace()</a>, and <a class="el" href="../../d6/d5/iosup_8c-source.html#l02058">MmMapLockedPagesSpecifyCache()</a>.
<p>
<pre class="fragment"><div>01620                    :
01621 
01622     This function inserts a PTE tracking block as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller has just
01623     consumed system PTEs.
01624 
01625 Arguments:
01626 
01627     PoolBlock - Supplies a tracker <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> block.  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> supplied by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller
01628                 since <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d4/d4/alpha_2splocks_8c.html#a15">MmSystemSpaceLock</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> held on entry hence <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a>
01629                 allocations may not be done here.
01630 
01631     MemoryDescriptorList - Supplies a valid Memory Descriptor <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>.
01632 
01633     NumberOfPtes - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of system PTEs allocated.
01634 
01635     MyCaller - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keywordflow">return</span> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller who consumed <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01636                system PTEs to map <span class="keyword">this</span> <a class="code" href="../../d6/d7/struct__MDL.html">MDL</a>.
01637 
01638     MyCallersCaller - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keywordflow">return</span> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller
01639                       who consumed <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system PTEs to map <span class="keyword">this</span> <a class="code" href="../../d6/d7/struct__MDL.html">MDL</a>.
01640 
01641 Return Value:
01642 
01643     None.
01644 
01645 Environment:
01646 
01647     Kernel mode, <span class="keyword">protected</span> by <a class="code" href="../../d4/d4/alpha_2splocks_8c.html#a15">MmSystemSpaceLock</a> at <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>.
01648 
01649 --*/
01650 
01651 {
01652     <a class="code" href="../../d7/d1/struct__PTE__TRACKER.html">PPTE_TRACKER</a> Tracker;
01653 
01654     Tracker = (<a class="code" href="../../d7/d1/struct__PTE__TRACKER.html">PPTE_TRACKER</a>)PoolBlock;
01655 
01656     Tracker-&gt;<a class="code" href="../../d7/d1/struct__PTE__TRACKER.html#o1">Mdl</a> = MemoryDescriptorList;
01657     Tracker-&gt;<a class="code" href="../../d7/d1/struct__PTE__TRACKER.html#o3">SystemVa</a> = MemoryDescriptorList-&gt;MappedSystemVa;
01658     Tracker-&gt;<a class="code" href="../../d7/d1/struct__PTE__TRACKER.html#o2">Count</a> = NumberOfPtes;
01659 
01660     Tracker-&gt;<a class="code" href="../../d7/d1/struct__PTE__TRACKER.html#o4">StartVa</a> = MemoryDescriptorList-&gt;StartVa;
01661     Tracker-&gt;<a class="code" href="../../d7/d1/struct__PTE__TRACKER.html#o5">Offset</a> = MemoryDescriptorList-&gt;ByteOffset;
01662     Tracker-&gt;<a class="code" href="../../d7/d1/struct__PTE__TRACKER.html#o6">Length</a> = MemoryDescriptorList-&gt;ByteCount;
01663     Tracker-&gt;<a class="code" href="../../d7/d1/struct__PTE__TRACKER.html#o7">Page</a> = *(PPFN_NUMBER)(MemoryDescriptorList + 1);
01664 
01665     Tracker-&gt;<a class="code" href="../../d7/d1/struct__PTE__TRACKER.html#o8">CallingAddress</a> = MyCaller;
01666     Tracker-&gt;<a class="code" href="../../d7/d1/struct__PTE__TRACKER.html#o9">CallersCaller</a> = MyCallersCaller;
01667     Tracker-&gt;<a class="code" href="../../d7/d1/struct__PTE__TRACKER.html#o10">PteAddress</a> = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (Tracker-&gt;<a class="code" href="../../d7/d1/struct__PTE__TRACKER.html#o3">SystemVa</a>);
01668 
01669     <a class="code" href="../../d5/d6/iosup_8c.html#a10">MiPteHeader</a>.<a class="code" href="../../d9/d7/struct__SYSPTES__HEADER.html#o1">Count</a> += NumberOfPtes;
01670 
01671     InsertHeadList (&amp;<a class="code" href="../../d5/d6/iosup_8c.html#a10">MiPteHeader</a>.<a class="code" href="../../d9/d7/struct__SYSPTES__HEADER.html#o0">ListHead</a>, &amp;Tracker-&gt;<a class="code" href="../../d7/d1/struct__PTE__TRACKER.html#o0">ListEntry</a>);
01672 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a77" doxytag="iosup.c::MiLockCode" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MiLockCode           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FirstPte</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>LastPte</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>LockType</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l06461">6461</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
References <a class="el" href="../../d2/d1/mm_8h.html#a345a177">ActiveAndValid</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00086">APC_LEVEL</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01600">_MMWSL::FirstDynamic</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01417">MI_ADD_LOCKED_PAGE_CHARGE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02411">MI_GET_PAGE_FRAME_FROM_TRANSITION_PTE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02262">MI_IS_PHYSICAL_ADDRESS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05287">MI_IS_SESSION_IMAGE_ADDRESS</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00494">MI_MAKE_VALID_PTE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01470">MI_REMOVE_LOCKED_PAGE_CHARGE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00641">MI_SET_PTE_IN_WORKING_SET</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02459">MI_WRITE_VALID_PTE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01521">MI_ZERO_WSINDEX</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01842">MiGetVirtualAddressMappedByPte</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l00117">MiLocateAndReserveWsle()</a>, <a class="el" href="../../d8/d9/wstree_8c-source.html#l00248">MiLocateWsle()</a>, <a class="el" href="../../d1/d1/mmsup_8c-source.html#l00916">MiMakeSystemAddressValidPfnSystemWs()</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l01016">MiReleaseWsle()</a>, <a class="el" href="../../d8/d9/wstree_8c-source.html#l00464">MiRemoveWsle()</a>, <a class="el" href="../../d8/d9/wstree_8c-source.html#l00576">MiSwapWslEntries()</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00667">MiUnlinkPageFromList()</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l01078">MiUpdateWsle()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04317">MM_BUMP_COUNTER</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00113">MM_LOCK_BY_REFCOUNT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00951">MM_PFN_LOCK_ASSERT</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l00209">MmLockedCode</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00068">MmPagedPoolEnd</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00067">MmPagedPoolStart</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00086">MmResidentAvailablePages</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05609">MmSessionSpace</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l01977">MmSpecialPoolEnd</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l01976">MmSpecialPoolStart</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04752">MmSystemCacheWorkingSetList</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00064">MmSystemCacheWs</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00051">MmTotalSystemDriverPages</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01297">_MMPFN::OriginalPte</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00085">PMMSUPPORT</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01281">_MMPFN::PteAddress</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o5">_MMPFN::u1</a>, <a class="el" href="../../d1/d8/struct__MMWSLE.html#o3">_MMWSLE::u1</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o10">_MMPFN::u2</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o15">_MMPFN::u3</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05556">_MM_SESSION_SPACE::Vm</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00064">_MMSUPPORT::VmWorkingSetList</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l05557">_MM_SESSION_SPACE::Wsle</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01231">WSLE_NUMBER</a>, and <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00036">ZeroKernelPte</a>.
<p>
Referenced by <a class="el" href="../../d6/d5/iosup_8c-source.html#l06284">MmLockPagableSectionByHandle()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l07821">MmLockPagedPool()</a>, and <a class="el" href="../../d9/d7/sysload_8c-source.html#l02560">MmResetDriverPaging()</a>.
<p>
<pre class="fragment"><div>06469                    :
06470 
06471     This routine checks to see <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified pages are resident in
06472     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process's working set and <span class="keywordflow">if</span> so <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> reference count <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
06473     page <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> incremented.  This allows <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">virtual</span> address to be accessed
06474     without getting a hard page fault (have to go to the disk...) except
06475     <span class="keywordflow">for</span> the extremely rare <span class="keywordflow">case</span> when the page table page is removed from the
06476     working set and migrates to the disk.
06477 
06478     If the <span class="keyword">virtual</span> address is that of the system wide global <span class="stringliteral">"cache"</span>, the
06479     <span class="keyword">virtual</span> address of the <span class="stringliteral">"locked"</span> pages is always guaranteed to
06480     be valid.
06481 
06482     NOTE: This routine is not to be used <span class="keywordflow">for</span> general locking of user
06483     addresses - use <a class="code" href="../../d2/d1/mm_8h.html#a273">MmProbeAndLockPages</a>.  This routine is intended <span class="keywordflow">for</span>
06484     well behaved system code like the file system caches which allocates
06485     <span class="keyword">virtual</span> addresses <span class="keywordflow">for</span> mapping files AND guarantees that the mapping
06486     will not be modified (deleted or changed) <span class="keywordflow">while</span> the pages are locked.
06487 
06488 Arguments:
06489 
06490     FirstPte - Supplies the base address to begin locking.
06491 
06492     LastPte - The last PTE to lock.
06493 
06494     LockType - Supplies either MM_LOCK_BY_REFCOUNT or MM_LOCK_NONPAGE.
06495                LOCK_BY_REFCOUNT increments the reference count to keep
06496                the page in memory, LOCK_NONPAGE removes the page from
06497                the working set so it's locked just like nonpaged <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a>.
06498 
06499 Return Value:
06500 
06501     None.
06502 
06503 Environment:
06504 
06505     Kernel mode, System working set mutex and PFN <a class="code" href="../../d4/d2/struct__LOCK.html">LOCK</a> held.
06506 
06507 --*/
06508 
06509 {
06510     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
06511     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
06512     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
06513     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> PteContents;
06514     WSLE_NUMBER WorkingSetIndex;
06515     WSLE_NUMBER SwapEntry;
06516     PFN_NUMBER PageFrameIndex;
06517     KIRQL OldIrql;
06518     LOGICAL SessionSpace;
06519     <a class="code" href="../../d0/d8/struct__MMWSL.html">PMMWSL</a> WorkingSetList;
06520     <a class="code" href="../../d3/d6/struct__MMSUPPORT.html">PMMSUPPORT</a> Vm;
06521 #<span class="keywordflow">if</span> PFN_CONSISTENCY
06522     KIRQL PfnIrql;
06523 #endif
06524 
06525     <a class="code" href="../../d4/d8/mi_8h.html#a136">MM_PFN_LOCK_ASSERT</a>();
06526 
06527     SessionSpace = MI_IS_SESSION_IMAGE_ADDRESS (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a>(FirstPte));
06528 
06529     <span class="keywordflow">if</span> (SessionSpace == TRUE) {
06530         Vm = &amp;<a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>;
06531         WorkingSetList = <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o30">Vm</a>.<a class="code" href="../../d3/d6/struct__MMSUPPORT.html#o7">VmWorkingSetList</a>;
06532     }
06533 
06534     <span class="comment">//</span>
06535     <span class="comment">// Session space is never locked by refcount.</span>
06536     <span class="comment">//</span>
06537 
06538     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((SessionSpace == FALSE) || (LockType != MM_LOCK_BY_REFCOUNT));
06539 
06540     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (!<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a178">MI_IS_PHYSICAL_ADDRESS</a>(<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a>(FirstPte)));
06541     PointerPte = FirstPte;
06542 
06543     <a class="code" href="../../d5/d6/iosup_8c.html#a20">MmLockedCode</a> += 1 + LastPte - FirstPte;
06544 
06545     <span class="keywordflow">do</span> {
06546 
06547         PteContents = *PointerPte;
06548         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PteContents.u.Long != <a class="code" href="../../d4/d2/datalpha_8c.html#a1">ZeroKernelPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long);
06549         <span class="keywordflow">if</span> (PteContents.u.Hard.Valid == 0) {
06550 
06551             <span class="keywordflow">if</span> (PteContents.u.Soft.Prototype == 1) {
06552 
06553                 <span class="comment">//</span>
06554                 <span class="comment">// Page is not in memory and it is a prototype.</span>
06555                 <span class="comment">//</span>
06556 
06557                 <a class="code" href="../../d0/d2/mmsup_8c.html#a10">MiMakeSystemAddressValidPfnSystemWs</a> (
06558                         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a>(PointerPte));
06559 
06560                 <span class="keywordflow">continue</span>;
06561             }
06562             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (PteContents.u.Soft.Transition == 1) {
06563 
06564                 PageFrameIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a183">MI_GET_PAGE_FRAME_FROM_TRANSITION_PTE</a> (&amp;PteContents);
06565 
06566                 Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
06567                 <span class="keywordflow">if</span> ((Pfn1-&gt;u3.e1.ReadInProgress) ||
06568                     (Pfn1-&gt;u3.e1.InPageError)) {
06569 
06570                     <span class="comment">//</span>
06571                     <span class="comment">// Page read is ongoing, force a collided fault.</span>
06572                     <span class="comment">//</span>
06573 
06574                     <a class="code" href="../../d0/d2/mmsup_8c.html#a10">MiMakeSystemAddressValidPfnSystemWs</a> (
06575                             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a>(PointerPte));
06576 
06577                     <span class="keywordflow">continue</span>;
06578                 }
06579 
06580                 <span class="comment">//</span>
06581                 <span class="comment">// Paged pool is trimmed without regard to sharecounts.</span>
06582                 <span class="comment">// This means a paged pool PTE can be in transition while</span>
06583                 <span class="comment">// the page is still marked active.</span>
06584                 <span class="comment">//</span>
06585 
06586                 <span class="keywordflow">if</span> (Pfn1-&gt;u3.e1.PageLocation == <a class="code" href="../../d2/d1/mm_8h.html#a345a177">ActiveAndValid</a>) {
06587 
06588                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (((Pfn1-&gt;PteAddress &gt;= <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(MmPagedPoolStart)) &amp;&amp;
06589                             (Pfn1-&gt;PteAddress &lt;= <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(MmPagedPoolEnd))) ||
06590                             ((Pfn1-&gt;PteAddress &gt;= <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(MmSpecialPoolStart)) &amp;&amp;
06591                             (Pfn1-&gt;PteAddress &lt;= <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(MmSpecialPoolEnd))));
06592 
06593                     <span class="comment">//</span>
06594                     <span class="comment">// Don't increment the valid PTE count for the</span>
06595                     <span class="comment">// paged pool page.</span>
06596                     <span class="comment">//</span>
06597 
06598                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;u2.ShareCount != 0);
06599                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;u3.e2.ReferenceCount != 0);
06600                     Pfn1-&gt;u2.ShareCount += 1;
06601                 }
06602                 <span class="keywordflow">else</span> {
06603 
06604                     <a class="code" href="../../d7/d5/pfnlist_8c.html#a11">MiUnlinkPageFromList</a> (Pfn1);
06605 
06606                     <span class="comment">//</span>
06607                     <span class="comment">// Set the reference count and share counts to 1.  Note the</span>
06608                     <span class="comment">// reference count may be 1 already if a modified page</span>
06609                     <span class="comment">// write is underway.  The systemwide locked page charges</span>
06610                     <span class="comment">// are correct in either case and nothing needs to be done</span>
06611                     <span class="comment">// just yet.</span>
06612                     <span class="comment">//</span>
06613 
06614                     Pfn1-&gt;u3.e2.ReferenceCount += 1;
06615                     Pfn1-&gt;u2.ShareCount = 1;
06616                 }
06617 
06618                 Pfn1-&gt;u3.e1.PageLocation = <a class="code" href="../../d2/d1/mm_8h.html#a345a177">ActiveAndValid</a>;
06619 
06620                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a105">MI_MAKE_VALID_PTE</a> (TempPte,
06621                                    PageFrameIndex,
06622                                    Pfn1-&gt;OriginalPte.u.Soft.Protection,
06623                                    PointerPte);
06624 
06625                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a> (PointerPte, TempPte);
06626 
06627                 <span class="comment">//</span>
06628                 <span class="comment">// Increment the reference count one for putting it the</span>
06629                 <span class="comment">// working set list and one for locking it for I/O.</span>
06630                 <span class="comment">//</span>
06631 
06632                 <span class="keywordflow">if</span> (LockType == <a class="code" href="../../d4/d8/mi_8h.html#a29">MM_LOCK_BY_REFCOUNT</a>) {
06633 
06634                     <span class="comment">//</span>
06635                     <span class="comment">// Lock the page in the working set by upping the</span>
06636                     <span class="comment">// reference count.</span>
06637                     <span class="comment">//</span>
06638 
06639                     <a class="code" href="../../d4/d8/mi_8h.html#a186">MI_ADD_LOCKED_PAGE_CHARGE</a> (Pfn1, 34);
06640                     Pfn1-&gt;u3.e2.ReferenceCount += 1;
06641                     Pfn1-&gt;u1.Event = (PVOID)<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
06642 
06643                     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (APC_LEVEL);
06644                     WorkingSetIndex = <a class="code" href="../../d4/d0/wslist_8c.html#a21">MiLocateAndReserveWsle</a> (&amp;MmSystemCacheWs);
06645 
06646                     <a class="code" href="../../d4/d0/wslist_8c.html#a25">MiUpdateWsle</a> (&amp;WorkingSetIndex,
06647                                   MiGetVirtualAddressMappedByPte (PointerPte),
06648                                   MmSystemCacheWorkingSetList,
06649                                   Pfn1);
06650 
06651                     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a109">MI_SET_PTE_IN_WORKING_SET</a> (PointerPte, WorkingSetIndex);
06652 
06653                     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
06654 
06655                 } <span class="keywordflow">else</span> {
06656 
06657                     <span class="comment">//</span>
06658                     <span class="comment">// The wsindex field must be zero because the</span>
06659                     <span class="comment">// page is not in the system (or session) working set.</span>
06660                     <span class="comment">//</span>
06661 
06662                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;u1.WsIndex == 0);
06663 
06664                     <span class="comment">//</span>
06665                     <span class="comment">// Adjust available pages as this page is now not in any</span>
06666                     <span class="comment">// working set, just like a non-paged pool page.  On entry</span>
06667                     <span class="comment">// this page was in transition so it was part of the</span>
06668                     <span class="comment">// available pages by definition.</span>
06669                     <span class="comment">//</span>
06670     
06671                     <a class="code" href="../../d8/d5/kddata_8c.html#a42">MmResidentAvailablePages</a> -= 1;
06672                     <span class="keywordflow">if</span> (Pfn1-&gt;u3.e1.PrototypePte == 0) {
06673                         <a class="code" href="../../d6/d8/sysinfo_8c.html#a14">MmTotalSystemDriverPages</a> -= 1;
06674                     }
06675                     <a class="code" href="../../d4/d8/mi_8h.html#a322">MM_BUMP_COUNTER</a>(29, 1);
06676                 }
06677             } <span class="keywordflow">else</span> {
06678 
06679                 <span class="comment">//</span>
06680                 <span class="comment">// Page is not in memory.</span>
06681                 <span class="comment">//</span>
06682 
06683                 <a class="code" href="../../d0/d2/mmsup_8c.html#a10">MiMakeSystemAddressValidPfnSystemWs</a> (
06684                         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a>(PointerPte));
06685 
06686                 <span class="keywordflow">continue</span>;
06687             }
06688 
06689         }
06690         <span class="keywordflow">else</span> {
06691 
06692             <span class="comment">//</span>
06693             <span class="comment">// This address is already in the system (or session) working set.</span>
06694             <span class="comment">//</span>
06695 
06696             Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PteContents.u.Hard.PageFrameNumber);
06697 
06698             <span class="comment">//</span>
06699             <span class="comment">// Up the reference count so the page cannot be released.</span>
06700             <span class="comment">//</span>
06701 
06702             <a class="code" href="../../d4/d8/mi_8h.html#a186">MI_ADD_LOCKED_PAGE_CHARGE</a> (Pfn1, 36);
06703             Pfn1-&gt;u3.e2.ReferenceCount += 1;
06704 
06705             <span class="keywordflow">if</span> (LockType != <a class="code" href="../../d4/d8/mi_8h.html#a29">MM_LOCK_BY_REFCOUNT</a>) {
06706 
06707                 <span class="comment">//</span>
06708                 <span class="comment">// If the page is in the system working set, remove it.</span>
06709                 <span class="comment">// The system working set lock MUST be owned to check to</span>
06710                 <span class="comment">// see if this page is in the working set or not.  This</span>
06711                 <span class="comment">// is because the pager may have just released the PFN lock,</span>
06712                 <span class="comment">// acquired the system lock and is now trying to add the</span>
06713                 <span class="comment">// page to the system working set.</span>
06714                 <span class="comment">//</span>
06715                 <span class="comment">// If the page is in the SESSION working set, it cannot be</span>
06716                 <span class="comment">// removed as all these pages are carefully accounted for.</span>
06717                 <span class="comment">// Instead move it to the locked portion of the working set</span>
06718                 <span class="comment">// if it is not there already.</span>
06719                 <span class="comment">//</span>
06720 
06721                 <span class="keywordflow">if</span> (Pfn1-&gt;u1.WsIndex != 0) {
06722 
06723                     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (APC_LEVEL);
06724 
06725                     <span class="keywordflow">if</span> (SessionSpace == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
06726 
06727                         WorkingSetIndex = <a class="code" href="../../d7/d0/wstree_8c.html#a7">MiLocateWsle</a> (
06728                                     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a>(PointerPte),
06729                                     WorkingSetList,
06730                                     Pfn1-&gt;u1.WsIndex);
06731 
06732                         <span class="keywordflow">if</span> (WorkingSetIndex &gt;= WorkingSetList-&gt;FirstDynamic) {
06733                 
06734                             SwapEntry = WorkingSetList-&gt;FirstDynamic;
06735                 
06736                             <span class="keywordflow">if</span> (WorkingSetIndex != WorkingSetList-&gt;FirstDynamic) {
06737                 
06738                                 <span class="comment">//</span>
06739                                 <span class="comment">// Swap this entry with the one at first</span>
06740                                 <span class="comment">// dynamic.  Note that the working set index</span>
06741                                 <span class="comment">// in the PTE is updated here as well.</span>
06742                                 <span class="comment">//</span>
06743                 
06744                                 <a class="code" href="../../d7/d0/wstree_8c.html#a9">MiSwapWslEntries</a> (WorkingSetIndex,
06745                                                   SwapEntry,
06746                                                   Vm);
06747                             }
06748                 
06749                             WorkingSetList-&gt;FirstDynamic += 1;
06750                         }
06751                         <span class="keywordflow">else</span> {
06752                             SwapEntry = WorkingSetIndex;
06753                         }
06754 
06755                         <span class="comment">//</span>
06756                         <span class="comment">// Indicate that the page is locked.</span>
06757                         <span class="comment">//</span>
06758             
06759                         <a class="code" href="../../d4/d8/mi_8h.html#a753">MmSessionSpace</a>-&gt;<a class="code" href="../../d0/d0/struct__MM__SESSION__SPACE.html#o31">Wsle</a>[SwapEntry].<a class="code" href="../../d1/d8/struct__MMWSLE.html#o3">u1</a>.e1.LockedInWs = 1;
06760                     }
06761                     <span class="keywordflow">else</span> {
06762                         <a class="code" href="../../d7/d0/wstree_8c.html#a8">MiRemoveWsle</a> (Pfn1-&gt;u1.WsIndex, MmSystemCacheWorkingSetList);
06763                         <a class="code" href="../../d4/d0/wslist_8c.html#a24">MiReleaseWsle</a> (Pfn1-&gt;u1.WsIndex, &amp;MmSystemCacheWs);
06764 
06765                         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a109">MI_SET_PTE_IN_WORKING_SET</a> (PointerPte, 0);
06766                     }
06767 
06768                     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
06769 
06770                     <a class="code" href="../../d4/d8/mi_8h.html#a190">MI_ZERO_WSINDEX</a> (Pfn1);
06771 
06772                     <span class="comment">//</span>
06773                     <span class="comment">// Adjust available pages as this page is now not in any</span>
06774                     <span class="comment">// working set, just like a non-paged pool page.</span>
06775                     <span class="comment">//</span>
06776     
06777                     <a class="code" href="../../d8/d5/kddata_8c.html#a42">MmResidentAvailablePages</a> -= 1;
06778                     <a class="code" href="../../d4/d8/mi_8h.html#a322">MM_BUMP_COUNTER</a>(29, 1);
06779                     <span class="keywordflow">if</span> (Pfn1-&gt;u3.e1.PrototypePte == 0) {
06780                         <a class="code" href="../../d6/d8/sysinfo_8c.html#a14">MmTotalSystemDriverPages</a> -= 1;
06781                     }
06782                 }
06783                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;u3.e2.ReferenceCount &gt; 1);
06784                 <a class="code" href="../../d4/d8/mi_8h.html#a189">MI_REMOVE_LOCKED_PAGE_CHARGE</a> (Pfn1, 37);
06785                 Pfn1-&gt;u3.e2.ReferenceCount -= 1;
06786             }
06787         }
06788 
06789         PointerPte += 1;
06790     } <span class="keywordflow">while</span> (PointerPte &lt;= LastPte);
06791 
06792     <span class="keywordflow">return</span>;
06793 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a80" doxytag="iosup.c::MiLookupDataTableEntry" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PLDR_DATA_TABLE_ENTRY MiLookupDataTableEntry           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>AddressWithinSection</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ResourceHeld</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l06991">6991</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
References <a class="el" href="../../d6/d7/ex_8h-source.html#l02474">ExAcquireResourceShared</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02393">ExReleaseResource</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01598">KeEnterCriticalRegion</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01628">KeLeaveCriticalRegion</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00582">PsLoadedModuleList</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00583">PsLoadedModuleResource</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/verifier_8c-source.html#l03846">MmAddVerifierThunks()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l06797">MmGetSectionRange()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l06864">MmLockPagableDataSection()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l02472">MmPageEntireDriver()</a>, and <a class="el" href="../../d9/d7/sysload_8c-source.html#l02560">MmResetDriverPaging()</a>.
<p>
<pre class="fragment"><div>06998                    :
06999 
07000     This <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a16">functions</a> locates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data table entry that maps <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified address.
07001 
07002 Arguments:
07003 
07004     AddressWithinSection - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of a function contained
07005                            within <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> desired module.
07006 
07007     ResourceHeld - Supplies <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> loaded module resource <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> already held,
07008                    <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <span class="keywordflow">if</span> not.
07009 
07010 Return Value:
07011 
07012     The address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> loaded module list data table entry that maps <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
07013     argument address.
07014 
07015 --*/
07016 
07017 {
07018     PLDR_DATA_TABLE_ENTRY DataTableEntry;
07019     PLDR_DATA_TABLE_ENTRY FoundEntry = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
07020     PLIST_ENTRY NextEntry;
07021 
07022     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
07023 
07024     <span class="comment">//</span>
07025     <span class="comment">// Search the loaded module list for the data table entry that describes</span>
07026     <span class="comment">// the DLL that was just unloaded. It is possible that an entry is not in</span>
07027     <span class="comment">// the list if a failure occurred at a point in loading the DLL just before</span>
07028     <span class="comment">// the data table entry was generated.</span>
07029     <span class="comment">//</span>
07030 
07031     <span class="keywordflow">if</span> (!ResourceHeld) {
07032         <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
07033         <a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a> (&amp;PsLoadedModuleResource, TRUE);
07034     }
07035 
07036     NextEntry = <a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>.Flink;
07037     <span class="keywordflow">do</span> {
07038 
07039         DataTableEntry = CONTAINING_RECORD(NextEntry,
07040                                            LDR_DATA_TABLE_ENTRY,
07041                                            InLoadOrderLinks);
07042 
07043         <span class="comment">//</span>
07044         <span class="comment">// Locate the loaded module that contains this address.</span>
07045         <span class="comment">//</span>
07046 
07047         <span class="keywordflow">if</span> ( AddressWithinSection &gt;= DataTableEntry-&gt;DllBase &amp;&amp;
07048              AddressWithinSection &lt; (PVOID)((PUCHAR)DataTableEntry-&gt;DllBase+DataTableEntry-&gt;SizeOfImage) ) {
07049 
07050             FoundEntry = DataTableEntry;
07051             <span class="keywordflow">break</span>;
07052         }
07053 
07054         NextEntry = NextEntry-&gt;Flink;
07055     } <span class="keywordflow">while</span> (NextEntry != &amp;<a class="code" href="../../d1/d9/ps_8h.html#a56">PsLoadedModuleList</a>);
07056 
07057     <span class="keywordflow">if</span> (!ResourceHeld) {
07058         <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a> (&amp;PsLoadedModuleResource);
07059         <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
07060     }
07061     <span class="keywordflow">return</span> FoundEntry;
07062 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a29" doxytag="iosup.c::MiMapLockedPagesInUserSpace" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PVOID MiMapLockedPagesInUserSpace           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d6/d7/struct__MDL.html">PMDL</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>MemoryDescriptorList</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>StartingVa</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d4/d9/ke_8h.html#a156">MEMORY_CACHING_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>CacheType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>BaseVa</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l02785">2785</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
References <a class="el" href="../../d2/d8/ps_8h-source.html#l00216">_EPROCESS::AddressSpaceDeleted</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00221">COMPUTE_PAGES_SPANNED</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02393">_MMVAD::ControlArea</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02385">_MMVAD::EndingVpn</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02429">_MI_PHYSICAL_VIEW::EndVa</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d1/d3/ex_2alpha_2raisests_8c-source.html#l00157">ExRaiseStatus()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02394">_MMVAD::FirstPrototypePte</a>, <a class="el" href="../../d1/d5/ppc_2flushtb_8c-source.html#l00033">KeFlushEntireTb()</a>, <a class="el" href="../../d1/d4/i386_2flush_8c-source.html#l00187">KeInvalidateAllCaches()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01093">LOCK_WS_AND_ADDRESS_SPACE</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00435">MDL_IO_SPACE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00861">MI_DISABLE_CACHING</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01355">MI_GET_USED_PTES_HANDLE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01359">MI_INCREMENT_USED_PTES_BY_HANDLE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02433">MI_PHYSICAL_VIEW_KEY</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00687">MI_SET_PTE_WRITE_COMBINE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00761">MI_VA_TO_VPN</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02459">MI_WRITE_VALID_PTE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00556">MiCheckForConflictingVad</a>, <a class="el" href="../../d7/d2/vadtree_8c-source.html#l00431">MiFindEmptyAddressRange()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01643">MiGetPdeAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d7/d2/vadtree_8c-source.html#l00030">MiInsertVad()</a>, <a class="el" href="../../d1/d1/mmsup_8c-source.html#l00624">MiMakePdeExistAndMakeValid()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l03591">MiMakePpeExistAndMakeValid</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l02583">MiPhysicalViewInserter()</a>, <a class="el" href="../../d7/d1/mm_2ia64_2initia64_8c-source.html#l02042">MiSweepCacheMachineDependent()</a>, <a class="el" href="../../d7/d7/mi386_8h-source.html#l00267">MiWriteCombiningPtes</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00107">MM_EMPTY_LIST</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00096">MM_HIGHEST_VAD_ADDRESS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00137">MM_READWRITE</a>, <a class="el" href="../../d4/d9/ke_8h.html#a413a249">MmCached</a>, <a class="el" href="../../d4/d9/ke_8h.html#a413a251">MmHardwareCoherentCached</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00044">MmHighestPhysicalPage</a>, <a class="el" href="../../d4/d9/ke_8h.html#a413a248">MmNonCached</a>, <a class="el" href="../../d4/d9/ke_8h.html#a413a252">MmNonCachedUnordered</a>, <a class="el" href="../../d4/d9/ke_8h.html#a413a250">MmWriteCombined</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02384">_MMVAD::StartingVpn</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02428">_MI_PHYSICAL_VIEW::StartVa</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d6/d6/struct__MMVAD.html#o7">_MMVAD::u</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o10">_MMPFN::u2</a>, <a class="el" href="../../d6/d6/struct__MMVAD.html#o19">_MMVAD::u4</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01097">UNLOCK_WS_AND_ADDRESS_SPACE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02427">_MI_PHYSICAL_VIEW::Vad</a>, <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00047">ValidUserPte</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l00094">X64K</a>.
<p>
Referenced by <a class="el" href="../../d6/d5/iosup_8c-source.html#l02058">MmMapLockedPagesSpecifyCache()</a>.
<p>
<pre class="fragment"><div>02794                    :
02795 
02796     This function maps physical pages described by a memory descriptor
02797     list into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user portion of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">virtual</span> address space.
02798 
02799 Arguments:
02800 
02801     MemoryDescriptorList - Supplies a valid Memory Descriptor <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a> which has
02802                            been updated by <a class="code" href="../../d2/d1/mm_8h.html#a273">MmProbeAndLockPages</a>.
02803 
02804 
02805     StartingVa - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> starting address.
02806 
02807     CacheType - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of cache mapping to use <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d6/d7/struct__MDL.html">MDL</a>.
02808                 <a class="code" href="../../d4/d9/ke_8h.html#a413a249">MmCached</a> indicates <span class="stringliteral">"normal"</span> user mappings.
02809 
02810     BaseVa - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> view. If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> initial
02811              value of <span class="keyword">this</span> argument <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not null, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> view will
02812              be allocated starting at <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified <span class="keyword">virtual</span>
02813              address rounded down to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> next 64kb address
02814              boundary. If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> initial value of <span class="keyword">this</span> argument <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
02815              null, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operating system will determine
02816              where to allocate <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> view.
02817 
02818 Return Value:
02819 
02820     Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base address where <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pages are mapped.  The base address
02821     has <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> same offset as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">virtual</span> address in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d6/d7/struct__MDL.html">MDL</a>.
02822 
02823     This routine will raise an exception <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> processor mode <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> USER_MODE
02824     and quota limits or VM limits are exceeded.
02825 
02826 Environment:
02827 
02828     Kernel mode.  <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a> or below.
02829 
02830 --*/
02831 
02832 {
02833     PFN_NUMBER NumberOfPages;
02834     PPFN_NUMBER Page;
02835     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
02836     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPde;
02837     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPpe;
02838     PCHAR Va;
02839     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
02840     PVOID EndingAddress;
02841     <a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a> Vad;
02842     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
02843     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn2;
02844     PVOID UsedPageTableHandle;
02845     <a class="code" href="../../d3/d9/struct__MI__PHYSICAL__VIEW.html">PMI_PHYSICAL_VIEW</a> PhysicalView;
02846 <span class="preprocessor">#if defined (_WIN64)</span>
02847 <span class="preprocessor"></span>    PVOID UsedPageDirectoryHandle;
02848 <span class="preprocessor">#endif</span>
02849 <span class="preprocessor"></span>
02850     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a> ();
02851     Page = (PPFN_NUMBER)(MemoryDescriptorList + 1);
02852     NumberOfPages = <a class="code" href="../../d2/d1/mm_8h.html#a9">COMPUTE_PAGES_SPANNED</a> (StartingVa,
02853                                            MemoryDescriptorList-&gt;ByteCount);
02854 
02855     <span class="keywordflow">if</span> (MemoryDescriptorList-&gt;MdlFlags &amp; <a class="code" href="../../d0/d9/ntosdef_8h.html#a23">MDL_IO_SPACE</a>) {
02856         <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a> (STATUS_INVALID_ADDRESS);
02857         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02858     }
02859 
02860     <span class="comment">//</span>
02861     <span class="comment">// Map the pages into the user part of the address as user</span>
02862     <span class="comment">// read/write no-delete.</span>
02863     <span class="comment">//</span>
02864 
02865     TempPte = <a class="code" href="../../d4/d2/datalpha_8c.html#a4">ValidUserPte</a>;
02866 
02867     <span class="keywordflow">switch</span> (CacheType) {
02868 
02869         <span class="keywordflow">case</span> <a class="code" href="../../d4/d9/ke_8h.html#a413a248">MmNonCached</a>:
02870             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a118">MI_DISABLE_CACHING</a> (TempPte);
02871             <span class="keywordflow">break</span>;
02872 
02873         <span class="keywordflow">case</span> <a class="code" href="../../d4/d9/ke_8h.html#a413a249">MmCached</a>:
02874             <span class="keywordflow">break</span>;
02875 
02876         <span class="keywordflow">case</span> <a class="code" href="../../d4/d9/ke_8h.html#a413a250">MmWriteCombined</a>:
02877             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a111">MI_SET_PTE_WRITE_COMBINE</a> (TempPte);
02878             <span class="keywordflow">break</span>;
02879 
02880         <span class="keywordflow">case</span> <a class="code" href="../../d4/d9/ke_8h.html#a413a251">MmHardwareCoherentCached</a>:
02881             <span class="keywordflow">break</span>;
02882 
02883 <span class="preprocessor">#if 0</span>
02884 <span class="preprocessor"></span>        <span class="keywordflow">case</span> <a class="code" href="../../d4/d9/ke_8h.html#a413a252">MmNonCachedUnordered</a>:
02885             <span class="keywordflow">break</span>;
02886 <span class="preprocessor">#endif</span>
02887 <span class="preprocessor"></span>
02888         <span class="keywordflow">default</span>:
02889             <span class="keywordflow">break</span>;
02890     }
02891 
02892     Process = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a> ();
02893 
02894     <span class="comment">//</span>
02895     <span class="comment">// Make sure the specified starting and ending addresses are</span>
02896     <span class="comment">// within the user part of the virtual address space.</span>
02897     <span class="comment">//</span>
02898 
02899     <span class="keywordflow">if</span> (BaseVa != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02900 
02901         <span class="keywordflow">if</span> ((ULONG_PTR)BaseVa &amp; (<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1)) {
02902 
02903             <span class="comment">//</span>
02904             <span class="comment">// Invalid base address.</span>
02905             <span class="comment">//</span>
02906 
02907             <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a> (STATUS_INVALID_ADDRESS);
02908             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02909         }
02910 
02911         EndingAddress = (PVOID)((PCHAR)BaseVa + ((ULONG_PTR)NumberOfPages * <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>) - 1);
02912 
02913         <span class="keywordflow">if</span> (EndingAddress &lt;= BaseVa) {
02914 
02915             <span class="comment">//</span>
02916             <span class="comment">// Invalid region size.</span>
02917             <span class="comment">//</span>
02918 
02919             <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a> (STATUS_INVALID_ADDRESS);
02920             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02921         }
02922 
02923         <span class="keywordflow">if</span> (EndingAddress &gt; <a class="code" href="../../d4/d8/mi_8h.html#a19">MM_HIGHEST_VAD_ADDRESS</a>) {
02924 
02925             <span class="comment">//</span>
02926             <span class="comment">// Invalid region size.</span>
02927             <span class="comment">//</span>
02928 
02929             <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a> (STATUS_INVALID_ADDRESS);
02930             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02931         }
02932 
02933         <a class="code" href="../../d4/d8/mi_8h.html#a161">LOCK_WS_AND_ADDRESS_SPACE</a> (Process);
02934 
02935         <span class="comment">//</span>
02936         <span class="comment">// Make sure the address space was not deleted, if so, return an error.</span>
02937         <span class="comment">//</span>
02938 
02939         <span class="keywordflow">if</span> (Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o27">AddressSpaceDeleted</a> != 0) {
02940             <a class="code" href="../../d4/d8/mi_8h.html#a162">UNLOCK_WS_AND_ADDRESS_SPACE</a> (Process);
02941             <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a> (STATUS_PROCESS_IS_TERMINATING);
02942             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02943         }
02944 
02945         Vad = <a class="code" href="../../d4/d8/mi_8h.html#a98">MiCheckForConflictingVad</a> (BaseVa, EndingAddress);
02946 
02947         <span class="comment">//</span>
02948         <span class="comment">// Make sure the address space is not already in use.</span>
02949         <span class="comment">//</span>
02950 
02951         <span class="keywordflow">if</span> (Vad != (<a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02952             <a class="code" href="../../d4/d8/mi_8h.html#a162">UNLOCK_WS_AND_ADDRESS_SPACE</a> (Process);
02953             <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a> (STATUS_CONFLICTING_ADDRESSES);
02954             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02955         }
02956     }
02957     <span class="keywordflow">else</span> {
02958 
02959         <span class="comment">//</span>
02960         <span class="comment">// Get the working set mutex and address creation mutex.</span>
02961         <span class="comment">//</span>
02962 
02963         <a class="code" href="../../d4/d8/mi_8h.html#a161">LOCK_WS_AND_ADDRESS_SPACE</a> (Process);
02964 
02965         <span class="comment">//</span>
02966         <span class="comment">// Make sure the address space was not deleted, if so, return an error.</span>
02967         <span class="comment">//</span>
02968 
02969         <span class="keywordflow">if</span> (Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o27">AddressSpaceDeleted</a> != 0) {
02970             <a class="code" href="../../d4/d8/mi_8h.html#a162">UNLOCK_WS_AND_ADDRESS_SPACE</a> (Process);
02971             <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a> (STATUS_PROCESS_IS_TERMINATING);
02972             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02973         }
02974 
02975         <span class="keywordflow">try</span> {
02976 
02977             BaseVa = <a class="code" href="../../d6/d3/vadtree_8c.html#a3">MiFindEmptyAddressRange</a> ( (ULONG_PTR)NumberOfPages * PAGE_SIZE,
02978                                                 X64K,
02979                                                 0 );
02980 
02981             EndingAddress = (PVOID)((PCHAR)BaseVa + ((ULONG_PTR)NumberOfPages * <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>) - 1);
02982 
02983         } except (EXCEPTION_EXECUTE_HANDLER) {
02984             BaseVa = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02985             <span class="keywordflow">goto</span> Done;
02986         }
02987     }
02988 
02989     PhysicalView = (<a class="code" href="../../d3/d9/struct__MI__PHYSICAL__VIEW.html">PMI_PHYSICAL_VIEW</a>)<a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (NonPagedPool,
02990                                                              <span class="keyword">sizeof</span>(<a class="code" href="../../d3/d9/struct__MI__PHYSICAL__VIEW.html">MI_PHYSICAL_VIEW</a>),
02991                                                              MI_PHYSICAL_VIEW_KEY);
02992     <span class="keywordflow">if</span> (PhysicalView == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02993         BaseVa = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02994         <span class="keywordflow">goto</span> Done;
02995     }
02996 
02997     Vad = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (NonPagedPool, <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d6/struct__MMVAD.html">MMVAD</a>), ' daV');
02998 
02999     <span class="keywordflow">if</span> (Vad == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03000         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (PhysicalView);
03001         BaseVa = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03002         <span class="keywordflow">goto</span> Done;
03003     }
03004 
03005     PhysicalView-&gt;<a class="code" href="../../d3/d9/struct__MI__PHYSICAL__VIEW.html#o1">Vad</a> = Vad;
03006     PhysicalView-&gt;<a class="code" href="../../d3/d9/struct__MI__PHYSICAL__VIEW.html#o2">StartVa</a> = BaseVa;
03007     PhysicalView-&gt;<a class="code" href="../../d3/d9/struct__MI__PHYSICAL__VIEW.html#o3">EndVa</a> = EndingAddress;
03008 
03009     Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o0">StartingVpn</a> = <a class="code" href="../../d4/d8/mi_8h.html#a107">MI_VA_TO_VPN</a> (BaseVa);
03010     Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o1">EndingVpn</a> = <a class="code" href="../../d4/d8/mi_8h.html#a107">MI_VA_TO_VPN</a> (EndingAddress);
03011     Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o8">ControlArea</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03012     Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o9">FirstPrototypePte</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03013     Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.LongFlags = 0;
03014     Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.Protection = <a class="code" href="../../d4/d8/mi_8h.html#a39">MM_READWRITE</a>;
03015     Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.PhysicalMapping = 1;
03016     Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.PrivateMemory = 1;
03017     Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o19">u4</a>.Banked = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03018 
03019     <span class="keywordflow">try</span> {
03020 
03021         <a class="code" href="../../d6/d3/vadtree_8c.html#a0">MiInsertVad</a> (Vad);
03022 
03023     } except (EXCEPTION_EXECUTE_HANDLER) {
03024         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (PhysicalView);
03025         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (Vad);
03026         BaseVa = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03027         <span class="keywordflow">goto</span> Done;
03028     }
03029 
03030     <a class="code" href="../../d5/d6/iosup_8c.html#a53">MiPhysicalViewInserter</a> (Process, PhysicalView);
03031 
03032 <span class="preprocessor">#if defined(_IA64_)</span>
03033 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (CacheType != <a class="code" href="../../d4/d9/ke_8h.html#a413a249">MmCached</a>) {
03034         <a class="code" href="../../d0/d6/ppc_2flushtb_8c.html#a0">KeFlushEntireTb</a>(FALSE, TRUE);
03035     }
03036 <span class="preprocessor">#endif</span>
03037 <span class="preprocessor"></span>
03038     <span class="comment">//</span>
03039     <span class="comment">// Create a page table and fill in the mappings for the Vad.</span>
03040     <span class="comment">//</span>
03041 
03042     Va = BaseVa;
03043     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (BaseVa);
03044 
03045     <span class="keywordflow">do</span> {
03046 
03047         <span class="keywordflow">if</span> (*Page == <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>) {
03048             <span class="keywordflow">break</span>;
03049         }
03050 
03051         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (*Page &lt;= MmHighestPhysicalPage);
03052 
03053         PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (PointerPte);
03054         PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (PointerPte);
03055 
03056 <span class="preprocessor">#if defined (_WIN64)</span>
03057 <span class="preprocessor"></span>        <a class="code" href="../../d4/d8/mi_8h.html#a245">MiMakePpeExistAndMakeValid</a> (PointerPpe, Process, FALSE);
03058         <span class="keywordflow">if</span> (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == 0) {
03059             UsedPageDirectoryHandle = <a class="code" href="../../d4/d8/mi_8h.html#a180">MI_GET_USED_PTES_HANDLE</a> (PointerPte);
03060             <a class="code" href="../../d4/d8/mi_8h.html#a182">MI_INCREMENT_USED_PTES_BY_HANDLE</a> (UsedPageDirectoryHandle);
03061         }
03062 <span class="preprocessor">#endif</span>
03063 <span class="preprocessor"></span>
03064         <a class="code" href="../../d0/d2/mmsup_8c.html#a7">MiMakePdeExistAndMakeValid</a>(PointerPde, Process, FALSE);
03065 
03066         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0);
03067         TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber = *Page;
03068         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a> (PointerPte, TempPte);
03069 
03070         <span class="comment">//</span>
03071         <span class="comment">// A PTE just went from not present, not transition to</span>
03072         <span class="comment">// present.  The share count and valid count must be</span>
03073         <span class="comment">// updated in the page table page which contains this</span>
03074         <span class="comment">// PTE.</span>
03075         <span class="comment">//</span>
03076 
03077         Pfn2 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber);
03078         Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount += 1;
03079 
03080         <span class="comment">//</span>
03081         <span class="comment">// Another zeroed PTE has become non-zero.</span>
03082         <span class="comment">//</span>
03083 
03084         UsedPageTableHandle = <a class="code" href="../../d4/d8/mi_8h.html#a180">MI_GET_USED_PTES_HANDLE</a> (Va);
03085 
03086         <a class="code" href="../../d4/d8/mi_8h.html#a182">MI_INCREMENT_USED_PTES_BY_HANDLE</a> (UsedPageTableHandle);
03087 
03088         Page += 1;
03089         PointerPte += 1;
03090         NumberOfPages -= 1;
03091         Va += <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
03092     } <span class="keywordflow">while</span> (NumberOfPages != 0);
03093 
03094 <span class="preprocessor">#if defined(_IA64_)</span>
03095 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (CacheType != <a class="code" href="../../d4/d9/ke_8h.html#a413a249">MmCached</a>) {
03096         <a class="code" href="../../d2/d9/miia64_8h.html#a318">MiSweepCacheMachineDependent</a> (BaseVa, MemoryDescriptorList-&gt;ByteCount, CacheType);
03097     }
03098 <span class="preprocessor">#endif</span>
03099 <span class="preprocessor"></span>
03100 Done:
03101     <a class="code" href="../../d4/d8/mi_8h.html#a162">UNLOCK_WS_AND_ADDRESS_SPACE</a> (Process);
03102     <span class="keywordflow">if</span> (BaseVa == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03103         <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a> (STATUS_INSUFFICIENT_RESOURCES);
03104         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03105     }
03106 
03107 <span class="preprocessor">#if defined(i386)</span>
03108 <span class="preprocessor"></span>    <span class="comment">//</span>
03109     <span class="comment">// If write combined was specified then flush all caches and TBs.</span>
03110     <span class="comment">//</span>
03111 
03112     <span class="keywordflow">if</span> (CacheType == <a class="code" href="../../d4/d9/ke_8h.html#a413a250">MmWriteCombined</a> &amp;&amp; <a class="code" href="../../d6/d8/mi386_8h.html#a204">MiWriteCombiningPtes</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
03113         <a class="code" href="../../d0/d6/ppc_2flushtb_8c.html#a0">KeFlushEntireTb</a> (FALSE, TRUE);
03114         <a class="code" href="../../d0/d5/i386_2flush_8c.html#a2">KeInvalidateAllCaches</a> (TRUE);
03115     }
03116 <span class="preprocessor">#endif</span>
03117 <span class="preprocessor"></span>
03118     BaseVa = (PVOID)((PCHAR)BaseVa + MemoryDescriptorList-&gt;ByteOffset);
03119 
03120     <span class="keywordflow">return</span> BaseVa;
03121 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a51" doxytag="iosup.c::MiMapSinglePage" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PVOID MiMapSinglePage           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID VirtualAddress&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PFN_NUMBER&nbsp;</td>
          <td class="mdname" nowrap> <em>PageFrameIndex</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d4/d9/ke_8h.html#a156">MEMORY_CACHING_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>CacheType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d1/mm_8h.html#a154">MM_PAGE_PRIORITY</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Priority</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l02395">2395</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d1/mm_8h.html#a347a183">HighPagePriority</a>, <a class="el" href="../../d1/d5/ppc_2flushtb_8c-source.html#l00033">KeFlushEntireTb()</a>, <a class="el" href="../../d1/d5/ppc_2flushtb_8c-source.html#l00188">KeFlushSingleTb()</a>, <a class="el" href="../../d1/d4/i386_2flush_8c-source.html#l00187">KeInvalidateAllCaches()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00861">MI_DISABLE_CACHING</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02262">MI_IS_PHYSICAL_ADDRESS</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00687">MI_SET_PTE_WRITE_COMBINE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02486">MI_WRITE_INVALID_PTE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02459">MI_WRITE_VALID_PTE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l02030">MiGetSystemPteAvailability()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01842">MiGetVirtualAddressMappedByPte</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l00524">MiReserveSystemPtes()</a>, <a class="el" href="../../d7/d1/mm_2ia64_2initia64_8c-source.html#l02042">MiSweepCacheMachineDependent()</a>, <a class="el" href="../../d7/d7/mi386_8h-source.html#l00267">MiWriteCombiningPtes</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00321">MM_COLOR_ALIGNMENT</a>, <a class="el" href="../../d4/d9/ke_8h.html#a413a249">MmCached</a>, <a class="el" href="../../d4/d9/ke_8h.html#a413a251">MmHardwareCoherentCached</a>, <a class="el" href="../../d4/d9/ke_8h.html#a413a248">MmNonCached</a>, <a class="el" href="../../d4/d9/ke_8h.html#a413a252">MmNonCachedUnordered</a>, <a class="el" href="../../d4/d9/ke_8h.html#a413a250">MmWriteCombined</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d4/d8/mi_8h.html#a1003a769">SystemPteSpace</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00038">ValidKernelPte</a>, and <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00030">ZeroPte</a>.
<p>
Referenced by <a class="el" href="../../d9/d5/forksup_8c-source.html#l00100">MiCloneProcessAddressSpace()</a>.
<p>
<pre class="fragment"><div>02404                    :
02405 
02406     This function (re)maps a single system PTE to the specified physical page.
02407 
02408 Arguments:
02409 
02410     VirtualAddress - Supplies the virtual address to map the page frame at.
02411                      NULL indicates a system PTE is needed.  Non-NULL supplies
02412                      the virtual address returned by an earlier
02413                      MiMapSinglePage call.
02414 
02415     PageFrameIndex - Supplies the page frame index to map.
02416 
02417     CacheType - Supplies the type of cache mapping to use for the <a class="code" href="../../d6/d7/struct__MDL.html">MDL</a>.
02418                 MmCached indicates "normal" kernel or user mappings.
02419 
02420     Priority - Supplies an indication as to how important it is that this
02421                request succeed under low available PTE conditions.
02422 
02423 Return Value:
02424 
02425     Returns the base address where the page is mapped, or NULL if it the
02426     mapping failed.
02427 
02428 Environment:
02429 
02430     Kernel mode.  APC_LEVEL or below.
02431 
02432 --*/
02433 
02434 {
02435     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
02436     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
02437 
02438     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a> ();
02439 
02440     <span class="keywordflow">if</span> (VirtualAddress == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02441 
02442         <span class="comment">//</span>
02443         <span class="comment">// Make sure there are enough PTEs of the requested size.</span>
02444         <span class="comment">//</span>
02445     
02446         <span class="keywordflow">if</span> ((Priority != <a class="code" href="../../d2/d1/mm_8h.html#a347a183">HighPagePriority</a>) &amp;&amp;
02447             (<a class="code" href="../../d0/d9/sysptes_8c.html#a29">MiGetSystemPteAvailability</a> (1, Priority) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
02448                 <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02449         }
02450 
02451         PointerPte = <a class="code" href="../../d0/d9/sysptes_8c.html#a25">MiReserveSystemPtes</a> (1,
02452                                           SystemPteSpace,
02453                                           MM_COLOR_ALIGNMENT,
02454                                           0,
02455                                           0);
02456 
02457         <span class="keywordflow">if</span> (PointerPte == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02458     
02459             <span class="comment">//</span>
02460             <span class="comment">// Not enough system PTES are available.</span>
02461             <span class="comment">//</span>
02462     
02463             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02464         }
02465 
02466         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0);
02467         VirtualAddress = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPte);
02468     }
02469     <span class="keywordflow">else</span> {
02470         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (MI_IS_PHYSICAL_ADDRESS (VirtualAddress) == 0);
02471         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (VirtualAddress &gt;= MM_SYSTEM_RANGE_START);
02472 
02473         PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (VirtualAddress);
02474         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1);
02475 
02476         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a187">MI_WRITE_INVALID_PTE</a> (PointerPte, ZeroPte);
02477 
02478         <a class="code" href="../../d0/d6/ppc_2flushtb_8c.html#a2">KeFlushSingleTb</a> (VirtualAddress,
02479                          TRUE,
02480                          TRUE,
02481                          (PHARDWARE_PTE)PointerPte,
02482                          <a class="code" href="../../d4/d2/datalpha_8c.html#a0">ZeroPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Flush);
02483     }
02484 
02485     TempPte = <a class="code" href="../../d4/d2/datalpha_8c.html#a2">ValidKernelPte</a>;
02486 
02487     <span class="keywordflow">switch</span> (CacheType) {
02488 
02489         <span class="keywordflow">case</span> <a class="code" href="../../d4/d9/ke_8h.html#a413a248">MmNonCached</a>:
02490             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a118">MI_DISABLE_CACHING</a> (TempPte);
02491             <span class="keywordflow">break</span>;
02492 
02493         <span class="keywordflow">case</span> <a class="code" href="../../d4/d9/ke_8h.html#a413a249">MmCached</a>:
02494             <span class="keywordflow">break</span>;
02495 
02496         <span class="keywordflow">case</span> <a class="code" href="../../d4/d9/ke_8h.html#a413a250">MmWriteCombined</a>:
02497             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a111">MI_SET_PTE_WRITE_COMBINE</a> (TempPte);
02498             <span class="keywordflow">break</span>;
02499 
02500         <span class="keywordflow">case</span> <a class="code" href="../../d4/d9/ke_8h.html#a413a251">MmHardwareCoherentCached</a>:
02501             <span class="keywordflow">break</span>;
02502 
02503 <span class="preprocessor">#if 0</span>
02504 <span class="preprocessor"></span>        <span class="keywordflow">case</span> <a class="code" href="../../d4/d9/ke_8h.html#a413a252">MmNonCachedUnordered</a>:
02505             <span class="keywordflow">break</span>;
02506 <span class="preprocessor">#endif</span>
02507 <span class="preprocessor"></span>
02508         <span class="keywordflow">default</span>:
02509             <span class="keywordflow">break</span>;
02510     }
02511 
02512 <span class="preprocessor">#if defined(_IA64_)</span>
02513 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (CacheType != <a class="code" href="../../d4/d9/ke_8h.html#a413a249">MmCached</a>) {
02514         <a class="code" href="../../d0/d6/ppc_2flushtb_8c.html#a0">KeFlushEntireTb</a>(FALSE, TRUE);
02515     }
02516 <span class="preprocessor">#endif</span>
02517 <span class="preprocessor"></span>
02518     TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber = PageFrameIndex;
02519 
02520     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a> (PointerPte, TempPte);
02521 
02522 <span class="preprocessor">#if defined(i386)</span>
02523 <span class="preprocessor"></span>    <span class="comment">//</span>
02524     <span class="comment">// If write combined was specified then flush all caches and TBs.</span>
02525     <span class="comment">//</span>
02526 
02527     <span class="keywordflow">if</span> (CacheType == <a class="code" href="../../d4/d9/ke_8h.html#a413a250">MmWriteCombined</a> &amp;&amp; <a class="code" href="../../d6/d8/mi386_8h.html#a204">MiWriteCombiningPtes</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
02528         <a class="code" href="../../d0/d6/ppc_2flushtb_8c.html#a0">KeFlushEntireTb</a> (FALSE, TRUE);
02529         <a class="code" href="../../d0/d5/i386_2flush_8c.html#a2">KeInvalidateAllCaches</a> (TRUE);
02530     }
02531 <span class="preprocessor">#endif</span>
02532 <span class="preprocessor"></span>
02533 <span class="preprocessor">#if defined(_IA64_)</span>
02534 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (CacheType != <a class="code" href="../../d4/d9/ke_8h.html#a413a249">MmCached</a>) {
02535         <a class="code" href="../../d2/d9/miia64_8h.html#a318">MiSweepCacheMachineDependent</a>(VirtualAddress, PAGE_SIZE, CacheType);
02536     }
02537 <span class="preprocessor">#endif</span>
02538 <span class="preprocessor"></span>
02539     <span class="keywordflow">return</span> VirtualAddress;
02540 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a55" doxytag="iosup.c::MiPhysicalViewAdjuster" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MiPhysicalViewAdjuster           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Process</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>OldVad</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>NewVad</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l02721">2721</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00922">LOCK_AWE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00901">LOCK_PFN2</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00925">UNLOCK_AWE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00905">UNLOCK_PFN2</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l02427">_MI_PHYSICAL_VIEW::Vad</a>.
<p>
Referenced by <a class="el" href="../../d4/d4/mapview_8c-source.html#l04177">MmSecureVirtualMemory()</a>.
<p>
<pre class="fragment"><div>02729                    :
02730 
02731     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a nonpaged wrapper which acquires <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PFN lock to repoint
02732     a physical VAD in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process chain.
02733 
02734 Arguments:
02735 
02736     Process - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process in which to adjust <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> physical VAD.
02737 
02738     Vad - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> old Vad to replace.
02739 
02740     NewVad - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> newVad to substitute.
02741 
02742 Return Value:
02743 
02744     None.
02745 
02746 Environment:
02747 
02748     Kernel mode, called with APCs disabled, working set mutex held.
02749 
02750 --*/
02751 {
02752     KIRQL OldIrql;
02753     KIRQL OldIrql2;
02754     PLIST_ENTRY NextEntry;
02755     <a class="code" href="../../d3/d9/struct__MI__PHYSICAL__VIEW.html">PMI_PHYSICAL_VIEW</a> PhysicalView;
02756 
02757     <a class="code" href="../../d4/d8/mi_8h.html#a133">LOCK_AWE</a> (Process, OldIrql);
02758 
02759     <a class="code" href="../../d4/d8/mi_8h.html#a130">LOCK_PFN2</a> (OldIrql2);
02760 
02761     NextEntry = Process-&gt;PhysicalVadList.Flink;
02762     <span class="keywordflow">while</span> (NextEntry != &amp;Process-&gt;PhysicalVadList) {
02763 
02764         PhysicalView = CONTAINING_RECORD(NextEntry,
02765                                          <a class="code" href="../../d3/d9/struct__MI__PHYSICAL__VIEW.html">MI_PHYSICAL_VIEW</a>,
02766                                          ListEntry);
02767 
02768         <span class="keywordflow">if</span> (PhysicalView-&gt;<a class="code" href="../../d3/d9/struct__MI__PHYSICAL__VIEW.html#o1">Vad</a> == OldVad) {
02769             PhysicalView-&gt;<a class="code" href="../../d3/d9/struct__MI__PHYSICAL__VIEW.html#o1">Vad</a> = NewVad;
02770             <a class="code" href="../../d4/d8/mi_8h.html#a131">UNLOCK_PFN2</a> (OldIrql2);
02771             <a class="code" href="../../d4/d8/mi_8h.html#a134">UNLOCK_AWE</a> (Process, OldIrql);
02772             <span class="keywordflow">return</span>;
02773         }
02774 
02775         NextEntry = NextEntry-&gt;Flink;
02776     }
02777 
02778     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (FALSE);
02779 
02780     <a class="code" href="../../d4/d8/mi_8h.html#a131">UNLOCK_PFN2</a> (OldIrql2);
02781     <a class="code" href="../../d4/d8/mi_8h.html#a134">UNLOCK_AWE</a> (Process, OldIrql);
02782 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a53" doxytag="iosup.c::MiPhysicalViewInserter" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MiPhysicalViewInserter           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Process</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d3/d9/struct__MI__PHYSICAL__VIEW.html">PMI_PHYSICAL_VIEW</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PhysicalView</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l02583">2583</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
References <a class="el" href="../../d5/d7/mi_8h-source.html#l00922">LOCK_AWE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00901">LOCK_PFN2</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02440">MiActiveWriteWatch</a>, <a class="el" href="../../d4/d8/mi_8h.html#a773">MiMarkProcessAsWriteWatch()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00925">UNLOCK_AWE</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l00905">UNLOCK_PFN2</a>.
<p>
Referenced by <a class="el" href="../../d6/d5/iosup_8c-source.html#l02785">MiMapLockedPagesInUserSpace()</a>, and <a class="el" href="../../d4/d5/allocvm_8c-source.html#l00075">NtAllocateVirtualMemory()</a>.
<p>
<pre class="fragment"><div>02590                    :
02591 
02592     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a nonpaged wrapper which acquires <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PFN lock to insert
02593     a physical VAD into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process chain.
02594 
02595 Arguments:
02596 
02597     Process - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process to add <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> physical VAD to.
02598 
02599     PhysicalView - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> physical view data to link in.
02600 
02601 Return Value:
02602 
02603     None.
02604 
02605 Environment:
02606 
02607     Kernel mode.  <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>, working set and address space mutexes held.
02608 
02609 --*/
02610 {
02611     KIRQL OldIrql;
02612     KIRQL OldIrql2;
02613 
02614     <a class="code" href="../../d4/d8/mi_8h.html#a133">LOCK_AWE</a> (Process, OldIrql);
02615 
02616     <a class="code" href="../../d4/d8/mi_8h.html#a130">LOCK_PFN2</a> (OldIrql2);
02617 
02618     InsertHeadList (&amp;Process-&gt;PhysicalVadList, &amp;PhysicalView-&gt;ListEntry);
02619 
02620     <span class="keywordflow">if</span> (PhysicalView-&gt;Vad-&gt;u.VadFlags.WriteWatch == 1) {
02621         <a class="code" href="../../d4/d8/mi_8h.html#a495">MiActiveWriteWatch</a> += 1;
02622     }
02623 
02624     <a class="code" href="../../d4/d8/mi_8h.html#a131">UNLOCK_PFN2</a> (OldIrql2);
02625 
02626     <a class="code" href="../../d4/d8/mi_8h.html#a134">UNLOCK_AWE</a> (Process, OldIrql);
02627 
02628     <span class="keywordflow">if</span> (PhysicalView-&gt;Vad-&gt;u.VadFlags.WriteWatch == 1) {
02629 
02630         <span class="comment">//</span>
02631         <span class="comment">// Mark this process as forever containing write-watch</span>
02632         <span class="comment">// address space(s).</span>
02633 
02634         <span class="keywordflow">if</span> (Process-&gt;Vm.u.Flags.WriteWatch == 0) {
02635             <a class="code" href="../../d4/d8/mi_8h.html#a773">MiMarkProcessAsWriteWatch</a> (Process);
02636         }
02637     }
02638 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a54" doxytag="iosup.c::MiPhysicalViewRemover" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MiPhysicalViewRemover           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Process</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Vad</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l02641">2641</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d9/d8/tbitmap_8c-source.html#l00028">BitMap</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02430">_MI_PHYSICAL_VIEW::BitMap</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00922">LOCK_AWE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00901">LOCK_PFN2</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02440">MiActiveWriteWatch</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d1/psquota_8c-source.html#l00356">PsReturnPoolQuota()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00925">UNLOCK_AWE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00905">UNLOCK_PFN2</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l02427">_MI_PHYSICAL_VIEW::Vad</a>.
<p>
Referenced by <a class="el" href="../../d6/d5/iosup_8c-source.html#l03253">MiUnmapLockedPagesInUserSpace()</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l01695">MmCleanProcessAddressSpace()</a>, and <a class="el" href="../../d4/d6/freevm_8c-source.html#l00066">NtFreeVirtualMemory()</a>.
<p>
<pre class="fragment"><div>02648                    :
02649 
02650     This function <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a nonpaged wrapper which acquires <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PFN lock to remove
02651     a physical VAD from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process chain.
02652 
02653 Arguments:
02654 
02655     Process - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process to remove <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> physical VAD from.
02656 
02657     Vad - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Vad to remove.
02658 
02659 Return Value:
02660 
02661     None.
02662 
02663 Environment:
02664 
02665     Kernel mode, <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>, working set and address space mutexes held.
02666 
02667 --*/
02668 {
02669     KIRQL OldIrql;
02670     KIRQL OldIrql2;
02671     PRTL_BITMAP <a class="code" href="../../d2/d1/structBitMap.html">BitMap</a>;
02672     PLIST_ENTRY NextEntry;
02673     <a class="code" href="../../d3/d9/struct__MI__PHYSICAL__VIEW.html">PMI_PHYSICAL_VIEW</a> PhysicalView;
02674     ULONG BitMapSize;
02675 
02676     <a class="code" href="../../d8/d9/tbitmap_8c.html#a2">BitMap</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02677 
02678     <a class="code" href="../../d4/d8/mi_8h.html#a133">LOCK_AWE</a> (Process, OldIrql);
02679 
02680     <a class="code" href="../../d4/d8/mi_8h.html#a130">LOCK_PFN2</a> (OldIrql2);
02681 
02682     NextEntry = Process-&gt;PhysicalVadList.Flink;
02683     <span class="keywordflow">while</span> (NextEntry != &amp;Process-&gt;PhysicalVadList) {
02684 
02685         PhysicalView = CONTAINING_RECORD(NextEntry,
02686                                          <a class="code" href="../../d3/d9/struct__MI__PHYSICAL__VIEW.html">MI_PHYSICAL_VIEW</a>,
02687                                          ListEntry);
02688 
02689         <span class="keywordflow">if</span> (PhysicalView-&gt;<a class="code" href="../../d3/d9/struct__MI__PHYSICAL__VIEW.html#o1">Vad</a> == Vad) {
02690             RemoveEntryList (NextEntry);
02691 
02692             <span class="keywordflow">if</span> (Vad-&gt;u.VadFlags.WriteWatch == 1) {
02693                 <a class="code" href="../../d4/d8/mi_8h.html#a495">MiActiveWriteWatch</a> -= 1;
02694                 <a class="code" href="../../d8/d9/tbitmap_8c.html#a2">BitMap</a> = PhysicalView-&gt;<a class="code" href="../../d3/d9/struct__MI__PHYSICAL__VIEW.html#o4">BitMap</a>;
02695                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (BitMap != NULL);
02696             }
02697 
02698             <a class="code" href="../../d4/d8/mi_8h.html#a131">UNLOCK_PFN2</a> (OldIrql2);
02699             <a class="code" href="../../d4/d8/mi_8h.html#a134">UNLOCK_AWE</a> (Process, OldIrql);
02700             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (PhysicalView);
02701 
02702             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d9/tbitmap_8c.html#a2">BitMap</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02703                 BitMapSize = <span class="keyword">sizeof</span>(RTL_BITMAP) + (ULONG)(((<a class="code" href="../../d8/d9/tbitmap_8c.html#a2">BitMap</a>-&gt;SizeOfBitMap + 31) / 32) * 4);
02704                 <a class="code" href="../../d0/d2/psquota_8c.html#a3">PsReturnPoolQuota</a> (Process, NonPagedPool, BitMapSize);
02705                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (BitMap);
02706             }
02707 
02708             <span class="keywordflow">return</span>;
02709         }
02710 
02711         NextEntry = NextEntry-&gt;Flink;
02712     }
02713 
02714     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (FALSE);
02715 
02716     <a class="code" href="../../d4/d8/mi_8h.html#a131">UNLOCK_PFN2</a> (OldIrql2);
02717     <a class="code" href="../../d4/d8/mi_8h.html#a134">UNLOCK_AWE</a> (Process, OldIrql);
02718 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a37" doxytag="iosup.c::MiProtectFreeNonPagedPool" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MiProtectFreeNonPagedPool           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>VirtualAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>SizeInPages</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d5/allocpag_8c-source.html#l00150">150</a> of file <a class="el" href="../../d2/d5/allocpag_8c-source.html">allocpag.c</a>.
<p>
References <a class="el" href="../../d1/d5/ppc_2flushtb_8c-source.html#l00188">KeFlushSingleTb()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02262">MI_IS_PHYSICAL_ADDRESS</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>.
<p>
Referenced by <a class="el" href="../../d2/d5/allocpag_8c-source.html#l00807">MiAllocatePoolPages()</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l04569">MiFindContiguousMemory()</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l01778">MiFreePoolPages()</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l00282">MiProtectedPoolInsertList()</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l00365">MiProtectedPoolRemoveEntryList()</a>, and <a class="el" href="../../d6/d5/iosup_8c-source.html#l08083">MmSetKernelDumpRange()</a>.
<p>
<pre class="fragment"><div>00157                    :
00158 
00159     This function protects freed nonpaged <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a>.
00160 
00161 Arguments:
00162 
00163     VirtualAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> freed <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> address to protect.
00164 
00165     SizeInPages - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> request in pages.
00166 
00167 Return Value:
00168 
00169     None.
00170 
00171 Environment:
00172 
00173     Kernel mode.
00174 
00175 --*/
00176 
00177 {
00178     ULONG i;
00179     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> PteContents;
00180     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
00181 
00182     <span class="comment">//</span>
00183     <span class="comment">// Prevent anyone from touching the free non paged pool</span>
00184     <span class="comment">//</span>
00185 
00186     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a178">MI_IS_PHYSICAL_ADDRESS</a>(VirtualAddress) == 0) {
00187         PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (VirtualAddress);
00188 
00189         <span class="keywordflow">for</span> (i = 0; i &lt; SizeInPages; i += 1) {
00190 
00191             PteContents = *PointerPte;
00192 
00193             PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid = 0;
00194             PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype = 1;
00195     
00196             <a class="code" href="../../d0/d6/ppc_2flushtb_8c.html#a2">KeFlushSingleTb</a> (VirtualAddress,
00197                              TRUE,
00198                              TRUE,
00199                              (PHARDWARE_PTE)PointerPte,
00200                              PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Flush);
00201             VirtualAddress = (PVOID)((PCHAR)VirtualAddress + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
00202             PointerPte += 1;
00203         }
00204     }
00205 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a35" doxytag="iosup.c::MiReleaseDeadPteTrackers" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MiReleaseDeadPteTrackers           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l01859">1859</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00087">DISPATCH_LEVEL</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l00095">MiDeadPteTrackerListHead</a>, and <a class="el" href="../../d6/d5/iosup_8c-source.html#l00096">MiPteTrackerLock</a>.
<p>
Referenced by <a class="el" href="../../d6/d5/iosup_8c-source.html#l03415">MmMapIoSpace()</a>, and <a class="el" href="../../d6/d5/iosup_8c-source.html#l02058">MmMapLockedPagesSpecifyCache()</a>.
<p>
<pre class="fragment"><div>01864                    :
01865 
01866     This routine removes tracking blocks from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> dead PTE list and frees
01867     them to <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a>.
01868 
01869 Arguments:
01870 
01871     None.
01872 
01873 Return Value:
01874 
01875     None.
01876 
01877 Environment:
01878 
01879     Kernel mode.  No locks held.
01880 
01881 --*/
01882 {
01883     KIRQL OldIrql;
01884     PVOID PoolBlock;
01885 
01886     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (KeGetCurrentIrql() &lt;= DISPATCH_LEVEL);
01887 
01888     ExAcquireSpinLock (&amp;MiPteTrackerLock, &amp;OldIrql);
01889 
01890     <span class="keywordflow">while</span> (IsListEmpty(&amp;MiDeadPteTrackerListHead) == 0) {
01891         PoolBlock = (PVOID)RemoveHeadList(&amp;MiDeadPteTrackerListHead);
01892         ExReleaseSpinLock (&amp;MiPteTrackerLock, OldIrql);
01893         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (PoolBlock);
01894         ExAcquireSpinLock (&amp;MiPteTrackerLock, &amp;OldIrql);
01895     }
01896 
01897     ExReleaseSpinLock (&amp;MiPteTrackerLock, OldIrql);
01898 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a34" doxytag="iosup.c::MiRemovePteTracker" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PVOID MiRemovePteTracker           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d6/d7/struct__MDL.html">PMDL</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>MemoryDescriptorList</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>PteAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PFN_NUMBER&nbsp;</td>
          <td class="mdname" nowrap> <em>NumberOfPtes</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l01675">1675</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
References <a class="el" href="../../d6/d5/iosup_8c-source.html#l00089">_SYSPTES_HEADER::Count</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l00076">_PTE_TRACKER::Count</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l00074">_PTE_TRACKER::ListEntry</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l00088">_SYSPTES_HEADER::ListHead</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01842">MiGetVirtualAddressMappedByPte</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l00094">MiPteHeader</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l00093">MiTrackPtesAborted</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l00081">_PTE_TRACKER::Page</a>, <a class="el" href="../../d5/d6/iosup_8c.html#a5">PPTE_TRACKER</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l00084">_PTE_TRACKER::PteAddress</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l00078">_PTE_TRACKER::StartVa</a>, and <a class="el" href="../../d6/d5/iosup_8c-source.html#l00077">_PTE_TRACKER::SystemVa</a>.
<p>
Referenced by <a class="el" href="../../d6/d5/iosup_8c-source.html#l03678">MmUnmapIoSpace()</a>, and <a class="el" href="../../d6/d5/iosup_8c-source.html#l03124">MmUnmapLockedPages()</a>.
<p>
<pre class="fragment"><div>01683                    :
01684 
01685     This function removes a PTE tracking block from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> lists as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PTEs
01686     are being freed.
01687 
01688 Arguments:
01689 
01690     MemoryDescriptorList - Supplies a valid Memory Descriptor <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>.
01691 
01692     PteAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system PTEs were mapped to.
01693 
01694     NumberOfPtes - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of system PTEs allocated.
01695 
01696 Return Value:
01697 
01698     The <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> block that held <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> tracking info that must be freed by our
01699     caller _AFTER_ our caller releases <a class="code" href="../../d4/d8/mi_8h.html#a689">MmSystemSpaceLock</a> (to prevent deadlock).
01700 
01701 Environment:
01702 
01703     Kernel mode, <span class="keyword">protected</span> by <a class="code" href="../../d4/d4/alpha_2splocks_8c.html#a15">MmSystemSpaceLock</a> at <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>.
01704 
01705 --*/
01706 
01707 {
01708     <a class="code" href="../../d7/d1/struct__PTE__TRACKER.html">PPTE_TRACKER</a> Tracker;
01709     PFN_NUMBER Page;
01710     PVOID BaseAddress;
01711     PLIST_ENTRY LastFound;
01712     PLIST_ENTRY NextEntry;
01713 
01714     BaseAddress = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PteAddress);
01715 
01716     <span class="keywordflow">if</span> (ARGUMENT_PRESENT (MemoryDescriptorList)) {
01717         Page = *(PPFN_NUMBER)(MemoryDescriptorList + 1);
01718     }
01719 
01720     LastFound = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01721     NextEntry = <a class="code" href="../../d5/d6/iosup_8c.html#a10">MiPteHeader</a>.<a class="code" href="../../d9/d7/struct__SYSPTES__HEADER.html#o0">ListHead</a>.Flink;
01722     <span class="keywordflow">while</span> (NextEntry != &amp;<a class="code" href="../../d5/d6/iosup_8c.html#a10">MiPteHeader</a>.<a class="code" href="../../d9/d7/struct__SYSPTES__HEADER.html#o0">ListHead</a>) {
01723 
01724         Tracker = (<a class="code" href="../../d7/d1/struct__PTE__TRACKER.html">PPTE_TRACKER</a>) CONTAINING_RECORD (NextEntry,
01725                                                     <a class="code" href="../../d7/d1/struct__PTE__TRACKER.html">PTE_TRACKER</a>,
01726                                                     ListEntry.Flink);
01727 
01728         <span class="keywordflow">if</span> (PteAddress == Tracker-&gt;<a class="code" href="../../d7/d1/struct__PTE__TRACKER.html#o10">PteAddress</a>) {
01729 
01730             <span class="keywordflow">if</span> (LastFound != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01731 
01732                 <span class="comment">//</span>
01733                 <span class="comment">// Duplicate map entry.</span>
01734                 <span class="comment">//</span>
01735 
01736                 <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (SYSTEM_PTE_MISUSE,
01737                               0x1,
01738                               (ULONG_PTR)Tracker,
01739                               (ULONG_PTR)MemoryDescriptorList,
01740                               (ULONG_PTR)LastFound);
01741             }
01742 
01743             <span class="keywordflow">if</span> (Tracker-&gt;Count != NumberOfPtes) {
01744 
01745                 <span class="comment">//</span>
01746                 <span class="comment">// Not unmapping the same of number of PTEs that were mapped.</span>
01747                 <span class="comment">//</span>
01748 
01749                 <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (SYSTEM_PTE_MISUSE,
01750                               0x2,
01751                               (ULONG_PTR)Tracker,
01752                               Tracker-&gt;Count,
01753                               NumberOfPtes);
01754             }
01755 
01756             <span class="keywordflow">if</span> (ARGUMENT_PRESENT (MemoryDescriptorList)) {
01757 
01758                 <span class="keywordflow">if</span> (Tracker-&gt;SystemVa != MemoryDescriptorList-&gt;MappedSystemVa) {
01759 
01760                     <span class="comment">//</span>
01761                     <span class="comment">// Not unmapping the same address that was mapped.</span>
01762                     <span class="comment">//</span>
01763 
01764                     <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (SYSTEM_PTE_MISUSE,
01765                                   0x3,
01766                                   (ULONG_PTR)Tracker,
01767                                   (ULONG_PTR)Tracker-&gt;SystemVa,
01768                                   (ULONG_PTR)MemoryDescriptorList-&gt;MappedSystemVa);
01769                 }
01770 
01771                 <span class="keywordflow">if</span> (Tracker-&gt;Page != Page) {
01772 
01773                     <span class="comment">//</span>
01774                     <span class="comment">// The first page in the MDL has changed since it was mapped.</span>
01775                     <span class="comment">//</span>
01776 
01777                     <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (SYSTEM_PTE_MISUSE,
01778                                   0x4,
01779                                   (ULONG_PTR)Tracker,
01780                                   (ULONG_PTR)Tracker-&gt;Page,
01781                                   (ULONG_PTR)Page);
01782                 }
01783 
01784                 <span class="keywordflow">if</span> (Tracker-&gt;StartVa != MemoryDescriptorList-&gt;StartVa) {
01785 
01786                     <span class="comment">//</span>
01787                     <span class="comment">// Map and unmap don't match up.</span>
01788                     <span class="comment">//</span>
01789 
01790                     <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (SYSTEM_PTE_MISUSE,
01791                                   0x5,
01792                                   (ULONG_PTR)Tracker,
01793                                   (ULONG_PTR)Tracker-&gt;StartVa,
01794                                   (ULONG_PTR)MemoryDescriptorList-&gt;StartVa);
01795                 }
01796             }
01797 
01798             RemoveEntryList (NextEntry);
01799             LastFound = NextEntry;
01800         }
01801         NextEntry = Tracker-&gt;ListEntry.Flink;
01802     }
01803 
01804     <span class="keywordflow">if</span> ((LastFound == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (<a class="code" href="../../d5/d6/iosup_8c.html#a9">MiTrackPtesAborted</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
01805 
01806         <span class="comment">//</span>
01807         <span class="comment">// Can't unmap something that was never (or isn't currently) mapped.</span>
01808         <span class="comment">//</span>
01809 
01810         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (SYSTEM_PTE_MISUSE,
01811                       0x6,
01812                       (ULONG_PTR)MemoryDescriptorList,
01813                       (ULONG_PTR)BaseAddress,
01814                       (ULONG_PTR)NumberOfPtes);
01815     }
01816 
01817     <a class="code" href="../../d5/d6/iosup_8c.html#a10">MiPteHeader</a>.<a class="code" href="../../d9/d7/struct__SYSPTES__HEADER.html#o1">Count</a> -= NumberOfPtes;
01818 
01819     <span class="keywordflow">return</span> (PVOID)LastFound;
01820 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a30" doxytag="iosup.c::MiUnmapLockedPagesInUserSpace" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MiUnmapLockedPagesInUserSpace           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>BaseAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d6/d7/struct__MDL.html">PMDL</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>MemoryDescriptorList</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l03253">3253</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00059">ASSERT64</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00221">COMPUTE_PAGES_SPANNED</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l03321">ExPageLockHandle</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d5/ppc_2flushtb_8c-source.html#l00188">KeFlushSingleTb()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01093">LOCK_WS_AND_ADDRESS_SPACE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01362">MI_DECREMENT_USED_PTES_BY_HANDLE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02410">MI_GET_PAGE_FRAME_FROM_PTE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01357">MI_GET_USED_PTES_FROM_HANDLE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01355">MI_GET_USED_PTES_HANDLE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02759">MiDecrementShareAndValidCount</a>, <a class="el" href="../../d9/d5/deleteva_8c-source.html#l00506">MiDeletePte()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01643">MiGetPdeAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01842">MiGetVirtualAddressMappedByPte</a>, <a class="el" href="../../d7/d2/vadtree_8c-source.html#l00380">MiLocateAddress()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l02641">MiPhysicalViewRemover()</a>, <a class="el" href="../../d7/d2/vadtree_8c-source.html#l00256">MiRemoveVad()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00107">MM_EMPTY_LIST</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l06284">MmLockPagableSectionByHandle()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l07065">MmUnlockPagableImageSection()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01097">UNLOCK_WS_AND_ADDRESS_SPACE</a>, <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>, and <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00030">ZeroPte</a>.
<p>
Referenced by <a class="el" href="../../d6/d5/iosup_8c-source.html#l03124">MmUnmapLockedPages()</a>.
<p>
<pre class="fragment"><div>03260                    :
03261 
03262     This routine unmaps locked pages which were previously mapped via
03263     a <a class="code" href="../../d2/d1/mm_8h.html#a276">MmMapLockedPages</a> function.
03264 
03265 Arguments:
03266 
03267     BaseAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base address where <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pages were previously
03268                   mapped.
03269 
03270     MemoryDescriptorList - Supplies a valid Memory Descriptor <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a> which has
03271                            been updated by <a class="code" href="../../d2/d1/mm_8h.html#a273">MmProbeAndLockPages</a>.
03272 
03273 Return Value:
03274 
03275     None.
03276 
03277 Environment:
03278 
03279     Kernel mode.  <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a> or below <span class="keywordflow">if</span> base address <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> within system space;
03280                 <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a> or below <span class="keywordflow">if</span> base address <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> user space.
03281 
03282 --*/
03283 
03284 {
03285     PFN_NUMBER NumberOfPages;
03286     PPFN_NUMBER Page;
03287     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
03288     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerBase;
03289     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPde;
03290     PVOID StartingVa;
03291     KIRQL OldIrql;
03292     <a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a> Vad;
03293     PVOID TempVa;
03294     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
03295     PVOID UsedPageTableHandle;
03296 <span class="preprocessor">#if defined (_WIN64)</span>
03297 <span class="preprocessor"></span>    PVOID UsedPageDirectoryHandle;
03298 <span class="preprocessor">#endif</span>
03299 <span class="preprocessor"></span>
03300     <a class="code" href="../../d5/d6/iosup_8c.html#a76">MmLockPagableSectionByHandle</a> (ExPageLockHandle);
03301 
03302     StartingVa = (PVOID)((PCHAR)MemoryDescriptorList-&gt;StartVa +
03303                     MemoryDescriptorList-&gt;ByteOffset);
03304 
03305     Page = (PPFN_NUMBER)(MemoryDescriptorList + 1);
03306     NumberOfPages = <a class="code" href="../../d2/d1/mm_8h.html#a9">COMPUTE_PAGES_SPANNED</a> (StartingVa,
03307                                            MemoryDescriptorList-&gt;ByteCount);
03308 
03309     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (BaseAddress);
03310     PointerBase = PointerPte;
03311 
03312     <span class="comment">//</span>
03313     <span class="comment">// This was mapped into the user portion of the address space and</span>
03314     <span class="comment">// the corresponding virtual address descriptor must be deleted.</span>
03315     <span class="comment">//</span>
03316 
03317     <span class="comment">//</span>
03318     <span class="comment">// Get the working set mutex and address creation mutex.</span>
03319     <span class="comment">//</span>
03320 
03321     Process = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a> ();
03322 
03323     <a class="code" href="../../d4/d8/mi_8h.html#a161">LOCK_WS_AND_ADDRESS_SPACE</a> (Process);
03324 
03325     Vad = <a class="code" href="../../d6/d3/vadtree_8c.html#a2">MiLocateAddress</a> (BaseAddress);
03326     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Vad != NULL);
03327 
03328     <a class="code" href="../../d4/d8/mi_8h.html#a893">MiPhysicalViewRemover</a> (Process, Vad);
03329 
03330     <a class="code" href="../../d6/d3/vadtree_8c.html#a1">MiRemoveVad</a> (Vad);
03331 
03332     <span class="comment">//</span>
03333     <span class="comment">// Get the PFN mutex so we can safely decrement share and valid</span>
03334     <span class="comment">// counts on page table pages.</span>
03335     <span class="comment">//</span>
03336 
03337     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
03338 
03339     <span class="keywordflow">do</span> {
03340 
03341         <span class="keywordflow">if</span> (*Page == <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>) {
03342             <span class="keywordflow">break</span>;
03343         }
03344 
03345         <a class="code" href="../../d4/d8/mi_8h.html#a1">ASSERT64</a> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a>(PointerPte)-&gt;u.Hard.Valid == 1);
03346         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(PointerPte)-&gt;u.Hard.Valid == 1);
03347         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte-&gt;u.Hard.Valid == 1);
03348 
03349         (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>)<a class="code" href="../../d0/d6/ppc_2flushtb_8c.html#a2">KeFlushSingleTb</a> (BaseAddress,
03350                                TRUE,
03351                                FALSE,
03352                                (PHARDWARE_PTE)PointerPte,
03353                                <a class="code" href="../../d4/d2/datalpha_8c.html#a0">ZeroPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Flush);
03354 
03355         PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(PointerPte);
03356         <a class="code" href="../../d4/d8/mi_8h.html#a242">MiDecrementShareAndValidCount</a> (MI_GET_PAGE_FRAME_FROM_PTE (PointerPde));
03357 
03358         <span class="comment">//</span>
03359         <span class="comment">// Another PTE has become zero.</span>
03360         <span class="comment">//</span>
03361 
03362         UsedPageTableHandle = <a class="code" href="../../d4/d8/mi_8h.html#a180">MI_GET_USED_PTES_HANDLE</a> (BaseAddress);
03363 
03364         <a class="code" href="../../d4/d8/mi_8h.html#a183">MI_DECREMENT_USED_PTES_BY_HANDLE</a> (UsedPageTableHandle);
03365 
03366         <span class="comment">//</span>
03367         <span class="comment">// If all the entries have been eliminated from the previous</span>
03368         <span class="comment">// page table page, delete the page table page itself.  Likewise</span>
03369         <span class="comment">// with the page directory page.</span>
03370         <span class="comment">//</span>
03371 
03372         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a181">MI_GET_USED_PTES_FROM_HANDLE</a> (UsedPageTableHandle) == 0) {
03373 
03374             TempVa = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPde);
03375             <a class="code" href="../../d4/d8/mi_8h.html#a886">MiDeletePte</a> (PointerPde,
03376                          TempVa,
03377                          FALSE,
03378                          Process,
03379                          (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)NULL,
03380                          NULL);
03381 
03382 <span class="preprocessor">#if defined (_WIN64)</span>
03383 <span class="preprocessor"></span>            UsedPageDirectoryHandle = <a class="code" href="../../d4/d8/mi_8h.html#a180">MI_GET_USED_PTES_HANDLE</a> (PointerPte);
03384 
03385             <a class="code" href="../../d4/d8/mi_8h.html#a183">MI_DECREMENT_USED_PTES_BY_HANDLE</a> (UsedPageDirectoryHandle);
03386 
03387             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a181">MI_GET_USED_PTES_FROM_HANDLE</a> (UsedPageDirectoryHandle) == 0) {
03388 
03389                 TempVa = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a>(<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(PointerPde));
03390                 <a class="code" href="../../d4/d8/mi_8h.html#a886">MiDeletePte</a> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(PointerPde),
03391                              TempVa,
03392                              FALSE,
03393                              Process,
03394                              NULL,
03395                              NULL);
03396             }
03397 <span class="preprocessor">#endif</span>
03398 <span class="preprocessor"></span>        }
03399 
03400         Page += 1;
03401         PointerPte += 1;
03402         NumberOfPages -= 1;
03403         BaseAddress = (PVOID)((PCHAR)BaseAddress + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
03404     } <span class="keywordflow">while</span> (NumberOfPages != 0);
03405 
03406     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
03407     <a class="code" href="../../d4/d8/mi_8h.html#a162">UNLOCK_WS_AND_ADDRESS_SPACE</a> (Process);
03408     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (Vad);
03409     <a class="code" href="../../d5/d6/iosup_8c.html#a81">MmUnlockPagableImageSection</a>(ExPageLockHandle);
03410     <span class="keywordflow">return</span>;
03411 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a52" doxytag="iosup.c::MiUnmapSinglePage" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MiUnmapSinglePage           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>VirtualAddress</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l02543">2543</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02262">MI_IS_PHYSICAL_ADDRESS</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l01354">MiReleaseSystemPtes()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d4/d8/mi_8h.html#a1003a769">SystemPteSpace</a>.
<p>
Referenced by <a class="el" href="../../d9/d5/forksup_8c-source.html#l00100">MiCloneProcessAddressSpace()</a>.
<p>
<pre class="fragment"><div>02549                    :
02550 
02551     This routine unmaps a single locked pages which was previously mapped via
02552     an <a class="code" href="../../d5/d6/iosup_8c.html#a51">MiMapSinglePage</a> call.
02553 
02554 Arguments:
02555 
02556     VirtualAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">virtual</span> address used to map <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> page.
02557 
02558 Return Value:
02559 
02560     None.
02561 
02562 Environment:
02563 
02564     Kernel mode.  <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a> or below, base address <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> within system space.
02565 
02566 --*/
02567 
02568 {
02569     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
02570 
02571     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a> ();
02572 
02573     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (MI_IS_PHYSICAL_ADDRESS (VirtualAddress) == 0);
02574     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (VirtualAddress &gt;= MM_SYSTEM_RANGE_START);
02575 
02576     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (VirtualAddress);
02577 
02578     <a class="code" href="../../d0/d9/sysptes_8c.html#a26">MiReleaseSystemPtes</a> (PointerPte, 1, SystemPteSpace);
02579     <span class="keywordflow">return</span>;
02580 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a38" doxytag="iosup.c::MiUnProtectFreeNonPagedPool" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LOGICAL MiUnProtectFreeNonPagedPool           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>VirtualAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>SizeInPages</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d5/allocpag_8c-source.html#l00209">209</a> of file <a class="el" href="../../d2/d5/allocpag_8c-source.html">allocpag.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02262">MI_IS_PHYSICAL_ADDRESS</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02459">MI_WRITE_VALID_PTE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>.
<p>
Referenced by <a class="el" href="../../d2/d5/allocpag_8c-source.html#l00807">MiAllocatePoolPages()</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l04569">MiFindContiguousMemory()</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l01778">MiFreePoolPages()</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l00282">MiProtectedPoolInsertList()</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l00365">MiProtectedPoolRemoveEntryList()</a>, and <a class="el" href="../../d6/d5/iosup_8c-source.html#l08083">MmSetKernelDumpRange()</a>.
<p>
<pre class="fragment"><div>00216                    :
00217 
00218     This function unprotects freed nonpaged <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a>.
00219 
00220 Arguments:
00221 
00222     VirtualAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> freed <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> address to unprotect.
00223 
00224     SizeInPages - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> request in pages - zero indicates
00225                   to keep going until there are no more <span class="keyword">protected</span> PTEs (ie: the
00226                   caller doesn't know how many <span class="keyword">protected</span> PTEs there are).
00227 
00228 Return Value:
00229 
00230     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> pages were unprotected, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <span class="keywordflow">if</span> not.
00231 
00232 Environment:
00233 
00234     Kernel mode.
00235 
00236 --*/
00237 
00238 {
00239     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
00240     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> PteContents;
00241     ULONG PagesDone;
00242 
00243     PagesDone = 0;
00244 
00245     <span class="comment">//</span>
00246     <span class="comment">// Unprotect the previously freed pool so it can be manipulated</span>
00247     <span class="comment">//</span>
00248 
00249     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a178">MI_IS_PHYSICAL_ADDRESS</a>(VirtualAddress) == 0) {
00250 
00251         PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>((PVOID)VirtualAddress);
00252 
00253         PteContents = *PointerPte;
00254 
00255         <span class="keywordflow">while</span> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0 &amp;&amp; PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype == 1) {
00256 
00257             PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid = 1;
00258             PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype = 0;
00259     
00260             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a> (PointerPte, PteContents);
00261 
00262             PagesDone += 1;
00263 
00264             <span class="keywordflow">if</span> (PagesDone == SizeInPages) {
00265                 <span class="keywordflow">break</span>;
00266             }
00267 
00268             PointerPte += 1;
00269             PteContents = *PointerPte;
00270         }
00271     }
00272 
00273     <span class="keywordflow">if</span> (PagesDone == 0) {
00274         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00275     }
00276 
00277     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00278 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a60" doxytag="iosup.c::MmAllocateContiguousMemory" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PVOID MmAllocateContiguousMemory           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN SIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>NumberOfBytes</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PHYSICAL_ADDRESS&nbsp;</td>
          <td class="mdname" nowrap> <em>HighestAcceptableAddress</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l03881">3881</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
References <a class="el" href="../../d6/d5/iosup_8c-source.html#l04107">MiAllocateContiguousMemory()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, and <a class="el" href="../../d6/d1/ppc_2getcalr_8c-source.html#l00038">RtlGetCallersAddress()</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l00384">IopGetDumpStack()</a>, and <a class="el" href="../../d3/d0/largepag_8c-source.html#l00227">Ki386AllocateContiguousMemory()</a>.
<p>
<pre class="fragment"><div>03888                    :
03889 
03890     This function allocates a range of physically contiguous non-paged <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a>.
03891 
03892     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> designed to be used by a driver's initialization
03893     routine to allocate a contiguous block of physical memory <span class="keywordflow">for</span>
03894     issuing DMA requests from.
03895 
03896 Arguments:
03897 
03898     NumberOfBytes - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of bytes to allocate.
03899 
03900     HighestAcceptableAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> highest physical address
03901                                which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> valid <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> allocation.  For
03902                                example, <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device can <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> reference
03903                                physical memory in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> lower 16MB <span class="keyword">this</span>
03904                                value would be set to 0xFFFFFF (16Mb - 1).
03905 
03906 Return Value:
03907 
03908     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> - a contiguous range could not be found to satisfy <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> request.
03909 
03910     NON-<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> - Returns a pointer (<span class="keyword">virtual</span> address in the nonpaged portion
03911                of the system) to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> allocated physically contiguous
03912                memory.
03913 
03914 Environment:
03915 
03916     Kernel mode, IRQL of <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a> or below.
03917 
03918 --*/
03919 
03920 {
03921     PFN_NUMBER HighestPfn;
03922     PVOID CallingAddress;
03923 
03924 <span class="preprocessor">#if defined (_X86_)</span>
03925 <span class="preprocessor"></span>    PVOID CallersCaller;
03926 
03927     <a class="code" href="../../d5/d2/ppc_2getcalr_8c.html#a0">RtlGetCallersAddress</a>(&amp;CallingAddress, &amp;CallersCaller);
03928 <span class="preprocessor">#else</span>
03929 <span class="preprocessor"></span>    CallingAddress = (PVOID)_ReturnAddress();
03930 <span class="preprocessor">#endif</span>
03931 <span class="preprocessor"></span>
03932     HighestPfn = (PFN_NUMBER)(HighestAcceptableAddress.QuadPart &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
03933 
03934     <span class="keywordflow">return</span> <a class="code" href="../../d5/d6/iosup_8c.html#a28">MiAllocateContiguousMemory</a>(NumberOfBytes,
03935                                       0,
03936                                       HighestPfn,
03937                                       0,
03938                                       CallingAddress);
03939 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a59" doxytag="iosup.c::MmAllocateContiguousMemorySpecifyCache" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PVOID MmAllocateContiguousMemorySpecifyCache           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN SIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>NumberOfBytes</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PHYSICAL_ADDRESS&nbsp;</td>
          <td class="mdname" nowrap> <em>LowestAcceptableAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PHYSICAL_ADDRESS&nbsp;</td>
          <td class="mdname" nowrap> <em>HighestAcceptableAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PHYSICAL_ADDRESS BoundaryAddressMultiple&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d4/d9/ke_8h.html#a156">MEMORY_CACHING_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>CacheType</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l03744">3744</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00166">BYTE_OFFSET</a>, <a class="el" href="../../d4/d4/ppc_2flush_8c-source.html#l00220">KeSweepDcache()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l04107">MiAllocateContiguousMemory()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d4/d9/ke_8h.html#a413a249">MmCached</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l05372">MmFreeContiguousMemory()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l05490">MmGetPhysicalAddress()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l03415">MmMapIoSpace()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d6/d1/ppc_2getcalr_8c-source.html#l00038">RtlGetCallersAddress()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>.
<p>
<pre class="fragment"><div>03754                    :
03755 
03756     This function allocates a range of physically contiguous non-cached,
03757     non-paged memory.  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> accomplished by <span class="keyword">using</span> <a class="code" href="../../d2/d1/mm_8h.html#a293">MmAllocateContiguousMemory</a>
03758     which uses nonpaged <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> <span class="keyword">virtual</span> addresses to map <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> found memory chunk.
03759 
03760     Then <span class="keyword">this</span> function establishes another map to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> same physical addresses,
03761     but <span class="keyword">this</span> alternate map <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> initialized as non-cached.  All references by
03762     our caller will be done through <span class="keyword">this</span> alternate map.
03763 
03764     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> designed to be used by a driver's initialization
03765     routine to allocate a contiguous block of noncached physical memory <span class="keywordflow">for</span>
03766     things like <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> AGP GART.
03767 
03768 Arguments:
03769 
03770     NumberOfBytes - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of bytes to allocate.
03771 
03772     LowestAcceptableAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> lowest physical address
03773                               which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> valid <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> allocation.  For
03774                               example, <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device can <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> reference
03775                               physical memory in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> 8M to 16MB range, <span class="keyword">this</span>
03776                               value would be set to 0x800000 (8Mb).
03777 
03778     HighestAcceptableAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> highest physical address
03779                                which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> valid <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> allocation.  For
03780                                example, <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device can <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> reference
03781                                physical memory below 16MB, <span class="keyword">this</span>
03782                                value would be set to 0xFFFFFF (16Mb - 1).
03783 
03784     BoundaryAddressMultiple - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> physical address multiple <span class="keyword">this</span>
03785                               allocation must not cross.
03786 
03787 Return Value:
03788 
03789     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> - a contiguous range could not be found to satisfy <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> request.
03790 
03791     NON-<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> - Returns a pointer (<span class="keyword">virtual</span> address in the nonpaged portion
03792                of the system) to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> allocated physically contiguous
03793                memory.
03794 
03795 Environment:
03796 
03797     Kernel mode, IRQL of <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a> or below.
03798 
03799 --*/
03800 
03801 {
03802     PVOID BaseAddress;
03803     PVOID NewVa;
03804     PFN_NUMBER LowestPfn;
03805     PFN_NUMBER HighestPfn;
03806     PFN_NUMBER BoundaryPfn;
03807     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
03808     PHYSICAL_ADDRESS PhysicalAddress;
03809     PVOID CallingAddress;
03810 
03811 <span class="preprocessor">#if defined (_X86_)</span>
03812 <span class="preprocessor"></span>    PVOID CallersCaller;
03813 
03814     <a class="code" href="../../d5/d2/ppc_2getcalr_8c.html#a0">RtlGetCallersAddress</a>(&amp;CallingAddress, &amp;CallersCaller);
03815 <span class="preprocessor">#else</span>
03816 <span class="preprocessor"></span>    CallingAddress = (PVOID)_ReturnAddress();
03817 <span class="preprocessor">#endif</span>
03818 <span class="preprocessor"></span>
03819     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (NumberOfBytes != 0);
03820 
03821     LowestPfn = (PFN_NUMBER)(LowestAcceptableAddress.QuadPart &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
03822     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d1/mm_8h.html#a6">BYTE_OFFSET</a>(LowestAcceptableAddress.LowPart)) {
03823         LowestPfn += 1;
03824     }
03825 
03826     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d1/mm_8h.html#a6">BYTE_OFFSET</a>(BoundaryAddressMultiple.LowPart)) {
03827         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03828     }
03829 
03830     BoundaryPfn = (PFN_NUMBER)(BoundaryAddressMultiple.QuadPart &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
03831 
03832     HighestPfn = (PFN_NUMBER)(HighestAcceptableAddress.QuadPart &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
03833 
03834     BaseAddress = <a class="code" href="../../d5/d6/iosup_8c.html#a28">MiAllocateContiguousMemory</a>(NumberOfBytes,
03835                                              LowestPfn,
03836                                              HighestPfn,
03837                                              BoundaryPfn,
03838                                              CallingAddress);
03839 
03840     <span class="keywordflow">if</span> (BaseAddress) {
03841 
03842         <span class="keywordflow">if</span> (CacheType != <a class="code" href="../../d4/d9/ke_8h.html#a413a249">MmCached</a>) {
03843 
03844             <span class="comment">//</span>
03845             <span class="comment">// We have an address range but it's cached.  Create an uncached</span>
03846             <span class="comment">// alternate mapping now.  Stash the original virtual address at the</span>
03847             <span class="comment">// end of the mapped range so we can unmap the nonpaged pool VAs and</span>
03848             <span class="comment">// the actual pages when the caller frees the memory.</span>
03849             <span class="comment">//</span>
03850 
03851             PhysicalAddress = <a class="code" href="../../d5/d6/iosup_8c.html#a68">MmGetPhysicalAddress</a> (BaseAddress);
03852 
03853             NewVa = <a class="code" href="../../d5/d6/iosup_8c.html#a57">MmMapIoSpace</a> (PhysicalAddress,
03854                                   NumberOfBytes + (2 * PAGE_SIZE),
03855                                   CacheType);
03856 
03857             <span class="keywordflow">if</span> (NewVa) {
03858 
03859                 PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(NewVa);
03860 
03861                 PointerPte += ((NumberOfBytes + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1) &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
03862                 PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = (ULONG_PTR)BaseAddress;
03863 
03864                 PointerPte += 1;
03865                 PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = NumberOfBytes;
03866 
03867                 <a class="code" href="../../d3/d5/ppc_2flush_8c.html#a6">KeSweepDcache</a> (TRUE);
03868                 BaseAddress = NewVa;
03869             }
03870             <span class="keywordflow">else</span> {
03871                 <a class="code" href="../../d5/d6/iosup_8c.html#a66">MmFreeContiguousMemory</a> (BaseAddress);
03872                 BaseAddress = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03873             }
03874         }
03875     }
03876 
03877     <span class="keywordflow">return</span> BaseAddress;
03878 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a61" doxytag="iosup.c::MmAllocateIndependentPages" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PVOID MmAllocateIndependentPages           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN SIZE_T&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>NumberOfBytes</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l03942">3942</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00141">BYTES_TO_PAGES</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01013">MI_GET_PAGE_COLOR_FROM_PTE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00494">MI_MAKE_VALID_PTE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04360">MI_NONPAGABLE_MEMORY_AVAILABLE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00710">MI_SET_PTE_DIRTY</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02459">MI_WRITE_VALID_PTE</a>, <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00329">MiChargeCommitmentCantExpand()</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00941">MiEnsureAvailablePageOrWait()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01842">MiGetVirtualAddressMappedByPte</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l03398">MiInitializePfn()</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l01354">MiReleaseSystemPtes()</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l01395">MiRemoveAnyPage()</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l00524">MiReserveSystemPtes()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04317">MM_BUMP_COUNTER</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04254">MM_DBG_COMMIT_INDEPENDENT_PAGES</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00137">MM_READWRITE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04221">MM_TRACK_COMMIT</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00086">MmResidentAvailablePages</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d4/d8/mi_8h.html#a1003a769">SystemPteSpace</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>.
<p>
Referenced by <a class="el" href="../../d7/d8/kernlini_8c-source.html#l02460">KiI386PentiumLockErrataFixup()</a>.
<p>
<pre class="fragment"><div>03948                    :
03949 
03950     This function allocates a range of virtually contiguous nonpaged pages that
03951     can have independent page protections applied to each page.
03952 
03953 Arguments:
03954 
03955     NumberOfBytes - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of bytes to allocate.
03956 
03957 Return Value:
03958 
03959     The <span class="keyword">virtual</span> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> memory or <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> <span class="keywordflow">if</span> none could be allocated.
03960 
03961 Environment:
03962 
03963     Kernel mode, IRQL of <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a> or below.
03964 
03965 --*/
03966 
03967 {
03968     PFN_NUMBER NumberOfPages;
03969     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
03970     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
03971     PFN_NUMBER PageFrameIndex;
03972     PVOID BaseAddress;
03973     KIRQL OldIrql;
03974 
03975     NumberOfPages = <a class="code" href="../../d2/d1/mm_8h.html#a5">BYTES_TO_PAGES</a> (NumberOfBytes);
03976 
03977     PointerPte = <a class="code" href="../../d0/d9/sysptes_8c.html#a25">MiReserveSystemPtes</a> ((ULONG)NumberOfPages,
03978                                       SystemPteSpace,
03979                                       0,
03980                                       0,
03981                                       FALSE);
03982     <span class="keywordflow">if</span> (PointerPte == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03983         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03984     }
03985 
03986     BaseAddress = (PVOID)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPte);
03987 
03988     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
03989 
03990     <span class="keywordflow">if</span> ((SPFN_NUMBER)NumberOfPages &gt; <a class="code" href="../../d4/d8/mi_8h.html#a323">MI_NONPAGABLE_MEMORY_AVAILABLE</a>()) {
03991         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
03992         <a class="code" href="../../d0/d9/sysptes_8c.html#a26">MiReleaseSystemPtes</a> (PointerPte, (ULONG)NumberOfPages, SystemPteSpace);
03993         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
03994     }
03995 
03996     <a class="code" href="../../d8/d5/kddata_8c.html#a42">MmResidentAvailablePages</a> -= NumberOfPages;
03997     <a class="code" href="../../d4/d8/mi_8h.html#a322">MM_BUMP_COUNTER</a>(28, NumberOfPages);
03998 
03999     <span class="keywordflow">do</span> {
04000         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0);
04001         <a class="code" href="../../d7/d5/pfnlist_8c.html#a13">MiEnsureAvailablePageOrWait</a> (NULL, NULL);
04002         PageFrameIndex = <a class="code" href="../../d7/d5/pfnlist_8c.html#a15">MiRemoveAnyPage</a> (MI_GET_PAGE_COLOR_FROM_PTE (PointerPte));
04003 
04004         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a105">MI_MAKE_VALID_PTE</a> (TempPte,
04005                            PageFrameIndex,
04006                            MM_READWRITE,
04007                            PointerPte);
04008 
04009         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a112">MI_SET_PTE_DIRTY</a> (TempPte);
04010         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a> (PointerPte, TempPte);
04011         <a class="code" href="../../d8/d2/pagfault_8c.html#a22">MiInitializePfn</a> (PageFrameIndex, PointerPte, 1);
04012 
04013         PointerPte += 1;
04014         NumberOfPages -= 1;
04015     } <span class="keywordflow">while</span> (NumberOfPages != 0);
04016 
04017     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
04018 
04019     <a class="code" href="../../d6/d1/mmquota_8c.html#a18">MiChargeCommitmentCantExpand</a> (NumberOfPages, TRUE);
04020 
04021     <a class="code" href="../../d4/d8/mi_8h.html#a254">MM_TRACK_COMMIT</a> (MM_DBG_COMMIT_INDEPENDENT_PAGES, NumberOfPages);
04022 
04023     <span class="keywordflow">return</span> BaseAddress;
04024 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a70" doxytag="iosup.c::MmAllocateNonCachedMemory" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PVOID MmAllocateNonCachedMemory           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN SIZE_T&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>NumberOfBytes</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l05581">5581</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00141">BYTES_TO_PAGES</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l03321">ExPageLockHandle</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d5/ppc_2flushtb_8c-source.html#l00033">KeFlushEntireTb()</a>, <a class="el" href="../../d4/d4/ppc_2flush_8c-source.html#l00220">KeSweepDcache()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00861">MI_DISABLE_CACHING</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01013">MI_GET_PAGE_COLOR_FROM_PTE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00494">MI_MAKE_VALID_PTE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04360">MI_NONPAGABLE_MEMORY_AVAILABLE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00710">MI_SET_PTE_DIRTY</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02459">MI_WRITE_VALID_PTE</a>, <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00329">MiChargeCommitmentCantExpand()</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00941">MiEnsureAvailablePageOrWait()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01842">MiGetVirtualAddressMappedByPte</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l03398">MiInitializePfn()</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l01354">MiReleaseSystemPtes()</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l01395">MiRemoveAnyPage()</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l00524">MiReserveSystemPtes()</a>, <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00442">MiReturnCommitment()</a>, <a class="el" href="../../d7/d1/mm_2ia64_2initia64_8c-source.html#l02042">MiSweepCacheMachineDependent()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04317">MM_BUMP_COUNTER</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04257">MM_DBG_COMMIT_NONCACHED_PAGES</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00137">MM_READWRITE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04221">MM_TRACK_COMMIT</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l06284">MmLockPagableSectionByHandle()</a>, <a class="el" href="../../d4/d9/ke_8h.html#a413a248">MmNonCached</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00086">MmResidentAvailablePages</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l07065">MmUnlockPagableImageSection()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d4/d8/mi_8h.html#a1003a769">SystemPteSpace</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l00384">IopGetDumpStack()</a>.
<p>
<pre class="fragment"><div>05587                    :
05588 
05589     This function allocates a range of noncached memory in
05590     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> non-paged portion of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system address space.
05591 
05592     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> designed to be used by a driver's initialization
05593     routine to allocate a noncached block of <span class="keyword">virtual</span> memory <span class="keywordflow">for</span>
05594     various device specific buffers.
05595 
05596 Arguments:
05597 
05598     NumberOfBytes - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of bytes to allocate.
05599 
05600 Return Value:
05601 
05602     NON-<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> - Returns a pointer (<span class="keyword">virtual</span> address in the nonpaged portion
05603                of the system) to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> allocated physically contiguous
05604                memory.
05605 
05606     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> - The specified request could not be satisfied.
05607 
05608 Environment:
05609 
05610     Kernel mode, IRQL of <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a> or below.
05611 
05612 --*/
05613 
05614 {
05615     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
05616     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
05617     PFN_NUMBER NumberOfPages;
05618     PFN_NUMBER PageFrameIndex;
05619     PVOID BaseAddress;
05620     KIRQL OldIrql;
05621 
05622     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (NumberOfBytes != 0);
05623 
05624     NumberOfPages = <a class="code" href="../../d2/d1/mm_8h.html#a5">BYTES_TO_PAGES</a>(NumberOfBytes);
05625 
05626     <span class="comment">//</span>
05627     <span class="comment">// Obtain enough virtual space to map the pages.</span>
05628     <span class="comment">//</span>
05629 
05630     PointerPte = <a class="code" href="../../d0/d9/sysptes_8c.html#a25">MiReserveSystemPtes</a> ((ULONG)NumberOfPages,
05631                                       SystemPteSpace,
05632                                       0,
05633                                       0,
05634                                       FALSE);
05635 
05636     <span class="keywordflow">if</span> (PointerPte == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05637         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05638     }
05639 
05640     <span class="comment">//</span>
05641     <span class="comment">// Obtain backing commitment for the pages.</span>
05642     <span class="comment">//</span>
05643 
05644     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d1/mmquota_8c.html#a18">MiChargeCommitmentCantExpand</a> (NumberOfPages, FALSE) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
05645         <a class="code" href="../../d0/d9/sysptes_8c.html#a26">MiReleaseSystemPtes</a> (PointerPte, (ULONG)NumberOfPages, SystemPteSpace);
05646         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05647     }
05648 
05649     <a class="code" href="../../d4/d8/mi_8h.html#a254">MM_TRACK_COMMIT</a> (MM_DBG_COMMIT_NONCACHED_PAGES, NumberOfPages);
05650 
05651     <a class="code" href="../../d5/d6/iosup_8c.html#a76">MmLockPagableSectionByHandle</a> (ExPageLockHandle);
05652 
05653     <span class="comment">//</span>
05654     <span class="comment">// Acquire the PFN mutex to synchronize access to the PFN database.</span>
05655     <span class="comment">//</span>
05656 
05657     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
05658 
05659     <span class="comment">//</span>
05660     <span class="comment">// Obtain enough pages to contain the allocation.</span>
05661     <span class="comment">// Check to make sure the physical pages are available.</span>
05662     <span class="comment">//</span>
05663 
05664     <span class="keywordflow">if</span> ((SPFN_NUMBER)NumberOfPages &gt; <a class="code" href="../../d4/d8/mi_8h.html#a323">MI_NONPAGABLE_MEMORY_AVAILABLE</a>()) {
05665         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
05666         <a class="code" href="../../d5/d6/iosup_8c.html#a81">MmUnlockPagableImageSection</a> (ExPageLockHandle);
05667         <a class="code" href="../../d0/d9/sysptes_8c.html#a26">MiReleaseSystemPtes</a> (PointerPte, (ULONG)NumberOfPages, SystemPteSpace);
05668         <a class="code" href="../../d6/d1/mmquota_8c.html#a19">MiReturnCommitment</a> (NumberOfPages);
05669         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
05670     }
05671 
05672 <span class="preprocessor">#if defined(_IA64_)</span>
05673 <span class="preprocessor"></span>    <a class="code" href="../../d0/d6/ppc_2flushtb_8c.html#a0">KeFlushEntireTb</a>(FALSE, TRUE);
05674 <span class="preprocessor">#endif</span>
05675 <span class="preprocessor"></span>
05676     <a class="code" href="../../d8/d5/kddata_8c.html#a42">MmResidentAvailablePages</a> -= NumberOfPages;
05677     <a class="code" href="../../d4/d8/mi_8h.html#a322">MM_BUMP_COUNTER</a>(4, NumberOfPages);
05678 
05679     BaseAddress = (PVOID)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPte);
05680 
05681     <span class="keywordflow">do</span> {
05682         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0);
05683         <a class="code" href="../../d7/d5/pfnlist_8c.html#a13">MiEnsureAvailablePageOrWait</a> (NULL, NULL);
05684         PageFrameIndex = <a class="code" href="../../d7/d5/pfnlist_8c.html#a15">MiRemoveAnyPage</a> (MI_GET_PAGE_COLOR_FROM_PTE (PointerPte));
05685 
05686         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a105">MI_MAKE_VALID_PTE</a> (TempPte,
05687                            PageFrameIndex,
05688                            MM_READWRITE,
05689                            PointerPte);
05690 
05691         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a112">MI_SET_PTE_DIRTY</a> (TempPte);
05692         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a118">MI_DISABLE_CACHING</a> (TempPte);
05693         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a> (PointerPte, TempPte);
05694         <a class="code" href="../../d8/d2/pagfault_8c.html#a22">MiInitializePfn</a> (PageFrameIndex, PointerPte, 1);
05695 
05696         PointerPte += 1;
05697         NumberOfPages -= 1;
05698     } <span class="keywordflow">while</span> (NumberOfPages != 0);
05699 
05700     <span class="comment">//</span>
05701     <span class="comment">// Flush any data for this page out of the dcaches.</span>
05702     <span class="comment">//</span>
05703 
05704 <span class="preprocessor">#if !defined(_IA64_)</span>
05705 <span class="preprocessor"></span>    <span class="comment">//</span>
05706     <span class="comment">// Flush any data for this page out of the dcaches.</span>
05707     <span class="comment">//</span>
05708 
05709     <a class="code" href="../../d3/d5/ppc_2flush_8c.html#a6">KeSweepDcache</a> (TRUE);
05710 <span class="preprocessor">#else</span>
05711 <span class="preprocessor"></span>    <a class="code" href="../../d2/d9/miia64_8h.html#a318">MiSweepCacheMachineDependent</a>(BaseAddress, NumberOfBytes, MmNonCached);
05712 <span class="preprocessor">#endif</span>
05713 <span class="preprocessor"></span>
05714     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
05715     <a class="code" href="../../d5/d6/iosup_8c.html#a81">MmUnlockPagableImageSection</a> (ExPageLockHandle);
05716 
05717     <span class="keywordflow">return</span> BaseAddress;
05718 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a63" doxytag="iosup.c::MmAllocatePagesForMdl" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d6/d7/struct__MDL.html">PMDL</a> MmAllocatePagesForMdl           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PHYSICAL_ADDRESS&nbsp;</td>
          <td class="mdname" nowrap> <em>LowAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PHYSICAL_ADDRESS&nbsp;</td>
          <td class="mdname" nowrap> <em>HighAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PHYSICAL_ADDRESS&nbsp;</td>
          <td class="mdname" nowrap> <em>SkipBytes</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN SIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>TotalBytes</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l04270">4270</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
References <a class="el" href="../../d2/d1/mm_8h.html#a345a177">ActiveAndValid</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00217">ADDRESS_AND_SIZE_TO_SPAN_PAGES</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00086">APC_LEVEL</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00034">_PHYSICAL_MEMORY_RUN::BasePage</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l01082">_MMPFNLIST::Blink</a>, <a class="el" href="../../d7/d8/mippc_8h-source.html#l01893">_MMCOLOR_TABLES::Blink</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00166">BYTE_OFFSET</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00420">_MDL::ByteCount</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l03321">ExPageLockHandle</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l01081">_MMPFNLIST::Flink</a>, <a class="el" href="../../d7/d8/mippc_8h-source.html#l01892">_MMCOLOR_TABLES::Flink</a>, <a class="el" href="../../d2/d1/mm_8h.html#a345a172">FreePageList</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01219">MI_MAGIC_AWE_PTEFRAME</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04360">MI_NONPAGABLE_MEMORY_AVAILABLE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00909">MI_SET_PFN_DELETED</a>, <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00329">MiChargeCommitmentCantExpand()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l04266">MiLastCallColor</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l04265">MiLastCallHighPage</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l04264">MiLastCallLowPage</a>, <a class="el" href="../../d1/d1/mmsup_8c-source.html#l01245">MiRestoreTransitionPte()</a>, <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00442">MiReturnCommitment()</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00821">MiUnlinkFreeOrZeroedPage()</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l00667">MiUnlinkPageFromList()</a>, <a class="el" href="../../d1/d1/mmsup_8c-source.html#l01184">MiZeroPhysicalPage()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04317">MM_BUMP_COUNTER</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04256">MM_DBG_COMMIT_MDL_PAGES</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00418">MM_DEMAND_ZERO_WRITE_PTE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00107">MM_EMPTY_LIST</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04221">MM_TRACK_COMMIT</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l05852">MmCreateMdl()</a>, <a class="el" href="../../d0/d3/dynmem_8c-source.html#l00024">MmDynamicMemoryMutex</a>, <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00112">MmFreePagesByColor</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00044">MmHighestPhysicalPage</a>, <a class="el" href="../../d2/d1/mm_8h.html#a147">MMLISTS</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l06284">MmLockPagableSectionByHandle()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l00204">MmMdlPagesAllocated</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04571">MmPageLocationList</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l00075">MmPfnDatabase</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00048">MmPhysicalMemoryBlock</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00086">MmResidentAvailablePages</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00081">MmSecondaryColors</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l07065">MmUnlockPagableImageSection()</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00039">_PHYSICAL_MEMORY_DESCRIPTOR::NumberOfRuns</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01297">_MMPFN::OriginalPte</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00035">_PHYSICAL_MEMORY_RUN::PageCount</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01298">_MMPFN::PteFrame</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00041">_PHYSICAL_MEMORY_DESCRIPTOR::Run</a>, <a class="el" href="../../d2/d1/mm_8h.html#a345a173">StandbyPageList</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o5">_MMPFN::u1</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o10">_MMPFN::u2</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o15">_MMPFN::u3</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>, and <a class="el" href="../../d2/d1/mm_8h.html#a345a171">ZeroedPageList</a>.
<p>
Referenced by <a class="el" href="../../d9/d4/physical_8c-source.html#l00970">NtAllocateUserPhysicalPages()</a>.
<p>
<pre class="fragment"><div>04279                    :
04280 
04281     This routine searches <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PFN database <span class="keywordflow">for</span> free, zeroed or standby pages
04282     to satisfy <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> request.  This does not map <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pages - <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> just allocates
04283     them and puts them into an <a class="code" href="../../d6/d7/struct__MDL.html">MDL</a>.  It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> expected that our caller will
04284     map <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d6/d7/struct__MDL.html">MDL</a> as needed.
04285 
04286     NOTE: <span class="keyword">this</span> routine may <span class="keywordflow">return</span> an <a class="code" href="../../d6/d7/struct__MDL.html">MDL</a> mapping a smaller number of bytes
04287     than <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> amount requested.  It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller's responsibility to check <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
04288     <a class="code" href="../../d6/d7/struct__MDL.html">MDL</a> upon <span class="keywordflow">return</span> <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size actually allocated.
04289 
04290     These pages comprise physical non-paged memory and are zero-filled.
04291 
04292     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> designed to be used by an AGP driver to obtain physical
04293     memory in a specified range since hardware may provide substantial
04294     performance wins depending on where <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> backing memory <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> allocated.
04295 
04296 Arguments:
04297 
04298     LowAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d3/fetypes_8h.html#a457a418">low</a> physical address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first range that
04299                  <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> allocated pages can come from.
04300 
04301     HighAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d3/fetypes_8h.html#a457a417">high</a> physical address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first range that
04302                   <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> allocated pages can come from.
04303 
04304     SkipBytes - Number of bytes to skip (from the Low Address) to get to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
04305                 next physical address range that allocated pages can come from.
04306 
04307     TotalBytes - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of bytes to allocate.
04308 
04309 Return Value:
04310 
04311     <a class="code" href="../../d6/d7/struct__MDL.html">MDL</a> - An <a class="code" href="../../d6/d7/struct__MDL.html">MDL</a> mapping a range of pages in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified range.
04312           This may map less memory than <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller requested <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> full amount
04313           <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not currently available.
04314 
04315     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> - No pages in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified range OR not enough virtually contiguous
04316            nonpaged <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d6/d7/struct__MDL.html">MDL</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> available at <span class="keyword">this</span> time.
04317 
04318 Environment:
04319 
04320     Kernel mode, IRQL of <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a> or below.
04321 
04322 --*/
04323 
04324 {
04325     <a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a> MemoryDescriptorList;
04326     <a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a> MemoryDescriptorList2;
04327     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
04328     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> PfnNextColored;
04329     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> PfnNextFlink;
04330     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> PfnLastColored;
04331     KIRQL OldIrql;
04332     PFN_NUMBER start;
04333     PFN_NUMBER count;
04334     PFN_NUMBER Page;
04335     PFN_NUMBER LastPage;
04336     PFN_NUMBER found;
04337     PFN_NUMBER BasePage;
04338     PFN_NUMBER LowPage;
04339     PFN_NUMBER HighPage;
04340     PFN_NUMBER SizeInPages;
04341     PFN_NUMBER MdlPageSpan;
04342     PFN_NUMBER SkipPages;
04343     PFN_NUMBER MaxPages;
04344     PPFN_NUMBER MdlPage;
04345     PPFN_NUMBER LastMdlPage;
04346     ULONG Color;
04347     <a class="code" href="../../d4/d1/struct__MMCOLOR__TABLES.html">PMMCOLOR_TABLES</a> ColorHead;
04348     <a class="code" href="../../d2/d1/mm_8h.html#a147">MMLISTS</a> MemoryList;
04349     PPFN_NUMBER FirstMdlPageToZero;
04350     PFN_NUMBER LowPage1;
04351     PFN_NUMBER HighPage1;
04352     LOGICAL PagePlacementOk;
04353     PFN_NUMBER PageNextColored;
04354     PFN_NUMBER PageNextFlink;
04355     PFN_NUMBER PageLastColored;
04356     <a class="code" href="../../d0/d4/struct__MMPFNLIST.html">PMMPFNLIST</a> ListHead;
04357     PPFN_NUMBER ColorAnchorsHead;
04358     PPFN_NUMBER ColorAnchor;
04359     ULONG FullAnchorCount;
04360 <span class="preprocessor">#if DBG</span>
04361 <span class="preprocessor"></span>    ULONG FinishedCount;
04362 <span class="preprocessor">#endif</span>
04363 <span class="preprocessor"></span>
04364     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (KeGetCurrentIrql() &lt;= APC_LEVEL);
04365 
04366     <span class="comment">//</span>
04367     <span class="comment">// The skip increment must be a page-size multiple.</span>
04368     <span class="comment">//</span>
04369 
04370     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d1/mm_8h.html#a6">BYTE_OFFSET</a>(SkipBytes.LowPart)) {
04371         <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a>)0;
04372     }
04373 
04374     <a class="code" href="../../d5/d6/iosup_8c.html#a76">MmLockPagableSectionByHandle</a> (ExPageLockHandle);
04375 
04376     LowPage = (PFN_NUMBER)(LowAddress.QuadPart &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
04377     HighPage = (PFN_NUMBER)(HighAddress.QuadPart &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
04378 
04379     <span class="comment">//</span>
04380     <span class="comment">// Maximum allocation size is constrained by the MDL ByteCount field.</span>
04381     <span class="comment">//</span>
04382 
04383     <span class="keywordflow">if</span> (TotalBytes &gt; (SIZE_T)((ULONG)(MAXULONG - <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>))) {
04384         TotalBytes = (SIZE_T)((ULONG)(MAXULONG - <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>));
04385     }
04386 
04387     SizeInPages = (PFN_NUMBER)<a class="code" href="../../d2/d1/mm_8h.html#a8">ADDRESS_AND_SIZE_TO_SPAN_PAGES</a>(0, TotalBytes);
04388 
04389     SkipPages = (PFN_NUMBER)(SkipBytes.QuadPart &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
04390 
04391     BasePage = LowPage;
04392 
04393     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
04394 
04395     MaxPages = <a class="code" href="../../d4/d8/mi_8h.html#a323">MI_NONPAGABLE_MEMORY_AVAILABLE</a>() - 1024;
04396 
04397     <span class="keywordflow">if</span> ((SPFN_NUMBER)MaxPages &lt;= 0) {
04398         SizeInPages = 0;
04399     }
04400     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (SizeInPages &gt; MaxPages) {
04401         SizeInPages = MaxPages;
04402     }
04403 
04404     <span class="keywordflow">if</span> (SizeInPages == 0) {
04405         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
04406         <a class="code" href="../../d5/d6/iosup_8c.html#a81">MmUnlockPagableImageSection</a> (ExPageLockHandle);
04407         <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a>)0;
04408     }
04409 
04410     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
04411 
04412 <span class="preprocessor">#if DBG</span>
04413 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (SizeInPages &lt; (PFN_NUMBER)<a class="code" href="../../d2/d1/mm_8h.html#a8">ADDRESS_AND_SIZE_TO_SPAN_PAGES</a>(0, TotalBytes)) {
04414         <span class="keywordflow">if</span> (MiPrintAwe != 0) {
04415             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"MmAllocatePagesForMdl1: unable to get %p pages, trying for %p instead\n"</span>,
04416                 <a class="code" href="../../d2/d1/mm_8h.html#a8">ADDRESS_AND_SIZE_TO_SPAN_PAGES</a>(0, TotalBytes),
04417                 SizeInPages);
04418         }
04419     }
04420 <span class="preprocessor">#endif</span>
04421 <span class="preprocessor"></span>
04422     <span class="comment">//</span>
04423     <span class="comment">// Allocate an MDL to return the pages in.</span>
04424     <span class="comment">//</span>
04425 
04426     <span class="keywordflow">do</span> {
04427         MemoryDescriptorList = <a class="code" href="../../d5/d6/iosup_8c.html#a73">MmCreateMdl</a> ((<a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a>)0,
04428                                             (PVOID)0,
04429                                             SizeInPages &lt;&lt; PAGE_SHIFT);
04430     
04431         <span class="keywordflow">if</span> (MemoryDescriptorList != (<a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a>)0) {
04432             <span class="keywordflow">break</span>;
04433         }
04434         SizeInPages -= (SizeInPages &gt;&gt; 4);
04435     } <span class="keywordflow">while</span> (SizeInPages != 0);
04436 
04437     <span class="keywordflow">if</span> (MemoryDescriptorList == (<a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a>)0) {
04438         <a class="code" href="../../d5/d6/iosup_8c.html#a81">MmUnlockPagableImageSection</a> (ExPageLockHandle);
04439         <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a>)0;
04440     }
04441 
04442     <span class="comment">//</span>
04443     <span class="comment">// Allocate a list of colored anchors.</span>
04444     <span class="comment">//</span>
04445 
04446     ColorAnchorsHead = (PPFN_NUMBER) <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (NonPagedPool,
04447                                                             MmSecondaryColors * <span class="keyword">sizeof</span> (PFN_NUMBER),
04448                                                             'ldmM');
04449 
04450     <span class="keywordflow">if</span> (ColorAnchorsHead == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04451         <a class="code" href="../../d5/d6/iosup_8c.html#a81">MmUnlockPagableImageSection</a> (ExPageLockHandle);
04452         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (MemoryDescriptorList);
04453         <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a>)0;
04454     }
04455 
04456     MdlPageSpan = SizeInPages;
04457 
04458     <span class="comment">//</span>
04459     <span class="comment">// Recalculate as the PFN lock was dropped.</span>
04460     <span class="comment">//</span>
04461 
04462     start = 0;
04463     found = 0;
04464 
04465     MdlPage = (PPFN_NUMBER)(MemoryDescriptorList + 1);
04466 
04467     ExAcquireFastMutex (&amp;MmDynamicMemoryMutex);
04468 
04469     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
04470 
04471     MaxPages = <a class="code" href="../../d4/d8/mi_8h.html#a323">MI_NONPAGABLE_MEMORY_AVAILABLE</a>() - 1024;
04472 
04473     <span class="keywordflow">if</span> ((SPFN_NUMBER)MaxPages &lt;= 0) {
04474         SizeInPages = 0;
04475     }
04476     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (SizeInPages &gt; MaxPages) {
04477         SizeInPages = MaxPages;
04478     }
04479 
04480     <span class="keywordflow">if</span> (SizeInPages == 0) {
04481         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
04482         ExReleaseFastMutex (&amp;MmDynamicMemoryMutex);
04483         <a class="code" href="../../d5/d6/iosup_8c.html#a81">MmUnlockPagableImageSection</a> (ExPageLockHandle);
04484         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (MemoryDescriptorList);
04485         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (ColorAnchorsHead);
04486         <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a>)0;
04487     }
04488 
04489     <span class="comment">//</span>
04490     <span class="comment">// Ensure there is enough commit prior to allocating the pages as this</span>
04491     <span class="comment">// is not a nonpaged pool allocation but rather a dynamic MDL allocation.</span>
04492     <span class="comment">//</span>
04493 
04494     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d1/mmquota_8c.html#a18">MiChargeCommitmentCantExpand</a> (SizeInPages, FALSE) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
04495         <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
04496         ExReleaseFastMutex (&amp;MmDynamicMemoryMutex);
04497         <a class="code" href="../../d5/d6/iosup_8c.html#a81">MmUnlockPagableImageSection</a> (ExPageLockHandle);
04498         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (MemoryDescriptorList);
04499         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (ColorAnchorsHead);
04500         <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a>)0;
04501     }
04502 
04503     <a class="code" href="../../d4/d8/mi_8h.html#a254">MM_TRACK_COMMIT</a> (MM_DBG_COMMIT_MDL_PAGES, SizeInPages);
04504 
04505     <span class="keywordflow">if</span> ((<a class="code" href="../../d5/d6/iosup_8c.html#a24">MiLastCallLowPage</a> != LowPage) || (<a class="code" href="../../d5/d6/iosup_8c.html#a25">MiLastCallHighPage</a> != HighPage)) {
04506         <a class="code" href="../../d5/d6/iosup_8c.html#a26">MiLastCallColor</a> = 0;
04507     }
04508 
04509     <a class="code" href="../../d5/d6/iosup_8c.html#a24">MiLastCallLowPage</a> = LowPage;
04510     <a class="code" href="../../d5/d6/iosup_8c.html#a25">MiLastCallHighPage</a> = HighPage;
04511 
04512     FirstMdlPageToZero = MdlPage;
04513 
04514     <span class="keywordflow">do</span> {
04515         <span class="comment">//</span>
04516         <span class="comment">// Grab all zeroed (and then free) pages first directly from the</span>
04517         <span class="comment">// colored lists to avoid multiple walks down these singly linked lists.</span>
04518         <span class="comment">// Then snatch transition pages as needed.  In addition to optimizing</span>
04519         <span class="comment">// the speed of the removals this also avoids cannibalizing the page</span>
04520         <span class="comment">// cache unless it's absolutely needed.</span>
04521         <span class="comment">//</span>
04522 
04523         <span class="keywordflow">for</span> (MemoryList = <a class="code" href="../../d2/d1/mm_8h.html#a345a171">ZeroedPageList</a>; MemoryList &lt;= <a class="code" href="../../d2/d1/mm_8h.html#a345a172">FreePageList</a>; MemoryList += 1) {
04524 
04525             ListHead = <a class="code" href="../../d4/d8/mi_8h.html#a606">MmPageLocationList</a>[MemoryList];
04526 
04527             FullAnchorCount = 0;
04528 
04529             <span class="keywordflow">for</span> (Color = 0; Color &lt; <a class="code" href="../../d8/d0/cmdat3_8c.html#a25">MmSecondaryColors</a>; Color += 1) {
04530                 ColorAnchorsHead[Color] = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>;
04531             }
04532 
04533             Color = <a class="code" href="../../d5/d6/iosup_8c.html#a26">MiLastCallColor</a>;
04534             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Color &lt; MmSecondaryColors);
04535 
04536             <span class="keywordflow">do</span> {
04537 
04538                 ColorHead = &amp;<a class="code" href="../../d4/d2/datalpha_8c.html#a20">MmFreePagesByColor</a>[MemoryList][Color];
04539                 ColorAnchor = &amp;ColorAnchorsHead[Color];
04540     
04541                 Color += 1;
04542                 <span class="keywordflow">if</span> (Color &gt;= <a class="code" href="../../d8/d0/cmdat3_8c.html#a25">MmSecondaryColors</a>) {
04543                     Color = 0;
04544                 }
04545 
04546                 <span class="keywordflow">if</span> (*ColorAnchor == (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a> - 1)) {
04547 
04548                     <span class="comment">//</span>
04549                     <span class="comment">// This colored list has already been completely searched.</span>
04550                     <span class="comment">//</span>
04551 
04552                     <span class="keywordflow">continue</span>;
04553                 }
04554 
04555                 <span class="keywordflow">if</span> (ColorHead-&gt;<a class="code" href="../../d4/d1/struct__MMCOLOR__TABLES.html#o0">Flink</a> == <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>) {
04556 
04557                     <span class="comment">//</span>
04558                     <span class="comment">// This colored list is empty.</span>
04559                     <span class="comment">//</span>
04560 
04561                     FullAnchorCount += 1;
04562                     *ColorAnchor = (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a> - 1);
04563                     <span class="keywordflow">continue</span>;
04564                 }
04565 
04566                 <span class="keywordflow">while</span> (ColorHead-&gt;<a class="code" href="../../d4/d1/struct__MMCOLOR__TABLES.html#o0">Flink</a> != <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>) {
04567     
04568                     Page = ColorHead-&gt;<a class="code" href="../../d4/d1/struct__MMCOLOR__TABLES.html#o0">Flink</a>;
04569         
04570                     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(Page);
04571 
04572                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((MMLISTS)Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation == MemoryList);
04573     
04574                     <span class="comment">//</span>
04575                     <span class="comment">// See if the page is within the caller's page constraints.</span>
04576                     <span class="comment">//</span>
04577 
04578                     PagePlacementOk = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04579 
04580                     LowPage1 = LowPage;
04581                     HighPage1 = HighPage;
04582 
04583                     <span class="keywordflow">do</span> {
04584                         <span class="keywordflow">if</span> ((Page &gt;= LowPage1) &amp;&amp; (Page &lt;= HighPage1)) {
04585                             PagePlacementOk = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04586                             <span class="keywordflow">break</span>;
04587                         }
04588 
04589                         <span class="keywordflow">if</span> (SkipPages == 0) {
04590                             <span class="keywordflow">break</span>;
04591                         }
04592 
04593                         LowPage1 += SkipPages;
04594                         HighPage1 += SkipPages;
04595 
04596                         <span class="keywordflow">if</span> (LowPage1 &gt; <a class="code" href="../../d6/d8/sysinfo_8c.html#a7">MmHighestPhysicalPage</a>) {
04597                             <span class="keywordflow">break</span>;
04598                         }
04599                         <span class="keywordflow">if</span> (HighPage1 &gt; <a class="code" href="../../d6/d8/sysinfo_8c.html#a7">MmHighestPhysicalPage</a>) {
04600                             HighPage1 = <a class="code" href="../../d6/d8/sysinfo_8c.html#a7">MmHighestPhysicalPage</a>;
04601                         }
04602                     } <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
04603                 
04604                     <span class="comment">// </span>
04605                     <span class="comment">// The Flink and Blink must be nonzero here for the page</span>
04606                     <span class="comment">// to be on the listhead.  Only code that scans the</span>
04607                     <span class="comment">// MmPhysicalMemoryBlock has to check for the zero case.</span>
04608                     <span class="comment">//</span>
04609 
04610                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Flink != 0);
04611                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.Blink != 0);
04612 
04613                     <span class="keywordflow">if</span> (PagePlacementOk == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
04614 
04615                         <span class="comment">//</span>
04616                         <span class="comment">// Put page on end of list and if first time, save pfn.</span>
04617                         <span class="comment">//</span>
04618     
04619                         <span class="keywordflow">if</span> (*ColorAnchor == <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>) {
04620                             *ColorAnchor = Page;
04621                         }
04622                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Page == *ColorAnchor) {
04623 
04624                             <span class="comment">//</span>
04625                             <span class="comment">// No more pages available in this colored chain.</span>
04626                             <span class="comment">//</span>
04627 
04628                             FullAnchorCount += 1;
04629                             *ColorAnchor = (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a> - 1);
04630                             <span class="keywordflow">break</span>;
04631                         }
04632 
04633                         <span class="comment">//</span>
04634                         <span class="comment">// If the colored chain has more than one entry then</span>
04635                         <span class="comment">// put this page on the end.</span>
04636                         <span class="comment">//</span>
04637 
04638                         PageNextColored = (PFN_NUMBER)Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long;
04639 
04640                         <span class="keywordflow">if</span> (PageNextColored == <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>) {
04641 
04642                             <span class="comment">//</span>
04643                             <span class="comment">// No more pages available in this colored chain.</span>
04644                             <span class="comment">//</span>
04645 
04646                             FullAnchorCount += 1;
04647                             *ColorAnchor = (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a> - 1);
04648                             <span class="keywordflow">break</span>;
04649                         }
04650 
04651                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Flink != 0);
04652                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Flink != MM_EMPTY_LIST);
04653                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> != MI_MAGIC_AWE_PTEFRAME);
04654 
04655                         PfnNextColored = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(PageNextColored);
04656                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((MMLISTS)PfnNextColored-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation == MemoryList);
04657                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PfnNextColored-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> != MI_MAGIC_AWE_PTEFRAME);
04658 
04659                         <span class="comment">//</span>
04660                         <span class="comment">// Adjust the free page list so Page</span>
04661                         <span class="comment">// follows PageNextFlink.</span>
04662                         <span class="comment">//</span>
04663 
04664                         PageNextFlink = Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Flink;
04665                         PfnNextFlink = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(PageNextFlink);
04666 
04667                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((MMLISTS)PfnNextFlink-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation == MemoryList);
04668                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PfnNextFlink-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> != MI_MAGIC_AWE_PTEFRAME);
04669 
04670                         PfnLastColored = ColorHead-&gt;<a class="code" href="../../d4/d1/struct__MMCOLOR__TABLES.html#o1">Blink</a>;
04671                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PfnLastColored != (<a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a>)MM_EMPTY_LIST);
04672                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PfnLastColored-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == MM_EMPTY_LIST);
04673                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PfnLastColored-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> != MI_MAGIC_AWE_PTEFRAME);
04674                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PfnLastColored-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.Blink != MM_EMPTY_LIST);
04675 
04676                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((MMLISTS)PfnLastColored-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation == MemoryList);
04677                         PageLastColored = PfnLastColored - <a class="code" href="../../d2/d3/dumpctl_8c.html#a15">MmPfnDatabase</a>;
04678 
04679                         <span class="keywordflow">if</span> (ListHead-&gt;<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o2">Flink</a> == Page) {
04680 
04681                             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.Blink == MM_EMPTY_LIST);
04682                             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ListHead-&gt;<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o3">Blink</a> != Page);
04683 
04684                             ListHead-&gt;<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o2">Flink</a> = PageNextFlink;
04685 
04686                             PfnNextFlink-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.Blink = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>;
04687                         }
04688                         <span class="keywordflow">else</span> {
04689 
04690                             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.Blink != MM_EMPTY_LIST);
04691                             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((MMLISTS)(<a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>((<a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.Blink)-&gt;u1.Flink)))-&gt;PteFrame != MI_MAGIC_AWE_PTEFRAME);
04692                             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((MMLISTS)(<a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>((<a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.Blink)-&gt;u1.Flink)))-&gt;u3.e1.PageLocation == MemoryList);
04693 
04694                             <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.Blink)-&gt;u1.Flink = PageNextFlink;
04695                             PfnNextFlink-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.Blink = Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.Blink;
04696                         }
04697 
04698 <span class="preprocessor">#if DBG</span>
04699 <span class="preprocessor"></span>                        <span class="keywordflow">if</span> (PfnLastColored-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Flink == <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>) {
04700                             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (ListHead-&gt;<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o3">Blink</a> == PageLastColored);
04701                         }
04702 <span class="preprocessor">#endif</span>
04703 <span class="preprocessor"></span>
04704                         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Flink = PfnLastColored-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Flink;
04705                         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.Blink = PageLastColored;
04706 
04707                         <span class="keywordflow">if</span> (ListHead-&gt;<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o3">Blink</a> == PageLastColored) {
04708                             ListHead-&gt;<a class="code" href="../../d0/d4/struct__MMPFNLIST.html#o3">Blink</a> = Page;
04709                         }
04710 
04711                         <span class="comment">//</span>
04712                         <span class="comment">// Adjust the colored chains.</span>
04713                         <span class="comment">//</span>
04714 
04715                         <span class="keywordflow">if</span> (PfnLastColored-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Flink != <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>) {
04716                             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(PfnLastColored-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Flink)-&gt;PteFrame != MI_MAGIC_AWE_PTEFRAME);
04717                             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((MMLISTS)(<a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(PfnLastColored-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Flink)-&gt;u3.e1.PageLocation) == MemoryList);
04718                             <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(PfnLastColored-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Flink)-&gt;u2.Blink = Page;
04719                         }
04720 
04721                         PfnLastColored-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Flink = Page;
04722 
04723                         ColorHead-&gt;<a class="code" href="../../d4/d1/struct__MMCOLOR__TABLES.html#o0">Flink</a> = PageNextColored;
04724                         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>;
04725 
04726                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PfnLastColored-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long == MM_EMPTY_LIST);
04727                         PfnLastColored-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = Page;
04728                         ColorHead-&gt;<a class="code" href="../../d4/d1/struct__MMCOLOR__TABLES.html#o1">Blink</a> = Pfn1;
04729 
04730                         <span class="keywordflow">continue</span>;
04731                     }
04732     
04733                     found += 1;
04734                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.ReadInProgress == 0);
04735                     <a class="code" href="../../d7/d5/pfnlist_8c.html#a12">MiUnlinkFreeOrZeroedPage</a> (Page);
04736                     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageColor = 0;
04737     
04738                     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount = 1;
04739                     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount = 1;
04740                     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a120">MI_SET_PFN_DELETED</a>(Pfn1);
04741                     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a95">MM_DEMAND_ZERO_WRITE_PTE</a>;
04742 <span class="preprocessor">#if DBG</span>
04743 <span class="preprocessor"></span>                    Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> = <a class="code" href="../../d4/d8/mi_8h.html#a170">MI_MAGIC_AWE_PTEFRAME</a>;
04744 <span class="preprocessor">#endif</span>
04745 <span class="preprocessor"></span>                    Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation = <a class="code" href="../../d2/d1/mm_8h.html#a345a177">ActiveAndValid</a>;
04746     
04747                     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.StartOfAllocation = 1;
04748                     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.EndOfAllocation = 1;
04749                     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.VerifierAllocation = 0;
04750                     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.LargeSessionAllocation = 0;
04751     
04752                     *MdlPage = Page;
04753                     MdlPage += 1;
04754     
04755                     <span class="keywordflow">if</span> (found == SizeInPages) {
04756     
04757                         <span class="comment">//</span>
04758                         <span class="comment">// All the pages requested are available.</span>
04759                         <span class="comment">//</span>
04760 
04761                         <span class="keywordflow">if</span> (MemoryList == <a class="code" href="../../d2/d1/mm_8h.html#a345a171">ZeroedPageList</a>) {
04762                             FirstMdlPageToZero = MdlPage;
04763                             <a class="code" href="../../d5/d6/iosup_8c.html#a26">MiLastCallColor</a> = Color;
04764                         }
04765     
04766 <span class="preprocessor">#if DBG</span>
04767 <span class="preprocessor"></span>                        FinishedCount = 0;
04768                         <span class="keywordflow">for</span> (Color = 0; Color &lt; <a class="code" href="../../d8/d0/cmdat3_8c.html#a25">MmSecondaryColors</a>; Color += 1) {
04769                             <span class="keywordflow">if</span> (ColorAnchorsHead[Color] == (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a> - 1)) {
04770                                 FinishedCount += 1;
04771                             }
04772                         }
04773                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (FinishedCount == FullAnchorCount);
04774 <span class="preprocessor">#endif</span>
04775 <span class="preprocessor"></span>
04776                         <span class="keywordflow">goto</span> pass2_done;
04777                     }
04778     
04779                     <span class="comment">//</span>
04780                     <span class="comment">// March on to the next colored chain so the overall</span>
04781                     <span class="comment">// allocation round-robins the page colors.</span>
04782                     <span class="comment">//</span>
04783 
04784                     <span class="keywordflow">break</span>;
04785                 }
04786 
04787             } <span class="keywordflow">while</span> (FullAnchorCount != <a class="code" href="../../d8/d0/cmdat3_8c.html#a25">MmSecondaryColors</a>);
04788 
04789 <span class="preprocessor">#if DBG</span>
04790 <span class="preprocessor"></span>            FinishedCount = 0;
04791             <span class="keywordflow">for</span> (Color = 0; Color &lt; <a class="code" href="../../d8/d0/cmdat3_8c.html#a25">MmSecondaryColors</a>; Color += 1) {
04792                 <span class="keywordflow">if</span> (ColorAnchorsHead[Color] == (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a> - 1)) {
04793                     FinishedCount += 1;
04794                 }
04795             }
04796             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (FinishedCount == FullAnchorCount);
04797 <span class="preprocessor">#endif</span>
04798 <span class="preprocessor"></span>
04799             <span class="keywordflow">if</span> (MemoryList == <a class="code" href="../../d2/d1/mm_8h.html#a345a171">ZeroedPageList</a>) {
04800                 FirstMdlPageToZero = MdlPage;
04801             }
04802 
04803             <a class="code" href="../../d5/d6/iosup_8c.html#a26">MiLastCallColor</a> = 0;
04804         }
04805 
04806         start = 0;
04807 
04808         <span class="keywordflow">do</span> {
04809 
04810             count = <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o2">Run</a>[start].<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html#o1">PageCount</a>;
04811             Page = <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o2">Run</a>[start].<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html#o0">BasePage</a>;
04812 
04813             <span class="keywordflow">if</span> (count != 0) {
04814 
04815                 <span class="comment">//</span>
04816                 <span class="comment">// Close the gaps, then examine the range for a fit.</span>
04817                 <span class="comment">//</span>
04818 
04819                 LastPage = Page + count;
04820 
04821                 <span class="keywordflow">if</span> (LastPage - 1 &gt; HighPage) {
04822                     LastPage = HighPage + 1;
04823                 }
04824             
04825                 <span class="keywordflow">if</span> (Page &lt; LowPage) {
04826                     Page = LowPage;
04827                 }
04828 
04829                 <span class="keywordflow">if</span> ((Page &lt; LastPage) &amp;&amp;
04830                     (Page &gt;= <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o2">Run</a>[start].<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html#o0">BasePage</a>) &amp;&amp;
04831                     (LastPage &lt;= <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o2">Run</a>[start].<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html#o0">BasePage</a> +
04832                         <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o2">Run</a>[start].<a class="code" href="../../d5/d5/struct__PHYSICAL__MEMORY__RUN.html#o1">PageCount</a>)) {
04833 
04834                     Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (Page);
04835                     <span class="keywordflow">do</span> {
04836     
04837                         <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation == <a class="code" href="../../d2/d1/mm_8h.html#a345a173">StandbyPageList</a>) {
04838     
04839                             <span class="keywordflow">if</span> ((Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o5">u1</a>.Flink != 0) &amp;&amp;
04840                                 (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.Blink != 0) &amp;&amp;
04841                                 (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount == 0)) {
04842     
04843                                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.ReadInProgress == 0);
04844 
04845                                 found += 1;
04846     
04847                                 <span class="comment">//</span>
04848                                 <span class="comment">// This page is in the desired range - grab it.</span>
04849                                 <span class="comment">//</span>
04850     
04851                                 <a class="code" href="../../d7/d5/pfnlist_8c.html#a11">MiUnlinkPageFromList</a> (Pfn1);
04852                                 <a class="code" href="../../d0/d2/mmsup_8c.html#a15">MiRestoreTransitionPte</a> (Page);
04853     
04854                                 Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageColor = 0;
04855     
04856                                 Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount = 1;
04857                                 Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount = 1;
04858                                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a120">MI_SET_PFN_DELETED</a>(Pfn1);
04859                                 Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a95">MM_DEMAND_ZERO_WRITE_PTE</a>;
04860 <span class="preprocessor">#if DBG</span>
04861 <span class="preprocessor"></span>                                Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> = <a class="code" href="../../d4/d8/mi_8h.html#a170">MI_MAGIC_AWE_PTEFRAME</a>;
04862 <span class="preprocessor">#endif</span>
04863 <span class="preprocessor"></span>                                Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation = <a class="code" href="../../d2/d1/mm_8h.html#a345a177">ActiveAndValid</a>;
04864     
04865                                 Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.StartOfAllocation = 1;
04866                                 Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.EndOfAllocation = 1;
04867                                 Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.VerifierAllocation = 0;
04868                                 Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.LargeSessionAllocation = 0;
04869     
04870                                 *MdlPage = Page;
04871                                 MdlPage += 1;
04872     
04873                                 <span class="keywordflow">if</span> (found == SizeInPages) {
04874 
04875                                     <span class="comment">//</span>
04876                                     <span class="comment">// All the pages requested are available.</span>
04877                                     <span class="comment">//</span>
04878     
04879                                     <span class="keywordflow">goto</span> pass2_done;
04880                                 }
04881                             }
04882                         }
04883                         Page += 1;
04884                         Pfn1 += 1;
04885     
04886                     } <span class="keywordflow">while</span> (Page &lt; LastPage);
04887                 }
04888             }
04889             start += 1;
04890         } <span class="keywordflow">while</span> (start != <a class="code" href="../../d2/d1/mm_8h.html#a131">MmPhysicalMemoryBlock</a>-&gt;<a class="code" href="../../d3/d5/struct__PHYSICAL__MEMORY__DESCRIPTOR.html#o0">NumberOfRuns</a>);
04891 
04892         <span class="keywordflow">if</span> (SkipPages == 0) {
04893             <span class="keywordflow">break</span>;
04894         }
04895         LowPage += SkipPages;
04896         HighPage += SkipPages;
04897         <span class="keywordflow">if</span> (LowPage &gt; <a class="code" href="../../d6/d8/sysinfo_8c.html#a7">MmHighestPhysicalPage</a>) {
04898             <span class="keywordflow">break</span>;
04899         }
04900         <span class="keywordflow">if</span> (HighPage &gt; <a class="code" href="../../d6/d8/sysinfo_8c.html#a7">MmHighestPhysicalPage</a>) {
04901             HighPage = <a class="code" href="../../d6/d8/sysinfo_8c.html#a7">MmHighestPhysicalPage</a>;
04902         }
04903     } <span class="keywordflow">while</span> (1);
04904 
04905 pass2_done:
04906 
04907     <a class="code" href="../../d5/d6/iosup_8c.html#a17">MmMdlPagesAllocated</a> += found;
04908 
04909     <a class="code" href="../../d8/d5/kddata_8c.html#a42">MmResidentAvailablePages</a> -= found;
04910     <a class="code" href="../../d4/d8/mi_8h.html#a322">MM_BUMP_COUNTER</a>(34, found);
04911 
04912     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
04913 
04914     ExReleaseFastMutex (&amp;MmDynamicMemoryMutex);
04915     <a class="code" href="../../d5/d6/iosup_8c.html#a81">MmUnlockPagableImageSection</a> (ExPageLockHandle);
04916 
04917     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (ColorAnchorsHead);
04918 
04919     <span class="keywordflow">if</span> (found != SizeInPages) {
04920         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (found &lt; SizeInPages);
04921         <a class="code" href="../../d6/d1/mmquota_8c.html#a19">MiReturnCommitment</a> (SizeInPages - found);
04922         <a class="code" href="../../d4/d8/mi_8h.html#a254">MM_TRACK_COMMIT</a> (MM_DBG_COMMIT_MDL_PAGES, 0 - (SizeInPages - found));
04923     }
04924 
04925     <span class="keywordflow">if</span> (found == 0) {
04926         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (MemoryDescriptorList);
04927         <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a>)0;
04928     }
04929 
04930     MemoryDescriptorList-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o6">ByteCount</a> = (ULONG)(found &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
04931 
04932     <span class="keywordflow">if</span> (found != SizeInPages) {
04933         *MdlPage = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>;
04934     }
04935 
04936     <span class="comment">//</span>
04937     <span class="comment">// If the number of pages allocated was substantially less than the</span>
04938     <span class="comment">// initial request amount, attempt to allocate a smaller MDL to save</span>
04939     <span class="comment">// pool.</span>
04940     <span class="comment">//</span>
04941 
04942     <span class="keywordflow">if</span> ((MdlPageSpan - found) &gt; ((4 * <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>) / <span class="keyword">sizeof</span> (PFN_NUMBER))) {
04943         MemoryDescriptorList2 = <a class="code" href="../../d5/d6/iosup_8c.html#a73">MmCreateMdl</a> ((<a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a>)0,
04944                                              (PVOID)0,
04945                                              found &lt;&lt; PAGE_SHIFT);
04946     
04947         <span class="keywordflow">if</span> (MemoryDescriptorList2 != (<a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a>)0) {
04948             RtlMoveMemory ((PVOID)(MemoryDescriptorList2 + 1),
04949                            (PVOID)(MemoryDescriptorList + 1),
04950                            found * <span class="keyword">sizeof</span> (PFN_NUMBER));
04951             FirstMdlPageToZero = (PPFN_NUMBER)(MemoryDescriptorList2 + 1) +
04952                                  (FirstMdlPageToZero -
04953                                     (PPFN_NUMBER)(MemoryDescriptorList + 1));
04954             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (MemoryDescriptorList);
04955             MemoryDescriptorList = MemoryDescriptorList2;
04956         }
04957     }
04958 
04959     MdlPage = (PPFN_NUMBER)(MemoryDescriptorList + 1);
04960     LastMdlPage = MdlPage + found;
04961 
04962 <span class="preprocessor">#if DBG</span>
04963 <span class="preprocessor"></span>    <span class="comment">//</span>
04964     <span class="comment">// Ensure all pages are within the caller's page constraints.</span>
04965     <span class="comment">//</span>
04966 
04967     LowPage = (PFN_NUMBER)(LowAddress.QuadPart &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
04968     HighPage = (PFN_NUMBER)(HighAddress.QuadPart &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
04969 
04970     <span class="keywordflow">while</span> (MdlPage &lt; FirstMdlPageToZero) {
04971         Page = *MdlPage;
04972         PagePlacementOk = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04973         LowPage1 = LowPage;
04974         HighPage1 = HighPage;
04975 
04976         <span class="keywordflow">do</span> {
04977             <span class="keywordflow">if</span> ((Page &gt;= LowPage1) &amp;&amp; (Page &lt;= HighPage1)) {
04978                 PagePlacementOk = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04979                 <span class="keywordflow">break</span>;
04980             }
04981 
04982             <span class="keywordflow">if</span> (SkipPages == 0) {
04983                 <span class="keywordflow">break</span>;
04984             }
04985 
04986             LowPage1 += SkipPages;
04987             HighPage1 += SkipPages;
04988 
04989             <span class="keywordflow">if</span> (LowPage1 &gt; <a class="code" href="../../d6/d8/sysinfo_8c.html#a7">MmHighestPhysicalPage</a>) {
04990                 <span class="keywordflow">break</span>;
04991             }
04992             <span class="keywordflow">if</span> (HighPage1 &gt; <a class="code" href="../../d6/d8/sysinfo_8c.html#a7">MmHighestPhysicalPage</a>) {
04993                 HighPage1 = <a class="code" href="../../d6/d8/sysinfo_8c.html#a7">MmHighestPhysicalPage</a>;
04994             }
04995         } <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
04996 
04997         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PagePlacementOk == TRUE);
04998         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(*MdlPage);
04999         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> == MI_MAGIC_AWE_PTEFRAME);
05000         MdlPage += 1;
05001     }
05002 <span class="preprocessor">#endif</span>
05003 <span class="preprocessor"></span>
05004     <span class="keywordflow">while</span> (FirstMdlPageToZero &lt; LastMdlPage) {
05005 
05006 <span class="preprocessor">#if DBG</span>
05007 <span class="preprocessor"></span>        <span class="comment">//</span>
05008         <span class="comment">// Ensure all pages are within the caller's page constraints.</span>
05009         <span class="comment">//</span>
05010 
05011         Page = *FirstMdlPageToZero;
05012 
05013         PagePlacementOk = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05014         LowPage1 = LowPage;
05015         HighPage1 = HighPage;
05016 
05017         <span class="keywordflow">do</span> {
05018             <span class="keywordflow">if</span> ((Page &gt;= LowPage1) &amp;&amp; (Page &lt;= HighPage1)) {
05019                 PagePlacementOk = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
05020                 <span class="keywordflow">break</span>;
05021             }
05022 
05023             <span class="keywordflow">if</span> (SkipPages == 0) {
05024                 <span class="keywordflow">break</span>;
05025             }
05026 
05027             LowPage1 += SkipPages;
05028             HighPage1 += SkipPages;
05029 
05030             <span class="keywordflow">if</span> (LowPage1 &gt; <a class="code" href="../../d6/d8/sysinfo_8c.html#a7">MmHighestPhysicalPage</a>) {
05031                 <span class="keywordflow">break</span>;
05032             }
05033             <span class="keywordflow">if</span> (HighPage1 &gt; <a class="code" href="../../d6/d8/sysinfo_8c.html#a7">MmHighestPhysicalPage</a>) {
05034                 HighPage1 = <a class="code" href="../../d6/d8/sysinfo_8c.html#a7">MmHighestPhysicalPage</a>;
05035             }
05036         } <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
05037 
05038         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PagePlacementOk == TRUE);
05039         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a>(*FirstMdlPageToZero);
05040         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> == MI_MAGIC_AWE_PTEFRAME);
05041 <span class="preprocessor">#endif</span>
05042 <span class="preprocessor"></span>        <a class="code" href="../../d0/d2/mmsup_8c.html#a14">MiZeroPhysicalPage</a> (*FirstMdlPageToZero, 0);
05043         FirstMdlPageToZero += 1;
05044     }
05045 
05046     <span class="keywordflow">return</span> MemoryDescriptorList;
05047 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a46" doxytag="iosup.c::MmBuildMdlForNonPagedPool" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MmBuildMdlForNonPagedPool           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT <a class="el" href="../../d6/d7/struct__MDL.html">PMDL</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>MemoryDescriptorList</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l01500">1500</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00424">MDL_MAPPED_TO_SYSTEM_VA</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00425">MDL_PAGES_LOCKED</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00428">MDL_PARTIAL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00426">MDL_SOURCE_IS_NONPAGED_POOL</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02287">MI_CONVERT_PHYSICAL_TO_PFN</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02410">MI_GET_PAGE_FRAME_FROM_PTE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02262">MI_IS_PHYSICAL_ADDRESS</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d1/d1/mmsup_8c-source.html#l01460">MmIsNonPagedSystemAddressValid()</a>, and <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>.
<p>
Referenced by <a class="el" href="../../d6/d7/fssup_8c-source.html#l02952">CcZeroData()</a>, <a class="el" href="../../d1/d7/creasect_8c-source.html#l01424">MiCreateImageFileMap()</a>, and <a class="el" href="../../d4/d6/deviosup_8c-source.html#l00883">UdfPrepareBuffers()</a>.
<p>
<pre class="fragment"><div>01506                    :
01507 
01508     This routine fills in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="stringliteral">"pages"</span> portion of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d6/d7/struct__MDL.html">MDL</a> <span class="keyword">using</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PFN
01509     numbers corresponding <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffers which resides in non-paged <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a>.
01510 
01511     Unlike <a class="code" href="../../d2/d1/mm_8h.html#a273">MmProbeAndLockPages</a>, there <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> no corresponding unlock as no
01512     reference counts are incremented as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffers being in nonpaged
01513     <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> are always resident.
01514 
01515 Arguments:
01516 
01517     MemoryDescriptorList - Supplies a pointer to a Memory Descriptor <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>
01518                             (<a class="code" href="../../d6/d7/struct__MDL.html">MDL</a>). The supplied <a class="code" href="../../d6/d7/struct__MDL.html">MDL</a> must supply a <span class="keyword">virtual</span>
01519                             address, byte offset and length field.  The
01520                             physical page portion of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d6/d7/struct__MDL.html">MDL</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> updated when
01521                             <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pages are locked in memory.  The <span class="keyword">virtual</span>
01522                             address must be within <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> non-paged portion
01523                             of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system space.
01524 
01525 Return Value:
01526 
01527     None.
01528 
01529 Environment:
01530 
01531     Kernel mode, IRQL of <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a> or below.
01532 
01533 --*/
01534 
01535 {
01536     PPFN_NUMBER Page;
01537     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
01538     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastPte;
01539     PVOID EndVa;
01540     PFN_NUMBER PageFrameIndex;
01541 
01542     Page = (PPFN_NUMBER)(MemoryDescriptorList + 1);
01543 
01544     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (MemoryDescriptorList-&gt;ByteCount != 0);
01545     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((MemoryDescriptorList-&gt;MdlFlags &amp; (
01546                     MDL_PAGES_LOCKED |
01547                     MDL_MAPPED_TO_SYSTEM_VA |
01548                     MDL_SOURCE_IS_NONPAGED_POOL |
01549                     MDL_PARTIAL)) == 0);
01550 
01551     MemoryDescriptorList-&gt;Process = (<a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01552 
01553     <span class="comment">//</span>
01554     <span class="comment">// Endva is last byte of the buffer.</span>
01555     <span class="comment">//</span>
01556 
01557     MemoryDescriptorList-&gt;MdlFlags |= <a class="code" href="../../d0/d9/ntosdef_8h.html#a14">MDL_SOURCE_IS_NONPAGED_POOL</a>;
01558 
01559     MemoryDescriptorList-&gt;MappedSystemVa =
01560             (PVOID)((PCHAR)MemoryDescriptorList-&gt;StartVa +
01561                                            MemoryDescriptorList-&gt;ByteOffset);
01562 
01563     EndVa = (PVOID)(((PCHAR)MemoryDescriptorList-&gt;MappedSystemVa +
01564                             MemoryDescriptorList-&gt;ByteCount - 1));
01565 
01566     LastPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (EndVa);
01567 
01568     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (MmIsNonPagedSystemAddressValid (MemoryDescriptorList-&gt;StartVa));
01569 
01570     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (MemoryDescriptorList-&gt;StartVa);
01571 
01572     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a178">MI_IS_PHYSICAL_ADDRESS</a>(EndVa)) {
01573         PageFrameIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a179">MI_CONVERT_PHYSICAL_TO_PFN</a> (
01574                                 MemoryDescriptorList-&gt;StartVa);
01575 
01576         <span class="keywordflow">do</span> {
01577             *Page = PageFrameIndex;
01578             Page += 1;
01579             PageFrameIndex += 1;
01580             PointerPte += 1;
01581         } <span class="keywordflow">while</span> (PointerPte &lt;= LastPte);
01582     } <span class="keywordflow">else</span> {
01583         <span class="keywordflow">do</span> {
01584             PageFrameIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (PointerPte);
01585             *Page = PageFrameIndex;
01586             Page += 1;
01587             PointerPte += 1;
01588         } <span class="keywordflow">while</span> (PointerPte &lt;= LastPte);
01589     }
01590 
01591     <span class="keywordflow">return</span>;
01592 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a73" doxytag="iosup.c::MmCreateMdl" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d6/d7/struct__MDL.html">PMDL</a> MmCreateMdl           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d6/d7/struct__MDL.html">PMDL</a> MemoryDescriptorList&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Base</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN SIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l05852">5852</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
References <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l01789">MmInitializeMdl</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l05815">MmSizeOfMdl()</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a175">NonPagedPoolMustSucceed</a>, and <a class="el" href="../../d6/d1/poolhack_8c-source.html#l00117">POOL_BUDDY_MAX</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l01519">IoWriteCrashDump()</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l01095">MiCheckForCrashDump()</a>, <a class="el" href="../../d1/d7/creasect_8c-source.html#l01424">MiCreateImageFileMap()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l04270">MmAllocatePagesForMdl()</a>, and <a class="el" href="../../d9/d4/physical_8c-source.html#l01624">NtFreeUserPhysicalPages()</a>.
<p>
<pre class="fragment"><div>05860                    :
05861 
05862     This function optionally allocates and initializes an <a class="code" href="../../d6/d7/struct__MDL.html">MDL</a>.
05863 
05864 Arguments:
05865 
05866     MemoryDescriptorList - Optionally supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d6/d7/struct__MDL.html">MDL</a>
05867                            to initialize.  If <span class="keyword">this</span> address <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> supplied as <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
05868                            an <a class="code" href="../../d6/d7/struct__MDL.html">MDL</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> allocated from non-paged <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> and
05869                            initialized.
05870 
05871     Base - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base <span class="keyword">virtual</span> address <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer.
05872 
05873     Length - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer in bytes.
05874 
05875 Return Value:
05876 
05877     Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> initialized <a class="code" href="../../d6/d7/struct__MDL.html">MDL</a>.
05878 
05879 Environment:
05880 
05881     Kernel mode, IRQL of <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a> or below.
05882 
05883 --*/
05884 
05885 {
05886     SIZE_T MdlSize;
05887 
05888     MdlSize = <a class="code" href="../../d5/d6/iosup_8c.html#a72">MmSizeOfMdl</a>( Base, Length );
05889 
05890     <span class="keywordflow">if</span> (!ARGUMENT_PRESENT( MemoryDescriptorList )) {
05891 
05892         <span class="comment">//</span>
05893         <span class="comment">// The pool manager doesn't like being called with large requests</span>
05894         <span class="comment">// marked MustSucceed, so try the normal nonpaged if the</span>
05895         <span class="comment">// request is large.</span>
05896         <span class="comment">//</span>
05897 
05898         <span class="keywordflow">if</span> (MdlSize &gt; <a class="code" href="../../d5/d2/poolhack_8c.html#a7">POOL_BUDDY_MAX</a>) {
05899             MemoryDescriptorList = (<a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a>)<a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (
05900                                                      NonPagedPool,
05901                                                      MdlSize,
05902                                                      'ldmM');
05903             <span class="keywordflow">if</span> (MemoryDescriptorList == (<a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a>)0) {
05904                 <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a>)0;
05905             }
05906         }
05907         <span class="keywordflow">else</span> {
05908             MemoryDescriptorList = (<a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a>)<a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (
05909                                                      NonPagedPoolMustSucceed,
05910                                                      MdlSize,
05911                                                      'ldmM');
05912         }
05913     }
05914 
05915     <a class="code" href="../../d2/d1/mm_8h.html#a24">MmInitializeMdl</a> (MemoryDescriptorList, Base, Length);
05916     <span class="keywordflow">return</span> MemoryDescriptorList;
05917 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a66" doxytag="iosup.c::MmFreeContiguousMemory" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MmFreeContiguousMemory           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>BaseAddress</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l05372">5372</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
References <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d4/d5/procsup_8c.html#a28">MiFreeLowMemory()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l00141">MiNoLowMemory</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l01300">IoFreeDumpStack()</a>, <a class="el" href="../../d3/d0/largepag_8c-source.html#l00646">Ki386ClearIdentityMap()</a>, and <a class="el" href="../../d6/d5/iosup_8c-source.html#l03744">MmAllocateContiguousMemorySpecifyCache()</a>.
<p>
<pre class="fragment"><div>05378                    :
05379 
05380     This function deallocates a range of physically contiguous non-paged
05381     <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> which was allocated with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d1/mm_8h.html#a293">MmAllocateContiguousMemory</a> function.
05382 
05383 Arguments:
05384 
05385     BaseAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base <span class="keyword">virtual</span> address where <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> physical
05386                   address was previously mapped.
05387 
05388 Return Value:
05389 
05390     None.
05391 
05392 Environment:
05393 
05394     Kernel mode, IRQL of <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a> or below.
05395 
05396 --*/
05397 
05398 {
05399     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
05400 
05401 <span class="preprocessor">#if defined (_X86PAE_)</span>
05402 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/iosup_8c.html#a15">MiNoLowMemory</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
05403         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d5/procsup_8c.html#a28">MiFreeLowMemory</a> (BaseAddress, 'tnoC') == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
05404             <span class="keywordflow">return</span>;
05405         }
05406     }
05407 <span class="preprocessor">#endif</span>
05408 <span class="preprocessor"></span>
05409     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (BaseAddress);
05410 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a67" doxytag="iosup.c::MmFreeContiguousMemorySpecifyCache" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MmFreeContiguousMemorySpecifyCache           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>BaseAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN SIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>NumberOfBytes</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d4/d9/ke_8h.html#a156">MEMORY_CACHING_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>CacheType</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l05414">5414</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d4/d5/procsup_8c.html#a28">MiFreeLowMemory()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l00141">MiNoLowMemory</a>, <a class="el" href="../../d4/d9/ke_8h.html#a413a249">MmCached</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00063">MmNonPagedSystemStart</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00079">MmNumberOfSystemPtes</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l03678">MmUnmapIoSpace()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>.
<p>
<pre class="fragment"><div>05422                    :
05423 
05424     This function deallocates a range of noncached memory in
05425     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> non-paged portion of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system address space.
05426 
05427 Arguments:
05428 
05429     BaseAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base <span class="keyword">virtual</span> address where <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> noncached
05430 
05431     NumberOfBytes - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of bytes allocated to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> request.
05432                     This must be <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> same number that was obtained with
05433                     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d1/mm_8h.html#a294">MmAllocateContiguousMemorySpecifyCache</a> call.
05434 
05435     CacheType - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> cachetype used when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
05436                 <a class="code" href="../../d2/d1/mm_8h.html#a294">MmAllocateContiguousMemorySpecifyCache</a> call.
05437 
05438 Return Value:
05439 
05440     None.
05441 
05442 Environment:
05443 
05444     Kernel mode, IRQL of <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a> or below.
05445 
05446 --*/
05447 
05448 {
05449     PVOID PoolAddress;
05450     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
05451 
05452     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
05453 
05454     <span class="keywordflow">if</span> (CacheType != <a class="code" href="../../d4/d9/ke_8h.html#a413a249">MmCached</a>) {
05455 
05456         <span class="comment">//</span>
05457         <span class="comment">// The caller was using an alternate mapping - free these PTEs too.</span>
05458         <span class="comment">//</span>
05459 
05460         PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(BaseAddress);
05461 
05462         PointerPte += ((NumberOfBytes + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1) &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
05463         PoolAddress = (PVOID)(ULONG_PTR)PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long;
05464 
05465         PointerPte += 1;
05466         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (NumberOfBytes == PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long);
05467 
05468         NumberOfBytes += (2 * <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
05469         <a class="code" href="../../d5/d6/iosup_8c.html#a58">MmUnmapIoSpace</a> (BaseAddress, NumberOfBytes);
05470         BaseAddress = PoolAddress;
05471     }
05472     <span class="keywordflow">else</span> {
05473         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (BaseAddress &lt; MmNonPagedSystemStart ||
05474                 BaseAddress &gt;= (PVOID)((PCHAR)MmNonPagedSystemStart + (MmNumberOfSystemPtes &lt;&lt; PAGE_SHIFT)));
05475     }
05476 
05477 <span class="preprocessor">#if defined (_X86PAE_)</span>
05478 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/iosup_8c.html#a15">MiNoLowMemory</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
05479         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d5/procsup_8c.html#a28">MiFreeLowMemory</a> (BaseAddress, 'tnoC') == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
05480             <span class="keywordflow">return</span>;
05481         }
05482     }
05483 <span class="preprocessor">#endif</span>
05484 <span class="preprocessor"></span>
05485     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (BaseAddress);
05486 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a71" doxytag="iosup.c::MmFreeNonCachedMemory" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MmFreeNonCachedMemory           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>BaseAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN SIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>NumberOfBytes</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l05721">5721</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00141">BYTES_TO_PAGES</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l03321">ExPageLockHandle</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02410">MI_GET_PAGE_FRAME_FROM_PTE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02099">MI_MAKING_MULTIPLE_PTES_INVALID</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00909">MI_SET_PFN_DELETED</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02759">MiDecrementShareAndValidCount</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02757">MiDecrementShareCountOnly</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l01354">MiReleaseSystemPtes()</a>, <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00442">MiReturnCommitment()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04317">MM_BUMP_COUNTER</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04289">MM_DBG_COMMIT_RETURN_NONCACHED_PAGES</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04221">MM_TRACK_COMMIT</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l06284">MmLockPagableSectionByHandle()</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00086">MmResidentAvailablePages</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l07065">MmUnlockPagableImageSection()</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00190">PAGE_ALIGN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01298">_MMPFN::PteFrame</a>, <a class="el" href="../../d4/d8/mi_8h.html#a1003a769">SystemPteSpace</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o10">_MMPFN::u2</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>.
<p>
<pre class="fragment"><div>05728                    :
05729 
05730     This function deallocates a range of noncached memory in
05731     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> non-paged portion of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system address space.
05732 
05733 Arguments:
05734 
05735     BaseAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base <span class="keyword">virtual</span> address where <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> noncached
05736                   memory resides.
05737 
05738     NumberOfBytes - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of bytes allocated to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> request.
05739                     This must be <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> same number that was obtained with
05740                     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d1/mm_8h.html#a300">MmAllocateNonCachedMemory</a> call.
05741 
05742 Return Value:
05743 
05744     None.
05745 
05746 Environment:
05747 
05748     Kernel mode, IRQL of <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a> or below.
05749 
05750 --*/
05751 
05752 {
05753 
05754     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
05755     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
05756     PFN_NUMBER NumberOfPages;
05757     PFN_NUMBER i;
05758     PFN_NUMBER PageFrameIndex;
05759     KIRQL OldIrql;
05760 
05761     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (NumberOfBytes != 0);
05762     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PAGE_ALIGN (BaseAddress) == BaseAddress);
05763 
05764     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a173">MI_MAKING_MULTIPLE_PTES_INVALID</a> (TRUE);
05765 
05766     NumberOfPages = <a class="code" href="../../d2/d1/mm_8h.html#a5">BYTES_TO_PAGES</a>(NumberOfBytes);
05767 
05768     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (BaseAddress);
05769 
05770     i = NumberOfPages;
05771 
05772     <a class="code" href="../../d5/d6/iosup_8c.html#a76">MmLockPagableSectionByHandle</a> (ExPageLockHandle);
05773 
05774     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
05775 
05776     <span class="keywordflow">do</span> {
05777 
05778         PageFrameIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (PointerPte);
05779 
05780         <span class="comment">//</span>
05781         <span class="comment">// Mark the page for deletion when the reference count goes to zero.</span>
05782         <span class="comment">//</span>
05783 
05784         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
05785         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount == 1);
05786         <a class="code" href="../../d4/d8/mi_8h.html#a242">MiDecrementShareAndValidCount</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a>);
05787         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a120">MI_SET_PFN_DELETED</a> (Pfn1);
05788         <a class="code" href="../../d4/d8/mi_8h.html#a241">MiDecrementShareCountOnly</a> (PageFrameIndex);
05789         PointerPte += 1;
05790         i -= 1;
05791     } <span class="keywordflow">while</span> (i != 0);
05792 
05793     PointerPte -= NumberOfPages;
05794 
05795     <span class="comment">//</span>
05796     <span class="comment">// Update the count of available resident pages.</span>
05797     <span class="comment">//</span>
05798 
05799     <a class="code" href="../../d8/d5/kddata_8c.html#a42">MmResidentAvailablePages</a> += NumberOfPages;
05800     <a class="code" href="../../d4/d8/mi_8h.html#a322">MM_BUMP_COUNTER</a>(5, NumberOfPages);
05801 
05802     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
05803 
05804     <a class="code" href="../../d5/d6/iosup_8c.html#a81">MmUnlockPagableImageSection</a> (ExPageLockHandle);
05805 
05806     <a class="code" href="../../d0/d9/sysptes_8c.html#a26">MiReleaseSystemPtes</a> (PointerPte, (ULONG)NumberOfPages, SystemPteSpace);
05807 
05808     <a class="code" href="../../d6/d1/mmquota_8c.html#a19">MiReturnCommitment</a> (NumberOfPages);
05809     <a class="code" href="../../d4/d8/mi_8h.html#a254">MM_TRACK_COMMIT</a> (MM_DBG_COMMIT_RETURN_NONCACHED_PAGES, NumberOfPages);
05810 
05811     <span class="keywordflow">return</span>;
05812 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a64" doxytag="iosup.c::MmFreePagesFromMdl" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MmFreePagesFromMdl           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d6/d7/struct__MDL.html">PMDL</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>MemoryDescriptorList</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l05051">5051</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
References <a class="el" href="../../d3/d0/mm_8h-source.html#l00217">ADDRESS_AND_SIZE_TO_SPAN_PAGES</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00086">APC_LEVEL</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l03321">ExPageLockHandle</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00435">MDL_IO_SPACE</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00434">MDL_PHYSICAL_VIEW</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00934">MI_IS_PFN_DELETED</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01219">MI_MAGIC_AWE_PTEFRAME</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02099">MI_MAKING_MULTIPLE_PTES_INVALID</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01221">MI_PFN_IS_AWE</a>, <a class="el" href="../../d7/d4/pfndec_8c-source.html#l00167">MiDecrementReferenceCount()</a>, <a class="el" href="../../d7/d0/mmquota_8c-source.html#l00442">MiReturnCommitment()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04317">MM_BUMP_COUNTER</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04288">MM_DBG_COMMIT_RETURN_MDL_PAGES</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00107">MM_EMPTY_LIST</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04221">MM_TRACK_COMMIT</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00044">MmHighestPhysicalPage</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l06284">MmLockPagableSectionByHandle()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l00204">MmMdlPagesAllocated</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00086">MmResidentAvailablePages</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l07065">MmUnlockPagableImageSection()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d2/d1/mm_8h.html#a345a173">StandbyPageList</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o10">_MMPFN::u2</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>.
<p>
Referenced by <a class="el" href="../../d9/d4/physical_8c-source.html#l02313">MiCleanPhysicalProcessPages()</a>, <a class="el" href="../../d9/d4/physical_8c-source.html#l00970">NtAllocateUserPhysicalPages()</a>, and <a class="el" href="../../d9/d4/physical_8c-source.html#l01624">NtFreeUserPhysicalPages()</a>.
<p>
<pre class="fragment"><div>05057                    :
05058 
05059     This routine walks <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> argument <a class="code" href="../../d6/d7/struct__MDL.html">MDL</a> freeing each physical page back to
05060     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PFN database.  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> designed to free pages acquired via
05061     <a class="code" href="../../d2/d1/mm_8h.html#a284">MmAllocatePagesForMdl</a> <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a>.
05062 
05063 Arguments:
05064 
05065     MemoryDescriptorList - Supplies an <a class="code" href="../../d6/d7/struct__MDL.html">MDL</a> which contains <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pages to be freed.
05066 
05067 Return Value:
05068 
05069     None.
05070 
05071 Environment:
05072 
05073     Kernel mode, IRQL of <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a> or below.
05074 
05075 --*/
05076 {
05077     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
05078     KIRQL OldIrql;
05079     PVOID StartingAddress;
05080     PVOID AlignedVa;
05081     PPFN_NUMBER Page;
05082     PFN_NUMBER NumberOfPages;
05083     PFN_NUMBER PagesFreed;
05084 
05085     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (KeGetCurrentIrql() &lt;= APC_LEVEL);
05086 
05087     PagesFreed = 0;
05088 
05089     <a class="code" href="../../d5/d6/iosup_8c.html#a76">MmLockPagableSectionByHandle</a> (ExPageLockHandle);
05090 
05091     Page = (PPFN_NUMBER)(MemoryDescriptorList + 1);
05092 
05093     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((MemoryDescriptorList-&gt;MdlFlags &amp; (MDL_IO_SPACE | MDL_PHYSICAL_VIEW)) == 0);
05094 
05095     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (((ULONG_PTR)MemoryDescriptorList-&gt;StartVa &amp; (PAGE_SIZE - 1)) == 0);
05096     AlignedVa = (PVOID)MemoryDescriptorList-&gt;StartVa;
05097 
05098     StartingAddress = (PVOID)((PCHAR)AlignedVa +
05099                     MemoryDescriptorList-&gt;ByteOffset);
05100 
05101     NumberOfPages = <a class="code" href="../../d2/d1/mm_8h.html#a8">ADDRESS_AND_SIZE_TO_SPAN_PAGES</a>(StartingAddress,
05102                                               MemoryDescriptorList-&gt;ByteCount);
05103 
05104     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a173">MI_MAKING_MULTIPLE_PTES_INVALID</a> (TRUE);
05105 
05106     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
05107 
05108     <span class="keywordflow">do</span> {
05109 
05110         <span class="keywordflow">if</span> (*Page == <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>) {
05111 
05112             <span class="comment">//</span>
05113             <span class="comment">// There are no more locked pages.</span>
05114             <span class="comment">//</span>
05115 
05116             <span class="keywordflow">break</span>;
05117         }
05118 
05119         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (*Page &lt;= MmHighestPhysicalPage);
05120 
05121         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (*Page);
05122         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount == 1);
05123         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (MI_IS_PFN_DELETED (Pfn1) == TRUE);
05124         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (MI_PFN_IS_AWE (Pfn1) == TRUE);
05125         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> == MI_MAGIC_AWE_PTEFRAME);
05126 
05127         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.StartOfAllocation = 0;
05128         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.EndOfAllocation = 0;
05129         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o10">u2</a>.ShareCount = 0;
05130 <span class="preprocessor">#if DBG</span>
05131 <span class="preprocessor"></span>        Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o17">PteFrame</a> -= 1;
05132         Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageLocation = <a class="code" href="../../d2/d1/mm_8h.html#a345a173">StandbyPageList</a>;
05133 <span class="preprocessor">#endif</span>
05134 <span class="preprocessor"></span>
05135         <a class="code" href="../../d6/d5/pfndec_8c.html#a2">MiDecrementReferenceCount</a> (*Page);
05136 
05137         PagesFreed += 1;
05138 
05139         StartingAddress = (PVOID)((PCHAR)StartingAddress + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
05140 
05141         *Page++ = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>;
05142         NumberOfPages -= 1;
05143 
05144     } <span class="keywordflow">while</span> (NumberOfPages != 0);
05145 
05146     <a class="code" href="../../d5/d6/iosup_8c.html#a17">MmMdlPagesAllocated</a> -= PagesFreed;
05147 
05148     <a class="code" href="../../d8/d5/kddata_8c.html#a42">MmResidentAvailablePages</a> += PagesFreed;
05149     <a class="code" href="../../d4/d8/mi_8h.html#a322">MM_BUMP_COUNTER</a>(35, PagesFreed);
05150 
05151     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
05152 
05153     <a class="code" href="../../d5/d6/iosup_8c.html#a81">MmUnlockPagableImageSection</a> (ExPageLockHandle);
05154 
05155     <a class="code" href="../../d6/d1/mmquota_8c.html#a19">MiReturnCommitment</a> (PagesFreed);
05156     <a class="code" href="../../d4/d8/mi_8h.html#a254">MM_TRACK_COMMIT</a> (MM_DBG_COMMIT_RETURN_MDL_PAGES, PagesFreed);
05157 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a89" doxytag="iosup.c::MmGatherMemoryForHibernate" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI ULONG MmGatherMemoryForHibernate           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d6/d7/struct__MDL.html">PMDL</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Mdl</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>Wait</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l07930">7930</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00086">APC_LEVEL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00140">KeDelayExecutionThread()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00901">LOCK_PFN2</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00425">MDL_PAGES_LOCKED</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01013">MI_GET_PAGE_COLOR_FROM_PTE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00909">MI_SET_PFN_DELETED</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04555">MiDelayPageFaults</a>, <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l02715">MiEmptyAllWorkingSets()</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l04870">MiFlushAllPages()</a>, <a class="el" href="../../d8/d4/pfnlist_8c-source.html#l01395">MiRemoveAnyPage()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00217">Mm30Milliseconds</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00418">MM_DEMAND_ZERO_WRITE_PTE</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00134">MmAvailablePages</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01297">_MMPFN::OriginalPte</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o15">_MMPFN::u3</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l00905">UNLOCK_PFN2</a>.
<p>
<pre class="fragment"><div>07937                    :
07938 
07939     Finds enough memory to fill in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pages of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d6/d7/struct__MDL.html">MDL</a> <span class="keywordflow">for</span> power management
07940     hibernate function.
07941 
07942 Arguments:
07943 
07944     Mdl - Supplies an <a class="code" href="../../d6/d7/struct__MDL.html">MDL</a>, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> start VA field should be <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>.  The length
07945           field indicates how many pages to obtain.
07946 
07947     Wait - <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> to fail immediately <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pages aren'<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> available.
07948 
07949 Return Value:
07950 
07951     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d9/ntosdef_8h.html#a58">MDL</a> could be filled in, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise.
07952 
07953 Environment:
07954 
07955     Kernel mode, IRQL of <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a> or below.
07956 
07957 --*/
07958 
07959 {
07960     KIRQL OldIrql;
07961     PFN_NUMBER PagesNeeded;
07962     PPFN_NUMBER Pages;
07963     PFN_NUMBER i;
07964     PFN_NUMBER PageFrameIndex;
07965     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
07966     ULONG status;
07967 
07968     status = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
07969 
07970     PagesNeeded = Mdl-&gt;ByteCount &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
07971     Pages = (PPFN_NUMBER)(Mdl + 1);
07972 
07973     i = Wait ? 100 : 1;
07974 
07975     InterlockedIncrement (&amp;MiDelayPageFaults);
07976 
07977     <span class="keywordflow">do</span> {
07978 
07979         <a class="code" href="../../d4/d8/mi_8h.html#a130">LOCK_PFN2</a> (OldIrql);
07980         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a94">MmAvailablePages</a> &gt; PagesNeeded) {
07981 
07982             <span class="comment">//</span>
07983             <span class="comment">// Fill in the MDL.</span>
07984             <span class="comment">//</span>
07985 
07986             <span class="keywordflow">do</span> {
07987                 PageFrameIndex = <a class="code" href="../../d7/d5/pfnlist_8c.html#a15">MiRemoveAnyPage</a> (MI_GET_PAGE_COLOR_FROM_PTE (NULL));
07988                 Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
07989                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a120">MI_SET_PFN_DELETED</a> (Pfn1);
07990                 Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount += 1;
07991                 Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a95">MM_DEMAND_ZERO_WRITE_PTE</a>;
07992                 *Pages = PageFrameIndex;
07993                 Pages += 1;
07994                 PagesNeeded -= 1;
07995             } <span class="keywordflow">while</span> (PagesNeeded);
07996             <a class="code" href="../../d4/d8/mi_8h.html#a131">UNLOCK_PFN2</a> (OldIrql);
07997             Mdl-&gt;MdlFlags |= <a class="code" href="../../d0/d9/ntosdef_8h.html#a13">MDL_PAGES_LOCKED</a>;
07998             status = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
07999             <span class="keywordflow">break</span>;
08000         }
08001 
08002         <a class="code" href="../../d4/d8/mi_8h.html#a131">UNLOCK_PFN2</a> (OldIrql);
08003 
08004         <span class="comment">//</span>
08005         <span class="comment">// If we're being called at DISPATCH_LEVEL we cannot move pages to</span>
08006         <span class="comment">// the standby list because mutexes must be acquired to do so.</span>
08007         <span class="comment">//</span>
08008 
08009         <span class="keywordflow">if</span> (OldIrql &gt; <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>) {
08010             <span class="keywordflow">break</span>;
08011         }
08012 
08013         <span class="keywordflow">if</span> (!i) {
08014             <span class="keywordflow">break</span>;
08015         }
08016 
08017         <span class="comment">//</span>
08018         <span class="comment">// Attempt to move pages to the standby list.</span>
08019         <span class="comment">//</span>
08020 
08021         <a class="code" href="../../d5/d0/wsmanage_8c.html#a47">MiEmptyAllWorkingSets</a> ();
08022         <a class="code" href="../../d6/d3/modwrite_8c.html#a57">MiFlushAllPages</a>();
08023 
08024         <a class="code" href="../../d1/d7/wait_8c.html#a2">KeDelayExecutionThread</a> (KernelMode,
08025                                 FALSE,
08026                                 (PLARGE_INTEGER)&amp;Mm30Milliseconds);
08027         i -= 1;
08028 
08029     } <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
08030 
08031     InterlockedDecrement (&amp;MiDelayPageFaults);
08032 
08033     <span class="keywordflow">return</span> status;
08034 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a68" doxytag="iosup.c::MmGetPhysicalAddress" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PHYSICAL_ADDRESS MmGetPhysicalAddress           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>BaseAddress</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l05490">5490</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
References <a class="el" href="../../d3/d0/mm_8h-source.html#l00166">BYTE_OFFSET</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02287">MI_CONVERT_PHYSICAL_TO_PFN</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02410">MI_GET_PAGE_FRAME_FROM_PTE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02262">MI_IS_PHYSICAL_ADDRESS</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l01128">ZERO_LARGE</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l02400">IoFreeDumpRange()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l00384">IopGetDumpStack()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l04580">IopInitializeDCB()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l03759">IopMapVirtualToPhysicalMdl()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l02291">IoSetDumpRange()</a>, <a class="el" href="../../d4/d8/4_2ia64_2kdtrap_8c-source.html#l00467">KdpStub()</a>, <a class="el" href="../../d7/d5/ia64_2allproc_8c-source.html#l00082">KeStartAllProcessors()</a>, <a class="el" href="../../d3/d0/largepag_8c-source.html#l00515">Ki386BuildIdentityBuffer()</a>, <a class="el" href="../../d3/d0/largepag_8c-source.html#l00482">Ki386ConvertPte()</a>, <a class="el" href="../../d3/d0/largepag_8c-source.html#l00054">Ki386CreateIdentityMap()</a>, <a class="el" href="../../d2/d1/mips_2buserror_8c-source.html#l00081">KiGetPhysicalAddress()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l03744">MmAllocateContiguousMemorySpecifyCache()</a>, <a class="el" href="../../d0/d5/alpha_2debugsup_8c-source.html#l00070">MmDbgWriteCheck()</a>, <a class="el" href="../../d1/d1/mmsup_8c-source.html#l01503">MmHibernateInformation()</a>, and <a class="el" href="../../d6/d5/iosup_8c-source.html#l05161">MmMapUserAddressesToPage()</a>.
<p>
<pre class="fragment"><div>05496                    :
05497 
05498     This function returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> corresponding physical address <span class="keywordflow">for</span> a
05499     valid <span class="keyword">virtual</span> address.
05500 
05501 Arguments:
05502 
05503     BaseAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">virtual</span> address <span class="keywordflow">for</span> which to <span class="keywordflow">return</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
05504                   physical address.
05505 
05506 Return Value:
05507 
05508     Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> corresponding physical address.
05509 
05510 Environment:
05511 
05512     Kernel mode.  Any IRQL level.
05513 
05514 --*/
05515 
05516 {
05517     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
05518     PHYSICAL_ADDRESS PhysicalAddress;
05519 
05520     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a178">MI_IS_PHYSICAL_ADDRESS</a>(BaseAddress)) {
05521         PhysicalAddress.QuadPart = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a179">MI_CONVERT_PHYSICAL_TO_PFN</a> (BaseAddress);
05522     } <span class="keywordflow">else</span> {
05523 
05524         PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(BaseAddress);
05525 
05526         <span class="keywordflow">if</span> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) {
05527             KdPrint((<span class="stringliteral">"MM:MmGetPhysicalAddressFailed base address was %lx"</span>,
05528                       BaseAddress));
05529             <a class="code" href="../../d4/d8/mi_8h.html#a166">ZERO_LARGE</a> (PhysicalAddress);
05530             <span class="keywordflow">return</span> PhysicalAddress;
05531         }
05532         PhysicalAddress.QuadPart = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (PointerPte);
05533     }
05534 
05535     PhysicalAddress.QuadPart = PhysicalAddress.QuadPart &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
05536     PhysicalAddress.LowPart += <a class="code" href="../../d2/d1/mm_8h.html#a6">BYTE_OFFSET</a>(BaseAddress);
05537 
05538     <span class="keywordflow">return</span> PhysicalAddress;
05539 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a78" doxytag="iosup.c::MmGetSectionRange" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS MmGetSectionRange           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>AddressWithinSection</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>StartingSectionAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>SizeofSection</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l06797">6797</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
References <a class="el" href="../../d6/d7/ex_8h-source.html#l02474">ExAcquireResourceShared</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02393">ExReleaseResource</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01598">KeEnterCriticalRegion</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01628">KeLeaveCriticalRegion</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l06991">MiLookupDataTableEntry()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00583">PsLoadedModuleResource</a>, <a class="el" href="../../d9/d8/imagedir_8c-source.html#l00029">RtlImageNtHeader()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
<pre class="fragment"><div>06802 {
06803     PLDR_DATA_TABLE_ENTRY DataTableEntry;
06804     ULONG i;
06805     PIMAGE_NT_HEADERS NtHeaders;
06806     PIMAGE_SECTION_HEADER NtSection;
06807     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
06808     ULONG_PTR Rva;
06809 
06810     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
06811 
06812     <span class="comment">//</span>
06813     <span class="comment">// Search the loaded module list for the data table entry that describes</span>
06814     <span class="comment">// the DLL that was just unloaded. It is possible that an entry is not in</span>
06815     <span class="comment">// the list if a failure occurred at a point in loading the DLL just before</span>
06816     <span class="comment">// the data table entry was generated.</span>
06817     <span class="comment">//</span>
06818 
06819     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NOT_FOUND;
06820 
06821     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
06822     <a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a> (&amp;PsLoadedModuleResource, TRUE);
06823 
06824     DataTableEntry = <a class="code" href="../../d4/d8/mi_8h.html#a874">MiLookupDataTableEntry</a> (AddressWithinSection, TRUE);
06825     <span class="keywordflow">if</span> (DataTableEntry) {
06826 
06827         Rva = (ULONG_PTR)((PUCHAR)AddressWithinSection - (ULONG_PTR)DataTableEntry-&gt;DllBase);
06828 
06829         NtHeaders = (PIMAGE_NT_HEADERS)<a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>(DataTableEntry-&gt;DllBase);
06830 
06831         NtSection = (PIMAGE_SECTION_HEADER)((PCHAR)NtHeaders +
06832                             <span class="keyword">sizeof</span>(ULONG) +
06833                             <span class="keyword">sizeof</span>(IMAGE_FILE_HEADER) +
06834                             NtHeaders-&gt;FileHeader.SizeOfOptionalHeader
06835                             );
06836 
06837         <span class="keywordflow">for</span> (i = 0; i &lt; NtHeaders-&gt;FileHeader.NumberOfSections; i += 1) {
06838 
06839             <span class="keywordflow">if</span> ( Rva &gt;= NtSection-&gt;VirtualAddress &amp;&amp;
06840                  Rva &lt; NtSection-&gt;VirtualAddress + NtSection-&gt;SizeOfRawData ) {
06841 
06842                 <span class="comment">//</span>
06843                 <span class="comment">// Found it</span>
06844                 <span class="comment">//</span>
06845 
06846                 *StartingSectionAddress = (PVOID)
06847                     ((PCHAR) DataTableEntry-&gt;DllBase + NtSection-&gt;VirtualAddress);
06848                 *SizeofSection = NtSection-&gt;SizeOfRawData;
06849                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
06850                 <span class="keywordflow">break</span>;
06851             }
06852 
06853             NtSection += 1;
06854         }
06855     }
06856 
06857     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a> (&amp;PsLoadedModuleResource);
06858     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
06859     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
06860 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a69" doxytag="iosup.c::MmGetVirtualForPhysical" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PVOID MmGetVirtualForPhysical           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PHYSICAL_ADDRESS&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>PhysicalAddress</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l05542">5542</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
References <a class="el" href="../../d3/d0/mm_8h-source.html#l00166">BYTE_OFFSET</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01842">MiGetVirtualAddressMappedByPte</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l01281">_MMPFN::PteAddress</a>.
<p>
Referenced by <a class="el" href="../../d6/d5/iosup_8c-source.html#l08083">MmSetKernelDumpRange()</a>.
<p>
<pre class="fragment"><div>05548                    :
05549 
05550     This function returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> corresponding <span class="keyword">virtual</span> address <span class="keywordflow">for</span> a physical
05551     address whose primary <span class="keyword">virtual</span> address <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> in system space.
05552 
05553 Arguments:
05554 
05555     PhysicalAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> physical address <span class="keywordflow">for</span> which to <span class="keywordflow">return</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
05556                   <span class="keyword">virtual</span> address.
05557 
05558 Return Value:
05559 
05560     Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> corresponding <span class="keyword">virtual</span> address.
05561 
05562 Environment:
05563 
05564     Kernel mode.  Any IRQL level.
05565 
05566 --*/
05567 
05568 {
05569     PFN_NUMBER PageFrameIndex;
05570     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn;
05571 
05572     PageFrameIndex = (PFN_NUMBER)(PhysicalAddress.QuadPart &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
05573 
05574     Pfn = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
05575 
05576     <span class="keywordflow">return</span> (PVOID)((PCHAR)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (Pfn-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o6">PteAddress</a>) +
05577                     <a class="code" href="../../d2/d1/mm_8h.html#a6">BYTE_OFFSET</a> (PhysicalAddress.LowPart));
05578 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a27" doxytag="iosup.c::MmIsRecursiveIoFault" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN MmIsRecursiveIoFault           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l07167">7167</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
References <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>.
<p>
<pre class="fragment"><div>07173                    :
07174 
07175     This function examines <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread's page fault clustering information
07176     and determines <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current page fault <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> occurring during an I/O
07177     operation.
07178 
07179 Arguments:
07180 
07181     None.
07182 
07183 Return Value:
07184 
07185     Returns <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> fault <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> occurring during an I/O operation,
07186     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise.
07187 
07188 --*/
07189 
07190 {
07191     <span class="keywordflow">return</span> (BOOLEAN)(<a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;DisablePageFaultClustering |
07192                      <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()-&gt;ForwardClusterOnly);
07193 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a79" doxytag="iosup.c::MmLockPagableDataSection" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PVOID MmLockPagableDataSection           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>AddressWithinSection</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l06864">6864</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
References <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02474">ExAcquireResourceShared</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02393">ExReleaseResource</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01598">KeEnterCriticalRegion</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01628">KeLeaveCriticalRegion</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02262">MI_IS_PHYSICAL_ADDRESS</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l06991">MiLookupDataTableEntry()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00186">MM_DBG_LOCK_CODE</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l06284">MmLockPagableSectionByHandle()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00583">PsLoadedModuleResource</a>, <a class="el" href="../../d9/d8/imagedir_8c-source.html#l00029">RtlImageNtHeader()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01985">SECTION_BASE_ADDRESS</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l00551">SmbTraceStart()</a>.
<p>
<pre class="fragment"><div>06870                    :
06871 
06872     This <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a16">functions</a> locks <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> entire section that contains <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified
06873     section in memory.  This allows pagable code to be brought into
06874     memory and to be used as <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> code was not really pagable.  This
06875     should not be done with a <a class="code" href="../../d2/d3/fetypes_8h.html#a457a417">high</a> degree of frequency.
06876 
06877 Arguments:
06878 
06879     AddressWithinSection - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of a function
06880         contained within a section that should be brought in and locked
06881         in memory.
06882 
06883 Return Value:
06884 
06885     This function returns a value to be used in a subsequent call to
06886     <a class="code" href="../../d2/d1/mm_8h.html#a312">MmUnlockPagableImageSection</a>.
06887 
06888 --*/
06889 
06890 {
06891     PLDR_DATA_TABLE_ENTRY DataTableEntry;
06892     ULONG i;
06893     PIMAGE_NT_HEADERS NtHeaders;
06894     PIMAGE_SECTION_HEADER NtSection;
06895     PIMAGE_SECTION_HEADER FoundSection;
06896     ULONG_PTR Rva;
06897 
06898     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
06899 
06900     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a178">MI_IS_PHYSICAL_ADDRESS</a>(AddressWithinSection)) {
06901 
06902         <span class="comment">//</span>
06903         <span class="comment">// Physical address, just return that as the handle.</span>
06904         <span class="comment">//</span>
06905 
06906         <span class="keywordflow">return</span> AddressWithinSection;
06907     }
06908 
06909     <span class="comment">//</span>
06910     <span class="comment">// Search the loaded module list for the data table entry that describes</span>
06911     <span class="comment">// the DLL that was just unloaded. It is possible that an entry is not in</span>
06912     <span class="comment">// the list if a failure occurred at a point in loading the DLL just before</span>
06913     <span class="comment">// the data table entry was generated.</span>
06914     <span class="comment">//</span>
06915 
06916     FoundSection = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
06917 
06918     <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
06919     <a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a> (&amp;PsLoadedModuleResource, TRUE);
06920 
06921     DataTableEntry = <a class="code" href="../../d4/d8/mi_8h.html#a874">MiLookupDataTableEntry</a> (AddressWithinSection, TRUE);
06922 
06923     Rva = (ULONG_PTR)((PUCHAR)AddressWithinSection - (ULONG_PTR)DataTableEntry-&gt;DllBase);
06924 
06925     NtHeaders = (PIMAGE_NT_HEADERS)<a class="code" href="../../d8/d9/imagedir_8c.html#a0">RtlImageNtHeader</a>(DataTableEntry-&gt;DllBase);
06926 
06927     NtSection = (PIMAGE_SECTION_HEADER)((ULONG_PTR)NtHeaders +
06928                         <span class="keyword">sizeof</span>(ULONG) +
06929                         <span class="keyword">sizeof</span>(IMAGE_FILE_HEADER) +
06930                         NtHeaders-&gt;FileHeader.SizeOfOptionalHeader
06931                         );
06932 
06933     <span class="keywordflow">for</span> (i = 0; i &lt; NtHeaders-&gt;FileHeader.NumberOfSections; i += 1) {
06934 
06935         <span class="keywordflow">if</span> ( Rva &gt;= NtSection-&gt;VirtualAddress &amp;&amp;
06936              Rva &lt; NtSection-&gt;VirtualAddress + NtSection-&gt;SizeOfRawData ) {
06937             FoundSection = NtSection;
06938 
06939             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a217">SECTION_BASE_ADDRESS</a>(NtSection) != ((PUCHAR)DataTableEntry-&gt;DllBase +
06940                             NtSection-&gt;VirtualAddress)) {
06941 
06942                 <span class="comment">//</span>
06943                 <span class="comment">// Overwrite the PointerToRelocations field (and on Win64, the</span>
06944                 <span class="comment">// PointerToLinenumbers field also) so that it contains</span>
06945                 <span class="comment">// the Va of this section and NumberOfLinenumbers so it contains</span>
06946                 <span class="comment">// the Lock Count for the section.</span>
06947                 <span class="comment">//</span>
06948 
06949                 <a class="code" href="../../d4/d8/mi_8h.html#a217">SECTION_BASE_ADDRESS</a>(NtSection) = ((PUCHAR)DataTableEntry-&gt;DllBase +
06950                                         NtSection-&gt;VirtualAddress);
06951                 NtSection-&gt;NumberOfLinenumbers = 0;
06952             }
06953 
06954             <span class="comment">//</span>
06955             <span class="comment">// Now lock in the code</span>
06956             <span class="comment">//</span>
06957 
06958 <span class="preprocessor">#if DBG</span>
06959 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (MmDebug &amp; <a class="code" href="../../d4/d8/mi_8h.html#a78">MM_DBG_LOCK_CODE</a>) {
06960                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"MM Lock %wZ %8s %p -&gt; %p : %p %3ld.\n"</span>,
06961                         &amp;DataTableEntry-&gt;BaseDllName,
06962                         NtSection-&gt;Name,
06963                         AddressWithinSection,
06964                         NtSection,
06965                         <a class="code" href="../../d4/d8/mi_8h.html#a217">SECTION_BASE_ADDRESS</a>(NtSection),
06966                         NtSection-&gt;NumberOfLinenumbers);
06967             }
06968 <span class="preprocessor">#endif //DBG</span>
06969 <span class="preprocessor"></span>
06970             <a class="code" href="../../d5/d6/iosup_8c.html#a76">MmLockPagableSectionByHandle</a> ((PVOID)NtSection);
06971 
06972             <span class="keywordflow">break</span>;
06973         }
06974         NtSection += 1;
06975     }
06976 
06977     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a> (&amp;PsLoadedModuleResource);
06978     <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
06979     <span class="keywordflow">if</span> (!FoundSection) {
06980         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (MEMORY_MANAGEMENT,
06981                       0x1234,
06982                       (ULONG_PTR)AddressWithinSection,
06983                       0,
06984                       0);
06985     }
06986     <span class="keywordflow">return</span> (PVOID)FoundSection;
06987 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a76" doxytag="iosup.c::MmLockPagableSectionByHandle" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MmLockPagableSectionByHandle           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>ImageSectionHandle</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l06284">6284</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01598">KeEnterCriticalRegion</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01628">KeLeaveCriticalRegion</a>, <a class="el" href="../../d3/d7/eventobj_8c-source.html#l00167">KePulseEvent()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00901">LOCK_PFN2</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00998">LOCK_SYSTEM_WS</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02262">MI_IS_PHYSICAL_ADDRESS</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02717">MI_IS_SYSTEM_CACHE_ADDRESS</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l06461">MiLockCode()</a>, <a class="el" href="../../d1/d1/mmsup_8c-source.html#l00916">MiMakeSystemAddressValidPfnSystemWs()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00113">MM_LOCK_BY_REFCOUNT</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l00206">MmCollidedLockEvent</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l00207">MmCollidedLockWait</a>, <a class="el" href="../../d1/d8/miglobal_8c-source.html#l00033">MmSystemRangeStart</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01985">SECTION_BASE_ADDRESS</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00905">UNLOCK_PFN2</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00910">UNLOCK_PFN_AND_THEN_WAIT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01005">UNLOCK_SYSTEM_WS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01012">UNLOCK_SYSTEM_WS_NO_IRQL</a>, and <a class="el" href="../../d4/d9/ke_8h.html#a407a216">WrVirtualMemory</a>.
<p>
Referenced by <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l03579">ExpGetLockInformation()</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l03661">ExpGetLookasideInformation()</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l03846">ExpGetPoolInformation()</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l03060">ExpGetProcessInformation()</a>, <a class="el" href="../../d9/d3/mtrr_8c-source.html#l00576">KeSetPhysicalCacheTypeRange()</a>, <a class="el" href="../../d1/d4/mtrramd_8c-source.html#l00294">KiAmdK6MtrrSetMemoryType()</a>, <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l02715">MiEmptyAllWorkingSets()</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l04569">MiFindContiguousMemory()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l00443">MiLoadSystemImage()</a>, <a class="el" href="../../d4/d4/mapview_8c-source.html#l03268">MiMapViewInSystemSpace()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l02309">MiSetPagingOfDriver()</a>, <a class="el" href="../../d5/d6/sessload_8c-source.html#l00119">MiShareSessionImage()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l03253">MiUnmapLockedPagesInUserSpace()</a>, <a class="el" href="../../d4/d4/mapview_8c-source.html#l03683">MiUnmapViewInSystemSpace()</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l02450">MmAdjustWorkingSetSize()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l05581">MmAllocateNonCachedMemory()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l04270">MmAllocatePagesForMdl()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l02106">MmFreeDriverInitialization()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l05721">MmFreeNonCachedMemory()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l05051">MmFreePagesFromMdl()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l06864">MmLockPagableDataSection()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l07821">MmLockPagedPool()</a>, <a class="el" href="../../d4/d4/mapview_8c-source.html#l00753">MmMapViewOfSection()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l02560">MmResetDriverPaging()</a>, <a class="el" href="../../d2/d8/shutdown_8c-source.html#l00041">MmShutdownSystem()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l02896">MmUnloadSystemImage()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l07869">MmUnlockPagedPool()</a>, <a class="el" href="../../d6/d2/queryvm_8c-source.html#l00061">NtQueryVirtualMemory()</a>, <a class="el" href="../../d0/d1/psquery_8c-source.html#l00291">PspQueryPooledQuotaLimits()</a>, <a class="el" href="../../d0/d1/psquery_8c-source.html#l00209">PspQueryQuotaLimits()</a>, <a class="el" href="../../d0/d1/psquery_8c-source.html#l00113">PspQueryWorkingSetWatch()</a>, and <a class="el" href="../../d0/d1/psquery_8c-source.html#l01211">PspSetQuotaLimits()</a>.
<p>
<pre class="fragment"><div>06291                    :
06292 
06293     This routine checks to see <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified pages are resident in
06294     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process's working set and <span class="keywordflow">if</span> so <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> reference count <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
06295     page <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> incremented.  The allows <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">virtual</span> address to be accessed
06296     without getting a hard page fault (have to go to the disk... except
06297     <span class="keywordflow">for</span> extremely rare <span class="keywordflow">case</span> when the page table page is removed from the
06298     working set and migrates to the disk.
06299 
06300     If the <span class="keyword">virtual</span> address is that of the system wide global <span class="stringliteral">"cache"</span> the
06301     <span class="keyword">virtual</span> address of the <span class="stringliteral">"locked"</span> pages is always guaranteed to
06302     be valid.
06303 
06304     NOTE: This routine is not to be used <span class="keywordflow">for</span> general locking of user
06305     addresses - use <a class="code" href="../../d2/d1/mm_8h.html#a273">MmProbeAndLockPages</a>.  This routine is intended <span class="keywordflow">for</span>
06306     well behaved system code like the file system caches which allocates
06307     <span class="keyword">virtual</span> addresses <span class="keywordflow">for</span> mapping files AND guarantees that the mapping
06308     will not be modified (deleted or changed) <span class="keywordflow">while</span> the pages are locked.
06309 
06310 Arguments:
06311 
06312     ImageSectionHandle - Supplies the value returned by a previous call
06313         to <a class="code" href="../../d2/d1/mm_8h.html#a306">MmLockPagableDataSection</a>.  This is a pointer to the Section
06314         header <span class="keywordflow">for</span> the image.
06315 
06316 Return Value:
06317 
06318     None.
06319 
06320 Environment:
06321 
06322     Kernel mode, IRQL of DISPATCH_LEVEL or below.
06323 
06324 --*/
06325 
06326 {
06327     PIMAGE_SECTION_HEADER NtSection;
06328     PVOID BaseAddress;
06329     ULONG SizeToLock;
06330     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
06331     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastPte;
06332     KIRQL OldIrql;
06333     KIRQL OldIrqlWs;
06334     ULONG Collision;
06335 
06336     if (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a178">MI_IS_PHYSICAL_ADDRESS</a>(ImageSectionHandle)) {
06337 
06338         <span class="comment">//</span>
06339         <span class="comment">// No need to lock physical addresses.</span>
06340         <span class="comment">//</span>
06341 
06342         <span class="keywordflow">return</span>;
06343     }
06344 
06345     NtSection = (PIMAGE_SECTION_HEADER)ImageSectionHandle;
06346 
06347     BaseAddress = <a class="code" href="../../d4/d8/mi_8h.html#a217">SECTION_BASE_ADDRESS</a>(NtSection);
06348 
06349     ASSERT (!<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a196">MI_IS_SYSTEM_CACHE_ADDRESS</a>(BaseAddress));
06350 
06351     ASSERT (BaseAddress &gt;= MmSystemRangeStart);
06352 
06353     SizeToLock = NtSection-&gt;SizeOfRawData;
06354     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(BaseAddress);
06355     LastPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>((PCHAR)BaseAddress + SizeToLock - 1);
06356 
06357     ASSERT (SizeToLock != 0);
06358 
06359     <span class="comment">//</span>
06360     <span class="comment">// The address must be within the system space.</span>
06361     <span class="comment">//</span>
06362 
06363 RetryLock:
06364 
06365     LOCK_SYSTEM_WS (OldIrqlWs);
06366     LOCK_PFN2 (OldIrql);
06367 
06368     MiMakeSystemAddressValidPfnSystemWs (&amp;NtSection-&gt;NumberOfLinenumbers);
06369 
06370     <span class="comment">//</span>
06371     <span class="comment">// The NumberOfLinenumbers field is used to store the</span>
06372     <span class="comment">// lock count.</span>
06373     <span class="comment">//</span>
06374     <span class="comment">//  Value of 0 means unlocked,</span>
06375     <span class="comment">//  Value of 1 means lock in progress by another thread.</span>
06376     <span class="comment">//  Value of 2 or more means locked.</span>
06377     <span class="comment">//</span>
06378     <span class="comment">//  If the value is 1, this thread must block until the other thread's</span>
06379     <span class="comment">//  lock operation is complete.</span>
06380     <span class="comment">//</span>
06381 
06382     NtSection-&gt;NumberOfLinenumbers += 1;
06383 
06384     if (NtSection-&gt;NumberOfLinenumbers &gt;= 3) {
06385 
06386         <span class="comment">//</span>
06387         <span class="comment">// Already locked, increment counter and return.</span>
06388         <span class="comment">//</span>
06389 
06390         <a class="code" href="../../d4/d8/mi_8h.html#a131">UNLOCK_PFN2</a> (OldIrql);
06391         UNLOCK_SYSTEM_WS (OldIrqlWs);
06392         <span class="keywordflow">return</span>;
06393     }
06394 
06395     <span class="keywordflow">if</span> (NtSection-&gt;NumberOfLinenumbers == 2) {
06396 
06397         <span class="comment">//</span>
06398         <span class="comment">// A lock is in progress.</span>
06399         <span class="comment">// Reset back to 1 and wait.</span>
06400         <span class="comment">//</span>
06401 
06402         NtSection-&gt;NumberOfLinenumbers = 1;
06403         MmCollidedLockWait = TRUE;
06404 
06405         <a class="code" href="../../d4/d9/ke_8h.html#a28">KeEnterCriticalRegion</a>();
06406 
06407         <span class="comment">//</span>
06408         <span class="comment">// The unlock IRQLs are deliberately reversed as the lock and mutex</span>
06409         <span class="comment">// are being released in reverse order.</span>
06410         <span class="comment">//</span>
06411 
06412         UNLOCK_SYSTEM_WS_NO_IRQL ();
06413         UNLOCK_PFN_AND_THEN_WAIT (OldIrqlWs);
06414 
06415         <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>(&amp;MmCollidedLockEvent,
06416                               WrVirtualMemory,
06417                               KernelMode,
06418                               FALSE,
06419                               (PLARGE_INTEGER)NULL);
06420         <a class="code" href="../../d4/d9/ke_8h.html#a29">KeLeaveCriticalRegion</a>();
06421         <span class="keywordflow">goto</span> RetryLock;
06422     }
06423 
06424     <span class="comment">//</span>
06425     <span class="comment">// Value was 0 when the lock was obtained.  It is now 1 indicating</span>
06426     <span class="comment">// a lock is in progress.</span>
06427     <span class="comment">//</span>
06428 
06429     MiLockCode (PointerPte, LastPte, MM_LOCK_BY_REFCOUNT);
06430 
06431     <span class="comment">//</span>
06432     <span class="comment">// Set lock count to 2 (it was 1 when this started) and check</span>
06433     <span class="comment">// to see if any other threads tried to lock while this was happening.</span>
06434     <span class="comment">//</span>
06435 
06436     MiMakeSystemAddressValidPfnSystemWs (&amp;NtSection-&gt;NumberOfLinenumbers);
06437     NtSection-&gt;NumberOfLinenumbers += 1;
06438 
06439     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (NtSection-&gt;NumberOfLinenumbers == 2);
06440 
06441     Collision = MmCollidedLockWait;
06442     MmCollidedLockWait = FALSE;
06443 
06444     <a class="code" href="../../d4/d8/mi_8h.html#a131">UNLOCK_PFN2</a> (OldIrql);
06445     UNLOCK_SYSTEM_WS (OldIrqlWs);
06446 
06447     <span class="keywordflow">if</span> (Collision) {
06448 
06449         <span class="comment">//</span>
06450         <span class="comment">// Wake up all waiters.</span>
06451         <span class="comment">//</span>
06452 
06453         KePulseEvent (&amp;MmCollidedLockEvent, 0, FALSE);
06454     }
06455 
06456     <span class="keywordflow">return</span>;
06457 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a87" doxytag="iosup.c::MmLockPagedPool" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MmLockPagedPool           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Address</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN SIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>SizeInBytes</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l07821">7821</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
References <a class="el" href="../../d6/d7/ex_8h-source.html#l03321">ExPageLockHandle</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00998">LOCK_SYSTEM_WS</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l06461">MiLockCode()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00113">MM_LOCK_BY_REFCOUNT</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l06284">MmLockPagableSectionByHandle()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l07065">MmUnlockPagableImageSection()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l01005">UNLOCK_SYSTEM_WS</a>.
<p>
Referenced by <a class="el" href="../../d5/d2/i386_2ldtsup_8c-source.html#l00255">Ke386SetDescriptorProcess()</a>, and <a class="el" href="../../d9/d7/sysload_8c-source.html#l05376">MiSetImageProtect()</a>.
<p>
<pre class="fragment"><div>07828                    :
07829 
07830     Locks <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified address (which MUST reside in paged pool) into
07831     memory until <a class="code" href="../../d2/d1/mm_8h.html#a309">MmUnlockPagedPool</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called.
07832 
07833 Arguments:
07834 
07835     Address - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address in paged <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> to lock.
07836 
07837     SizeInBytes - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size in bytes to lock.
07838 
07839 Return Value:
07840 
07841     None.
07842 
07843 Environment:
07844 
07845     Kernel mode, IRQL of <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a> or below.
07846 
07847 --*/
07848 
07849 {
07850     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
07851     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastPte;
07852     KIRQL OldIrql;
07853     KIRQL OldIrqlWs;
07854 
07855     <a class="code" href="../../d5/d6/iosup_8c.html#a76">MmLockPagableSectionByHandle</a>(ExPageLockHandle);
07856     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (Address);
07857     LastPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> ((PVOID)((PCHAR)Address + (SizeInBytes - 1)));
07858     <a class="code" href="../../d4/d8/mi_8h.html#a144">LOCK_SYSTEM_WS</a> (OldIrqlWs);
07859     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
07860     <a class="code" href="../../d4/d8/mi_8h.html#a873">MiLockCode</a> (PointerPte, LastPte, MM_LOCK_BY_REFCOUNT);
07861     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
07862     <a class="code" href="../../d4/d8/mi_8h.html#a145">UNLOCK_SYSTEM_WS</a> (OldIrqlWs);
07863     <a class="code" href="../../d5/d6/iosup_8c.html#a81">MmUnlockPagableImageSection</a>(ExPageLockHandle);
07864     <span class="keywordflow">return</span>;
07865 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a57" doxytag="iosup.c::MmMapIoSpace" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PVOID MmMapIoSpace           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PHYSICAL_ADDRESS&nbsp;</td>
          <td class="mdname" nowrap> <em>PhysicalAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN SIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>NumberOfBytes</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d4/d9/ke_8h.html#a156">MEMORY_CACHING_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>CacheType</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l03415">3415</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00166">BYTE_OFFSET</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00420">_MDL::ByteCount</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00421">_MDL::ByteOffset</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00221">COMPUTE_PAGES_SPANNED</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02780">KeFeatureBits</a>, <a class="el" href="../../d1/d5/ppc_2flushtb_8c-source.html#l00033">KeFlushEntireTb()</a>, <a class="el" href="../../d1/d4/i386_2flush_8c-source.html#l00187">KeInvalidateAllCaches()</a>, <a class="el" href="../../d9/d3/mtrr_8c-source.html#l00576">KeSetPhysicalCacheTypeRange()</a>, <a class="el" href="../../d6/d2/i386_8h-source.html#l02712">KF_PAT</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00418">_MDL::MappedSystemVa</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00861">MI_DISABLE_CACHING</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00687">MI_SET_PTE_WRITE_COMBINE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02459">MI_WRITE_VALID_PTE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01842">MiGetVirtualAddressMappedByPte</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l01611">MiInsertPteTracker()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00822">MiLockSystemSpace</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l01859">MiReleaseDeadPteTrackers()</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l01354">MiReleaseSystemPtes()</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l00524">MiReserveSystemPtes()</a>, <a class="el" href="../../d7/d1/mm_2ia64_2initia64_8c-source.html#l02042">MiSweepCacheMachineDependent()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l00093">MiTrackPtesAborted</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00825">MiUnlockSystemSpace</a>, <a class="el" href="../../d7/d7/mi386_8h-source.html#l00267">MiWriteCombiningPtes</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00321">MM_COLOR_ALIGNMENT</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00327">MM_COLOR_MASK_VIRTUAL</a>, <a class="el" href="../../d4/d9/ke_8h.html#a413a249">MmCached</a>, <a class="el" href="../../d4/d9/ke_8h.html#a413a254">MmMaximumCacheType</a>, <a class="el" href="../../d4/d9/ke_8h.html#a413a248">MmNonCached</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00093">MmTrackPtes</a>, <a class="el" href="../../d4/d9/ke_8h.html#a413a253">MmUSWCCached</a>, <a class="el" href="../../d4/d9/ke_8h.html#a413a250">MmWriteCombined</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, <a class="el" href="../../d6/d1/ppc_2getcalr_8c-source.html#l00038">RtlGetCallersAddress()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00419">_MDL::StartVa</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d4/d8/mi_8h.html#a1003a769">SystemPteSpace</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, and <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00038">ValidKernelPte</a>.
<p>
Referenced by <a class="el" href="../../d0/d3/rules_8c-source.html#l02173">CmpFindACPITable()</a>, <a class="el" href="../../d7/d7/fsvga_8c-source.html#l00053">DriverEntry()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l03744">MmAllocateContiguousMemorySpecifyCache()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l07516">MmMapVideoDisplay()</a>, and <a class="el" href="../../d0/d5/verifier_8c-source.html#l00662">VerifierMapIoSpace()</a>.
<p>
<pre class="fragment"><div>03423                    :
03424 
03425     This function maps <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified physical address into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> non-pagable
03426     portion of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system address space.
03427 
03428 Arguments:
03429 
03430     PhysicalAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> starting physical address to map.
03431 
03432     NumberOfBytes - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of bytes to map.
03433 
03434     CacheType - Supplies <a class="code" href="../../d4/d9/ke_8h.html#a413a248">MmNonCached</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> physical address <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be mapped
03435                 as non-cached, <a class="code" href="../../d4/d9/ke_8h.html#a413a249">MmCached</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address should be cached, and
03436                 <a class="code" href="../../d4/d9/ke_8h.html#a413a250">MmWriteCombined</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address should be cached and
03437                 write-combined as a frame buffer which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be used <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> by
03438                 <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> video port driver.  All other callers should use
03439                 <a class="code" href="../../d4/d9/ke_8h.html#a413a253">MmUSWCCached</a>.  <a class="code" href="../../d4/d9/ke_8h.html#a413a253">MmUSWCCached</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> available <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d9/union__PAT.html">PAT</a>
03440                 feature <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> present and available.
03441 
03442                 For I/O device registers, <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> usually specified
03443                 as <a class="code" href="../../d4/d9/ke_8h.html#a413a248">MmNonCached</a>.
03444 
03445 Return Value:
03446 
03447     Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">virtual</span> address which maps <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified physical addresses.
03448     The value <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned <span class="keywordflow">if</span> sufficient <span class="keyword">virtual</span> address space <span class="keywordflow">for</span>
03449     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> mapping could not be found.
03450 
03451 Environment:
03452 
03453     Kernel mode, Should be IRQL of <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a> or below, but unfortunately
03454     callers are coming in at <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a> and <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>'s too late to change <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
03455     rules now.  This means you can never make <span class="keyword">this</span> routine pagable.
03456 
03457 --*/
03458 
03459 {
03460     PFN_NUMBER NumberOfPages;
03461     PFN_NUMBER PageFrameIndex;
03462     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
03463     PVOID BaseVa;
03464     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
03465     KIRQL OldIrql;
03466     <a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a> TempMdl;
03467     PFN_NUMBER MdlHack[(<span class="keyword">sizeof</span>(<a class="code" href="../../d6/d7/struct__MDL.html">MDL</a>)/<span class="keyword">sizeof</span>(PFN_NUMBER)) + 1];
03468     PPFN_NUMBER Page;
03469     <a class="code" href="../../d0/d3/struct__LOCK__TRACKER.html">PLOCK_TRACKER</a> Tracker;
03470     PVOID CallingAddress;
03471     PVOID CallersCaller;
03472 <span class="preprocessor">#ifdef i386</span>
03473 <span class="preprocessor"></span>    <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03474 <span class="preprocessor">#endif</span>
03475 <span class="preprocessor"></span>
03476 <span class="preprocessor">#if !defined (_X86_)</span>
03477 <span class="preprocessor"></span>    CallingAddress = (PVOID)_ReturnAddress();
03478     CallersCaller = (PVOID)0;
03479 <span class="preprocessor">#endif</span>
03480 <span class="preprocessor"></span>
03481     <span class="comment">//</span>
03482     <span class="comment">// For compatibility for when CacheType used to be passed as a BOOLEAN</span>
03483     <span class="comment">// mask off the upper bits (TRUE == MmCached, FALSE == MmNonCached).</span>
03484     <span class="comment">//</span>
03485 
03486     CacheType &amp;= 0xFF;
03487 
03488     <span class="keywordflow">if</span> (CacheType &gt;= <a class="code" href="../../d4/d9/ke_8h.html#a413a254">MmMaximumCacheType</a>) {
03489         <span class="keywordflow">return</span> (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
03490     }
03491 
03492 <span class="preprocessor">#if defined (i386) &amp;&amp; !defined (_X86PAE_)</span>
03493 <span class="preprocessor"></span>    <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PhysicalAddress.HighPart == 0);
03494 <span class="preprocessor">#endif</span>
03495 <span class="preprocessor"></span>
03496     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (NumberOfBytes != 0);
03497     NumberOfPages = <a class="code" href="../../d2/d1/mm_8h.html#a9">COMPUTE_PAGES_SPANNED</a> (PhysicalAddress.LowPart,
03498                                            NumberOfBytes);
03499 
03500     PointerPte = <a class="code" href="../../d0/d9/sysptes_8c.html#a25">MiReserveSystemPtes</a>((ULONG)NumberOfPages,
03501                                      SystemPteSpace,
03502                                      MM_COLOR_ALIGNMENT,
03503                                      (PhysicalAddress.LowPart &amp;
03504                                                        MM_COLOR_MASK_VIRTUAL),
03505                                      FALSE);
03506     <span class="keywordflow">if</span> (PointerPte == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03507         <span class="keywordflow">return</span>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
03508     }
03509 
03510     BaseVa = (PVOID)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPte);
03511     BaseVa = (PVOID)((PCHAR)BaseVa + <a class="code" href="../../d2/d1/mm_8h.html#a6">BYTE_OFFSET</a>(PhysicalAddress.LowPart));
03512 
03513     TempPte = <a class="code" href="../../d4/d2/datalpha_8c.html#a2">ValidKernelPte</a>;
03514 
03515 <span class="preprocessor">#ifdef i386</span>
03516 <span class="preprocessor"></span>    <span class="comment">//</span>
03517     <span class="comment">// Set the physical range to proper caching type.  If the PAT feature</span>
03518     <span class="comment">// is supported, then set the caching type in the PTE, otherwise modify</span>
03519     <span class="comment">// the MTRRs if applicable.  If the cache type is MmUSWCCached and the</span>
03520     <span class="comment">// PAT is not supported then fail the call.</span>
03521     <span class="comment">//</span>
03522 
03523     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d9/ke_8h.html#a137">KeFeatureBits</a> &amp; <a class="code" href="../../d5/d3/i386_8h.html#a10">KF_PAT</a>) {
03524         <span class="keywordflow">if</span> ((CacheType == <a class="code" href="../../d4/d9/ke_8h.html#a413a250">MmWriteCombined</a>) || (CacheType == <a class="code" href="../../d4/d9/ke_8h.html#a413a253">MmUSWCCached</a>)) {
03525             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d8/mi386_8h.html#a204">MiWriteCombiningPtes</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
03526                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a111">MI_SET_PTE_WRITE_COMBINE</a>(TempPte);
03527                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
03528             } <span class="keywordflow">else</span> {
03529                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_UNSUCCESSFUL;
03530             }
03531         } <span class="keywordflow">else</span> {
03532 
03533             <span class="comment">//</span>
03534             <span class="comment">// For Non-MmFrameBufferCaching type use existing mm macros.</span>
03535             <span class="comment">//</span>
03536 
03537             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
03538         }
03539     } <span class="keywordflow">else</span> {
03540 
03541         <span class="comment">// Set the MTRRs if possible.</span>
03542 
03543         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d4/mtrr_8c.html#a32">KeSetPhysicalCacheTypeRange</a>(
03544                     PhysicalAddress,
03545                     NumberOfBytes,
03546                     CacheType
03547                     );
03548     }
03549 
03550     <span class="comment">//</span>
03551     <span class="comment">// If range could not be set, determine what to do</span>
03552     <span class="comment">//</span>
03553 
03554     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
03555 
03556         <span class="keywordflow">if</span> ((<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_NOT_SUPPORTED) &amp;&amp;
03557             ((CacheType == <a class="code" href="../../d4/d9/ke_8h.html#a413a248">MmNonCached</a>) || (CacheType == <a class="code" href="../../d4/d9/ke_8h.html#a413a249">MmCached</a>))) {
03558 
03559             <span class="comment">//</span>
03560             <span class="comment">// The range may not have been set into the proper cache</span>
03561             <span class="comment">// type.  If the range is either MmNonCached or MmCached just</span>
03562             <span class="comment">// continue as the PTE will be marked properly.</span>
03563             <span class="comment">//</span>
03564 
03565             NOTHING;
03566 
03567         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_UNSUCCESSFUL  &amp;&amp;  CacheType == <a class="code" href="../../d4/d9/ke_8h.html#a413a249">MmCached</a>) {
03568 
03569             <span class="comment">//</span>
03570             <span class="comment">// If setting a range to Cached was unsuccessful things are not</span>
03571             <span class="comment">// optimal, but not fatal.  The range can be returned to the</span>
03572             <span class="comment">// caller and it will have whatever caching type it has - possibly</span>
03573             <span class="comment">// something below fully cached.</span>
03574             <span class="comment">//</span>
03575 
03576             NOTHING;
03577 
03578         } <span class="keywordflow">else</span> {
03579 
03580             <span class="comment">//</span>
03581             <span class="comment">// If there's still a problem, fail the request.</span>
03582             <span class="comment">//</span>
03583 
03584             <a class="code" href="../../d0/d9/sysptes_8c.html#a26">MiReleaseSystemPtes</a>(PointerPte, NumberOfPages, SystemPteSpace);
03585 
03586             <span class="keywordflow">return</span>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
03587          }
03588     }
03589 <span class="preprocessor">#endif</span>
03590 <span class="preprocessor"></span>
03591     <span class="keywordflow">if</span> (CacheType == <a class="code" href="../../d4/d9/ke_8h.html#a413a248">MmNonCached</a>) {
03592         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a118">MI_DISABLE_CACHING</a> (TempPte);
03593     }
03594 
03595 <span class="preprocessor">#if defined(_IA64_)</span>
03596 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (CacheType != <a class="code" href="../../d4/d9/ke_8h.html#a413a249">MmCached</a>) { 
03597         <a class="code" href="../../d0/d6/ppc_2flushtb_8c.html#a0">KeFlushEntireTb</a>(FALSE, TRUE);
03598     }
03599 <span class="preprocessor">#endif</span>
03600 <span class="preprocessor"></span>
03601     PageFrameIndex = (PFN_NUMBER)(PhysicalAddress.QuadPart &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
03602 
03603     <span class="keywordflow">do</span> {
03604         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0);
03605         TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber = PageFrameIndex;
03606         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a> (PointerPte, TempPte);
03607         PointerPte += 1;
03608         PageFrameIndex += 1;
03609         NumberOfPages -= 1;
03610     } <span class="keywordflow">while</span> (NumberOfPages != 0);
03611 
03612 <span class="preprocessor">#if defined(i386)</span>
03613 <span class="preprocessor"></span>    <span class="comment">//</span>
03614     <span class="comment">// WriteCombined is a non self-snooping memory type.  This memory type</span>
03615     <span class="comment">// requires a writeback invalidation of all the caches on all processors</span>
03616     <span class="comment">// and each accompanying TB flush if the PAT is supported.</span>
03617     <span class="comment">//</span>
03618 
03619     <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d9/ke_8h.html#a137">KeFeatureBits</a> &amp; <a class="code" href="../../d5/d3/i386_8h.html#a10">KF_PAT</a>) &amp;&amp; ((CacheType == <a class="code" href="../../d4/d9/ke_8h.html#a413a250">MmWriteCombined</a>)
03620         || (CacheType == <a class="code" href="../../d4/d9/ke_8h.html#a413a253">MmUSWCCached</a>)) &amp;&amp; (<a class="code" href="../../d6/d8/mi386_8h.html#a204">MiWriteCombiningPtes</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
03621             <a class="code" href="../../d0/d6/ppc_2flushtb_8c.html#a0">KeFlushEntireTb</a> (FALSE, TRUE);
03622             <a class="code" href="../../d0/d5/i386_2flush_8c.html#a2">KeInvalidateAllCaches</a> (TRUE);
03623     }
03624 <span class="preprocessor">#endif</span>
03625 <span class="preprocessor"></span>
03626 <span class="preprocessor">#if defined(_IA64_)</span>
03627 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (CacheType != <a class="code" href="../../d4/d9/ke_8h.html#a413a249">MmCached</a>) {
03628         <a class="code" href="../../d2/d9/miia64_8h.html#a318">MiSweepCacheMachineDependent</a>(BaseVa, NumberOfBytes, CacheType);
03629     }
03630 <span class="preprocessor">#endif</span>
03631 <span class="preprocessor"></span>
03632     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a37">MmTrackPtes</a> != 0) {
03633 
03634         <span class="comment">//</span>
03635         <span class="comment">// First free any zombie blocks as no locks are being held.</span>
03636         <span class="comment">//</span>
03637 
03638         <a class="code" href="../../d5/d6/iosup_8c.html#a35">MiReleaseDeadPteTrackers</a> ();
03639 
03640         Tracker = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (NonPagedPool,
03641                                          <span class="keyword">sizeof</span> (<a class="code" href="../../d7/d1/struct__PTE__TRACKER.html">PTE_TRACKER</a>),
03642                                          'ySmM');
03643 
03644         <span class="keywordflow">if</span> (Tracker != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03645 <span class="preprocessor">#if defined (_X86_)</span>
03646 <span class="preprocessor"></span>            <a class="code" href="../../d5/d2/ppc_2getcalr_8c.html#a0">RtlGetCallersAddress</a>(&amp;CallingAddress, &amp;CallersCaller);
03647 <span class="preprocessor">#endif</span>
03648 <span class="preprocessor"></span>
03649             TempMdl = (<a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a>) &amp;MdlHack;
03650             TempMdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o4">MappedSystemVa</a> = BaseVa;
03651             TempMdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o5">StartVa</a> = (PVOID)(ULONG_PTR)PhysicalAddress.QuadPart;
03652             TempMdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o7">ByteOffset</a> = <a class="code" href="../../d2/d1/mm_8h.html#a6">BYTE_OFFSET</a>(PhysicalAddress.LowPart);
03653             TempMdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o6">ByteCount</a> = (ULONG)NumberOfBytes;
03654     
03655             Page = (PPFN_NUMBER) (TempMdl + 1);
03656             Page = (PPFN_NUMBER)-1;
03657     
03658             <a class="code" href="../../d4/d8/mi_8h.html#a117">MiLockSystemSpace</a>(OldIrql);
03659     
03660             <a class="code" href="../../d5/d6/iosup_8c.html#a33">MiInsertPteTracker</a> (Tracker,
03661                                 TempMdl,
03662                                 COMPUTE_PAGES_SPANNED (PhysicalAddress.LowPart,
03663                                                NumberOfBytes),
03664                                 CallingAddress,
03665                                 CallersCaller);
03666     
03667             <a class="code" href="../../d4/d8/mi_8h.html#a118">MiUnlockSystemSpace</a>(OldIrql);
03668         }
03669         <span class="keywordflow">else</span> {
03670             <a class="code" href="../../d5/d6/iosup_8c.html#a9">MiTrackPtesAborted</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03671         }
03672     }
03673     
03674     <span class="keywordflow">return</span> BaseVa;
03675 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a49" doxytag="iosup.c::MmMapLockedPages" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PVOID MmMapLockedPages           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d6/d7/struct__MDL.html">PMDL</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>MemoryDescriptorList</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessMode</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l02009">2009</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
References <a class="el" href="../../d2/d1/mm_8h.html#a347a183">HighPagePriority</a>, <a class="el" href="../../d4/d9/ke_8h.html#a413a249">MmCached</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l02058">MmMapLockedPagesSpecifyCache()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/verifier_8c-source.html#l00688">VerifierMapLockedPages()</a>.
<p>
<pre class="fragment"><div>02016                    :
02017 
02018     This function maps physical pages described by a memory descriptor
02019     list into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system <span class="keyword">virtual</span> address space or <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user portion of
02020     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">virtual</span> address space.
02021 
02022 Arguments:
02023 
02024     MemoryDescriptorList - Supplies a valid Memory Descriptor <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a> which has
02025                             been updated by <a class="code" href="../../d2/d1/mm_8h.html#a273">MmProbeAndLockPages</a>.
02026 
02027 
02028     AccessMode - Supplies an indicator of where to map <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pages;
02029                  <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a> indicates that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pages should be mapped in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02030                  system part of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address space, <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a> indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02031                  pages should be mapped in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user part of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address space.
02032 
02033 Return Value:
02034 
02035     Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base address where <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pages are mapped.  The base address
02036     has <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> same offset as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">virtual</span> address in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d6/d7/struct__MDL.html">MDL</a>.
02037 
02038     This routine will raise an exception <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> processor mode <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> USER_MODE
02039     and quota limits or VM limits are exceeded.
02040 
02041 Environment:
02042 
02043     Kernel mode.  <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a> or below <span class="keywordflow">if</span> access mode <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
02044                   <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a> or below <span class="keywordflow">if</span> access mode <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>.
02045 
02046 --*/
02047 
02048 {
02049     <span class="keywordflow">return</span> <a class="code" href="../../d5/d6/iosup_8c.html#a50">MmMapLockedPagesSpecifyCache</a> (MemoryDescriptorList,
02050                                          AccessMode,
02051                                          MmCached,
02052                                          NULL,
02053                                          TRUE,
02054                                          HighPagePriority);
02055 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a50" doxytag="iosup.c::MmMapLockedPagesSpecifyCache" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PVOID MmMapLockedPagesSpecifyCache           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d6/d7/struct__MDL.html">PMDL</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>MemoryDescriptorList</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessMode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d4/d9/ke_8h.html#a156">MEMORY_CACHING_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>CacheType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>RequestedAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>BugCheckOnFailure</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d1/mm_8h.html#a154">MM_PAGE_PRIORITY</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Priority</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l02058">2058</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00221">COMPUTE_PAGES_SPANNED</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d1/mm_8h.html#a347a183">HighPagePriority</a>, <a class="el" href="../../d1/d5/ppc_2flushtb_8c-source.html#l00033">KeFlushEntireTb()</a>, <a class="el" href="../../d1/d4/i386_2flush_8c-source.html#l00187">KeInvalidateAllCaches()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00901">LOCK_PFN2</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00435">MDL_IO_SPACE</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00424">MDL_MAPPED_TO_SYSTEM_VA</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00437">MDL_MAPPING_CAN_FAIL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00425">MDL_PAGES_LOCKED</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00428">MDL_PARTIAL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00429">MDL_PARTIAL_HAS_BEEN_MAPPED</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00434">MDL_PHYSICAL_VIEW</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00426">MDL_SOURCE_IS_NONPAGED_POOL</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00861">MI_DISABLE_CACHING</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00687">MI_SET_PTE_WRITE_COMBINE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02459">MI_WRITE_VALID_PTE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l02030">MiGetSystemPteAvailability()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01842">MiGetVirtualAddressMappedByPte</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l01611">MiInsertPteTracker()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00822">MiLockSystemSpace</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l02785">MiMapLockedPagesInUserSpace()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l01859">MiReleaseDeadPteTrackers()</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l01354">MiReleaseSystemPtes()</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l00524">MiReserveSystemPtes()</a>, <a class="el" href="../../d7/d1/mm_2ia64_2initia64_8c-source.html#l02042">MiSweepCacheMachineDependent()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l00093">MiTrackPtesAborted</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00825">MiUnlockSystemSpace</a>, <a class="el" href="../../d7/d7/mi386_8h-source.html#l00267">MiWriteCombiningPtes</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00321">MM_COLOR_ALIGNMENT</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00315">MM_COLOR_MASK</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00327">MM_COLOR_MASK_VIRTUAL</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00107">MM_EMPTY_LIST</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00116">MM_KSEG0_BASE</a>, <a class="el" href="../../d4/d9/ke_8h.html#a413a249">MmCached</a>, <a class="el" href="../../d4/d9/ke_8h.html#a413a251">MmHardwareCoherentCached</a>, <a class="el" href="../../d4/d9/ke_8h.html#a413a248">MmNonCached</a>, <a class="el" href="../../d4/d9/ke_8h.html#a413a252">MmNonCachedUnordered</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l00026">MmSystemLockPagesCount</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00093">MmTrackPtes</a>, <a class="el" href="../../d4/d9/ke_8h.html#a413a250">MmWriteCombined</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00282">PTE_SHIFT</a>, <a class="el" href="../../d6/d1/ppc_2getcalr_8c-source.html#l00038">RtlGetCallersAddress()</a>, <a class="el" href="../../d4/d8/mi_8h.html#a1003a769">SystemPteSpace</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o15">_MMPFN::u3</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00905">UNLOCK_PFN2</a>, and <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00038">ValidKernelPte</a>.
<p>
Referenced by <a class="el" href="../../d9/d5/forksup_8c-source.html#l00100">MiCloneProcessAddressSpace()</a>, <a class="el" href="../../d0/d5/readwrt_8c-source.html#l00529">MiDoMappedCopy()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l02009">MmMapLockedPages()</a>, <a class="el" href="../../d0/d6/ex_2profile_8c-source.html#l00517">NtStartProfile()</a>, and <a class="el" href="../../d0/d5/verifier_8c-source.html#l00751">VerifierMapLockedPagesSpecifyCache()</a>.
<p>
<pre class="fragment"><div>02069                    :
02070 
02071     This function maps physical pages described by a memory descriptor
02072     list into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system <span class="keyword">virtual</span> address space or <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user portion of
02073     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">virtual</span> address space.
02074 
02075 Arguments:
02076 
02077     MemoryDescriptorList - Supplies a valid Memory Descriptor <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a> which has
02078                            been updated by <a class="code" href="../../d2/d1/mm_8h.html#a273">MmProbeAndLockPages</a>.
02079 
02080     AccessMode - Supplies an indicator of where to map <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pages;
02081                  <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a> indicates that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pages should be mapped in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02082                  system part of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address space, <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a> indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02083                  pages should be mapped in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user part of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address space.
02084 
02085     CacheType - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of cache mapping to use <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d6/d7/struct__MDL.html">MDL</a>.
02086                 <a class="code" href="../../d4/d9/ke_8h.html#a413a249">MmCached</a> indicates <span class="stringliteral">"normal"</span> kernel or user mappings.
02087 
02088     RequestedAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base user address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> view. This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a>
02089                        used <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> AccessMode <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> initial
02090                        value of <span class="keyword">this</span> argument <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not null, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> view will
02091                        be allocated starting at <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified <span class="keyword">virtual</span>
02092                        address rounded down to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> next 64kb address
02093                        boundary. If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> initial value of <span class="keyword">this</span> argument <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
02094                        null, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operating system will determine
02095                        where to allocate <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> view.
02096 
02097     BugCheckOnFailure - Supplies whether to bugcheck <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> mapping cannot be
02098                         obtained.  This flag <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> checked <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d6/d7/struct__MDL.html">MDL</a>'s
02099                         <a class="code" href="../../d0/d9/ntosdef_8h.html#a25">MDL_MAPPING_CAN_FAIL</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> zero, which implies that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02100                         <span class="keywordflow">default</span> <a class="code" href="../../d6/d7/struct__MDL.html">MDL</a> behavior <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to bugcheck.  This flag then
02101                         provides an additional avenue to avoid <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> bugcheck.
02102                         Done <span class="keyword">this</span> way in order to provide WDM compatibility.
02103 
02104     Priority - Supplies an indication as to how important <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> that <span class="keyword">this</span>
02105                request succeed under <a class="code" href="../../d2/d3/fetypes_8h.html#a457a418">low</a> available PTE conditions.
02106 
02107 Return Value:
02108 
02109     Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base address where <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pages are mapped.  The base address
02110     has <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> same offset as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">virtual</span> address in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d6/d7/struct__MDL.html">MDL</a>.
02111 
02112     This routine will raise an exception <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> processor mode <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> USER_MODE
02113     and quota limits or VM limits are exceeded.
02114 
02115 Environment:
02116 
02117     Kernel mode.  <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a> or below <span class="keywordflow">if</span> access mode <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
02118                   <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a> or below <span class="keywordflow">if</span> access mode <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>.
02119 
02120 --*/
02121 
02122 {
02123     PFN_NUMBER NumberOfPages;
02124     PFN_NUMBER SavedPageCount;
02125     PPFN_NUMBER Page;
02126     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
02127     PVOID BaseVa;
02128     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
02129     PVOID StartingVa;
02130     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn2;
02131     KIRQL OldIrql;
02132     PFN_NUMBER NumberOfPtes;
02133     PVOID CallingAddress;
02134     PVOID CallersCaller;
02135     PVOID Tracker;
02136 
02137 <span class="preprocessor">#if !defined (_X86_)</span>
02138 <span class="preprocessor"></span>    CallingAddress = (PVOID)_ReturnAddress();
02139     CallersCaller = (PVOID)0;
02140 <span class="preprocessor">#endif</span>
02141 <span class="preprocessor"></span>
02142     StartingVa = (PVOID)((PCHAR)MemoryDescriptorList-&gt;StartVa +
02143                     MemoryDescriptorList-&gt;ByteOffset);
02144 
02145     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (MemoryDescriptorList-&gt;ByteCount != 0);
02146 
02147     <span class="keywordflow">if</span> (AccessMode == <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
02148 
02149         Page = (PPFN_NUMBER)(MemoryDescriptorList + 1);
02150         NumberOfPages = <a class="code" href="../../d2/d1/mm_8h.html#a9">COMPUTE_PAGES_SPANNED</a> (StartingVa,
02151                                                MemoryDescriptorList-&gt;ByteCount);
02152         SavedPageCount = NumberOfPages;
02153 
02154         <span class="comment">//</span>
02155         <span class="comment">// Map the pages into the system part of the address space as</span>
02156         <span class="comment">// kernel read/write.</span>
02157         <span class="comment">//</span>
02158 
02159         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((MemoryDescriptorList-&gt;MdlFlags &amp; (
02160                         MDL_MAPPED_TO_SYSTEM_VA |
02161                         MDL_SOURCE_IS_NONPAGED_POOL |
02162                         MDL_PARTIAL_HAS_BEEN_MAPPED)) == 0);
02163         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((MemoryDescriptorList-&gt;MdlFlags &amp; (
02164                         MDL_PAGES_LOCKED |
02165                         MDL_PARTIAL)) != 0);
02166 
02167         <span class="comment">//</span>
02168         <span class="comment">// Map this with KSEG0 if possible.</span>
02169         <span class="comment">//</span>
02170 
02171 <span class="preprocessor">#if defined(_ALPHA_)</span>
02172 <span class="preprocessor"></span><span class="preprocessor">#define KSEG0_MAXPAGE ((PFN_NUMBER)((KSEG2_BASE - KSEG0_BASE) &gt;&gt; PAGE_SHIFT))</span>
02173 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
02174 <span class="preprocessor"></span>
02175 <span class="preprocessor">#if defined(_X86_) || defined(_IA64_)</span>
02176 <span class="preprocessor"></span><span class="preprocessor">#define KSEG0_MAXPAGE MmKseg2Frame</span>
02177 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
02178 <span class="preprocessor"></span>
02179 <span class="preprocessor">#if defined(_IA64_)</span>
02180 <span class="preprocessor"></span><span class="preprocessor">#define MM_KSEG0_BASE KSEG0_BASE</span>
02181 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
02182 <span class="preprocessor"></span>
02183         <span class="keywordflow">if</span> ((NumberOfPages == 1) &amp;&amp; (CacheType == <a class="code" href="../../d4/d9/ke_8h.html#a413a249">MmCached</a>) &amp;&amp;
02184             (*Page &lt; KSEG0_MAXPAGE)) {
02185             BaseVa = (PVOID)(<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a3">MM_KSEG0_BASE</a> + (*Page &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>) +
02186                             MemoryDescriptorList-&gt;ByteOffset);
02187             MemoryDescriptorList-&gt;MappedSystemVa = BaseVa;
02188             MemoryDescriptorList-&gt;MdlFlags |= <a class="code" href="../../d0/d9/ntosdef_8h.html#a12">MDL_MAPPED_TO_SYSTEM_VA</a>;
02189 
02190             <span class="keywordflow">goto</span> Update;
02191         }
02192 
02193         <span class="comment">//</span>
02194         <span class="comment">// Make sure there are enough PTEs of the requested size.</span>
02195         <span class="comment">//</span>
02196 
02197         <span class="keywordflow">if</span> ((Priority != <a class="code" href="../../d2/d1/mm_8h.html#a347a183">HighPagePriority</a>) &amp;&amp;
02198             (<a class="code" href="../../d0/d9/sysptes_8c.html#a29">MiGetSystemPteAvailability</a> ((ULONG)NumberOfPages, Priority) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
02199                 <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02200         }
02201 
02202         PointerPte = <a class="code" href="../../d0/d9/sysptes_8c.html#a25">MiReserveSystemPtes</a> (
02203                                     (ULONG)NumberOfPages,
02204                                     SystemPteSpace,
02205                                     MM_COLOR_ALIGNMENT,
02206                                     (PtrToUlong(StartingVa) &amp;
02207                                                        MM_COLOR_MASK_VIRTUAL),
02208                         MemoryDescriptorList-&gt;MdlFlags &amp; MDL_MAPPING_CAN_FAIL ? 0 : BugCheckOnFailure);
02209 
02210         <span class="keywordflow">if</span> (PointerPte == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02211 
02212             <span class="comment">//</span>
02213             <span class="comment">// Not enough system PTES are available.</span>
02214             <span class="comment">//</span>
02215 
02216             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02217         }
02218         BaseVa = (PVOID)((PCHAR)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPte) +
02219                                 MemoryDescriptorList-&gt;ByteOffset);
02220 
02221         NumberOfPtes = NumberOfPages;
02222 
02223         TempPte = <a class="code" href="../../d4/d2/datalpha_8c.html#a2">ValidKernelPte</a>;
02224 
02225         <span class="keywordflow">switch</span> (CacheType) {
02226 
02227             <span class="keywordflow">case</span> <a class="code" href="../../d4/d9/ke_8h.html#a413a248">MmNonCached</a>:
02228                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a118">MI_DISABLE_CACHING</a> (TempPte);
02229                 <span class="keywordflow">break</span>;
02230 
02231             <span class="keywordflow">case</span> <a class="code" href="../../d4/d9/ke_8h.html#a413a249">MmCached</a>:
02232                 <span class="keywordflow">break</span>;
02233 
02234             <span class="keywordflow">case</span> <a class="code" href="../../d4/d9/ke_8h.html#a413a250">MmWriteCombined</a>:
02235                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a111">MI_SET_PTE_WRITE_COMBINE</a> (TempPte);
02236                 <span class="keywordflow">break</span>;
02237 
02238             <span class="keywordflow">case</span> <a class="code" href="../../d4/d9/ke_8h.html#a413a251">MmHardwareCoherentCached</a>:
02239                 <span class="keywordflow">break</span>;
02240 
02241 <span class="preprocessor">#if 0</span>
02242 <span class="preprocessor"></span>            <span class="keywordflow">case</span> <a class="code" href="../../d4/d9/ke_8h.html#a413a252">MmNonCachedUnordered</a>:
02243                 <span class="keywordflow">break</span>;
02244 <span class="preprocessor">#endif</span>
02245 <span class="preprocessor"></span>
02246             <span class="keywordflow">default</span>:
02247                 <span class="keywordflow">break</span>;
02248         }
02249 
02250 <span class="preprocessor">#if defined(_IA64_)</span>
02251 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (CacheType != <a class="code" href="../../d4/d9/ke_8h.html#a413a249">MmCached</a>) {
02252             <a class="code" href="../../d0/d6/ppc_2flushtb_8c.html#a0">KeFlushEntireTb</a>(FALSE, TRUE);
02253         }
02254 <span class="preprocessor">#endif</span>
02255 <span class="preprocessor"></span>
02256 <span class="preprocessor">#if DBG</span>
02257 <span class="preprocessor"></span>        <a class="code" href="../../d4/d8/mi_8h.html#a130">LOCK_PFN2</a> (OldIrql);
02258 <span class="preprocessor">#endif //DBG</span>
02259 <span class="preprocessor"></span>
02260         <span class="keywordflow">do</span> {
02261 
02262             <span class="keywordflow">if</span> (*Page == <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>) {
02263                 <span class="keywordflow">break</span>;
02264             }
02265             TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber = *Page;
02266             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0);
02267 
02268 <span class="preprocessor">#if DBG</span>
02269 <span class="preprocessor"></span>            <span class="keywordflow">if</span> ((MemoryDescriptorList-&gt;MdlFlags &amp; (<a class="code" href="../../d0/d9/ntosdef_8h.html#a23">MDL_IO_SPACE</a> | <a class="code" href="../../d0/d9/ntosdef_8h.html#a22">MDL_PHYSICAL_VIEW</a>)) == 0) {
02270                 Pfn2 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (*Page);
02271                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount != 0);
02272                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((((ULONG_PTR)PointerPte &gt;&gt; PTE_SHIFT) &amp; MM_COLOR_MASK) ==
02273                      (((ULONG)Pfn2-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageColor)));
02274             }
02275 <span class="preprocessor">#endif //DBG</span>
02276 <span class="preprocessor"></span>
02277             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a> (PointerPte, TempPte);
02278             Page += 1;
02279             PointerPte += 1;
02280             NumberOfPages -= 1;
02281         } <span class="keywordflow">while</span> (NumberOfPages != 0);
02282 
02283 <span class="preprocessor">#if DBG</span>
02284 <span class="preprocessor"></span>        <a class="code" href="../../d4/d8/mi_8h.html#a131">UNLOCK_PFN2</a> (OldIrql);
02285 <span class="preprocessor">#endif //DBG</span>
02286 <span class="preprocessor"></span>
02287 <span class="preprocessor">#if defined(i386)</span>
02288 <span class="preprocessor"></span>        <span class="comment">//</span>
02289         <span class="comment">// If write combined was specified then flush all caches and TBs.</span>
02290         <span class="comment">//</span>
02291 
02292         <span class="keywordflow">if</span> (CacheType == <a class="code" href="../../d4/d9/ke_8h.html#a413a250">MmWriteCombined</a> &amp;&amp; <a class="code" href="../../d6/d8/mi386_8h.html#a204">MiWriteCombiningPtes</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
02293             <a class="code" href="../../d0/d6/ppc_2flushtb_8c.html#a0">KeFlushEntireTb</a> (FALSE, TRUE);
02294             <a class="code" href="../../d0/d5/i386_2flush_8c.html#a2">KeInvalidateAllCaches</a> (TRUE);
02295         }
02296 <span class="preprocessor">#endif</span>
02297 <span class="preprocessor"></span>
02298 <span class="preprocessor">#if defined(_IA64_)</span>
02299 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (CacheType != <a class="code" href="../../d4/d9/ke_8h.html#a413a249">MmCached</a>) {
02300             <a class="code" href="../../d2/d9/miia64_8h.html#a318">MiSweepCacheMachineDependent</a>(BaseVa, SavedPageCount * PAGE_SIZE, CacheType);
02301         }
02302 <span class="preprocessor">#endif</span>
02303 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a37">MmTrackPtes</a> != 0) {
02304 
02305             <span class="comment">//</span>
02306             <span class="comment">// First free any zombie blocks as no locks are being held.</span>
02307             <span class="comment">//</span>
02308 
02309             <a class="code" href="../../d5/d6/iosup_8c.html#a35">MiReleaseDeadPteTrackers</a> ();
02310 
02311             Tracker = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (NonPagedPool,
02312                                              <span class="keyword">sizeof</span> (<a class="code" href="../../d7/d1/struct__PTE__TRACKER.html">PTE_TRACKER</a>),
02313                                              'ySmM');
02314             <span class="keywordflow">if</span> (Tracker == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02315                 <a class="code" href="../../d5/d6/iosup_8c.html#a9">MiTrackPtesAborted</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02316             }
02317         }
02318 
02319         <a class="code" href="../../d4/d8/mi_8h.html#a117">MiLockSystemSpace</a>(OldIrql);
02320         <span class="keywordflow">if</span> (MemoryDescriptorList-&gt;MdlFlags &amp; <a class="code" href="../../d0/d9/ntosdef_8h.html#a12">MDL_MAPPED_TO_SYSTEM_VA</a>) {
02321 
02322             <span class="comment">//</span>
02323             <span class="comment">// Another thread must have already mapped this.</span>
02324             <span class="comment">// Clean up the system PTES and release them.</span>
02325             <span class="comment">//</span>
02326 
02327             <a class="code" href="../../d4/d8/mi_8h.html#a118">MiUnlockSystemSpace</a>(OldIrql);
02328 
02329             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a37">MmTrackPtes</a> != 0) {
02330                 <span class="keywordflow">if</span> (Tracker != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02331                     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(Tracker);
02332                 }
02333             }
02334 
02335 <span class="preprocessor">#if DBG</span>
02336 <span class="preprocessor"></span>            <span class="keywordflow">if</span> ((MemoryDescriptorList-&gt;MdlFlags &amp; (<a class="code" href="../../d0/d9/ntosdef_8h.html#a23">MDL_IO_SPACE</a> | <a class="code" href="../../d0/d9/ntosdef_8h.html#a22">MDL_PHYSICAL_VIEW</a>)) == 0) {
02337                 <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn3;
02338                 PFN_NUMBER j;
02339                 PPFN_NUMBER Page1;
02340     
02341                 Page1 = (PPFN_NUMBER)(MemoryDescriptorList + 1);
02342                 <span class="keywordflow">for</span> (j = 0; j &lt; SavedPageCount ;j += 1) {
02343                     <span class="keywordflow">if</span> (*Page == <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>) {
02344                         <span class="keywordflow">break</span>;
02345                     }
02346                     Pfn3 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (*Page1);
02347                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn3-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount != 0);
02348                     Page1 += 1;
02349                 }
02350             }
02351 <span class="preprocessor">#endif //DBG</span>
02352 <span class="preprocessor"></span>            PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (BaseVa);
02353 
02354             <a class="code" href="../../d0/d9/sysptes_8c.html#a26">MiReleaseSystemPtes</a> (PointerPte,
02355                                  (ULONG)SavedPageCount,
02356                                  SystemPteSpace);
02357 
02358             <span class="keywordflow">return</span> MemoryDescriptorList-&gt;MappedSystemVa;
02359         }
02360 
02361         MemoryDescriptorList-&gt;MappedSystemVa = BaseVa;
02362         *(<span class="keyword">volatile</span> ULONG *)&amp;<a class="code" href="../../d5/d6/iosup_8c.html#a2">MmSystemLockPagesCount</a>;  <span class="comment">//need to force order.</span>
02363         MemoryDescriptorList-&gt;MdlFlags |= <a class="code" href="../../d0/d9/ntosdef_8h.html#a12">MDL_MAPPED_TO_SYSTEM_VA</a>;
02364 
02365         <span class="keywordflow">if</span> ((<a class="code" href="../../d8/d0/cmdat3_8c.html#a37">MmTrackPtes</a> != 0) &amp;&amp; (Tracker != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
02366 <span class="preprocessor">#if defined (_X86_)</span>
02367 <span class="preprocessor"></span>            <a class="code" href="../../d5/d2/ppc_2getcalr_8c.html#a0">RtlGetCallersAddress</a>(&amp;CallingAddress, &amp;CallersCaller);
02368 <span class="preprocessor">#endif</span>
02369 <span class="preprocessor"></span>            <a class="code" href="../../d5/d6/iosup_8c.html#a33">MiInsertPteTracker</a> (Tracker,
02370                                 MemoryDescriptorList,
02371                                 NumberOfPtes,
02372                                 CallingAddress,
02373                                 CallersCaller);
02374         }
02375 
02376         <a class="code" href="../../d4/d8/mi_8h.html#a118">MiUnlockSystemSpace</a>(OldIrql);
02377 
02378 Update:
02379         <span class="keywordflow">if</span> ((MemoryDescriptorList-&gt;MdlFlags &amp; <a class="code" href="../../d0/d9/ntosdef_8h.html#a16">MDL_PARTIAL</a>) != 0) {
02380             MemoryDescriptorList-&gt;MdlFlags |= <a class="code" href="../../d0/d9/ntosdef_8h.html#a17">MDL_PARTIAL_HAS_BEEN_MAPPED</a>;
02381         }
02382 
02383         <span class="keywordflow">return</span> BaseVa;
02384 
02385     } <span class="keywordflow">else</span> {
02386 
02387         <span class="keywordflow">return</span> <a class="code" href="../../d5/d6/iosup_8c.html#a29">MiMapLockedPagesInUserSpace</a> (MemoryDescriptorList,
02388                                             StartingVa,
02389                                             CacheType,
02390                                             RequestedAddress);
02391     }
02392 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a82" doxytag="iosup.c::MmMapMemoryDumpMdl" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MmMapMemoryDumpMdl           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT <a class="el" href="../../d6/d7/struct__MDL.html">PMDL</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>MemoryDumpMdl</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l07197">7197</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00141">BYTES_TO_PAGES</a>, <a class="el" href="../../d0/d0/ki_8h.html#a114">KiFlushSingleTb()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01842">MiGetVirtualAddressMappedByPte</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00425">MM_KERNEL_DEMAND_ZERO_PTE</a>, <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00105">MmCrashDumpPte</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, and <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00038">ValidKernelPte</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l02081">IopMapPhysicalMemory()</a>, and <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l03183">IopWritePageToDisk()</a>.
<p>
<pre class="fragment"><div>07203                    :
07204 
07205     For use by crash dump routine ONLY.  Maps an <a class="code" href="../../d6/d7/struct__MDL.html">MDL</a> into a fixed
07206     portion of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address space.  Only 1 <a class="code" href="../../d6/d7/struct__MDL.html">MDL</a> can be mapped at a
07207     time.
07208 
07209 Arguments:
07210 
07211     MemoryDumpMdl - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d6/d7/struct__MDL.html">MDL</a> to map.
07212 
07213 Return Value:
07214 
07215     None, fields in <a class="code" href="../../d6/d7/struct__MDL.html">MDL</a> updated.
07216 
07217 --*/
07218 
07219 {
07220     PFN_NUMBER NumberOfPages;
07221     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
07222     PCHAR BaseVa;
07223     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
07224     PPFN_NUMBER Page;
07225 
07226     NumberOfPages = <a class="code" href="../../d2/d1/mm_8h.html#a5">BYTES_TO_PAGES</a> (MemoryDumpMdl-&gt;ByteCount + MemoryDumpMdl-&gt;ByteOffset);
07227 
07228     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (NumberOfPages &lt;= 16);
07229 
07230     PointerPte = <a class="code" href="../../d4/d2/datalpha_8c.html#a19">MmCrashDumpPte</a>;
07231     BaseVa = (PCHAR)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a>(PointerPte);
07232     MemoryDumpMdl-&gt;MappedSystemVa = (PCHAR)BaseVa + MemoryDumpMdl-&gt;ByteOffset;
07233     TempPte = <a class="code" href="../../d4/d2/datalpha_8c.html#a2">ValidKernelPte</a>;
07234     Page = (PPFN_NUMBER)(MemoryDumpMdl + 1);
07235 
07236     <span class="comment">//</span>
07237     <span class="comment">// If the pages don't span the entire dump virtual address range,</span>
07238     <span class="comment">// build a barrier.  Otherwise use the default barrier provided at the</span>
07239     <span class="comment">// end of the dump virtual address range.</span>
07240     <span class="comment">//</span>
07241 
07242     <span class="keywordflow">if</span> (NumberOfPages &lt; 16) {
07243         <a class="code" href="../../d0/d0/ki_8h.html#a114">KiFlushSingleTb</a> (TRUE, BaseVa + (NumberOfPages &lt;&lt; PAGE_SHIFT));
07244         (PointerPte + NumberOfPages)-&gt;u.Long = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a96">MM_KERNEL_DEMAND_ZERO_PTE</a>;
07245     }
07246 
07247     <span class="keywordflow">do</span> {
07248 
07249         <a class="code" href="../../d0/d0/ki_8h.html#a114">KiFlushSingleTb</a> (TRUE, BaseVa);
07250 
07251         TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber = *Page;
07252 
07253         <span class="comment">//</span>
07254         <span class="comment">// Note this PTE may be valid or invalid prior to the overwriting here.</span>
07255         <span class="comment">//</span>
07256 
07257         *PointerPte = TempPte;
07258 
07259         Page += 1;
07260         PointerPte += 1;
07261         BaseVa += <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
07262         NumberOfPages -= 1;
07263     } <span class="keywordflow">while</span> (NumberOfPages != 0);
07264 
07265     <span class="keywordflow">return</span>;
07266 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a65" doxytag="iosup.c::MmMapUserAddressesToPage" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS MmMapUserAddressesToPage           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>BaseAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN SIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>NumberOfBytes</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>PageAddress</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l05161">5161</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
References <a class="el" href="../../d2/d8/ps_8h-source.html#l00216">_EPROCESS::AddressSpaceDeleted</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02385">_MMVAD::EndingVpn</a>, <a class="el" href="../../d1/d5/ppc_2flushtb_8c-source.html#l00033">KeFlushEntireTb()</a>, <a class="el" href="../../d1/d5/ppc_2flushtb_8c-source.html#l00188">KeFlushSingleTb()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01093">LOCK_WS_AND_ADDRESS_SPACE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00761">MI_VA_TO_VPN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00763">MI_VPN_TO_VA</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00765">MI_VPN_TO_VA_ENDING</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02543">MiFillMemoryPte</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d7/d2/vadtree_8c-source.html#l00380">MiLocateAddress()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l05490">MmGetPhysicalAddress()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02384">_MMVAD::StartingVpn</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d6/d6/struct__MMVAD.html#o7">_MMVAD::u</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01097">UNLOCK_WS_AND_ADDRESS_SPACE</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
<pre class="fragment"><div>05169                    :
05170 
05171     This function maps a range of addresses in a physical memory VAD to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
05172     specified page address.  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> typically used by a driver to nicely
05173     remove an application's access to things like video memory when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
05174     application <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not responding to requests to relinquish <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>.
05175 
05176     Note <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> entire range must be currently mapped (ie, all the PTEs must
05177     be valid) by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller.
05178 
05179 Arguments:
05180 
05181     BaseAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base <span class="keyword">virtual</span> address where <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> physical
05182                   address <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> mapped.
05183 
05184     NumberOfBytes - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of bytes to remap to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> address.
05185 
05186     PageAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">virtual</span> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> page <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> remapped to.
05187                   This must be nonpaged memory.
05188 
05189 Return Value:
05190 
05191     Various <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> codes.
05192 
05193 Environment:
05194 
05195     Kernel mode, IRQL of <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a> or below.
05196 
05197 --*/
05198 
05199 {
05200     <a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a> Vad;
05201     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
05202     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> PteContents;
05203     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastPte;
05204     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
05205     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
05206     PVOID EndingAddress;
05207     PFN_NUMBER PageFrameNumber;
05208     SIZE_T NumberOfPtes;
05209     PHYSICAL_ADDRESS PhysicalAddress;
05210     KIRQL OldIrql;
05211 
05212     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
05213 
05214     <span class="keywordflow">if</span> (BaseAddress &gt; MM_HIGHEST_USER_ADDRESS) {
05215         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER_1;
05216     }
05217 
05218     <span class="keywordflow">if</span> ((ULONG_PTR)BaseAddress + NumberOfBytes &gt; (ULONG64)MM_HIGHEST_USER_ADDRESS) {
05219         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER_2;
05220     }
05221 
05222     Process = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>();
05223 
05224     EndingAddress = (PVOID)((PCHAR)BaseAddress + NumberOfBytes - 1);
05225 
05226     <a class="code" href="../../d4/d8/mi_8h.html#a161">LOCK_WS_AND_ADDRESS_SPACE</a> (Process);
05227 
05228     <span class="comment">//</span>
05229     <span class="comment">// Make sure the address space was not deleted.</span>
05230     <span class="comment">//</span>
05231 
05232     <span class="keywordflow">if</span> (Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o27">AddressSpaceDeleted</a> != 0) {
05233         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_PROCESS_IS_TERMINATING;
05234         <span class="keywordflow">goto</span> ErrorReturn;
05235     }
05236 
05237     Vad = (<a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a>)<a class="code" href="../../d6/d3/vadtree_8c.html#a2">MiLocateAddress</a> (BaseAddress);
05238 
05239     <span class="keywordflow">if</span> (Vad == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
05240 
05241         <span class="comment">//</span>
05242         <span class="comment">// No virtual address descriptor located.</span>
05243         <span class="comment">//</span>
05244 
05245         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_MEMORY_NOT_ALLOCATED;
05246         <span class="keywordflow">goto</span> ErrorReturn;
05247     }
05248 
05249     <span class="keywordflow">if</span> (NumberOfBytes == 0) {
05250 
05251         <span class="comment">//</span>
05252         <span class="comment">// If the region size is specified as 0, the base address</span>
05253         <span class="comment">// must be the starting address for the region.  The entire VAD</span>
05254         <span class="comment">// will then be repointed.</span>
05255         <span class="comment">//</span>
05256 
05257         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a107">MI_VA_TO_VPN</a> (BaseAddress) != Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o0">StartingVpn</a>) {
05258             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_FREE_VM_NOT_AT_BASE;
05259             <span class="keywordflow">goto</span> ErrorReturn;
05260         }
05261 
05262         BaseAddress = <a class="code" href="../../d4/d8/mi_8h.html#a108">MI_VPN_TO_VA</a> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o0">StartingVpn</a>);
05263         EndingAddress = <a class="code" href="../../d4/d8/mi_8h.html#a109">MI_VPN_TO_VA_ENDING</a> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o1">EndingVpn</a>);
05264         NumberOfBytes = (PCHAR)EndingAddress - (PCHAR)BaseAddress + 1;
05265     }
05266 
05267     <span class="comment">//</span>
05268     <span class="comment">// Found the associated virtual address descriptor.</span>
05269     <span class="comment">//</span>
05270 
05271     <span class="keywordflow">if</span> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o1">EndingVpn</a> &lt; <a class="code" href="../../d4/d8/mi_8h.html#a107">MI_VA_TO_VPN</a> (EndingAddress)) {
05272 
05273         <span class="comment">//</span>
05274         <span class="comment">// The entire range to remap is not contained within a single</span>
05275         <span class="comment">// virtual address descriptor.  Return an error.</span>
05276         <span class="comment">//</span>
05277 
05278         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER_2;
05279         <span class="keywordflow">goto</span> ErrorReturn;
05280     }
05281 
05282     <span class="keywordflow">if</span> (Vad-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.PhysicalMapping == 0) {
05283 
05284         <span class="comment">//</span>
05285         <span class="comment">// The virtual address descriptor is not a physical mapping.</span>
05286         <span class="comment">//</span>
05287 
05288         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_ADDRESS;
05289         <span class="keywordflow">goto</span> ErrorReturn;
05290     }
05291 
05292     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (BaseAddress);
05293     LastPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (EndingAddress);
05294     NumberOfPtes = LastPte - PointerPte + 1;
05295 
05296     PhysicalAddress = <a class="code" href="../../d5/d6/iosup_8c.html#a68">MmGetPhysicalAddress</a> (PageAddress);
05297     PageFrameNumber = (PFN_NUMBER)(PhysicalAddress.QuadPart &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
05298 
05299     PteContents = *PointerPte;
05300     PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber = PageFrameNumber;
05301 
05302 <span class="preprocessor">#if DBG</span>
05303 <span class="preprocessor"></span>
05304     <span class="comment">//</span>
05305     <span class="comment">// All the PTEs must be valid or the filling will corrupt the</span>
05306     <span class="comment">// UsedPageTableCounts.</span>
05307     <span class="comment">//</span>
05308 
05309     <span class="keywordflow">do</span> {
05310         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte-&gt;u.Hard.Valid == 1);
05311         PointerPte += 1;
05312     } <span class="keywordflow">while</span> (PointerPte &lt; LastPte);
05313     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (BaseAddress);
05314 <span class="preprocessor">#endif</span>
05315 <span class="preprocessor"></span>
05316     <span class="comment">//</span>
05317     <span class="comment">// Fill the PTEs and flush at the end - no race here because it doesn't</span>
05318     <span class="comment">// matter whether the user app sees the old or the new data until we</span>
05319     <span class="comment">// return (writes going to either page is acceptable prior to return</span>
05320     <span class="comment">// from this function).  There is no race with I/O and ProbeAndLockPages</span>
05321     <span class="comment">// because the PFN lock is acquired here.</span>
05322     <span class="comment">//</span>
05323 
05324     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
05325 
05326 <span class="preprocessor">#if !defined (_X86PAE_)</span>
05327 <span class="preprocessor"></span>    <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a189">MiFillMemoryPte</a> (PointerPte,
05328                      NumberOfPtes * <span class="keyword">sizeof</span> (<a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>),
05329                      PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long);
05330 <span class="preprocessor">#else</span>
05331 <span class="preprocessor"></span>
05332     <span class="comment">//</span>
05333     <span class="comment">// Note that the PAE architecture must very carefully fill these PTEs.</span>
05334     <span class="comment">//</span>
05335 
05336     <span class="keywordflow">do</span> {
05337         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte-&gt;u.Hard.Valid == 1);
05338         PointerPte += 1;
05339         (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>)KeInterlockedSwapPte ((PHARDWARE_PTE)PointerPte,
05340                                     (PHARDWARE_PTE)&amp;PteContents);
05341     } <span class="keywordflow">while</span> (PointerPte &lt; LastPte);
05342     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (BaseAddress);
05343 
05344 <span class="preprocessor">#endif</span>
05345 <span class="preprocessor"></span>
05346     <span class="keywordflow">if</span> (NumberOfPtes == 1) {
05347 
05348         (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>)<a class="code" href="../../d0/d6/ppc_2flushtb_8c.html#a2">KeFlushSingleTb</a> (BaseAddress,
05349                                TRUE,
05350                                TRUE,
05351                                (PHARDWARE_PTE)PointerPte,
05352                                PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Flush);
05353     }
05354     <span class="keywordflow">else</span> {
05355         <a class="code" href="../../d0/d6/ppc_2flushtb_8c.html#a0">KeFlushEntireTb</a> (TRUE, TRUE);
05356     }
05357 
05358     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
05359 
05360     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
05361 
05362 ErrorReturn:
05363 
05364     <a class="code" href="../../d4/d8/mi_8h.html#a162">UNLOCK_WS_AND_ADDRESS_SPACE</a> (Process);
05365 
05366     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
05367 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a85" doxytag="iosup.c::MmMapVideoDisplay" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PVOID MmMapVideoDisplay           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PHYSICAL_ADDRESS&nbsp;</td>
          <td class="mdname" nowrap> <em>PhysicalAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN SIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>NumberOfBytes</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d4/d9/ke_8h.html#a156">MEMORY_CACHING_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>CacheType</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l07516">7516</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00166">BYTE_OFFSET</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00221">COMPUTE_PAGES_SPANNED</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00861">MI_DISABLE_CACHING</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00808">MI_SET_GLOBAL_STATE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02459">MI_WRITE_VALID_PTE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02543">MiFillMemoryPte</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01591">MiGetSubsectionAddressForPte</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01842">MiGetVirtualAddressMappedByPte</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01495">MiProtoAddressForPte</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l01354">MiReleaseSystemPtes()</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l00524">MiReserveSystemPtes()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00142">MM_NOCACHE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00137">MM_READWRITE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00278">MM_VA_MAPPED_BY_PDE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00412">MM_ZERO_KERNEL_PTE</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l03415">MmMapIoSpace()</a>, <a class="el" href="../../d4/d1/dataia64_8c-source.html#l00180">MmPageSizeInfo</a>, <a class="el" href="../../d8/d8/alpha_2mialpha_8h.html#a213">MMPTE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00282">PTE_SHIFT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02123">_SUBSECTION::PtesInSubsection</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02119">_SUBSECTION::StartingSector</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02121">_SUBSECTION::SubsectionBase</a>, <a class="el" href="../../d4/d8/mi_8h.html#a1003a769">SystemPteSpace</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d1/d7/struct__SUBSECTION.html#o3">_SUBSECTION::u</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00038">ValidKernelPte</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00094">X64K</a>, and <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00036">ZeroKernelPte</a>.
<p>
<pre class="fragment"><div>07524                    :
07525 
07526     This function maps <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified physical address into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> non-pagable
07527     portion of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system address space.
07528 
07529 Arguments:
07530 
07531     PhysicalAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> starting physical address to map.
07532 
07533     NumberOfBytes - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of bytes to map.
07534 
07535     CacheType - Supplies <a class="code" href="../../d4/d9/ke_8h.html#a413a248">MmNonCached</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> physical address <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be mapped
07536                 as non-cached, <a class="code" href="../../d4/d9/ke_8h.html#a413a249">MmCached</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address should be cached, and
07537                 <a class="code" href="../../d4/d9/ke_8h.html#a413a250">MmWriteCombined</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address should be cached and
07538                 write-combined as a frame buffer. For I/O device registers,
07539                 <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> usually specified as <a class="code" href="../../d4/d9/ke_8h.html#a413a248">MmNonCached</a>.
07540 
07541 Return Value:
07542 
07543     Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">virtual</span> address which maps <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified physical addresses.
07544     The value <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned <span class="keywordflow">if</span> sufficient <span class="keyword">virtual</span> address space <span class="keywordflow">for</span>
07545     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> mapping could not be found.
07546 
07547 Environment:
07548 
07549     Kernel mode, IRQL of <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a> or below.
07550 
07551 --*/
07552 
07553 {
07554     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
07555     PVOID BaseVa;
07556 <span class="preprocessor">#ifdef LARGE_PAGES</span>
07557 <span class="preprocessor"></span>    <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
07558     PFN_NUMBER PageFrameIndex;
07559     PFN_NUMBER NumberOfPages;
07560     ULONG size;
07561     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> protoPte;
07562     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> largePte;
07563     ULONG pageSize;
07564     <a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a> Subsection;
07565     ULONG Alignment;
07566     ULONG EmPageSize;
07567 <span class="preprocessor">#endif LARGE_PAGES</span>
07568 <span class="preprocessor"></span>    ULONG LargePages;
07569 
07570     LargePages = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
07571     PointerPte = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
07572 
07573 <span class="preprocessor">#if defined (i386) &amp;&amp; !defined (_X86PAE_)</span>
07574 <span class="preprocessor"></span>    <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PhysicalAddress.HighPart == 0);
07575 <span class="preprocessor">#endif</span>
07576 <span class="preprocessor"></span>
07577     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
07578 
07579     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (NumberOfBytes != 0);
07580 
07581 <span class="preprocessor">#ifdef LARGE_PAGES</span>
07582 <span class="preprocessor"></span>    NumberOfPages = <a class="code" href="../../d2/d1/mm_8h.html#a9">COMPUTE_PAGES_SPANNED</a> (PhysicalAddress.LowPart,
07583                                            NumberOfBytes);
07584 
07585     TempPte = <a class="code" href="../../d4/d2/datalpha_8c.html#a2">ValidKernelPte</a>;
07586     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a118">MI_DISABLE_CACHING</a> (TempPte);
07587     PageFrameIndex = (PFN_NUMBER)(PhysicalAddress.QuadPart &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
07588     TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber = PageFrameIndex;
07589 
07590     <span class="keywordflow">if</span> ((NumberOfBytes &gt; <a class="code" href="../../d4/d8/mi_8h.html#a18">X64K</a>) &amp;&amp; (!MmLargeVideoMapped)) {
07591         size = (NumberOfBytes - 1) &gt;&gt; (<a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a> + 1);
07592         pageSize = <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
07593 
07594         <span class="keywordflow">while</span> (size != 0) {
07595             size = size &gt;&gt; 2;
07596             pageSize = pageSize &lt;&lt; 2;
07597         }
07598 
07599         Alignment = pageSize &lt;&lt; 1;
07600         <span class="keywordflow">if</span> (Alignment &lt; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a50">MM_VA_MAPPED_BY_PDE</a>) {
07601             Alignment = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a50">MM_VA_MAPPED_BY_PDE</a>;
07602         }
07603 
07604 <span class="preprocessor">#if defined(_IA64_)</span>
07605 <span class="preprocessor"></span>
07606         <span class="comment">//</span>
07607         <span class="comment">// Convert pageSize to the EM specific page-size field format</span>
07608         <span class="comment">//</span>
07609 
07610         EmPageSize = 0;
07611         size = pageSize - 1 ;
07612 
07613         <span class="keywordflow">while</span> (size) {
07614             size = size &gt;&gt; 1;
07615             EmPageSize += 1;
07616         }
07617 
07618         <span class="keywordflow">if</span> (NumberOfBytes &gt; pageSize) {
07619 
07620             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d2/dataia64_8c.html#a27">MmPageSizeInfo</a> &amp; (pageSize &lt;&lt; 1)) {
07621 
07622                 <span class="comment">//</span>
07623                 <span class="comment">// if larger page size is supported in the implementation</span>
07624                 <span class="comment">//</span>
07625 
07626                 pageSize = pageSize &lt;&lt; 1;
07627                 EmPageSize += 1;
07628 
07629             }
07630             <span class="keywordflow">else</span> {
07631 
07632                 EmPageSize = EmPageSize | pageSize;
07633 
07634             }
07635         }
07636 
07637         pageSize = EmPageSize;
07638 <span class="preprocessor">#endif</span>
07639 <span class="preprocessor"></span>
07640         NumberOfPages = Alignment &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
07641 
07642         PointerPte = <a class="code" href="../../d0/d9/sysptes_8c.html#a25">MiReserveSystemPtes</a>(NumberOfPages,
07643                                          SystemPteSpace,
07644                                          Alignment,
07645                                          0,
07646                                          FALSE);
07647 
07648         <span class="keywordflow">if</span> (PointerPte == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
07649             <span class="keywordflow">goto</span> MapWithSmallPages;
07650         }
07651 
07652         protoPte = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (PagedPool,
07653                                            <span class="keyword">sizeof</span> (<a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>),
07654                                            'bSmM');
07655 
07656         <span class="keywordflow">if</span> (protoPte == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
07657             <a class="code" href="../../d0/d9/sysptes_8c.html#a26">MiReleaseSystemPtes</a>(PointerPte, NumberOfPages, SystemPteSpace);
07658             <span class="keywordflow">goto</span> MapWithSmallPages;
07659         }
07660 
07661         Subsection = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (NonPagedPool,
07662                                      <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d7/struct__SUBSECTION.html">SUBSECTION</a>) + (4 * <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>)),
07663                                      'bSmM');
07664 
07665         <span class="keywordflow">if</span> (Subsection == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
07666             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (protoPte);
07667             <a class="code" href="../../d0/d9/sysptes_8c.html#a26">MiReleaseSystemPtes</a>(PointerPte, NumberOfPages, SystemPteSpace);
07668             <span class="keywordflow">goto</span> MapWithSmallPages;
07669         }
07670 
07671         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a189">MiFillMemoryPte</a> (PointerPte,
07672                          Alignment &gt;&gt; (PAGE_SHIFT - PTE_SHIFT),
07673                          MM_ZERO_KERNEL_PTE);
07674 
07675         <span class="comment">//</span>
07676         <span class="comment">// Build large page descriptor and fill in all the PTEs.</span>
07677         <span class="comment">//</span>
07678 
07679         Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o4">StartingSector</a> = pageSize;
07680         Subsection-&gt;EndingSector = (ULONG)NumberOfPages;
07681         Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o3">u</a>.LongFlags = 0;
07682         Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o3">u</a>.SubsectionFlags.LargePages = 1;
07683         Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o3">u</a>.SubsectionFlags.Protection = <a class="code" href="../../d4/d8/mi_8h.html#a39">MM_READWRITE</a> | <a class="code" href="../../d4/d8/mi_8h.html#a43">MM_NOCACHE</a>;
07684         Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o8">PtesInSubsection</a> = Alignment;
07685         Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o6">SubsectionBase</a> = PointerPte;
07686 
07687         largePte = (<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>)(Subsection + 1);
07688 
07689         <span class="comment">//</span>
07690         <span class="comment">// Build the first 2 PTEs as entries for the TLB to</span>
07691         <span class="comment">// map the specified physical address.</span>
07692         <span class="comment">//</span>
07693 
07694         *largePte = TempPte;
07695         largePte += 1;
07696 
07697         <span class="keywordflow">if</span> (NumberOfBytes &gt; pageSize) {
07698             *largePte = TempPte;
07699             largePte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber += (pageSize &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
07700         } <span class="keywordflow">else</span> {
07701             *largePte = <a class="code" href="../../d4/d2/datalpha_8c.html#a1">ZeroKernelPte</a>;
07702         }
07703 
07704         <span class="comment">//</span>
07705         <span class="comment">// Build the first prototype PTE as a paging file format PTE</span>
07706         <span class="comment">// referring to the subsection.</span>
07707         <span class="comment">//</span>
07708 
07709         protoPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a149">MiGetSubsectionAddressForPte</a>(Subsection);
07710         protoPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype = 1;
07711         protoPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Protection = <a class="code" href="../../d4/d8/mi_8h.html#a39">MM_READWRITE</a> | <a class="code" href="../../d4/d8/mi_8h.html#a43">MM_NOCACHE</a>;
07712 
07713         <span class="comment">//</span>
07714         <span class="comment">// Set the PTE up for all the user's PTE entries, proto pte</span>
07715         <span class="comment">// format pointing to the 3rd prototype PTE.</span>
07716         <span class="comment">//</span>
07717 
07718         TempPte.u.Long = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a145">MiProtoAddressForPte</a> (protoPte);
07719         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a116">MI_SET_GLOBAL_STATE</a> (TempPte, 1);
07720         LargePages = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
07721         MmLargeVideoMapped = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
07722     }
07723 
07724     <span class="keywordflow">if</span> (PointerPte != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
07725         BaseVa = (PVOID)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a> (PointerPte);
07726         BaseVa = (PVOID)((PCHAR)BaseVa + <a class="code" href="../../d2/d1/mm_8h.html#a6">BYTE_OFFSET</a>(PhysicalAddress.LowPart));
07727 
07728         <span class="keywordflow">do</span> {
07729             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0);
07730             <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a186">MI_WRITE_VALID_PTE</a> (PointerPte, TempPte);
07731             PointerPte += 1;
07732             NumberOfPages -= 1;
07733         } <span class="keywordflow">while</span> (NumberOfPages != 0);
07734     } <span class="keywordflow">else</span> {
07735 
07736 MapWithSmallPages:
07737 
07738 <span class="preprocessor">#endif //LARGE_PAGES</span>
07739 <span class="preprocessor"></span>
07740         BaseVa = <a class="code" href="../../d5/d6/iosup_8c.html#a57">MmMapIoSpace</a> (PhysicalAddress,
07741                                NumberOfBytes,
07742                                CacheType);
07743 <span class="preprocessor">#ifdef LARGE_PAGES</span>
07744 <span class="preprocessor"></span>    }
07745 <span class="preprocessor">#endif //LARGE_PAGES</span>
07746 <span class="preprocessor"></span>
07747     <span class="keywordflow">return</span> BaseVa;
07748 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a41" doxytag="iosup.c::MmProbeAndLockPages" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MmProbeAndLockPages           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT <a class="el" href="../../d6/d7/struct__MDL.html">PMDL</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>MemoryDescriptorList</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessMode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d1/mm_8h.html#a141">LOCK_OPERATION</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Operation</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l00238">238</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
References <a class="el" href="../../d3/d0/mm_8h-source.html#l00217">ADDRESS_AND_SIZE_TO_SPAN_PAGES</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d0/bench_8c-source.html#l00050">CHAR</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00221">COMPUTE_PAGES_SPANNED</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02429">_MI_PHYSICAL_VIEW::EndVa</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d1/d3/ex_2alpha_2raisests_8c-source.html#l00157">ExRaiseStatus()</a>, <a class="el" href="../../d9/d9/rtbatcr_8c-source.html#l00056">failure</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d1/mm_8h.html#a344a168">IoReadAccess</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00901">LOCK_PFN2</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00435">MDL_IO_SPACE</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00424">MDL_MAPPED_TO_SYSTEM_VA</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00425">MDL_PAGES_LOCKED</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00428">MDL_PARTIAL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00434">MDL_PHYSICAL_VIEW</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00426">MDL_SOURCE_IS_NONPAGED_POOL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00431">MDL_WRITE_OPERATION</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01417">MI_ADD_LOCKED_PAGE_CHARGE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02287">MI_CONVERT_PHYSICAL_TO_PFN</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02410">MI_GET_PAGE_FRAME_FROM_PTE</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l00225">MI_INSTRUMENT_PROBE_RAISES</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02262">MI_IS_PHYSICAL_ADDRESS</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02717">MI_IS_SYSTEM_CACHE_ADDRESS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04360">MI_NONPAGABLE_MEMORY_AVAILABLE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l00879">MiAddMdlTracker()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01643">MiGetPdeAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01619">MiGetPpeAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01945">MiIsPteOnPdeBoundary</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01921">MiIsPteOnPpeBoundary</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00107">MM_EMPTY_LIST</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00374">MM_PTE_WRITE_MASK</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00137">MM_READWRITE</a>, <a class="el" href="../../d5/d0/mmfault_8c-source.html#l00041">MmAccessFault()</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00044">MmHighestPhysicalPage</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04668">MmLockPagesLimit</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l00234">MmReferenceCountCheck</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l01053">MmResetPageFaultReadAhead</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00983">MmSavePageFaultReadAhead</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l01018">MmSetPageFaultReadAhead</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l00026">MmSystemLockPagesCount</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00089">MmTrackLockedPages</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l01347">MmUnlockPages()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00231">_EPROCESS::NumberOfLockedPages</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00267">_EPROCESS::PhysicalVadList</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01464">ProbeForWriteChar</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d6/d1/ppc_2getcalr_8c-source.html#l00038">RtlGetCallersAddress()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02428">_MI_PHYSICAL_VIEW::StartVa</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d6/d6/struct__MMVAD.html#o7">_MMVAD::u</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o15">_MMPFN::u3</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00905">UNLOCK_PFN2</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l02427">_MI_PHYSICAL_VIEW::Vad</a>.
<p>
Referenced by <a class="el" href="../../d1/d7/dir_8c-source.html#l00057">BuildQueryDirectoryIrp()</a>, <a class="el" href="../../d8/d4/mdlsup_8c-source.html#l00030">CcMdlRead()</a>, <a class="el" href="../../d8/d4/mdlsup_8c-source.html#l00466">CcPrepareMdlWrite()</a>, <a class="el" href="../../d6/d7/fssup_8c-source.html#l02952">CcZeroData()</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l02995">ExLockUserBuffer()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l01360">IoBuildAsynchronousFsdRequest()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l01552">IoBuildDeviceIoControlRequest()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l06326">IopSetEaOrQuotaInformationFile()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l08084">IopXxxControlFile()</a>, <a class="el" href="../../d0/d5/readwrt_8c-source.html#l00529">MiDoMappedCopy()</a>, <a class="el" href="../../d6/d2/queryvm_8c-source.html#l00890">MiGetWorkingSetInfo()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l00813">MmProbeAndLockProcessPages()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l01152">MmProbeAndLockSelectedPages()</a>, <a class="el" href="../../d1/d7/dir_8c-source.html#l00821">NtNotifyChangeDirectoryFile()</a>, <a class="el" href="../../d8/d1/qsea_8c-source.html#l00035">NtQueryEaFile()</a>, <a class="el" href="../../d1/d2/qsquota_8c-source.html#l00035">NtQueryQuotaInformationFile()</a>, <a class="el" href="../../d7/d4/io_2read_8c-source.html#l00036">NtReadFile()</a>, <a class="el" href="../../d8/d1/qsea_8c-source.html#l00652">NtSetEaFile()</a>, <a class="el" href="../../d0/d6/ex_2profile_8c-source.html#l00517">NtStartProfile()</a>, <a class="el" href="../../d1/d9/io_2write_8c-source.html#l00035">NtWriteFile()</a>, <a class="el" href="../../d4/d6/deviosup_8c-source.html#l00474">UdfCreateUserMdl()</a>, <a class="el" href="../../d4/d3/vdm_2vdm_8c-source.html#l00087">VdmQueryDirectoryFile()</a>, and <a class="el" href="../../d0/d5/verifier_8c-source.html#l00537">VerifierProbeAndLockPages()</a>.
<p>
<pre class="fragment"><div>00246                    :
00247 
00248     This routine probes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified pages, makes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pages resident and
00249     locks <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> physical pages mapped by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">virtual</span> pages in memory.  The
00250     Memory descriptor list <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> updated to describe <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> physical pages.
00251 
00252 Arguments:
00253 
00254     MemoryDescriptorList - Supplies a pointer to a Memory Descriptor <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>
00255                             (<a class="code" href="../../d6/d7/struct__MDL.html">MDL</a>). The supplied <a class="code" href="../../d6/d7/struct__MDL.html">MDL</a> must supply a <span class="keyword">virtual</span>
00256                             address, byte offset and length field.  The
00257                             physical page portion of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d6/d7/struct__MDL.html">MDL</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> updated when
00258                             <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pages are locked in memory.
00259 
00260     AccessMode - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> access mode in which to probe <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> arguments.
00261                  One of <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a> or <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>.
00262 
00263     Operation - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a>.  One of <a class="code" href="../../d2/d1/mm_8h.html#a344a168">IoReadAccess</a>, <a class="code" href="../../d2/d1/mm_8h.html#a344a169">IoWriteAccess</a>
00264                 or <a class="code" href="../../d2/d1/mm_8h.html#a344a170">IoModifyAccess</a>.
00265 
00266 Return Value:
00267 
00268     None - exceptions are raised.
00269 
00270 Environment:
00271 
00272     Kernel mode.  <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a> and below <span class="keywordflow">for</span> pagable addresses,
00273                   <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a> and below <span class="keywordflow">for</span> non-pagable addresses.
00274 
00275 --*/
00276 
00277 {
00278     PPFN_NUMBER Page;
00279     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> PteContents;
00280     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
00281     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPde;
00282     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPpe;
00283     PVOID Va;
00284     PVOID EndVa;
00285     PVOID AlignedVa;
00286     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
00287     PFN_NUMBER PageFrameIndex;
00288     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> CurrentProcess;
00289     KIRQL OldIrql;
00290     PFN_NUMBER NumberOfPagesToLock;
00291     PFN_NUMBER NumberOfPagesSpanned;
00292     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00293     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> ProbeStatus;
00294     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> Thread;
00295     ULONG SavedState;
00296     LOGICAL AddressIsPhysical;
00297     PLIST_ENTRY NextEntry;
00298     <a class="code" href="../../d3/d9/struct__MI__PHYSICAL__VIEW.html">PMI_PHYSICAL_VIEW</a> PhysicalView;
00299     PCHAR StartVa;
00300     PVOID CallingAddress;
00301     PVOID CallersCaller;
00302 
00303 <span class="preprocessor">#if !defined (_X86_)</span>
00304 <span class="preprocessor"></span>    CallingAddress = (PVOID)_ReturnAddress();
00305     CallersCaller = (PVOID)0;
00306 <span class="preprocessor">#endif</span>
00307 <span class="preprocessor"></span>
00308 <span class="preprocessor">#if DBG</span>
00309 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (MiPrintLockedPages != 0) {
00310         MiVerifyLockedPageCharges ();
00311     }
00312 <span class="preprocessor">#endif</span>
00313 <span class="preprocessor"></span>
00314     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (MemoryDescriptorList-&gt;ByteCount != 0);
00315     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (((ULONG)MemoryDescriptorList-&gt;ByteOffset &amp; ~(PAGE_SIZE - 1)) == 0);
00316 
00317     Page = (PPFN_NUMBER)(MemoryDescriptorList + 1);
00318 
00319     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (((ULONG_PTR)MemoryDescriptorList-&gt;StartVa &amp; (PAGE_SIZE - 1)) == 0);
00320     AlignedVa = (PVOID)MemoryDescriptorList-&gt;StartVa;
00321 
00322     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((MemoryDescriptorList-&gt;MdlFlags &amp; (
00323                     MDL_PAGES_LOCKED |
00324                     MDL_MAPPED_TO_SYSTEM_VA |
00325                     MDL_SOURCE_IS_NONPAGED_POOL |
00326                     MDL_PARTIAL |
00327                     MDL_IO_SPACE)) == 0);
00328 
00329     Va = (PCHAR)AlignedVa + MemoryDescriptorList-&gt;ByteOffset;
00330     StartVa = Va;
00331 
00332     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (Va);
00333 
00334     <span class="comment">//</span>
00335     <span class="comment">// Endva is one byte past the end of the buffer, if ACCESS_MODE is not</span>
00336     <span class="comment">// kernel, make sure the EndVa is in user space AND the byte count</span>
00337     <span class="comment">// does not cause it to wrap.</span>
00338     <span class="comment">//</span>
00339 
00340     EndVa = (PVOID)((PCHAR)Va + MemoryDescriptorList-&gt;ByteCount);
00341 
00342     <span class="keywordflow">if</span> ((AccessMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) &amp;&amp;
00343         ((EndVa &gt; (PVOID)MM_USER_PROBE_ADDRESS) || (Va &gt;= EndVa))) {
00344         *Page = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>;
00345         <a class="code" href="../../d5/d6/iosup_8c.html#a1">MI_INSTRUMENT_PROBE_RAISES</a>(0);
00346         <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a> (STATUS_ACCESS_VIOLATION);
00347         <span class="keywordflow">return</span>;
00348     }
00349 
00350     <span class="comment">//</span>
00351     <span class="comment">// There is an optimization which could be performed here.  If</span>
00352     <span class="comment">// the operation is for WriteAccess and the complete page is</span>
00353     <span class="comment">// being modified, we can remove the current page, if it is not</span>
00354     <span class="comment">// resident, and substitute a demand zero page.</span>
00355     <span class="comment">// Note, that after analysis by marking the thread and then</span>
00356     <span class="comment">// noting if a page read was done, this rarely occurs.</span>
00357     <span class="comment">//</span>
00358 
00359     MemoryDescriptorList-&gt;Process = (<a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00360 
00361     Thread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a> ();
00362 
00363     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a178">MI_IS_PHYSICAL_ADDRESS</a>(Va)) {
00364 
00365         AddressIsPhysical = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00366         ProbeStatus = STATUS_SUCCESS;
00367 
00368         NumberOfPagesToLock = <a class="code" href="../../d2/d1/mm_8h.html#a9">COMPUTE_PAGES_SPANNED</a> (Va,
00369                                        MemoryDescriptorList-&gt;ByteCount);
00370 
00371         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (NumberOfPagesToLock != 0);
00372 
00373         NumberOfPagesSpanned = NumberOfPagesToLock;
00374 
00375         PointerPpe = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a150">MiGetPpeAddress</a> (Va);
00376         PointerPde = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a151">MiGetPdeAddress</a> (Va);
00377 
00378         <a class="code" href="../../d2/d1/mm_8h.html#a19">MmSavePageFaultReadAhead</a> (Thread, &amp;SavedState);
00379         <a class="code" href="../../d2/d1/mm_8h.html#a20">MmSetPageFaultReadAhead</a> (Thread, (ULONG)(NumberOfPagesToLock - 1));
00380 
00381         <span class="keywordflow">try</span> {
00382 
00383             <span class="keywordflow">do</span> {
00384 
00385                 *Page = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>;
00386 
00387                 <span class="comment">//</span>
00388                 <span class="comment">// Make sure the page is resident.</span>
00389                 <span class="comment">//</span>
00390 
00391                 *(<span class="keyword">volatile</span> <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> *)Va;
00392 
00393                 <span class="keywordflow">if</span> ((Operation != <a class="code" href="../../d2/d1/mm_8h.html#a344a168">IoReadAccess</a>) &amp;&amp;
00394                     (Va &lt;= MM_HIGHEST_USER_ADDRESS)) {
00395 
00396                     <span class="comment">//</span>
00397                     <span class="comment">// Probe for write access as well.</span>
00398                     <span class="comment">//</span>
00399 
00400                     <a class="code" href="../../d5/d8/ex_8h.html#a29">ProbeForWriteChar</a> ((PCHAR)Va);
00401                 }
00402 
00403                 NumberOfPagesToLock -= 1;
00404 
00405                 <a class="code" href="../../d2/d1/mm_8h.html#a20">MmSetPageFaultReadAhead</a> (Thread, (ULONG)(NumberOfPagesToLock - 1));
00406                 Va = (PVOID)(((ULONG_PTR)(PCHAR)Va + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>) &amp; ~(<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1));
00407                 Page += 1;
00408             } <span class="keywordflow">while</span> (Va &lt; EndVa);
00409 
00410             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (NumberOfPagesToLock == 0);
00411 
00412         } except (EXCEPTION_EXECUTE_HANDLER) {
00413             ProbeStatus = GetExceptionCode();
00414         }
00415 
00416         <span class="comment">//</span>
00417         <span class="comment">// We may still fault again below but it's generally rare.</span>
00418         <span class="comment">// Restore this thread's normal fault behavior now.</span>
00419         <span class="comment">//</span>
00420 
00421         <a class="code" href="../../d2/d1/mm_8h.html#a21">MmResetPageFaultReadAhead</a> (Thread, SavedState);
00422 
00423         <span class="keywordflow">if</span> (ProbeStatus != STATUS_SUCCESS) {
00424             <a class="code" href="../../d5/d6/iosup_8c.html#a1">MI_INSTRUMENT_PROBE_RAISES</a>(1);
00425             <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a> (ProbeStatus);
00426             <span class="keywordflow">return</span>;
00427         }
00428     }
00429     <span class="keywordflow">else</span> {
00430         AddressIsPhysical = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00431         *Page = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>;
00432     }
00433 
00434     Va = AlignedVa;
00435     Page = (PPFN_NUMBER)(MemoryDescriptorList + 1);
00436 
00437     <span class="comment">//</span>
00438     <span class="comment">// Indicate that this is a write operation.</span>
00439     <span class="comment">//</span>
00440 
00441     <span class="keywordflow">if</span> (Operation != <a class="code" href="../../d2/d1/mm_8h.html#a344a168">IoReadAccess</a>) {
00442         MemoryDescriptorList-&gt;MdlFlags |= <a class="code" href="../../d0/d9/ntosdef_8h.html#a19">MDL_WRITE_OPERATION</a>;
00443     } <span class="keywordflow">else</span> {
00444         MemoryDescriptorList-&gt;MdlFlags &amp;= ~(<a class="code" href="../../d0/d9/ntosdef_8h.html#a19">MDL_WRITE_OPERATION</a>);
00445     }
00446 
00447     <span class="comment">//</span>
00448     <span class="comment">// Acquire the PFN database lock.</span>
00449     <span class="comment">//</span>
00450 
00451     <a class="code" href="../../d4/d8/mi_8h.html#a130">LOCK_PFN2</a> (OldIrql);
00452 
00453     <span class="keywordflow">if</span> (Va &lt;= MM_HIGHEST_USER_ADDRESS) {
00454 
00455         <span class="comment">//</span>
00456         <span class="comment">// These are addresses with user space, check to see if the</span>
00457         <span class="comment">// working set size will allow these pages to be locked.</span>
00458         <span class="comment">//</span>
00459 
00460         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (NumberOfPagesSpanned != 0);
00461 
00462         CurrentProcess = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a> ();
00463 
00464         <span class="comment">//</span>
00465         <span class="comment">// Check for a transfer to/from a physical VAD - no reference counts</span>
00466         <span class="comment">// may be modified for these pages.</span>
00467         <span class="comment">//</span>
00468 
00469         NextEntry = CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o61">PhysicalVadList</a>.Flink;
00470         <span class="keywordflow">while</span> (NextEntry != &amp;CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o61">PhysicalVadList</a>) {
00471 
00472             PhysicalView = CONTAINING_RECORD(NextEntry,
00473                                              <a class="code" href="../../d3/d9/struct__MI__PHYSICAL__VIEW.html">MI_PHYSICAL_VIEW</a>,
00474                                              ListEntry);
00475 
00476             <span class="keywordflow">if</span> ((PhysicalView-&gt;<a class="code" href="../../d3/d9/struct__MI__PHYSICAL__VIEW.html#o1">Vad</a>-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.UserPhysicalPages == 0) &amp;&amp;
00477                 (PhysicalView-&gt;<a class="code" href="../../d3/d9/struct__MI__PHYSICAL__VIEW.html#o1">Vad</a>-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.PhysicalMapping == 0)) {
00478                 NextEntry = NextEntry-&gt;Flink;
00479                 <span class="keywordflow">continue</span>;
00480             }
00481 
00482             <span class="keywordflow">if</span> (StartVa &lt; PhysicalView-&gt;<a class="code" href="../../d3/d9/struct__MI__PHYSICAL__VIEW.html#o2">StartVa</a>) {
00483 
00484                 <span class="keywordflow">if</span> ((PCHAR)EndVa - 1 &gt;= PhysicalView-&gt;<a class="code" href="../../d3/d9/struct__MI__PHYSICAL__VIEW.html#o2">StartVa</a>) {
00485 
00486                     <span class="comment">//</span>
00487                     <span class="comment">// The range encompasses a physical VAD.  This is not</span>
00488                     <span class="comment">// allowed.</span>
00489                     <span class="comment">//</span>
00490 
00491                     <a class="code" href="../../d4/d8/mi_8h.html#a131">UNLOCK_PFN2</a> (OldIrql);
00492                     <a class="code" href="../../d5/d6/iosup_8c.html#a1">MI_INSTRUMENT_PROBE_RAISES</a>(2);
00493                     <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a> (STATUS_ACCESS_VIOLATION);
00494                     <span class="keywordflow">return</span>;
00495                 }
00496 
00497                 NextEntry = NextEntry-&gt;Flink;
00498                 <span class="keywordflow">continue</span>;
00499             }
00500 
00501             <span class="keywordflow">if</span> (StartVa &lt;= PhysicalView-&gt;<a class="code" href="../../d3/d9/struct__MI__PHYSICAL__VIEW.html#o3">EndVa</a>) {
00502 
00503                 <span class="comment">//</span>
00504                 <span class="comment">// Ensure that the entire range lies within the VAD.</span>
00505                 <span class="comment">//</span>
00506 
00507                 <span class="keywordflow">if</span> ((PCHAR)EndVa - 1 &gt; PhysicalView-&gt;<a class="code" href="../../d3/d9/struct__MI__PHYSICAL__VIEW.html#o3">EndVa</a>) {
00508 
00509                     <span class="comment">//</span>
00510                     <span class="comment">// The range goes past the end of the VAD - not allowed.</span>
00511                     <span class="comment">//</span>
00512 
00513                     <a class="code" href="../../d4/d8/mi_8h.html#a131">UNLOCK_PFN2</a> (OldIrql);
00514                     <a class="code" href="../../d5/d6/iosup_8c.html#a1">MI_INSTRUMENT_PROBE_RAISES</a>(3);
00515                     <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a> (STATUS_ACCESS_VIOLATION);
00516                     <span class="keywordflow">return</span>;
00517                 }
00518 
00519                 <span class="keywordflow">if</span> (PhysicalView-&gt;<a class="code" href="../../d3/d9/struct__MI__PHYSICAL__VIEW.html#o1">Vad</a>-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.UserPhysicalPages == 1) {
00520 
00521                     <span class="comment">//</span>
00522                     <span class="comment">// All the PTEs must still be checked and reference</span>
00523                     <span class="comment">// counts bumped on the pages.  Just don't charge</span>
00524                     <span class="comment">// against the working set.</span>
00525                     <span class="comment">//</span>
00526 
00527                     NextEntry = NextEntry-&gt;Flink;
00528                     <span class="keywordflow">continue</span>;
00529                 }
00530 
00531                 <span class="comment">//</span>
00532                 <span class="comment">// The range lies within a physical VAD.</span>
00533                 <span class="comment">//</span>
00534 
00535                 <span class="keywordflow">if</span> (Operation != <a class="code" href="../../d2/d1/mm_8h.html#a344a168">IoReadAccess</a>) {
00536 
00537                     <span class="comment">//</span>
00538                     <span class="comment">// Ensure the VAD is writable.  Changing individual PTE</span>
00539                     <span class="comment">// protections in a physical VAD is not allowed.</span>
00540                     <span class="comment">//</span>
00541 
00542                     <span class="keywordflow">if</span> ((PhysicalView-&gt;<a class="code" href="../../d3/d9/struct__MI__PHYSICAL__VIEW.html#o1">Vad</a>-&gt;<a class="code" href="../../d6/d6/struct__MMVAD.html#o7">u</a>.VadFlags.Protection &amp; <a class="code" href="../../d4/d8/mi_8h.html#a39">MM_READWRITE</a>) == 0) {
00543                         <a class="code" href="../../d4/d8/mi_8h.html#a131">UNLOCK_PFN2</a> (OldIrql);
00544                         <a class="code" href="../../d5/d6/iosup_8c.html#a1">MI_INSTRUMENT_PROBE_RAISES</a>(4);
00545                         <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a> (STATUS_ACCESS_VIOLATION);
00546                         <span class="keywordflow">return</span>;
00547                     }
00548                 }
00549 
00550                 <span class="comment">//</span>
00551                 <span class="comment">// Don't charge page locking for this transfer as it is all</span>
00552                 <span class="comment">// physical, just initialize the MDL.  Note the pages do not</span>
00553                 <span class="comment">// have to be physically contiguous, so the frames must be</span>
00554                 <span class="comment">// extracted from the PTEs.</span>
00555                 <span class="comment">//</span>
00556 
00557                 MemoryDescriptorList-&gt;MdlFlags |= (<a class="code" href="../../d0/d9/ntosdef_8h.html#a22">MDL_PHYSICAL_VIEW</a> | <a class="code" href="../../d0/d9/ntosdef_8h.html#a13">MDL_PAGES_LOCKED</a>);
00558                 MemoryDescriptorList-&gt;Process = CurrentProcess;
00559 
00560                 <span class="keywordflow">do</span> {
00561                     PageFrameIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (PointerPte);
00562                     *Page = PageFrameIndex;
00563                     Page += 1;
00564                     PointerPte += 1;
00565                     Va = (PVOID)((PCHAR)Va + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
00566                 } <span class="keywordflow">while</span> (Va &lt; EndVa);
00567 
00568                 <a class="code" href="../../d4/d8/mi_8h.html#a131">UNLOCK_PFN2</a> (OldIrql);
00569                 <span class="keywordflow">return</span>;
00570             }
00571             NextEntry = NextEntry-&gt;Flink;
00572         }
00573 
00574         CurrentProcess-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o42">NumberOfLockedPages</a> += NumberOfPagesSpanned;
00575 
00576         MemoryDescriptorList-&gt;Process = CurrentProcess;
00577     }
00578 
00579     MemoryDescriptorList-&gt;MdlFlags |= <a class="code" href="../../d0/d9/ntosdef_8h.html#a13">MDL_PAGES_LOCKED</a>;
00580 
00581     <span class="keywordflow">do</span> {
00582 
00583         <span class="keywordflow">if</span> (AddressIsPhysical == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00584 
00585             <span class="comment">//</span>
00586             <span class="comment">// On certain architectures, virtual addresses</span>
00587             <span class="comment">// may be physical and hence have no corresponding PTE.</span>
00588             <span class="comment">//</span>
00589 
00590             PageFrameIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a179">MI_CONVERT_PHYSICAL_TO_PFN</a> (Va);
00591 
00592         } <span class="keywordflow">else</span> {
00593 
00594 <span class="preprocessor">#if defined (_WIN64)</span>
00595 <span class="preprocessor"></span>            <span class="keywordflow">while</span> ((PointerPpe-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) ||
00596                    (PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) ||
00597                    (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0))
00598 <span class="preprocessor">#else</span>
00599 <span class="preprocessor"></span>            <span class="keywordflow">while</span> ((PointerPde-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0) ||
00600                    (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0))
00601 <span class="preprocessor">#endif</span>
00602 <span class="preprocessor"></span>            {
00603 
00604                 <span class="comment">//</span>
00605                 <span class="comment">// PDE is not resident, release PFN lock touch the page and make</span>
00606                 <span class="comment">// it appear.</span>
00607                 <span class="comment">//</span>
00608 
00609                 <a class="code" href="../../d4/d8/mi_8h.html#a131">UNLOCK_PFN2</a> (OldIrql);
00610 
00611                 <a class="code" href="../../d2/d1/mm_8h.html#a20">MmSetPageFaultReadAhead</a> (Thread, 0);
00612 
00613                 status = <a class="code" href="../../d4/d1/mmfault_8c.html#a2">MmAccessFault</a> (FALSE, Va, KernelMode, (PVOID)0);
00614 
00615                 <a class="code" href="../../d2/d1/mm_8h.html#a21">MmResetPageFaultReadAhead</a> (Thread, SavedState);
00616 
00617                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
00618 
00619                     <span class="comment">//</span>
00620                     <span class="comment">// An exception occurred.  Unlock the pages locked</span>
00621                     <span class="comment">// so far.</span>
00622                     <span class="comment">//</span>
00623 
00624 <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a>:
00625                     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a33">MmTrackLockedPages</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00626 
00627                         <span class="comment">//</span>
00628                         <span class="comment">// Adjust the MDL length so that MmUnlockPages only</span>
00629                         <span class="comment">// processes the part that was completed.</span>
00630                         <span class="comment">//</span>
00631 
00632                         ULONG PagesLocked;
00633             
00634                         PagesLocked = <a class="code" href="../../d2/d1/mm_8h.html#a8">ADDRESS_AND_SIZE_TO_SPAN_PAGES</a>(StartVa,
00635                                               MemoryDescriptorList-&gt;ByteCount);
00636 
00637 <span class="preprocessor">#if defined (_X86_)</span>
00638 <span class="preprocessor"></span>                        <a class="code" href="../../d5/d2/ppc_2getcalr_8c.html#a0">RtlGetCallersAddress</a>(&amp;CallingAddress, &amp;CallersCaller);
00639 <span class="preprocessor">#endif</span>
00640 <span class="preprocessor"></span>                        <a class="code" href="../../d5/d6/iosup_8c.html#a32">MiAddMdlTracker</a> (MemoryDescriptorList,
00641                                          CallingAddress,
00642                                          CallersCaller,
00643                                          PagesLocked,
00644                                          0);
00645                     }
00646 
00647                     <a class="code" href="../../d5/d6/iosup_8c.html#a45">MmUnlockPages</a> (MemoryDescriptorList);
00648 
00649                     <span class="comment">//</span>
00650                     <span class="comment">// Raise an exception of access violation to the caller.</span>
00651                     <span class="comment">//</span>
00652 
00653                     <a class="code" href="../../d5/d6/iosup_8c.html#a1">MI_INSTRUMENT_PROBE_RAISES</a>(7);
00654                     <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a> (status);
00655                     <span class="keywordflow">return</span>;
00656                 }
00657 
00658                 <a class="code" href="../../d4/d8/mi_8h.html#a130">LOCK_PFN2</a> (OldIrql);
00659             }
00660 
00661             PteContents = *PointerPte;
00662             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1);
00663 
00664             <span class="keywordflow">if</span> (Va &lt;= MM_HIGHEST_USER_ADDRESS) {
00665                 <span class="keywordflow">if</span> (Operation != <a class="code" href="../../d2/d1/mm_8h.html#a344a168">IoReadAccess</a>) {
00666 
00667                     <span class="keywordflow">if</span> ((PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long &amp; <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a77">MM_PTE_WRITE_MASK</a>) == 0) {
00668 
00669                         <span class="comment">//</span>
00670                         <span class="comment">// The caller has made the page protection more</span>
00671                         <span class="comment">// restrictive, this should never be done once the</span>
00672                         <span class="comment">// request has been issued !  Rather than wading</span>
00673                         <span class="comment">// through the PFN database entry to see if it</span>
00674                         <span class="comment">// could possibly work out, give the caller an</span>
00675                         <span class="comment">// access violation.</span>
00676                         <span class="comment">//</span>
00677 
00678 <span class="preprocessor">#if DBG</span>
00679 <span class="preprocessor"></span>                        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"MmProbeAndLockPages: PTE %p %p changed\n"</span>,
00680                             PointerPte,
00681                             PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long);
00682                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (FALSE);
00683 <span class="preprocessor">#endif</span>
00684 <span class="preprocessor"></span>
00685                         <a class="code" href="../../d4/d8/mi_8h.html#a131">UNLOCK_PFN2</a> (OldIrql);
00686                         status = STATUS_ACCESS_VIOLATION;
00687                         <span class="keywordflow">goto</span> <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a>;
00688                     }
00689                 }
00690             }
00691 
00692             PageFrameIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (&amp;PteContents);
00693         }
00694 
00695         <span class="keywordflow">if</span> (PageFrameIndex &gt; <a class="code" href="../../d6/d8/sysinfo_8c.html#a7">MmHighestPhysicalPage</a>) {
00696 
00697             <span class="comment">//</span>
00698             <span class="comment">// This is an I/O space address don't allow operations</span>
00699             <span class="comment">// on addresses not in the PFN database.</span>
00700             <span class="comment">//</span>
00701 
00702             MemoryDescriptorList-&gt;MdlFlags |= <a class="code" href="../../d0/d9/ntosdef_8h.html#a23">MDL_IO_SPACE</a>;
00703 
00704         } <span class="keywordflow">else</span> {
00705             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((MemoryDescriptorList-&gt;MdlFlags &amp; MDL_IO_SPACE) == 0);
00706 
00707             Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
00708 
00709 <span class="preprocessor">#if PFN_CONSISTENCY</span>
00710 <span class="preprocessor"></span>            <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.PageTablePage == 0);
00711 <span class="preprocessor">#endif</span>
00712 <span class="preprocessor"></span>
00713             <span class="comment">//</span>
00714             <span class="comment">// Check to make sure this page is not locked down an unusually</span>
00715             <span class="comment">// high number of times.</span>
00716             <span class="comment">//</span>
00717 
00718             <span class="keywordflow">if</span> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount &gt;= <a class="code" href="../../d5/d6/iosup_8c.html#a23">MmReferenceCountCheck</a>) {
00719                 <a class="code" href="../../d4/d8/mi_8h.html#a131">UNLOCK_PFN2</a> (OldIrql);
00720                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (FALSE);
00721                 status = STATUS_WORKING_SET_QUOTA;
00722                 <span class="keywordflow">goto</span> <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a>;
00723             }
00724 
00725             <span class="comment">//</span>
00726             <span class="comment">// Check to make sure the systemwide locked pages count is fluid.</span>
00727             <span class="comment">//</span>
00728 
00729             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d8/mi_8h.html#a323">MI_NONPAGABLE_MEMORY_AVAILABLE</a>() &lt;= 0) {
00730 
00731                 <span class="comment">//</span>
00732                 <span class="comment">// If this page is for paged pool or privileged code/data,</span>
00733                 <span class="comment">// then force it in.</span>
00734                 <span class="comment">//</span>
00735 
00736                 <span class="keywordflow">if</span> ((Va &gt; MM_HIGHEST_USER_ADDRESS) &amp;&amp;
00737                     (!<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a196">MI_IS_SYSTEM_CACHE_ADDRESS</a>(Va))) {
00738                     <a class="code" href="../../d5/d6/iosup_8c.html#a1">MI_INSTRUMENT_PROBE_RAISES</a>(8);
00739                     <span class="keywordflow">goto</span> ok;
00740                 }
00741 
00742                 <a class="code" href="../../d5/d6/iosup_8c.html#a1">MI_INSTRUMENT_PROBE_RAISES</a>(5);
00743                 <a class="code" href="../../d4/d8/mi_8h.html#a131">UNLOCK_PFN2</a> (OldIrql);
00744                 status = STATUS_WORKING_SET_QUOTA;
00745                 <span class="keywordflow">goto</span> <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a>;
00746             }
00747 
00748             <span class="comment">//</span>
00749             <span class="comment">// Check to make sure any administrator-desired limit is obeyed.</span>
00750             <span class="comment">//</span>
00751 
00752             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/iosup_8c.html#a2">MmSystemLockPagesCount</a> + 1 &gt;= <a class="code" href="../../d4/d8/mi_8h.html#a635">MmLockPagesLimit</a>) {
00753 
00754                 <span class="comment">//</span>
00755                 <span class="comment">// If this page is for paged pool or privileged code/data,</span>
00756                 <span class="comment">// then force it in.</span>
00757                 <span class="comment">//</span>
00758 
00759                 <span class="keywordflow">if</span> ((Va &gt; MM_HIGHEST_USER_ADDRESS) &amp;&amp;
00760                     (!<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a196">MI_IS_SYSTEM_CACHE_ADDRESS</a>(Va))) {
00761                     <a class="code" href="../../d5/d6/iosup_8c.html#a1">MI_INSTRUMENT_PROBE_RAISES</a>(9);
00762                     <span class="keywordflow">goto</span> ok;
00763                 }
00764 
00765                 <a class="code" href="../../d5/d6/iosup_8c.html#a1">MI_INSTRUMENT_PROBE_RAISES</a>(6);
00766                 <a class="code" href="../../d4/d8/mi_8h.html#a131">UNLOCK_PFN2</a> (OldIrql);
00767                 status = STATUS_WORKING_SET_QUOTA;
00768                 <span class="keywordflow">goto</span> <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a>;
00769             }
00770 
00771 ok:
00772             <a class="code" href="../../d4/d8/mi_8h.html#a186">MI_ADD_LOCKED_PAGE_CHARGE</a>(Pfn1, 0);
00773 
00774             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount += 1;
00775         }
00776 
00777         *Page = PageFrameIndex;
00778 
00779         Page += 1;
00780         PointerPte += 1;
00781         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a167">MiIsPteOnPdeBoundary</a>(PointerPte)) {
00782             PointerPde += 1;
00783             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a166">MiIsPteOnPpeBoundary</a>(PointerPte)) {
00784                 PointerPpe += 1;
00785             }
00786         }
00787 
00788         Va = (PVOID)((PCHAR)Va + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
00789     } <span class="keywordflow">while</span> (Va &lt; EndVa);
00790 
00791     <a class="code" href="../../d4/d8/mi_8h.html#a131">UNLOCK_PFN2</a> (OldIrql);
00792 
00793     <span class="keywordflow">if</span> ((<a class="code" href="../../d8/d0/cmdat3_8c.html#a33">MmTrackLockedPages</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) &amp;&amp; (AlignedVa &lt;= MM_HIGHEST_USER_ADDRESS)) {
00794 
00795         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (NumberOfPagesSpanned != 0);
00796 
00797 <span class="preprocessor">#if defined (_X86_)</span>
00798 <span class="preprocessor"></span>        <a class="code" href="../../d5/d2/ppc_2getcalr_8c.html#a0">RtlGetCallersAddress</a>(&amp;CallingAddress, &amp;CallersCaller);
00799 <span class="preprocessor">#endif</span>
00800 <span class="preprocessor"></span>
00801         <a class="code" href="../../d5/d6/iosup_8c.html#a32">MiAddMdlTracker</a> (MemoryDescriptorList,
00802                          CallingAddress,
00803                          CallersCaller,
00804                          NumberOfPagesSpanned,
00805                          1);
00806     }
00807 
00808     <span class="keywordflow">return</span>;
00809 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a42" doxytag="iosup.c::MmProbeAndLockProcessPages" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI VOID MmProbeAndLockProcessPages           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT <a class="el" href="../../d6/d7/struct__MDL.html">PMDL</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>MemoryDescriptorList</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Process</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessMode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d1/mm_8h.html#a141">LOCK_OPERATION</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Operation</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l00813">813</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d1/d3/ex_2alpha_2raisests_8c-source.html#l00157">ExRaiseStatus()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00166">KeAttachProcess()</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00405">KeDetachProcess()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l00238">MmProbeAndLockPages()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d0/d5/verifier_8c-source.html#l00563">VerifierProbeAndLockProcessPages()</a>.
<p>
<pre class="fragment"><div>00822                    :
00823 
00824     This routine probes and locks <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address range specified by
00825     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> MemoryDescriptorList in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified Process <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> AccessMode
00826     and Operation.
00827 
00828 Arguments:
00829 
00830     MemoryDescriptorList - Supplies a pre-initialized <a class="code" href="../../d6/d7/struct__MDL.html">MDL</a> that describes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00831                            address range to be probed and locked.
00832 
00833     Process - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process whose address range <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00834               to be locked.
00835 
00836     AccessMode - The mode <span class="keywordflow">for</span> which <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> probe should check access to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> range.
00837 
00838     Operation - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of access which <span class="keywordflow">for</span> which to check <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> range.
00839 
00840 Return Value:
00841 
00842     None.
00843 
00844 --*/
00845 
00846 {
00847     LOGICAL Attached;
00848     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00849 
00850     Attached = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00851     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00852 
00853     <span class="keywordflow">if</span> (Process != <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a> ()) {
00854         <a class="code" href="../../d3/d5/procobj_8c.html#a4">KeAttachProcess</a> (&amp;Process-&gt;Pcb);
00855         Attached = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00856     }
00857 
00858     <span class="keywordflow">try</span> {
00859 
00860         <a class="code" href="../../d5/d6/iosup_8c.html#a41">MmProbeAndLockPages</a> (MemoryDescriptorList,
00861                              AccessMode,
00862                              Operation);
00863 
00864     } except (EXCEPTION_EXECUTE_HANDLER) {
00865         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00866     }
00867 
00868     <span class="keywordflow">if</span> (Attached) {
00869         <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
00870     }
00871 
00872     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_SUCCESS) {
00873         <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a> (Status);
00874     }
00875     <span class="keywordflow">return</span>;
00876 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a44" doxytag="iosup.c::MmProbeAndLockSelectedPages" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI VOID MmProbeAndLockSelectedPages           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT <a class="el" href="../../d6/d7/struct__MDL.html">PMDL</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>MemoryDescriptorList</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PFILE_SEGMENT_ELEMENT&nbsp;</td>
          <td class="mdname" nowrap> <em>SegmentArray</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>AccessMode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d1/mm_8h.html#a141">LOCK_OPERATION</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Operation</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l01152">1152</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00141">BYTES_TO_PAGES</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00435">MDL_IO_SPACE</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00424">MDL_MAPPED_TO_SYSTEM_VA</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00425">MDL_PAGES_LOCKED</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00428">MDL_PARTIAL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00426">MDL_SOURCE_IS_NONPAGED_POOL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00416">_MDL::MdlFlags</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l00879">MiAddMdlTracker()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l01041">MiFreeMdlTracker()</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l01789">MmInitializeMdl</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l00238">MmProbeAndLockPages()</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00089">MmTrackLockedPages</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l01347">MmUnlockPages()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00417">_MDL::Process</a>, <a class="el" href="../../d6/d1/ppc_2getcalr_8c-source.html#l00038">RtlGetCallersAddress()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00419">_MDL::StartVa</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d7/d4/io_2read_8c-source.html#l00730">NtReadFileScatter()</a>, <a class="el" href="../../d1/d9/io_2write_8c-source.html#l00801">NtWriteFileGather()</a>, and <a class="el" href="../../d0/d5/verifier_8c-source.html#l00593">VerifierProbeAndLockSelectedPages()</a>.
<p>
<pre class="fragment"><div>01161                    :
01162 
01163     This routine probes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified pages, makes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pages resident and
01164     locks <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> physical pages mapped by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">virtual</span> pages in memory.  The
01165     Memory descriptor list <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> updated to describe <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> physical pages.
01166 
01167 Arguments:
01168 
01169     MemoryDescriptorList - Supplies a pointer to a Memory Descriptor <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>
01170                            (<a class="code" href="../../d6/d7/struct__MDL.html">MDL</a>). The <a class="code" href="../../d6/d7/struct__MDL.html">MDL</a> must supply <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length. The
01171                            physical page portion of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d6/d7/struct__MDL.html">MDL</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> updated when
01172                            <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pages are locked in memory.
01173 
01174     SegmentArray - Supplies a pointer to a list of buffer segments to be
01175                    probed and locked.
01176 
01177     AccessMode - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> access mode in which to probe <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> arguments.
01178                  One of <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a> or <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>.
01179 
01180     Operation - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a>.  One of <a class="code" href="../../d2/d1/mm_8h.html#a344a168">IoReadAccess</a>, <a class="code" href="../../d2/d1/mm_8h.html#a344a169">IoWriteAccess</a>
01181                 or <a class="code" href="../../d2/d1/mm_8h.html#a344a170">IoModifyAccess</a>.
01182 
01183 Return Value:
01184 
01185     None - exceptions are raised.
01186 
01187 Environment:
01188 
01189     Kernel mode.  <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a> and below.
01190 
01191 --*/
01192 
01193 {
01194     <a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a> TempMdl;
01195     PFN_NUMBER MdlHack[(<span class="keyword">sizeof</span>(<a class="code" href="../../d6/d7/struct__MDL.html">MDL</a>)/<span class="keyword">sizeof</span>(PFN_NUMBER)) + 1];
01196     PPFN_NUMBER Page;
01197     PFILE_SEGMENT_ELEMENT LastSegment;
01198     PVOID CallingAddress;
01199     PVOID CallersCaller;
01200     ULONG NumberOfPagesToLock;
01201 
01202     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01203 
01204 <span class="preprocessor">#if !defined (_X86_)</span>
01205 <span class="preprocessor"></span>    CallingAddress = (PVOID)_ReturnAddress();
01206     CallersCaller = (PVOID)0;
01207 <span class="preprocessor">#endif</span>
01208 <span class="preprocessor"></span>
01209     NumberOfPagesToLock = 0;
01210 
01211     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (MemoryDescriptorList-&gt;ByteCount != 0);
01212     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (((ULONG_PTR)MemoryDescriptorList-&gt;ByteOffset &amp; ~(PAGE_SIZE - 1)) == 0);
01213 
01214     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((MemoryDescriptorList-&gt;MdlFlags &amp; (
01215                     MDL_PAGES_LOCKED |
01216                     MDL_MAPPED_TO_SYSTEM_VA |
01217                     MDL_SOURCE_IS_NONPAGED_POOL |
01218                     MDL_PARTIAL |
01219                     MDL_IO_SPACE)) == 0);
01220 
01221     <span class="comment">//</span>
01222     <span class="comment">// Initialize TempMdl.</span>
01223     <span class="comment">//</span>
01224 
01225     TempMdl = (<a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a>) &amp;MdlHack;
01226 
01227     <a class="code" href="../../d2/d1/mm_8h.html#a24">MmInitializeMdl</a>( TempMdl, SegmentArray-&gt;Buffer, PAGE_SIZE );
01228 
01229     Page = (PPFN_NUMBER) (MemoryDescriptorList + 1);
01230 
01231     <span class="comment">//</span>
01232     <span class="comment">// Calculate the end of the segment list.</span>
01233     <span class="comment">//</span>
01234 
01235     LastSegment = SegmentArray +
01236                   <a class="code" href="../../d2/d1/mm_8h.html#a5">BYTES_TO_PAGES</a>(MemoryDescriptorList-&gt;ByteCount);
01237 
01238     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(SegmentArray &lt; LastSegment);
01239 
01240     <span class="comment">//</span>
01241     <span class="comment">// Build a small Mdl for each segment and call probe and lock pages.</span>
01242     <span class="comment">// Then copy the PFNs to the real mdl.  The first page is processed</span>
01243     <span class="comment">// outside of the try/finally to ensure that the flags and process</span>
01244     <span class="comment">// field are correctly set in case MmUnlockPages needs to be called.</span>
01245     <span class="comment">//</span>
01246 
01247     <span class="comment">//</span>
01248     <span class="comment">// Even systems without 64 bit pointers are required to zero the</span>
01249     <span class="comment">// upper 32 bits of the segment address so use alignment rather</span>
01250     <span class="comment">// than the buffer pointer.</span>
01251     <span class="comment">//</span>
01252 
01253     SegmentArray += 1;
01254     <a class="code" href="../../d5/d6/iosup_8c.html#a41">MmProbeAndLockPages</a>( TempMdl, AccessMode, Operation );
01255 
01256     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a33">MmTrackLockedPages</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01257 
01258         <span class="comment">//</span>
01259         <span class="comment">// Since we move the page from the temp MDL to the real one below</span>
01260         <span class="comment">// and never free the temp one, fixup our accounting now.</span>
01261         <span class="comment">//</span>
01262 
01263         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/iosup_8c.html#a43">MiFreeMdlTracker</a> (TempMdl, 1) == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01264             NumberOfPagesToLock += 1;
01265         }
01266     }
01267 
01268     *Page++ = *((PPFN_NUMBER) (TempMdl + 1));
01269 
01270     <span class="comment">//</span>
01271     <span class="comment">// Copy the flags and process fields.</span>
01272     <span class="comment">//</span>
01273 
01274     MemoryDescriptorList-&gt;MdlFlags |= TempMdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o2">MdlFlags</a>;
01275     MemoryDescriptorList-&gt;Process = TempMdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o3">Process</a>;
01276 
01277     <span class="keywordflow">try</span> {
01278 
01279         <span class="keywordflow">while</span> (SegmentArray &lt; LastSegment) {
01280 
01281             <span class="comment">//</span>
01282             <span class="comment">// Even systems without 64 bit pointers are required to zero the</span>
01283             <span class="comment">// upper 32 bits of the segment address so use alignment rather</span>
01284             <span class="comment">// than the buffer pointer.</span>
01285             <span class="comment">//</span>
01286 
01287             TempMdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o5">StartVa</a> = (PVOID)(ULONG_PTR)SegmentArray-&gt;Buffer;
01288             TempMdl-&gt;<a class="code" href="../../d6/d7/struct__MDL.html#o2">MdlFlags</a> = 0;
01289 
01290             SegmentArray += 1;
01291             <a class="code" href="../../d5/d6/iosup_8c.html#a41">MmProbeAndLockPages</a>( TempMdl, AccessMode, Operation );
01292 
01293 
01294             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a33">MmTrackLockedPages</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01295 
01296                 <span class="comment">//</span>
01297                 <span class="comment">// Since we move the page from the temp MDL to the real one</span>
01298                 <span class="comment">// below and never free the temp one, fixup our accounting now.</span>
01299                 <span class="comment">//</span>
01300 
01301                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/iosup_8c.html#a43">MiFreeMdlTracker</a> (TempMdl, 1) == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01302                     NumberOfPagesToLock += 1;
01303                 }
01304             }
01305 
01306             *Page++ = *((PPFN_NUMBER) (TempMdl + 1));
01307         }
01308     } finally {
01309 
01310         <span class="keywordflow">if</span> (abnormal_termination()) {
01311 
01312             <span class="comment">//</span>
01313             <span class="comment">// Adjust the MDL length so that MmUnlockPages only processes</span>
01314             <span class="comment">// the part that was completed.</span>
01315             <span class="comment">//</span>
01316 
01317             MemoryDescriptorList-&gt;ByteCount =
01318                 (ULONG) (Page - (PPFN_NUMBER) (MemoryDescriptorList + 1)) &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
01319 
01320             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a33">MmTrackLockedPages</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01321 <span class="preprocessor">#if defined (_X86_)</span>
01322 <span class="preprocessor"></span>                <a class="code" href="../../d5/d2/ppc_2getcalr_8c.html#a0">RtlGetCallersAddress</a>(&amp;CallingAddress, &amp;CallersCaller);
01323 <span class="preprocessor">#endif</span>
01324 <span class="preprocessor"></span>                <a class="code" href="../../d5/d6/iosup_8c.html#a32">MiAddMdlTracker</a> (MemoryDescriptorList,
01325                                  CallingAddress,
01326                                  CallersCaller,
01327                                  NumberOfPagesToLock,
01328                                  2);
01329             }
01330 
01331             <a class="code" href="../../d5/d6/iosup_8c.html#a45">MmUnlockPages</a>( MemoryDescriptorList );
01332         }
01333         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a33">MmTrackLockedPages</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01334 <span class="preprocessor">#if defined (_X86_)</span>
01335 <span class="preprocessor"></span>            <a class="code" href="../../d5/d2/ppc_2getcalr_8c.html#a0">RtlGetCallersAddress</a>(&amp;CallingAddress, &amp;CallersCaller);
01336 <span class="preprocessor">#endif</span>
01337 <span class="preprocessor"></span>            <a class="code" href="../../d5/d6/iosup_8c.html#a32">MiAddMdlTracker</a> (MemoryDescriptorList,
01338                              CallingAddress,
01339                              CallersCaller,
01340                              NumberOfPagesToLock,
01341                              3);
01342         }
01343     }
01344 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a83" doxytag="iosup.c::MmReleaseDumpAddresses" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MmReleaseDumpAddresses           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PFN_NUMBER&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Pages</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l07270">7270</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
References <a class="el" href="../../d0/d0/ki_8h.html#a114">KiFlushSingleTb()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01842">MiGetVirtualAddressMappedByPte</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00406">MM_ZERO_PTE</a>, <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00105">MmCrashDumpPte</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>.
<p>
<pre class="fragment"><div>07276                    :
07277 
07278     For use by hibernate routine ONLY.  Puts zeros back into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
07279     used dump PTEs.
07280 
07281 Arguments:
07282 
07283     None
07284 
07285 Return Value:
07286 
07287     None
07288 
07289 --*/
07290 
07291 {
07292     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
07293     PCHAR BaseVa;
07294 
07295     PointerPte = <a class="code" href="../../d4/d2/datalpha_8c.html#a19">MmCrashDumpPte</a>;
07296     BaseVa = (PCHAR)<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a161">MiGetVirtualAddressMappedByPte</a>(PointerPte);
07297 
07298     <span class="keywordflow">while</span> (Pages) {
07299 
07300         <a class="code" href="../../d0/d0/ki_8h.html#a114">KiFlushSingleTb</a> (TRUE, BaseVa);
07301 
07302         PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a93">MM_ZERO_PTE</a>;
07303         PointerPte += 1;
07304         BaseVa += <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
07305         Pages -= 1;
07306     }
07307 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a90" doxytag="iosup.c::MmReturnMemoryForHibernate" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI VOID MmReturnMemoryForHibernate           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d6/d7/struct__MDL.html">PMDL</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Mdl</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l08038">8038</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
References <a class="el" href="../../d5/d7/mi_8h-source.html#l00901">LOCK_PFN2</a>, <a class="el" href="../../d7/d4/pfndec_8c-source.html#l00167">MiDecrementReferenceCount()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l00905">UNLOCK_PFN2</a>.
<p>
<pre class="fragment"><div>08044                    :
08045 
08046     Returns memory from MmGatherMemoryForHibername.
08047 
08048 Arguments:
08049 
08050     Mdl - Supplies an <a class="code" href="../../d6/d7/struct__MDL.html">MDL</a>, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> start VA field should be <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>.  The length
08051           field indicates how many pages to obtain.
08052 
08053 Return Value:
08054 
08055     None.
08056 
08057 Environment:
08058 
08059     Kernel mode, IRQL of <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a> or below.
08060 
08061 --*/
08062 
08063 {
08064     KIRQL OldIrql;
08065     PFN_NUMBER PagesNeeded;
08066     PPFN_NUMBER Pages;
08067 
08068     PagesNeeded = (Mdl-&gt;ByteCount &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
08069     Pages = (PPFN_NUMBER)(Mdl + 1);
08070 
08071     <a class="code" href="../../d4/d8/mi_8h.html#a130">LOCK_PFN2</a> (OldIrql);
08072     <span class="keywordflow">do</span> {
08073         <a class="code" href="../../d6/d5/pfndec_8c.html#a2">MiDecrementReferenceCount</a> (*Pages);
08074         Pages += 1;
08075         PagesNeeded -= 1;
08076     } <span class="keywordflow">while</span> (PagesNeeded);
08077     <a class="code" href="../../d4/d8/mi_8h.html#a131">UNLOCK_PFN2</a> (OldIrql);
08078     <span class="keywordflow">return</span>;
08079 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a74" doxytag="iosup.c::MmSetAddressRangeModified" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN MmSetAddressRangeModified           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Address</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN SIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l05920">5920</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
References <a class="el" href="../../d5/d9/cmconfig_8c-source.html#l00051">Count</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d5/ppc_2flushtb_8c-source.html#l00033">KeFlushEntireTb()</a>, <a class="el" href="../../d1/d5/ppc_2flushtb_8c-source.html#l00104">KeFlushMultipleTb()</a>, <a class="el" href="../../d1/d5/ppc_2flushtb_8c-source.html#l00188">KeFlushSingleTb()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00901">LOCK_PFN2</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00757">MI_IS_PTE_DIRTY</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00733">MI_SET_PTE_CLEAN</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02513">MI_WRITE_VALID_PTE_NEW_PROTECTION</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d9/d5/deleteva_8c-source.html#l01014">MiReleasePageFileSpace()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00127">MM_MAXIMUM_FLUSH_COUNT</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01297">_MMPFN::OriginalPte</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o15">_MMPFN::u3</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00905">UNLOCK_PFN2</a>, <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>, and <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00030">ZeroPte</a>.
<p>
Referenced by <a class="el" href="../../d7/d1/cachesub_8c-source.html#l04411">CcFlushCache()</a>, <a class="el" href="../../d7/d1/cachesub_8c-source.html#l06024">CcMapAndCopy()</a>, <a class="el" href="../../d6/d7/fssup_8c-source.html#l02194">CcPurgeAndClearCacheSection()</a>, <a class="el" href="../../d7/d1/cachesub_8c-source.html#l05143">CcUnpinRepinnedBcb()</a>, and <a class="el" href="../../d6/d7/fssup_8c-source.html#l02952">CcZeroData()</a>.
<p>
<pre class="fragment"><div>05927                    :
05928 
05929     This routine sets <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> modified bit in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PFN database <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
05930     pages that correspond to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified address range.
05931 
05932     Note that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> dirty bit in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> PTE <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> cleared by <span class="keyword">this</span> operation.
05933 
05934 Arguments:
05935 
05936     Address - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> start of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> range.  This
05937               range must reside within <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system cache.
05938 
05939     Length - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> range.
05940 
05941 Return Value:
05942 
05943     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> at least one PTE was dirty in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> range, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise.
05944 
05945 Environment:
05946 
05947     Kernel mode.  <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a> and below <span class="keywordflow">for</span> pagable addresses,
05948                   <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a> and below <span class="keywordflow">for</span> non-pagable addresses.
05949 
05950 --*/
05951 
05952 {
05953     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
05954     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastPte;
05955     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
05956     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> FlushPte;
05957     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> PteContents;
05958     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> FlushContents;
05959     KIRQL OldIrql;
05960     PVOID VaFlushList[<a class="code" href="../../d4/d8/mi_8h.html#a34">MM_MAXIMUM_FLUSH_COUNT</a>];
05961     ULONG <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>;
05962     BOOLEAN Result;
05963 
05964     <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> = 0;
05965     Result = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
05966 
05967     <span class="comment">//</span>
05968     <span class="comment">// Loop on the copy on write case until the page is only</span>
05969     <span class="comment">// writable.</span>
05970     <span class="comment">//</span>
05971 
05972     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (Address);
05973     LastPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> ((PVOID)((PCHAR)Address + Length - 1));
05974 
05975     <a class="code" href="../../d4/d8/mi_8h.html#a130">LOCK_PFN2</a> (OldIrql);
05976 
05977     <span class="keywordflow">do</span> {
05978 
05979         PteContents = *PointerPte;
05980 
05981         <span class="keywordflow">if</span> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1) {
05982 
05983             Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber);
05984             Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.Modified = 1;
05985 
05986             <span class="keywordflow">if</span> ((Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype == 0) &amp;&amp;
05987                          (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.WriteInProgress == 0)) {
05988                 <a class="code" href="../../d4/d8/mi_8h.html#a889">MiReleasePageFileSpace</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>);
05989                 Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.PageFileHigh = 0;
05990             }
05991 
05992 <span class="preprocessor">#ifdef NT_UP</span>
05993 <span class="preprocessor"></span>            <span class="comment">//</span>
05994             <span class="comment">// On uniprocessor systems no need to flush if this processor</span>
05995             <span class="comment">// doesn't think the PTE is dirty.</span>
05996             <span class="comment">//</span>
05997 
05998             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a114">MI_IS_PTE_DIRTY</a> (PteContents)) {
05999                 Result = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
06000 <span class="preprocessor">#else  //NT_UP</span>
06001 <span class="preprocessor"></span>                Result |= (BOOLEAN)(<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a114">MI_IS_PTE_DIRTY</a> (PteContents));
06002 <span class="preprocessor">#endif //NT_UP</span>
06003 <span class="preprocessor"></span>                <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a113">MI_SET_PTE_CLEAN</a> (PteContents);
06004                 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a188">MI_WRITE_VALID_PTE_NEW_PROTECTION</a> (PointerPte, PteContents);
06005                 FlushContents = PteContents;
06006                 FlushPte = PointerPte;
06007 
06008                 <span class="comment">//</span>
06009                 <span class="comment">// Clear the write bit in the PTE so new writes can be tracked.</span>
06010                 <span class="comment">//</span>
06011 
06012                 <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> != <a class="code" href="../../d4/d8/mi_8h.html#a34">MM_MAXIMUM_FLUSH_COUNT</a>) {
06013                     VaFlushList[<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>] = Address;
06014                     <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> += 1;
06015                 }
06016 <span class="preprocessor">#ifdef NT_UP</span>
06017 <span class="preprocessor"></span>            }
06018 <span class="preprocessor">#endif //NT_UP</span>
06019 <span class="preprocessor"></span>        }
06020         PointerPte += 1;
06021         Address = (PVOID)((PCHAR)Address + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
06022     } <span class="keywordflow">while</span> (PointerPte &lt;= LastPte);
06023 
06024     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> != 0) {
06025         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> == 1) {
06026 
06027             (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>)<a class="code" href="../../d0/d6/ppc_2flushtb_8c.html#a2">KeFlushSingleTb</a> (VaFlushList[0],
06028                                    FALSE,
06029                                    TRUE,
06030                                    (PHARDWARE_PTE)FlushPte,
06031                                    FlushContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Flush);
06032 
06033         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> != <a class="code" href="../../d4/d8/mi_8h.html#a34">MM_MAXIMUM_FLUSH_COUNT</a>) {
06034 
06035             <a class="code" href="../../d0/d6/ppc_2flushtb_8c.html#a1">KeFlushMultipleTb</a> (Count,
06036                                &amp;VaFlushList[0],
06037                                FALSE,
06038                                TRUE,
06039                                NULL,
06040                                *(PHARDWARE_PTE)&amp;<a class="code" href="../../d4/d2/datalpha_8c.html#a0">ZeroPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Flush);
06041 
06042         } <span class="keywordflow">else</span> {
06043             <a class="code" href="../../d0/d6/ppc_2flushtb_8c.html#a0">KeFlushEntireTb</a> (FALSE, TRUE);
06044         }
06045     }
06046     <a class="code" href="../../d4/d8/mi_8h.html#a131">UNLOCK_PFN2</a> (OldIrql);
06047     <span class="keywordflow">return</span> Result;
06048 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a84" doxytag="iosup.c::MmSetBankedSection" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS MmSetBankedSection           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>ProcessHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>VirtualAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>BankLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>ReadWriteBank</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d1/mm_8h.html#a162">PBANKED_SECTION_ROUTINE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>BankRoutine</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Context</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l07311">7311</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02308">_MMBANKED_SECTION::BankedRoutine</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02307">_MMBANKED_SECTION::BankShift</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02306">_MMBANKED_SECTION::BankSize</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02311">_MMBANKED_SECTION::BankTemplate</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02305">_MMBANKED_SECTION::BasedPte</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02304">_MMBANKED_SECTION::BasePhysicalPage</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02309">_MMBANKED_SECTION::Context</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02310">_MMBANKED_SECTION::CurrentMappedPte</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02385">_MMVAD::EndingVpn</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00166">KeAttachProcess()</a>, <a class="el" href="../../d4/d4/procobj_8c-source.html#l00405">KeDetachProcess()</a>, <a class="el" href="../../d1/d5/ppc_2flushtb_8c-source.html#l00033">KeFlushEntireTb()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01093">LOCK_WS_AND_ADDRESS_SPACE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02410">MI_GET_PAGE_FRAME_FROM_PTE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00494">MI_MAKE_VALID_PTE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00710">MI_SET_PTE_DIRTY</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00761">MI_VA_TO_VPN</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00763">MI_VPN_TO_VA</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d7/d2/vadtree_8c-source.html#l00380">MiLocateAddress()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00137">MM_READWRITE</a>, <a class="el" href="../../d4/d8/mi_8h.html#a481">MMBANKED_SECTION</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l02072">PBANKED_SECTION_ROUTINE</a>, <a class="el" href="../../d4/d8/mi_8h.html#a482">PMMBANKED_SECTION</a>, <a class="el" href="../../d0/d8/ntos_8h-source.html#l00088">PsProcessType</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00282">PTE_SHIFT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02384">_MMVAD::StartingVpn</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d6/d6/struct__MMVAD.html#o7">_MMVAD::u</a>, <a class="el" href="../../d6/d6/struct__MMVAD.html#o19">_MMVAD::u4</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01097">UNLOCK_WS_AND_ADDRESS_SPACE</a>, and <a class="el" href="../../d5/d1/datalpha_8c-source.html#l00030">ZeroPte</a>.
<p>
<pre class="fragment"><div>07322                    :
07323 
07324     This function declares a mapped video buffer as a banked
07325     section.  This allows banked video devices (i.e., even
07326     though the video controller has a megabyte or so of memory,
07327     only a small bank (like 64k) can be mapped at any one time.
07328 
07329     In order to overcome <span class="keyword">this</span> problem, the pager handles faults
07330     to <span class="keyword">this</span> memory, unmaps the current bank, calls off to the
07331     video driver and then maps in the <span class="keyword">new</span> bank.
07332 
07333     This function creates the necessary structures to allow the
07334     video driver to be called from the pager.
07335 
07336  ********************* NOTE NOTE NOTE *************************
07337     At <span class="keyword">this</span> time only read/write banks are supported!
07338 
07339 Arguments:
07340 
07341     ProcessHandle - Supplies a handle to the process in which to
07342                     support the banked video function.
07343 
07344     VirtualAddress - Supplies the <span class="keyword">virtual</span> address where the video
07345                      buffer is mapped in the specified process.
07346 
07347     BankLength - Supplies the size of the bank.
07348 
07349     ReadWriteBank - Supplies TRUE <span class="keywordflow">if</span> the bank is read and write.
07350 
07351     BankRoutine - Supplies a pointer to the routine that should be
07352                   called by the pager.
07353 
07354     Context - Supplies a context to be passed by the pager to the
07355               BankRoutine.
07356 
07357 Return Value:
07358 
07359     Returns the status of the function.
07360 
07361 Environment:
07362 
07363     Kernel mode, APC_LEVEL or below.
07364 
07365 --*/
07366 
07367 {
07368     NTSTATUS Status;
07369     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
07370     <a class="code" href="../../d6/d6/struct__MMVAD.html">PMMVAD</a> Vad;
07371     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
07372     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastPte;
07373     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
07374     ULONG_PTR size;
07375     LONG count;
07376     ULONG NumberOfPtes;
07377     <a class="code" href="../../d0/d1/struct__MMBANKED__SECTION.html">PMMBANKED_SECTION</a> Bank;
07378 
07379     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a> ();
07380 
07381     UNREFERENCED_PARAMETER (ReadWriteBank);
07382 
07383     <span class="comment">//</span>
07384     <span class="comment">// Reference the specified process handle for VM_OPERATION access.</span>
07385     <span class="comment">//</span>
07386 
07387     Status = ObReferenceObjectByHandle ( ProcessHandle,
07388                                          PROCESS_VM_OPERATION,
07389                                          PsProcessType,
07390                                          KernelMode,
07391                                          (PVOID *)&amp;Process,
07392                                          NULL );
07393 
07394     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
07395         <span class="keywordflow">return</span> Status;
07396     }
07397 
07398     KeAttachProcess (&amp;Process-&gt;Pcb);
07399 
07400     <span class="comment">//</span>
07401     <span class="comment">// Get the address creation mutex to block multiple threads from</span>
07402     <span class="comment">// creating or deleting address space at the same time and</span>
07403     <span class="comment">// get the working set mutex so virtual address descriptors can</span>
07404     <span class="comment">// be inserted and walked.  Block APCs so an APC which takes a page</span>
07405     <span class="comment">// fault does not corrupt various structures.</span>
07406     <span class="comment">//</span>
07407 
07408     <a class="code" href="../../d4/d8/mi_8h.html#a161">LOCK_WS_AND_ADDRESS_SPACE</a> (Process);
07409 
07410     <span class="comment">//</span>
07411     <span class="comment">// Make sure the address space was not deleted, if so, return an error.</span>
07412     <span class="comment">//</span>
07413 
07414     <span class="keywordflow">if</span> (Process-&gt;AddressSpaceDeleted != 0) {
07415         Status = STATUS_PROCESS_IS_TERMINATING;
07416         <span class="keywordflow">goto</span> ErrorReturn;
07417     }
07418 
07419     Vad = <a class="code" href="../../d6/d3/vadtree_8c.html#a2">MiLocateAddress</a> (VirtualAddress);
07420 
07421     <span class="keywordflow">if</span> ((Vad == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
07422         (Vad-&gt;StartingVpn != <a class="code" href="../../d4/d8/mi_8h.html#a107">MI_VA_TO_VPN</a> (VirtualAddress)) ||
07423         (Vad-&gt;u.VadFlags.PhysicalMapping == 0)) {
07424         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NOT_MAPPED_DATA;
07425         <span class="keywordflow">goto</span> ErrorReturn;
07426     }
07427 
07428     size = <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> + ((Vad-&gt;EndingVpn - Vad-&gt;StartingVpn) &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
07429     <span class="keywordflow">if</span> ((size % BankLength) != 0) {
07430         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_VIEW_SIZE;
07431         <span class="keywordflow">goto</span> ErrorReturn;
07432     }
07433 
07434     count = -1;
07435     NumberOfPtes = BankLength;
07436 
07437     <span class="keywordflow">do</span> {
07438         NumberOfPtes = NumberOfPtes &gt;&gt; 1;
07439         count += 1;
07440     } <span class="keywordflow">while</span> (NumberOfPtes != 0);
07441 
07442     <span class="comment">//</span>
07443     <span class="comment">// Turn VAD into Banked VAD</span>
07444     <span class="comment">//</span>
07445 
07446     NumberOfPtes = BankLength &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
07447 
07448     Bank = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (NonPagedPool,
07449                                     <span class="keyword">sizeof</span> (<a class="code" href="../../d0/d1/struct__MMBANKED__SECTION.html">MMBANKED_SECTION</a>) +
07450                                        (NumberOfPtes - 1) * <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>),
07451                                     '  mM');
07452     <span class="keywordflow">if</span> (Bank == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
07453         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
07454         <span class="keywordflow">goto</span> ErrorReturn;
07455     }
07456 
07457     Bank-&gt;BankShift = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a52">PTE_SHIFT</a> + count - <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
07458 
07459     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(MI_VPN_TO_VA (Vad-&gt;StartingVpn));
07460     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte-&gt;u.Hard.Valid == 1);
07461 
07462     Vad-&gt;u4.Banked = Bank;
07463     Bank-&gt;BasePhysicalPage = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (PointerPte);
07464     Bank-&gt;BasedPte = PointerPte;
07465     Bank-&gt;BankSize = BankLength;
07466     Bank-&gt;BankedRoutine = BankRoutine;
07467     Bank-&gt;Context = Context;
07468     Bank-&gt;CurrentMappedPte = PointerPte;
07469 
07470     <span class="comment">//</span>
07471     <span class="comment">// Build the template PTEs structure.</span>
07472     <span class="comment">//</span>
07473 
07474     count = 0;
07475     TempPte = <a class="code" href="../../d4/d2/datalpha_8c.html#a0">ZeroPte</a>;
07476 
07477     <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a105">MI_MAKE_VALID_PTE</a> (TempPte,
07478                        Bank-&gt;BasePhysicalPage,
07479                        MM_READWRITE,
07480                        PointerPte);
07481 
07482     <span class="keywordflow">if</span> (TempPte.u.Hard.Write) {
07483         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a112">MI_SET_PTE_DIRTY</a> (TempPte);
07484     }
07485 
07486     <span class="keywordflow">do</span> {
07487         Bank-&gt;BankTemplate[count] = TempPte;
07488         TempPte.u.Hard.PageFrameNumber += 1;
07489         count += 1;
07490     } <span class="keywordflow">while</span> ((ULONG)count &lt; NumberOfPtes );
07491 
07492     LastPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (MI_VPN_TO_VA (Vad-&gt;EndingVpn));
07493 
07494     <span class="comment">//</span>
07495     <span class="comment">// Set all PTEs within this range to zero.  Any faults within</span>
07496     <span class="comment">// this range will call the banked routine before making the</span>
07497     <span class="comment">// page valid.</span>
07498     <span class="comment">//</span>
07499 
07500     RtlFillMemory (PointerPte,
07501                    (size &gt;&gt; (PAGE_SHIFT - PTE_SHIFT)),
07502                    (UCHAR)<a class="code" href="../../d4/d2/datalpha_8c.html#a0">ZeroPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long);
07503 
07504     <a class="code" href="../../d0/d6/ppc_2flushtb_8c.html#a0">KeFlushEntireTb</a> (TRUE, TRUE);
07505 
07506     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
07507 ErrorReturn:
07508 
07509     <a class="code" href="../../d4/d8/mi_8h.html#a162">UNLOCK_WS_AND_ADDRESS_SPACE</a> (Process);
07510     <a class="code" href="../../d3/d5/procobj_8c.html#a7">KeDetachProcess</a>();
07511     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a> (Process);
07512     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
07513 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a91" doxytag="iosup.c::MmSetKernelDumpRange" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MmSetKernelDumpRange           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>pDumpContext</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l08083">8083</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
References <a class="el" href="../../d3/d0/mm_8h-source.html#l00217">ADDRESS_AND_SIZE_TO_SPAN_PAGES</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00221">COMPUTE_PAGES_SPANNED</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l02400">IoFreeDumpRange()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l02291">IoSetDumpRange()</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02776">KeNumberProcessors</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02782">KiProcessorBlock</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02590">_MMFREE_POOL_ENTRY::List</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00094">List</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02262">MI_IS_PHYSICAL_ADDRESS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l04688">MI_MAX_FREE_LIST_HEADS</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l00150">MiProtectFreeNonPagedPool()</a>, <a class="el" href="../../d3/d1/data386_8c-source.html#l00181">MiSystemCacheEndExtra</a>, <a class="el" href="../../d3/d1/data386_8c-source.html#l00179">MiSystemCacheStartExtra</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l00209">MiUnProtectFreeNonPagedPool()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00080">MM_FREE_POOL_SIGNATURE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00130">MM_PAGES_IN_KSEG0</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00168">MM_SYSTEM_SPACE_END</a>, <a class="el" href="../../d4/d8/mi_8h.html#a513">MMFREE_POOL_ENTRY</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l05542">MmGetVirtualForPhysical()</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l00076">MmHighestPossiblePhysicalPage</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l03883">MmIsAddressValid()</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l00116">MmNonPagedPoolFreeListHead</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00064">MmNonPagedPoolStart</a>, <a class="el" href="../../d4/d8/mi_8h.html#a438">MMPFN</a>, <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l00075">MmPfnDatabase</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00092">MmProtectFreedNonPagedPool</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00075">MmSizeOfNonPagedPoolInBytes</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00050">MmSystemCacheEnd</a>, <a class="el" href="../../d9/d4/kddata_8c-source.html#l00049">MmSystemCacheStart</a>, <a class="el" href="../../d1/d8/miglobal_8c-source.html#l00033">MmSystemRangeStart</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00029">MmVirtualBias</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00582">PsLoadedModuleList</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02592">_MMFREE_POOL_ENTRY::Signature</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02591">_MMFREE_POOL_ENTRY::Size</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d3/d2/dumpctl_8c-source.html#l03815">IopCreateSummaryDump()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a62" doxytag="iosup.c::MmSetPageProtection" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN MmSetPageProtection           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>VirtualAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN SIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>NumberOfBytes</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>NewProtect</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l04027">4027</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
References <a class="el" href="../../d3/d0/mm_8h-source.html#l00141">BYTES_TO_PAGES</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d5/ppc_2flushtb_8c-source.html#l00188">KeFlushSingleTb()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00886">LOCK_PFN</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02262">MI_IS_PHYSICAL_ADDRESS</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00494">MI_MAKE_VALID_PTE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d1/d1/mmsup_8c-source.html#l00243">MiMakeProtectionMask()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00600">PAGE_SHIFT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l00896">UNLOCK_PFN</a>.
<p>
Referenced by <a class="el" href="../../d7/d8/kernlini_8c-source.html#l02460">KiI386PentiumLockErrataFixup()</a>.
<p>
<pre class="fragment"><div>04035                    :
04036 
04037     This function sets <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified <span class="keyword">virtual</span> address range to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> desired
04038     protection.  This assumes that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">virtual</span> addresses are backed by PTEs
04039     which can be set (ie: not in kseg0 or large pages).
04040 
04041 Arguments:
04042 
04043     VirtualAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> start address to protect.
04044 
04045     NumberOfBytes - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of bytes to set.
04046 
04047     NewProtect - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> protection to set <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pages to (PAGE_XX).
04048 
04049 Return Value:
04050 
04051     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> protection was applied, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <span class="keywordflow">if</span> not.
04052 
04053 Environment:
04054 
04055     Kernel mode, IRQL of <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a> or below.
04056 
04057 --*/
04058 
04059 {
04060     PFN_NUMBER i;
04061     PFN_NUMBER NumberOfPages;
04062     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
04063     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> TempPte;
04064     <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> NewPteContents;
04065     KIRQL OldIrql;
04066     ULONG ProtectionMask;
04067 
04068     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a178">MI_IS_PHYSICAL_ADDRESS</a>(VirtualAddress)) {
04069         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04070     }
04071 
04072     <span class="keywordflow">try</span> {
04073         ProtectionMask = <a class="code" href="../../d0/d2/mmsup_8c.html#a5">MiMakeProtectionMask</a> (NewProtect);
04074     } except (EXCEPTION_EXECUTE_HANDLER) {
04075         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
04076     }
04077 
04078     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (VirtualAddress);
04079     NumberOfPages = <a class="code" href="../../d2/d1/mm_8h.html#a5">BYTES_TO_PAGES</a> (NumberOfBytes);
04080 
04081     <a class="code" href="../../d4/d8/mi_8h.html#a127">LOCK_PFN</a> (OldIrql);
04082 
04083     <span class="keywordflow">for</span> (i = 0; i &lt; NumberOfPages; i += 1) {
04084         TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long = PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Long;
04085 
04086         <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a105">MI_MAKE_VALID_PTE</a> (NewPteContents,
04087                            TempPte.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.PageFrameNumber,
04088                            ProtectionMask,
04089                            PointerPte);
04090 
04091         <a class="code" href="../../d0/d6/ppc_2flushtb_8c.html#a2">KeFlushSingleTb</a> ((PVOID)((PUCHAR)VirtualAddress + (i &lt;&lt; PAGE_SHIFT)),
04092                          TRUE,
04093                          TRUE,
04094                          (PHARDWARE_PTE)PointerPte,
04095                          NewPteContents.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Flush);
04096 
04097         PointerPte += 1;
04098     }
04099 
04100     <a class="code" href="../../d4/d8/mi_8h.html#a129">UNLOCK_PFN</a> (OldIrql);
04101 
04102     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
04103 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a72" doxytag="iosup.c::MmSizeOfMdl" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> SIZE_T MmSizeOfMdl           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Base</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN SIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l05815">5815</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
References <a class="el" href="../../d3/d0/mm_8h-source.html#l00217">ADDRESS_AND_SIZE_TO_SPAN_PAGES</a>.
<p>
Referenced by <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l02995">ExLockUserBuffer()</a>, <a class="el" href="../../d1/d7/creasect_8c-source.html#l01424">MiCreateImageFileMap()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l05852">MmCreateMdl()</a>, and <a class="el" href="../../d0/d6/ex_2profile_8c-source.html#l00517">NtStartProfile()</a>.
<p>
<pre class="fragment"><div>05822                    :
05823 
05824     This function returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of bytes required <span class="keywordflow">for</span> an <a class="code" href="../../d6/d7/struct__MDL.html">MDL</a> <span class="keywordflow">for</span> a
05825     given buffer and size.
05826 
05827 Arguments:
05828 
05829     Base - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base <span class="keyword">virtual</span> address <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer.
05830 
05831     Length - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer in bytes.
05832 
05833 Return Value:
05834 
05835     Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of bytes required to contain <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d6/d7/struct__MDL.html">MDL</a>.
05836 
05837 Environment:
05838 
05839     Kernel mode.  Any IRQL level.
05840 
05841 --*/
05842 
05843 {
05844     <span class="keywordflow">return</span>( <span class="keyword">sizeof</span>( <a class="code" href="../../d6/d7/struct__MDL.html">MDL</a> ) +
05845                 (<a class="code" href="../../d2/d1/mm_8h.html#a8">ADDRESS_AND_SIZE_TO_SPAN_PAGES</a>( Base, Length ) *
05846                  <span class="keyword">sizeof</span>( PFN_NUMBER ))
05847           );
05848 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a81" doxytag="iosup.c::MmUnlockPagableImageSection" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MmUnlockPagableImageSection           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>ImageSectionHandle</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l07065">7065</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d7/eventobj_8c-source.html#l00167">KePulseEvent()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00901">LOCK_PFN2</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02410">MI_GET_PAGE_FRAME_FROM_PTE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02262">MI_IS_PHYSICAL_ADDRESS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01470">MI_REMOVE_LOCKED_PAGE_CHARGE</a>, <a class="el" href="../../d7/d4/pfndec_8c-source.html#l00167">MiDecrementReferenceCount()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l00206">MmCollidedLockEvent</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l00207">MmCollidedLockWait</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l00209">MmLockedCode</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01985">SECTION_BASE_ADDRESS</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o15">_MMPFN::u3</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l00905">UNLOCK_PFN2</a>.
<p>
Referenced by <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l03579">ExpGetLockInformation()</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l03661">ExpGetLookasideInformation()</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l03846">ExpGetPoolInformation()</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l03060">ExpGetProcessInformation()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l11239">IoUnregisterShutdownNotification()</a>, <a class="el" href="../../d0/d1/cyrix_8c-source.html#l00270">Ke386ConfigureCyrixProcessor()</a>, <a class="el" href="../../d9/d3/mtrr_8c-source.html#l00576">KeSetPhysicalCacheTypeRange()</a>, <a class="el" href="../../d1/d4/mtrramd_8c-source.html#l00294">KiAmdK6MtrrSetMemoryType()</a>, <a class="el" href="../../d6/d9/wsmanage_8c-source.html#l02715">MiEmptyAllWorkingSets()</a>, <a class="el" href="../../d2/d5/allocpag_8c-source.html#l04569">MiFindContiguousMemory()</a>, <a class="el" href="../../d6/d0/mminit_8c-source.html#l02664">MiFreeInitializationCode()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l00443">MiLoadSystemImage()</a>, <a class="el" href="../../d4/d4/mapview_8c-source.html#l03268">MiMapViewInSystemSpace()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l02309">MiSetPagingOfDriver()</a>, <a class="el" href="../../d5/d6/sessload_8c-source.html#l00119">MiShareSessionImage()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l03253">MiUnmapLockedPagesInUserSpace()</a>, <a class="el" href="../../d4/d4/mapview_8c-source.html#l03683">MiUnmapViewInSystemSpace()</a>, <a class="el" href="../../d5/d9/wslist_8c-source.html#l02450">MmAdjustWorkingSetSize()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l05581">MmAllocateNonCachedMemory()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l04270">MmAllocatePagesForMdl()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l02106">MmFreeDriverInitialization()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l05721">MmFreeNonCachedMemory()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l05051">MmFreePagesFromMdl()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l07821">MmLockPagedPool()</a>, <a class="el" href="../../d4/d4/mapview_8c-source.html#l00753">MmMapViewOfSection()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l02560">MmResetDriverPaging()</a>, <a class="el" href="../../d2/d8/shutdown_8c-source.html#l00041">MmShutdownSystem()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l02896">MmUnloadSystemImage()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l07869">MmUnlockPagedPool()</a>, <a class="el" href="../../d6/d2/queryvm_8c-source.html#l00061">NtQueryVirtualMemory()</a>, <a class="el" href="../../d0/d1/psquery_8c-source.html#l00291">PspQueryPooledQuotaLimits()</a>, <a class="el" href="../../d0/d1/psquery_8c-source.html#l00209">PspQueryQuotaLimits()</a>, <a class="el" href="../../d0/d1/psquery_8c-source.html#l00113">PspQueryWorkingSetWatch()</a>, <a class="el" href="../../d0/d1/psquery_8c-source.html#l01211">PspSetQuotaLimits()</a>, and <a class="el" href="../../d5/d8/smbtrsup_8c-source.html#l01050">SmbTraceStop()</a>.
<p>
<pre class="fragment"><div>07071                    :
07072 
07073     This function unlocks from memory, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pages locked by a preceding call to
07074     <a class="code" href="../../d2/d1/mm_8h.html#a306">MmLockPagableDataSection</a>.
07075 
07076 Arguments:
07077 
07078     ImageSectionHandle - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value returned by a previous call
07079         to <a class="code" href="../../d2/d1/mm_8h.html#a306">MmLockPagableDataSection</a>.
07080 
07081 Return Value:
07082 
07083     None.
07084 
07085 --*/
07086 
07087 {
07088     PIMAGE_SECTION_HEADER NtSection;
07089     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
07090     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastPte;
07091     PFN_NUMBER PageFrameIndex;
07092     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
07093     KIRQL OldIrql;
07094     PVOID BaseAddress;
07095     ULONG SizeToUnlock;
07096     ULONG Collision;
07097 
07098     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a178">MI_IS_PHYSICAL_ADDRESS</a>(ImageSectionHandle)) {
07099 
07100         <span class="comment">//</span>
07101         <span class="comment">// No need to lock physical addresses.</span>
07102         <span class="comment">//</span>
07103 
07104         <span class="keywordflow">return</span>;
07105     }
07106 
07107     NtSection = (PIMAGE_SECTION_HEADER)ImageSectionHandle;
07108 
07109     BaseAddress = <a class="code" href="../../d4/d8/mi_8h.html#a217">SECTION_BASE_ADDRESS</a>(NtSection);
07110     SizeToUnlock = NtSection-&gt;SizeOfRawData;
07111 
07112     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>(BaseAddress);
07113     LastPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a>((PCHAR)BaseAddress + SizeToUnlock - 1);
07114 
07115     <span class="comment">//</span>
07116     <span class="comment">// Address must be within the system cache.</span>
07117     <span class="comment">//</span>
07118 
07119     <a class="code" href="../../d4/d8/mi_8h.html#a130">LOCK_PFN2</a> (OldIrql);
07120 
07121     <span class="comment">//</span>
07122     <span class="comment">// The NumberOfLinenumbers field is used to store the</span>
07123     <span class="comment">// lock count.</span>
07124     <span class="comment">//</span>
07125 
07126     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (NtSection-&gt;NumberOfLinenumbers &gt;= 2);
07127     NtSection-&gt;NumberOfLinenumbers -= 1;
07128 
07129     <span class="keywordflow">if</span> (NtSection-&gt;NumberOfLinenumbers != 1) {
07130         <a class="code" href="../../d4/d8/mi_8h.html#a131">UNLOCK_PFN2</a> (OldIrql);
07131         <span class="keywordflow">return</span>;
07132     }
07133 
07134     <span class="keywordflow">do</span> {
07135         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1);
07136 
07137         PageFrameIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (PointerPte);
07138         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
07139 
07140         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount &gt; 1);
07141 
07142         <a class="code" href="../../d4/d8/mi_8h.html#a189">MI_REMOVE_LOCKED_PAGE_CHARGE</a> (Pfn1, 37);
07143 
07144         <a class="code" href="../../d6/d5/pfndec_8c.html#a2">MiDecrementReferenceCount</a> (PageFrameIndex);
07145 
07146         PointerPte += 1;
07147 
07148     } <span class="keywordflow">while</span> (PointerPte &lt;= LastPte);
07149 
07150     NtSection-&gt;NumberOfLinenumbers -= 1;
07151     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (NtSection-&gt;NumberOfLinenumbers == 0);
07152     Collision = <a class="code" href="../../d5/d6/iosup_8c.html#a19">MmCollidedLockWait</a>;
07153     <a class="code" href="../../d5/d6/iosup_8c.html#a19">MmCollidedLockWait</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
07154     <a class="code" href="../../d5/d6/iosup_8c.html#a20">MmLockedCode</a> -= SizeToUnlock;
07155 
07156     <a class="code" href="../../d4/d8/mi_8h.html#a131">UNLOCK_PFN2</a> (OldIrql);
07157 
07158     <span class="keywordflow">if</span> (Collision) {
07159         <a class="code" href="../../d2/d8/eventobj_8c.html#a5">KePulseEvent</a> (&amp;MmCollidedLockEvent, 0, FALSE);
07160     }
07161 
07162     <span class="keywordflow">return</span>;
07163 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a88" doxytag="iosup.c::MmUnlockPagedPool" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTKERNELAPI VOID MmUnlockPagedPool           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Address</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN SIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>SizeInBytes</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l07869">7869</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l03321">ExPageLockHandle</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00901">LOCK_PFN2</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02410">MI_GET_PAGE_FRAME_FROM_PTE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01470">MI_REMOVE_LOCKED_PAGE_CHARGE</a>, <a class="el" href="../../d7/d4/pfndec_8c-source.html#l00167">MiDecrementReferenceCount()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l06284">MmLockPagableSectionByHandle()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l07065">MmUnlockPagableImageSection()</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o15">_MMPFN::u3</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l00905">UNLOCK_PFN2</a>.
<p>
Referenced by <a class="el" href="../../d5/d2/i386_2ldtsup_8c-source.html#l00255">Ke386SetDescriptorProcess()</a>, and <a class="el" href="../../d9/d7/sysload_8c-source.html#l05376">MiSetImageProtect()</a>.
<p>
<pre class="fragment"><div>07876                    :
07877 
07878     Unlocks paged <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> that was locked with <a class="code" href="../../d2/d1/mm_8h.html#a308">MmLockPagedPool</a>.
07879 
07880 Arguments:
07881 
07882     Address - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address in paged <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> to unlock.
07883 
07884     <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size to unlock.
07885 
07886 Return Value:
07887 
07888     None.
07889 
07890 Environment:
07891 
07892     Kernel mode, IRQL of <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a> or below.
07893 
07894 --*/
07895 
07896 {
07897     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
07898     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LastPte;
07899     KIRQL OldIrql;
07900     PFN_NUMBER PageFrameIndex;
07901     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
07902 
07903     <a class="code" href="../../d5/d6/iosup_8c.html#a76">MmLockPagableSectionByHandle</a>(ExPageLockHandle);
07904     PointerPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (Address);
07905     LastPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> ((PVOID)((PCHAR)Address + (SizeInBytes - 1)));
07906     <a class="code" href="../../d4/d8/mi_8h.html#a130">LOCK_PFN2</a> (OldIrql);
07907 
07908     <span class="keywordflow">do</span> {
07909         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1);
07910 
07911         PageFrameIndex = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a182">MI_GET_PAGE_FRAME_FROM_PTE</a> (PointerPte);
07912         Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (PageFrameIndex);
07913 
07914         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount &gt; 1);
07915 
07916         <a class="code" href="../../d4/d8/mi_8h.html#a189">MI_REMOVE_LOCKED_PAGE_CHARGE</a> (Pfn1, 35);
07917 
07918         <a class="code" href="../../d6/d5/pfndec_8c.html#a2">MiDecrementReferenceCount</a> (PageFrameIndex);
07919 
07920         PointerPte += 1;
07921     } <span class="keywordflow">while</span> (PointerPte &lt;= LastPte);
07922 
07923     <a class="code" href="../../d4/d8/mi_8h.html#a131">UNLOCK_PFN2</a> (OldIrql);
07924     <a class="code" href="../../d5/d6/iosup_8c.html#a81">MmUnlockPagableImageSection</a>(ExPageLockHandle);
07925     <span class="keywordflow">return</span>;
07926 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a45" doxytag="iosup.c::MmUnlockPages" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MmUnlockPages           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT <a class="el" href="../../d6/d7/struct__MDL.html">PMDL</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>MemoryDescriptorList</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l01347">1347</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
References <a class="el" href="../../d3/d0/mm_8h-source.html#l00217">ADDRESS_AND_SIZE_TO_SPAN_PAGES</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d1/bugcheck_8c-source.html#l00428">KeBugCheckEx()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02679">_LOCK_HEADER::ListHead</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00901">LOCK_PFN2</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02662">_LOCK_TRACKER::Mdl</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00435">MDL_IO_SPACE</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00424">MDL_MAPPED_TO_SYSTEM_VA</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00425">MDL_PAGES_LOCKED</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00428">MDL_PARTIAL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00434">MDL_PHYSICAL_VIEW</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00426">MDL_SOURCE_IS_NONPAGED_POOL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00431">MDL_WRITE_OPERATION</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01470">MI_REMOVE_LOCKED_PAGE_CHARGE</a>, <a class="el" href="../../d7/d4/pfndec_8c-source.html#l00167">MiDecrementReferenceCount()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l01041">MiFreeMdlTracker()</a>, <a class="el" href="../../d9/d5/deleteva_8c-source.html#l01014">MiReleasePageFileSpace()</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l00107">MM_EMPTY_LIST</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l00044">MmHighestPhysicalPage</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l00098">MmLockedPagesHead</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00089">MmTrackLockedPages</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l03124">MmUnmapLockedPages()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l01297">_MMPFN::OriginalPte</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o15">_MMPFN::u3</a>, <a class="el" href="../../d7/d9/usercli_8h-source.html#l00368">Unlock</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l00905">UNLOCK_PFN2</a>.
<p>
Referenced by <a class="el" href="../../d8/d4/mdlsup_8c-source.html#l00030">CcMdlRead()</a>, <a class="el" href="../../d8/d4/mdlsup_8c-source.html#l00406">CcMdlReadComplete2()</a>, <a class="el" href="../../d8/d4/mdlsup_8c-source.html#l00838">CcMdlWriteComplete2()</a>, <a class="el" href="../../d8/d4/mdlsup_8c-source.html#l00466">CcPrepareMdlWrite()</a>, <a class="el" href="../../d6/d7/fssup_8c-source.html#l02952">CcZeroData()</a>, <a class="el" href="../../d0/d6/ex_2profile_8c-source.html#l00145">ExpProfileDelete()</a>, <a class="el" href="../../d7/d7/sysinfo_8c-source.html#l03048">ExUnlockUserBuffer()</a>, <a class="el" href="../../d0/d5/readwrt_8c-source.html#l00529">MiDoMappedCopy()</a>, <a class="el" href="../../d6/d2/queryvm_8c-source.html#l00890">MiGetWorkingSetInfo()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l00238">MmProbeAndLockPages()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l01152">MmProbeAndLockSelectedPages()</a>, <a class="el" href="../../d0/d6/ex_2profile_8c-source.html#l00517">NtStartProfile()</a>, <a class="el" href="../../d0/d6/ex_2profile_8c-source.html#l00680">NtStopProfile()</a>, and <a class="el" href="../../d0/d5/verifier_8c-source.html#l00829">VerifierUnlockPages()</a>.
<p>
<pre class="fragment"><div>01353                    :
01354 
01355     This routine unlocks physical pages which are described by a Memory
01356     Descriptor <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a>.
01357 
01358 Arguments:
01359 
01360     MemoryDescriptorList - Supplies a pointer to a memory descriptor list
01361                             (<a class="code" href="../../d6/d7/struct__MDL.html">MDL</a>). The supplied <a class="code" href="../../d6/d7/struct__MDL.html">MDL</a> must have been supplied
01362                             to MmLockPages to lock <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pages down.  As <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01363                             pages are unlocked, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d6/d7/struct__MDL.html">MDL</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> updated.
01364 
01365 Return Value:
01366 
01367     None.
01368 
01369 Environment:
01370 
01371     Kernel mode, IRQL of <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a> or below.
01372 
01373 --*/
01374 
01375 {
01376     PFN_NUMBER NumberOfPages;
01377     PPFN_NUMBER Page;
01378     PVOID StartingVa;
01379     KIRQL OldIrql;
01380     <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn1;
01381     LOGICAL <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a>;
01382 
01383     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((MemoryDescriptorList-&gt;MdlFlags &amp; MDL_PAGES_LOCKED) != 0);
01384     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((MemoryDescriptorList-&gt;MdlFlags &amp; MDL_SOURCE_IS_NONPAGED_POOL) == 0);
01385     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((MemoryDescriptorList-&gt;MdlFlags &amp; MDL_PARTIAL) == 0);
01386     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (MemoryDescriptorList-&gt;ByteCount != 0);
01387 
01388     <span class="keywordflow">if</span> (MemoryDescriptorList-&gt;MdlFlags &amp; <a class="code" href="../../d0/d9/ntosdef_8h.html#a12">MDL_MAPPED_TO_SYSTEM_VA</a>) {
01389 
01390         <span class="comment">//</span>
01391         <span class="comment">// This MDL has been mapped into system space, unmap now.</span>
01392         <span class="comment">//</span>
01393 
01394         <a class="code" href="../../d5/d6/iosup_8c.html#a56">MmUnmapLockedPages</a> (MemoryDescriptorList-&gt;MappedSystemVa,
01395                             MemoryDescriptorList);
01396     }
01397 
01398     Page = (PPFN_NUMBER)(MemoryDescriptorList + 1);
01399     <a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01400     StartingVa = (PVOID)((PCHAR)MemoryDescriptorList-&gt;StartVa +
01401                     MemoryDescriptorList-&gt;ByteOffset);
01402 
01403     NumberOfPages = <a class="code" href="../../d2/d1/mm_8h.html#a8">ADDRESS_AND_SIZE_TO_SPAN_PAGES</a>(StartingVa,
01404                                               MemoryDescriptorList-&gt;ByteCount);
01405 
01406     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a33">MmTrackLockedPages</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01407         <span class="keywordflow">if</span> ((MemoryDescriptorList-&gt;Process != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
01408             (<a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) &amp;&amp;
01409             ((MemoryDescriptorList-&gt;MdlFlags &amp; <a class="code" href="../../d0/d9/ntosdef_8h.html#a22">MDL_PHYSICAL_VIEW</a>) == 0)) {
01410                 <a class="code" href="../../d5/d6/iosup_8c.html#a43">MiFreeMdlTracker</a> (MemoryDescriptorList, NumberOfPages);
01411         }
01412     }
01413 
01414     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (NumberOfPages != 0);
01415 
01416     <a class="code" href="../../d4/d8/mi_8h.html#a130">LOCK_PFN2</a> (OldIrql);
01417 
01418     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/iosup_8c.html#a13">MmLockedPagesHead</a>.<a class="code" href="../../d5/d2/struct__LOCK__HEADER.html#o0">ListHead</a>.Flink != 0) {
01419 
01420         <a class="code" href="../../d0/d3/struct__LOCK__TRACKER.html">PLOCK_TRACKER</a> P;
01421         PLIST_ENTRY NextEntry;
01422 
01423         NextEntry = <a class="code" href="../../d5/d6/iosup_8c.html#a13">MmLockedPagesHead</a>.<a class="code" href="../../d5/d2/struct__LOCK__HEADER.html#o0">ListHead</a>.Flink;
01424         <span class="keywordflow">while</span> (NextEntry != &amp;<a class="code" href="../../d5/d6/iosup_8c.html#a13">MmLockedPagesHead</a>.<a class="code" href="../../d5/d2/struct__LOCK__HEADER.html#o0">ListHead</a>) {
01425 
01426             P = CONTAINING_RECORD(NextEntry,
01427                                   <a class="code" href="../../d0/d3/struct__LOCK__TRACKER.html">LOCK_TRACKER</a>,
01428                                   GlobalListEntry);
01429 
01430             <span class="keywordflow">if</span> (P-&gt;<a class="code" href="../../d0/d3/struct__LOCK__TRACKER.html#o1">Mdl</a> == MemoryDescriptorList) {
01431                 <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (LOCKED_PAGES_TRACKER_CORRUPTION,
01432                               0x4,
01433                               (ULONG_PTR)P,
01434                               (ULONG_PTR)MemoryDescriptorList,
01435                               0);
01436             }
01437 
01438             NextEntry = NextEntry-&gt;Flink;
01439         }
01440     }
01441 
01442     <span class="keywordflow">if</span> ((MemoryDescriptorList-&gt;Process != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
01443         (<a class="code" href="../../d6/d0/usercli_8h.html#a42">Unlock</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) &amp;&amp;
01444         ((MemoryDescriptorList-&gt;MdlFlags &amp; <a class="code" href="../../d0/d9/ntosdef_8h.html#a22">MDL_PHYSICAL_VIEW</a>) == 0)) {
01445 
01446         MemoryDescriptorList-&gt;Process-&gt;NumberOfLockedPages -= NumberOfPages;
01447         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((SPFN_NUMBER)MemoryDescriptorList-&gt;Process-&gt;NumberOfLockedPages &gt;= 0);
01448     }
01449 
01450     <span class="keywordflow">if</span> ((MemoryDescriptorList-&gt;MdlFlags &amp; (<a class="code" href="../../d0/d9/ntosdef_8h.html#a23">MDL_IO_SPACE</a> | <a class="code" href="../../d0/d9/ntosdef_8h.html#a22">MDL_PHYSICAL_VIEW</a>)) == 0) {
01451 
01452         <span class="comment">//</span>
01453         <span class="comment">// Only unlock if not I/O or physical space.</span>
01454         <span class="comment">//</span>
01455 
01456         <span class="keywordflow">do</span> {
01457 
01458             <span class="keywordflow">if</span> (*Page == <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>) {
01459 
01460                 <span class="comment">//</span>
01461                 <span class="comment">// There are no more locked pages.</span>
01462                 <span class="comment">//</span>
01463 
01464                 <span class="keywordflow">break</span>;
01465             }
01466             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (*Page &lt;= MmHighestPhysicalPage);
01467 
01468             <span class="comment">//</span>
01469             <span class="comment">// If this was a write operation set the modified bit in the</span>
01470             <span class="comment">// PFN database.</span>
01471             <span class="comment">//</span>
01472 
01473             Pfn1 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (*Page);
01474             <span class="keywordflow">if</span> (MemoryDescriptorList-&gt;MdlFlags &amp; <a class="code" href="../../d0/d9/ntosdef_8h.html#a19">MDL_WRITE_OPERATION</a>) {
01475                 Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.Modified = 1;
01476                 <span class="keywordflow">if</span> ((Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.Prototype == 0) &amp;&amp;
01477                              (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e1.WriteInProgress == 0)) {
01478                     <a class="code" href="../../d4/d8/mi_8h.html#a889">MiReleasePageFileSpace</a> (Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>);
01479                     Pfn1-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o16">OriginalPte</a>.<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Soft.PageFileHigh = 0;
01480                 }
01481             }
01482 
01483             <a class="code" href="../../d4/d8/mi_8h.html#a189">MI_REMOVE_LOCKED_PAGE_CHARGE</a>(Pfn1, 1);
01484 
01485             <a class="code" href="../../d6/d5/pfndec_8c.html#a2">MiDecrementReferenceCount</a> (*Page);
01486 
01487             *Page = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a0">MM_EMPTY_LIST</a>;
01488             Page += 1;
01489             NumberOfPages -= 1;
01490         } <span class="keywordflow">while</span> (NumberOfPages != 0);
01491     }
01492 
01493     MemoryDescriptorList-&gt;MdlFlags &amp;= ~<a class="code" href="../../d0/d9/ntosdef_8h.html#a13">MDL_PAGES_LOCKED</a>;
01494     <a class="code" href="../../d4/d8/mi_8h.html#a131">UNLOCK_PFN2</a> (OldIrql);
01495 
01496     <span class="keywordflow">return</span>;
01497 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a58" doxytag="iosup.c::MmUnmapIoSpace" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MmUnmapIoSpace           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>BaseAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN SIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>NumberOfBytes</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l03678">3678</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00221">COMPUTE_PAGES_SPANNED</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l01823">MiInsertDeadPteTrackingBlock()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00822">MiLockSystemSpace</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l01354">MiReleaseSystemPtes()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l01675">MiRemovePteTracker()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00825">MiUnlockSystemSpace</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00093">MmTrackPtes</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d4/d8/mi_8h.html#a1003a769">SystemPteSpace</a>.
<p>
Referenced by <a class="el" href="../../d0/d3/rules_8c-source.html#l02173">CmpFindACPITable()</a>, <a class="el" href="../../d0/d3/rules_8c-source.html#l01623">CmpMatchAcpiCreatorIdRule()</a>, <a class="el" href="../../d0/d3/rules_8c-source.html#l01540">CmpMatchAcpiCreatorRevisionRule()</a>, <a class="el" href="../../d0/d3/rules_8c-source.html#l01171">CmpMatchAcpiOemIdRule()</a>, <a class="el" href="../../d0/d3/rules_8c-source.html#l01372">CmpMatchAcpiOemRevisionRule()</a>, <a class="el" href="../../d0/d3/rules_8c-source.html#l01288">CmpMatchAcpiOemTableIdRule()</a>, <a class="el" href="../../d0/d3/rules_8c-source.html#l01456">CmpMatchAcpiRevisionRule()</a>, <a class="el" href="../../d7/d7/fsvga_8c-source.html#l00053">DriverEntry()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l05414">MmFreeContiguousMemorySpecifyCache()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l07751">MmUnmapVideoDisplay()</a>, and <a class="el" href="../../d0/d5/verifier_8c-source.html#l00906">VerifierUnmapIoSpace()</a>.
<p>
<pre class="fragment"><div>03685                    :
03686 
03687     This function unmaps a range of physical address which were previously
03688     mapped via an <a class="code" href="../../d2/d1/mm_8h.html#a286">MmMapIoSpace</a> function call.
03689 
03690 Arguments:
03691 
03692     BaseAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base <span class="keyword">virtual</span> address where <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> physical
03693                   address was previously mapped.
03694 
03695     NumberOfBytes - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of bytes which were mapped.
03696 
03697 Return Value:
03698 
03699     None.
03700 
03701 Environment:
03702 
03703     Kernel mode, Should be IRQL of <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a> or below, but unfortunately
03704     callers are coming in at <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a> and <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>'s too late to change <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
03705     rules now.  This means you can never make <span class="keyword">this</span> routine pagable.
03706 
03707 --*/
03708 
03709 {
03710     PFN_NUMBER NumberOfPages;
03711     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> FirstPte;
03712     KIRQL OldIrql;
03713     PVOID PoolBlock;
03714 
03715     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03716     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (NumberOfBytes != 0);
03717     NumberOfPages = <a class="code" href="../../d2/d1/mm_8h.html#a9">COMPUTE_PAGES_SPANNED</a> (BaseAddress, NumberOfBytes);
03718     FirstPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (BaseAddress);
03719     <a class="code" href="../../d0/d9/sysptes_8c.html#a26">MiReleaseSystemPtes</a>(FirstPte, (ULONG)NumberOfPages, SystemPteSpace);
03720 
03721     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a37">MmTrackPtes</a> != 0) {
03722         <a class="code" href="../../d4/d8/mi_8h.html#a117">MiLockSystemSpace</a>(OldIrql);
03723 
03724         PoolBlock = <a class="code" href="../../d5/d6/iosup_8c.html#a34">MiRemovePteTracker</a> (NULL,
03725                                         FirstPte,
03726                                         NumberOfPages);
03727         <a class="code" href="../../d4/d8/mi_8h.html#a118">MiUnlockSystemSpace</a>(OldIrql);
03728 
03729         <span class="comment">//</span>
03730         <span class="comment">// Can't free the pool block here because we may be getting called</span>
03731         <span class="comment">// from the fault path in MiWaitForInPageComplete holding the PFN</span>
03732         <span class="comment">// lock.  Queue the block for later release.</span>
03733         <span class="comment">//</span>
03734 
03735         <span class="keywordflow">if</span> (PoolBlock) {
03736             <a class="code" href="../../d5/d6/iosup_8c.html#a36">MiInsertDeadPteTrackingBlock</a> (PoolBlock);
03737         }
03738     }
03739 
03740     <span class="keywordflow">return</span>;
03741 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a56" doxytag="iosup.c::MmUnmapLockedPages" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MmUnmapLockedPages           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>BaseAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d6/d7/struct__MDL.html">PMDL</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>MemoryDescriptorList</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l03124">3124</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00221">COMPUTE_PAGES_SPANNED</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00901">LOCK_PFN2</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00435">MDL_IO_SPACE</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00433">MDL_LOCK_HELD</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00424">MDL_MAPPED_TO_SYSTEM_VA</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00432">MDL_PARENT_MAPPED_SYSTEM_VA</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00429">MDL_PARTIAL_HAS_BEEN_MAPPED</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00434">MDL_PHYSICAL_VIEW</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02410">MI_GET_PAGE_FRAME_FROM_PTE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l02262">MI_IS_PHYSICAL_ADDRESS</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00769">MI_PFN_ELEMENT</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l01823">MiInsertDeadPteTrackingBlock()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00822">MiLockSystemSpace</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l01354">MiReleaseSystemPtes()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l01675">MiRemovePteTracker()</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l00825">MiUnlockSystemSpace</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l03253">MiUnmapLockedPagesInUserSpace()</a>, <a class="el" href="../../d9/d9/cmdat3_8c-source.html#l00093">MmTrackPtes</a>, <a class="el" href="../../d4/d8/mi_8h.html#a1003a769">SystemPteSpace</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, <a class="el" href="../../d4/d3/struct__MMPFN.html#o15">_MMPFN::u3</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l00905">UNLOCK_PFN2</a>.
<p>
Referenced by <a class="el" href="../../d6/d7/fssup_8c-source.html#l02952">CcZeroData()</a>, <a class="el" href="../../d0/d6/ex_2profile_8c-source.html#l00145">ExpProfileDelete()</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l01095">MiCheckForCrashDump()</a>, <a class="el" href="../../d6/d4/sectsup_8c-source.html#l01075">MiCleanSection()</a>, <a class="el" href="../../d9/d5/forksup_8c-source.html#l00100">MiCloneProcessAddressSpace()</a>, <a class="el" href="../../d1/d7/creasect_8c-source.html#l01424">MiCreateImageFileMap()</a>, <a class="el" href="../../d0/d5/readwrt_8c-source.html#l00529">MiDoMappedCopy()</a>, <a class="el" href="../../d7/d4/flushsec_8c-source.html#l01014">MiFlushSectionInternal()</a>, <a class="el" href="../../d5/d4/procsup_8c-source.html#l05287">MiMakeOutswappedPageResident()</a>, <a class="el" href="../../d9/d1/pagfault_8c-source.html#l02335">MiWaitForInPageComplete()</a>, <a class="el" href="../../d7/d2/modwrite_8c-source.html#l02234">MiWriteComplete()</a>, <a class="el" href="../../d2/d8/shutdown_8c-source.html#l00041">MmShutdownSystem()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l01347">MmUnlockPages()</a>, <a class="el" href="../../d0/d6/ex_2profile_8c-source.html#l00517">NtStartProfile()</a>, <a class="el" href="../../d0/d6/ex_2profile_8c-source.html#l00680">NtStopProfile()</a>, and <a class="el" href="../../d0/d5/verifier_8c-source.html#l00874">VerifierUnmapLockedPages()</a>.
<p>
<pre class="fragment"><div>03131                    :
03132 
03133     This routine unmaps locked pages which were previously mapped via
03134     a <a class="code" href="../../d2/d1/mm_8h.html#a276">MmMapLockedPages</a> call.
03135 
03136 Arguments:
03137 
03138     BaseAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base address where <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> pages were previously
03139                   mapped.
03140 
03141     MemoryDescriptorList - Supplies a valid Memory Descriptor <a class="code" href="../../d1/d0/cmchek_8c.html#a12">List</a> which has
03142                             been updated by <a class="code" href="../../d2/d1/mm_8h.html#a273">MmProbeAndLockPages</a>.
03143 
03144 Return Value:
03145 
03146     None.
03147 
03148 Environment:
03149 
03150     Kernel mode.  <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a> or below <span class="keywordflow">if</span> base address <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> within
03151     system space; <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a> or below <span class="keywordflow">if</span> base address <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> user space.
03152 
03153 --*/
03154 
03155 {
03156     PFN_NUMBER NumberOfPages;
03157     PFN_NUMBER i;
03158     PPFN_NUMBER Page;
03159     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerPte;
03160     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> PointerBase;
03161     PVOID StartingVa;
03162     KIRQL OldIrql;
03163     PVOID PoolBlock;
03164 
03165     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (MemoryDescriptorList-&gt;ByteCount != 0);
03166     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((MemoryDescriptorList-&gt;MdlFlags &amp; MDL_PARENT_MAPPED_SYSTEM_VA) == 0);
03167 
03168     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a178">MI_IS_PHYSICAL_ADDRESS</a> (BaseAddress)) {
03169 
03170         <span class="comment">//</span>
03171         <span class="comment">// MDL is not mapped into virtual space, just clear the fields</span>
03172         <span class="comment">// and return.</span>
03173         <span class="comment">//</span>
03174 
03175         MemoryDescriptorList-&gt;MdlFlags &amp;= ~(<a class="code" href="../../d0/d9/ntosdef_8h.html#a12">MDL_MAPPED_TO_SYSTEM_VA</a> |
03176                                             <a class="code" href="../../d0/d9/ntosdef_8h.html#a17">MDL_PARTIAL_HAS_BEEN_MAPPED</a>);
03177         <span class="keywordflow">return</span>;
03178     }
03179 
03180     <span class="keywordflow">if</span> (BaseAddress &gt; MM_HIGHEST_USER_ADDRESS) {
03181 
03182         StartingVa = (PVOID)((PCHAR)MemoryDescriptorList-&gt;StartVa +
03183                         MemoryDescriptorList-&gt;ByteOffset);
03184 
03185         NumberOfPages = <a class="code" href="../../d2/d1/mm_8h.html#a9">COMPUTE_PAGES_SPANNED</a> (StartingVa,
03186                                                MemoryDescriptorList-&gt;ByteCount);
03187 
03188         PointerBase = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (BaseAddress);
03189 
03190 
03191         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((MemoryDescriptorList-&gt;MdlFlags &amp; MDL_MAPPED_TO_SYSTEM_VA) != 0);
03192 
03193 
03194 <span class="preprocessor">#if DBG</span>
03195 <span class="preprocessor"></span>        PointerPte = PointerBase;
03196         i = NumberOfPages;
03197         Page = (PPFN_NUMBER)(MemoryDescriptorList + 1);
03198         <span class="keywordflow">if</span> ((MemoryDescriptorList-&gt;MdlFlags &amp; <a class="code" href="../../d0/d9/ntosdef_8h.html#a21">MDL_LOCK_HELD</a>) == 0) {
03199             <a class="code" href="../../d4/d8/mi_8h.html#a130">LOCK_PFN2</a> (OldIrql);
03200         }
03201 
03202         <span class="keywordflow">while</span> (i != 0) {
03203             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PointerPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 1);
03204             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (*Page == MI_GET_PAGE_FRAME_FROM_PTE (PointerPte));
03205             <span class="keywordflow">if</span> ((MemoryDescriptorList-&gt;MdlFlags &amp; (<a class="code" href="../../d0/d9/ntosdef_8h.html#a23">MDL_IO_SPACE</a> | <a class="code" href="../../d0/d9/ntosdef_8h.html#a22">MDL_PHYSICAL_VIEW</a>)) == 0) {
03206                 <a class="code" href="../../d4/d3/struct__MMPFN.html">PMMPFN</a> Pfn3;
03207                 Pfn3 = <a class="code" href="../../d4/d8/mi_8h.html#a111">MI_PFN_ELEMENT</a> (*Page);
03208                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Pfn3-&gt;<a class="code" href="../../d4/d3/struct__MMPFN.html#o15">u3</a>.e2.ReferenceCount != 0);
03209             }
03210 
03211             Page += 1;
03212             PointerPte += 1;
03213             i -= 1;
03214         }
03215 
03216         <span class="keywordflow">if</span> ((MemoryDescriptorList-&gt;MdlFlags &amp; <a class="code" href="../../d0/d9/ntosdef_8h.html#a21">MDL_LOCK_HELD</a>) == 0) {
03217             <a class="code" href="../../d4/d8/mi_8h.html#a131">UNLOCK_PFN2</a> (OldIrql);
03218         }
03219 <span class="preprocessor">#endif //DBG</span>
03220 <span class="preprocessor"></span>
03221         MemoryDescriptorList-&gt;MdlFlags &amp;= ~(<a class="code" href="../../d0/d9/ntosdef_8h.html#a12">MDL_MAPPED_TO_SYSTEM_VA</a> |
03222                                             <a class="code" href="../../d0/d9/ntosdef_8h.html#a17">MDL_PARTIAL_HAS_BEEN_MAPPED</a>);
03223 
03224         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/cmdat3_8c.html#a37">MmTrackPtes</a> != 0) {
03225             <a class="code" href="../../d4/d8/mi_8h.html#a117">MiLockSystemSpace</a>(OldIrql);
03226             PoolBlock = <a class="code" href="../../d5/d6/iosup_8c.html#a34">MiRemovePteTracker</a> (MemoryDescriptorList,
03227                                             PointerBase,
03228                                             NumberOfPages);
03229             <a class="code" href="../../d4/d8/mi_8h.html#a118">MiUnlockSystemSpace</a>(OldIrql);
03230 
03231             <span class="comment">//</span>
03232             <span class="comment">// Can't free the pool block here because we may be getting called</span>
03233             <span class="comment">// from the fault path in MiWaitForInPageComplete holding the PFN</span>
03234             <span class="comment">// lock.  Queue the block for later release.</span>
03235             <span class="comment">//</span>
03236 
03237             <span class="keywordflow">if</span> (PoolBlock) {
03238                 <a class="code" href="../../d5/d6/iosup_8c.html#a36">MiInsertDeadPteTrackingBlock</a> (PoolBlock);
03239             }
03240         }
03241 
03242         <a class="code" href="../../d0/d9/sysptes_8c.html#a26">MiReleaseSystemPtes</a> (PointerBase, (ULONG)NumberOfPages, SystemPteSpace);
03243         <span class="keywordflow">return</span>;
03244 
03245     } <span class="keywordflow">else</span> {
03246 
03247         <a class="code" href="../../d5/d6/iosup_8c.html#a30">MiUnmapLockedPagesInUserSpace</a> (BaseAddress,
03248                                        MemoryDescriptorList);
03249     }
03250 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a86" doxytag="iosup.c::MmUnmapVideoDisplay" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MmUnmapVideoDisplay           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>BaseAddress</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN SIZE_T&nbsp;</td>
          <td class="mdname" nowrap> <em>NumberOfBytes</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l07751">7751</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00221">COMPUTE_PAGES_SPANNED</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00591">KSEG0_BASE</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01671">MiGetPteAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01559">MiGetSubsectionAddress</a>, <a class="el" href="../../d9/d7/alpha_2mialpha_8h-source.html#l01466">MiPteToProto</a>, <a class="el" href="../../d1/d8/sysptes_8c-source.html#l01354">MiReleaseSystemPtes()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l03678">MmUnmapIoSpace()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d7/mi_8h-source.html#l02121">_SUBSECTION::SubsectionBase</a>, <a class="el" href="../../d4/d8/mi_8h.html#a1003a769">SystemPteSpace</a>, <a class="el" href="../../d2/d4/struct__MMPTE.html#o8">_MMPTE::u</a>, and <a class="el" href="../../d5/d7/mi_8h-source.html#l00094">X64K</a>.
<p>
<pre class="fragment"><div>07758                    :
07759 
07760     This function unmaps a range of physical address which were previously
07761     mapped via an <a class="code" href="../../d2/d1/mm_8h.html#a289">MmMapVideoDisplay</a> function call.
07762 
07763 Arguments:
07764 
07765     BaseAddress - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base <span class="keyword">virtual</span> address where <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> physical
07766                   address was previously mapped.
07767 
07768     NumberOfBytes - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of bytes which were mapped.
07769 
07770 Return Value:
07771 
07772     None.
07773 
07774 Environment:
07775 
07776     Kernel mode, IRQL of <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a> or below.
07777 
07778 --*/
07779 
07780 {
07781 
07782 <span class="preprocessor">#ifdef LARGE_PAGES</span>
07783 <span class="preprocessor"></span>    PFN_NUMBER NumberOfPages;
07784     ULONG i;
07785     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> FirstPte;
07786     KIRQL OldIrql;
07787     <a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a> LargePte;
07788     <a class="code" href="../../d1/d7/struct__SUBSECTION.html">PSUBSECTION</a> Subsection;
07789 
07790     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
07791 
07792     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (NumberOfBytes != 0);
07793     NumberOfPages = <a class="code" href="../../d2/d1/mm_8h.html#a9">COMPUTE_PAGES_SPANNED</a> (BaseAddress, NumberOfBytes);
07794     FirstPte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a153">MiGetPteAddress</a> (BaseAddress);
07795 
07796     <span class="keywordflow">if</span> ((NumberOfBytes &gt; <a class="code" href="../../d4/d8/mi_8h.html#a18">X64K</a>) &amp;&amp; (FirstPte-&gt;<a class="code" href="../../d2/d4/struct__MMPTE.html#o8">u</a>.Hard.Valid == 0)) {
07797 
07798         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (MmLargeVideoMapped);
07799         LargePte = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a144">MiPteToProto</a> (FirstPte);
07800         Subsection = <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a148">MiGetSubsectionAddress</a> (LargePte);
07801         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (Subsection-&gt;<a class="code" href="../../d1/d7/struct__SUBSECTION.html#o6">SubsectionBase</a> == FirstPte);
07802 
07803         NumberOfPages = Subsection-&gt;EndingSector;
07804         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (Subsection);
07805         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (LargePte);
07806         MmLargeVideoMapped = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
07807         KeFillFixedEntryTb ((PHARDWARE_PTE)FirstPte, (PVOID)KSEG0_BASE, LARGE_ENTRY);
07808     }
07809     <a class="code" href="../../d0/d9/sysptes_8c.html#a26">MiReleaseSystemPtes</a>(FirstPte, NumberOfPages, SystemPteSpace);
07810     <span class="keywordflow">return</span>;
07811 
07812 <span class="preprocessor">#else // LARGE_PAGES</span>
07813 <span class="preprocessor"></span>
07814     <a class="code" href="../../d5/d6/iosup_8c.html#a58">MmUnmapIoSpace</a> (BaseAddress, NumberOfBytes);
07815     <span class="keywordflow">return</span>;
07816 <span class="preprocessor">#endif //LARGE_PAGES</span>
07817 <span class="preprocessor"></span>}

</div></pre>    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a11" doxytag="iosup.c::MiDeadPteTrackerListHead" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LIST_ENTRY <a class="el" href="../../d5/d6/iosup_8c.html#a11">MiDeadPteTrackerListHead</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l00095">95</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d5/iosup_8c-source.html#l01595">MiInitializeIoTrackers()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l01823">MiInsertDeadPteTrackingBlock()</a>, and <a class="el" href="../../d6/d5/iosup_8c-source.html#l01859">MiReleaseDeadPteTrackers()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a26" doxytag="iosup.c::MiLastCallColor" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d5/d6/iosup_8c.html#a26">MiLastCallColor</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l04266">4266</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d5/iosup_8c-source.html#l04270">MmAllocatePagesForMdl()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a25" doxytag="iosup.c::MiLastCallHighPage" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PFN_NUMBER <a class="el" href="../../d5/d6/iosup_8c.html#a25">MiLastCallHighPage</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l04265">4265</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d5/iosup_8c-source.html#l04270">MmAllocatePagesForMdl()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a24" doxytag="iosup.c::MiLastCallLowPage" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PFN_NUMBER <a class="el" href="../../d5/d6/iosup_8c.html#a24">MiLastCallLowPage</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l04264">4264</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d5/iosup_8c-source.html#l04270">MmAllocatePagesForMdl()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a15" doxytag="iosup.c::MiNoLowMemory" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LOGICAL <a class="el" href="../../d8/d8/sysload_8c.html#a24">MiNoLowMemory</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l00141">141</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
Referenced by <a class="el" href="../../d0/d3/4_2kdapi_8c-source.html#l03633">KdpCheckLowMemory()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l04107">MiAllocateContiguousMemory()</a>, <a class="el" href="../../d2/d1/mm_2i386_2init386_8c-source.html#l00058">MiInitMachineDependent()</a>, <a class="el" href="../../d9/d7/sysload_8c-source.html#l05956">MiReloadBootLoadedDrivers()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l05372">MmFreeContiguousMemory()</a>, and <a class="el" href="../../d6/d5/iosup_8c-source.html#l05414">MmFreeContiguousMemorySpecifyCache()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a22" doxytag="iosup.c::MiProbeRaises" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d5/d6/iosup_8c.html#a22">MiProbeRaises</a>[MI_PROBE_RAISE_SIZE]          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l00223">223</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="iosup.c::MiPteHeader" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d9/d7/struct__SYSPTES__HEADER.html">SYSPTES_HEADER</a> <a class="el" href="../../d5/d6/iosup_8c.html#a10">MiPteHeader</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l00094">94</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d5/iosup_8c-source.html#l01901">MiGetHighestPteConsumer()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l01595">MiInitializeIoTrackers()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l01611">MiInsertPteTracker()</a>, and <a class="el" href="../../d6/d5/iosup_8c-source.html#l01675">MiRemovePteTracker()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a12" doxytag="iosup.c::MiPteTrackerLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> KSPIN_LOCK <a class="el" href="../../d5/d6/iosup_8c.html#a12">MiPteTrackerLock</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l00096">96</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d5/iosup_8c-source.html#l01595">MiInitializeIoTrackers()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l01823">MiInsertDeadPteTrackingBlock()</a>, and <a class="el" href="../../d6/d5/iosup_8c-source.html#l01859">MiReleaseDeadPteTrackers()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a14" doxytag="iosup.c::MiTrackingAborted" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN <a class="el" href="../../d4/d8/mi_8h.html#a527">MiTrackingAborted</a> = FALSE          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l00099">99</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d5/iosup_8c-source.html#l00879">MiAddMdlTracker()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l01041">MiFreeMdlTracker()</a>, and <a class="el" href="../../d5/d4/procsup_8c-source.html#l01695">MmCleanProcessAddressSpace()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="iosup.c::MiTrackPtesAborted" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN <a class="el" href="../../d5/d6/iosup_8c.html#a9">MiTrackPtesAborted</a> = FALSE          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l00093">93</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d5/iosup_8c-source.html#l01901">MiGetHighestPteConsumer()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l01675">MiRemovePteTracker()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l03415">MmMapIoSpace()</a>, and <a class="el" href="../../d6/d5/iosup_8c-source.html#l02058">MmMapLockedPagesSpecifyCache()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a21" doxytag="iosup.c::MiWriteCombiningPtes" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN <a class="el" href="../../d5/d6/iosup_8c.html#a21">MiWriteCombiningPtes</a> = FALSE          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l00211">211</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d5/iosup_8c-source.html#l02785">MiMapLockedPagesInUserSpace()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l02395">MiMapSinglePage()</a>, <a class="el" href="../../d4/d4/mapview_8c-source.html#l01028">MiMapViewOfPhysicalSection()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l03415">MmMapIoSpace()</a>, and <a class="el" href="../../d6/d5/iosup_8c-source.html#l02058">MmMapLockedPagesSpecifyCache()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a18" doxytag="iosup.c::MmCollidedLockEvent" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> <a class="el" href="../../d4/d8/mi_8h.html#a721">MmCollidedLockEvent</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l00206">206</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d0/mminit_8c-source.html#l00184">MmInitSystem()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l06284">MmLockPagableSectionByHandle()</a>, and <a class="el" href="../../d6/d5/iosup_8c-source.html#l07065">MmUnlockPagableImageSection()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a19" doxytag="iosup.c::MmCollidedLockWait" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d5/d6/iosup_8c.html#a19">MmCollidedLockWait</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l00207">207</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d5/iosup_8c-source.html#l06284">MmLockPagableSectionByHandle()</a>, and <a class="el" href="../../d6/d5/iosup_8c-source.html#l07065">MmUnlockPagableImageSection()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a20" doxytag="iosup.c::MmLockedCode" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> SIZE_T <a class="el" href="../../d5/d6/iosup_8c.html#a20">MmLockedCode</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l00209">209</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d5/iosup_8c-source.html#l06461">MiLockCode()</a>, and <a class="el" href="../../d6/d5/iosup_8c-source.html#l07065">MmUnlockPagableImageSection()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a13" doxytag="iosup.c::MmLockedPagesHead" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d5/d2/struct__LOCK__HEADER.html">LOCK_HEADER</a> <a class="el" href="../../d5/d6/iosup_8c.html#a13">MmLockedPagesHead</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l00098">98</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d5/iosup_8c-source.html#l00879">MiAddMdlTracker()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l01041">MiFreeMdlTracker()</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l01595">MiInitializeIoTrackers()</a>, and <a class="el" href="../../d6/d5/iosup_8c-source.html#l01347">MmUnlockPages()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a17" doxytag="iosup.c::MmMdlPagesAllocated" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PFN_NUMBER <a class="el" href="../../d5/d6/iosup_8c.html#a17">MmMdlPagesAllocated</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l00204">204</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d5/iosup_8c-source.html#l04270">MmAllocatePagesForMdl()</a>, and <a class="el" href="../../d6/d5/iosup_8c-source.html#l05051">MmFreePagesFromMdl()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a23" doxytag="iosup.c::MmReferenceCountCheck" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d5/d6/iosup_8c.html#a23">MmReferenceCountCheck</a> = 2500          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l00234">234</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d5/iosup_8c-source.html#l00238">MmProbeAndLockPages()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="iosup.c::MmSystemLockPagesCount" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PFN_NUMBER <a class="el" href="../../d4/d8/mi_8h.html#a442">MmSystemLockPagesCount</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l00026">26</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d5/iosup_8c-source.html#l02058">MmMapLockedPagesSpecifyCache()</a>, and <a class="el" href="../../d6/d5/iosup_8c-source.html#l00238">MmProbeAndLockPages()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="iosup.c::MmTotalSystemDriverPages" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d8/d8/sysload_8c.html#a8">MmTotalSystemDriverPages</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l00028">28</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="iosup.c::MmTrackPtes" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LOGICAL <a class="el" href="../../d4/d8/mi_8h.html#a543">MmTrackPtes</a> = FALSE          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l00092">92</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a16" doxytag="iosup.c::NonPagedPoolDescriptor" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d4/d8/struct__POOL__DESCRIPTOR.html">POOL_DESCRIPTOR</a> <a class="el" href="../../d5/d6/iosup_8c.html#a16">NonPagedPoolDescriptor</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/iosup_8c-source.html#l00202">202</a> of file <a class="el" href="../../d6/d5/iosup_8c-source.html">iosup.c</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:44:23 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
