<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: lpcconn.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>lpcconn.c File Reference</h1><code>#include "<a class="el" href="../../d1/d6/lpcp_8h-source.html">lpcp.h</a>"</code><br>

<p>
<a href="../../d6/d5/lpcconn_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>PVOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/lpcconn_8c.html#a0">LpcpFreeConMsg</a> (IN <a class="el" href="../../d5/d4/struct__LPCP__MESSAGE.html">PLPCP_MESSAGE</a> *Msg, <a class="el" href="../../d4/d4/struct__LPCP__CONNECTION__MESSAGE.html">PLPCP_CONNECTION_MESSAGE</a> *ConnectMsg, IN <a class="el" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> CurrentThread)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSYSAPI NTSTATUS NTAPI&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/lpcconn_8c.html#a1">NtConnectPort</a> (OUT PHANDLE <a class="el" href="../../d7/d7/uclient_8c.html#a3">PortHandle</a>, IN PUNICODE_STRING <a class="el" href="../../d8/d0/ctlpcqos_8c.html#a5">PortName</a>, IN PSECURITY_QUALITY_OF_SERVICE <a class="el" href="../../d8/d0/ctlpcqos_8c.html#a9">SecurityQos</a>, IN OUT PPORT_VIEW ClientView OPTIONAL, IN OUT PREMOTE_PORT_VIEW ServerView OPTIONAL, OUT PULONG MaxMessageLength OPTIONAL, IN OUT PVOID ConnectionInformation OPTIONAL, IN OUT PULONG ConnectionInformationLength OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/lpcconn_8c.html#a2">NtSecureConnectPort</a> (OUT PHANDLE <a class="el" href="../../d7/d7/uclient_8c.html#a3">PortHandle</a>, IN PUNICODE_STRING <a class="el" href="../../d8/d0/ctlpcqos_8c.html#a5">PortName</a>, IN PSECURITY_QUALITY_OF_SERVICE <a class="el" href="../../d8/d0/ctlpcqos_8c.html#a9">SecurityQos</a>, IN OUT PPORT_VIEW ClientView OPTIONAL, IN PSID RequiredServerSid, IN OUT PREMOTE_PORT_VIEW ServerView OPTIONAL, OUT PULONG MaxMessageLength OPTIONAL, IN OUT PVOID ConnectionInformation OPTIONAL, IN OUT PULONG ConnectionInformationLength OPTIONAL)</td></tr>

</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a0" doxytag="lpcconn.c::LpcpFreeConMsg" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PVOID LpcpFreeConMsg           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d5/d4/struct__LPCP__MESSAGE.html">PLPCP_MESSAGE</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>Msg</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d4/d4/struct__LPCP__CONNECTION__MESSAGE.html">PLPCP_CONNECTION_MESSAGE</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>ConnectMsg</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>CurrentThread</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/lpcconn_8c-source.html#l01131">1131</a> of file <a class="el" href="../../d6/d5/lpcconn_8c-source.html">lpcconn.c</a>.
<p>
References <a class="el" href="../../d1/d6/lpcp_8h-source.html#l00093">LpcpAcquireLpcpLock</a>, <a class="el" href="../../d1/d6/lpcp_8h-source.html#l00108">LpcpReleaseLpcpLock</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d3/d5/lpc_8h-source.html#l00173">_LPCP_CONNECTION_MESSAGE::SectionToMap</a>.
<p>
Referenced by <a class="el" href="../../d6/d5/lpcconn_8c-source.html#l00084">NtSecureConnectPort()</a>.
<p>
<pre class="fragment"><div>01139                    :
01140 
01141     This routine returns a connection reply message <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified thread
01142 
01143 Arguments:
01144 
01145     Msg - Receives a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> LPCP message <span class="keywordflow">if</span> there <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a reply
01146 
01147     ConnectMsg - Receives a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> LPCP connection message <span class="keywordflow">if</span> there
01148         <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a reply
01149 
01150     CurrentThread - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread we're to be examining
01151 
01152 Return Value:
01153 
01154     PVOID - Returns a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> section to map in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> connection message
01155 
01156 --*/
01157 
01158 {
01159     PVOID SectionToMap;
01160 
01161     <span class="comment">//</span>
01162     <span class="comment">//  Acquire the LPC mutex, remove the connection request message</span>
01163     <span class="comment">//  from the received queue and free the message back to the connection</span>
01164     <span class="comment">//  port's zone.</span>
01165     <span class="comment">//</span>
01166 
01167     <a class="code" href="../../d0/d7/lpcp_8h.html#a3">LpcpAcquireLpcpLock</a>();
01168 
01169     <span class="comment">//</span>
01170     <span class="comment">//  Remove the thread from the reply rundown list in case we did not wakeup due to</span>
01171     <span class="comment">//  a reply</span>
01172     <span class="comment">//</span>
01173 
01174     <span class="keywordflow">if</span> (!IsListEmpty( &amp;CurrentThread-&gt;LpcReplyChain )) {
01175 
01176         RemoveEntryList( &amp;CurrentThread-&gt;LpcReplyChain );
01177 
01178         InitializeListHead( &amp;CurrentThread-&gt;LpcReplyChain );
01179     }
01180 
01181     <span class="comment">//</span>
01182     <span class="comment">//  Check if the thread has an LPC reply message waiting to be handled</span>
01183     <span class="comment">//</span>
01184 
01185     <span class="keywordflow">if</span> (CurrentThread-&gt;LpcReplyMessage != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01186 
01187         <span class="comment">//</span>
01188         <span class="comment">//  Take the message off the threads list</span>
01189         <span class="comment">//</span>
01190 
01191         *Msg = CurrentThread-&gt;LpcReplyMessage;
01192 
01193         CurrentThread-&gt;LpcReplyMessageId = 0;
01194         CurrentThread-&gt;LpcReplyMessage = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01195 
01196         <span class="comment">//</span>
01197         <span class="comment">//  Set the connection message pointer, and copy over the section</span>
01198         <span class="comment">//  to map location before zeroing it out</span>
01199         <span class="comment">//</span>
01200 
01201         *ConnectMsg = (<a class="code" href="../../d4/d4/struct__LPCP__CONNECTION__MESSAGE.html">PLPCP_CONNECTION_MESSAGE</a>)(*Msg + 1);
01202 
01203         SectionToMap = (*ConnectMsg)-&gt;<a class="code" href="../../d4/d4/struct__LPCP__CONNECTION__MESSAGE.html#o2">SectionToMap</a>;
01204         (*ConnectMsg)-&gt;SectionToMap = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01205 
01206     } <span class="keywordflow">else</span> {
01207 
01208         <span class="comment">//</span>
01209         <span class="comment">//  Otherwise there is no LPC message to be handle so we'll return</span>
01210         <span class="comment">//  null's to our caller</span>
01211         <span class="comment">//</span>
01212 
01213         *Msg = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01214         SectionToMap = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01215     }
01216 
01217     <span class="comment">//</span>
01218     <span class="comment">//  Release the global lock and return to our caller</span>
01219     <span class="comment">//</span>
01220 
01221     <a class="code" href="../../d0/d7/lpcp_8h.html#a4">LpcpReleaseLpcpLock</a>();
01222 
01223     <span class="keywordflow">return</span> SectionToMap;
01224 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="lpcconn.c::NtConnectPort" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSYSAPI NTSTATUS NTAPI NtConnectPort           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">OUT PHANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>PortHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>PortName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSECURITY_QUALITY_OF_SERVICE&nbsp;</td>
          <td class="mdname" nowrap> <em>SecurityQos</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PPORT_VIEW ClientView&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PREMOTE_PORT_VIEW ServerView&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG MaxMessageLength&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PVOID ConnectionInformation&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PULONG ConnectionInformationLength&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/lpcconn_8c-source.html#l00043">43</a> of file <a class="el" href="../../d6/d5/lpcconn_8c-source.html">lpcconn.c</a>.
<p>
References <a class="el" href="../../d6/d5/lpcconn_8c-source.html#l00084">NtSecureConnectPort()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d8/d6/uclient_8c-source.html#l00027">PortHandle</a>, <a class="el" href="../../d4/d8/ulpc_8h-source.html#l00032">PortName</a>, and <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00037">SecurityQos</a>.
<p>
Referenced by <a class="el" href="../../d6/d3/icadis_8c-source.html#l00042">ConnectToTerminalServer()</a>, <a class="el" href="../../d4/d9/dllssstb_8c-source.html#l00025">DbgSspConnectToDbg()</a>, <a class="el" href="../../d5/d9/dlluistb_8c-source.html#l00027">DbgUiConnectToDbg()</a>, <a class="el" href="../../d3/d3/internal_8c-source.html#l01506">IopConnectLinkTrackingPort()</a>, <a class="el" href="../../d8/d6/errorlog_8c-source.html#l00566">IopErrorLogConnectPort()</a>, <a class="el" href="../../d8/d6/uclient_8c-source.html#l00099">main()</a>, and <a class="el" href="../../d3/d7/api_8c-source.html#l00279">TerminalServerRequestThread()</a>.
<p>
<pre class="fragment"><div>00056                    :
00057 
00058     See <a class="code" href="../../d5/d6/lpcconn_8c.html#a2">NtSecureConnectPort</a>
00059 
00060 Arguments:
00061 
00062     See <a class="code" href="../../d5/d6/lpcconn_8c.html#a2">NtSecureConnectPort</a>
00063 
00064 Return Value:
00065 
00066     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - An appropriate status value
00067 
00068 --*/
00069 
00070 {
00071     <span class="keywordflow">return</span> <a class="code" href="../../d5/d6/lpcconn_8c.html#a2">NtSecureConnectPort</a>( PortHandle,
00072                                 PortName,
00073                                 SecurityQos,
00074                                 ClientView,
00075                                 NULL,
00076                                 ServerView,
00077                                 MaxMessageLength,
00078                                 ConnectionInformation,
00079                                 ConnectionInformationLength );
00080 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="lpcconn.c::NtSecureConnectPort" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtSecureConnectPort           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">OUT PHANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>PortHandle</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>PortName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSECURITY_QUALITY_OF_SERVICE&nbsp;</td>
          <td class="mdname" nowrap> <em>SecurityQos</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PPORT_VIEW ClientView&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSID&nbsp;</td>
          <td class="mdname" nowrap> <em>RequiredServerSid</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PREMOTE_PORT_VIEW ServerView&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG MaxMessageLength&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PVOID ConnectionInformation&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PULONG ConnectionInformationLength&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/lpcconn_8c-source.html#l00084">84</a> of file <a class="el" href="../../d6/d5/lpcconn_8c-source.html">lpcconn.c</a>.
<p>
References <a class="el" href="../../d2/d8/ps_8h-source.html#l00388">_ETHREAD::Cid</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00134">CLIENT_COMMUNICATION_PORT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d8/d9/cmdat2_8c-source.html#l00091">Handle</a>, <a class="el" href="../../d2/d5/semphobj_8c-source.html#l00085">KeReadStateSemaphore()</a>, <a class="el" href="../../d2/d5/semphobj_8c-source.html#l00118">KeReleaseSemaphore()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d3/d7/eventobj_8c-source.html#l00343">KeSetEvent()</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00174">KPROCESSOR_MODE</a>, <a class="el" href="../../d2/d6/lpc_8h.html#a21">LPCP_PORT_OBJECT</a>, <a class="el" href="../../d1/d6/lpcp_8h-source.html#l00093">LpcpAcquireLpcpLock</a>, <a class="el" href="../../d4/d6/lpcqueue_8c-source.html#l00558">LpcpAllocateFromPortZone()</a>, <a class="el" href="../../d6/d5/lpcconn_8c-source.html#l01131">LpcpFreeConMsg()</a>, <a class="el" href="../../d4/d6/lpcqueue_8c-source.html#l00642">LpcpFreeToPortZone()</a>, <a class="el" href="../../d1/d6/lpcp_8h-source.html#l00071">LpcpGenerateMessageId</a>, <a class="el" href="../../d4/d6/lpcqueue_8c-source.html#l00037">LpcpInitializePortQueue()</a>, <a class="el" href="../../d0/d8/ntos_8h-source.html#l00091">LpcPortObjectType</a>, <a class="el" href="../../d1/d6/lpcp_8h-source.html#l00108">LpcpReleaseLpcpLock</a>, <a class="el" href="../../d1/d6/lpcp_8h-source.html#l00320">LpcpTrace</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00371">_ETHREAD::LpcReplyChain</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00395">_ETHREAD::LpcReplyMessage</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00396">_ETHREAD::LpcReplyMessageId</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00394">_ETHREAD::LpcReplySemaphore</a>, <a class="el" href="../../d0/d8/ntos_8h-source.html#l00092">LpcWaitablePortObjectType</a>, <a class="el" href="../../d4/d4/mapview_8c-source.html#l00753">MmMapViewOfSection()</a>, <a class="el" href="../../d3/d0/mm_8h-source.html#l00381">MmSectionObjectType</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d6/d9/obclose_8c-source.html#l00037">NtClose()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d9/obcreate_8c-source.html#l00055">ObCreateObject()</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d2/d0/obinsert_8c-source.html#l00029">ObInsertObject()</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00514">ObReferenceObject</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00542">ObReferenceObjectByHandle()</a>, <a class="el" href="../../d8/d0/obref_8c-source.html#l00844">ObReferenceObjectByName()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00137">PORT_DYNAMIC_SECURITY</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00136">PORT_NAME_DELETED</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00130">PORT_TYPE</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00135">PORT_WAITABLE</a>, <a class="el" href="../../d8/d6/uclient_8c-source.html#l00027">PortHandle</a>, <a class="el" href="../../d4/d8/ulpc_8h-source.html#l00032">PortName</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01431">ProbeAndReadStructure</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01339">ProbeAndReadUlong</a>, <a class="el" href="../../d0/d4/probe_8c-source.html#l00034">ProbeForWrite()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01564">ProbeForWriteHandle</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l01649">ProbeForWriteUlong</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00810">PsDereferencePrimaryToken</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d7/d4/ps_2security_8c-source.html#l00028">PsReferencePrimaryToken()</a>, <a class="el" href="../../d9/d5/sertl_8c-source.html#l00871">RtlEqualSid()</a>, <a class="el" href="../../d3/d4/se_2capture_8c-source.html#l01141">SeCaptureSid()</a>, <a class="el" href="../../d5/d4/seclient_8c-source.html#l00209">SeCreateClientSecurity()</a>, <a class="el" href="../../d8/d9/ctlnpqos_8c-source.html#l00037">SecurityQos</a>, <a class="el" href="../../d0/d3/tokenqry_8c-source.html#l01189">SeQueryInformationToken()</a>, <a class="el" href="../../d3/d4/se_2capture_8c-source.html#l01320">SeReleaseSid()</a>, <a class="el" href="../../d3/d5/lpc_8h-source.html#l00131">SERVER_CONNECTION_PORT</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d9/ctaccess_8c-source.html#l00123">Token</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00007">WrExecutive</a>.
<p>
Referenced by <a class="el" href="../../d2/d9/csrinit_8c-source.html#l00359">CsrpConnectToServer()</a>, and <a class="el" href="../../d6/d5/lpcconn_8c-source.html#l00043">NtConnectPort()</a>.
<p>
<pre class="fragment"><div>00098                    :
00099 
00100     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> client process can connect to a server process by name <span class="keyword">using</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00101     <a class="code" href="../../d5/d6/lpcconn_8c.html#a1">NtConnectPort</a> service.
00102 
00103     The <a class="code" href="../../d3/d9/ulpc_8h.html#a2">PortName</a> parameter specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> server port to
00104     connect to.  It must correspond to an object name specified on a
00105     call to <a class="code" href="../../d6/d6/lpccreat_8c.html#a1">NtCreatePort</a>.  The service sends a connection request to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00106     server thread that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> listening <span class="keywordflow">for</span> them with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d8/d6/lpclistn_8c.html#a0">NtListenPort</a>
00107     service.  The client thread then blocks until a server thread
00108     receives <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> connection request and responds with a call to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00109     <a class="code" href="../../d4/d6/lpccompl_8c.html#a2">NtCompleteConnectPort</a> service.  The server thread receives <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a> of
00110     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client thread, along with any information passed via <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00111     ConnectionInformation parameter.  The server thread then decides to
00112     either accept or reject <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> connection request.
00113 
00114     The server communicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> acceptance or rejection with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00115     <a class="code" href="../../d4/d6/lpccompl_8c.html#a2">NtCompleteConnectPort</a> service.  The server can pass back data to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00116     client about <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> acceptance or rejection via <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00117     ConnectionInformation data block.
00118 
00119     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> server accepts <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> connection request, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client
00120     receives a communication port object in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> location pointed to by
00121     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d7/d7/uclient_8c.html#a3">PortHandle</a> parameter.  This object handle has no name associated
00122     with <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> and <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <span class="keyword">private</span> to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client process (i.e.  it cannot be
00123     inherited by a child process).  The client uses <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle to send
00124     and receive messages to/from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> server process <span class="keyword">using</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00125     <a class="code" href="../../d6/d7/lpcsend_8c.html#a1">NtRequestWaitReplyPort</a> service.
00126 
00127     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ClientView parameter was specified, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> section handle
00128     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> examined.  If <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a valid section handle, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> portion of
00129     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> section described by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SectionOffset and ViewSize fields will
00130     be mapped into both <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client and server process' address spaces.
00131     The address in client address space will be returned in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ViewBase
00132     field.  The address in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> server address space will be returned in
00133     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ViewRemoteBase field.  The actual offset and size used to map
00134     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> section will be returned in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SectionOffset and ViewSize
00135     fields.
00136 
00137     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> server rejects <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> connection request, then no communication
00138     port object handle <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> returned, and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keywordflow">return</span> status indicates an
00139     error occurred.  The server may optionally <span class="keywordflow">return</span> information in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00140     ConnectionInformation data block giving <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a10">reason</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> connection
00141     requests was rejected.
00142 
00143     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d9/ulpc_8h.html#a2">PortName</a> does not exist, or <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client process does not have
00144     sufficient access rights then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> returned status will indicate that
00145     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> port was not found.
00146 
00147 Arguments:
00148 
00149     <a class="code" href="../../d7/d7/uclient_8c.html#a3">PortHandle</a> - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to a variable that will receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client
00150         communication port object handle value.
00151 
00152     <a class="code" href="../../d3/d9/ulpc_8h.html#a2">PortName</a> - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to a port name string.  The form of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name
00153         <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> [\name...\name]\port_name.
00154 
00155     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a14">SecurityQos</a> - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to security quality of service information
00156         to be applied to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> server on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client's behalf.
00157 
00158     ClientView - An optional pointer to a structure that specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00159         section that all client threads will use to send messages to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00160         server.
00161 
00162     ClientView Structure
00163 
00164         ULONG Length - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size of <span class="keyword">this</span> data structure in
00165             bytes.
00166 
00167         HANDLE SectionHandle - Specifies an open handle to a section
00168             object.
00169 
00170         ULONG SectionOffset - Specifies a field that will receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00171             actual offset, in bytes, from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> start of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> section.  The
00172             initial value of <span class="keyword">this</span> parameter specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> byte offset
00173             within <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> section that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client's view <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> based.  The
00174             value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> rounded down to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> next host page size boundary.
00175 
00176         ULONG ViewSize - Specifies a field that will receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00177             actual size, in bytes, of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> view.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value of <span class="keyword">this</span>
00178             parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> zero, then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client's view of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> section
00179             will be mapped starting at <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified section offset and
00180             continuing to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> end of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> section.  Otherwise, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00181             initial value of <span class="keyword">this</span> parameter specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size, in
00182             bytes, of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client's view and <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> rounded up to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> next
00183             host page size boundary.
00184 
00185         PVOID ViewBase - Specifies a field that will receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base
00186             address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> section in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client's address space.
00187 
00188         PVOID ViewRemoteBase - Specifies a field that will receive
00189             <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client's section in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> server's
00190             address space.  Used to generate pointers that are
00191             meaningful to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> server.
00192 
00193     RequiredServerSid - Optionally specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> SID that we expect <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00194         server side of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> port to possess.  If not specified then we'll
00195         connect to any server SID.
00196 
00197     ServerView - An optional pointer to a structure that will receive
00198         information about <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> server process' view in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client's
00199         address space.  The client process can use <span class="keyword">this</span> information
00200         to validate pointers <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> receives from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> server process.
00201 
00202         ServerView Structure
00203 
00204         ULONG Length - Specifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size of <span class="keyword">this</span> data structure in
00205             bytes.
00206 
00207         PVOID ViewBase - Specifies a field that will receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> base
00208             address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> server's section in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client's address
00209             space.
00210 
00211         ULONG ViewSize - Specifies a field that will receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00212             size, in bytes, of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> server's view in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client's address
00213             space.  If <span class="keyword">this</span> field <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> zero, then server has no view in
00214             <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client's address space.
00215 
00216     MaxMessageLength - An optional pointer to a variable that will
00217         receive maximum length of messages that can be sent to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00218         server.  The value of <span class="keyword">this</span> parameter will not exceed
00219         MAX_PORTMSG_LENGTH bytes.
00220 
00221     ConnectionInformation - An optional pointer to uninterpreted data.
00222         This data <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> intended <span class="keywordflow">for</span> clients to pass package, version and
00223         protocol identification information to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> server to allow <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00224         server to determine <span class="keywordflow">if</span> <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> can satisify <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client before
00225         accepting <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> connection.  Upon <span class="keywordflow">return</span> to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> client, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00226         ConnectionInformation data block contains any information passed
00227         back from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> server by its call to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d4/d6/lpccompl_8c.html#a2">NtCompleteConnectPort</a>
00228         service.  The output data overwrites <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> input data.
00229 
00230     ConnectionInformationLength - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00231         ConnectionInformation data block.  The output value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00232         length of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data stored in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ConnectionInformation data
00233         block by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> server's call to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d4/d6/lpccompl_8c.html#a2">NtCompleteConnectPort</a>
00234         service.  This parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> OPTIONAL <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00235         ConnectionInformation parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> null, otherwise <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00236         required.
00237 
00238 Return Value:
00239 
00240     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - An appropriate status value.
00241 
00242 --*/
00243 
00244 {
00245     <a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html">PLPCP_PORT_OBJECT</a> ConnectionPort;
00246     <a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html">PLPCP_PORT_OBJECT</a> ClientPort;
00247     HANDLE <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>;
00248     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00249     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00250     ULONG ConnectionInfoLength;
00251     PVOID SectionToMap;
00252     <a class="code" href="../../d5/d4/struct__LPCP__MESSAGE.html">PLPCP_MESSAGE</a> Msg;
00253     <a class="code" href="../../d4/d4/struct__LPCP__CONNECTION__MESSAGE.html">PLPCP_CONNECTION_MESSAGE</a> ConnectMsg;
00254     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> CurrentThread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
00255     LARGE_INTEGER SectionOffset;
00256     PORT_VIEW CapturedClientView;
00257     SECURITY_QUALITY_OF_SERVICE CapturedQos;
00258     PSID CapturedRequiredServerSid;
00259 
00260     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00261 
00262     <span class="comment">//</span>
00263     <span class="comment">//  Get previous processor mode and probe input and output arguments if</span>
00264     <span class="comment">//  necessary.</span>
00265     <span class="comment">//</span>
00266 
00267     PreviousMode = KeGetPreviousMode();
00268     ConnectionInfoLength = 0;
00269 
00270     <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00271 
00272         <span class="keywordflow">try</span> {
00273 
00274             <a class="code" href="../../d5/d8/ex_8h.html#a35">ProbeForWriteHandle</a>( PortHandle );
00275 
00276             <span class="keywordflow">if</span> (ARGUMENT_PRESENT( ClientView )) {
00277 
00278                 CapturedClientView = <a class="code" href="../../d5/d8/ex_8h.html#a27">ProbeAndReadStructure</a>( ClientView, PORT_VIEW );
00279 
00280                 <span class="keywordflow">if</span> (CapturedClientView.Length != <span class="keyword">sizeof</span>( *ClientView )) {
00281 
00282                     <span class="keywordflow">return</span>( STATUS_INVALID_PARAMETER );
00283                 }
00284 
00285                 <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>( ClientView,
00286                                <span class="keyword">sizeof</span>( *ClientView ),
00287                                <span class="keyword">sizeof</span>( ULONG ));
00288             }
00289 
00290             <span class="keywordflow">if</span> (ARGUMENT_PRESENT( ServerView )) {
00291 
00292                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d8/ex_8h.html#a20">ProbeAndReadUlong</a>( &amp;ServerView-&gt;Length ) != <span class="keyword">sizeof</span>( *ServerView )) {
00293 
00294                     <span class="keywordflow">return</span>( STATUS_INVALID_PARAMETER );
00295                 }
00296 
00297                 <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>( ServerView,
00298                                <span class="keyword">sizeof</span>( *ServerView ),
00299                                <span class="keyword">sizeof</span>( ULONG ));
00300             }
00301 
00302             <span class="keywordflow">if</span> (ARGUMENT_PRESENT( MaxMessageLength )) {
00303 
00304                 <a class="code" href="../../d5/d8/ex_8h.html#a40">ProbeForWriteUlong</a>( MaxMessageLength );
00305             }
00306 
00307             <span class="keywordflow">if</span> (ARGUMENT_PRESENT( ConnectionInformationLength )) {
00308 
00309                 ConnectionInfoLength = <a class="code" href="../../d5/d8/ex_8h.html#a20">ProbeAndReadUlong</a>( ConnectionInformationLength );
00310                 <a class="code" href="../../d5/d8/ex_8h.html#a40">ProbeForWriteUlong</a>( ConnectionInformationLength );
00311             }
00312 
00313             <span class="keywordflow">if</span> (ARGUMENT_PRESENT( ConnectionInformation )) {
00314 
00315                 <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>( ConnectionInformation,
00316                                ConnectionInfoLength,
00317                                <span class="keyword">sizeof</span>( UCHAR ));
00318             }
00319 
00320             CapturedQos = <a class="code" href="../../d5/d8/ex_8h.html#a27">ProbeAndReadStructure</a>( SecurityQos, SECURITY_QUALITY_OF_SERVICE );
00321 
00322             CapturedRequiredServerSid = RequiredServerSid;
00323 
00324             <span class="keywordflow">if</span> (ARGUMENT_PRESENT( RequiredServerSid )) {
00325 
00326                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d5/se_2capture_8c.html#a8">SeCaptureSid</a>( RequiredServerSid,
00327                                        PreviousMode,
00328                                        NULL,
00329                                        0,
00330                                        PagedPool,
00331                                        TRUE,
00332                                        &amp;CapturedRequiredServerSid );
00333 
00334                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00335 
00336                     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00337                 }
00338             }
00339 
00340         } except( EXCEPTION_EXECUTE_HANDLER ) {
00341 
00342             <span class="keywordflow">return</span>( GetExceptionCode() );
00343         }
00344 
00345     <span class="comment">//</span>
00346     <span class="comment">//  Otherwise this is a kernel mode operation</span>
00347     <span class="comment">//</span>
00348 
00349     } <span class="keywordflow">else</span> {
00350 
00351         <span class="keywordflow">if</span> (ARGUMENT_PRESENT( ClientView )) {
00352 
00353             <span class="keywordflow">if</span> (ClientView-&gt;Length != <span class="keyword">sizeof</span>( *ClientView )) {
00354 
00355                 <span class="keywordflow">return</span>( STATUS_INVALID_PARAMETER );
00356             }
00357 
00358             CapturedClientView = *ClientView;
00359         }
00360 
00361         <span class="keywordflow">if</span> (ARGUMENT_PRESENT( ServerView )) {
00362 
00363             <span class="keywordflow">if</span> (ServerView-&gt;Length != <span class="keyword">sizeof</span>( *ServerView )) {
00364 
00365                 <span class="keywordflow">return</span>( STATUS_INVALID_PARAMETER );
00366             }
00367         }
00368 
00369         <span class="keywordflow">if</span> (ARGUMENT_PRESENT( ConnectionInformationLength )) {
00370 
00371             ConnectionInfoLength = *ConnectionInformationLength;
00372         }
00373 
00374         CapturedQos = *<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a14">SecurityQos</a>;
00375         CapturedRequiredServerSid = RequiredServerSid;
00376     }
00377 
00378     <span class="comment">//</span>
00379     <span class="comment">//  Reference the connection port object by name.  Return status if</span>
00380     <span class="comment">//  unsuccessful.</span>
00381     <span class="comment">//</span>
00382 
00383     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a5">ObReferenceObjectByName</a>( PortName,
00384                                       0,
00385                                       NULL,
00386                                       PORT_CONNECT,
00387                                       LpcPortObjectType,
00388                                       PreviousMode,
00389                                       NULL,
00390                                       (PVOID *)&amp;ConnectionPort );
00391 
00392     <span class="comment">//</span>
00393     <span class="comment">//  If the port type object didn't work then try for a waitable port type</span>
00394     <span class="comment">//  object</span>
00395     <span class="comment">//</span>
00396 
00397     <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_OBJECT_TYPE_MISMATCH ) {
00398 
00399         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a5">ObReferenceObjectByName</a>( PortName,
00400                                           0,
00401                                           NULL,
00402                                           PORT_CONNECT,
00403                                           LpcWaitablePortObjectType,
00404                                           PreviousMode,
00405                                           NULL,
00406                                           (PVOID *)&amp;ConnectionPort );
00407     }
00408 
00409     <span class="comment">//</span>
00410     <span class="comment">//  We can't locate the name so release the sid if we captured one and</span>
00411     <span class="comment">//  return error status back to our caller</span>
00412     <span class="comment">//</span>
00413 
00414     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00415 
00416         <span class="keywordflow">if</span> (CapturedRequiredServerSid != RequiredServerSid) {
00417 
00418             <a class="code" href="../../d2/d5/se_2capture_8c.html#a9">SeReleaseSid</a>( CapturedRequiredServerSid, PreviousMode, TRUE);
00419         }
00420 
00421         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00422     }
00423 
00424     <a class="code" href="../../d0/d7/lpcp_8h.html#a13">LpcpTrace</a>((<span class="stringliteral">"Connecting to port %wZ\n"</span>, PortName ));
00425 
00426     <span class="comment">//</span>
00427     <span class="comment">//  Error if user didn't give us a server communication port</span>
00428     <span class="comment">//</span>
00429 
00430     <span class="keywordflow">if</span> ((ConnectionPort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o1">Flags</a> &amp; <a class="code" href="../../d2/d6/lpc_8h.html#a3">PORT_TYPE</a>) != <a class="code" href="../../d2/d6/lpc_8h.html#a4">SERVER_CONNECTION_PORT</a>) {
00431 
00432         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( ConnectionPort );
00433 
00434         <span class="keywordflow">if</span> (CapturedRequiredServerSid != RequiredServerSid) {
00435 
00436             <a class="code" href="../../d2/d5/se_2capture_8c.html#a9">SeReleaseSid</a>( CapturedRequiredServerSid, PreviousMode, TRUE);
00437         }
00438 
00439         <span class="keywordflow">return</span> STATUS_INVALID_PORT_HANDLE;
00440     }
00441 
00442     <span class="comment">//</span>
00443     <span class="comment">//  If this is NtSecureConnectPort, validated the required SID against</span>
00444     <span class="comment">//  the SID of the server process.  Fail if not equal.</span>
00445     <span class="comment">//</span>
00446 
00447     <span class="keywordflow">if</span> (ARGUMENT_PRESENT( RequiredServerSid )) {
00448 
00449         PTOKEN_USER TokenInfo;
00450 
00451         <span class="keywordflow">if</span> (ConnectionPort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o16">ServerProcess</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00452 
00453             PACCESS_TOKEN <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> ;
00454 
00455             <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> = <a class="code" href="../../d6/d5/ps_2security_8c.html#a0">PsReferencePrimaryToken</a>( ConnectionPort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o16">ServerProcess</a> );
00456 
00457     
00458             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a2">SeQueryInformationToken</a>( Token,
00459                                               TokenUser,
00460                                               &amp;TokenInfo );
00461             
00462             <a class="code" href="../../d1/d9/ps_8h.html#a24">PsDereferencePrimaryToken</a>( Token );
00463 
00464             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00465 
00466                 <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>( CapturedRequiredServerSid, TokenInfo-&gt;User.Sid )) {
00467 
00468                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SERVER_SID_MISMATCH;
00469                 }
00470 
00471                 <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( TokenInfo );
00472             }
00473 
00474         } <span class="keywordflow">else</span> {
00475 
00476             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SERVER_SID_MISMATCH;
00477         }
00478 
00479         <span class="comment">//</span>
00480         <span class="comment">//  We are all done with the required server sid if specified so</span>
00481         <span class="comment">//  now release one if we had to capture it</span>
00482         <span class="comment">//</span>
00483 
00484         <span class="keywordflow">if</span> (CapturedRequiredServerSid != RequiredServerSid) {
00485 
00486             <a class="code" href="../../d2/d5/se_2capture_8c.html#a9">SeReleaseSid</a>( CapturedRequiredServerSid, PreviousMode, TRUE);
00487         }
00488 
00489         <span class="comment">//</span>
00490         <span class="comment">//  If the se information token query didn't work then return the</span>
00491         <span class="comment">//  error to our caller</span>
00492         <span class="comment">//</span>
00493 
00494         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00495 
00496             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( ConnectionPort );
00497 
00498             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00499         }
00500     }
00501 
00502     <span class="comment">//</span>
00503     <span class="comment">//  Allocate and initialize a client communication port object.  Give</span>
00504     <span class="comment">//  the port a request message queue for lost reply datagrams.  If</span>
00505     <span class="comment">//  unable to initialize the port, then deference the port object which</span>
00506     <span class="comment">//  will cause it to be deleted and return the system service status.</span>
00507     <span class="comment">//</span>
00508 
00509     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d0/obcreate_8c.html#a5">ObCreateObject</a>( PreviousMode,
00510                              LpcPortObjectType,
00511                              NULL,
00512                              PreviousMode,
00513                              NULL,
00514                              <span class="keyword">sizeof</span>( <a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html">LPCP_PORT_OBJECT</a> ),
00515                              0,
00516                              0,
00517                              (PVOID *)&amp;ClientPort );
00518 
00519     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00520 
00521         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( ConnectionPort );
00522 
00523         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00524     }
00525 
00526     <span class="comment">//</span>
00527     <span class="comment">//  Note, that from here on, none of the error paths dereference the</span>
00528     <span class="comment">//  connection port pointer, just the newly created client port pointer.</span>
00529     <span class="comment">//  The port delete routine will get called when the client port is</span>
00530     <span class="comment">//  deleted and it will dereference the connection port pointer stored</span>
00531     <span class="comment">//  in the client port object.</span>
00532     <span class="comment">//</span>
00533 
00534     <span class="comment">//</span>
00535     <span class="comment">//  Initialize the client port object to zeros and then fill in the</span>
00536     <span class="comment">//  fields.</span>
00537     <span class="comment">//</span>
00538 
00539     RtlZeroMemory( ClientPort, <span class="keyword">sizeof</span>( LPCP_PORT_OBJECT ));
00540 
00541     ClientPort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o0">Length</a> = <span class="keyword">sizeof</span>( <a class="code" href="../../d2/d6/lpc_8h.html#a21">LPCP_PORT_OBJECT</a> );
00542     ClientPort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o1">Flags</a> = <a class="code" href="../../d2/d6/lpc_8h.html#a7">CLIENT_COMMUNICATION_PORT</a>;
00543     ClientPort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o2">ConnectionPort</a> = ConnectionPort;
00544     ClientPort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o9">MaxMessageLength</a> = ConnectionPort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o9">MaxMessageLength</a>;
00545     ClientPort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o12">SecurityQos</a> = CapturedQos;
00546 
00547     InitializeListHead( &amp;ClientPort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o14">LpcReplyChainHead</a> );
00548     InitializeListHead( &amp;ClientPort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o15">LpcDataInfoChainHead</a> );
00549 
00550     <span class="comment">//</span>
00551     <span class="comment">//  Set the security tracking mode, and initialize the client security</span>
00552     <span class="comment">//  context if it is static tracking.</span>
00553     <span class="comment">//</span>
00554 
00555     <span class="keywordflow">if</span> (CapturedQos.ContextTrackingMode == SECURITY_DYNAMIC_TRACKING) {
00556 
00557         ClientPort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o1">Flags</a> |= <a class="code" href="../../d2/d6/lpc_8h.html#a10">PORT_DYNAMIC_SECURITY</a>;
00558 
00559     } <span class="keywordflow">else</span> {
00560 
00561         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d5/seclient_8c.html#a1">SeCreateClientSecurity</a>( CurrentThread,
00562                                          &amp;CapturedQos,
00563                                          FALSE,
00564                                          &amp;ClientPort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o13">StaticSecurity</a> );
00565 
00566         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00567 
00568             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( ClientPort );
00569 
00570             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00571         }
00572     }
00573 
00574     <span class="comment">//</span>
00575     <span class="comment">//  Client communication ports get a request message queue for lost</span>
00576     <span class="comment">//  replies.</span>
00577     <span class="comment">//</span>
00578 
00579     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d7/lpcqueue_8c.html#a0">LpcpInitializePortQueue</a>( ClientPort );
00580 
00581     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00582 
00583         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( ClientPort );
00584 
00585         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00586     }
00587 
00588     <span class="comment">//</span>
00589     <span class="comment">//  If client has allocated a port memory section, then map a view of</span>
00590     <span class="comment">//  that section into the client's address space.  Also reference the</span>
00591     <span class="comment">//  section object so we can pass a pointer to the section object in</span>
00592     <span class="comment">//  connection request message.  If the server accepts the connection,</span>
00593     <span class="comment">//  then it will map a corresponding view of the section in the server's</span>
00594     <span class="comment">//  address space, using the referenced pointer passed in the connection</span>
00595     <span class="comment">//  request message.</span>
00596     <span class="comment">//</span>
00597 
00598     <span class="keywordflow">if</span> (ARGUMENT_PRESENT( ClientView )) {
00599 
00600         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>( CapturedClientView.SectionHandle,
00601                                             SECTION_MAP_READ |
00602                                             SECTION_MAP_WRITE,
00603                                             MmSectionObjectType,
00604                                             PreviousMode,
00605                                             (PVOID *)&amp;SectionToMap,
00606                                             NULL );
00607 
00608         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00609 
00610             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( ClientPort );
00611 
00612             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00613         }
00614 
00615         SectionOffset.LowPart = CapturedClientView.SectionOffset,
00616         SectionOffset.HighPart = 0;
00617 
00618         <span class="comment">//</span>
00619         <span class="comment">//  Now map a view of the section using the reference we just captured</span>
00620         <span class="comment">//  and not the section handle itself, because the handle may have changed</span>
00621         <span class="comment">//</span>
00622 
00623         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d5/mapview_8c.html#a21">MmMapViewOfSection</a>( SectionToMap,
00624                                      <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>(),
00625                                      &amp;ClientPort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o6">ClientSectionBase</a>,
00626                                      0,
00627                                      0,
00628                                      &amp;SectionOffset,
00629                                      &amp;CapturedClientView.ViewSize,
00630                                      ViewUnmap,
00631                                      0,
00632                                      PAGE_READWRITE );
00633 
00634         CapturedClientView.SectionOffset = SectionOffset.LowPart;
00635 
00636         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00637 
00638             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( SectionToMap );
00639             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( ClientPort );
00640 
00641             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00642         }
00643 
00644         CapturedClientView.ViewBase = ClientPort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o6">ClientSectionBase</a>;
00645 
00646     } <span class="keywordflow">else</span> {
00647 
00648         SectionToMap = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00649     }
00650 
00651     <span class="comment">//</span>
00652     <span class="comment">//  Adjust the size of the connection info length that the client supplied</span>
00653     <span class="comment">//  to be the no longer than one the connection port will accept</span>
00654     <span class="comment">//</span>
00655 
00656     <span class="keywordflow">if</span> (ConnectionInfoLength &gt; ConnectionPort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o10">MaxConnectionInfoLength</a>) {
00657 
00658         ConnectionInfoLength = ConnectionPort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o10">MaxConnectionInfoLength</a>;
00659     }
00660 
00661     <span class="comment">//</span>
00662     <span class="comment">//  At this point the client port is all setup and now we have to</span>
00663     <span class="comment">//  allocate a request connection message for the server and send it off</span>
00664     <span class="comment">//</span>
00665     <span class="comment">//  Lock, allocate and then unlock the zone.  We are allocation a</span>
00666     <span class="comment">//  connection request message.  It holds the LPCP message, the LPCP</span>
00667     <span class="comment">//  connection message, and the user supplied connection information</span>
00668     <span class="comment">//</span>
00669 
00670     <a class="code" href="../../d0/d7/lpcp_8h.html#a3">LpcpAcquireLpcpLock</a>();
00671 
00672     Msg = <a class="code" href="../../d3/d7/lpcqueue_8c.html#a4">LpcpAllocateFromPortZone</a>( <span class="keyword">sizeof</span>( *Msg ) +
00673                                     <span class="keyword">sizeof</span>( *ConnectMsg ) +
00674                                     ConnectionInfoLength );
00675 
00676     <a class="code" href="../../d0/d7/lpcp_8h.html#a4">LpcpReleaseLpcpLock</a>();
00677 
00678     <span class="comment">//</span>
00679     <span class="comment">//  If we didn't get memory for the message then tell our caller we failed</span>
00680     <span class="comment">//</span>
00681 
00682     <span class="keywordflow">if</span> (Msg == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00683 
00684         <span class="keywordflow">if</span> (SectionToMap != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00685 
00686             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( SectionToMap );
00687         }
00688 
00689         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( ClientPort );
00690 
00691         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00692     }
00693 
00694     <span class="comment">//</span>
00695     <span class="comment">//  Msg points to the LPCP message, followed by ConnectMsg which points to</span>
00696     <span class="comment">//  the LPCP connection message, followed by client specified information.</span>
00697     <span class="comment">//  We'll now fill it all in.</span>
00698     <span class="comment">//</span>
00699 
00700     ConnectMsg = (<a class="code" href="../../d4/d4/struct__LPCP__CONNECTION__MESSAGE.html">PLPCP_CONNECTION_MESSAGE</a>)(Msg + 1);
00701 
00702     <span class="comment">//</span>
00703     <span class="comment">//  This thread originated the message</span>
00704     <span class="comment">//</span>
00705 
00706     Msg-&gt;Request.ClientId = CurrentThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o12">Cid</a>;
00707 
00708     <span class="comment">//</span>
00709     <span class="comment">//  If we have a client view then copy over the client view information</span>
00710     <span class="comment">//  otherwise we'll zero out all of the view information</span>
00711     <span class="comment">//</span>
00712 
00713     <span class="keywordflow">if</span> (ARGUMENT_PRESENT( ClientView )) {
00714 
00715         Msg-&gt;Request.ClientViewSize = CapturedClientView.ViewSize;
00716 
00717         RtlMoveMemory( &amp;ConnectMsg-&gt;<a class="code" href="../../d4/d4/struct__LPCP__CONNECTION__MESSAGE.html#o0">ClientView</a>,
00718                        &amp;CapturedClientView,
00719                        <span class="keyword">sizeof</span>( CapturedClientView ));
00720 
00721         RtlZeroMemory( &amp;ConnectMsg-&gt;<a class="code" href="../../d4/d4/struct__LPCP__CONNECTION__MESSAGE.html#o3">ServerView</a>, <span class="keyword">sizeof</span>( ConnectMsg-&gt;<a class="code" href="../../d4/d4/struct__LPCP__CONNECTION__MESSAGE.html#o3">ServerView</a> ));
00722 
00723     } <span class="keywordflow">else</span> {
00724 
00725         Msg-&gt;Request.ClientViewSize = 0;
00726         RtlZeroMemory( ConnectMsg, <span class="keyword">sizeof</span>( *ConnectMsg ));
00727     }
00728 
00729     ConnectMsg-&gt;<a class="code" href="../../d4/d4/struct__LPCP__CONNECTION__MESSAGE.html#o1">ClientPort</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;              <span class="comment">// Set below</span>
00730     ConnectMsg-&gt;<a class="code" href="../../d4/d4/struct__LPCP__CONNECTION__MESSAGE.html#o2">SectionToMap</a> = SectionToMap;
00731 
00732     <span class="comment">//</span>
00733     <span class="comment">//  The data length is everything after the port message within the lpcp</span>
00734     <span class="comment">//  message.  In other words the connection message and the user supplied</span>
00735     <span class="comment">//  information</span>
00736     <span class="comment">//</span>
00737 
00738     Msg-&gt;Request.u1.s1.DataLength = (CSHORT)(<span class="keyword">sizeof</span>( *ConnectMsg ) +
00739                                              ConnectionInfoLength);
00740 
00741     <span class="comment">//</span>
00742     <span class="comment">//  The total length add on the LPCP message</span>
00743     <span class="comment">//</span>
00744     <span class="comment">//  **** should this just add on the size of a port message instead?</span>
00745     <span class="comment">//</span>
00746 
00747     Msg-&gt;Request.u1.s1.TotalLength = (CSHORT)(<span class="keyword">sizeof</span>( *Msg ) +
00748                                               Msg-&gt;Request.u1.s1.DataLength);
00749 
00750     <span class="comment">//</span>
00751     <span class="comment">//  This will be a connection request message</span>
00752     <span class="comment">//</span>
00753 
00754     Msg-&gt;Request.u2.s2.Type = LPC_CONNECTION_REQUEST;
00755 
00756     <span class="comment">//</span>
00757     <span class="comment">//  If the caller supplied some connection information then copy</span>
00758     <span class="comment">//  that into place right now</span>
00759     <span class="comment">//</span>
00760 
00761     <span class="keywordflow">if</span> (ARGUMENT_PRESENT( ConnectionInformation )) {
00762 
00763         <span class="keywordflow">try</span> {
00764 
00765             RtlMoveMemory( ConnectMsg + 1,
00766                            ConnectionInformation,
00767                            ConnectionInfoLength );
00768 
00769         } except( EXCEPTION_EXECUTE_HANDLER ) {
00770 
00771             <span class="comment">//</span>
00772             <span class="comment">//  If we fail then cleanup after ourselves and return the</span>
00773             <span class="comment">//  error to our caller</span>
00774             <span class="comment">//</span>
00775 
00776             <a class="code" href="../../d3/d7/lpcqueue_8c.html#a5">LpcpFreeToPortZone</a>( Msg, FALSE );
00777 
00778             <span class="keywordflow">if</span> (SectionToMap != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00779 
00780                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( SectionToMap );
00781             }
00782 
00783             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( ClientPort );
00784 
00785             <span class="keywordflow">return</span> GetExceptionCode();
00786         }
00787     }
00788 
00789     <span class="comment">//</span>
00790     <span class="comment">//  The message is mostly ready to go now put it on the servers queue.</span>
00791     <span class="comment">//</span>
00792     <span class="comment">//  Acquire the mutex that guards the LpcReplyMessage field of the</span>
00793     <span class="comment">//  thread.  Also acquire the semaphore that guards the connection</span>
00794     <span class="comment">//  request message queue.  Stamp the connection request message with</span>
00795     <span class="comment">//  a serial number, insert the message at the tail of the connection</span>
00796     <span class="comment">//  request message queue and remember the address of the message in</span>
00797     <span class="comment">//  the LpcReplyMessage field for the current thread.</span>
00798     <span class="comment">//</span>
00799 
00800     <a class="code" href="../../d0/d7/lpcp_8h.html#a3">LpcpAcquireLpcpLock</a>();
00801 
00802     <span class="comment">//</span>
00803     <span class="comment">//  See if the port name has been deleted from under us.  If so, then</span>
00804     <span class="comment">//  don't queue the message and don't wait for a reply</span>
00805     <span class="comment">//</span>
00806 
00807     <span class="keywordflow">if</span> (ConnectionPort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o1">Flags</a> &amp; <a class="code" href="../../d2/d6/lpc_8h.html#a9">PORT_NAME_DELETED</a>) {
00808 
00809         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_OBJECT_NAME_NOT_FOUND;
00810 
00811     } <span class="keywordflow">else</span> {
00812 
00813         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00814 
00815         <a class="code" href="../../d0/d7/lpcp_8h.html#a13">LpcpTrace</a>(( <span class="stringliteral">"Send Connect Msg %lx to Port %wZ (%lx)\n"</span>, Msg, PortName, ConnectionPort ));
00816 
00817         <span class="comment">//</span>
00818         <span class="comment">//  Stamp the request message with a serial number, insert the message</span>
00819         <span class="comment">//  at the tail of the request message queue</span>
00820         <span class="comment">//</span>
00821 
00822         Msg-&gt;RepliedToThread = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00823         Msg-&gt;Request.MessageId = <a class="code" href="../../d0/d7/lpcp_8h.html#a0">LpcpGenerateMessageId</a>();
00824 
00825         CurrentThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o15">LpcReplyMessageId</a> = Msg-&gt;Request.MessageId;
00826 
00827         InsertTailList( &amp;ConnectionPort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o4">MsgQueue</a>.<a class="code" href="../../d0/d5/struct__LPCP__PORT__QUEUE.html#o2">ReceiveHead</a>, &amp;Msg-&gt;Entry );
00828         InsertTailList( &amp;ConnectionPort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o14">LpcReplyChainHead</a>, &amp;CurrentThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o5">LpcReplyChain</a> );
00829 
00830         CurrentThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o14">LpcReplyMessage</a> = Msg;
00831 
00832         <span class="comment">//</span>
00833         <span class="comment">//  Reference the port we are passing in the connect msg so if we die</span>
00834         <span class="comment">//  it will still be valid for the server in NtAcceptConnectPort.  The</span>
00835         <span class="comment">//  reference will be release when the message is freed.</span>
00836         <span class="comment">//</span>
00837 
00838         <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>( ClientPort );
00839 
00840         ConnectMsg-&gt;<a class="code" href="../../d4/d4/struct__LPCP__CONNECTION__MESSAGE.html#o1">ClientPort</a> = ClientPort;
00841     }
00842 
00843     <a class="code" href="../../d0/d7/lpcp_8h.html#a4">LpcpReleaseLpcpLock</a>();
00844 
00845     <span class="comment">//</span>
00846     <span class="comment">//  At this point the client's communcation port is all set up and the</span>
00847     <span class="comment">//  connection request message is in the server's queue.  So now we have</span>
00848     <span class="comment">//  to single the server and wait for a reply</span>
00849     <span class="comment">//</span>
00850 
00851     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00852 
00853         <span class="comment">//</span>
00854         <span class="comment">//  If this is a waitable port then set the event that they might be</span>
00855         <span class="comment">//  waiting on</span>
00856         <span class="comment">//</span>
00857 
00858         <span class="keywordflow">if</span> ( ConnectionPort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o1">Flags</a> &amp; <a class="code" href="../../d2/d6/lpc_8h.html#a8">PORT_WAITABLE</a> ) {
00859 
00860             <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>( &amp;ConnectionPort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o18">WaitEvent</a>, 1, FALSE );
00861         }
00862 
00863         <span class="comment">//</span>
00864         <span class="comment">//  Increment the connection request message queue semaphore by one for</span>
00865         <span class="comment">//  the newly inserted connection request message.  Release the spin</span>
00866         <span class="comment">//  locks, while remaining at the dispatcher IRQL.  Then wait for the</span>
00867         <span class="comment">//  reply to this connection request by waiting on the LpcReplySemaphore</span>
00868         <span class="comment">//  for the current thread.</span>
00869         <span class="comment">//</span>
00870 
00871         <a class="code" href="../../d1/d6/semphobj_8c.html#a3">KeReleaseSemaphore</a>( ConnectionPort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o4">MsgQueue</a>.<a class="code" href="../../d0/d5/struct__LPCP__PORT__QUEUE.html#o1">Semaphore</a>,
00872                             1,
00873                             1,
00874                             FALSE );
00875 
00876         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;CurrentThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o13">LpcReplySemaphore</a>,
00877                                         Executive,
00878                                         PreviousMode,
00879                                         FALSE,
00880                                         NULL );
00881     }
00882 
00883     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_USER_APC) {
00884 
00885         <span class="comment">//</span>
00886         <span class="comment">//  if the semaphore is signaled, then clear it</span>
00887         <span class="comment">//</span>
00888 
00889         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d6/semphobj_8c.html#a2">KeReadStateSemaphore</a>( &amp;CurrentThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o13">LpcReplySemaphore</a> )) {
00890 
00891             <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;CurrentThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o13">LpcReplySemaphore</a>,
00892                                    WrExecutive,
00893                                    KernelMode,
00894                                    FALSE,
00895                                    NULL );
00896 
00897             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00898         }
00899     }
00900 
00901     <span class="comment">//</span>
00902     <span class="comment">//  A connection request is accepted if the ConnectedPort of the client's</span>
00903     <span class="comment">//  communication port has been filled in.</span>
00904     <span class="comment">//</span>
00905 
00906     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS) {
00907 
00908         SectionToMap = <a class="code" href="../../d5/d6/lpcconn_8c.html#a0">LpcpFreeConMsg</a>( &amp;Msg, &amp;ConnectMsg, CurrentThread );
00909 
00910         <span class="comment">//</span>
00911         <span class="comment">//  Check that we got a reply message</span>
00912         <span class="comment">//</span>
00913 
00914         <span class="keywordflow">if</span> (Msg != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00915 
00916             <span class="comment">//</span>
00917             <span class="comment">//  Copy any connection information back to the caller, but first</span>
00918             <span class="comment">//  calculate the new connection data length for the reply and</span>
00919             <span class="comment">//  don't let it grow beyond what we probed originally</span>
00920             <span class="comment">//</span>
00921 
00922             <span class="keywordflow">if</span> ((Msg-&gt;Request.u1.s1.DataLength - <span class="keyword">sizeof</span>( *ConnectMsg )) &lt; ConnectionInfoLength) {
00923 
00924                 ConnectionInfoLength = Msg-&gt;Request.u1.s1.DataLength - <span class="keyword">sizeof</span>( *ConnectMsg );
00925             }
00926 
00927             <span class="keywordflow">if</span> (ARGUMENT_PRESENT( ConnectionInformation )) {
00928 
00929                 <span class="keywordflow">try</span> {
00930 
00931                     <span class="keywordflow">if</span> (ARGUMENT_PRESENT( ConnectionInformationLength )) {
00932 
00933                         *ConnectionInformationLength = ConnectionInfoLength;
00934                     }
00935 
00936                     RtlMoveMemory( ConnectionInformation,
00937                                    ConnectMsg + 1,
00938                                    ConnectionInfoLength );
00939 
00940                 } except( EXCEPTION_EXECUTE_HANDLER ) {
00941 
00942                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00943                 }
00944             }
00945 
00946             <span class="comment">//</span>
00947             <span class="comment">//  Insert client communication port object in specified object</span>
00948             <span class="comment">//  table.  Set port handle value if successful.  If not</span>
00949             <span class="comment">//  successful, then the port will have been dereferenced, which</span>
00950             <span class="comment">//  will cause it to be freed, after our delete procedure is</span>
00951             <span class="comment">//  called.  The delete procedure will undo the work done to</span>
00952             <span class="comment">//  initialize the port.</span>
00953             <span class="comment">//</span>
00954 
00955             <span class="keywordflow">if</span> (ClientPort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o3">ConnectedPort</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00956 
00957                 ULONG CapturedMaxMessageLength;
00958 
00959                 <span class="comment">//</span>
00960                 <span class="comment">//  Before we do the object insert we need to get the max</span>
00961                 <span class="comment">//  message length because right after the call the object</span>
00962                 <span class="comment">//  could be dereferenced and gone away</span>
00963                 <span class="comment">//</span>
00964 
00965                 CapturedMaxMessageLength = ConnectionPort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o9">MaxMessageLength</a>;
00966 
00967                 <span class="comment">//</span>
00968                 <span class="comment">//  Now create a handle for the new client port object.</span>
00969                 <span class="comment">//</span>
00970 
00971                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d1/obinsert_8c.html#a0">ObInsertObject</a>( ClientPort,
00972                                          NULL,
00973                                          PORT_ALL_ACCESS,
00974                                          0,
00975                                          (PVOID *)NULL,
00976                                          &amp;Handle );
00977 
00978                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00979 
00980                     <span class="comment">//</span>
00981                     <span class="comment">//  This is the only successful path through this routine.</span>
00982                     <span class="comment">//  Set the output variables, later we'll free the msg</span>
00983                     <span class="comment">//  back to the port zone and return to our caller</span>
00984                     <span class="comment">//</span>
00985 
00986                     <span class="keywordflow">try</span> {
00987 
00988                         *<a class="code" href="../../d7/d7/uclient_8c.html#a3">PortHandle</a> = <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>;
00989 
00990                         <span class="keywordflow">if</span> (ARGUMENT_PRESENT( MaxMessageLength )) {
00991 
00992                             *MaxMessageLength = CapturedMaxMessageLength;
00993                         }
00994 
00995                         <span class="keywordflow">if</span> (ARGUMENT_PRESENT( ClientView )) {
00996 
00997                             RtlMoveMemory( ClientView,
00998                                            &amp;ConnectMsg-&gt;<a class="code" href="../../d4/d4/struct__LPCP__CONNECTION__MESSAGE.html#o0">ClientView</a>,
00999                                            <span class="keyword">sizeof</span>( *ClientView ));
01000                         }
01001 
01002                         <span class="keywordflow">if</span> (ARGUMENT_PRESENT( ServerView )) {
01003 
01004                             RtlMoveMemory( ServerView,
01005                                            &amp;ConnectMsg-&gt;<a class="code" href="../../d4/d4/struct__LPCP__CONNECTION__MESSAGE.html#o3">ServerView</a>,
01006                                            <span class="keyword">sizeof</span>( *ServerView ));
01007                         }
01008 
01009                     } except( EXCEPTION_EXECUTE_HANDLER ) {
01010 
01011                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
01012                         <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( Handle );
01013                     }
01014                 }
01015 
01016             } <span class="keywordflow">else</span> {
01017 
01018                 <span class="comment">//</span>
01019                 <span class="comment">//  Otherwise we did not get a connect port from the server so</span>
01020                 <span class="comment">//  the connection was refused</span>
01021                 <span class="comment">//</span>
01022 
01023                 <a class="code" href="../../d0/d7/lpcp_8h.html#a13">LpcpTrace</a>(( <span class="stringliteral">"Connection request refused.\n"</span> ));
01024 
01025                 <span class="keywordflow">if</span> ( SectionToMap != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
01026 
01027                     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( SectionToMap );
01028                 }
01029 
01030                 <span class="keywordflow">if</span> (ConnectionPort-&gt;<a class="code" href="../../d9/d4/struct__LPCP__PORT__OBJECT.html#o1">Flags</a> &amp; <a class="code" href="../../d2/d6/lpc_8h.html#a9">PORT_NAME_DELETED</a>) {
01031 
01032                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_OBJECT_NAME_NOT_FOUND;
01033 
01034                 } <span class="keywordflow">else</span> {
01035 
01036                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_PORT_CONNECTION_REFUSED;
01037                 }
01038 
01039                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( ClientPort );
01040             }
01041 
01042             <span class="comment">//</span>
01043             <span class="comment">//  Free the reply message back to the port zone</span>
01044             <span class="comment">//</span>
01045 
01046             <a class="code" href="../../d3/d7/lpcqueue_8c.html#a5">LpcpFreeToPortZone</a>( Msg, FALSE );
01047 
01048         } <span class="keywordflow">else</span> {
01049 
01050             <span class="comment">//</span>
01051             <span class="comment">//  We did not get a reply message so the connection must have</span>
01052             <span class="comment">//  been refused</span>
01053             <span class="comment">//</span>
01054 
01055             <span class="keywordflow">if</span> (SectionToMap != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01056 
01057                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( SectionToMap );
01058             }
01059 
01060             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( ClientPort );
01061 
01062             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_PORT_CONNECTION_REFUSED;
01063         }
01064 
01065     } <span class="keywordflow">else</span> {
01066 
01067         <span class="comment">//</span>
01068         <span class="comment">//  Our wait was not successful</span>
01069         <span class="comment">//</span>
01070 
01071         <span class="comment">//</span>
01072         <span class="comment">//  Remove the connection request message from the received</span>
01073         <span class="comment">//  queue and free the message back to the connection</span>
01074         <span class="comment">//  port's zone.</span>
01075         <span class="comment">//</span>
01076 
01077         SectionToMap = <a class="code" href="../../d5/d6/lpcconn_8c.html#a0">LpcpFreeConMsg</a>( &amp;Msg, &amp;ConnectMsg, CurrentThread );
01078         
01079         <span class="comment">//</span>
01080         <span class="comment">//  The wait was not successful, but in the meantime the server could</span>
01081         <span class="comment">//  replied, so it signaled the lpc semaphore. We have to clear the</span>
01082         <span class="comment">//  semaphore state right now.</span>
01083         <span class="comment">//</span>
01084 
01085         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d6/semphobj_8c.html#a2">KeReadStateSemaphore</a>( &amp;CurrentThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o13">LpcReplySemaphore</a> )) {
01086 
01087             <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;CurrentThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o13">LpcReplySemaphore</a>,
01088                                    WrExecutive,
01089                                    KernelMode,
01090                                    FALSE,
01091                                    NULL );
01092         }
01093 
01094         <span class="keywordflow">if</span> (Msg != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01095 
01096             <a class="code" href="../../d3/d7/lpcqueue_8c.html#a5">LpcpFreeToPortZone</a>( Msg, FALSE );
01097         }
01098 
01099         <span class="comment">//</span>
01100         <span class="comment">//  If a client section was specified, then dereference the section</span>
01101         <span class="comment">//  object.</span>
01102         <span class="comment">//</span>
01103 
01104         <span class="keywordflow">if</span> ( SectionToMap != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
01105 
01106             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( SectionToMap );
01107         }
01108 
01109         <span class="comment">//</span>
01110         <span class="comment">//  If the connection was rejected or the wait failed, then</span>
01111         <span class="comment">//  dereference the client port object, which will cause it to</span>
01112         <span class="comment">//  be deleted.</span>
01113         <span class="comment">//</span>
01114 
01115         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( ClientPort );
01116     }
01117 
01118     <span class="comment">//</span>
01119     <span class="comment">//  And return to our caller</span>
01120     <span class="comment">//</span>
01121 
01122     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01123 }

</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:44:33 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
