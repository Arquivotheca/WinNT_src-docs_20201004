<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: frgmnt16.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>frgmnt16.c</h1><a href="../../d4/d7/lh__core_2frgmnt16_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*</span>
00002 <span class="comment">        File:           LHFragment16.c</span>
00003 <span class="comment"></span>
00004 <span class="comment">        Contains:       ALUT stuff (16 bit) for Color Sync</span>
00005 <span class="comment"></span>
00006 <span class="comment">        Version:        </span>
00007 <span class="comment"></span>
00008 <span class="comment">        Written by:     H.Siegeritz</span>
00009 <span class="comment"></span>
00010 <span class="comment">        Copyright:      © 1993-1997 by Heidelberger Druckmaschinen AG, all rights reserved.</span>
00011 <span class="comment"></span>
00012 <span class="comment">*/</span>
00013 
00014 <span class="preprocessor">#ifndef LHGeneralIncs_h</span>
00015 <span class="preprocessor"></span><span class="preprocessor">#include "General.h"</span>
00016 <span class="preprocessor">#endif</span>
00017 <span class="preprocessor"></span>
00018 <span class="preprocessor">#if GENERATING68K</span>
00019 <span class="preprocessor"></span><span class="comment">/*      #include &lt;ConditionalMacros.h&gt; */</span>
00020 
00021 <span class="preprocessor">        #define CM_Doub extended</span>
00022 <span class="preprocessor"></span>        <span class="keyword">extern</span> <a class="code" href="../../d9/d6/lh__core_2fragment_8c.html#a0">CM_Doub</a> pow(CM_Doub _x,CM_Doub _y);
00023 <span class="preprocessor">#else</span>
<a name="l00024"></a><a class="code" href="../../d4/d7/lh__core_2frgmnt16_8c.html#a0">00024</a> <span class="preprocessor"></span><span class="preprocessor">        #define CM_Doub double</span>
00025 <span class="preprocessor"></span><span class="preprocessor">        #include &lt;math.h&gt;</span>
00026 <span class="preprocessor">#endif</span>
00027 <span class="preprocessor"></span>
00028 <span class="preprocessor">#ifndef LHFragment_h</span>
00029 <span class="preprocessor"></span><span class="preprocessor">#include "Fragment.h"</span>
00030 <span class="preprocessor">#endif</span>
00031 <span class="preprocessor"></span>
00032 <span class="preprocessor">#ifndef LHStdConversionLuts_h</span>
00033 <span class="preprocessor"></span><span class="preprocessor">#include "StdConv.h"</span>
00034 <span class="preprocessor">#endif</span>
00035 <span class="preprocessor"></span>
00036 <span class="preprocessor">#if ! realThing</span>
00037 <span class="preprocessor"></span><span class="preprocessor">#ifdef DEBUG_OUTPUT</span>
00038 <span class="preprocessor"></span><span class="preprocessor">#define kThisFile kLHFragment16ID</span>
00039 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00040 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00041 <span class="preprocessor"></span>
00042 
00043 <span class="comment">/*-----prototypes for local functions-----*/</span>
00044 <span class="keywordtype">void</span>    
00045 <a class="code" href="../../d5/d7/w98_2lh__core_2frgmnt16_8c.html#a1">Fill_inverseGamma_ushort_ALUT</a>   ( <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *usALUT, <span class="keywordtype">char</span> addrBits,
00046                                                                   <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> gamma_u8_8);
00047 
00048 <span class="comment">/* ______________________________________________________________________</span>
00049 <span class="comment"></span>
00050 <span class="comment">        CMError</span>
00051 <span class="comment">                Fill_inverse_ushort_ALUT_from_CurveTag( icCurveType             *pCurveTag,</span>
00052 <span class="comment">                                                                                                unsigned short  *usALUT,</span>
00053 <span class="comment">                                                                                                char                    addrBits )</span>
00054 <span class="comment">        Abstract:</span>
00055 <span class="comment">                extracts output luts out of cmSigCurveType tag and converts them</span>
00056 <span class="comment">                to desired format: (2 ^ addrBits) values in a range from 0 to 65535</span>
00057 <span class="comment">                NOTE: not-monotone CurveTags are manipulated</span>
00058 <span class="comment">                NOTE: Memory for the LUT has to be allocated before !</span>
00059 <span class="comment"></span>
00060 <span class="comment">        Params:</span>
00061 <span class="comment">                pCurveTag               (in)            extract input LUT from this</span>
00062 <span class="comment">                usALUT                  (in/out)        result LUT</span>
00063 <span class="comment">                addrBits                (in)            2 ^ addrBits values are requested</span>
00064 <span class="comment">                </span>
00065 <span class="comment">        Return:</span>
00066 <span class="comment">                noErr           successful</span>
00067 <span class="comment"></span>
00068 <span class="comment">   _____________________________________________________________________ */</span>
00069 <a class="code" href="../../d2/d6/lh__open_2pi__app_8h.html#a11">CMError</a>
<a name="l00070"></a><a class="code" href="../../d2/d7/w98_2lh__core_2fragment_8h.html#a6">00070</a> <a class="code" href="../../d5/d7/w98_2lh__core_2frgmnt16_8c.html#a2">Fill_inverse_ushort_ALUT_from_CurveTag</a>( <a class="code" href="../../d5/d1/structicCurveType.html">icCurveType</a>             *pCurveTag,
00071                                                                                 <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>  *usALUT,
00072                                                                                 <span class="keywordtype">char</span>                    addrBits )
00073 {
00074         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>   i, inCount, outCount, clipIndex, ulFactor;
00075         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>   intpFirst, intpLast, halfStep, ulAux, target;
00076         <span class="keywordtype">short</span>                   monot;
00077         <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>  *inCurve, *usPtr, *stopPtr;
00078         <span class="keywordtype">double</span>                  flFactor;
00079 <span class="preprocessor">#ifdef DEBUG_OUTPUT</span>
00080 <span class="preprocessor"></span>        <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a35">OSErr</a> err=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a58a55">noErr</a>;
00081 <span class="preprocessor">#endif</span>
00082 <span class="preprocessor"></span>        <a class="code" href="../../d6/d9/lh__open_2general_8h.html#a1">LH_START_PROC</a>(<span class="stringliteral">"Fill_inverse_ushort_ALUT_from_CurveTag"</span>)
00083         
00084     <span class="keywordflow">if</span>( pCurveTag-&gt;<a class="code" href="../../d5/d1/structicCurveType.html#o0">base</a>.<a class="code" href="../../d6/d4/structicTagBase.html#o0">sig</a> != <a class="code" href="../../d7/d4/aug98_2dll32_2icc_8h.html#a87">icSigCurveType</a>   <span class="comment">/* 'curv' */</span>
00085          || addrBits &gt; 15 )
00086          {
00087 <span class="preprocessor">#ifdef DEBUG_OUTPUT</span>
00088 <span class="preprocessor"></span>                <span class="keywordflow">if</span> ( DebugCheck(kThisFile, kDebugErrorInfo) )
00089                         <a class="code" href="../../d7/d2/drivesup_8c.html#a0">DebugPrint</a>(<span class="stringliteral">"¥ Fill_inverse_ushort_ALUT_from_CurveTag ERROR:   addrBits= %d\n"</span>,addrBits);
00090 <span class="preprocessor">#endif</span>
00091 <span class="preprocessor"></span>                <span class="keywordflow">return</span>(<a class="code" href="../../d2/d6/lh__open_2pi__app_8h.html#a149a30">cmparamErr</a>);
00092          }
00093         
00094         outCount  = 1 &lt;&lt; addrBits;
00095         clipIndex = outCount - 1;
00096 
00097                 <span class="comment">/*---special cases:---*/</span>
00098 
00099         <span class="keywordflow">if</span>(pCurveTag-&gt;<a class="code" href="../../d5/d1/structicCurveType.html#o1">curve</a>.<a class="code" href="../../d4/d1/structicCurve.html#o0">count</a> == 0)         <span class="comment">/*---identity---*/</span>
00100         {
00101                 ulFactor = ((<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)65535 &lt;&lt; 16) / clipIndex;            <span class="comment">/* use all 32 bits */</span>
00102                 
00103                 <span class="keywordflow">for</span>(i=0; i&lt;clipIndex; i++)
00104                         usALUT[i] = (<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>)((i * ulFactor + 32767) &gt;&gt; 16);
00105         
00106                 <span class="keywordflow">for</span>(i=clipIndex; i&lt;outCount; i++)
00107                         usALUT[i] = 0xFFFF;
00108         
00109                 <span class="keywordflow">return</span>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a58a55">noErr</a>);
00110         }
00111         <span class="keywordflow">else</span> <span class="keywordflow">if</span>(pCurveTag-&gt;<a class="code" href="../../d5/d1/structicCurveType.html#o1">curve</a>.<a class="code" href="../../d4/d1/structicCurve.html#o0">count</a> == 1)    <span class="comment">/*---gamma curve---*/</span>
00112         {
00113                 <a class="code" href="../../d5/d7/w98_2lh__core_2frgmnt16_8c.html#a1">Fill_inverseGamma_ushort_ALUT</a>(usALUT, addrBits, pCurveTag-&gt;<a class="code" href="../../d5/d1/structicCurveType.html#o1">curve</a>.<a class="code" href="../../d4/d1/structicCurve.html#o1">data</a>[0]);
00114                 <span class="keywordflow">return</span>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a58a55">noErr</a>);
00115         }
00116         
00117                 <span class="comment">/*---ordinary case:---*/</span>
00118         
00119         inCount = pCurveTag-&gt;<a class="code" href="../../d5/d1/structicCurveType.html#o1">curve</a>.<a class="code" href="../../d4/d1/structicCurve.html#o0">count</a>;
00120         inCurve = pCurveTag-&gt;<a class="code" href="../../d5/d1/structicCurveType.html#o1">curve</a>.<a class="code" href="../../d4/d1/structicCurve.html#o1">data</a>;
00121                 
00122                  <span class="comment">/* exact matching factor needed for special values: */</span>
00123         flFactor = (<span class="keywordtype">double</span>)clipIndex / 65535.;
00124         
00125         halfStep = clipIndex &gt;&gt; 1;              <span class="comment">/* lessen computation incorrectness */</span>
00126         
00127                                 <span class="comment">/* ascending or descending ? */</span>
00128         <span class="keywordflow">for</span>(monot=0, i=1; i&lt;inCount; i++)
00129         {
00130                 <span class="keywordflow">if</span>(inCurve[i-1] &lt; inCurve[i])
00131                         monot++;
00132                 <span class="keywordflow">else</span> <span class="keywordflow">if</span>(inCurve[i-1] &gt; inCurve[i])
00133                         monot--;
00134         }
00135         
00136         <span class="keywordflow">if</span>(monot &gt;= 0)  <span class="comment">/* curve seems to be ascending */</span>
00137         {
00138                 <span class="keywordflow">for</span>(i=1; i&lt;inCount; i++)
00139                         <span class="keywordflow">if</span>(inCurve[i-1] &gt; inCurve[i])
00140                                 inCurve[i] = inCurve[i-1];      <span class="comment">/* correct not-invertible parts */</span>
00141                 
00142                 intpFirst = (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)(inCurve[0] * flFactor + 0.9999);
00143                 intpLast  = (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)(inCurve[inCount-1] * flFactor);
00144                 
00145                 <span class="keywordflow">for</span>(i=0; i&lt;intpFirst; i++)                      <span class="comment">/* fill lacking area low */</span>
00146                         usALUT[i] = 0;
00147                 <span class="keywordflow">for</span>(i=intpLast+1; i&lt;outCount; i++)      <span class="comment">/* fill lacking area high */</span>
00148                         usALUT[i] = 0xFFFF;
00149 
00150                         <span class="comment">/* interpolate remaining values: */</span>
00151                 usPtr   = inCurve;
00152                 stopPtr = inCurve + inCount - 2; <span class="comment">/* stops incrementation */</span>
00153                 
00154                 <span class="keywordflow">for</span>(i=intpFirst; i&lt;=intpLast; i++)
00155                 {
00156                         target = (0x0FFFF * i + halfStep)  / clipIndex;
00157                         <span class="keywordflow">while</span>(*(usPtr+1) &lt; target &amp;&amp; usPtr &lt; stopPtr)
00158                                 usPtr++;                                        <span class="comment">/* find interval */</span>
00159                         
00160                         ulAux = ((<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)(usPtr - inCurve) &lt;&lt; 16) / (inCount - 1);
00161                         <span class="keywordflow">if</span>(*(usPtr+1) != *usPtr)
00162                         {
00163                                 ulAux += ((target - (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)*usPtr) &lt;&lt; 16)
00164                                           / ( (*(usPtr+1) - *usPtr) * (inCount - 1) );
00165                                 
00166                                 <span class="keywordflow">if</span>(ulAux &amp; 0x10000)   <span class="comment">/* *(usPtr+1) was required */</span>
00167                                         ulAux = 0xFFFF;
00168                         }
00169                         
00170                         usALUT[i] = (<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>)ulAux;
00171                 }
00172         }
00173         <span class="keywordflow">else</span>                    <span class="comment">/* curve seems to be descending */</span>
00174         {
00175                 <span class="keywordflow">for</span>(i=1; i&lt;inCount; i++)
00176                         <span class="keywordflow">if</span>(inCurve[i-1] &lt; inCurve[i])
00177                                 inCurve[i] = inCurve[i-1];      <span class="comment">/* correct not-invertible parts */</span>
00178                 
00179                 intpFirst = (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)(inCurve[inCount-1] * flFactor + 0.9999);
00180                 intpLast  = (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)(inCurve[0] * flFactor);
00181                 
00182                 <span class="keywordflow">for</span>(i=0; i&lt;intpFirst; i++)                      <span class="comment">/* fill lacking area low */</span>
00183                         usALUT[i] = 0xFFFF;
00184                 <span class="keywordflow">for</span>(i=intpLast+1; i&lt;outCount; i++)      <span class="comment">/* fill lacking area high */</span>
00185                         usALUT[i] = 0;
00186 
00187                         <span class="comment">/* interpolate remaining values: */</span>
00188                 usPtr   = inCurve + inCount - 1;
00189                 stopPtr = inCurve + 1;          <span class="comment">/* stops decrementation */</span>
00190                 
00191                 <span class="keywordflow">for</span>(i=intpFirst; i&lt;=intpLast; i++)
00192                 {
00193                         target = (0x0FFFF * i + halfStep)  / clipIndex;
00194                         <span class="keywordflow">while</span>(*(usPtr-1) &lt; target &amp;&amp; usPtr &gt; stopPtr)
00195                                 usPtr--;                                        <span class="comment">/* find interval */</span>
00196                         
00197                         ulAux = ((<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)(usPtr-1 - inCurve) &lt;&lt; 16) / (inCount - 1);
00198                         <span class="keywordflow">if</span>(*(usPtr-1) != *usPtr)
00199                         {
00200                                 ulAux += (((<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)*(usPtr-1) - target) &lt;&lt; 16)
00201                                           / ( (*(usPtr-1) - *usPtr) * (inCount - 1) );
00202                                 
00203                                 <span class="keywordflow">if</span>(ulAux &amp; 0x10000)
00204                                         ulAux = 0xFFFF;
00205                         }
00206                         
00207                         usALUT[i] = (<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>)ulAux;
00208                 }
00209         }
00210         
00211 
00212         <a class="code" href="../../d6/d9/lh__open_2general_8h.html#a2">LH_END_PROC</a>(<span class="stringliteral">"Fill_inverse_ushort_ALUT_from_CurveTag"</span>)
00213         <span class="keywordflow">return</span>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a58a55">noErr</a>);
00214 }
00215 
00216 <span class="comment">/*   _____________________________________________________________________ */</span>
00217 
00218 <span class="keywordtype">void</span>
<a name="l00219"></a><a class="code" href="../../d4/d7/lh__core_2frgmnt16_8c.html#a1">00219</a> <a class="code" href="../../d5/d7/w98_2lh__core_2frgmnt16_8c.html#a1">Fill_inverseGamma_ushort_ALUT</a>(  <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>  *usALUT,
00220                                                                 <span class="keywordtype">char</span>                    addrBits,
00221                                                                 <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>  gamma_u8_8 )
00222 {
00223         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>   i, j, outCount, step, stopit;
00224         <span class="keywordtype">long</span>                    leftVal, Diff, lAux;
00225         <a class="code" href="../../d9/d6/lh__core_2fragment_8c.html#a0">CM_Doub</a>                 invGamma, x, xFactor;
00226         <span class="keywordtype">long</span>                    clipIndex;
00227 <span class="preprocessor">#ifdef DEBUG_OUTPUT</span>
00228 <span class="preprocessor"></span>        <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a35">OSErr</a> err = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a58a55">noErr</a>;
00229 <span class="preprocessor">#endif</span>
00230 <span class="preprocessor"></span>        <a class="code" href="../../d6/d9/lh__open_2general_8h.html#a1">LH_START_PROC</a>(<span class="stringliteral">"Fill_inverseGamma_ushort_ALUT"</span>)
00231 
00232         outCount = 0x1 &lt;&lt; addrBits;
00233         
00234         invGamma  = 256. / (<a class="code" href="../../d9/d6/lh__core_2fragment_8c.html#a0">CM_Doub</a>)gamma_u8_8;
00235         clipIndex = outCount - 1;
00236         xFactor   = 1. / (<a class="code" href="../../d9/d6/lh__core_2fragment_8c.html#a0">CM_Doub</a>)clipIndex;
00237         
00238         <span class="keywordflow">if</span>(addrBits &lt;= 6)               <span class="comment">/* up to 64 - 2 float.computations */</span>
00239                 step = 1;
00240         <span class="keywordflow">else</span>
00241                 step = 0x1 &lt;&lt; (addrBits - 6);           <span class="comment">/* more would take too long */</span>
00242         
00243         usALUT[0]          = 0;                 <span class="comment">/* these two... */</span>
00244         usALUT[outCount-1] = 0xFFFF;    <span class="comment">/* ...are fixed */</span>
00245         
00246         <span class="keywordflow">for</span>(i=step; i&lt;outCount-1; i+=step)
00247         {
00248                 x = (<a class="code" href="../../d9/d6/lh__core_2fragment_8c.html#a0">CM_Doub</a>)i * xFactor;
00249                 <span class="keywordflow">if</span>(x &gt; 1.)
00250                         x = 1.;         <span class="comment">/* clipping in the end of ALUT */</span>
00251                 
00252                 usALUT[i] = (<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>)( pow(x,invGamma) * 65535.0 + 0.5);
00253         }
00254         
00255                 <span class="comment">/*---fill intervals - except for last, which is odd:---*/</span>
00256         <span class="keywordflow">for</span>(i=0; i&lt;outCount-step; i+=step)
00257         {
00258                 leftVal = (<span class="keywordtype">long</span>)usALUT[i];
00259                 Diff    = (<span class="keywordtype">long</span>)usALUT[i + step] - leftVal;
00260                         
00261                 <span class="keywordflow">for</span>(j=1; j&lt;step; j++)
00262                 {
00263                         lAux = ( (Diff * j &lt;&lt; 8) / step + 128 ) &gt;&gt; 8;
00264 
00265                         usALUT[i + j] = (<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>)(leftVal + lAux);
00266                 }
00267         }
00268         
00269                 <span class="comment">/*---fill last interval:---*/</span>
00270         i       = outCount - step;
00271         leftVal = (<span class="keywordtype">long</span>)usALUT[i];
00272         Diff    = 0x0FFFF - leftVal;    <span class="comment">/* 0xFFFF for 1.0 */</span>
00273                 
00274         <span class="keywordflow">for</span>(j=1; j&lt;step-1; j++)         <span class="comment">/* stops here if step &lt;= 2 */</span>
00275         {
00276                 lAux = ( (Diff * j &lt;&lt; 8) / (step - 1) + 128 ) &gt;&gt; 8;
00277 
00278                 usALUT[i + j] = (<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>)(leftVal + lAux);
00279         }
00280         
00281                 <span class="comment">/*--overwrite sensitive values depending on Gamma:--*/</span>
00282         <span class="keywordflow">if</span>(addrBits &gt; 6 &amp;&amp; invGamma &lt; 1.0)              <span class="comment">/* ...if lower part is difficult */</span>
00283         {
00284                 stopit = 0x1 &lt;&lt; (addrBits - 6);
00285                 
00286                 <span class="keywordflow">for</span>(i=1; i&lt;stopit; i++)
00287                 {
00288                         x         = (<a class="code" href="../../d9/d6/lh__core_2fragment_8c.html#a0">CM_Doub</a>)i * xFactor;
00289                         usALUT[i] = (<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>)( pow(x,invGamma) * 65535.0);
00290                 }
00291         }
00292 
00293         <a class="code" href="../../d6/d9/lh__open_2general_8h.html#a2">LH_END_PROC</a>(<span class="stringliteral">"Fill_inverseGamma_ushort_ALUT"</span>)
00294 }
00295 
00296 <span class="comment">/* ______________________________________________________________________</span>
00297 <span class="comment"></span>
00298 <span class="comment">        CMError</span>
00299 <span class="comment">        Fill_ushort_ALUTs_from_lut8Tag( CMLutParamPtr   theLutData,</span>
00300 <span class="comment">                                                                        Ptr                             profileALuts,</span>
00301 <span class="comment">                                                                        char                    addrBits )</span>
00302 <span class="comment">        Abstract:</span>
00303 <span class="comment">                extracts output luts out of CMLut8Type tag and converts them</span>
00304 <span class="comment">                to desired format: (2 ^ addrBits) values in a range from 0 to 65535</span>
00305 <span class="comment"></span>
00306 <span class="comment">        Params:</span>
00307 <span class="comment">                theLutData                      (in/out)        Ptr to structure that holds all the luts...</span>
00308 <span class="comment">                profileALuts            (in)            Ptr to the profile's output luts</span>
00309 <span class="comment">                addrBits                        (in)            2 ^ addrBits values are requested</span>
00310 <span class="comment">                </span>
00311 <span class="comment">        Return:</span>
00312 <span class="comment">                noErr           successful</span>
00313 <span class="comment"></span>
00314 <span class="comment">   _____________________________________________________________________ */</span>
00315 <a class="code" href="../../d2/d6/lh__open_2pi__app_8h.html#a11">CMError</a>
<a name="l00316"></a><a class="code" href="../../d2/d7/w98_2lh__core_2fragment_8h.html#a9">00316</a> <a class="code" href="../../d5/d7/w98_2lh__core_2frgmnt16_8c.html#a3">Fill_ushort_ALUTs_from_lut8Tag</a>( <a class="code" href="../../d0/d4/structCMLutParam.html">CMLutParamPtr</a>   theLutData,
00317                                                                 Ptr                             profileALuts,
00318                                                                 <span class="keywordtype">char</span>                    addrBits )
00319 {
00320         <span class="keywordtype">long</span>                    i, j;
00321         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>   *curOutLut;
00322         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>   *profAluts = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)profileALuts;
00323         <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>  *curALUT;
00324         <span class="keywordtype">long</span>                    count, clipIndex;
00325         <span class="keywordtype">long</span>                    factor, fract, baseInd, lAux, leftVal, rightVal;
00326         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a35">OSErr</a>                   err = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a58a55">noErr</a>;
00327         <a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a1">LUT_DATA_TYPE</a>   localAlut = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a2">nil</a>;
00328         <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>  *localAlutPtr;
00329         <span class="keywordtype">long</span>                    theAlutSize;
00330         
00331         <a class="code" href="../../d6/d9/lh__open_2general_8h.html#a1">LH_START_PROC</a>(<span class="stringliteral">"Fill_ushort_ALUTs_from_lut8Tag"</span>)
00332         
00333         count     = 1 &lt;&lt; addrBits;                                              <span class="comment">/* addrBits is always &gt;= 8 */</span>
00334         clipIndex = count - 1;
00335         
00336         theAlutSize = theLutData-&gt;<a class="code" href="../../d0/d4/structCMLutParam.html#o7">colorLutOutDim</a> * count * <span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>);
00337         localAlut   = <a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a8">ALLOC_DATA</a>(theAlutSize + 2, &amp;err);
00338         <span class="keywordflow">if</span> (err)
00339                 <span class="keywordflow">goto</span> CleanupAndExit;
00340         
00341         <a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a6">LOCK_DATA</a>(localAlut);
00342         localAlutPtr = (<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *)<a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a3">DATA_2_PTR</a>(localAlut);
00343         
00344         factor = ((255 &lt;&lt; 12) + clipIndex/2) / clipIndex;               <span class="comment">/* for adjusting the indices */</span>
00345         
00346         <span class="keywordflow">for</span>(i=0; i&lt;theLutData-&gt;<a class="code" href="../../d0/d4/structCMLutParam.html#o7">colorLutOutDim</a>; i++)
00347         {
00348                 curOutLut = profAluts + (i &lt;&lt; 8);               <span class="comment">/* these are unsigned char's */</span>
00349                 curALUT   = localAlutPtr + i * count;   <span class="comment">/* these are unsigned short's */</span>
00350                 
00351                 <span class="keywordflow">for</span>(j=0; j&lt;=clipIndex-1; j++)
00352                 {
00353                         lAux    = j * factor;
00354                         baseInd = (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)lAux &gt;&gt; 12;
00355                         fract   = lAux &amp; 0x0FFF;
00356                         
00357                         leftVal = (<span class="keywordtype">long</span>)curOutLut[baseInd];
00358                         leftVal = (leftVal &lt;&lt; 8) + leftVal;             <span class="comment">/* 0xFF -&gt; 0xFFFF */</span>
00359                         
00360                         <span class="keywordflow">if</span>(fract)
00361                         {
00362                                 rightVal = (<span class="keywordtype">long</span>)curOutLut[baseInd + 1];
00363                                 rightVal = (rightVal &lt;&lt; 8) + rightVal;          <span class="comment">/* 0xFF -&gt; 0xFFFF */</span>
00364                                 
00365                                 lAux = rightVal - leftVal;
00366                                 lAux = (lAux * fract + 0x0800) &gt;&gt; 12;
00367                                 
00368                                 curALUT[j] = (<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>)(leftVal + lAux);
00369                         }
00370                         <span class="keywordflow">else</span>
00371                                 curALUT[j] = (<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>)leftVal;
00372                 }
00373                 
00374                 leftVal = (<span class="keywordtype">long</span>)curOutLut[255];
00375                 leftVal = (leftVal &lt;&lt; 8) + leftVal;             <span class="comment">/* 0xFF -&gt; 0xFFFF */</span>
00376                 curALUT[j] = (<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>)leftVal;
00377                 
00378                 <span class="keywordflow">for</span>(j=clipIndex+1; j&lt;count; j++)                <span class="comment">/* unused indices, clip these */</span>
00379                         curALUT[j] = curALUT[clipIndex];
00380         }
00381         
00382         <a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a7">UNLOCK_DATA</a>(localAlut);
00383         theLutData-&gt;<a class="code" href="../../d0/d4/structCMLutParam.html#o5">outputLut</a> = localAlut;
00384         localAlut = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a2">nil</a>;
00385 CleanupAndExit:
00386         localAlut = <a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a10">DISPOSE_IF_DATA</a>(localAlut);
00387 
00388         <a class="code" href="../../d6/d9/lh__open_2general_8h.html#a2">LH_END_PROC</a>(<span class="stringliteral">"Fill_ushort_ALUTs_from_lut8Tag"</span>)
00389         <span class="keywordflow">return</span> err;
00390 }
00391 
00392 <span class="comment">/* ______________________________________________________________________</span>
00393 <span class="comment"></span>
00394 <span class="comment">        CMError</span>
00395 <span class="comment">        Fill_ushort_ALUTs_from_lut16Tag(CMLutParamPtr   theLutData,</span>
00396 <span class="comment">                                                                        Ptr                             profileALuts,</span>
00397 <span class="comment">                                                                        char                    addrBits,</span>
00398 <span class="comment">                                                                    long                        outputTableEntries )</span>
00399 <span class="comment">        Abstract:</span>
00400 <span class="comment">                extracts output luts out of CMLut16Type tag and converts them</span>
00401 <span class="comment">                to desired format: (2 ^ addrBits) values in a range from 0 to 65535</span>
00402 <span class="comment"></span>
00403 <span class="comment">        Params:</span>
00404 <span class="comment">                theLutData                      (in/out)        Ptr to structure that holds all the luts...</span>
00405 <span class="comment">                profileALuts            (in)            Ptr to the profile's output luts</span>
00406 <span class="comment">                addrBits                        (in)            2 ^ addrBits values are requested</span>
00407 <span class="comment">                outputTableEntries      (in)            number of entries in the output lut (up to 4096)</span>
00408 <span class="comment">                </span>
00409 <span class="comment">        Return:</span>
00410 <span class="comment">                noErr           successful</span>
00411 <span class="comment"></span>
00412 <span class="comment">   _____________________________________________________________________ */</span>
00413 <a class="code" href="../../d2/d6/lh__open_2pi__app_8h.html#a11">CMError</a>
<a name="l00414"></a><a class="code" href="../../d2/d7/w98_2lh__core_2fragment_8h.html#a12">00414</a> <a class="code" href="../../d5/d7/w98_2lh__core_2frgmnt16_8c.html#a4">Fill_ushort_ALUTs_from_lut16Tag</a>(<a class="code" href="../../d0/d4/structCMLutParam.html">CMLutParamPtr</a>   theLutData,
00415                                                                 Ptr                             profileALuts,
00416                                                                 <span class="keywordtype">char</span>                    addrBits,
00417                                                             <span class="keywordtype">long</span>                        outputTableEntries )
00418 {
00419         <span class="keywordtype">long</span>                    i;
00420         <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>  *curOutLut;
00421         <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>  *curALUT;
00422         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>   ulIndFactor, j;
00423         <span class="keywordtype">long</span>                    count, clipIndex, outTabLen;
00424         <span class="keywordtype">long</span>                    fract, baseInd, lAux, leftVal, rightVal;
00425         <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>  *profALUTs = (<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *)profileALuts;
00426         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a35">OSErr</a>                   err = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a58a55">noErr</a>;
00427         <a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a1">LUT_DATA_TYPE</a>   localAlut = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a2">nil</a>;
00428         <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>  *localAlutPtr;
00429         <span class="keywordtype">long</span>                    theAlutSize;
00430         
00431         <a class="code" href="../../d6/d9/lh__open_2general_8h.html#a1">LH_START_PROC</a>(<span class="stringliteral">"Fill_ushort_ALUTs_from_lut16Tag"</span>)
00432         
00433         count     = 1 &lt;&lt; addrBits;                                              <span class="comment">/* addrBits is always &gt;= 8 */</span>
00434         clipIndex = count - 1;
00435 
00436         theAlutSize = theLutData-&gt;<a class="code" href="../../d0/d4/structCMLutParam.html#o7">colorLutOutDim</a> * count * <span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>);
00437         localAlut   = <a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a8">ALLOC_DATA</a>(theAlutSize + 2, &amp;err);
00438         <span class="keywordflow">if</span> (err)
00439                 <span class="keywordflow">goto</span> CleanupAndExit;
00440         
00441         outTabLen = outputTableEntries;                 <span class="comment">/* &lt;= 4096 acc. to the spec */</span>
00442         <span class="keywordflow">if</span>(outTabLen &gt; 4096)
00443         {
00444                 err = <a class="code" href="../../d2/d6/lh__open_2pi__app_8h.html#a149a30">cmparamErr</a>;
00445                 <span class="keywordflow">goto</span> CleanupAndExit;
00446         }
00447         
00448         ulIndFactor = (((<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)outTabLen - 1) &lt;&lt; 20)
00449                                 / (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)clipIndex;                             <span class="comment">/* for adjusting the indices */</span>
00450         
00451         <a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a6">LOCK_DATA</a>(localAlut);
00452         localAlutPtr = (<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> *)<a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a3">DATA_2_PTR</a>(localAlut);
00453         
00454         <span class="keywordflow">for</span>(i=0; i&lt;theLutData-&gt;<a class="code" href="../../d0/d4/structCMLutParam.html#o7">colorLutOutDim</a>; i++)
00455         {
00456                 curOutLut = profALUTs + i * outTabLen;
00457                 curALUT   = localAlutPtr + i * count;
00458                 
00459                 <span class="keywordflow">for</span>(j=0; j&lt;=(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)clipIndex; j++)
00460                 {
00461                         lAux    = (<span class="keywordtype">long</span>)( (j * ulIndFactor + 16) &gt;&gt; 5 );                <span class="comment">/* n.b: j is unsigned long ! */</span>
00462                         baseInd = (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)lAux &gt;&gt; 15;
00463                         fract   = lAux &amp; 0x7FFF;        <span class="comment">/* 15 bits for interpolation */</span>
00464                         
00465                         <span class="keywordflow">if</span>(fract)
00466                         {
00467                                 leftVal  = (<span class="keywordtype">long</span>)curOutLut[baseInd];
00468                                 rightVal = (<span class="keywordtype">long</span>)curOutLut[baseInd + 1];
00469                                 
00470                                 lAux = rightVal - leftVal;
00471                                 lAux = (lAux * fract + 16383) &gt;&gt; 15;
00472                                 
00473                                 curALUT[j] = (<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>)(leftVal + lAux);
00474                         }
00475                         <span class="keywordflow">else</span>
00476                                 curALUT[j] = curOutLut[baseInd];
00477                 }
00478                 
00479                 <span class="keywordflow">for</span>(j=clipIndex+1; j&lt;(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)count; j++)         <span class="comment">/* unused indices, clip these */</span>
00480                         curALUT[j] = curALUT[clipIndex];
00481         }
00482         
00483         <a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a7">UNLOCK_DATA</a>(localAlut);
00484         theLutData-&gt;<a class="code" href="../../d0/d4/structCMLutParam.html#o5">outputLut</a> = localAlut;
00485         localAlut = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a2">nil</a>;
00486 CleanupAndExit:
00487         localAlut = <a class="code" href="../../d5/d6/lh__core_2defines_8h.html#a10">DISPOSE_IF_DATA</a>(localAlut);
00488 
00489         <a class="code" href="../../d6/d9/lh__open_2general_8h.html#a2">LH_END_PROC</a>(<span class="stringliteral">"Fill_ushort_ALUTs_from_lut16Tag"</span>)
00490         <span class="keywordflow">return</span> err;
00491 }
00492 
00493 <span class="comment">/* ______________________________________________________________________</span>
00494 <span class="comment"></span>
00495 <span class="comment">        CMError</span>
00496 <span class="comment">                DoAbsoluteShiftForPCS_Cube16(   unsigned short  *theCube,</span>
00497 <span class="comment">                                                                                long                    count,</span>
00498 <span class="comment">                                                                                CMProfileRef    theProfile,</span>
00499 <span class="comment">                                                                                Boolean                 pcsIsXYZ,</span>
00500 <span class="comment">                                                                                Boolean                 afterInput )</span>
00501 <span class="comment">        Abstract:</span>
00502 <span class="comment">                Performs color shift necessary for absolute colorimetry. Data of</span>
00503 <span class="comment">                the cube points are in linear XYZ (16 bit) or in Lab (16 bit).</span>
00504 <span class="comment">                Either conversion just after entering PCS or before leaving PCS (inverse</span>
00505 <span class="comment">                operation). NOTE: for devices with colorant matrices this operation is</span>
00506 <span class="comment">                done much faster by manipulating the matrix.</span>
00507 <span class="comment"></span>
00508 <span class="comment">        Params:</span>
00509 <span class="comment">                theCube                 (in/out)        cube grid points</span>
00510 <span class="comment">                count                   (in)            number of points</span>
00511 <span class="comment">                theProfile              (in)            contains media white point</span>
00512 <span class="comment">                pcsIsXYZ                (in)            XYZ/Lab, saves one file access to profile</span>
00513 <span class="comment">                afterInput              (in)            direct or inverse operation</span>
00514 <span class="comment"></span>
00515 <span class="comment">        Return:</span>
00516 <span class="comment">                noErr                   successful</span>
00517 <span class="comment">   _____________________________________________________________________ */</span>
<a name="l00518"></a><a class="code" href="../../d2/d7/w98_2lh__core_2fragment_8h.html#a14">00518</a> <a class="code" href="../../d2/d6/lh__open_2pi__app_8h.html#a11">CMError</a> <a class="code" href="../../d5/d7/w98_2lh__core_2frgmnt16_8c.html#a5">DoAbsoluteShiftForPCS_Cube16</a>(   <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>  *theCube,
00519                                                                                 <span class="keywordtype">long</span>                    count,
00520                                                                                 CMProfileRef    theProfile,
00521                                                                                 Boolean                 pcsIsXYZ,
00522                                                                                 Boolean                 afterInput )
00523 {
00524         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>           i, uLong;
00525         <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>          *usPtr;
00526    <a class="code" href="../../d2/d6/lh__open_2pi__app_8h.html#a11">CMError</a>                              err = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a58a55">noErr</a>;
00527         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>           elementSize;
00528         <a class="code" href="../../d9/d6/structicXYZType.html">icXYZType</a>                       curMediaWhite;
00529         <span class="keywordtype">double</span>                          xFactor, yFactor, zFactor;
00530         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>           intFactorX, intFactorY, intFactorZ;
00531         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>           roundX, roundY, roundZ;
00532         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>           shiftX, shiftY, shiftZ;
00533         
00534         <a class="code" href="../../d6/d9/lh__open_2general_8h.html#a1">LH_START_PROC</a>(<span class="stringliteral">"DoAbsoluteShiftForPCS_Cube16"</span>)
00535         
00536         elementSize = <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d6/structicXYZType.html">icXYZType</a>);
00537         err = <a class="code" href="../../d7/d3/ntgdi_2icm_2mscmm_8w98_2mscmm_2access_8c.html#a1">CMGetProfileElement</a>(theProfile, <a class="code" href="../../d7/d4/aug98_2dll32_2icc_8h.html#a39">icSigMediaWhitePointTag</a>, &amp;elementSize, &amp;curMediaWhite);
00538 <span class="preprocessor">#ifdef IntelMode</span>
00539 <span class="preprocessor"></span>   SwapLongOffset( &amp;curMediaWhite.<a class="code" href="../../d9/d6/structicXYZType.html#o0">base</a>.<a class="code" href="../../d6/d4/structicTagBase.html#o0">sig</a>, 0, 4 );
00540    SwapLongOffset( &amp;curMediaWhite, (LONG)((<span class="keywordtype">char</span>*)&amp;curMediaWhite.<a class="code" href="../../d9/d6/structicXYZType.html#o1">data</a>.<a class="code" href="../../d7/d6/structicXYZArray.html#o0">data</a>[0]-(<span class="keywordtype">char</span>*)&amp;curMediaWhite), elementSize );
00541 <span class="preprocessor">#endif</span>
00542 <span class="preprocessor"></span>        <span class="keywordflow">if</span>(err)
00543         {
00544                 <span class="keywordflow">if</span>(err == <a class="code" href="../../d2/d6/lh__open_2pi__app_8h.html#a149a38">cmElementTagNotFound</a>)         <span class="comment">/* take D50 and do nothing */</span>
00545                         <span class="keywordflow">return</span>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a58a55">noErr</a>);
00546                 <span class="keywordflow">else</span>
00547                         <span class="keywordflow">return</span>(err);
00548         }
00549         
00550                 <span class="comment">/*--- preliminary matching factors: ---*/</span>
00551         xFactor = ((<span class="keywordtype">double</span>)curMediaWhite.data.data[0].X) / 65536. / 0.9642;
00552         <span class="keywordflow">if</span>(xFactor &gt; 100.)
00553                 xFactor = 100.;                 <span class="comment">/* evil profile */</span>
00554         <span class="keywordflow">else</span> <span class="keywordflow">if</span>(xFactor &lt; 0.01)
00555                 xFactor = 0.01;
00556 
00557         yFactor = ((<span class="keywordtype">double</span>)curMediaWhite.data.data[0].Y) / 65536.;
00558         <span class="keywordflow">if</span>(yFactor &gt; 100.)
00559                 yFactor = 100.;
00560         <span class="keywordflow">else</span> <span class="keywordflow">if</span>(yFactor &lt; 0.01)
00561                 yFactor = 0.01;
00562 
00563         zFactor = ((<span class="keywordtype">double</span>)curMediaWhite.data.data[0].Z) / 65536. / 0.8249;
00564         <span class="keywordflow">if</span>(zFactor &gt; 100.)
00565                 zFactor = 100.;
00566         <span class="keywordflow">else</span> <span class="keywordflow">if</span>(zFactor &lt; 0.01)
00567                 zFactor = 0.01;
00568 
00569         <span class="keywordflow">if</span>( ( xFactor &lt; 1.+1.E-3 &amp;&amp; xFactor &gt; 1.-1.E-3 ) &amp;&amp;
00570                 ( yFactor &lt; 1.+1.E-3 &amp;&amp; yFactor &gt; 1.-1.E-3 ) &amp;&amp;
00571                 ( zFactor &lt; 1.+1.E-3 &amp;&amp; zFactor &gt; 1.-1.E-3 ) )
00572                         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a58a55">noErr</a>; <span class="comment">/* do nothing if MediaWhite is D50 */</span>
00573         
00574         <span class="keywordflow">if</span>(!afterInput)         <span class="comment">/* back to device space (for example with B2A1 table) */</span>
00575         {
00576                 xFactor = 1. / xFactor;
00577                 yFactor = 1. / yFactor;
00578                 zFactor = 1. / zFactor;
00579         }
00580         
00581                 <span class="comment">/*--- integer factors for speed: ---*/</span>
00582         intFactorX = (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)(xFactor * 65536. * 64.);   <span class="comment">/* probably too long... */</span>
00583         intFactorY = (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)(yFactor * 65536. * 64.);   <span class="comment">/* ...adding 22 bits    */</span>
00584         intFactorZ = (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)(zFactor * 65536. * 64.);
00585         
00586         roundX = roundY = roundZ = 0x1FFFFF;    <span class="comment">/* 2^21 - 1 */</span>
00587         shiftX = shiftY = shiftZ = 22;
00588         
00589         <span class="keywordflow">while</span>(intFactorX &amp; 0xFFFF0000)  <span class="comment">/* stay within 16 bits to prevent product overflow */</span>
00590         {
00591                 intFactorX &gt;&gt;= 1;
00592                 roundX     &gt;&gt;= 1;
00593                 shiftX      -= 1;
00594         }
00595         
00596         <span class="keywordflow">while</span>(intFactorY &amp; 0xFFFF0000)
00597         {
00598                 intFactorY &gt;&gt;= 1;
00599                 roundY     &gt;&gt;= 1;
00600                 shiftY      -= 1;
00601         }
00602         
00603         <span class="keywordflow">while</span>(intFactorZ &amp; 0xFFFF0000)
00604         {
00605                 intFactorZ &gt;&gt;= 1;
00606                 roundZ     &gt;&gt;= 1;
00607                 shiftZ      -= 1;
00608         }
00609         
00610                 <span class="comment">/*--- perform matching: ---*/</span>
00611         <span class="keywordflow">if</span>(!pcsIsXYZ)           <span class="comment">/* 16 bit linear Lab  to XYZ before and afterwards */</span>
00612                 <a class="code" href="../../d1/d6/w98_2lh__core_2stdconv_8h.html#a0">Lab2XYZ_forCube16</a>(theCube, count);
00613         
00614         usPtr = theCube;
00615 
00616         <span class="keywordflow">for</span>(i=0; i&lt;(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)count; i++)
00617         {
00618                 uLong = ((<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)(*usPtr) * intFactorX + roundX) &gt;&gt; shiftX;
00619                 <span class="keywordflow">if</span>(uLong &gt; 0x0FFFF)
00620                         uLong = 0xFFFF;                         <span class="comment">/* clip to 2.0 */</span>
00621                 *usPtr++ = (<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>)uLong;
00622                 
00623                 uLong = ((<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)(*usPtr) * intFactorY + roundY) &gt;&gt; shiftY;
00624                 <span class="keywordflow">if</span>(uLong &gt; 0x0FFFF)
00625                         uLong = 0xFFFF;
00626                 *usPtr++ = (<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>)uLong;
00627                 
00628                 uLong = ((<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)(*usPtr) * intFactorZ + roundZ) &gt;&gt; shiftZ;
00629                 <span class="keywordflow">if</span>(uLong &gt; 0x0FFFF)
00630                         uLong = 0xFFFF;
00631                 *usPtr++ = (<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span>)uLong;
00632         }
00633 
00634         <span class="keywordflow">if</span>(!pcsIsXYZ)           <span class="comment">/* back to 16 bit Lab */</span>
00635                 <a class="code" href="../../d1/d6/w98_2lh__core_2stdconv_8h.html#a1">XYZ2Lab_forCube16</a>(theCube, count);
00636 
00637 
00638         <a class="code" href="../../d6/d9/lh__open_2general_8h.html#a2">LH_END_PROC</a>(<span class="stringliteral">"DoAbsoluteShiftForPCS_Cube16"</span>)
00639         <span class="keywordflow">return</span>(<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a58a55">noErr</a>);
00640 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:03 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
