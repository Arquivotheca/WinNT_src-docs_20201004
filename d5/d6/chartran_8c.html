<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: chartran.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>chartran.c File Reference</h1>
<p>
<a href="../../d6/d5/chartran_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/chartran_8c.html#a0">THREAD_CODEPAGE</a>()&nbsp;&nbsp;&nbsp;(GetClientInfo()-&gt;CodePage)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/chartran_8c.html#a1">IS_ACP</a>(cp)&nbsp;&nbsp;&nbsp;(((cp) == <a class="el" href="../../d9/d6/nlsxlat_8c.html#a12">NlsAnsiCodePage</a>) || ((cp) == CP_ACP))</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/chartran_8c.html#a2">__declspec</a> (dllimport)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>int&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/chartran_8c.html#a3">MBToWCSEx</a> (WORD wCodePage, LPCSTR pAnsiString, int nAnsiChar, LPWSTR *ppUnicodeString, int cchUnicodeString, BOOL bAllocateMem)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/chartran_8c.html#a4">RtlWCSMessageWParamCharToMB</a> (<a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="el" href="../../d2/d1/userexts_8c.html#a129">msg</a>, WPARAM *pWParam)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOL&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/chartran_8c.html#a5">RtlMBMessageWParamCharToWCS</a> (<a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> <a class="el" href="../../d2/d1/userexts_8c.html#a129">msg</a>, WPARAM *pWParam)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/chartran_8c.html#a6">RtlInitLargeAnsiString</a> (<a class="el" href="../../d5/d8/struct__LARGE__ANSI__STRING.html">PLARGE_ANSI_STRING</a> plstr, LPCSTR psz, UINT cchLimit)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/chartran_8c.html#a7">RtlInitLargeUnicodeString</a> (<a class="el" href="../../d2/d9/struct__LARGE__UNICODE__STRING.html">PLARGE_UNICODE_STRING</a> plstr, LPCWSTR psz, UINT cchLimit)</td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a1" doxytag="chartran.c::IS_ACP" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define IS_ACP          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">cp&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;(((cp) == <a class="el" href="../../d9/d6/nlsxlat_8c.html#a12">NlsAnsiCodePage</a>) || ((cp) == CP_ACP))</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d6/d5/chartran_8c-source.html#l00016">__declspec()</a>, <a class="el" href="../../d6/d5/chartran_8c-source.html#l00191">MBToWCSEx()</a>, <a class="el" href="../../d6/d5/chartran_8c-source.html#l00490">RtlMBMessageWParamCharToWCS()</a>, and <a class="el" href="../../d6/d5/chartran_8c-source.html#l00361">RtlWCSMessageWParamCharToMB()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="chartran.c::THREAD_CODEPAGE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define THREAD_CODEPAGE          </td>
          <td class="md" valign="top">(&nbsp;</td>
&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;(GetClientInfo()-&gt;CodePage)</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a2" doxytag="chartran.c::__declspec" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> __declspec           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">dllimport&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/chartran_8c-source.html#l00016">16</a> of file <a class="el" href="../../d6/d5/chartran_8c-source.html">chartran.c</a>.
<p>
References <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l00587">DBCS_CHARSIZE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d5/ndismain_8h-source.html#l00025">INT</a>, <a class="el" href="../../d5/d6/chartran_8c.html#a1">IS_ACP</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d0/d6/nlsxlat_8c-source.html#l00905">RtlUnicodeToMultiByteN()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d0/d5/ndismain_8h-source.html#l00026">UINT</a>, <a class="el" href="../../d7/d7/clinit_8c-source.html#l01614">UserRtlAllocMem()</a>, and <a class="el" href="../../d7/d7/clinit_8c-source.html#l01620">UserRtlFreeMem()</a>.
<p>
Referenced by <a class="el" href="../../d0/d6/kernel_2server_8c-source.html#l02135">IsMidEastEnabledSystem()</a>, and <a class="el" href="../../d3/d3/tounicod_8c-source.html#l00279">xxxInternalToUnicode()</a>.
<p>
<pre class="fragment"><div>00043            : number of characters in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> output string
00044 *        If bAllocateMem was <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, then FreeAnsiString() may be
00045 *        used to free the allocated memory at *ppAnsiString.
00046 *   Failure: 0 means failure
00047 *        (Any buffers allocated by this routine are freed)
00048 *
00049 * History:
00050 *  1992-??-?? GregoryW   Created
00051 *  1993-01-07 IanJa      fix memory leak on error case.
00052 \***************************************************************************/
00053 
00054 <span class="keywordtype">int</span>
00055 WCSToMBEx(
00056     WORD wCodePage,
00057     LPCWSTR pUnicodeString,
00058     <span class="keywordtype">int</span> cchUnicodeString,
00059     LPSTR *ppAnsiString,
00060     <span class="keywordtype">int</span> nAnsiChar,
00061     BOOL bAllocateMem)
00062 {
00063     ULONG nCharsInAnsiString;
00064 <span class="preprocessor">#ifdef _USERK_</span>
00065 <span class="preprocessor"></span>    <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a> iCharsInAnsiString;
00066 <span class="preprocessor">#endif // _USERK_</span>
00067 <span class="preprocessor"></span>
00068     <span class="keywordflow">if</span> (nAnsiChar == 0 || cchUnicodeString == 0 || pUnicodeString == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00069         <span class="keywordflow">return</span> 0;      <span class="comment">// nothing to translate or nowhere to put it</span>
00070     }
00071 
00072     <span class="comment">/*</span>
00073 <span class="comment">     * Adjust the cchUnicodeString value.  If cchUnicodeString == -1 then the</span>
00074 <span class="comment">     * string pointed to by pUnicodeString is NUL terminated so we</span>
00075 <span class="comment">     * count the number of bytes.  If cchUnicodeString &lt; -1 this is an</span>
00076 <span class="comment">     * illegal value so we return FALSE.  Otherwise, cchUnicodeString is</span>
00077 <span class="comment">     * set and requires no adjustment.</span>
00078 <span class="comment">     */</span>
00079     <span class="keywordflow">if</span> (cchUnicodeString == -1) {
00080         cchUnicodeString = (wcslen(pUnicodeString) + 1);
00081     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cchUnicodeString &lt; -1) {
00082         <span class="keywordflow">return</span> 0;     <span class="comment">// illegal value</span>
00083     }
00084 
00085     <span class="comment">/*</span>
00086 <span class="comment">     * Adjust the nAnsiChar value.  If nAnsiChar == -1 then we pick a</span>
00087 <span class="comment">     * value based on cchUnicodeString to hold the converted string.  If</span>
00088 <span class="comment">     * nAnsiChar &lt; -1 this is an illegal value so we return FALSE.</span>
00089 <span class="comment">     * Otherwise, nAnsiChar is set and requires no adjustment.</span>
00090 <span class="comment">     */</span>
00091     <span class="keywordflow">if</span> (nAnsiChar == -1) {
00092         <span class="keywordflow">if</span> (bAllocateMem == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00093             <span class="keywordflow">return</span> 0;  <span class="comment">// no destination</span>
00094         }
00095         nAnsiChar = cchUnicodeString * <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a123">DBCS_CHARSIZE</a>;
00096     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (nAnsiChar &lt; -1) {
00097         <span class="keywordflow">return</span> 0;     <span class="comment">// illegal value</span>
00098     }
00099 
00100     <span class="keywordflow">if</span> (bAllocateMem) {
00101         <span class="comment">/*</span>
00102 <span class="comment">         * We need to allocate memory to hold the translated string.</span>
00103 <span class="comment">         */</span>
00104         *ppAnsiString = (LPSTR)<a class="code" href="../../d6/d1/userrtl_8h.html#a31">UserRtlAllocMem</a>(nAnsiChar);
00105         <span class="keywordflow">if</span> (*ppAnsiString == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00106             <span class="keywordflow">return</span> 0;
00107         }
00108     }
00109 
00110     <span class="comment">/*</span>
00111 <span class="comment">     * translate Unicode string pointed to by pUnicodeString into</span>
00112 <span class="comment">     * ANSI and store in location pointed to by pAnsiString.  We</span>
00113 <span class="comment">     * stop translating when we fill up the ANSI buffer or reach</span>
00114 <span class="comment">     * the end of the Unicode string.</span>
00115 <span class="comment">     */</span>
00116 
00117     <span class="comment">/*</span>
00118 <span class="comment">     * if the target multibyte codepage is eqaul to ACP, Call faster Rtl function.</span>
00119 <span class="comment">     */</span>
00120     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/chartran_8c.html#a1">IS_ACP</a>(wCodePage)) {
00121 
00122         <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00123 
00124         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d6/nlsxlat_8c.html#a37">RtlUnicodeToMultiByteN</a>(
00125                         (PCH)*ppAnsiString,
00126                         nAnsiChar,
00127                         &amp;nCharsInAnsiString,
00128                         (PWCH)pUnicodeString,
00129                         cchUnicodeString * <span class="keyword">sizeof</span>(WCHAR));
00130         <span class="comment">/*</span>
00131 <span class="comment">         * If the ansi buffer is too small, RtlUnicodeToMultiByteN()</span>
00132 <span class="comment">         * returns STATUS_BUFFER_OVERFLOW. In this case, the function</span>
00133 <span class="comment">         * put as many ansi characters as specified in the buffer and</span>
00134 <span class="comment">         *  returns the number by chacacters(in bytes) written. We would</span>
00135 <span class="comment">         * like to return the actual byte  count written in the ansi</span>
00136 <span class="comment">         * buffer rather than returnning 0 since callers of this function</span>
00137 <span class="comment">         * don't expect to be returned 0 in most case.</span>
00138 <span class="comment">         */</span>
00139 
00140         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) &amp;&amp; <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_BUFFER_OVERFLOW) {
00141             <span class="keywordflow">if</span> (bAllocateMem) {
00142                 <a class="code" href="../../d6/d1/userrtl_8h.html#a32">UserRtlFreeMem</a>(*ppAnsiString);
00143             }
00144             <span class="keywordflow">return</span> 0;   <span class="comment">// translation failed</span>
00145         }
00146 
00147         <span class="keywordflow">return</span> (<span class="keywordtype">int</span>)nCharsInAnsiString;
00148 
00149     } <span class="keywordflow">else</span> {
00150 
00151 <span class="preprocessor">#ifdef _USERK_</span>
00152 <span class="preprocessor"></span>        <span class="comment">/*</span>
00153 <span class="comment">         * Call GRE to convert string to Unicode. (Kernel mode)</span>
00154 <span class="comment">         */</span>
00155 
00156         iCharsInAnsiString = EngWideCharToMultiByte(
00157                                  (UINT)wCodePage,
00158                                  (LPWSTR)pUnicodeString,
00159                                  cchUnicodeString * <span class="keyword">sizeof</span>(WCHAR),
00160                                  (LPSTR)*ppAnsiString,
00161                                  nAnsiChar);
00162 
00163         nCharsInAnsiString = (iCharsInAnsiString == -1) ? 0 :
00164                                                           (ULONG) iCharsInAnsiString;
00165 
00166 <span class="preprocessor">#else</span>
00167 <span class="preprocessor"></span>        <span class="comment">/*</span>
00168 <span class="comment">         * Call NLS API (Kernel32) to convert string to Unicode. (User mode)</span>
00169 <span class="comment">         */</span>
00170         nCharsInAnsiString = WideCharToMultiByte(
00171                                  (UINT)wCodePage, 0,
00172                                  (LPCWSTR)pUnicodeString,
00173                                  cchUnicodeString,
00174                                  (LPSTR)*ppAnsiString,
00175                                  nAnsiChar,
00176                                  NULL, NULL);
00177 <span class="preprocessor">#endif // _USERK_</span>
00178 <span class="preprocessor"></span>
00179         <span class="keywordflow">if</span> (nCharsInAnsiString == 0) {
00180             <span class="keywordflow">if</span> (bAllocateMem) {
00181                 <a class="code" href="../../d6/d1/userrtl_8h.html#a32">UserRtlFreeMem</a>(*ppAnsiString);
00182             }
00183         }
00184 
00185         <span class="keywordflow">return</span> (<span class="keywordtype">int</span>)nCharsInAnsiString;
00186     }
00187 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="chartran.c::MBToWCSEx" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> int MBToWCSEx           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">WORD&nbsp;</td>
          <td class="mdname" nowrap> <em>wCodePage</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>LPCSTR&nbsp;</td>
          <td class="mdname" nowrap> <em>pAnsiString</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>int&nbsp;</td>
          <td class="mdname" nowrap> <em>nAnsiChar</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>LPWSTR *&nbsp;</td>
          <td class="mdname" nowrap> <em>ppUnicodeString</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>int&nbsp;</td>
          <td class="mdname" nowrap> <em>cchUnicodeString</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>BOOL&nbsp;</td>
          <td class="mdname" nowrap> <em>bAllocateMem</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/chartran_8c-source.html#l00191">191</a> of file <a class="el" href="../../d6/d5/chartran_8c-source.html">chartran.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d5/ndismain_8h-source.html#l00025">INT</a>, <a class="el" href="../../d5/d6/chartran_8c.html#a1">IS_ACP</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d0/d6/nlsxlat_8c-source.html#l00369">RtlMultiByteToUnicodeN()</a>, <a class="el" href="../../d2/d7/regtest_8c.html#a2">strlen()</a>, <a class="el" href="../../d0/d5/ndismain_8h-source.html#l00026">UINT</a>, <a class="el" href="../../d7/d7/clinit_8c-source.html#l01614">UserRtlAllocMem()</a>, and <a class="el" href="../../d7/d7/clinit_8c-source.html#l01620">UserRtlFreeMem()</a>.
<p>
Referenced by <a class="el" href="../../d2/d3/combo_8c-source.html#l00104">ComboBoxDBCharHandler()</a>, <a class="el" href="../../d4/d1/client_2drawtext_8c-source.html#l00047">DrawTextExA()</a>, <a class="el" href="../../d4/d1/client_2drawtext_8c-source.html#l00508">GetTabbedTextExtentA()</a>, <a class="el" href="../../d9/d8/client_2ntstubs_8c-source.html#l01669">MESSAGECALL()</a>, <a class="el" href="../../d6/d4/statctl_8c-source.html#l00840">StaticWndProcWorker()</a>, <a class="el" href="../../d4/d1/client_2drawtext_8c-source.html#l00459">TabbedTextOutA()</a>, and <a class="el" href="../../d0/d1/lboxctl2_8c-source.html#l02948">xxxLBoxCtlCharInput()</a>.
<p>
<pre class="fragment"><div>00198 {
00199     ULONG nBytesInUnicodeString;
00200 
00201     <span class="keywordflow">if</span> (nAnsiChar == 0 || cchUnicodeString == 0 || pAnsiString == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00202         <span class="keywordflow">return</span> 0;      <span class="comment">// nothing to translate or nowhere to put it</span>
00203     }
00204 
00205     <span class="comment">/*</span>
00206 <span class="comment">     * Adjust the nAnsiChar value.  If nAnsiChar == -1 then the</span>
00207 <span class="comment">     * string pointed to by pAnsiString is NUL terminated so we</span>
00208 <span class="comment">     * count the number of bytes.  If nAnsiChar &lt; -1 this is an</span>
00209 <span class="comment">     * illegal value so we return FALSE.  Otherwise, nAnsiChar is</span>
00210 <span class="comment">     * set and requires no adjustment.</span>
00211 <span class="comment">     */</span>
00212 
00213 <span class="preprocessor">#ifdef _USERK_</span>
00214 <span class="preprocessor"></span>    UserAssert(nAnsiChar &gt;= USER_AWCONV_COUNTSTRINGSZ);
00215 <span class="preprocessor">#endif</span>
00216 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (nAnsiChar &lt; 0) {
00217 
00218         <span class="comment">/*</span>
00219 <span class="comment">         *  Bug 268035 - joejo</span>
00220 <span class="comment">         *  Need to fail if the count is a negative number less than -2!</span>
00221 <span class="comment">         */</span>
00222         <span class="keywordflow">if</span> (nAnsiChar &lt; USER_AWCONV_COUNTSTRINGSZ) {
00223             <span class="keywordflow">return</span> 0;
00224         }
00225 
00226 <span class="preprocessor">#if (USER_AWCONV_COUNTSTRING != -1 || USER_AWCONV_COUNTSTRINGSZ != -2)</span>
00227 <span class="preprocessor"></span><span class="preprocessor">#error USER_AWCONV_COUNTSTRING or USER_AWCONV_COUNTSTRINGSZ has unexpected value.</span>
00228 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00229 <span class="preprocessor"></span>        <span class="comment">/* HACK HACK HACK</span>
00230 <span class="comment">         * If nAnsiChar is -1 (USER_AWCONV_COUNTSTRING), nAnsiChar length will be strlen() + 1,</span>
00231 <span class="comment">         * to allocate the memory including trailing \0: this is compatible to the original code.</span>
00232 <span class="comment">         * If nAnsiCahr is -2 (USER_AWCONV_COUNTSTRINGSZ), memory for trailing \0 will not be needed,</span>
00233 <span class="comment">         * so memory allocation is optimized and the return value would be same as strlen().</span>
00234 <span class="comment">         */</span>
00235         nAnsiChar = <a class="code" href="../../d2/d7/regtest_8c.html#a2">strlen</a>(pAnsiString) + 2 + nAnsiChar;   <span class="comment">// don't forget the NUL if nAnsiChar == -1</span>
00236 
00237         <span class="keywordflow">if</span> (nAnsiChar == 0) {
00238             <span class="keywordflow">return</span> 0;
00239         }
00240     }
00241 
00242     <span class="comment">/*</span>
00243 <span class="comment">     * Adjust the cchUnicodeString value.  If cchUnicodeString == -1 then we</span>
00244 <span class="comment">     * pick a value based on nAnsiChar to hold the converted string.  If</span>
00245 <span class="comment">     * cchUnicodeString &lt; -1 this is an illegal value so we return FALSE.</span>
00246 <span class="comment">     * Otherwise, cchUnicodeString is set and requires no adjustment.</span>
00247 <span class="comment">     */</span>
00248     <span class="keywordflow">if</span> (cchUnicodeString == -1) {
00249         <span class="keywordflow">if</span> (bAllocateMem == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00250             <span class="keywordflow">return</span> 0;    <span class="comment">// no destination</span>
00251         }
00252         cchUnicodeString = nAnsiChar;
00253     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cchUnicodeString &lt; -1) {
00254         <span class="keywordflow">return</span> 0;     <span class="comment">// illegal value</span>
00255     }
00256 
00257     <span class="keywordflow">if</span> (bAllocateMem) {
00258         *ppUnicodeString = (LPWSTR)<a class="code" href="../../d6/d1/userrtl_8h.html#a31">UserRtlAllocMem</a>(cchUnicodeString*<span class="keyword">sizeof</span>(WCHAR));
00259         <span class="keywordflow">if</span> (*ppUnicodeString == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00260             <span class="keywordflow">return</span> 0;    <span class="comment">// allocation failed</span>
00261         }
00262     }
00263 
00264     <span class="comment">/*</span>
00265 <span class="comment">     * if codepage is CP_ACP, We will call faster RtlXXX function.</span>
00266 <span class="comment">     */</span>
00267     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/chartran_8c.html#a1">IS_ACP</a>(wCodePage)) {
00268         <span class="comment">/*</span>
00269 <span class="comment">         * translate ANSI string pointed to by pAnsiString into Unicode</span>
00270 <span class="comment">         * and store in location pointed to by pUnicodeString.  We</span>
00271 <span class="comment">         * stop translating when we fill up the Unicode buffer or reach</span>
00272 <span class="comment">         * the end of the ANSI string.</span>
00273 <span class="comment">         */</span>
00274         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d9/d6/nlsxlat_8c.html#a33">RtlMultiByteToUnicodeN</a>(
00275                             (PWCH)*ppUnicodeString,
00276                             cchUnicodeString * <span class="keyword">sizeof</span>(WCHAR),
00277                             &amp;nBytesInUnicodeString,
00278                             (PCH)pAnsiString,
00279                             nAnsiChar
00280                             ))) {
00281             <span class="keywordflow">if</span> (bAllocateMem) {
00282                 <a class="code" href="../../d6/d1/userrtl_8h.html#a32">UserRtlFreeMem</a>(*ppUnicodeString);
00283             }
00284             <span class="keywordflow">return</span> 0;   <span class="comment">// translation failed</span>
00285         }
00286 
00287         <span class="keywordflow">return</span> (<span class="keywordtype">int</span>)(nBytesInUnicodeString / <span class="keyword">sizeof</span>(WCHAR));
00288 
00289     } <span class="keywordflow">else</span> {
00290         <span class="comment">/*</span>
00291 <span class="comment">         * if wCodePage is not ACP, Call NLS API.</span>
00292 <span class="comment">         */</span>
00293         ULONG nCharsInUnicodeString;
00294 
00295 <span class="preprocessor">#ifdef _USERK_</span>
00296 <span class="preprocessor"></span>
00297         <span class="comment">/*</span>
00298 <span class="comment">         * I believe we will never hit this code which is why I am</span>
00299 <span class="comment">         * adding this assert.  [gerritv] 5-21-96</span>
00300 <span class="comment">         */</span>
00301 <span class="preprocessor">#define SHOULD_NOT_REACH_HERE   0</span>
00302 <span class="preprocessor"></span>        UserAssert(SHOULD_NOT_REACH_HERE);
00303 <span class="preprocessor">#undef  SHOULD_NOT_REACH_HERE</span>
00304 <span class="preprocessor"></span>        <span class="keywordflow">return</span> 0;
00305 
00306 <span class="preprocessor">#if 0   // FYI: old code</span>
00307 <span class="preprocessor"></span>        <a class="code" href="../../d9/d5/ndismain_8h.html#a263">INT</a>   iCharsInUnicodeString;
00308 
00309         <span class="comment">/*</span>
00310 <span class="comment">         * Call GRE to convert string to Unicode. (Kernel mode)</span>
00311 <span class="comment">         * I believe we will never hit this code which is why I am</span>
00312 <span class="comment">         * adding this assert.  [gerritv] 5-21-96</span>
00313 <span class="comment">         */</span>
00314 
00315         UserAssert(0);
00316 
00317         iCharsInUnicodeString = EngMultiByteToWideChar(
00318                                     (UINT)wCodePage,
00319                                     (LPWSTR)*ppUnicodeString,
00320                                     (<span class="keywordtype">int</span>)cchUnicodeString * <span class="keyword">sizeof</span>(WCHAR),
00321                                     (LPSTR)pAnsiString,
00322                                     (<span class="keywordtype">int</span>)nAnsiChar);
00323 
00324         nCharsInUnicodeString = (iCharsInUnicodeString == -1) ? 0 :
00325                                                           (ULONG) iCharsInUnicodeString;
00326 <span class="preprocessor">#endif</span>
00327 <span class="preprocessor"></span>
00328 <span class="preprocessor">#else</span>
00329 <span class="preprocessor"></span>        <span class="comment">/*</span>
00330 <span class="comment">         * Call NLS API (Kernel32) to convert string to Unicode. (User mode)</span>
00331 <span class="comment">         */</span>
00332         nCharsInUnicodeString = MultiByteToWideChar(
00333                                     (UINT)wCodePage, 0,
00334                                     (LPCSTR)pAnsiString,
00335                                     (<span class="keywordtype">int</span>)nAnsiChar,
00336                                     (LPWSTR)*ppUnicodeString,
00337                                     (<span class="keywordtype">int</span>)cchUnicodeString);
00338 <span class="preprocessor">#endif // _USERK_</span>
00339 <span class="preprocessor"></span>
00340         <span class="keywordflow">if</span> (nCharsInUnicodeString == 0) {
00341             <span class="keywordflow">if</span> (bAllocateMem) {
00342                 <a class="code" href="../../d6/d1/userrtl_8h.html#a32">UserRtlFreeMem</a>(*ppUnicodeString);
00343             }
00344         }
00345 
00346         <span class="keywordflow">return</span> (<span class="keywordtype">int</span>)nCharsInUnicodeString;
00347     }
00348 
00349 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="chartran.c::RtlInitLargeAnsiString" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID RtlInitLargeAnsiString           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d5/d8/struct__LARGE__ANSI__STRING.html">PLARGE_ANSI_STRING</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>plstr</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>LPCSTR&nbsp;</td>
          <td class="mdname" nowrap> <em>psz</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>UINT&nbsp;</td>
          <td class="mdname" nowrap> <em>cchLimit</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/chartran_8c-source.html#l00608">608</a> of file <a class="el" href="../../d6/d5/chartran_8c-source.html">chartran.c</a>.
<p>
References <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l00458">_LARGE_ANSI_STRING::bAnsi</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l00428">_LARGE_ANSI_STRING::Buffer</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l00456">_LARGE_ANSI_STRING::Length</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l00457">_LARGE_ANSI_STRING::MaximumLength</a>, <a class="el" href="../../d6/d3/acpitabl_8h-source.html#l00366">min</a>, <a class="el" href="../../d0/d0/client_2nt6_2user_8h.html#a971">PLARGE_ANSI_STRING</a>, <a class="el" href="../../d2/d7/regtest_8c.html#a2">strlen()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
Referenced by <a class="el" href="../../d9/d8/client_2ntstubs_8c-source.html#l01197">_CreateWindowEx()</a>, <a class="el" href="../../d9/d8/client_2ntstubs_8c-source.html#l01171">_DefSetText()</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l10358">MESSAGECALL()</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l12075">NtUserfnHkINLPCBTCREATESTRUCT()</a>, and <a class="el" href="../../d5/d7/createw_8c-source.html#l00033">xxxCreateWindowEx()</a>.
<p>
<pre class="fragment"><div>00612 {
00613     ULONG Length;
00614 
00615     plstr-&gt;<a class="code" href="../../d5/d8/struct__LARGE__ANSI__STRING.html#o3">Buffer</a> = (PSTR)psz;
00616     plstr-&gt;<a class="code" href="../../d5/d8/struct__LARGE__ANSI__STRING.html#o2">bAnsi</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00617     <span class="keywordflow">if</span> (ARGUMENT_PRESENT( psz )) {
00618         Length = <a class="code" href="../../d2/d7/regtest_8c.html#a2">strlen</a>( psz );
00619         plstr-&gt;<a class="code" href="../../d5/d8/struct__LARGE__ANSI__STRING.html#o0">Length</a> = <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(Length, cchLimit);
00620         plstr-&gt;<a class="code" href="../../d5/d8/struct__LARGE__ANSI__STRING.html#o1">MaximumLength</a> = <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>((Length + 1), cchLimit);
00621     } <span class="keywordflow">else</span> {
00622         plstr-&gt;<a class="code" href="../../d5/d8/struct__LARGE__ANSI__STRING.html#o1">MaximumLength</a> = 0;
00623         plstr-&gt;<a class="code" href="../../d5/d8/struct__LARGE__ANSI__STRING.html#o0">Length</a> = 0;
00624     }
00625 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="chartran.c::RtlInitLargeUnicodeString" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID RtlInitLargeUnicodeString           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d2/d9/struct__LARGE__UNICODE__STRING.html">PLARGE_UNICODE_STRING</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>plstr</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>LPCWSTR&nbsp;</td>
          <td class="mdname" nowrap> <em>psz</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>UINT&nbsp;</td>
          <td class="mdname" nowrap> <em>cchLimit</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/chartran_8c-source.html#l00636">636</a> of file <a class="el" href="../../d6/d5/chartran_8c-source.html">chartran.c</a>.
<p>
References <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l00465">_LARGE_UNICODE_STRING::bAnsi</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l00435">_LARGE_UNICODE_STRING::Buffer</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l00463">_LARGE_UNICODE_STRING::Length</a>, <a class="el" href="../../d2/d9/inc_2user_8h-source.html#l00464">_LARGE_UNICODE_STRING::MaximumLength</a>, <a class="el" href="../../d6/d3/acpitabl_8h-source.html#l00366">min</a>, <a class="el" href="../../d0/d0/client_2nt6_2user_8h.html#a973">PLARGE_UNICODE_STRING</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
Referenced by <a class="el" href="../../d9/d8/client_2ntstubs_8c-source.html#l01197">_CreateWindowEx()</a>, <a class="el" href="../../d9/d8/client_2ntstubs_8c-source.html#l01171">_DefSetText()</a>, <a class="el" href="../../d1/d1/lboxctl3_8c-source.html#l00682">DlgDirSelectHelper()</a>, <a class="el" href="../../d2/d2/tmswitch_8c-source.html#l00538">DrawSwitchWndHilite()</a>, <a class="el" href="../../d1/d8/dlgbegin_8c-source.html#l00553">InternalCreateDialog()</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l10358">MESSAGECALL()</a>, <a class="el" href="../../d0/d9/kernel_2ntstubs_8c-source.html#l12075">NtUserfnHkINLPCBTCREATESTRUCT()</a>, <a class="el" href="../../d1/d7/ntcftxt_8h-source.html#l00883">SendNotifyMessage()</a>, <a class="el" href="../../d6/d7/ntimm_8c-source.html#l00531">xxxCreateDefaultImeWindow()</a>, <a class="el" href="../../d7/d4/mdiwin_8c-source.html#l00032">xxxSetFrameTitle()</a>, and <a class="el" href="../../d5/d4/rare_8c-source.html#l01497">xxxSystemParametersInfo()</a>.
<p>
<pre class="fragment"><div>00640 {
00641     ULONG Length;
00642 
00643     plstr-&gt;<a class="code" href="../../d2/d9/struct__LARGE__UNICODE__STRING.html#o3">Buffer</a> = (PWSTR)psz;
00644     plstr-&gt;<a class="code" href="../../d2/d9/struct__LARGE__UNICODE__STRING.html#o2">bAnsi</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00645     <span class="keywordflow">if</span> (ARGUMENT_PRESENT( psz )) {
00646         Length = wcslen( psz ) * <span class="keyword">sizeof</span>( WCHAR );
00647         plstr-&gt;<a class="code" href="../../d2/d9/struct__LARGE__UNICODE__STRING.html#o0">Length</a> = <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>(Length, cchLimit);
00648         plstr-&gt;<a class="code" href="../../d2/d9/struct__LARGE__UNICODE__STRING.html#o1">MaximumLength</a> = <a class="code" href="../../d5/d4/acpitabl_8h.html#a69">min</a>((Length + <span class="keyword">sizeof</span>(UNICODE_NULL)), cchLimit);
00649     } <span class="keywordflow">else</span> {
00650         plstr-&gt;<a class="code" href="../../d2/d9/struct__LARGE__UNICODE__STRING.html#o1">MaximumLength</a> = 0;
00651         plstr-&gt;<a class="code" href="../../d2/d9/struct__LARGE__UNICODE__STRING.html#o0">Length</a> = 0;
00652     }
00653 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="chartran.c::RtlMBMessageWParamCharToWCS" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOL RtlMBMessageWParamCharToWCS           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>msg</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>WPARAM *&nbsp;</td>
          <td class="mdname" nowrap> <em>pWParam</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/chartran_8c-source.html#l00490">490</a> of file <a class="el" href="../../d6/d5/chartran_8c-source.html">chartran.c</a>.
<p>
References <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d2/d0/bench_8c-source.html#l00050">CHAR</a>, <a class="el" href="../../d1/d4/perfuser_8c-source.html#l00052">DWORD</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d6/chartran_8c.html#a1">IS_ACP</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l00590">IS_DBCS_ENABLED</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l00581">MAKE_WPARAM_DBCSCHAR</a>, <a class="el" href="../../d3/d0/userexts_8c-source.html#l01830">msg</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d0/d6/nlsxlat_8c-source.html#l00369">RtlMultiByteToUnicodeN()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l00558">THREAD_CODEPAGE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l00566">WMCR_IR_DBCSCHAR</a>.
<p>
Referenced by <a class="el" href="../../d1/d7/ntcftxt_8h-source.html#l01460">CallMsgFilter()</a>, <a class="el" href="../../d1/d8/clmsg_8c-source.html#l01533">DispatchMessageWorker()</a>, <a class="el" href="../../d6/d8/dlgmgr2_8c-source.html#l00230">IsDialogMessageA()</a>, <a class="el" href="../../d9/d8/client_2ntstubs_8c-source.html#l01444">MESSAGECALL()</a>, <a class="el" href="../../d1/d7/ntcftxt_8h-source.html#l00427">PostMessage()</a>, <a class="el" href="../../d1/d7/ntcftxt_8h-source.html#l00481">PostThreadMessage()</a>, <a class="el" href="../../d1/d7/ntcftxt_8h-source.html#l00850">SendMessageCallback()</a>, <a class="el" href="../../d1/d8/clmsg_8c-source.html#l00270">SendMessageWorker()</a>, <a class="el" href="../../d1/d7/ntcftxt_8h-source.html#l00883">SendNotifyMessage()</a>, <a class="el" href="../../d4/d7/client_8c-source.html#l00225">TranslateAcceleratorA()</a>, and <a class="el" href="../../d6/d2/ntuser_2kernel_2input_8c-source.html#l00762">xxxDispatchMessage()</a>.
<p>
<pre class="fragment"><div>00491 {
00492     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwUni;
00493     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00494     <span class="comment">// FE_SB    (RtlMBMessageWParamCharToWCS)</span>
00495     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a11">BOOL</a>  bWmCrIrDbcsChar = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00496     WORD  wAnsi = LOWORD(*pWParam);
00497     <span class="comment">// end FE_SB    (RtlMBMessageWParamCharToWCS)</span>
00498     WORD CodePage = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a118">THREAD_CODEPAGE</a>();
00499 
00500     <span class="comment">/*</span>
00501 <span class="comment">     * Only these messages have CHARs: others are passed through</span>
00502 <span class="comment">     */</span>
00503 
00504     <span class="keywordflow">switch</span>(<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>) {
00505     <span class="comment">// FE_SB    (RtlMBMessageWParamCharToWCS)</span>
00506     <span class="keywordflow">case</span> WM_CHAR:
00507         <span class="comment">//</span>
00508         <span class="comment">// WM_CHAR's wParam format for WM_IME_REPORT:IR_DBCSCHAR</span>
00509         <span class="comment">//</span>
00510         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a125">IS_DBCS_ENABLED</a>() &amp;&amp; (*pWParam &amp; <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a119">WMCR_IR_DBCSCHAR</a>)) {
00511             <span class="comment">//</span>
00512             <span class="comment">// Mark this message is sent as IR_DBCSCHAR format.</span>
00513             <span class="comment">//</span>
00514             bWmCrIrDbcsChar = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00515         }
00516 
00517         <span class="comment">//</span>
00518         <span class="comment">// Fall through....</span>
00519         <span class="comment">//</span>
00520 <span class="preprocessor">#ifdef FE_IME</span>
00521 <span class="preprocessor"></span>    <span class="keywordflow">case</span> WM_IME_CHAR:
00522     <span class="keywordflow">case</span> WM_IME_COMPOSITION:
00523         <span class="comment">//</span>
00524         <span class="comment">// We need to re-align for Unicode convertsion..</span>
00525         <span class="comment">// WM_CHAR/WM_IME_CHAR/WM_IME_COMPOSITION's wParam format :</span>
00526         <span class="comment">//</span>
00527         <span class="comment">// ReAlign IR_DBCS char format to regular sequence.</span>
00528         <span class="comment">//</span>
00529         <span class="comment">// From:</span>
00530         <span class="comment">//</span>
00531         <span class="comment">//  HIWORD(wParam)         = 0;</span>
00532         <span class="comment">//  HIBYTE(LOWORD(wParam)) = DBCS LeadingByte.</span>
00533         <span class="comment">//  LOBYTE(LOWORD(wParan)) = DBCS TrailingByte or SBCS character.</span>
00534         <span class="comment">//</span>
00535         <span class="comment">// To:</span>
00536         <span class="comment">//  HIWORD(wParam)         = 0;</span>
00537         <span class="comment">//  HIBYTE(LOWORD(wParam)) = DBCS TrailingByte.</span>
00538         <span class="comment">//  LOBYTE(LOWORD(wParam)) = DBCS LeadingByte or SBCS character.</span>
00539         <span class="comment">//</span>
00540         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a125">IS_DBCS_ENABLED</a>()) {
00541             *pWParam = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a122">MAKE_WPARAM_DBCSCHAR</a>(wAnsi);
00542         }
00543 <span class="preprocessor">#endif</span>
00544 <span class="preprocessor"></span>        <span class="comment">//</span>
00545         <span class="comment">// Fall through...</span>
00546         <span class="comment">//</span>
00547         <span class="comment">// end FE_SB    (RtlMBMessageWParamCharToWCS)</span>
00548     <span class="keywordflow">case</span> WM_CHARTOITEM:
00549     <span class="keywordflow">case</span> EM_SETPASSWORDCHAR:
00550     <span class="keywordflow">case</span> WM_DEADCHAR:
00551     <span class="keywordflow">case</span> WM_SYSCHAR:
00552     <span class="keywordflow">case</span> WM_SYSDEADCHAR:
00553     <span class="keywordflow">case</span> WM_MENUCHAR:
00554 
00555         dwUni = 0;
00556 
00557         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/chartran_8c.html#a1">IS_ACP</a>(CodePage)) {
00558             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d6/nlsxlat_8c.html#a33">RtlMultiByteToUnicodeN</a>((LPWSTR)&amp;dwUni, <span class="keyword">sizeof</span>(dwUni),
00559                     NULL, (LPSTR)pWParam, 2 * <span class="keyword">sizeof</span>(CHAR));
00560             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status))
00561                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00562         } <span class="keywordflow">else</span> {
00563             <span class="keywordtype">int</span> cwch;
00564 <span class="preprocessor">#ifdef _USERK_</span>
00565 <span class="preprocessor"></span>            cwch = EngMultiByteToWideChar(CodePage,
00566                     (LPWSTR)&amp;dwUni, <span class="keyword">sizeof</span>(dwUni),
00567                     (LPSTR)pWParam, 2);
00568 <span class="preprocessor">#else</span>
00569 <span class="preprocessor"></span>            cwch = MultiByteToWideChar(CodePage, 0,
00570                     (LPSTR)pWParam, 2,
00571                     (LPWSTR)&amp;dwUni, <span class="keyword">sizeof</span>(dwUni) / <span class="keyword">sizeof</span>(WCHAR));
00572 <span class="preprocessor">#endif // _USERK_</span>
00573 <span class="preprocessor"></span>            <span class="comment">// KdPrint(("0x%02x -&gt; 0x%04x (%d)\n", *pWParam, dwUni, CodePage));</span>
00574             <span class="keywordflow">if</span> (cwch == 0) {
00575                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00576             }
00577         }
00578 
00579         <span class="comment">// FE_SB    (RtlMBMessageWParamCharToWCS)</span>
00580         <span class="comment">//</span>
00581         <span class="comment">// if this character is sent for WM_IME_REPORT:IR_DBCSCHAR, we mark it.</span>
00582         <span class="comment">//</span>
00583         <span class="keywordflow">if</span> (bWmCrIrDbcsChar)
00584             dwUni |= <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a119">WMCR_IR_DBCSCHAR</a>;
00585         <span class="comment">// else FE_SB (RtlMBMessageWParamCharToWCS)</span>
00586 <span class="preprocessor">#if DBG</span>
00587 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ((dwUni == 0) || (dwUni &gt; 0xFF)) {
00588             RIPMSG1(RIP_VERBOSE, <span class="stringliteral">"msgA -&gt; msgW: wchar = 0x%lX\n"</span>, dwUni);
00589         }
00590 <span class="preprocessor">#endif</span>
00591 <span class="preprocessor"></span>        <span class="comment">// end FE_SB</span>
00592         *pWParam = dwUni;
00593         <span class="keywordflow">break</span>;
00594     }
00595 
00596     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00597 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="chartran.c::RtlWCSMessageWParamCharToMB" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOL RtlWCSMessageWParamCharToMB           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>msg</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>WPARAM *&nbsp;</td>
          <td class="mdname" nowrap> <em>pWParam</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/chartran_8c-source.html#l00361">361</a> of file <a class="el" href="../../d6/d5/chartran_8c-source.html">chartran.c</a>.
<p>
References <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00057">BOOL</a>, <a class="el" href="../../d1/d4/perfuser_8c-source.html#l00052">DWORD</a>, <a class="el" href="../../d6/d8/ntrtlp_8h-source.html#l00184">HIBYTE</a>, <a class="el" href="../../d5/d6/chartran_8c.html#a1">IS_ACP</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l00590">IS_DBCS_ENABLED</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l00570">IS_DBCS_MESSAGE</a>, <a class="el" href="../../d6/d8/ntrtlp_8h-source.html#l00183">LOBYTE</a>, <a class="el" href="../../d3/d0/userexts_8c-source.html#l01830">msg</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d0/d6/nlsxlat_8c-source.html#l00905">RtlUnicodeToMultiByteN()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d1/d9/client_2nt6_2user_8h-source.html#l00558">THREAD_CODEPAGE</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d9/d8/client_2ntstubs_8c-source.html#l00556">_PeekMessage()</a>, <a class="el" href="../../d1/d8/clmsg_8c-source.html#l01533">DispatchMessageWorker()</a>, <a class="el" href="../../d1/d7/ntcftxt_8h-source.html#l00249">GetMessage()</a>, <a class="el" href="../../d1/d8/clmsg_8c-source.html#l00270">SendMessageWorker()</a>, and <a class="el" href="../../d6/d2/ntuser_2kernel_2input_8c-source.html#l00762">xxxDispatchMessage()</a>.
<p>
<pre class="fragment"><div>00362 {
00363     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a> dwAnsi;
00364     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00365     WORD CodePage;
00366     <span class="keywordtype">int</span> nbWch;
00367 
00368 <span class="preprocessor">#ifdef FE_SB // RtlWCSMessageWParamCharToMB()</span>
00369 <span class="preprocessor"></span>    <span class="comment">//</span>
00370     <span class="comment">// Format of *pWParam here...</span>
00371     <span class="comment">//</span>
00372     <span class="comment">// LOWORD(*pWParam) = Unicode CodePoint...</span>
00373     <span class="comment">// HIWORD(*pWParam) = Has some information for DBCS messaging</span>
00374     <span class="comment">//                    (ex. WPARAM_IR_DBCSCHAR)</span>
00375     <span class="comment">//</span>
00376     <span class="comment">// Then we need to convert ONLY loword of wParam to Unicode...</span>
00377     <span class="comment">//</span>
00378 <span class="preprocessor">#endif // FE_SB</span>
00379 <span class="preprocessor"></span><span class="preprocessor">#ifndef FE_SB</span>
00380 <span class="preprocessor"></span>    <span class="comment">// NtBug #3135 (Closed 02/04/93)</span>
00381     <span class="comment">// Publisher Posts WM_CHAR messages with wParam &gt; 0xFF (not a valid ANSI char)!</span>
00382     <span class="comment">//</span>
00383     <span class="comment">// It does this to disable TranslateAccelerator for that char.</span>
00384     <span class="comment">// MSPub's winproc must get the non-ANSI 'character' value, so PostMessage must</span>
00385     <span class="comment">// translate *two* characters of wParam for character messages, and PeekMessage</span>
00386     <span class="comment">// must translate *two* Unicode chars of wParam for ANSI app.</span>
00387 <span class="preprocessor">#endif</span>
00388 <span class="preprocessor"></span>
00389     <span class="comment">/*</span>
00390 <span class="comment">     * Only these messages have CHARs: others are passed through</span>
00391 <span class="comment">     */</span>
00392 
00393     <span class="keywordflow">switch</span>(<a class="code" href="../../d2/d1/userexts_8c.html#a129">msg</a>) {
00394 <span class="preprocessor">#ifdef FE_IME // RtlWCSMessageWParamCharToMB()</span>
00395 <span class="preprocessor"></span>    <span class="keywordflow">case</span> WM_IME_CHAR:
00396     <span class="keywordflow">case</span> WM_IME_COMPOSITION:
00397 <span class="preprocessor">#endif // FE_IME</span>
00398 <span class="preprocessor"></span>    <span class="keywordflow">case</span> WM_CHAR:
00399     <span class="keywordflow">case</span> WM_CHARTOITEM:
00400     <span class="keywordflow">case</span> EM_SETPASSWORDCHAR:
00401     <span class="keywordflow">case</span> WM_DEADCHAR:
00402     <span class="keywordflow">case</span> WM_SYSCHAR:
00403     <span class="keywordflow">case</span> WM_SYSDEADCHAR:
00404     <span class="keywordflow">case</span> WM_MENUCHAR:
00405 
00406         CodePage = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a118">THREAD_CODEPAGE</a>();
00407         dwAnsi = 0;
00408 
00409         nbWch = <a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a125">IS_DBCS_ENABLED</a>() ? 1 * <span class="keyword">sizeof</span>(WCHAR) : 2 * <span class="keyword">sizeof</span>(WCHAR);
00410 
00411         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/chartran_8c.html#a1">IS_ACP</a>(CodePage)) {
00412             <span class="comment">// HACK HACK HACK HACK (for NtBug #3135)</span>
00413             <span class="comment">// to allow applications that store data in high word of wParam</span>
00414             <span class="comment">// Jan/06/96 hiroyama</span>
00415             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d6/nlsxlat_8c.html#a37">RtlUnicodeToMultiByteN</a>((LPSTR)&amp;dwAnsi, <span class="keyword">sizeof</span>(dwAnsi),
00416                     NULL, (LPWSTR)pWParam, nbWch);
00417             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00418                 <span class="comment">// LATER IanJa: returning FALSE makes GetMessage fail, which</span>
00419                 <span class="comment">// terminates the app.  We should use some default 'bad character'</span>
00420                 <span class="comment">// I use 0x00 for now.</span>
00421                 *pWParam = 0x00;
00422                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00423             }
00424         } <span class="keywordflow">else</span> {
00425             <span class="keywordtype">int</span> cwch;
00426             <span class="comment">// assuming little endian</span>
00427 <span class="preprocessor">#ifdef _USERK_</span>
00428 <span class="preprocessor"></span>            cwch = EngWideCharToMultiByte(CodePage,
00429                     (LPWSTR)pWParam, nbWch,
00430                     (LPSTR)&amp;dwAnsi, <span class="keyword">sizeof</span>(dwAnsi));
00431 <span class="preprocessor">#else</span>
00432 <span class="preprocessor"></span>            cwch = WideCharToMultiByte(CodePage, 0,
00433                     (LPCWSTR)pWParam, nbWch / <span class="keyword">sizeof</span>(WCHAR),
00434                     (LPSTR)&amp;dwAnsi, <span class="keyword">sizeof</span>(dwAnsi), NULL, NULL);
00435 <span class="preprocessor">#endif // _USERK_</span>
00436 <span class="preprocessor"></span>            <span class="comment">// KdPrint(("0x%04x -&gt; 0x%02x (%d)\n", *pWParam, dwAnsi, CodePage));</span>
00437             <span class="keywordflow">if</span> (cwch == 0) {
00438                 *pWParam = 0x00;
00439                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00440             }
00441         }
00442         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a125">IS_DBCS_ENABLED</a>()) {
00443             WORD wAnsi = LOWORD(dwAnsi);
00444             <span class="comment">//</span>
00445             <span class="comment">// From:</span>
00446             <span class="comment">//   HIBYTE(wAnsi)            = Dbcs TrailingByte.</span>
00447             <span class="comment">//   LOBYTE(wAnsi)            = Dbcs LeadingByte or Sbcs character.</span>
00448             <span class="comment">//</span>
00449             <span class="comment">// To:</span>
00450             <span class="comment">//   HIWORD(*pWParam)         = Original Data (information for DBCS messgaing).</span>
00451             <span class="comment">//   HIBYTE(LOWORD(*pWParam)) = Dbcs LeadingByte Byte.</span>
00452             <span class="comment">//   LOBYTE(LOWORD(*pWParam)) = Dbcs TrailingByte or Sbcs character.</span>
00453             <span class="comment">//</span>
00454             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d0/client_2nt6_2user_8h.html#a120">IS_DBCS_MESSAGE</a>(wAnsi)) {
00455                 <span class="comment">//</span>
00456                 <span class="comment">// It's a DBCS character.</span>
00457                 <span class="comment">//</span>
00458                 *pWParam = MAKEWPARAM(MAKEWORD(<a class="code" href="../../d5/d9/ntrtlp_8h.html#a5">HIBYTE</a>(wAnsi),<a class="code" href="../../d5/d9/ntrtlp_8h.html#a4">LOBYTE</a>(wAnsi)),HIWORD(*pWParam));
00459             } <span class="keywordflow">else</span> {
00460                 <span class="comment">//</span>
00461                 <span class="comment">// It's a SBCS character.</span>
00462                 <span class="comment">//</span>
00463                 *pWParam = MAKEWPARAM(MAKEWORD(<a class="code" href="../../d5/d9/ntrtlp_8h.html#a4">LOBYTE</a>(wAnsi),0),0);
00464             }
00465         } <span class="keywordflow">else</span> {
00466 <span class="preprocessor">#if DBG</span>
00467 <span class="preprocessor"></span>            <span class="keywordflow">if</span> ((dwAnsi == 0) || (dwAnsi &gt; 0xFF)) {
00468                 RIPMSG1(RIP_VERBOSE, <span class="stringliteral">"msgW -&gt; msgA: char = 0x%.4lX\n"</span>, dwAnsi);
00469             }
00470 <span class="preprocessor">#endif</span>
00471 <span class="preprocessor"></span>            *pWParam = dwAnsi;
00472         }
00473         <span class="keywordflow">break</span>;
00474     }
00475 
00476     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00477 }
</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:43:03 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
