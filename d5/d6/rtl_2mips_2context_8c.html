<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: rtl/mips/context.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>context.c File Reference</h1><code>#include &lt;<a class="el" href="../../d0/d8/ntos_8h-source.html">ntos.h</a>&gt;</code><br>

<p>
<a href="../../d6/d5/rtl_2mips_2context_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/rtl_2mips_2context_8c.html#a0">RtlInitializeContext</a> (IN HANDLE Process, OUT PCONTEXT Context, IN PVOID Parameter OPTIONAL, IN PVOID InitialPc OPTIONAL, IN PVOID InitialSp OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/rtl_2mips_2context_8c.html#a1">RtlRemoteCall</a> (HANDLE Process, HANDLE Thread, PVOID CallSite, ULONG ArgumentCount, PULONG Arguments, BOOLEAN PassContext, BOOLEAN AlreadySuspended)</td></tr>

</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a0" doxytag="rtl/mips/context.c::RtlInitializeContext" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID RtlInitializeContext           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>Process</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PCONTEXT&nbsp;</td>
          <td class="mdname" nowrap> <em>Context</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID Parameter&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID InitialPc&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID InitialSp&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/rtl_2mips_2context_8c-source.html#l00028">28</a> of file <a class="el" href="../../d6/d5/rtl_2mips_2context_8c-source.html">rtl/mips/context.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00239">CONTEXT_FULL</a>, and <a class="el" href="../../d0/d9/ppc_2exdsptch_8c-source.html#l00563">RtlRaiseStatus()</a>.
<p>
<pre class="fragment"><div>00038                    :
00039 
00040     This function initializes a context structure so that <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> can be used in
00041     a subsequent call to <a class="code" href="../../d2/d8/ps_2create_8c.html#a10">NtCreateThread</a>.
00042 
00043 Arguments:
00044 
00045     Context - Supplies a pointer to a context record that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be initialized.
00046 
00047     InitialPc - Supplies an initial program counter value.
00048 
00049     InitialSp - Supplies an initial stack pointer value.
00050 
00051 Return Value:
00052 
00053     Raises STATUS_BAD_INITIAL_STACK <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value of InitialSp <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not properly
00054            aligned.
00055 
00056     Raises STATUS_BAD_INITIAL_PC <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> value of InitialPc <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not properly
00057            aligned.
00058 
00059 --*/
00060 
00061 {
00062 
00063     <span class="comment">//</span>
00064     <span class="comment">// Check for proper initial stack and PC alignment.</span>
00065     <span class="comment">//</span>
00066 
00067     <span class="keywordflow">if</span> (((ULONG)InitialSp &amp; 0x7) != 0) {
00068         <a class="code" href="../../d9/d9/ppc_2exdsptch_8c.html#a10">RtlRaiseStatus</a>(STATUS_BAD_INITIAL_STACK);
00069     }
00070     <span class="keywordflow">if</span> (((ULONG)InitialPc &amp; 0x3) != 0) {
00071         <a class="code" href="../../d9/d9/ppc_2exdsptch_8c.html#a10">RtlRaiseStatus</a>(STATUS_BAD_INITIAL_PC);
00072     }
00073 
00074     <span class="comment">//</span>
00075     <span class="comment">// Initialize the integer registers to contain their register number.</span>
00076     <span class="comment">//</span>
00077 
00078     Context-&gt;XIntZero = 0;
00079     Context-&gt;XIntAt = 1;
00080     Context-&gt;XIntV0 = 2;
00081     Context-&gt;XIntV1 = 3;
00082     Context-&gt;XIntA0 = 4;
00083     Context-&gt;XIntA1 = 5;
00084     Context-&gt;XIntA2 = 6;
00085     Context-&gt;XIntA3 = 7;
00086     Context-&gt;XIntT0 = 8;
00087     Context-&gt;XIntT1 = 9;
00088     Context-&gt;XIntT2 = 10;
00089     Context-&gt;XIntT3 = 11;
00090     Context-&gt;XIntT4 = 12;
00091     Context-&gt;XIntT5 = 13;
00092     Context-&gt;XIntT6 = 14;
00093     Context-&gt;XIntT7 = 15;
00094     Context-&gt;XIntS0 = 16;
00095     Context-&gt;XIntS1 = 17;
00096     Context-&gt;XIntS2 = 18;
00097     Context-&gt;XIntS3 = 19;
00098     Context-&gt;XIntS4 = 20;
00099     Context-&gt;XIntS5 = 21;
00100     Context-&gt;XIntS6 = 22;
00101     Context-&gt;XIntS7 = 23;
00102     Context-&gt;XIntT8 = 24;
00103     Context-&gt;XIntT9 = 25;
00104     Context-&gt;XIntS8 = 30;
00105     Context-&gt;XIntLo = 0;
00106     Context-&gt;XIntHi = 0;
00107 
00108     <span class="comment">//</span>
00109     <span class="comment">// Initialize the floating point registers to contain zero in their upper</span>
00110     <span class="comment">// half and the integer value of their register number in the lower half.</span>
00111     <span class="comment">//</span>
00112 
00113     Context-&gt;FltF0 = 0;
00114     Context-&gt;FltF1 = 0;
00115     Context-&gt;FltF2 = 2;
00116     Context-&gt;FltF3 = 0;
00117     Context-&gt;FltF4 = 4;
00118     Context-&gt;FltF5 = 0;
00119     Context-&gt;FltF6 = 6;
00120     Context-&gt;FltF7 = 0;
00121     Context-&gt;FltF8 = 8;
00122     Context-&gt;FltF9 = 0;
00123     Context-&gt;FltF10 = 10;
00124     Context-&gt;FltF11 = 0;
00125     Context-&gt;FltF12 = 12;
00126     Context-&gt;FltF13 = 0;
00127     Context-&gt;FltF14 = 14;
00128     Context-&gt;FltF15 = 0;
00129     Context-&gt;FltF16 = 16;
00130     Context-&gt;FltF17 = 0;
00131     Context-&gt;FltF18 = 18;
00132     Context-&gt;FltF19 = 0;
00133     Context-&gt;FltF20 = 20;
00134     Context-&gt;FltF21 = 0;
00135     Context-&gt;FltF22 = 22;
00136     Context-&gt;FltF23 = 0;
00137     Context-&gt;FltF24 = 24;
00138     Context-&gt;FltF25 = 0;
00139     Context-&gt;FltF26 = 26;
00140     Context-&gt;FltF27 = 0;
00141     Context-&gt;FltF28 = 28;
00142     Context-&gt;FltF29 = 0;
00143     Context-&gt;FltF30 = 30;
00144     Context-&gt;FltF31 = 0;
00145     Context-&gt;Fsr = 0;
00146 
00147     <span class="comment">//</span>
00148     <span class="comment">// Initialize the control registers.</span>
00149     <span class="comment">//</span>
00150     <span class="comment">// N.B. The register gp is estabished at thread startup by the loader.</span>
00151     <span class="comment">//</span>
00152 
00153     Context-&gt;XIntGp = 0;
00154     Context-&gt;XIntSp = (LONG)InitialSp;
00155     Context-&gt;XIntRa = 1;
00156     Context-&gt;Fir = (ULONG)InitialPc;
00157     Context-&gt;Psr = 0;
00158     Context-&gt;ContextFlags = <a class="code" href="../../d6/d7/halmips_8h.html#a152">CONTEXT_FULL</a>;
00159 
00160     <span class="comment">//</span>
00161     <span class="comment">// Set the initial context of the thread in a machine specific way.</span>
00162     <span class="comment">//</span>
00163 
00164     Context-&gt;XIntA0 = (LONG)Parameter;
00165     Context-&gt;XIntSp -= KTRAP_FRAME_ARGUMENTS;
00166 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="rtl/mips/context.c::RtlRemoteCall" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS RtlRemoteCall           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>Process</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>HANDLE&nbsp;</td>
          <td class="mdname" nowrap> <em>Thread</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>CallSite</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ArgumentCount</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Arguments</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>PassContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>AlreadySuspended</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/rtl_2mips_2context_8c-source.html#l00169">169</a> of file <a class="el" href="../../d6/d5/rtl_2mips_2context_8c-source.html">rtl/mips/context.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00239">CONTEXT_FULL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d3/d9/psctx_8c-source.html#l00151">NtGetContextThread()</a>, <a class="el" href="../../d2/d1/psspnd_8c-source.html#l00138">NtResumeThread()</a>, <a class="el" href="../../d3/d9/psctx_8c-source.html#l00352">NtSetContextThread()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d2/d1/psspnd_8c-source.html#l00033">NtSuspendThread()</a>, <a class="el" href="../../d0/d5/readwrt_8c-source.html#l00231">NtWriteVirtualMemory()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
<pre class="fragment"><div>00181                    :
00182 
00183     This function calls a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a> in another thread/process,  by <span class="keyword">using</span>
00184     NtGetContext and NtSetContext. Parameters are passed to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target
00185     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a> via <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> nonvolatile registers (s0 - s7).
00186 
00187 Arguments:
00188 
00189     Process - Supplies an open handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target process.
00190 
00191     Thread - Supplies an open handle to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target thread within <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target
00192         process.
00193 
00194     CallSize - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a> to call in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target
00195         process.
00196 
00197     ArgumentCount - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of 32 bit parameters to pass to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00198         target <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a>.
00199 
00200     Arguments - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> array of 32 bit parameters to pass.
00201 
00202     PassContext - Supplies a <span class="keywordtype">boolean</span> value that determines whether a parameter
00203         <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be passed that points to a context record. This parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00204         ignored on MIPS hosts.
00205 
00206     AlreadySuspended - Supplies a <span class="keywordtype">boolean</span> value that determines whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00207         target thread <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> already in a suspended or waiting state.
00208 
00209 Return Value:
00210 
00211     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> - <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> value
00212 
00213 --*/
00214 
00215 {
00216 
00217     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00218     CONTEXT Context;
00219     ULONG NewSp;
00220 
00221     <span class="keywordflow">if</span> (ArgumentCount &gt; 8) {
00222         <span class="keywordflow">return</span>(STATUS_INVALID_PARAMETER);
00223     }
00224 
00225     <span class="comment">//</span>
00226     <span class="comment">// If necessary, suspend the target thread before getting the thread's</span>
00227     <span class="comment">// current state.</span>
00228     <span class="comment">//</span>
00229 
00230     <span class="keywordflow">if</span> (AlreadySuspended == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00231         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d2/psspnd_8c.html#a0">NtSuspendThread</a>(Thread, NULL);
00232         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00233             <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
00234         }
00235     }
00236 
00237     <span class="comment">//</span>
00238     <span class="comment">// Get the cuurent state of the target thread.</span>
00239     <span class="comment">//</span>
00240 
00241     Context.ContextFlags = <a class="code" href="../../d6/d7/halmips_8h.html#a152">CONTEXT_FULL</a>;
00242     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d0/psctx_8c.html#a2">NtGetContextThread</a>(Thread, &amp;Context);
00243     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00244         <span class="keywordflow">if</span> (AlreadySuspended == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00245             <a class="code" href="../../d1/d2/psspnd_8c.html#a1">NtResumeThread</a>(Thread, NULL);
00246         }
00247 
00248         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00249     }
00250 
00251     <span class="keywordflow">if</span> (AlreadySuspended) {
00252         Context.XIntV0 = (LONG)STATUS_ALERTED;
00253     }
00254 
00255     <span class="comment">//</span>
00256     <span class="comment">// Pass the parameters to the other thread via the non-volatile registers</span>
00257     <span class="comment">// s0 - s7. The context record is passed on the stack of the target thread.</span>
00258     <span class="comment">//</span>
00259 
00260     NewSp = (ULONG)(Context.XIntSp - <span class="keyword">sizeof</span>(CONTEXT));
00261     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d5/readwrt_8c.html#a10">NtWriteVirtualMemory</a>(Process,
00262                                   (PVOID)NewSp,
00263                                   &amp;Context,
00264                                   <span class="keyword">sizeof</span>(CONTEXT),
00265                                   NULL);
00266 
00267     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00268         <span class="keywordflow">if</span> (AlreadySuspended == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00269             <a class="code" href="../../d1/d2/psspnd_8c.html#a1">NtResumeThread</a>(Thread, NULL);
00270         }
00271 
00272         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00273     }
00274 
00275     Context.XIntSp = (LONG)NewSp;
00276     <span class="keywordflow">if</span> (PassContext) {
00277         Context.XIntS0 = (LONG)NewSp;
00278         RtlMoveMemory(&amp;Context.XIntS1, Arguments, ArgumentCount * <span class="keyword">sizeof</span>(ULONG));
00279 
00280     } <span class="keywordflow">else</span> {
00281         RtlMoveMemory(&amp;Context.XIntS0, Arguments, ArgumentCount * <span class="keyword">sizeof</span>(ULONG));
00282     }
00283 
00284     <span class="comment">//</span>
00285     <span class="comment">// Set the address of the target code into FIR and set the thread context</span>
00286     <span class="comment">// to cause the target procedure to be executed.</span>
00287     <span class="comment">//</span>
00288 
00289     Context.Fir = (ULONG)CallSite;;
00290     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d0/psctx_8c.html#a3">NtSetContextThread</a>(Thread, &amp;Context);
00291     <span class="keywordflow">if</span> (AlreadySuspended == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00292         <a class="code" href="../../d1/d2/psspnd_8c.html#a1">NtResumeThread</a>(Thread, NULL);
00293     }
00294 
00295     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00296 }
}
</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:43:16 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
