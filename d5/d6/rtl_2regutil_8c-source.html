<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: regutil.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>regutil.c</h1><a href="../../d4/d7/rtl_2regutil_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1990  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    regutil.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This file contains support routines for accessing the registry.</span>
00012 <span class="comment"></span>
00013 <span class="comment">Author:</span>
00014 <span class="comment"></span>
00015 <span class="comment">    Steve Wood (stevewo) 15-Apr-1992</span>
00016 <span class="comment"></span>
00017 <span class="comment">Revision History:</span>
00018 <span class="comment"></span>
00019 <span class="comment">--*/</span>
00020 
00021 <span class="preprocessor">#include "<a class="code" href="../../d5/d9/ntrtlp_8h.html">ntrtlp.h</a>"</span>
00022 <span class="preprocessor">#include &lt;ctype.h&gt;</span>
00023 
00024 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00025 <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a13">RtlpGetRegistryHandle</a>(
00026     IN ULONG RelativeTo,
00027     IN PCWSTR KeyName,
00028     IN BOOLEAN WriteAccess,
00029     OUT PHANDLE Key
00030     );
00031 
00032 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00033 <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a14">RtlpQueryRegistryDirect</a>(
00034     IN ULONG ValueType,
00035     IN PVOID ValueData,
00036     IN ULONG ValueLength,
00037     IN OUT PVOID Destination
00038     );
00039 
00040 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00041 <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a15">RtlpCallQueryRegistryRoutine</a>(
00042     IN PRTL_QUERY_REGISTRY_TABLE QueryTable,
00043     IN PKEY_VALUE_FULL_INFORMATION KeyValueInformation,
00044     IN OUT PULONG PKeyValueInfoLength,
00045     IN PVOID Context,
00046     IN PVOID Environment OPTIONAL
00047     );
00048 
00049 PVOID
00050 <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a16">RtlpAllocDeallocQueryBuffer</a>(
00051    IN OUT SIZE_T    *PAllocLength            OPTIONAL,
00052    IN     PVOID      OldKeyValueInformation  OPTIONAL,
00053    IN     SIZE_T     OldAllocLength          OPTIONAL,
00054       OUT NTSTATUS  *pStatus                 OPTIONAL
00055     );
00056 
00057 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00058 <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a17">RtlpInitCurrentUserString</a>(
00059     OUT PUNICODE_STRING UserString
00060     );
00061 
00062 
00063 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00064 <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a18">RtlpGetTimeZoneInfoHandle</a>(
00065     IN BOOLEAN WriteAccess,
00066     OUT PHANDLE Key
00067     );
00068 
00069 <span class="preprocessor">#if defined(ALLOC_PRAGMA) &amp;&amp; defined(NTOS_KERNEL_RUNTIME)</span>
00070 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,RtlpGetRegistryHandle)</span>
00071 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,RtlpQueryRegistryDirect)</span>
00072 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,RtlpCallQueryRegistryRoutine)</span>
00073 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,RtlpAllocDeallocQueryBuffer)</span>
00074 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,RtlQueryRegistryValues)</span>
00075 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,RtlWriteRegistryValue)</span>
00076 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,RtlCheckRegistryKey)</span>
00077 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,RtlCreateRegistryKey)</span>
00078 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,RtlDeleteRegistryValue)</span>
00079 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,RtlExpandEnvironmentStrings_U)</span>
00080 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,RtlGetNtGlobalFlags)</span>
00081 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,RtlpInitCurrentUserString)</span>
00082 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,RtlOpenCurrentUser)</span>
00083 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,RtlpGetTimeZoneInfoHandle)</span>
00084 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,RtlQueryTimeZoneInformation)</span>
00085 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,RtlSetTimeZoneInformation)</span>
00086 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,RtlSetActiveTimeBias)</span>
00087 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00088 <span class="preprocessor"></span>
<a name="l00089"></a><a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a4">00089</a> <span class="keyword">extern</span>  <span class="keyword">const</span> PWSTR <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a4">RtlpRegistryPaths</a>[ RTL_REGISTRY_MAXIMUM ];
00090 
00091 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00092"></a><a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a13">00092</a> <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a13">RtlpGetRegistryHandle</a>(
00093     IN ULONG RelativeTo,
00094     IN PCWSTR KeyName,
00095     IN BOOLEAN WriteAccess,
00096     OUT PHANDLE Key
00097     )
00098 {
00099     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00100     OBJECT_ATTRIBUTES <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>;
00101     WCHAR <a class="code" href="../../d2/d2/rtload_8c.html#a2">KeyPathBuffer</a>[ MAXIMUM_FILENAME_LENGTH+6 ];
00102     UNICODE_STRING <a class="code" href="../../d8/d0/rtbatcr_8c.html#a2">KeyPath</a>;
00103     UNICODE_STRING CurrentUserKeyPath;
00104     BOOLEAN OptionalPath;
00105 
00106     <span class="keywordflow">if</span> (RelativeTo &amp; RTL_REGISTRY_HANDLE) {
00107         *<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a> = (HANDLE)<a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>;
00108         <span class="keywordflow">return</span> STATUS_SUCCESS;
00109     }
00110 
00111     <span class="keywordflow">if</span> (RelativeTo &amp; RTL_REGISTRY_OPTIONAL) {
00112         RelativeTo &amp;= ~RTL_REGISTRY_OPTIONAL;
00113         OptionalPath = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00114     } <span class="keywordflow">else</span> {
00115         OptionalPath = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00116     }
00117 
00118     <span class="keywordflow">if</span> (RelativeTo &gt;= RTL_REGISTRY_MAXIMUM) {
00119         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00120     }
00121 
00122     <a class="code" href="../../d8/d0/rtbatcr_8c.html#a2">KeyPath</a>.Buffer = <a class="code" href="../../d2/d2/rtload_8c.html#a2">KeyPathBuffer</a>;
00123     <a class="code" href="../../d8/d0/rtbatcr_8c.html#a2">KeyPath</a>.Length = 0;
00124     <a class="code" href="../../d8/d0/rtbatcr_8c.html#a2">KeyPath</a>.MaximumLength = <span class="keyword">sizeof</span>( <a class="code" href="../../d2/d2/rtload_8c.html#a2">KeyPathBuffer</a> );
00125     <span class="keywordflow">if</span> (RelativeTo != RTL_REGISTRY_ABSOLUTE) {
00126         <span class="keywordflow">if</span> (RelativeTo == RTL_REGISTRY_USER &amp;&amp;
00127             <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a26">RtlFormatCurrentUserKeyPath</a>( &amp;CurrentUserKeyPath ) )
00128            ) {
00129             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d6/nls_8c.html#a46">RtlAppendUnicodeStringToString</a>( &amp;<a class="code" href="../../d8/d0/rtbatcr_8c.html#a2">KeyPath</a>, &amp;CurrentUserKeyPath );
00130             <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;CurrentUserKeyPath );
00131         } <span class="keywordflow">else</span> {
00132             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>( &amp;<a class="code" href="../../d8/d0/rtbatcr_8c.html#a2">KeyPath</a>, <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a4">RtlpRegistryPaths</a>[ RelativeTo ] );
00133         }
00134 
00135         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00136             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00137         }
00138 
00139         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>( &amp;<a class="code" href="../../d8/d0/rtbatcr_8c.html#a2">KeyPath</a>, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\"</span> );
00140         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00141             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00142         }
00143     }
00144 
00145     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>( &amp;<a class="code" href="../../d8/d0/rtbatcr_8c.html#a2">KeyPath</a>, <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a> );
00146     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00147         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00148     }
00149 
00150 
00151     InitializeObjectAttributes( &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00152                                 &amp;<a class="code" href="../../d8/d0/rtbatcr_8c.html#a2">KeyPath</a>,
00153                                 OBJ_CASE_INSENSITIVE,
00154                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00155                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00156                               );
00157 <span class="preprocessor">#ifdef NTOS_KERNEL_RUNTIME</span>
00158 <span class="preprocessor"></span>    <span class="comment">//</span>
00159     <span class="comment">// Use a kernel-mode handle for the registry key to prevent</span>
00160     <span class="comment">// malicious apps from hijacking it.</span>
00161     <span class="comment">//</span>
00162     <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>.Attributes |= OBJ_KERNEL_HANDLE;
00163 <span class="preprocessor">#endif</span>
00164 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (WriteAccess) {
00165         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwCreateKey( <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>,
00166                               GENERIC_WRITE,
00167                               &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00168                               0,
00169                               (PUNICODE_STRING) <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00170                               0,
00171                               <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00172                             );
00173     } <span class="keywordflow">else</span> {
00174         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwOpenKey( <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>,
00175                             MAXIMUM_ALLOWED | GENERIC_READ,
00176                             &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>
00177                           );
00178     }
00179 
00180     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00181 }
00182 
00183 <span class="comment">//</span>
00184 <span class="comment">// This is the maximum MaximumLength for a UNICODE_STRING.</span>
00185 <span class="comment">//</span>
<a name="l00186"></a><a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a0">00186</a> <span class="preprocessor">#define MAX_USTRING ( sizeof(WCHAR) * (MAXUSHORT/sizeof(WCHAR)) )</span>
00187 <span class="preprocessor"></span>
00188 <span class="comment">//</span>
00189 <span class="comment">// This is the maximum MaximumLength for a UNICODE_STRING that still leaves</span>
00190 <span class="comment">// room for a UNICODE_NULL.</span>
00191 <span class="comment">//</span>
<a name="l00192"></a><a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a1">00192</a> <span class="preprocessor">#define MAX_NONNULL_USTRING ( MAX_USTRING - sizeof(UNICODE_NULL) )</span>
00193 <span class="preprocessor"></span>
00194 <span class="comment">//</span>
00195 <span class="comment">// Return a registry value for RTL_QUERY_REGISTRY_DIRECT.</span>
00196 <span class="comment">// For string values, ValueLength includes the UNICODE_NULL.</span>
00197 <span class="comment">// Truncate string values if they don't fit within a UNICODE_STRING.</span>
00198 <span class="comment">//</span>
00199 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00200"></a><a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a14">00200</a> <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a14">RtlpQueryRegistryDirect</a>(
00201     IN ULONG ValueType,
00202     IN PVOID ValueData,
00203     IN ULONG ValueLength,
00204     IN OUT PVOID Destination
00205     )
00206 {
00207 
00208     <span class="keywordflow">if</span> (ValueType == REG_SZ ||
00209         ValueType == REG_EXPAND_SZ ||
00210         ValueType == REG_MULTI_SZ
00211        ) {
00212         PUNICODE_STRING DestinationString;
00213         <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> TruncValueLength;
00214 
00215         <span class="comment">//</span>
00216         <span class="comment">// Truncate ValueLength to be represented in a UNICODE_STRING</span>
00217         <span class="comment">//</span>
00218         <span class="keywordflow">if</span> ( ValueLength &lt;= <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a0">MAX_USTRING</a> ) {
00219             TruncValueLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)ValueLength;
00220         } <span class="keywordflow">else</span> {
00221             TruncValueLength = <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a0">MAX_USTRING</a>;
00222 
00223 <span class="comment">//davepr: move all this stuff to debug builds at some point.</span>
00224 <span class="comment">//davepr: but for now, I'd like to identify whether there are components</span>
00225 <span class="comment">//davepr: that are seeing silent failures.</span>
00226 <span class="comment">//#if DBG</span>
00227             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"RtlpQueryRegistryDirect: truncating SZ Value length: %x -&gt; %x\n"</span>,
00228                      ValueLength, TruncValueLength);
00229 <span class="comment">//#endif //DBG</span>
00230         }
00231 
00232         DestinationString = (PUNICODE_STRING)Destination;
00233         <span class="keywordflow">if</span> (DestinationString-&gt;Buffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00234 
00235             DestinationString-&gt;Buffer = <a class="code" href="../../d2/d2/ex_2pool_8c.html#a49">RtlAllocateStringRoutine</a>( TruncValueLength );
00236             <span class="keywordflow">if</span> (!DestinationString-&gt;Buffer) {
00237                 <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00238             }
00239             DestinationString-&gt;MaximumLength = TruncValueLength;
00240         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (TruncValueLength &gt; DestinationString-&gt;MaximumLength) {
00241                 <span class="keywordflow">return</span> STATUS_BUFFER_TOO_SMALL;
00242         }
00243 
00244         RtlCopyMemory( DestinationString-&gt;Buffer, ValueData, TruncValueLength );
00245         DestinationString-&gt;Length = (TruncValueLength - <span class="keyword">sizeof</span>(UNICODE_NULL));
00246 
00247     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ValueLength &lt;= <span class="keyword">sizeof</span>( ULONG )) {
00248         RtlCopyMemory( Destination, ValueData, ValueLength );
00249 
00250     } <span class="keywordflow">else</span> {
00251         PULONG DestinationLength;
00252 
00253         DestinationLength = (PULONG)Destination;
00254         <span class="keywordflow">if</span> ((LONG)*DestinationLength &lt; 0) {
00255             ULONG <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a> = -(LONG)*DestinationLength;
00256 
00257             <span class="keywordflow">if</span> (<a class="code" href="../../d7/d0/exts_8h.html#a0">n</a> &lt; ValueLength) {
00258                 <span class="keywordflow">return</span> STATUS_BUFFER_TOO_SMALL;
00259             }
00260             RtlCopyMemory( DestinationLength, ValueData, ValueLength );
00261 
00262         } <span class="keywordflow">else</span> {
00263             <span class="keywordflow">if</span> (*DestinationLength &lt; (2 * <span class="keyword">sizeof</span>(*DestinationLength) + ValueLength)) {
00264                 <span class="keywordflow">return</span> STATUS_BUFFER_TOO_SMALL;
00265             }
00266 
00267             *DestinationLength++ = ValueLength;
00268             *DestinationLength++ = ValueType;
00269             RtlCopyMemory( DestinationLength, ValueData, ValueLength );
00270         }
00271     }
00272 
00273     <span class="keywordflow">return</span> STATUS_SUCCESS;
00274 }
00275 
<a name="l00276"></a><a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a2">00276</a> <span class="preprocessor">#define QuadAlignPtr(P) (             \</span>
00277 <span class="preprocessor">    (PVOID)((((ULONG_PTR)(P)) + 7) &amp; (-8)) \</span>
00278 <span class="preprocessor">)</span>
00279 <span class="preprocessor"></span>
00280 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00281"></a><a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a15">00281</a> <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a15">RtlpCallQueryRegistryRoutine</a>(
00282     IN PRTL_QUERY_REGISTRY_TABLE QueryTable,
00283     IN PKEY_VALUE_FULL_INFORMATION KeyValueInformation,
00284     IN OUT PULONG PKeyValueInfoLength,
00285     IN PVOID Context,
00286     IN PVOID Environment OPTIONAL
00287     )
00288 
00289 <span class="comment">/*++</span>
00290 <span class="comment"></span>
00291 <span class="comment">Routine Description:</span>
00292 <span class="comment"></span>
00293 <span class="comment">    This function implements the caller out the a caller specified</span>
00294 <span class="comment">    routine.  It is reponsible for capturing the arguments for the</span>
00295 <span class="comment">    routine and then calling it.  If not specifically disabled, this</span>
00296 <span class="comment">    routine will converted REG_EXPAND_SZ Registry values to REG_SZ by</span>
00297 <span class="comment">    calling RtlExpandEnvironmentStrings_U prior to calling the routine.</span>
00298 <span class="comment">    It will also converted REG_MULTI_SZ registry values into multiple</span>
00299 <span class="comment">    REG_SZ calls to the specified routine.</span>
00300 <span class="comment"></span>
00301 <span class="comment">    N.B. UNICODE_STRINGs cannot handle strings exceeding MAX_USTRING bytes. This creates</span>
00302 <span class="comment">    issues both for expansion and for returning queries.  Whenever this limitation</span>
00303 <span class="comment">    is a encountered, we punt as best we can -- often returning an unexpanded, or perhaps</span>
00304 <span class="comment">    truncated stream -- since this seems to create fewer problems for our callers than</span>
00305 <span class="comment">    if we unexpectedly fail.</span>
00306 <span class="comment"></span>
00307 <span class="comment">Arguments:</span>
00308 <span class="comment"></span>
00309 <span class="comment">    QueryTable - specifies the current query table entry.</span>
00310 <span class="comment"></span>
00311 <span class="comment">    KeyValueInformation - points to a buffer that contains the information</span>
00312 <span class="comment">        about the current registry value.</span>
00313 <span class="comment"></span>
00314 <span class="comment">    PKeyValueInfoLength - pointer to the maximum length of the KeyValueInformation</span>
00315 <span class="comment">        buffer.  This function will use the</span>
00316 <span class="comment">        unused portion at the end of this buffer for storing null terminated</span>
00317 <span class="comment">        value name strings and the expanded version of REG_EXPAND_SZ values.</span>
00318 <span class="comment">        PKeyValueInfoLength returns an estimate of the space required if</span>
00319 <span class="comment">        STATUS_BUFFER_TOO_SMALL is returned.  This estimate can be used to retry</span>
00320 <span class="comment">        with a larger buffer. Two retries may be required if REG_EXPAND_SZ is specified.</span>
00321 <span class="comment"></span>
00322 <span class="comment">    Context - specifies a 32-bit quantity that is passed uninterpreted to</span>
00323 <span class="comment">        each QueryRoutine called.</span>
00324 <span class="comment"></span>
00325 <span class="comment">    Environment - optional parameter, that if specified is the environment</span>
00326 <span class="comment">        used when expanding variable values in REG_EXPAND_SZ registry</span>
00327 <span class="comment">        values.</span>
00328 <span class="comment"></span>
00329 <span class="comment">Return Value:</span>
00330 <span class="comment"></span>
00331 <span class="comment">    Status of the operation.</span>
00332 <span class="comment"></span>
00333 <span class="comment">--*/</span>
00334 {
00335     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00336     ULONG ValueType;
00337     PWSTR <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>;
00338     PVOID ValueData;
00339     ULONG ValueLength;
00340     PWSTR s;
00341     PCHAR FreeMem;
00342     PCHAR EndFreeMem;
00343     LONG  FreeMemSize;
00344     ULONG KeyValueInfoLength;
00345     <span class="keywordtype">int</span>   retries;
00346 
00347 
00348     <span class="comment">//</span>
00349     <span class="comment">// Return 0 length unless we return STATUS_BUFFER_TOO_SMALL.</span>
00350     <span class="comment">//</span>
00351     KeyValueInfoLength = *PKeyValueInfoLength;
00352     *PKeyValueInfoLength = 0;
00353 
00354     <span class="comment">//</span>
00355     <span class="comment">// Initially assume the entire KeyValueInformation buffer is unused.</span>
00356     <span class="comment">//</span>
00357 
00358     FreeMem = (PCHAR)KeyValueInformation;
00359     FreeMemSize = KeyValueInfoLength;
00360     EndFreeMem = FreeMem + FreeMemSize;
00361 
00362     <span class="keywordflow">if</span> (KeyValueInformation-&gt;Type == REG_NONE ||
00363         (KeyValueInformation-&gt;DataLength == 0 &amp;&amp;
00364          KeyValueInformation-&gt;Type == QueryTable-&gt;DefaultType)
00365        ) {
00366 
00367         <span class="comment">//</span>
00368         <span class="comment">// If there is no registry value then see if they want to default</span>
00369         <span class="comment">// this value.</span>
00370         <span class="comment">//</span>
00371         <span class="keywordflow">if</span> (QueryTable-&gt;DefaultType == REG_NONE) {
00372             <span class="comment">//</span>
00373             <span class="comment">// No default value specified.  Return success unless this is</span>
00374             <span class="comment">// a required value.</span>
00375             <span class="comment">//</span>
00376             <span class="keywordflow">if</span> ( QueryTable-&gt;Flags &amp; RTL_QUERY_REGISTRY_REQUIRED ) {
00377                <span class="keywordflow">return</span> STATUS_OBJECT_NAME_NOT_FOUND;
00378             } <span class="keywordflow">else</span> {
00379                <span class="keywordflow">return</span> STATUS_SUCCESS;
00380             }
00381         }
00382 
00383         <span class="comment">//</span>
00384         <span class="comment">// Default requested.  Setup the value data pointers from the</span>
00385         <span class="comment">// information in the table entry.</span>
00386         <span class="comment">//</span>
00387 
00388         <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a> = QueryTable-&gt;Name,
00389         ValueType = QueryTable-&gt;DefaultType;
00390         ValueData = QueryTable-&gt;DefaultData;
00391         ValueLength = QueryTable-&gt;DefaultLength;
00392         <span class="keywordflow">if</span> (ValueLength == 0) {
00393             <span class="comment">//</span>
00394             <span class="comment">// If the length of the value is zero, then calculate the</span>
00395             <span class="comment">// actual length for REG_SZ, REG_EXPAND_SZ and REG_MULTI_SZ</span>
00396             <span class="comment">// value types.</span>
00397             <span class="comment">//</span>
00398 
00399             s = (PWSTR)ValueData;
00400             <span class="keywordflow">if</span> (ValueType == REG_SZ || ValueType == REG_EXPAND_SZ) {
00401                 <span class="keywordflow">while</span> (*s++ != UNICODE_NULL) {
00402                 }
00403                 ValueLength = (ULONG)((PCHAR)s - (PCHAR)ValueData);
00404 
00405             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ValueType == REG_MULTI_SZ) {
00406                 <span class="keywordflow">while</span> (*s != UNICODE_NULL) {
00407                     <span class="keywordflow">while</span> (*s++ != UNICODE_NULL) {
00408                         }
00409                     }
00410                 ValueLength = (ULONG)((PCHAR)s - (PCHAR)ValueData) + <span class="keyword">sizeof</span>( UNICODE_NULL );
00411             }
00412         }
00413 
00414     } <span class="keywordflow">else</span> {
00415         <span class="keywordflow">if</span> (!(QueryTable-&gt;Flags &amp; RTL_QUERY_REGISTRY_DIRECT)) {
00416             LONG ValueSpaceNeeded;
00417 
00418             <span class="comment">//</span>
00419             <span class="comment">// There is a registry value.  Calculate a pointer to the</span>
00420             <span class="comment">// free memory at the end of the value information buffer,</span>
00421             <span class="comment">// and its size.</span>
00422             <span class="comment">//</span>
00423             <span class="keywordflow">if</span> (KeyValueInformation-&gt;DataLength) {
00424                 FreeMem += KeyValueInformation-&gt;DataOffset +
00425                            KeyValueInformation-&gt;DataLength;
00426             } <span class="keywordflow">else</span> {
00427                 FreeMem += FIELD_OFFSET(KEY_VALUE_FULL_INFORMATION, <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>) +
00428                            KeyValueInformation-&gt;NameLength;
00429             }
00430             FreeMem = (PCHAR)<a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a2">QuadAlignPtr</a>(FreeMem);
00431             FreeMemSize = (ULONG) (EndFreeMem - FreeMem);
00432 
00433             <span class="comment">//</span>
00434             <span class="comment">// See if there is room in the free memory area for a null</span>
00435             <span class="comment">// terminated copy of the value name string.  If not return</span>
00436             <span class="comment">// the length we require (so far) and an error.</span>
00437             <span class="comment">//</span>
00438             ValueSpaceNeeded = KeyValueInformation-&gt;NameLength + <span class="keyword">sizeof</span>(UNICODE_NULL);
00439             <span class="keywordflow">if</span> ( FreeMemSize &lt; ValueSpaceNeeded ) {
00440 
00441                *PKeyValueInfoLength = (ULONG)(((PCHAR)FreeMem - (PCHAR)KeyValueInformation) + ValueSpaceNeeded);
00442                 <span class="keywordflow">return</span> STATUS_BUFFER_TOO_SMALL;
00443             }
00444 
00445             <span class="comment">//</span>
00446             <span class="comment">// There is room, so copy the string, and null terminate it.</span>
00447             <span class="comment">//</span>
00448 
00449             <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a> = (PWSTR)FreeMem;
00450             RtlCopyMemory( <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>,
00451                            KeyValueInformation-&gt;Name,
00452                            KeyValueInformation-&gt;NameLength
00453                          );
00454             *(PWSTR)((PCHAR)<a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a> + KeyValueInformation-&gt;NameLength) = UNICODE_NULL;
00455 
00456             <span class="comment">//</span>
00457             <span class="comment">// Update the free memory pointer and size to reflect the space we</span>
00458             <span class="comment">// just used for the null terminated value name.</span>
00459             <span class="comment">//</span>
00460             FreeMem += ValueSpaceNeeded;
00461             FreeMem = (PCHAR)<a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a2">QuadAlignPtr</a>(FreeMem);
00462             FreeMemSize = (LONG) (EndFreeMem - FreeMem);
00463 
00464         } <span class="keywordflow">else</span> {
00465             <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a> = QueryTable-&gt;Name;
00466         }
00467 
00468         <span class="comment">//</span>
00469         <span class="comment">// Get the remaining data for the registry value.</span>
00470         <span class="comment">//</span>
00471 
00472         ValueType = KeyValueInformation-&gt;Type;
00473         ValueData = (PCHAR)KeyValueInformation + KeyValueInformation-&gt;DataOffset;
00474         ValueLength = KeyValueInformation-&gt;DataLength;
00475     }
00476 
00477     <span class="comment">//</span>
00478     <span class="comment">// Unless specifically disabled for this table entry, preprocess</span>
00479     <span class="comment">// registry values of type REG_EXPAND_SZ and REG_MULTI_SZ</span>
00480     <span class="comment">//</span>
00481 
00482     <span class="keywordflow">if</span> (!(QueryTable-&gt;Flags &amp; RTL_QUERY_REGISTRY_NOEXPAND)) {
00483         <span class="keywordflow">if</span> (ValueType == REG_MULTI_SZ) {
00484             PWSTR ValueEnd;
00485 
00486             <span class="comment">//</span>
00487             <span class="comment">// For REG_MULTI_SZ value type, call the query routine once</span>
00488             <span class="comment">// for each null terminated string in the registry value.  Fake</span>
00489             <span class="comment">// like this is multiple REG_SZ values with the same value name.</span>
00490             <span class="comment">//</span>
00491 
00492             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00493             ValueEnd = (PWSTR)((PCHAR)ValueData + ValueLength) - <span class="keyword">sizeof</span>(UNICODE_NULL);
00494             s = (PWSTR)ValueData;
00495             <span class="keywordflow">while</span> (s &lt; ValueEnd) {
00496                 <span class="keywordflow">while</span> (*s++ != UNICODE_NULL) {
00497                 }
00498 
00499                 ValueLength = (ULONG)((PCHAR)s - (PCHAR)ValueData);
00500                 <span class="keywordflow">if</span> (QueryTable-&gt;Flags &amp; RTL_QUERY_REGISTRY_DIRECT) {
00501                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a14">RtlpQueryRegistryDirect</a>( REG_SZ,
00502                                                       ValueData,
00503                                                       ValueLength,
00504                                                       QueryTable-&gt;EntryContext
00505                                                     );
00506                     (PUNICODE_STRING)(QueryTable-&gt;EntryContext) += 1;
00507 
00508                 } <span class="keywordflow">else</span> {
00509                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = (QueryTable-&gt;QueryRoutine)( <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>,
00510                                                          REG_SZ,
00511                                                          ValueData,
00512                                                          ValueLength,
00513                                                          Context,
00514                                                          QueryTable-&gt;EntryContext
00515                                                        );
00516                 }
00517 
00518                 <span class="comment">//</span>
00519                 <span class="comment">// We ignore failures where the buffer is too small.</span>
00520                 <span class="comment">//</span>
00521                 <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_BUFFER_TOO_SMALL) {
00522                    <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00523                 }
00524 
00525                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00526                     <span class="keywordflow">break</span>;
00527                 }
00528 
00529                 ValueData = (PVOID)s;
00530             }
00531 
00532             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00533         }
00534 
00535         <span class="comment">//</span>
00536         <span class="comment">// If requested, expand the Value -- but only if the unexpanded value</span>
00537         <span class="comment">// can be represented with a UNICODE_STRING.</span>
00538         <span class="comment">//</span>
00539         <span class="keywordflow">if</span> ((ValueType == REG_EXPAND_SZ) &amp;&amp;
00540             (ValueLength &gt;= <span class="keyword">sizeof</span>(WCHAR)) &amp;&amp;
00541             (ValueLength &lt;= <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a1">MAX_NONNULL_USTRING</a>)) {
00542             <span class="comment">//</span>
00543             <span class="comment">// For REG_EXPAND_SZ value type, expand any environment variable</span>
00544             <span class="comment">// references in the registry value string using the Rtl function.</span>
00545             <span class="comment">//</span>
00546 
00547             UNICODE_STRING Source;
00548             UNICODE_STRING Destination;
00549             PWCHAR  Src;
00550             ULONG   SrcLength;
00551             ULONG   RequiredLength;
00552             BOOLEAN PercentFound;
00553 
00554             <span class="comment">//</span>
00555             <span class="comment">// Don't expand unless we have to since expansion doubles buffer usage.</span>
00556             <span class="comment">//</span>
00557 
00558             PercentFound = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00559             SrcLength = ValueLength - <span class="keyword">sizeof</span>(WCHAR);
00560             Src = (PWSTR)ValueData;
00561             <span class="keywordflow">while</span> (SrcLength) {
00562                 <span class="keywordflow">if</span> (*Src == <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'%'</span>) {
00563                     PercentFound = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00564                     <span class="keywordflow">break</span>;
00565                 }
00566                 Src++;
00567                 SrcLength -= <span class="keyword">sizeof</span>(WCHAR);
00568             }
00569 
00570             <span class="keywordflow">if</span> ( PercentFound ) {
00571                 Source.Buffer = (PWSTR)ValueData;
00572                 Source.MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)ValueLength;
00573                 Source.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(Source.MaximumLength - <span class="keyword">sizeof</span>(UNICODE_NULL));
00574                 Destination.Buffer = (PWSTR)FreeMem;
00575                 Destination.Length = 0;
00576 
00577                 <span class="keywordflow">if</span> (FreeMemSize &lt;= 0) {
00578                     Destination.MaximumLength = 0;
00579                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (FreeMemSize &lt;= <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a0">MAX_USTRING</a>) {
00580                     Destination.MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)FreeMemSize;
00581                     Destination.Buffer[FreeMemSize/<span class="keyword">sizeof</span>(WCHAR) - 1] = UNICODE_NULL;
00582                 } <span class="keywordflow">else</span> {
00583                     Destination.MaximumLength = <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a0">MAX_USTRING</a>;
00584                     Destination.Buffer[<a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a0">MAX_USTRING</a>/<span class="keyword">sizeof</span>(WCHAR) - 1] = UNICODE_NULL;
00585                 }
00586 
00587                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a24">RtlExpandEnvironmentStrings_U</a>( Environment,
00588                                                         &amp;Source,
00589                                                         &amp;Destination,
00590                                                         &amp;RequiredLength
00591                                                       );
00592                 ValueType = REG_SZ;
00593 
00594                 <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ) {
00595                     ValueData = Destination.Buffer;
00596                     ValueLength = Destination.Length + <span class="keyword">sizeof</span>( UNICODE_NULL );
00597                 } <span class="keywordflow">else</span> {
00598                     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_BUFFER_TOO_SMALL) {
00599                        *PKeyValueInfoLength = (ULONG)((PCHAR)FreeMem - (PCHAR)KeyValueInformation) + RequiredLength;
00600                     }
00601 <span class="comment">//#if DBG</span>
00602                     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_BUFFER_TOO_SMALL) {
00603                        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"RTL: Expand variables for %wZ failed - Status == %lx Size %x &gt; %x &lt;%x&gt;\n"</span>,
00604                                      &amp;Source, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>, *PKeyValueInfoLength, KeyValueInfoLength,
00605                                      Destination.MaximumLength );
00606                     } <span class="keywordflow">else</span> {
00607                        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"RTL: Expand variables for %wZ failed - Status == %lx\n"</span>, &amp;Source, <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00608                     }
00609 <span class="comment">//#endif  // DBG</span>
00610                     <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_BUFFER_OVERFLOW ||
00611                          <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_BUFFER_TOO_SMALL &amp;&amp;
00612                         ( Destination.MaximumLength == <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a0">MAX_USTRING</a>
00613                          || RequiredLength &gt; <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a1">MAX_NONNULL_USTRING</a> ) ) {
00614 
00615                        <span class="comment">// We can't do variable expansion because the required buffer can't be described</span>
00616                        <span class="comment">// by a UNICODE_STRING, so we silently ignore expansion.</span>
00617 <span class="comment">//#if DBG</span>
00618                        <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"RtlpCallQueryRegistryRoutine: skipping expansion.  Status=%x RequiredLength=%x\n"</span>,
00619                          <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>, RequiredLength);
00620 <span class="comment">//#endif //DBG</span>
00621                    } <span class="keywordflow">else</span> {
00622                         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00623                    }
00624                 }
00625             }
00626         }
00627 <span class="comment">//#if DBG</span>
00628         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ValueType == REG_EXPAND_SZ  &amp;&amp;  ValueLength &gt; <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a1">MAX_NONNULL_USTRING</a>) {
00629             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"RtlpCallQueryRegistryRoutine: skipping environment expansion.  ValueLength=%x\n"</span>,
00630                      ValueLength);
00631         }
00632 <span class="comment">//#endif //DBG</span>
00633     }
00634 
00635     <span class="comment">//</span>
00636     <span class="comment">// No special process of the registry value required so just call</span>
00637     <span class="comment">// the query routine.</span>
00638     <span class="comment">//</span>
00639     <span class="keywordflow">if</span> (QueryTable-&gt;Flags &amp; RTL_QUERY_REGISTRY_DIRECT) {
00640         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a14">RtlpQueryRegistryDirect</a>( ValueType,
00641                                           ValueData,
00642                                           ValueLength,
00643                                           QueryTable-&gt;EntryContext
00644                                         );
00645     } <span class="keywordflow">else</span> {
00646         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = (QueryTable-&gt;QueryRoutine)( <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a>,
00647                                              ValueType,
00648                                              ValueData,
00649                                              ValueLength,
00650                                              Context,
00651                                              QueryTable-&gt;EntryContext
00652                                            );
00653 
00654     }
00655 
00656     <span class="comment">//</span>
00657     <span class="comment">// At this point we fail silently if the buffer is too small.</span>
00658     <span class="comment">//</span>
00659     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_BUFFER_TOO_SMALL) {
00660         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00661     }
00662     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00663 }
00664 
00665 <span class="comment">//</span>
00666 <span class="comment">// Most of the registry queries in the kernel are small (40-50 bytes).</span>
00667 <span class="comment">// User queries use ZwAllocateVirtualMemory, so nothing less than a page will do.</span>
00668 <span class="comment">//</span>
00669 <span class="preprocessor">#ifdef NTOS_KERNEL_RUNTIME</span>
00670 <span class="preprocessor"></span>SIZE_T <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a5">RtlpRegistryQueryInitialBuffersize</a> = 0x80 + <span class="keyword">sizeof</span>(PVOID);
00671 <span class="preprocessor">#else</span>
<a name="l00672"></a><a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a5">00672</a> <span class="preprocessor"></span>SIZE_T <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a5">RtlpRegistryQueryInitialBuffersize</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
00673 <span class="preprocessor">#endif</span>
00674 <span class="preprocessor"></span>
00675 <span class="comment">//</span>
00676 <span class="comment">// Allocate, Free, or Free/Allocate space for registry queries.</span>
00677 <span class="comment">//</span>
00678 PVOID
<a name="l00679"></a><a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a16">00679</a> <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a16">RtlpAllocDeallocQueryBuffer</a>(
00680    IN OUT SIZE_T    *PAllocLength            OPTIONAL,
00681    IN     PVOID      OldKeyValueInformation  OPTIONAL,
00682    IN     SIZE_T     OldAllocLength          OPTIONAL,
00683       OUT NTSTATUS  *pStatus                 OPTIONAL
00684    )
00685 {
00686    PVOID    <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a28">Ptr</a>     = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00687    <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>  = STATUS_SUCCESS;
00688 
00689 <span class="preprocessor">#ifdef NTOS_KERNEL_RUNTIME</span>
00690 <span class="preprocessor"></span>
00691    <span class="comment">//</span>
00692    <span class="comment">// Kernel version</span>
00693    <span class="comment">//</span>
00694 
00695    UNREFERENCED_PARAMETER( OldAllocLength );
00696 
00697    <span class="keywordflow">if</span> ( ARGUMENT_PRESENT(OldKeyValueInformation) ) {
00698       <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( OldKeyValueInformation );
00699    }
00700 
00701    <span class="keywordflow">if</span> ( ARGUMENT_PRESENT(PAllocLength) ) {
00702       <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a28">Ptr</a> = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, *PAllocLength, 'vrqR' );
00703       <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a28">Ptr</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00704          <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_MEMORY;
00705       }
00706    }
00707 
00708 <span class="preprocessor">#else</span>
00709 <span class="preprocessor"></span>
00710    <span class="comment">//</span>
00711    <span class="comment">// User version</span>
00712    <span class="comment">//</span>
00713 
00714    <span class="keywordflow">if</span> ( ARGUMENT_PRESENT(OldKeyValueInformation) ) {
00715        <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwFreeVirtualMemory( NtCurrentProcess(),
00716                                      &amp;OldKeyValueInformation,
00717                                      &amp;OldAllocLength,
00718                                      MEM_RELEASE );
00719    }
00720 
00721    <span class="keywordflow">if</span> ( ARGUMENT_PRESENT(PAllocLength) ) {
00722 
00723        <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwAllocateVirtualMemory( NtCurrentProcess(),
00724                                      &amp;<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a28">Ptr</a>,
00725                                      0,
00726                                      PAllocLength,
00727                                      MEM_COMMIT,
00728                                      PAGE_READWRITE );
00729        <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00730           <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a28">Ptr</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00731        }
00732    }
00733 
00734 <span class="preprocessor">#endif</span>
00735 <span class="preprocessor"></span>
00736    <span class="keywordflow">if</span> ( ARGUMENT_PRESENT(pStatus) ) {
00737       *pStatus = <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00738    }
00739 
00740    <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a28">Ptr</a>;
00741 }
00742 
00743 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00744"></a><a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a19">00744</a> <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a19">RtlQueryRegistryValues</a>(
00745     IN ULONG RelativeTo,
00746     IN PCWSTR Path,
00747     IN PRTL_QUERY_REGISTRY_TABLE QueryTable,
00748     IN PVOID Context,
00749     IN PVOID Environment OPTIONAL
00750     )
00751 
00752 <span class="comment">/*++</span>
00753 <span class="comment"></span>
00754 <span class="comment">Routine Description:</span>
00755 <span class="comment"></span>
00756 <span class="comment">    This function allows the caller to query multiple values from the registry</span>
00757 <span class="comment">    sub-tree with a single call.  The caller specifies an initial key path,</span>
00758 <span class="comment">    and a table.  The table contains one or more entries that describe the</span>
00759 <span class="comment">    key values and subkey names the caller is interested in.  This function</span>
00760 <span class="comment">    starts at the initial key and enumerates the entries in the table.  For</span>
00761 <span class="comment">    each entry that specifies a value name or subkey name that exists in</span>
00762 <span class="comment">    the registry, this function calls the caller's query routine associated</span>
00763 <span class="comment">    with each table entry.  The caller's query routine is passed the value</span>
00764 <span class="comment">    name, type, data and data length, to do with what they wish.</span>
00765 <span class="comment"></span>
00766 <span class="comment">Arguments:</span>
00767 <span class="comment"></span>
00768 <span class="comment">    RelativeTo - specifies that the Path parameter is either an absolute</span>
00769 <span class="comment">        registry path, or a path relative to a predefined key path.  The</span>
00770 <span class="comment">        following values are defined:</span>
00771 <span class="comment"></span>
00772 <span class="comment">        RTL_REGISTRY_ABSOLUTE   - Path is an absolute registry path</span>
00773 <span class="comment">        RTL_REGISTRY_SERVICES   - Path is relative to \Registry\Machine\System\CurrentControlSet\Services</span>
00774 <span class="comment">        RTL_REGISTRY_CONTROL    - Path is relative to \Registry\Machine\System\CurrentControlSet\Control</span>
00775 <span class="comment">        RTL_REGISTRY_WINDOWS_NT - Path is relative to \Registry\Machine\Software\Microsoft\Windows NT\CurrentVersion</span>
00776 <span class="comment">        RTL_REGISTRY_DEVICEMAP  - Path is relative to \Registry\Machine\Hardware\DeviceMap</span>
00777 <span class="comment">        RTL_REGISTRY_USER       - Path is relative to \Registry\User\CurrentUser</span>
00778 <span class="comment"></span>
00779 <span class="comment">        RTL_REGISTRY_OPTIONAL   - Bit that specifies the key referenced by</span>
00780 <span class="comment">                                  this parameter and the Path parameter is</span>
00781 <span class="comment">                                  optional.</span>
00782 <span class="comment"></span>
00783 <span class="comment">        RTL_REGISTRY_HANDLE     - Bit that specifies that the Path parameter</span>
00784 <span class="comment">                                  is actually a registry handle to use.</span>
00785 <span class="comment">                                  optional.</span>
00786 <span class="comment"></span>
00787 <span class="comment">    Path - specifies either an absolute registry path, or a path relative to the</span>
00788 <span class="comment">        known location specified by the RelativeTo parameter.  If the the</span>
00789 <span class="comment">        RTL_REGISTRY_HANDLE flag is specified, then this parameter is a</span>
00790 <span class="comment">        registry handle to use directly.</span>
00791 <span class="comment"></span>
00792 <span class="comment">    QueryTable - specifies a table of one or more value names and subkey names</span>
00793 <span class="comment">        that the caller is interested.  Each table entry contains a query routine</span>
00794 <span class="comment">        that will be called for each value name that exists in the registry.</span>
00795 <span class="comment">        The table is terminated when a NULL table entry is reached.  A NULL</span>
00796 <span class="comment">        table entry is defined as a table entry with a NULL QueryRoutine</span>
00797 <span class="comment">        and a NULL Name field.</span>
00798 <span class="comment"></span>
00799 <span class="comment">        QueryTable entry fields:</span>
00800 <span class="comment"></span>
00801 <span class="comment">        PRTL_QUERY_REGISTRY_ROUTINE QueryRoutine - This routine is</span>
00802 <span class="comment">            called with the name, type, data and data length of a</span>
00803 <span class="comment">            registry value.  If this field is NULL, then it marks the</span>
00804 <span class="comment">            end of the table.</span>
00805 <span class="comment"></span>
00806 <span class="comment">        ULONG Flags - These flags control how the following fields are</span>
00807 <span class="comment">            interpreted.  The following flags are defined:</span>
00808 <span class="comment"></span>
00809 <span class="comment">            RTL_QUERY_REGISTRY_SUBKEY - says the Name field of this</span>
00810 <span class="comment">                table entry is another path to a registry key and all</span>
00811 <span class="comment">                following table entries are for that key rather than the</span>
00812 <span class="comment">                key specified by the Path parameter.  This change in</span>
00813 <span class="comment">                focus lasts until the end of the table or another</span>
00814 <span class="comment">                RTL_QUERY_REGISTRY_SUBKEY entry is seen or</span>
00815 <span class="comment">                RTL_QUERY_REGISTRY_TOPKEY entry is seen.  Each such</span>
00816 <span class="comment">                entry must specify a path that is relative to the Path</span>
00817 <span class="comment">                specified on the call to this function.</span>
00818 <span class="comment"></span>
00819 <span class="comment">            RTL_QUERY_REGISTRY_TOPKEY - resets the current registry key</span>
00820 <span class="comment">                handle to the original one specified by the RelativeTo</span>
00821 <span class="comment">                and Path parameters.  Useful for getting back to the</span>
00822 <span class="comment">                original node after descending into subkeys with the</span>
00823 <span class="comment">                RTL_QUERY_REGISTRY_SUBKEY flag.</span>
00824 <span class="comment"></span>
00825 <span class="comment">            RTL_QUERY_REGISTRY_REQUIRED - specifies that this value is</span>
00826 <span class="comment">                required and if not found then STATUS_OBJECT_NAME_NOT_FOUND</span>
00827 <span class="comment">                is returned.  For a table entry that specifies a NULL</span>
00828 <span class="comment">                name so that this function will enumerate all of the</span>
00829 <span class="comment">                value names under a key, STATUS_OBJECT_NAME_NOT_FOUND</span>
00830 <span class="comment">                will be returned only if there are no value keys under</span>
00831 <span class="comment">                the current key.</span>
00832 <span class="comment"></span>
00833 <span class="comment">            RTL_QUERY_REGISTRY_NOVALUE - specifies that even though</span>
00834 <span class="comment">                there is no Name field for this table entry, all the</span>
00835 <span class="comment">                caller wants is a call back, it does NOT want to</span>
00836 <span class="comment">                enumerate all the values under the current key.  The</span>
00837 <span class="comment">                query routine is called with NULL for ValueData,</span>
00838 <span class="comment">                REG_NONE for ValueType and zero for ValueLength.</span>
00839 <span class="comment"></span>
00840 <span class="comment">            RTL_QUERY_REGISTRY_NOEXPAND - specifies that if the value</span>
00841 <span class="comment">                type of this registry value is REG_EXPAND_SZ or</span>
00842 <span class="comment">                REG_MULTI_SZ, then this function is NOT to do any</span>
00843 <span class="comment">                preprocessing of the registry values prior to calling</span>
00844 <span class="comment">                the query routine.  Default behavior is to expand</span>
00845 <span class="comment">                environment variable references in REG_EXPAND_SZ</span>
00846 <span class="comment">                values and to enumerate the NULL terminated strings</span>
00847 <span class="comment">                in a REG_MULTI_SZ value and call the query routine</span>
00848 <span class="comment">                once for each, making it look like multiple REG_SZ</span>
00849 <span class="comment">                values with the same ValueName.</span>
00850 <span class="comment"></span>
00851 <span class="comment">            RTL_QUERY_REGISTRY_DIRECT QueryRoutine field ignored.</span>
00852 <span class="comment">                EntryContext field points to location to store value.</span>
00853 <span class="comment">                For null terminated strings, EntryContext points to</span>
00854 <span class="comment">                UNICODE_STRING structure that that describes maximum</span>
00855 <span class="comment">                size of buffer.  If .Buffer field is NULL then a buffer</span>
00856 <span class="comment">                is allocated.</span>
00857 <span class="comment"></span>
00858 <span class="comment">            RTL_QUERY_REGISTRY_DELETE Used to delete value keys after</span>
00859 <span class="comment">                they are queried.</span>
00860 <span class="comment"></span>
00861 <span class="comment">        PWSTR Name - This field gives the name of a Value the caller</span>
00862 <span class="comment">            wants to query the value of.  If this field is NULL, then</span>
00863 <span class="comment">            the QueryRoutine specified for this table entry is called</span>
00864 <span class="comment">            for all values associated with the current registry key.</span>
00865 <span class="comment"></span>
00866 <span class="comment">        PVOID EntryContext - This field is an arbitrary 32-bit field</span>
00867 <span class="comment">            that is passed uninterpreted to each QueryRoutine called.</span>
00868 <span class="comment"></span>
00869 <span class="comment">        ULONG DefaultType</span>
00870 <span class="comment">        PVOID DefaultData</span>
00871 <span class="comment">        ULONG DefaultLength If there is no value name that matches the</span>
00872 <span class="comment">            name given by the Name field, and the DefaultType field is</span>
00873 <span class="comment">            not REG_NONE, then the QueryRoutine for this table entry is</span>
00874 <span class="comment">            called with the contents of the following fields as if the</span>
00875 <span class="comment">            value had been found in the registry.  If the DefaultType is</span>
00876 <span class="comment">            REG_SZ, REG_EXPANDSZ or REG_MULTI_SZ and the DefaultLength</span>
00877 <span class="comment">            is 0 then the value of DefaultLength will be computed based</span>
00878 <span class="comment">            on the length of unicode string pointed to by DefaultData</span>
00879 <span class="comment"></span>
00880 <span class="comment">    Context - specifies a 32-bit quantity that is passed uninterpreted to</span>
00881 <span class="comment">        each QueryRoutine called.</span>
00882 <span class="comment"></span>
00883 <span class="comment">    Environment - optional parameter, that if specified is the environment</span>
00884 <span class="comment">        used when expanding variable values in REG_EXPAND_SZ registry</span>
00885 <span class="comment">        values.</span>
00886 <span class="comment"></span>
00887 <span class="comment">Return Value:</span>
00888 <span class="comment"></span>
00889 <span class="comment">    Status of the operation.</span>
00890 <span class="comment"></span>
00891 <span class="comment">--*/</span>
00892 
00893 {
00894     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00895     OBJECT_ATTRIBUTES <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>;
00896     UNICODE_STRING    <a class="code" href="../../d8/d0/rtbatcr_8c.html#a2">KeyPath</a>, KeyValueName;
00897     HANDLE  <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>, Key1;
00898     PKEY_VALUE_FULL_INFORMATION KeyValueInformation;
00899     SIZE_T  KeyValueInfoLength;
00900     ULONG   ValueIndex;
00901     SIZE_T  AllocLength;
00902     ULONG   KeyResultLength;
00903     <span class="keywordtype">int</span>     retries;
00904 
00905     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
00906 
00907     KeyValueInformation = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00908 
00909     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a13">RtlpGetRegistryHandle</a>( RelativeTo, Path, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, &amp;<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a> );
00910     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00911         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00912     }
00913 
00914     <span class="keywordflow">if</span> ((RelativeTo &amp; RTL_REGISTRY_HANDLE) == 0) {
00915         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;<a class="code" href="../../d8/d0/rtbatcr_8c.html#a2">KeyPath</a>, Path);
00916     } <span class="keywordflow">else</span> {
00917         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;<a class="code" href="../../d8/d0/rtbatcr_8c.html#a2">KeyPath</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00918     }
00919 
00920     AllocLength = <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a5">RtlpRegistryQueryInitialBuffersize</a>;
00921 
00922     KeyValueInformation = <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a16">RtlpAllocDeallocQueryBuffer</a>( &amp;AllocLength, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0, &amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
00923     <span class="keywordflow">if</span> ( KeyValueInformation == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00924         <span class="keywordflow">if</span> (!(RelativeTo &amp; RTL_REGISTRY_HANDLE)) {
00925             ZwClose( <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a> );
00926         }
00927         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00928     }
00929 
00930     KeyValueInfoLength = AllocLength - <span class="keyword">sizeof</span>(UNICODE_NULL);
00931     Key1 = <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>;
00932     <span class="keywordflow">while</span> (QueryTable-&gt;QueryRoutine != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ||
00933            (QueryTable-&gt;Flags &amp; (RTL_QUERY_REGISTRY_SUBKEY | RTL_QUERY_REGISTRY_DIRECT))
00934           ) {
00935 
00936         <span class="keywordflow">if</span> ((QueryTable-&gt;Flags &amp; RTL_QUERY_REGISTRY_DIRECT) &amp;&amp;
00937             (QueryTable-&gt;Name == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ||
00938              (QueryTable-&gt;Flags &amp; RTL_QUERY_REGISTRY_SUBKEY) ||
00939              QueryTable-&gt;QueryRoutine != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)
00940            ) {
00941 
00942             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
00943             <span class="keywordflow">break</span>;
00944         }
00945 
00946         <span class="keywordflow">if</span> (QueryTable-&gt;Flags &amp; (RTL_QUERY_REGISTRY_TOPKEY | RTL_QUERY_REGISTRY_SUBKEY)) {
00947             <span class="keywordflow">if</span> (Key1 != <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>) {
00948                 <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( Key1 );
00949                 Key1 = <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>;
00950             }
00951         }
00952 
00953         <span class="keywordflow">if</span> (QueryTable-&gt;Flags &amp; RTL_QUERY_REGISTRY_SUBKEY) {
00954             <span class="keywordflow">if</span> (QueryTable-&gt;Name == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00955                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
00956             } <span class="keywordflow">else</span> {
00957                 <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;<a class="code" href="../../d8/d0/rtbatcr_8c.html#a2">KeyPath</a>, QueryTable-&gt;Name );
00958                 InitializeObjectAttributes( &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00959                                             &amp;<a class="code" href="../../d8/d0/rtbatcr_8c.html#a2">KeyPath</a>,
00960                                             OBJ_CASE_INSENSITIVE,
00961                                             <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>,
00962                                             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00963                                             );
00964 <span class="preprocessor">#ifdef NTOS_KERNEL_RUNTIME</span>
00965 <span class="preprocessor"></span>                <span class="comment">//</span>
00966                 <span class="comment">// Use a kernel-mode handle for the registry key to prevent</span>
00967                 <span class="comment">// malicious apps from hijacking it.</span>
00968                 <span class="comment">//</span>
00969                 <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>.Attributes |= OBJ_KERNEL_HANDLE;
00970 <span class="preprocessor">#endif</span>
00971 <span class="preprocessor"></span>                <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwOpenKey( &amp;Key1,
00972                                     MAXIMUM_ALLOWED,
00973                                     &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>
00974                                   );
00975                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
00976                     <span class="keywordflow">if</span> (QueryTable-&gt;QueryRoutine != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00977                         <span class="keywordflow">goto</span> enumvalues;
00978                     }
00979                 }
00980             }
00981 
00982         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (QueryTable-&gt;Name != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00983                 <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;KeyValueName, QueryTable-&gt;Name );
00984                 retries = 0;
00985     retryqueryvalue:
00986                 <span class="comment">//</span>
00987                 <span class="comment">// A maximum of two retries is expected. If we see more we must</span>
00988                 <span class="comment">// have miscomputed how much is required for the query buffer.</span>
00989                 <span class="comment">//</span>
00990                 <span class="keywordflow">if</span> (retries++ &gt; 4) {
00991 <span class="comment">//#if DBG</span>
00992                    <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"RtlQueryRegistryValues: Miscomputed buffer size at line %d\n"</span>, __LINE__);
00993 <span class="comment">//#endif</span>
00994                    <span class="keywordflow">break</span>;
00995                 }
00996 
00997                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwQueryValueKey( Key1,
00998                                           &amp;KeyValueName,
00999                                           KeyValueFullInformation,
01000                                           KeyValueInformation,
01001                                           (ULONG) KeyValueInfoLength,
01002                                           &amp;KeyResultLength
01003                                         );
01004                 <span class="comment">//</span>
01005                 <span class="comment">// ZwQueryValueKey returns overflow even though the problem is that</span>
01006                 <span class="comment">// the specified buffer was too small, so we fix that up here so we</span>
01007                 <span class="comment">// can decide correctly whether to retry or not below.</span>
01008                 <span class="comment">//</span>
01009                 <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_BUFFER_OVERFLOW) {
01010                    <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_BUFFER_TOO_SMALL;
01011                 }
01012 
01013                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
01014                     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_OBJECT_NAME_NOT_FOUND) {
01015 
01016                         KeyValueInformation-&gt;Type = REG_NONE;
01017                         KeyValueInformation-&gt;DataLength = 0;
01018                         KeyResultLength = (ULONG)KeyValueInfoLength;
01019                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a15">RtlpCallQueryRegistryRoutine</a>( QueryTable,
01020                                                                KeyValueInformation,
01021                                                                &amp;KeyResultLength,
01022                                                                Context,
01023                                                                Environment
01024                                                              );
01025                     }
01026 
01027                    <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_BUFFER_TOO_SMALL) {
01028                         <span class="comment">//</span>
01029                         <span class="comment">// Try to allocate a larger buffer as this is one humongous</span>
01030                         <span class="comment">// value.</span>
01031                         <span class="comment">//</span>
01032                         AllocLength = KeyResultLength + <span class="keyword">sizeof</span>(PVOID) + <span class="keyword">sizeof</span>(UNICODE_NULL);
01033                         KeyValueInformation = <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a16">RtlpAllocDeallocQueryBuffer</a>( &amp;AllocLength,
01034                                                                            KeyValueInformation,
01035                                                                            AllocLength,
01036                                                                            &amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>
01037                                                                          );
01038                         <span class="keywordflow">if</span> ( KeyValueInformation == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01039                            <span class="keywordflow">break</span>;
01040                         }
01041                         KeyValueInfoLength = AllocLength - <span class="keyword">sizeof</span>(UNICODE_NULL);
01042                         <span class="keywordflow">goto</span> retryqueryvalue;
01043                     }
01044 
01045                 } <span class="keywordflow">else</span> {
01046                     <span class="comment">//</span>
01047                     <span class="comment">// KeyResultLength holds the length of the data returned by ZwQueryKeyValue.</span>
01048                     <span class="comment">// If this is a MULTI_SZ value, catenate a NUL.</span>
01049                     <span class="comment">//</span>
01050                     <span class="keywordflow">if</span> ( KeyValueInformation-&gt;Type == REG_MULTI_SZ ) {
01051                             *(PWCHAR) ((PUCHAR)KeyValueInformation + KeyResultLength) = UNICODE_NULL;
01052                             KeyValueInformation-&gt;DataLength += <span class="keyword">sizeof</span>(UNICODE_NULL);
01053                     }
01054 
01055                     KeyResultLength = (ULONG)KeyValueInfoLength;
01056                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a15">RtlpCallQueryRegistryRoutine</a>( QueryTable,
01057                                                            KeyValueInformation,
01058                                                            &amp;KeyResultLength,
01059                                                            Context,
01060                                                            Environment
01061                                                          );
01062 
01063                     <span class="keywordflow">if</span> ( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_BUFFER_TOO_SMALL ) {
01064                          <span class="comment">//</span>
01065                          <span class="comment">// Try to allocate a larger buffer as this is one humongous</span>
01066                          <span class="comment">// value.</span>
01067                          <span class="comment">//</span>
01068                          AllocLength = KeyResultLength + <span class="keyword">sizeof</span>(PVOID) + <span class="keyword">sizeof</span>(UNICODE_NULL);
01069                          KeyValueInformation = <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a16">RtlpAllocDeallocQueryBuffer</a>( &amp;AllocLength,
01070                                                                             KeyValueInformation,
01071                                                                             AllocLength,
01072                                                                             &amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>
01073                                                                           );
01074                          <span class="keywordflow">if</span> ( KeyValueInformation == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01075                             <span class="keywordflow">break</span>;
01076                          }
01077                          KeyValueInfoLength = AllocLength - <span class="keyword">sizeof</span>(UNICODE_NULL);
01078                          <span class="keywordflow">goto</span> retryqueryvalue;
01079                      }
01080 
01081                     <span class="comment">//</span>
01082                     <span class="comment">// If requested, delete the value key after it has been successfully queried.</span>
01083                     <span class="comment">//</span>
01084 
01085                     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ) &amp;&amp; QueryTable-&gt;Flags &amp; RTL_QUERY_REGISTRY_DELETE) {
01086                         ZwDeleteValueKey (Key1, &amp;KeyValueName);
01087                     }
01088                 }
01089 
01090         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (QueryTable-&gt;Flags &amp; RTL_QUERY_REGISTRY_NOVALUE) {
01091             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = (QueryTable-&gt;QueryRoutine)( <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01092                                                  REG_NONE,
01093                                                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01094                                                  0,
01095                                                  Context,
01096                                                  QueryTable-&gt;EntryContext
01097                                                );
01098         } <span class="keywordflow">else</span> {
01099 
01100         enumvalues:
01101             retries = 0;
01102             <span class="keywordflow">for</span> (ValueIndex = 0; <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>; ValueIndex++) {
01103                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwEnumerateValueKey( Key1,
01104                                               ValueIndex,
01105                                               KeyValueFullInformation,
01106                                               KeyValueInformation,
01107                                               (ULONG) KeyValueInfoLength,
01108                                               &amp;KeyResultLength
01109                                             );
01110                 <span class="comment">//</span>
01111                 <span class="comment">// ZwEnumerateValueKey returns overflow even though the problem is that</span>
01112                 <span class="comment">// the specified buffer was too small, so we fix that up here so we</span>
01113                 <span class="comment">// can decide correctly whether to retry or not below.</span>
01114                 <span class="comment">//</span>
01115                 <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_BUFFER_OVERFLOW) {
01116                    <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_BUFFER_TOO_SMALL;
01117                 }
01118 
01119                 <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_NO_MORE_ENTRIES) {
01120                     <span class="keywordflow">if</span> (ValueIndex == 0 &amp;&amp; (QueryTable-&gt;Flags &amp; RTL_QUERY_REGISTRY_REQUIRED)) {
01121                        <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_OBJECT_NAME_NOT_FOUND;
01122                     } <span class="keywordflow">else</span> {
01123                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01124                     }
01125                     <span class="keywordflow">break</span>;
01126                 }
01127 
01128                 <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ) ) {
01129 
01130                     KeyResultLength = (ULONG)KeyValueInfoLength;
01131                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a15">RtlpCallQueryRegistryRoutine</a>( QueryTable,
01132                                                            KeyValueInformation,
01133                                                            &amp;KeyResultLength,
01134                                                            Context,
01135                                                            Environment
01136                                                          );
01137                 }
01138 
01139                 <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_BUFFER_TOO_SMALL) {
01140                     <span class="comment">//</span>
01141                     <span class="comment">// Allocate a larger buffer and try again.</span>
01142                     <span class="comment">//</span>
01143                     AllocLength = KeyResultLength + <span class="keyword">sizeof</span>(PVOID) + <span class="keyword">sizeof</span>(UNICODE_NULL);
01144                     KeyValueInformation = <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a16">RtlpAllocDeallocQueryBuffer</a>( &amp;AllocLength,
01145                                                                        KeyValueInformation,
01146                                                                        AllocLength,
01147                                                                        &amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>
01148                                                                      );
01149                     <span class="keywordflow">if</span> (KeyValueInformation == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01150                        <span class="keywordflow">break</span>;
01151                     }
01152                     KeyValueInfoLength = AllocLength - <span class="keyword">sizeof</span>(UNICODE_NULL);
01153                     ValueIndex -= 1;
01154 
01155                     <span class="comment">//</span>
01156                     <span class="comment">// A maximum of two retries is expected per loop iteration.</span>
01157                     <span class="comment">// If we see more we must have miscomputed</span>
01158                     <span class="comment">// how much is required for the query buffer.</span>
01159                     <span class="comment">//</span>
01160                     <span class="keywordflow">if</span> (retries++ &lt;= 4) {
01161                         <span class="keywordflow">continue</span>;
01162                     }
01163 <span class="comment">//#if DBG</span>
01164                     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>(<span class="stringliteral">"RtlQueryRegistryValues: Miscomputed buffer size at line %d\n"</span>, __LINE__);
01165 <span class="comment">//#endif</span>
01166                     <span class="keywordflow">break</span>;
01167                 }
01168 
01169                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
01170                     <span class="keywordflow">break</span>;
01171                 }
01172 
01173                 retries = 0;
01174 
01175                 <span class="comment">//</span>
01176                 <span class="comment">// If requested, delete the value key after it has been successfully queried.</span>
01177                 <span class="comment">// After deletion the current ValueIndex is for the next sub-key, so adjust it.</span>
01178                 <span class="comment">// KeyValueInformation-&gt;NameLength should fit in a USHORT, but we don't check since</span>
01179                 <span class="comment">// it only harms our caller.</span>
01180                 <span class="comment">//</span>
01181 
01182                 <span class="keywordflow">if</span> (QueryTable-&gt;Flags &amp; RTL_QUERY_REGISTRY_DELETE) {
01183                     KeyValueName.Buffer = KeyValueInformation-&gt;Name;
01184                     KeyValueName.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)KeyValueInformation-&gt;NameLength;
01185                     KeyValueName.MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)KeyValueInformation-&gt;NameLength;
01186                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwDeleteValueKey( Key1,
01187                                                &amp;KeyValueName
01188                                              );
01189                     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
01190                         ValueIndex -= 1;
01191                     }
01192                 }
01193             }
01194         }
01195 
01196         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
01197             <span class="keywordflow">break</span>;
01198         }
01199 
01200         QueryTable++;
01201     }
01202 
01203     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; !(RelativeTo &amp; RTL_REGISTRY_HANDLE)) {
01204         ZwClose( <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a> );
01205     }
01206 
01207     <span class="keywordflow">if</span> (Key1 != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; Key1 != <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>) {
01208         ZwClose( Key1 );
01209     }
01210 
01211     <span class="comment">//</span>
01212     <span class="comment">// Free any query buffer we allocated.</span>
01213     <span class="comment">//</span>
01214     (<span class="keywordtype">void</span>) <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a16">RtlpAllocDeallocQueryBuffer</a>( <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, KeyValueInformation, AllocLength, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
01215     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01216 }
01217 
01218 
01219 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01220"></a><a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a20">01220</a> <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a20">RtlWriteRegistryValue</a>(
01221     IN ULONG RelativeTo,
01222     IN PCWSTR Path,
01223     IN PCWSTR ValueName,
01224     IN ULONG ValueType,
01225     IN PVOID ValueData,
01226     IN ULONG ValueLength
01227     )
01228 {
01229     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01230     UNICODE_STRING KeyValueName;
01231     HANDLE <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>;
01232 
01233     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
01234 
01235     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a13">RtlpGetRegistryHandle</a>( RelativeTo, Path, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, &amp;<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a> );
01236     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
01237         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01238     }
01239 
01240     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;KeyValueName, <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a> );
01241     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwSetValueKey( <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>,
01242                             &amp;KeyValueName,
01243                             0,
01244                             ValueType,
01245                             ValueData,
01246                             ValueLength
01247                           );
01248     <span class="keywordflow">if</span> (!(RelativeTo &amp; RTL_REGISTRY_HANDLE)) {
01249         ZwClose( <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a> );
01250     }
01251 
01252     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01253 }
01254 
01255 
01256 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01257"></a><a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a21">01257</a> <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a21">RtlCheckRegistryKey</a>(
01258     IN ULONG RelativeTo,
01259     IN PWSTR Path
01260     )
01261 {
01262     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01263     HANDLE <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>;
01264 
01265     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
01266 
01267     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a13">RtlpGetRegistryHandle</a>( RelativeTo, Path, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, &amp;<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a> );
01268     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
01269         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01270         }
01271 
01272     ZwClose( <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a> );
01273     <span class="keywordflow">return</span> STATUS_SUCCESS;
01274 }
01275 
01276 
01277 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01278"></a><a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a22">01278</a> <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a22">RtlCreateRegistryKey</a>(
01279     IN ULONG RelativeTo,
01280     IN PWSTR Path
01281     )
01282 {
01283     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01284     HANDLE <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>;
01285 
01286     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
01287 
01288     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a13">RtlpGetRegistryHandle</a>( RelativeTo, Path, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, &amp;<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a> );
01289     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
01290         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01291     }
01292 
01293     ZwClose( <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a> );
01294     <span class="keywordflow">return</span> STATUS_SUCCESS;
01295 }
01296 
01297 
01298 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01299"></a><a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a23">01299</a> <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a23">RtlDeleteRegistryValue</a>(
01300     IN ULONG RelativeTo,
01301     IN PCWSTR Path,
01302     IN PCWSTR ValueName
01303     )
01304 {
01305     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01306     UNICODE_STRING KeyValueName;
01307     HANDLE <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>;
01308 
01309     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
01310 
01311     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a13">RtlpGetRegistryHandle</a>( RelativeTo, Path, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, &amp;<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a> );
01312     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
01313         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01314         }
01315 
01316     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;KeyValueName, <a class="code" href="../../d1/d1/rtdelval_8c.html#a3">ValueName</a> );
01317     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwDeleteValueKey( <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>, &amp;KeyValueName );
01318 
01319     ZwClose( <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a> );
01320     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01321 }
01322 
01323 
01324 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01325"></a><a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a24">01325</a> <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a24">RtlExpandEnvironmentStrings_U</a>(
01326     IN PVOID Environment OPTIONAL,
01327     IN PUNICODE_STRING Source,
01328     OUT PUNICODE_STRING Destination,
01329     OUT PULONG ReturnedLength OPTIONAL
01330     )
01331 {
01332     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>, Status1;
01333     PWCHAR Src, Src1, Dst;
01334     UNICODE_STRING VariableName, VariableValue;
01335     ULONG SrcLength, DstLength, VarLength, RequiredLength;
01336 
01337     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
01338 
01339     Src = Source-&gt;Buffer;
01340     SrcLength = Source-&gt;Length;
01341     Dst = Destination-&gt;Buffer;
01342     DstLength = Destination-&gt;MaximumLength;
01343     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01344     RequiredLength = 0;
01345     <span class="keywordflow">while</span> (SrcLength &gt;= <span class="keyword">sizeof</span>(WCHAR)) {
01346         <span class="keywordflow">if</span> (*Src == <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'%'</span>) {
01347             Src1 = Src + 1;
01348             VarLength = 0;
01349             VariableName.Length = 0;
01350             VariableName.Buffer = Src1;
01351 
01352             <span class="keywordflow">while</span> (VarLength &lt; (SrcLength - <span class="keyword">sizeof</span>(WCHAR))) {
01353                 <span class="keywordflow">if</span> (*Src1 == <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'%'</span>) {
01354                     <span class="keywordflow">if</span> (VarLength) {
01355                         VariableName.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)VarLength;
01356                         VariableName.MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)VarLength;
01357                     }
01358                     <span class="keywordflow">break</span>;
01359 
01360                 }
01361 
01362                 Src1++;
01363                 VarLength += <span class="keyword">sizeof</span>(WCHAR);
01364             }
01365 
01366             <span class="keywordflow">if</span> (VariableName.Length) {
01367                 VariableValue.Buffer = Dst;
01368                 VariableValue.Length = 0;
01369                 VariableValue.MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)DstLength;
01370                 Status1 = <a class="code" href="../../d5/d7/environ_8c.html#a6">RtlQueryEnvironmentVariable_U</a>( Environment,
01371                                                          &amp;VariableName,
01372                                                          &amp;VariableValue
01373                                                        );
01374                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status1 ) || Status1 == STATUS_BUFFER_TOO_SMALL) {
01375                     RequiredLength += VariableValue.Length;
01376                     Src = Src1 + 1;
01377                     SrcLength -= (VarLength + 2*<span class="keyword">sizeof</span>(WCHAR));
01378 
01379                     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status1 )) {
01380                         DstLength -= VariableValue.Length;
01381                         Dst += VariableValue.Length / <span class="keyword">sizeof</span>(WCHAR);
01382 
01383                     } <span class="keywordflow">else</span> {
01384                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = Status1;
01385                     }
01386 
01387                     <span class="keywordflow">continue</span>;
01388                 }
01389             }
01390         }
01391 
01392         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
01393             <span class="keywordflow">if</span> (DstLength &gt; <span class="keyword">sizeof</span>(WCHAR)) {
01394                 DstLength -= <span class="keyword">sizeof</span>(WCHAR);
01395                 *Dst++ = *Src;
01396 
01397             } <span class="keywordflow">else</span> {
01398                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_BUFFER_TOO_SMALL;
01399             }
01400         }
01401 
01402         RequiredLength += <span class="keyword">sizeof</span>(WCHAR);
01403         SrcLength -= <span class="keyword">sizeof</span>(WCHAR);
01404         Src++;
01405     }
01406 
01407     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
01408         <span class="keywordflow">if</span> (DstLength) {
01409             DstLength -= <span class="keyword">sizeof</span>(WCHAR);
01410             *Dst = UNICODE_NULL;
01411 
01412         } <span class="keywordflow">else</span> {
01413             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_BUFFER_TOO_SMALL;
01414         }
01415     }
01416 
01417     RequiredLength += <span class="keyword">sizeof</span>(WCHAR);
01418 
01419     <span class="keywordflow">if</span> (ARGUMENT_PRESENT( ReturnedLength )) {
01420         *ReturnedLength = RequiredLength;
01421     }
01422 
01423     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
01424         Destination-&gt;Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(RequiredLength - <span class="keyword">sizeof</span>(WCHAR));
01425     }
01426 
01427     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01428 }
01429 
01430 
01431 ULONG
<a name="l01432"></a><a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a25">01432</a> <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a25">RtlGetNtGlobalFlags</a>( VOID )
01433 {
01434 <span class="preprocessor">#ifdef NTOS_KERNEL_RUNTIME</span>
01435 <span class="preprocessor"></span>    <span class="keywordflow">return</span> <a class="code" href="../../d9/d2/ldrp_8h.html#a33">NtGlobalFlag</a>;
01436 <span class="preprocessor">#else</span>
01437 <span class="preprocessor"></span>    <span class="keywordflow">return</span> NtCurrentPeb()-&gt;NtGlobalFlag;
01438 <span class="preprocessor">#endif</span>
01439 <span class="preprocessor"></span>}
01440 
01441 
01442 <span class="comment">//</span>
01443 <span class="comment">// Maximum size of TOKEN_USER information.</span>
01444 <span class="comment">//</span>
01445 
<a name="l01446"></a><a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a3">01446</a> <span class="preprocessor">#define SIZE_OF_TOKEN_INFORMATION                   \</span>
01447 <span class="preprocessor">    sizeof( TOKEN_USER )                            \</span>
01448 <span class="preprocessor">    + sizeof( SID )                                 \</span>
01449 <span class="preprocessor">    + sizeof( ULONG ) * SID_MAX_SUB_AUTHORITIES</span>
01450 <span class="preprocessor"></span>
01451 
01452 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01453"></a><a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a26">01453</a> <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a26">RtlFormatCurrentUserKeyPath</a>(
01454     OUT PUNICODE_STRING CurrentUserKeyPath
01455     )
01456 
01457 <span class="comment">/*++</span>
01458 <span class="comment"></span>
01459 <span class="comment">Routine Description:</span>
01460 <span class="comment"></span>
01461 <span class="comment">    Initialize the supplied buffer with a string representation</span>
01462 <span class="comment">    of the current user's SID.</span>
01463 <span class="comment"></span>
01464 <span class="comment">Arguments:</span>
01465 <span class="comment"></span>
01466 <span class="comment">    CurrentUserKeyPath - Returns a string that represents the current</span>
01467 <span class="comment">        user's root key in the Registry.  Caller must call</span>
01468 <span class="comment">        RtlFreeUnicodeString to free the buffer when done with it.</span>
01469 <span class="comment"></span>
01470 <span class="comment">Return Value:</span>
01471 <span class="comment"></span>
01472 <span class="comment">    NTSTATUS - Returns STATUS_SUCCESS if the user string was</span>
01473 <span class="comment">        succesfully initialized.</span>
01474 <span class="comment"></span>
01475 <span class="comment">--*/</span>
01476 
01477 {
01478     HANDLE TokenHandle;
01479     UCHAR TokenInformation[ <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a3">SIZE_OF_TOKEN_INFORMATION</a> ];
01480     ULONG ReturnLength;
01481     ULONG SidStringLength ;
01482     UNICODE_STRING SidString ;
01483     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01484 
01485     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwOpenThreadToken( NtCurrentThread(),
01486                                  TOKEN_READ,
01487                                  <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
01488                                  &amp;TokenHandle
01489                                );
01490 
01491     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ) &amp;&amp; ( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_NO_TOKEN ) ) {
01492         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01493     }
01494 
01495     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ) ) {
01496 
01497         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwOpenProcessToken( NtCurrentProcess(),
01498                                      TOKEN_READ,
01499                                      &amp;TokenHandle
01500                                    );
01501         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
01502             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01503         }
01504     }
01505 
01506     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwQueryInformationToken( TokenHandle,
01507                                       TokenUser,
01508                                       TokenInformation,
01509                                       <span class="keyword">sizeof</span>( TokenInformation ),
01510                                       &amp;ReturnLength
01511                                     );
01512 
01513     ZwClose( TokenHandle );
01514 
01515     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
01516         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01517     }
01518 
01519     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a48">RtlLengthSidAsUnicodeString</a>(
01520                         ((PTOKEN_USER)TokenInformation)-&gt;User.Sid,
01521                         &amp;SidStringLength
01522                         );
01523 
01524     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ) ) {
01525         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> ;
01526     }
01527 
01528     CurrentUserKeyPath-&gt;Length = 0;
01529     CurrentUserKeyPath-&gt;MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(SidStringLength +
01530                                         <span class="keyword">sizeof</span>( <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\REGISTRY\\USER\\"</span> ) +
01531                                         <span class="keyword">sizeof</span>( UNICODE_NULL ));
01532     CurrentUserKeyPath-&gt;Buffer = (<a class="code" href="../../d8/d2/ldrinit_8c.html#a7">RtlAllocateStringRoutine</a>)( CurrentUserKeyPath-&gt;MaximumLength );
01533     <span class="keywordflow">if</span> (CurrentUserKeyPath-&gt;Buffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01534         <span class="keywordflow">return</span> STATUS_NO_MEMORY;
01535     }
01536 
01537     <span class="comment">//</span>
01538     <span class="comment">// Copy "\REGISTRY\USER" to the current user string.</span>
01539     <span class="comment">//</span>
01540 
01541     <a class="code" href="../../d6/d6/nls_8c.html#a45">RtlAppendUnicodeToString</a>( CurrentUserKeyPath, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"\\REGISTRY\\USER\\"</span> );
01542 
01543     SidString.MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)SidStringLength ;
01544     SidString.Length = 0 ;
01545     SidString.Buffer = CurrentUserKeyPath-&gt;Buffer +
01546             (CurrentUserKeyPath-&gt;Length / <span class="keyword">sizeof</span>(WCHAR) );
01547 
01548     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d6/sertl_8c.html#a49">RtlConvertSidToUnicodeString</a>( &amp;SidString,
01549                                            ((PTOKEN_USER)TokenInformation)-&gt;User.Sid,
01550                                            <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
01551                                          );
01552     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
01553         <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( CurrentUserKeyPath );
01554 
01555     } <span class="keywordflow">else</span> {
01556         CurrentUserKeyPath-&gt;Length += SidString.Length ;
01557     }
01558 
01559     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01560 }
01561 
01562 
01563 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01564"></a><a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a27">01564</a> <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a27">RtlOpenCurrentUser</a>(
01565     IN ULONG DesiredAccess,
01566     OUT PHANDLE CurrentUserKey
01567     )
01568 
01569 <span class="comment">/*++</span>
01570 <span class="comment"></span>
01571 <span class="comment">Routine Description:</span>
01572 <span class="comment"></span>
01573 <span class="comment">    Attempts to open the the HKEY_CURRENT_USER predefined handle.</span>
01574 <span class="comment"></span>
01575 <span class="comment">Arguments:</span>
01576 <span class="comment"></span>
01577 <span class="comment">    DesiredAccess - Specifies the access to open the key for.</span>
01578 <span class="comment"></span>
01579 <span class="comment">    CurrentUserKey - Returns a handle to the key \REGISTRY\USER\*.</span>
01580 <span class="comment"></span>
01581 <span class="comment">Return Value:</span>
01582 <span class="comment"></span>
01583 <span class="comment">    Returns ERROR_SUCCESS (0) for success; error-code for failure.</span>
01584 <span class="comment"></span>
01585 <span class="comment">--*/</span>
01586 
01587 {
01588     UNICODE_STRING      CurrentUserKeyPath;
01589     OBJECT_ATTRIBUTES   Obja;
01590     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>            <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01591 
01592     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
01593 
01594     <span class="comment">//</span>
01595     <span class="comment">// Format the registry path for the current user.</span>
01596     <span class="comment">//</span>
01597 
01598     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a26">RtlFormatCurrentUserKeyPath</a>( &amp;CurrentUserKeyPath );
01599     <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ) {
01600 
01601         InitializeObjectAttributes( &amp;Obja,
01602                                     &amp;CurrentUserKeyPath,
01603                                     OBJ_CASE_INSENSITIVE,
01604                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01605                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
01606                                   );
01607         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwOpenKey( CurrentUserKey,
01608                             DesiredAccess,
01609                             &amp;Obja
01610                           );
01611         <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>( &amp;CurrentUserKeyPath );
01612     }
01613 
01614     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ) {
01615         <span class="comment">//</span>
01616         <span class="comment">// Opening \REGISTRY\USER&lt;SID&gt; failed, try \REGISTRY\USER\.DEFAULT</span>
01617         <span class="comment">//</span>
01618         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;CurrentUserKeyPath, <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a4">RtlpRegistryPaths</a>[ RTL_REGISTRY_USER ] );
01619         InitializeObjectAttributes( &amp;Obja,
01620                                     &amp;CurrentUserKeyPath,
01621                                     OBJ_CASE_INSENSITIVE,
01622                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01623                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
01624                                   );
01625 
01626         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwOpenKey( CurrentUserKey,
01627                             DesiredAccess,
01628                             &amp;Obja
01629                           );
01630     }
01631 
01632     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01633 }
01634 
01635 
01636 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01637"></a><a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a18">01637</a> <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a18">RtlpGetTimeZoneInfoHandle</a>(
01638     IN BOOLEAN WriteAccess,
01639     OUT PHANDLE Key
01640     )
01641 {
01642     <span class="keywordflow">return</span> <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a13">RtlpGetRegistryHandle</a>( RTL_REGISTRY_CONTROL, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"TimeZoneInformation"</span>, WriteAccess, <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a> );
01643 }
01644 
01645 
01646 
<a name="l01647"></a><a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a6">01647</a> <span class="keyword">extern</span>  <span class="keyword">const</span> WCHAR <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a6">szBias</a>[];
<a name="l01648"></a><a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a7">01648</a> <span class="keyword">extern</span>  <span class="keyword">const</span> WCHAR <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a7">szStandardName</a>[];
<a name="l01649"></a><a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a8">01649</a> <span class="keyword">extern</span>  <span class="keyword">const</span> WCHAR <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a8">szStandardBias</a>[];
<a name="l01650"></a><a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a9">01650</a> <span class="keyword">extern</span>  <span class="keyword">const</span> WCHAR <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a9">szStandardStart</a>[];
<a name="l01651"></a><a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a10">01651</a> <span class="keyword">extern</span>  <span class="keyword">const</span> WCHAR <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a10">szDaylightName</a>[];
<a name="l01652"></a><a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a11">01652</a> <span class="keyword">extern</span>  <span class="keyword">const</span> WCHAR <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a11">szDaylightBias</a>[];
<a name="l01653"></a><a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a12">01653</a> <span class="keyword">extern</span>  <span class="keyword">const</span> WCHAR <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a12">szDaylightStart</a>[];
01654 
01655 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01656"></a><a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a28">01656</a> <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a28">RtlQueryTimeZoneInformation</a>(
01657     OUT PRTL_TIME_ZONE_INFORMATION TimeZoneInformation
01658     )
01659 {
01660     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01661     HANDLE <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>;
01662     UNICODE_STRING StandardName, DaylightName;
01663     RTL_QUERY_REGISTRY_TABLE RegistryConfigurationTable[ 8 ];
01664 
01665     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
01666 
01667     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a18">RtlpGetTimeZoneInfoHandle</a>( <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, &amp;<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a> );
01668     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
01669         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01670     }
01671 
01672     RtlZeroMemory( TimeZoneInformation, <span class="keyword">sizeof</span>( *TimeZoneInformation ) );
01673     RtlZeroMemory( RegistryConfigurationTable, <span class="keyword">sizeof</span>( RegistryConfigurationTable ) );
01674 
01675     RegistryConfigurationTable[ 0 ].Flags = RTL_QUERY_REGISTRY_DIRECT;
01676     RegistryConfigurationTable[ 0 ].Name = (PWSTR)<a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a6">szBias</a>;
01677     RegistryConfigurationTable[ 0 ].EntryContext = &amp;TimeZoneInformation-&gt;Bias;
01678 
01679 
01680     StandardName.Buffer = TimeZoneInformation-&gt;StandardName;
01681     StandardName.Length = 0;
01682     StandardName.MaximumLength = <span class="keyword">sizeof</span>( TimeZoneInformation-&gt;StandardName );
01683     RegistryConfigurationTable[ 1 ].Flags = RTL_QUERY_REGISTRY_DIRECT;
01684     RegistryConfigurationTable[ 1 ].Name = (PWSTR)<a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a7">szStandardName</a>;
01685     RegistryConfigurationTable[ 1 ].EntryContext = &amp;StandardName;
01686 
01687     RegistryConfigurationTable[ 2 ].Flags = RTL_QUERY_REGISTRY_DIRECT;
01688     RegistryConfigurationTable[ 2 ].Name = (PWSTR)<a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a8">szStandardBias</a>;
01689     RegistryConfigurationTable[ 2 ].EntryContext = &amp;TimeZoneInformation-&gt;StandardBias;
01690 
01691     RegistryConfigurationTable[ 3 ].Flags = RTL_QUERY_REGISTRY_DIRECT;
01692     RegistryConfigurationTable[ 3 ].Name = (PWSTR)<a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a9">szStandardStart</a>;
01693     RegistryConfigurationTable[ 3 ].EntryContext = &amp;TimeZoneInformation-&gt;StandardStart;
01694     *(PLONG)(RegistryConfigurationTable[ 3 ].EntryContext) = -(LONG)<span class="keyword">sizeof</span>( TIME_FIELDS );
01695 
01696     DaylightName.Buffer = TimeZoneInformation-&gt;DaylightName;
01697     DaylightName.Length = 0;
01698     DaylightName.MaximumLength = <span class="keyword">sizeof</span>( TimeZoneInformation-&gt;DaylightName );
01699     RegistryConfigurationTable[ 4 ].Flags = RTL_QUERY_REGISTRY_DIRECT;
01700     RegistryConfigurationTable[ 4 ].Name = (PWSTR)<a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a10">szDaylightName</a>;
01701     RegistryConfigurationTable[ 4 ].EntryContext = &amp;DaylightName;
01702 
01703     RegistryConfigurationTable[ 5 ].Flags = RTL_QUERY_REGISTRY_DIRECT;
01704     RegistryConfigurationTable[ 5 ].Name = (PWSTR)<a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a11">szDaylightBias</a>;
01705     RegistryConfigurationTable[ 5 ].EntryContext = &amp;TimeZoneInformation-&gt;DaylightBias;
01706 
01707     RegistryConfigurationTable[ 6 ].Flags = RTL_QUERY_REGISTRY_DIRECT;
01708     RegistryConfigurationTable[ 6 ].Name = (PWSTR)<a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a12">szDaylightStart</a>;
01709     RegistryConfigurationTable[ 6 ].EntryContext = &amp;TimeZoneInformation-&gt;DaylightStart;
01710     *(PLONG)(RegistryConfigurationTable[ 6 ].EntryContext) = -(LONG)<span class="keyword">sizeof</span>( TIME_FIELDS );
01711 
01712     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a19">RtlQueryRegistryValues</a>( RTL_REGISTRY_HANDLE,
01713                                      (PWSTR)<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>,
01714                                      RegistryConfigurationTable,
01715                                      <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01716                                      <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
01717                                    );
01718     ZwClose( <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a> );
01719     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01720 }
01721 
01722 
01723 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01724"></a><a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a29">01724</a> <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a29">RtlSetTimeZoneInformation</a>(
01725     IN PRTL_TIME_ZONE_INFORMATION TimeZoneInformation
01726     )
01727 {
01728     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01729     HANDLE <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>;
01730 
01731     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
01732 
01733     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a18">RtlpGetTimeZoneInfoHandle</a>( <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, &amp;<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a> );
01734     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
01735         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01736     }
01737 
01738     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a20">RtlWriteRegistryValue</a>( RTL_REGISTRY_HANDLE,
01739                                     (PWSTR)<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>,
01740                                     <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a6">szBias</a>,
01741                                     REG_DWORD,
01742                                     &amp;TimeZoneInformation-&gt;Bias,
01743                                     <span class="keyword">sizeof</span>( TimeZoneInformation-&gt;Bias )
01744                                   );
01745     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
01746         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a20">RtlWriteRegistryValue</a>( RTL_REGISTRY_HANDLE,
01747                                         (PWSTR)<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>,
01748                                         <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a7">szStandardName</a>,
01749                                         REG_SZ,
01750                                         TimeZoneInformation-&gt;StandardName,
01751                                         (wcslen( TimeZoneInformation-&gt;StandardName ) + 1) * <span class="keyword">sizeof</span>( WCHAR )
01752                                       );
01753     }
01754 
01755     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
01756         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a20">RtlWriteRegistryValue</a>( RTL_REGISTRY_HANDLE,
01757                                         (PWSTR)<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>,
01758                                         <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a8">szStandardBias</a>,
01759                                         REG_DWORD,
01760                                         &amp;TimeZoneInformation-&gt;StandardBias,
01761                                         <span class="keyword">sizeof</span>( TimeZoneInformation-&gt;StandardBias )
01762                                       );
01763     }
01764 
01765     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
01766         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a20">RtlWriteRegistryValue</a>( RTL_REGISTRY_HANDLE,
01767                                         (PWSTR)<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>,
01768                                         <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a9">szStandardStart</a>,
01769                                         REG_BINARY,
01770                                         &amp;TimeZoneInformation-&gt;StandardStart,
01771                                         <span class="keyword">sizeof</span>( TimeZoneInformation-&gt;StandardStart )
01772                                       );
01773     }
01774 
01775     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
01776         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a20">RtlWriteRegistryValue</a>( RTL_REGISTRY_HANDLE,
01777                                         (PWSTR)<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>,
01778                                         <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a10">szDaylightName</a>,
01779                                         REG_SZ,
01780                                         TimeZoneInformation-&gt;DaylightName,
01781                                         (wcslen( TimeZoneInformation-&gt;DaylightName ) + 1) * <span class="keyword">sizeof</span>( WCHAR )
01782                                       );
01783     }
01784 
01785     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
01786         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a20">RtlWriteRegistryValue</a>( RTL_REGISTRY_HANDLE,
01787                                         (PWSTR)<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>,
01788                                         <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a11">szDaylightBias</a>,
01789                                         REG_DWORD,
01790                                         &amp;TimeZoneInformation-&gt;DaylightBias,
01791                                         <span class="keyword">sizeof</span>( TimeZoneInformation-&gt;DaylightBias )
01792                                       );
01793     }
01794 
01795     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
01796         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a20">RtlWriteRegistryValue</a>( RTL_REGISTRY_HANDLE,
01797                                         (PWSTR)<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>,
01798                                         <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a12">szDaylightStart</a>,
01799                                         REG_BINARY,
01800                                         &amp;TimeZoneInformation-&gt;DaylightStart,
01801                                         <span class="keyword">sizeof</span>( TimeZoneInformation-&gt;DaylightStart )
01802                                       );
01803     }
01804 
01805     ZwClose( <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a> );
01806     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01807 }
01808 
01809 
01810 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01811"></a><a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a30">01811</a> <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a30">RtlSetActiveTimeBias</a>(
01812     IN LONG ActiveBias
01813     )
01814 {
01815     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01816     HANDLE <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>;
01817     RTL_QUERY_REGISTRY_TABLE RegistryConfigurationTable[ 2 ];
01818     LONG CurrentActiveBias;
01819 
01820     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
01821 
01822     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a18">RtlpGetTimeZoneInfoHandle</a>( <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, &amp;<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a> );
01823     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> )) {
01824         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01825     }
01826 
01827     RtlZeroMemory( RegistryConfigurationTable, <span class="keyword">sizeof</span>( RegistryConfigurationTable ) );
01828     RegistryConfigurationTable[ 0 ].Flags = RTL_QUERY_REGISTRY_DIRECT | RTL_QUERY_REGISTRY_REQUIRED;
01829     RegistryConfigurationTable[ 0 ].Name = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"ActiveTimeBias"</span>;
01830     RegistryConfigurationTable[ 0 ].EntryContext = &amp;CurrentActiveBias;
01831 
01832     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a19">RtlQueryRegistryValues</a>( RTL_REGISTRY_HANDLE,
01833                                      (PWSTR)<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>,
01834                                      RegistryConfigurationTable,
01835                                      <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01836                                      <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
01837                                    );
01838 
01839     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) || CurrentActiveBias != ActiveBias ) {
01840 
01841         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d7/rtl_2regutil_8c.html#a20">RtlWriteRegistryValue</a>( RTL_REGISTRY_HANDLE,
01842                                         (PWSTR)<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>,
01843                                         <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"ActiveTimeBias"</span>,
01844                                         REG_DWORD,
01845                                         &amp;ActiveBias,
01846                                         <span class="keyword">sizeof</span>( ActiveBias )
01847                                       );
01848     }
01849 
01850     ZwClose( <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a> );
01851     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01852 }
01853 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:38 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
