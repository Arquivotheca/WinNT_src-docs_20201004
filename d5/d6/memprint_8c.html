<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: memprint.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>memprint.c File Reference</h1><code>#include "<a class="el" href="../../d5/d9/exp_8h-source.html">exp.h</a>"</code><br>
<code>#include &lt;stdarg.h&gt;</code><br>
<code>#include &lt;string.h&gt;</code><br>
<code>#include &lt;<a class="el" href="../../d7/d5/memprint_8h-source.html">memprint.h</a>&gt;</code><br>

<p>
<a href="../../d6/d5/memprint_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Classes</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>struct &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d8/struct__MEM__PRINT__MESSAGE__HEADER.html">_MEM_PRINT_MESSAGE_HEADER</a></td></tr>

<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/memprint_8c.html#a0">MEM_PRINT_MAX_MESSAGE_SIZE</a>&nbsp;&nbsp;&nbsp;256</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/memprint_8c.html#a1">MEM_PRINT_SUBBUFFER_SIZE</a>&nbsp;&nbsp;&nbsp;(<a class="el" href="../../d5/d6/memprint_8c.html#a5">MemPrintBufferSize</a> / <a class="el" href="../../d5/d6/memprint_8c.html#a6">MemPrintSubbufferCount</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/memprint_8c.html#a2">GET_MEM_PRINT_SUBBUFFER</a>(i)&nbsp;&nbsp;&nbsp;((CSHORT)( (i) / MEM_PRINT_SUBBUFFER_SIZE ))</td></tr>

<tr><td colspan=2><br><h2>Typedefs</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d0/d8/struct__MEM__PRINT__MESSAGE__HEADER.html">_MEM_PRINT_MESSAGE_HEADER</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/memprint_8c.html#a3">MEM_PRINT_MESSAGE_HEADER</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d0/d8/struct__MEM__PRINT__MESSAGE__HEADER.html">_MEM_PRINT_MESSAGE_HEADER</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/memprint_8c.html#a4">PMEM_PRINT_MESSAGE_HEADER</a></td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/memprint_8c.html#a16">MemPrintWriteCompleteApc</a> (IN PVOID ApcContext, IN PIO_STATUS_BLOCK IoStatusBlock, IN ULONG Reserved)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/memprint_8c.html#a17">MemPrintWriteThread</a> (IN PVOID Dummy)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/memprint_8c.html#a18">MemPrintInitialize</a> (VOID)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/memprint_8c.html#a19">MemPrint</a> (<a class="el" href="../../d2/d1/bench_8h.html#a8">CHAR</a> *Format,...)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/memprint_8c.html#a20">MemPrintFlush</a> (VOID)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>CLONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/memprint_8c.html#a5">MemPrintBufferSize</a> = MEM_PRINT_DEF_BUFFER_SIZE</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>CLONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/memprint_8c.html#a6">MemPrintSubbufferCount</a> = MEM_PRINT_DEF_SUBBUFFER_COUNT</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>PCHAR&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/memprint_8c.html#a7">MemPrintBuffer</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/memprint_8c.html#a8">MemPrintFlags</a> = MEM_PRINT_FLAG_CONSOLE</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>KSPIN_LOCK&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/memprint_8c.html#a9">MemPrintSpinLock</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d2/d1/bench_8h.html#a8">CHAR</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/memprint_8c.html#a10">MemPrintTempBuffer</a> [MEM_PRINT_MAX_MESSAGE_SIZE]</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/memprint_8c.html#a11">MemPrintInitialized</a> = FALSE</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>CLONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/memprint_8c.html#a12">MemPrintIndex</a> = 0</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>CLONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/memprint_8c.html#a13">MemPrintCurrentSubbuffer</a> = 0</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/memprint_8c.html#a14">MemPrintSubbufferWriting</a> [MEM_PRINT_MAX_SUBBUFFER_COUNT]</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d2/d6/struct__KEVENT.html">KEVENT</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d5/d6/memprint_8c.html#a15">MemPrintSubbufferFullEvent</a> [MEM_PRINT_MAX_SUBBUFFER_COUNT]</td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a2" doxytag="memprint.c::GET_MEM_PRINT_SUBBUFFER" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define GET_MEM_PRINT_SUBBUFFER          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">i&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;((CSHORT)( (i) / MEM_PRINT_SUBBUFFER_SIZE ))</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/memprint_8c-source.html#l00062">62</a> of file <a class="el" href="../../d6/d5/memprint_8c-source.html">memprint.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d5/memprint_8c-source.html#l00250">MemPrint()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="memprint.c::MEM_PRINT_MAX_MESSAGE_SIZE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define MEM_PRINT_MAX_MESSAGE_SIZE&nbsp;&nbsp;&nbsp;256          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/memprint_8c-source.html#l00053">53</a> of file <a class="el" href="../../d6/d5/memprint_8c-source.html">memprint.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d5/memprint_8c-source.html#l00250">MemPrint()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="memprint.c::MEM_PRINT_SUBBUFFER_SIZE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define MEM_PRINT_SUBBUFFER_SIZE&nbsp;&nbsp;&nbsp;(<a class="el" href="../../d5/d6/memprint_8c.html#a5">MemPrintBufferSize</a> / <a class="el" href="../../d5/d6/memprint_8c.html#a6">MemPrintSubbufferCount</a>)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/memprint_8c-source.html#l00060">60</a> of file <a class="el" href="../../d6/d5/memprint_8c-source.html">memprint.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d5/memprint_8c-source.html#l00492">MemPrintFlush()</a>, and <a class="el" href="../../d6/d5/memprint_8c-source.html#l00598">MemPrintWriteThread()</a>.    </td>
  </tr>
</table>
<hr><h2>Typedef Documentation</h2>
<a class="anchor" name="a3" doxytag="memprint.c::MEM_PRINT_MESSAGE_HEADER" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d0/d8/struct__MEM__PRINT__MESSAGE__HEADER.html">_MEM_PRINT_MESSAGE_HEADER</a>  <a class="el" href="../../d0/d8/struct__MEM__PRINT__MESSAGE__HEADER.html">MEM_PRINT_MESSAGE_HEADER</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="memprint.c::PMEM_PRINT_MESSAGE_HEADER" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef struct <a class="el" href="../../d0/d8/struct__MEM__PRINT__MESSAGE__HEADER.html">_MEM_PRINT_MESSAGE_HEADER</a> * <a class="el" href="../../d0/d8/struct__MEM__PRINT__MESSAGE__HEADER.html">PMEM_PRINT_MESSAGE_HEADER</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d6/d5/memprint_8c-source.html#l00250">MemPrint()</a>, and <a class="el" href="../../d6/d5/memprint_8c-source.html#l00492">MemPrintFlush()</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a19" doxytag="memprint.c::MemPrint" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MemPrint           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d2/d1/bench_8h.html#a8">CHAR</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>Format</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>&nbsp;</td>
          <td class="mdname" nowrap> <em>...</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/memprint_8c-source.html#l00250">250</a> of file <a class="el" href="../../d6/d5/memprint_8c-source.html">memprint.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d0/bench_8c-source.html#l00050">CHAR</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d5/memprint_8c-source.html#l00062">GET_MEM_PRINT_SUBBUFFER</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02007">KeAcquireSpinLock</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a119">KeReleaseSpinLock()</a>, <a class="el" href="../../d3/d7/eventobj_8c-source.html#l00343">KeSetEvent()</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00029">MEM_PRINT_FLAG_CONSOLE</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00031">MEM_PRINT_FLAG_HEADER</a>, <a class="el" href="../../d6/d5/memprint_8c-source.html#l00053">MEM_PRINT_MAX_MESSAGE_SIZE</a>, <a class="el" href="../../d6/d5/memprint_8c-source.html#l00080">MemPrintBuffer</a>, <a class="el" href="../../d6/d5/memprint_8c-source.html#l00078">MemPrintBufferSize</a>, <a class="el" href="../../d6/d5/memprint_8c-source.html#l00102">MemPrintCurrentSubbuffer</a>, <a class="el" href="../../d6/d5/memprint_8c-source.html#l00082">MemPrintFlags</a>, <a class="el" href="../../d6/d5/memprint_8c-source.html#l00094">MemPrintIndex</a>, <a class="el" href="../../d6/d5/memprint_8c-source.html#l00088">MemPrintInitialized</a>, <a class="el" href="../../d6/d5/memprint_8c-source.html#l00084">MemPrintSpinLock</a>, <a class="el" href="../../d6/d5/memprint_8c-source.html#l00079">MemPrintSubbufferCount</a>, <a class="el" href="../../d6/d5/memprint_8c-source.html#l00120">MemPrintSubbufferFullEvent</a>, <a class="el" href="../../d6/d5/memprint_8c-source.html#l00110">MemPrintSubbufferWriting</a>, <a class="el" href="../../d5/d6/memprint_8c.html#a4">PMEM_PRINT_MESSAGE_HEADER</a>, <a class="el" href="../../d6/d5/memprint_8c-source.html#l00070">_MEM_PRINT_MESSAGE_HEADER::Size</a>, <a class="el" href="../../d2/d7/regtest_8c.html#a2">strlen()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d6/d5/memprint_8c-source.html#l00071">_MEM_PRINT_MESSAGE_HEADER::Type</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
<pre class="fragment"><div>00256                    :
00257 
00258     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called in place of <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> to process in-memory
00259     printing.
00260 
00261 Arguments:
00262 
00263     Format - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> <a class="code" href="../../d8/d0/rtbatcr_8c.html#a8">format</a> string in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> style of <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>.
00264 
00265            - formatting arguments.
00266 
00267 Return Value:
00268 
00269     None.
00270 
00271 --*/
00272 
00273 {
00274     va_list arglist;
00275     KIRQL oldIrql;
00276     CLONG nextSubbuffer;
00277     <a class="code" href="../../d0/d8/struct__MEM__PRINT__MESSAGE__HEADER.html">PMEM_PRINT_MESSAGE_HEADER</a> messageHeader;
00278     <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> tempBuffer[<a class="code" href="../../d5/d6/memprint_8c.html#a0">MEM_PRINT_MAX_MESSAGE_SIZE</a>];
00279 
00280     va_start(arglist, Format);
00281     _vsnprintf( tempBuffer, <span class="keyword">sizeof</span>( tempBuffer ), Format, arglist );
00282     va_end(arglist);
00283 
00284     <span class="comment">//</span>
00285     <span class="comment">// If memory DbgPrint has not been initialized, simply print to the</span>
00286     <span class="comment">// console.</span>
00287     <span class="comment">//</span>
00288 
00289     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/memprint_8c.html#a11">MemPrintInitialized</a> ) {
00290 
00291         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"%s"</span>, tempBuffer );
00292         <span class="keywordflow">return</span>;
00293     }
00294 
00295     <span class="comment">//</span>
00296     <span class="comment">// Acquire the spin lock that synchronizes access to the pointers</span>
00297     <span class="comment">// and circular buffer.</span>
00298     <span class="comment">//</span>
00299 
00300     <a class="code" href="../../d4/d9/ke_8h.html#a37">KeAcquireSpinLock</a>( &amp;MemPrintSpinLock, &amp;oldIrql );
00301 
00302     <span class="comment">//</span>
00303     <span class="comment">// Make sure that the request will fit.  xx_sprintf will just dump</span>
00304     <span class="comment">// all it gets, so assume the message is maximum size, and, if the</span>
00305     <span class="comment">// request would go into the next subbuffer and it is writing, fail</span>
00306     <span class="comment">// the request.</span>
00307     <span class="comment">//</span>
00308 
00309     nextSubbuffer =
00310         <a class="code" href="../../d5/d6/memprint_8c.html#a2">GET_MEM_PRINT_SUBBUFFER</a>( MemPrintIndex + MEM_PRINT_MAX_MESSAGE_SIZE );
00311 
00312     <span class="keywordflow">if</span> (  nextSubbuffer != <a class="code" href="../../d5/d6/memprint_8c.html#a13">MemPrintCurrentSubbuffer</a> ) {
00313 
00314         <span class="comment">//</span>
00315         <span class="comment">// The request will go to a new subbuffer.  Check if we should</span>
00316         <span class="comment">// wrap around to the first subbuffer (i.e. start of circular</span>
00317         <span class="comment">// buffer).</span>
00318         <span class="comment">//</span>
00319 
00320         <span class="keywordflow">if</span> ( nextSubbuffer == <a class="code" href="../../d5/d6/memprint_8c.html#a6">MemPrintSubbufferCount</a> ) {
00321             nextSubbuffer = 0;
00322         }
00323 
00324         <span class="comment">//</span>
00325         <span class="comment">// Is that subbuffer available for use?</span>
00326         <span class="comment">//</span>
00327 
00328         <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/memprint_8c.html#a14">MemPrintSubbufferWriting</a>[nextSubbuffer] ) {
00329 
00330             <span class="comment">//</span>
00331             <span class="comment">// It is in use.  Print to the console.  Oh well.</span>
00332             <span class="comment">//</span>
00333 
00334             <a class="code" href="../../d9/d5/verifier_8c.html#a119">KeReleaseSpinLock</a>( &amp;MemPrintSpinLock, oldIrql );
00335 
00336             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"%s"</span>, tempBuffer );
00337 
00338             <span class="keywordflow">return</span>;
00339         }
00340 
00341         <span class="comment">//</span>
00342         <span class="comment">// If we went to subbuffer 0 and it is available to receive</span>
00343         <span class="comment">// data, set up the "end of last subbuffer" conditions and reset</span>
00344         <span class="comment">// the index into the circular buffer.  By setting a special</span>
00345         <span class="comment">// type value in the message header that precedes the garbage at</span>
00346         <span class="comment">// the end of the last subbuffer, an interpreter program can</span>
00347         <span class="comment">// know to skip over the garbage by using the size in the</span>
00348         <span class="comment">// header.  This is done instead of writing only good data so</span>
00349         <span class="comment">// that we can write just full sectors to disk, thereby</span>
00350         <span class="comment">// enhancing write performance.</span>
00351         <span class="comment">//</span>
00352 
00353         <span class="keywordflow">if</span> ( nextSubbuffer == 0 ) {
00354 
00355             <span class="comment">//</span>
00356             <span class="comment">// Set up the message header.  This always gets done at the</span>
00357             <span class="comment">// end of the circular buffer, regardless of the flags bit.</span>
00358             <span class="comment">//</span>
00359 
00360             messageHeader =
00361                 (<a class="code" href="../../d0/d8/struct__MEM__PRINT__MESSAGE__HEADER.html">PMEM_PRINT_MESSAGE_HEADER</a>)&amp;<a class="code" href="../../d5/d6/memprint_8c.html#a7">MemPrintBuffer</a>[<a class="code" href="../../d5/d6/memprint_8c.html#a12">MemPrintIndex</a>];
00362             RtlStoreUshort(
00363                 &amp;messageHeader-&gt;<a class="code" href="../../d0/d8/struct__MEM__PRINT__MESSAGE__HEADER.html#o0">Size</a>,
00364                 (USHORT)(MemPrintBufferSize - MemPrintIndex - 1)
00365                 );
00366             RtlStoreUshort(
00367                 &amp;messageHeader-&gt;<a class="code" href="../../d0/d8/struct__MEM__PRINT__MESSAGE__HEADER.html#o1">Type</a>,
00368                 (USHORT)0xffff
00369                 );
00370 
00371             <span class="comment">//</span>
00372             <span class="comment">// Zero out the rest of the subbuffer.</span>
00373             <span class="comment">//</span>
00374 
00375             <span class="keywordflow">for</span> ( <a class="code" href="../../d5/d6/memprint_8c.html#a12">MemPrintIndex</a> += <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d8/struct__MEM__PRINT__MESSAGE__HEADER.html">MEM_PRINT_MESSAGE_HEADER</a>);
00376                   <a class="code" href="../../d5/d6/memprint_8c.html#a12">MemPrintIndex</a> &lt; <a class="code" href="../../d5/d6/memprint_8c.html#a5">MemPrintBufferSize</a>;
00377                   <a class="code" href="../../d5/d6/memprint_8c.html#a12">MemPrintIndex</a>++ ) {
00378 
00379                 <a class="code" href="../../d5/d6/memprint_8c.html#a7">MemPrintBuffer</a>[<a class="code" href="../../d5/d6/memprint_8c.html#a12">MemPrintIndex</a>] = 0;
00380             }
00381 
00382             <span class="comment">//</span>
00383             <span class="comment">// Reset the index to start at the beginning of the circular</span>
00384             <span class="comment">// buffer.</span>
00385             <span class="comment">//</span>
00386 
00387             <a class="code" href="../../d5/d6/memprint_8c.html#a12">MemPrintIndex</a> = 0;
00388         }
00389     }
00390 
00391     <span class="comment">//</span>
00392     <span class="comment">// Store a pointer to the location that will contain the message</span>
00393     <span class="comment">// header.</span>
00394     <span class="comment">//</span>
00395 
00396     messageHeader = (<a class="code" href="../../d0/d8/struct__MEM__PRINT__MESSAGE__HEADER.html">PMEM_PRINT_MESSAGE_HEADER</a>)&amp;<a class="code" href="../../d5/d6/memprint_8c.html#a7">MemPrintBuffer</a>[<a class="code" href="../../d5/d6/memprint_8c.html#a12">MemPrintIndex</a>];
00397 
00398     <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/memprint_8c.html#a8">MemPrintFlags</a> &amp; <a class="code" href="../../d6/d6/memprint_8h.html#a2">MEM_PRINT_FLAG_HEADER</a> ) {
00399         <a class="code" href="../../d5/d6/memprint_8c.html#a12">MemPrintIndex</a> += <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d8/struct__MEM__PRINT__MESSAGE__HEADER.html">MEM_PRINT_MESSAGE_HEADER</a>);
00400     }
00401 
00402     <span class="comment">//</span>
00403     <span class="comment">// Dump the formatted string to the subbuffer.  xx_sprintf is a special</span>
00404     <span class="comment">// version of sprintf that takes a variable argument list.</span>
00405     <span class="comment">//</span>
00406 
00407     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( MemPrintIndex + MEM_PRINT_MAX_MESSAGE_SIZE -
00408                 <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d8/struct__MEM__PRINT__MESSAGE__HEADER.html">MEM_PRINT_MESSAGE_HEADER</a>) &lt;= MemPrintBufferSize );
00409 
00410 
00411     RtlMoveMemory( &amp;MemPrintBuffer[MemPrintIndex], tempBuffer, <a class="code" href="../../d2/d7/regtest_8c.html#a2">strlen</a>(tempBuffer)+1 );
00412 
00413     <a class="code" href="../../d5/d6/memprint_8c.html#a12">MemPrintIndex</a> += <a class="code" href="../../d2/d7/regtest_8c.html#a2">strlen</a>(tempBuffer);
00414 
00415     <span class="comment">//</span>
00416     <span class="comment">// Write the total message size to the message header.</span>
00417     <span class="comment">//</span>
00418 
00419     <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/memprint_8c.html#a8">MemPrintFlags</a> &amp; <a class="code" href="../../d6/d6/memprint_8h.html#a2">MEM_PRINT_FLAG_HEADER</a> ) {
00420         messageHeader-&gt;<a class="code" href="../../d0/d8/struct__MEM__PRINT__MESSAGE__HEADER.html#o0">Size</a> =
00421             (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)( &amp;<a class="code" href="../../d5/d6/memprint_8c.html#a7">MemPrintBuffer</a>[<a class="code" href="../../d5/d6/memprint_8c.html#a12">MemPrintIndex</a>] - (PCHAR)messageHeader );
00422         messageHeader-&gt;<a class="code" href="../../d0/d8/struct__MEM__PRINT__MESSAGE__HEADER.html#o1">Type</a> = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)0xdead;
00423         messageHeader++;
00424     }
00425 
00426     <span class="comment">//</span>
00427     <span class="comment">// If it was too large, there's a potential problem with writing off</span>
00428     <span class="comment">// the end of the circular buffer.  Print the offending message to</span>
00429     <span class="comment">// the console and breakpoint.</span>
00430     <span class="comment">//</span>
00431 
00432     <span class="keywordflow">if</span> ( &amp;<a class="code" href="../../d5/d6/memprint_8c.html#a7">MemPrintBuffer</a>[<a class="code" href="../../d5/d6/memprint_8c.html#a12">MemPrintIndex</a>] - (PCHAR)messageHeader &gt;
00433                                                 <a class="code" href="../../d5/d6/memprint_8c.html#a0">MEM_PRINT_MAX_MESSAGE_SIZE</a> ) {
00434         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"Message too long!! :\n"</span> );
00435         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"%s"</span>, messageHeader );
00436         DbgBreakPoint( );
00437     }
00438 
00439     <span class="comment">//</span>
00440     <span class="comment">// Print to the console if the appropriate flag is on.</span>
00441     <span class="comment">//</span>
00442 
00443     <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/memprint_8c.html#a8">MemPrintFlags</a> &amp; <a class="code" href="../../d6/d6/memprint_8h.html#a0">MEM_PRINT_FLAG_CONSOLE</a> ) {
00444         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"%s"</span>, messageHeader );
00445     }
00446 
00447     <span class="comment">//</span>
00448     <span class="comment">// Calculate whether we have stepped into a new subbuffer.</span>
00449     <span class="comment">//</span>
00450 
00451     nextSubbuffer = <a class="code" href="../../d5/d6/memprint_8c.html#a2">GET_MEM_PRINT_SUBBUFFER</a>( MemPrintIndex );
00452 
00453     <span class="keywordflow">if</span> ( nextSubbuffer != <a class="code" href="../../d5/d6/memprint_8c.html#a13">MemPrintCurrentSubbuffer</a> ) {
00454 
00455         <span class="comment">//DbgPrint( "Subbuffer %ld complete.\n", MemPrintCurrentSubbuffer );</span>
00456 
00457         <span class="comment">//</span>
00458         <span class="comment">// We did step into a new subbuffer, so set the boolean to</span>
00459         <span class="comment">// indicate that the old subbuffer is writing to disk, thereby</span>
00460         <span class="comment">// preventing it from being overwritten until the write is</span>
00461         <span class="comment">// complete.</span>
00462         <span class="comment">//</span>
00463 
00464         <a class="code" href="../../d5/d6/memprint_8c.html#a14">MemPrintSubbufferWriting</a>[<a class="code" href="../../d5/d6/memprint_8c.html#a13">MemPrintCurrentSubbuffer</a>] = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00465 
00466         <span class="comment">//</span>
00467         <span class="comment">// Set the event that will wake up the thread writing subbuffers</span>
00468         <span class="comment">// to disk.</span>
00469         <span class="comment">//</span>
00470 
00471         <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>(
00472             &amp;MemPrintSubbufferFullEvent[MemPrintCurrentSubbuffer],
00473             2,
00474             FALSE
00475             );
00476 
00477         <span class="comment">//</span>
00478         <span class="comment">// Update the current subbuffer.</span>
00479         <span class="comment">//</span>
00480 
00481         <a class="code" href="../../d5/d6/memprint_8c.html#a13">MemPrintCurrentSubbuffer</a> = nextSubbuffer;
00482     }
00483 
00484     <a class="code" href="../../d9/d5/verifier_8c.html#a119">KeReleaseSpinLock</a>( &amp;MemPrintSpinLock, oldIrql );
00485 
00486     <span class="keywordflow">return</span>;
00487 
00488 } <span class="comment">// MemPrint</span>

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a20" doxytag="memprint.c::MemPrintFlush" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MemPrintFlush           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/memprint_8c-source.html#l00492">492</a> of file <a class="el" href="../../d6/d5/memprint_8c-source.html">memprint.c</a>.
<p>
References <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02007">KeAcquireSpinLock</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00140">KeDelayExecutionThread()</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a119">KeReleaseSpinLock()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d3/d7/eventobj_8c-source.html#l00343">KeSetEvent()</a>, <a class="el" href="../../d6/d5/memprint_8c-source.html#l00060">MEM_PRINT_SUBBUFFER_SIZE</a>, <a class="el" href="../../d6/d5/memprint_8c-source.html#l00080">MemPrintBuffer</a>, <a class="el" href="../../d6/d5/memprint_8c-source.html#l00078">MemPrintBufferSize</a>, <a class="el" href="../../d6/d5/memprint_8c-source.html#l00102">MemPrintCurrentSubbuffer</a>, <a class="el" href="../../d6/d5/memprint_8c-source.html#l00094">MemPrintIndex</a>, <a class="el" href="../../d6/d5/memprint_8c-source.html#l00084">MemPrintSpinLock</a>, <a class="el" href="../../d6/d5/memprint_8c-source.html#l00120">MemPrintSubbufferFullEvent</a>, <a class="el" href="../../d6/d5/memprint_8c-source.html#l00110">MemPrintSubbufferWriting</a>, <a class="el" href="../../d5/d6/memprint_8c.html#a4">PMEM_PRINT_MESSAGE_HEADER</a>, <a class="el" href="../../d6/d5/memprint_8c-source.html#l00070">_MEM_PRINT_MESSAGE_HEADER::Size</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d6/d5/memprint_8c-source.html#l00071">_MEM_PRINT_MESSAGE_HEADER::Type</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
<pre class="fragment"><div>00498                    :
00499 
00500     This routine causes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current subbuffer to be written to disk,
00501     regardless of how full <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>.  The unwritten part of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> subbuffer
00502     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> zeroed before writing.
00503 
00504 Arguments:
00505 
00506     None.
00507 
00508 Return Value:
00509 
00510     None.
00511 
00512 --*/
00513 
00514 {
00515     KIRQL oldIrql;
00516     <a class="code" href="../../d0/d8/struct__MEM__PRINT__MESSAGE__HEADER.html">PMEM_PRINT_MESSAGE_HEADER</a> messageHeader;
00517     CLONG nextSubbufferIndex;
00518     LARGE_INTEGER delayInterval;
00519 
00520     <span class="comment">//</span>
00521     <span class="comment">// Acquire the spin lock that protects memory DbgPrint variables.</span>
00522     <span class="comment">//</span>
00523 
00524     <a class="code" href="../../d4/d9/ke_8h.html#a37">KeAcquireSpinLock</a>( &amp;MemPrintSpinLock, &amp;oldIrql );
00525 
00526     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"Flushing subbuffer %ld\n"</span>, MemPrintCurrentSubbuffer );
00527 
00528     <span class="comment">//</span>
00529     <span class="comment">// Set up the header that indicates that unused space follows.</span>
00530     <span class="comment">//</span>
00531 
00532     messageHeader =
00533         (<a class="code" href="../../d0/d8/struct__MEM__PRINT__MESSAGE__HEADER.html">PMEM_PRINT_MESSAGE_HEADER</a>)&amp;<a class="code" href="../../d5/d6/memprint_8c.html#a7">MemPrintBuffer</a>[<a class="code" href="../../d5/d6/memprint_8c.html#a12">MemPrintIndex</a>];
00534     messageHeader-&gt;<a class="code" href="../../d0/d8/struct__MEM__PRINT__MESSAGE__HEADER.html#o0">Size</a> =
00535         (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(<a class="code" href="../../d5/d6/memprint_8c.html#a5">MemPrintBufferSize</a> - <a class="code" href="../../d5/d6/memprint_8c.html#a12">MemPrintIndex</a> - 1);
00536     messageHeader-&gt;<a class="code" href="../../d0/d8/struct__MEM__PRINT__MESSAGE__HEADER.html#o1">Type</a> = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)0xffff;
00537 
00538     <span class="comment">//</span>
00539     <span class="comment">// Determine where the next subbuffer starts.</span>
00540     <span class="comment">//</span>
00541 
00542     nextSubbufferIndex =
00543         (<a class="code" href="../../d5/d6/memprint_8c.html#a13">MemPrintCurrentSubbuffer</a> + 1) * <a class="code" href="../../d5/d6/memprint_8c.html#a1">MEM_PRINT_SUBBUFFER_SIZE</a>;
00544 
00545     <span class="comment">//</span>
00546     <span class="comment">// Zero out the rest of the subbuffer.</span>
00547     <span class="comment">//</span>
00548 
00549     <span class="keywordflow">for</span> ( <a class="code" href="../../d5/d6/memprint_8c.html#a12">MemPrintIndex</a> += <span class="keyword">sizeof</span>(<a class="code" href="../../d0/d8/struct__MEM__PRINT__MESSAGE__HEADER.html">MEM_PRINT_MESSAGE_HEADER</a>);
00550           <a class="code" href="../../d5/d6/memprint_8c.html#a12">MemPrintIndex</a> &lt; nextSubbufferIndex;
00551           <a class="code" href="../../d5/d6/memprint_8c.html#a12">MemPrintIndex</a>++ ) {
00552 
00553         <a class="code" href="../../d5/d6/memprint_8c.html#a7">MemPrintBuffer</a>[<a class="code" href="../../d5/d6/memprint_8c.html#a12">MemPrintIndex</a>] = 0;
00554     }
00555 
00556     <span class="comment">//</span>
00557     <span class="comment">// Indicate that the subbuffer should be written to disk.</span>
00558     <span class="comment">//</span>
00559 
00560     <a class="code" href="../../d5/d6/memprint_8c.html#a14">MemPrintSubbufferWriting</a>[<a class="code" href="../../d5/d6/memprint_8c.html#a13">MemPrintCurrentSubbuffer</a>] = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00561 
00562     <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a>(
00563         &amp;MemPrintSubbufferFullEvent[MemPrintCurrentSubbuffer],
00564         8,
00565         FALSE
00566         );
00567 
00568     <span class="comment">//</span>
00569     <span class="comment">// Increment the current subbuffer so that it corresponds with the</span>
00570     <span class="comment">// buffer index.</span>
00571     <span class="comment">//</span>
00572 
00573     <a class="code" href="../../d5/d6/memprint_8c.html#a13">MemPrintCurrentSubbuffer</a>++;
00574 
00575     <a class="code" href="../../d9/d5/verifier_8c.html#a119">KeReleaseSpinLock</a>( &amp;MemPrintSpinLock, oldIrql );
00576 
00577     <span class="comment">//</span>
00578     <span class="comment">// Delay so that the memory print write thread wakes up and performs</span>
00579     <span class="comment">// the write to disk.</span>
00580     <span class="comment">//</span>
00581     <span class="comment">// !!! This is obviously not a perfect solution--the write thread</span>
00582     <span class="comment">//     may never wake up, so this could complete before the flush</span>
00583     <span class="comment">//     is really done.</span>
00584     <span class="comment">//</span>
00585 
00586     delayInterval.QuadPart = -10*10*1000*1000;
00587 
00588     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"Delaying...\n"</span> );
00589     <a class="code" href="../../d1/d7/wait_8c.html#a2">KeDelayExecutionThread</a>( KernelMode, TRUE, &amp;delayInterval );
00590     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"Woke up.\n"</span> );
00591 
00592     <span class="keywordflow">return</span>;
00593 
00594 } <span class="comment">// MemPrintFlush</span>

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a18" doxytag="memprint.c::MemPrintInitialize" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MemPrintInitialize           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">VOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/memprint_8c-source.html#l00124">124</a> of file <a class="el" href="../../d6/d5/memprint_8c-source.html">memprint.c</a>.
<p>
References <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01066">KeInitializeEvent</a>, <a class="el" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock()</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00053">MEM_PRINT_MAX_SUBBUFFER_COUNT</a>, <a class="el" href="../../d6/d5/memprint_8c-source.html#l00080">MemPrintBuffer</a>, <a class="el" href="../../d6/d5/memprint_8c-source.html#l00078">MemPrintBufferSize</a>, <a class="el" href="../../d6/d5/memprint_8c-source.html#l00088">MemPrintInitialized</a>, <a class="el" href="../../d6/d5/memprint_8c-source.html#l00084">MemPrintSpinLock</a>, <a class="el" href="../../d6/d5/memprint_8c-source.html#l00079">MemPrintSubbufferCount</a>, <a class="el" href="../../d6/d5/memprint_8c-source.html#l00120">MemPrintSubbufferFullEvent</a>, <a class="el" href="../../d6/d5/memprint_8c-source.html#l00110">MemPrintSubbufferWriting</a>, <a class="el" href="../../d6/d5/memprint_8c-source.html#l00598">MemPrintWriteThread()</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d3/d7/ps_2create_8c-source.html#l00175">PsCreateSystemThread()</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
<pre class="fragment"><div>00130                    :
00131 
00132     This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> initialization routine <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> in-memory <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> routine.
00133     It should be called before <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first call to <a class="code" href="../../d5/d6/memprint_8c.html#a19">MemPrint</a> to set up <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00134     various structures used and to start <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> write thread.
00135 
00136 Arguments:
00137 
00138     None.
00139 
00140 Return Value:
00141 
00142     None.
00143 
00144 --*/
00145 
00146 {
00147     CLONG i;
00148     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00149     HANDLE threadHandle;
00150 
00151     <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/memprint_8c.html#a11">MemPrintInitialized</a> ) {
00152         <span class="keywordflow">return</span>;
00153     }
00154 
00155     <span class="comment">//</span>
00156     <span class="comment">// Allocate memory for the circular buffer that will receive</span>
00157     <span class="comment">// the text and data.  If we can't do it, try again with a buffer</span>
00158     <span class="comment">// half as large.  If that fails, quit trying.</span>
00159     <span class="comment">//</span>
00160 
00161     <a class="code" href="../../d5/d6/memprint_8c.html#a7">MemPrintBuffer</a> = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( NonPagedPool, MemPrintBufferSize, 'rPeM' );
00162 
00163     <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/memprint_8c.html#a7">MemPrintBuffer</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00164 
00165         <a class="code" href="../../d5/d6/memprint_8c.html#a5">MemPrintBufferSize</a> /= 2;
00166         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"Unable to allocate DbgPrint buffer--trying size = %ld\n"</span>,
00167                       MemPrintBufferSize );
00168         <a class="code" href="../../d5/d6/memprint_8c.html#a7">MemPrintBuffer</a> = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( NonPagedPool, MemPrintBufferSize, 'rPeM' );
00169 
00170         <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/memprint_8c.html#a7">MemPrintBuffer</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00171             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"Couldn't allocate DbgPrint buffer.\n"</span> );
00172             <span class="keywordflow">return</span>;
00173         } <span class="keywordflow">else</span> {
00174             <span class="comment">//DbgPrint( "MemPrint buffer from %lx to %lx\n",</span>
00175             <span class="comment">//            MemPrintBuffer, MemPrintBuffer + MemPrintBufferSize );</span>
00176         }
00177 
00178     } <span class="keywordflow">else</span> {
00179         <span class="comment">//DbgPrint( "MemPrint buffer from %lx to %lx\n",</span>
00180         <span class="comment">//              MemPrintBuffer, MemPrintBuffer + MemPrintBufferSize );</span>
00181     }
00182 
00183     <span class="comment">//</span>
00184     <span class="comment">// Allocate the spin lock that protects access to the various</span>
00185     <span class="comment">// pointers and the circular buffer.  This ensures integrity of the</span>
00186     <span class="comment">// buffer.</span>
00187     <span class="comment">//</span>
00188 
00189     <a class="code" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock</a>( &amp;MemPrintSpinLock );
00190 
00191     <span class="comment">//</span>
00192     <span class="comment">// Make sure that the subbuffer count is in range.  (We assume that</span>
00193     <span class="comment">// the number is a power of 2.)</span>
00194     <span class="comment">//</span>
00195 
00196     <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/memprint_8c.html#a6">MemPrintSubbufferCount</a> &lt; 2 ) {
00197         <a class="code" href="../../d5/d6/memprint_8c.html#a6">MemPrintSubbufferCount</a> = 2;
00198     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/memprint_8c.html#a6">MemPrintSubbufferCount</a> &gt; <a class="code" href="../../d6/d6/memprint_8h.html#a5">MEM_PRINT_MAX_SUBBUFFER_COUNT</a> ) {
00199         <a class="code" href="../../d5/d6/memprint_8c.html#a6">MemPrintSubbufferCount</a> = <a class="code" href="../../d6/d6/memprint_8h.html#a5">MEM_PRINT_MAX_SUBBUFFER_COUNT</a>;
00200     }
00201 
00202     <span class="comment">//</span>
00203     <span class="comment">// Initialize the array of BOOLEANs that determines which subbuffers</span>
00204     <span class="comment">// are being written to disk and therefore cannot be used to store</span>
00205     <span class="comment">// new DbgPrint data.</span>
00206     <span class="comment">//</span>
00207     <span class="comment">// Initialize the array of events that indicates that a subbuffer is</span>
00208     <span class="comment">// ready to be written to disk.</span>
00209     <span class="comment">//</span>
00210 
00211     <span class="keywordflow">for</span> ( i = 0; i &lt; <a class="code" href="../../d5/d6/memprint_8c.html#a6">MemPrintSubbufferCount</a>; i++ ) {
00212         <a class="code" href="../../d5/d6/memprint_8c.html#a14">MemPrintSubbufferWriting</a>[i] = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00213         <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>(
00214             &amp;MemPrintSubbufferFullEvent[i],
00215             SynchronizationEvent,
00216             FALSE
00217             );
00218     }
00219 
00220     <span class="comment">//</span>
00221     <span class="comment">// Start the thread that writes subbuffers from the large circular</span>
00222     <span class="comment">// buffer to disk.</span>
00223     <span class="comment">//</span>
00224 
00225     status = <a class="code" href="../../d2/d8/ps_2create_8c.html#a11">PsCreateSystemThread</a>(
00226                 &amp;threadHandle,
00227                 PROCESS_ALL_ACCESS,
00228                 NULL,
00229                 NtCurrentProcess(),
00230                 NULL,
00231                 MemPrintWriteThread,
00232                 NULL
00233                 );
00234 
00235     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
00236         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"MemPrintInitialize: PsCreateSystemThread failed: %X\n"</span>,
00237                       status );
00238         <span class="keywordflow">return</span>;
00239     }
00240 
00241     <a class="code" href="../../d5/d6/memprint_8c.html#a11">MemPrintInitialized</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00242     ZwClose( threadHandle );
00243 
00244     <span class="keywordflow">return</span>;
00245 
00246 } <span class="comment">// MemPrintInitialize</span>

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a16" doxytag="memprint.c::MemPrintWriteCompleteApc" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MemPrintWriteCompleteApc           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>ApcContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PIO_STATUS_BLOCK&nbsp;</td>
          <td class="mdname" nowrap> <em>IoStatusBlock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Reserved</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/memprint_8c-source.html#l00862">862</a> of file <a class="el" href="../../d6/d5/memprint_8c-source.html">memprint.c</a>.
<p>
References <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02007">KeAcquireSpinLock</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a119">KeReleaseSpinLock()</a>, <a class="el" href="../../d6/d5/memprint_8c-source.html#l00084">MemPrintSpinLock</a>, <a class="el" href="../../d6/d5/memprint_8c-source.html#l00110">MemPrintSubbufferWriting</a>, and <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>.
<p>
Referenced by <a class="el" href="../../d6/d5/memprint_8c-source.html#l00598">MemPrintWriteThread()</a>.
<p>
<pre class="fragment"><div>00870                    :
00871 
00872     This APC routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called when subbuffer writes to disk complete.
00873     It checks <span class="keywordflow">for</span> success, printing a message <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> write failed.
00874     It also sets <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> appropriate <a class="code" href="../../d5/d6/memprint_8c.html#a14">MemPrintSubbufferWriting</a> location to
00875     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> so that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> subbuffer can be reused.
00876 
00877 Arguments:
00878 
00879     ApcContext - contains <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> index of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> subbuffer just written.
00880 
00881     IoStatusBlock - <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> status block <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation.
00882 
00883     Reserved - not used; reserved <span class="keywordflow">for</span> future use.
00884 
00885 Return Value:
00886 
00887     None.
00888 
00889 --*/
00890 
00891 {
00892     KIRQL oldIrql;
00893 
00894     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(IoStatusBlock-&gt;Status) ) {
00895         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"NtWriteFile for subbuffer %ld failed: %X\n"</span>,
00896                       ApcContext, IoStatusBlock-&gt;Status );
00897         <span class="keywordflow">return</span>;
00898     }
00899 
00900     <span class="comment">//DbgPrint( "Write complete for subbuffer %ld.\n", ApcContext );</span>
00901     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"."</span> );
00902 
00903     <span class="comment">//</span>
00904     <span class="comment">// Acquire the spin lock that protects memory print global variables</span>
00905     <span class="comment">// and set the subbuffer writing boolean to FALSE so that other</span>
00906     <span class="comment">// threads can write to the subbuffer if necessary.</span>
00907     <span class="comment">//</span>
00908 
00909     <a class="code" href="../../d4/d9/ke_8h.html#a37">KeAcquireSpinLock</a>( &amp;MemPrintSpinLock, &amp;oldIrql );
00910     <a class="code" href="../../d5/d6/memprint_8c.html#a14">MemPrintSubbufferWriting</a>[ (ULONG_PTR)ApcContext ] = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00911     <a class="code" href="../../d9/d5/verifier_8c.html#a119">KeReleaseSpinLock</a>( &amp;MemPrintSpinLock, oldIrql );
00912 
00913     <span class="keywordflow">return</span>;
00914 
00915     Reserved;
00916 
00917 } <span class="comment">// MemPrintWriteCompleteApc</span>
} <span class="comment">// MemPrintWriteCompleteApc</span>
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a17" doxytag="memprint.c::MemPrintWriteThread" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID MemPrintWriteThread           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Dummy</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/memprint_8c-source.html#l00598">598</a> of file <a class="el" href="../../d6/d5/memprint_8c-source.html">memprint.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00079">DbgPrint</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02007">KeAcquireSpinLock</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00140">KeDelayExecutionThread()</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a119">KeReleaseSpinLock()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00395">KeWaitForMultipleObjects()</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00030">MEM_PRINT_FLAG_FILE</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00055">MEM_PRINT_LOG_FILE_NAME</a>, <a class="el" href="../../d7/d5/memprint_8h-source.html#l00053">MEM_PRINT_MAX_SUBBUFFER_COUNT</a>, <a class="el" href="../../d6/d5/memprint_8c-source.html#l00060">MEM_PRINT_SUBBUFFER_SIZE</a>, <a class="el" href="../../d6/d5/memprint_8c-source.html#l00080">MemPrintBuffer</a>, <a class="el" href="../../d6/d5/memprint_8c-source.html#l00078">MemPrintBufferSize</a>, <a class="el" href="../../d6/d5/memprint_8c-source.html#l00082">MemPrintFlags</a>, <a class="el" href="../../d6/d5/memprint_8c-source.html#l00084">MemPrintSpinLock</a>, <a class="el" href="../../d6/d5/memprint_8c-source.html#l00079">MemPrintSubbufferCount</a>, <a class="el" href="../../d6/d5/memprint_8c-source.html#l00120">MemPrintSubbufferFullEvent</a>, <a class="el" href="../../d6/d5/memprint_8c-source.html#l00110">MemPrintSubbufferWriting</a>, <a class="el" href="../../d6/d5/memprint_8c-source.html#l00862">MemPrintWriteCompleteApc()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d2/d7/io_2create_8c-source.html#l00037">NtCreateFile()</a>, <a class="el" href="../../d0/d2/qsinfo_8c-source.html#l00849">NtSetInformationFile()</a>, <a class="el" href="../../d0/d1/psquery_8c-source.html#l03103">NtSetInformationThread()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d9/d9/psdelete_8c-source.html#l00461">NtTerminateThread()</a>, <a class="el" href="../../d1/d9/io_2write_8c-source.html#l00035">NtWriteFile()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l00082">RtlAnsiStringToUnicodeString()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01215">RtlFreeUnicodeString()</a>, <a class="el" href="../../d3/d6/string_8c-source.html#l00102">RtlInitAnsiString()</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d6/d5/memprint_8c-source.html#l00124">MemPrintInitialize()</a>.
<p>
<pre class="fragment"><div>00604                    :
00605 
00606     The log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> write thread executes <span class="keyword">this</span> routine.  It sets up <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00607     log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> <span class="keywordflow">for</span> writing, then waits <span class="keywordflow">for</span> subbuffers to fill, writing
00608     them to disk when they <span class="keywordflow">do</span>.  When <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> log <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> fills, <span class="keyword">new</span> space
00609     <span class="keywordflow">for</span> <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> allocated on disk to prevent <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> system from
00610     having to <span class="keywordflow">do</span> <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>.
00611 
00612 Arguments:
00613 
00614     Dummy - Ignored.
00615 
00616 Return Value:
00617 
00618     None.
00619 
00620 --*/
00621 
00622 {
00623     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
00624     IO_STATUS_BLOCK ioStatusBlock[<a class="code" href="../../d6/d6/memprint_8h.html#a5">MEM_PRINT_MAX_SUBBUFFER_COUNT</a>];
00625     IO_STATUS_BLOCK localIoStatusBlock;
00626     CLONG i;
00627     KPRIORITY threadPriorityLevel;
00628 
00629     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> waitStatus;
00630     PVOID waitObjects[64];
00631     <a class="code" href="../../d4/d8/struct__KWAIT__BLOCK.html">KWAIT_BLOCK</a> waitBlockArray[<a class="code" href="../../d6/d6/memprint_8h.html#a5">MEM_PRINT_MAX_SUBBUFFER_COUNT</a>];
00632 
00633     OBJECT_ATTRIBUTES objectAttributes;
00634     PCHAR fileName = <a class="code" href="../../d6/d6/memprint_8h.html#a6">MEM_PRINT_LOG_FILE_NAME</a>;
00635     ANSI_STRING fileNameString;
00636     HANDLE fileHandle;
00637 
00638     LARGE_INTEGER fileAllocation;
00639     LARGE_INTEGER fileAllocationIncrement;
00640     LARGE_INTEGER totalBytesWritten;
00641     LARGE_INTEGER writeSize;
00642 
00643     LARGE_INTEGER delayInterval;
00644     ULONG attempts = 0;
00645 
00646     UNICODE_STRING UnicodeFileName;
00647 
00648     Dummy;
00649 
00650     <span class="comment">//</span>
00651     <span class="comment">// Initialize the string containing the file name and the object</span>
00652     <span class="comment">// attributes structure that will describe the log file to open.</span>
00653     <span class="comment">//</span>
00654 
00655     <a class="code" href="../../d2/d7/string_8c.html#a6">RtlInitAnsiString</a>( &amp;fileNameString, fileName );
00656     status = <a class="code" href="../../d6/d6/nls_8c.html#a21">RtlAnsiStringToUnicodeString</a>(&amp;UnicodeFileName,&amp;fileNameString,TRUE);
00657     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
00658         <a class="code" href="../../d8/d0/psdelete_8c.html#a6">NtTerminateThread</a>( NtCurrentThread(), status );
00659     }
00660 
00661     InitializeObjectAttributes(
00662         &amp;objectAttributes,
00663         &amp;UnicodeFileName,
00664         OBJ_CASE_INSENSITIVE,
00665         NULL,
00666         NULL
00667         );
00668 
00669     <span class="comment">//</span>
00670     <span class="comment">// Set the allocation size of the log file to be three times the</span>
00671     <span class="comment">// size of the circular buffer.  When it fills up, we'll extend</span>
00672     <span class="comment">// it.</span>
00673     <span class="comment">//</span>
00674 
00675     fileAllocationIncrement.LowPart = <a class="code" href="../../d5/d6/memprint_8c.html#a5">MemPrintBufferSize</a> * 8;
00676     fileAllocationIncrement.HighPart = 0;
00677     fileAllocation = fileAllocationIncrement;
00678 
00679     <span class="comment">//</span>
00680     <span class="comment">// Open the log file.</span>
00681     <span class="comment">//</span>
00682     <span class="comment">// !!! The loop here is to help avoid a system initialization</span>
00683     <span class="comment">//     timing problem, and should be removed when the problem is</span>
00684     <span class="comment">//     fixed.</span>
00685     <span class="comment">//</span>
00686 
00687     <span class="keywordflow">while</span> ( <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> ) {
00688 
00689         status = <a class="code" href="../../d1/d8/io_2create_8c.html#a0">NtCreateFile</a>(
00690                      &amp;fileHandle,
00691                      FILE_WRITE_DATA,
00692                      &amp;objectAttributes,
00693                      &amp;localIoStatusBlock,
00694                      &amp;fileAllocation,
00695                      FILE_ATTRIBUTE_NORMAL,
00696                      FILE_SHARE_READ,
00697                      FILE_OVERWRITE_IF,
00698                      FILE_SEQUENTIAL_ONLY,
00699                      NULL,
00700                      0L
00701                      );
00702 
00703         <span class="keywordflow">if</span> ( (status != STATUS_OBJECT_PATH_NOT_FOUND) || (++attempts &gt;= 3) ) {
00704             <a class="code" href="../../d6/d6/nls_8c.html#a34">RtlFreeUnicodeString</a>(&amp;UnicodeFileName);
00705             <span class="keywordflow">break</span>;
00706         }
00707 
00708         delayInterval.QuadPart = -5*10*1000*1000;    <span class="comment">// five second delay</span>
00709         <a class="code" href="../../d1/d7/wait_8c.html#a2">KeDelayExecutionThread</a>( KernelMode, FALSE, &amp;delayInterval );
00710 
00711     }
00712 
00713     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
00714         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"NtCreateFile for log file failed: %X\n"</span>, status );
00715         <a class="code" href="../../d8/d0/psdelete_8c.html#a6">NtTerminateThread</a>( NtCurrentThread(), status );
00716     }
00717 
00718     <span class="comment">//</span>
00719     <span class="comment">// Initialize the total bytes written and write size variables.</span>
00720     <span class="comment">//</span>
00721 
00722     totalBytesWritten.LowPart = 0;
00723     totalBytesWritten.HighPart = 0;
00724     writeSize.LowPart = <a class="code" href="../../d5/d6/memprint_8c.html#a1">MEM_PRINT_SUBBUFFER_SIZE</a>;
00725     writeSize.HighPart = 0;
00726 
00727     <span class="comment">//</span>
00728     <span class="comment">// Set up the wait objects array for a call to KeWaitForMultipleObjects.</span>
00729     <span class="comment">//</span>
00730 
00731     <span class="keywordflow">for</span> ( i = 0; i &lt; <a class="code" href="../../d5/d6/memprint_8c.html#a6">MemPrintSubbufferCount</a>; i++ ) {
00732         waitObjects[i] = &amp;<a class="code" href="../../d5/d6/memprint_8c.html#a15">MemPrintSubbufferFullEvent</a>[i];
00733     }
00734 
00735     <span class="comment">//</span>
00736     <span class="comment">// Set the priority of the write thread.</span>
00737     <span class="comment">//</span>
00738 
00739     threadPriorityLevel = LOW_REALTIME_PRIORITY + 1;
00740 
00741     status = <a class="code" href="../../d9/d1/psquery_8c.html#a21">NtSetInformationThread</a>(
00742                 NtCurrentThread(),
00743                 ThreadPriority,
00744                 &amp;threadPriorityLevel,
00745                 <span class="keyword">sizeof</span>(threadPriorityLevel)
00746                 );
00747 
00748     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
00749         <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"Unable to set error log thread priority: %X\n"</span>, status );
00750     }
00751 
00752     <span class="comment">//</span>
00753     <span class="comment">// Loop waiting for one of the subbuffer full events to be signaled.</span>
00754     <span class="comment">// When one is signaled, wake up and write the subbuffer to the log</span>
00755     <span class="comment">// file.</span>
00756     <span class="comment">//</span>
00757 
00758     <span class="keywordflow">while</span> ( <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> ) {
00759 
00760         waitStatus = <a class="code" href="../../d1/d7/wait_8c.html#a3">KeWaitForMultipleObjects</a>(
00761                          (CCHAR)MemPrintSubbufferCount,
00762                          waitObjects,
00763                          WaitAny,
00764                          Executive,
00765                          KernelMode,
00766                          TRUE,
00767                          NULL,
00768                          waitBlockArray
00769                          );
00770 
00771         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(waitStatus) ) {
00772             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"KeWaitForMultipleObjects failed: %X\n"</span>, waitStatus );
00773             <a class="code" href="../../d8/d0/psdelete_8c.html#a6">NtTerminateThread</a>( NtCurrentThread(), waitStatus );
00774         } <span class="comment">//else {</span>
00775             <span class="comment">//DbgPrint( "Writing subbuffer %ld...\n", waitStatus );</span>
00776         <span class="comment">//}</span>
00777 
00778         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( (CCHAR)waitStatus &lt; (CCHAR)MemPrintSubbufferCount );
00779 
00780         <span class="comment">//</span>
00781         <span class="comment">// Check the DbgPrint flags to see if we really want to write</span>
00782         <span class="comment">// this.</span>
00783         <span class="comment">//</span>
00784 
00785         <span class="keywordflow">if</span> ( (<a class="code" href="../../d5/d6/memprint_8c.html#a8">MemPrintFlags</a> &amp; <a class="code" href="../../d6/d6/memprint_8h.html#a1">MEM_PRINT_FLAG_FILE</a>) == 0 ) {
00786 
00787             KIRQL oldIrql;
00788 
00789             <a class="code" href="../../d4/d9/ke_8h.html#a37">KeAcquireSpinLock</a>( &amp;MemPrintSpinLock, &amp;oldIrql );
00790             <a class="code" href="../../d5/d6/memprint_8c.html#a14">MemPrintSubbufferWriting</a>[ waitStatus ] = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00791             <a class="code" href="../../d9/d5/verifier_8c.html#a119">KeReleaseSpinLock</a>( &amp;MemPrintSpinLock, oldIrql );
00792 
00793             <span class="keywordflow">continue</span>;
00794         }
00795 
00796         <span class="comment">//</span>
00797         <span class="comment">// Start the write operation.  The APC routine will handle</span>
00798         <span class="comment">// checking the return status from the write and resetting</span>
00799         <span class="comment">// the MemPrintSubbufferWriting boolean.</span>
00800         <span class="comment">//</span>
00801 
00802         status = <a class="code" href="../../d0/d0/io_2write_8c.html#a0">NtWriteFile</a>(
00803                      fileHandle,
00804                      NULL,
00805                      MemPrintWriteCompleteApc,
00806                      (PVOID)waitStatus,
00807                      &amp;ioStatusBlock[waitStatus],
00808                      &amp;MemPrintBuffer[waitStatus * MEM_PRINT_SUBBUFFER_SIZE],
00809                      MEM_PRINT_SUBBUFFER_SIZE,
00810                      &amp;totalBytesWritten,
00811                      NULL
00812                      );
00813 
00814         <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
00815             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"NtWriteFile for log file failed: %X\n"</span>, status );
00816         }
00817 
00818         <span class="comment">//</span>
00819         <span class="comment">// Update the count of bytes written to the log file.</span>
00820         <span class="comment">//</span>
00821 
00822         totalBytesWritten.QuadPart = totalBytesWritten.QuadPart + writeSize.QuadPart;
00823 
00824         <span class="comment">//</span>
00825         <span class="comment">// Extend the file if we have reached the end of what we have</span>
00826         <span class="comment">// thus far allocated for the file.  This increases performance</span>
00827         <span class="comment">// by extending the file here rather than in the file system,</span>
00828         <span class="comment">// which would have to extend it each time a write past end of</span>
00829         <span class="comment">// file comes in.</span>
00830         <span class="comment">//</span>
00831 
00832         <span class="keywordflow">if</span> ( totalBytesWritten.QuadPart &gt;= fileAllocation.QuadPart ) {
00833 
00834             fileAllocation.QuadPart =
00835                         fileAllocation.QuadPart + fileAllocationIncrement.QuadPart;
00836 
00837             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"Enlarging log file to %ld bytes.\n"</span>,
00838                           fileAllocation.LowPart );
00839 
00840             status = <a class="code" href="../../d9/d2/qsinfo_8c.html#a4">NtSetInformationFile</a>(
00841                          fileHandle,
00842                          &amp;localIoStatusBlock,
00843                          &amp;fileAllocation,
00844                          <span class="keyword">sizeof</span>(fileAllocation),
00845                          FileAllocationInformation
00846                          );
00847 
00848             <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status) ) {
00849                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"Attempt to extend log file failed: %X\n"</span>, status );
00850                 fileAllocation.QuadPart =
00851                         fileAllocation.QuadPart - fileAllocationIncrement.QuadPart;
00852             }
00853         }
00854     }
00855 
00856     <span class="keywordflow">return</span>;
00857 
00858 } <span class="comment">// MemPrintWriteThread</span>

</div></pre>    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a7" doxytag="memprint.c::MemPrintBuffer" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PCHAR <a class="el" href="../../d5/d6/memprint_8c.html#a7">MemPrintBuffer</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/memprint_8c-source.html#l00080">80</a> of file <a class="el" href="../../d6/d5/memprint_8c-source.html">memprint.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d5/memprint_8c-source.html#l00250">MemPrint()</a>, <a class="el" href="../../d6/d5/memprint_8c-source.html#l00492">MemPrintFlush()</a>, <a class="el" href="../../d6/d5/memprint_8c-source.html#l00124">MemPrintInitialize()</a>, and <a class="el" href="../../d6/d5/memprint_8c-source.html#l00598">MemPrintWriteThread()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="memprint.c::MemPrintBufferSize" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> CLONG <a class="el" href="../../d5/d6/memprint_8c.html#a5">MemPrintBufferSize</a> = MEM_PRINT_DEF_BUFFER_SIZE          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/memprint_8c-source.html#l00078">78</a> of file <a class="el" href="../../d6/d5/memprint_8c-source.html">memprint.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d5/memprint_8c-source.html#l00250">MemPrint()</a>, <a class="el" href="../../d6/d5/memprint_8c-source.html#l00492">MemPrintFlush()</a>, <a class="el" href="../../d6/d5/memprint_8c-source.html#l00124">MemPrintInitialize()</a>, and <a class="el" href="../../d6/d5/memprint_8c-source.html#l00598">MemPrintWriteThread()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a13" doxytag="memprint.c::MemPrintCurrentSubbuffer" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> CLONG <a class="el" href="../../d5/d6/memprint_8c.html#a13">MemPrintCurrentSubbuffer</a> = 0          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/memprint_8c-source.html#l00102">102</a> of file <a class="el" href="../../d6/d5/memprint_8c-source.html">memprint.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d5/memprint_8c-source.html#l00250">MemPrint()</a>, and <a class="el" href="../../d6/d5/memprint_8c-source.html#l00492">MemPrintFlush()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="memprint.c::MemPrintFlags" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG <a class="el" href="../../d6/d6/memprint_8h.html#a8">MemPrintFlags</a> = MEM_PRINT_FLAG_CONSOLE          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/memprint_8c-source.html#l00082">82</a> of file <a class="el" href="../../d6/d5/memprint_8c-source.html">memprint.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d5/memprint_8c-source.html#l00250">MemPrint()</a>, and <a class="el" href="../../d6/d5/memprint_8c-source.html#l00598">MemPrintWriteThread()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a12" doxytag="memprint.c::MemPrintIndex" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> CLONG <a class="el" href="../../d5/d6/memprint_8c.html#a12">MemPrintIndex</a> = 0          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/memprint_8c-source.html#l00094">94</a> of file <a class="el" href="../../d6/d5/memprint_8c-source.html">memprint.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d5/memprint_8c-source.html#l00250">MemPrint()</a>, and <a class="el" href="../../d6/d5/memprint_8c-source.html#l00492">MemPrintFlush()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="memprint.c::MemPrintInitialized" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN <a class="el" href="../../d5/d6/memprint_8c.html#a11">MemPrintInitialized</a> = FALSE          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/memprint_8c-source.html#l00088">88</a> of file <a class="el" href="../../d6/d5/memprint_8c-source.html">memprint.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d5/memprint_8c-source.html#l00250">MemPrint()</a>, and <a class="el" href="../../d6/d5/memprint_8c-source.html#l00124">MemPrintInitialize()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="memprint.c::MemPrintSpinLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> KSPIN_LOCK <a class="el" href="../../d5/d6/memprint_8c.html#a9">MemPrintSpinLock</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/memprint_8c-source.html#l00084">84</a> of file <a class="el" href="../../d6/d5/memprint_8c-source.html">memprint.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d5/memprint_8c-source.html#l00250">MemPrint()</a>, <a class="el" href="../../d6/d5/memprint_8c-source.html#l00492">MemPrintFlush()</a>, <a class="el" href="../../d6/d5/memprint_8c-source.html#l00124">MemPrintInitialize()</a>, <a class="el" href="../../d6/d5/memprint_8c-source.html#l00862">MemPrintWriteCompleteApc()</a>, and <a class="el" href="../../d6/d5/memprint_8c-source.html#l00598">MemPrintWriteThread()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="memprint.c::MemPrintSubbufferCount" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> CLONG <a class="el" href="../../d5/d6/memprint_8c.html#a6">MemPrintSubbufferCount</a> = MEM_PRINT_DEF_SUBBUFFER_COUNT          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/memprint_8c-source.html#l00079">79</a> of file <a class="el" href="../../d6/d5/memprint_8c-source.html">memprint.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d5/memprint_8c-source.html#l00250">MemPrint()</a>, <a class="el" href="../../d6/d5/memprint_8c-source.html#l00124">MemPrintInitialize()</a>, and <a class="el" href="../../d6/d5/memprint_8c-source.html#l00598">MemPrintWriteThread()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a15" doxytag="memprint.c::MemPrintSubbufferFullEvent" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> <a class="el" href="../../d5/d6/memprint_8c.html#a15">MemPrintSubbufferFullEvent</a>[MEM_PRINT_MAX_SUBBUFFER_COUNT]          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/memprint_8c-source.html#l00120">120</a> of file <a class="el" href="../../d6/d5/memprint_8c-source.html">memprint.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d5/memprint_8c-source.html#l00250">MemPrint()</a>, <a class="el" href="../../d6/d5/memprint_8c-source.html#l00492">MemPrintFlush()</a>, <a class="el" href="../../d6/d5/memprint_8c-source.html#l00124">MemPrintInitialize()</a>, and <a class="el" href="../../d6/d5/memprint_8c-source.html#l00598">MemPrintWriteThread()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a14" doxytag="memprint.c::MemPrintSubbufferWriting" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN <a class="el" href="../../d5/d6/memprint_8c.html#a14">MemPrintSubbufferWriting</a>[MEM_PRINT_MAX_SUBBUFFER_COUNT]          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/memprint_8c-source.html#l00110">110</a> of file <a class="el" href="../../d6/d5/memprint_8c-source.html">memprint.c</a>.
<p>
Referenced by <a class="el" href="../../d6/d5/memprint_8c-source.html#l00250">MemPrint()</a>, <a class="el" href="../../d6/d5/memprint_8c-source.html#l00492">MemPrintFlush()</a>, <a class="el" href="../../d6/d5/memprint_8c-source.html#l00124">MemPrintInitialize()</a>, <a class="el" href="../../d6/d5/memprint_8c-source.html#l00862">MemPrintWriteCompleteApc()</a>, and <a class="el" href="../../d6/d5/memprint_8c-source.html#l00598">MemPrintWriteThread()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="memprint.c::MemPrintTempBuffer" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d2/d1/bench_8h.html#a8">CHAR</a> <a class="el" href="../../d5/d6/memprint_8c.html#a10">MemPrintTempBuffer</a>[MEM_PRINT_MAX_MESSAGE_SIZE]          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d5/memprint_8c-source.html#l00086">86</a> of file <a class="el" href="../../d6/d5/memprint_8c-source.html">memprint.c</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:44:37 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
