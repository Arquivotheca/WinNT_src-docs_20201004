<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: timer.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>timer.c</h1><a href="../../d2/d2/timer_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    timer.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">   This module implements the executive timer object. Functions are provided</span>
00012 <span class="comment">   to create, open, cancel, set, and query timer objects.</span>
00013 <span class="comment"></span>
00014 <span class="comment">Author:</span>
00015 <span class="comment"></span>
00016 <span class="comment">    David N. Cutler (davec) 12-May-1989</span>
00017 <span class="comment"></span>
00018 <span class="comment">Environment:</span>
00019 <span class="comment"></span>
00020 <span class="comment">    Kernel mode only.</span>
00021 <span class="comment"></span>
00022 <span class="comment">Revision History:</span>
00023 <span class="comment"></span>
00024 <span class="comment">--*/</span>
00025 
00026 <span class="preprocessor">#include "<a class="code" href="../../d4/d0/exp_8h.html">exp.h</a>"</span>
00027 
00028 <span class="comment">//</span>
00029 <span class="comment">// Executive timer object structure definition.</span>
00030 <span class="comment">//</span>
00031 
<a name="l00032"></a><a class="code" href="../../d1/d7/struct__ETIMER.html">00032</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d1/d7/struct__ETIMER.html">_ETIMER</a> {
<a name="l00033"></a><a class="code" href="../../d1/d7/struct__ETIMER.html#o0">00033</a>     <a class="code" href="../../d3/d8/struct__KTIMER.html">KTIMER</a> <a class="code" href="../../d1/d7/struct__ETIMER.html#o0">KeTimer</a>;
<a name="l00034"></a><a class="code" href="../../d1/d7/struct__ETIMER.html#o1">00034</a>     <a class="code" href="../../d1/d5/struct__KAPC.html">KAPC</a> <a class="code" href="../../d1/d7/struct__ETIMER.html#o1">TimerApc</a>;
<a name="l00035"></a><a class="code" href="../../d1/d7/struct__ETIMER.html#o2">00035</a>     <a class="code" href="../../d1/d6/struct__KDPC.html">KDPC</a> <a class="code" href="../../d1/d7/struct__ETIMER.html#o2">TimerDpc</a>;
<a name="l00036"></a><a class="code" href="../../d1/d7/struct__ETIMER.html#o3">00036</a>     LIST_ENTRY <a class="code" href="../../d1/d7/struct__ETIMER.html#o3">ActiveTimerListEntry</a>;
<a name="l00037"></a><a class="code" href="../../d1/d7/struct__ETIMER.html#o4">00037</a>     KSPIN_LOCK <a class="code" href="../../d1/d7/struct__ETIMER.html#o4">Lock</a>;
<a name="l00038"></a><a class="code" href="../../d1/d7/struct__ETIMER.html#o5">00038</a>     LONG <a class="code" href="../../d1/d7/struct__ETIMER.html#o5">Period</a>;
<a name="l00039"></a><a class="code" href="../../d1/d7/struct__ETIMER.html#o6">00039</a>     BOOLEAN <a class="code" href="../../d1/d7/struct__ETIMER.html#o6">ApcAssociated</a>;
<a name="l00040"></a><a class="code" href="../../d1/d7/struct__ETIMER.html#o7">00040</a>     BOOLEAN <a class="code" href="../../d1/d7/struct__ETIMER.html#o7">WakeTimer</a>;
<a name="l00041"></a><a class="code" href="../../d1/d7/struct__ETIMER.html#o8">00041</a>     LIST_ENTRY <a class="code" href="../../d1/d7/struct__ETIMER.html#o8">WakeTimerListEntry</a>;
00042 } <a class="code" href="../../d1/d7/struct__ETIMER.html">ETIMER</a>, *<a class="code" href="../../d1/d7/struct__ETIMER.html">PETIMER</a>;
00043 
00044 <span class="comment">//</span>
00045 <span class="comment">// List of all timers which are set to wake</span>
00046 <span class="comment">//</span>
00047 
<a name="l00048"></a><a class="code" href="../../d2/d2/timer_8c.html#a2">00048</a> KSPIN_LOCK <a class="code" href="../../d2/d2/timer_8c.html#a2">ExpWakeTimerListLock</a>;
<a name="l00049"></a><a class="code" href="../../d2/d2/timer_8c.html#a3">00049</a> LIST_ENTRY <a class="code" href="../../d2/d2/timer_8c.html#a3">ExpWakeTimerList</a>;
00050 
00051 <span class="comment">//</span>
00052 <span class="comment">// Address of timer object type descriptor.</span>
00053 <span class="comment">//</span>
00054 
<a name="l00055"></a><a class="code" href="../../d2/d2/timer_8c.html#a4">00055</a> <a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> <a class="code" href="../../d2/d2/timer_8c.html#a4">ExTimerObjectType</a>;
00056 
00057 <span class="comment">//</span>
00058 <span class="comment">// Structure that describes the mapping of generic access rights to object</span>
00059 <span class="comment">// specific access rights for timer objects.</span>
00060 <span class="comment">//</span>
00061 
<a name="l00062"></a><a class="code" href="../../d2/d2/timer_8c.html#a5">00062</a> GENERIC_MAPPING <a class="code" href="../../d2/d2/timer_8c.html#a5">ExpTimerMapping</a> = {
00063     STANDARD_RIGHTS_READ |
00064         TIMER_QUERY_STATE,
00065     STANDARD_RIGHTS_WRITE |
00066         TIMER_MODIFY_STATE,
00067     STANDARD_RIGHTS_EXECUTE |
00068         SYNCHRONIZE,
00069     TIMER_ALL_ACCESS
00070 };
00071 
00072 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00073 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT, ExpTimerInitialization)</span>
00074 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, NtCreateTimer)</span>
00075 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, NtOpenTimer)</span>
00076 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, NtQueryTimer)</span>
00077 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGELK, ExGetNextWakeTime)</span>
00078 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00079 <span class="preprocessor"></span>
00080 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00081"></a><a class="code" href="../../d2/d2/timer_8c.html#a6">00081</a> <a class="code" href="../../d2/d2/timer_8c.html#a6">ExpTimerApcRoutine</a> (
00082     IN <a class="code" href="../../d1/d5/struct__KAPC.html">PKAPC</a> Apc,
00083     IN PKNORMAL_ROUTINE *NormalRoutine,
00084     IN PVOID *NormalContext,
00085     IN PVOID *SystemArgument1,
00086     IN PVOID *SystemArgument2
00087     )
00088 
00089 <span class="comment">/*++</span>
00090 <span class="comment"></span>
00091 <span class="comment">Routine Description:</span>
00092 <span class="comment"></span>
00093 <span class="comment">    This function is the special APC routine that is called to remove</span>
00094 <span class="comment">    a timer from the current thread's active timer list.</span>
00095 <span class="comment"></span>
00096 <span class="comment">Arguments:</span>
00097 <span class="comment"></span>
00098 <span class="comment">    Apc - Supplies a pointer to the APC object used to invoke this routine.</span>
00099 <span class="comment"></span>
00100 <span class="comment">    NormalRoutine - Supplies a pointer to a pointer to the normal routine</span>
00101 <span class="comment">        function that was specified when the APC was initialized.</span>
00102 <span class="comment"></span>
00103 <span class="comment">    NormalContext - Supplies a pointer to a pointer to an arbitrary data</span>
00104 <span class="comment">        structure that was specified when the APC was initialized.</span>
00105 <span class="comment"></span>
00106 <span class="comment">    SystemArgument1, SystemArgument2 - Supplies a set of two pointers to</span>
00107 <span class="comment">        two arguments that contain untyped data.</span>
00108 <span class="comment"></span>
00109 <span class="comment">Return Value:</span>
00110 <span class="comment"></span>
00111 <span class="comment">    None.</span>
00112 <span class="comment"></span>
00113 <span class="comment">--*/</span>
00114 
00115 {
00116 
00117     BOOLEAN Dereference;
00118     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> ExThread;
00119     <a class="code" href="../../d2/d2/timer_8c.html#a1">PETIMER</a> ExTimer;
00120     KIRQL OldIrql1;
00121 
00122     <span class="comment">//</span>
00123     <span class="comment">// Get address of executive timer object and the current thread object.</span>
00124     <span class="comment">//</span>
00125 
00126     ExThread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
00127     ExTimer = CONTAINING_RECORD(Apc, <a class="code" href="../../d1/d7/struct__ETIMER.html">ETIMER</a>, TimerApc);
00128 
00129     <span class="comment">//</span>
00130     <span class="comment">// If the timer is still in the current thread's active timer list, then</span>
00131     <span class="comment">// remove it if it is not a periodic timer and set APC associated FALSE.</span>
00132     <span class="comment">// It is possible for the timer not to be in the current thread's active</span>
00133     <span class="comment">// timer list since the APC could have been delivered, and then another</span>
00134     <span class="comment">// thread could have set the timer again with another APC. This would</span>
00135     <span class="comment">// have caused the timer to be removed from the current thread's active</span>
00136     <span class="comment">// timer list.</span>
00137     <span class="comment">//</span>
00138     <span class="comment">// N. B. The spin locks for the timer and the active timer list must be</span>
00139     <span class="comment">//  acquired in the order: 1) timer lock, 2) thread list lock.</span>
00140     <span class="comment">//</span>
00141 
00142     Dereference = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00143     ExAcquireSpinLock(&amp;ExTimer-&gt;<a class="code" href="../../d1/d7/struct__ETIMER.html#o4">Lock</a>, &amp;OldIrql1);
00144     ExAcquireSpinLockAtDpcLevel(&amp;ExThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o10">ActiveTimerListLock</a>);
00145     <span class="keywordflow">if</span> ((ExTimer-&gt;<a class="code" href="../../d1/d7/struct__ETIMER.html#o6">ApcAssociated</a>) &amp;&amp; (&amp;ExThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a> == ExTimer-&gt;<a class="code" href="../../d1/d7/struct__ETIMER.html#o1">TimerApc</a>.<a class="code" href="../../d1/d5/struct__KAPC.html#o3">Thread</a>)) {
00146         <span class="keywordflow">if</span> (ExTimer-&gt;<a class="code" href="../../d1/d7/struct__ETIMER.html#o5">Period</a> == 0) {
00147             RemoveEntryList(&amp;ExTimer-&gt;<a class="code" href="../../d1/d7/struct__ETIMER.html#o3">ActiveTimerListEntry</a>);
00148             ExTimer-&gt;<a class="code" href="../../d1/d7/struct__ETIMER.html#o6">ApcAssociated</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00149             Dereference = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00150         }
00151 
00152     } <span class="keywordflow">else</span> {
00153         *NormalRoutine = (<a class="code" href="../../d0/d9/ntosdef_8h.html#a41">PKNORMAL_ROUTINE</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00154     }
00155 
00156     ExReleaseSpinLockFromDpcLevel(&amp;ExThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o10">ActiveTimerListLock</a>);
00157     ExReleaseSpinLock(&amp;ExTimer-&gt;<a class="code" href="../../d1/d7/struct__ETIMER.html#o4">Lock</a>, OldIrql1);
00158     <span class="keywordflow">if</span> (Dereference) {
00159         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>((PVOID)ExTimer);
00160     }
00161 
00162     <span class="keywordflow">return</span>;
00163 }
00164 
00165 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00166"></a><a class="code" href="../../d2/d2/timer_8c.html#a7">00166</a> <a class="code" href="../../d2/d2/timer_8c.html#a7">ExpTimerDpcRoutine</a> (
00167     IN <a class="code" href="../../d1/d6/struct__KDPC.html">PKDPC</a> Dpc,
00168     IN PVOID DeferredContext,
00169     IN PVOID SystemArgument1,
00170     IN PVOID SystemArgument2
00171     )
00172 
00173 <span class="comment">/*++</span>
00174 <span class="comment"></span>
00175 <span class="comment">Routine Description:</span>
00176 <span class="comment"></span>
00177 <span class="comment">    This function is the DPC routine that is called when a timer expires that</span>
00178 <span class="comment">    has an associated APC routine. Its function is to insert the associated</span>
00179 <span class="comment">    APC into the target thread's APC queue.</span>
00180 <span class="comment"></span>
00181 <span class="comment">Arguments:</span>
00182 <span class="comment"></span>
00183 <span class="comment">    Dpc - Supplies a pointer to a control object of type DPC.</span>
00184 <span class="comment"></span>
00185 <span class="comment">    DeferredContext - Supplies a pointer to the executive timer that contains</span>
00186 <span class="comment">        the DPC that caused this routine to be executed.</span>
00187 <span class="comment"></span>
00188 <span class="comment">    SystemArgument1, SystemArgument2 - Supplies values that are not used by</span>
00189 <span class="comment">        this routine.</span>
00190 <span class="comment"></span>
00191 <span class="comment">Return Value:</span>
00192 <span class="comment"></span>
00193 <span class="comment">    None.</span>
00194 <span class="comment"></span>
00195 <span class="comment">--*/</span>
00196 
00197 {
00198 
00199     <a class="code" href="../../d2/d2/timer_8c.html#a1">PETIMER</a> ExTimer;
00200     <a class="code" href="../../d3/d8/struct__KTIMER.html">PKTIMER</a> KeTimer;
00201     KIRQL OldIrql;
00202 
00203     <span class="comment">//</span>
00204     <span class="comment">// Get address of executive and kernel timer objects.</span>
00205     <span class="comment">//</span>
00206 
00207     ExTimer = (<a class="code" href="../../d2/d2/timer_8c.html#a1">PETIMER</a>)DeferredContext;
00208     KeTimer = &amp;ExTimer-&gt;<a class="code" href="../../d1/d7/struct__ETIMER.html#o0">KeTimer</a>;
00209 
00210     <span class="comment">//</span>
00211     <span class="comment">// If there is still an APC associated with the timer, then insert the APC</span>
00212     <span class="comment">// in target thread's APC queue. It is possible that the timer does not</span>
00213     <span class="comment">// have an associated APC. This can happen when the timer is set to expire</span>
00214     <span class="comment">// by a thread running on another processor just after the DPC has been</span>
00215     <span class="comment">// removed from the DPC queue, but before it has acquired the timer related</span>
00216     <span class="comment">// spin lock.</span>
00217     <span class="comment">//</span>
00218 
00219     ExAcquireSpinLock(&amp;ExTimer-&gt;<a class="code" href="../../d1/d7/struct__ETIMER.html#o4">Lock</a>, &amp;OldIrql);
00220     <span class="keywordflow">if</span> (ExTimer-&gt;<a class="code" href="../../d1/d7/struct__ETIMER.html#o6">ApcAssociated</a>) {
00221         <a class="code" href="../../d5/d7/apcobj_8c.html#a3">KeInsertQueueApc</a>(&amp;ExTimer-&gt;<a class="code" href="../../d1/d7/struct__ETIMER.html#o1">TimerApc</a>,
00222                          SystemArgument1,
00223                          SystemArgument2,
00224                          <a class="code" href="../../d7/d8/exboosts_8h.html#a17">TIMER_APC_INCREMENT</a>);
00225     }
00226 
00227     ExReleaseSpinLock(&amp;ExTimer-&gt;<a class="code" href="../../d1/d7/struct__ETIMER.html#o4">Lock</a>, OldIrql);
00228     <span class="keywordflow">return</span>;
00229 }
00230 
00231 <span class="keyword">static</span> <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00232"></a><a class="code" href="../../d2/d2/timer_8c.html#a8">00232</a> <a class="code" href="../../d2/d2/timer_8c.html#a8">ExpDeleteTimer</a> (
00233     IN PVOID Object
00234     )
00235 
00236 <span class="comment">/*++</span>
00237 <span class="comment"></span>
00238 <span class="comment">Routine Description:</span>
00239 <span class="comment"></span>
00240 <span class="comment">    This function is the delete routine for timer objects. Its function is</span>
00241 <span class="comment">    to cancel the timer and free the spin lock associated with a timer.</span>
00242 <span class="comment"></span>
00243 <span class="comment">Arguments:</span>
00244 <span class="comment"></span>
00245 <span class="comment">    Object - Supplies a pointer to an executive timer object.</span>
00246 <span class="comment"></span>
00247 <span class="comment">Return Value:</span>
00248 <span class="comment"></span>
00249 <span class="comment">    None.</span>
00250 <span class="comment"></span>
00251 <span class="comment">--*/</span>
00252 
00253 {
00254     <a class="code" href="../../d2/d2/timer_8c.html#a1">PETIMER</a>     ExTimer;
00255     KIRQL       OldIrql;
00256 
00257     ExTimer = (<a class="code" href="../../d2/d2/timer_8c.html#a1">PETIMER</a>) Object;
00258 
00259     <span class="comment">//</span>
00260     <span class="comment">// Remove from wake list</span>
00261     <span class="comment">//</span>
00262 
00263     <span class="keywordflow">if</span> (ExTimer-&gt;<a class="code" href="../../d1/d7/struct__ETIMER.html#o8">WakeTimerListEntry</a>.Flink) {
00264         ExAcquireSpinLock(&amp;<a class="code" href="../../d2/d2/timer_8c.html#a2">ExpWakeTimerListLock</a>, &amp;OldIrql);
00265         <span class="keywordflow">if</span> (ExTimer-&gt;<a class="code" href="../../d1/d7/struct__ETIMER.html#o8">WakeTimerListEntry</a>.Flink) {
00266             RemoveEntryList(&amp;ExTimer-&gt;<a class="code" href="../../d1/d7/struct__ETIMER.html#o8">WakeTimerListEntry</a>);
00267             ExTimer-&gt;<a class="code" href="../../d1/d7/struct__ETIMER.html#o8">WakeTimerListEntry</a>.Flink = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00268         }
00269         ExReleaseSpinLock(&amp;<a class="code" href="../../d2/d2/timer_8c.html#a2">ExpWakeTimerListLock</a>, OldIrql);
00270     }
00271 
00272     <span class="comment">//</span>
00273     <span class="comment">// Cancel the timer and free the spin lock associated with the timer.</span>
00274     <span class="comment">//</span>
00275 
00276     <a class="code" href="../../d3/d2/timerobj_8c.html#a4">KeCancelTimer</a>(&amp;ExTimer-&gt;<a class="code" href="../../d1/d7/struct__ETIMER.html#o0">KeTimer</a>);
00277     <span class="keywordflow">return</span>;
00278 }
00279 
00280 BOOLEAN
<a name="l00281"></a><a class="code" href="../../d2/d2/timer_8c.html#a9">00281</a> <a class="code" href="../../d2/d2/timer_8c.html#a9">ExpTimerInitialization</a> (
00282     )
00283 
00284 <span class="comment">/*++</span>
00285 <span class="comment"></span>
00286 <span class="comment">Routine Description:</span>
00287 <span class="comment"></span>
00288 <span class="comment">    This function creates the timer object type descriptor at system</span>
00289 <span class="comment">    initialization and stores the address of the object type descriptor</span>
00290 <span class="comment">    in local static storage.</span>
00291 <span class="comment"></span>
00292 <span class="comment">Arguments:</span>
00293 <span class="comment"></span>
00294 <span class="comment">    None.</span>
00295 <span class="comment"></span>
00296 <span class="comment">Return Value:</span>
00297 <span class="comment"></span>
00298 <span class="comment">    A value of TRUE is returned if the timer object type descriptor is</span>
00299 <span class="comment">    successfully initialized. Otherwise a value of FALSE is returned.</span>
00300 <span class="comment"></span>
00301 <span class="comment">--*/</span>
00302 
00303 {
00304 
00305     <a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html">OBJECT_TYPE_INITIALIZER</a> ObjectTypeInitializer;
00306     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00307     UNICODE_STRING TypeName;
00308 
00309     <a class="code" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock</a> (&amp;<a class="code" href="../../d2/d2/timer_8c.html#a2">ExpWakeTimerListLock</a>);
00310     InitializeListHead (&amp;<a class="code" href="../../d2/d2/timer_8c.html#a3">ExpWakeTimerList</a>);
00311 
00312     <span class="comment">//</span>
00313     <span class="comment">// Initialize string descriptor.</span>
00314     <span class="comment">//</span>
00315 
00316     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;TypeName, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Timer"</span>);
00317 
00318     <span class="comment">//</span>
00319     <span class="comment">// Create timer object type descriptor.</span>
00320     <span class="comment">//</span>
00321 
00322     RtlZeroMemory(&amp;ObjectTypeInitializer, <span class="keyword">sizeof</span>(ObjectTypeInitializer));
00323     ObjectTypeInitializer.Length = <span class="keyword">sizeof</span>(ObjectTypeInitializer);
00324     ObjectTypeInitializer.InvalidAttributes = OBJ_OPENLINK;
00325     ObjectTypeInitializer.GenericMapping = <a class="code" href="../../d2/d2/timer_8c.html#a5">ExpTimerMapping</a>;
00326     ObjectTypeInitializer.PoolType = <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>;
00327     ObjectTypeInitializer.DefaultNonPagedPoolCharge = <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d7/struct__ETIMER.html">ETIMER</a>);
00328     ObjectTypeInitializer.ValidAccessMask = TIMER_ALL_ACCESS;
00329     ObjectTypeInitializer.DeleteProcedure = <a class="code" href="../../d2/d2/timer_8c.html#a8">ExpDeleteTimer</a>;
00330     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d2/obtype_8c.html#a2">ObCreateObjectType</a>(&amp;TypeName,
00331                                 &amp;ObjectTypeInitializer,
00332                                 (PSECURITY_DESCRIPTOR)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00333                                 &amp;<a class="code" href="../../d2/d2/timer_8c.html#a4">ExTimerObjectType</a>);
00334 
00335 
00336 
00337     <span class="comment">//</span>
00338     <span class="comment">// If the time object type descriptor was successfully created, then</span>
00339     <span class="comment">// return a value of TRUE. Otherwise return a value of FALSE.</span>
00340     <span class="comment">//</span>
00341 
00342     <span class="keywordflow">return</span> (BOOLEAN)(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
00343 }
00344 
00345 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00346"></a><a class="code" href="../../d2/d2/timer_8c.html#a10">00346</a> <a class="code" href="../../d2/d2/timer_8c.html#a10">ExTimerRundown</a> (
00347     )
00348 
00349 <span class="comment">/*++</span>
00350 <span class="comment"></span>
00351 <span class="comment">Routine Description:</span>
00352 <span class="comment"></span>
00353 <span class="comment">    This function is called when a thread is about to be terminated to</span>
00354 <span class="comment">    process the active timer list. It is assumed that APC's have been</span>
00355 <span class="comment">    disabled for the subject thread, thus this code cannot be interrupted</span>
00356 <span class="comment">    to execute an APC for the current thread.</span>
00357 <span class="comment"></span>
00358 <span class="comment">Arguments:</span>
00359 <span class="comment"></span>
00360 <span class="comment">    None.</span>
00361 <span class="comment"></span>
00362 <span class="comment">Return Value:</span>
00363 <span class="comment"></span>
00364 <span class="comment">    None.</span>
00365 <span class="comment"></span>
00366 <span class="comment">--*/</span>
00367 
00368 {
00369 
00370     BOOLEAN Dereference;
00371     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> ExThread;
00372     <a class="code" href="../../d2/d2/timer_8c.html#a1">PETIMER</a> ExTimer;
00373     PLIST_ENTRY NextEntry;
00374     KIRQL OldIrql1;
00375 
00376     <span class="comment">//</span>
00377     <span class="comment">// Process each entry in the active timer list.</span>
00378     <span class="comment">//</span>
00379 
00380     ExThread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
00381     ExAcquireSpinLock(&amp;ExThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o10">ActiveTimerListLock</a>, &amp;OldIrql1);
00382     NextEntry = ExThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o11">ActiveTimerListHead</a>.Flink;
00383     <span class="keywordflow">while</span> (NextEntry != &amp;ExThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o11">ActiveTimerListHead</a>) {
00384         ExTimer = CONTAINING_RECORD(NextEntry, <a class="code" href="../../d1/d7/struct__ETIMER.html">ETIMER</a>, ActiveTimerListEntry);
00385 
00386         <span class="comment">//</span>
00387         <span class="comment">// Increment the reference count on the object so that it cannot be</span>
00388         <span class="comment">// deleted, and then drop the active timer list lock.</span>
00389         <span class="comment">//</span>
00390         <span class="comment">// N. B. The object reference cannot fail and will acquire no mutexes.</span>
00391         <span class="comment">//</span>
00392 
00393         <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>(ExTimer);
00394         ExReleaseSpinLock(&amp;ExThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o10">ActiveTimerListLock</a>, OldIrql1);
00395 
00396         <span class="comment">//</span>
00397         <span class="comment">// Acquire the timer spin lock and reacquire the active time list spin</span>
00398         <span class="comment">// lock. If the timer is still in the current thread's active timer</span>
00399         <span class="comment">// list, then cancel the timer, remove the timer's DPC from the DPC</span>
00400         <span class="comment">// queue, remove the timer's APC from the APC queue, remove the timer</span>
00401         <span class="comment">// from the thread's active timer list, and set the associate APC</span>
00402         <span class="comment">// flag FALSE.</span>
00403         <span class="comment">//</span>
00404         <span class="comment">// N. B. The spin locks for the timer and the active timer list must be</span>
00405         <span class="comment">//  acquired in the order: 1) timer lock, 2) thread list lock.</span>
00406         <span class="comment">//</span>
00407 
00408         ExAcquireSpinLock(&amp;ExTimer-&gt;<a class="code" href="../../d1/d7/struct__ETIMER.html#o4">Lock</a>, &amp;OldIrql1);
00409         ExAcquireSpinLockAtDpcLevel(&amp;ExThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o10">ActiveTimerListLock</a>);
00410         <span class="keywordflow">if</span> ((ExTimer-&gt;<a class="code" href="../../d1/d7/struct__ETIMER.html#o6">ApcAssociated</a>) &amp;&amp; (&amp;ExThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a> == ExTimer-&gt;<a class="code" href="../../d1/d7/struct__ETIMER.html#o1">TimerApc</a>.<a class="code" href="../../d1/d5/struct__KAPC.html#o3">Thread</a>)) {
00411             RemoveEntryList(&amp;ExTimer-&gt;<a class="code" href="../../d1/d7/struct__ETIMER.html#o3">ActiveTimerListEntry</a>);
00412             ExTimer-&gt;<a class="code" href="../../d1/d7/struct__ETIMER.html#o6">ApcAssociated</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00413             <a class="code" href="../../d3/d2/timerobj_8c.html#a4">KeCancelTimer</a>(&amp;ExTimer-&gt;<a class="code" href="../../d1/d7/struct__ETIMER.html#o0">KeTimer</a>);
00414             <a class="code" href="../../d4/d1/dpcobj_8c.html#a3">KeRemoveQueueDpc</a>(&amp;ExTimer-&gt;<a class="code" href="../../d1/d7/struct__ETIMER.html#o2">TimerDpc</a>);
00415             <a class="code" href="../../d5/d7/apcobj_8c.html#a4">KeRemoveQueueApc</a>(&amp;ExTimer-&gt;<a class="code" href="../../d1/d7/struct__ETIMER.html#o1">TimerApc</a>);
00416             Dereference = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00417 
00418         } <span class="keywordflow">else</span> {
00419             Dereference = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00420         }
00421 
00422         ExReleaseSpinLockFromDpcLevel(&amp;ExThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o10">ActiveTimerListLock</a>);
00423         ExReleaseSpinLock(&amp;ExTimer-&gt;<a class="code" href="../../d1/d7/struct__ETIMER.html#o4">Lock</a>, OldIrql1);
00424         <span class="keywordflow">if</span> (Dereference) {
00425             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>((PVOID)ExTimer);
00426         }
00427 
00428         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>((PVOID)ExTimer);
00429 
00430         <span class="comment">//</span>
00431         <span class="comment">// Raise IRQL to DISPATCH_LEVEL and reacquire active timer list</span>
00432         <span class="comment">// spin lock.</span>
00433         <span class="comment">//</span>
00434 
00435         ExAcquireSpinLock(&amp;ExThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o10">ActiveTimerListLock</a>, &amp;OldIrql1);
00436         NextEntry = ExThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o11">ActiveTimerListHead</a>.Flink;
00437     }
00438 
00439     ExReleaseSpinLock(&amp;ExThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o10">ActiveTimerListLock</a>, OldIrql1);
00440     <span class="keywordflow">return</span>;
00441 }
00442 
00443 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00444"></a><a class="code" href="../../d2/d2/timer_8c.html#a11">00444</a> <a class="code" href="../../d2/d2/timer_8c.html#a11">NtCreateTimer</a> (
00445     OUT PHANDLE TimerHandle,
00446     IN ACCESS_MASK DesiredAccess,
00447     IN POBJECT_ATTRIBUTES ObjectAttributes OPTIONAL,
00448     IN TIMER_TYPE TimerType
00449     )
00450 
00451 <span class="comment">/*++</span>
00452 <span class="comment"></span>
00453 <span class="comment">Routine Description:</span>
00454 <span class="comment"></span>
00455 <span class="comment">    This function creates an timer object and opens a handle to the object with</span>
00456 <span class="comment">    the specified desired access.</span>
00457 <span class="comment"></span>
00458 <span class="comment">Arguments:</span>
00459 <span class="comment"></span>
00460 <span class="comment">    TimerHandle - Supplies a pointer to a variable that will receive the</span>
00461 <span class="comment">        timer object handle.</span>
00462 <span class="comment"></span>
00463 <span class="comment">    DesiredAccess - Supplies the desired types of access for the timer object.</span>
00464 <span class="comment"></span>
00465 <span class="comment">    ObjectAttributes - Supplies a pointer to an object attributes structure.</span>
00466 <span class="comment"></span>
00467 <span class="comment">    TimerType - Supplies the type of the timer (autoclearing or notification).</span>
00468 <span class="comment"></span>
00469 <span class="comment">Return Value:</span>
00470 <span class="comment"></span>
00471 <span class="comment">    TBS</span>
00472 <span class="comment"></span>
00473 <span class="comment">--*/</span>
00474 
00475 {
00476 
00477     <a class="code" href="../../d2/d2/timer_8c.html#a1">PETIMER</a> ExTimer;
00478     HANDLE <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>;
00479     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00480     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00481 
00482     <span class="comment">//</span>
00483     <span class="comment">// Establish an exception handler, probe the output handle address, and</span>
00484     <span class="comment">// attempt to create a timer object. If the probe fails, then return the</span>
00485     <span class="comment">// exception code as the service status. Otherwise return the status value</span>
00486     <span class="comment">// returned by the object insertion routine.</span>
00487     <span class="comment">//</span>
00488 
00489     <span class="keywordflow">try</span> {
00490 
00491         <span class="comment">//</span>
00492         <span class="comment">// Get previous processor mode and probe output handle address if</span>
00493         <span class="comment">// necessary.</span>
00494         <span class="comment">//</span>
00495 
00496         PreviousMode = KeGetPreviousMode();
00497         <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00498             <a class="code" href="../../d5/d8/ex_8h.html#a35">ProbeForWriteHandle</a>(<a class="code" href="../../d3/d1/threads_8h.html#a95">TimerHandle</a>);
00499         }
00500 
00501         <span class="comment">//</span>
00502         <span class="comment">// Check argument validity.</span>
00503         <span class="comment">//</span>
00504 
00505         <span class="keywordflow">if</span> ((TimerType != NotificationTimer) &amp;&amp;
00506             (TimerType != SynchronizationTimer)) {
00507             <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER_4;
00508         }
00509 
00510         <span class="comment">//</span>
00511         <span class="comment">// Allocate timer object.</span>
00512         <span class="comment">//</span>
00513 
00514         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d0/obcreate_8c.html#a5">ObCreateObject</a>(PreviousMode,
00515                                 <a class="code" href="../../d2/d2/timer_8c.html#a4">ExTimerObjectType</a>,
00516                                 <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00517                                 PreviousMode,
00518                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00519                                 <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d7/struct__ETIMER.html">ETIMER</a>),
00520                                 0,
00521                                 0,
00522                                 (PVOID *)&amp;ExTimer);
00523 
00524         <span class="comment">//</span>
00525         <span class="comment">// If the timer object was successfully allocated, then initialize the</span>
00526         <span class="comment">// timer object and attempt to insert the time object in the current</span>
00527         <span class="comment">// process' handle table.</span>
00528         <span class="comment">//</span>
00529 
00530         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00531             <a class="code" href="../../d4/d1/dpcobj_8c.html#a1">KeInitializeDpc</a>(&amp;ExTimer-&gt;TimerDpc,
00532                             <a class="code" href="../../d2/d2/timer_8c.html#a7">ExpTimerDpcRoutine</a>,
00533                             (PVOID)ExTimer);
00534 
00535             <a class="code" href="../../d3/d2/timerobj_8c.html#a2">KeInitializeTimerEx</a>(&amp;ExTimer-&gt;KeTimer, TimerType);
00536             <a class="code" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock</a>(&amp;ExTimer-&gt;Lock);
00537             ExTimer-&gt;ApcAssociated = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00538             ExTimer-&gt;WakeTimer = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00539             ExTimer-&gt;WakeTimerListEntry.Flink = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00540             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d1/obinsert_8c.html#a0">ObInsertObject</a>((PVOID)ExTimer,
00541                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00542                                     DesiredAccess,
00543                                     0,
00544                                     (PVOID *)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00545                                     &amp;<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>);
00546 
00547             <span class="comment">//</span>
00548             <span class="comment">// If the timer object was successfully inserted in the current</span>
00549             <span class="comment">// process' handle table, then attempt to write the timer object</span>
00550             <span class="comment">// handle value. If the write attempt fails, then do not report</span>
00551             <span class="comment">// an error. When the caller attempts to access the handle value,</span>
00552             <span class="comment">// an access violation will occur.</span>
00553             <span class="comment">//</span>
00554 
00555             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00556                 <span class="keywordflow">try</span> {
00557                     *<a class="code" href="../../d3/d1/threads_8h.html#a95">TimerHandle</a> = <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>;
00558                  } except(<a class="code" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter</a>()) {
00559                  }
00560             }
00561         }
00562 
00563     <span class="comment">//</span>
00564     <span class="comment">// If an exception occurs during the probe of the output handle address,</span>
00565     <span class="comment">// then always handle the exception and return the exception code as the</span>
00566     <span class="comment">// status value.</span>
00567     <span class="comment">//</span>
00568 
00569     } except(<a class="code" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter</a>()) {
00570         <span class="keywordflow">return</span> GetExceptionCode();
00571     }
00572 
00573     <span class="comment">//</span>
00574     <span class="comment">// Return service status.</span>
00575     <span class="comment">//</span>
00576 
00577     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00578 }
00579 
00580 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00581"></a><a class="code" href="../../d2/d2/timer_8c.html#a12">00581</a> <a class="code" href="../../d2/d2/timer_8c.html#a12">NtOpenTimer</a> (
00582     OUT PHANDLE TimerHandle,
00583     IN ACCESS_MASK DesiredAccess,
00584     IN POBJECT_ATTRIBUTES ObjectAttributes
00585     )
00586 
00587 <span class="comment">/*++</span>
00588 <span class="comment"></span>
00589 <span class="comment">Routine Description:</span>
00590 <span class="comment"></span>
00591 <span class="comment">    This function opens a handle to an timer object with the specified</span>
00592 <span class="comment">    desired access.</span>
00593 <span class="comment"></span>
00594 <span class="comment">Arguments:</span>
00595 <span class="comment"></span>
00596 <span class="comment">    TimerHandle - Supplies a pointer to a variable that will receive the</span>
00597 <span class="comment">        timer object handle.</span>
00598 <span class="comment"></span>
00599 <span class="comment">    DesiredAccess - Supplies the desired types of access for the timer object.</span>
00600 <span class="comment"></span>
00601 <span class="comment">    ObjectAttributes - Supplies a pointer to an object attributes structure.</span>
00602 <span class="comment"></span>
00603 <span class="comment">Return Value:</span>
00604 <span class="comment"></span>
00605 <span class="comment">    TBS</span>
00606 <span class="comment"></span>
00607 <span class="comment">--*/</span>
00608 
00609 {
00610 
00611     HANDLE <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>;
00612     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00613     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00614 
00615     <span class="comment">//</span>
00616     <span class="comment">// Establish an exception handler, probe the output handle address, and</span>
00617     <span class="comment">// attempt to open a timer object. If the probe fails, then return the</span>
00618     <span class="comment">// exception code as the service status. Otherwise return the status value</span>
00619     <span class="comment">// returned by the open object routine.</span>
00620     <span class="comment">//</span>
00621 
00622     <span class="keywordflow">try</span> {
00623 
00624         <span class="comment">//</span>
00625         <span class="comment">// Get previous processor mode and probe output handle address if</span>
00626         <span class="comment">// necessary.</span>
00627         <span class="comment">//</span>
00628 
00629         PreviousMode = KeGetPreviousMode();
00630         <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00631             <a class="code" href="../../d5/d8/ex_8h.html#a35">ProbeForWriteHandle</a>(<a class="code" href="../../d3/d1/threads_8h.html#a95">TimerHandle</a>);
00632         }
00633 
00634         <span class="comment">//</span>
00635         <span class="comment">// Open handle to the timer object with the specified desired access.</span>
00636         <span class="comment">//</span>
00637 
00638         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a2">ObOpenObjectByName</a>(<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00639                                     <a class="code" href="../../d2/d2/timer_8c.html#a4">ExTimerObjectType</a>,
00640                                     PreviousMode,
00641                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00642                                     DesiredAccess,
00643                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00644                                     &amp;<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>);
00645 
00646         <span class="comment">//</span>
00647         <span class="comment">// If the open was successful, then attempt to write the timer object</span>
00648         <span class="comment">// handle value. If the write attempt fails, then do not report an</span>
00649         <span class="comment">// error. When the caller attempts to access the handle value, an</span>
00650         <span class="comment">// access violation will occur.</span>
00651         <span class="comment">//</span>
00652 
00653         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00654             <span class="keywordflow">try</span> {
00655                 *<a class="code" href="../../d3/d1/threads_8h.html#a95">TimerHandle</a> = <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>;
00656 
00657             } except(<a class="code" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter</a>()) {
00658             }
00659         }
00660 
00661     <span class="comment">//</span>
00662     <span class="comment">// If an exception occurs during the probe of the output handle address,</span>
00663     <span class="comment">// then always handle the exception and return the exception code as the</span>
00664     <span class="comment">// status value.</span>
00665     <span class="comment">//</span>
00666 
00667     } except(<a class="code" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter</a>()) {
00668         <span class="keywordflow">return</span> GetExceptionCode();
00669     }
00670 
00671     <span class="comment">//</span>
00672     <span class="comment">// Return service status.</span>
00673     <span class="comment">//</span>
00674 
00675     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00676 }
00677 
00678 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00679"></a><a class="code" href="../../d2/d2/timer_8c.html#a13">00679</a> <a class="code" href="../../d2/d2/timer_8c.html#a13">NtCancelTimer</a> (
00680     IN HANDLE TimerHandle,
00681     OUT PBOOLEAN CurrentState OPTIONAL
00682     )
00683 
00684 <span class="comment">/*++</span>
00685 <span class="comment"></span>
00686 <span class="comment">Routine Description:</span>
00687 <span class="comment"></span>
00688 <span class="comment">    This function cancels a timer object.</span>
00689 <span class="comment"></span>
00690 <span class="comment">Arguments:</span>
00691 <span class="comment"></span>
00692 <span class="comment">    TimerHandle - Supplies a handle to an timer object.</span>
00693 <span class="comment"></span>
00694 <span class="comment">    CurrentState - Supplies an optional pointer to a variable that will</span>
00695 <span class="comment">        receive the current state of the timer object.</span>
00696 <span class="comment"></span>
00697 <span class="comment">Return Value:</span>
00698 <span class="comment"></span>
00699 <span class="comment">    TBS</span>
00700 <span class="comment"></span>
00701 <span class="comment">--*/</span>
00702 
00703 {
00704 
00705     BOOLEAN Dereference;
00706     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> ExThread;
00707     <a class="code" href="../../d2/d2/timer_8c.html#a1">PETIMER</a> ExTimer;
00708     KIRQL OldIrql1;
00709     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00710     BOOLEAN State;
00711     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00712 
00713     <span class="comment">//</span>
00714     <span class="comment">// Establish an exception handler, probe the current state address if</span>
00715     <span class="comment">// specified, reference the timer object, and cancel the timer object.</span>
00716     <span class="comment">// If the probe fails, then return the exception code as the service</span>
00717     <span class="comment">// status. Otherwise return the status value returned by the reference</span>
00718     <span class="comment">// object by handle routine.</span>
00719     <span class="comment">//</span>
00720 
00721     <span class="keywordflow">try</span> {
00722 
00723         <span class="comment">//</span>
00724         <span class="comment">// Get previous processor mode and probe current state address if</span>
00725         <span class="comment">// necessary.</span>
00726         <span class="comment">//</span>
00727 
00728         PreviousMode = KeGetPreviousMode();
00729         <span class="keywordflow">if</span> ((PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) &amp;&amp; (ARGUMENT_PRESENT(CurrentState))) {
00730             <a class="code" href="../../d5/d8/ex_8h.html#a28">ProbeForWriteBoolean</a>(CurrentState);
00731         }
00732 
00733         <span class="comment">//</span>
00734         <span class="comment">// Reference timer object by handle.</span>
00735         <span class="comment">//</span>
00736 
00737         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(<a class="code" href="../../d3/d1/threads_8h.html#a95">TimerHandle</a>,
00738                                            TIMER_MODIFY_STATE,
00739                                            <a class="code" href="../../d2/d2/timer_8c.html#a4">ExTimerObjectType</a>,
00740                                            PreviousMode,
00741                                            (PVOID *)&amp;ExTimer,
00742                                            <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00743 
00744         <span class="comment">//</span>
00745         <span class="comment">// If the reference was successful, then cancel the timer object,</span>
00746         <span class="comment">// dereference the timer object, and write the current state value</span>
00747         <span class="comment">// if specified. If the write attempt fails, then do not report an</span>
00748         <span class="comment">// error. When the caller attempts to access the current state value,</span>
00749         <span class="comment">// an access violation will occur.</span>
00750         <span class="comment">//</span>
00751 
00752         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00753             ExAcquireSpinLock(&amp;ExTimer-&gt;Lock, &amp;OldIrql1);
00754             <span class="keywordflow">if</span> (ExTimer-&gt;ApcAssociated) {
00755                 ExThread = CONTAINING_RECORD(ExTimer-&gt;TimerApc.Thread, <a class="code" href="../../d5/d6/struct__ETHREAD.html">ETHREAD</a>, Tcb);
00756                 ExAcquireSpinLockAtDpcLevel(&amp;ExThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o10">ActiveTimerListLock</a>);
00757                 RemoveEntryList(&amp;ExTimer-&gt;ActiveTimerListEntry);
00758                 ExTimer-&gt;ApcAssociated = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00759                 ExReleaseSpinLockFromDpcLevel(&amp;ExThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o10">ActiveTimerListLock</a>);
00760                 <a class="code" href="../../d3/d2/timerobj_8c.html#a4">KeCancelTimer</a>(&amp;ExTimer-&gt;KeTimer);
00761                 <a class="code" href="../../d4/d1/dpcobj_8c.html#a3">KeRemoveQueueDpc</a>(&amp;ExTimer-&gt;TimerDpc);
00762                 <a class="code" href="../../d5/d7/apcobj_8c.html#a4">KeRemoveQueueApc</a>(&amp;ExTimer-&gt;TimerApc);
00763                 Dereference = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00764 
00765             } <span class="keywordflow">else</span> {
00766                 <a class="code" href="../../d3/d2/timerobj_8c.html#a4">KeCancelTimer</a>(&amp;ExTimer-&gt;KeTimer);
00767                 Dereference = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00768             }
00769 
00770             <span class="keywordflow">if</span> (ExTimer-&gt;WakeTimerListEntry.Flink) {
00771                 ExAcquireSpinLockAtDpcLevel(&amp;<a class="code" href="../../d2/d2/timer_8c.html#a2">ExpWakeTimerListLock</a>);
00772 
00773                 <span class="comment">//</span>
00774                 <span class="comment">// Check again as ExGetNextWakeTime might have removed it.</span>
00775                 <span class="comment">//</span>
00776                 <span class="keywordflow">if</span> (ExTimer-&gt;WakeTimerListEntry.Flink) {
00777                     RemoveEntryList(&amp;ExTimer-&gt;WakeTimerListEntry);
00778                     ExTimer-&gt;WakeTimerListEntry.Flink = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00779                 }
00780                 ExReleaseSpinLockFromDpcLevel(&amp;<a class="code" href="../../d2/d2/timer_8c.html#a2">ExpWakeTimerListLock</a>);
00781             }
00782 
00783             ExReleaseSpinLock(&amp;ExTimer-&gt;Lock, OldIrql1);
00784             <span class="keywordflow">if</span> (Dereference) {
00785                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>((PVOID)ExTimer);
00786             }
00787 
00788             <span class="comment">//</span>
00789             <span class="comment">// Read current state of timer, dereference timer object, and set</span>
00790             <span class="comment">// current state.</span>
00791             <span class="comment">//</span>
00792 
00793             State = <a class="code" href="../../d3/d2/timerobj_8c.html#a5">KeReadStateTimer</a>(&amp;ExTimer-&gt;KeTimer);
00794             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(ExTimer);
00795             <span class="keywordflow">if</span> (ARGUMENT_PRESENT(CurrentState)) {
00796                 <span class="keywordflow">try</span> {
00797                     *CurrentState = State;
00798 
00799                 } except(<a class="code" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter</a>()) {
00800                 }
00801             }
00802         }
00803 
00804     <span class="comment">//</span>
00805     <span class="comment">// If an exception occurs during the probe of the current state address,</span>
00806     <span class="comment">// then always handle the exception and return the exception code as the</span>
00807     <span class="comment">// status value.</span>
00808     <span class="comment">//</span>
00809 
00810     } except(<a class="code" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter</a>()) {
00811         <span class="keywordflow">return</span> GetExceptionCode();
00812     }
00813 
00814     <span class="comment">//</span>
00815     <span class="comment">// Return service status.</span>
00816     <span class="comment">//</span>
00817 
00818     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00819 }
00820 
00821 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00822"></a><a class="code" href="../../d2/d2/timer_8c.html#a14">00822</a> <a class="code" href="../../d2/d2/timer_8c.html#a14">NtQueryTimer</a> (
00823     IN HANDLE TimerHandle,
00824     IN TIMER_INFORMATION_CLASS TimerInformationClass,
00825     OUT PVOID TimerInformation,
00826     IN ULONG TimerInformationLength,
00827     OUT PULONG ReturnLength OPTIONAL
00828     )
00829 
00830 <span class="comment">/*++</span>
00831 <span class="comment"></span>
00832 <span class="comment">Routine Description:</span>
00833 <span class="comment"></span>
00834 <span class="comment">    This function queries the state of an timer object and returns the</span>
00835 <span class="comment">    requested information in the specified record structure.</span>
00836 <span class="comment"></span>
00837 <span class="comment">Arguments:</span>
00838 <span class="comment"></span>
00839 <span class="comment">    TimerHandle - Supplies a handle to an timer object.</span>
00840 <span class="comment"></span>
00841 <span class="comment">    TimerInformationClass - Supplies the class of information being requested.</span>
00842 <span class="comment"></span>
00843 <span class="comment">    TimerInformation - Supplies a pointer to a record that is to receive the</span>
00844 <span class="comment">        requested information.</span>
00845 <span class="comment"></span>
00846 <span class="comment">    TimerInformationLength - Supplies the length of the record that is to</span>
00847 <span class="comment">        receive the requested information.</span>
00848 <span class="comment"></span>
00849 <span class="comment">    ReturnLength - Supplies an optional pointer to a variable that is to</span>
00850 <span class="comment">        receive the actual length of information that is returned.</span>
00851 <span class="comment"></span>
00852 <span class="comment">Return Value:</span>
00853 <span class="comment"></span>
00854 <span class="comment">    TBS</span>
00855 <span class="comment"></span>
00856 <span class="comment">--*/</span>
00857 
00858 {
00859 
00860     <a class="code" href="../../d2/d2/timer_8c.html#a1">PETIMER</a> ExTimer;
00861     <a class="code" href="../../d3/d8/struct__KTIMER.html">PKTIMER</a> KeTimer;
00862     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00863     BOOLEAN State;
00864     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00865     LARGE_INTEGER TimeToGo;
00866 
00867     <span class="comment">//</span>
00868     <span class="comment">// Establish an exception handler, probe the output arguments, reference</span>
00869     <span class="comment">// the timer object, and return the specified information. If the probe</span>
00870     <span class="comment">// fails, then return the exception code as the service status. Otherwise</span>
00871     <span class="comment">// return the status value returned by the reference object by handle</span>
00872     <span class="comment">// routine.</span>
00873     <span class="comment">//</span>
00874 
00875     <span class="keywordflow">try</span> {
00876 
00877         <span class="comment">//</span>
00878         <span class="comment">// Get previous processor mode and probe output arguments if necessary.</span>
00879         <span class="comment">//</span>
00880 
00881         PreviousMode = KeGetPreviousMode();
00882         <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00883             <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>(TimerInformation,
00884                           <span class="keyword">sizeof</span>(TIMER_BASIC_INFORMATION),
00885                           <span class="keyword">sizeof</span>(ULONG));
00886 
00887             <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ReturnLength)) {
00888                 <a class="code" href="../../d5/d8/ex_8h.html#a40">ProbeForWriteUlong</a>(ReturnLength);
00889             }
00890         }
00891 
00892         <span class="comment">//</span>
00893         <span class="comment">// Check argument validity.</span>
00894         <span class="comment">//</span>
00895 
00896         <span class="keywordflow">if</span> (TimerInformationClass != TimerBasicInformation) {
00897             <span class="keywordflow">return</span> STATUS_INVALID_INFO_CLASS;
00898         }
00899 
00900         <span class="keywordflow">if</span> (TimerInformationLength != <span class="keyword">sizeof</span>(TIMER_BASIC_INFORMATION)) {
00901             <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
00902         }
00903 
00904         <span class="comment">//</span>
00905         <span class="comment">// Reference timer object by handle.</span>
00906         <span class="comment">//</span>
00907 
00908         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(<a class="code" href="../../d3/d1/threads_8h.html#a95">TimerHandle</a>,
00909                                            TIMER_QUERY_STATE,
00910                                            <a class="code" href="../../d2/d2/timer_8c.html#a4">ExTimerObjectType</a>,
00911                                            PreviousMode,
00912                                            (PVOID *)&amp;ExTimer,
00913                                            <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00914 
00915         <span class="comment">//</span>
00916         <span class="comment">// If the reference was successful, then read the current state,</span>
00917         <span class="comment">// compute the time remaining, dereference the timer object, fill in</span>
00918         <span class="comment">// the information structure, and return the length of the information</span>
00919         <span class="comment">// structure if specified. If the write of the time information or the</span>
00920         <span class="comment">// return length fails, then do not report an error. When the caller</span>
00921         <span class="comment">// accesses the information structure or the length, an violation will</span>
00922         <span class="comment">// occur.</span>
00923         <span class="comment">//</span>
00924 
00925         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00926             KeTimer = &amp;ExTimer-&gt;KeTimer;
00927             State = <a class="code" href="../../d3/d2/timerobj_8c.html#a5">KeReadStateTimer</a>(KeTimer);
00928             KiQueryInterruptTime(&amp;TimeToGo);
00929             TimeToGo.QuadPart = KeTimer-&gt;<a class="code" href="../../d3/d8/struct__KTIMER.html#o1">DueTime</a>.QuadPart - TimeToGo.QuadPart;
00930             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(ExTimer);
00931             <span class="keywordflow">try</span> {
00932                 ((PTIMER_BASIC_INFORMATION)TimerInformation)-&gt;TimerState = State;
00933                 ((PTIMER_BASIC_INFORMATION)TimerInformation)-&gt;RemainingTime = TimeToGo;
00934                 <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ReturnLength)) {
00935                     *ReturnLength = <span class="keyword">sizeof</span>(TIMER_BASIC_INFORMATION);
00936                 }
00937 
00938             } except(<a class="code" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter</a>()) {
00939             }
00940         }
00941 
00942     <span class="comment">//</span>
00943     <span class="comment">// If an exception occurs during the probe of the current state address,</span>
00944     <span class="comment">// then always handle the exception and return the exception code as the</span>
00945     <span class="comment">// status value.</span>
00946     <span class="comment">//</span>
00947 
00948     } except(<a class="code" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter</a>()) {
00949         <span class="keywordflow">return</span> GetExceptionCode();
00950     }
00951 
00952     <span class="comment">//</span>
00953     <span class="comment">// Return service status.</span>
00954     <span class="comment">//</span>
00955 
00956     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00957 }
00958 
00959 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00960"></a><a class="code" href="../../d2/d2/timer_8c.html#a15">00960</a> <a class="code" href="../../d2/d2/timer_8c.html#a15">NtSetTimer</a> (
00961     IN HANDLE TimerHandle,
00962     IN PLARGE_INTEGER DueTime,
00963     IN PTIMER_APC_ROUTINE TimerApcRoutine OPTIONAL,
00964     IN PVOID TimerContext OPTIONAL,
00965     IN BOOLEAN WakeTimer,
00966     IN LONG Period OPTIONAL,
00967     OUT PBOOLEAN PreviousState OPTIONAL
00968     )
00969 
00970 <span class="comment">/*++</span>
00971 <span class="comment"></span>
00972 <span class="comment">Routine Description:</span>
00973 <span class="comment"></span>
00974 <span class="comment">    This function sets an timer object to a Not-Signaled state and sets the timer</span>
00975 <span class="comment">    to expire at the specified time.</span>
00976 <span class="comment"></span>
00977 <span class="comment">Arguments:</span>
00978 <span class="comment"></span>
00979 <span class="comment">    TimerHandle - Supplies a handle to an timer object.</span>
00980 <span class="comment"></span>
00981 <span class="comment">    DueTime - Supplies a pointer to absolute of relative time at which the</span>
00982 <span class="comment">        timer is to expire.</span>
00983 <span class="comment"></span>
00984 <span class="comment">    TimerApcRoutine - Supplies an optional pointer to a function which is to</span>
00985 <span class="comment">        be executed when the timer expires. If this parameter is not specified,</span>
00986 <span class="comment">        then the TimerContext parameter is ignored.</span>
00987 <span class="comment"></span>
00988 <span class="comment">    TimerContext - Supplies an optional pointer to an arbitrary data structure</span>
00989 <span class="comment">        that will be passed to the function specified by the TimerApcRoutine</span>
00990 <span class="comment">        parameter. This parameter is ignored if the TimerApcRoutine parameter</span>
00991 <span class="comment">        is not specified.</span>
00992 <span class="comment"></span>
00993 <span class="comment">    WakeTimer - Supplies a boolean value that specifies whether the timer</span>
00994 <span class="comment">        wakes computer operation if sleeping</span>
00995 <span class="comment"></span>
00996 <span class="comment">    Period - Supplies an optional repetitive period for the timer.</span>
00997 <span class="comment"></span>
00998 <span class="comment">    PreviousState - Supplies an optional pointer to a variable that will</span>
00999 <span class="comment">        receive the previous state of the timer object.</span>
01000 <span class="comment"></span>
01001 <span class="comment">Return Value:</span>
01002 <span class="comment"></span>
01003 <span class="comment">    TBS</span>
01004 <span class="comment"></span>
01005 <span class="comment">--*/</span>
01006 
01007 {
01008 
01009     BOOLEAN AssociatedApc;
01010     BOOLEAN Dereference;
01011     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> ExThread;
01012     <a class="code" href="../../d2/d2/timer_8c.html#a1">PETIMER</a> ExTimer;
01013     LARGE_INTEGER ExpirationTime;
01014     KIRQL OldIrql1;
01015     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
01016     BOOLEAN State;
01017     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01018 
01019     <span class="comment">//</span>
01020     <span class="comment">// Establish an exception handler, probe the due time and previous state</span>
01021     <span class="comment">// address if specified, reference the timer object, and set the timer</span>
01022     <span class="comment">// object. If the probe fails, then return the exception code as the</span>
01023     <span class="comment">// service status. Otherwise return the status value returned by the</span>
01024     <span class="comment">// reference object by handle routine.</span>
01025     <span class="comment">//</span>
01026 
01027     <span class="keywordflow">try</span> {
01028 
01029         <span class="comment">//</span>
01030         <span class="comment">// Get previous processor mode and probe previous state address</span>
01031         <span class="comment">// if necessary.</span>
01032         <span class="comment">//</span>
01033 
01034         PreviousMode = KeGetPreviousMode();
01035         <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
01036             <span class="keywordflow">if</span> (ARGUMENT_PRESENT(PreviousState)) {
01037                 <a class="code" href="../../d5/d8/ex_8h.html#a28">ProbeForWriteBoolean</a>(PreviousState);
01038             }
01039 
01040             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(DueTime, <span class="keyword">sizeof</span>(LARGE_INTEGER), <span class="keyword">sizeof</span>(ULONG));
01041         }
01042 
01043         <span class="comment">//</span>
01044         <span class="comment">// Check argument validity.</span>
01045         <span class="comment">//</span>
01046 
01047         <span class="keywordflow">if</span> (Period &lt; 0) {
01048             <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER_6;
01049         }
01050 
01051         <span class="comment">//</span>
01052         <span class="comment">// Capture the expiration time.</span>
01053         <span class="comment">//</span>
01054 
01055         ExpirationTime = *DueTime;
01056 
01057         <span class="comment">//</span>
01058         <span class="comment">// Reference timer object by handle.</span>
01059         <span class="comment">//</span>
01060 
01061         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a>(<a class="code" href="../../d3/d1/threads_8h.html#a95">TimerHandle</a>,
01062                                            TIMER_MODIFY_STATE,
01063                                            <a class="code" href="../../d2/d2/timer_8c.html#a4">ExTimerObjectType</a>,
01064                                            PreviousMode,
01065                                            (PVOID *)&amp;ExTimer,
01066                                            <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01067 
01068         <span class="comment">//</span>
01069         <span class="comment">// If this WakeTimer flag is set, return the appropiate informational</span>
01070         <span class="comment">// success status code.</span>
01071         <span class="comment">//</span>
01072 
01073         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) &amp;&amp; WakeTimer &amp;&amp; !<a class="code" href="../../d1/d2/po_8h.html#a13">PoWakeTimerSupported</a>()) {
01074             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_TIMER_RESUME_IGNORED;
01075         }
01076 
01077         <span class="comment">//</span>
01078         <span class="comment">// If the reference was successful, then cancel the timer object, set</span>
01079         <span class="comment">// the timer object, dereference time object, and write the previous</span>
01080         <span class="comment">// state value if specified. If the write of the previous state value</span>
01081         <span class="comment">// fails, then do not report an error. When the caller attempts to</span>
01082         <span class="comment">// access the previous state value, an access violation will occur.</span>
01083         <span class="comment">//</span>
01084 
01085         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01086             ExAcquireSpinLock(&amp;ExTimer-&gt;Lock, &amp;OldIrql1);
01087 
01088             <span class="keywordflow">if</span> (ExTimer-&gt;ApcAssociated) {
01089                 ExThread = CONTAINING_RECORD(ExTimer-&gt;TimerApc.Thread, <a class="code" href="../../d5/d6/struct__ETHREAD.html">ETHREAD</a>, Tcb);
01090                 ExAcquireSpinLockAtDpcLevel(&amp;ExThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o10">ActiveTimerListLock</a>);
01091                 RemoveEntryList(&amp;ExTimer-&gt;ActiveTimerListEntry);
01092                 ExTimer-&gt;ApcAssociated = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01093                 ExReleaseSpinLockFromDpcLevel(&amp;ExThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o10">ActiveTimerListLock</a>);
01094                 <a class="code" href="../../d3/d2/timerobj_8c.html#a4">KeCancelTimer</a>(&amp;ExTimer-&gt;KeTimer);
01095                 <a class="code" href="../../d4/d1/dpcobj_8c.html#a3">KeRemoveQueueDpc</a>(&amp;ExTimer-&gt;TimerDpc);
01096                 <a class="code" href="../../d5/d7/apcobj_8c.html#a4">KeRemoveQueueApc</a>(&amp;ExTimer-&gt;TimerApc);
01097                 Dereference = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01098 
01099             } <span class="keywordflow">else</span> {
01100                 <a class="code" href="../../d3/d2/timerobj_8c.html#a4">KeCancelTimer</a>(&amp;ExTimer-&gt;KeTimer);
01101                 Dereference = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01102             }
01103 
01104             <span class="comment">//</span>
01105             <span class="comment">// Read the current state of the timer.</span>
01106             <span class="comment">//</span>
01107 
01108             State = <a class="code" href="../../d3/d2/timerobj_8c.html#a5">KeReadStateTimer</a>(&amp;ExTimer-&gt;KeTimer);
01109 
01110             <span class="comment">//</span>
01111             <span class="comment">// If this is a wake timer ensure it's on the wake timer list</span>
01112             <span class="comment">//</span>
01113 
01114             ExTimer-&gt;WakeTimer = WakeTimer;
01115             ExAcquireSpinLockAtDpcLevel(&amp;<a class="code" href="../../d2/d2/timer_8c.html#a2">ExpWakeTimerListLock</a>);
01116             <span class="keywordflow">if</span> (WakeTimer) {
01117                 <span class="keywordflow">if</span> (!ExTimer-&gt;WakeTimerListEntry.Flink) {
01118                     InsertTailList(&amp;<a class="code" href="../../d2/d2/timer_8c.html#a3">ExpWakeTimerList</a>, &amp;ExTimer-&gt;WakeTimerListEntry);
01119                 }
01120             } <span class="keywordflow">else</span> {
01121                 <span class="keywordflow">if</span> (ExTimer-&gt;WakeTimerListEntry.Flink) {
01122                     RemoveEntryList(&amp;ExTimer-&gt;WakeTimerListEntry);
01123                     ExTimer-&gt;WakeTimerListEntry.Flink = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01124                 }
01125             }
01126             ExReleaseSpinLockFromDpcLevel(&amp;<a class="code" href="../../d2/d2/timer_8c.html#a2">ExpWakeTimerListLock</a>);
01127 
01128             <span class="comment">//</span>
01129             <span class="comment">// If an APC routine is specified, then initialize the APC, acquire the</span>
01130             <span class="comment">// thread's active time list lock, insert the timer in the thread's</span>
01131             <span class="comment">// active timer list, set the timer with an associated DPC, and set the</span>
01132             <span class="comment">// associated APC flag TRUE. Otherwise set the timer without an associated</span>
01133             <span class="comment">// DPC, and set the associated APC flag FALSE.</span>
01134             <span class="comment">//</span>
01135 
01136             ExTimer-&gt;Period = Period;
01137             <span class="keywordflow">if</span> (ARGUMENT_PRESENT(<a class="code" href="../../d4/d0/tex_8c.html#a29">TimerApcRoutine</a>)) {
01138                 ExThread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
01139                 <a class="code" href="../../d5/d7/apcobj_8c.html#a1">KeInitializeApc</a>(&amp;ExTimer-&gt;TimerApc,
01140                                 &amp;ExThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>,
01141                                 <a class="code" href="../../d4/d9/ke_8h.html#a403a183">CurrentApcEnvironment</a>,
01142                                 <a class="code" href="../../d2/d2/timer_8c.html#a6">ExpTimerApcRoutine</a>,
01143                                 (<a class="code" href="../../d0/d9/ntosdef_8h.html#a43">PKRUNDOWN_ROUTINE</a>)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01144                                 (<a class="code" href="../../d0/d9/ntosdef_8h.html#a41">PKNORMAL_ROUTINE</a>)<a class="code" href="../../d4/d0/tex_8c.html#a29">TimerApcRoutine</a>,
01145                                 PreviousMode,
01146                                 TimerContext);
01147 
01148                 ExAcquireSpinLockAtDpcLevel(&amp;ExThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o10">ActiveTimerListLock</a>);
01149                 InsertTailList(&amp;ExThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o11">ActiveTimerListHead</a>,
01150                                &amp;ExTimer-&gt;ActiveTimerListEntry);
01151 
01152                 ExTimer-&gt;ApcAssociated = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01153                 ExReleaseSpinLockFromDpcLevel(&amp;ExThread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o10">ActiveTimerListLock</a>);
01154                 <a class="code" href="../../d3/d2/timerobj_8c.html#a7">KeSetTimerEx</a>(&amp;ExTimer-&gt;KeTimer,
01155                              ExpirationTime,
01156                              Period,
01157                              &amp;ExTimer-&gt;TimerDpc);
01158 
01159                 AssociatedApc = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01160 
01161             } <span class="keywordflow">else</span> {
01162                 <a class="code" href="../../d3/d2/timerobj_8c.html#a7">KeSetTimerEx</a>(&amp;ExTimer-&gt;KeTimer,
01163                              ExpirationTime,
01164                              Period,
01165                              <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01166 
01167                 AssociatedApc = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01168             }
01169 
01170             ExReleaseSpinLock(&amp;ExTimer-&gt;Lock, OldIrql1);
01171 
01172             <span class="comment">//</span>
01173             <span class="comment">// Dereference the object as appropriate.</span>
01174             <span class="comment">//</span>
01175 
01176             <span class="keywordflow">if</span> (Dereference) {
01177                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>((PVOID)ExTimer);
01178             }
01179 
01180             <span class="keywordflow">if</span> (AssociatedApc == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01181                 <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>((PVOID)ExTimer);
01182             }
01183 
01184             <span class="keywordflow">if</span> (ARGUMENT_PRESENT(PreviousState)) {
01185                 <span class="keywordflow">try</span> {
01186                     *PreviousState = State;
01187 
01188                 } except(<a class="code" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter</a>()) {
01189                 }
01190             }
01191         }
01192 
01193     <span class="comment">//</span>
01194     <span class="comment">// If an exception occurs during the probe of the current state address,</span>
01195     <span class="comment">// then always handle the exception and return the exception code as the</span>
01196     <span class="comment">// status value.</span>
01197     <span class="comment">//</span>
01198 
01199     } except(<a class="code" href="../../d5/d8/ex_8h.html#a307">ExSystemExceptionFilter</a>()) {
01200         <span class="keywordflow">return</span> GetExceptionCode();
01201     }
01202 
01203     <span class="comment">//</span>
01204     <span class="comment">// Return service status.</span>
01205     <span class="comment">//</span>
01206 
01207     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01208 }
01209 
01210 
01211 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01212"></a><a class="code" href="../../d5/d8/ex_8h.html#a315">01212</a> <a class="code" href="../../d5/d8/ex_8h.html#a315">ExGetNextWakeTime</a> (
01213     OUT PULONGLONG      DueTime,
01214     OUT PTIME_FIELDS    TimeFields,
01215     OUT PVOID           *TimerObject
01216     )
01217 {
01218     PLIST_ENTRY     Link;
01219     <a class="code" href="../../d2/d2/timer_8c.html#a1">PETIMER</a>         ExTimer;
01220     <a class="code" href="../../d2/d2/timer_8c.html#a1">PETIMER</a>         BestTimer;
01221     KIRQL           OldIrql;
01222     ULONGLONG       TimerDueTime;
01223     ULONGLONG       BestDueTime;
01224     ULONGLONG       InterruptTime;
01225     LARGE_INTEGER   SystemTime;
01226     LARGE_INTEGER   CmosTime;
01227 
01228     ExAcquireSpinLock(&amp;<a class="code" href="../../d2/d2/timer_8c.html#a2">ExpWakeTimerListLock</a>, &amp;OldIrql);
01229     BestDueTime = 0;
01230     BestTimer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01231     Link = <a class="code" href="../../d2/d2/timer_8c.html#a3">ExpWakeTimerList</a>.Flink;
01232     <span class="keywordflow">while</span> (Link != &amp;<a class="code" href="../../d2/d2/timer_8c.html#a3">ExpWakeTimerList</a>) {
01233         ExTimer = CONTAINING_RECORD(Link, <a class="code" href="../../d1/d7/struct__ETIMER.html">ETIMER</a>, WakeTimerListEntry);
01234         Link = Link-&gt;Flink;
01235 
01236         <span class="keywordflow">if</span> (ExTimer-&gt;<a class="code" href="../../d1/d7/struct__ETIMER.html#o7">WakeTimer</a>) {
01237 
01238             TimerDueTime = <a class="code" href="../../d3/d2/timerobj_8c.html#a8">KeQueryTimerDueTime</a>(&amp;ExTimer-&gt;<a class="code" href="../../d1/d7/struct__ETIMER.html#o0">KeTimer</a>);
01239             TimerDueTime = 0 - TimerDueTime;
01240 
01241             <span class="comment">//</span>
01242             <span class="comment">// Is this timers due time closer?</span>
01243             <span class="comment">//</span>
01244 
01245             <span class="keywordflow">if</span> (TimerDueTime &gt; BestDueTime) {
01246                 BestDueTime = TimerDueTime;
01247                 BestTimer = ExTimer;
01248             }
01249 
01250         } <span class="keywordflow">else</span> {
01251 
01252             <span class="comment">//</span>
01253             <span class="comment">// Timer is not an active wake timer, remove it</span>
01254             <span class="comment">//</span>
01255 
01256             RemoveEntryList(&amp;ExTimer-&gt;<a class="code" href="../../d1/d7/struct__ETIMER.html#o8">WakeTimerListEntry</a>);
01257             ExTimer-&gt;<a class="code" href="../../d1/d7/struct__ETIMER.html#o8">WakeTimerListEntry</a>.Flink = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01258         }
01259     }
01260 
01261     ExReleaseSpinLock(&amp;<a class="code" href="../../d2/d2/timer_8c.html#a2">ExpWakeTimerListLock</a>, OldIrql);
01262 
01263     <span class="keywordflow">if</span> (BestDueTime) {
01264         <span class="comment">//</span>
01265         <span class="comment">// Convert time to timefields</span>
01266         <span class="comment">//</span>
01267 
01268         <a class="code" href="../../d7/d0/ke_2miscc_8c.html#a3">KeQuerySystemTime</a> (&amp;SystemTime);
01269         InterruptTime = <a class="code" href="../../d7/d0/ke_2miscc_8c.html#a2">KeQueryInterruptTime</a> ();
01270         BestDueTime = 0 - BestDueTime;
01271 
01272         SystemTime.QuadPart += BestDueTime - InterruptTime;
01273 
01274         <span class="comment">//</span>
01275         <span class="comment">// Many system alarms are only good to 1 second resolution.</span>
01276         <span class="comment">// Add one sceond to the target time so that the timer is really</span>
01277         <span class="comment">// elasped if this is the wake event.</span>
01278         <span class="comment">//</span>
01279 
01280         SystemTime.QuadPart += 10000000;
01281 
01282         <a class="code" href="../../d5/d8/ex_8h.html#a317">ExSystemTimeToLocalTime</a>(&amp;SystemTime,&amp;CmosTime);
01283         <a class="code" href="../../d1/d2/time_8c.html#a26">RtlTimeToTimeFields</a>(&amp;CmosTime, <a class="code" href="../../d6/d6/ttime_8c.html#a13">TimeFields</a>);
01284     }
01285 
01286     *DueTime = BestDueTime;
01287     *TimerObject = BestTimer;
01288 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:59 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
