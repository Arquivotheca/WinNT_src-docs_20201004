<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: i386/psldt.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>psldt.c File Reference</h1><code>#include "<a class="el" href="../../d9/d0/psp_8h-source.html">psp.h</a>"</code><br>

<p>
<a href="../../d4/d0/i386_2psldt_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d1/i386_2psldt_8c.html#a0">DESCRIPTOR_GRAN</a>&nbsp;&nbsp;&nbsp;0x00800000</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d1/i386_2psldt_8c.html#a1">DESCRIPTOR_NP</a>&nbsp;&nbsp;&nbsp;0x00008000</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d1/i386_2psldt_8c.html#a2">DESCRIPTOR_SYSTEM</a>&nbsp;&nbsp;&nbsp;0x00001000</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d1/i386_2psldt_8c.html#a3">DESCRIPTOR_CONFORM</a>&nbsp;&nbsp;&nbsp;0x00001C00</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d1/i386_2psldt_8c.html#a4">DESCRIPTOR_DPL</a>&nbsp;&nbsp;&nbsp;0x00006000</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d1/i386_2psldt_8c.html#a5">DESCRIPTOR_TYPEDPL</a>&nbsp;&nbsp;&nbsp;0x00007F00</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>PLDT_ENTRY&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d1/i386_2psldt_8c.html#a7">PspCreateLdt</a> (IN PLDT_ENTRY Ldt, IN ULONG <a class="el" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>, IN ULONG <a class="el" href="../../d9/d7/w98_2lh__open_2pi__mem_8h.html#a0">Size</a>, IN ULONG AllocationSize)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d1/i386_2psldt_8c.html#a8">PspIsDescriptorValid</a> (IN PLDT_ENTRY Descriptor)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d1/i386_2psldt_8c.html#a9">PspLdtInitialize</a> ()</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d1/i386_2psldt_8c.html#a10">PspQueryLdtInformation</a> (IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process, OUT PPROCESS_LDT_INFORMATION LdtInformation, IN ULONG LdtInformationLength, OUT PULONG ReturnLength)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d1/i386_2psldt_8c.html#a11">PspSetLdtSize</a> (IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process, IN PPROCESS_LDT_SIZE LdtSize, IN ULONG LdtSizeLength)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d1/i386_2psldt_8c.html#a12">PspSetLdtInformation</a> (IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process, IN PPROCESS_LDT_INFORMATION LdtInformation, IN ULONG LdtInformationLength)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d1/i386_2psldt_8c.html#a13">PspQueryDescriptorThread</a> (<a class="el" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> Thread, PVOID ThreadInformation, ULONG ThreadInformationLength, PULONG ReturnLength)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d1/i386_2psldt_8c.html#a14">PspDeleteLdt</a> (IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d1/i386_2psldt_8c.html#a15">NtSetLdtEntries</a> (IN ULONG Selector0, IN ULONG Entry0Low, IN ULONG Entry0Hi, IN ULONG Selector1, IN ULONG Entry1Low, IN ULONG Entry1Hi)</td></tr>

<tr><td colspan=2><br><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d3/d7/struct__KMUTANT.html">KMUTEX</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d1/i386_2psldt_8c.html#a6">LdtMutex</a></td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a3" doxytag="i386/psldt.c::DESCRIPTOR_CONFORM" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define DESCRIPTOR_CONFORM&nbsp;&nbsp;&nbsp;0x00001C00          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d0/i386_2psldt_8c-source.html#l00046">46</a> of file <a class="el" href="../../d4/d0/i386_2psldt_8c-source.html">i386/psldt.c</a>.
<p>
Referenced by <a class="el" href="../../d4/d0/i386_2psldt_8c-source.html#l01235">NtSetLdtEntries()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="i386/psldt.c::DESCRIPTOR_DPL" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define DESCRIPTOR_DPL&nbsp;&nbsp;&nbsp;0x00006000          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d0/i386_2psldt_8c-source.html#l00047">47</a> of file <a class="el" href="../../d4/d0/i386_2psldt_8c-source.html">i386/psldt.c</a>.
<p>
Referenced by <a class="el" href="../../d4/d0/i386_2psldt_8c-source.html#l01235">NtSetLdtEntries()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="i386/psldt.c::DESCRIPTOR_GRAN" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define DESCRIPTOR_GRAN&nbsp;&nbsp;&nbsp;0x00800000          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d0/i386_2psldt_8c-source.html#l00043">43</a> of file <a class="el" href="../../d4/d0/i386_2psldt_8c-source.html">i386/psldt.c</a>.
<p>
Referenced by <a class="el" href="../../d4/d0/i386_2psldt_8c-source.html#l01235">NtSetLdtEntries()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="i386/psldt.c::DESCRIPTOR_NP" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define DESCRIPTOR_NP&nbsp;&nbsp;&nbsp;0x00008000          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d0/i386_2psldt_8c-source.html#l00044">44</a> of file <a class="el" href="../../d4/d0/i386_2psldt_8c-source.html">i386/psldt.c</a>.
<p>
Referenced by <a class="el" href="../../d4/d0/i386_2psldt_8c-source.html#l01235">NtSetLdtEntries()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="i386/psldt.c::DESCRIPTOR_SYSTEM" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define DESCRIPTOR_SYSTEM&nbsp;&nbsp;&nbsp;0x00001000          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d0/i386_2psldt_8c-source.html#l00045">45</a> of file <a class="el" href="../../d4/d0/i386_2psldt_8c-source.html">i386/psldt.c</a>.
<p>
Referenced by <a class="el" href="../../d4/d0/i386_2psldt_8c-source.html#l01235">NtSetLdtEntries()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="i386/psldt.c::DESCRIPTOR_TYPEDPL" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define DESCRIPTOR_TYPEDPL&nbsp;&nbsp;&nbsp;0x00007F00          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d0/i386_2psldt_8c-source.html#l00048">48</a> of file <a class="el" href="../../d4/d0/i386_2psldt_8c-source.html">i386/psldt.c</a>.
<p>
Referenced by <a class="el" href="../../d4/d0/i386_2psldt_8c-source.html#l01235">NtSetLdtEntries()</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a15" doxytag="i386/psldt.c::NtSetLdtEntries" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS NtSetLdtEntries           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Selector0</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Entry0Low</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Entry0Hi</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Selector1</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Entry1Low</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Entry1Hi</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d0/i386_2psldt_8c-source.html#l01235">1235</a> of file <a class="el" href="../../d4/d0/i386_2psldt_8c-source.html">i386/psldt.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d4/d0/i386_2psldt_8c-source.html#l00046">DESCRIPTOR_CONFORM</a>, <a class="el" href="../../d4/d0/i386_2psldt_8c-source.html#l00047">DESCRIPTOR_DPL</a>, <a class="el" href="../../d4/d0/i386_2psldt_8c-source.html#l00043">DESCRIPTOR_GRAN</a>, <a class="el" href="../../d4/d0/i386_2psldt_8c-source.html#l00044">DESCRIPTOR_NP</a>, <a class="el" href="../../d4/d0/i386_2psldt_8c-source.html#l00045">DESCRIPTOR_SYSTEM</a>, <a class="el" href="../../d4/d0/i386_2psldt_8c-source.html#l00048">DESCRIPTOR_TYPEDPL</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d2/i386_2ldtsup_8c-source.html#l00255">Ke386SetDescriptorProcess()</a>, <a class="el" href="../../d5/d2/i386_2ldtsup_8c-source.html#l00063">Ke386SetLdtProcess()</a>, <a class="el" href="../../d4/d4/mutntobj_8c-source.html#l00310">KeReleaseMutex()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00256">_EPROCESS::LdtInformation</a>, <a class="el" href="../../d4/d0/i386_2psldt_8c-source.html#l00051">LdtMutex</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00166">_EPROCESS::Pcb</a>, <a class="el" href="../../d1/d1/psquota_8c-source.html#l00246">PsChargePoolQuota()</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00643">PsGetCurrentProcess</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
<pre class="fragment"><div>01245                    :
01246 
01247     This routine sets up to two selectors in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current process's LDT.
01248     The LDT will be grown as necessary.  <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> selector value of 0 indicates
01249     that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified selector was not passed (allowing the setting of
01250     a single selector).
01251 
01252 Arguments:
01253 
01254     Selector0 -- Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first descriptor to set
01255     Entry0Low -- Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d3/fetypes_8h.html#a457a418">low</a> 32 bits of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> descriptor
01256     Entry0Hi -- Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d3/fetypes_8h.html#a457a417">high</a> 32 bits of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> descriptor
01257     Selector1 -- Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first descriptor to set
01258     Entry1Low -- Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d3/fetypes_8h.html#a457a418">low</a> 32 bits of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> descriptor
01259     Entry1Hi -- Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d3/fetypes_8h.html#a457a417">high</a> 32 bits of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> descriptor
01260 
01261 Return Value:
01262 
01263     TBS
01264 --*/
01265 
01266 {
01267     ULONG Base, Limit, LdtSize, AllocatedSize;
01268     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01269     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
01270     LDT_ENTRY Descriptor;
01271     PLDT_ENTRY Ldt, OldLdt;
01272     PLDTINFORMATION ProcessLdtInformation;
01273     LONG MutexState;
01274 
01275     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01276 
01277     <span class="comment">//</span>
01278     <span class="comment">// Verify the selectors.  We do not allow selectors that point into</span>
01279     <span class="comment">// Kernel space, system selectors, or conforming code selectors</span>
01280     <span class="comment">//</span>
01281 
01282     <span class="comment">//</span>
01283     <span class="comment">// Verify the selectors</span>
01284     <span class="comment">//</span>
01285     <span class="keywordflow">if</span> ((Selector0 &amp; 0xFFFF0000) || (Selector1 &amp; 0xFFFF0000)) {
01286         <span class="keywordflow">return</span> STATUS_INVALID_LDT_DESCRIPTOR;
01287     }
01288 
01289     <span class="comment">// Change the selector values to indexes into the LDT</span>
01290 
01291     Selector0 = Selector0 &amp; ~(RPL_MASK | SELECTOR_TABLE_INDEX);
01292     Selector1 = Selector1 &amp; ~(RPL_MASK | SELECTOR_TABLE_INDEX);
01293 
01294 
01295     <span class="comment">//</span>
01296     <span class="comment">// Verify descriptor 0</span>
01297     <span class="comment">//</span>
01298 
01299     <span class="keywordflow">if</span> (Selector0) {
01300 
01301         <span class="comment">// Form the base and the limit</span>
01302         Base = ((Entry0Low &amp; 0xFFFF0000) &gt;&gt; 16) + ((Entry0Hi &amp; 0xFF) &lt;&lt; 16)
01303             + (Entry0Hi &amp; 0xFF000000);
01304 
01305         Limit = (Entry0Low &amp; 0xFFFF) + (Entry0Hi &amp; 0xF0000);
01306 
01307         <span class="comment">// N.B.  the interpretation of the limit depends on the G bit</span>
01308         <span class="comment">// in the descriptor</span>
01309 
01310         <span class="keywordflow">if</span> (Entry0Hi &amp; <a class="code" href="../../d3/d1/i386_2psldt_8c.html#a0">DESCRIPTOR_GRAN</a>) {
01311             Limit = (Limit &lt;&lt; 12) | 0xFFF;
01312         }
01313 
01314         <span class="comment">//</span>
01315         <span class="comment">// Base and limit don't matter for NP descriptors, so only check</span>
01316         <span class="comment">// for present descriptors</span>
01317         <span class="comment">//</span>
01318         <span class="keywordflow">if</span> (Entry0Hi &amp; <a class="code" href="../../d3/d1/i386_2psldt_8c.html#a1">DESCRIPTOR_NP</a>) {
01319 
01320             <span class="comment">// Check descriptor base and limit</span>
01321             <span class="keywordflow">if</span> (((PVOID)Base &gt; MM_HIGHEST_USER_ADDRESS)
01322                 || ((PVOID)Base &gt; (PVOID) (Base + Limit))
01323                 || ((PVOID)(Base + Limit) &gt; MM_HIGHEST_USER_ADDRESS))
01324             {
01325                 <span class="keywordflow">return</span> STATUS_INVALID_LDT_DESCRIPTOR;
01326             }
01327 
01328         }
01329         <span class="comment">//</span>
01330         <span class="comment">// If type and DPL are 0, this is an invalid descriptor, otherwise,</span>
01331         <span class="comment">// we have to check the type (invalid from the standpoint of a</span>
01332         <span class="comment">// descriptor created to generate a GP fault)</span>
01333         <span class="comment">//</span>
01334 
01335         <span class="keywordflow">if</span> (Entry0Hi &amp; <a class="code" href="../../d3/d1/i386_2psldt_8c.html#a5">DESCRIPTOR_TYPEDPL</a>) {
01336 
01337             <span class="comment">// No system descriptors (system descriptors have system bit = 0)</span>
01338             <span class="keywordflow">if</span> (!(Entry0Hi &amp; <a class="code" href="../../d3/d1/i386_2psldt_8c.html#a2">DESCRIPTOR_SYSTEM</a>)) {
01339                 <span class="keywordflow">return</span> STATUS_INVALID_LDT_DESCRIPTOR;
01340             }
01341 
01342             <span class="comment">// No conforming code</span>
01343             <span class="keywordflow">if</span> ((Entry0Hi &amp; <a class="code" href="../../d3/d1/i386_2psldt_8c.html#a3">DESCRIPTOR_CONFORM</a>) == <a class="code" href="../../d3/d1/i386_2psldt_8c.html#a3">DESCRIPTOR_CONFORM</a>) {
01344                 <span class="keywordflow">return</span> STATUS_INVALID_LDT_DESCRIPTOR;
01345             }
01346 
01347             <span class="comment">// Dpl must be 3</span>
01348             <span class="keywordflow">if</span> ((Entry0Hi &amp; <a class="code" href="../../d3/d1/i386_2psldt_8c.html#a4">DESCRIPTOR_DPL</a>) != <a class="code" href="../../d3/d1/i386_2psldt_8c.html#a4">DESCRIPTOR_DPL</a>) {
01349                 <span class="keywordflow">return</span> STATUS_INVALID_LDT_DESCRIPTOR;
01350             }
01351         }
01352     }
01353 
01354     <span class="comment">//</span>
01355     <span class="comment">// Verify descriptor 1</span>
01356     <span class="comment">//</span>
01357 
01358     <span class="keywordflow">if</span> (Selector1) {
01359 
01360         <span class="comment">// Form the base and the limit</span>
01361         Base = ((Entry1Low &amp; 0xFFFF0000) &gt;&gt; 16) + ((Entry1Hi &amp; 0xFF) &lt;&lt; 16)
01362             + (Entry1Hi &amp; 0xFF000000);
01363 
01364         Limit = (Entry1Low &amp; 0xFFFF) + (Entry1Hi &amp; 0xF0000);
01365 
01366         <span class="comment">// N.B.  the interpretation of the limit depends on the G bit</span>
01367         <span class="comment">// in the descriptor</span>
01368 
01369         <span class="keywordflow">if</span> (Entry1Hi &amp; <a class="code" href="../../d3/d1/i386_2psldt_8c.html#a0">DESCRIPTOR_GRAN</a>) {
01370             Limit = (Limit &lt;&lt; 12) | 0xFFF;
01371         }
01372 
01373         <span class="comment">//</span>
01374         <span class="comment">// Base and limit don't matter for NP descriptor, so only check</span>
01375         <span class="comment">// for present descriptors</span>
01376         <span class="comment">//</span>
01377         <span class="keywordflow">if</span> (Entry1Hi &amp; <a class="code" href="../../d3/d1/i386_2psldt_8c.html#a1">DESCRIPTOR_NP</a>) {
01378 
01379             <span class="comment">// Check descriptor base and limit</span>
01380             <span class="keywordflow">if</span> (((PVOID)Base &gt; MM_HIGHEST_USER_ADDRESS)
01381                 || ((PVOID)Base &gt; (PVOID) (Base + Limit))
01382                 || ((PVOID)(Base + Limit) &gt; MM_HIGHEST_USER_ADDRESS))
01383             {
01384                 <span class="keywordflow">return</span> STATUS_INVALID_LDT_DESCRIPTOR;
01385             }
01386         }
01387         <span class="comment">//</span>
01388         <span class="comment">// If type and DPL are 0, this is an invalid descriptor, otherwise,</span>
01389         <span class="comment">// we have to check the type (invalid from the standpoint of a</span>
01390         <span class="comment">// descriptor created to generate a GP fault)</span>
01391         <span class="comment">//</span>
01392 
01393         <span class="keywordflow">if</span> (Entry1Hi &amp; <a class="code" href="../../d3/d1/i386_2psldt_8c.html#a5">DESCRIPTOR_TYPEDPL</a>) {
01394 
01395             <span class="comment">// No system descriptors (system descriptors have system bit = 0)</span>
01396             <span class="keywordflow">if</span> (!(Entry1Hi &amp; <a class="code" href="../../d3/d1/i386_2psldt_8c.html#a2">DESCRIPTOR_SYSTEM</a>)) {
01397                 <span class="keywordflow">return</span> STATUS_INVALID_LDT_DESCRIPTOR;
01398             }
01399 
01400             <span class="comment">// No conforming code</span>
01401             <span class="keywordflow">if</span> ((Entry1Hi &amp; <a class="code" href="../../d3/d1/i386_2psldt_8c.html#a3">DESCRIPTOR_CONFORM</a>) == <a class="code" href="../../d3/d1/i386_2psldt_8c.html#a3">DESCRIPTOR_CONFORM</a>) {
01402                 <span class="keywordflow">return</span> STATUS_INVALID_LDT_DESCRIPTOR;
01403             }
01404 
01405             <span class="comment">// Dpl must be 3</span>
01406             <span class="keywordflow">if</span> ((Entry1Hi &amp; <a class="code" href="../../d3/d1/i386_2psldt_8c.html#a4">DESCRIPTOR_DPL</a>) != <a class="code" href="../../d3/d1/i386_2psldt_8c.html#a4">DESCRIPTOR_DPL</a>) {
01407                 <span class="keywordflow">return</span> STATUS_INVALID_LDT_DESCRIPTOR;
01408             }
01409         }
01410     }
01411 
01412     <span class="comment">//</span>
01413     <span class="comment">// Acquire the LDT mutex.</span>
01414     <span class="comment">//</span>
01415 
01416     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>(
01417                 &amp;LdtMutex,
01418                 Executive,
01419                 KernelMode,
01420                 FALSE,
01421                 NULL
01422                 );
01423     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ) {
01424         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01425     }
01426 
01427     <span class="comment">//</span>
01428     <span class="comment">// Figure out how large the LDT needs to be</span>
01429     <span class="comment">//</span>
01430 
01431     <span class="keywordflow">if</span> (Selector0 &gt; Selector1) {
01432         LdtSize = Selector0 + <span class="keyword">sizeof</span>(LDT_ENTRY);
01433     } <span class="keywordflow">else</span> {
01434         LdtSize = Selector1 + <span class="keyword">sizeof</span>(LDT_ENTRY);
01435     }
01436 
01437     Process = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>();
01438     ProcessLdtInformation = Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o56">LdtInformation</a>;
01439 
01440     <span class="comment">//</span>
01441     <span class="comment">// Most of the time, the process will already have an LDT, and it</span>
01442     <span class="comment">// will be large enough.  for this, we just set the descriptors and</span>
01443     <span class="comment">// return</span>
01444     <span class="comment">//</span>
01445 
01446     <span class="keywordflow">if</span> (ProcessLdtInformation) {
01447 
01448         <span class="comment">//</span>
01449         <span class="comment">// If the LDT descriptor does not have to be modified.</span>
01450         <span class="comment">//</span>
01451         <span class="keywordflow">if</span> (ProcessLdtInformation-&gt;Size &gt;= LdtSize) {
01452             <span class="keywordflow">if</span> (Selector0) {
01453 
01454                 *((PULONG)(&amp;Descriptor)) = Entry0Low;
01455                 *(((PULONG)(&amp;Descriptor)) + 1) = Entry0Hi;
01456 
01457                 <a class="code" href="../../d4/d3/i386_2ldtsup_8c.html#a5">Ke386SetDescriptorProcess</a>(
01458                     &amp;(Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>),
01459                     Selector0,
01460                     Descriptor
01461                     );
01462             }
01463 
01464             <span class="keywordflow">if</span> (Selector1) {
01465 
01466                 *((PULONG)(&amp;Descriptor)) = Entry1Low;
01467                 *(((PULONG)(&amp;Descriptor)) + 1) = Entry1Hi;
01468 
01469                 <a class="code" href="../../d4/d3/i386_2ldtsup_8c.html#a5">Ke386SetDescriptorProcess</a>(
01470                     &amp;(Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>),
01471                     Selector1,
01472                     Descriptor
01473                     );
01474             }
01475 
01476             MutexState = <a class="code" href="../../d3/d5/mutntobj_8c.html#a5">KeReleaseMutex</a>( &amp;LdtMutex, FALSE );
01477             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(( MutexState == 0 ));
01478             <span class="keywordflow">return</span> STATUS_SUCCESS;
01479 
01480         <span class="comment">//</span>
01481         <span class="comment">// Else if the Ldt will fit in the memory currently allocated</span>
01482         <span class="comment">//</span>
01483         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ProcessLdtInformation-&gt;AllocatedSize &gt;= LdtSize) {
01484 
01485             <span class="comment">//</span>
01486             <span class="comment">// First remove the LDT.  This will allow us to edit the memory.</span>
01487             <span class="comment">// We will then put the LDT back.  Since we have to change the</span>
01488             <span class="comment">// limit anyway, it would take two calls to the kernel ldt</span>
01489             <span class="comment">// management minimum to set the descriptors.  Each of those calls</span>
01490             <span class="comment">// would stall all of the processors in an MP system.  If we</span>
01491             <span class="comment">// didn't remove the ldt first, and we were setting two descriptors,</span>
01492             <span class="comment">// we would have to call the LDT management 3 times (once per</span>
01493             <span class="comment">// descriptor, and once to change the limit of the LDT).</span>
01494             <span class="comment">//</span>
01495 
01496             <a class="code" href="../../d4/d3/i386_2ldtsup_8c.html#a4">Ke386SetLdtProcess</a>(
01497                 &amp;(Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>),
01498                 NULL,
01499                 0L
01500                 );
01501 
01502             <span class="comment">//</span>
01503             <span class="comment">// Set the Descriptors in the LDT</span>
01504             <span class="comment">//</span>
01505             <span class="keywordflow">if</span> (Selector0) {
01506                 *((PULONG)(&amp;(ProcessLdtInformation-&gt;Ldt[Selector0/<span class="keyword">sizeof</span>(LDT_ENTRY)]))) = Entry0Low;
01507                 *((PULONG)(&amp;(ProcessLdtInformation-&gt;Ldt[Selector0/<span class="keyword">sizeof</span>(LDT_ENTRY)])) + 1) =
01508                     Entry0Hi;
01509             }
01510 
01511             <span class="keywordflow">if</span> (Selector1) {
01512                 *((PULONG)(&amp;(ProcessLdtInformation-&gt;Ldt[Selector1/<span class="keyword">sizeof</span>(LDT_ENTRY)]))) = Entry1Low;
01513                 *((PULONG)(&amp;(ProcessLdtInformation-&gt;Ldt[Selector1/<span class="keyword">sizeof</span>(LDT_ENTRY)])) + 1) =
01514                     Entry1Hi;
01515             }
01516 
01517             <span class="comment">//</span>
01518             <span class="comment">// Set the LDT for the process</span>
01519             <span class="comment">//</span>
01520 
01521             ProcessLdtInformation-&gt;Size = LdtSize;
01522 
01523             <a class="code" href="../../d4/d3/i386_2ldtsup_8c.html#a4">Ke386SetLdtProcess</a>(
01524                 &amp;(Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>),
01525                 ProcessLdtInformation-&gt;Ldt,
01526                 ProcessLdtInformation-&gt;Size
01527                 );
01528 
01529             MutexState = <a class="code" href="../../d3/d5/mutntobj_8c.html#a5">KeReleaseMutex</a>( &amp;LdtMutex, FALSE );
01530             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(( MutexState == 0 ));
01531             <span class="keywordflow">return</span> STATUS_SUCCESS;
01532         <span class="comment">//</span>
01533         <span class="comment">// Otherwise, we have to grow the LDT allocation</span>
01534         <span class="comment">//</span>
01535         }
01536     }
01537 
01538     <span class="comment">//</span>
01539     <span class="comment">// If the process does not yet have an LDT information structure,</span>
01540     <span class="comment">// allocate and attach one.</span>
01541     <span class="comment">//</span>
01542 
01543     OldLdt = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01544 
01545     <span class="keywordflow">if</span> (!Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o56">LdtInformation</a>) {
01546         ProcessLdtInformation = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(
01547             PagedPool,
01548             <span class="keyword">sizeof</span>(LDTINFORMATION)
01549             );
01550         <span class="keywordflow">if</span> (ProcessLdtInformation == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01551             <span class="keywordflow">goto</span> SetLdtEntriesCleanup;
01552         }
01553         Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o56">LdtInformation</a> = ProcessLdtInformation;
01554         ProcessLdtInformation-&gt;Size = 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
01555         ProcessLdtInformation-&gt;AllocatedSize = 0<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>;
01556         ProcessLdtInformation-&gt;Ldt = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01557     }
01558 
01559     <span class="comment">//</span>
01560     <span class="comment">// Now, we either need to create or grow an LDT, so allocate some</span>
01561     <span class="comment">// memory, and copy as necessary</span>
01562     <span class="comment">//</span>
01563 
01564     AllocatedSize = (LdtSize + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1) &amp; ~(<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1);
01565 
01566     Ldt = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(
01567         PagedPool,
01568         AllocatedSize
01569         );
01570 
01571     <span class="keywordflow">if</span> (Ldt) {
01572         RtlZeroMemory(
01573             Ldt,
01574             AllocatedSize
01575             );
01576     } <span class="keywordflow">else</span> {
01577         <span class="keywordflow">goto</span> SetLdtEntriesCleanup;
01578     }
01579 
01580 
01581     <span class="keywordflow">if</span> (ProcessLdtInformation-&gt;Ldt) {
01582         <span class="comment">//</span>
01583         <span class="comment">// copy the contents of the old ldt</span>
01584         <span class="comment">//</span>
01585         RtlMoveMemory(
01586             Ldt,
01587             ProcessLdtInformation-&gt;Ldt,
01588             ProcessLdtInformation-&gt;Size
01589             );
01590 
01591         <span class="keywordflow">try</span> {
01592             <a class="code" href="../../d0/d2/psquota_8c.html#a2">PsChargePoolQuota</a>(
01593                 Process,
01594                 PagedPool,
01595                 AllocatedSize - ProcessLdtInformation-&gt;AllocatedSize
01596                 );
01597         } except(EXCEPTION_EXECUTE_HANDLER) {
01598             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
01599             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(Ldt);
01600             Ldt = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01601         }
01602 
01603         <span class="keywordflow">if</span> (Ldt == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01604             <span class="keywordflow">goto</span> SetLdtEntriesCleanup;
01605         }
01606 
01607     } <span class="keywordflow">else</span> {
01608         <span class="keywordflow">try</span> {
01609             <a class="code" href="../../d0/d2/psquota_8c.html#a2">PsChargePoolQuota</a>(
01610                 Process,
01611                 PagedPool,
01612                 AllocatedSize
01613                 );
01614         } except(EXCEPTION_EXECUTE_HANDLER) {
01615             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
01616             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(Ldt);
01617             Ldt = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01618         }
01619 
01620         <span class="keywordflow">if</span> (Ldt == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01621             <span class="keywordflow">goto</span> SetLdtEntriesCleanup;
01622         }
01623     }
01624 
01625     OldLdt = ProcessLdtInformation-&gt;Ldt;
01626     ProcessLdtInformation-&gt;Size = LdtSize;
01627     ProcessLdtInformation-&gt;AllocatedSize = AllocatedSize;
01628     ProcessLdtInformation-&gt;Ldt = Ldt;
01629 
01630     <span class="comment">//</span>
01631     <span class="comment">// Set the descriptors in the LDT</span>
01632     <span class="comment">//</span>
01633 
01634     <span class="keywordflow">if</span> (Selector0) {
01635         *((PULONG)(&amp;(ProcessLdtInformation-&gt;Ldt[Selector0/<span class="keyword">sizeof</span>(LDT_ENTRY)]))) = Entry0Low;
01636         *((PULONG)(&amp;(ProcessLdtInformation-&gt;Ldt[Selector0/<span class="keyword">sizeof</span>(LDT_ENTRY)])) + 1) =
01637             Entry0Hi;
01638     }
01639 
01640     <span class="keywordflow">if</span> (Selector1) {
01641         *((PULONG)(&amp;(ProcessLdtInformation-&gt;Ldt[Selector1/<span class="keyword">sizeof</span>(LDT_ENTRY)]))) = Entry1Low;
01642         *((PULONG)(&amp;(ProcessLdtInformation-&gt;Ldt[Selector1/<span class="keyword">sizeof</span>(LDT_ENTRY)])) + 1) =
01643             Entry1Hi;
01644     }
01645 
01646     <span class="comment">//</span>
01647     <span class="comment">// Set the LDT for the process</span>
01648     <span class="comment">//</span>
01649 
01650     <a class="code" href="../../d4/d3/i386_2ldtsup_8c.html#a4">Ke386SetLdtProcess</a>(
01651         &amp;(Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o0">Pcb</a>),
01652         ProcessLdtInformation-&gt;Ldt,
01653         ProcessLdtInformation-&gt;Size
01654         );
01655 
01656     <span class="comment">//</span>
01657     <span class="comment">// Cleanup and exit</span>
01658     <span class="comment">//</span>
01659 
01660     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01661 
01662 SetLdtEntriesCleanup:
01663 
01664     <span class="keywordflow">if</span> (OldLdt) {
01665         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(OldLdt);
01666     }
01667 
01668     MutexState = <a class="code" href="../../d3/d5/mutntobj_8c.html#a5">KeReleaseMutex</a>( &amp;LdtMutex, FALSE );
01669     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(( MutexState == 0 ));
01670     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01671 
01672 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="i386/psldt.c::PspCreateLdt" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> PLDT_ENTRY PspCreateLdt           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PLDT_ENTRY&nbsp;</td>
          <td class="mdname" nowrap> <em>Ldt</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Offset</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Size</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>AllocationSize</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d0/i386_2psldt_8c-source.html#l00902">902</a> of file <a class="el" href="../../d4/d0/i386_2psldt_8c-source.html">i386/psldt.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00033">Offset</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, and <a class="el" href="../../d9/d6/lh__open_2pi__mem_8h-source.html#l00017">Size</a>.
<p>
Referenced by <a class="el" href="../../d4/d0/i386_2psldt_8c-source.html#l00503">PspSetLdtInformation()</a>, and <a class="el" href="../../d4/d0/i386_2psldt_8c-source.html#l00308">PspSetLdtSize()</a>.
<p>
<pre class="fragment"><div>00911                    :
00912 
00913     This routine allocates space in paged <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> <span class="keywordflow">for</span> an LDT, and copies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00914     specified selectors into <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>.  IT DOES NOT VALIDATE THE SELECTORS.
00915     Selector validation must be done before calling <span class="keyword">this</span> routine.  IT
00916     DOES NOT CHARGE THE QUOTA FOR THE LDT.
00917 
00918 Arguments:
00919 
00920     Ldt -- Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> descriptors to be put into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Ldt.
00921     <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> -- Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> offset in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> LDT to copy <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> descriptors to.
00922     <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> -- Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> actualsize of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> Ldt
00923     AllocationSize -- Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size to allocate
00924 
00925 Return Value:
00926 
00927     Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> Ldt
00928 --*/
00929 {
00930     PLDT_ENTRY NewLdt;
00931 
00932     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00933 
00934     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(( AllocationSize &gt;= Size ));
00935     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(( (Size % <span class="keyword">sizeof</span>(LDT_ENTRY)) == 0 ));
00936 
00937     NewLdt = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>( PagedPool, AllocationSize );
00938     <span class="keywordflow">if</span> (NewLdt == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00939         <span class="keywordflow">return</span> NewLdt;
00940     }
00941 
00942 
00943     RtlZeroMemory( NewLdt, AllocationSize );
00944     RtlMoveMemory( (PCHAR)NewLdt + Offset, Ldt, Size - Offset );
00945 
00946     <span class="keywordflow">return</span> NewLdt;
00947 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a14" doxytag="i386/psldt.c::PspDeleteLdt" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID PspDeleteLdt           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Process</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d0/i386_2psldt_8c-source.html#l01202">1202</a> of file <a class="el" href="../../d4/d0/i386_2psldt_8c-source.html">i386/psldt.c</a>.
<p>
References <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
<pre class="fragment"><div>01207                    :
01208 
01209     This routine frees <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> paged <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> associated with a process' Ldt, <span class="keywordflow">if</span>
01210     <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> has one.
01211 
01212 Arguments:
01213 
01214     Process -- Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process
01215 
01216 Return Value:
01217 
01218     None
01219 --*/
01220 {
01221     PLDTINFORMATION LdtInformation;
01222 
01223     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01224 
01225     LdtInformation = Process-&gt;LdtInformation;
01226     <span class="keywordflow">if</span> ( LdtInformation != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
01227         <span class="keywordflow">if</span> ( LdtInformation-&gt;Ldt != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
01228             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( LdtInformation-&gt;Ldt );
01229         }
01230         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( LdtInformation );
01231     }
01232 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="i386/psldt.c::PspIsDescriptorValid" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN PspIsDescriptorValid           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PLDT_ENTRY&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Descriptor</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d0/i386_2psldt_8c-source.html#l00952">952</a> of file <a class="el" href="../../d4/d0/i386_2psldt_8c-source.html">i386/psldt.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d4/d0/i386_2psldt_8c-source.html#l00503">PspSetLdtInformation()</a>.
<p>
<pre class="fragment"><div>00958                    :
00959 
00960     This function determines <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> supplied descriptor <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> valid to put
00961     into a process Ldt.  For <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> descriptor to be valid <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> must have <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00962     following characteristics:
00963 
00964     Base &lt; MM_HIGHEST_USER_ADDRESS
00965     Base + Limit &lt; MM_HIGHEST_USER_ADDRESS
00966     Type must be
00967         ReadWrite, ReadOnly, ExecuteRead, ExecuteOnly, or Invalid
00968         big or small
00969         normal or grow down
00970         Not a system descriptor (system bit is 1 == application)
00971             This rules <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a> all gates, etc
00972         Not conforming
00973     DPL must be 3
00974 
00975 Arguments:
00976 
00977     Descriptor -- Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> descriptor to check
00978 
00979 Return Value:
00980 
00981     True <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> descriptor <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> valid (note: valid to put into an LDT.  This
00982         includes Invalid descriptors)
00983     False <span class="keywordflow">if</span> not
00984 --*/
00985 
00986 {
00987     ULONG Base;
00988     ULONG Limit;
00989 
00990     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00991 
00992     <span class="comment">//</span>
00993     <span class="comment">// if descriptor is an invalid descriptor</span>
00994     <span class="comment">//</span>
00995 
00996     <span class="keywordflow">if</span> ( (Descriptor-&gt;HighWord.Bits.Type == 0) &amp;&amp;
00997         (Descriptor-&gt;HighWord.Bits.Dpl == 0) ) {
00998 
00999         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01000     }
01001 
01002     Base = Descriptor-&gt;BaseLow | (Descriptor-&gt;HighWord.Bytes.BaseMid &lt;&lt; 16) |
01003         (Descriptor-&gt;HighWord.Bytes.BaseHi &lt;&lt; 24);
01004 
01005     Limit = Descriptor-&gt;LimitLow | (Descriptor-&gt;HighWord.Bits.LimitHi &lt;&lt; 16);
01006 
01007     <span class="comment">//</span>
01008     <span class="comment">// Only have to check for present selectors</span>
01009     <span class="comment">//</span>
01010     <span class="keywordflow">if</span> (Descriptor-&gt;HighWord.Bits.Pres) {
01011         ULONG ActualLimit;
01012 
01013         <span class="keywordflow">if</span> ( (PVOID)Base &gt; MM_HIGHEST_USER_ADDRESS ) {
01014             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01015         }
01016 
01017         ActualLimit = (Limit &lt;&lt; (Descriptor-&gt;HighWord.Bits.Granularity *
01018             12)) + 0xFFF * Descriptor-&gt;HighWord.Bits.Granularity;
01019 
01020         <span class="keywordflow">if</span> ( (Base &gt; (Base + ActualLimit))
01021              || ((PVOID)(Base + ActualLimit) &gt; MM_HIGHEST_USER_ADDRESS)
01022         ) {
01023 
01024             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01025         }
01026 
01027     }
01028 
01029     <span class="comment">//</span>
01030     <span class="comment">// if descriptor is a system descriptor (which includes gates)</span>
01031     <span class="comment">// if bit 4 of the Type field is 0, then it's a system descriptor,</span>
01032     <span class="comment">// and we don't like it.</span>
01033     <span class="comment">//</span>
01034 
01035     <span class="keywordflow">if</span> (  ! (Descriptor-&gt;HighWord.Bits.Type &amp; 0x10)) {
01036         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01037     }
01038 
01039     <span class="comment">//</span>
01040     <span class="comment">// if descriptor is conforming code</span>
01041     <span class="comment">//</span>
01042 
01043     <span class="keywordflow">if</span> ( ((Descriptor-&gt;HighWord.Bits.Type &amp; 0x18) == 0x18) &amp;&amp;
01044         (Descriptor-&gt;HighWord.Bits.Type &amp; 0x4)) {
01045 
01046         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01047     }
01048 
01049     <span class="comment">//</span>
01050     <span class="comment">// if Dpl is not 3</span>
01051     <span class="comment">//</span>
01052 
01053     <span class="keywordflow">if</span> ( Descriptor-&gt;HighWord.Bits.Dpl != 3 ) {
01054         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01055     }
01056 
01057     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01058 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="i386/psldt.c::PspLdtInitialize" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS PspLdtInitialize           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d0/i386_2psldt_8c-source.html#l00084">84</a> of file <a class="el" href="../../d4/d0/i386_2psldt_8c-source.html">i386/psldt.c</a>.
<p>
References <a class="el" href="../../d4/d4/mutntobj_8c-source.html#l00099">KeInitializeMutex()</a>, <a class="el" href="../../d4/d0/i386_2psldt_8c-source.html#l00051">LdtMutex</a>, and <a class="el" href="../../d4/d9/exlevels_8h-source.html#l00041">MUTEX_LEVEL_PS_LDT</a>.
<p>
Referenced by <a class="el" href="../../d1/d0/psinit_8c-source.html#l00181">PspInitPhase0()</a>.
<p>
<pre class="fragment"><div>00089                    :
00090 
00091     This routine initializes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Ldt support <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> x86
00092 
00093 Arguments:
00094 
00095     None
00096 
00097 Return Value:
00098 
00099     TBS
00100 --*/
00101 {
00102     <a class="code" href="../../d3/d5/mutntobj_8c.html#a2">KeInitializeMutex</a>( &amp;LdtMutex, MUTEX_LEVEL_PS_LDT );
00103     <span class="keywordflow">return</span> STATUS_SUCCESS;
00104 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a13" doxytag="i386/psldt.c::PspQueryDescriptorThread" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS PspQueryDescriptorThread           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Thread</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>ThreadInformation</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ThreadInformationLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ReturnLength</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d0/i386_2psldt_8c-source.html#l01061">1061</a> of file <a class="el" href="../../d4/d0/i386_2psldt_8c-source.html">i386/psldt.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d8/i386_2gdtsup_8c-source.html#l00033">Ke386GetGdtEntryThread()</a>, <a class="el" href="../../d4/d4/mutntobj_8c-source.html#l00310">KeReleaseMutex()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00256">_EPROCESS::LdtInformation</a>, <a class="el" href="../../d4/d0/i386_2psldt_8c-source.html#l00051">LdtMutex</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00347">_ETHREAD::Tcb</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00638">THREAD_TO_PROCESS</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
<pre class="fragment"><div>01069                    :
01070 
01071     This function retrieves a descriptor table entry <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified thread.
01072     This entry may be in either <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Gdt or <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Ldt, as specfied by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01073     supplied selector
01074 
01075 Arguments:
01076 
01077     Thread -- Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread.
01078     ThreadInformation -- Supplies information on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> descriptor.
01079     ThreadInformationLength -- Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> information.
01080     ReturnLength -- Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of bytes returned.
01081 
01082 Return Value:
01083 
01084     TBS
01085 --*/
01086 {
01087     DESCRIPTOR_TABLE_ENTRY DescriptorEntry;
01088     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
01089     BOOLEAN ReturnNow = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01090     LONG MutexState;
01091     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01092 
01093     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01094 
01095     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <span class="keyword">sizeof</span>(KGDTENTRY) == <span class="keyword">sizeof</span>(LDT_ENTRY) );
01096 
01097     <span class="comment">//</span>
01098     <span class="comment">// Verify parameters</span>
01099     <span class="comment">//</span>
01100 
01101     <span class="keywordflow">if</span> ( ThreadInformationLength != <span class="keyword">sizeof</span>(DESCRIPTOR_TABLE_ENTRY) ) {
01102         <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
01103     }
01104 
01105     <span class="keywordflow">try</span> {
01106         DescriptorEntry = *(PDESCRIPTOR_TABLE_ENTRY)ThreadInformation;
01107     } except(EXCEPTION_EXECUTE_HANDLER){
01108         ReturnNow = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01109     }
01110 
01111     <span class="keywordflow">if</span> (ReturnNow) {
01112         <span class="keywordflow">return</span> STATUS_SUCCESS;
01113     }
01114 
01115     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
01116 
01117     <span class="comment">//</span>
01118     <span class="comment">// If its a Gdt entry, let the kernel find it for us</span>
01119     <span class="comment">//</span>
01120 
01121     <span class="keywordflow">if</span> ( !(DescriptorEntry.Selector &amp; SELECTOR_TABLE_INDEX) ) {
01122 
01123         <span class="keywordflow">if</span> ( (DescriptorEntry.Selector &amp; 0xFFFFFFF8) &gt;= KGDT_NUMBER *
01124             <span class="keyword">sizeof</span>(KGDTENTRY) ) {
01125 
01126             <span class="keywordflow">return</span> STATUS_ACCESS_VIOLATION;
01127         }
01128 
01129         <span class="keywordflow">try</span> {
01130             <a class="code" href="../../d9/d8/i386_2gdtsup_8c.html#a0">Ke386GetGdtEntryThread</a>( &amp;(Thread-&gt;<a class="code" href="../../d5/d6/struct__ETHREAD.html#o0">Tcb</a>),
01131                 DescriptorEntry.Selector &amp; 0xFFFFFFF8,
01132                 (PKGDTENTRY)
01133                     &amp;(((PDESCRIPTOR_TABLE_ENTRY)ThreadInformation)-&gt;Descriptor)
01134                 );
01135             <span class="keywordflow">if</span> ( ARGUMENT_PRESENT(ReturnLength) ) {
01136                 *ReturnLength = <span class="keyword">sizeof</span>(LDT_ENTRY);
01137             }
01138         } except(EXCEPTION_EXECUTE_HANDLER) {
01139             <span class="comment">// We want to return STATUS_SUCCESS (see module notes), so</span>
01140             <span class="comment">// do nothing and fall out of if.</span>
01141         }
01142     } <span class="keywordflow">else</span> {
01143 
01144         <span class="comment">//</span>
01145         <span class="comment">// it's an Ldt entry, so copy it from the ldt</span>
01146         <span class="comment">//</span>
01147 
01148         Process = <a class="code" href="../../d1/d9/ps_8h.html#a17">THREAD_TO_PROCESS</a>(Thread);
01149 
01150         <span class="comment">//</span>
01151         <span class="comment">// Acquire the Ldt Mutex</span>
01152         <span class="comment">//</span>
01153 
01154         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>(
01155                     &amp;LdtMutex,
01156                     Executive,
01157                     KernelMode,
01158                     FALSE,
01159                     NULL
01160                     );
01161         <span class="keywordflow">if</span> ( !(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) ) {
01162             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01163         }
01164 
01165         <span class="keywordflow">if</span> ( Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o56">LdtInformation</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
01166 
01167             <span class="comment">// If there is no Ldt</span>
01168             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_NO_LDT;
01169 
01170         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( (DescriptorEntry.Selector &amp; 0xFFFFFFF8) &gt;=
01171             ((PLDTINFORMATION)(Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o56">LdtInformation</a>))-&gt;Size ) {
01172 
01173             <span class="comment">// Else If the selector is outside the table</span>
01174             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_ACCESS_VIOLATION;
01175 
01176         } <span class="keywordflow">else</span> <span class="keywordflow">try</span> {
01177 
01178             <span class="comment">// Else return the contents of the descriptor</span>
01179             RtlMoveMemory(
01180                 &amp;(((PDESCRIPTOR_TABLE_ENTRY)ThreadInformation)-&gt;Descriptor),
01181                 (PCHAR)(((PLDTINFORMATION)(Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o56">LdtInformation</a>))-&gt;Ldt) +
01182                     (DescriptorEntry.Selector &amp; 0xFFFFFFF8),
01183                 <span class="keyword">sizeof</span>(LDT_ENTRY)
01184                 );
01185             <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ReturnLength)) {
01186                 *ReturnLength = <span class="keyword">sizeof</span>(LDT_ENTRY);
01187             }
01188 
01189         } except(EXCEPTION_EXECUTE_HANDLER) {
01190             <span class="comment">// We want to return STATUS_SUCCESS (see module notes), so</span>
01191             <span class="comment">// do nothing and fall out of if.</span>
01192         }
01193 
01194         MutexState = <a class="code" href="../../d3/d5/mutntobj_8c.html#a5">KeReleaseMutex</a>( &amp;LdtMutex, FALSE );
01195         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(( MutexState == 0 ));
01196     }
01197 
01198     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01199 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a10" doxytag="i386/psldt.c::PspQueryLdtInformation" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS PspQueryLdtInformation           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Process</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PPROCESS_LDT_INFORMATION&nbsp;</td>
          <td class="mdname" nowrap> <em>LdtInformation</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>LdtInformationLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ReturnLength</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d0/i386_2psldt_8c-source.html#l00108">108</a> of file <a class="el" href="../../d4/d0/i386_2psldt_8c-source.html">i386/psldt.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d4/d4/mutntobj_8c-source.html#l00310">KeReleaseMutex()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d4/d0/i386_2psldt_8c-source.html#l00051">LdtMutex</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d0/d1/config_2i386_2init386_8c-source.html#l00049">Start</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
<pre class="fragment"><div>00116                    :
00117 
00118     This function performs <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> work <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Ldt portion of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> query
00119     process information function.  It copies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> contents of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Ldt
00120     <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified process into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> users buffer, up to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length
00121     of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer.
00122 
00123 Arguments:
00124 
00125     Process -- Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process to <span class="keywordflow">return</span> LDT info <span class="keywordflow">for</span>
00126     LdtInformation -- Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer
00127     ReturnLength -- Returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of bytes put into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer
00128 
00129 Return Value:
00130 
00131     TBS
00132 --*/
00133 {
00134     ULONG CopyLength, CopyEnd;
00135     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00136     ULONG HeaderLength;
00137     ULONG Length, <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>;
00138     LONG MutexStatus;
00139     PLDTINFORMATION ProcessLdtInfo;
00140     BOOLEAN ReturnNow = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00141 
00142     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00143 
00144     <span class="comment">//</span>
00145     <span class="comment">// Verify the parameters</span>
00146     <span class="comment">//</span>
00147 
00148     <span class="keywordflow">if</span> ( LdtInformationLength &lt; (ULONG)<span class="keyword">sizeof</span>(PROCESS_LDT_INFORMATION) ) {
00149         <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
00150     }
00151 
00152     <span class="comment">//</span>
00153     <span class="comment">// This portion of the parameters may be in user space</span>
00154     <span class="comment">//</span>
00155     <span class="keywordflow">try</span> {
00156         <span class="comment">//</span>
00157         <span class="comment">// Capture parameters</span>
00158         <span class="comment">//</span>
00159         Length = LdtInformation-&gt;Length;
00160         <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a> = LdtInformation-&gt;Start;
00161 
00162     } except(EXCEPTION_EXECUTE_HANDLER) {
00163         ReturnNow = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00164     }
00165 
00166     <span class="keywordflow">if</span> (ReturnNow) {
00167         <span class="keywordflow">return</span> STATUS_SUCCESS;
00168     }
00169 
00170     <span class="comment">//</span>
00171     <span class="comment">// The buffer containing the Ldt entries must be in the information</span>
00172     <span class="comment">// structure.  We subtract one Ldt entry, because the structure is</span>
00173     <span class="comment">// declared to contain one.</span>
00174     <span class="comment">//</span>
00175     <span class="keywordflow">if</span> (LdtInformationLength - <span class="keyword">sizeof</span>(PROCESS_LDT_INFORMATION) + <span class="keyword">sizeof</span>(LDT_ENTRY) &lt; Length) {
00176 
00177         <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
00178     }
00179 
00180     <span class="comment">// An Ldt entry is a processor structure, and must be 8 bytes long</span>
00181     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((<span class="keyword">sizeof</span>(LDT_ENTRY) == 8));
00182 
00183     <span class="comment">//</span>
00184     <span class="comment">// The length of the structure must be an even number of Ldt entries</span>
00185     <span class="comment">//</span>
00186     <span class="keywordflow">if</span> (Length % <span class="keyword">sizeof</span>(LDT_ENTRY)) {
00187         <span class="keywordflow">return</span> STATUS_INVALID_LDT_SIZE;
00188     }
00189 
00190     <span class="comment">//</span>
00191     <span class="comment">// The information to get from the Ldt must start on an Ldt entry</span>
00192     <span class="comment">// boundary.</span>
00193     <span class="comment">//</span>
00194     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a> % <span class="keyword">sizeof</span>(LDT_ENTRY)) {
00195         <span class="keywordflow">return</span> STATUS_INVALID_LDT_OFFSET;
00196     }
00197 
00198     <span class="comment">//</span>
00199     <span class="comment">// Acquire the Ldt mutex</span>
00200     <span class="comment">//</span>
00201 
00202     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>(
00203                 &amp;LdtMutex,
00204                 Executive,
00205                 KernelMode,
00206                 FALSE,
00207                 NULL
00208                 );
00209     <span class="keywordflow">if</span> ( !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) ) {
00210         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00211     }
00212 
00213     ProcessLdtInfo = Process-&gt;LdtInformation;
00214 
00215     <span class="comment">//</span>
00216     <span class="comment">// If the process has an Ldt</span>
00217     <span class="comment">//</span>
00218     <span class="keywordflow">if</span> (( ProcessLdtInfo) &amp;&amp; (ProcessLdtInfo-&gt;Size )) {
00219 
00220         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((ProcessLdtInfo-&gt;Ldt));
00221 
00222         <span class="comment">//</span>
00223         <span class="comment">// Set the end of the copy to be the smaller of:</span>
00224         <span class="comment">//  the end of the information the user requested or</span>
00225         <span class="comment">//  the end of the information that is actually there</span>
00226         <span class="comment">//</span>
00227 
00228         <span class="keywordflow">if</span> (ProcessLdtInfo-&gt;Size &lt; <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>) {
00229            CopyEnd = <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>;
00230         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ProcessLdtInfo-&gt;Size - <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>  &gt; Length) {
00231             CopyEnd = Length + <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>;
00232         } <span class="keywordflow">else</span> {
00233             CopyEnd = ProcessLdtInfo-&gt;Size;
00234         }
00235 
00236         CopyLength = CopyEnd - <a class="code" href="../../d9/d1/config_2i386_2init386_8c.html#a18">Start</a>;
00237 
00238         <span class="keywordflow">try</span> {
00239 
00240             <span class="comment">//</span>
00241             <span class="comment">// Set the length field to the actual length of the Ldt</span>
00242             <span class="comment">//</span>
00243             LdtInformation-&gt;Length = ProcessLdtInfo-&gt;Size;
00244 
00245             <span class="comment">//</span>
00246             <span class="comment">// Copy the contents of the Ldt into the user's buffer</span>
00247             <span class="comment">//</span>
00248 
00249             <span class="keywordflow">if</span> (CopyLength) {
00250                 RtlMoveMemory(
00251                     &amp;(LdtInformation-&gt;LdtEntries),
00252                     (PCHAR)ProcessLdtInfo-&gt;Ldt + Start,
00253                     CopyLength
00254                     );
00255             }
00256 
00257         } except(EXCEPTION_EXECUTE_HANDLER) {
00258             ReturnNow = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00259             MutexStatus = <a class="code" href="../../d3/d5/mutntobj_8c.html#a5">KeReleaseMutex</a>( &amp;LdtMutex, FALSE );
00260             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(( MutexStatus == 0 ));
00261         }
00262 
00263 
00264         <span class="keywordflow">if</span> (ReturnNow) {
00265             <span class="keywordflow">return</span> STATUS_SUCCESS;
00266         }
00267 
00268     } <span class="keywordflow">else</span> {
00269 
00270         <span class="comment">//</span>
00271         <span class="comment">// There is no Ldt</span>
00272         <span class="comment">//</span>
00273 
00274         CopyLength = 0;
00275         <span class="keywordflow">try</span> {
00276             LdtInformation-&gt;Length = 0;
00277         } except(EXCEPTION_EXECUTE_HANDLER) {
00278             ReturnNow = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00279             MutexStatus = <a class="code" href="../../d3/d5/mutntobj_8c.html#a5">KeReleaseMutex</a>( &amp;LdtMutex, FALSE );
00280             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(( MutexStatus == 0 ));
00281         }
00282 
00283         <span class="keywordflow">if</span> (ReturnNow) {
00284             <span class="keywordflow">return</span> STATUS_SUCCESS;
00285         }
00286     }
00287 
00288     <span class="comment">//</span>
00289     <span class="comment">// Set the length of the information returned</span>
00290     <span class="comment">//</span>
00291     <span class="keywordflow">if</span> ( ARGUMENT_PRESENT(ReturnLength) ) {
00292         <span class="keywordflow">try</span> {
00293             HeaderLength = (PCHAR)(&amp;(LdtInformation-&gt;LdtEntries)) -
00294                 (PCHAR)(&amp;(LdtInformation-&gt;Start));
00295             *ReturnLength = CopyLength + HeaderLength;
00296         } except(EXCEPTION_EXECUTE_HANDLER){
00297             <span class="comment">// We don't do anything here because we want to return success</span>
00298         }
00299     }
00300 
00301     MutexStatus = <a class="code" href="../../d3/d5/mutntobj_8c.html#a5">KeReleaseMutex</a>( &amp;LdtMutex, FALSE );
00302     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(( MutexStatus == 0 ));
00303     <span class="keywordflow">return</span> STATUS_SUCCESS;
00304 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a12" doxytag="i386/psldt.c::PspSetLdtInformation" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS PspSetLdtInformation           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Process</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PPROCESS_LDT_INFORMATION&nbsp;</td>
          <td class="mdname" nowrap> <em>LdtInformation</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>LdtInformationLength</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d0/i386_2psldt_8c-source.html#l00503">503</a> of file <a class="el" href="../../d4/d0/i386_2psldt_8c-source.html">i386/psldt.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00126">ExAllocatePool</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d2/i386_2ldtsup_8c-source.html#l00255">Ke386SetDescriptorProcess()</a>, <a class="el" href="../../d5/d2/i386_2ldtsup_8c-source.html#l00063">Ke386SetLdtProcess()</a>, <a class="el" href="../../d4/d4/mutntobj_8c-source.html#l00310">KeReleaseMutex()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d4/d0/i386_2psldt_8c-source.html#l00051">LdtMutex</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d1/d1/psquota_8c-source.html#l00246">PsChargePoolQuota()</a>, <a class="el" href="../../d4/d0/i386_2psldt_8c-source.html#l00902">PspCreateLdt()</a>, <a class="el" href="../../d4/d0/i386_2psldt_8c-source.html#l00952">PspIsDescriptorValid()</a>, <a class="el" href="../../d1/d1/psquota_8c-source.html#l00356">PsReturnPoolQuota()</a>, <a class="el" href="../../d9/d6/lh__open_2pi__mem_8h-source.html#l00017">Size</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
<pre class="fragment"><div>00511                    :
00512 
00513     This function alters <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ldt <span class="keywordflow">for</span> a specified process.  It can alter
00514     portions of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> LDT, or <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> whole LDT.  If an Ldt <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> created or
00515     grown, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified process will be charged <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> quota <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> LDT.
00516     Each descriptor that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> set will be verified.
00517 
00518 Arguments:
00519 
00520     Process -- Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process whose Ldt <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be modified
00521     LdtInformation -- Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> information about <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Ldt
00522         modifications
00523     LdtInformationLength -- Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> LdtInformation
00524         structure.
00525 Return Value:
00526 
00527     TBS
00528 --*/
00529 {
00530     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00531     PLDT_ENTRY OldLdt = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00532     ULONG OldSize = 0;
00533     ULONG AllocatedSize;
00534     ULONG <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
00535     ULONG MutexState;
00536     ULONG LdtOffset;
00537     PLDT_ENTRY CurrentDescriptor;
00538     PPROCESS_LDT_INFORMATION LdtInfo;
00539     PLDTINFORMATION ProcessLdtInfo;
00540     PLDT_ENTRY Ldt;
00541 
00542     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00543 
00544     <span class="keywordflow">if</span> ( LdtInformationLength &lt; (ULONG)<span class="keyword">sizeof</span>( PROCESS_LDT_INFORMATION)) {
00545         <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
00546     }
00547 
00548     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00549     <span class="comment">//</span>
00550     <span class="comment">// alocate a local buffer to capture the ldt information to</span>
00551     <span class="comment">//</span>
00552     <span class="keywordflow">try</span> {
00553         LdtInfo = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(
00554             PagedPool,
00555             LdtInformationLength
00556             );
00557         <span class="keywordflow">if</span> (LdtInfo) {
00558             <span class="comment">//</span>
00559             <span class="comment">// Copy the information the user is supplying</span>
00560             <span class="comment">//</span>
00561             RtlMoveMemory(
00562                 LdtInfo,
00563                 LdtInformation,
00564                 LdtInformationLength
00565                 );
00566         }
00567     } except(EXCEPTION_EXECUTE_HANDLER) {
00568         <span class="keywordflow">if</span> (LdtInfo) {
00569             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(LdtInfo);
00570         }
00571         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00572     }
00573 
00574     <span class="comment">//</span>
00575     <span class="comment">// If the capture didn't succeed</span>
00576     <span class="comment">//</span>
00577     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00578         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_ACCESS_VIOLATION) {
00579             <span class="keywordflow">return</span> STATUS_SUCCESS;
00580         } <span class="keywordflow">else</span> {
00581             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00582         }
00583     }
00584 
00585     <span class="keywordflow">if</span> (LdtInfo == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00586         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00587     }
00588 
00589     <span class="comment">//</span>
00590     <span class="comment">// Verify that the Start and Length are plausible</span>
00591     <span class="comment">//</span>
00592     <span class="keywordflow">if</span> (LdtInfo-&gt;Start &amp; 0xFFFF0000) {
00593         <span class="keywordflow">return</span> STATUS_INVALID_LDT_OFFSET;
00594     }
00595 
00596     <span class="keywordflow">if</span> (LdtInfo-&gt;Length &amp; 0xFFFF0000) {
00597         <span class="keywordflow">return</span> STATUS_INVALID_LDT_SIZE;
00598     }
00599 
00600     <span class="comment">//</span>
00601     <span class="comment">// Insure that the buffer it large enough to contain the specified number</span>
00602     <span class="comment">// of selectors.</span>
00603     <span class="comment">//</span>
00604     <span class="keywordflow">if</span> (LdtInformationLength - <span class="keyword">sizeof</span>(PROCESS_LDT_INFORMATION) + <span class="keyword">sizeof</span>(LDT_ENTRY) &lt; LdtInfo-&gt;Length) {
00605         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(LdtInfo);
00606         <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
00607     }
00608 
00609     <span class="comment">//</span>
00610     <span class="comment">// The info to set must be an integral number of selectors</span>
00611     <span class="comment">//</span>
00612     <span class="keywordflow">if</span> (LdtInfo-&gt;Length % <span class="keyword">sizeof</span>(LDT_ENTRY)) {
00613         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(LdtInfo);
00614         <span class="keywordflow">return</span> STATUS_INVALID_LDT_SIZE;
00615     }
00616 
00617     <span class="comment">//</span>
00618     <span class="comment">// The beginning of the info must be on a selector boundary</span>
00619     <span class="comment">//</span>
00620     <span class="keywordflow">if</span> (LdtInfo-&gt;Start % <span class="keyword">sizeof</span>(LDT_ENTRY)) {
00621         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(LdtInfo);
00622         <span class="keywordflow">return</span> STATUS_INVALID_LDT_OFFSET;
00623     }
00624 
00625     <span class="comment">//</span>
00626     <span class="comment">// Verify all of the descriptors.</span>
00627     <span class="comment">//</span>
00628 
00629     <span class="keywordflow">for</span> (CurrentDescriptor = LdtInfo-&gt;LdtEntries;
00630 
00631         (PCHAR)CurrentDescriptor &lt; (PCHAR)LdtInfo-&gt;LdtEntries +
00632         LdtInfo-&gt;Length;
00633 
00634         CurrentDescriptor++
00635     ) {
00636         <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d1/i386_2psldt_8c.html#a8">PspIsDescriptorValid</a>( CurrentDescriptor )) {
00637             <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(LdtInfo);
00638             <span class="keywordflow">return</span> STATUS_INVALID_LDT_DESCRIPTOR;
00639         }
00640     }
00641 
00642     <span class="comment">//</span>
00643     <span class="comment">// Acquire the Ldt Mutex</span>
00644     <span class="comment">//</span>
00645 
00646     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>(
00647                 &amp;LdtMutex,
00648                 Executive,
00649                 KernelMode,
00650                 FALSE,
00651                 NULL
00652                 );
00653     <span class="keywordflow">if</span> ( !(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) ) {
00654         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00655     }
00656 
00657     ProcessLdtInfo = Process-&gt;LdtInformation;
00658 
00659     <span class="comment">//</span>
00660     <span class="comment">// If the process doen't have an Ldt information structure, allocate</span>
00661     <span class="comment">//  one and attach it to the process</span>
00662     <span class="comment">//</span>
00663     <span class="keywordflow">if</span> ( ProcessLdtInfo == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00664         ProcessLdtInfo = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(
00665                             PagedPool,
00666                             <span class="keyword">sizeof</span>(LDTINFORMATION)
00667                             );
00668         <span class="keywordflow">if</span> ( ProcessLdtInfo == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00669             <span class="keywordflow">goto</span> SetInfoCleanup;
00670         }
00671         Process-&gt;LdtInformation = ProcessLdtInfo;
00672         RtlZeroMemory( ProcessLdtInfo, <span class="keyword">sizeof</span>(LDTINFORMATION) );
00673     }
00674 
00675     <span class="comment">//</span>
00676     <span class="comment">// If we are supposed to remove the LDT</span>
00677     <span class="comment">//</span>
00678     <span class="keywordflow">if</span> ( LdtInfo-&gt;Length == 0 )  {
00679 
00680         <span class="comment">//</span>
00681         <span class="comment">// Remove the process' Ldt</span>
00682         <span class="comment">//</span>
00683 
00684         <span class="keywordflow">if</span> ( ProcessLdtInfo-&gt;Ldt ) {
00685             OldSize = ProcessLdtInfo-&gt;AllocatedSize;
00686             OldLdt = ProcessLdtInfo-&gt;Ldt;
00687 
00688             ProcessLdtInfo-&gt;AllocatedSize = 0;
00689             ProcessLdtInfo-&gt;Size = 0;
00690             ProcessLdtInfo-&gt;Ldt = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00691 
00692             <a class="code" href="../../d4/d3/i386_2ldtsup_8c.html#a4">Ke386SetLdtProcess</a>(
00693                 &amp;(Process-&gt;Pcb),
00694                 NULL,
00695                 0
00696                 );
00697 
00698             <a class="code" href="../../d0/d2/psquota_8c.html#a3">PsReturnPoolQuota</a>( Process, PagedPool, OldSize );
00699         }
00700 
00701 
00702     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( ProcessLdtInfo-&gt;Ldt == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00703 
00704         <span class="comment">//</span>
00705         <span class="comment">// Create a new Ldt for the process</span>
00706         <span class="comment">//</span>
00707 
00708         <span class="comment">//</span>
00709         <span class="comment">// Allocate an integral number of pages for the LDT.</span>
00710         <span class="comment">//</span>
00711 
00712         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(((PAGE_SIZE % 2) == 0));
00713 
00714         AllocatedSize = (LdtInfo-&gt;Start + LdtInfo-&gt;Length + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1) &amp;
00715             ~(<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1);
00716 
00717         <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = LdtInfo-&gt;Start + LdtInfo-&gt;Length;
00718 
00719         Ldt = <a class="code" href="../../d3/d1/i386_2psldt_8c.html#a7">PspCreateLdt</a>(
00720             LdtInfo-&gt;LdtEntries,
00721             LdtInfo-&gt;Start,
00722             Size,
00723             AllocatedSize
00724             );
00725 
00726         <span class="keywordflow">if</span> ( Ldt == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00727             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
00728             <span class="keywordflow">goto</span> SetInfoCleanup;
00729         }
00730 
00731         <span class="keywordflow">try</span> {
00732             <a class="code" href="../../d0/d2/psquota_8c.html#a2">PsChargePoolQuota</a>(
00733                 Process,
00734                 PagedPool,
00735                 AllocatedSize
00736                 );
00737         } except(EXCEPTION_EXECUTE_HANDLER) {
00738             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00739         }
00740 
00741         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00742             <span class="keywordflow">goto</span> SetInfoCleanup;
00743         }
00744 
00745         ProcessLdtInfo-&gt;Ldt = Ldt;
00746         ProcessLdtInfo-&gt;Size = <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
00747         ProcessLdtInfo-&gt;AllocatedSize = AllocatedSize;
00748         <a class="code" href="../../d4/d3/i386_2ldtsup_8c.html#a4">Ke386SetLdtProcess</a>(
00749             &amp;(Process-&gt;Pcb),
00750             ProcessLdtInfo-&gt;Ldt,
00751             ProcessLdtInfo-&gt;Size
00752             );
00753 
00754 
00755     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( (LdtInfo-&gt;Length + LdtInfo-&gt;Start) &gt; ProcessLdtInfo-&gt;Size ) {
00756 
00757         <span class="comment">//</span>
00758         <span class="comment">// Grow the process' Ldt</span>
00759         <span class="comment">//</span>
00760 
00761         <span class="keywordflow">if</span> ( (LdtInfo-&gt;Length + LdtInfo-&gt;Start) &gt;
00762             ProcessLdtInfo-&gt;AllocatedSize
00763         ) {
00764 
00765             <span class="comment">//</span>
00766             <span class="comment">// Current Ldt allocation is not large enough, so create a</span>
00767             <span class="comment">// new larger Ldt</span>
00768             <span class="comment">//</span>
00769 
00770             OldSize = ProcessLdtInfo-&gt;AllocatedSize;
00771 
00772             <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = LdtInfo-&gt;Start + LdtInfo-&gt;Length;
00773             AllocatedSize = (<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1) &amp; ~(<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1);
00774 
00775             Ldt = <a class="code" href="../../d3/d1/i386_2psldt_8c.html#a7">PspCreateLdt</a>(
00776                 ProcessLdtInfo-&gt;Ldt,
00777                 0,
00778                 OldSize,
00779                 AllocatedSize
00780                 );
00781 
00782             <span class="keywordflow">if</span> ( Ldt == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00783                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
00784                 <span class="keywordflow">goto</span> SetInfoCleanup;
00785             }
00786 
00787             <span class="keywordflow">try</span> {
00788 
00789                 <a class="code" href="../../d0/d2/psquota_8c.html#a2">PsChargePoolQuota</a>(
00790                     Process,
00791                     PagedPool,
00792                     ProcessLdtInfo-&gt;AllocatedSize - OldSize
00793                     );
00794 
00795             } except(EXCEPTION_EXECUTE_HANDLER) {
00796                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00797             }
00798 
00799             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00800                 <span class="keywordflow">goto</span> SetInfoCleanup;
00801             }
00802 
00803             <span class="comment">//</span>
00804             <span class="comment">// Swap Ldt information</span>
00805             <span class="comment">//</span>
00806             OldLdt = ProcessLdtInfo-&gt;Ldt;
00807             ProcessLdtInfo-&gt;Ldt = Ldt;
00808             ProcessLdtInfo-&gt;Size = <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
00809             ProcessLdtInfo-&gt;AllocatedSize = AllocatedSize;
00810 
00811             <span class="comment">//</span>
00812             <span class="comment">// Put new selectors into the new ldt</span>
00813             <span class="comment">//</span>
00814             RtlMoveMemory(
00815                 (PCHAR)(ProcessLdtInfo-&gt;Ldt) + LdtInfo-&gt;Start,
00816                 LdtInfo-&gt;LdtEntries,
00817                 LdtInfo-&gt;Length
00818                 );
00819 
00820             <a class="code" href="../../d4/d3/i386_2ldtsup_8c.html#a4">Ke386SetLdtProcess</a>(
00821                 &amp;(Process-&gt;Pcb),
00822                 ProcessLdtInfo-&gt;Ldt,
00823                 ProcessLdtInfo-&gt;Size
00824                 );
00825 
00826 
00827         } <span class="keywordflow">else</span> {
00828 
00829             <span class="comment">//</span>
00830             <span class="comment">// Current Ldt allocation is large enough</span>
00831             <span class="comment">//</span>
00832 
00833             ProcessLdtInfo-&gt;Size = LdtInfo-&gt;Length + LdtInfo-&gt;Start;
00834 
00835             <a class="code" href="../../d4/d3/i386_2ldtsup_8c.html#a4">Ke386SetLdtProcess</a>(
00836                 &amp;(Process-&gt;Pcb),
00837                 ProcessLdtInfo-&gt;Ldt,
00838                 ProcessLdtInfo-&gt;Size
00839                 );
00840 
00841             <span class="comment">//</span>
00842             <span class="comment">// Change the selectors in the table</span>
00843             <span class="comment">//</span>
00844             <span class="keywordflow">for</span> (LdtOffset = LdtInfo-&gt;Start,
00845                 CurrentDescriptor = LdtInfo-&gt;LdtEntries;
00846 
00847                 LdtOffset &lt; LdtInfo-&gt;Start + LdtInfo-&gt;Length;
00848 
00849                 LdtOffset += <span class="keyword">sizeof</span>(LDT_ENTRY),
00850                 CurrentDescriptor++
00851             ) {
00852 
00853                 <a class="code" href="../../d4/d3/i386_2ldtsup_8c.html#a5">Ke386SetDescriptorProcess</a>(
00854                     &amp;(Process-&gt;Pcb),
00855                     LdtOffset,
00856                     *CurrentDescriptor
00857                     );
00858             }
00859         }
00860     } <span class="keywordflow">else</span> {
00861 
00862         <span class="comment">//</span>
00863         <span class="comment">// Simply changing some selectors</span>
00864         <span class="comment">//</span>
00865 
00866         <span class="keywordflow">for</span> (LdtOffset = LdtInfo-&gt;Start,
00867             CurrentDescriptor = LdtInfo-&gt;LdtEntries;
00868 
00869             LdtOffset &lt; LdtInfo-&gt;Start +  LdtInfo-&gt;Length;
00870 
00871             LdtOffset += <span class="keyword">sizeof</span>(LDT_ENTRY),
00872             CurrentDescriptor++
00873         ) {
00874 
00875             <a class="code" href="../../d4/d3/i386_2ldtsup_8c.html#a5">Ke386SetDescriptorProcess</a>(
00876                 &amp;(Process-&gt;Pcb),
00877                 LdtOffset,
00878                 *CurrentDescriptor
00879                 );
00880         }
00881         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00882     }
00883 
00884 
00885 SetInfoCleanup:
00886 
00887     MutexState = <a class="code" href="../../d3/d5/mutntobj_8c.html#a5">KeReleaseMutex</a>( &amp;LdtMutex, FALSE );
00888     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(( MutexState == 0 ));
00889 
00890     <span class="keywordflow">if</span> (OldLdt != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00891         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(OldLdt);
00892     }
00893 
00894     <span class="keywordflow">if</span> (LdtInfo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00895         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(LdtInfo);
00896     }
00897 
00898     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00899 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="i386/psldt.c::PspSetLdtSize" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS PspSetLdtSize           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Process</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PPROCESS_LDT_SIZE&nbsp;</td>
          <td class="mdname" nowrap> <em>LdtSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>LdtSizeLength</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d0/i386_2psldt_8c-source.html#l00308">308</a> of file <a class="el" href="../../d4/d0/i386_2psldt_8c-source.html">i386/psldt.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d2/i386_2ldtsup_8c-source.html#l00063">Ke386SetLdtProcess()</a>, <a class="el" href="../../d4/d4/mutntobj_8c-source.html#l00310">KeReleaseMutex()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d4/d0/i386_2psldt_8c-source.html#l00051">LdtMutex</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00599">PAGE_SIZE</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d4/d0/i386_2psldt_8c-source.html#l00902">PspCreateLdt()</a>, <a class="el" href="../../d1/d1/psquota_8c-source.html#l00356">PsReturnPoolQuota()</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
<pre class="fragment"><div>00316                    :
00317 
00318     This routine changes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> LDT size.  It will shrink <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> LDT, but not
00319     grow <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> LDT shrinks by 1 or more pages from its current allocation,
00320     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> LDT will be reallocated <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> smaller size.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> allocated
00321     size of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> LDT changes, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> quota charge <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Ldt will be reduced.
00322 
00323 Arguments:
00324 
00325     Process -- Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process whose Ldt <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be sized
00326     LdtSize -- Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size information
00327 
00328 Return Value:
00329 
00330     TBS
00331 --*/
00332 {
00333     ULONG OldSize = 0;
00334     LONG MutexState;
00335     ULONG Length;
00336     PLDT_ENTRY OldLdt = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00337     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00338     PLDTINFORMATION ProcessLdtInfo;
00339     BOOLEAN ReturnNow = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00340     PLDT_ENTRY Ldt;
00341 
00342     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00343 
00344     <span class="comment">//</span>
00345     <span class="comment">// Verify the parameters</span>
00346     <span class="comment">//</span>
00347     <span class="keywordflow">if</span> ( LdtSizeLength != (ULONG)<span class="keyword">sizeof</span>( PROCESS_LDT_SIZE ) ){
00348         <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
00349     }
00350 
00351     <span class="comment">//</span>
00352     <span class="comment">// The following parameters may be in user space</span>
00353     <span class="comment">//</span>
00354     <span class="keywordflow">try</span> {
00355         <span class="comment">//</span>
00356         <span class="comment">// Capture the new Ldt length</span>
00357         <span class="comment">//</span>
00358         Length = LdtSize-&gt;Length;
00359 
00360     } except(EXCEPTION_EXECUTE_HANDLER){
00361         ReturnNow = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00362     }
00363 
00364     <span class="keywordflow">if</span> (ReturnNow) {
00365         <span class="keywordflow">return</span> STATUS_SUCCESS;
00366     }
00367 
00368     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((<span class="keyword">sizeof</span>(LDT_ENTRY) == 8));
00369 
00370     <span class="comment">//</span>
00371     <span class="comment">// The Ldt must always be an integral number of LDT_ENTRIES</span>
00372     <span class="comment">//</span>
00373     <span class="keywordflow">if</span> (Length % <span class="keyword">sizeof</span>(LDT_ENTRY)) {
00374         <span class="keywordflow">return</span> STATUS_INVALID_LDT_SIZE;
00375     }
00376 
00377     <span class="comment">//</span>
00378     <span class="comment">// Acquire the Ldt Mutex</span>
00379     <span class="comment">//</span>
00380 
00381     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>(
00382                 &amp;LdtMutex,
00383                 Executive,
00384                 KernelMode,
00385                 FALSE,
00386                 NULL
00387                 );
00388     <span class="keywordflow">if</span> ( !(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) ) {
00389         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00390     }
00391 
00392     <span class="comment">//</span>
00393     <span class="comment">// If there isn't an Ldt we can't set the size of the LDT</span>
00394     <span class="comment">//</span>
00395     ProcessLdtInfo = Process-&gt;LdtInformation;
00396     <span class="keywordflow">if</span> ((ProcessLdtInfo == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) || (ProcessLdtInfo-&gt;Size == 0)) {
00397         MutexState = <a class="code" href="../../d3/d5/mutntobj_8c.html#a5">KeReleaseMutex</a>( &amp;LdtMutex, FALSE );
00398         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((MutexState == 0));
00399         <span class="keywordflow">return</span> STATUS_NO_LDT;
00400     }
00401 
00402     <span class="comment">//</span>
00403     <span class="comment">// This function cannot be used to grow the Ldt</span>
00404     <span class="comment">//</span>
00405     <span class="keywordflow">if</span> (Length &gt; ProcessLdtInfo-&gt;Size) {
00406         MutexState = <a class="code" href="../../d3/d5/mutntobj_8c.html#a5">KeReleaseMutex</a>( &amp;LdtMutex, FALSE );
00407         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((MutexState == 0));
00408         <span class="keywordflow">return</span> STATUS_INVALID_LDT_SIZE;
00409     }
00410 
00411     <span class="comment">//</span>
00412     <span class="comment">// Later, we will set ProcessLdtInfo-&gt;Ldt = Ldt.  We may set the value</span>
00413     <span class="comment">// of Ldt in the if statement below, but there is one case where we</span>
00414     <span class="comment">// don't</span>
00415     <span class="comment">//</span>
00416     Ldt = ProcessLdtInfo-&gt;Ldt;
00417 
00418     <span class="comment">//</span>
00419     <span class="comment">// Adjust the size of the LDT</span>
00420     <span class="comment">//</span>
00421 
00422     ProcessLdtInfo-&gt;Size = Length;
00423 
00424     <span class="comment">//</span>
00425     <span class="comment">// Free some of the Ldt memory if conditions allow</span>
00426     <span class="comment">//</span>
00427 
00428     <span class="keywordflow">if</span> ( Length == 0 ) {
00429 
00430         OldSize = ProcessLdtInfo-&gt;AllocatedSize;
00431         OldLdt = ProcessLdtInfo-&gt;Ldt;
00432 
00433         ProcessLdtInfo-&gt;AllocatedSize = 0;
00434         Ldt = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00435 
00436     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( (ProcessLdtInfo-&gt;AllocatedSize - ProcessLdtInfo-&gt;Size) &gt;=
00437         <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>
00438     ) {
00439 
00440         OldSize = ProcessLdtInfo-&gt;AllocatedSize;
00441         OldLdt = ProcessLdtInfo-&gt;Ldt;
00442 
00443         <span class="comment">//</span>
00444         <span class="comment">// Calculate new Ldt size (lowest integer number of pages</span>
00445         <span class="comment">// large enough)</span>
00446         <span class="comment">//</span>
00447 
00448         ProcessLdtInfo-&gt;AllocatedSize = (ProcessLdtInfo-&gt;Size + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1)
00449             &amp; ~(<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - 1);
00450 
00451         <span class="comment">//</span>
00452         <span class="comment">// Reallocate and copy the Ldt</span>
00453         <span class="comment">//</span>
00454         Ldt = <a class="code" href="../../d3/d1/i386_2psldt_8c.html#a7">PspCreateLdt</a>(
00455             ProcessLdtInfo-&gt;Ldt,
00456             0,
00457             ProcessLdtInfo-&gt;Size,
00458             ProcessLdtInfo-&gt;AllocatedSize
00459             );
00460 
00461         <span class="keywordflow">if</span> ( Ldt == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
00462             <span class="comment">// We cannot reduce the allocation, but we can reduce the</span>
00463             <span class="comment">// Ldt selector limit (done using Ke386SetLdtProcess)</span>
00464             Ldt = OldLdt;
00465             ProcessLdtInfo-&gt;AllocatedSize = OldSize;
00466             OldLdt = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00467         }
00468     }
00469 
00470     ProcessLdtInfo-&gt;Ldt = Ldt;
00471 
00472     <span class="comment">//</span>
00473     <span class="comment">// Change the limit on the Process Ldt</span>
00474     <span class="comment">//</span>
00475 
00476     <a class="code" href="../../d4/d3/i386_2ldtsup_8c.html#a4">Ke386SetLdtProcess</a>(
00477         &amp;(Process-&gt;Pcb),
00478         ProcessLdtInfo-&gt;Ldt,
00479         ProcessLdtInfo-&gt;Size
00480         );
00481 
00482     <span class="comment">//</span>
00483     <span class="comment">// If we resized the Ldt, free to old one and reduce the quota charge</span>
00484     <span class="comment">//</span>
00485 
00486     <span class="keywordflow">if</span> (OldLdt) {
00487         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( OldLdt );
00488 
00489         <a class="code" href="../../d0/d2/psquota_8c.html#a3">PsReturnPoolQuota</a>(
00490             Process,
00491             PagedPool,
00492             OldSize - ProcessLdtInfo-&gt;AllocatedSize
00493             );
00494     }
00495 
00496     MutexState = <a class="code" href="../../d3/d5/mutntobj_8c.html#a5">KeReleaseMutex</a>( &amp;LdtMutex, FALSE );
00497     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((MutexState == 0));
00498     <span class="keywordflow">return</span> STATUS_SUCCESS;
00499 }

</div></pre>    </td>
  </tr>
</table>
<hr><h2>Variable Documentation</h2>
<a class="anchor" name="a6" doxytag="i386/psldt.c::LdtMutex" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d3/d7/struct__KMUTANT.html">KMUTEX</a> <a class="el" href="../../d3/d1/i386_2psldt_8c.html#a6">LdtMutex</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d0/i386_2psldt_8c-source.html#l00051">51</a> of file <a class="el" href="../../d4/d0/i386_2psldt_8c-source.html">i386/psldt.c</a>.
<p>
Referenced by <a class="el" href="../../d4/d0/i386_2psldt_8c-source.html#l01235">NtSetLdtEntries()</a>, <a class="el" href="../../d4/d0/i386_2psldt_8c-source.html#l00084">PspLdtInitialize()</a>, <a class="el" href="../../d4/d0/i386_2psldt_8c-source.html#l01061">PspQueryDescriptorThread()</a>, <a class="el" href="../../d4/d0/i386_2psldt_8c-source.html#l00108">PspQueryLdtInformation()</a>, <a class="el" href="../../d4/d0/i386_2psldt_8c-source.html#l00503">PspSetLdtInformation()</a>, and <a class="el" href="../../d4/d0/i386_2psldt_8c-source.html#l00308">PspSetLdtSize()</a>.    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:45:23 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
