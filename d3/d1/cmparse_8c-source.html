<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: cmparse.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>cmparse.c</h1><a href="../../d2/d2/cmparse_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment">Copyright (c) 1991  Microsoft Corporation</span>
00003 <span class="comment"></span>
00004 <span class="comment">Module Name:</span>
00005 <span class="comment"></span>
00006 <span class="comment">    cmparse.c</span>
00007 <span class="comment"></span>
00008 <span class="comment">Abstract:</span>
00009 <span class="comment"></span>
00010 <span class="comment">    This module contains parse routines for the configuration manager, particularly</span>
00011 <span class="comment">    the registry.</span>
00012 <span class="comment"></span>
00013 <span class="comment">Author:</span>
00014 <span class="comment"></span>
00015 <span class="comment">    Bryan M. Willman (bryanwi) 10-Sep-1991</span>
00016 <span class="comment"></span>
00017 <span class="comment">Revision History:</span>
00018 <span class="comment"></span>
00019 <span class="comment">--*/</span>
00020 
00021 <span class="preprocessor">#include    "<a class="code" href="../../d1/d2/cmp_8h.html">cmp.h</a>"</span>
00022 
<a name="l00023"></a><a class="code" href="../../d2/d2/cmparse_8c.html#a6">00023</a> ULONG <a class="code" href="../../d1/d2/cmp_8h.html#a154">CmpCacheOnFlag</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a15">CM_CACHE_FAKE_KEY</a>;
00024 
<a name="l00025"></a><a class="code" href="../../d2/d2/cmparse_8c.html#a7">00025</a> <span class="keyword">extern</span>  <a class="code" href="../../d9/d6/struct__CMHIVE.html">PCMHIVE</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a2">CmpMasterHive</a>;
<a name="l00026"></a><a class="code" href="../../d2/d2/cmparse_8c.html#a8">00026</a> <span class="keyword">extern</span>  BOOLEAN <a class="code" href="../../d6/d0/cmdat_8c.html#a64">CmpNoMasterCreates</a>;
<a name="l00027"></a><a class="code" href="../../d2/d2/cmparse_8c.html#a9">00027</a> <span class="keyword">extern</span>  <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> <a class="code" href="../../d7/d0/cmdat2_8c.html#a14">CmpKeyControlBlockRoot</a>;
<a name="l00028"></a><a class="code" href="../../d2/d2/cmparse_8c.html#a10">00028</a> <span class="keyword">extern</span>  UNICODE_STRING <a class="code" href="../../d8/d9/cmapi_8c.html#a6">CmSymbolicLinkValueName</a>;
00029 
<a name="l00030"></a><a class="code" href="../../d2/d2/cmparse_8c.html#a0">00030</a> <span class="preprocessor">#define CM_HASH_STACK_SIZE  30</span>
00031 <span class="preprocessor"></span>
<a name="l00032"></a><a class="code" href="../../d1/d4/struct__CM__HASH__ENTRY.html">00032</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d1/d4/struct__CM__HASH__ENTRY.html">_CM_HASH_ENTRY</a> {
<a name="l00033"></a><a class="code" href="../../d1/d4/struct__CM__HASH__ENTRY.html#o0">00033</a>     ULONG <a class="code" href="../../d1/d4/struct__CM__HASH__ENTRY.html#o0">ConvKey</a>;
<a name="l00034"></a><a class="code" href="../../d1/d4/struct__CM__HASH__ENTRY.html#o1">00034</a>     UNICODE_STRING <a class="code" href="../../d1/d4/struct__CM__HASH__ENTRY.html#o1">KeyName</a>;
00035 } <a class="code" href="../../d1/d4/struct__CM__HASH__ENTRY.html">CM_HASH_ENTRY</a>, *<a class="code" href="../../d1/d4/struct__CM__HASH__ENTRY.html">PCM_HASH_ENTRY</a>;
00036 
00037 ULONG
00038 <a class="code" href="../../d2/d2/cmparse_8c.html#a13">CmpComputeHashValue</a>(
00039     IN PCM_HASH_ENTRY  HashStack,
00040     IN OUT ULONG  *TotalSubkeys,
00041     IN ULONG BaseConvKey,
00042     IN PUNICODE_STRING RemainingName
00043     );
00044 
00045 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00046 <a class="code" href="../../d2/d2/cmparse_8c.html#a14">CmpCacheLookup</a>(
00047     IN PCM_HASH_ENTRY HashStack,
00048     IN ULONG TotalRemainingSubkeys,
00049     OUT ULONG *MatchRemainSubkeyLevel,
00050     IN OUT <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> *Kcb,
00051     OUT PUNICODE_STRING RemainingName,
00052     OUT <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> *Hive,
00053     OUT HCELL_INDEX *Cell
00054     );
00055 
00056 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00057 <a class="code" href="../../d2/d2/cmparse_8c.html#a15">CmpCacheAdd</a>(
00058     IN PCM_HASH_ENTRY LastHashEntry,
00059     IN ULONG Count
00060     );
00061 
00062 <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>
00063 <a class="code" href="../../d2/d2/cmparse_8c.html#a16">CmpAddInfoAfterParseFailure</a>(
00064     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>          Hive,
00065     HCELL_INDEX     Cell,
00066     <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>    Node,
00067     <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> kcb,
00068     PUNICODE_STRING NodeName
00069     );
00070 
00071 <span class="comment">//</span>
00072 <span class="comment">// Prototypes for procedures private to this file</span>
00073 <span class="comment">//</span>
00074 
00075 BOOLEAN
00076 <a class="code" href="../../d2/d2/cmparse_8c.html#a17">CmpGetSymbolicLink</a>(
00077     IN <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> Hive,
00078     IN <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> Node,
00079     IN OUT PUNICODE_STRING ObjectName,
00080     IN OUT <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> SymbolicKcb,
00081     IN PUNICODE_STRING RemainingName
00082     );
00083 
00084 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00085 <a class="code" href="../../d2/d2/cmparse_8c.html#a18">CmpDoOpen</a>(
00086     IN <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> Hive,
00087     IN HCELL_INDEX Cell,
00088     IN <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> Node,
00089     IN <a class="code" href="../../d2/d5/struct__ACCESS__STATE.html">PACCESS_STATE</a> AccessState,
00090     IN KPROCESSOR_MODE AccessMode,
00091     IN ULONG Attributes,
00092     IN <a class="code" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html">PCM_PARSE_CONTEXT</a> Context,
00093     IN BOOLEAN  CompleteKeyCached,
00094     IN OUT <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> *CachedKcb,
00095     IN PUNICODE_STRING KeyName,
00096     OUT PVOID *Object
00097     );
00098 
00099 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00100 <a class="code" href="../../d2/d2/cmparse_8c.html#a19">CmpCreateLinkNode</a>(
00101     IN <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> Hive,
00102     IN HCELL_INDEX Cell,
00103     IN <a class="code" href="../../d2/d5/struct__ACCESS__STATE.html">PACCESS_STATE</a> AccessState,
00104     IN UNICODE_STRING Name,
00105     IN KPROCESSOR_MODE AccessMode,
00106     IN ULONG Attributes,
00107     IN <a class="code" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html">PCM_PARSE_CONTEXT</a> Context,
00108     IN <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> ParentKcb,
00109     OUT PVOID *Object
00110     );
00111 
00112 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00113 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpParseKey)</span>
00114 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpGetNextName)</span>
00115 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpDoOpen)</span>
00116 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpCreateLinkNode)</span>
00117 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpGetSymbolicLink)</span>
00118 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpComputeHashValue)</span>
00119 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpCacheLookup)</span>
00120 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,CmpAddInfoAfterParseFailure)</span>
00121 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00122 <span class="preprocessor"></span>
00123 <span class="comment">/*</span>
00124 <span class="comment">VOID</span>
00125 <span class="comment">CmpStepThroughExit(</span>
00126 <span class="comment">    IN OUT PHHIVE       *Hive,</span>
00127 <span class="comment">    IN OUT HCELL_INDEX  *Cell,</span>
00128 <span class="comment">    IN OUT PCM_KEY_NODE *pNode</span>
00129 <span class="comment">    )</span>
00130 <span class="comment">*/</span>
<a name="l00131"></a><a class="code" href="../../d2/d2/cmparse_8c.html#a1">00131</a> <span class="preprocessor">#define CmpStepThroughExit(h,c,n)           \</span>
00132 <span class="preprocessor">if ((n)-&gt;Flags &amp; KEY_HIVE_EXIT) {           \</span>
00133 <span class="preprocessor">    (h)=(n)-&gt;ChildHiveReference.KeyHive;    \</span>
00134 <span class="preprocessor">    (c)=(n)-&gt;ChildHiveReference.KeyCell;    \</span>
00135 <span class="preprocessor">    (n)=(PCM_KEY_NODE)HvGetCell((h),(c));   \</span>
00136 <span class="preprocessor">}</span>
00137 <span class="preprocessor"></span>
<a name="l00138"></a><a class="code" href="../../d2/d2/cmparse_8c.html#a2">00138</a> <span class="preprocessor">#define CMP_PARSE_GOTO_NONE     0</span>
<a name="l00139"></a><a class="code" href="../../d2/d2/cmparse_8c.html#a3">00139</a> <span class="preprocessor"></span><span class="preprocessor">#define CMP_PARSE_GOTO_CREATE   1</span>
<a name="l00140"></a><a class="code" href="../../d2/d2/cmparse_8c.html#a4">00140</a> <span class="preprocessor"></span><span class="preprocessor">#define CMP_PARSE_GOTO_RETURN   2</span>
<a name="l00141"></a><a class="code" href="../../d2/d2/cmparse_8c.html#a5">00141</a> <span class="preprocessor"></span><span class="preprocessor">#define CMP_PARSE_GOTO_RETURN2  3</span>
00142 <span class="preprocessor"></span>
00143 
00144 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00145"></a><a class="code" href="../../d2/d2/cmparse_8c.html#a20">00145</a> <a class="code" href="../../d2/d2/cmparse_8c.html#a20">CmpParseKey</a>(
00146     IN PVOID ParseObject,
00147     IN PVOID ObjectType,
00148     IN OUT <a class="code" href="../../d2/d5/struct__ACCESS__STATE.html">PACCESS_STATE</a> AccessState,
00149     IN KPROCESSOR_MODE AccessMode,
00150     IN ULONG Attributes,
00151     IN OUT PUNICODE_STRING CompleteName,
00152     IN OUT PUNICODE_STRING RemainingName,
00153     IN OUT PVOID Context OPTIONAL,
00154     IN PSECURITY_QUALITY_OF_SERVICE SecurityQos OPTIONAL,
00155     OUT PVOID *Object
00156     )
00157 <span class="comment">/*++</span>
00158 <span class="comment"></span>
00159 <span class="comment">Routine Description:</span>
00160 <span class="comment"></span>
00161 <span class="comment">    This routine interfaces to the NT Object Manager.  It is invoked when</span>
00162 <span class="comment">    the object system is given the name of an entity to create or open and</span>
00163 <span class="comment">    a Key or KeyRoot is encountered in the path.  In practice this means</span>
00164 <span class="comment">    that this routine is called for all objects whose names are of the</span>
00165 <span class="comment">    form \REGISTRY\...</span>
00166 <span class="comment"></span>
00167 <span class="comment">    This routine will create a Key object, which is effectively an open</span>
00168 <span class="comment">    instance to a registry key node, and return its address</span>
00169 <span class="comment">    (for the success case.)</span>
00170 <span class="comment"></span>
00171 <span class="comment">Arguments:</span>
00172 <span class="comment"></span>
00173 <span class="comment">    ParseObject - Pointer to a KeyRoot or Key, thus -&gt; KEY_BODY.</span>
00174 <span class="comment"></span>
00175 <span class="comment">    ObjectType - Type of the object being opened.</span>
00176 <span class="comment"></span>
00177 <span class="comment">    AccessState - Running security access state information for operation.</span>
00178 <span class="comment"></span>
00179 <span class="comment">    AccessMode - Access mode of the original caller.</span>
00180 <span class="comment"></span>
00181 <span class="comment">    Attributes - Attributes to be applied to the object.</span>
00182 <span class="comment"></span>
00183 <span class="comment">    CompleteName - Supplies complete name of the object.</span>
00184 <span class="comment"></span>
00185 <span class="comment">    RemainingName - Remaining name of the object.</span>
00186 <span class="comment"></span>
00187 <span class="comment">    Context - if create or hive root open, points to a CM_PARSE_CONTEXT</span>
00188 <span class="comment">              structure,</span>
00189 <span class="comment">              if open, is NULL.</span>
00190 <span class="comment"></span>
00191 <span class="comment">    SecurityQos - Optional security quality of service indicator.</span>
00192 <span class="comment"></span>
00193 <span class="comment">    Object - The address of a variable to receive the created key object, if</span>
00194 <span class="comment">        any.</span>
00195 <span class="comment"></span>
00196 <span class="comment">Return Value:</span>
00197 <span class="comment"></span>
00198 <span class="comment">    The function return value is one of the following:</span>
00199 <span class="comment"></span>
00200 <span class="comment">        a)  Success - This indicates that the function succeeded and the object</span>
00201 <span class="comment">            parameter contains the address of the created key object.</span>
00202 <span class="comment"></span>
00203 <span class="comment">        b)  STATUS_REPARSE - This indicates that a symbolic link key was</span>
00204 <span class="comment">            found, and the path should be reparsed.</span>
00205 <span class="comment"></span>
00206 <span class="comment">        c)  Error - This indicates that the file was not found or created and</span>
00207 <span class="comment">            no file object was created.</span>
00208 <span class="comment"></span>
00209 <span class="comment">--*/</span>
00210 {
00211     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    status;
00212     BOOLEAN     rc;
00213     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>      <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>;
00214     <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> Node;
00215     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>;
00216     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> ParentCell;
00217     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> NextCell;
00218     <a class="code" href="../../d0/d1/hivedata_8h.html#a50">PHCELL_INDEX</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00219     <a class="code" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html">PCM_PARSE_CONTEXT</a> lcontext;
00220     UNICODE_STRING Current;
00221     UNICODE_STRING  NextName;   <span class="comment">// Component last returned by CmpGetNextName,</span>
00222                                 <span class="comment">// will always be behind Current.</span>
00223     BOOLEAN     Last;           <span class="comment">// TRUE if component NextName points to</span>
00224                                 <span class="comment">// is the last one in the path.</span>
00225 
00226     <a class="code" href="../../d1/d4/struct__CM__HASH__ENTRY.html">CM_HASH_ENTRY</a>   HashStack[<a class="code" href="../../d2/d2/cmparse_8c.html#a0">CM_HASH_STACK_SIZE</a>];
00227     ULONG           TotalRemainingSubkeys;
00228     ULONG           MatchRemainSubkeyLevel;
00229     ULONG           TotalSubkeys=0;
00230     ULONG           SubkeyParsed;
00231     <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>   <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>;
00232     <a class="code" href="../../d0/d5/struct__CM__KEY__HASH.html">PCM_KEY_HASH</a> PCmpCacheEntry=<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00233     <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>   ParentKcb;
00234     UNICODE_STRING  TmpNodeName;
00235     ULONG   namelength;
00236     ULONG   GoToValue = <a class="code" href="../../d2/d2/cmparse_8c.html#a2">CMP_PARSE_GOTO_NONE</a>;
00237     BOOLEAN CompleteKeyCached = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00238     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> i,j;
00239     WCHAR *p1;
00240 
00241     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a23">CML_MINOR</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a31">CMS_PARSE</a>) {
00242         KdPrint((<span class="stringliteral">"CmpParseKey:\n\t"</span>));
00243         KdPrint((<span class="stringliteral">"CompleteName = '%wZ'\n\t"</span>, CompleteName));
00244         KdPrint((<span class="stringliteral">"RemainingName = '%wZ'\n"</span>, RemainingName));
00245     }
00246 
00247     <span class="comment">//</span>
00248     <span class="comment">// Strip off any trailing path separators</span>
00249     <span class="comment">//</span>
00250     <span class="keywordflow">while</span> ((RemainingName-&gt;Length &gt; 0) &amp;&amp;
00251            (RemainingName-&gt;Buffer[(RemainingName-&gt;Length/<span class="keyword">sizeof</span>(WCHAR)) - 1] == OBJ_NAME_PATH_SEPARATOR)) {
00252         RemainingName-&gt;Length -= <span class="keyword">sizeof</span>(WCHAR);
00253     }
00254 
00255     Current = *RemainingName;
00256     <span class="keywordflow">if</span> (ObjectType != <a class="code" href="../../d6/d0/cmdat_8c.html#a66">CmpKeyObjectType</a>) {
00257         <span class="keywordflow">return</span> STATUS_OBJECT_TYPE_MISMATCH;
00258     }
00259 
00260     lcontext = (<a class="code" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html">PCM_PARSE_CONTEXT</a>)Context;
00261 
00262     <span class="comment">//</span>
00263     <span class="comment">// Check to make sure the passed in root key is not marked for deletion.</span>
00264     <span class="comment">//</span>
00265     <span class="keywordflow">if</span> (((<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a>)ParseObject)-&gt;KeyControlBlock-&gt;Delete == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00266         <span class="keywordflow">return</span>(STATUS_KEY_DELETED);
00267     }
00268 
00269     <span class="comment">//</span>
00270     <span class="comment">// Fetch the starting Hive.Cell.  Because of the way the parse</span>
00271     <span class="comment">// paths work, this will always be defined.  (ObOpenObjectByName</span>
00272     <span class="comment">// had to bounce off of a KeyObject or KeyRootObject to get here)</span>
00273     <span class="comment">//</span>
00274     <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a> = ((<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a>)ParseObject)-&gt;KeyControlBlock;
00275     <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> = <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;KeyHive;
00276     <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> = <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;KeyCell;
00277     Node = <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;KeyNode;
00278 
00279     <span class="comment">//</span>
00280     <span class="comment">// Compute the hash values of each subkeys</span>
00281     <span class="comment">//</span>
00282     TotalRemainingSubkeys = <a class="code" href="../../d2/d2/cmparse_8c.html#a13">CmpComputeHashValue</a>(HashStack,
00283                                                 &amp;TotalSubkeys,
00284                                                 <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;ConvKey,
00285                                                 &amp;Current);
00286 
00287 
00288     <span class="comment">// Look up from the cache.  kcb will be changed if we find a partial or exact match</span>
00289     <span class="comment">// PCmpCacheEntry, the entry found, will be move to the front of</span>
00290     <span class="comment">// the Cache.</span>
00291 
00292     <a class="code" href="../../d1/d2/cmp_8h.html#a16">LOCK_KCB_TREE</a>();
00293 
00294     status = <a class="code" href="../../d2/d2/cmparse_8c.html#a14">CmpCacheLookup</a>(HashStack,
00295                             TotalRemainingSubkeys,
00296                             &amp;MatchRemainSubkeyLevel,
00297                             &amp;<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>,
00298                             &amp;Current,
00299                             &amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
00300                             &amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>);
00301     <span class="comment">//</span>
00302     <span class="comment">// The RefCount of kcb was increased in the CmpCacheLookup process,</span>
00303     <span class="comment">// It is to protect it from being kicked out of cache.</span>
00304     <span class="comment">// Make sure we dereference it after we are done.</span>
00305     <span class="comment">//</span>
00306 
00307     <span class="comment">//</span>
00308     <span class="comment">// First make sure it is OK to proceed.</span>
00309     <span class="comment">//</span>
00310     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a> (status)) {
00311         <a class="code" href="../../d1/d2/cmp_8h.html#a17">UNLOCK_KCB_TREE</a>();
00312         <span class="keywordflow">goto</span> JustReturn;
00313     }
00314 
00315     SubkeyParsed = MatchRemainSubkeyLevel;
00316     ParentKcb = <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>;
00317 
00318     <span class="comment">//</span>
00319     <span class="comment">// First check if there are further information in the cached kcb.</span>
00320     <span class="comment">// </span>
00321     <span class="comment">// The additional information can be</span>
00322     <span class="comment">// 1. This cached key is a fake key (CM_KCB_KEY_NON_EXIST), then either let it be created</span>
00323     <span class="comment">//    or return STATUS_OBJECT_NAME_NOT_FOUND.</span>
00324     <span class="comment">// 2. The cached key is not the destination and it has no subkey (CM_KCB_NO_SUBKEY).</span>
00325     <span class="comment">// 3. The cached key is not the destination and it has </span>
00326     <span class="comment">//    the first four characters of its subkeys.  If the flag is CM_KCB_SUBKEY_ONE, there is only one subkey</span>
00327     <span class="comment">//    and the four char is embedded in the KCB.  If the flag is CM_KCB_SUBKEY_INFO, then there is</span>
00328     <span class="comment">//    an allocation for these info. </span>
00329     <span class="comment">//</span>
00330     <span class="comment">// We do need to lock KCB tree to protect the KCB being modified.  Currently there is not lock contention problem</span>
00331     <span class="comment">// on KCBs, We can change KCB lock to a read-write lock if this becomes a problem.</span>
00332     <span class="comment">// </span>
00333 
00334     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;ExtFlags &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a15">CM_KCB_CACHE_MASK</a>) {
00335         <span class="keywordflow">if</span> (MatchRemainSubkeyLevel == TotalRemainingSubkeys) {
00336             <span class="comment">//</span>
00337             <span class="comment">// We have found a cache for the complete path,</span>
00338             <span class="comment">//</span>
00339             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;ExtFlags &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a13">CM_KCB_KEY_NON_EXIST</a>) {
00340                 <span class="comment">//</span>
00341                 <span class="comment">// This key does not exist.</span>
00342                 <span class="comment">//</span>
00343                 <span class="keywordflow">if</span> (ARGUMENT_PRESENT(lcontext)) {
00344                     ULONG LevelToSkip = TotalRemainingSubkeys-1;
00345                     ULONG i=0;
00346                     <span class="comment">//</span>
00347                     <span class="comment">// The non-existing key is the desination key and lcontext is present.</span>
00348                     <span class="comment">// delete this fake kcb and let the real one be created.</span>
00349                     <span class="comment">//</span>
00350                     <span class="comment">// Temporarily increase the RefCount of the ParentKcb so it's </span>
00351                     <span class="comment">// not removed while removing the fake and creating the real KCB.</span>
00352                     <span class="comment">//</span>
00353                     
00354                     ParentKcb = <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;ParentKcb;
00355                     
00356                     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d2/cmsubs_8c.html#a13">CmpReferenceKeyControlBlock</a>(ParentKcb)) {
00357                     
00358                         <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;Delete = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00359                         <a class="code" href="../../d8/d2/cmsubs_8c.html#a24">CmpRemoveKeyControlBlock</a>(<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>);
00360                         <a class="code" href="../../d8/d2/cmsubs_8c.html#a23">CmpDereferenceKeyControlBlockWithLock</a>(<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>);
00361 
00362                         <span class="comment">//</span>
00363                         <span class="comment">// Update Hive, Cell and Node</span>
00364                         <span class="comment">//</span>
00365                         <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> = ParentKcb-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o5">KeyHive</a>;
00366                         <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> = ParentKcb-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o6">KeyCell</a>;
00367                         Node = ParentKcb-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o17">KeyNode</a>;
00368 
00369                         <span class="comment">//</span>
00370                         <span class="comment">// Now get the child name to be created.</span>
00371                         <span class="comment">//</span>
00372    
00373                         NextName = *RemainingName;
00374                         <span class="keywordflow">if</span> ((NextName.Buffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) || (NextName.Length == 0)) {
00375                             KdPrint((<span class="stringliteral">"Something wrong in finding the child name\n"</span>));
00376                             DbgBreakPoint();
00377                         }
00378                         <span class="comment">//</span>
00379                         <span class="comment">// Skip over leading path separators</span>
00380                         <span class="comment">//</span>
00381                         <span class="keywordflow">if</span> (*(NextName.Buffer) == OBJ_NAME_PATH_SEPARATOR) {
00382                             NextName.Buffer++;
00383                             NextName.Length -= <span class="keyword">sizeof</span>(WCHAR);
00384                             NextName.MaximumLength -= <span class="keyword">sizeof</span>(WCHAR);
00385                         }
00386    
00387                         <span class="keywordflow">while</span> (i &lt; LevelToSkip) {
00388                             <span class="keywordflow">if</span> (*(NextName.Buffer) == OBJ_NAME_PATH_SEPARATOR) {
00389                                 i++;
00390                             }
00391                             NextName.Buffer++;
00392                             NextName.Length -= <span class="keyword">sizeof</span>(WCHAR);
00393                             NextName.MaximumLength -= <span class="keyword">sizeof</span>(WCHAR);
00394                         } 
00395                         GoToValue = <a class="code" href="../../d2/d2/cmparse_8c.html#a3">CMP_PARSE_GOTO_CREATE</a>;
00396                     } <span class="keywordflow">else</span> {
00397                         <span class="comment">//</span>
00398                         <span class="comment">// We have maxed the RefCount of ParentKcb; treate it as key cannot be created.</span>
00399                         <span class="comment">// The ParentKcb will not be dereferenced at the end.</span>
00400                         <span class="comment">//</span>
00401                         status = STATUS_INSUFFICIENT_RESOURCES;
00402                         GoToValue = <a class="code" href="../../d2/d2/cmparse_8c.html#a5">CMP_PARSE_GOTO_RETURN2</a>;
00403                     }
00404                 } <span class="keywordflow">else</span> {
00405                     status = STATUS_OBJECT_NAME_NOT_FOUND;
00406                     GoToValue = <a class="code" href="../../d2/d2/cmparse_8c.html#a4">CMP_PARSE_GOTO_RETURN</a>;
00407                 }
00408             }
00409         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;ExtFlags &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a13">CM_KCB_KEY_NON_EXIST</a>) {
00410             <span class="comment">//</span>
00411             <span class="comment">// one subkey (not desination) in the path does not exist. no point to continue.</span>
00412             <span class="comment">//</span>
00413             status = STATUS_OBJECT_NAME_NOT_FOUND;
00414             GoToValue = <a class="code" href="../../d2/d2/cmparse_8c.html#a4">CMP_PARSE_GOTO_RETURN</a>;
00415         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;ExtFlags &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a9">CM_KCB_NO_SUBKEY</a>) {
00416             <span class="comment">//</span>
00417             <span class="comment">// one parent in the path has no subkey. see if it is a create.</span>
00418             <span class="comment">//</span>
00419             <span class="keywordflow">if</span> (((TotalRemainingSubkeys - MatchRemainSubkeyLevel) == 1) &amp;&amp; (ARGUMENT_PRESENT(lcontext))) {
00420                 <span class="comment">//</span>
00421                 <span class="comment">// Now we are going to create this subkey. </span>
00422                 <span class="comment">// The kcb cache will be updated in CmpDoCreate routine.</span>
00423                 <span class="comment">//</span>
00424             } <span class="keywordflow">else</span> {
00425                 status = STATUS_OBJECT_NAME_NOT_FOUND;
00426                 GoToValue = <a class="code" href="../../d2/d2/cmparse_8c.html#a4">CMP_PARSE_GOTO_RETURN</a>;
00427             }
00428         } <span class="keywordflow">else</span> {
00429             <span class="comment">//</span>
00430             <span class="comment">// We have a partial match.  Current is the remaining name to be parsed.</span>
00431             <span class="comment">// The Key has either one or a few subkeys and has index hint. check if it is the candidate.</span>
00432             <span class="comment">//</span>
00433             ULONG HintLength;
00434             ULONG HintCounts;
00435             ULONG CmpCount;
00436             WCHAR c1;
00437             WCHAR c2;
00438             UCHAR *TmpName;
00439             LONG Result;
00440             BOOLEAN NoMatch = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00441             <span class="comment">//</span>
00442             <span class="comment">// When NoMatch is TRUE, we know for sure there is no subkey that can match.</span>
00443             <span class="comment">// When NoMatch is FALSE, it can we either we found a match or</span>
00444             <span class="comment">// there is not enough information.  Either case, we need to continue</span>
00445             <span class="comment">// the parse.</span>
00446             <span class="comment">//</span>
00447 
00448             TmpNodeName = Current;
00449 
00450             rc = <a class="code" href="../../d2/d2/cmparse_8c.html#a21">CmpGetNextName</a>(&amp;TmpNodeName, &amp;NextName, &amp;Last);
00451         
00452             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;ExtFlags &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a10">CM_KCB_SUBKEY_ONE</a>) {
00453                 HintCounts = 1;
00454                 TmpName = &amp;(<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;NameHint[0]);
00455             } <span class="keywordflow">else</span> {
00456                 <span class="comment">//</span>
00457                 <span class="comment">// More than one child, the hint info in not inside the kcb but pointed by kcb.</span>
00458                 <span class="comment">//</span>
00459                 HintCounts = <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;IndexHint-&gt;Count;
00460                 TmpName = &amp;(<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;IndexHint-&gt;NameHint[0]);
00461             }
00462 
00463             <span class="comment">//</span>
00464             <span class="comment">// use the hint to predict if there is a possible match</span>
00465             <span class="comment">//</span>
00466             <span class="keywordflow">if</span> (NextName.Length &lt; (<span class="keyword">sizeof</span>(WCHAR) * <a class="code" href="../../d9/d0/cmdata_8h.html#a7">CM_SUBKEY_HINT_LENGTH</a>) ) {
00467                 HintLength = NextName.Length / <span class="keyword">sizeof</span>(WCHAR);
00468             } <span class="keywordflow">else</span> {
00469                 HintLength = <a class="code" href="../../d9/d0/cmdata_8h.html#a7">CM_SUBKEY_HINT_LENGTH</a>;
00470             }
00471 
00472             <span class="keywordflow">for</span> (CmpCount=0; CmpCount&lt;HintCounts; CmpCount++) {
00473                 NoMatch = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00474                 
00475                 <span class="keywordflow">if</span>( TmpName[0] == 0) {
00476                     <span class="comment">//</span>
00477                     <span class="comment">// No hint available; assume the subkey exist and go on with the parse</span>
00478                     <span class="comment">//</span>
00479                     <span class="keywordflow">break</span>;
00480                 } 
00481                 
00482                 <span class="keywordflow">for</span> (i=0; i&lt;HintLength; i++) {
00483                     c1 = NextName.Buffer[i];
00484                     c2 = (WCHAR) *TmpName;
00485 
00486                     Result = (LONG)<a class="code" href="../../d6/d6/nls_8c.html#a33">RtlUpcaseUnicodeChar</a>(c1) - (LONG)<a class="code" href="../../d6/d6/nls_8c.html#a33">RtlUpcaseUnicodeChar</a>(c2);
00487                     <span class="keywordflow">if</span> (Result != 0) {
00488                         NoMatch = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00489                         TmpName += (<a class="code" href="../../d9/d0/cmdata_8h.html#a7">CM_SUBKEY_HINT_LENGTH</a>-i); 
00490                         <span class="keywordflow">break</span>;
00491                     }
00492                     TmpName++;
00493                 }
00494                 
00495                 <span class="keywordflow">if</span> (NoMatch == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00496                     <span class="comment">//</span>
00497                     <span class="comment">// There is a match.</span>
00498                     <span class="comment">//</span>
00499                     <span class="keywordflow">break</span>;
00500                 }
00501             }
00502 
00503             <span class="keywordflow">if</span> (NoMatch) {
00504                 <span class="keywordflow">if</span> (((TotalRemainingSubkeys - MatchRemainSubkeyLevel) == 1) &amp;&amp; (ARGUMENT_PRESENT(lcontext))) {
00505                     <span class="comment">//</span>
00506                     <span class="comment">// No we are going to create this subkey. </span>
00507                     <span class="comment">// The kcb cache will be updated in CmpDoCreate.</span>
00508                     <span class="comment">//</span>
00509                 } <span class="keywordflow">else</span> {
00510                     status = STATUS_OBJECT_NAME_NOT_FOUND;
00511                     GoToValue = <a class="code" href="../../d2/d2/cmparse_8c.html#a4">CMP_PARSE_GOTO_RETURN</a>;
00512                 }
00513             }
00514         }
00515     }
00516 
00517     <a class="code" href="../../d1/d2/cmp_8h.html#a17">UNLOCK_KCB_TREE</a>();
00518 
00519 
00520     <span class="keywordflow">if</span> (GoToValue == <a class="code" href="../../d2/d2/cmparse_8c.html#a3">CMP_PARSE_GOTO_CREATE</a>) {
00521         <span class="keywordflow">goto</span> CreateChild;
00522     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (GoToValue == <a class="code" href="../../d2/d2/cmparse_8c.html#a4">CMP_PARSE_GOTO_RETURN</a>) {
00523         <span class="keywordflow">goto</span> FreeAndReturn;
00524     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (GoToValue == <a class="code" href="../../d2/d2/cmparse_8c.html#a5">CMP_PARSE_GOTO_RETURN2</a>) {
00525         <span class="keywordflow">goto</span> JustReturn;
00526     }
00527 
00528     <span class="keywordflow">if</span> (MatchRemainSubkeyLevel) {
00529         <span class="comment">// Found something, update the information to start the search</span>
00530         <span class="comment">// from the new BaseName</span>
00531 
00532         <span class="comment">//</span>
00533         <span class="comment">// Get the Node address from the kcb.</span>
00534         <span class="comment">// (Always try to utilize the KCB to avoid touching the registry data).</span>
00535         <span class="comment">//</span>
00536         Node = <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;KeyNode;
00537 
00538         <span class="keywordflow">if</span> (MatchRemainSubkeyLevel == TotalSubkeys) {
00539             <span class="comment">// The complete key has been found in the cache,</span>
00540             <span class="comment">// go directly to the CmpDoOpen.</span>
00541             
00542             <span class="comment">//</span>
00543             <span class="comment">// Found the whole thing cached.</span>
00544             <span class="comment">// </span>
00545             <span class="comment">//</span>
00546             CompleteKeyCached = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00547             <span class="keywordflow">goto</span> Found;
00548         }
00549     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (TotalRemainingSubkeys == 0) {
00550         <span class="comment">//</span>
00551         <span class="comment">// BUGBUG John Vert (jvert) 10/7/1997</span>
00552         <span class="comment">//</span>
00553         CompleteKeyCached = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00554         <span class="keywordflow">goto</span> Found;
00555     }
00556 
00557     <span class="comment">//</span>
00558     <span class="comment">// Parse the path.</span>
00559     <span class="comment">//</span>
00560 
00561     status = STATUS_SUCCESS;
00562     <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00563 
00564         <span class="comment">//</span>
00565         <span class="comment">// Parse out next component of name</span>
00566         <span class="comment">//</span>
00567         rc = <a class="code" href="../../d2/d2/cmparse_8c.html#a21">CmpGetNextName</a>(&amp;Current, &amp;NextName, &amp;Last);
00568         <span class="keywordflow">if</span> ((NextName.Length &gt; 0) &amp;&amp; (rc == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
00569 
00570             <span class="comment">//</span>
00571             <span class="comment">// As we iterate through, we will create a kcb for each subkey parsed.</span>
00572             <span class="comment">// </span>
00573             <span class="comment">// Always use the information in kcb to avoid</span>
00574             <span class="comment">// touching registry data.</span>
00575             <span class="comment">//</span>
00576             <span class="keywordflow">if</span> (!(<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;KeyNode-&gt;Flags &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a31">KEY_SYM_LINK</a>)) {
00577                 <span class="comment">//</span>
00578                 <span class="comment">// Got a legal name component, see if we can find a sub key</span>
00579                 <span class="comment">// that actually has such a name.</span>
00580                 <span class="comment">//</span>
00581                 NextCell = <a class="code" href="../../d1/d2/cmp_8h.html#a303">CmpFindSubKeyByName</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
00582                                                Node,
00583                                                &amp;NextName);
00584 
00585                 <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a24">CML_FLOW</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a31">CMS_PARSE</a>) {
00586                     KdPrint((<span class="stringliteral">"CmpParseKey:\n\t"</span>));
00587                     KdPrint((<span class="stringliteral">"NextName = '%wZ'\n\t"</span>, &amp;NextName));
00588                     KdPrint((<span class="stringliteral">"NextCell = %08lx  Last = %01lx\n"</span>, NextCell, Last));
00589                 }
00590                 <span class="keywordflow">if</span> (NextCell != <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
00591                     <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> = NextCell;
00592                     Node = (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,<a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>);
00593                     <span class="keywordflow">if</span> (Last == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00594 
00595 Found:
00596                         <span class="comment">//</span>
00597                         <span class="comment">// We will open the key regardless of whether the</span>
00598                         <span class="comment">// call was open or create, so step through exit</span>
00599                         <span class="comment">// portholes here.</span>
00600                         <span class="comment">//</span>
00601 
00602                         <span class="keywordflow">if</span> (CompleteKeyCached == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00603                             <span class="comment">//</span>
00604                             <span class="comment">// If the key found is already cached, </span>
00605                             <span class="comment">// do not need to StepThroughExit</span>
00606                             <span class="comment">// (no kcb is created using exit node).</span>
00607                             <span class="comment">// This prevents us from touching the key node just for the Flags.</span>
00608                             <span class="comment">//</span>
00609                         } <span class="keywordflow">else</span> {
00610                             <a class="code" href="../../d2/d2/cmparse_8c.html#a1">CmpStepThroughExit</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>, Node);
00611                         }
00612                         <span class="comment">//</span>
00613                         <span class="comment">// We have found the entire path, so we want to open</span>
00614                         <span class="comment">// it (for both Open and Create calls).</span>
00615                         <span class="comment">// Hive,Cell -&gt; the key we are supposed to open.</span>
00616                         <span class="comment">//</span>
00617 
00618                         status = <a class="code" href="../../d2/d2/cmparse_8c.html#a18">CmpDoOpen</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
00619                                            <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>,
00620                                            Node,
00621                                            AccessState,
00622                                            AccessMode,
00623                                            Attributes,
00624                                            lcontext,
00625                                            CompleteKeyCached,
00626                                            &amp;<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>,
00627                                            &amp;NextName,
00628                                            Object);
00629 
00630                         <span class="keywordflow">if</span> (status == STATUS_REPARSE) {
00631                             <span class="comment">//</span>
00632                             <span class="comment">// The given key was a symbolic link.  Find the name of</span>
00633                             <span class="comment">// its link, and return STATUS_REPARSE to the Object Manager.</span>
00634                             <span class="comment">//</span>
00635 
00636                             <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d2/cmparse_8c.html#a17">CmpGetSymbolicLink</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
00637                                                     Node,
00638                                                     CompleteName,
00639                                                     <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>,
00640                                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00641                                 <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a22">CML_MAJOR</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a31">CMS_PARSE</a>) {
00642                                     KdPrint((<span class="stringliteral">"CmpParseKey: couldn't find symbolic link name\n"</span>));
00643                                 }
00644                                 status = STATUS_OBJECT_NAME_NOT_FOUND;
00645                             }
00646                         }
00647 
00648                         <span class="keywordflow">break</span>;
00649                     }
00650                     <span class="comment">// else</span>
00651                     <span class="comment">//   Not at end, so we'll simply iterate and consume</span>
00652                     <span class="comment">//   the next component.</span>
00653                     <span class="comment">//</span>
00654                     <span class="comment">//</span>
00655                     <span class="comment">// Step through exit portholes here.</span>
00656                     <span class="comment">// This ensures that no KCB is created using</span>
00657                     <span class="comment">// the Exit node.</span>
00658                     <span class="comment">//</span>
00659 
00660                     <a class="code" href="../../d2/d2/cmparse_8c.html#a1">CmpStepThroughExit</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>, Node);
00661 
00662                     <span class="comment">//</span>
00663                     <span class="comment">// Create a kcb for each subkey parsed.</span>
00664                     <span class="comment">//</span>
00665 
00666                     <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a> = <a class="code" href="../../d8/d2/cmsubs_8c.html#a20">CmpCreateKeyControlBlock</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
00667                                                    <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>,
00668                                                    Node,
00669                                                    ParentKcb,
00670                                                    <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00671                                                    &amp;NextName);
00672             
00673                     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>  == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00674                         status = STATUS_INSUFFICIENT_RESOURCES;
00675                         <span class="keywordflow">goto</span> FreeAndReturn;
00676                         <span class="comment">//</span>
00677                         <span class="comment">// Currently, the kcb has one extra reference conut to be decremented.</span>
00678                         <span class="comment">// So, remember it so we can dereference it properly.</span>
00679                         <span class="comment">//</span>
00680                     }
00681                     <span class="comment">//</span>
00682                     <span class="comment">// Now we have created a kcb for the next level,</span>
00683                     <span class="comment">// the kcb in the previous level is no longer needed.</span>
00684                     <span class="comment">// Dereference the parent kcb.</span>
00685                     <span class="comment">//</span>
00686                     <a class="code" href="../../d8/d2/cmsubs_8c.html#a22">CmpDereferenceKeyControlBlock</a>(ParentKcb);
00687 
00688                     ParentKcb = <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>;
00689 
00690 
00691                 } <span class="keywordflow">else</span> {
00692                     <span class="comment">//</span>
00693                     <span class="comment">// We did not find a key matching the name, but no</span>
00694                     <span class="comment">// unexpected error occured</span>
00695                     <span class="comment">//</span>
00696 
00697                     <span class="keywordflow">if</span> ((Last == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) &amp;&amp; (ARGUMENT_PRESENT(lcontext))) {
00698 
00699 CreateChild:
00700                         <span class="comment">//</span>
00701                         <span class="comment">// Only unfound component is last one, and operation</span>
00702                         <span class="comment">// is a create, so perform the create.</span>
00703                         <span class="comment">//</span>
00704 
00705                         <span class="comment">//</span>
00706                         <span class="comment">// There are two possibilities here.  The normal one</span>
00707                         <span class="comment">// is that we are simply creating a new node.</span>
00708                         <span class="comment">//</span>
00709                         <span class="comment">// The abnormal one is that we are creating a root</span>
00710                         <span class="comment">// node that is linked to the main hive.  In this</span>
00711                         <span class="comment">// case, we must create the link.  Once the link is</span>
00712                         <span class="comment">// created, we can check to see if the root node</span>
00713                         <span class="comment">// exists, then either create it or open it as</span>
00714                         <span class="comment">// necessary.</span>
00715                         <span class="comment">//</span>
00716                         <span class="comment">// CmpCreateLinkNode creates the link, and calls</span>
00717                         <span class="comment">// back to CmpDoCreate or CmpDoOpen to create or open</span>
00718                         <span class="comment">// the root node as appropriate.</span>
00719                         <span class="comment">//</span>
00720 
00721                         <span class="keywordflow">if</span> (lcontext-&gt;<a class="code" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html#o4">CreateLink</a>) {
00722                             status = <a class="code" href="../../d2/d2/cmparse_8c.html#a19">CmpCreateLinkNode</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
00723                                                        <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>,
00724                                                        AccessState,
00725                                                        NextName,
00726                                                        AccessMode,
00727                                                        Attributes,
00728                                                        lcontext,
00729                                                        ParentKcb,
00730                                                        Object);
00731 
00732                         } <span class="keywordflow">else</span> {
00733 
00734                             <span class="keywordflow">if</span> ( (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> == &amp;(<a class="code" href="../../d1/d0/cmchek_8c.html#a2">CmpMasterHive</a>-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>)) &amp;&amp;
00735                                  (<a class="code" href="../../d6/d0/cmdat_8c.html#a64">CmpNoMasterCreates</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) ) {
00736                                 <span class="comment">//</span>
00737                                 <span class="comment">// attempting to create a cell in the master</span>
00738                                 <span class="comment">// hive, and not a link, so blow out of here,</span>
00739                                 <span class="comment">// since it wouldn't work anyway.</span>
00740                                 <span class="comment">//</span>
00741                                 status = STATUS_INVALID_PARAMETER;
00742                                 <span class="keywordflow">break</span>;
00743                             }
00744 
00745                             status = <a class="code" href="../../d3/d2/cmparse2_8c.html#a1">CmpDoCreate</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
00746                                                  <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>,
00747                                                  AccessState,
00748                                                  &amp;NextName,
00749                                                  AccessMode,
00750                                                  lcontext,
00751                                                  ParentKcb,
00752                                                  Object);
00753                         }
00754 
00755                         lcontext-&gt;<a class="code" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html#o3">Disposition</a> = REG_CREATED_NEW_KEY;
00756                         <span class="keywordflow">break</span>;
00757 
00758                     } <span class="keywordflow">else</span> {
00759 
00760                         <span class="comment">//</span>
00761                         <span class="comment">// Did not find a key to match the component, and</span>
00762                         <span class="comment">// are not at the end of the path.  Thus, open must</span>
00763                         <span class="comment">// fail because the whole path dosn't exist, create must</span>
00764                         <span class="comment">// fail because more than 1 component doesn't exist.</span>
00765                         <span class="comment">//</span>
00766                         <span class="comment">//</span>
00767                         <span class="comment">// We have a lookup failure here, so having additional information</span>
00768                         <span class="comment">// about this kcb may help us not to go through all the code just to fail again.</span>
00769                         <span class="comment">// </span>
00770                         ParentKcb = <a class="code" href="../../d2/d2/cmparse_8c.html#a16">CmpAddInfoAfterParseFailure</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
00771                                                                 <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>,
00772                                                                 Node,
00773                                                                 <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>,
00774                                                                 &amp;NextName
00775                                                                 );
00776                         
00777                         status = STATUS_OBJECT_NAME_NOT_FOUND;
00778                         <span class="keywordflow">break</span>;
00779                     }
00780 
00781                 }
00782 
00783             } <span class="keywordflow">else</span> {
00784                 <span class="comment">//</span>
00785                 <span class="comment">// The given key was a symbolic link.  Find the name of</span>
00786                 <span class="comment">// its link, and return STATUS_REPARSE to the Object Manager.</span>
00787                 <span class="comment">//</span>
00788                 Current.Buffer = NextName.Buffer;
00789                 Current.Length += NextName.Length;
00790                 Current.MaximumLength += NextName.MaximumLength;
00791                 <span class="keywordflow">if</span> (<a class="code" href="../../d2/d2/cmparse_8c.html#a17">CmpGetSymbolicLink</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
00792                                        Node,
00793                                        CompleteName,
00794                                        <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>,
00795                                        &amp;Current)) {
00796 
00797                     status = STATUS_REPARSE;
00798                     <span class="keywordflow">break</span>;
00799 
00800                 } <span class="keywordflow">else</span> {
00801                     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a22">CML_MAJOR</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a31">CMS_PARSE</a>) {
00802                         KdPrint((<span class="stringliteral">"CmpParseKey: couldn't find symbolic link name\n"</span>));
00803                     }
00804                     status = STATUS_OBJECT_NAME_NOT_FOUND;
00805                     <span class="keywordflow">break</span>;
00806                 }
00807             }
00808 
00809         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (rc == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> &amp;&amp; Last == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00810             <span class="comment">//</span>
00811             <span class="comment">// We will open the \Registry root.</span>
00812             <span class="comment">// Or some strange remaining name that</span>
00813             <span class="comment">// screw up the lookup.</span>
00814             <span class="comment">//</span>
00815             <a class="code" href="../../d2/d2/cmparse_8c.html#a1">CmpStepThroughExit</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>, Node);
00816 
00817             <span class="comment">//</span>
00818             <span class="comment">// We have found the entire path, so we want to open</span>
00819             <span class="comment">// it (for both Open and Create calls).</span>
00820             <span class="comment">// Hive,Cell -&gt; the key we are supposed to open.</span>
00821             <span class="comment">//</span>
00822             status = <a class="code" href="../../d2/d2/cmparse_8c.html#a18">CmpDoOpen</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
00823                                <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>,
00824                                Node,
00825                                AccessState,
00826                                AccessMode,
00827                                Attributes,
00828                                lcontext,
00829                                <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00830                                &amp;<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>,
00831                                &amp;NextName,
00832                                Object);
00833             <span class="keywordflow">break</span>;
00834 
00835         } <span class="keywordflow">else</span> {
00836 
00837             <span class="comment">//</span>
00838             <span class="comment">// bogus path -&gt; fail</span>
00839             <span class="comment">//</span>
00840             status = STATUS_INVALID_PARAMETER;
00841             <span class="keywordflow">break</span>;
00842         }
00843 
00844     } <span class="comment">// while</span>
00845 
00846 FreeAndReturn:
00847     <span class="comment">//</span>
00848     <span class="comment">// Now we have to free the last kcb that still has one extra reference count to</span>
00849     <span class="comment">// protect it from being freed.</span>
00850     <span class="comment">//</span>
00851 
00852     <a class="code" href="../../d8/d2/cmsubs_8c.html#a22">CmpDereferenceKeyControlBlock</a>(ParentKcb);
00853 JustReturn:
00854 
00855     <span class="keywordflow">return</span> status;
00856 }
00857 
00858 
00859 BOOLEAN
<a name="l00860"></a><a class="code" href="../../d2/d2/cmparse_8c.html#a21">00860</a> <a class="code" href="../../d2/d2/cmparse_8c.html#a21">CmpGetNextName</a>(
00861     IN OUT PUNICODE_STRING  RemainingName,
00862     OUT    PUNICODE_STRING  NextName,
00863     OUT    PBOOLEAN  Last
00864     )
00865 <span class="comment">/*++</span>
00866 <span class="comment"></span>
00867 <span class="comment">Routine Description:</span>
00868 <span class="comment"></span>
00869 <span class="comment">    This routine parses off the next component of a registry path, returning</span>
00870 <span class="comment">    all of the interesting state about it, including whether it's legal.</span>
00871 <span class="comment"></span>
00872 <span class="comment">Arguments:</span>
00873 <span class="comment"></span>
00874 <span class="comment">    Current - supplies pointer to variable which points to path to parse.</span>
00875 <span class="comment">              on input - parsing starts from here</span>
00876 <span class="comment">              on output - updated to reflect starting position for next call.</span>
00877 <span class="comment"></span>
00878 <span class="comment">    NextName - supplies pointer to a unicode_string, which will be set up</span>
00879 <span class="comment">               to point into the parse string.</span>
00880 <span class="comment"></span>
00881 <span class="comment">    Last - supplies a pointer to a boolean - set to TRUE if this is the</span>
00882 <span class="comment">           last component of the name being parse, FALSE otherwise.</span>
00883 <span class="comment"></span>
00884 <span class="comment">Return Value:</span>
00885 <span class="comment"></span>
00886 <span class="comment">    TRUE if all is well.</span>
00887 <span class="comment"></span>
00888 <span class="comment">    FALSE if illegal name (too long component, bad character, etc.)</span>
00889 <span class="comment">        (if false, all out parameter values are bogus.)</span>
00890 <span class="comment"></span>
00891 <span class="comment">--*/</span>
00892 {
00893     BOOLEAN rc = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00894 
00895     <span class="comment">//</span>
00896     <span class="comment">// Deal with NULL paths, and pointers to NULL paths</span>
00897     <span class="comment">//</span>
00898     <span class="keywordflow">if</span> ((RemainingName-&gt;Buffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) || (RemainingName-&gt;Length == 0)) {
00899         *Last = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00900         NextName-&gt;Buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00901         NextName-&gt;Length = 0;
00902         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00903     }
00904 
00905     <span class="keywordflow">if</span> (*(RemainingName-&gt;Buffer) == UNICODE_NULL) {
00906         *Last = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00907         NextName-&gt;Buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00908         NextName-&gt;Length = 0;
00909         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00910     }
00911 
00912     <span class="comment">//</span>
00913     <span class="comment">// Skip over leading path separators</span>
00914     <span class="comment">//</span>
00915     <span class="keywordflow">if</span> (*(RemainingName-&gt;Buffer) == OBJ_NAME_PATH_SEPARATOR) {
00916         RemainingName-&gt;Buffer++;
00917         RemainingName-&gt;Length -= <span class="keyword">sizeof</span>(WCHAR);
00918         RemainingName-&gt;MaximumLength -= <span class="keyword">sizeof</span>(WCHAR);
00919     }
00920 
00921     <span class="comment">//</span>
00922     <span class="comment">// Remember where the component starts, and scan to the end</span>
00923     <span class="comment">//</span>
00924     NextName-&gt;Buffer = RemainingName-&gt;Buffer;
00925     <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00926         <span class="keywordflow">if</span> (RemainingName-&gt;Length == 0) {
00927             <span class="keywordflow">break</span>;
00928         }
00929         <span class="keywordflow">if</span> (*RemainingName-&gt;Buffer == OBJ_NAME_PATH_SEPARATOR) {
00930             <span class="keywordflow">break</span>;
00931         }
00932 
00933         <span class="comment">//</span>
00934         <span class="comment">// NOT at end</span>
00935         <span class="comment">// NOT another path sep</span>
00936         <span class="comment">//</span>
00937 
00938         RemainingName-&gt;Buffer++;
00939         RemainingName-&gt;Length -= <span class="keyword">sizeof</span>(WCHAR);
00940         RemainingName-&gt;MaximumLength -= <span class="keyword">sizeof</span>(WCHAR);
00941     }
00942 
00943     <span class="comment">//</span>
00944     <span class="comment">// Compute component length, return error if it's illegal</span>
00945     <span class="comment">//</span>
00946     NextName-&gt;Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)
00947         ((PUCHAR)RemainingName-&gt;Buffer - (PUCHAR)(NextName-&gt;Buffer));
00948     <span class="keywordflow">if</span> (NextName-&gt;Length &gt; <a class="code" href="../../d9/d0/cmdata_8h.html#a1">MAX_KEY_NAME_LENGTH</a>)
00949     {
00950         rc = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00951     }
00952     NextName-&gt;MaximumLength = NextName-&gt;Length;
00953 
00954     <span class="comment">//</span>
00955     <span class="comment">// Set last, return success</span>
00956     <span class="comment">//</span>
00957     *Last = (RemainingName-&gt;Length == 0);
00958     <span class="keywordflow">return</span> rc;
00959 }
00960 
00961 
00962 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00963"></a><a class="code" href="../../d2/d2/cmparse_8c.html#a18">00963</a> <a class="code" href="../../d2/d2/cmparse_8c.html#a18">CmpDoOpen</a>(
00964     IN <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> Hive,
00965     IN HCELL_INDEX Cell,
00966     IN <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> Node,
00967     IN <a class="code" href="../../d2/d5/struct__ACCESS__STATE.html">PACCESS_STATE</a> AccessState,
00968     IN KPROCESSOR_MODE AccessMode,
00969     IN ULONG Attributes,
00970     IN <a class="code" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html">PCM_PARSE_CONTEXT</a> Context,
00971     IN BOOLEAN  CompleteKeyCached,
00972     IN OUT <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>  *CachedKcb,
00973     IN PUNICODE_STRING KeyName,
00974     OUT PVOID *Object
00975     )
00976 <span class="comment">/*++</span>
00977 <span class="comment"></span>
00978 <span class="comment">Routine Description:</span>
00979 <span class="comment"></span>
00980 <span class="comment">    Open a registry key, create a keycontrol block.</span>
00981 <span class="comment"></span>
00982 <span class="comment">Arguments:</span>
00983 <span class="comment"></span>
00984 <span class="comment">    Hive - supplies a pointer to the hive control structure for the hive</span>
00985 <span class="comment"></span>
00986 <span class="comment">    Cell - supplies index of node to delete</span>
00987 <span class="comment"></span>
00988 <span class="comment">    AccessState - Running security access state information for operation.</span>
00989 <span class="comment"></span>
00990 <span class="comment">    AccessMode - Access mode of the original caller.</span>
00991 <span class="comment"></span>
00992 <span class="comment">    Attributes - Attributes to be applied to the object.</span>
00993 <span class="comment"></span>
00994 <span class="comment">    Context - if create or hive root open, points to a CM_PARSE_CONTEXT</span>
00995 <span class="comment">              structure,</span>
00996 <span class="comment">              if open, is NULL.</span>
00997 <span class="comment"></span>
00998 <span class="comment">    CompleteKeyCached - BOOLEAN to indicate it the completekey is cached.</span>
00999 <span class="comment"></span>
01000 <span class="comment">    CachedKcb - If the completekey is cached, this is the kcb for the destination.</span>
01001 <span class="comment">                If not, this is the parent kcb.</span>
01002 <span class="comment"></span>
01003 <span class="comment">    KeyName - Relative name (to BaseName)</span>
01004 <span class="comment"></span>
01005 <span class="comment">    Object - The address of a variable to receive the created key object, if</span>
01006 <span class="comment">             any.</span>
01007 <span class="comment"></span>
01008 <span class="comment">Return Value:</span>
01009 <span class="comment"></span>
01010 <span class="comment">    NTSTATUS</span>
01011 <span class="comment"></span>
01012 <span class="comment">--*/</span>
01013 {
01014     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status;
01015     <a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a> pbody;
01016     <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>;
01017     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>   mode;
01018     BOOLEAN BackupRestore;
01019 
01020     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a24">CML_FLOW</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a31">CMS_PARSE</a>) {
01021         KdPrint((<span class="stringliteral">"CmpDoOpen:\n"</span>));
01022     }
01023     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(Context)) {
01024 
01025         <span class="comment">//</span>
01026         <span class="comment">// It's a create of some sort</span>
01027         <span class="comment">//</span>
01028         <span class="keywordflow">if</span> (Context-&gt;CreateLink) {
01029             <span class="comment">//</span>
01030             <span class="comment">// The node already exists as a regular key, so it cannot be</span>
01031             <span class="comment">// turned into a link node.</span>
01032             <span class="comment">//</span>
01033             <span class="keywordflow">return</span> STATUS_ACCESS_DENIED;
01034 
01035         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Context-&gt;CreateOptions &amp; REG_OPTION_CREATE_LINK) {
01036             <span class="comment">//</span>
01037             <span class="comment">// Attempt to create a symbolic link has hit an existing key</span>
01038             <span class="comment">// so return an error</span>
01039             <span class="comment">//</span>
01040             <span class="keywordflow">return</span> STATUS_OBJECT_NAME_COLLISION;
01041 
01042         } <span class="keywordflow">else</span> {
01043             <span class="comment">//</span>
01044             <span class="comment">// Operation is an open, so set Disposition</span>
01045             <span class="comment">//</span>
01046             Context-&gt;Disposition = REG_OPENED_EXISTING_KEY;
01047         }
01048     }
01049 
01050     <span class="comment">//</span>
01051     <span class="comment">// Check for symbolic link and caller does not want to open a link</span>
01052     <span class="comment">//</span>
01053     <span class="keywordflow">if</span> (CompleteKeyCached) {
01054         <span class="comment">//</span>
01055         <span class="comment">// The complete key is cached.</span>
01056         <span class="comment">//</span>
01057         <span class="keywordflow">if</span> ((*CachedKcb)-&gt;Flags &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a31">KEY_SYM_LINK</a> &amp;&amp; !(Attributes &amp; OBJ_OPENLINK)) {
01058             <span class="comment">//</span>
01059             <span class="comment">// If the key is a symbolic link, check if the link has been resolved.</span>
01060             <span class="comment">// If the link is resolved, change the kcb to the real KCB.</span>
01061             <span class="comment">// Otherwise, return for reparse.</span>
01062             <span class="comment">//</span>
01063             <a class="code" href="../../d1/d2/cmp_8h.html#a16">LOCK_KCB_TREE</a>();
01064             <span class="keywordflow">if</span> ((*CachedKcb)-&gt;ExtFlags &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a12">CM_KCB_SYM_LINK_FOUND</a>) {
01065                 <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a> = (*CachedKcb)-&gt;ValueCache.RealKcb;
01066 
01067                 <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;Delete == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01068                     <span class="comment">//</span>
01069                     <span class="comment">// The real key it pointes to had been deleted.</span>
01070                     <span class="comment">// We have no way of knowing if the key has been recreated.</span>
01071                     <span class="comment">// Just clean up the cache and do a reparse.</span>
01072                     <span class="comment">//</span>
01073                     <a class="code" href="../../d8/d2/cmsubs_8c.html#a16">CmpCleanUpKcbValueCache</a>(*CachedKcb);
01074                     <a class="code" href="../../d1/d2/cmp_8h.html#a17">UNLOCK_KCB_TREE</a>();
01075                     <span class="keywordflow">return</span>(STATUS_REPARSE);
01076                 }
01077 
01078                 <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d2/cmsubs_8c.html#a13">CmpReferenceKeyControlBlock</a>(<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>)) {
01079                     <a class="code" href="../../d1/d2/cmp_8h.html#a17">UNLOCK_KCB_TREE</a>();
01080                     <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
01081                 }
01082             } <span class="keywordflow">else</span> {
01083                 <a class="code" href="../../d1/d2/cmp_8h.html#a17">UNLOCK_KCB_TREE</a>();
01084                 <span class="keywordflow">return</span>(STATUS_REPARSE);
01085             }
01086             <a class="code" href="../../d1/d2/cmp_8h.html#a17">UNLOCK_KCB_TREE</a>();
01087         } <span class="keywordflow">else</span> {
01088             <span class="comment">//</span>
01089             <span class="comment">// Not a symbolic link, increase the reference Count of Kcb.</span>
01090             <span class="comment">//</span>
01091             <a class="code" href="../../d1/d2/cmp_8h.html#a16">LOCK_KCB_TREE</a>();
01092             <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a> = *CachedKcb;
01093             <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d2/cmsubs_8c.html#a13">CmpReferenceKeyControlBlock</a>(<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>)) {
01094                 <a class="code" href="../../d1/d2/cmp_8h.html#a17">UNLOCK_KCB_TREE</a>();
01095                 <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
01096             }
01097             <a class="code" href="../../d1/d2/cmp_8h.html#a17">UNLOCK_KCB_TREE</a>();
01098         }
01099     } <span class="keywordflow">else</span> {
01100             <span class="comment">//</span>
01101             <span class="comment">// The key is not in cache, the CachedKcb is the parentkcb of this</span>
01102             <span class="comment">// key to be opened.</span>
01103             <span class="comment">//</span>
01104 
01105         <span class="keywordflow">if</span> (Node-&gt;Flags &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a31">KEY_SYM_LINK</a> &amp;&amp; !(Attributes &amp; OBJ_OPENLINK)) {
01106             <span class="comment">//</span>
01107             <span class="comment">// Create a KCB for this symbolic key and put it in delay close.</span>
01108             <span class="comment">//</span>
01109             <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a> = <a class="code" href="../../d8/d2/cmsubs_8c.html#a20">CmpCreateKeyControlBlock</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>, Node, *CachedKcb, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>);
01110             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>  == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01111                 <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
01112             }
01113             <a class="code" href="../../d8/d2/cmsubs_8c.html#a22">CmpDereferenceKeyControlBlock</a>(<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>);
01114             *CachedKcb = <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>;
01115             <span class="keywordflow">return</span>(STATUS_REPARSE);
01116         }
01117     
01118         <span class="comment">//</span>
01119         <span class="comment">// If key control block does not exist, and cannot be created, fail,</span>
01120         <span class="comment">// else just increment the ref count (done for us by CreateKeyControlBlock)</span>
01121         <span class="comment">//</span>
01122         <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a> = <a class="code" href="../../d8/d2/cmsubs_8c.html#a20">CmpCreateKeyControlBlock</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>, Node, *CachedKcb, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>);
01123         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>  == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01124             <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
01125         }
01126         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;Delete == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01127     
01128         *CachedKcb = <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>;
01129     }
01130 
01131     <span class="comment">//</span>
01132     <span class="comment">// Allocate the object.</span>
01133     <span class="comment">//</span>
01134     status = <a class="code" href="../../d6/d0/obcreate_8c.html#a5">ObCreateObject</a>(AccessMode,
01135                             <a class="code" href="../../d6/d0/cmdat_8c.html#a66">CmpKeyObjectType</a>,
01136                             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01137                             AccessMode,
01138                             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01139                             <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">CM_KEY_BODY</a>),
01140                             0,
01141                             0,
01142                             Object);
01143 
01144     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(status)) {
01145 
01146         pbody = (<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a>)(*Object);
01147 
01148         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a23">CML_MINOR</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a35">CMS_POOL</a>|<a class="code" href="../../d1/d2/cmp_8h.html#a31">CMS_PARSE</a>) {
01149             KdPrint((<span class="stringliteral">"CmpDoOpen: object allocated at:%08lx\n"</span>, pbody));
01150         }
01151 
01152         <span class="comment">//</span>
01153         <span class="comment">// Check for predefined handle</span>
01154         <span class="comment">//</span>
01155 
01156         pbody = (<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a>)(*Object);
01157 
01158         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;Flags &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a33">KEY_PREDEF_HANDLE</a>) {
01159             pbody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o0">Type</a> = <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;ValueCache.Count;
01160             pbody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o1">KeyControlBlock</a> = <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>;
01161             <span class="keywordflow">return</span>(STATUS_PREDEFINED_HANDLE);
01162         } <span class="keywordflow">else</span> {
01163             <span class="comment">//</span>
01164             <span class="comment">// Fill in CM specific fields in the object</span>
01165             <span class="comment">//</span>
01166             pbody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o0">Type</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a78">KEY_BODY_TYPE</a>;
01167             pbody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o1">KeyControlBlock</a> = <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>;
01168             pbody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o2">NotifyBlock</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01169             pbody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o3">Process</a> = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>();
01170             <a class="code" href="../../d1/d2/cmp_8h.html#a81">ENLIST_KEYBODY_IN_KEYBODY_LIST</a>(pbody);
01171         }
01172 
01173     } <span class="keywordflow">else</span> {
01174 
01175         <span class="comment">//</span>
01176         <span class="comment">// Failed to create object, so undo key control block work</span>
01177         <span class="comment">//</span>
01178         <a class="code" href="../../d8/d2/cmsubs_8c.html#a22">CmpDereferenceKeyControlBlock</a>(<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>);
01179         <span class="keywordflow">return</span> status;
01180     }
01181 
01182     <span class="comment">//</span>
01183     <span class="comment">// Check to make sure the caller can access the key.</span>
01184     <span class="comment">//</span>
01185     BackupRestore = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01186     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(Context)) {
01187         <span class="keywordflow">if</span> (Context-&gt;CreateOptions &amp; REG_OPTION_BACKUP_RESTORE) {
01188             BackupRestore = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01189         }
01190     }
01191 
01192     status = STATUS_SUCCESS;
01193 
01194     <span class="keywordflow">if</span> (BackupRestore == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01195 
01196         <span class="comment">//</span>
01197         <span class="comment">// this is an open to support a backup or restore</span>
01198         <span class="comment">// operation, do the special case work</span>
01199         <span class="comment">//</span>
01200         AccessState-&gt;RemainingDesiredAccess = 0;
01201         AccessState-&gt;PreviouslyGrantedAccess = 0;
01202 
01203         mode = KeGetPreviousMode();
01204 
01205         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d4/privileg_8c.html#a3">SeSinglePrivilegeCheck</a>(<a class="code" href="../../d0/d5/se_8h.html#a94">SeBackupPrivilege</a>, mode)) {
01206             AccessState-&gt;PreviouslyGrantedAccess |=
01207                 KEY_READ | ACCESS_SYSTEM_SECURITY;
01208         }
01209 
01210         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d4/privileg_8c.html#a3">SeSinglePrivilegeCheck</a>(<a class="code" href="../../d0/d5/se_8h.html#a95">SeRestorePrivilege</a>, mode)) {
01211             AccessState-&gt;PreviouslyGrantedAccess |=
01212                 KEY_WRITE | ACCESS_SYSTEM_SECURITY | WRITE_DAC | WRITE_OWNER;
01213         }
01214 
01215         <span class="keywordflow">if</span> (AccessState-&gt;PreviouslyGrantedAccess == 0) {
01216             <span class="comment">//</span>
01217             <span class="comment">// relevent privileges not asserted/possessed, so</span>
01218             <span class="comment">// deref (which will cause CmpDeleteKeyObject to clean up)</span>
01219             <span class="comment">// and return an error.</span>
01220             <span class="comment">//</span>
01221             <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a24">CML_FLOW</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a31">CMS_PARSE</a>) {
01222                 KdPrint((<span class="stringliteral">"CmpDoOpen for backup restore: access denied\n"</span>));
01223             }
01224             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(*Object);
01225             <span class="keywordflow">return</span> STATUS_ACCESS_DENIED;
01226         }
01227 
01228     } <span class="keywordflow">else</span> {
01229 
01230         <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d1/obse_8c.html#a3">ObCheckObjectAccess</a>(*Object,
01231                                   AccessState,
01232                                   <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,         <span class="comment">// Type mutex already locked</span>
01233                                   AccessMode,
01234                                   &amp;status))
01235         {
01236             <span class="comment">//</span>
01237             <span class="comment">// Access denied, so deref object, will cause CmpDeleteKeyObject</span>
01238             <span class="comment">// to be called, it will clean up.</span>
01239             <span class="comment">//</span>
01240             <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a24">CML_FLOW</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a31">CMS_PARSE</a>) {
01241                 KdPrint((<span class="stringliteral">"CmpDoOpen: access denied\n"</span>));
01242             }
01243             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(*Object);
01244         }
01245     }
01246 
01247     <span class="keywordflow">return</span> status;
01248 }
01249 
01250 
01251 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01252"></a><a class="code" href="../../d2/d2/cmparse_8c.html#a19">01252</a> <a class="code" href="../../d2/d2/cmparse_8c.html#a19">CmpCreateLinkNode</a>(
01253     IN <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> Hive,
01254     IN HCELL_INDEX Cell,
01255     IN <a class="code" href="../../d2/d5/struct__ACCESS__STATE.html">PACCESS_STATE</a> AccessState,
01256     IN UNICODE_STRING Name,
01257     IN KPROCESSOR_MODE AccessMode,
01258     IN ULONG Attributes,
01259     IN <a class="code" href="../../d3/d6/struct__CM__PARSE__CONTEXT.html">PCM_PARSE_CONTEXT</a> Context,
01260     IN <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> ParentKcb,
01261     OUT PVOID *Object
01262     )
01263 <span class="comment">/*++</span>
01264 <span class="comment"></span>
01265 <span class="comment">Routine Description:</span>
01266 <span class="comment"></span>
01267 <span class="comment">    Perform the creation of a link node.  Allocate all components,</span>
01268 <span class="comment">    and attach to parent key.  Calls CmpDoCreate or CmpDoOpen to</span>
01269 <span class="comment">    create or open the root node of the hive as appropriate.</span>
01270 <span class="comment"></span>
01271 <span class="comment">    Note that you can only create link nodes in the master hive.</span>
01272 <span class="comment"></span>
01273 <span class="comment">Arguments:</span>
01274 <span class="comment"></span>
01275 <span class="comment">    Hive - supplies a pointer to the hive control structure for the hive</span>
01276 <span class="comment"></span>
01277 <span class="comment">    Cell - supplies index of node to create child under</span>
01278 <span class="comment"></span>
01279 <span class="comment">    Name - supplies pointer to a UNICODE string which is the name of</span>
01280 <span class="comment">            the child to be created.</span>
01281 <span class="comment"></span>
01282 <span class="comment">    AccessMode - Access mode of the original caller.</span>
01283 <span class="comment"></span>
01284 <span class="comment">    Attributes - Attributes to be applied to the object.</span>
01285 <span class="comment"></span>
01286 <span class="comment">    Context - pointer to CM_PARSE_CONTEXT structure passed through</span>
01287 <span class="comment">                the object manager</span>
01288 <span class="comment"></span>
01289 <span class="comment">    BaseName - Name of object create is relative to</span>
01290 <span class="comment"></span>
01291 <span class="comment">    KeyName - Relative name (to BaseName)</span>
01292 <span class="comment"></span>
01293 <span class="comment">    Object - The address of a variable to receive the created key object, if</span>
01294 <span class="comment">             any.</span>
01295 <span class="comment"></span>
01296 <span class="comment">Return Value:</span>
01297 <span class="comment"></span>
01298 <span class="comment">    NTSTATUS</span>
01299 <span class="comment"></span>
01300 <span class="comment">--*/</span>
01301 {
01302     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01303     <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a> Parent;
01304     <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a> Link;
01305     <a class="code" href="../../d4/d9/struct__CELL__DATA.html">PCELL_DATA</a> CellData;
01306     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> LinkCell;
01307     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> KeyCell;
01308     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> ChildCell;
01309     <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a> = ParentKcb;  
01310     <a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a> KeyBody;
01311     LARGE_INTEGER systemtime;
01312 
01313     <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a24">CML_FLOW</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a31">CMS_PARSE</a>) {
01314         KdPrint((<span class="stringliteral">"CmpCreateLinkNode:\n"</span>));
01315     }
01316 
01317     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> != &amp;<a class="code" href="../../d1/d0/cmchek_8c.html#a2">CmpMasterHive</a>-&gt;<a class="code" href="../../d9/d6/struct__CMHIVE.html#o0">Hive</a>) {
01318         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a22">CML_MAJOR</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a31">CMS_PARSE</a>) {
01319             KdPrint((<span class="stringliteral">"CmpCreateLinkNode: attempt to create link node in\n"</span>));
01320             KdPrint((<span class="stringliteral">"    non-master hive %08lx\n"</span>, <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>));
01321         }
01322         <span class="keywordflow">return</span>(STATUS_ACCESS_DENIED);
01323     }
01324 
01325     <span class="comment">//</span>
01326     <span class="comment">// Allocate link node</span>
01327     <span class="comment">//</span>
01328     <span class="comment">// Link nodes are always in the master hive, so their storage type is</span>
01329     <span class="comment">// mostly irrelevent.</span>
01330     <span class="comment">//</span>
01331     LinkCell = <a class="code" href="../../d8/d0/hivecell_8c.html#a16">HvAllocateCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,  <a class="code" href="../../d1/d2/cmp_8h.html#a98">CmpHKeyNodeSize</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, &amp;<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>), <a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>);
01332     <span class="keywordflow">if</span> (LinkCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01333         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
01334     }
01335 
01336     KeyCell = Context-&gt;ChildHive.KeyCell;
01337 
01338     <span class="keywordflow">if</span> (KeyCell != <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01339 
01340         <span class="comment">//</span>
01341         <span class="comment">// This hive already exists, so we just need to open the root node.</span>
01342         <span class="comment">//</span>
01343         ChildCell=KeyCell;
01344 
01345         <span class="comment">//</span>
01346         <span class="comment">// The root cell in the hive does not has the Name buffer </span>
01347         <span class="comment">// space reseverd.  This is why we need to pass in the Name for creating KCB</span>
01348         <span class="comment">// instead of using the name in the keynode.</span>
01349         <span class="comment">//</span>
01350         CellData = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Context-&gt;ChildHive.KeyHive, ChildCell);
01351         CellData-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o4">Parent</a> = LinkCell;
01352         CellData-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o1">Flags</a> |= <a class="code" href="../../d9/d0/cmdata_8h.html#a29">KEY_HIVE_ENTRY</a> | <a class="code" href="../../d9/d0/cmdata_8h.html#a30">KEY_NO_DELETE</a>;
01353         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d2/cmparse_8c.html#a18">CmpDoOpen</a>( Context-&gt;ChildHive.KeyHive,
01354                             KeyCell,
01355                             (<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Context-&gt;ChildHive.KeyHive,KeyCell),
01356                             AccessState,
01357                             AccessMode,
01358                             Attributes,
01359                             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01360                             <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
01361                             &amp;<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>,
01362                             &amp;<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>,
01363                             Object );
01364     } <span class="keywordflow">else</span> {
01365 
01366         <span class="comment">//</span>
01367         <span class="comment">// This is a newly created hive, so we must allocate and initialize</span>
01368         <span class="comment">// the root node.</span>
01369         <span class="comment">//</span>
01370 
01371         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d2/cmparse2_8c.html#a2">CmpDoCreateChild</a>( Context-&gt;ChildHive.KeyHive,
01372                                    <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>,
01373                                    <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
01374                                    AccessState,
01375                                    &amp;<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>,
01376                                    AccessMode,
01377                                    Context,
01378                                    ParentKcb,
01379                                    <a class="code" href="../../d9/d0/cmdata_8h.html#a29">KEY_HIVE_ENTRY</a> | <a class="code" href="../../d9/d0/cmdata_8h.html#a30">KEY_NO_DELETE</a>,
01380                                    &amp;ChildCell,
01381                                    Object );
01382 
01383         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01384 
01385             <span class="comment">//</span>
01386             <span class="comment">// Initialize hive root cell pointer.</span>
01387             <span class="comment">//</span>
01388 
01389             Context-&gt;ChildHive.KeyHive-&gt;BaseBlock-&gt;RootCell = ChildCell;
01390         }
01391 
01392     }
01393     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
01394 
01395         <span class="comment">//</span>
01396         <span class="comment">// Initialize parent and flags.  Note that we do this whether the</span>
01397         <span class="comment">// root has been created or opened, because we are not guaranteed</span>
01398         <span class="comment">// that the link node is always the same cell in the master hive.</span>
01399         <span class="comment">//</span>
01400         CellData = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(Context-&gt;ChildHive.KeyHive, ChildCell);
01401         CellData-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o4">Parent</a> = LinkCell;
01402         CellData-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o1">Flags</a> |= <a class="code" href="../../d9/d0/cmdata_8h.html#a29">KEY_HIVE_ENTRY</a> | <a class="code" href="../../d9/d0/cmdata_8h.html#a30">KEY_NO_DELETE</a>;
01403 
01404         <span class="comment">//</span>
01405         <span class="comment">// Initialize special link node flags and data</span>
01406         <span class="comment">//</span>
01407         Link = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, LinkCell);
01408         Link-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o0">Signature</a> = <a class="code" href="../../d9/d0/cmdata_8h.html#a26">CM_LINK_NODE_SIGNATURE</a>;
01409         Link-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o1">Flags</a> = <a class="code" href="../../d9/d0/cmdata_8h.html#a28">KEY_HIVE_EXIT</a> | <a class="code" href="../../d9/d0/cmdata_8h.html#a30">KEY_NO_DELETE</a>;
01410         Link-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o4">Parent</a> = <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>;
01411         Link-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o16">NameLength</a> = <a class="code" href="../../d1/d2/cmp_8h.html#a317">CmpCopyName</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, Link-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o18">Name</a>, &amp;<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>);
01412         <span class="keywordflow">if</span> (Link-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o16">NameLength</a> &lt; <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>.Length) {
01413             Link-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o1">Flags</a> |= <a class="code" href="../../d9/d0/cmdata_8h.html#a32">KEY_COMP_NAME</a>;
01414         }
01415 
01416         <a class="code" href="../../d7/d0/ke_2miscc_8c.html#a3">KeQuerySystemTime</a>(&amp;systemtime);
01417         Link-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o2">LastWriteTime</a> = systemtime;
01418 
01419         <span class="comment">//</span>
01420         <span class="comment">// Zero out unused fields.</span>
01421         <span class="comment">//</span>
01422         Link-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o5">SubKeyCounts</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>] = 0;
01423         Link-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o5">SubKeyCounts</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>] = 0;
01424         Link-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o6">SubKeyLists</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>] = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
01425         Link-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o6">SubKeyLists</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>] = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
01426         Link-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o7">ValueList</a>.<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o0">Count</a> = 0;
01427         Link-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o7">ValueList</a>.<a class="code" href="../../d7/d9/struct__CHILD__LIST.html#o1">List</a> = <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>;
01428         Link-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o17">ClassLength</a> = 0;
01429 
01430 
01431         <span class="comment">//</span>
01432         <span class="comment">// Fill in the link node's pointer to the root node</span>
01433         <span class="comment">//</span>
01434         Link-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o8">ChildHiveReference</a>.<a class="code" href="../../d5/d5/struct__CM__KEY__REFERENCE.html#o1">KeyHive</a> = Context-&gt;ChildHive.KeyHive;
01435         Link-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o8">ChildHiveReference</a>.<a class="code" href="../../d5/d5/struct__CM__KEY__REFERENCE.html#o0">KeyCell</a> = ChildCell;
01436 
01437         <span class="comment">//</span>
01438         <span class="comment">// Fill in the parent cell's child list</span>
01439         <span class="comment">//</span>
01440         <span class="keywordflow">if</span> (! <a class="code" href="../../d1/d2/cmp_8h.html#a305">CmpAddSubKey</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>, LinkCell)) {
01441             <a class="code" href="../../d8/d0/hivecell_8c.html#a17">HvFreeCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, LinkCell);
01442             <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
01443         }
01444 
01445         <span class="comment">//</span>
01446         <span class="comment">// Update max keyname and class name length fields</span>
01447         <span class="comment">//</span>
01448         Parent = <a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>);
01449 
01450         <span class="comment">//</span>
01451         <span class="comment">// It seem to me that the original code is wrong.</span>
01452         <span class="comment">// Isn't the definition of MaxNameLen just the length of the subkey?</span>
01453         <span class="comment">//</span>
01454         <span class="keywordflow">if</span> (Parent-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o11">MaxNameLen</a> &lt; <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>.Length) {
01455             Parent-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o11">MaxNameLen</a> = <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>.Length;
01456         }
01457 
01458         <span class="keywordflow">if</span> (Parent-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o12">MaxClassLen</a> &lt; Context-&gt;Class.Length) {
01459             Parent-&gt;<a class="code" href="../../d4/d9/struct__CELL__DATA.html#o0">u</a>.<a class="code" href="../../d5/d9/union__CELL__DATA_1_1__u.html#o0">KeyNode</a>.<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o12">MaxClassLen</a> = Context-&gt;Class.Length;
01460         }
01461 
01462         <span class="comment">//</span>
01463         <span class="comment">// If the parent has the subkey info or hint cached, free it.</span>
01464         <span class="comment">//</span>
01465         <a class="code" href="../../d1/d2/cmp_8h.html#a62">ASSERT_CM_LOCK_OWNED_EXCLUSIVE</a>();
01466         KeyBody = (<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html">PCM_KEY_BODY</a>)(*Object);
01467         <a class="code" href="../../d8/d2/cmsubs_8c.html#a15">CmpCleanUpSubKeyInfo</a> (KeyBody-&gt;<a class="code" href="../../d4/d4/struct__CM__KEY__BODY.html#o1">KeyControlBlock</a>-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o9">ParentKcb</a>);
01468 
01469     } <span class="keywordflow">else</span> {
01470         <a class="code" href="../../d8/d0/hivecell_8c.html#a17">HvFreeCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, LinkCell);
01471     }
01472     <span class="keywordflow">return</span>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>);
01473 }
01474 
01475 BOOLEAN
<a name="l01476"></a><a class="code" href="../../d2/d2/cmparse_8c.html#a17">01476</a> <a class="code" href="../../d2/d2/cmparse_8c.html#a17">CmpGetSymbolicLink</a>(
01477     IN <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> Hive,
01478     IN <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a> Node,
01479     IN OUT PUNICODE_STRING ObjectName,
01480     IN OUT <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> SymbolicKcb,
01481     IN PUNICODE_STRING RemainingName OPTIONAL
01482     )
01483 
01484 <span class="comment">/*++</span>
01485 <span class="comment"></span>
01486 <span class="comment">Routine Description:</span>
01487 <span class="comment"></span>
01488 <span class="comment">    This routine extracts the symbolic link name from a key, if it is</span>
01489 <span class="comment">    marked as a symbolic link.</span>
01490 <span class="comment"></span>
01491 <span class="comment">Arguments:</span>
01492 <span class="comment"></span>
01493 <span class="comment">    Hive - Supplies the hive of the key.</span>
01494 <span class="comment"></span>
01495 <span class="comment">    Node - Supplies pointer to the key node</span>
01496 <span class="comment"></span>
01497 <span class="comment">    ObjectName - Supplies the current ObjectName.</span>
01498 <span class="comment">                 Returns the new ObjectName.  If the new name is longer</span>
01499 <span class="comment">                 than the maximum length of the current ObjectName, the</span>
01500 <span class="comment">                 old buffer will be freed and a new buffer allocated.</span>
01501 <span class="comment"></span>
01502 <span class="comment">    RemainingName - Supplies the remaining path.  If present, this will be</span>
01503 <span class="comment">                concatenated with the symbolic link to form the new objectname.</span>
01504 <span class="comment"></span>
01505 <span class="comment">Return Value:</span>
01506 <span class="comment"></span>
01507 <span class="comment">    TRUE - symbolic link succesfully found</span>
01508 <span class="comment"></span>
01509 <span class="comment">    FALSE - Key is not a symbolic link, or an error occurred</span>
01510 <span class="comment"></span>
01511 <span class="comment">--*/</span>
01512 
01513 {
01514     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01515     <a class="code" href="../../d0/d1/hivedata_8h.html#a49">HCELL_INDEX</a> LinkCell;
01516     <a class="code" href="../../d0/d1/hivedata_8h.html#a50">PHCELL_INDEX</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
01517     <a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a> LinkValue;
01518     PWSTR LinkName;
01519     PWSTR NewBuffer;
01520     ULONG Length;
01521     ULONG ValueLength;
01522     <span class="keyword">extern</span> ULONG <a class="code" href="../../d1/d2/cmp_8h.html#a202">CmpHashTableSize</a>; 
01523     <span class="keyword">extern</span> <a class="code" href="../../d0/d5/struct__CM__KEY__HASH.html">PCM_KEY_HASH</a> *<a class="code" href="../../d1/d2/cmp_8h.html#a203">CmpCacheTable</a>;
01524     PUNICODE_STRING ConstructedName;
01525     ULONG  ConvKey=0;
01526     <a class="code" href="../../d0/d5/struct__CM__KEY__HASH.html">PCM_KEY_HASH</a> KeyHash;
01527     <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> RealKcb;
01528     BOOLEAN KcbFound = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01529     ULONG  Cnt;
01530     WCHAR *Cp;
01531     WCHAR *Cp2;
01532     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> TotalLevels;
01533     BOOLEAN FreeConstructedName = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01534     
01535     <a class="code" href="../../d1/d2/cmp_8h.html#a16">LOCK_KCB_TREE</a>();
01536     <span class="keywordflow">if</span> (SymbolicKcb-&gt;ExtFlags &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a12">CM_KCB_SYM_LINK_FOUND</a>) {
01537         <span class="comment">//</span>
01538         <span class="comment">// First see of the real kab for this symbolic name has been found</span>
01539         <span class="comment">// </span>
01540         ConstructedName = <a class="code" href="../../d8/d2/cmsubs_8c.html#a18">CmpConstructName</a>(SymbolicKcb-&gt;ValueCache.RealKcb);
01541         <span class="keywordflow">if</span> (ConstructedName) {
01542             FreeConstructedName = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01543             LinkName = ConstructedName-&gt;Buffer;
01544             ValueLength = ConstructedName-&gt;Length;
01545             Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)ValueLength + <span class="keyword">sizeof</span>(WCHAR);
01546         }
01547     } 
01548     <a class="code" href="../../d1/d2/cmp_8h.html#a17">UNLOCK_KCB_TREE</a>();
01549 
01550     <span class="keywordflow">if</span> (FreeConstructedName == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01551         <span class="comment">//</span>
01552         <span class="comment">// Find the SymbolicLinkValue value.  This is the name of the symbolic link.</span>
01553         <span class="comment">//</span>
01554         LinkCell = <a class="code" href="../../d1/d2/cmp_8h.html#a117">CmpFindValueByName</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
01555                                       Node,
01556                                       &amp;<a class="code" href="../../d8/d9/cmapi_8c.html#a6">CmSymbolicLinkValueName</a>);
01557         <span class="keywordflow">if</span> (LinkCell == <a class="code" href="../../d0/d1/hivedata_8h.html#a6">HCELL_NIL</a>) {
01558             <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a23">CML_MINOR</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a31">CMS_PARSE</a>) {
01559                 KdPrint((<span class="stringliteral">"CmpGetSymbolicLink: couldn't open symbolic link\n"</span>));
01560             }
01561             <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01562         }
01563     
01564         LinkValue = (<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html">PCM_KEY_VALUE</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, LinkCell);
01565     
01566         <span class="keywordflow">if</span> (LinkValue-&gt;<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o4">Type</a> != REG_LINK) {
01567             <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a23">CML_MINOR</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a31">CMS_PARSE</a>) {
01568                 KdPrint((<span class="stringliteral">"CmpGetSymbolicLink: link value is wrong type: %08lx"</span>, LinkValue-&gt;<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o4">Type</a>));
01569             }
01570             <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01571         }
01572     
01573         LinkName = (PWSTR)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, LinkValue-&gt;<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o3">Data</a>);
01574     
01575         <a class="code" href="../../d9/d0/cmdata_8h.html#a38">CmpIsHKeyValueSmall</a>(ValueLength, LinkValue-&gt;<a class="code" href="../../d7/d5/struct__CM__KEY__VALUE.html#o2">DataLength</a>);
01576         Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)ValueLength + <span class="keyword">sizeof</span>(WCHAR);
01577 
01578         <span class="comment">//</span>
01579         <span class="comment">// Now see if we have this kcb cached.</span>
01580         <span class="comment">//</span>
01581         Cp = LinkName;
01582         TotalLevels = 0;
01583         <span class="keywordflow">for</span> (Cnt=0; Cnt&lt;ValueLength; Cnt += <span class="keyword">sizeof</span>(WCHAR)) {
01584             <span class="keywordflow">if</span> (*Cp != OBJ_NAME_PATH_SEPARATOR) {
01585                 ConvKey = 37 * ConvKey + (ULONG) <a class="code" href="../../d6/d6/nls_8c.html#a33">RtlUpcaseUnicodeChar</a>(*Cp);
01586             } <span class="keywordflow">else</span> {
01587                 TotalLevels++;
01588             }
01589             ++Cp;
01590         }
01591 
01592         
01593         KeyHash = <a class="code" href="../../d1/d2/cmp_8h.html#a77">GET_HASH_ENTRY</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a203">CmpCacheTable</a>, ConvKey); 
01594 
01595         <a class="code" href="../../d1/d2/cmp_8h.html#a16">LOCK_KCB_TREE</a>();
01596         <span class="keywordflow">while</span> (KeyHash) {
01597             RealKcb =  CONTAINING_RECORD(KeyHash, <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">CM_KEY_CONTROL_BLOCK</a>, KeyHash);
01598             <span class="keywordflow">if</span> ((ConvKey == KeyHash-&gt;<a class="code" href="../../d0/d5/struct__CM__KEY__HASH.html#o0">ConvKey</a>) &amp;&amp; (TotalLevels == RealKcb-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o16">TotalLevels</a>)) {
01599                 ConstructedName = <a class="code" href="../../d8/d2/cmsubs_8c.html#a18">CmpConstructName</a>(RealKcb);
01600                 <span class="keywordflow">if</span> (ConstructedName) {
01601                     FreeConstructedName = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01602                     <span class="keywordflow">if</span> (ConstructedName-&gt;Length == ValueLength) {
01603                         KcbFound = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01604                         Cp = LinkName;
01605                         Cp2 = ConstructedName-&gt;Buffer;
01606                         <span class="keywordflow">for</span> (Cnt=0; Cnt&lt;ConstructedName-&gt;Length; Cnt += <span class="keyword">sizeof</span>(WCHAR)) {
01607                             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/nls_8c.html#a33">RtlUpcaseUnicodeChar</a>(*Cp) != <a class="code" href="../../d6/d6/nls_8c.html#a33">RtlUpcaseUnicodeChar</a>(*Cp2)) {
01608                                 KcbFound = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01609                                 <span class="keywordflow">break</span>;
01610                             }
01611                             ++Cp;
01612                             ++Cp2;
01613                         }
01614                         <span class="keywordflow">if</span> (KcbFound) {
01615                             <span class="comment">//</span>
01616                             <span class="comment">// Now the RealKcb is also pointed to by its symbolic link Kcb,</span>
01617                             <span class="comment">// Increase the reference count.</span>
01618                             <span class="comment">// Need to dereference the realkcb when the symbolic kcb is removed.</span>
01619                             <span class="comment">// Do this in CmpCleanUpKcbCacheWithLock();</span>
01620                             <span class="comment">//</span>
01621                             <span class="keywordflow">if</span> (<a class="code" href="../../d8/d2/cmsubs_8c.html#a13">CmpReferenceKeyControlBlock</a>(RealKcb)) {
01622                                 <span class="comment">//</span>
01623                                 <span class="comment">// This symbolic kcb may have value lookup for the path</span>
01624                                 <span class="comment">// Cleanup the value cache.</span>
01625                                 <span class="comment">//</span>
01626                                 <a class="code" href="../../d8/d2/cmsubs_8c.html#a16">CmpCleanUpKcbValueCache</a>(SymbolicKcb);
01627     
01628                                 SymbolicKcb-&gt;ExtFlags |= <a class="code" href="../../d9/d0/cmdata_8h.html#a12">CM_KCB_SYM_LINK_FOUND</a>;
01629                                 SymbolicKcb-&gt;ValueCache.RealKcb = RealKcb;
01630                             } <span class="keywordflow">else</span> {
01631                                 <span class="comment">//</span>
01632                                 <span class="comment">// We have maxed out the ref count on the real kcb.</span>
01633                                 <span class="comment">// do not cache the symbolic link.</span>
01634                                 <span class="comment">//</span>
01635                             }
01636                             <span class="keywordflow">break</span>;
01637                         }
01638                     }
01639                 } <span class="keywordflow">else</span> {
01640                     <span class="keywordflow">break</span>;
01641                 }
01642             }
01643             <span class="keywordflow">if</span> (FreeConstructedName) {
01644                 <a class="code" href="../../d5/d8/ex_8h.html#a7">ExFreePoolWithTag</a>(ConstructedName, CM_NAME_TAG | <a class="code" href="../../d5/d8/ex_8h.html#a6">PROTECTED_POOL</a>);
01645                 FreeConstructedName = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01646             }
01647             KeyHash = KeyHash-&gt;<a class="code" href="../../d0/d5/struct__CM__KEY__HASH.html#o1">NextHash</a>;
01648         }
01649         <a class="code" href="../../d1/d2/cmp_8h.html#a17">UNLOCK_KCB_TREE</a>();
01650     }
01651     
01652     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(RemainingName)) {
01653         Length += RemainingName-&gt;Length + <span class="keyword">sizeof</span>(WCHAR);
01654     }
01655 
01656     <span class="comment">//</span>
01657     <span class="comment">// Overflow test: If Length overflows the USHRT_MAX value</span>
01658     <span class="comment">//                cleanup and return FALSE  </span>
01659     <span class="comment">//</span>
01660     <span class="keywordflow">if</span>( Length&gt;0xFFFF ) {
01661         <span class="keywordflow">if</span> (FreeConstructedName) {
01662             <a class="code" href="../../d5/d8/ex_8h.html#a7">ExFreePoolWithTag</a>(ConstructedName, CM_NAME_TAG | <a class="code" href="../../d5/d8/ex_8h.html#a6">PROTECTED_POOL</a>);
01663             FreeConstructedName = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01664         }
01665 
01666         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01667     }
01668 
01669         <span class="keywordflow">if</span> (Length &gt; ObjectName-&gt;MaximumLength) {
01670         UNICODE_STRING NewObjectName;
01671 
01672         <span class="comment">//</span>
01673         <span class="comment">// The new name is too long to fit in the existing ObjectName buffer,</span>
01674         <span class="comment">// so allocate a new buffer.</span>
01675         <span class="comment">//</span>
01676         NewBuffer = <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, Length);
01677         <span class="keywordflow">if</span> (NewBuffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01678             <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a23">CML_MINOR</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a31">CMS_PARSE</a>) {
01679                 KdPrint((<span class="stringliteral">"CmpGetSymbolicLink: couldn't allocate new name buffer\n"</span>));
01680             }
01681             <span class="keywordflow">if</span> (FreeConstructedName) {
01682                 <a class="code" href="../../d5/d8/ex_8h.html#a7">ExFreePoolWithTag</a>(ConstructedName, CM_NAME_TAG | <a class="code" href="../../d5/d8/ex_8h.html#a6">PROTECTED_POOL</a>);
01683                 FreeConstructedName = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01684             }
01685             <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01686         }
01687 
01688         NewObjectName.Buffer = NewBuffer;
01689         NewObjectName.MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)Length;
01690         NewObjectName.Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)ValueLength;
01691         RtlCopyMemory(NewBuffer, LinkName, ValueLength);
01692         <a class="code" href="../../d1/d2/cmp_8h.html#a55">CMLOG</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a24">CML_FLOW</a>, <a class="code" href="../../d1/d2/cmp_8h.html#a31">CMS_PARSE</a>) {
01693             KdPrint((<span class="stringliteral">"CmpGetSymbolicLink: LinkName is %wZ\n"</span>, ObjectName));
01694             <span class="keywordflow">if</span> (ARGUMENT_PRESENT(RemainingName)) {
01695                 KdPrint((<span class="stringliteral">"               RemainingName is %wZ\n"</span>, RemainingName));
01696             } <span class="keywordflow">else</span> {
01697                 KdPrint((<span class="stringliteral">"               RemainingName is NULL\n"</span>));
01698             }
01699         }
01700 
01701         <span class="keywordflow">if</span> (ARGUMENT_PRESENT(RemainingName)) {
01702             NewBuffer[ ValueLength / <span class="keyword">sizeof</span>(WCHAR) ] = OBJ_NAME_PATH_SEPARATOR;
01703             NewObjectName.Length += <span class="keyword">sizeof</span>(WCHAR);
01704             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d6/nls_8c.html#a46">RtlAppendUnicodeStringToString</a>(&amp;NewObjectName, RemainingName);
01705             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>));
01706         }
01707 
01708         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(ObjectName-&gt;Buffer);
01709         *ObjectName = NewObjectName;
01710     } <span class="keywordflow">else</span> {
01711         <span class="comment">//</span>
01712         <span class="comment">// The new name will fit within the maximum length of the existing</span>
01713         <span class="comment">// ObjectName, so do the expansion in-place. Note that the remaining</span>
01714         <span class="comment">// name must be moved into its new position first since the symbolic</span>
01715         <span class="comment">// link may or may not overlap it.</span>
01716         <span class="comment">//</span>
01717         ObjectName-&gt;Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)ValueLength;
01718         <span class="keywordflow">if</span> (ARGUMENT_PRESENT(RemainingName)) {
01719             RtlMoveMemory(&amp;ObjectName-&gt;Buffer[(ValueLength / <span class="keyword">sizeof</span>(WCHAR)) + 1],
01720                           RemainingName-&gt;Buffer,
01721                           RemainingName-&gt;Length);
01722             ObjectName-&gt;Buffer[ValueLength / <span class="keyword">sizeof</span>(WCHAR)] = OBJ_NAME_PATH_SEPARATOR;
01723             ObjectName-&gt;Length += RemainingName-&gt;Length + <span class="keyword">sizeof</span>(WCHAR);
01724         }
01725         RtlCopyMemory(ObjectName-&gt;Buffer, LinkName, ValueLength);
01726     }
01727     ObjectName-&gt;Buffer[ObjectName-&gt;Length / <span class="keyword">sizeof</span>(WCHAR)] = UNICODE_NULL;
01728 
01729     <span class="keywordflow">if</span> (FreeConstructedName) {
01730         <a class="code" href="../../d5/d8/ex_8h.html#a7">ExFreePoolWithTag</a>(ConstructedName, CM_NAME_TAG | <a class="code" href="../../d5/d8/ex_8h.html#a6">PROTECTED_POOL</a>);
01731     }
01732     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01733 }
01734 
01735 
01736 ULONG
<a name="l01737"></a><a class="code" href="../../d2/d2/cmparse_8c.html#a13">01737</a> <a class="code" href="../../d2/d2/cmparse_8c.html#a13">CmpComputeHashValue</a>(
01738     IN PCM_HASH_ENTRY HashStack,
01739     IN OUT ULONG  *TotalSubkeys,
01740     IN ULONG BaseConvKey,
01741     IN PUNICODE_STRING RemainingName
01742     )
01743 
01744 <span class="comment">/*++</span>
01745 <span class="comment"></span>
01746 <span class="comment">Routine Description:</span>
01747 <span class="comment"></span>
01748 <span class="comment">    This routine parses the complete path of a request registry key and calculate</span>
01749 <span class="comment">    the hash value at each level.</span>
01750 <span class="comment"></span>
01751 <span class="comment">Arguments:</span>
01752 <span class="comment"></span>
01753 <span class="comment">    HashStack - Array for filling the hash value of each level.</span>
01754 <span class="comment"></span>
01755 <span class="comment">    TotalSubkeys - a pointer to fill the total number of subkeys</span>
01756 <span class="comment"></span>
01757 <span class="comment">    BaseConvKey - Supplies the convkey for the base key.</span>
01758 <span class="comment"></span>
01759 <span class="comment">    RemainingName - supplies pointer to a unicode_string for RemainingName.</span>
01760 <span class="comment"></span>
01761 <span class="comment">Return Value:</span>
01762 <span class="comment"></span>
01763 <span class="comment">    Number of Levels in RemainingName</span>
01764 <span class="comment"></span>
01765 <span class="comment">--*/</span>
01766 
01767 {
01768     ULONG  TotalRemainingSubkeys=0;
01769     ULONG  TotalKeys=0;
01770     ULONG  ConvKey=BaseConvKey;
01771     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>  Cnt;
01772     WCHAR *Cp;
01773     WCHAR *Begin;
01774     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> Length;
01775 
01776     <span class="keywordflow">if</span> (RemainingName-&gt;Length) {
01777         Cp = RemainingName-&gt;Buffer;
01778         Cnt = RemainingName-&gt;Length;
01779 
01780         <span class="comment">//Skip the leading OBJ_NAME_PATH_SEPARATOR</span>
01781 
01782         <span class="keywordflow">while</span> (*Cp == OBJ_NAME_PATH_SEPARATOR) {
01783             Cp++;
01784             Cnt -= <span class="keyword">sizeof</span>(WCHAR);
01785         }
01786         Begin = Cp;
01787         Length = 0;
01788 
01789         HashStack[TotalRemainingSubkeys].KeyName.Buffer = Cp;
01790 
01791         <span class="keywordflow">while</span> (Cnt){
01792             <span class="keywordflow">if</span> ( *Cp == OBJ_NAME_PATH_SEPARATOR ) {
01793                 <span class="keywordflow">if</span> (TotalRemainingSubkeys &lt; <a class="code" href="../../d2/d2/cmparse_8c.html#a0">CM_HASH_STACK_SIZE</a>) {
01794                     HashStack[TotalRemainingSubkeys].ConvKey = ConvKey;
01795                     <span class="comment">//</span>
01796                     <span class="comment">// Due to the changes in KCB structure, we now only have the subkey name</span>
01797                     <span class="comment">// in the kcb (not the full path).  Change the name in the stack to store</span>
01798                     <span class="comment">// the parse element (each subkey) only.</span>
01799                     <span class="comment">//</span>
01800                     HashStack[TotalRemainingSubkeys].KeyName.Length = Length;
01801                     Length = 0;
01802                     TotalRemainingSubkeys++;
01803                 }
01804 
01805                 TotalKeys++;
01806 
01807                 <span class="comment">//</span>
01808                 <span class="comment">// Now skip over leading path separators</span>
01809                 <span class="comment">// Just in case someone has a RemainingName '..A\\\\B..'</span>
01810                 <span class="comment">//</span>
01811                 <span class="comment">//</span>
01812                 <span class="comment">// We are stripping all OBJ_NAME_PATH_SEPARATOR (The origainl code keep the first one).</span>
01813                 <span class="comment">// so the KeyName.Buffer is set properly.</span>
01814                 <span class="comment">//</span>
01815                 <span class="keywordflow">while</span>(*Cp == OBJ_NAME_PATH_SEPARATOR){
01816                     Cp++;
01817                     Cnt -= <span class="keyword">sizeof</span>(WCHAR);
01818                 }
01819                 HashStack[TotalRemainingSubkeys].KeyName.Buffer = Cp;
01820 
01821             } <span class="keywordflow">else</span> {
01822                 ConvKey = 37 * ConvKey + (ULONG) <a class="code" href="../../d6/d6/nls_8c.html#a33">RtlUpcaseUnicodeChar</a>(*Cp);
01823                 <span class="comment">//</span>
01824                 <span class="comment">// We are stripping all OBJ_NAME_PATH_SEPARATOR in the above code,</span>
01825                 <span class="comment">// we should only move to the next char in the else case.</span>
01826                 <span class="comment">//</span>
01827                 Cp++;
01828                 Cnt -= <span class="keyword">sizeof</span>(WCHAR);
01829                 Length += <span class="keyword">sizeof</span>(WCHAR);
01830             
01831             }
01832 
01833 
01834         }
01835 
01836         <span class="comment">//</span>
01837         <span class="comment">// Since we have stripped off all trailing path separators in CmpParseKey routine,</span>
01838         <span class="comment">// the last char will not be OBJ_NAME_PATH_SEPARATOR.</span>
01839         <span class="comment">//</span>
01840         <span class="keywordflow">if</span> (TotalRemainingSubkeys &lt; <a class="code" href="../../d2/d2/cmparse_8c.html#a0">CM_HASH_STACK_SIZE</a>) {
01841             HashStack[TotalRemainingSubkeys].ConvKey = ConvKey;
01842             HashStack[TotalRemainingSubkeys].KeyName.Length = Length;
01843             TotalRemainingSubkeys++;
01844         }
01845         TotalKeys++;
01846 
01847         (*TotalSubkeys) = TotalKeys;
01848     }
01849 
01850     <span class="keywordflow">return</span>(TotalRemainingSubkeys);
01851 }
01852 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01853"></a><a class="code" href="../../d2/d2/cmparse_8c.html#a14">01853</a> <a class="code" href="../../d2/d2/cmparse_8c.html#a14">CmpCacheLookup</a>(
01854     IN PCM_HASH_ENTRY HashStack,
01855     IN ULONG TotalRemainingSubkeys,
01856     OUT ULONG *MatchRemainSubkeyLevel,
01857     IN OUT <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> *Kcb,
01858     OUT PUNICODE_STRING RemainingName,
01859     OUT <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a> *Hive,
01860     OUT HCELL_INDEX *Cell
01861     )
01862 <span class="comment">/*++</span>
01863 <span class="comment"></span>
01864 <span class="comment">Routine Description:</span>
01865 <span class="comment"></span>
01866 <span class="comment">    This routine Search the cache to find the matching path in the Cache.</span>
01867 <span class="comment"></span>
01868 <span class="comment">Arguments:</span>
01869 <span class="comment"></span>
01870 <span class="comment">    HashStack - Array that has the hash value of each level.</span>
01871 <span class="comment"></span>
01872 <span class="comment">    TotalRemainingSubkeys - Total Subkey counts from base.</span>
01873 <span class="comment"></span>
01874 <span class="comment">    MatchRemainSubkeyLevel - Number of Levels in RemaingName </span>
01875 <span class="comment">                             that matches. (0 if not found)</span>
01876 <span class="comment"></span>
01877 <span class="comment">    kcb - Pointer to the kcb of the basename.</span>
01878 <span class="comment">          Will be changed to the kcb for the new basename.</span>
01879 <span class="comment"></span>
01880 <span class="comment">    RemainingName - Returns remaining name</span>
01881 <span class="comment"></span>
01882 <span class="comment">    Hive - Returns the hive of the cache entry found (if any)</span>
01883 <span class="comment"></span>
01884 <span class="comment">    Cell - Returns the cell of the cache entry found (if any)</span>
01885 <span class="comment"></span>
01886 <span class="comment">Return Value:</span>
01887 <span class="comment"></span>
01888 <span class="comment">    Status</span>
01889 <span class="comment"></span>
01890 <span class="comment">--*/</span>
01891 
01892 {
01893     LONG i;
01894     LONG j;
01895     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> status = STATUS_SUCCESS;
01896     ULONG CurrentLevel;
01897     <a class="code" href="../../d0/d5/struct__CM__KEY__HASH.html">PCM_KEY_HASH</a> Current;
01898     <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> BaseKcb;
01899     <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> CurrentKcb;
01900     <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> ParentKcb;
01901     BOOLEAN Found = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01902 
01903     BaseKcb = *Kcb;
01904     CurrentLevel = TotalRemainingSubkeys + BaseKcb-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o16">TotalLevels</a> + 1;
01905 
01906     <span class="keywordflow">for</span>(i = TotalRemainingSubkeys-1; i&gt;=0; i--) {
01907         <span class="comment">//</span>
01908         <span class="comment">// Try to find the longest path in the cache.</span>
01909         <span class="comment">//</span>
01910         <span class="comment">// First, find the kcb that match the hash value.</span>
01911         <span class="comment">//</span>
01912 
01913         CurrentLevel--; 
01914 
01915         Current = <a class="code" href="../../d1/d2/cmp_8h.html#a77">GET_HASH_ENTRY</a>(<a class="code" href="../../d1/d2/cmp_8h.html#a203">CmpCacheTable</a>, HashStack[i].ConvKey);
01916 
01917         <span class="keywordflow">while</span> (Current) {
01918             <a class="code" href="../../d9/d0/cmdata_8h.html#a6">ASSERT_KEY_HASH</a>(Current);
01919 
01920             <span class="comment">//</span>
01921             <span class="comment">// Check against both the ConvKey and total levels;</span>
01922             <span class="comment">//</span>
01923             CurrentKcb = (CONTAINING_RECORD(Current, <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">CM_KEY_CONTROL_BLOCK</a>, KeyHash));
01924 
01925             <span class="keywordflow">if</span> (CurrentKcb-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o16">TotalLevels</a> == CurrentLevel) {
01926                 <span class="comment">//</span>
01927                 <span class="comment">// The total subkey levels match.</span>
01928                 <span class="comment">// Iterate through the kcb path and compare each subkey.</span>
01929                 <span class="comment">//</span>
01930                 Found = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01931                 ParentKcb = CurrentKcb;
01932                 <span class="keywordflow">for</span> (j=i; j&gt;=0; j--) {
01933                     <span class="keywordflow">if</span> (HashStack[j].ConvKey == ParentKcb-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o3">ConvKey</a>) {
01934                         <span class="comment">//</span>
01935                         <span class="comment">// Convkey matches, compare the string</span>
01936                         <span class="comment">//</span>
01937                         LONG Result;
01938                         UNICODE_STRING  TmpNodeName;
01939 
01940                         <span class="keywordflow">if</span> (ParentKcb-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o10">NameBlock</a>-&gt;<a class="code" href="../../d8/d5/struct__CM__NAME__CONTROL__BLOCK.html#o0">Compressed</a>) {
01941                                Result = <a class="code" href="../../d1/d2/cmp_8h.html#a319">CmpCompareCompressedName</a>(&amp;(HashStack[j].<a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>),
01942                                                                  ParentKcb-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o10">NameBlock</a>-&gt;<a class="code" href="../../d8/d5/struct__CM__NAME__CONTROL__BLOCK.html#o6">Name</a>, 
01943                                                                  ParentKcb-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o10">NameBlock</a>-&gt;<a class="code" href="../../d8/d5/struct__CM__NAME__CONTROL__BLOCK.html#o5">NameLength</a>);
01944                         } <span class="keywordflow">else</span> {
01945                                TmpNodeName.Buffer = ParentKcb-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o10">NameBlock</a>-&gt;<a class="code" href="../../d8/d5/struct__CM__NAME__CONTROL__BLOCK.html#o6">Name</a>;
01946                                TmpNodeName.Length = ParentKcb-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o10">NameBlock</a>-&gt;<a class="code" href="../../d8/d5/struct__CM__NAME__CONTROL__BLOCK.html#o5">NameLength</a>;
01947                                TmpNodeName.MaximumLength = ParentKcb-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o10">NameBlock</a>-&gt;<a class="code" href="../../d8/d5/struct__CM__NAME__CONTROL__BLOCK.html#o5">NameLength</a>;
01948 
01949                                Result = <a class="code" href="../../d6/d6/nls_8c.html#a41">RtlCompareUnicodeString</a> (&amp;(HashStack[j].<a class="code" href="../../d8/d0/rtbatcr_8c.html#a3">KeyName</a>), 
01950                                                                  &amp;TmpNodeName, 
01951                                                                  <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01952                         }
01953 
01954                         <span class="keywordflow">if</span> (Result) {
01955                             Found = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01956                             <span class="keywordflow">break</span>;
01957                         } 
01958                         ParentKcb = ParentKcb-&gt;<a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html#o9">ParentKcb</a>;
01959                     } <span class="keywordflow">else</span> {
01960                         Found = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01961                         <span class="keywordflow">break</span>;
01962                     }
01963                 }
01964                 <span class="keywordflow">if</span> (Found) {
01965                     <span class="comment">//</span>
01966                     <span class="comment">// All remaining key matches.  Now compare the BaseKcb.</span>
01967                     <span class="comment">//</span>
01968                     <span class="keywordflow">if</span> (BaseKcb == ParentKcb) {
01969                         <span class="keywordflow">if</span> (CurrentKcb-&gt;ParentKcb-&gt;Delete) {
01970                             <span class="comment">//</span>
01971                             <span class="comment">// The parentkcb is marked deleted.  </span>
01972                             <span class="comment">// So this must be a fake key created when the parent still existed.</span>
01973                             <span class="comment">// Otherwise it cannot be in the cache</span>
01974                             <span class="comment">//</span>
01975                             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (CurrentKcb-&gt;ExtFlags &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a13">CM_KCB_KEY_NON_EXIST</a>);
01976 
01977                             <span class="comment">//</span>
01978                             <span class="comment">// It is possible that the parent key was deleted but now recreated.</span>
01979                             <span class="comment">// In that case this fake key is not longer valid for the ParentKcb is bad.</span>
01980                             <span class="comment">// We must now remove this fake key out of cache so, if this is a</span>
01981                             <span class="comment">// create operation, we do get hit this kcb in CmpCreateKeyControlBlock. </span>
01982                             <span class="comment">//</span>
01983                             <span class="keywordflow">if</span> (CurrentKcb-&gt;RefCount == 0) {
01984                                 <span class="comment">//</span>
01985                                 <span class="comment">// No one is holding this fake kcb, just delete it.</span>
01986                                 <span class="comment">//</span>
01987                                 <a class="code" href="../../d8/d2/cmsubs_8c.html#a19">CmpRemoveFromDelayedClose</a>(CurrentKcb);
01988                                 <a class="code" href="../../d8/d2/cmsubs_8c.html#a17">CmpCleanUpKcbCacheWithLock</a>(CurrentKcb);
01989                             } <span class="keywordflow">else</span> {
01990                                 <span class="comment">//</span>
01991                                 <span class="comment">// Someone is still holding this fake kcb, </span>
01992                                 <span class="comment">// Mark it as delete and remove it out of cache.</span>
01993                                 <span class="comment">//</span>
01994                                 CurrentKcb-&gt;Delete = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01995                                 <a class="code" href="../../d8/d2/cmsubs_8c.html#a24">CmpRemoveKeyControlBlock</a>(CurrentKcb);
01996                             }
01997                             Found = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01998                             <span class="keywordflow">break</span>;
01999                         }
02000 
02001                         
02002                         <span class="comment">//</span>
02003                         <span class="comment">// We have a match, update the RemainingName.</span>
02004                         <span class="comment">//</span>
02005 
02006                         <span class="comment">//</span>
02007                         <span class="comment">// Skip the leading OBJ_NAME_PATH_SEPARATOR</span>
02008                         <span class="comment">//</span>
02009                         <span class="keywordflow">while</span> ((RemainingName-&gt;Length &gt; 0) &amp;&amp;
02010                                (RemainingName-&gt;Buffer[0] == OBJ_NAME_PATH_SEPARATOR)) {
02011                             RemainingName-&gt;Buffer++;
02012                             RemainingName-&gt;Length -= <span class="keyword">sizeof</span>(WCHAR);
02013                         }
02014 
02015                         <span class="comment">//</span>
02016                         <span class="comment">// Skip all subkeys plus OBJ_NAME_PATH_SEPARATOR</span>
02017                         <span class="comment">//</span>
02018                         <span class="keywordflow">for</span>(j=0; j&lt;=i; j++) {
02019                             RemainingName-&gt;Buffer += HashStack[j].KeyName.Length/<span class="keyword">sizeof</span>(WCHAR) + 1;
02020                             RemainingName-&gt;Length -= HashStack[j].KeyName.Length + <span class="keyword">sizeof</span>(WCHAR);
02021                         }
02022 
02023                         <span class="comment">//</span>
02024                         <span class="comment">// Update the KCB, Hive and Cell.</span>
02025                         <span class="comment">//</span>
02026                         *Kcb = CurrentKcb;
02027                         *<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a> = CurrentKcb-&gt;KeyHive;
02028                         *<a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a> = CurrentKcb-&gt;KeyCell;
02029                         <span class="keywordflow">break</span>;
02030                     } <span class="keywordflow">else</span> {
02031                         Found = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02032                     }
02033                 }
02034             }
02035             Current = Current-&gt;<a class="code" href="../../d0/d5/struct__CM__KEY__HASH.html#o1">NextHash</a>;
02036         }
02037 
02038         <span class="keywordflow">if</span> (Found) {
02039             <span class="keywordflow">break</span>;
02040         }
02041     }
02042     <span class="comment">//</span>
02043     <span class="comment">// Now the kcb will be used in the parse routine.</span>
02044     <span class="comment">// Increase its reference count.</span>
02045     <span class="comment">// Make sure we remember to dereference it at the parse routine.</span>
02046     <span class="comment">//</span>
02047     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d2/cmsubs_8c.html#a13">CmpReferenceKeyControlBlock</a>(*Kcb)) {
02048         status = STATUS_INSUFFICIENT_RESOURCES;
02049     }
02050     *MatchRemainSubkeyLevel = i+1;
02051     <span class="keywordflow">return</span> status;
02052 }
02053 
02054 
02055 <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a>
<a name="l02056"></a><a class="code" href="../../d2/d2/cmparse_8c.html#a16">02056</a> <a class="code" href="../../d2/d2/cmparse_8c.html#a16">CmpAddInfoAfterParseFailure</a>(
02057     <a class="code" href="../../d7/d7/struct__HHIVE.html">PHHIVE</a>          Hive,
02058     HCELL_INDEX     Cell,
02059     <a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html">PCM_KEY_NODE</a>    Node,
02060     <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> kcb,
02061     PUNICODE_STRING NodeName
02062     )
02063 <span class="comment">/*++</span>
02064 <span class="comment"></span>
02065 <span class="comment">Routine Description:</span>
02066 <span class="comment"></span>
02067 <span class="comment">    This routine builds up further information in the cache when parse</span>
02068 <span class="comment">    fails.  The additional information can be</span>
02069 <span class="comment">    1. The key is has no subkey (CM_KCB_NO_SUBKEY).</span>
02070 <span class="comment">    2. The key has a few subkeys, then build the index hint in the cache.</span>
02071 <span class="comment">    3. If lookup failed even we have index hint cached, then create a fake key so</span>
02072 <span class="comment">       we do not fail again.   This is very usful for lookup failure under keys like</span>
02073 <span class="comment">       \registry\machine\software\classes\clsid, which have 1500+ subkeys and lots of</span>
02074 <span class="comment">       them have the smae first four chars.</span>
02075 <span class="comment">       </span>
02076 <span class="comment">       NOTE. Currently we are not seeing too many fake keys being created.</span>
02077 <span class="comment">       We need to monitor this periodly and work out a way to work around if</span>
02078 <span class="comment">       we do create too many fake keys. </span>
02079 <span class="comment">       One solution is to use hash value for index hint (We can do it in the cache only</span>
02080 <span class="comment">       if we need to be backward comparible).</span>
02081 <span class="comment">    </span>
02082 <span class="comment">Arguments:</span>
02083 <span class="comment"></span>
02084 <span class="comment">    Hive - Supplies Hive that holds the key we are creating a KCB for.</span>
02085 <span class="comment"></span>
02086 <span class="comment">    Cell - Supplies Cell that contains the key we are creating a KCB for.</span>
02087 <span class="comment"></span>
02088 <span class="comment">    Node - Supplies pointer to key node.</span>
02089 <span class="comment"></span>
02090 <span class="comment">    KeyName - The KeyName.</span>
02091 <span class="comment"></span>
02092 <span class="comment">Return Value:</span>
02093 <span class="comment"></span>
02094 <span class="comment">    The KCB that CmpParse need to dereference at the end.</span>
02095 <span class="comment">--*/</span>
02096 {
02097 
02098     ULONG TotalSubKeyCounts;
02099     BOOLEAN CreateFakeKcb = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02100     BOOLEAN HintCached;
02101     <a class="code" href="../../d5/d4/struct__CM__KEY__CONTROL__BLOCK.html">PCM_KEY_CONTROL_BLOCK</a> ParentKcb;
02102     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> i,j,k;
02103 
02104     <span class="keywordflow">if</span> (!<a class="code" href="../../d9/d0/cmdata_8h.html#a17">UseFastIndex</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>)) {
02105         <span class="comment">//</span>
02106         <span class="comment">// Older version of hive, do not bother to cache hint.</span>
02107         <span class="comment">//</span>
02108         <span class="keywordflow">return</span> (<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>);
02109     }
02110 
02111     TotalSubKeyCounts = Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o5">SubKeyCounts</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>] + Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o5">SubKeyCounts</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>];
02112 
02113     <span class="keywordflow">if</span> (TotalSubKeyCounts == 0) {
02114         <a class="code" href="../../d1/d2/cmp_8h.html#a16">LOCK_KCB_TREE</a>();
02115         <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;ExtFlags |= <a class="code" href="../../d9/d0/cmdata_8h.html#a9">CM_KCB_NO_SUBKEY</a>;
02116         <a class="code" href="../../d1/d2/cmp_8h.html#a17">UNLOCK_KCB_TREE</a>();
02117     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (TotalSubKeyCounts == 1) {
02118         <a class="code" href="../../d1/d2/cmp_8h.html#a16">LOCK_KCB_TREE</a>();
02119         <span class="keywordflow">if</span> (!(<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;ExtFlags &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a10">CM_KCB_SUBKEY_ONE</a>)) {
02120             <span class="comment">//</span>
02121             <span class="comment">// Build the subkey hint to avoid unnecessary lookups in the index leaf</span>
02122             <span class="comment">//</span>
02123             <a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>   <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
02124             <a class="code" href="../../d2/d4/struct__CM__INDEX.html">PCM_INDEX</a>       Hint;
02125 
02126             <span class="keywordflow">if</span> (Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o5">SubKeyCounts</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>] == 1) {
02127                 <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = (<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o6">SubKeyLists</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>]);
02128             } <span class="keywordflow">else</span> {
02129                 <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = (<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o6">SubKeyLists</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>]);
02130             } 
02131 
02132             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;Signature == <a class="code" href="../../d9/d0/cmdata_8h.html#a20">CM_KEY_FAST_LEAF</a>) {
02133                 <a class="code" href="../../d9/d4/struct__CM__KEY__FAST__INDEX.html">PCM_KEY_FAST_INDEX</a> FastIndex;
02134                 FastIndex = (<a class="code" href="../../d9/d4/struct__CM__KEY__FAST__INDEX.html">PCM_KEY_FAST_INDEX</a>)<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
02135                 Hint = &amp;FastIndex-&gt;<a class="code" href="../../d9/d4/struct__CM__KEY__FAST__INDEX.html#o2">List</a>[0];
02136 
02137                 <span class="keywordflow">for</span> (k=0; k&lt;<a class="code" href="../../d9/d0/cmdata_8h.html#a7">CM_SUBKEY_HINT_LENGTH</a>; k++) {
02138                     <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;NameHint[k] = Hint-&gt;<a class="code" href="../../d2/d4/struct__CM__INDEX.html#o1">NameHint</a>[k];
02139                 }
02140 
02141                 <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;ExtFlags |= <a class="code" href="../../d9/d0/cmdata_8h.html#a10">CM_KCB_SUBKEY_ONE</a>;
02142             } 
02143         } <span class="keywordflow">else</span> {
02144             <span class="comment">//</span>
02145             <span class="comment">// The name hint does not prevent from this look up</span>
02146             <span class="comment">// Create the fake Kcb.</span>
02147             <span class="comment">//</span>
02148             CreateFakeKcb = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02149         }
02150         <a class="code" href="../../d1/d2/cmp_8h.html#a17">UNLOCK_KCB_TREE</a>();
02151     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (TotalSubKeyCounts &lt; <a class="code" href="../../d9/d0/cmdata_8h.html#a8">CM_MAX_CACHE_HINT_SIZE</a>) {
02152         <a class="code" href="../../d1/d2/cmp_8h.html#a16">LOCK_KCB_TREE</a>();
02153         <span class="keywordflow">if</span> (!(<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;ExtFlags &amp; <a class="code" href="../../d9/d0/cmdata_8h.html#a11">CM_KCB_SUBKEY_HINT</a>)) {
02154             <span class="comment">//</span>
02155             <span class="comment">// Build the index leaf info in the parent KCB</span>
02156             <span class="comment">// How to sync the cache with the registry data is a problem to be resolved.</span>
02157             <span class="comment">//</span>
02158             ULONG <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
02159             <a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>   <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
02160             <a class="code" href="../../d2/d4/struct__CM__INDEX.html">PCM_INDEX</a>       Hint;
02161             <a class="code" href="../../d9/d4/struct__CM__KEY__FAST__INDEX.html">PCM_KEY_FAST_INDEX</a> FastIndex;
02162             UCHAR           *NameHint;
02163 
02164             <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = <span class="keyword">sizeof</span>(ULONG) * (Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o5">SubKeyCounts</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>] + Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o5">SubKeyCounts</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>] + 1);
02165 
02166             <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;IndexHint = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
02167                                                    <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>,
02168                                                    CM_CACHE_INDEX_TAG | <a class="code" href="../../d5/d8/ex_8h.html#a6">PROTECTED_POOL</a>);
02169 
02170             HintCached = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02171             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;IndexHint) {
02172                 <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;IndexHint-&gt;Count = Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o5">SubKeyCounts</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a75">Stable</a>] + Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o5">SubKeyCounts</a>[<a class="code" href="../../d0/d1/hivedata_8h.html#a77a76">Volatile</a>]; 
02173 
02174                 NameHint = &amp;(<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;IndexHint-&gt;NameHint[0]);
02175 
02176                 <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>-&gt;<a class="code" href="../../d7/d7/struct__HHIVE.html#o20">StorageTypeCount</a>; i++) {
02177                     <span class="keywordflow">if</span>(Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o5">SubKeyCounts</a>[i]) {
02178                         <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = (<a class="code" href="../../d1/d5/struct__CM__KEY__INDEX.html">PCM_KEY_INDEX</a>)<a class="code" href="../../d6/d0/hive_8h.html#a12">HvGetCell</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>, Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o6">SubKeyLists</a>[i]);
02179                         <span class="keywordflow">for</span> (j=0; j&lt;Node-&gt;<a class="code" href="../../d2/d5/struct__CM__KEY__NODE.html#o5">SubKeyCounts</a>[i]; j++) {
02180                             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>-&gt;Signature == <a class="code" href="../../d9/d0/cmdata_8h.html#a20">CM_KEY_FAST_LEAF</a>) {
02181                                 FastIndex = (<a class="code" href="../../d9/d4/struct__CM__KEY__FAST__INDEX.html">PCM_KEY_FAST_INDEX</a>)<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
02182                                 Hint = &amp;FastIndex-&gt;<a class="code" href="../../d9/d4/struct__CM__KEY__FAST__INDEX.html#o2">List</a>[j];
02183                 
02184                                 <span class="keywordflow">for</span> (k=0; k&lt;<a class="code" href="../../d9/d0/cmdata_8h.html#a7">CM_SUBKEY_HINT_LENGTH</a>; k++) {
02185                                     NameHint[k] = Hint-&gt;<a class="code" href="../../d2/d4/struct__CM__INDEX.html#o1">NameHint</a>[k];
02186                                 }
02187                             } <span class="keywordflow">else</span> {
02188                                 HintCached = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02189                                 <span class="keywordflow">break</span>;
02190                             }
02191                             NameHint += <a class="code" href="../../d9/d0/cmdata_8h.html#a7">CM_SUBKEY_HINT_LENGTH</a>;
02192                         }
02193                     }
02194                 }
02195 
02196                 <span class="keywordflow">if</span> (HintCached) {
02197                     <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;ExtFlags |= <a class="code" href="../../d9/d0/cmdata_8h.html#a11">CM_KCB_SUBKEY_HINT</a>;
02198                 } <span class="keywordflow">else</span> {
02199                     <span class="comment">//</span>
02200                     <span class="comment">// Do not have a FAST_LEAF, free the allocation.</span>
02201                     <span class="comment">//</span>
02202                     <a class="code" href="../../d5/d8/ex_8h.html#a7">ExFreePoolWithTag</a>(<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>-&gt;IndexHint, CM_CACHE_INDEX_TAG | <a class="code" href="../../d5/d8/ex_8h.html#a6">PROTECTED_POOL</a>);
02203                 }
02204             }
02205         } <span class="keywordflow">else</span> {
02206             <span class="comment">//</span>
02207             <span class="comment">// The name hint does not prevent from this look up</span>
02208             <span class="comment">// Create the fake Kcb.</span>
02209             <span class="comment">//</span>
02210             CreateFakeKcb = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02211         }
02212         <a class="code" href="../../d1/d2/cmp_8h.html#a17">UNLOCK_KCB_TREE</a>();
02213     } <span class="keywordflow">else</span> {
02214         CreateFakeKcb = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02215     }
02216 
02217     ParentKcb = <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>;
02218 
02219     <span class="keywordflow">if</span> (CreateFakeKcb &amp;&amp; (<a class="code" href="../../d1/d2/cmp_8h.html#a154">CmpCacheOnFlag</a> &amp; <a class="code" href="../../d1/d2/cmp_8h.html#a15">CM_CACHE_FAKE_KEY</a>)) {
02220         <span class="comment">//</span>
02221         <span class="comment">// It has more than a few children but not the one we are interested.</span>
02222         <span class="comment">// Create a kcb for this non-existing key so we do not try to find it</span>
02223         <span class="comment">// again. Use the cell and node from the parent.</span>
02224         <span class="comment">//</span>
02225         <span class="comment">// Before we create a new one. Dereference the current kcb.</span>
02226         <span class="comment">//</span>
02227         <span class="comment">// CmpCacheOnFlag is for us to turn it on/off easily.</span>
02228         <span class="comment">//</span>
02229 
02230         <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a> = <a class="code" href="../../d8/d2/cmsubs_8c.html#a20">CmpCreateKeyControlBlock</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a3">Hive</a>,
02231                                        <a class="code" href="../../d1/d0/cmchek_8c.html#a7">Cell</a>,
02232                                        Node,
02233                                        ParentKcb,
02234                                        <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
02235                                        NodeName);
02236 
02237         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>) {
02238             <a class="code" href="../../d8/d2/cmsubs_8c.html#a22">CmpDereferenceKeyControlBlock</a>(ParentKcb);
02239             ParentKcb = <a class="code" href="../../d4/d6/regext_8c.html#a18">kcb</a>;
02240         }
02241     }
02242 
02243     <span class="keywordflow">return</span> (ParentKcb);
02244 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:28 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
