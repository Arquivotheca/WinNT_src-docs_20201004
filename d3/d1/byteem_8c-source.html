<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: byteem.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>byteem.c</h1><a href="../../d2/d2/byteem_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1995  Digital Equipment Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    byteem.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module implements the code necessary to emulate the new set of Alpha</span>
00012 <span class="comment">    byte and word instructions defined by ECO 81.</span>
00013 <span class="comment"></span>
00014 <span class="comment">    N.B. This file must be compiled without the use of byte/word instructions</span>
00015 <span class="comment">         to avoid fatal recursive exceptions.</span>
00016 <span class="comment"></span>
00017 <span class="comment">Author:</span>
00018 <span class="comment"></span>
00019 <span class="comment">    Wim Colgate (colgate) 18-May-1995</span>
00020 <span class="comment">    Thomas Van Baak (tvb) 18-May-1995</span>
00021 <span class="comment"></span>
00022 <span class="comment">Environment:</span>
00023 <span class="comment"></span>
00024 <span class="comment">    Kernel mode only.</span>
00025 <span class="comment"></span>
00026 <span class="comment">Revision History:</span>
00027 <span class="comment"></span>
00028 <span class="comment">--*/</span>
00029 
00030 <span class="preprocessor">#include "<a class="code" href="../../d0/d0/ki_8h.html">ki.h</a>"</span>
00031 
00032 <span class="comment">//</span>
00033 <span class="comment">// Define function prototypes for emulation routines written in assembler.</span>
00034 <span class="comment">//</span>
00035 
00036 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00037 <a class="code" href="../../d2/d2/byteem_8c.html#a0">KiInterlockedStoreByte</a> (
00038    IN PUCHAR Address,
00039    IN UCHAR Data
00040    );
00041 
00042 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00043 <a class="code" href="../../d2/d2/byteem_8c.html#a1">KiInterlockedStoreWord</a> (
00044    IN PUSHORT Address,
00045    IN USHORT Data
00046    );
00047 
00048 BOOLEAN
<a name="l00049"></a><a class="code" href="../../d2/d2/byteem_8c.html#a2">00049</a> <a class="code" href="../../d2/d2/byteem_8c.html#a2">KiEmulateByteWord</a> (
00050     IN OUT PEXCEPTION_RECORD ExceptionRecord,
00051     IN OUT PKEXCEPTION_FRAME  ExceptionFrame,
00052     IN OUT PKTRAP_FRAME TrapFrame
00053     )
00054 
00055 <span class="comment">/*++</span>
00056 <span class="comment"></span>
00057 <span class="comment">Routine Description:</span>
00058 <span class="comment"></span>
00059 <span class="comment">    This routine emulates Alpha instructions defined by ECO 81. This includes</span>
00060 <span class="comment">    the load byte unsigned, store byte, load word unsigned, store word, sign</span>
00061 <span class="comment">    extend byte, and sign extend word instructions.</span>
00062 <span class="comment"></span>
00063 <span class="comment">    If a misaligned word access is detected the illegal instruction exception</span>
00064 <span class="comment">    record is converted into data misalignment exception record, no emulation</span>
00065 <span class="comment">    is performed, and a value of FALSE is returned. It is expected that the</span>
00066 <span class="comment">    call to this function is followed by a check for a data misalignment</span>
00067 <span class="comment">    exception and a call to the data misalignment emulation function if</span>
00068 <span class="comment">    appropriate.</span>
00069 <span class="comment"></span>
00070 <span class="comment">Arguments:</span>
00071 <span class="comment"></span>
00072 <span class="comment">    ExceptionRecord - Supplies a pointer to the exception record.</span>
00073 <span class="comment"></span>
00074 <span class="comment">    ExceptionFrame - Supplies a pointer to an exception frame.</span>
00075 <span class="comment"></span>
00076 <span class="comment">    TrapFrame - Supplies a pointer to a trap frame.</span>
00077 <span class="comment"></span>
00078 <span class="comment">Return Value:</span>
00079 <span class="comment"></span>
00080 <span class="comment">    A value of TRUE is returned if the instruction is successfully emulated,</span>
00081 <span class="comment">    otherwise a value of FALSE is returned.</span>
00082 <span class="comment"></span>
00083 <span class="comment">--*/</span>
00084 
00085 {
00086     ULONGLONG Data;
00087     ULONGLONG EffectiveAddress;
00088     PVOID ExceptionAddress;
00089     ALPHA_INSTRUCTION Instruction;
00090     KIRQL OldIrql;
00091     <a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a> PreviousMode;
00092 
00093     <span class="comment">//</span>
00094     <span class="comment">// Save original exception address in case another exception occurs.</span>
00095     <span class="comment">//</span>
00096 
00097     ExceptionAddress = ExceptionRecord-&gt;ExceptionAddress;
00098 
00099     <span class="comment">//</span>
00100     <span class="comment">// Any exception that occurs during the attempted emulation will cause</span>
00101     <span class="comment">// the emulation to be aborted. The new exception code and information</span>
00102     <span class="comment">// will be copied to the original exception record and FALSE will be</span>
00103     <span class="comment">// returned. If the memory access was not from kernel mode then probe</span>
00104     <span class="comment">// the effective address before performing the emulation.</span>
00105     <span class="comment">//</span>
00106 
00107     <span class="comment">//</span>
00108     <span class="comment">// Capture previous mode from trap frame not current thread.</span>
00109     <span class="comment">//</span>
00110 
00111     PreviousMode = (<a class="code" href="../../d0/d9/ntosdef_8h.html#a39">KPROCESSOR_MODE</a>)(((<a class="code" href="../../d9/d2/festate_8h.html#a2">PSR</a> *)(&amp;TrapFrame-&gt;Psr))-&gt;MODE);
00112 
00113     <span class="keywordflow">try</span> {
00114 
00115         <span class="comment">//</span>
00116         <span class="comment">// Get faulting instruction and case on instruction type.</span>
00117         <span class="comment">//</span>
00118 
00119         <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00120             <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(ExceptionAddress,
00121                          <span class="keyword">sizeof</span>(ALPHA_INSTRUCTION),
00122                          <span class="keyword">sizeof</span>(ALPHA_INSTRUCTION));
00123         }
00124         Instruction = *((PALPHA_INSTRUCTION)ExceptionAddress);
00125         <span class="keywordflow">switch</span> (Instruction.Memory.Opcode) {
00126 
00127         <span class="comment">//</span>
00128         <span class="comment">// Load/store operations.</span>
00129         <span class="comment">//</span>
00130 
00131         <span class="keywordflow">case</span> LDBU_OP :
00132         <span class="keywordflow">case</span> LDWU_OP :
00133         <span class="keywordflow">case</span> STB_OP :
00134         <span class="keywordflow">case</span> STW_OP :
00135 
00136 
00137             <span class="comment">//</span>
00138             <span class="comment">// Compute effective address and if the address is non-canonical</span>
00139             <span class="comment">// then change the exception code to STATUS_ACCESS_VIOLATION and</span>
00140             <span class="comment">// return FALSE.</span>
00141             <span class="comment">//</span>
00142 
00143             EffectiveAddress = (ULONGLONG)Instruction.Memory.MemDisp +
00144                                <a class="code" href="../../d8/d5/ppc_2getsetrg_8c.html#a0">KiGetRegisterValue</a>(Instruction.Memory.Rb,
00145                                                   ExceptionFrame,
00146                                                   TrapFrame);
00147 
00148             <span class="keywordflow">if</span> (EffectiveAddress != (ULONGLONG)(PVOID)EffectiveAddress) {
00149                 ExceptionRecord-&gt;ExceptionCode = STATUS_ACCESS_VIOLATION;
00150                 ExceptionRecord-&gt;NumberParameters = 0;
00151                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00152             }
00153 
00154             <span class="comment">//</span>
00155             <span class="comment">// Case on individual load/store instruction type.</span>
00156             <span class="comment">//</span>
00157 
00158             <span class="keywordflow">switch</span> (Instruction.Memory.Opcode) {
00159 
00160             <span class="comment">//</span>
00161             <span class="comment">// Load byte unsigned.</span>
00162             <span class="comment">//</span>
00163 
00164             <span class="keywordflow">case</span> LDBU_OP :
00165                 <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00166                     <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>(EffectiveAddress,
00167                                  <span class="keyword">sizeof</span>(UCHAR),
00168                                  <span class="keyword">sizeof</span>(UCHAR));
00169                 }
00170                 Data = (ULONGLONG)*(PUCHAR)EffectiveAddress;
00171                 <a class="code" href="../../d8/d5/ppc_2getsetrg_8c.html#a1">KiSetRegisterValue</a>(Instruction.Memory.Ra,
00172                                    Data,
00173                                    ExceptionFrame,
00174                                    TrapFrame);
00175                 <span class="keywordflow">break</span>;
00176 
00177             <span class="comment">//</span>
00178             <span class="comment">// Load word unsigned.</span>
00179             <span class="comment">//</span>
00180 
00181             <span class="keywordflow">case</span> LDWU_OP :
00182                 <span class="keywordflow">if</span> (EffectiveAddress &amp; 0x1) {
00183                     <span class="keywordflow">goto</span> AlignmentFault;
00184                 }
00185                 <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00186                     <a class="code" href="../../d5/d8/ex_8h.html#a11">ProbeForRead</a>((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a22">PUSHORT</a>)EffectiveAddress,
00187                                  <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>),
00188                                  <span class="keyword">sizeof</span>(UCHAR));
00189                 }
00190                 Data = (ULONGLONG)*(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a22">PUSHORT</a>)EffectiveAddress;
00191                 <a class="code" href="../../d8/d5/ppc_2getsetrg_8c.html#a1">KiSetRegisterValue</a>(Instruction.Memory.Ra,
00192                                    Data,
00193                                    ExceptionFrame,
00194                                    TrapFrame);
00195                 <span class="keywordflow">break</span>;
00196 
00197             <span class="comment">//</span>
00198             <span class="comment">// Store byte.</span>
00199             <span class="comment">//</span>
00200 
00201             <span class="keywordflow">case</span> STB_OP :
00202                 <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00203                     <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>((PUCHAR)EffectiveAddress,
00204                                   <span class="keyword">sizeof</span>(UCHAR),
00205                                   <span class="keyword">sizeof</span>(UCHAR));
00206                 }
00207                 Data = <a class="code" href="../../d8/d5/ppc_2getsetrg_8c.html#a0">KiGetRegisterValue</a>(Instruction.Memory.Ra,
00208                                           ExceptionFrame,
00209                                           TrapFrame);
00210                 <a class="code" href="../../d2/d2/byteem_8c.html#a0">KiInterlockedStoreByte</a>((PUCHAR)EffectiveAddress,
00211                                        (UCHAR)Data);
00212                 <span class="keywordflow">break</span>;
00213 
00214             <span class="comment">//</span>
00215             <span class="comment">// Store word.</span>
00216             <span class="comment">//</span>
00217 
00218             <span class="keywordflow">case</span> STW_OP :
00219                 <span class="keywordflow">if</span> (EffectiveAddress &amp; 0x1) {
00220                     <span class="keywordflow">goto</span> AlignmentFault;
00221                 }
00222                 <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00223                     <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a22">PUSHORT</a>)EffectiveAddress,
00224                                   <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>),
00225                                   <span class="keyword">sizeof</span>(UCHAR));
00226                 }
00227                 Data = <a class="code" href="../../d8/d5/ppc_2getsetrg_8c.html#a0">KiGetRegisterValue</a>(Instruction.Memory.Ra,
00228                                           ExceptionFrame,
00229                                           TrapFrame);
00230                 <a class="code" href="../../d2/d2/byteem_8c.html#a1">KiInterlockedStoreWord</a>((<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a22">PUSHORT</a>)EffectiveAddress,
00231                                        (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)Data);
00232                 <span class="keywordflow">break</span>;
00233             }
00234 
00235             <span class="keywordflow">break</span>;
00236 
00237         <span class="comment">//</span>
00238         <span class="comment">// Sign extend operations.</span>
00239         <span class="comment">//</span>
00240 
00241         <span class="keywordflow">case</span> SEXT_OP :
00242             <span class="keywordflow">switch</span> (Instruction.OpReg.Function) {
00243 
00244             <span class="comment">//</span>
00245             <span class="comment">// Sign extend byte.</span>
00246             <span class="comment">//</span>
00247 
00248             <span class="keywordflow">case</span> SEXTB_FUNC :
00249                 Data = <a class="code" href="../../d8/d5/ppc_2getsetrg_8c.html#a0">KiGetRegisterValue</a>(Instruction.OpReg.Rb,
00250                                           ExceptionFrame,
00251                                           TrapFrame);
00252                 <a class="code" href="../../d8/d5/ppc_2getsetrg_8c.html#a1">KiSetRegisterValue</a>(Instruction.OpReg.Rc,
00253                                    (ULONGLONG)(<a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>)Data,
00254                                    ExceptionFrame,
00255                                    TrapFrame);
00256                 <span class="keywordflow">break</span>;
00257 
00258             <span class="comment">//</span>
00259             <span class="comment">// Sign extend word.</span>
00260             <span class="comment">//</span>
00261 
00262             <span class="keywordflow">case</span> SEXTW_FUNC :
00263                 Data = <a class="code" href="../../d8/d5/ppc_2getsetrg_8c.html#a0">KiGetRegisterValue</a>(Instruction.OpReg.Rb,
00264                                           ExceptionFrame,
00265                                           TrapFrame);
00266                 <a class="code" href="../../d8/d5/ppc_2getsetrg_8c.html#a1">KiSetRegisterValue</a>(Instruction.OpReg.Rc,
00267                                    (ULONGLONG)(<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a13">SHORT</a>)Data,
00268                                    ExceptionFrame,
00269                                    TrapFrame);
00270                 <span class="keywordflow">break</span>;
00271 
00272             <span class="comment">//</span>
00273             <span class="comment">// All other functions are not emulated.</span>
00274             <span class="comment">//</span>
00275 
00276             <span class="keywordflow">default</span> :
00277                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00278             }
00279 
00280             <span class="keywordflow">break</span>;
00281 
00282         <span class="comment">//</span>
00283         <span class="comment">// All other instructions are not emulated.</span>
00284         <span class="comment">//</span>
00285 
00286         <span class="keywordflow">default</span> :
00287             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00288         }
00289 
00290 <span class="preprocessor">#if 0</span>
00291 <span class="preprocessor"></span>        <span class="comment">//</span>
00292         <span class="comment">// Call out to profile interrupt if byte/word emulation profiling is</span>
00293         <span class="comment">// active.</span>
00294         <span class="comment">//</span>
00295 
00296         <span class="keywordflow">if</span> (KiProfileByteWordEmulation != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00297             <span class="keywordflow">if</span> (++KiProfileByteWordEmulationCount &gt;=
00298                 KiProfileByteWordEmulationInterval) {
00299 
00300                 <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a56">PROFILE_LEVEL</a>, &amp;OldIrql);
00301                 KiProfileByteWordEmulationCount = 0;
00302                 <a class="code" href="../../d1/d9/clock_8c.html#a6">KeProfileInterruptWithSource</a>(TrapFrame,
00303                                              ProfileByteWordEmulation);
00304                 <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>(OldIrql);
00305             }
00306         }
00307 <span class="preprocessor">#endif</span>
00308 <span class="preprocessor"></span>
00309         TrapFrame-&gt;Fir += 4;
00310 
00311         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00312 
00313     } except (<a class="code" href="../../d2/d9/ppc_2exceptn_8c.html#a12">KiCopyInformation</a>(ExceptionRecord,
00314                                 (GetExceptionInformation())-&gt;ExceptionRecord)) {
00315 
00316         <span class="comment">//</span>
00317         <span class="comment">// Preserve the original exception address.</span>
00318         <span class="comment">//</span>
00319 
00320         ExceptionRecord-&gt;ExceptionAddress = ExceptionAddress;
00321 
00322         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00323     }
00324 
00325 AlignmentFault :
00326 
00327     <span class="comment">//</span>
00328     <span class="comment">// A misaligned word access has been encountered. Change the illegal</span>
00329     <span class="comment">// instruction exception record into data misalignment exception record</span>
00330     <span class="comment">// (the format is defined by PALcode) and return FALSE.</span>
00331     <span class="comment">//</span>
00332 
00333     ExceptionRecord-&gt;ExceptionCode = STATUS_DATATYPE_MISALIGNMENT;
00334     ExceptionRecord-&gt;NumberParameters = 3;
00335     ExceptionRecord-&gt;ExceptionInformation[0] = Instruction.Memory.Opcode;
00336     ExceptionRecord-&gt;ExceptionInformation[1] = Instruction.Memory.Ra;
00337     ExceptionRecord-&gt;ExceptionInformation[2] = (ULONG)EffectiveAddress;
00338 
00339     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00340 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:19 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
