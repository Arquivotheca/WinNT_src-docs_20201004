<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: pool.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>pool.c</h1><a href="../../d2/d2/ex_2pool_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989-1994  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    pool.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module implements the NT executive pool allocator.</span>
00012 <span class="comment"></span>
00013 <span class="comment">Author:</span>
00014 <span class="comment"></span>
00015 <span class="comment">    Mark Lucovsky     16-feb-1989</span>
00016 <span class="comment">    Lou Perazzoli     31-Aug-1991 (change from binary buddy)</span>
00017 <span class="comment">    David N. Cutler (davec) 27-May-1994</span>
00018 <span class="comment">    Landy Wang        17-Oct-1997</span>
00019 <span class="comment"></span>
00020 <span class="comment">Environment:</span>
00021 <span class="comment"></span>
00022 <span class="comment">    Kernel mode only</span>
00023 <span class="comment"></span>
00024 <span class="comment">Revision History:</span>
00025 <span class="comment"></span>
00026 <span class="comment">--*/</span>
00027 
00028 <span class="preprocessor">#include "<a class="code" href="../../d4/d0/exp_8h.html">exp.h</a>"</span>
00029 
00030 <span class="preprocessor">#pragma hdrstop</span>
00031 <span class="preprocessor"></span>
00032 <span class="preprocessor">#undef ExAllocatePoolWithTag</span>
00033 <span class="preprocessor"></span><span class="preprocessor">#undef ExAllocatePool</span>
00034 <span class="preprocessor"></span><span class="preprocessor">#undef ExAllocatePoolWithQuota</span>
00035 <span class="preprocessor"></span><span class="preprocessor">#undef ExAllocatePoolWithQuotaTag</span>
00036 <span class="preprocessor"></span><span class="preprocessor">#undef ExFreePoolWithTag</span>
00037 <span class="preprocessor"></span>
00038 <span class="preprocessor">#if defined (_WIN64)</span>
00039 <span class="preprocessor"></span><span class="preprocessor">#define POOL_QUOTA_ENABLED (TRUE)</span>
00040 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l00041"></a><a class="code" href="../../d2/d2/ex_2pool_8c.html#a0">00041</a> <span class="preprocessor"></span><span class="preprocessor">#define POOL_QUOTA_ENABLED (PoolTrackTable == NULL)</span>
00042 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00043 <span class="preprocessor"></span>
00044 <span class="comment">//</span>
00045 <span class="comment">// These bitfield definitions are based on EX_POOL_PRIORITY in inc\ex.h.</span>
00046 <span class="comment">//</span>
00047 
<a name="l00048"></a><a class="code" href="../../d2/d2/ex_2pool_8c.html#a1">00048</a> <span class="preprocessor">#define POOL_SPECIAL_POOL_BIT               0x8</span>
<a name="l00049"></a><a class="code" href="../../d2/d2/ex_2pool_8c.html#a2">00049</a> <span class="preprocessor"></span><span class="preprocessor">#define POOL_SPECIAL_POOL_UNDERRUN_BIT      0x1</span>
00050 <span class="preprocessor"></span>
00051 <span class="comment">//</span>
00052 <span class="comment">// FREE_CHECK_ERESOURCE - If enabled causes each free pool to verify</span>
00053 <span class="comment">// no active ERESOURCEs are in the pool block being freed.</span>
00054 <span class="comment">//</span>
00055 <span class="comment">// FREE_CHECK_KTIMER - If enabled causes each free pool to verify no</span>
00056 <span class="comment">// active KTIMERs are in the pool block being freed.</span>
00057 <span class="comment">//</span>
00058 
00059 <span class="preprocessor">#if DBG</span>
00060 <span class="preprocessor"></span>
00061 <span class="preprocessor">#define FREE_CHECK_ERESOURCE(Va, NumberOfBytes) \</span>
00062 <span class="preprocessor">            ExpCheckForResource(Va, NumberOfBytes)</span>
00063 <span class="preprocessor"></span>
00064 <span class="preprocessor">#define FREE_CHECK_KTIMER(Va, NumberOfBytes) \</span>
00065 <span class="preprocessor">            KeCheckForTimer(Va, NumberOfBytes)</span>
00066 <span class="preprocessor"></span>
00067 <span class="preprocessor">#define FREE_CHECK_WORKER(Va, NumberOfBytes) \</span>
00068 <span class="preprocessor">            ExpCheckForWorker(Va, NumberOfBytes)</span>
00069 <span class="preprocessor"></span>
00070 <span class="preprocessor">#else</span>
00071 <span class="preprocessor"></span>
<a name="l00072"></a><a class="code" href="../../d2/d2/ex_2pool_8c.html#a3">00072</a> <span class="preprocessor">#define FREE_CHECK_ERESOURCE(Va, NumberOfBytes)</span>
<a name="l00073"></a><a class="code" href="../../d2/d2/ex_2pool_8c.html#a4">00073</a> <span class="preprocessor"></span><span class="preprocessor">#define FREE_CHECK_KTIMER(Va, NumberOfBytes)</span>
<a name="l00074"></a><a class="code" href="../../d2/d2/ex_2pool_8c.html#a5">00074</a> <span class="preprocessor"></span><span class="preprocessor">#define FREE_CHECK_WORKER(Va, NumberOfBytes)</span>
00075 <span class="preprocessor"></span>
00076 <span class="preprocessor">#endif</span>
00077 <span class="preprocessor"></span>
00078 
00079 <span class="preprocessor">#if defined(_ALPHA_) &amp;&amp; !defined(_AXP64_)</span>
00080 <span class="preprocessor"></span>
00081 <span class="comment">//</span>
00082 <span class="comment">// On Alpha32, Entry-&gt;PoolType cannot be updated without</span>
00083 <span class="comment">// synchronizing with updates to Entry-&gt;PreviousSize.</span>
00084 <span class="comment">// Otherwise, the lack of byte granularity can cause one</span>
00085 <span class="comment">// update to get lost.</span>
00086 <span class="comment">//</span>
00087 
00088 <span class="preprocessor">#define _POOL_LOCK_GRANULAR_ 1</span>
00089 <span class="preprocessor"></span>
00090 <span class="preprocessor">#define LOCK_POOL_GRANULAR(PoolDesc, LockHandle)        \</span>
00091 <span class="preprocessor">            LOCK_POOL(PoolDesc, LockHandle);</span>
00092 <span class="preprocessor"></span>
00093 <span class="preprocessor">#define UNLOCK_POOL_GRANULAR(PoolDesc, LockHandle)      \</span>
00094 <span class="preprocessor">            UNLOCK_POOL(PoolDesc, LockHandle);</span>
00095 <span class="preprocessor"></span>
00096 <span class="preprocessor">#else</span>
00097 <span class="preprocessor"></span>
<a name="l00098"></a><a class="code" href="../../d2/d2/ex_2pool_8c.html#a6">00098</a> <span class="preprocessor">#define LOCK_POOL_GRANULAR(PoolDesc, LockHandle)</span>
<a name="l00099"></a><a class="code" href="../../d2/d2/ex_2pool_8c.html#a7">00099</a> <span class="preprocessor"></span><span class="preprocessor">#define UNLOCK_POOL_GRANULAR(PoolDesc, LockHandle)</span>
00100 <span class="preprocessor"></span>
00101 <span class="preprocessor">#endif</span>
00102 <span class="preprocessor"></span>
00103 
00104 <span class="comment">//</span>
00105 <span class="comment">// We redefine the LIST_ENTRY macros to have each pointer biased</span>
00106 <span class="comment">// by one so any rogue code using these pointers will access</span>
00107 <span class="comment">// violate.  See \nt\public\sdk\inc\ntrtl.h for the original</span>
00108 <span class="comment">// definition of these macros.</span>
00109 <span class="comment">//</span>
00110 <span class="comment">// This is turned off in the shipping product.</span>
00111 <span class="comment">//</span>
00112 
00113 <span class="preprocessor">#ifndef NO_POOL_CHECKS</span>
00114 <span class="preprocessor"></span>
<a name="l00115"></a><a class="code" href="../../d2/d2/ex_2pool_8c.html#a39">00115</a> ULONG <a class="code" href="../../d2/d2/ex_2pool_8c.html#a39">ExpPoolBugCheckLine</a>;
00116 
00117 PVOID
00118 <a class="code" href="../../d1/d6/allocpag_8c.html#a38">MmSqueezeBadTags</a> (
00119     IN SIZE_T NumberOfBytes,
00120     IN ULONG Tag,
00121     IN POOL_TYPE PoolType,
00122     IN ULONG SpecialPoolType
00123     );
00124 
<a name="l00125"></a><a class="code" href="../../d2/d2/ex_2pool_8c.html#a8">00125</a> <span class="preprocessor">#define DecodeLink(Link) ((PLIST_ENTRY)((ULONG_PTR)(Link) &amp; ~1))</span>
<a name="l00126"></a><a class="code" href="../../d2/d2/ex_2pool_8c.html#a9">00126</a> <span class="preprocessor"></span><span class="preprocessor">#define EncodeLink(Link) ((PLIST_ENTRY)((ULONG_PTR)(Link) |  1))</span>
00127 <span class="preprocessor"></span>
<a name="l00128"></a><a class="code" href="../../d2/d2/ex_2pool_8c.html#a10">00128</a> <span class="preprocessor">#define PrivateInitializeListHead(ListHead) (                     \</span>
00129 <span class="preprocessor">    (ListHead)-&gt;Flink = (ListHead)-&gt;Blink = EncodeLink(ListHead))</span>
00130 <span class="preprocessor"></span>
<a name="l00131"></a><a class="code" href="../../d2/d2/ex_2pool_8c.html#a11">00131</a> <span class="preprocessor">#define PrivateIsListEmpty(ListHead)              \</span>
00132 <span class="preprocessor">    (DecodeLink((ListHead)-&gt;Flink) == (ListHead))</span>
00133 <span class="preprocessor"></span>
<a name="l00134"></a><a class="code" href="../../d2/d2/ex_2pool_8c.html#a12">00134</a> <span class="preprocessor">#define PrivateRemoveHeadList(ListHead)                     \</span>
00135 <span class="preprocessor">    DecodeLink((ListHead)-&gt;Flink);                          \</span>
00136 <span class="preprocessor">    {PrivateRemoveEntryList(DecodeLink((ListHead)-&gt;Flink))}</span>
00137 <span class="preprocessor"></span>
<a name="l00138"></a><a class="code" href="../../d2/d2/ex_2pool_8c.html#a13">00138</a> <span class="preprocessor">#define PrivateRemoveTailList(ListHead)                     \</span>
00139 <span class="preprocessor">    DecodeLink((ListHead)-&gt;Blink);                          \</span>
00140 <span class="preprocessor">    {PrivateRemoveEntryList(DecodeLink((ListHead)-&gt;Blink))}</span>
00141 <span class="preprocessor"></span>
<a name="l00142"></a><a class="code" href="../../d2/d2/ex_2pool_8c.html#a14">00142</a> <span class="preprocessor">#define PrivateRemoveEntryList(Entry) {       \</span>
00143 <span class="preprocessor">    PLIST_ENTRY _EX_Blink;                    \</span>
00144 <span class="preprocessor">    PLIST_ENTRY _EX_Flink;                    \</span>
00145 <span class="preprocessor">    _EX_Flink = DecodeLink((Entry)-&gt;Flink);   \</span>
00146 <span class="preprocessor">    _EX_Blink = DecodeLink((Entry)-&gt;Blink);   \</span>
00147 <span class="preprocessor">    _EX_Blink-&gt;Flink = EncodeLink(_EX_Flink); \</span>
00148 <span class="preprocessor">    _EX_Flink-&gt;Blink = EncodeLink(_EX_Blink); \</span>
00149 <span class="preprocessor">    }</span>
00150 <span class="preprocessor"></span>
<a name="l00151"></a><a class="code" href="../../d2/d2/ex_2pool_8c.html#a15">00151</a> <span class="preprocessor">#define PrivateInsertTailList(ListHead,Entry) {  \</span>
00152 <span class="preprocessor">    PLIST_ENTRY _EX_Blink;                       \</span>
00153 <span class="preprocessor">    PLIST_ENTRY _EX_ListHead;                    \</span>
00154 <span class="preprocessor">    _EX_ListHead = (ListHead);                   \</span>
00155 <span class="preprocessor">    _EX_Blink = DecodeLink(_EX_ListHead-&gt;Blink); \</span>
00156 <span class="preprocessor">    (Entry)-&gt;Flink = EncodeLink(_EX_ListHead);   \</span>
00157 <span class="preprocessor">    (Entry)-&gt;Blink = EncodeLink(_EX_Blink);      \</span>
00158 <span class="preprocessor">    _EX_Blink-&gt;Flink = EncodeLink(Entry);        \</span>
00159 <span class="preprocessor">    _EX_ListHead-&gt;Blink = EncodeLink(Entry);     \</span>
00160 <span class="preprocessor">    }</span>
00161 <span class="preprocessor"></span>
<a name="l00162"></a><a class="code" href="../../d2/d2/ex_2pool_8c.html#a16">00162</a> <span class="preprocessor">#define PrivateInsertHeadList(ListHead,Entry) {  \</span>
00163 <span class="preprocessor">    PLIST_ENTRY _EX_Flink;                       \</span>
00164 <span class="preprocessor">    PLIST_ENTRY _EX_ListHead;                    \</span>
00165 <span class="preprocessor">    _EX_ListHead = (ListHead);                   \</span>
00166 <span class="preprocessor">    _EX_Flink = DecodeLink(_EX_ListHead-&gt;Flink); \</span>
00167 <span class="preprocessor">    (Entry)-&gt;Flink = EncodeLink(_EX_Flink);      \</span>
00168 <span class="preprocessor">    (Entry)-&gt;Blink = EncodeLink(_EX_ListHead);   \</span>
00169 <span class="preprocessor">    _EX_Flink-&gt;Blink = EncodeLink(Entry);        \</span>
00170 <span class="preprocessor">    _EX_ListHead-&gt;Flink = EncodeLink(Entry);     \</span>
00171 <span class="preprocessor">    }</span>
00172 <span class="preprocessor"></span>
<a name="l00173"></a><a class="code" href="../../d2/d2/ex_2pool_8c.html#a17">00173</a> <span class="preprocessor">#define CHECK_LIST(LINE,LIST,ENTRY)                                         \</span>
00174 <span class="preprocessor">    if ((DecodeLink(DecodeLink((LIST)-&gt;Flink)-&gt;Blink) != (LIST)) ||         \</span>
00175 <span class="preprocessor">        (DecodeLink(DecodeLink((LIST)-&gt;Blink)-&gt;Flink) != (LIST))) {         \</span>
00176 <span class="preprocessor">            ExpPoolBugCheckLine = LINE;                                     \</span>
00177 <span class="preprocessor">            KeBugCheckEx (BAD_POOL_HEADER,                                  \</span>
00178 <span class="preprocessor">                          3,                                                \</span>
00179 <span class="preprocessor">                          (ULONG_PTR)LIST,                                  \</span>
00180 <span class="preprocessor">                          (ULONG_PTR)DecodeLink(DecodeLink((LIST)-&gt;Flink)-&gt;Blink),     \</span>
00181 <span class="preprocessor">                          (ULONG_PTR)DecodeLink(DecodeLink((LIST)-&gt;Blink)-&gt;Flink));    \</span>
00182 <span class="preprocessor">    }</span>
00183 <span class="preprocessor"></span>
<a name="l00184"></a><a class="code" href="../../d2/d2/ex_2pool_8c.html#a18">00184</a> <span class="preprocessor">#define CHECK_POOL_HEADER(LINE,ENTRY) {                                                 \</span>
00185 <span class="preprocessor">    PPOOL_HEADER PreviousEntry;                                                         \</span>
00186 <span class="preprocessor">    PPOOL_HEADER NextEntry;                                                             \</span>
00187 <span class="preprocessor">    if ((ENTRY)-&gt;PreviousSize != 0) {                                                   \</span>
00188 <span class="preprocessor">        PreviousEntry = (PPOOL_HEADER)((PPOOL_BLOCK)(ENTRY) - (ENTRY)-&gt;PreviousSize);   \</span>
00189 <span class="preprocessor">        if ((PreviousEntry-&gt;BlockSize != (ENTRY)-&gt;PreviousSize) ||                      \</span>
00190 <span class="preprocessor">            (DECODE_POOL_INDEX(PreviousEntry) != DECODE_POOL_INDEX(ENTRY))) {           \</span>
00191 <span class="preprocessor">            ExpPoolBugCheckLine = LINE;                                     \</span>
00192 <span class="preprocessor">            KeBugCheckEx(BAD_POOL_HEADER, 5, (ULONG_PTR)PreviousEntry, LINE, (ULONG_PTR)ENTRY); \</span>
00193 <span class="preprocessor">        }                                                                               \</span>
00194 <span class="preprocessor">    }                                                                                   \</span>
00195 <span class="preprocessor">    NextEntry = (PPOOL_HEADER)((PPOOL_BLOCK)(ENTRY) + (ENTRY)-&gt;BlockSize);              \</span>
00196 <span class="preprocessor">    if (!PAGE_END(NextEntry)) {                                                         \</span>
00197 <span class="preprocessor">        if ((NextEntry-&gt;PreviousSize != (ENTRY)-&gt;BlockSize) ||                          \</span>
00198 <span class="preprocessor">            (DECODE_POOL_INDEX(NextEntry) != DECODE_POOL_INDEX(ENTRY))) {               \</span>
00199 <span class="preprocessor">            ExpPoolBugCheckLine = LINE;                                     \</span>
00200 <span class="preprocessor">            KeBugCheckEx(BAD_POOL_HEADER, 5, (ULONG_PTR)NextEntry, LINE, (ULONG_PTR)ENTRY);     \</span>
00201 <span class="preprocessor">        }                                                                               \</span>
00202 <span class="preprocessor">    }                                                                                   \</span>
00203 <span class="preprocessor">}</span>
00204 <span class="preprocessor"></span>
<a name="l00205"></a><a class="code" href="../../d2/d2/ex_2pool_8c.html#a19">00205</a> <span class="preprocessor">#define ASSERT_ALLOCATE_IRQL(_PoolType, _NumberOfBytes)                 \</span>
00206 <span class="preprocessor">    if ((_PoolType &amp; BASE_POOL_TYPE_MASK) == PagedPool) {               \</span>
00207 <span class="preprocessor">        if (KeGetCurrentIrql() &gt; APC_LEVEL) {                           \</span>
00208 <span class="preprocessor">            KeBugCheckEx (BAD_POOL_CALLER, 8, KeGetCurrentIrql(), _PoolType, _NumberOfBytes);                                                           \</span>
00209 <span class="preprocessor">        }                                                               \</span>
00210 <span class="preprocessor">    }                                                                   \</span>
00211 <span class="preprocessor">    else {                                                              \</span>
00212 <span class="preprocessor">        if (KeGetCurrentIrql() &gt; DISPATCH_LEVEL) {                      \</span>
00213 <span class="preprocessor">            KeBugCheckEx (BAD_POOL_CALLER, 8, KeGetCurrentIrql(), _PoolType, _NumberOfBytes);                                                           \</span>
00214 <span class="preprocessor">        }                                                               \</span>
00215 <span class="preprocessor">    }</span>
00216 <span class="preprocessor"></span>
<a name="l00217"></a><a class="code" href="../../d2/d2/ex_2pool_8c.html#a20">00217</a> <span class="preprocessor">#define ASSERT_FREE_IRQL(_PoolType, _P)                                 \</span>
00218 <span class="preprocessor">    if ((_PoolType &amp; BASE_POOL_TYPE_MASK) == PagedPool) {               \</span>
00219 <span class="preprocessor">        if (KeGetCurrentIrql() &gt; APC_LEVEL) {                           \</span>
00220 <span class="preprocessor">            KeBugCheckEx (BAD_POOL_CALLER, 9, KeGetCurrentIrql(), _PoolType, (ULONG_PTR)_P);                                                            \</span>
00221 <span class="preprocessor">        }                                                               \</span>
00222 <span class="preprocessor">    }                                                                   \</span>
00223 <span class="preprocessor">    else {                                                              \</span>
00224 <span class="preprocessor">        if (KeGetCurrentIrql() &gt; DISPATCH_LEVEL) {                      \</span>
00225 <span class="preprocessor">            KeBugCheckEx (BAD_POOL_CALLER, 9, KeGetCurrentIrql(), _PoolType, (ULONG_PTR)P);                                                             \</span>
00226 <span class="preprocessor">        }                                                               \</span>
00227 <span class="preprocessor">    }</span>
00228 <span class="preprocessor"></span>
<a name="l00229"></a><a class="code" href="../../d2/d2/ex_2pool_8c.html#a21">00229</a> <span class="preprocessor">#define ASSERT_POOL_NOT_FREE(_Entry)                                    \</span>
00230 <span class="preprocessor">    if ((_Entry-&gt;PoolType &amp; POOL_TYPE_MASK) == 0) {                     \</span>
00231 <span class="preprocessor">        KeBugCheckEx (BAD_POOL_CALLER, 6, __LINE__, (ULONG_PTR)_Entry, _Entry-&gt;Ulong1);                                                                 \</span>
00232 <span class="preprocessor">    }</span>
00233 <span class="preprocessor"></span>
<a name="l00234"></a><a class="code" href="../../d2/d2/ex_2pool_8c.html#a22">00234</a> <span class="preprocessor">#define ASSERT_POOL_TYPE_NOT_ZERO(_Entry)                               \</span>
00235 <span class="preprocessor">    if (_Entry-&gt;PoolType == 0) {                                        \</span>
00236 <span class="preprocessor">        KeBugCheckEx(BAD_POOL_CALLER, 1, (ULONG_PTR)_Entry, (ULONG_PTR)(*(PULONG)_Entry), 0);                                                           \</span>
00237 <span class="preprocessor">    }</span>
00238 <span class="preprocessor"></span>
<a name="l00239"></a><a class="code" href="../../d2/d2/ex_2pool_8c.html#a23">00239</a> <span class="preprocessor">#define CHECK_LOOKASIDE_LIST(LINE,LIST,ENTRY) {NOTHING;}</span>
00240 <span class="preprocessor"></span>
00241 <span class="preprocessor">#else</span>
00242 <span class="preprocessor"></span>
00243 <span class="preprocessor">#define DecodeLink(Link) ((PLIST_ENTRY)((ULONG_PTR)(Link)))</span>
00244 <span class="preprocessor"></span><span class="preprocessor">#define EncodeLink(Link) ((PLIST_ENTRY)((ULONG_PTR)(Link)))</span>
00245 <span class="preprocessor"></span><span class="preprocessor">#define PrivateInitializeListHead InitializeListHead</span>
00246 <span class="preprocessor"></span><span class="preprocessor">#define PrivateIsListEmpty        IsListEmpty</span>
00247 <span class="preprocessor"></span><span class="preprocessor">#define PrivateRemoveHeadList     RemoveHeadList</span>
00248 <span class="preprocessor"></span><span class="preprocessor">#define PrivateRemoveTailList     RemoveTailList</span>
00249 <span class="preprocessor"></span><span class="preprocessor">#define PrivateRemoveEntryList    RemoveEntryList</span>
00250 <span class="preprocessor"></span><span class="preprocessor">#define PrivateInsertTailList     InsertTailList</span>
00251 <span class="preprocessor"></span><span class="preprocessor">#define PrivateInsertHeadList     InsertHeadList</span>
00252 <span class="preprocessor"></span>
00253 <span class="preprocessor">#define ASSERT_ALLOCATE_IRQL(_PoolType, _P) {NOTHING;}</span>
00254 <span class="preprocessor"></span><span class="preprocessor">#define ASSERT_FREE_IRQL(_PoolType, _P)     {NOTHING;}</span>
00255 <span class="preprocessor"></span><span class="preprocessor">#define ASSERT_POOL_NOT_FREE(_Entry)        {NOTHING;}</span>
00256 <span class="preprocessor"></span><span class="preprocessor">#define ASSERT_POOL_TYPE_NOT_ZERO(_Entry)   {NOTHING;}</span>
00257 <span class="preprocessor"></span>
00258 <span class="comment">//</span>
00259 <span class="comment">// The check list macros come in two flavors - there is one in the checked</span>
00260 <span class="comment">// and free build that will bugcheck the system if a list is ill-formed, and</span>
00261 <span class="comment">// there is one for the final shipping version that has all the checked</span>
00262 <span class="comment">// disabled.</span>
00263 <span class="comment">//</span>
00264 <span class="comment">// The check lookaside list macros also comes in two flavors and is used to</span>
00265 <span class="comment">// verify that the look aside lists are well formed.</span>
00266 <span class="comment">//</span>
00267 <span class="comment">// The check pool header macro (two flavors) verifies that the specified</span>
00268 <span class="comment">// pool header matches the preceeding and succeeding pool headers.</span>
00269 <span class="comment">//</span>
00270 
00271 <span class="preprocessor">#define CHECK_LIST(LINE,LIST,ENTRY)         {NOTHING;}</span>
00272 <span class="preprocessor"></span><span class="preprocessor">#define CHECK_POOL_HEADER(LINE,ENTRY)       {NOTHING;}</span>
00273 <span class="preprocessor"></span>
00274 <span class="preprocessor">#define CHECK_LOOKASIDE_LIST(LINE,LIST,ENTRY) {NOTHING;}</span>
00275 <span class="preprocessor"></span>
00276 <span class="preprocessor">#define CHECK_POOL_PAGE(PAGE) \</span>
00277 <span class="preprocessor">    {                                                                         \</span>
00278 <span class="preprocessor">        PPOOL_HEADER P = (PPOOL_HEADER)(((ULONG_PTR)(PAGE)) &amp; ~(PAGE_SIZE-1));    \</span>
00279 <span class="preprocessor">        ULONG SIZE, LSIZE;                                                    \</span>
00280 <span class="preprocessor">        LOGICAL FOUND=FALSE;                                                  \</span>
00281 <span class="preprocessor">        LSIZE = 0;                                                            \</span>
00282 <span class="preprocessor">        SIZE = 0;                                                             \</span>
00283 <span class="preprocessor">        do {                                                                  \</span>
00284 <span class="preprocessor">            if (P == (PPOOL_HEADER)PAGE) {                                    \</span>
00285 <span class="preprocessor">                FOUND = TRUE;                                                 \</span>
00286 <span class="preprocessor">            }                                                                 \</span>
00287 <span class="preprocessor">            if (P-&gt;PreviousSize != LSIZE) {                                   \</span>
00288 <span class="preprocessor">                DbgPrint("POOL: Inconsistent size: ( %lx ) - %lx-&gt;%u != %u\n",\</span>
00289 <span class="preprocessor">                         PAGE, P, P-&gt;PreviousSize, LSIZE);                    \</span>
00290 <span class="preprocessor">                DbgBreakPoint();                                              \</span>
00291 <span class="preprocessor">            }                                                                 \</span>
00292 <span class="preprocessor">            LSIZE = P-&gt;BlockSize;                                             \</span>
00293 <span class="preprocessor">            SIZE += LSIZE;                                                    \</span>
00294 <span class="preprocessor">            P = (PPOOL_HEADER)((PPOOL_BLOCK)P + LSIZE);                       \</span>
00295 <span class="preprocessor">        } while ((SIZE &lt; (PAGE_SIZE / POOL_SMALLEST_BLOCK)) &amp;&amp;                \</span>
00296 <span class="preprocessor">                 (PAGE_END(P) == FALSE));                                     \</span>
00297 <span class="preprocessor">        if ((PAGE_END(P) == FALSE) || (FOUND == FALSE)) {                     \</span>
00298 <span class="preprocessor">            DbgPrint("POOL: Inconsistent page: %lx\n",P);                     \</span>
00299 <span class="preprocessor">            DbgBreakPoint();                                                  \</span>
00300 <span class="preprocessor">        }                                                                     \</span>
00301 <span class="preprocessor">    }</span>
00302 <span class="preprocessor"></span>
00303 <span class="preprocessor">#endif</span>
00304 <span class="preprocessor"></span>
00305 
00306 
00307 <span class="comment">//</span>
00308 <span class="comment">// Define forward referenced function prototypes.</span>
00309 <span class="comment">//</span>
00310 
00311 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00312 <a class="code" href="../../d4/d2/pool_8h.html#a35">ExpInitializePoolDescriptor</a>(
00313     IN <a class="code" href="../../d4/d8/struct__POOL__DESCRIPTOR.html">PPOOL_DESCRIPTOR</a> PoolDescriptor,
00314     IN POOL_TYPE PoolType,
00315     IN ULONG PoolIndex,
00316     IN ULONG Threshold,
00317     IN PVOID PoolLock
00318     );
00319 
00320 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
00321 <a class="code" href="../../d2/d2/ex_2pool_8c.html#a64">ExpSnapShotPoolPages</a>(
00322     IN PVOID Address,
00323     IN ULONG Size,
00324     IN OUT PSYSTEM_POOL_INFORMATION PoolInformation,
00325     IN OUT PSYSTEM_POOL_ENTRY *PoolEntryInfo,
00326     IN ULONG Length,
00327     IN OUT PULONG RequiredLength
00328     );
00329 
00330 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00331 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT, InitializePool)</span>
00332 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, ExpInitializePoolDescriptor)</span>
00333 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEVRFY, ExAllocatePoolSanityChecks)</span>
00334 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGEVRFY, ExFreePoolSanityChecks)</span>
00335 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(POOLCODE, ExAllocatePoolWithTag)</span>
00336 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(POOLCODE, ExFreePool)</span>
00337 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(POOLCODE, ExFreePoolWithTag)</span>
00338 <span class="preprocessor"></span><span class="preprocessor">#if DBG</span>
00339 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGELK, ExSnapShotPool)</span>
00340 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGELK, ExpSnapShotPoolPages)</span>
00341 <span class="preprocessor"></span><span class="preprocessor">#endif // DBG</span>
00342 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00343 <span class="preprocessor"></span>
<a name="l00344"></a><a class="code" href="../../d2/d2/ex_2pool_8c.html#a24">00344</a> <span class="preprocessor">#define MAX_TRACKER_TABLE   1025</span>
<a name="l00345"></a><a class="code" href="../../d2/d2/ex_2pool_8c.html#a25">00345</a> <span class="preprocessor"></span><span class="preprocessor">#define MAX_BIGPAGE_TABLE   4096</span>
00346 <span class="preprocessor"></span><span class="comment">// #define MAX_TRACKER_TABLE   5</span>
00347 <span class="comment">// #define MAX_BIGPAGE_TABLE   4</span>
00348 
<a name="l00349"></a><a class="code" href="../../d2/d2/ex_2pool_8c.html#a40">00349</a> <a class="code" href="../../d4/d8/struct__POOL__DESCRIPTOR.html">PPOOL_DESCRIPTOR</a> <a class="code" href="../../d2/d2/ex_2pool_8c.html#a40">ExpSessionPoolDescriptor</a>;
<a name="l00350"></a><a class="code" href="../../d2/d2/ex_2pool_8c.html#a41">00350</a> ULONG <a class="code" href="../../d2/d2/ex_2pool_8c.html#a41">FirstPrint</a>;
00351 
<a name="l00352"></a><a class="code" href="../../d2/d2/ex_2pool_8c.html#a42">00352</a> <a class="code" href="../../d2/d9/struct__POOL__TRACKER__TABLE.html">PPOOL_TRACKER_TABLE</a> <a class="code" href="../../d2/d2/ex_2pool_8c.html#a42">PoolTrackTable</a>;
<a name="l00353"></a><a class="code" href="../../d2/d2/ex_2pool_8c.html#a43">00353</a> SIZE_T <a class="code" href="../../d2/d2/ex_2pool_8c.html#a43">PoolTrackTableSize</a>;
<a name="l00354"></a><a class="code" href="../../d2/d2/ex_2pool_8c.html#a44">00354</a> SIZE_T <a class="code" href="../../d2/d2/ex_2pool_8c.html#a44">PoolTrackTableMask</a>;
00355 
<a name="l00356"></a><a class="code" href="../../d2/d2/ex_2pool_8c.html#a45">00356</a> <a class="code" href="../../d1/d9/struct__POOL__TRACKER__BIG__PAGES.html">PPOOL_TRACKER_BIG_PAGES</a> <a class="code" href="../../d2/d2/ex_2pool_8c.html#a45">PoolBigPageTable</a>;
<a name="l00357"></a><a class="code" href="../../d2/d2/ex_2pool_8c.html#a46">00357</a> SIZE_T <a class="code" href="../../d2/d2/ex_2pool_8c.html#a46">PoolBigPageTableSize</a>;
<a name="l00358"></a><a class="code" href="../../d2/d2/ex_2pool_8c.html#a47">00358</a> SIZE_T <a class="code" href="../../d2/d2/ex_2pool_8c.html#a47">PoolBigPageTableHash</a>;
00359 
<a name="l00360"></a><a class="code" href="../../d2/d2/ex_2pool_8c.html#a48">00360</a> ULONG <a class="code" href="../../d2/d2/ex_2pool_8c.html#a48">PoolHitTag</a> = 0xffffff0f;
00361 
00362 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00363 <a class="code" href="../../d2/d2/ex_2pool_8c.html#a65">ExpInsertPoolTracker</a> (
00364     IN ULONG Key,
00365     IN SIZE_T Size,
00366     IN POOL_TYPE PoolType
00367     );
00368 
00369 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00370 <a class="code" href="../../d2/d2/ex_2pool_8c.html#a66">ExpRemovePoolTracker</a> (
00371     IN ULONG Key,
00372     IN ULONG Size,
00373     IN POOL_TYPE PoolType
00374     );
00375 
00376 LOGICAL
00377 <a class="code" href="../../d2/d2/ex_2pool_8c.html#a67">ExpAddTagForBigPages</a> (
00378     IN PVOID Va,
00379     IN ULONG Key,
00380     IN ULONG NumberOfPages
00381     );
00382 
00383 ULONG
00384 <a class="code" href="../../d2/d2/ex_2pool_8c.html#a68">ExpFindAndRemoveTagBigPages</a> (
00385     IN PVOID Va
00386     );
00387 
00388 PVOID
<a name="l00389"></a><a class="code" href="../../d2/d2/ex_2pool_8c.html#a69">00389</a> <a class="code" href="../../d2/d2/ex_2pool_8c.html#a69">ExpAllocateStringRoutine</a>(
00390     IN SIZE_T NumberOfBytes
00391     )
00392 {
00393     <span class="keywordflow">return</span> <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,NumberOfBytes,'grtS');
00394 }
00395 
00396 BOOLEAN
<a name="l00397"></a><a class="code" href="../../d2/d2/ex_2pool_8c.html#a70">00397</a> <a class="code" href="../../d2/d2/ex_2pool_8c.html#a70">ExOkayToLockRoutine</a>(
00398     IN PVOID Lock
00399     )
00400 {
00401     UNREFERENCED_PARAMETER (<a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>);
00402 
00403     <span class="keywordflow">if</span> (KeIsExecutingDpc()) {
00404         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00405     } <span class="keywordflow">else</span> {
00406         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00407     }
00408 }
00409 
<a name="l00410"></a><a class="code" href="../../d2/d2/ex_2pool_8c.html#a49">00410</a> PRTL_ALLOCATE_STRING_ROUTINE <a class="code" href="../../d8/d2/ldrinit_8c.html#a7">RtlAllocateStringRoutine</a> = <a class="code" href="../../d2/d2/ex_2pool_8c.html#a69">ExpAllocateStringRoutine</a>;
<a name="l00411"></a><a class="code" href="../../d2/d2/ex_2pool_8c.html#a50">00411</a> PRTL_FREE_STRING_ROUTINE <a class="code" href="../../d8/d2/ldrinit_8c.html#a8">RtlFreeStringRoutine</a> = (PRTL_FREE_STRING_ROUTINE)<a class="code" href="../../d6/d3/cmwraper_8c.html#a26">ExFreePool</a>;
00412 
00413 <span class="comment">//</span>
00414 <span class="comment">// Define macros to pack and unpack a pool index.</span>
00415 <span class="comment">//</span>
00416 
<a name="l00417"></a><a class="code" href="../../d2/d2/ex_2pool_8c.html#a26">00417</a> <span class="preprocessor">#define ENCODE_POOL_INDEX(POOLHEADER,INDEX) {(POOLHEADER)-&gt;PoolIndex = (UCHAR)((((POOLHEADER)-&gt;PoolIndex &amp; 0x80) | ((UCHAR)(INDEX))));}</span>
<a name="l00418"></a><a class="code" href="../../d2/d2/ex_2pool_8c.html#a27">00418</a> <span class="preprocessor"></span><span class="preprocessor">#define DECODE_POOL_INDEX(POOLHEADER)       ((ULONG)((POOLHEADER)-&gt;PoolIndex &amp; 0x7f))</span>
00419 <span class="preprocessor"></span>
<a name="l00420"></a><a class="code" href="../../d2/d2/ex_2pool_8c.html#a28">00420</a> <span class="preprocessor">#define MARK_POOL_HEADER_ALLOCATED(POOLHEADER)      {(POOLHEADER)-&gt;PoolIndex |= 0x80;}</span>
<a name="l00421"></a><a class="code" href="../../d2/d2/ex_2pool_8c.html#a29">00421</a> <span class="preprocessor"></span><span class="preprocessor">#define MARK_POOL_HEADER_FREED(POOLHEADER)          {(POOLHEADER)-&gt;PoolIndex &amp;= 0x7f;}</span>
<a name="l00422"></a><a class="code" href="../../d2/d2/ex_2pool_8c.html#a30">00422</a> <span class="preprocessor"></span><span class="preprocessor">#define IS_POOL_HEADER_MARKED_ALLOCATED(POOLHEADER) ((POOLHEADER)-&gt;PoolIndex &amp; 0x80)</span>
00423 <span class="preprocessor"></span>
00424 <span class="comment">//</span>
00425 <span class="comment">// Define the number of paged pools. This value may be overridden at boot</span>
00426 <span class="comment">// time.</span>
00427 <span class="comment">//</span>
00428 
<a name="l00429"></a><a class="code" href="../../d2/d2/ex_2pool_8c.html#a51">00429</a> ULONG <a class="code" href="../../d2/d2/ex_2pool_8c.html#a51">ExpNumberOfPagedPools</a> = <a class="code" href="../../d4/d2/pool_8h.html#a4">NUMBER_OF_PAGED_POOLS</a>;
00430 
00431 <span class="comment">//</span>
00432 <span class="comment">// Pool descriptors for nonpaged pool and nonpaged pool must succeed are</span>
00433 <span class="comment">// static. The pool descriptors for paged pool are dynamically allocated</span>
00434 <span class="comment">// since there can be more than one paged pool. There is always one more</span>
00435 <span class="comment">// paged pool descriptor than there are paged pools. This descriptor is</span>
00436 <span class="comment">// used when a page allocation is done for a paged pool and is the first</span>
00437 <span class="comment">// descriptor in the paged pool descriptor array.</span>
00438 <span class="comment">//</span>
00439 
<a name="l00440"></a><a class="code" href="../../d2/d2/ex_2pool_8c.html#a52">00440</a> <a class="code" href="../../d4/d8/struct__POOL__DESCRIPTOR.html">POOL_DESCRIPTOR</a> <a class="code" href="../../d2/d2/ex_2pool_8c.html#a52">NonPagedPoolDescriptor</a>;
<a name="l00441"></a><a class="code" href="../../d2/d2/ex_2pool_8c.html#a53">00441</a> <a class="code" href="../../d4/d8/struct__POOL__DESCRIPTOR.html">POOL_DESCRIPTOR</a> <a class="code" href="../../d2/d2/ex_2pool_8c.html#a53">NonPagedPoolDescriptorMS</a>;
00442 
00443 <span class="comment">//</span>
00444 <span class="comment">// The pool vector contains an array of pointers to pool descriptors. For</span>
00445 <span class="comment">// nonpaged pool and nonpaged pool must succeed, this is a pointer to a</span>
00446 <span class="comment">// single descriptor. For page pool, this is a pointer to an array of pool</span>
00447 <span class="comment">// descriptors. The pointer to the paged pool descriptor is duplicated so</span>
00448 <span class="comment">// if can be found easily by the kernel debugger.</span>
00449 <span class="comment">//</span>
00450 
<a name="l00451"></a><a class="code" href="../../d2/d2/ex_2pool_8c.html#a54">00451</a> <a class="code" href="../../d4/d8/struct__POOL__DESCRIPTOR.html">PPOOL_DESCRIPTOR</a> <a class="code" href="../../d2/d2/ex_2pool_8c.html#a54">PoolVector</a>[<a class="code" href="../../d4/d2/pool_8h.html#a3">NUMBER_OF_POOLS</a>];
<a name="l00452"></a><a class="code" href="../../d2/d2/ex_2pool_8c.html#a55">00452</a> <a class="code" href="../../d4/d8/struct__POOL__DESCRIPTOR.html">PPOOL_DESCRIPTOR</a> <a class="code" href="../../d2/d2/ex_2pool_8c.html#a55">ExpPagedPoolDescriptor</a>;
00453 
<a name="l00454"></a><a class="code" href="../../d2/d2/ex_2pool_8c.html#a56">00454</a> <span class="keyword">extern</span> KSPIN_LOCK <a class="code" href="../../d2/d2/ex_2pool_8c.html#a56">NonPagedPoolLock</a>;
00455 
<a name="l00456"></a><a class="code" href="../../d2/d2/ex_2pool_8c.html#a31">00456</a> <span class="preprocessor">#define ExpLockNonPagedPool(OldIrql) \</span>
00457 <span class="preprocessor">    ExAcquireSpinLock(&amp;NonPagedPoolLock, &amp;OldIrql)</span>
00458 <span class="preprocessor"></span>
<a name="l00459"></a><a class="code" href="../../d2/d2/ex_2pool_8c.html#a32">00459</a> <span class="preprocessor">#define ExpUnlockNonPagedPool(OldIrql) \</span>
00460 <span class="preprocessor">    ExReleaseSpinLock(&amp;NonPagedPoolLock, OldIrql)</span>
00461 <span class="preprocessor"></span>
<a name="l00462"></a><a class="code" href="../../d2/d2/ex_2pool_8c.html#a57">00462</a> <span class="keyword">volatile</span> ULONG <a class="code" href="../../d2/d2/ex_2pool_8c.html#a57">ExpPoolIndex</a> = 1;
<a name="l00463"></a><a class="code" href="../../d2/d2/ex_2pool_8c.html#a58">00463</a> KSPIN_LOCK <a class="code" href="../../d2/d2/ex_2pool_8c.html#a58">ExpTaggedPoolLock</a>;
00464 
00465 <span class="preprocessor">#if DBG</span>
00466 <span class="preprocessor"></span>PSZ PoolTypeNames[<a class="code" href="../../d5/d8/ex_8h.html#a329a180">MaxPoolType</a>] = {
00467     <span class="stringliteral">"NonPaged"</span>,
00468     <span class="stringliteral">"Paged"</span>,
00469     <span class="stringliteral">"NonPagedMustSucceed"</span>,
00470     <span class="stringliteral">"NotUsed"</span>,
00471     <span class="stringliteral">"NonPagedCacheAligned"</span>,
00472     <span class="stringliteral">"PagedCacheAligned"</span>,
00473     <span class="stringliteral">"NonPagedCacheAlignedMustS"</span>
00474     };
00475 
00476 <span class="preprocessor">#endif //DBG</span>
00477 <span class="preprocessor"></span>
00478 
00479 <span class="comment">//</span>
00480 <span class="comment">// Define paged and nonpaged pool lookaside descriptors.</span>
00481 <span class="comment">//</span>
00482 
<a name="l00483"></a><a class="code" href="../../d2/d2/ex_2pool_8c.html#a59">00483</a> <a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html">NPAGED_LOOKASIDE_LIST</a> <a class="code" href="../../d4/d0/exp_8h.html#a12">ExpSmallNPagedPoolLookasideLists</a>[<a class="code" href="../../d0/d9/ntosdef_8h.html#a2">POOL_SMALL_LISTS</a>];
00484 
<a name="l00485"></a><a class="code" href="../../d2/d2/ex_2pool_8c.html#a60">00485</a> <a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html">NPAGED_LOOKASIDE_LIST</a> <a class="code" href="../../d4/d0/exp_8h.html#a11">ExpSmallPagedPoolLookasideLists</a>[<a class="code" href="../../d0/d9/ntosdef_8h.html#a2">POOL_SMALL_LISTS</a>];
00486 
00487 
00488 <span class="comment">//</span>
00489 <span class="comment">// LOCK_POOL and LOCK_IF_PAGED_POOL are only used within this module.</span>
00490 <span class="comment">//</span>
00491 
<a name="l00492"></a><a class="code" href="../../d2/d2/ex_2pool_8c.html#a33">00492</a> <span class="preprocessor">#define LOCK_POOL(PoolDesc, LockHandle) {                                      \</span>
00493 <span class="preprocessor">    if ((PoolDesc-&gt;PoolType &amp; BASE_POOL_TYPE_MASK) == NonPagedPool) {          \</span>
00494 <span class="preprocessor">        ExpLockNonPagedPool(LockHandle);                                       \</span>
00495 <span class="preprocessor">    } else {                                                                   \</span>
00496 <span class="preprocessor">        ExAcquireFastMutex((PFAST_MUTEX)PoolDesc-&gt;LockAddress);                \</span>
00497 <span class="preprocessor">    }                                                                          \</span>
00498 <span class="preprocessor">}</span>
00499 <span class="preprocessor"></span>
<a name="l00500"></a><a class="code" href="../../d2/d2/ex_2pool_8c.html#a34">00500</a> <span class="preprocessor">#define LOCK_IF_PAGED_POOL(_CheckType, _GlobalPool)                            \</span>
00501 <span class="preprocessor">    if (_CheckType == PagedPool &amp;&amp; _GlobalPool == TRUE) {                      \</span>
00502 <span class="preprocessor">        ExAcquireFastMutex((PFAST_MUTEX)PoolVector[PagedPool]-&gt;LockAddress);   \</span>
00503 <span class="preprocessor">    }</span>
00504 <span class="preprocessor"></span>
00505 KIRQL
<a name="l00506"></a><a class="code" href="../../d5/d8/ex_8h.html#a226">00506</a> <a class="code" href="../../d5/d8/ex_8h.html#a226">ExLockPool</a>(
00507     IN POOL_TYPE PoolType
00508     )
00509 
00510 <span class="comment">/*++</span>
00511 <span class="comment"></span>
00512 <span class="comment">Routine Description:</span>
00513 <span class="comment"></span>
00514 <span class="comment">    This function locks the pool specified by pool type.</span>
00515 <span class="comment"></span>
00516 <span class="comment">Arguments:</span>
00517 <span class="comment"></span>
00518 <span class="comment">    PoolType - Specifies the pool that should be locked.</span>
00519 <span class="comment"></span>
00520 <span class="comment">Return Value:</span>
00521 <span class="comment"></span>
00522 <span class="comment">    The previous IRQL is returned as the function value.</span>
00523 <span class="comment"></span>
00524 <span class="comment">--*/</span>
00525 
00526 {
00527 
00528     KIRQL OldIrql;
00529 
00530     <span class="comment">//</span>
00531     <span class="comment">// If the pool type is nonpaged, then use a spinlock to lock the</span>
00532     <span class="comment">// pool. Otherwise, use a fast mutex to lock the pool.</span>
00533     <span class="comment">//</span>
00534 
00535     <span class="keywordflow">if</span> ((PoolType &amp; <a class="code" href="../../d4/d2/pool_8h.html#a5">BASE_POOL_TYPE_MASK</a>) == <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>) {
00536         ExAcquireSpinLock(<a class="code" href="../../d2/d2/ex_2pool_8c.html#a52">NonPagedPoolDescriptor</a>.<a class="code" href="../../d4/d8/struct__POOL__DESCRIPTOR.html#o3">LockAddress</a>, &amp;OldIrql);
00537 
00538     } <span class="keywordflow">else</span> {
00539         ExAcquireFastMutex((<a class="code" href="../../d6/d9/struct__FAST__MUTEX.html">PFAST_MUTEX</a>)<a class="code" href="../../d2/d2/ex_2pool_8c.html#a54">PoolVector</a>[<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>]-&gt;LockAddress);
00540         OldIrql = (KIRQL)((<a class="code" href="../../d6/d9/struct__FAST__MUTEX.html">PFAST_MUTEX</a>)(<a class="code" href="../../d2/d2/ex_2pool_8c.html#a54">PoolVector</a>[<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>]-&gt;<a class="code" href="../../d4/d8/struct__POOL__DESCRIPTOR.html#o3">LockAddress</a>))-&gt;OldIrql;
00541     }
00542 
00543     <span class="keywordflow">return</span> OldIrql;
00544 }
00545 
00546 
00547 <span class="comment">//</span>
00548 <span class="comment">// UNLOCK_POOL and UNLOCK_IF_PAGED_POOL are only used within this module.</span>
00549 <span class="comment">//</span>
00550 
<a name="l00551"></a><a class="code" href="../../d2/d2/ex_2pool_8c.html#a35">00551</a> <span class="preprocessor">#define UNLOCK_POOL(PoolDesc, LockHandle) {                                    \</span>
00552 <span class="preprocessor">    if ((PoolDesc-&gt;PoolType &amp; BASE_POOL_TYPE_MASK) == NonPagedPool) {          \</span>
00553 <span class="preprocessor">        ExpUnlockNonPagedPool((KIRQL)LockHandle);                              \</span>
00554 <span class="preprocessor">    } else {                                                                   \</span>
00555 <span class="preprocessor">        ExReleaseFastMutex((PFAST_MUTEX)PoolDesc-&gt;LockAddress);                \</span>
00556 <span class="preprocessor">    }                                                                          \</span>
00557 <span class="preprocessor">}</span>
00558 <span class="preprocessor"></span>
<a name="l00559"></a><a class="code" href="../../d2/d2/ex_2pool_8c.html#a36">00559</a> <span class="preprocessor">#define UNLOCK_IF_PAGED_POOL(_CheckType, _GlobalPool)                          \</span>
00560 <span class="preprocessor">    if (_CheckType == PagedPool &amp;&amp; _GlobalPool == TRUE) {                      \</span>
00561 <span class="preprocessor">        ExReleaseFastMutex((PFAST_MUTEX)PoolVector[PagedPool]-&gt;LockAddress);   \</span>
00562 <span class="preprocessor">    }</span>
00563 <span class="preprocessor"></span>
00564 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00565"></a><a class="code" href="../../d5/d8/ex_8h.html#a227">00565</a> <a class="code" href="../../d5/d8/ex_8h.html#a227">ExUnlockPool</a>(
00566     IN POOL_TYPE PoolType,
00567     IN KIRQL LockHandle
00568     )
00569 
00570 <span class="comment">/*++</span>
00571 <span class="comment"></span>
00572 <span class="comment">Routine Description:</span>
00573 <span class="comment"></span>
00574 <span class="comment">    This function unlocks the pool specified by pool type.</span>
00575 <span class="comment"></span>
00576 <span class="comment"></span>
00577 <span class="comment">Arguments:</span>
00578 <span class="comment"></span>
00579 <span class="comment">    PoolType - Specifies the pool that should be unlocked.</span>
00580 <span class="comment"></span>
00581 <span class="comment">    LockHandle - Specifies the lock handle from a previous call to</span>
00582 <span class="comment">                 ExLockPool.</span>
00583 <span class="comment"></span>
00584 <span class="comment">Return Value:</span>
00585 <span class="comment"></span>
00586 <span class="comment">    None.</span>
00587 <span class="comment"></span>
00588 <span class="comment">--*/</span>
00589 
00590 {
00591 
00592     <span class="comment">//</span>
00593     <span class="comment">// If the pool type is nonpaged, then use a spinlock to unlock the</span>
00594     <span class="comment">// pool. Otherwise, use a fast mutex to unlock the pool.</span>
00595     <span class="comment">//</span>
00596 
00597     <span class="keywordflow">if</span> ((PoolType &amp; <a class="code" href="../../d4/d2/pool_8h.html#a5">BASE_POOL_TYPE_MASK</a>) == <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>) {
00598         ExReleaseSpinLock(&amp;<a class="code" href="../../d2/d2/ex_2pool_8c.html#a56">NonPagedPoolLock</a>, LockHandle);
00599 
00600     } <span class="keywordflow">else</span> {
00601         ExReleaseFastMutex((<a class="code" href="../../d6/d9/struct__FAST__MUTEX.html">PFAST_MUTEX</a>)<a class="code" href="../../d2/d2/ex_2pool_8c.html#a54">PoolVector</a>[<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>]-&gt;LockAddress);
00602     }
00603 
00604     <span class="keywordflow">return</span>;
00605 }
00606 
00607 
00608 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00609"></a><a class="code" href="../../d2/d2/ex_2pool_8c.html#a63">00609</a> <a class="code" href="../../d4/d2/pool_8h.html#a35">ExpInitializePoolDescriptor</a>(
00610     IN <a class="code" href="../../d4/d8/struct__POOL__DESCRIPTOR.html">PPOOL_DESCRIPTOR</a> PoolDescriptor,
00611     IN POOL_TYPE PoolType,
00612     IN ULONG PoolIndex,
00613     IN ULONG Threshold,
00614     IN PVOID PoolLock
00615     )
00616 
00617 <span class="comment">/*++</span>
00618 <span class="comment"></span>
00619 <span class="comment">Routine Description:</span>
00620 <span class="comment"></span>
00621 <span class="comment">    This function initializes a pool descriptor.</span>
00622 <span class="comment"></span>
00623 <span class="comment">    Note that this routine is called directly by the memory manager.</span>
00624 <span class="comment"></span>
00625 <span class="comment">Arguments:</span>
00626 <span class="comment"></span>
00627 <span class="comment">    PoolDescriptor - Supplies a pointer to the pool descriptor.</span>
00628 <span class="comment"></span>
00629 <span class="comment">    PoolType - Supplies the type of the pool.</span>
00630 <span class="comment"></span>
00631 <span class="comment">    PoolIndex - Supplies the pool descriptor index.</span>
00632 <span class="comment"></span>
00633 <span class="comment">    Threshold - Supplies the threshold value for the specified pool.</span>
00634 <span class="comment"></span>
00635 <span class="comment">    PoolLock - Supplies a point to the lock for the specified pool.</span>
00636 <span class="comment"></span>
00637 <span class="comment">Return Value:</span>
00638 <span class="comment"></span>
00639 <span class="comment">    None.</span>
00640 <span class="comment"></span>
00641 <span class="comment">--*/</span>
00642 
00643 {
00644 
00645     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00646 
00647     <span class="comment">//</span>
00648     <span class="comment">// Initialize statistics fields, the pool type, the threshold value,</span>
00649     <span class="comment">// and the lock address.</span>
00650     <span class="comment">//</span>
00651 
00652     PoolDescriptor-&gt;PoolType = PoolType;
00653     PoolDescriptor-&gt;PoolIndex = PoolIndex;
00654     PoolDescriptor-&gt;RunningAllocs = 0;
00655     PoolDescriptor-&gt;RunningDeAllocs = 0;
00656     PoolDescriptor-&gt;TotalPages = 0;
00657     PoolDescriptor-&gt;TotalBigPages = 0;
00658     PoolDescriptor-&gt;Threshold = Threshold;
00659     PoolDescriptor-&gt;LockAddress = PoolLock;
00660 
00661     <span class="comment">//</span>
00662     <span class="comment">// Initialize the allocation listheads.</span>
00663     <span class="comment">//</span>
00664 
00665     <span class="keywordflow">for</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; <a class="code" href="../../d5/d2/poolhack_8c.html#a2">POOL_LIST_HEADS</a>; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1) {
00666         <a class="code" href="../../d2/d2/ex_2pool_8c.html#a10">PrivateInitializeListHead</a>(&amp;PoolDescriptor-&gt;ListHeads[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>]);
00667     }
00668 
00669     <span class="keywordflow">if</span> ((PoolType == <a class="code" href="../../d5/d8/ex_8h.html#a329a182">PagedPoolSession</a>) &amp;&amp; (<a class="code" href="../../d2/d2/ex_2pool_8c.html#a40">ExpSessionPoolDescriptor</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00670         <a class="code" href="../../d2/d2/ex_2pool_8c.html#a40">ExpSessionPoolDescriptor</a> = (<a class="code" href="../../d4/d8/struct__POOL__DESCRIPTOR.html">PPOOL_DESCRIPTOR</a>) <a class="code" href="../../d1/d6/allocpag_8c.html#a49">MiSessionPoolVector</a> ();
00671     }
00672 
00673     <span class="keywordflow">return</span>;
00674 }
00675 
00676 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00677"></a><a class="code" href="../../d5/d8/ex_8h.html#a215">00677</a> <a class="code" href="../../d5/d8/ex_8h.html#a215">InitializePool</a>(
00678     IN POOL_TYPE PoolType,
00679     IN ULONG Threshold
00680     )
00681 
00682 <span class="comment">/*++</span>
00683 <span class="comment"></span>
00684 <span class="comment">Routine Description:</span>
00685 <span class="comment"></span>
00686 <span class="comment">    This procedure initializes a pool descriptor for the specified pool</span>
00687 <span class="comment">    type.  Once initialized, the pool may be used for allocation and</span>
00688 <span class="comment">    deallocation.</span>
00689 <span class="comment"></span>
00690 <span class="comment">    This function should be called once for each base pool type during</span>
00691 <span class="comment">    system initialization.</span>
00692 <span class="comment"></span>
00693 <span class="comment">    Each pool descriptor contains an array of list heads for free</span>
00694 <span class="comment">    blocks.  Each list head holds blocks which are a multiple of</span>
00695 <span class="comment">    the POOL_BLOCK_SIZE.  The first element on the list [0] links</span>
00696 <span class="comment">    together free entries of size POOL_BLOCK_SIZE, the second element</span>
00697 <span class="comment">    [1] links together entries of POOL_BLOCK_SIZE * 2, the third</span>
00698 <span class="comment">    POOL_BLOCK_SIZE * 3, etc, up to the number of blocks which fit</span>
00699 <span class="comment">    into a page.</span>
00700 <span class="comment"></span>
00701 <span class="comment">Arguments:</span>
00702 <span class="comment"></span>
00703 <span class="comment">    PoolType - Supplies the type of pool being initialized (e.g.</span>
00704 <span class="comment">               nonpaged pool, paged pool...).</span>
00705 <span class="comment"></span>
00706 <span class="comment">    Threshold - Supplies the threshold value for the specified pool.</span>
00707 <span class="comment"></span>
00708 <span class="comment">Return Value:</span>
00709 <span class="comment"></span>
00710 <span class="comment">    None.</span>
00711 <span class="comment"></span>
00712 <span class="comment">--*/</span>
00713 
00714 {
00715 
00716     <a class="code" href="../../d4/d8/struct__POOL__DESCRIPTOR.html">PPOOL_DESCRIPTOR</a> Descriptor;
00717     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00718     <a class="code" href="../../d6/d9/struct__FAST__MUTEX.html">PFAST_MUTEX</a> FastMutex;
00719     SIZE_T <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
00720 
00721     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>((PoolType &amp; <a class="code" href="../../d4/d2/pool_8h.html#a6">MUST_SUCCEED_POOL_TYPE_MASK</a>) == 0);
00722 
00723     <span class="keywordflow">if</span> (PoolType == <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>) {
00724 
00725         <span class="comment">//</span>
00726         <span class="comment">// Initialize nonpaged pools.</span>
00727         <span class="comment">//</span>
00728 
00729 <span class="preprocessor">#if !DBG</span>
00730 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a33">NtGlobalFlag</a> &amp; FLG_POOL_ENABLE_TAGGING) {
00731 <span class="preprocessor">#endif  </span>
00732 <span class="preprocessor">            PoolTrackTableSize = MAX_TRACKER_TABLE;</span>
00733 <span class="preprocessor"></span>            <a class="code" href="../../d2/d2/ex_2pool_8c.html#a44">PoolTrackTableMask</a> = <a class="code" href="../../d2/d2/ex_2pool_8c.html#a43">PoolTrackTableSize</a> - 2;
00734             <a class="code" href="../../d2/d2/ex_2pool_8c.html#a42">PoolTrackTable</a> = <a class="code" href="../../d1/d6/allocpag_8c.html#a54">MiAllocatePoolPages</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
00735                                                  <a class="code" href="../../d2/d2/ex_2pool_8c.html#a43">PoolTrackTableSize</a> *
00736                                                    <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d9/struct__POOL__TRACKER__TABLE.html">POOL_TRACKER_TABLE</a>),
00737                                                  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00738 
00739             RtlZeroMemory(<a class="code" href="../../d2/d2/ex_2pool_8c.html#a42">PoolTrackTable</a>, <a class="code" href="../../d2/d2/ex_2pool_8c.html#a43">PoolTrackTableSize</a> * <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d2/pool_8h.html#a30">POOL_TRACKER_TABLE</a>));
00740 
00741             <a class="code" href="../../d2/d2/ex_2pool_8c.html#a46">PoolBigPageTableSize</a> = <a class="code" href="../../d2/d2/ex_2pool_8c.html#a25">MAX_BIGPAGE_TABLE</a>;
00742             <a class="code" href="../../d2/d2/ex_2pool_8c.html#a47">PoolBigPageTableHash</a> = <a class="code" href="../../d2/d2/ex_2pool_8c.html#a46">PoolBigPageTableSize</a> - 1;
00743             <a class="code" href="../../d2/d2/ex_2pool_8c.html#a45">PoolBigPageTable</a> = <a class="code" href="../../d1/d6/allocpag_8c.html#a54">MiAllocatePoolPages</a>(<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
00744                                                    <a class="code" href="../../d2/d2/ex_2pool_8c.html#a46">PoolBigPageTableSize</a> *
00745                                                      <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d9/struct__POOL__TRACKER__BIG__PAGES.html">POOL_TRACKER_BIG_PAGES</a>),
00746                                                    <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00747 
00748             RtlZeroMemory(<a class="code" href="../../d2/d2/ex_2pool_8c.html#a45">PoolBigPageTable</a>, <a class="code" href="../../d2/d2/ex_2pool_8c.html#a46">PoolBigPageTableSize</a> * <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d2/pool_8h.html#a33">POOL_TRACKER_BIG_PAGES</a>));
00749 <span class="preprocessor">#if !DBG</span>
00750 <span class="preprocessor"></span>        }
00751 <span class="preprocessor">#endif  </span>
00752 <span class="preprocessor"></span>
00753 <span class="preprocessor"></span>        <span class="comment">//</span>
00754         <span class="comment">// Initialize the spinlocks for nonpaged pool.</span>
00755         <span class="comment">//</span>
00756 
00757         <a class="code" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock</a> (&amp;<a class="code" href="../../d2/d2/ex_2pool_8c.html#a58">ExpTaggedPoolLock</a>);
00758         <a class="code" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock</a>(&amp;<a class="code" href="../../d2/d2/ex_2pool_8c.html#a56">NonPagedPoolLock</a>);
00759 
00760         <span class="comment">//</span>
00761         <span class="comment">// Initialize the nonpaged pool descriptor.</span>
00762         <span class="comment">//</span>
00763 
00764         <a class="code" href="../../d2/d2/ex_2pool_8c.html#a54">PoolVector</a>[<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>] = &amp;<a class="code" href="../../d2/d2/ex_2pool_8c.html#a52">NonPagedPoolDescriptor</a>;
00765         <a class="code" href="../../d4/d2/pool_8h.html#a35">ExpInitializePoolDescriptor</a>(&amp;<a class="code" href="../../d2/d2/ex_2pool_8c.html#a52">NonPagedPoolDescriptor</a>,
00766                                     <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
00767                                     0,
00768                                     Threshold,
00769                                     (PVOID)&amp;<a class="code" href="../../d2/d2/ex_2pool_8c.html#a56">NonPagedPoolLock</a>);
00770 
00771         <span class="comment">//</span>
00772         <span class="comment">// Initialize the nonpaged must succeed pool descriptor.</span>
00773         <span class="comment">//</span>
00774 
00775         <a class="code" href="../../d2/d2/ex_2pool_8c.html#a54">PoolVector</a>[<a class="code" href="../../d5/d8/ex_8h.html#a329a175">NonPagedPoolMustSucceed</a>] = &amp;<a class="code" href="../../d2/d2/ex_2pool_8c.html#a53">NonPagedPoolDescriptorMS</a>;
00776         <a class="code" href="../../d4/d2/pool_8h.html#a35">ExpInitializePoolDescriptor</a>(&amp;<a class="code" href="../../d2/d2/ex_2pool_8c.html#a53">NonPagedPoolDescriptorMS</a>,
00777                                     <a class="code" href="../../d5/d8/ex_8h.html#a329a175">NonPagedPoolMustSucceed</a>,
00778                                     0,
00779                                     0,
00780                                     (PVOID)&amp;<a class="code" href="../../d2/d2/ex_2pool_8c.html#a56">NonPagedPoolLock</a>);
00781 
00782     } <span class="keywordflow">else</span> {
00783 
00784         <span class="comment">//</span>
00785         <span class="comment">// Allocate memory for the paged pool descriptors and fast mutexes.</span>
00786         <span class="comment">//</span>
00787 
00788         <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> = (<a class="code" href="../../d2/d2/ex_2pool_8c.html#a51">ExpNumberOfPagedPools</a> + 1) * (<span class="keyword">sizeof</span>(<a class="code" href="../../d6/d9/struct__FAST__MUTEX.html">FAST_MUTEX</a>) + <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d8/struct__POOL__DESCRIPTOR.html">POOL_DESCRIPTOR</a>));
00789         Descriptor = (<a class="code" href="../../d4/d8/struct__POOL__DESCRIPTOR.html">PPOOL_DESCRIPTOR</a>)<a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
00790                                                               <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>,
00791                                                               'looP');
00792         <span class="keywordflow">if</span> (Descriptor == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00793             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (MUST_SUCCEED_POOL_EMPTY,
00794                           <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>,
00795                           (ULONG_PTR)-1,
00796                           (ULONG_PTR)-1,
00797                           (ULONG_PTR)-1);
00798         }
00799 
00800         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d2/ex_2pool_8c.html#a42">PoolTrackTable</a>) {
00801             <a class="code" href="../../d2/d2/ex_2pool_8c.html#a65">ExpInsertPoolTracker</a>('looP',
00802                                   (ULONG) <a class="code" href="../../d2/d1/mm_8h.html#a4">ROUND_TO_PAGES</a>(<a class="code" href="../../d2/d2/ex_2pool_8c.html#a43">PoolTrackTableSize</a> * <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d9/struct__POOL__TRACKER__TABLE.html">POOL_TRACKER_TABLE</a>)),
00803                                  <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>);
00804 
00805             <a class="code" href="../../d2/d2/ex_2pool_8c.html#a65">ExpInsertPoolTracker</a>('looP',
00806                                   (ULONG) <a class="code" href="../../d2/d1/mm_8h.html#a4">ROUND_TO_PAGES</a>(<a class="code" href="../../d2/d2/ex_2pool_8c.html#a46">PoolBigPageTableSize</a> * <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d9/struct__POOL__TRACKER__BIG__PAGES.html">POOL_TRACKER_BIG_PAGES</a>)),
00807                                  <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>);
00808         }
00809 
00810         FastMutex = (<a class="code" href="../../d6/d9/struct__FAST__MUTEX.html">PFAST_MUTEX</a>)(Descriptor + <a class="code" href="../../d2/d2/ex_2pool_8c.html#a51">ExpNumberOfPagedPools</a> + 1);
00811         <a class="code" href="../../d2/d2/ex_2pool_8c.html#a54">PoolVector</a>[<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>] = Descriptor;
00812         <a class="code" href="../../d2/d2/ex_2pool_8c.html#a55">ExpPagedPoolDescriptor</a> = Descriptor;
00813         <span class="keywordflow">for</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; (<a class="code" href="../../d2/d2/ex_2pool_8c.html#a51">ExpNumberOfPagedPools</a> + 1); <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1) {
00814             <a class="code" href="../../d5/d8/ex_8h.html#a8">ExInitializeFastMutex</a>(FastMutex);
00815             <a class="code" href="../../d4/d2/pool_8h.html#a35">ExpInitializePoolDescriptor</a>(Descriptor,
00816                                         <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>,
00817                                         <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>,
00818                                         Threshold,
00819                                         (PVOID)FastMutex);
00820 
00821             Descriptor += 1;
00822             FastMutex += 1;
00823         }
00824     }
00825 
00826     <span class="comment">//</span>
00827     <span class="comment">// The maximum cache alignment must be less than the size of the</span>
00828     <span class="comment">// smallest pool block because the lower bits are being cleared</span>
00829     <span class="comment">// in ExFreePool to find the entry's address.</span>
00830     <span class="comment">//</span>
00831 
00832 <span class="preprocessor">#if POOL_CACHE_SUPPORTED</span>
00833 <span class="preprocessor"></span>
00834     <span class="comment">//</span>
00835     <span class="comment">// Compute pool cache information.</span>
00836     <span class="comment">//</span>
00837 
00838     PoolCacheSize = HalGetDmaAlignmentRequirement();
00839 
00840     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PoolCacheSize &gt;= <a class="code" href="../../d5/d2/poolhack_8c.html#a6">POOL_OVERHEAD</a>);
00841 
00842     PoolCacheOverhead = PoolCacheSize + PoolCacheSize - (<span class="keyword">sizeof</span>(<a class="code" href="../../d5/d8/struct__POOL__HEADER.html">POOL_HEADER</a>) + 1);
00843 
00844     PoolBuddyMax =
00845        (<a class="code" href="../../d5/d2/poolhack_8c.html#a0">POOL_PAGE_SIZE</a> - (<a class="code" href="../../d5/d2/poolhack_8c.html#a6">POOL_OVERHEAD</a> + (3*<a class="code" href="../../d4/d2/pool_8h.html#a20">POOL_SMALLEST_BLOCK</a>) + 2*PoolCacheSize));
00846 
00847 <span class="preprocessor">#endif //POOL_CACHE_SUPPORTED</span>
00848 <span class="preprocessor"></span>
00849 }
00850 
00851 
00852 LOGICAL
<a name="l00853"></a><a class="code" href="../../d2/d2/ex_2pool_8c.html#a74">00853</a> <a class="code" href="../../d2/d2/ex_2pool_8c.html#a74">ExpCheckSingleFilter</a> (
00854     ULONG Tag,
00855     ULONG Filter
00856     )
00857 
00858 <span class="comment">/*++</span>
00859 <span class="comment"></span>
00860 <span class="comment">Routine Description:</span>
00861 <span class="comment"></span>
00862 <span class="comment">    This function checks if a pool tag matches a given pattern.  Pool</span>
00863 <span class="comment">    protection is ignored in the tag.</span>
00864 <span class="comment"></span>
00865 <span class="comment">        ? - matches a single character</span>
00866 <span class="comment">        * - terminates match with TRUE</span>
00867 <span class="comment"></span>
00868 <span class="comment">    N.B.: ability inspired by the !poolfind debugger extension.</span>
00869 <span class="comment"></span>
00870 <span class="comment">Arguments:</span>
00871 <span class="comment"></span>
00872 <span class="comment">    Tag - a pool tag</span>
00873 <span class="comment"></span>
00874 <span class="comment">    Filter - a globish pattern (chars and/or ?,*)</span>
00875 <span class="comment"></span>
00876 <span class="comment">Return Value:</span>
00877 <span class="comment"></span>
00878 <span class="comment">    TRUE if a match exists, FALSE otherwise.</span>
00879 <span class="comment"></span>
00880 <span class="comment">--*/</span>
00881 
00882 {
00883     ULONG i;
00884     PUCHAR tc;
00885     PUCHAR fc;
00886 
00887     tc = (PUCHAR) &amp;Tag;
00888     fc = (PUCHAR) &amp;<a class="code" href="../../d5/d2/rtnotify_8c.html#a9">Filter</a>;
00889 
00890     <span class="keywordflow">for</span> (i = 0; i &lt; 4; i += 1, tc += 1, fc += 1) {
00891 
00892         <span class="keywordflow">if</span> (*fc == <span class="charliteral">'*'</span>) {
00893             <span class="keywordflow">break</span>;
00894         }
00895         <span class="keywordflow">if</span> (*fc == <span class="charliteral">'?'</span>) {
00896             <span class="keywordflow">continue</span>;
00897         }
00898         <span class="keywordflow">if</span> (i == 3 &amp;&amp; ((*tc) &amp; ~(<a class="code" href="../../d5/d8/ex_8h.html#a6">PROTECTED_POOL</a> &gt;&gt; 24)) == *fc) {
00899             <span class="keywordflow">continue</span>;
00900         }
00901         <span class="keywordflow">if</span> (*tc != *fc) {
00902             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00903         }
00904     }
00905     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00906 }
00907 
00908 
00909 PVOID
<a name="l00910"></a><a class="code" href="../../d5/d8/ex_8h.html#a219">00910</a> <a class="code" href="../../d5/d5/cc_8h.html#a10">ExAllocatePool</a>(
00911     IN POOL_TYPE PoolType,
00912     IN SIZE_T NumberOfBytes
00913     )
00914 
00915 <span class="comment">/*++</span>
00916 <span class="comment"></span>
00917 <span class="comment">Routine Description:</span>
00918 <span class="comment"></span>
00919 <span class="comment">    This function allocates a block of pool of the specified type and</span>
00920 <span class="comment">    returns a pointer to the allocated block.  This function is used to</span>
00921 <span class="comment">    access both the page-aligned pools, and the list head entries (less than</span>
00922 <span class="comment">    a page) pools.</span>
00923 <span class="comment"></span>
00924 <span class="comment">    If the number of bytes specifies a size that is too large to be</span>
00925 <span class="comment">    satisfied by the appropriate list, then the page-aligned</span>
00926 <span class="comment">    pool allocator is used.  The allocated block will be page-aligned</span>
00927 <span class="comment">    and a page-sized multiple.</span>
00928 <span class="comment"></span>
00929 <span class="comment">    Otherwise, the appropriate pool list entry is used.  The allocated</span>
00930 <span class="comment">    block will be 64-bit aligned, but will not be page aligned.  The</span>
00931 <span class="comment">    pool allocator calculates the smallest number of POOL_BLOCK_SIZE</span>
00932 <span class="comment">    that can be used to satisfy the request.  If there are no blocks</span>
00933 <span class="comment">    available of this size, then a block of the next larger block size</span>
00934 <span class="comment">    is allocated and split.  One piece is placed back into the pool, and</span>
00935 <span class="comment">    the other piece is used to satisfy the request.  If the allocator</span>
00936 <span class="comment">    reaches the paged-sized block list, and nothing is there, the</span>
00937 <span class="comment">    page-aligned pool allocator is called.  The page is split and added</span>
00938 <span class="comment">    to the pool...</span>
00939 <span class="comment"></span>
00940 <span class="comment">Arguments:</span>
00941 <span class="comment"></span>
00942 <span class="comment">    PoolType - Supplies the type of pool to allocate.  If the pool type</span>
00943 <span class="comment">        is one of the "MustSucceed" pool types, then this call will</span>
00944 <span class="comment">        always succeed and return a pointer to allocated pool.</span>
00945 <span class="comment">        Otherwise, if the system cannot allocate the requested amount</span>
00946 <span class="comment">        of memory a NULL is returned.</span>
00947 <span class="comment"></span>
00948 <span class="comment">        Valid pool types:</span>
00949 <span class="comment"></span>
00950 <span class="comment">        NonPagedPool</span>
00951 <span class="comment">        PagedPool</span>
00952 <span class="comment">        NonPagedPoolMustSucceed,</span>
00953 <span class="comment">        NonPagedPoolCacheAligned</span>
00954 <span class="comment">        PagedPoolCacheAligned</span>
00955 <span class="comment">        NonPagedPoolCacheAlignedMustS</span>
00956 <span class="comment"></span>
00957 <span class="comment">    NumberOfBytes - Supplies the number of bytes to allocate.</span>
00958 <span class="comment"></span>
00959 <span class="comment">Return Value:</span>
00960 <span class="comment"></span>
00961 <span class="comment">    NULL - The PoolType is not one of the "MustSucceed" pool types, and</span>
00962 <span class="comment">        not enough pool exists to satisfy the request.</span>
00963 <span class="comment"></span>
00964 <span class="comment">    NON-NULL - Returns a pointer to the allocated pool.</span>
00965 <span class="comment"></span>
00966 <span class="comment">--*/</span>
00967 
00968 {
00969     <span class="keywordflow">return</span> <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (PoolType,
00970                                   NumberOfBytes,
00971                                   'enoN');
00972 }
00973 
<a name="l00974"></a><a class="code" href="../../d2/d2/ex_2pool_8c.html#a37">00974</a> <span class="preprocessor">#define _NTOSKRNL_VERIFIER_ 1       // LWFIX: disable for ship</span>
00975 <span class="preprocessor"></span>
00976 <span class="preprocessor">#ifdef _NTOSKRNL_VERIFIER_</span>
00977 <span class="preprocessor"></span>
00978 PVOID
00979 <a class="code" href="../../d9/d5/verifier_8c.html#a58">VeAllocatePoolWithTagPriority</a>(
00980     IN POOL_TYPE PoolType,
00981     IN SIZE_T NumberOfBytes,
00982     IN ULONG Tag,
00983     IN EX_POOL_PRIORITY Priority,
00984     IN PVOID CallingAddress
00985     );
00986 
<a name="l00987"></a><a class="code" href="../../d2/d2/ex_2pool_8c.html#a61">00987</a> <span class="keyword">extern</span> LOGICAL <a class="code" href="../../d2/d2/ex_2pool_8c.html#a61">KernelVerifier</a>;
00988 
00989 <span class="preprocessor">#endif</span>
00990 <span class="preprocessor"></span>
00991 
00992 PVOID
<a name="l00993"></a><a class="code" href="../../d5/d8/ex_8h.html#a222">00993</a> <a class="code" href="../../d5/d8/ex_8h.html#a222">ExAllocatePoolWithTagPriority</a>(
00994     IN POOL_TYPE PoolType,
00995     IN SIZE_T NumberOfBytes,
00996     IN ULONG Tag,
00997     IN EX_POOL_PRIORITY Priority
00998     )
00999 
01000 <span class="comment">/*++</span>
01001 <span class="comment"></span>
01002 <span class="comment">Routine Description:</span>
01003 <span class="comment"></span>
01004 <span class="comment">    This function allocates a block of pool of the specified type and</span>
01005 <span class="comment">    returns a pointer to the allocated block.  This function is used to</span>
01006 <span class="comment">    access both the page-aligned pools, and the list head entries (less than</span>
01007 <span class="comment">    a page) pools.</span>
01008 <span class="comment"></span>
01009 <span class="comment">    If the number of bytes specifies a size that is too large to be</span>
01010 <span class="comment">    satisfied by the appropriate list, then the page-aligned</span>
01011 <span class="comment">    pool allocator is used.  The allocated block will be page-aligned</span>
01012 <span class="comment">    and a page-sized multiple.</span>
01013 <span class="comment"></span>
01014 <span class="comment">    Otherwise, the appropriate pool list entry is used.  The allocated</span>
01015 <span class="comment">    block will be 64-bit aligned, but will not be page aligned.  The</span>
01016 <span class="comment">    pool allocator calculates the smallest number of POOL_BLOCK_SIZE</span>
01017 <span class="comment">    that can be used to satisfy the request.  If there are no blocks</span>
01018 <span class="comment">    available of this size, then a block of the next larger block size</span>
01019 <span class="comment">    is allocated and split.  One piece is placed back into the pool, and</span>
01020 <span class="comment">    the other piece is used to satisfy the request.  If the allocator</span>
01021 <span class="comment">    reaches the paged-sized block list, and nothing is there, the</span>
01022 <span class="comment">    page-aligned pool allocator is called.  The page is split and added</span>
01023 <span class="comment">    to the pool...</span>
01024 <span class="comment"></span>
01025 <span class="comment">Arguments:</span>
01026 <span class="comment"></span>
01027 <span class="comment">    PoolType - Supplies the type of pool to allocate.  If the pool type</span>
01028 <span class="comment">        is one of the "MustSucceed" pool types, then this call will</span>
01029 <span class="comment">        always succeed and return a pointer to allocated pool.</span>
01030 <span class="comment">        Otherwise, if the system cannot allocate the requested amount</span>
01031 <span class="comment">        of memory a NULL is returned.</span>
01032 <span class="comment"></span>
01033 <span class="comment">        Valid pool types:</span>
01034 <span class="comment"></span>
01035 <span class="comment">        NonPagedPool</span>
01036 <span class="comment">        PagedPool</span>
01037 <span class="comment">        NonPagedPoolMustSucceed,</span>
01038 <span class="comment">        NonPagedPoolCacheAligned</span>
01039 <span class="comment">        PagedPoolCacheAligned</span>
01040 <span class="comment">        NonPagedPoolCacheAlignedMustS</span>
01041 <span class="comment"></span>
01042 <span class="comment">    NumberOfBytes - Supplies the number of bytes to allocate.</span>
01043 <span class="comment"></span>
01044 <span class="comment">    Tag - Supplies the caller's identifying tag.</span>
01045 <span class="comment"></span>
01046 <span class="comment">    Priority - Supplies an indication as to how important it is that this</span>
01047 <span class="comment">               request succeed under low available pool conditions.  This</span>
01048 <span class="comment">               can also be used to specify special pool.</span>
01049 <span class="comment"></span>
01050 <span class="comment">Return Value:</span>
01051 <span class="comment"></span>
01052 <span class="comment">    NULL - The PoolType is not one of the "MustSucceed" pool types, and</span>
01053 <span class="comment">        not enough pool exists to satisfy the request.</span>
01054 <span class="comment"></span>
01055 <span class="comment">    NON-NULL - Returns a pointer to the allocated pool.</span>
01056 <span class="comment"></span>
01057 <span class="comment">--*/</span>
01058 
01059 {
01060     PVOID Entry;
01061 
01062     <span class="keywordflow">if</span> ((Priority &amp; <a class="code" href="../../d2/d2/ex_2pool_8c.html#a1">POOL_SPECIAL_POOL_BIT</a>) &amp;&amp; (NumberOfBytes &lt;= <a class="code" href="../../d5/d2/poolhack_8c.html#a7">POOL_BUDDY_MAX</a>)) {
01063         Entry = <a class="code" href="../../d1/d6/allocpag_8c.html#a60">MmAllocateSpecialPool</a> (NumberOfBytes,
01064                                        Tag,
01065                                        PoolType &amp; (<a class="code" href="../../d4/d2/pool_8h.html#a5">BASE_POOL_TYPE_MASK</a> | <a class="code" href="../../d4/d2/pool_8h.html#a9">POOL_VERIFIER_MASK</a>),
01066                                        (Priority &amp; <a class="code" href="../../d2/d2/ex_2pool_8c.html#a2">POOL_SPECIAL_POOL_UNDERRUN_BIT</a>) ? 1 : 0);
01067 
01068         <span class="keywordflow">if</span> (Entry != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01069             <span class="keywordflow">return</span> Entry;
01070         }
01071         Priority &amp;= ~(<a class="code" href="../../d2/d2/ex_2pool_8c.html#a1">POOL_SPECIAL_POOL_BIT</a> | <a class="code" href="../../d2/d2/ex_2pool_8c.html#a2">POOL_SPECIAL_POOL_UNDERRUN_BIT</a>);
01072     }
01073 
01074     <span class="comment">//</span>
01075     <span class="comment">// Pool and other resources can be allocated directly through the Mm</span>
01076     <span class="comment">// without the pool code knowing - so always call the Mm for the</span>
01077     <span class="comment">// up-to-date counters.</span>
01078     <span class="comment">//</span>
01079 
01080     <span class="keywordflow">if</span> ((Priority != <a class="code" href="../../d5/d8/ex_8h.html#a330a194">HighPoolPriority</a>) &amp;&amp; ((PoolType &amp; <a class="code" href="../../d4/d2/pool_8h.html#a6">MUST_SUCCEED_POOL_TYPE_MASK</a>) == 0)) {
01081 
01082         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d2/ex_2pool_8c.html#a40">ExpSessionPoolDescriptor</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01083             PoolType &amp;= ~<a class="code" href="../../d4/d2/pool_8h.html#a8">SESSION_POOL_MASK</a>;
01084         }
01085 
01086         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d6/allocpag_8c.html#a52">MmResourcesAvailable</a> (PoolType, NumberOfBytes, Priority) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01087             <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01088         }
01089     }
01090 
01091     <span class="comment">//</span>
01092     <span class="comment">// There is a window between determining whether to proceed and actually</span>
01093     <span class="comment">// doing the allocation.  In this window the pool may deplete.  This is not</span>
01094     <span class="comment">// worth closing at this time.</span>
01095     <span class="comment">//</span>
01096 
01097     <span class="keywordflow">return</span> <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a> (PoolType,
01098                                   NumberOfBytes,
01099                                   Tag);
01100 }
01101 
01102 
01103 PVOID
<a name="l01104"></a><a class="code" href="../../d5/d8/ex_8h.html#a221">01104</a> <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(
01105     IN POOL_TYPE PoolType,
01106     IN SIZE_T NumberOfBytes,
01107     IN ULONG Tag
01108     )
01109 
01110 <span class="comment">/*++</span>
01111 <span class="comment"></span>
01112 <span class="comment">Routine Description:</span>
01113 <span class="comment"></span>
01114 <span class="comment">    This function allocates a block of pool of the specified type and</span>
01115 <span class="comment">    returns a pointer to the allocated block. This function is used to</span>
01116 <span class="comment">    access both the page-aligned pools and the list head entries (less</span>
01117 <span class="comment">    than a page) pools.</span>
01118 <span class="comment"></span>
01119 <span class="comment">    If the number of bytes specifies a size that is too large to be</span>
01120 <span class="comment">    satisfied by the appropriate list, then the page-aligned pool</span>
01121 <span class="comment">    allocator is used. The allocated block will be page-aligned and a</span>
01122 <span class="comment">    page-sized multiple.</span>
01123 <span class="comment"></span>
01124 <span class="comment">    Otherwise, the appropriate pool list entry is used. The allocated</span>
01125 <span class="comment">    block will be 64-bit aligned, but will not be page aligned. The</span>
01126 <span class="comment">    pool allocator calculates the smallest number of POOL_BLOCK_SIZE</span>
01127 <span class="comment">    that can be used to satisfy the request. If there are no blocks</span>
01128 <span class="comment">    available of this size, then a block of the next larger block size</span>
01129 <span class="comment">    is allocated and split. One piece is placed back into the pool, and</span>
01130 <span class="comment">    the other piece is used to satisfy the request. If the allocator</span>
01131 <span class="comment">    reaches the paged-sized block list, and nothing is there, the</span>
01132 <span class="comment">    page-aligned pool allocator is called. The page is split and added</span>
01133 <span class="comment">    to the pool.</span>
01134 <span class="comment"></span>
01135 <span class="comment">Arguments:</span>
01136 <span class="comment"></span>
01137 <span class="comment">    PoolType - Supplies the type of pool to allocate. If the pool type</span>
01138 <span class="comment">        is one of the "MustSucceed" pool types, then this call will</span>
01139 <span class="comment">        always succeed and return a pointer to allocated pool. Otherwise,</span>
01140 <span class="comment">        if the system cannot allocate the requested amount of memory a</span>
01141 <span class="comment">        NULL is returned.</span>
01142 <span class="comment"></span>
01143 <span class="comment">        Valid pool types:</span>
01144 <span class="comment"></span>
01145 <span class="comment">        NonPagedPool</span>
01146 <span class="comment">        PagedPool</span>
01147 <span class="comment">        NonPagedPoolMustSucceed,</span>
01148 <span class="comment">        NonPagedPoolCacheAligned</span>
01149 <span class="comment">        PagedPoolCacheAligned</span>
01150 <span class="comment">        NonPagedPoolCacheAlignedMustS</span>
01151 <span class="comment"></span>
01152 <span class="comment">    Tag - Supplies the caller's identifying tag.</span>
01153 <span class="comment"></span>
01154 <span class="comment">    NumberOfBytes - Supplies the number of bytes to allocate.</span>
01155 <span class="comment"></span>
01156 <span class="comment">Return Value:</span>
01157 <span class="comment"></span>
01158 <span class="comment">    NULL - The PoolType is not one of the "MustSucceed" pool types, and</span>
01159 <span class="comment">        not enough pool exists to satisfy the request.</span>
01160 <span class="comment"></span>
01161 <span class="comment">    NON-NULL - Returns a pointer to the allocated pool.</span>
01162 <span class="comment"></span>
01163 <span class="comment">--*/</span>
01164 
01165 {
01166     PVOID Block;
01167     <a class="code" href="../../d5/d8/struct__POOL__HEADER.html">PPOOL_HEADER</a> Entry;
01168     <a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html">PNPAGED_LOOKASIDE_LIST</a> LookasideList;
01169     <a class="code" href="../../d5/d8/struct__POOL__HEADER.html">PPOOL_HEADER</a> NextEntry;
01170     <a class="code" href="../../d5/d8/struct__POOL__HEADER.html">PPOOL_HEADER</a> SplitEntry;
01171     KIRQL LockHandle;
01172     <a class="code" href="../../d4/d8/struct__POOL__DESCRIPTOR.html">PPOOL_DESCRIPTOR</a> PoolDesc;
01173     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
01174     ULONG ListNumber;
01175     ULONG NeededSize;
01176     ULONG PoolIndex;
01177     <a class="code" href="../../d5/d8/ex_8h.html#a96">POOL_TYPE</a> CheckType;
01178     <a class="code" href="../../d5/d8/ex_8h.html#a96">POOL_TYPE</a> RequestType;
01179     PLIST_ENTRY ListHead;
01180     <a class="code" href="../../d5/d8/ex_8h.html#a96">POOL_TYPE</a> NewPoolType;
01181     LOGICAL GlobalSpace;
01182     ULONG IsLargeSessionAllocation;
01183     PKPRCB Prcb;
01184     ULONG NumberOfPages;
01185     PVOID CallingAddress;
01186     PVOID CallersCaller;
01187 
01188 <span class="preprocessor">#if POOL_CACHE_SUPPORTED</span>
01189 <span class="preprocessor"></span>    ULONG <a class="code" href="../../d2/d2/ex_2pool_8c.html#a38">CacheOverhead</a>;
01190 <span class="preprocessor">#else</span>
01191 <span class="preprocessor"></span><span class="preprocessor">#define CacheOverhead POOL_OVERHEAD</span>
01192 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
01193 <span class="preprocessor"></span>
01194     <a class="code" href="../../d2/d1/mm_8h.html#a49">PERFINFO_EXALLOCATEPOOLWITHTAG_DECL</a>();
01195 
01196 <span class="preprocessor">#ifdef _NTOSKRNL_VERIFIER_</span>
01197 <span class="preprocessor"></span>
01198     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d2/ex_2pool_8c.html#a61">KernelVerifier</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01199 <span class="preprocessor">#if defined (_X86_)</span>
01200 <span class="preprocessor"></span>        <a class="code" href="../../d5/d2/ppc_2getcalr_8c.html#a0">RtlGetCallersAddress</a>(&amp;CallingAddress, &amp;CallersCaller);
01201 <span class="preprocessor">#else</span>
01202 <span class="preprocessor"></span>        CallingAddress = (PVOID)_ReturnAddress();
01203 <span class="preprocessor">#endif</span>
01204 <span class="preprocessor"></span>
01205         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(NumberOfBytes != 0);
01206         <a class="code" href="../../d2/d2/ex_2pool_8c.html#a19">ASSERT_ALLOCATE_IRQL</a>(PoolType, NumberOfBytes);
01207 
01208         <span class="keywordflow">if</span> ((PoolType &amp; <a class="code" href="../../d4/d2/pool_8h.html#a10">POOL_DRIVER_MASK</a>) == 0) {
01209 
01210             <span class="comment">//</span>
01211             <span class="comment">// Use the Driver Verifier pool framework.  Note this will</span>
01212             <span class="comment">// result in a recursive callback to this routine.</span>
01213             <span class="comment">//</span>
01214 
01215             <span class="keywordflow">return</span> <a class="code" href="../../d9/d5/verifier_8c.html#a58">VeAllocatePoolWithTagPriority</a> (PoolType | <a class="code" href="../../d4/d2/pool_8h.html#a10">POOL_DRIVER_MASK</a>,
01216                                                   NumberOfBytes,
01217                                                   Tag,
01218                                                   <a class="code" href="../../d5/d8/ex_8h.html#a330a194">HighPoolPriority</a>,
01219                                                   CallingAddress);
01220         }
01221         PoolType &amp;= ~<a class="code" href="../../d4/d2/pool_8h.html#a10">POOL_DRIVER_MASK</a>;
01222     }
01223 
01224 <span class="preprocessor">#else</span>
01225 <span class="preprocessor"></span>
01226     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(NumberOfBytes != 0);
01227     <a class="code" href="../../d2/d2/ex_2pool_8c.html#a19">ASSERT_ALLOCATE_IRQL</a>(PoolType, NumberOfBytes);
01228 
01229 <span class="preprocessor">#endif</span>
01230 <span class="preprocessor"></span>
01231     <span class="comment">//</span>
01232     <span class="comment">// Isolate the base pool type and select a pool from which to allocate</span>
01233     <span class="comment">// the specified block size.</span>
01234     <span class="comment">//</span>
01235 
01236     CheckType = PoolType &amp; <a class="code" href="../../d4/d2/pool_8h.html#a5">BASE_POOL_TYPE_MASK</a>;
01237 
01238     <span class="comment">//</span>
01239     <span class="comment">// Currently only Hydra paged pool allocations come from the per session</span>
01240     <span class="comment">// pools.  Nonpaged Hydra pool allocations still come from global pool.</span>
01241     <span class="comment">//</span>
01242 
01243     <span class="keywordflow">if</span> (PoolType &amp; <a class="code" href="../../d4/d2/pool_8h.html#a8">SESSION_POOL_MASK</a>) {
01244         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d2/ex_2pool_8c.html#a40">ExpSessionPoolDescriptor</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01245 
01246             <span class="comment">//</span>
01247             <span class="comment">// Promote this down to support common binaries.</span>
01248             <span class="comment">//</span>
01249 
01250             PoolType &amp;= ~<a class="code" href="../../d4/d2/pool_8h.html#a8">SESSION_POOL_MASK</a>;
01251             PoolDesc = <a class="code" href="../../d2/d2/ex_2pool_8c.html#a54">PoolVector</a>[CheckType];
01252             GlobalSpace = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01253         }
01254         <span class="keywordflow">else</span> {
01255             GlobalSpace = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01256             <span class="keywordflow">if</span> (CheckType == <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>) {
01257                 PoolDesc = <a class="code" href="../../d2/d2/ex_2pool_8c.html#a54">PoolVector</a>[CheckType];
01258             }
01259             <span class="keywordflow">else</span> {
01260                 PoolDesc = <a class="code" href="../../d2/d2/ex_2pool_8c.html#a40">ExpSessionPoolDescriptor</a>;
01261             }
01262         }
01263     }
01264     <span class="keywordflow">else</span> {
01265         PoolDesc = <a class="code" href="../../d2/d2/ex_2pool_8c.html#a54">PoolVector</a>[CheckType];
01266         GlobalSpace = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01267     }
01268 
01269     <span class="comment">//</span>
01270     <span class="comment">// Check to determine if the requested block can be allocated from one</span>
01271     <span class="comment">// of the pool lists or must be directly allocated from virtual memory.</span>
01272     <span class="comment">//</span>
01273 
01274     <span class="keywordflow">if</span> (NumberOfBytes &gt; <a class="code" href="../../d5/d2/poolhack_8c.html#a7">POOL_BUDDY_MAX</a>) {
01275 
01276         <span class="comment">//</span>
01277         <span class="comment">// The requested size is greater than the largest block maintained</span>
01278         <span class="comment">// by allocation lists.</span>
01279         <span class="comment">//</span>
01280 
01281         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((NumberOfBytes &lt;= <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>) ||
01282                 (<a class="code" href="../../d2/d2/ex_2pool_8c.html#a55">ExpPagedPoolDescriptor</a> == (<a class="code" href="../../d4/d8/struct__POOL__DESCRIPTOR.html">PPOOL_DESCRIPTOR</a>)0) ||
01283                 ((PoolType &amp; <a class="code" href="../../d4/d2/pool_8h.html#a6">MUST_SUCCEED_POOL_TYPE_MASK</a>) == 0));
01284 
01285         <a class="code" href="../../d2/d2/ex_2pool_8c.html#a33">LOCK_POOL</a>(PoolDesc, LockHandle);
01286 
01287         PoolDesc-&gt;<a class="code" href="../../d4/d8/struct__POOL__DESCRIPTOR.html#o6">RunningAllocs</a> += 1;
01288 
01289         IsLargeSessionAllocation = (PoolType &amp; <a class="code" href="../../d4/d2/pool_8h.html#a8">SESSION_POOL_MASK</a>);
01290 
01291         RequestType = (PoolType &amp; (<a class="code" href="../../d4/d2/pool_8h.html#a5">BASE_POOL_TYPE_MASK</a> | <a class="code" href="../../d4/d2/pool_8h.html#a8">SESSION_POOL_MASK</a> | <a class="code" href="../../d4/d2/pool_8h.html#a9">POOL_VERIFIER_MASK</a>));
01292 
01293 RetryWithMustSucceed:
01294         Entry = (<a class="code" href="../../d5/d8/struct__POOL__HEADER.html">PPOOL_HEADER</a>) <a class="code" href="../../d1/d6/allocpag_8c.html#a54">MiAllocatePoolPages</a> (RequestType,
01295                                                     NumberOfBytes,
01296                                                     IsLargeSessionAllocation);
01297 
01298         <span class="comment">//</span>
01299         <span class="comment">// Large session pool allocations are accounted for directly by</span>
01300         <span class="comment">// the memory manager so no need to call MiSessionPoolAllocated here.</span>
01301         <span class="comment">//</span>
01302 
01303         <span class="keywordflow">if</span> (Entry != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01304 
01305             NumberOfPages = <a class="code" href="../../d2/d1/mm_8h.html#a5">BYTES_TO_PAGES</a>(NumberOfBytes);
01306             PoolDesc-&gt;<a class="code" href="../../d4/d8/struct__POOL__DESCRIPTOR.html#o8">TotalBigPages</a> += NumberOfPages;
01307 
01308             <a class="code" href="../../d2/d2/ex_2pool_8c.html#a35">UNLOCK_POOL</a>(PoolDesc, LockHandle);
01309 
01310             <span class="keywordflow">if</span> ((<a class="code" href="../../d2/d2/ex_2pool_8c.html#a45">PoolBigPageTable</a>) &amp;&amp; (IsLargeSessionAllocation == 0)) {
01311 
01312                 <span class="keywordflow">if</span> (<a class="code" href="../../d2/d2/ex_2pool_8c.html#a67">ExpAddTagForBigPages</a>((PVOID)Entry,
01313                                          Tag,
01314                                          NumberOfPages) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01315                     Tag = ' GIB';
01316                 }
01317 
01318                 <a class="code" href="../../d2/d2/ex_2pool_8c.html#a65">ExpInsertPoolTracker</a> (Tag,
01319                                       (ULONG) <a class="code" href="../../d2/d1/mm_8h.html#a4">ROUND_TO_PAGES</a>(NumberOfBytes),
01320                                       PoolType);
01321             }
01322 
01323         } <span class="keywordflow">else</span> {
01324             <span class="keywordflow">if</span> (PoolType &amp; <a class="code" href="../../d4/d2/pool_8h.html#a6">MUST_SUCCEED_POOL_TYPE_MASK</a>) {
01325                 RequestType |= <a class="code" href="../../d4/d2/pool_8h.html#a6">MUST_SUCCEED_POOL_TYPE_MASK</a>;
01326                 <span class="keywordflow">goto</span> RetryWithMustSucceed;
01327             }
01328 
01329             <a class="code" href="../../d2/d2/ex_2pool_8c.html#a35">UNLOCK_POOL</a>(PoolDesc, LockHandle);
01330 
01331             KdPrint((<span class="stringliteral">"EX: ExAllocatePool (%p, 0x%x ) returning NULL\n"</span>,
01332                 NumberOfBytes,
01333                 PoolType));
01334 
01335             <span class="keywordflow">if</span> ((PoolType &amp; <a class="code" href="../../d5/d8/ex_8h.html#a3">POOL_RAISE_IF_ALLOCATION_FAILURE</a>) != 0) {
01336                 <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>(STATUS_INSUFFICIENT_RESOURCES);
01337             }
01338         }
01339 
01340         <a class="code" href="../../d2/d1/mm_8h.html#a34">PERFINFO_BIGPOOLALLOC</a>(PoolType, Tag, NumberOfBytes, Entry);
01341 
01342         <span class="keywordflow">return</span> Entry;
01343     }
01344 
01345     <span class="comment">//</span>
01346     <span class="comment">// The requested size is less than or equal to the size of the</span>
01347     <span class="comment">// maximum block maintained by the allocation lists.</span>
01348     <span class="comment">//</span>
01349 
01350     <a class="code" href="../../d2/d1/mm_8h.html#a82">PERFINFO_POOLALLOC</a>(PoolType, Tag, NumberOfBytes);
01351 
01352     <span class="comment">//</span>
01353     <span class="comment">// Check for a special pool tag match by actual tag.</span>
01354     <span class="comment">//</span>
01355 
01356     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d1/mm_8h.html#a159">MmSpecialPoolTag</a> != 0 &amp;&amp; NumberOfBytes != 0) {
01357 
01358 <span class="preprocessor">#ifndef NO_POOL_CHECKS</span>
01359 <span class="preprocessor"></span>        Entry = <a class="code" href="../../d1/d6/allocpag_8c.html#a38">MmSqueezeBadTags</a> (NumberOfBytes, Tag, CheckType, 2);
01360         <span class="keywordflow">if</span> (Entry != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01361             <span class="keywordflow">return</span> (PVOID)Entry;
01362         }
01363 <span class="preprocessor">#endif</span>
01364 <span class="preprocessor"></span>
01365         <span class="comment">//</span>
01366         <span class="comment">// Check for a special pool tag match by tag string and size ranges.</span>
01367         <span class="comment">//</span>
01368 
01369         <span class="keywordflow">if</span> ((<a class="code" href="../../d2/d2/ex_2pool_8c.html#a74">ExpCheckSingleFilter</a>(Tag, <a class="code" href="../../d2/d1/mm_8h.html#a159">MmSpecialPoolTag</a>)) ||
01370             ((<a class="code" href="../../d2/d1/mm_8h.html#a159">MmSpecialPoolTag</a> &gt;= (NumberOfBytes + <a class="code" href="../../d5/d2/poolhack_8c.html#a6">POOL_OVERHEAD</a>)) &amp;&amp;
01371              (<a class="code" href="../../d2/d1/mm_8h.html#a159">MmSpecialPoolTag</a> &lt; (NumberOfBytes + <a class="code" href="../../d5/d2/poolhack_8c.html#a6">POOL_OVERHEAD</a> + <a class="code" href="../../d4/d2/pool_8h.html#a20">POOL_SMALLEST_BLOCK</a>)))) {
01372 
01373             Entry = <a class="code" href="../../d1/d6/allocpag_8c.html#a60">MmAllocateSpecialPool</a> (NumberOfBytes,
01374                                            Tag,
01375                                            PoolType &amp; (<a class="code" href="../../d4/d2/pool_8h.html#a5">BASE_POOL_TYPE_MASK</a> | <a class="code" href="../../d4/d2/pool_8h.html#a9">POOL_VERIFIER_MASK</a>),
01376                                            2);
01377             <span class="keywordflow">if</span> (Entry != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01378                 <span class="keywordflow">return</span> (PVOID)Entry;
01379             }
01380         }
01381     }
01382 
01383     <span class="comment">//</span>
01384     <span class="comment">// If the request is for cache aligned memory adjust the number of</span>
01385     <span class="comment">// bytes.</span>
01386     <span class="comment">//</span>
01387 
01388 <span class="preprocessor">#if POOL_CACHE_SUPPORTED</span>
01389 <span class="preprocessor"></span>
01390     <a class="code" href="../../d2/d2/ex_2pool_8c.html#a38">CacheOverhead</a> = <a class="code" href="../../d5/d2/poolhack_8c.html#a6">POOL_OVERHEAD</a>;
01391     <span class="keywordflow">if</span> (PoolType &amp; <a class="code" href="../../d4/d2/pool_8h.html#a7">CACHE_ALIGNED_POOL_TYPE_MASK</a>) {
01392         NumberOfBytes += PoolCacheOverhead;
01393         <a class="code" href="../../d2/d2/ex_2pool_8c.html#a38">CacheOverhead</a> = PoolCacheSize;
01394     }
01395 
01396 <span class="preprocessor">#endif //POOL_CACHE_SUPPORTED</span>
01397 <span class="preprocessor"></span>
01398     <span class="comment">//</span>
01399     <span class="comment">// Compute the Index of the listhead for blocks of the requested</span>
01400     <span class="comment">// size.</span>
01401     <span class="comment">//</span>
01402 
01403     ListNumber = (ULONG)((NumberOfBytes + <a class="code" href="../../d5/d2/poolhack_8c.html#a6">POOL_OVERHEAD</a> + (<a class="code" href="../../d4/d2/pool_8h.html#a20">POOL_SMALLEST_BLOCK</a> - 1)) &gt;&gt; <a class="code" href="../../d4/d2/pool_8h.html#a14">POOL_BLOCK_SHIFT</a>);
01404 
01405     NeededSize = ListNumber;
01406 
01407     <span class="comment">//</span>
01408     <span class="comment">// If the pool type is paged, then pick a starting pool number and</span>
01409     <span class="comment">// attempt to lock each paged pool in circular succession. Otherwise,</span>
01410     <span class="comment">// lock the nonpaged pool as the same lock is used for both nonpaged</span>
01411     <span class="comment">// and nonpaged must succeed.</span>
01412     <span class="comment">//</span>
01413     <span class="comment">// N.B. The paged pool is selected in a round robin fashion using a</span>
01414     <span class="comment">//      simple counter. Note that the counter is incremented using a</span>
01415     <span class="comment">//      a noninterlocked sequence, but the pool index is never allowed</span>
01416     <span class="comment">//      to get out of range.</span>
01417     <span class="comment">//</span>
01418 
01419     <span class="keywordflow">if</span> (CheckType == <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>) {
01420 
01421         <span class="comment">//</span>
01422         <span class="comment">// If the requested pool block is a small block, then attempt to</span>
01423         <span class="comment">// allocate the requested pool from the per processor lookaside</span>
01424         <span class="comment">// list. If the attempt fails, then attempt to allocate from the</span>
01425         <span class="comment">// system lookaside list. If the attempt fails, then select a</span>
01426         <span class="comment">// pool to allocate from and allocate the block normally.</span>
01427         <span class="comment">//</span>
01428         <span class="comment">// Session space allocations do not currently use lookaside lists.</span>
01429         <span class="comment">//</span>
01430 
01431         <span class="keywordflow">if</span> ((GlobalSpace == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) &amp;&amp;
01432             (NeededSize &lt;= <a class="code" href="../../d0/d9/ntosdef_8h.html#a2">POOL_SMALL_LISTS</a>) &amp;&amp;
01433             (<a class="code" href="../../d5/d3/i386_8h.html#a16">Isx86FeaturePresent</a>(<a class="code" href="../../d5/d3/i386_8h.html#a7">KF_CMPXCHG8B</a>))) {
01434 
01435             Prcb = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a2">KeGetCurrentPrcb</a>();
01436             LookasideList = Prcb-&gt;PPPagedLookasideList[NeededSize - 1].P;
01437             LookasideList-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o3">TotalAllocates</a> += 1;
01438 
01439             <a class="code" href="../../d2/d2/ex_2pool_8c.html#a23">CHECK_LOOKASIDE_LIST</a>(__LINE__, LookasideList, Entry);
01440 
01441             Entry = (<a class="code" href="../../d5/d8/struct__POOL__HEADER.html">PPOOL_HEADER</a>)
01442                 <a class="code" href="../../d5/d8/ex_8h.html#a242">ExInterlockedPopEntrySList</a> (&amp;LookasideList-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o0">ListHead</a>,
01443                                             &amp;LookasideList-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o1">Lock</a>);
01444 
01445             <span class="keywordflow">if</span> (Entry == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01446                 LookasideList = Prcb-&gt;PPPagedLookasideList[NeededSize - 1].<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>;
01447                 LookasideList-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o3">TotalAllocates</a> += 1;
01448 
01449                 <a class="code" href="../../d2/d2/ex_2pool_8c.html#a23">CHECK_LOOKASIDE_LIST</a>(__LINE__, LookasideList, Entry);
01450 
01451                 Entry = (<a class="code" href="../../d5/d8/struct__POOL__HEADER.html">PPOOL_HEADER</a>)
01452                     <a class="code" href="../../d5/d8/ex_8h.html#a242">ExInterlockedPopEntrySList</a> (&amp;LookasideList-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o0">ListHead</a>,
01453                                                 &amp;LookasideList-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o1">Lock</a>);
01454             }
01455 
01456             <span class="keywordflow">if</span> (Entry != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01457 
01458                 <a class="code" href="../../d2/d2/ex_2pool_8c.html#a23">CHECK_LOOKASIDE_LIST</a>(__LINE__, LookasideList, Entry);
01459 
01460                 Entry -= 1;
01461                 LookasideList-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o5">AllocateHits</a> += 1;
01462                 NewPoolType = (PoolType &amp; (<a class="code" href="../../d4/d2/pool_8h.html#a5">BASE_POOL_TYPE_MASK</a> | <a class="code" href="../../d4/d2/pool_8h.html#a11">POOL_QUOTA_MASK</a> | <a class="code" href="../../d4/d2/pool_8h.html#a8">SESSION_POOL_MASK</a> | <a class="code" href="../../d4/d2/pool_8h.html#a9">POOL_VERIFIER_MASK</a>)) + 1;
01463 
01464 <span class="preprocessor">#if _POOL_LOCK_GRANULAR_</span>
01465 <span class="preprocessor"></span>                PoolDesc = &amp;PoolDesc[<a class="code" href="../../d2/d2/ex_2pool_8c.html#a27">DECODE_POOL_INDEX</a>(Entry)];
01466 <span class="preprocessor">#endif</span>
01467 <span class="preprocessor"></span>
01468                 <a class="code" href="../../d2/d2/ex_2pool_8c.html#a6">LOCK_POOL_GRANULAR</a>(PoolDesc, LockHandle);
01469 
01470                 Entry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o1">PoolType</a> = (UCHAR)NewPoolType;
01471                 <a class="code" href="../../d2/d2/ex_2pool_8c.html#a28">MARK_POOL_HEADER_ALLOCATED</a>(Entry);
01472 
01473                 <a class="code" href="../../d2/d2/ex_2pool_8c.html#a7">UNLOCK_POOL_GRANULAR</a>(PoolDesc, LockHandle);
01474 
01475                 Entry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o9">PoolTag</a> = Tag;
01476 
01477                 <span class="keywordflow">if</span> ((<a class="code" href="../../d2/d2/ex_2pool_8c.html#a42">PoolTrackTable</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
01478                     ((PoolType &amp; <a class="code" href="../../d4/d2/pool_8h.html#a8">SESSION_POOL_MASK</a>) == 0)) {
01479 
01480                     <a class="code" href="../../d2/d2/ex_2pool_8c.html#a65">ExpInsertPoolTracker</a> (Tag,
01481                                           Entry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o6">BlockSize</a> &lt;&lt; <a class="code" href="../../d4/d2/pool_8h.html#a14">POOL_BLOCK_SHIFT</a>,
01482                                           PoolType);
01483                 }
01484 
01485                 <span class="comment">//</span>
01486                 <span class="comment">// Zero out any back pointer to our internal structures</span>
01487                 <span class="comment">// to stop someone from corrupting us via an</span>
01488                 <span class="comment">// uninitialized pointer.</span>
01489                 <span class="comment">//</span>
01490 
01491                 ((PULONG)((PCHAR)Entry + <a class="code" href="../../d2/d2/ex_2pool_8c.html#a38">CacheOverhead</a>))[0] = 0;
01492 
01493                 <a class="code" href="../../d2/d1/mm_8h.html#a83">PERFINFO_POOLALLOC_ADDR</a>((PUCHAR)Entry + <a class="code" href="../../d2/d2/ex_2pool_8c.html#a38">CacheOverhead</a>);
01494 
01495                 <span class="keywordflow">return</span> (PUCHAR)Entry + <a class="code" href="../../d2/d2/ex_2pool_8c.html#a38">CacheOverhead</a>;
01496             }
01497         }
01498 
01499         <span class="comment">//</span>
01500         <span class="comment">// If there is more than one paged pool, then attempt to find</span>
01501         <span class="comment">// one that can be immediately locked.</span>
01502         <span class="comment">//</span>
01503 
01504         <span class="keywordflow">if</span> (GlobalSpace == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01505 
01506             PVOID <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>;
01507 
01508             PoolIndex = 1;
01509             <span class="keywordflow">if</span> (<a class="code" href="../../d2/d2/ex_2pool_8c.html#a51">ExpNumberOfPagedPools</a> != PoolIndex) {
01510                 <a class="code" href="../../d2/d2/ex_2pool_8c.html#a57">ExpPoolIndex</a> += 1;
01511                 PoolIndex = <a class="code" href="../../d2/d2/ex_2pool_8c.html#a57">ExpPoolIndex</a>;
01512                 <span class="keywordflow">if</span> (PoolIndex &gt; <a class="code" href="../../d2/d2/ex_2pool_8c.html#a51">ExpNumberOfPagedPools</a>) {
01513                     PoolIndex = 1;
01514                     <a class="code" href="../../d2/d2/ex_2pool_8c.html#a57">ExpPoolIndex</a> = 1;
01515                 }
01516 
01517                 <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = PoolIndex;
01518                 <span class="keywordflow">do</span> {
01519                     <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a> = PoolDesc[PoolIndex].<a class="code" href="../../d4/d8/struct__POOL__DESCRIPTOR.html#o3">LockAddress</a>;
01520                     <span class="keywordflow">if</span> (ExTryToAcquireFastMutex((<a class="code" href="../../d6/d9/struct__FAST__MUTEX.html">PFAST_MUTEX</a>)<a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01521                         PoolDesc = &amp;PoolDesc[PoolIndex];
01522                         <span class="keywordflow">goto</span> PoolLocked;
01523                     }
01524 
01525                     PoolIndex += 1;
01526                     <span class="keywordflow">if</span> (PoolIndex &gt; <a class="code" href="../../d2/d2/ex_2pool_8c.html#a51">ExpNumberOfPagedPools</a>) {
01527                         PoolIndex = 1;
01528                     }
01529 
01530                 } <span class="keywordflow">while</span> (PoolIndex != <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>);
01531             }
01532             PoolDesc = &amp;PoolDesc[PoolIndex];
01533         }
01534         <span class="keywordflow">else</span> {
01535 
01536             <span class="comment">//</span>
01537             <span class="comment">// Only one paged pool is currently available per session.</span>
01538             <span class="comment">//</span>
01539 
01540             PoolIndex = 0;
01541             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (PoolDesc == <a class="code" href="../../d2/d2/ex_2pool_8c.html#a40">ExpSessionPoolDescriptor</a>);
01542         }
01543 
01544         <span class="comment">//</span>
01545         <span class="comment">// None of the paged pools could be conditionally locked or there</span>
01546         <span class="comment">// is only one paged pool. The first pool considered is picked as</span>
01547         <span class="comment">// the victim to wait on.</span>
01548         <span class="comment">//</span>
01549 
01550         ExAcquireFastMutex((<a class="code" href="../../d6/d9/struct__FAST__MUTEX.html">PFAST_MUTEX</a>)PoolDesc-&gt;<a class="code" href="../../d4/d8/struct__POOL__DESCRIPTOR.html#o3">LockAddress</a>);
01551 PoolLocked:
01552 
01553         GlobalSpace = GlobalSpace;
01554 <span class="preprocessor">#if DBG</span>
01555 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (GlobalSpace == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01556             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PoolIndex == PoolDesc-&gt;<a class="code" href="../../d4/d8/struct__POOL__DESCRIPTOR.html#o5">PoolIndex</a>);
01557         }
01558         <span class="keywordflow">else</span> {
01559             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PoolIndex == 0);
01560             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PoolDesc-&gt;<a class="code" href="../../d4/d8/struct__POOL__DESCRIPTOR.html#o5">PoolIndex</a> == 0);
01561         }
01562 <span class="preprocessor">#endif</span>
01563 <span class="preprocessor"></span>
01564     } <span class="keywordflow">else</span> {
01565 
01566         <span class="comment">//</span>
01567         <span class="comment">// If the requested pool block is a small block, then attempt to</span>
01568         <span class="comment">// allocate the requested pool from the per processor lookaside</span>
01569         <span class="comment">// list. If the attempt fails, then attempt to allocate from the</span>
01570         <span class="comment">// system lookaside list. If the attempt fails, then select a</span>
01571         <span class="comment">// pool to allocate from and allocate the block normally.</span>
01572         <span class="comment">//</span>
01573 
01574         <span class="keywordflow">if</span> (GlobalSpace == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> &amp;&amp; NeededSize &lt;= <a class="code" href="../../d0/d9/ntosdef_8h.html#a2">POOL_SMALL_LISTS</a>) {
01575             Prcb = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a2">KeGetCurrentPrcb</a>();
01576             LookasideList = Prcb-&gt;PPNPagedLookasideList[NeededSize - 1].P;
01577             LookasideList-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o3">TotalAllocates</a> += 1;
01578 
01579             <a class="code" href="../../d2/d2/ex_2pool_8c.html#a23">CHECK_LOOKASIDE_LIST</a>(__LINE__, LookasideList, 0);
01580 
01581             Entry = (<a class="code" href="../../d5/d8/struct__POOL__HEADER.html">PPOOL_HEADER</a>)
01582                         <a class="code" href="../../d5/d8/ex_8h.html#a242">ExInterlockedPopEntrySList</a> (&amp;LookasideList-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o0">ListHead</a>,
01583                                                     &amp;LookasideList-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o1">Lock</a>);
01584 
01585             <span class="keywordflow">if</span> (Entry == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01586                 LookasideList = Prcb-&gt;PPNPagedLookasideList[NeededSize - 1].<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>;
01587                 LookasideList-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o3">TotalAllocates</a> += 1;
01588 
01589                 <a class="code" href="../../d2/d2/ex_2pool_8c.html#a23">CHECK_LOOKASIDE_LIST</a>(__LINE__, LookasideList, 0);
01590 
01591                 Entry = (<a class="code" href="../../d5/d8/struct__POOL__HEADER.html">PPOOL_HEADER</a>)
01592                         <a class="code" href="../../d5/d8/ex_8h.html#a242">ExInterlockedPopEntrySList</a> (&amp;LookasideList-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o0">ListHead</a>,
01593                                                     &amp;LookasideList-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o1">Lock</a>);
01594             }
01595 
01596             <span class="keywordflow">if</span> (Entry != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01597 
01598                 <a class="code" href="../../d2/d2/ex_2pool_8c.html#a23">CHECK_LOOKASIDE_LIST</a>(__LINE__, LookasideList, Entry);
01599 
01600                 Entry -= 1;
01601                 LookasideList-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o5">AllocateHits</a> += 1;
01602                 NewPoolType = (PoolType &amp; (<a class="code" href="../../d4/d2/pool_8h.html#a5">BASE_POOL_TYPE_MASK</a> | <a class="code" href="../../d4/d2/pool_8h.html#a11">POOL_QUOTA_MASK</a> | <a class="code" href="../../d4/d2/pool_8h.html#a8">SESSION_POOL_MASK</a> | <a class="code" href="../../d4/d2/pool_8h.html#a9">POOL_VERIFIER_MASK</a>)) + 1;
01603 
01604                 <a class="code" href="../../d2/d2/ex_2pool_8c.html#a6">LOCK_POOL_GRANULAR</a>(PoolDesc, LockHandle);
01605 
01606                 Entry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o1">PoolType</a> = (UCHAR)NewPoolType;
01607                 <a class="code" href="../../d2/d2/ex_2pool_8c.html#a28">MARK_POOL_HEADER_ALLOCATED</a>(Entry);
01608 
01609                 <a class="code" href="../../d2/d2/ex_2pool_8c.html#a7">UNLOCK_POOL_GRANULAR</a>(PoolDesc, LockHandle);
01610 
01611                 Entry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o9">PoolTag</a> = Tag;
01612 
01613                 <span class="keywordflow">if</span> (<a class="code" href="../../d2/d2/ex_2pool_8c.html#a42">PoolTrackTable</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01614 
01615                     <a class="code" href="../../d2/d2/ex_2pool_8c.html#a65">ExpInsertPoolTracker</a> (Tag,
01616                                           Entry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o6">BlockSize</a> &lt;&lt; <a class="code" href="../../d4/d2/pool_8h.html#a14">POOL_BLOCK_SHIFT</a>,
01617                                           PoolType);
01618                 }
01619 
01620                 <span class="comment">//</span>
01621                 <span class="comment">// Zero out any back pointer to our internal structures</span>
01622                 <span class="comment">// to stop someone from corrupting us via an</span>
01623                 <span class="comment">// uninitialized pointer.</span>
01624                 <span class="comment">//</span>
01625 
01626                 ((PULONG)((PCHAR)Entry + <a class="code" href="../../d2/d2/ex_2pool_8c.html#a38">CacheOverhead</a>))[0] = 0;
01627 
01628                 <a class="code" href="../../d2/d1/mm_8h.html#a83">PERFINFO_POOLALLOC_ADDR</a>((PUCHAR)Entry + <a class="code" href="../../d2/d2/ex_2pool_8c.html#a38">CacheOverhead</a>);
01629 
01630                 <span class="keywordflow">return</span> (PUCHAR)Entry + <a class="code" href="../../d2/d2/ex_2pool_8c.html#a38">CacheOverhead</a>;
01631             }
01632         }
01633 
01634         PoolIndex = 0;
01635         ExAcquireSpinLock(&amp;<a class="code" href="../../d2/d2/ex_2pool_8c.html#a56">NonPagedPoolLock</a>, &amp;LockHandle);
01636 
01637         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PoolIndex == PoolDesc-&gt;<a class="code" href="../../d4/d8/struct__POOL__DESCRIPTOR.html#o5">PoolIndex</a>);
01638     }
01639 
01640     <span class="comment">//</span>
01641     <span class="comment">// The following code has an outer loop and an inner loop.</span>
01642     <span class="comment">//</span>
01643     <span class="comment">// The outer loop is utilized to repeat a nonpaged must succeed</span>
01644     <span class="comment">// allocation if necessary.</span>
01645     <span class="comment">//</span>
01646     <span class="comment">// The inner loop is used to repeat an allocation attempt if there</span>
01647     <span class="comment">// are no entries in any of the pool lists.</span>
01648     <span class="comment">//</span>
01649 
01650     RequestType = PoolType &amp; (<a class="code" href="../../d4/d2/pool_8h.html#a5">BASE_POOL_TYPE_MASK</a> | <a class="code" href="../../d4/d2/pool_8h.html#a8">SESSION_POOL_MASK</a>);
01651 
01652     PoolDesc-&gt;<a class="code" href="../../d4/d8/struct__POOL__DESCRIPTOR.html#o6">RunningAllocs</a> += 1;
01653     ListHead = &amp;PoolDesc-&gt;<a class="code" href="../../d4/d8/struct__POOL__DESCRIPTOR.html#o4">ListHeads</a>[ListNumber];
01654 
01655     <span class="keywordflow">do</span> {
01656 
01657         <span class="comment">//</span>
01658         <span class="comment">// Attempt to allocate the requested block from the current free</span>
01659         <span class="comment">// blocks.</span>
01660         <span class="comment">//</span>
01661 
01662         <span class="keywordflow">do</span> {
01663 
01664             <span class="comment">//</span>
01665             <span class="comment">// If the list is not empty, then allocate a block from the</span>
01666             <span class="comment">// selected list.</span>
01667             <span class="comment">//</span>
01668 
01669             <span class="keywordflow">if</span> (<a class="code" href="../../d2/d2/ex_2pool_8c.html#a11">PrivateIsListEmpty</a>(ListHead) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01670 
01671                 <a class="code" href="../../d2/d2/ex_2pool_8c.html#a17">CHECK_LIST</a>( __LINE__, ListHead, 0 );
01672                 Block = <a class="code" href="../../d2/d2/ex_2pool_8c.html#a12">PrivateRemoveHeadList</a>(ListHead);
01673                 <a class="code" href="../../d2/d2/ex_2pool_8c.html#a17">CHECK_LIST</a>( __LINE__, ListHead, 0 );
01674                 Entry = (<a class="code" href="../../d5/d8/struct__POOL__HEADER.html">PPOOL_HEADER</a>)((PCHAR)Block - <a class="code" href="../../d5/d2/poolhack_8c.html#a6">POOL_OVERHEAD</a>);
01675 
01676                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Entry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o6">BlockSize</a> &gt;= NeededSize);
01677 
01678                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d2/d2/ex_2pool_8c.html#a27">DECODE_POOL_INDEX</a>(Entry) == PoolIndex);
01679 
01680                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(Entry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o1">PoolType</a> == 0);
01681 
01682                 <span class="keywordflow">if</span> (Entry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o6">BlockSize</a> != NeededSize) {
01683 
01684                     <span class="comment">//</span>
01685                     <span class="comment">// The selected block is larger than the allocation</span>
01686                     <span class="comment">// request. Split the block and insert the remaining</span>
01687                     <span class="comment">// fragment in the appropriate list.</span>
01688                     <span class="comment">//</span>
01689                     <span class="comment">// If the entry is at the start of a page, then take</span>
01690                     <span class="comment">// the allocation from the front of the block so as</span>
01691                     <span class="comment">// to minimize fragmentation. Otherwise, take the</span>
01692                     <span class="comment">// allocation from the end of the block which may</span>
01693                     <span class="comment">// also reduce fragmentation if the block is at the</span>
01694                     <span class="comment">// end of a page.</span>
01695                     <span class="comment">//</span>
01696 
01697                     <span class="keywordflow">if</span> (Entry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o3">PreviousSize</a> == 0) {
01698 
01699                         <span class="comment">//</span>
01700                         <span class="comment">// The entry is at the start of a page.</span>
01701                         <span class="comment">//</span>
01702 
01703                         SplitEntry = (<a class="code" href="../../d5/d8/struct__POOL__HEADER.html">PPOOL_HEADER</a>)((<a class="code" href="../../d3/d8/struct__POOL__BLOCK.html">PPOOL_BLOCK</a>)Entry + NeededSize);
01704                         SplitEntry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o6">BlockSize</a> = (UCHAR)(Entry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o6">BlockSize</a> - (UCHAR)NeededSize);
01705                         SplitEntry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o3">PreviousSize</a> = (UCHAR)NeededSize;
01706 
01707                         <span class="comment">//</span>
01708                         <span class="comment">// If the allocated block is not at the end of a</span>
01709                         <span class="comment">// page, then adjust the size of the next block.</span>
01710                         <span class="comment">//</span>
01711 
01712                         NextEntry = (<a class="code" href="../../d5/d8/struct__POOL__HEADER.html">PPOOL_HEADER</a>)((<a class="code" href="../../d3/d8/struct__POOL__BLOCK.html">PPOOL_BLOCK</a>)SplitEntry + SplitEntry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o6">BlockSize</a>);
01713                         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d2/pool_8h.html#a17">PAGE_END</a>(NextEntry) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01714                             NextEntry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o3">PreviousSize</a> = SplitEntry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o6">BlockSize</a>;
01715                         }
01716 
01717                     } <span class="keywordflow">else</span> {
01718 
01719                         <span class="comment">//</span>
01720                         <span class="comment">// The entry is not at the start of a page.</span>
01721                         <span class="comment">//</span>
01722 
01723                         SplitEntry = Entry;
01724                         Entry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o6">BlockSize</a> -= (UCHAR)NeededSize;
01725                         Entry = (<a class="code" href="../../d5/d8/struct__POOL__HEADER.html">PPOOL_HEADER</a>)((<a class="code" href="../../d3/d8/struct__POOL__BLOCK.html">PPOOL_BLOCK</a>)Entry + Entry-&gt;BlockSize);
01726                         Entry-&gt;PreviousSize = SplitEntry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o6">BlockSize</a>;
01727 
01728                         <span class="comment">//</span>
01729                         <span class="comment">// If the allocated block is not at the end of a</span>
01730                         <span class="comment">// page, then adjust the size of the next block.</span>
01731                         <span class="comment">//</span>
01732 
01733                         NextEntry = (<a class="code" href="../../d5/d8/struct__POOL__HEADER.html">PPOOL_HEADER</a>)((<a class="code" href="../../d3/d8/struct__POOL__BLOCK.html">PPOOL_BLOCK</a>)Entry + NeededSize);
01734                         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d2/pool_8h.html#a17">PAGE_END</a>(NextEntry) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01735                             NextEntry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o3">PreviousSize</a> = (UCHAR)NeededSize;
01736                         }
01737                     }
01738 
01739                     <span class="comment">//</span>
01740                     <span class="comment">// Set the size of the allocated entry, clear the pool</span>
01741                     <span class="comment">// type of the split entry, set the index of the split</span>
01742                     <span class="comment">// entry, and insert the split entry in the appropriate</span>
01743                     <span class="comment">// free list.</span>
01744                     <span class="comment">//</span>
01745 
01746                     Entry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o6">BlockSize</a> = (UCHAR)NeededSize;
01747                     <a class="code" href="../../d2/d2/ex_2pool_8c.html#a26">ENCODE_POOL_INDEX</a>(Entry, PoolIndex);
01748                     SplitEntry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o1">PoolType</a> = 0;
01749                     <a class="code" href="../../d2/d2/ex_2pool_8c.html#a26">ENCODE_POOL_INDEX</a>(SplitEntry, PoolIndex);
01750                     <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = SplitEntry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o6">BlockSize</a>;
01751 
01752                     <a class="code" href="../../d2/d2/ex_2pool_8c.html#a17">CHECK_LIST</a>(__LINE__, &amp;PoolDesc-&gt;<a class="code" href="../../d4/d8/struct__POOL__DESCRIPTOR.html#o4">ListHeads</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> - 1], 0);
01753                     <a class="code" href="../../d2/d2/ex_2pool_8c.html#a15">PrivateInsertTailList</a>(&amp;PoolDesc-&gt;<a class="code" href="../../d4/d8/struct__POOL__DESCRIPTOR.html#o4">ListHeads</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> - 1], ((PLIST_ENTRY)((PCHAR)SplitEntry + <a class="code" href="../../d5/d2/poolhack_8c.html#a6">POOL_OVERHEAD</a>)));
01754                     <a class="code" href="../../d2/d2/ex_2pool_8c.html#a17">CHECK_LIST</a>(__LINE__, &amp;PoolDesc-&gt;<a class="code" href="../../d4/d8/struct__POOL__DESCRIPTOR.html#o4">ListHeads</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> - 1], 0);
01755                     <a class="code" href="../../d2/d2/ex_2pool_8c.html#a17">CHECK_LIST</a>(__LINE__, ((PLIST_ENTRY)((PCHAR)SplitEntry + <a class="code" href="../../d5/d2/poolhack_8c.html#a6">POOL_OVERHEAD</a>)), 0);
01756                 }
01757 
01758                 Entry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o1">PoolType</a> = (UCHAR)((PoolType &amp; (<a class="code" href="../../d4/d2/pool_8h.html#a5">BASE_POOL_TYPE_MASK</a> | <a class="code" href="../../d4/d2/pool_8h.html#a11">POOL_QUOTA_MASK</a> | <a class="code" href="../../d4/d2/pool_8h.html#a8">SESSION_POOL_MASK</a> | <a class="code" href="../../d4/d2/pool_8h.html#a9">POOL_VERIFIER_MASK</a>)) + 1);
01759 
01760                 <a class="code" href="../../d2/d2/ex_2pool_8c.html#a28">MARK_POOL_HEADER_ALLOCATED</a>(Entry);
01761 
01762                 <a class="code" href="../../d2/d2/ex_2pool_8c.html#a18">CHECK_POOL_HEADER</a>(__LINE__, Entry);
01763 
01764                 <span class="comment">//</span>
01765                 <span class="comment">// Notify the memory manager of session pool allocations</span>
01766                 <span class="comment">// so leaked allocations can be caught on session exit.</span>
01767                 <span class="comment">// This call must be made with the relevant pool locked.</span>
01768                 <span class="comment">//</span>
01769 
01770                 <span class="keywordflow">if</span> (PoolType &amp; <a class="code" href="../../d4/d2/pool_8h.html#a8">SESSION_POOL_MASK</a>) {
01771                     <a class="code" href="../../d1/d6/allocpag_8c.html#a50">MiSessionPoolAllocated</a>(
01772                         (PVOID)((PCHAR)Entry + <a class="code" href="../../d2/d2/ex_2pool_8c.html#a38">CacheOverhead</a>),
01773                         (ULONG)(Entry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o6">BlockSize</a> &lt;&lt; <a class="code" href="../../d4/d2/pool_8h.html#a14">POOL_BLOCK_SHIFT</a>),
01774                         PoolType);
01775                 }
01776 
01777                 <a class="code" href="../../d2/d2/ex_2pool_8c.html#a35">UNLOCK_POOL</a>(PoolDesc, LockHandle);
01778 
01779                 Entry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o9">PoolTag</a> = Tag;
01780 
01781                 <span class="keywordflow">if</span> ((<a class="code" href="../../d2/d2/ex_2pool_8c.html#a42">PoolTrackTable</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
01782                     ((PoolType &amp; <a class="code" href="../../d4/d2/pool_8h.html#a8">SESSION_POOL_MASK</a>) == 0)) {
01783 
01784                     <a class="code" href="../../d2/d2/ex_2pool_8c.html#a65">ExpInsertPoolTracker</a> (Tag,
01785                                           Entry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o6">BlockSize</a> &lt;&lt; <a class="code" href="../../d4/d2/pool_8h.html#a14">POOL_BLOCK_SHIFT</a>,
01786                                           PoolType);
01787                 }
01788 
01789                 <span class="comment">//</span>
01790                 <span class="comment">// Zero out any back pointer to our internal structures</span>
01791                 <span class="comment">// to stop someone from corrupting us via an</span>
01792                 <span class="comment">// uninitialized pointer.</span>
01793                 <span class="comment">//</span>
01794 
01795                 ((PULONGLONG)((PCHAR)Entry + <a class="code" href="../../d2/d2/ex_2pool_8c.html#a38">CacheOverhead</a>))[0] = 0;
01796 
01797                 <a class="code" href="../../d2/d1/mm_8h.html#a83">PERFINFO_POOLALLOC_ADDR</a>((PUCHAR)Entry + <a class="code" href="../../d2/d2/ex_2pool_8c.html#a38">CacheOverhead</a>);
01798                 <span class="keywordflow">return</span> (PCHAR)Entry + <a class="code" href="../../d2/d2/ex_2pool_8c.html#a38">CacheOverhead</a>;
01799 
01800             }
01801             ListHead += 1;
01802 
01803         } <span class="keywordflow">while</span> (ListHead != &amp;PoolDesc-&gt;<a class="code" href="../../d4/d8/struct__POOL__DESCRIPTOR.html#o4">ListHeads</a>[<a class="code" href="../../d5/d2/poolhack_8c.html#a2">POOL_LIST_HEADS</a>]);
01804 
01805         <span class="comment">//</span>
01806         <span class="comment">// A block of the desired size does not exist and there are</span>
01807         <span class="comment">// no large blocks that can be split to satisfy the allocation.</span>
01808         <span class="comment">// Attempt to expand the pool by allocating another page to be</span>
01809         <span class="comment">// added to the pool.</span>
01810         <span class="comment">//</span>
01811         <span class="comment">// If the pool type is paged pool, then the paged pool page lock</span>
01812         <span class="comment">// must be held during the allocation of the pool pages.</span>
01813         <span class="comment">//</span>
01814 
01815         <a class="code" href="../../d2/d2/ex_2pool_8c.html#a34">LOCK_IF_PAGED_POOL</a>(CheckType, GlobalSpace);
01816 
01817         Entry = (<a class="code" href="../../d5/d8/struct__POOL__HEADER.html">PPOOL_HEADER</a>)<a class="code" href="../../d1/d6/allocpag_8c.html#a54">MiAllocatePoolPages</a> (RequestType,
01818                                                    <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>,
01819                                                    <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
01820 
01821         <a class="code" href="../../d2/d2/ex_2pool_8c.html#a36">UNLOCK_IF_PAGED_POOL</a>(CheckType, GlobalSpace);
01822 
01823         <span class="keywordflow">if</span> (Entry == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01824             <span class="keywordflow">if</span> ((PoolType &amp; <a class="code" href="../../d4/d2/pool_8h.html#a6">MUST_SUCCEED_POOL_TYPE_MASK</a>) != 0) {
01825 
01826                 <span class="comment">//</span>
01827                 <span class="comment">// Must succeed pool was requested. Reset the type,</span>
01828                 <span class="comment">// the pool descriptor address, and continue the search.</span>
01829                 <span class="comment">//</span>
01830 
01831                 CheckType = <a class="code" href="../../d5/d8/ex_8h.html#a329a175">NonPagedPoolMustSucceed</a>;
01832                 RequestType = RequestType | <a class="code" href="../../d4/d2/pool_8h.html#a6">MUST_SUCCEED_POOL_TYPE_MASK</a>;
01833                 PoolDesc = <a class="code" href="../../d2/d2/ex_2pool_8c.html#a54">PoolVector</a>[<a class="code" href="../../d5/d8/ex_8h.html#a329a175">NonPagedPoolMustSucceed</a>];
01834                 ListHead = &amp;PoolDesc-&gt;<a class="code" href="../../d4/d8/struct__POOL__DESCRIPTOR.html#o4">ListHeads</a>[ListNumber];
01835                 <span class="keywordflow">continue</span>;
01836 
01837             } <span class="keywordflow">else</span> {
01838 
01839                 <span class="comment">//</span>
01840                 <span class="comment">// No more pool of the specified type is available.</span>
01841                 <span class="comment">//</span>
01842 
01843                 KdPrint((<span class="stringliteral">"EX: ExAllocatePool (%p, 0x%x ) returning NULL\n"</span>,
01844                     NumberOfBytes,
01845                     PoolType));
01846 
01847                 <a class="code" href="../../d2/d2/ex_2pool_8c.html#a35">UNLOCK_POOL</a>(PoolDesc, LockHandle);
01848 
01849                 <span class="keywordflow">if</span> ((PoolType &amp; <a class="code" href="../../d5/d8/ex_8h.html#a3">POOL_RAISE_IF_ALLOCATION_FAILURE</a>) != 0) {
01850                     <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>(STATUS_INSUFFICIENT_RESOURCES);
01851                 }
01852 
01853                 <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01854             }
01855         }
01856 
01857         <span class="comment">//</span>
01858         <span class="comment">// Insert the allocated page in the last allocation list.</span>
01859         <span class="comment">//</span>
01860 
01861         PoolDesc-&gt;<a class="code" href="../../d4/d8/struct__POOL__DESCRIPTOR.html#o1">TotalPages</a> += 1;
01862         Entry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o1">PoolType</a> = 0;
01863         <a class="code" href="../../d2/d2/ex_2pool_8c.html#a26">ENCODE_POOL_INDEX</a>(Entry, PoolIndex);
01864 
01865         <a class="code" href="../../d2/d1/mm_8h.html#a32">PERFINFO_ADDPOOLPAGE</a>(CheckType, PoolIndex, Entry, PoolDesc);
01866 
01867         <span class="comment">//</span>
01868         <span class="comment">// N.B. A byte is used to store the block size in units of the</span>
01869         <span class="comment">//      smallest block size. Therefore, if the number of small</span>
01870         <span class="comment">//      blocks in the page is greater than 255, the block size</span>
01871         <span class="comment">//      is set to 255.</span>
01872         <span class="comment">//</span>
01873 
01874         <span class="keywordflow">if</span> ((<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> / <a class="code" href="../../d4/d2/pool_8h.html#a20">POOL_SMALLEST_BLOCK</a>) &gt; 255) {
01875             Entry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o6">BlockSize</a> = 255;
01876 
01877         } <span class="keywordflow">else</span> {
01878             Entry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o6">BlockSize</a> = (UCHAR)(<a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> / <a class="code" href="../../d4/d2/pool_8h.html#a20">POOL_SMALLEST_BLOCK</a>);
01879         }
01880 
01881         Entry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o3">PreviousSize</a> = 0;
01882         ListHead = &amp;PoolDesc-&gt;<a class="code" href="../../d4/d8/struct__POOL__DESCRIPTOR.html#o4">ListHeads</a>[<a class="code" href="../../d5/d2/poolhack_8c.html#a2">POOL_LIST_HEADS</a> - 1];
01883 
01884         <a class="code" href="../../d2/d2/ex_2pool_8c.html#a17">CHECK_LIST</a>(__LINE__, ListHead, 0);
01885         <a class="code" href="../../d2/d2/ex_2pool_8c.html#a16">PrivateInsertHeadList</a>(ListHead, ((PLIST_ENTRY)((PCHAR)Entry + <a class="code" href="../../d5/d2/poolhack_8c.html#a6">POOL_OVERHEAD</a>)));
01886         <a class="code" href="../../d2/d2/ex_2pool_8c.html#a17">CHECK_LIST</a>(__LINE__, ListHead, 0);
01887         <a class="code" href="../../d2/d2/ex_2pool_8c.html#a17">CHECK_LIST</a>(__LINE__, ((PLIST_ENTRY)((PCHAR)Entry + <a class="code" href="../../d5/d2/poolhack_8c.html#a6">POOL_OVERHEAD</a>)), 0);
01888 
01889     } <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01890 }
01891 
01892 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01893"></a><a class="code" href="../../d5/d8/ex_8h.html#a216">01893</a> <a class="code" href="../../d5/d8/ex_8h.html#a216">ExInsertPoolTag</a> (
01894     ULONG Tag,
01895     PVOID Va,
01896     SIZE_T NumberOfBytes,
01897     POOL_TYPE PoolType
01898     )
01899 
01900 <span class="comment">/*++</span>
01901 <span class="comment"></span>
01902 <span class="comment">Routine Description:</span>
01903 <span class="comment"></span>
01904 <span class="comment">    This function inserts a pool tag in the tag table and increments the</span>
01905 <span class="comment">    number of allocates and updates the total allocation size.</span>
01906 <span class="comment"></span>
01907 <span class="comment">    This function also inserts the pool tag in the big page tag table.</span>
01908 <span class="comment"></span>
01909 <span class="comment">    N.B. This function is for use by memory management ONLY.</span>
01910 <span class="comment"></span>
01911 <span class="comment">Arguments:</span>
01912 <span class="comment"></span>
01913 <span class="comment">    Tag - Supplies the tag used to insert an entry in the tag table.</span>
01914 <span class="comment"></span>
01915 <span class="comment">    Va - Supplies the allocated virtual address.</span>
01916 <span class="comment"></span>
01917 <span class="comment">    NumberOfBytes - Supplies the allocation size in bytes.</span>
01918 <span class="comment"></span>
01919 <span class="comment">    PoolType - Supplies the pool type.</span>
01920 <span class="comment"></span>
01921 <span class="comment">Return Value:</span>
01922 <span class="comment"></span>
01923 <span class="comment">    None.</span>
01924 <span class="comment"></span>
01925 <span class="comment">Environment:</span>
01926 <span class="comment"></span>
01927 <span class="comment">    No pool locks held so pool may be freely allocated here as needed.</span>
01928 <span class="comment"></span>
01929 <span class="comment">--*/</span>
01930 
01931 {
01932     ULONG NumberOfPages;
01933 
01934     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((PoolType &amp; <a class="code" href="../../d4/d2/pool_8h.html#a8">SESSION_POOL_MASK</a>) == 0);
01935 
01936     <span class="keywordflow">if</span> ((<a class="code" href="../../d2/d2/ex_2pool_8c.html#a45">PoolBigPageTable</a>) &amp;&amp; (NumberOfBytes &gt;= <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>)) {
01937 
01938         NumberOfPages = <a class="code" href="../../d2/d1/mm_8h.html#a5">BYTES_TO_PAGES</a>(NumberOfBytes);
01939 
01940         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d2/ex_2pool_8c.html#a67">ExpAddTagForBigPages</a>((PVOID)Va, Tag, NumberOfPages) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01941             Tag = ' GIB';
01942         }
01943     }
01944 
01945     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d2/ex_2pool_8c.html#a42">PoolTrackTable</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01946         <a class="code" href="../../d2/d2/ex_2pool_8c.html#a65">ExpInsertPoolTracker</a> (Tag, NumberOfBytes, <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>);
01947     }
01948 }
01949 
01950 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l01951"></a><a class="code" href="../../d2/d2/ex_2pool_8c.html#a80">01951</a> <a class="code" href="../../d2/d2/ex_2pool_8c.html#a80">ExRemovePoolTag</a> (
01952     ULONG Tag,
01953     PVOID Va,
01954     SIZE_T NumberOfBytes
01955     )
01956 
01957 <span class="comment">/*++</span>
01958 <span class="comment"></span>
01959 <span class="comment">Routine Description:</span>
01960 <span class="comment"></span>
01961 <span class="comment">    This function removes a pool tag from the tag table and increments the</span>
01962 <span class="comment">    number of frees and updates the total allocation size.</span>
01963 <span class="comment"></span>
01964 <span class="comment">    This function also removes the pool tag from the big page tag table.</span>
01965 <span class="comment"></span>
01966 <span class="comment">    N.B. This function is for use by memory management ONLY.</span>
01967 <span class="comment"></span>
01968 <span class="comment">Arguments:</span>
01969 <span class="comment"></span>
01970 <span class="comment">    Tag - Supplies the tag used to remove an entry in the tag table.</span>
01971 <span class="comment"></span>
01972 <span class="comment">    Va - Supplies the allocated virtual address.</span>
01973 <span class="comment"></span>
01974 <span class="comment">    NumberOfBytes - Supplies the allocation size in bytes.</span>
01975 <span class="comment"></span>
01976 <span class="comment">Return Value:</span>
01977 <span class="comment"></span>
01978 <span class="comment">    None.</span>
01979 <span class="comment"></span>
01980 <span class="comment">Environment:</span>
01981 <span class="comment"></span>
01982 <span class="comment">    No pool locks held so pool may be freely allocated here as needed.</span>
01983 <span class="comment"></span>
01984 <span class="comment">--*/</span>
01985 
01986 {
01987     <span class="keywordflow">if</span> ((<a class="code" href="../../d2/d2/ex_2pool_8c.html#a45">PoolBigPageTable</a>) &amp;&amp; (NumberOfBytes &gt;= <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>)) {
01988         <a class="code" href="../../d2/d2/ex_2pool_8c.html#a68">ExpFindAndRemoveTagBigPages</a> (Va);
01989     }
01990 
01991     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d2/ex_2pool_8c.html#a42">PoolTrackTable</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01992         <a class="code" href="../../d2/d2/ex_2pool_8c.html#a66">ExpRemovePoolTracker</a>(Tag,
01993                              (ULONG)NumberOfBytes,
01994                              <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>);
01995     }
01996 }
01997 
01998 
01999 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02000"></a><a class="code" href="../../d2/d2/ex_2pool_8c.html#a65">02000</a> <a class="code" href="../../d2/d2/ex_2pool_8c.html#a65">ExpInsertPoolTracker</a> (
02001     IN ULONG Key,
02002     IN SIZE_T Size,
02003     IN POOL_TYPE PoolType
02004     )
02005 
02006 <span class="comment">/*++</span>
02007 <span class="comment"></span>
02008 <span class="comment">Routine Description:</span>
02009 <span class="comment"></span>
02010 <span class="comment">    This function inserts a pool tag in the tag table and increments the</span>
02011 <span class="comment">    number of allocates and updates the total allocation size.</span>
02012 <span class="comment"></span>
02013 <span class="comment">Arguments:</span>
02014 <span class="comment"></span>
02015 <span class="comment">    Key - Supplies the key value used to locate a matching entry in the</span>
02016 <span class="comment">          tag table.</span>
02017 <span class="comment"></span>
02018 <span class="comment">    Size - Supplies the allocation size.</span>
02019 <span class="comment"></span>
02020 <span class="comment">    PoolType - Supplies the pool type.</span>
02021 <span class="comment"></span>
02022 <span class="comment">Return Value:</span>
02023 <span class="comment"></span>
02024 <span class="comment">    None.</span>
02025 <span class="comment"></span>
02026 <span class="comment">Environment:</span>
02027 <span class="comment"></span>
02028 <span class="comment">    No pool locks held so pool may be freely allocated here as needed.</span>
02029 <span class="comment"></span>
02030 <span class="comment">--*/</span>
02031 
02032 {
02033     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> Result;
02034     ULONG Hash;
02035     ULONG OriginalKey;
02036     ULONG OriginalHash;
02037     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
02038     KIRQL OldIrql;
02039     KIRQL LockHandle;
02040     ULONG BigPages;
02041     LOGICAL HashedIt;
02042     SIZE_T NewSize;
02043     SIZE_T SizeInBytes;
02044     SIZE_T NewSizeInBytes;
02045     SIZE_T NewSizeMask;
02046     <a class="code" href="../../d2/d9/struct__POOL__TRACKER__TABLE.html">PPOOL_TRACKER_TABLE</a> OldTable;
02047     <a class="code" href="../../d2/d9/struct__POOL__TRACKER__TABLE.html">PPOOL_TRACKER_TABLE</a> NewTable;
02048 
02049     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((PoolType &amp; <a class="code" href="../../d4/d2/pool_8h.html#a8">SESSION_POOL_MASK</a>) == 0);
02050 
02051     <span class="comment">//</span>
02052     <span class="comment">// Ignore protected pool bit except for returned hash index.</span>
02053     <span class="comment">//</span>
02054 
02055     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a> &amp; <a class="code" href="../../d5/d8/ex_8h.html#a6">PROTECTED_POOL</a>) {
02056         <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a> &amp;= ~<a class="code" href="../../d5/d8/ex_8h.html#a6">PROTECTED_POOL</a>;
02057         Result = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(<a class="code" href="../../d5/d8/ex_8h.html#a6">PROTECTED_POOL</a> &gt;&gt; 16);
02058     } <span class="keywordflow">else</span> {
02059         Result = 0;
02060     }
02061 
02062     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a> == <a class="code" href="../../d2/d2/ex_2pool_8c.html#a48">PoolHitTag</a>) {
02063         DbgBreakPoint();
02064     }
02065 
02066 retry:
02067 
02068     <span class="comment">//</span>
02069     <span class="comment">// Compute hash index and search for pool tag.</span>
02070     <span class="comment">//</span>
02071 
02072     ExAcquireSpinLock(&amp;<a class="code" href="../../d2/d2/ex_2pool_8c.html#a58">ExpTaggedPoolLock</a>, &amp;OldIrql);
02073 
02074     Hash = ((40543*((((((((PUCHAR)&amp;<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>)[0]&lt;&lt;2)^((PUCHAR)&amp;<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>)[1])&lt;&lt;2)^((PUCHAR)&amp;<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>)[2])&lt;&lt;2)^((PUCHAR)&amp;<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>)[3]))&gt;&gt;2) &amp; (ULONG)<a class="code" href="../../d2/d2/ex_2pool_8c.html#a44">PoolTrackTableMask</a>;
02075     <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = Hash;
02076 
02077     <span class="keywordflow">do</span> {
02078         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d2/ex_2pool_8c.html#a42">PoolTrackTable</a>[Hash].<a class="code" href="../../d2/d9/struct__POOL__TRACKER__TABLE.html#o0">Key</a> == <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>) {
02079             <a class="code" href="../../d2/d2/ex_2pool_8c.html#a42">PoolTrackTable</a>[Hash].<a class="code" href="../../d2/d9/struct__POOL__TRACKER__TABLE.html#o0">Key</a> = <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>;
02080             <span class="keywordflow">goto</span> EntryFound;
02081         }
02082 
02083         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d2/ex_2pool_8c.html#a42">PoolTrackTable</a>[Hash].<a class="code" href="../../d2/d9/struct__POOL__TRACKER__TABLE.html#o0">Key</a> == 0 &amp;&amp; Hash != <a class="code" href="../../d2/d2/ex_2pool_8c.html#a43">PoolTrackTableSize</a> - 1) {
02084             <a class="code" href="../../d2/d2/ex_2pool_8c.html#a42">PoolTrackTable</a>[Hash].<a class="code" href="../../d2/d9/struct__POOL__TRACKER__TABLE.html#o0">Key</a> = <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>;
02085             <span class="keywordflow">goto</span> EntryFound;
02086         }
02087 
02088         Hash = (Hash + 1) &amp; (ULONG)<a class="code" href="../../d2/d2/ex_2pool_8c.html#a44">PoolTrackTableMask</a>;
02089     } <span class="keywordflow">while</span> (Hash != <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>);
02090 
02091     <span class="comment">//</span>
02092     <span class="comment">// No matching entry and no free entry was found.</span>
02093     <span class="comment">// If the overflow bucket has been used then expansion of the tracker table</span>
02094     <span class="comment">// is not allowed because a subsequent free of a tag can go negative as the</span>
02095     <span class="comment">// original allocation is in overflow and a newer allocation may be</span>
02096     <span class="comment">// distinct.</span>
02097     <span class="comment">//</span>
02098 
02099     NewSize = ((<a class="code" href="../../d2/d2/ex_2pool_8c.html#a43">PoolTrackTableSize</a> - 1) &lt;&lt; 1) + 1;
02100     NewSizeInBytes = NewSize * <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d9/struct__POOL__TRACKER__TABLE.html">POOL_TRACKER_TABLE</a>);
02101 
02102     SizeInBytes = <a class="code" href="../../d2/d2/ex_2pool_8c.html#a43">PoolTrackTableSize</a> * <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d9/struct__POOL__TRACKER__TABLE.html">POOL_TRACKER_TABLE</a>);
02103 
02104     <span class="keywordflow">if</span> ((NewSizeInBytes &gt; SizeInBytes) &amp;&amp;
02105         (<a class="code" href="../../d2/d2/ex_2pool_8c.html#a42">PoolTrackTable</a>[<a class="code" href="../../d2/d2/ex_2pool_8c.html#a43">PoolTrackTableSize</a> - 1].<a class="code" href="../../d2/d9/struct__POOL__TRACKER__TABLE.html#o0">Key</a> == 0)) {
02106 
02107         <a class="code" href="../../d2/d2/ex_2pool_8c.html#a31">ExpLockNonPagedPool</a>(LockHandle);
02108 
02109         NewTable = <a class="code" href="../../d1/d6/allocpag_8c.html#a54">MiAllocatePoolPages</a> (<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
02110                                         NewSizeInBytes,
02111                                         <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02112 
02113         <a class="code" href="../../d2/d2/ex_2pool_8c.html#a32">ExpUnlockNonPagedPool</a>(LockHandle);
02114 
02115         <span class="keywordflow">if</span> (NewTable != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02116 
02117             OldTable = (PVOID)<a class="code" href="../../d2/d2/ex_2pool_8c.html#a42">PoolTrackTable</a>;
02118 
02119             KdPrint((<span class="stringliteral">"POOL:grew track table (%p, %p, %p)\n"</span>,
02120                 OldTable,
02121                 <a class="code" href="../../d2/d2/ex_2pool_8c.html#a43">PoolTrackTableSize</a>,
02122                 NewTable));
02123 
02124             RtlZeroMemory ((PVOID)NewTable, NewSizeInBytes);
02125 
02126             <span class="comment">//</span>
02127             <span class="comment">// Rehash all the entries into the new table.</span>
02128             <span class="comment">//</span>
02129 
02130             NewSizeMask = NewSize - 2;
02131 
02132             <span class="keywordflow">for</span> (OriginalHash = 0; OriginalHash &lt; <a class="code" href="../../d2/d2/ex_2pool_8c.html#a43">PoolTrackTableSize</a>; OriginalHash += 1) {
02133                 OriginalKey = <a class="code" href="../../d2/d2/ex_2pool_8c.html#a42">PoolTrackTable</a>[OriginalHash].<a class="code" href="../../d2/d9/struct__POOL__TRACKER__TABLE.html#o0">Key</a>;
02134 
02135                 <span class="keywordflow">if</span> (OriginalKey == 0) {
02136                     <span class="keywordflow">continue</span>;
02137                 }
02138 
02139                 Hash = (ULONG)((40543*((((((((PUCHAR)&amp;OriginalKey)[0]&lt;&lt;2)^((PUCHAR)&amp;OriginalKey)[1])&lt;&lt;2)^((PUCHAR)&amp;OriginalKey)[2])&lt;&lt;2)^((PUCHAR)&amp;OriginalKey)[3]))&gt;&gt;2) &amp; (ULONG)NewSizeMask;
02140                 <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = Hash;
02141             
02142                 HashedIt = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02143                 <span class="keywordflow">do</span> {
02144                     <span class="keywordflow">if</span> (NewTable[Hash].Key == 0 &amp;&amp; Hash != NewSize - 1) {
02145                         RtlCopyMemory ((PVOID)&amp;NewTable[Hash],
02146                                        (PVOID)&amp;<a class="code" href="../../d2/d2/ex_2pool_8c.html#a42">PoolTrackTable</a>[OriginalHash],
02147                                        <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d9/struct__POOL__TRACKER__TABLE.html">POOL_TRACKER_TABLE</a>));
02148                         HashedIt = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02149                         <span class="keywordflow">break</span>;
02150                     }
02151             
02152                     Hash = (Hash + 1) &amp; (ULONG)NewSizeMask;
02153                 } <span class="keywordflow">while</span> (Hash != <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>);
02154         
02155                 <span class="comment">//</span>
02156                 <span class="comment">// No matching entry and no free entry was found, have to bail.</span>
02157                 <span class="comment">//</span>
02158 
02159                 <span class="keywordflow">if</span> (HashedIt == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
02160                     KdPrint((<span class="stringliteral">"POOL:rehash of track table failed (%p, %p, %p %p)\n"</span>,
02161                         OldTable,
02162                         <a class="code" href="../../d2/d2/ex_2pool_8c.html#a43">PoolTrackTableSize</a>,
02163                         NewTable,
02164                         OriginalKey));
02165         
02166                     <a class="code" href="../../d2/d2/ex_2pool_8c.html#a31">ExpLockNonPagedPool</a>(LockHandle);
02167 
02168                     <a class="code" href="../../d1/d6/allocpag_8c.html#a55">MiFreePoolPages</a> (NewTable);
02169 
02170                     <a class="code" href="../../d2/d2/ex_2pool_8c.html#a32">ExpUnlockNonPagedPool</a>(LockHandle);
02171 
02172                     <span class="keywordflow">goto</span> overflow;
02173                 }
02174             }
02175 
02176             <a class="code" href="../../d2/d2/ex_2pool_8c.html#a42">PoolTrackTable</a> = NewTable;
02177             <a class="code" href="../../d2/d2/ex_2pool_8c.html#a43">PoolTrackTableSize</a> = NewSize;
02178             <a class="code" href="../../d2/d2/ex_2pool_8c.html#a44">PoolTrackTableMask</a> = NewSizeMask;
02179 
02180             ExReleaseSpinLock(&amp;<a class="code" href="../../d2/d2/ex_2pool_8c.html#a58">ExpTaggedPoolLock</a>, OldIrql);
02181 
02182             <a class="code" href="../../d2/d2/ex_2pool_8c.html#a31">ExpLockNonPagedPool</a>(LockHandle);
02183 
02184             BigPages = <a class="code" href="../../d1/d6/allocpag_8c.html#a55">MiFreePoolPages</a> (OldTable);
02185 
02186             <a class="code" href="../../d2/d2/ex_2pool_8c.html#a32">ExpUnlockNonPagedPool</a>(LockHandle);
02187 
02188             <a class="code" href="../../d2/d2/ex_2pool_8c.html#a66">ExpRemovePoolTracker</a> ('looP',
02189                                   BigPages * <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>,
02190                                   <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>);
02191 
02192             <a class="code" href="../../d2/d2/ex_2pool_8c.html#a65">ExpInsertPoolTracker</a> ('looP',
02193                                   (ULONG) <a class="code" href="../../d2/d1/mm_8h.html#a4">ROUND_TO_PAGES</a>(NewSizeInBytes),
02194                                   <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>);
02195 
02196             <span class="keywordflow">goto</span> retry;
02197         }
02198     }
02199 
02200 overflow:
02201 
02202     <span class="comment">//</span>
02203     <span class="comment">// Use the very last entry as a bit bucket for overflows.</span>
02204     <span class="comment">//</span>
02205 
02206     Hash = (ULONG)<a class="code" href="../../d2/d2/ex_2pool_8c.html#a43">PoolTrackTableSize</a> - 1;
02207 
02208     <a class="code" href="../../d2/d2/ex_2pool_8c.html#a42">PoolTrackTable</a>[Hash].<a class="code" href="../../d2/d9/struct__POOL__TRACKER__TABLE.html#o0">Key</a> = 'lfvO';
02209 
02210     <span class="comment">//</span>
02211     <span class="comment">// Update pool tracker table entry.</span>
02212     <span class="comment">//</span>
02213 
02214 EntryFound:
02215 
02216     <span class="keywordflow">if</span> ((PoolType &amp; <a class="code" href="../../d4/d2/pool_8h.html#a5">BASE_POOL_TYPE_MASK</a>) == <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>) {
02217         <a class="code" href="../../d2/d2/ex_2pool_8c.html#a42">PoolTrackTable</a>[Hash].<a class="code" href="../../d2/d9/struct__POOL__TRACKER__TABLE.html#o4">PagedAllocs</a> += 1;
02218         <a class="code" href="../../d2/d2/ex_2pool_8c.html#a42">PoolTrackTable</a>[Hash].<a class="code" href="../../d2/d9/struct__POOL__TRACKER__TABLE.html#o6">PagedBytes</a> += <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
02219 
02220     } <span class="keywordflow">else</span> {
02221         <a class="code" href="../../d2/d2/ex_2pool_8c.html#a42">PoolTrackTable</a>[Hash].<a class="code" href="../../d2/d9/struct__POOL__TRACKER__TABLE.html#o1">NonPagedAllocs</a> += 1;
02222         <a class="code" href="../../d2/d2/ex_2pool_8c.html#a42">PoolTrackTable</a>[Hash].<a class="code" href="../../d2/d9/struct__POOL__TRACKER__TABLE.html#o3">NonPagedBytes</a> += <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
02223     }
02224     ExReleaseSpinLock(&amp;<a class="code" href="../../d2/d2/ex_2pool_8c.html#a58">ExpTaggedPoolLock</a>, OldIrql);
02225 
02226     <span class="keywordflow">return</span>;
02227 }
02228 
02229 
02230 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02231"></a><a class="code" href="../../d2/d2/ex_2pool_8c.html#a66">02231</a> <a class="code" href="../../d2/d2/ex_2pool_8c.html#a66">ExpRemovePoolTracker</a> (
02232     IN ULONG Key,
02233     IN ULONG Size,
02234     IN POOL_TYPE PoolType
02235     )
02236 
02237 <span class="comment">/*++</span>
02238 <span class="comment"></span>
02239 <span class="comment">Routine Description:</span>
02240 <span class="comment"></span>
02241 <span class="comment">    This function increments the number of frees and updates the total</span>
02242 <span class="comment">    allocation size.</span>
02243 <span class="comment"></span>
02244 <span class="comment">Arguments:</span>
02245 <span class="comment"></span>
02246 <span class="comment">    Key - Supplies the key value used to locate a matching entry in the</span>
02247 <span class="comment">          tag table.</span>
02248 <span class="comment"></span>
02249 <span class="comment">    Size - Supplies the allocation size.</span>
02250 <span class="comment"></span>
02251 <span class="comment">    PoolType - Supplies the pool type.</span>
02252 <span class="comment"></span>
02253 <span class="comment">Return Value:</span>
02254 <span class="comment"></span>
02255 <span class="comment">    None.</span>
02256 <span class="comment"></span>
02257 <span class="comment">--*/</span>
02258 
02259 {
02260     ULONG Hash;
02261     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
02262     KIRQL OldIrql;
02263 
02264     <span class="comment">//</span>
02265     <span class="comment">// Ignore protected pool bit</span>
02266     <span class="comment">//</span>
02267 
02268     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a> &amp;= ~<a class="code" href="../../d5/d8/ex_8h.html#a6">PROTECTED_POOL</a>;
02269     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a> == <a class="code" href="../../d2/d2/ex_2pool_8c.html#a48">PoolHitTag</a>) {
02270         DbgBreakPoint();
02271     }
02272 
02273     <span class="comment">//</span>
02274     <span class="comment">// Compute hash index and search for pool tag.</span>
02275     <span class="comment">//</span>
02276 
02277     ExAcquireSpinLock(&amp;<a class="code" href="../../d2/d2/ex_2pool_8c.html#a58">ExpTaggedPoolLock</a>, &amp;OldIrql);
02278 
02279     Hash = ((40543*((((((((PUCHAR)&amp;<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>)[0]&lt;&lt;2)^((PUCHAR)&amp;<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>)[1])&lt;&lt;2)^((PUCHAR)&amp;<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>)[2])&lt;&lt;2)^((PUCHAR)&amp;<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>)[3]))&gt;&gt;2) &amp; (ULONG)<a class="code" href="../../d2/d2/ex_2pool_8c.html#a44">PoolTrackTableMask</a>;
02280     <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = Hash;
02281 
02282     <span class="keywordflow">do</span> {
02283         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d2/ex_2pool_8c.html#a42">PoolTrackTable</a>[Hash].<a class="code" href="../../d2/d9/struct__POOL__TRACKER__TABLE.html#o0">Key</a> == <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>) {
02284             <span class="keywordflow">goto</span> EntryFound;
02285         }
02286 
02287         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d2/ex_2pool_8c.html#a42">PoolTrackTable</a>[Hash].<a class="code" href="../../d2/d9/struct__POOL__TRACKER__TABLE.html#o0">Key</a> == 0 &amp;&amp; Hash != <a class="code" href="../../d2/d2/ex_2pool_8c.html#a43">PoolTrackTableSize</a> - 1) {
02288             KdPrint((<span class="stringliteral">"POOL: Unable to find tracker %lx, table corrupted\n"</span>, <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>));
02289             ExReleaseSpinLock(&amp;<a class="code" href="../../d2/d2/ex_2pool_8c.html#a58">ExpTaggedPoolLock</a>, OldIrql);
02290             <span class="keywordflow">return</span>;
02291         }
02292 
02293         Hash = (Hash + 1) &amp; (ULONG)<a class="code" href="../../d2/d2/ex_2pool_8c.html#a44">PoolTrackTableMask</a>;
02294     } <span class="keywordflow">while</span> (Hash != <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>);
02295 
02296     <span class="comment">//</span>
02297     <span class="comment">// No matching entry and no free entry was found.</span>
02298     <span class="comment">//</span>
02299 
02300     Hash = (ULONG)<a class="code" href="../../d2/d2/ex_2pool_8c.html#a43">PoolTrackTableSize</a> - 1;
02301 
02302     <span class="comment">//</span>
02303     <span class="comment">// Update pool tracker table entry.</span>
02304     <span class="comment">//</span>
02305 
02306 EntryFound:
02307 
02308     <span class="keywordflow">if</span> ((PoolType &amp; <a class="code" href="../../d4/d2/pool_8h.html#a5">BASE_POOL_TYPE_MASK</a>) == <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>) {
02309         <a class="code" href="../../d2/d2/ex_2pool_8c.html#a42">PoolTrackTable</a>[Hash].<a class="code" href="../../d2/d9/struct__POOL__TRACKER__TABLE.html#o6">PagedBytes</a> -= <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
02310         <a class="code" href="../../d2/d2/ex_2pool_8c.html#a42">PoolTrackTable</a>[Hash].<a class="code" href="../../d2/d9/struct__POOL__TRACKER__TABLE.html#o5">PagedFrees</a> += 1;
02311 
02312     } <span class="keywordflow">else</span> {
02313         <a class="code" href="../../d2/d2/ex_2pool_8c.html#a42">PoolTrackTable</a>[Hash].<a class="code" href="../../d2/d9/struct__POOL__TRACKER__TABLE.html#o3">NonPagedBytes</a> -= <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
02314         <a class="code" href="../../d2/d2/ex_2pool_8c.html#a42">PoolTrackTable</a>[Hash].<a class="code" href="../../d2/d9/struct__POOL__TRACKER__TABLE.html#o2">NonPagedFrees</a> += 1;
02315     }
02316 
02317     ExReleaseSpinLock(&amp;<a class="code" href="../../d2/d2/ex_2pool_8c.html#a58">ExpTaggedPoolLock</a>, OldIrql);
02318 
02319     <span class="keywordflow">return</span>;
02320 }
02321 
02322 
02323 LOGICAL
<a name="l02324"></a><a class="code" href="../../d2/d2/ex_2pool_8c.html#a67">02324</a> <a class="code" href="../../d2/d2/ex_2pool_8c.html#a67">ExpAddTagForBigPages</a> (
02325     IN PVOID Va,
02326     IN ULONG Key,
02327     IN ULONG NumberOfPages
02328     )
02329 <span class="comment">/*++</span>
02330 <span class="comment"></span>
02331 <span class="comment">Routine Description:</span>
02332 <span class="comment"></span>
02333 <span class="comment">    This function inserts a pool tag in the big page tag table.</span>
02334 <span class="comment"></span>
02335 <span class="comment">Arguments:</span>
02336 <span class="comment"></span>
02337 <span class="comment">    Va - Supplies the allocated virtual address.</span>
02338 <span class="comment"></span>
02339 <span class="comment">    Key - Supplies the key value used to locate a matching entry in the</span>
02340 <span class="comment">        tag table.</span>
02341 <span class="comment"></span>
02342 <span class="comment">    NumberOfPages - Supplies the number of pages that were allocated.</span>
02343 <span class="comment"></span>
02344 <span class="comment">Return Value:</span>
02345 <span class="comment"></span>
02346 <span class="comment">    TRUE if an entry was allocated, FALSE if not.</span>
02347 <span class="comment"></span>
02348 <span class="comment">Environment:</span>
02349 <span class="comment"></span>
02350 <span class="comment">    No pool locks held so the table may be freely expanded here as needed.</span>
02351 <span class="comment"></span>
02352 <span class="comment">--*/</span>
02353 {
02354     ULONG Hash;
02355     ULONG BigPages;
02356     PVOID OldTable;
02357     LOGICAL Inserted;
02358     KIRQL OldIrql;
02359     KIRQL LockHandle;
02360     SIZE_T SizeInBytes;
02361     SIZE_T NewSizeInBytes;
02362     <a class="code" href="../../d1/d9/struct__POOL__TRACKER__BIG__PAGES.html">PPOOL_TRACKER_BIG_PAGES</a> NewTable;
02363     <a class="code" href="../../d1/d9/struct__POOL__TRACKER__BIG__PAGES.html">PPOOL_TRACKER_BIG_PAGES</a> p;
02364 
02365 retry:
02366 
02367     Inserted = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02368     Hash = (ULONG)(((ULONG_PTR)Va &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>) &amp; <a class="code" href="../../d2/d2/ex_2pool_8c.html#a47">PoolBigPageTableHash</a>);
02369     ExAcquireSpinLock(&amp;<a class="code" href="../../d2/d2/ex_2pool_8c.html#a58">ExpTaggedPoolLock</a>, &amp;OldIrql);
02370     <span class="keywordflow">while</span> ((LONG_PTR)<a class="code" href="../../d2/d2/ex_2pool_8c.html#a45">PoolBigPageTable</a>[Hash].<a class="code" href="../../d1/d9/struct__POOL__TRACKER__BIG__PAGES.html#o0">Va</a> &lt; 0) {
02371         Hash += 1;
02372         <span class="keywordflow">if</span> (Hash &gt;= <a class="code" href="../../d2/d2/ex_2pool_8c.html#a46">PoolBigPageTableSize</a>) {
02373             <span class="keywordflow">if</span> (!Inserted) {
02374 
02375                 <span class="comment">//</span>
02376                 <span class="comment">// Try to expand the tracker table.</span>
02377                 <span class="comment">//</span>
02378 
02379                 SizeInBytes = <a class="code" href="../../d2/d2/ex_2pool_8c.html#a46">PoolBigPageTableSize</a> * <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d9/struct__POOL__TRACKER__BIG__PAGES.html">POOL_TRACKER_BIG_PAGES</a>);
02380                 NewSizeInBytes = (SizeInBytes &lt;&lt; 1);
02381 
02382                 <span class="keywordflow">if</span> (NewSizeInBytes &gt; SizeInBytes) {
02383 
02384                     <a class="code" href="../../d2/d2/ex_2pool_8c.html#a31">ExpLockNonPagedPool</a>(LockHandle);
02385 
02386                     NewTable = <a class="code" href="../../d1/d6/allocpag_8c.html#a54">MiAllocatePoolPages</a> (<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
02387                                                     NewSizeInBytes,
02388                                                     <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02389 
02390                     <a class="code" href="../../d2/d2/ex_2pool_8c.html#a32">ExpUnlockNonPagedPool</a>(LockHandle);
02391 
02392                     <span class="keywordflow">if</span> (NewTable != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02393     
02394                         OldTable = (PVOID)<a class="code" href="../../d2/d2/ex_2pool_8c.html#a45">PoolBigPageTable</a>;
02395 
02396                         KdPrint((<span class="stringliteral">"POOL:grew big table (%p, %p, %p)\n"</span>,
02397                             OldTable,
02398                             <a class="code" href="../../d2/d2/ex_2pool_8c.html#a46">PoolBigPageTableSize</a>,
02399                             NewTable));
02400 
02401                         RtlCopyMemory ((PVOID)NewTable,
02402                                        OldTable,
02403                                        SizeInBytes);
02404 
02405                         RtlZeroMemory ((PVOID)(NewTable + <a class="code" href="../../d2/d2/ex_2pool_8c.html#a46">PoolBigPageTableSize</a>),
02406                                        NewSizeInBytes - SizeInBytes);
02407 
02408                         <a class="code" href="../../d2/d2/ex_2pool_8c.html#a45">PoolBigPageTable</a> = NewTable;
02409                         <a class="code" href="../../d2/d2/ex_2pool_8c.html#a46">PoolBigPageTableSize</a> &lt;&lt;= 1;
02410                         <a class="code" href="../../d2/d2/ex_2pool_8c.html#a47">PoolBigPageTableHash</a> = <a class="code" href="../../d2/d2/ex_2pool_8c.html#a46">PoolBigPageTableSize</a> - 1;
02411 
02412                         ExReleaseSpinLock(&amp;<a class="code" href="../../d2/d2/ex_2pool_8c.html#a58">ExpTaggedPoolLock</a>, OldIrql);
02413 
02414                         <a class="code" href="../../d2/d2/ex_2pool_8c.html#a31">ExpLockNonPagedPool</a>(LockHandle);
02415 
02416                         BigPages = <a class="code" href="../../d1/d6/allocpag_8c.html#a55">MiFreePoolPages</a> (OldTable);
02417 
02418                         <a class="code" href="../../d2/d2/ex_2pool_8c.html#a32">ExpUnlockNonPagedPool</a>(LockHandle);
02419 
02420                         <a class="code" href="../../d2/d2/ex_2pool_8c.html#a66">ExpRemovePoolTracker</a> ('looP',
02421                                               BigPages * <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>,
02422                                               <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>);
02423 
02424                         <a class="code" href="../../d2/d2/ex_2pool_8c.html#a65">ExpInsertPoolTracker</a> ('looP',
02425                                               (ULONG) <a class="code" href="../../d2/d1/mm_8h.html#a4">ROUND_TO_PAGES</a>(NewSizeInBytes),
02426                                               <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>);
02427 
02428                         <span class="keywordflow">goto</span> retry;
02429                     }
02430                 }
02431 
02432                 <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d2/ex_2pool_8c.html#a41">FirstPrint</a>) {
02433                     KdPrint((<span class="stringliteral">"POOL:unable to insert big page slot %lx\n"</span>,<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>));
02434                     <a class="code" href="../../d2/d2/ex_2pool_8c.html#a41">FirstPrint</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02435                 }
02436 
02437                 ExReleaseSpinLock(&amp;<a class="code" href="../../d2/d2/ex_2pool_8c.html#a58">ExpTaggedPoolLock</a>, OldIrql);
02438                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02439             }
02440 
02441             Hash = 0;
02442             Inserted = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02443         }
02444     }
02445 
02446     p = &amp;<a class="code" href="../../d2/d2/ex_2pool_8c.html#a45">PoolBigPageTable</a>[Hash];
02447 
02448     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((LONG_PTR)Va &lt; 0);
02449 
02450     p-&gt;<a class="code" href="../../d1/d9/struct__POOL__TRACKER__BIG__PAGES.html#o0">Va</a> = Va;
02451     p-&gt;<a class="code" href="../../d1/d9/struct__POOL__TRACKER__BIG__PAGES.html#o1">Key</a> = <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>;
02452     p-&gt;<a class="code" href="../../d1/d9/struct__POOL__TRACKER__BIG__PAGES.html#o2">NumberOfPages</a> = NumberOfPages;
02453 
02454     ExReleaseSpinLock(&amp;<a class="code" href="../../d2/d2/ex_2pool_8c.html#a58">ExpTaggedPoolLock</a>, OldIrql);
02455 
02456     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02457 }
02458 
02459 
02460 ULONG
<a name="l02461"></a><a class="code" href="../../d2/d2/ex_2pool_8c.html#a68">02461</a> <a class="code" href="../../d2/d2/ex_2pool_8c.html#a68">ExpFindAndRemoveTagBigPages</a> (
02462     IN PVOID Va
02463     )
02464 
02465 {
02466     ULONG Hash;
02467     LOGICAL Inserted;
02468     KIRQL OldIrql;
02469     ULONG ReturnKey;
02470 
02471     Inserted = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02472     Hash = (ULONG)(((ULONG_PTR)Va &gt;&gt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>) &amp; <a class="code" href="../../d2/d2/ex_2pool_8c.html#a47">PoolBigPageTableHash</a>);
02473     ExAcquireSpinLock(&amp;<a class="code" href="../../d2/d2/ex_2pool_8c.html#a58">ExpTaggedPoolLock</a>, &amp;OldIrql);
02474     <span class="keywordflow">while</span> (<a class="code" href="../../d2/d2/ex_2pool_8c.html#a45">PoolBigPageTable</a>[Hash].<a class="code" href="../../d1/d9/struct__POOL__TRACKER__BIG__PAGES.html#o0">Va</a> != Va) {
02475         Hash += 1;
02476         <span class="keywordflow">if</span> (Hash &gt;= <a class="code" href="../../d2/d2/ex_2pool_8c.html#a46">PoolBigPageTableSize</a>) {
02477             <span class="keywordflow">if</span> (!Inserted) {
02478                 <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d2/ex_2pool_8c.html#a41">FirstPrint</a>) {
02479                     KdPrint((<span class="stringliteral">"POOL:unable to find big page slot %lx\n"</span>,Va));
02480                     <a class="code" href="../../d2/d2/ex_2pool_8c.html#a41">FirstPrint</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02481                 }
02482 
02483                 ExReleaseSpinLock(&amp;<a class="code" href="../../d2/d2/ex_2pool_8c.html#a58">ExpTaggedPoolLock</a>, OldIrql);
02484                 <span class="keywordflow">return</span> ' GIB';
02485             }
02486 
02487             Hash = 0;
02488             Inserted = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02489         }
02490     }
02491 
02492     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> ((LONG_PTR)Va &lt; 0);
02493     (ULONG_PTR)<a class="code" href="../../d2/d2/ex_2pool_8c.html#a45">PoolBigPageTable</a>[Hash].<a class="code" href="../../d1/d9/struct__POOL__TRACKER__BIG__PAGES.html#o0">Va</a> &amp;= MAXLONG_PTR;
02494 
02495     ReturnKey = <a class="code" href="../../d2/d2/ex_2pool_8c.html#a45">PoolBigPageTable</a>[Hash].<a class="code" href="../../d1/d9/struct__POOL__TRACKER__BIG__PAGES.html#o1">Key</a>;
02496     ExReleaseSpinLock(&amp;<a class="code" href="../../d2/d2/ex_2pool_8c.html#a58">ExpTaggedPoolLock</a>, OldIrql);
02497     <span class="keywordflow">return</span> ReturnKey;
02498 }
02499 
02500 
02501 ULONG
<a name="l02502"></a><a class="code" href="../../d2/d2/ex_2pool_8c.html#a81">02502</a> <a class="code" href="../../d5/d2/poolhack_8c.html#a33">ExpAllocatePoolWithQuotaHandler</a>(
02503     IN NTSTATUS ExceptionCode,
02504     IN PVOID PoolAddress,
02505     IN LOGICAL ContinueSearch
02506     )
02507 
02508 <span class="comment">/*++</span>
02509 <span class="comment"></span>
02510 <span class="comment">Routine Description:</span>
02511 <span class="comment"></span>
02512 <span class="comment">    This function is called when an exception occurs in ExFreePool</span>
02513 <span class="comment">    while quota is being charged to a process.</span>
02514 <span class="comment"></span>
02515 <span class="comment">    Its function is to deallocate the pool block and continue the search</span>
02516 <span class="comment">    for an exception handler.</span>
02517 <span class="comment"></span>
02518 <span class="comment">Arguments:</span>
02519 <span class="comment"></span>
02520 <span class="comment">    ExceptionCode - Supplies the exception code that caused this</span>
02521 <span class="comment">        function to be entered.</span>
02522 <span class="comment"></span>
02523 <span class="comment">    PoolAddress - Supplies the address of a pool block that needs to be</span>
02524 <span class="comment">        deallocated.</span>
02525 <span class="comment"></span>
02526 <span class="comment">    ContinueSearch - Supplies a value that if TRUE causes the exception</span>
02527 <span class="comment">        search to continue.  This is used in allocate pool with quota</span>
02528 <span class="comment">        calls that do not contain the pool quota mask bit set.</span>
02529 <span class="comment"></span>
02530 <span class="comment">Return Value:</span>
02531 <span class="comment"></span>
02532 <span class="comment">    EXCEPTION_CONTINUE_SEARCH - The exception should be propagated to the</span>
02533 <span class="comment">        caller of ExAllocatePoolWithQuota.</span>
02534 <span class="comment"></span>
02535 <span class="comment">--*/</span>
02536 
02537 {
02538     <span class="keywordflow">if</span> ( PoolAddress ) {
02539         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ExceptionCode == STATUS_QUOTA_EXCEEDED);
02540         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(PoolAddress);
02541 
02542     } <span class="keywordflow">else</span> {
02543         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(ExceptionCode == STATUS_INSUFFICIENT_RESOURCES);
02544     }
02545 
02546     <span class="keywordflow">return</span> ContinueSearch ? <a class="code" href="../../d6/d7/halmips_8h.html#a34">EXCEPTION_CONTINUE_SEARCH</a> : <a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>;
02547 }
02548 
02549 PVOID
<a name="l02550"></a><a class="code" href="../../d5/d8/ex_8h.html#a220">02550</a> <a class="code" href="../../d5/d5/cc_8h.html#a11">ExAllocatePoolWithQuota</a>(
02551     IN POOL_TYPE PoolType,
02552     IN SIZE_T NumberOfBytes
02553     )
02554 
02555 <span class="comment">/*++</span>
02556 <span class="comment"></span>
02557 <span class="comment">Routine Description:</span>
02558 <span class="comment"></span>
02559 <span class="comment">    This function allocates a block of pool of the specified type,</span>
02560 <span class="comment">    returns a pointer to the allocated block, and if the binary buddy</span>
02561 <span class="comment">    allocator was used to satisfy the request, charges pool quota to the</span>
02562 <span class="comment">    current process.  This function is used to access both the</span>
02563 <span class="comment">    page-aligned pools, and the binary buddy.</span>
02564 <span class="comment"></span>
02565 <span class="comment">    If the number of bytes specifies a size that is too large to be</span>
02566 <span class="comment">    satisfied by the appropriate binary buddy pool, then the</span>
02567 <span class="comment">    page-aligned pool allocator is used.  The allocated block will be</span>
02568 <span class="comment">    page-aligned and a page-sized multiple.  No quota is charged to the</span>
02569 <span class="comment">    current process if this is the case.</span>
02570 <span class="comment"></span>
02571 <span class="comment">    Otherwise, the appropriate binary buddy pool is used.  The allocated</span>
02572 <span class="comment">    block will be 64-bit aligned, but will not be page aligned.  After</span>
02573 <span class="comment">    the allocation completes, an attempt will be made to charge pool</span>
02574 <span class="comment">    quota (of the appropriate type) to the current process object.  If</span>
02575 <span class="comment">    the quota charge succeeds, then the pool block's header is adjusted</span>
02576 <span class="comment">    to point to the current process.  The process object is not</span>
02577 <span class="comment">    dereferenced until the pool is deallocated and the appropriate</span>
02578 <span class="comment">    amount of quota is returned to the process.  Otherwise, the pool is</span>
02579 <span class="comment">    deallocated, a "quota exceeded" condition is raised.</span>
02580 <span class="comment"></span>
02581 <span class="comment">Arguments:</span>
02582 <span class="comment"></span>
02583 <span class="comment">    PoolType - Supplies the type of pool to allocate.  If the pool type</span>
02584 <span class="comment">        is one of the "MustSucceed" pool types and sufficient quota</span>
02585 <span class="comment">        exists, then this call will always succeed and return a pointer</span>
02586 <span class="comment">        to allocated pool.  Otherwise, if the system cannot allocate</span>
02587 <span class="comment">        the requested amount of memory a STATUS_INSUFFICIENT_RESOURCES</span>
02588 <span class="comment">        status is raised.</span>
02589 <span class="comment"></span>
02590 <span class="comment">    NumberOfBytes - Supplies the number of bytes to allocate.</span>
02591 <span class="comment"></span>
02592 <span class="comment">Return Value:</span>
02593 <span class="comment"></span>
02594 <span class="comment">    NON-NULL - Returns a pointer to the allocated pool.</span>
02595 <span class="comment"></span>
02596 <span class="comment">    Unspecified - If insufficient quota exists to complete the pool</span>
02597 <span class="comment">        allocation, the return value is unspecified.</span>
02598 <span class="comment"></span>
02599 <span class="comment">--*/</span>
02600 
02601 {
02602     <span class="keywordflow">return</span> (<a class="code" href="../../d5/d8/ex_8h.html#a5">ExAllocatePoolWithQuotaTag</a> (PoolType, NumberOfBytes, 'enoN'));
02603 }
02604 
02605 
02606 PVOID
<a name="l02607"></a><a class="code" href="../../d5/d8/ex_8h.html#a223">02607</a> <a class="code" href="../../d5/d8/ex_8h.html#a5">ExAllocatePoolWithQuotaTag</a>(
02608     IN POOL_TYPE PoolType,
02609     IN SIZE_T NumberOfBytes,
02610     IN ULONG Tag
02611     )
02612 
02613 <span class="comment">/*++</span>
02614 <span class="comment"></span>
02615 <span class="comment">Routine Description:</span>
02616 <span class="comment"></span>
02617 <span class="comment">    This function allocates a block of pool of the specified type,</span>
02618 <span class="comment">    returns a pointer to the allocated block, and if the binary buddy</span>
02619 <span class="comment">    allocator was used to satisfy the request, charges pool quota to the</span>
02620 <span class="comment">    current process.  This function is used to access both the</span>
02621 <span class="comment">    page-aligned pools, and the binary buddy.</span>
02622 <span class="comment"></span>
02623 <span class="comment">    If the number of bytes specifies a size that is too large to be</span>
02624 <span class="comment">    satisfied by the appropriate binary buddy pool, then the</span>
02625 <span class="comment">    page-aligned pool allocator is used.  The allocated block will be</span>
02626 <span class="comment">    page-aligned and a page-sized multiple.  No quota is charged to the</span>
02627 <span class="comment">    current process if this is the case.</span>
02628 <span class="comment"></span>
02629 <span class="comment">    Otherwise, the appropriate binary buddy pool is used.  The allocated</span>
02630 <span class="comment">    block will be 64-bit aligned, but will not be page aligned.  After</span>
02631 <span class="comment">    the allocation completes, an attempt will be made to charge pool</span>
02632 <span class="comment">    quota (of the appropriate type) to the current process object.  If</span>
02633 <span class="comment">    the quota charge succeeds, then the pool block's header is adjusted</span>
02634 <span class="comment">    to point to the current process.  The process object is not</span>
02635 <span class="comment">    dereferenced until the pool is deallocated and the appropriate</span>
02636 <span class="comment">    amount of quota is returned to the process.  Otherwise, the pool is</span>
02637 <span class="comment">    deallocated, a "quota exceeded" condition is raised.</span>
02638 <span class="comment"></span>
02639 <span class="comment">Arguments:</span>
02640 <span class="comment"></span>
02641 <span class="comment">    PoolType - Supplies the type of pool to allocate.  If the pool type</span>
02642 <span class="comment">        is one of the "MustSucceed" pool types and sufficient quota</span>
02643 <span class="comment">        exists, then this call will always succeed and return a pointer</span>
02644 <span class="comment">        to allocated pool.  Otherwise, if the system cannot allocate</span>
02645 <span class="comment">        the requested amount of memory a STATUS_INSUFFICIENT_RESOURCES</span>
02646 <span class="comment">        status is raised.</span>
02647 <span class="comment"></span>
02648 <span class="comment">    NumberOfBytes - Supplies the number of bytes to allocate.</span>
02649 <span class="comment"></span>
02650 <span class="comment">Return Value:</span>
02651 <span class="comment"></span>
02652 <span class="comment">    NON-NULL - Returns a pointer to the allocated pool.</span>
02653 <span class="comment"></span>
02654 <span class="comment">    Unspecified - If insufficient quota exists to complete the pool</span>
02655 <span class="comment">        allocation, the return value is unspecified.</span>
02656 <span class="comment"></span>
02657 <span class="comment">--*/</span>
02658 
02659 {
02660     PVOID p;
02661     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
02662     <a class="code" href="../../d5/d8/struct__POOL__HEADER.html">PPOOL_HEADER</a> Entry;
02663     LOGICAL IgnoreQuota;
02664     LOGICAL RaiseOnQuotaFailure;
02665 
02666     IgnoreQuota = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02667     RaiseOnQuotaFailure = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02668 
02669     <span class="keywordflow">if</span> ( PoolType &amp; <a class="code" href="../../d5/d8/ex_8h.html#a2">POOL_QUOTA_FAIL_INSTEAD_OF_RAISE</a> ) {
02670         RaiseOnQuotaFailure = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02671         PoolType &amp;= ~<a class="code" href="../../d5/d8/ex_8h.html#a2">POOL_QUOTA_FAIL_INSTEAD_OF_RAISE</a>;
02672     }
02673 
02674     <span class="keywordflow">if</span> ((<a class="code" href="../../d2/d2/ex_2pool_8c.html#a0">POOL_QUOTA_ENABLED</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)
02675 <span class="preprocessor">#if i386 &amp;&amp; !FPO</span>
02676 <span class="preprocessor"></span>            || (<a class="code" href="../../d9/d2/ldrp_8h.html#a33">NtGlobalFlag</a> &amp; FLG_KERNEL_STACK_TRACE_DB)
02677 <span class="preprocessor">#endif // i386 &amp;&amp; !FPO</span>
02678 <span class="preprocessor"></span>       ) {
02679         IgnoreQuota = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02680     } <span class="keywordflow">else</span> {
02681         PoolType = (<a class="code" href="../../d5/d8/ex_8h.html#a96">POOL_TYPE</a>)((UCHAR)PoolType + <a class="code" href="../../d4/d2/pool_8h.html#a11">POOL_QUOTA_MASK</a>);
02682     }
02683 
02684     p = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(PoolType, NumberOfBytes, Tag);
02685 
02686     <span class="comment">//</span>
02687     <span class="comment">// Note - NULL is page aligned.</span>
02688     <span class="comment">//</span>
02689 
02690     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d2/poolhack_8c.html#a5">PAGE_ALIGNED</a>(p) &amp;&amp; !IgnoreQuota) {
02691 
02692         <span class="keywordflow">if</span> ((p &gt;= <a class="code" href="../../d2/d1/mm_8h.html#a160">MmSpecialPoolStart</a>) &amp;&amp; (p &lt; <a class="code" href="../../d2/d1/mm_8h.html#a161">MmSpecialPoolEnd</a>)) {
02693             <span class="keywordflow">return</span> p;
02694         }
02695 
02696 <span class="preprocessor">#if POOL_CACHE_SUPPORTED</span>
02697 <span class="preprocessor"></span>
02698         <span class="comment">//</span>
02699         <span class="comment">// Align entry on pool allocation boundary.</span>
02700         <span class="comment">//</span>
02701 
02702         <span class="keywordflow">if</span> (((ULONG)p &amp; POOL_CACHE_CHECK) == 0) {
02703             Entry = (<a class="code" href="../../d5/d8/struct__POOL__HEADER.html">PPOOL_HEADER</a>)((ULONG)p - PoolCacheSize);
02704         } <span class="keywordflow">else</span> {
02705             Entry = (<a class="code" href="../../d5/d8/struct__POOL__HEADER.html">PPOOL_HEADER</a>)((PCH)p - <a class="code" href="../../d5/d2/poolhack_8c.html#a6">POOL_OVERHEAD</a>);
02706         }
02707 
02708 <span class="preprocessor">#else</span>
02709 <span class="preprocessor"></span>        Entry = (<a class="code" href="../../d5/d8/struct__POOL__HEADER.html">PPOOL_HEADER</a>)((PCH)p - <a class="code" href="../../d5/d2/poolhack_8c.html#a6">POOL_OVERHEAD</a>);
02710 <span class="preprocessor">#endif //POOL_CACHE_SUPPORTED</span>
02711 <span class="preprocessor"></span>
02712         Process = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>();
02713 
02714         <span class="comment">//</span>
02715         <span class="comment">// Catch exception and back out allocation if necessary</span>
02716         <span class="comment">//</span>
02717 
02718         <span class="keywordflow">try</span> {
02719 
02720             Entry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o2">ProcessBilled</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02721 
02722             <span class="keywordflow">if</span> (Process != <a class="code" href="../../d1/d9/ps_8h.html#a53">PsInitialSystemProcess</a>) {
02723 
02724                 <a class="code" href="../../d0/d2/psquota_8c.html#a2">PsChargePoolQuota</a>(Process,
02725                                  PoolType &amp; <a class="code" href="../../d4/d2/pool_8h.html#a5">BASE_POOL_TYPE_MASK</a>,
02726                                  (ULONG)(Entry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o6">BlockSize</a> &lt;&lt; <a class="code" href="../../d4/d2/pool_8h.html#a14">POOL_BLOCK_SHIFT</a>));
02727 
02728                 <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>(Process);
02729                 Entry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o2">ProcessBilled</a> = Process;
02730             }
02731 
02732         } except ( <a class="code" href="../../d5/d2/poolhack_8c.html#a33">ExpAllocatePoolWithQuotaHandler</a>(GetExceptionCode(),p,RaiseOnQuotaFailure)) {
02733             <span class="keywordflow">if</span> ( RaiseOnQuotaFailure ) {
02734                 <a class="code" href="../../d9/d1/bugcheck_8c.html#a13">KeBugCheck</a>(GetExceptionCode());
02735             }
02736             <span class="keywordflow">else</span> {
02737                 p = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02738             }
02739         }
02740 
02741     } <span class="keywordflow">else</span> {
02742         <span class="keywordflow">if</span> ( !p &amp;&amp; RaiseOnQuotaFailure ) {
02743             <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>(STATUS_INSUFFICIENT_RESOURCES);
02744         }
02745     }
02746 
02747     <span class="keywordflow">return</span> p;
02748 }
02749 
02750 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02751"></a><a class="code" href="../../d2/d2/ex_2pool_8c.html#a84">02751</a> <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(
02752     IN PVOID P
02753     )
02754 {
02755     <a class="code" href="../../d5/d8/ex_8h.html#a7">ExFreePoolWithTag</a>(P, 0);
02756     <span class="keywordflow">return</span>;
02757 }
02758 
02759 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02760"></a><a class="code" href="../../d5/d8/ex_8h.html#a225">02760</a> <a class="code" href="../../d5/d8/ex_8h.html#a7">ExFreePoolWithTag</a>(
02761     IN PVOID P,
02762     IN ULONG TagToFree
02763     )
02764 {
02765 
02766 <span class="comment">/*++</span>
02767 <span class="comment"></span>
02768 <span class="comment">Routine Description:</span>
02769 <span class="comment"></span>
02770 <span class="comment">    This function deallocates a block of pool. This function is used to</span>
02771 <span class="comment">    deallocate to both the page aligned pools and the buddy (less than</span>
02772 <span class="comment">    a page) pools.</span>
02773 <span class="comment"></span>
02774 <span class="comment">    If the address of the block being deallocated is page-aligned, then</span>
02775 <span class="comment">    the page-aligned pool deallocator is used.</span>
02776 <span class="comment"></span>
02777 <span class="comment">    Otherwise, the binary buddy pool deallocator is used.  Deallocation</span>
02778 <span class="comment">    looks at the allocated block's pool header to determine the pool</span>
02779 <span class="comment">    type and block size being deallocated.  If the pool was allocated</span>
02780 <span class="comment">    using ExAllocatePoolWithQuota, then after the deallocation is</span>
02781 <span class="comment">    complete, the appropriate process's pool quota is adjusted to reflect</span>
02782 <span class="comment">    the deallocation, and the process object is dereferenced.</span>
02783 <span class="comment"></span>
02784 <span class="comment">Arguments:</span>
02785 <span class="comment"></span>
02786 <span class="comment">    P - Supplies the address of the block of pool being deallocated.</span>
02787 <span class="comment"></span>
02788 <span class="comment">Return Value:</span>
02789 <span class="comment"></span>
02790 <span class="comment">    None.</span>
02791 <span class="comment"></span>
02792 <span class="comment">--*/</span>
02793 
02794     <a class="code" href="../../d5/d8/ex_8h.html#a96">POOL_TYPE</a> CheckType;
02795     <a class="code" href="../../d5/d8/struct__POOL__HEADER.html">PPOOL_HEADER</a> Entry;
02796     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
02797     KIRQL LockHandle;
02798     <a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html">PNPAGED_LOOKASIDE_LIST</a> LookasideList;
02799     <a class="code" href="../../d5/d8/struct__POOL__HEADER.html">PPOOL_HEADER</a> NextEntry;
02800     ULONG PoolIndex;
02801     <a class="code" href="../../d5/d8/ex_8h.html#a96">POOL_TYPE</a> PoolType;
02802     <a class="code" href="../../d4/d8/struct__POOL__DESCRIPTOR.html">PPOOL_DESCRIPTOR</a> PoolDesc;
02803     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> ProcessBilled;
02804     LOGICAL Combined;
02805     ULONG BigPages;
02806     ULONG Tag;
02807     LOGICAL GlobalSpace;
02808     PKPRCB Prcb;
02809     <a class="code" href="../../d2/d1/mm_8h.html#a50">PERFINFO_EXFREEPOOLWITHTAG_DECL</a>();
02810 
02811     <a class="code" href="../../d2/d1/mm_8h.html#a51">PERFINFO_FREEPOOL</a>(P);
02812 
02813     <span class="keywordflow">if</span> ((P &gt;= <a class="code" href="../../d2/d1/mm_8h.html#a160">MmSpecialPoolStart</a>) &amp;&amp; (P &lt; <a class="code" href="../../d2/d1/mm_8h.html#a161">MmSpecialPoolEnd</a>)) {
02814         <a class="code" href="../../d1/d6/allocpag_8c.html#a41">MmFreeSpecialPool</a> (P);
02815         <span class="keywordflow">return</span>;
02816     }
02817 
02818     ProcessBilled = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02819 
02820     <span class="comment">//</span>
02821     <span class="comment">// If entry is page aligned, then call free block to the page aligned</span>
02822     <span class="comment">// pool. Otherwise, free the block to the allocation lists.</span>
02823     <span class="comment">//</span>
02824 
02825     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d2/poolhack_8c.html#a5">PAGE_ALIGNED</a>(P)) {
02826 
02827         PoolType = <a class="code" href="../../d1/d6/allocpag_8c.html#a48">MmDeterminePoolType</a>(P);
02828 
02829         <a class="code" href="../../d2/d2/ex_2pool_8c.html#a20">ASSERT_FREE_IRQL</a>(PoolType, P);
02830 
02831         CheckType = PoolType &amp; <a class="code" href="../../d4/d2/pool_8h.html#a5">BASE_POOL_TYPE_MASK</a>;
02832 
02833         <span class="keywordflow">if</span> (PoolType == <a class="code" href="../../d5/d8/ex_8h.html#a329a182">PagedPoolSession</a>) {
02834             PoolDesc = <a class="code" href="../../d2/d2/ex_2pool_8c.html#a40">ExpSessionPoolDescriptor</a>;
02835         }
02836         <span class="keywordflow">else</span> {
02837             PoolDesc = <a class="code" href="../../d2/d2/ex_2pool_8c.html#a54">PoolVector</a>[PoolType];
02838         }
02839 
02840         <span class="keywordflow">if</span> ((<a class="code" href="../../d2/d2/ex_2pool_8c.html#a42">PoolTrackTable</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (PoolType != <a class="code" href="../../d5/d8/ex_8h.html#a329a182">PagedPoolSession</a>)) {
02841             Tag = <a class="code" href="../../d2/d2/ex_2pool_8c.html#a68">ExpFindAndRemoveTagBigPages</a>(P);
02842         }
02843 
02844         <a class="code" href="../../d2/d2/ex_2pool_8c.html#a33">LOCK_POOL</a>(PoolDesc, LockHandle);
02845 
02846         PoolDesc-&gt;<a class="code" href="../../d4/d8/struct__POOL__DESCRIPTOR.html#o7">RunningDeAllocs</a> += 1;
02847 
02848         <span class="comment">//</span>
02849         <span class="comment">// Large session pool allocations are accounted for directly by</span>
02850         <span class="comment">// the memory manager so no need to call MiSessionPoolFreed here.</span>
02851         <span class="comment">//</span>
02852 
02853         BigPages = <a class="code" href="../../d1/d6/allocpag_8c.html#a55">MiFreePoolPages</a>(P);
02854 
02855         <span class="keywordflow">if</span> ((<a class="code" href="../../d2/d2/ex_2pool_8c.html#a42">PoolTrackTable</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; (PoolType != <a class="code" href="../../d5/d8/ex_8h.html#a329a182">PagedPoolSession</a>)) {
02856             <span class="keywordflow">if</span> (Tag &amp; <a class="code" href="../../d5/d8/ex_8h.html#a6">PROTECTED_POOL</a>) {
02857                 Tag &amp;= ~<a class="code" href="../../d5/d8/ex_8h.html#a6">PROTECTED_POOL</a>;
02858                 TagToFree &amp;= ~<a class="code" href="../../d5/d8/ex_8h.html#a6">PROTECTED_POOL</a>;
02859                 <span class="keywordflow">if</span> (Tag != TagToFree) {
02860                     <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"EX: Invalid attempt to free protected pool block %x (%c%c%c%c)\n"</span>,
02861                               P,
02862                               Tag,
02863                               Tag &gt;&gt; 8,
02864                               Tag &gt;&gt; 16,
02865                               Tag &gt;&gt; 24
02866                             );
02867                     DbgBreakPoint();
02868                 }
02869             }
02870 
02871             <a class="code" href="../../d2/d2/ex_2pool_8c.html#a66">ExpRemovePoolTracker</a>(Tag,
02872                                  BigPages * <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>,
02873                                  PoolType);
02874         }
02875 
02876         <span class="comment">//</span>
02877         <span class="comment">// Check if an ERESOURCE is currently active in this memory block.</span>
02878         <span class="comment">//</span>
02879 
02880         <a class="code" href="../../d2/d2/ex_2pool_8c.html#a3">FREE_CHECK_ERESOURCE</a> (P, BigPages &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
02881 
02882         <span class="comment">//</span>
02883         <span class="comment">// Check if a KTIMER is currently active in this memory block</span>
02884         <span class="comment">//</span>
02885 
02886         <a class="code" href="../../d2/d2/ex_2pool_8c.html#a4">FREE_CHECK_KTIMER</a>(P, BigPages &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
02887 
02888         <span class="comment">//</span>
02889         <span class="comment">// Search worker queues for work items still queued</span>
02890         <span class="comment">//</span>
02891         <a class="code" href="../../d2/d2/ex_2pool_8c.html#a5">FREE_CHECK_WORKER</a>(P, BigPages &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>);
02892 
02893         PoolDesc-&gt;<a class="code" href="../../d4/d8/struct__POOL__DESCRIPTOR.html#o8">TotalBigPages</a> -= BigPages;
02894 
02895         <a class="code" href="../../d2/d2/ex_2pool_8c.html#a35">UNLOCK_POOL</a>(PoolDesc, LockHandle);
02896 
02897         <span class="keywordflow">return</span>;
02898     }
02899 
02900     <span class="comment">//</span>
02901     <span class="comment">// Align the entry address to a pool allocation boundary.</span>
02902     <span class="comment">//</span>
02903 
02904 <span class="preprocessor">#if POOL_CACHE_SUPPORTED</span>
02905 <span class="preprocessor"></span>
02906     <span class="keywordflow">if</span> (((ULONG)P &amp; POOL_CACHE_CHECK) == 0) {
02907         Entry = (<a class="code" href="../../d5/d8/struct__POOL__HEADER.html">PPOOL_HEADER</a>)((ULONG)P - PoolCacheSize);
02908 
02909     } <span class="keywordflow">else</span> {
02910         Entry = (<a class="code" href="../../d5/d8/struct__POOL__HEADER.html">PPOOL_HEADER</a>)((PCHAR)P - <a class="code" href="../../d5/d2/poolhack_8c.html#a6">POOL_OVERHEAD</a>);
02911     }
02912 
02913 <span class="preprocessor">#else</span>
02914 <span class="preprocessor"></span>
02915     Entry = (<a class="code" href="../../d5/d8/struct__POOL__HEADER.html">PPOOL_HEADER</a>)((PCHAR)P - <a class="code" href="../../d5/d2/poolhack_8c.html#a6">POOL_OVERHEAD</a>);
02916 
02917 <span class="preprocessor">#endif //POOL_CACHE_SUPPORTED</span>
02918 <span class="preprocessor"></span>
02919     <a class="code" href="../../d2/d2/ex_2pool_8c.html#a21">ASSERT_POOL_NOT_FREE</a>(Entry);
02920 
02921     PoolType = (Entry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o1">PoolType</a> &amp; <a class="code" href="../../d4/d2/pool_8h.html#a12">POOL_TYPE_MASK</a>) - 1;
02922 
02923     CheckType = PoolType &amp; <a class="code" href="../../d4/d2/pool_8h.html#a5">BASE_POOL_TYPE_MASK</a>;
02924 
02925     <a class="code" href="../../d2/d2/ex_2pool_8c.html#a20">ASSERT_FREE_IRQL</a>(PoolType, P);
02926 
02927     <span class="keywordflow">if</span> (Entry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o1">PoolType</a> &amp; <a class="code" href="../../d4/d2/pool_8h.html#a9">POOL_VERIFIER_MASK</a>) {
02928         <a class="code" href="../../d9/d5/verifier_8c.html#a91">VerifierFreeTrackedPool</a> (P,
02929                                  Entry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o6">BlockSize</a> &lt;&lt; <a class="code" href="../../d4/d2/pool_8h.html#a14">POOL_BLOCK_SHIFT</a>,
02930                                  CheckType,
02931                                  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
02932     }
02933 
02934     PoolDesc = <a class="code" href="../../d2/d2/ex_2pool_8c.html#a54">PoolVector</a>[PoolType];
02935     GlobalSpace = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02936 
02937     <span class="keywordflow">if</span> (Entry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o1">PoolType</a> &amp; <a class="code" href="../../d4/d2/pool_8h.html#a8">SESSION_POOL_MASK</a>) {
02938         <span class="keywordflow">if</span> (CheckType == <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>) {
02939             PoolDesc = <a class="code" href="../../d2/d2/ex_2pool_8c.html#a40">ExpSessionPoolDescriptor</a>;
02940         }
02941         GlobalSpace = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02942     }
02943     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (CheckType == <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>) {
02944         PoolDesc = &amp;PoolDesc[<a class="code" href="../../d2/d2/ex_2pool_8c.html#a27">DECODE_POOL_INDEX</a>(Entry)];
02945     }
02946 
02947     <a class="code" href="../../d2/d2/ex_2pool_8c.html#a33">LOCK_POOL</a>(PoolDesc, LockHandle);
02948 
02949     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d2/ex_2pool_8c.html#a30">IS_POOL_HEADER_MARKED_ALLOCATED</a>(Entry)) {
02950         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (BAD_POOL_CALLER, 7, __LINE__, (ULONG_PTR)Entry, (ULONG_PTR)P);
02951     }
02952 
02953     <a class="code" href="../../d2/d2/ex_2pool_8c.html#a29">MARK_POOL_HEADER_FREED</a>(Entry);
02954 
02955     <span class="comment">//</span>
02956     <span class="comment">// If this allocation was in session space, let the memory</span>
02957     <span class="comment">// manager know to delete it so it won't be considered in use on</span>
02958     <span class="comment">// session exit.  Note this call must be made with the</span>
02959     <span class="comment">// relevant pool still locked.</span>
02960     <span class="comment">//</span>
02961 
02962     <span class="keywordflow">if</span> (GlobalSpace == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
02963         <a class="code" href="../../d1/d6/allocpag_8c.html#a51">MiSessionPoolFreed</a>(P, Entry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o6">BlockSize</a> &lt;&lt; <a class="code" href="../../d4/d2/pool_8h.html#a14">POOL_BLOCK_SHIFT</a>, CheckType);
02964     }
02965 
02966     <a class="code" href="../../d2/d2/ex_2pool_8c.html#a35">UNLOCK_POOL</a>(PoolDesc, LockHandle);
02967 
02968     <a class="code" href="../../d2/d2/ex_2pool_8c.html#a22">ASSERT_POOL_TYPE_NOT_ZERO</a>(Entry);
02969 
02970     <span class="comment">//</span>
02971     <span class="comment">// Check if an ERESOURCE is currently active in this memory block.</span>
02972     <span class="comment">//</span>
02973 
02974     <a class="code" href="../../d2/d2/ex_2pool_8c.html#a3">FREE_CHECK_ERESOURCE</a> (Entry, (ULONG)(Entry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o6">BlockSize</a> &lt;&lt; <a class="code" href="../../d4/d2/pool_8h.html#a14">POOL_BLOCK_SHIFT</a>));
02975 
02976     <span class="comment">//</span>
02977     <span class="comment">// Check if a KTIMER is currently active in this memory block.</span>
02978     <span class="comment">//</span>
02979 
02980     <a class="code" href="../../d2/d2/ex_2pool_8c.html#a4">FREE_CHECK_KTIMER</a>(Entry, (ULONG)(Entry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o6">BlockSize</a> &lt;&lt; <a class="code" href="../../d4/d2/pool_8h.html#a14">POOL_BLOCK_SHIFT</a>));
02981 
02982     <span class="comment">//</span>
02983     <span class="comment">// Look for work items still queued</span>
02984     <span class="comment">//</span>
02985 
02986     <a class="code" href="../../d2/d2/ex_2pool_8c.html#a5">FREE_CHECK_WORKER</a>(Entry, (ULONG)(Entry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o6">BlockSize</a> &lt;&lt; <a class="code" href="../../d4/d2/pool_8h.html#a14">POOL_BLOCK_SHIFT</a>));
02987 
02988 
02989 <span class="preprocessor">#if DBG</span>
02990 <span class="preprocessor"></span>
02991     <span class="comment">//</span>
02992     <span class="comment">// Check if the pool index field is defined correctly.</span>
02993     <span class="comment">//</span>
02994 
02995     <span class="keywordflow">if</span> (CheckType == <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>) {
02996         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d2/ex_2pool_8c.html#a27">DECODE_POOL_INDEX</a>(Entry) != 0) {
02997             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(BAD_POOL_CALLER, 2, (ULONG_PTR)Entry, (ULONG_PTR)(*(PULONG)Entry), 0);
02998         }
02999     }
03000     <span class="keywordflow">else</span> {
03001         <span class="keywordflow">if</span> (GlobalSpace == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
03002             <span class="comment">//</span>
03003             <span class="comment">// All session space allocations have an index of 0.</span>
03004             <span class="comment">//</span>
03005             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (<a class="code" href="../../d2/d2/ex_2pool_8c.html#a27">DECODE_POOL_INDEX</a>(Entry) == 0);
03006         }
03007         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d2/d2/ex_2pool_8c.html#a27">DECODE_POOL_INDEX</a>(Entry) == 0) {
03008             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(BAD_POOL_CALLER, 4, (ULONG_PTR)Entry, *(PULONG)Entry, 0);
03009         }
03010     }
03011 
03012 <span class="preprocessor">#endif // DBG</span>
03013 <span class="preprocessor"></span>
03014     <span class="comment">//</span>
03015     <span class="comment">// If pool tagging is enabled, then update the pool tracking database.</span>
03016     <span class="comment">// Otherwise, check to determine if quota was charged when the pool</span>
03017     <span class="comment">// block was allocated.</span>
03018     <span class="comment">//</span>
03019 
03020 <span class="preprocessor">#if defined (_WIN64)</span>
03021 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (Entry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o1">PoolType</a> &amp; <a class="code" href="../../d4/d2/pool_8h.html#a11">POOL_QUOTA_MASK</a>) {
03022         ProcessBilled = Entry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o2">ProcessBilled</a>;
03023     }
03024 
03025     Tag = Entry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o9">PoolTag</a>;
03026     <span class="keywordflow">if</span> (Tag &amp; <a class="code" href="../../d5/d8/ex_8h.html#a6">PROTECTED_POOL</a>) {
03027         Tag &amp;= ~<a class="code" href="../../d5/d8/ex_8h.html#a6">PROTECTED_POOL</a>;
03028         TagToFree &amp;= ~<a class="code" href="../../d5/d8/ex_8h.html#a6">PROTECTED_POOL</a>;
03029         <span class="keywordflow">if</span> (Tag != TagToFree) {
03030             <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"EX: Invalid attempt to free protected pool block %x (%c%c%c%c)\n"</span>,
03031                       P,
03032                       Tag,
03033                       Tag &gt;&gt; 8,
03034                       Tag &gt;&gt; 16,
03035                       Tag &gt;&gt; 24
03036                     );
03037             DbgBreakPoint();
03038         }
03039     }
03040     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d2/ex_2pool_8c.html#a42">PoolTrackTable</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03041         <span class="keywordflow">if</span> (GlobalSpace == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
03042             <a class="code" href="../../d2/d2/ex_2pool_8c.html#a66">ExpRemovePoolTracker</a>(Tag,
03043                                  Entry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o6">BlockSize</a> &lt;&lt; <a class="code" href="../../d4/d2/pool_8h.html#a14">POOL_BLOCK_SHIFT</a>,
03044                                  PoolType);
03045 
03046         }
03047     }
03048     <span class="keywordflow">if</span> (ProcessBilled != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03049         <a class="code" href="../../d0/d2/psquota_8c.html#a3">PsReturnPoolQuota</a>(ProcessBilled,
03050                           PoolType &amp; <a class="code" href="../../d4/d2/pool_8h.html#a5">BASE_POOL_TYPE_MASK</a>,
03051                           (ULONG)Entry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o6">BlockSize</a> &lt;&lt; <a class="code" href="../../d4/d2/pool_8h.html#a14">POOL_BLOCK_SHIFT</a>);
03052         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(ProcessBilled);
03053     }
03054 <span class="preprocessor">#else</span>
03055 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (Entry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o1">PoolType</a> &amp; <a class="code" href="../../d4/d2/pool_8h.html#a11">POOL_QUOTA_MASK</a>) {
03056         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d2/ex_2pool_8c.html#a42">PoolTrackTable</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03057             ProcessBilled = Entry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o2">ProcessBilled</a>;
03058             Entry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o9">PoolTag</a> = 'atoQ';
03059         }
03060     }
03061 
03062     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d2/ex_2pool_8c.html#a42">PoolTrackTable</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03063         Tag = Entry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o9">PoolTag</a>;
03064         <span class="keywordflow">if</span> (Tag &amp; <a class="code" href="../../d5/d8/ex_8h.html#a6">PROTECTED_POOL</a>) {
03065             Tag &amp;= ~<a class="code" href="../../d5/d8/ex_8h.html#a6">PROTECTED_POOL</a>;
03066             TagToFree &amp;= ~<a class="code" href="../../d5/d8/ex_8h.html#a6">PROTECTED_POOL</a>;
03067             <span class="keywordflow">if</span> (Tag != TagToFree) {
03068                 <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a>( <span class="stringliteral">"EX: Invalid attempt to free protected pool block %x (%c%c%c%c)\n"</span>,
03069                           P,
03070                           Tag,
03071                           Tag &gt;&gt; 8,
03072                           Tag &gt;&gt; 16,
03073                           Tag &gt;&gt; 24
03074                         );
03075                 DbgBreakPoint();
03076             }
03077         }
03078         <span class="keywordflow">if</span> (GlobalSpace == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
03079             <a class="code" href="../../d2/d2/ex_2pool_8c.html#a66">ExpRemovePoolTracker</a>(Tag,
03080                                  Entry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o6">BlockSize</a> &lt;&lt; <a class="code" href="../../d4/d2/pool_8h.html#a14">POOL_BLOCK_SHIFT</a> ,
03081                                  PoolType);
03082         }
03083     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ProcessBilled != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03084         <a class="code" href="../../d0/d2/psquota_8c.html#a3">PsReturnPoolQuota</a>(ProcessBilled,
03085                           PoolType &amp; <a class="code" href="../../d4/d2/pool_8h.html#a5">BASE_POOL_TYPE_MASK</a>,
03086                           (ULONG)Entry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o6">BlockSize</a> &lt;&lt; <a class="code" href="../../d4/d2/pool_8h.html#a14">POOL_BLOCK_SHIFT</a>);
03087         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(ProcessBilled);
03088     }
03089 <span class="preprocessor">#endif</span>
03090 <span class="preprocessor"></span>
03091     <span class="comment">//</span>
03092     <span class="comment">// If the pool block is a small block, then attempt to free the block</span>
03093     <span class="comment">// to the single entry lookaside list. If the free attempt fails, then</span>
03094     <span class="comment">// free the block by merging it back into the pool data structures.</span>
03095     <span class="comment">//</span>
03096 
03097     PoolIndex = <a class="code" href="../../d2/d2/ex_2pool_8c.html#a27">DECODE_POOL_INDEX</a>(Entry);
03098 
03099     <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = Entry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o6">BlockSize</a>;
03100 
03101     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt;= <a class="code" href="../../d0/d9/ntosdef_8h.html#a2">POOL_SMALL_LISTS</a> &amp;&amp; GlobalSpace == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
03102 
03103         <span class="comment">//</span>
03104         <span class="comment">// Attempt to free the small block to a per processor lookaside</span>
03105         <span class="comment">// list.</span>
03106         <span class="comment">//</span>
03107 
03108         <span class="keywordflow">if</span> (CheckType == <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>) {
03109             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d3/i386_8h.html#a16">Isx86FeaturePresent</a>(<a class="code" href="../../d5/d3/i386_8h.html#a7">KF_CMPXCHG8B</a>)) {
03110                 Prcb = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a2">KeGetCurrentPrcb</a>();
03111                 LookasideList = Prcb-&gt;PPPagedLookasideList[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> - 1].P;
03112                 LookasideList-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o6">TotalFrees</a> += 1;
03113 
03114                 <a class="code" href="../../d2/d2/ex_2pool_8c.html#a23">CHECK_LOOKASIDE_LIST</a>(__LINE__, LookasideList, P);
03115 
03116                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d8/ex_8h.html#a10">ExQueryDepthSList</a>(&amp;LookasideList-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o0">ListHead</a>) &lt; LookasideList-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o1">Depth</a>) {
03117                     LookasideList-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o8">FreeHits</a> += 1;
03118                     Entry += 1;
03119                     <a class="code" href="../../d5/d8/ex_8h.html#a243">ExInterlockedPushEntrySList</a>(&amp;LookasideList-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o0">ListHead</a>,
03120                                                 (PSINGLE_LIST_ENTRY)Entry,
03121                                                 &amp;LookasideList-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o1">Lock</a>);
03122 
03123                     <a class="code" href="../../d2/d2/ex_2pool_8c.html#a23">CHECK_LOOKASIDE_LIST</a>(__LINE__, LookasideList, P);
03124 
03125                     <span class="keywordflow">return</span>;
03126 
03127                 } <span class="keywordflow">else</span> {
03128                     LookasideList = Prcb-&gt;PPPagedLookasideList[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> - 1].<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>;
03129                     LookasideList-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o6">TotalFrees</a> += 1;
03130 
03131                     <a class="code" href="../../d2/d2/ex_2pool_8c.html#a23">CHECK_LOOKASIDE_LIST</a>(__LINE__, LookasideList, P);
03132 
03133                     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d8/ex_8h.html#a10">ExQueryDepthSList</a>(&amp;LookasideList-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o0">ListHead</a>) &lt; LookasideList-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o1">Depth</a>) {
03134                         LookasideList-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o8">FreeHits</a> += 1;
03135                         Entry += 1;
03136                         <a class="code" href="../../d5/d8/ex_8h.html#a243">ExInterlockedPushEntrySList</a>(&amp;LookasideList-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o0">ListHead</a>,
03137                                                     (PSINGLE_LIST_ENTRY)Entry,
03138                                                     &amp;LookasideList-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o1">Lock</a>);
03139 
03140                         <a class="code" href="../../d2/d2/ex_2pool_8c.html#a23">CHECK_LOOKASIDE_LIST</a>(__LINE__, LookasideList, P);
03141 
03142                         <span class="keywordflow">return</span>;
03143                     }
03144                 }
03145             }
03146 
03147         } <span class="keywordflow">else</span> {
03148 
03149             <span class="comment">//</span>
03150             <span class="comment">// Make sure we don't put a must succeed buffer into the</span>
03151             <span class="comment">// regular nonpaged pool list.</span>
03152             <span class="comment">//</span>
03153 
03154             <span class="keywordflow">if</span> (PoolType != <a class="code" href="../../d5/d8/ex_8h.html#a329a175">NonPagedPoolMustSucceed</a>) {
03155                 Prcb = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a2">KeGetCurrentPrcb</a>();
03156                 LookasideList = Prcb-&gt;PPNPagedLookasideList[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> - 1].P;
03157                 LookasideList-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o6">TotalFrees</a> += 1;
03158 
03159                 <a class="code" href="../../d2/d2/ex_2pool_8c.html#a23">CHECK_LOOKASIDE_LIST</a>(__LINE__, LookasideList, P);
03160 
03161                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d8/ex_8h.html#a10">ExQueryDepthSList</a>(&amp;LookasideList-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o0">ListHead</a>) &lt; LookasideList-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o1">Depth</a>) {
03162                     LookasideList-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o8">FreeHits</a> += 1;
03163                     Entry += 1;
03164                     <a class="code" href="../../d5/d8/ex_8h.html#a243">ExInterlockedPushEntrySList</a>(&amp;LookasideList-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o0">ListHead</a>,
03165                                                 (PSINGLE_LIST_ENTRY)Entry,
03166                                                 &amp;LookasideList-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o1">Lock</a>);
03167 
03168                     <a class="code" href="../../d2/d2/ex_2pool_8c.html#a23">CHECK_LOOKASIDE_LIST</a>(__LINE__, LookasideList, P);
03169 
03170                     <span class="keywordflow">return</span>;
03171 
03172                 } <span class="keywordflow">else</span> {
03173                     LookasideList = Prcb-&gt;PPNPagedLookasideList[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> - 1].<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>;
03174                     LookasideList-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o6">TotalFrees</a> += 1;
03175 
03176                     <a class="code" href="../../d2/d2/ex_2pool_8c.html#a23">CHECK_LOOKASIDE_LIST</a>(__LINE__, LookasideList, P);
03177 
03178                     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d8/ex_8h.html#a10">ExQueryDepthSList</a>(&amp;LookasideList-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o0">ListHead</a>) &lt; LookasideList-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o1">Depth</a>) {
03179                         LookasideList-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o8">FreeHits</a> += 1;
03180                         Entry += 1;
03181                         <a class="code" href="../../d5/d8/ex_8h.html#a243">ExInterlockedPushEntrySList</a>(&amp;LookasideList-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o0">ListHead</a>,
03182                                                     (PSINGLE_LIST_ENTRY)Entry,
03183                                                     &amp;LookasideList-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o1">Lock</a>);
03184 
03185                         <a class="code" href="../../d2/d2/ex_2pool_8c.html#a23">CHECK_LOOKASIDE_LIST</a>(__LINE__, LookasideList, P);
03186 
03187                         <span class="keywordflow">return</span>;
03188                     }
03189                 }
03190             }
03191         }
03192     }
03193 
03194     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(PoolIndex == PoolDesc-&gt;<a class="code" href="../../d4/d8/struct__POOL__DESCRIPTOR.html#o5">PoolIndex</a>);
03195 
03196     <a class="code" href="../../d2/d2/ex_2pool_8c.html#a33">LOCK_POOL</a>(PoolDesc, LockHandle);
03197 
03198     <a class="code" href="../../d2/d2/ex_2pool_8c.html#a18">CHECK_POOL_HEADER</a>(__LINE__, Entry);
03199 
03200     PoolDesc-&gt;<a class="code" href="../../d4/d8/struct__POOL__DESCRIPTOR.html#o7">RunningDeAllocs</a> += 1;
03201 
03202     <span class="comment">//</span>
03203     <span class="comment">// Free the specified pool block.</span>
03204     <span class="comment">//</span>
03205     <span class="comment">// Check to see if the next entry is free.</span>
03206     <span class="comment">//</span>
03207 
03208     Combined = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03209     NextEntry = (<a class="code" href="../../d5/d8/struct__POOL__HEADER.html">PPOOL_HEADER</a>)((<a class="code" href="../../d3/d8/struct__POOL__BLOCK.html">PPOOL_BLOCK</a>)Entry + Entry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o6">BlockSize</a>);
03210     <span class="keywordflow">if</span> (<a class="code" href="../../d4/d2/pool_8h.html#a17">PAGE_END</a>(NextEntry) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
03211 
03212         <span class="keywordflow">if</span> (NextEntry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o1">PoolType</a> == 0) {
03213 
03214             <span class="comment">//</span>
03215             <span class="comment">// This block is free, combine with the released block.</span>
03216             <span class="comment">//</span>
03217 
03218             Combined = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03219 
03220             <a class="code" href="../../d2/d2/ex_2pool_8c.html#a17">CHECK_LIST</a>(__LINE__, ((PLIST_ENTRY)((PCHAR)NextEntry + <a class="code" href="../../d5/d2/poolhack_8c.html#a6">POOL_OVERHEAD</a>)), P);
03221             <a class="code" href="../../d2/d2/ex_2pool_8c.html#a14">PrivateRemoveEntryList</a>(((PLIST_ENTRY)((PCHAR)NextEntry + <a class="code" href="../../d5/d2/poolhack_8c.html#a6">POOL_OVERHEAD</a>)));
03222             <a class="code" href="../../d2/d2/ex_2pool_8c.html#a17">CHECK_LIST</a>(__LINE__, <a class="code" href="../../d2/d2/ex_2pool_8c.html#a8">DecodeLink</a>(((PLIST_ENTRY)((PCHAR)NextEntry + <a class="code" href="../../d5/d2/poolhack_8c.html#a6">POOL_OVERHEAD</a>))-&gt;Flink), P);
03223             <a class="code" href="../../d2/d2/ex_2pool_8c.html#a17">CHECK_LIST</a>(__LINE__, <a class="code" href="../../d2/d2/ex_2pool_8c.html#a8">DecodeLink</a>(((PLIST_ENTRY)((PCHAR)NextEntry + <a class="code" href="../../d5/d2/poolhack_8c.html#a6">POOL_OVERHEAD</a>))-&gt;Blink), P);
03224 
03225             Entry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o6">BlockSize</a> += NextEntry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o6">BlockSize</a>;
03226         }
03227     }
03228 
03229     <span class="comment">//</span>
03230     <span class="comment">// Check to see if the previous entry is free.</span>
03231     <span class="comment">//</span>
03232 
03233     <span class="keywordflow">if</span> (Entry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o3">PreviousSize</a> != 0) {
03234         NextEntry = (<a class="code" href="../../d5/d8/struct__POOL__HEADER.html">PPOOL_HEADER</a>)((<a class="code" href="../../d3/d8/struct__POOL__BLOCK.html">PPOOL_BLOCK</a>)Entry - Entry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o3">PreviousSize</a>);
03235         <span class="keywordflow">if</span> (NextEntry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o1">PoolType</a> == 0) {
03236 
03237             <span class="comment">//</span>
03238             <span class="comment">// This block is free, combine with the released block.</span>
03239             <span class="comment">//</span>
03240 
03241             Combined = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03242 
03243             <a class="code" href="../../d2/d2/ex_2pool_8c.html#a17">CHECK_LIST</a>(__LINE__, ((PLIST_ENTRY)((PCHAR)NextEntry + <a class="code" href="../../d5/d2/poolhack_8c.html#a6">POOL_OVERHEAD</a>)), P);
03244             <a class="code" href="../../d2/d2/ex_2pool_8c.html#a14">PrivateRemoveEntryList</a>(((PLIST_ENTRY)((PCHAR)NextEntry + <a class="code" href="../../d5/d2/poolhack_8c.html#a6">POOL_OVERHEAD</a>)));
03245             <a class="code" href="../../d2/d2/ex_2pool_8c.html#a17">CHECK_LIST</a>(__LINE__, <a class="code" href="../../d2/d2/ex_2pool_8c.html#a8">DecodeLink</a>(((PLIST_ENTRY)((PCHAR)NextEntry + <a class="code" href="../../d5/d2/poolhack_8c.html#a6">POOL_OVERHEAD</a>))-&gt;Flink), P);
03246             <a class="code" href="../../d2/d2/ex_2pool_8c.html#a17">CHECK_LIST</a>(__LINE__, <a class="code" href="../../d2/d2/ex_2pool_8c.html#a8">DecodeLink</a>(((PLIST_ENTRY)((PCHAR)NextEntry + <a class="code" href="../../d5/d2/poolhack_8c.html#a6">POOL_OVERHEAD</a>))-&gt;Blink), P);
03247 
03248             NextEntry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o6">BlockSize</a> += Entry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o6">BlockSize</a>;
03249             Entry = NextEntry;
03250         }
03251     }
03252 
03253     <span class="comment">//</span>
03254     <span class="comment">// If the block being freed has been combined into a full page,</span>
03255     <span class="comment">// then return the free page to memory management.</span>
03256     <span class="comment">//</span>
03257 
03258     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d2/poolhack_8c.html#a5">PAGE_ALIGNED</a>(Entry) &amp;&amp;
03259         (<a class="code" href="../../d4/d2/pool_8h.html#a17">PAGE_END</a>((<a class="code" href="../../d3/d8/struct__POOL__BLOCK.html">PPOOL_BLOCK</a>)Entry + Entry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o6">BlockSize</a>) != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
03260 
03261         <span class="comment">//</span>
03262         <span class="comment">// If the pool type is paged pool, then the paged pool page lock</span>
03263         <span class="comment">// must be held during the free of the pool pages.</span>
03264         <span class="comment">//</span>
03265 
03266         <a class="code" href="../../d2/d2/ex_2pool_8c.html#a34">LOCK_IF_PAGED_POOL</a>(CheckType, GlobalSpace);
03267 
03268         <a class="code" href="../../d2/d1/mm_8h.html#a52">PERFINFO_FREEPOOLPAGE</a>(CheckType, PoolIndex, Entry, PoolDesc);
03269 
03270         <a class="code" href="../../d1/d6/allocpag_8c.html#a55">MiFreePoolPages</a>(Entry);
03271 
03272         <a class="code" href="../../d2/d2/ex_2pool_8c.html#a36">UNLOCK_IF_PAGED_POOL</a>(CheckType, GlobalSpace);
03273 
03274         PoolDesc-&gt;<a class="code" href="../../d4/d8/struct__POOL__DESCRIPTOR.html#o1">TotalPages</a> -= 1;
03275 
03276     } <span class="keywordflow">else</span> {
03277 
03278         <span class="comment">//</span>
03279         <span class="comment">// Insert this element into the list.</span>
03280         <span class="comment">//</span>
03281 
03282         Entry-&gt;PoolType = 0;
03283         <a class="code" href="../../d2/d2/ex_2pool_8c.html#a26">ENCODE_POOL_INDEX</a>(Entry, PoolIndex);
03284         <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = Entry-&gt;BlockSize;
03285 
03286         <span class="comment">//</span>
03287         <span class="comment">// If the freed block was combined with any other block, then</span>
03288         <span class="comment">// adjust the size of the next block if necessary.</span>
03289         <span class="comment">//</span>
03290 
03291         <span class="keywordflow">if</span> (Combined != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
03292 
03293             <span class="comment">//</span>
03294             <span class="comment">// The size of this entry has changed, if this entry is</span>
03295             <span class="comment">// not the last one in the page, update the pool block</span>
03296             <span class="comment">// after this block to have a new previous allocation size.</span>
03297             <span class="comment">//</span>
03298 
03299             NextEntry = (<a class="code" href="../../d5/d8/struct__POOL__HEADER.html">PPOOL_HEADER</a>)((<a class="code" href="../../d3/d8/struct__POOL__BLOCK.html">PPOOL_BLOCK</a>)Entry + Entry-&gt;BlockSize);
03300             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d2/pool_8h.html#a17">PAGE_END</a>(NextEntry) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
03301                 NextEntry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o3">PreviousSize</a> = Entry-&gt;BlockSize;
03302             }
03303 
03304             <span class="comment">//</span>
03305             <span class="comment">// Reduce fragmentation and insert at the tail in hopes</span>
03306             <span class="comment">// neighbors for this will be freed before this is reallocated.</span>
03307             <span class="comment">//</span>
03308 
03309             <a class="code" href="../../d2/d2/ex_2pool_8c.html#a17">CHECK_LIST</a>(__LINE__, &amp;PoolDesc-&gt;<a class="code" href="../../d4/d8/struct__POOL__DESCRIPTOR.html#o4">ListHeads</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> - 1], P);
03310             <a class="code" href="../../d2/d2/ex_2pool_8c.html#a15">PrivateInsertTailList</a>(&amp;PoolDesc-&gt;<a class="code" href="../../d4/d8/struct__POOL__DESCRIPTOR.html#o4">ListHeads</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> - 1], ((PLIST_ENTRY)((PCHAR)Entry + <a class="code" href="../../d5/d2/poolhack_8c.html#a6">POOL_OVERHEAD</a>)));
03311             <a class="code" href="../../d2/d2/ex_2pool_8c.html#a17">CHECK_LIST</a>(__LINE__, &amp;PoolDesc-&gt;<a class="code" href="../../d4/d8/struct__POOL__DESCRIPTOR.html#o4">ListHeads</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> - 1], P);
03312             <a class="code" href="../../d2/d2/ex_2pool_8c.html#a17">CHECK_LIST</a>(__LINE__, ((PLIST_ENTRY)((PCHAR)Entry + <a class="code" href="../../d5/d2/poolhack_8c.html#a6">POOL_OVERHEAD</a>)), P);
03313 
03314         } <span class="keywordflow">else</span> {
03315 
03316             <a class="code" href="../../d2/d2/ex_2pool_8c.html#a17">CHECK_LIST</a>(__LINE__, &amp;PoolDesc-&gt;<a class="code" href="../../d4/d8/struct__POOL__DESCRIPTOR.html#o4">ListHeads</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> - 1], P);
03317             <a class="code" href="../../d2/d2/ex_2pool_8c.html#a16">PrivateInsertHeadList</a>(&amp;PoolDesc-&gt;<a class="code" href="../../d4/d8/struct__POOL__DESCRIPTOR.html#o4">ListHeads</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> - 1], ((PLIST_ENTRY)((PCHAR)Entry + <a class="code" href="../../d5/d2/poolhack_8c.html#a6">POOL_OVERHEAD</a>)));
03318             <a class="code" href="../../d2/d2/ex_2pool_8c.html#a17">CHECK_LIST</a>(__LINE__, &amp;PoolDesc-&gt;<a class="code" href="../../d4/d8/struct__POOL__DESCRIPTOR.html#o4">ListHeads</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> - 1], P);
03319             <a class="code" href="../../d2/d2/ex_2pool_8c.html#a17">CHECK_LIST</a>(__LINE__, ((PLIST_ENTRY)((PCHAR)Entry + <a class="code" href="../../d5/d2/poolhack_8c.html#a6">POOL_OVERHEAD</a>)), P);
03320         }
03321     }
03322 
03323     <a class="code" href="../../d2/d2/ex_2pool_8c.html#a35">UNLOCK_POOL</a>(PoolDesc, LockHandle);
03324 }
03325 
03326 
03327 ULONG
<a name="l03328"></a><a class="code" href="../../d5/d8/ex_8h.html#a228">03328</a> <a class="code" href="../../d5/d8/ex_8h.html#a228">ExQueryPoolBlockSize</a> (
03329     IN PVOID PoolBlock,
03330     OUT PBOOLEAN QuotaCharged
03331     )
03332 
03333 <span class="comment">/*++</span>
03334 <span class="comment"></span>
03335 <span class="comment">Routine Description:</span>
03336 <span class="comment"></span>
03337 <span class="comment">    This function returns the size of the pool block.</span>
03338 <span class="comment"></span>
03339 <span class="comment">Arguments:</span>
03340 <span class="comment"></span>
03341 <span class="comment">    PoolBlock - Supplies the address of the block of pool.</span>
03342 <span class="comment"></span>
03343 <span class="comment">    QuotaCharged - Supplies a BOOLEAN variable to receive whether or not the</span>
03344 <span class="comment">        pool block had quota charged.</span>
03345 <span class="comment"></span>
03346 <span class="comment">    NOTE: If the entry is bigger than a page, the value PAGE_SIZE is returned</span>
03347 <span class="comment">          rather than the correct number of bytes.</span>
03348 <span class="comment"></span>
03349 <span class="comment">Return Value:</span>
03350 <span class="comment"></span>
03351 <span class="comment">    Size of pool block.</span>
03352 <span class="comment"></span>
03353 <span class="comment">--*/</span>
03354 
03355 {
03356     <a class="code" href="../../d5/d8/struct__POOL__HEADER.html">PPOOL_HEADER</a> Entry;
03357     ULONG size;
03358 
03359     <span class="keywordflow">if</span> ((PoolBlock &gt;= <a class="code" href="../../d2/d1/mm_8h.html#a160">MmSpecialPoolStart</a>) &amp;&amp; (PoolBlock &lt; <a class="code" href="../../d2/d1/mm_8h.html#a161">MmSpecialPoolEnd</a>)) {
03360         *QuotaCharged = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03361         <span class="keywordflow">return</span> (ULONG)<a class="code" href="../../d1/d6/allocpag_8c.html#a57">MmQuerySpecialPoolBlockSize</a> (PoolBlock);
03362     }
03363 
03364     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d2/poolhack_8c.html#a5">PAGE_ALIGNED</a>(PoolBlock)) {
03365         *QuotaCharged = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03366         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
03367     }
03368 
03369 <span class="preprocessor">#if POOL_CACHE_SUPPORTED</span>
03370 <span class="preprocessor"></span>
03371     <span class="comment">//</span>
03372     <span class="comment">// Align entry on pool allocation boundary.</span>
03373     <span class="comment">//</span>
03374 
03375     <span class="keywordflow">if</span> (((ULONG)PoolBlock &amp; POOL_CACHE_CHECK) == 0) {
03376         Entry = (<a class="code" href="../../d5/d8/struct__POOL__HEADER.html">PPOOL_HEADER</a>)((ULONG)PoolBlock - PoolCacheSize);
03377         size = (Entry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o6">BlockSize</a> &lt;&lt; <a class="code" href="../../d4/d2/pool_8h.html#a14">POOL_BLOCK_SHIFT</a>) - PoolCacheSize;
03378 
03379     } <span class="keywordflow">else</span> {
03380         Entry = (<a class="code" href="../../d5/d8/struct__POOL__HEADER.html">PPOOL_HEADER</a>)((PCHAR)PoolBlock - <a class="code" href="../../d5/d2/poolhack_8c.html#a6">POOL_OVERHEAD</a>);
03381         size = (Entry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o6">BlockSize</a> &lt;&lt; <a class="code" href="../../d4/d2/pool_8h.html#a14">POOL_BLOCK_SHIFT</a>) - <a class="code" href="../../d5/d2/poolhack_8c.html#a6">POOL_OVERHEAD</a>;
03382     }
03383 
03384 <span class="preprocessor">#else</span>
03385 <span class="preprocessor"></span>
03386     Entry = (<a class="code" href="../../d5/d8/struct__POOL__HEADER.html">PPOOL_HEADER</a>)((PCHAR)PoolBlock - <a class="code" href="../../d5/d2/poolhack_8c.html#a6">POOL_OVERHEAD</a>);
03387     size = (ULONG)((Entry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o6">BlockSize</a> &lt;&lt; <a class="code" href="../../d4/d2/pool_8h.html#a14">POOL_BLOCK_SHIFT</a>) - <a class="code" href="../../d5/d2/poolhack_8c.html#a6">POOL_OVERHEAD</a>);
03388 
03389 <span class="preprocessor">#endif //POOL_CACHE_SUPPORTED</span>
03390 <span class="preprocessor"></span>
03391 <span class="preprocessor">#ifdef _WIN64</span>
03392 <span class="preprocessor"></span>    *QuotaCharged = (BOOLEAN) (Entry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o2">ProcessBilled</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
03393 <span class="preprocessor">#else</span>
03394 <span class="preprocessor"></span>    <span class="keywordflow">if</span> ( <a class="code" href="../../d2/d2/ex_2pool_8c.html#a42">PoolTrackTable</a> ) {
03395         *QuotaCharged = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03396     }
03397     <span class="keywordflow">else</span> {
03398         *QuotaCharged = (BOOLEAN) (Entry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o2">ProcessBilled</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
03399     }
03400 <span class="preprocessor">#endif</span>
03401 <span class="preprocessor"></span>    <span class="keywordflow">return</span> size;
03402 }
03403 
03404 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l03405"></a><a class="code" href="../../d5/d8/ex_8h.html#a229">03405</a> <a class="code" href="../../d5/d8/ex_8h.html#a229">ExQueryPoolUsage</a>(
03406     OUT PULONG PagedPoolPages,
03407     OUT PULONG NonPagedPoolPages,
03408     OUT PULONG PagedPoolAllocs,
03409     OUT PULONG PagedPoolFrees,
03410     OUT PULONG PagedPoolLookasideHits,
03411     OUT PULONG NonPagedPoolAllocs,
03412     OUT PULONG NonPagedPoolFrees,
03413     OUT PULONG NonPagedPoolLookasideHits
03414     )
03415 
03416 {
03417     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
03418     <a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html">PNPAGED_LOOKASIDE_LIST</a> Lookaside;
03419     PLIST_ENTRY NextEntry;
03420     <a class="code" href="../../d4/d8/struct__POOL__DESCRIPTOR.html">PPOOL_DESCRIPTOR</a> <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a26">pd</a>;
03421 
03422     <span class="comment">//</span>
03423     <span class="comment">// Sum all the paged pool usage.</span>
03424     <span class="comment">//</span>
03425 
03426     <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a26">pd</a> = <a class="code" href="../../d2/d2/ex_2pool_8c.html#a54">PoolVector</a>[<a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>];
03427     *PagedPoolPages = 0;
03428     *PagedPoolAllocs = 0;
03429     *PagedPoolFrees = 0;
03430 
03431     <span class="keywordflow">for</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; <a class="code" href="../../d2/d2/ex_2pool_8c.html#a51">ExpNumberOfPagedPools</a> + 1; <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1) {
03432         *PagedPoolPages += <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a26">pd</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].TotalPages + <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a26">pd</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].TotalBigPages;
03433         *PagedPoolAllocs += <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a26">pd</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].RunningAllocs;
03434         *PagedPoolFrees += <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a26">pd</a>[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].RunningDeAllocs;
03435     }
03436 
03437     <span class="comment">//</span>
03438     <span class="comment">// Sum all the nonpaged pool usage.</span>
03439     <span class="comment">//</span>
03440 
03441     <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a26">pd</a> = <a class="code" href="../../d2/d2/ex_2pool_8c.html#a54">PoolVector</a>[<a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>];
03442     *NonPagedPoolPages = <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a26">pd</a>-&gt;TotalPages + <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a26">pd</a>-&gt;TotalBigPages;
03443     *NonPagedPoolAllocs = <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a26">pd</a>-&gt;RunningAllocs;
03444     *NonPagedPoolFrees = <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a26">pd</a>-&gt;RunningDeAllocs;
03445 
03446     <span class="comment">//</span>
03447     <span class="comment">// Sum all the nonpaged must succeed usage.</span>
03448     <span class="comment">//</span>
03449 
03450     <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a26">pd</a> = <a class="code" href="../../d2/d2/ex_2pool_8c.html#a54">PoolVector</a>[<a class="code" href="../../d5/d8/ex_8h.html#a329a175">NonPagedPoolMustSucceed</a>];
03451     *NonPagedPoolPages += <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a26">pd</a>-&gt;TotalPages + <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a26">pd</a>-&gt;TotalBigPages;
03452     *NonPagedPoolAllocs += <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a26">pd</a>-&gt;RunningAllocs;
03453     *NonPagedPoolFrees += <a class="code" href="../../d3/d8/aug98_2test_2main_8c.html#a26">pd</a>-&gt;RunningDeAllocs;
03454 
03455     <span class="comment">//</span>
03456     <span class="comment">// Sum all the lookaside hits for paged and nonpaged pool.</span>
03457     <span class="comment">//</span>
03458 
03459     NextEntry = <a class="code" href="../../d4/d0/exp_8h.html#a17">ExPoolLookasideListHead</a>.Flink;
03460     <span class="keywordflow">while</span> (NextEntry != &amp;<a class="code" href="../../d4/d0/exp_8h.html#a17">ExPoolLookasideListHead</a>) {
03461         Lookaside = CONTAINING_RECORD(NextEntry,
03462                                       <a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html">NPAGED_LOOKASIDE_LIST</a>,
03463                                       <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>.ListEntry);
03464 
03465         <span class="keywordflow">if</span> (Lookaside-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o9">Type</a> == <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>) {
03466             *NonPagedPoolLookasideHits += Lookaside-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o5">AllocateHits</a>;
03467 
03468         } <span class="keywordflow">else</span> {
03469             *PagedPoolLookasideHits += Lookaside-&gt;<a class="code" href="../../d1/d4/struct__NPAGED__LOOKASIDE__LIST.html#o0">L</a>.<a class="code" href="../../d6/d1/struct__GENERAL__LOOKASIDE.html#o5">AllocateHits</a>;
03470         }
03471 
03472         NextEntry = NextEntry-&gt;Flink;
03473     }
03474 
03475     <span class="keywordflow">return</span>;
03476 }
03477 
03478 
03479 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l03480"></a><a class="code" href="../../d5/d8/ex_8h.html#a230">03480</a> <a class="code" href="../../d5/d8/ex_8h.html#a230">ExReturnPoolQuota</a>(
03481     IN PVOID P
03482     )
03483 
03484 <span class="comment">/*++</span>
03485 <span class="comment"></span>
03486 <span class="comment">Routine Description:</span>
03487 <span class="comment"></span>
03488 <span class="comment">    This function returns quota charged to a subject process when the</span>
03489 <span class="comment">    specified pool block was allocated.</span>
03490 <span class="comment"></span>
03491 <span class="comment">Arguments:</span>
03492 <span class="comment"></span>
03493 <span class="comment">    P - Supplies the address of the block of pool being deallocated.</span>
03494 <span class="comment"></span>
03495 <span class="comment">Return Value:</span>
03496 <span class="comment"></span>
03497 <span class="comment">    None.</span>
03498 <span class="comment"></span>
03499 <span class="comment">--*/</span>
03500 
03501 {
03502 
03503     <a class="code" href="../../d5/d8/struct__POOL__HEADER.html">PPOOL_HEADER</a> Entry;
03504     <a class="code" href="../../d5/d8/ex_8h.html#a96">POOL_TYPE</a> PoolType;
03505     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process;
03506 <span class="preprocessor">#if defined(_ALPHA_) &amp;&amp; !defined(_AXP64_)</span>
03507 <span class="preprocessor"></span>    <a class="code" href="../../d4/d8/struct__POOL__DESCRIPTOR.html">PPOOL_DESCRIPTOR</a> PoolDesc;
03508     KIRQL LockHandle;
03509 <span class="preprocessor">#endif</span>
03510 <span class="preprocessor"></span>
03511     <span class="comment">//</span>
03512     <span class="comment">//  Do nothing for special pool. No quota was charged.</span>
03513     <span class="comment">//</span>
03514     
03515     <span class="keywordflow">if</span> ((P &gt;= <a class="code" href="../../d2/d1/mm_8h.html#a160">MmSpecialPoolStart</a>) &amp;&amp; (P &lt; <a class="code" href="../../d2/d1/mm_8h.html#a161">MmSpecialPoolEnd</a>)) {
03516         
03517         <span class="keywordflow">return</span>;
03518     }
03519 
03520     <span class="comment">//</span>
03521     <span class="comment">// Align the entry address to a pool allocation boundary.</span>
03522     <span class="comment">//</span>
03523 
03524 <span class="preprocessor">#if POOL_CACHE_SUPPORTED</span>
03525 <span class="preprocessor"></span>
03526     <span class="keywordflow">if</span> (((ULONG)P &amp; POOL_CACHE_CHECK) == 0) {
03527         Entry = (<a class="code" href="../../d5/d8/struct__POOL__HEADER.html">PPOOL_HEADER</a>)((ULONG)P - PoolCacheSize);
03528 
03529     } <span class="keywordflow">else</span> {
03530         Entry = (<a class="code" href="../../d5/d8/struct__POOL__HEADER.html">PPOOL_HEADER</a>)((PCHAR)P - <a class="code" href="../../d5/d2/poolhack_8c.html#a6">POOL_OVERHEAD</a>);
03531     }
03532 
03533 <span class="preprocessor">#else</span>
03534 <span class="preprocessor"></span>
03535     Entry = (<a class="code" href="../../d5/d8/struct__POOL__HEADER.html">PPOOL_HEADER</a>)((PCHAR)P - <a class="code" href="../../d5/d2/poolhack_8c.html#a6">POOL_OVERHEAD</a>);
03536 
03537 <span class="preprocessor">#endif //POOL_CACHE_SUPPORTED</span>
03538 <span class="preprocessor"></span>
03539     <span class="comment">//</span>
03540     <span class="comment">// If quota was charged, then return the appropriate quota to the</span>
03541     <span class="comment">// subject process.</span>
03542     <span class="comment">//</span>
03543 
03544     <span class="keywordflow">if</span> ((Entry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o1">PoolType</a> &amp; <a class="code" href="../../d4/d2/pool_8h.html#a11">POOL_QUOTA_MASK</a>) &amp;&amp; <a class="code" href="../../d2/d2/ex_2pool_8c.html#a0">POOL_QUOTA_ENABLED</a>) {
03545 
03546         PoolType = (Entry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o1">PoolType</a> &amp; <a class="code" href="../../d4/d2/pool_8h.html#a12">POOL_TYPE_MASK</a>) - 1;
03547 
03548 <span class="preprocessor">#if _POOL_LOCK_GRANULAR_</span>
03549 <span class="preprocessor"></span>        PoolDesc = <a class="code" href="../../d2/d2/ex_2pool_8c.html#a54">PoolVector</a>[PoolType];
03550         <span class="keywordflow">if</span> (PoolType == <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>) {
03551             PoolDesc = &amp;PoolDesc[<a class="code" href="../../d2/d2/ex_2pool_8c.html#a27">DECODE_POOL_INDEX</a>(Entry)];
03552         }
03553 <span class="preprocessor">#endif</span>
03554 <span class="preprocessor"></span>
03555         <a class="code" href="../../d2/d2/ex_2pool_8c.html#a6">LOCK_POOL_GRANULAR</a>(PoolDesc, LockHandle);
03556 
03557         Entry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o1">PoolType</a> &amp;= ~<a class="code" href="../../d4/d2/pool_8h.html#a11">POOL_QUOTA_MASK</a>;
03558 
03559         <a class="code" href="../../d2/d2/ex_2pool_8c.html#a7">UNLOCK_POOL_GRANULAR</a>(PoolDesc, LockHandle);
03560 
03561         Process = Entry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o2">ProcessBilled</a>;
03562 
03563 <span class="preprocessor">#if !defined (_WIN64)</span>
03564 <span class="preprocessor"></span>        Entry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o9">PoolTag</a> = 'atoQ';
03565 <span class="preprocessor">#endif</span>
03566 <span class="preprocessor"></span>
03567         <span class="keywordflow">if</span> (Process != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03568             <a class="code" href="../../d0/d2/psquota_8c.html#a3">PsReturnPoolQuota</a>(Process,
03569                               PoolType &amp; <a class="code" href="../../d4/d2/pool_8h.html#a5">BASE_POOL_TYPE_MASK</a>,
03570                               (ULONG)Entry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o6">BlockSize</a> &lt;&lt; <a class="code" href="../../d4/d2/pool_8h.html#a14">POOL_BLOCK_SHIFT</a>);
03571 
03572             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>(Process);
03573         }
03574 
03575     }
03576 
03577     <span class="keywordflow">return</span>;
03578 }
03579 
03580 <span class="preprocessor">#if DBG || (i386 &amp;&amp; !FPO)</span>
03581 <span class="preprocessor"></span>
03582 <span class="comment">//</span>
03583 <span class="comment">// Only works on checked builds or free x86 builds with FPO turned off</span>
03584 <span class="comment">// See comment in mm\allocpag.c</span>
03585 <span class="comment">//</span>
03586 
03587 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
03588 <a class="code" href="../../d2/d2/ex_2pool_8c.html#a64">ExpSnapShotPoolPages</a>(
03589     IN PVOID Address,
03590     IN ULONG Size,
03591     IN OUT PSYSTEM_POOL_INFORMATION PoolInformation,
03592     IN OUT PSYSTEM_POOL_ENTRY *PoolEntryInfo,
03593     IN ULONG Length,
03594     IN OUT PULONG RequiredLength
03595     )
03596 {
03597     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03598     CLONG i;
03599     <a class="code" href="../../d5/d8/struct__POOL__HEADER.html">PPOOL_HEADER</a> p;
03600     <a class="code" href="../../d1/d9/struct__POOL__TRACKER__BIG__PAGES.html">PPOOL_TRACKER_BIG_PAGES</a> PoolBig;
03601     LOGICAL ValidSplitBlock;
03602     ULONG EntrySize;
03603     KIRQL OldIrql;
03604 
03605     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d2/poolhack_8c.html#a5">PAGE_ALIGNED</a>(Address) &amp;&amp; <a class="code" href="../../d2/d2/ex_2pool_8c.html#a45">PoolBigPageTable</a>) {
03606 
03607         ExAcquireSpinLock(&amp;ExpTaggedPoolLock, &amp;OldIrql);
03608 
03609         PoolBig = <a class="code" href="../../d2/d2/ex_2pool_8c.html#a45">PoolBigPageTable</a>;
03610 
03611         <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="../../d2/d2/ex_2pool_8c.html#a46">PoolBigPageTableSize</a>; i += 1, PoolBig += 1) {
03612 
03613             <span class="keywordflow">if</span> (PoolBig-&gt;NumberOfPages == 0 || PoolBig-&gt;Va != Address) {
03614                 <span class="keywordflow">continue</span>;
03615             }
03616 
03617             PoolInformation-&gt;NumberOfEntries += 1;
03618             *RequiredLength += <span class="keyword">sizeof</span>(SYSTEM_POOL_ENTRY);
03619 
03620             <span class="keywordflow">if</span> (Length &lt; *RequiredLength) {
03621                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INFO_LENGTH_MISMATCH;
03622             }
03623             <span class="keywordflow">else</span> {
03624                 (*PoolEntryInfo)-&gt;Allocated = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03625                 (*PoolEntryInfo)-&gt;Size = PoolBig-&gt;NumberOfPages &lt;&lt; <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
03626                 (*PoolEntryInfo)-&gt;AllocatorBackTraceIndex = 0;
03627                 (*PoolEntryInfo)-&gt;ProcessChargedQuota = 0;
03628 <span class="preprocessor">#if !DBG</span>
03629 <span class="preprocessor"></span>                <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a33">NtGlobalFlag</a> &amp; FLG_POOL_ENABLE_TAGGING)
03630 <span class="preprocessor">#endif  </span>
03631 <span class="preprocessor">                (*PoolEntryInfo)-&gt;TagUlong = PoolBig-&gt;Key;</span>
03632 <span class="preprocessor"></span>                (*PoolEntryInfo) += 1;
03633                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
03634             }
03635 
03636             ExReleaseSpinLock(&amp;ExpTaggedPoolLock, OldIrql);
03637             <span class="keywordflow">return</span>  <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03638         }
03639         ExReleaseSpinLock(&amp;ExpTaggedPoolLock, OldIrql);
03640     }
03641 
03642     p = (<a class="code" href="../../d5/d8/struct__POOL__HEADER.html">PPOOL_HEADER</a>)Address;
03643     ValidSplitBlock = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03644 
03645     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> &amp;&amp; p-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o3">PreviousSize</a> == 0 &amp;&amp; p-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o6">BlockSize</a> != 0) {
03646         <a class="code" href="../../d5/d8/struct__POOL__HEADER.html">PPOOL_HEADER</a> PoolAddress;
03647         <a class="code" href="../../d5/d8/struct__POOL__HEADER.html">PPOOL_HEADER</a> EndPoolAddress;
03648 
03649         <span class="comment">//</span>
03650         <span class="comment">// Validate all the pool links before we regard this as a page that</span>
03651         <span class="comment">// has been split into small pool blocks.</span>
03652         <span class="comment">//</span>
03653 
03654         PoolAddress = p;
03655         EndPoolAddress = (<a class="code" href="../../d5/d8/struct__POOL__HEADER.html">PPOOL_HEADER</a>)((PCHAR) p + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
03656 
03657         <span class="keywordflow">do</span> {
03658             EntrySize = PoolAddress-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o6">BlockSize</a> &lt;&lt; <a class="code" href="../../d4/d2/pool_8h.html#a14">POOL_BLOCK_SHIFT</a>;
03659             PoolAddress = (<a class="code" href="../../d5/d8/struct__POOL__HEADER.html">PPOOL_HEADER</a>)((PCHAR)PoolAddress + EntrySize);
03660             <span class="keywordflow">if</span> (PoolAddress == EndPoolAddress) {
03661                 ValidSplitBlock = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03662                 <span class="keywordflow">break</span>;
03663             }
03664             <span class="keywordflow">if</span> (PoolAddress &gt; EndPoolAddress) {
03665                 <span class="keywordflow">break</span>;
03666             }
03667             <span class="keywordflow">if</span> (PoolAddress-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o3">PreviousSize</a> != EntrySize) {
03668                 <span class="keywordflow">break</span>;
03669             }
03670         } <span class="keywordflow">while</span> (EntrySize != 0);
03671     }
03672 
03673     <span class="keywordflow">if</span> (ValidSplitBlock == <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
03674 
03675         p = (<a class="code" href="../../d5/d8/struct__POOL__HEADER.html">PPOOL_HEADER</a>)Address;
03676 
03677         <span class="keywordflow">do</span> {
03678             EntrySize = p-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o6">BlockSize</a> &lt;&lt; <a class="code" href="../../d4/d2/pool_8h.html#a14">POOL_BLOCK_SHIFT</a>;
03679 
03680             <span class="keywordflow">if</span> (EntrySize == 0) {
03681                 <span class="keywordflow">return</span> STATUS_COMMITMENT_LIMIT;
03682             }
03683 
03684             PoolInformation-&gt;NumberOfEntries += 1;
03685             *RequiredLength += <span class="keyword">sizeof</span>(SYSTEM_POOL_ENTRY);
03686 
03687             <span class="keywordflow">if</span> (Length &lt; *RequiredLength) {
03688                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INFO_LENGTH_MISMATCH;
03689             }
03690             <span class="keywordflow">else</span> {
03691                 (*PoolEntryInfo)-&gt;Size = EntrySize;
03692                 <span class="keywordflow">if</span> (p-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o1">PoolType</a> != 0) {
03693                     (*PoolEntryInfo)-&gt;Allocated = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03694                     (*PoolEntryInfo)-&gt;AllocatorBackTraceIndex = 0;
03695                     (*PoolEntryInfo)-&gt;ProcessChargedQuota = 0;
03696 <span class="preprocessor">#if !DBG</span>
03697 <span class="preprocessor"></span>                    <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a33">NtGlobalFlag</a> &amp; FLG_POOL_ENABLE_TAGGING)
03698 <span class="preprocessor">#endif  </span>
03699 <span class="preprocessor">                    (*PoolEntryInfo)-&gt;TagUlong = p-&gt;PoolTag;</span>
03700 <span class="preprocessor"></span>                }
03701                 <span class="keywordflow">else</span> {
03702                     (*PoolEntryInfo)-&gt;Allocated = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03703                     (*PoolEntryInfo)-&gt;AllocatorBackTraceIndex = 0;
03704                     (*PoolEntryInfo)-&gt;ProcessChargedQuota = 0;
03705 
03706 <span class="preprocessor">#if !defined(DBG) &amp;&amp; !defined(_WIN64)</span>
03707 <span class="preprocessor"></span>                    <span class="keywordflow">if</span> (<a class="code" href="../../d9/d2/ldrp_8h.html#a33">NtGlobalFlag</a> &amp; FLG_POOL_ENABLE_TAGGING)
03708 <span class="preprocessor">#endif  </span>
03709 <span class="preprocessor">                    (*PoolEntryInfo)-&gt;TagUlong = p-&gt;PoolTag;</span>
03710 <span class="preprocessor"></span>                }
03711 
03712                 (*PoolEntryInfo) += 1;
03713                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
03714             }
03715 
03716             p = (<a class="code" href="../../d5/d8/struct__POOL__HEADER.html">PPOOL_HEADER</a>)((PCHAR)p + EntrySize);
03717         }
03718         <span class="keywordflow">while</span> (<a class="code" href="../../d4/d2/pool_8h.html#a17">PAGE_END</a>(p) == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
03719 
03720     }
03721     <span class="keywordflow">else</span> {
03722 
03723         PoolInformation-&gt;NumberOfEntries += 1;
03724         *RequiredLength += <span class="keyword">sizeof</span>(SYSTEM_POOL_ENTRY);
03725         <span class="keywordflow">if</span> (Length &lt; *RequiredLength) {
03726             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INFO_LENGTH_MISMATCH;
03727 
03728         } <span class="keywordflow">else</span> {
03729             (*PoolEntryInfo)-&gt;Allocated = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03730             (*PoolEntryInfo)-&gt;Size = <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a>;
03731             (*PoolEntryInfo)-&gt;AllocatorBackTraceIndex = 0;
03732             (*PoolEntryInfo)-&gt;ProcessChargedQuota = 0;
03733             (*PoolEntryInfo) += 1;
03734             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
03735         }
03736     }
03737 
03738     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03739 }
03740 
03741 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
03742 ExSnapShotPool(
03743     IN POOL_TYPE PoolType,
03744     IN PSYSTEM_POOL_INFORMATION PoolInformation,
03745     IN ULONG Length,
03746     OUT PULONG ReturnLength OPTIONAL
03747     )
03748 {
03749     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
03750     PVOID <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a>;
03751     KIRQL LockHandle;
03752     <a class="code" href="../../d4/d8/struct__POOL__DESCRIPTOR.html">PPOOL_DESCRIPTOR</a> PoolDesc;
03753     ULONG RequiredLength;
03754     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03755 
03756     RequiredLength = FIELD_OFFSET(SYSTEM_POOL_INFORMATION, Entries);
03757     <span class="keywordflow">if</span> (Length &lt; RequiredLength) {
03758         <span class="keywordflow">return</span> STATUS_INFO_LENGTH_MISMATCH;
03759     }
03760 
03761     <span class="keywordflow">try</span> {
03762 
03763         <span class="comment">//</span>
03764         <span class="comment">// If the pool type is paged, then lock all of the paged pools.</span>
03765         <span class="comment">// Otherwise, lock the nonpaged pool.</span>
03766         <span class="comment">//</span>
03767 
03768         PoolDesc = <a class="code" href="../../d2/d2/ex_2pool_8c.html#a54">PoolVector</a>[PoolType];
03769         <span class="keywordflow">if</span> (PoolType == <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>) {
03770             <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0;
03771             <a class="code" href="../../d9/d5/verifier_8c.html#a116">KeRaiseIrql</a>(APC_LEVEL, &amp;LockHandle);                                   \
03772             <span class="keywordflow">do</span> {
03773                 <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a> = PoolDesc[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d4/d8/struct__POOL__DESCRIPTOR.html#o3">LockAddress</a>;
03774                 ExAcquireFastMutex((<a class="code" href="../../d6/d9/struct__FAST__MUTEX.html">PFAST_MUTEX</a>)Lock);
03775                 <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1;
03776             } <span class="keywordflow">while</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; <a class="code" href="../../d2/d2/ex_2pool_8c.html#a51">ExpNumberOfPagedPools</a>);
03777 
03778         } <span class="keywordflow">else</span> {
03779             ExAcquireSpinLock(&amp;NonPagedPoolLock, &amp;LockHandle);
03780         }
03781 
03782         PoolInformation-&gt;EntryOverhead = <a class="code" href="../../d5/d2/poolhack_8c.html#a6">POOL_OVERHEAD</a>;
03783         PoolInformation-&gt;NumberOfEntries = 0;
03784 
03785 <span class="preprocessor">#if POOL_CACHE_SUPPORTED</span>
03786 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (PoolType &amp; <a class="code" href="../../d4/d2/pool_8h.html#a7">CACHE_ALIGNED_POOL_TYPE_MASK</a>) {
03787             PoolInformation-&gt;EntryOverhead = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)PoolCacheSize;
03788         }
03789 <span class="preprocessor">#endif //POOL_CACHE_SUPPORTED</span>
03790 <span class="preprocessor"></span>
03791         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = MmSnapShotPool(PoolType,
03792                                 ExpSnapShotPoolPages,
03793                                 PoolInformation,
03794                                 Length,
03795                                 &amp;RequiredLength);
03796 
03797     } finally {
03798 
03799         <span class="comment">//</span>
03800         <span class="comment">// If the pool type is paged, then unlock all of the paged pools.</span>
03801         <span class="comment">// Otherwise, unlock the nonpaged pool.</span>
03802         <span class="comment">//</span>
03803 
03804         <span class="keywordflow">if</span> (PoolType == <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>) {
03805             <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0;
03806             <span class="keywordflow">do</span> {
03807                 <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a> = PoolDesc[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].<a class="code" href="../../d4/d8/struct__POOL__DESCRIPTOR.html#o3">LockAddress</a>;
03808                 ExReleaseFastMutex((<a class="code" href="../../d6/d9/struct__FAST__MUTEX.html">PFAST_MUTEX</a>)Lock);
03809                 <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1;
03810             } <span class="keywordflow">while</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; <a class="code" href="../../d2/d2/ex_2pool_8c.html#a51">ExpNumberOfPagedPools</a>);
03811 
03812             <a class="code" href="../../d9/d5/verifier_8c.html#a117">KeLowerIrql</a>(LockHandle);
03813 
03814         } <span class="keywordflow">else</span> {
03815             ExReleaseSpinLock(&amp;NonPagedPoolLock, LockHandle);
03816         }
03817     }
03818 
03819     <span class="keywordflow">if</span> (ARGUMENT_PRESENT(ReturnLength)) {
03820         *ReturnLength = RequiredLength;
03821     }
03822 
03823     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
03824 }
03825 <span class="preprocessor">#endif // DBG || (i386 &amp;&amp; !FPO)</span>
03826 <span class="preprocessor"></span>
03827 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l03828"></a><a class="code" href="../../d5/d8/ex_8h.html#a217">03828</a> <a class="code" href="../../d5/d8/ex_8h.html#a217">ExAllocatePoolSanityChecks</a>(
03829     IN POOL_TYPE PoolType,
03830     IN SIZE_T NumberOfBytes
03831     )
03832 
03833 <span class="comment">/*++</span>
03834 <span class="comment"></span>
03835 <span class="comment">Routine Description:</span>
03836 <span class="comment"></span>
03837 <span class="comment">    This function performs sanity checks on the caller.</span>
03838 <span class="comment"></span>
03839 <span class="comment">Return Value:</span>
03840 <span class="comment"></span>
03841 <span class="comment">    None.</span>
03842 <span class="comment"></span>
03843 <span class="comment">Environment:</span>
03844 <span class="comment"></span>
03845 <span class="comment">    Only enabled as part of the driver verification package.</span>
03846 <span class="comment"></span>
03847 <span class="comment">--*/</span>
03848 
03849 {
03850     <span class="keywordflow">if</span> (NumberOfBytes == 0) {
03851         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (DRIVER_VERIFIER_DETECTED_VIOLATION,
03852                       0x0,
03853                       KeGetCurrentIrql(),
03854                       PoolType,
03855                       NumberOfBytes);
03856     }
03857 
03858     <span class="keywordflow">if</span> ((PoolType &amp; <a class="code" href="../../d4/d2/pool_8h.html#a5">BASE_POOL_TYPE_MASK</a>) == <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>) {
03859 
03860         <span class="keywordflow">if</span> (KeGetCurrentIrql() &gt; <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>) {
03861 
03862             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (DRIVER_VERIFIER_DETECTED_VIOLATION,
03863                           0x1,
03864                           KeGetCurrentIrql(),
03865                           PoolType,
03866                           NumberOfBytes);
03867         }
03868     }
03869     <span class="keywordflow">else</span> {
03870         <span class="keywordflow">if</span> (KeGetCurrentIrql() &gt; <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>) {
03871 
03872             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (DRIVER_VERIFIER_DETECTED_VIOLATION,
03873                           0x2,
03874                           KeGetCurrentIrql(),
03875                           PoolType,
03876                           NumberOfBytes);
03877         }
03878     }
03879 
03880     <span class="keywordflow">if</span> (PoolType &amp; <a class="code" href="../../d4/d2/pool_8h.html#a6">MUST_SUCCEED_POOL_TYPE_MASK</a>) {
03881         <span class="keywordflow">if</span> (NumberOfBytes &gt; <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>) {
03882             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (DRIVER_VERIFIER_DETECTED_VIOLATION,
03883                           0x3,
03884                           KeGetCurrentIrql(),
03885                           PoolType,
03886                           NumberOfBytes);
03887         }
03888     }
03889 }
03890 
03891 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l03892"></a><a class="code" href="../../d5/d8/ex_8h.html#a218">03892</a> <a class="code" href="../../d5/d8/ex_8h.html#a218">ExFreePoolSanityChecks</a>(
03893     IN PVOID P
03894     )
03895 
03896 <span class="comment">/*++</span>
03897 <span class="comment"></span>
03898 <span class="comment">Routine Description:</span>
03899 <span class="comment"></span>
03900 <span class="comment">    This function performs sanity checks on the caller.</span>
03901 <span class="comment"></span>
03902 <span class="comment">Return Value:</span>
03903 <span class="comment"></span>
03904 <span class="comment">    None.</span>
03905 <span class="comment"></span>
03906 <span class="comment">Environment:</span>
03907 <span class="comment"></span>
03908 <span class="comment">    Only enabled as part of the driver verification package.</span>
03909 <span class="comment"></span>
03910 <span class="comment">--*/</span>
03911 
03912 {
03913     <a class="code" href="../../d5/d8/struct__POOL__HEADER.html">PPOOL_HEADER</a> Entry;
03914     <a class="code" href="../../d5/d8/ex_8h.html#a96">POOL_TYPE</a> PoolType;
03915     PVOID StillQueued;
03916 
03917     <span class="keywordflow">if</span> (P &lt;= (PVOID)(MM_HIGHEST_USER_ADDRESS)) {
03918         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (DRIVER_VERIFIER_DETECTED_VIOLATION,
03919                       0x10,
03920                       (ULONG_PTR)P,
03921                       0,
03922                       0);
03923     }
03924 
03925     <span class="keywordflow">if</span> ((P &gt;= <a class="code" href="../../d2/d1/mm_8h.html#a160">MmSpecialPoolStart</a>) &amp;&amp; (P &lt; <a class="code" href="../../d2/d1/mm_8h.html#a161">MmSpecialPoolEnd</a>)) {
03926         StillQueued = <a class="code" href="../../d3/d2/timerobj_8c.html#a9">KeCheckForTimer</a>(P, <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - <a class="code" href="../../d2/d1/mm_8h.html#a6">BYTE_OFFSET</a> (P));
03927         <span class="keywordflow">if</span> (StillQueued != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03928             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (DRIVER_VERIFIER_DETECTED_VIOLATION,
03929                           0x15,
03930                           (ULONG_PTR)StillQueued,
03931                           (ULONG_PTR)-1,
03932                           (ULONG_PTR)P);
03933         }
03934 
03935         <span class="comment">//</span>
03936         <span class="comment">// Check if an ERESOURCE is currently active in this memory block.</span>
03937         <span class="comment">//</span>
03938 
03939         StillQueued = <a class="code" href="../../d8/d8/ex_2resource_8c.html#a34">ExpCheckForResource</a>(P, <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - <a class="code" href="../../d2/d1/mm_8h.html#a6">BYTE_OFFSET</a> (P));
03940         <span class="keywordflow">if</span> (StillQueued != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03941             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (DRIVER_VERIFIER_DETECTED_VIOLATION,
03942                           0x17,
03943                           (ULONG_PTR)StillQueued,
03944                           (ULONG_PTR)-1,
03945                           (ULONG_PTR)P);
03946         }
03947 
03948         <a class="code" href="../../d1/d9/worker_8c.html#a27">ExpCheckForWorker</a> (P, <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - <a class="code" href="../../d2/d1/mm_8h.html#a6">BYTE_OFFSET</a> (P)); <span class="comment">// bugchecks inside</span>
03949         <span class="keywordflow">return</span>;
03950     }
03951 
03952     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d2/poolhack_8c.html#a5">PAGE_ALIGNED</a>(P)) {
03953         PoolType = <a class="code" href="../../d1/d6/allocpag_8c.html#a48">MmDeterminePoolType</a>(P);
03954 
03955         <span class="keywordflow">if</span> ((PoolType &amp; <a class="code" href="../../d4/d2/pool_8h.html#a5">BASE_POOL_TYPE_MASK</a>) == <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>) {
03956             <span class="keywordflow">if</span> (KeGetCurrentIrql() &gt; <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>) {
03957                 <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (DRIVER_VERIFIER_DETECTED_VIOLATION,
03958                               0x11,
03959                               KeGetCurrentIrql(),
03960                               PoolType,
03961                               (ULONG_PTR)P);
03962             }
03963         }
03964         <span class="keywordflow">else</span> {
03965             <span class="keywordflow">if</span> (KeGetCurrentIrql() &gt; <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>) {
03966                 <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (DRIVER_VERIFIER_DETECTED_VIOLATION,
03967                               0x12,
03968                               KeGetCurrentIrql(),
03969                               PoolType,
03970                               (ULONG_PTR)P);
03971             }
03972         }
03973 
03974         <span class="comment">//</span>
03975         <span class="comment">// Just check the first page.</span>
03976         <span class="comment">//</span>
03977 
03978         StillQueued = <a class="code" href="../../d3/d2/timerobj_8c.html#a9">KeCheckForTimer</a>(P, <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
03979         <span class="keywordflow">if</span> (StillQueued != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03980             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (DRIVER_VERIFIER_DETECTED_VIOLATION,
03981                           0x15,
03982                           (ULONG_PTR)StillQueued,
03983                           PoolType,
03984                           (ULONG_PTR)P);
03985         }
03986 
03987         <span class="comment">//</span>
03988         <span class="comment">// Check if an ERESOURCE is currently active in this memory block.</span>
03989         <span class="comment">//</span>
03990 
03991         StillQueued = <a class="code" href="../../d8/d8/ex_2resource_8c.html#a34">ExpCheckForResource</a>(P, <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>);
03992 
03993         <span class="keywordflow">if</span> (StillQueued != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03994             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (DRIVER_VERIFIER_DETECTED_VIOLATION,
03995                           0x17,
03996                           (ULONG_PTR)StillQueued,
03997                           PoolType,
03998                           (ULONG_PTR)P);
03999         }
04000     }
04001     <span class="keywordflow">else</span> {
04002 
04003 <span class="preprocessor">#if !defined (_WIN64)</span>
04004 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (((ULONG_PTR)P &amp; 0x17) != 0) {
04005             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (DRIVER_VERIFIER_DETECTED_VIOLATION,
04006                           0x16,
04007                           __LINE__,
04008                           (ULONG_PTR)P,
04009                           0);
04010         }
04011 <span class="preprocessor">#endif</span>
04012 <span class="preprocessor"></span>
04013         Entry = (<a class="code" href="../../d5/d8/struct__POOL__HEADER.html">PPOOL_HEADER</a>)((PCHAR)P - <a class="code" href="../../d5/d2/poolhack_8c.html#a6">POOL_OVERHEAD</a>);
04014 
04015         <span class="keywordflow">if</span> ((Entry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o1">PoolType</a> &amp; <a class="code" href="../../d4/d2/pool_8h.html#a12">POOL_TYPE_MASK</a>) == 0) {
04016             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (DRIVER_VERIFIER_DETECTED_VIOLATION,
04017                           0x13,
04018                           __LINE__,
04019                           (ULONG_PTR)Entry,
04020                           Entry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o7">Ulong1</a>);
04021         }
04022 
04023         PoolType = (Entry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o1">PoolType</a> &amp; <a class="code" href="../../d4/d2/pool_8h.html#a12">POOL_TYPE_MASK</a>) - 1;
04024 
04025         <span class="keywordflow">if</span> ((PoolType &amp; <a class="code" href="../../d4/d2/pool_8h.html#a5">BASE_POOL_TYPE_MASK</a>) == <a class="code" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>) {
04026             <span class="keywordflow">if</span> (KeGetCurrentIrql() &gt; <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>) {
04027                 <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (DRIVER_VERIFIER_DETECTED_VIOLATION,
04028                               0x11,
04029                               KeGetCurrentIrql(),
04030                               PoolType,
04031                               (ULONG_PTR)P);
04032             }
04033         }
04034         <span class="keywordflow">else</span> {
04035             <span class="keywordflow">if</span> (KeGetCurrentIrql() &gt; <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>) {
04036                 <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (DRIVER_VERIFIER_DETECTED_VIOLATION,
04037                               0x12,
04038                               KeGetCurrentIrql(),
04039                               PoolType,
04040                               (ULONG_PTR)P);
04041             }
04042         }
04043 
04044         <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d2/ex_2pool_8c.html#a30">IS_POOL_HEADER_MARKED_ALLOCATED</a>(Entry)) {
04045             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (DRIVER_VERIFIER_DETECTED_VIOLATION,
04046                           0x14,
04047                           __LINE__,
04048                           (ULONG_PTR)Entry,
04049                           0);
04050         }
04051         StillQueued = <a class="code" href="../../d3/d2/timerobj_8c.html#a9">KeCheckForTimer</a>(Entry, (ULONG)(Entry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o6">BlockSize</a> &lt;&lt; <a class="code" href="../../d4/d2/pool_8h.html#a14">POOL_BLOCK_SHIFT</a>));
04052         <span class="keywordflow">if</span> (StillQueued != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04053             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (DRIVER_VERIFIER_DETECTED_VIOLATION,
04054                           0x15,
04055                           (ULONG_PTR)StillQueued,
04056                           PoolType,
04057                           (ULONG_PTR)P);
04058         }
04059 
04060         <span class="comment">//</span>
04061         <span class="comment">// Check if an ERESOURCE is currently active in this memory block.</span>
04062         <span class="comment">//</span>
04063 
04064         StillQueued = <a class="code" href="../../d8/d8/ex_2resource_8c.html#a34">ExpCheckForResource</a>(Entry, (ULONG)(Entry-&gt;<a class="code" href="../../d5/d8/struct__POOL__HEADER.html#o6">BlockSize</a> &lt;&lt; <a class="code" href="../../d4/d2/pool_8h.html#a14">POOL_BLOCK_SHIFT</a>));
04065 
04066         <span class="keywordflow">if</span> (StillQueued != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
04067             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a> (DRIVER_VERIFIER_DETECTED_VIOLATION,
04068                           0x17,
04069                           (ULONG_PTR)StillQueued,
04070                           PoolType,
04071                           (ULONG_PTR)P);
04072         }
04073     }
04074 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:41:24 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
