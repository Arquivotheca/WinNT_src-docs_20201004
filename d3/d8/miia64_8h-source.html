<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: miia64.h Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>miia64.h</h1><a href="../../d2/d9/miia64_8h.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1990  Microsoft Corporation</span>
00004 <span class="comment">Copyright (c) 1995  Intel Corporation</span>
00005 <span class="comment"></span>
00006 <span class="comment">Module Name:</span>
00007 <span class="comment"></span>
00008 <span class="comment">    miia64.h</span>
00009 <span class="comment"></span>
00010 <span class="comment">Abstract:</span>
00011 <span class="comment"></span>
00012 <span class="comment">    This module contains the private data structures and procedure</span>
00013 <span class="comment">    prototypes for the hardware dependent portion of the</span>
00014 <span class="comment">    memory management system.</span>
00015 <span class="comment"></span>
00016 <span class="comment">    This module is specifically tailored for the Intel MERCED,</span>
00017 <span class="comment"></span>
00018 <span class="comment">Author:</span>
00019 <span class="comment"></span>
00020 <span class="comment">    Lou Perazzoli (loup) 6-Jan-1990</span>
00021 <span class="comment"></span>
00022 <span class="comment">Revision History:</span>
00023 <span class="comment"></span>
00024 <span class="comment">--*/</span>
00025 
00026 <span class="comment">/*++</span>
00027 <span class="comment"></span>
00028 <span class="comment">    Virtual Memory Layout on MERCED is:</span>
00029 <span class="comment"></span>
00030 <span class="comment">/*++</span>
00031 <span class="comment"></span>
00032 <span class="comment">    Virtual Memory Layout for the initial Merced port is:</span>
00033 <span class="comment"></span>
00034 <span class="comment">                 +------------------------------------+</span>
00035 <span class="comment">0000000000000000 | User mode addresses - 8tb minus 8gb| UADDRESS_BASE</span>
00036 <span class="comment">                 |                                    |</span>
00037 <span class="comment">                 |                                    |</span>
00038 <span class="comment">000003FFFFFEFFFF |                                    | MM_HIGHEST_USER_ADDRESS</span>
00039 <span class="comment">                 +------------------------------------+</span>
00040 <span class="comment">000003FFFFFF0000 | 64k No Access Region               | MM_USER_PROBE_ADDRESS</span>
00041 <span class="comment">                 +------------------------------------+</span>
00042 <span class="comment">0000040000000000 | HyperSpace - working set lists     | HYPER_SPACE</span>
00043 <span class="comment">                 |  and per process memory management |</span>
00044 <span class="comment">                 |  structures mapped in this 8gb     |</span>
00045 <span class="comment">00000401FFFFFFFF |  region.                           | HYPER_SPACE_END</span>
00046 <span class="comment">                 +------------------------------------+</span>
00047 <span class="comment">0000040200000000 | Remaining per process addresses for|</span>
00048 <span class="comment">                 | eventual 43-bit address space.     |</span>
00049 <span class="comment">                 |                                    |</span>
00050 <span class="comment">                 |                                    |</span>
00051 <span class="comment">000007FFFFFFFFFF |                                    |</span>
00052 <span class="comment">                 +------------------------------------+</span>
00053 <span class="comment">                                   .</span>
00054 <span class="comment">                                   .</span>
00055 <span class="comment">                 +------------------------------------+</span>
00056 <span class="comment">1FFFFF0000000000 | 8gb leaf level page table map      | PTE_UBASE</span>
00057 <span class="comment">                 |        for user space              |</span>
00058 <span class="comment">1FFFFF01FFFFFFFF |                                    | PTE_UTOP</span>
00059 <span class="comment">                 +------------------------------------+</span>
00060 <span class="comment">                 +------------------------------------+</span>
00061 <span class="comment">1FFFFFFFC0000000 | 8mb page directory (2nd level)     | PDE_UBASE</span>
00062 <span class="comment">                 | table map for user space           |</span>
00063 <span class="comment">1FFFFFFFC07FFFFF |                                    | PDE_UTOP</span>
00064 <span class="comment">                 +------------------------------------+</span>
00065 <span class="comment">                 +------------------------------------+</span>
00066 <span class="comment">1FFFFFFFFFF00000 | 8KB parent directory (1st level)   | PDE_UTBASE</span>
00067 <span class="comment">                 +------------------------------------+</span>
00068 <span class="comment">                                   .</span>
00069 <span class="comment">                                   .</span>
00070 <span class="comment">                 +------------------------------------+</span>
00071 <span class="comment">2000000000000000 |  Hydra - 8gb                       | MM_SESSION_SPACE_DEFAULT</span>
00072 <span class="comment">                 |  and per process memory management |</span>
00073 <span class="comment">                 |  structures mapped in this 8gb     |</span>
00074 <span class="comment">                 |  region.                           |</span>
00075 <span class="comment">                 +------------------------------------+</span>
00076 <span class="comment">                                   .</span>
00077 <span class="comment">                 +------------------------------------+</span>
00078 <span class="comment">3FFFFF0000000000 | 8gb leaf level page table map      | PTE_SBASE</span>
00079 <span class="comment">                 |        for session space           |</span>
00080 <span class="comment">3FFFFF01FFFFFFFF |                                    | PTE_STOP</span>
00081 <span class="comment">                 +------------------------------------+</span>
00082 <span class="comment">                 +------------------------------------+</span>
00083 <span class="comment">3FFFFFFFC0000000 | 8mb page directory (2nd level)     | PDE_SBASE</span>
00084 <span class="comment">                 | table map for session space        |</span>
00085 <span class="comment">3FFFFFFFC07FFFFF |                                    | PDE_STOP</span>
00086 <span class="comment">                 +------------------------------------+</span>
00087 <span class="comment">                 +------------------------------------+</span>
00088 <span class="comment">3FFFFFFFFFF00000 | 8KB parent directory (1st level)   | PDE_STBASE</span>
00089 <span class="comment">                 +------------------------------------+</span>
00090 <span class="comment">                                   .</span>
00091 <span class="comment">                 +------------------------------------+ </span>
00092 <span class="comment">8000000000000000 |   physical addressable memory      | KSEG3_BASE</span>
00093 <span class="comment">                 |   for 44-bit of address space      | </span>
00094 <span class="comment">80000FFFFFFFFFFF |   mapped by VHPT 64KB page         | KSEG3_LIMIT</span>
00095 <span class="comment">                 +------------------------------------+</span>
00096 <span class="comment">                                   .</span>
00097 <span class="comment">                 +------------------------------------+</span>
00098 <span class="comment">9FFFFF00000000000| vhpt 64kb page for KSEG3 space     |</span>
00099 <span class="comment">                 |            (not used)              |</span>
00100 <span class="comment">                 +------------------------------------+</span>
00101 <span class="comment">                                   .</span>
00102 <span class="comment">                                   .</span>
00103 <span class="comment">                 +------------------------------------+ MM_SYSTEM_RANGE_START</span>
00104 <span class="comment">E000000000000000 |                                    | KADDRESS_BASE</span>
00105 <span class="comment">                 +------------------------------------+</span>
00106 <span class="comment">E000000080000000 | The HAL, kernel, initial drivers,  | KSEG0_BASE</span>
00107 <span class="comment">                 | NLS data, and registry load in the |</span>
00108 <span class="comment">                 | first 16mb of this region which    |</span>
00109 <span class="comment">                 | physically addresses memory.       |</span>
00110 <span class="comment">                 |                                    |</span>
00111 <span class="comment">                 | Kernel mode access only.           |</span>
00112 <span class="comment">                 |                                    |</span>
00113 <span class="comment">                 | Initial NonPaged Pool is within    |</span>
00114 <span class="comment">                 | KSEG0                              |</span>
00115 <span class="comment">                 |                                    | KSEG2_BASE</span>
00116 <span class="comment">                 +------------------------------------+</span>
00117 <span class="comment">E0000000A0000000 | System mapped views                | MM_SYSTEM_VIEW_START</span>
00118 <span class="comment">                 |   Win32k.sys                       |     MM_SYSTEM_CACHE_END</span>
00119 <span class="comment">                 |                                    |</span>
00120 <span class="comment">                 +------------------------------------+</span>
00121 <span class="comment">E0000000FF000000 | Shared system page                 | KI_USER_SHARED_DATA</span>
00122 <span class="comment">                 +------------------------------------+</span>
00123 <span class="comment">E0000000FF002000 |   Reserved for the HAL.            |</span>
00124 <span class="comment">                 |                                    |</span>
00125 <span class="comment">                 |                                    |</span>
00126 <span class="comment">E0000000FFFFFFFF |                                    | </span>
00127 <span class="comment">                 +------------------------------------+</span>
00128 <span class="comment">                                   .</span>
00129 <span class="comment">                                   .</span>
00130 <span class="comment">                 +------------------------------------+</span>
00131 <span class="comment">E000000200000000 |                                    |</span>
00132 <span class="comment">                 |                                    |</span>
00133 <span class="comment">                 |                                    |</span>
00134 <span class="comment">                 |                                    |</span>
00135 <span class="comment">                 +------------------------------------+</span>
00136 <span class="comment">E000000400000000 |   The system cache working set     | MM_SYSTEM_CACHE_WORKING_SET</span>
00137 <span class="comment">                 |                                    | MM_SYSTEM_SPACE_START</span>
00138 <span class="comment">                 |   information resides in this 8gb  |</span>
00139 <span class="comment">                 |   region.                          |</span>
00140 <span class="comment">                 +------------------------------------+</span>
00141 <span class="comment">E000000600000000 | System cache resides here.         | MM_SYSTEM_CACHE_START</span>
00142 <span class="comment">                 |  Kernel mode access only.          |</span>
00143 <span class="comment">                 |  1tb.                              |</span>
00144 <span class="comment">                 +------------------------------------+</span>
00145 <span class="comment">E000010600000000 | Start of paged system area.        | MM_PAGED_POOL_START</span>
00146 <span class="comment">                 |  Kernel mode access only.          |</span>
00147 <span class="comment">                 |  128gb.                            |</span>
00148 <span class="comment">                 +------------------------------------+</span>
00149 <span class="comment">                 |                                    |</span>
00150 <span class="comment">                                   .</span>
00151 <span class="comment">                                   .</span>
00152 <span class="comment"></span>
00153 <span class="comment">In general, the next two areas (system PTE pool and nonpaged pool) will both</span>
00154 <span class="comment">be shifted upwards to conserve a PPE...</span>
00155 <span class="comment"></span>
00156 <span class="comment">                                   .</span>
00157 <span class="comment">                                   .</span>
00158 <span class="comment">                 +------------------------------------+</span>
00159 <span class="comment">E000012600000000 | System PTE pool.                   | MM_LOWEST_NONPAGED_SYSTEM_START</span>
00160 <span class="comment">                 |  Kernel mode access only.          |</span>
00161 <span class="comment">                 |  128gb.                            |</span>
00162 <span class="comment">                 +------------------------------------+</span>
00163 <span class="comment">E000014600000000 | NonPaged pool.                     | MM_NON_PAGED_POOL_START</span>
00164 <span class="comment">                 |  Kernel mode access only.          |</span>
00165 <span class="comment">                 |  128gb.                            |</span>
00166 <span class="comment">                 |                                    |</span>
00167 <span class="comment">E0000165FFFFFFFF |  NonPaged System area              | MM_NONPAGED_POOL_END</span>
00168 <span class="comment">                 +------------------------------------+ </span>
00169 <span class="comment">                                   .</span>
00170 <span class="comment">                                   .</span>
00171 <span class="comment">E000040000000000 +------------------------------------+ MM_PFN_DATABASE_START</span>
00172 <span class="comment">                 | PFN Database space                 |</span>
00173 <span class="comment">                 |  Kernel mode access only.          |</span>
00174 <span class="comment">                 |  2tb.                              |</span>
00175 <span class="comment">E000060000000000 +------------------------------------+ MM_PFN_DATABASE_END</span>
00176 <span class="comment">                                   .                    MM_SYSTEM_SPACE_END</span>
00177 <span class="comment">                                   .</span>
00178 <span class="comment">                                   .</span>
00179 <span class="comment">                 +------------------------------------+</span>
00180 <span class="comment">FFFFFF0000000000 | 8gb leaf level page table map      | PTE_KBASE</span>
00181 <span class="comment">                 |       for kernel space             |</span>
00182 <span class="comment">FFFFFF01FFFFFFFF |                                    | PTE_KTOP</span>
00183 <span class="comment">                 +------------------------------------+</span>
00184 <span class="comment">                 +------------------------------------+</span>
00185 <span class="comment">FFFFFFFFC0000000 | 8mb page directory (2nd level)     | PDE_KBASE</span>
00186 <span class="comment">                 | table map for kernel space         |</span>
00187 <span class="comment">FFFFFFFFC07FFFFF |                                    | PDE_KTOP</span>
00188 <span class="comment">                 +------------------------------------+</span>
00189 <span class="comment">                 +------------------------------------+</span>
00190 <span class="comment">FFFFFFFFFFF00000 | 8KB parent directory (1st level)   | PDE_KTBASE</span>
00191 <span class="comment">                 +------------------------------------+</span>
00192 <span class="comment"></span>
00193 <span class="comment">--*/</span>
00194 
<a name="l00195"></a><a class="code" href="../../d2/d9/miia64_8h.html#a0">00195</a> <span class="preprocessor">#define _MM64_ 1</span>
00196 <span class="preprocessor"></span>
<a name="l00197"></a><a class="code" href="../../d2/d9/miia64_8h.html#a1">00197</a> <span class="preprocessor">#define _MIALT4K_ 1</span>
00198 <span class="preprocessor"></span><span class="comment">// #define HYPERMAP 1</span>
00199 
00200 <span class="comment">//</span>
00201 <span class="comment">// Define empty list markers.</span>
00202 <span class="comment">//</span>
00203 
<a name="l00204"></a><a class="code" href="../../d2/d9/miia64_8h.html#a2">00204</a> <span class="preprocessor">#define MM_EMPTY_LIST ((ULONG)0xFFFFFFFF) //</span>
<a name="l00205"></a><a class="code" href="../../d2/d9/miia64_8h.html#a3">00205</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_EMPTY_PTE_LIST ((ULONG)0xFFFFFFFF) // N.B. tied to MMPTE definition</span>
00206 <span class="preprocessor"></span>
<a name="l00207"></a><a class="code" href="../../d2/d9/miia64_8h.html#a4">00207</a> <span class="preprocessor">#define MI_PTE_BASE_FOR_LOWEST_KERNEL_ADDRESS ((PMMPTE)PTE_KBASE)</span>
00208 <span class="preprocessor"></span>
00209 <span class="comment">//</span>
00210 <span class="comment">// 43-Bit virtual address mask.</span>
00211 <span class="comment">//</span>
00212 
<a name="l00213"></a><a class="code" href="../../d2/d9/miia64_8h.html#a5">00213</a> <span class="preprocessor">#define MASK_43 0x7FFFFFFFFFFUI64       //</span>
00214 <span class="preprocessor"></span>
00215 <span class="comment">//</span>
00216 <span class="comment">// 44-Bit Physical address mask.</span>
00217 <span class="comment">//</span>
00218 
<a name="l00219"></a><a class="code" href="../../d2/d9/miia64_8h.html#a6">00219</a> <span class="preprocessor">#define MASK_44 0xFFFFFFFFFFFUI64       </span>
00220 <span class="preprocessor"></span>
<a name="l00221"></a><a class="code" href="../../d2/d9/miia64_8h.html#a7">00221</a> <span class="preprocessor">#define MM_PAGES_IN_KSEG0 ((ULONG)((KSEG2_BASE - KSEG0_BASE) &gt;&gt; PAGE_SHIFT))</span>
00222 <span class="preprocessor"></span>
<a name="l00223"></a><a class="code" href="../../d2/d9/miia64_8h.html#a271">00223</a> <span class="keyword">extern</span> ULONG_PTR <a class="code" href="../../d2/d2/data386_8c.html#a19">MmKseg2Frame</a>;
<a name="l00224"></a><a class="code" href="../../d2/d9/miia64_8h.html#a272">00224</a> <span class="keyword">extern</span> ULONGLONG <a class="code" href="../../d3/d2/dataia64_8c.html#a27">MmPageSizeInfo</a>;
00225 
<a name="l00226"></a><a class="code" href="../../d2/d9/miia64_8h.html#a8">00226</a> <span class="preprocessor">#define MM_USER_ADDRESS_RANGE_LIMIT (0xFFFFFFFFFFFFFFFFUI64) // user address range limit</span>
<a name="l00227"></a><a class="code" href="../../d2/d9/miia64_8h.html#a9">00227</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_MAXIMUM_ZERO_BITS 53         // maximum number of zero bits</span>
00228 <span class="preprocessor"></span>
00229 <span class="comment">//</span>
00230 <span class="comment">// PAGE_SIZE for Intel MERCED is 8k, virtual page is 20 bits with a PAGE_SHIFT</span>
00231 <span class="comment">// byte offset.</span>
00232 <span class="comment">//</span>
00233 
<a name="l00234"></a><a class="code" href="../../d2/d9/miia64_8h.html#a10">00234</a> <span class="preprocessor">#define MM_VIRTUAL_PAGE_FILLER (PAGE_SHIFT - 12)</span>
<a name="l00235"></a><a class="code" href="../../d2/d9/miia64_8h.html#a11">00235</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_VIRTUAL_PAGE_SIZE (64-PAGE_SHIFT)</span>
00236 <span class="preprocessor"></span>
00237 <span class="comment">//</span>
00238 <span class="comment">// Address space layout definitions.</span>
00239 <span class="comment">//</span>
00240 
<a name="l00241"></a><a class="code" href="../../d2/d9/miia64_8h.html#a12">00241</a> <span class="preprocessor">#define CODE_START KSEG0_BASE</span>
00242 <span class="preprocessor"></span>
<a name="l00243"></a><a class="code" href="../../d2/d9/miia64_8h.html#a13">00243</a> <span class="preprocessor">#define CODE_END   KSEG2_BASE</span>
00244 <span class="preprocessor"></span>
<a name="l00245"></a><a class="code" href="../../d2/d9/miia64_8h.html#a14">00245</a> <span class="preprocessor">#define MM_SYSTEM_SPACE_START (KADDRESS_BASE + 0x400000000UI64)</span>
00246 <span class="preprocessor"></span>
<a name="l00247"></a><a class="code" href="../../d2/d9/miia64_8h.html#a15">00247</a> <span class="preprocessor">#define MM_SYSTEM_SPACE_END (KADDRESS_BASE + 0x60000000000UI64)</span>
00248 <span class="preprocessor"></span>
<a name="l00249"></a><a class="code" href="../../d2/d9/miia64_8h.html#a16">00249</a> <span class="preprocessor">#define PDE_TOP PDE_UTOP</span>
00250 <span class="preprocessor"></span>
00251 <span class="comment">//</span>
00252 <span class="comment">// Define Althernate 4KB permission table space for X86</span>
00253 <span class="comment">//</span>
00254 
<a name="l00255"></a><a class="code" href="../../d2/d9/miia64_8h.html#a17">00255</a> <span class="preprocessor">#define ALT4KB_PERMISSION_TABLE_START (UADDRESS_BASE + 0x40000000000)</span>
00256 <span class="preprocessor"></span>
<a name="l00257"></a><a class="code" href="../../d2/d9/miia64_8h.html#a18">00257</a> <span class="preprocessor">#define ALT4KB_PERMISSION_TABLE_END   (UADDRESS_BASE + 0x40000400000)</span>
00258 <span class="preprocessor"></span>
00259 <span class="comment">//</span>
00260 <span class="comment">// Define hyper space </span>
00261 <span class="comment">//</span>
00262 
<a name="l00263"></a><a class="code" href="../../d2/d9/miia64_8h.html#a19">00263</a> <span class="preprocessor">#define HYPER_SPACE ((PVOID)(UADDRESS_BASE + 0x40000800000))</span>
00264 <span class="preprocessor"></span>
<a name="l00265"></a><a class="code" href="../../d2/d9/miia64_8h.html#a20">00265</a> <span class="preprocessor">#define HYPER_SPACE_END (UADDRESS_BASE + 0x401FFFFFFFF)</span>
00266 <span class="preprocessor"></span>
00267 <span class="comment">//</span>
00268 <span class="comment">// Define area for mapping views into system space</span>
00269 <span class="comment">//</span>
00270 
<a name="l00271"></a><a class="code" href="../../d2/d9/miia64_8h.html#a21">00271</a> <span class="preprocessor">#define MM_SYSTEM_VIEW_START (KADDRESS_BASE + 0xA0000000)</span>
00272 <span class="preprocessor"></span>
<a name="l00273"></a><a class="code" href="../../d2/d9/miia64_8h.html#a22">00273</a> <span class="preprocessor">#define MM_SYSTEM_VIEW_SIZE (48*1024*1024)</span>
00274 <span class="preprocessor"></span>
<a name="l00275"></a><a class="code" href="../../d2/d9/miia64_8h.html#a23">00275</a> <span class="preprocessor">#define MM_SESSION_SPACE_DEFAULT (0x2000000000000000UI64)  // make it the region 1 space</span>
00276 <span class="preprocessor"></span>
<a name="l00277"></a><a class="code" href="../../d2/d9/miia64_8h.html#a24">00277</a> <span class="preprocessor">#define MM_SYSTEM_VIEW_START_IF_HYDRA MM_SYSTEM_VIEW_START</span>
00278 <span class="preprocessor"></span>
<a name="l00279"></a><a class="code" href="../../d2/d9/miia64_8h.html#a25">00279</a> <span class="preprocessor">#define MM_SYSTEM_VIEW_SIZE_IF_HYDRA MM_SYSTEM_VIEW_SIZE</span>
00280 <span class="preprocessor"></span>
00281 <span class="comment">//</span>
00282 <span class="comment">// Define the start and maximum size for the system cache.</span>
00283 <span class="comment">// Maximum size 512MB.</span>
00284 <span class="comment">//</span>
00285 
<a name="l00286"></a><a class="code" href="../../d2/d9/miia64_8h.html#a26">00286</a> <span class="preprocessor">#define MM_SYSTEM_CACHE_WORKING_SET (KADDRESS_BASE + 0x400000000UI64)</span>
00287 <span class="preprocessor"></span>
<a name="l00288"></a><a class="code" href="../../d2/d9/miia64_8h.html#a27">00288</a> <span class="preprocessor">#define MM_SYSTEM_CACHE_START (KADDRESS_BASE + 0x600000000UI64)</span>
00289 <span class="preprocessor"></span>
<a name="l00290"></a><a class="code" href="../../d2/d9/miia64_8h.html#a28">00290</a> <span class="preprocessor">#define MM_SYSTEM_CACHE_END (KADDRESS_BASE + 0x1005FFFFFFFFUI64)</span>
00291 <span class="preprocessor"></span>
<a name="l00292"></a><a class="code" href="../../d2/d9/miia64_8h.html#a29">00292</a> <span class="preprocessor">#define MM_MAXIMUM_SYSTEM_CACHE_SIZE     \</span>
00293 <span class="preprocessor">   (((ULONG_PTR)MM_SYSTEM_CACHE_END - (ULONG_PTR)MM_SYSTEM_CACHE_START) &gt;&gt; PAGE_SHIFT)</span>
00294 <span class="preprocessor"></span>
<a name="l00295"></a><a class="code" href="../../d2/d9/miia64_8h.html#a30">00295</a> <span class="preprocessor">#define MM_PAGED_POOL_START ((PVOID)(KADDRESS_BASE + 0x10600000000UI64))</span>
00296 <span class="preprocessor"></span>
<a name="l00297"></a><a class="code" href="../../d2/d9/miia64_8h.html#a31">00297</a> <span class="preprocessor">#define MM_LOWEST_NONPAGED_SYSTEM_START ((PVOID)(KADDRESS_BASE + 0x12600000000UI64))</span>
00298 <span class="preprocessor"></span>
<a name="l00299"></a><a class="code" href="../../d2/d9/miia64_8h.html#a32">00299</a> <span class="preprocessor">#define MmProtopte_Base (KADDRESS_BASE)</span>
00300 <span class="preprocessor"></span>
<a name="l00301"></a><a class="code" href="../../d2/d9/miia64_8h.html#a33">00301</a> <span class="preprocessor">#define MM_NONPAGED_POOL_END ((PVOID)(KADDRESS_BASE + 0x16600000000UI64 - (16 * PAGE_SIZE)))</span>
00302 <span class="preprocessor"></span>
<a name="l00303"></a><a class="code" href="../../d2/d9/miia64_8h.html#a34">00303</a> <span class="preprocessor">#define MM_CRASH_DUMP_VA ((PVOID)(KADDRESS_BASE + 0xFF800000))</span>
00304 <span class="preprocessor"></span>
00305 <span class="comment">// EPC VA at 0xFFA00000 (see ntia64.h)</span>
00306 
<a name="l00307"></a><a class="code" href="../../d2/d9/miia64_8h.html#a35">00307</a> <span class="preprocessor">#define MM_DEBUG_VA  ((PVOID)(KADDRESS_BASE + 0xFF900000))</span>
00308 <span class="preprocessor"></span>
<a name="l00309"></a><a class="code" href="../../d2/d9/miia64_8h.html#a36">00309</a> <span class="preprocessor">#define NON_PAGED_SYSTEM_END   (KADDRESS_BASE + 0x16600000000UI64)  //quadword aligned.</span>
00310 <span class="preprocessor"></span>
<a name="l00311"></a><a class="code" href="../../d2/d9/miia64_8h.html#a37">00311</a> <span class="preprocessor">#define MM_PFN_DATABASE_START (KADDRESS_BASE + 0x40000000000UI64)</span>
00312 <span class="preprocessor"></span>
<a name="l00313"></a><a class="code" href="../../d2/d9/miia64_8h.html#a38">00313</a> <span class="preprocessor">#define MM_PFN_DATABASE_END (KADDRESS_BASE + 0x60000000000UI64)</span>
00314 <span class="preprocessor"></span>
<a name="l00315"></a><a class="code" href="../../d2/d9/miia64_8h.html#a273">00315</a> <span class="keyword">extern</span> ULONG <a class="code" href="../../d3/d2/dataia64_8c.html#a26">MiMaximumSystemCacheSize</a>;
00316 
00317 <span class="comment">//</span>
00318 <span class="comment">// Define absolute minumum and maximum count for system ptes.</span>
00319 <span class="comment">//</span>
00320 
<a name="l00321"></a><a class="code" href="../../d2/d9/miia64_8h.html#a39">00321</a> <span class="preprocessor">#define MM_MINIMUM_SYSTEM_PTES 7000</span>
00322 <span class="preprocessor"></span>
<a name="l00323"></a><a class="code" href="../../d2/d9/miia64_8h.html#a40">00323</a> <span class="preprocessor">#define MM_MAXIMUM_SYSTEM_PTES 50000</span>
00324 <span class="preprocessor"></span>
<a name="l00325"></a><a class="code" href="../../d2/d9/miia64_8h.html#a41">00325</a> <span class="preprocessor">#define MM_DEFAULT_SYSTEM_PTES 11000</span>
00326 <span class="preprocessor"></span>
00327 <span class="comment">//</span>
00328 <span class="comment">// Pool limits</span>
00329 <span class="comment">//</span>
00330 
00331 <span class="comment">//</span>
00332 <span class="comment">// The maximim amount of nonpaged pool that can be initially created.</span>
00333 <span class="comment">//</span>
00334 
<a name="l00335"></a><a class="code" href="../../d2/d9/miia64_8h.html#a42">00335</a> <span class="preprocessor">#define MM_MAX_INITIAL_NONPAGED_POOL ((SIZE_T)(128 * 1024 * 1024))</span>
00336 <span class="preprocessor"></span>
00337 <span class="comment">//</span>
00338 <span class="comment">// The total amount of nonpaged pool (initial pool + expansion + system PTEs).</span>
00339 <span class="comment">//</span>
00340 
<a name="l00341"></a><a class="code" href="../../d2/d9/miia64_8h.html#a43">00341</a> <span class="preprocessor">#define MM_MAX_ADDITIONAL_NONPAGED_POOL (((SIZE_T)128 * 1024 * 1024 * 1024) - 16)</span>
00342 <span class="preprocessor"></span>
00343 <span class="comment">//</span>
00344 <span class="comment">// The maximum amount of paged pool that can be created.</span>
00345 <span class="comment">//</span>
00346 
<a name="l00347"></a><a class="code" href="../../d2/d9/miia64_8h.html#a44">00347</a> <span class="preprocessor">#define MM_MAX_PAGED_POOL ((SIZE_T)128 * 1024 * 1024 * 1024)</span>
00348 <span class="preprocessor"></span>
00349 <span class="comment">//</span>
00350 <span class="comment">// Define the maximum default for pool (user specified 0 in registry).</span>
00351 <span class="comment">//</span>
00352 
<a name="l00353"></a><a class="code" href="../../d2/d9/miia64_8h.html#a45">00353</a> <span class="preprocessor">#define MM_MAX_DEFAULT_NONPAGED_POOL ((SIZE_T)8 * 1024 * 1024 * 1024)</span>
00354 <span class="preprocessor"></span>
00355 
00356 <span class="comment">//</span>
00357 <span class="comment">// Structure layout defintions.</span>
00358 <span class="comment">//</span>
00359 
<a name="l00360"></a><a class="code" href="../../d2/d9/miia64_8h.html#a46">00360</a> <span class="preprocessor">#define MM_PROTO_PTE_ALIGNMENT ((ULONG)PAGE_SIZE)</span>
00361 <span class="preprocessor"></span>
00362 <span class="comment">//</span>
00363 <span class="comment">// Define the address bits mapped by PPE and PDE entries.</span>
00364 <span class="comment">//</span>
00365 <span class="comment">// A PPE entry maps 10+10+13 = 33 bits of address space.</span>
00366 <span class="comment">// A PDE entry maps 10+13 = 23 bits of address space.</span>
00367 <span class="comment">//</span>
00368 
<a name="l00369"></a><a class="code" href="../../d2/d9/miia64_8h.html#a47">00369</a> <span class="preprocessor">#define PAGE_DIRECTORY1_MASK (((ULONG_PTR)1 &lt;&lt; PDI1_SHIFT) - 1)</span>
<a name="l00370"></a><a class="code" href="../../d2/d9/miia64_8h.html#a48">00370</a> <span class="preprocessor"></span><span class="preprocessor">#define PAGE_DIRECTORY2_MASK (((ULONG_PTR)1 &lt;&lt; PDI_SHIFT) -1)</span>
00371 <span class="preprocessor"></span>
<a name="l00372"></a><a class="code" href="../../d2/d9/miia64_8h.html#a49">00372</a> <span class="preprocessor">#define MM_VA_MAPPED_BY_PDE ((ULONG_PTR)1 &lt;&lt; PDI_SHIFT)</span>
00373 <span class="preprocessor"></span>
<a name="l00374"></a><a class="code" href="../../d2/d9/miia64_8h.html#a50">00374</a> <span class="preprocessor">#define LOWEST_IO_ADDRESS 0xa0000</span>
00375 <span class="preprocessor"></span>
00376 <span class="comment">//</span>
00377 <span class="comment">// The number of bits in a physical address.</span>
00378 <span class="comment">//</span>
00379 
<a name="l00380"></a><a class="code" href="../../d2/d9/miia64_8h.html#a51">00380</a> <span class="preprocessor">#define PHYSICAL_ADDRESS_BITS 44</span>
00381 <span class="preprocessor"></span>
<a name="l00382"></a><a class="code" href="../../d2/d9/miia64_8h.html#a52">00382</a> <span class="preprocessor">#define MM_MAXIMUM_NUMBER_OF_COLORS (1)</span>
00383 <span class="preprocessor"></span>
00384 <span class="comment">//</span>
00385 <span class="comment">// MERCED does not require support for colored pages.</span>
00386 <span class="comment">//</span>
00387 
<a name="l00388"></a><a class="code" href="../../d2/d9/miia64_8h.html#a53">00388</a> <span class="preprocessor">#define MM_NUMBER_OF_COLORS (1)</span>
00389 <span class="preprocessor"></span>
00390 <span class="comment">//</span>
00391 <span class="comment">// Mask for obtaining color from a physical page number.</span>
00392 <span class="comment">//</span>
00393 
<a name="l00394"></a><a class="code" href="../../d2/d9/miia64_8h.html#a54">00394</a> <span class="preprocessor">#define MM_COLOR_MASK (0)</span>
00395 <span class="preprocessor"></span>
00396 <span class="comment">//</span>
00397 <span class="comment">// Boundary for aligned pages of like color upon.</span>
00398 <span class="comment">//</span>
00399 
<a name="l00400"></a><a class="code" href="../../d2/d9/miia64_8h.html#a55">00400</a> <span class="preprocessor">#define MM_COLOR_ALIGNMENT (0)</span>
00401 <span class="preprocessor"></span>
00402 <span class="comment">//</span>
00403 <span class="comment">// Mask for isolating color from virtual address.</span>
00404 <span class="comment">//</span>
00405 
<a name="l00406"></a><a class="code" href="../../d2/d9/miia64_8h.html#a56">00406</a> <span class="preprocessor">#define MM_COLOR_MASK_VIRTUAL (0)</span>
00407 <span class="preprocessor"></span>
00408 <span class="comment">//</span>
00409 <span class="comment">//  Define 256k worth of secondary colors.</span>
00410 <span class="comment">//</span>
00411 
<a name="l00412"></a><a class="code" href="../../d2/d9/miia64_8h.html#a57">00412</a> <span class="preprocessor">#define MM_SECONDARY_COLORS_DEFAULT (64)</span>
00413 <span class="preprocessor"></span>
<a name="l00414"></a><a class="code" href="../../d2/d9/miia64_8h.html#a58">00414</a> <span class="preprocessor">#define MM_SECONDARY_COLORS_MIN (2)</span>
00415 <span class="preprocessor"></span>
<a name="l00416"></a><a class="code" href="../../d2/d9/miia64_8h.html#a59">00416</a> <span class="preprocessor">#define MM_SECONDARY_COLORS_MAX (1024)</span>
00417 <span class="preprocessor"></span>
00418 <span class="comment">//</span>
00419 <span class="comment">// Mask for isolating secondary color from physical page number;</span>
00420 <span class="comment">//</span>
00421 
<a name="l00422"></a><a class="code" href="../../d2/d9/miia64_8h.html#a274">00422</a> <span class="keyword">extern</span> ULONG <a class="code" href="../../d4/d2/datalpha_8c.html#a22">MmSecondaryColorMask</a>;
00423 
00424 <span class="comment">//</span>
00425 <span class="comment">// Maximum number of paging files.</span>
00426 <span class="comment">//</span>
00427 
<a name="l00428"></a><a class="code" href="../../d2/d9/miia64_8h.html#a60">00428</a> <span class="preprocessor">#define MAX_PAGE_FILES 16</span>
00429 <span class="preprocessor"></span>
00430 
00431 <span class="comment">//</span>
00432 <span class="comment">// Hyper space definitions.</span>
00433 <span class="comment">//</span>
00434 
<a name="l00435"></a><a class="code" href="../../d2/d9/miia64_8h.html#a61">00435</a> <span class="preprocessor">#define FIRST_MAPPING_PTE   ((PMMPTE)HYPER_SPACE)</span>
00436 <span class="preprocessor"></span>
<a name="l00437"></a><a class="code" href="../../d2/d9/miia64_8h.html#a62">00437</a> <span class="preprocessor">#define NUMBER_OF_MAPPING_PTES 255</span>
<a name="l00438"></a><a class="code" href="../../d2/d9/miia64_8h.html#a63">00438</a> <span class="preprocessor"></span><span class="preprocessor">#define LAST_MAPPING_PTE   \</span>
00439 <span class="preprocessor">     ((ULONG_PTR)((ULONG_PTR)FIRST_MAPPING_PTE + (NUMBER_OF_MAPPING_PTES * PAGE_SIZE)))</span>
00440 <span class="preprocessor"></span>
<a name="l00441"></a><a class="code" href="../../d2/d9/miia64_8h.html#a64">00441</a> <span class="preprocessor">#define IMAGE_MAPPING_PTE   ((PMMPTE)((ULONG_PTR)LAST_MAPPING_PTE + PAGE_SIZE))</span>
00442 <span class="preprocessor"></span>
<a name="l00443"></a><a class="code" href="../../d2/d9/miia64_8h.html#a65">00443</a> <span class="preprocessor">#define ZEROING_PAGE_PTE    ((PMMPTE)((ULONG_PTR)IMAGE_MAPPING_PTE + PAGE_SIZE))</span>
00444 <span class="preprocessor"></span>
<a name="l00445"></a><a class="code" href="../../d2/d9/miia64_8h.html#a66">00445</a> <span class="preprocessor">#define WORKING_SET_LIST   ((PVOID)((ULONG_PTR)ZEROING_PAGE_PTE + PAGE_SIZE))</span>
00446 <span class="preprocessor"></span>
<a name="l00447"></a><a class="code" href="../../d2/d9/miia64_8h.html#a67">00447</a> <span class="preprocessor">#define MM_MAXIMUM_WORKING_SET \</span>
00448 <span class="preprocessor">       ((ULONG)((ULONG)2*1024*1024*1024 - 64*1024*1024) &gt;&gt; PAGE_SHIFT) //2Gb-64Mb</span>
00449 <span class="preprocessor"></span>
<a name="l00450"></a><a class="code" href="../../d2/d9/miia64_8h.html#a68">00450</a> <span class="preprocessor">#define MM_WORKING_SET_END (UADDRESS_BASE + 0x3FFFFFFFFFFUI64)</span>
00451 <span class="preprocessor"></span>
00452 <span class="comment">//</span>
00453 <span class="comment">// Define memory attributes fields within PTE</span>
00454 <span class="comment">//</span>
00455 
<a name="l00456"></a><a class="code" href="../../d2/d9/miia64_8h.html#a69">00456</a> <span class="preprocessor">#define MM_PTE_TB_MA_WB         (0x0 &lt;&lt; 2) // cacheable, write-back</span>
<a name="l00457"></a><a class="code" href="../../d2/d9/miia64_8h.html#a70">00457</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_PTE_TB_MA_UC         (0x4 &lt;&lt; 2) // uncheable</span>
<a name="l00458"></a><a class="code" href="../../d2/d9/miia64_8h.html#a71">00458</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_PTE_TB_MA_UCE        (0x5 &lt;&lt; 2) // uncheable, exporting fetchadd</span>
<a name="l00459"></a><a class="code" href="../../d2/d9/miia64_8h.html#a72">00459</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_PTE_TB_MA_WC         (0x6 &lt;&lt; 2) // uncheable, coalesing</span>
<a name="l00460"></a><a class="code" href="../../d2/d9/miia64_8h.html#a73">00460</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_PTE_TB_MA_NATPAGE    (0x7 &lt;&lt; 2) // Nat Page</span>
00461 <span class="preprocessor"></span>
00462 <span class="comment">//</span>
00463 <span class="comment">// Define masks for the PTE cache attributes</span>
00464 <span class="comment">//</span>
00465 
<a name="l00466"></a><a class="code" href="../../d2/d9/miia64_8h.html#a74">00466</a> <span class="preprocessor">#define MM_PTE_CACHE_ENABLED     0     // WB</span>
<a name="l00467"></a><a class="code" href="../../d2/d9/miia64_8h.html#a75">00467</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_PTE_CACHE_DISABLED    4     // UC</span>
<a name="l00468"></a><a class="code" href="../../d2/d9/miia64_8h.html#a76">00468</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_PTE_CACHE_DISPLAY     6     // WC</span>
<a name="l00469"></a><a class="code" href="../../d2/d9/miia64_8h.html#a77">00469</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_PTE_CACHE_RESERVED    1     // special encoding to cause a TLB miss</span>
00470 <span class="preprocessor"></span>
00471 <span class="comment">//</span>
00472 <span class="comment">// Define masks for fields within the PTE.</span>
00473 <span class="comment">//</span>
00474 
<a name="l00475"></a><a class="code" href="../../d2/d9/miia64_8h.html#a78">00475</a> <span class="preprocessor">#define MM_PTE_OWNER_MASK         0x0180</span>
<a name="l00476"></a><a class="code" href="../../d2/d9/miia64_8h.html#a79">00476</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_PTE_VALID_MASK         1</span>
<a name="l00477"></a><a class="code" href="../../d2/d9/miia64_8h.html#a80">00477</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_PTE_CACHE_DISABLE_MASK MM_PTE_TB_MA_UC</span>
<a name="l00478"></a><a class="code" href="../../d2/d9/miia64_8h.html#a81">00478</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_PTE_ACCESS_MASK        0x0020</span>
<a name="l00479"></a><a class="code" href="../../d2/d9/miia64_8h.html#a82">00479</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_PTE_DIRTY_MASK         0x0040</span>
<a name="l00480"></a><a class="code" href="../../d2/d9/miia64_8h.html#a83">00480</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_PTE_EXECUTE_MASK       0x0200</span>
<a name="l00481"></a><a class="code" href="../../d2/d9/miia64_8h.html#a84">00481</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_PTE_WRITE_MASK         0x0400</span>
<a name="l00482"></a><a class="code" href="../../d2/d9/miia64_8h.html#a85">00482</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_PTE_LARGE_PAGE_MASK    0</span>
<a name="l00483"></a><a class="code" href="../../d2/d9/miia64_8h.html#a86">00483</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_PTE_COPY_ON_WRITE_MASK ((ULONG)1 &lt;&lt; (PAGE_SHIFT-1))</span>
00484 <span class="preprocessor"></span>
<a name="l00485"></a><a class="code" href="../../d2/d9/miia64_8h.html#a87">00485</a> <span class="preprocessor">#define MM_PTE_PROTOTYPE_MASK     0x0002</span>
<a name="l00486"></a><a class="code" href="../../d2/d9/miia64_8h.html#a88">00486</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_PTE_TRANSITION_MASK    0x0080</span>
00487 <span class="preprocessor"></span>
00488 <span class="comment">//</span>
00489 <span class="comment">// Bit fields to or into PTE to make a PTE valid based on the</span>
00490 <span class="comment">// protection field of the invalid PTE.</span>
00491 <span class="comment">//</span>
00492 
<a name="l00493"></a><a class="code" href="../../d2/d9/miia64_8h.html#a89">00493</a> <span class="preprocessor">#define MM_PTE_NOACCESS          0x0</span>
<a name="l00494"></a><a class="code" href="../../d2/d9/miia64_8h.html#a90">00494</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_PTE_READONLY          0x0</span>
<a name="l00495"></a><a class="code" href="../../d2/d9/miia64_8h.html#a91">00495</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_PTE_READWRITE         MM_PTE_WRITE_MASK</span>
<a name="l00496"></a><a class="code" href="../../d2/d9/miia64_8h.html#a92">00496</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_PTE_WRITECOPY         MM_PTE_COPY_ON_WRITE_MASK</span>
<a name="l00497"></a><a class="code" href="../../d2/d9/miia64_8h.html#a93">00497</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_PTE_EXECUTE           MM_PTE_EXECUTE_MASK</span>
<a name="l00498"></a><a class="code" href="../../d2/d9/miia64_8h.html#a94">00498</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_PTE_EXECUTE_READ      MM_PTE_EXECUTE_MASK</span>
<a name="l00499"></a><a class="code" href="../../d2/d9/miia64_8h.html#a95">00499</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_PTE_EXECUTE_READWRITE MM_PTE_EXECUTE_MASK | MM_PTE_WRITE_MASK</span>
<a name="l00500"></a><a class="code" href="../../d2/d9/miia64_8h.html#a96">00500</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_PTE_EXECUTE_WRITECOPY MM_PTE_EXECUTE_MASK | MM_PTE_COPY_ON_WRITE_MASK</span>
<a name="l00501"></a><a class="code" href="../../d2/d9/miia64_8h.html#a97">00501</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_PTE_GUARD             0x0</span>
<a name="l00502"></a><a class="code" href="../../d2/d9/miia64_8h.html#a98">00502</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_PTE_CACHE             MM_PTE_TB_MA_WB</span>
<a name="l00503"></a><a class="code" href="../../d2/d9/miia64_8h.html#a99">00503</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_PTE_NOCACHE           MM_PTE_CACHE     // PAGE_NOCACHE is cached</span>
<a name="l00504"></a><a class="code" href="../../d2/d9/miia64_8h.html#a100">00504</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_PTE_EXC_DEFER         0x10000000000000 // defer exception</span>
00505 <span class="preprocessor"></span>
00506 
<a name="l00507"></a><a class="code" href="../../d2/d9/miia64_8h.html#a101">00507</a> <span class="preprocessor">#define MM_PROTECT_FIELD_SHIFT 2</span>
00508 <span class="preprocessor"></span>
00509 <span class="comment">//</span>
00510 <span class="comment">// Define masks for fields within the EM TB entry</span>
00511 <span class="comment">//</span>
00512 
<a name="l00513"></a><a class="code" href="../../d2/d9/miia64_8h.html#a102">00513</a> <span class="preprocessor">#define MM_PTE_TB_VALID          0x0001</span>
<a name="l00514"></a><a class="code" href="../../d2/d9/miia64_8h.html#a103">00514</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_PTE_TB_ACCESSED       0x0020</span>
<a name="l00515"></a><a class="code" href="../../d2/d9/miia64_8h.html#a104">00515</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_PTE_TB_MODIFIED       0x0040</span>
<a name="l00516"></a><a class="code" href="../../d2/d9/miia64_8h.html#a105">00516</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_PTE_TB_WRITE          0x0400</span>
<a name="l00517"></a><a class="code" href="../../d2/d9/miia64_8h.html#a106">00517</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_PTE_TB_EXECUTE        0x0200  // read/execute on EM</span>
<a name="l00518"></a><a class="code" href="../../d2/d9/miia64_8h.html#a107">00518</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_PTE_TB_EXC_DEFER      0x10000000000000 // defer exception</span>
00519 <span class="preprocessor"></span>
00520 <span class="comment">//</span>
00521 <span class="comment">// Define masks for PTE PageSize field</span>
00522 <span class="comment">//</span>
00523 
<a name="l00524"></a><a class="code" href="../../d2/d9/miia64_8h.html#a108">00524</a> <span class="preprocessor">#define MM_PTE_1MB_PAGE          20</span>
<a name="l00525"></a><a class="code" href="../../d2/d9/miia64_8h.html#a109">00525</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_PTE_2MB_PAGE          21</span>
<a name="l00526"></a><a class="code" href="../../d2/d9/miia64_8h.html#a110">00526</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_PTE_4MB_PAGE          22</span>
<a name="l00527"></a><a class="code" href="../../d2/d9/miia64_8h.html#a111">00527</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_PTE_16MB_PAGE         24</span>
<a name="l00528"></a><a class="code" href="../../d2/d9/miia64_8h.html#a112">00528</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_PTE_64MB_PAGE         26</span>
<a name="l00529"></a><a class="code" href="../../d2/d9/miia64_8h.html#a113">00529</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_PTE_256MB_PAGE        28</span>
00530 <span class="preprocessor"></span>
00531 <span class="comment">//</span>
00532 <span class="comment">// Define the number of VHPT pages</span>
00533 <span class="comment">//</span>
00534 
<a name="l00535"></a><a class="code" href="../../d2/d9/miia64_8h.html#a114">00535</a> <span class="preprocessor">#define MM_VHPT_PAGES           32</span>
00536 <span class="preprocessor"></span>
00537 <span class="comment">//</span>
00538 <span class="comment">// Bits available for the software working set index within the hardware PTE.</span>
00539 <span class="comment">//</span>
00540 
<a name="l00541"></a><a class="code" href="../../d2/d9/miia64_8h.html#a115">00541</a> <span class="preprocessor">#define MI_MAXIMUM_PTE_WORKING_SET_INDEX (1 &lt;&lt; _HARDWARE_PTE_WORKING_SET_BITS)</span>
00542 <span class="preprocessor"></span>
00543 <span class="comment">//</span>
00544 <span class="comment">// Zero PTE</span>
00545 <span class="comment">//</span>
00546 
<a name="l00547"></a><a class="code" href="../../d2/d9/miia64_8h.html#a116">00547</a> <span class="preprocessor">#define MM_ZERO_PTE 0</span>
00548 <span class="preprocessor"></span>
00549 <span class="comment">//</span>
00550 <span class="comment">// Zero Kernel PTE</span>
00551 <span class="comment">//</span>
00552 
<a name="l00553"></a><a class="code" href="../../d2/d9/miia64_8h.html#a117">00553</a> <span class="preprocessor">#define MM_ZERO_KERNEL_PTE 0</span>
00554 <span class="preprocessor"></span>
00555 <span class="comment">//</span>
00556 <span class="comment">// A demand zero PTE with a protection or PAGE_READWRITE.</span>
00557 <span class="comment">//</span>
00558 
<a name="l00559"></a><a class="code" href="../../d2/d9/miia64_8h.html#a118">00559</a> <span class="preprocessor">#define MM_DEMAND_ZERO_WRITE_PTE ((ULONGLONG)MM_READWRITE &lt;&lt; MM_PROTECT_FIELD_SHIFT)</span>
00560 <span class="preprocessor"></span>
00561 
00562 <span class="comment">//</span>
00563 <span class="comment">// A demand zero PTE with a protection or PAGE_READWRITE for system space.</span>
00564 <span class="comment">//</span>
00565 
<a name="l00566"></a><a class="code" href="../../d2/d9/miia64_8h.html#a119">00566</a> <span class="preprocessor">#define MM_KERNEL_DEMAND_ZERO_PTE ((ULONGLONG)MM_READWRITE &lt;&lt; MM_PROTECT_FIELD_SHIFT)</span>
00567 <span class="preprocessor"></span>
00568 <span class="comment">//</span>
00569 <span class="comment">// A no access PTE for system space.</span>
00570 <span class="comment">//</span>
00571 
<a name="l00572"></a><a class="code" href="../../d2/d9/miia64_8h.html#a120">00572</a> <span class="preprocessor">#define MM_KERNEL_NOACCESS_PTE ((ULONGLONG)MM_NOACCESS &lt;&lt; MM_PROTECT_FIELD_SHIFT)</span>
00573 <span class="preprocessor"></span>
<a name="l00574"></a><a class="code" href="../../d2/d9/miia64_8h.html#a275">00574</a> <span class="keyword">extern</span> ULONG_PTR <a class="code" href="../../d2/d2/data386_8c.html#a2">MmPteGlobal</a>; <span class="comment">// One if processor supports Global Page, else zero.</span>
00575 
00576 <span class="comment">//</span>
00577 <span class="comment">// Kernel stack alignment requirements.</span>
00578 <span class="comment">//</span>
00579 
<a name="l00580"></a><a class="code" href="../../d2/d9/miia64_8h.html#a121">00580</a> <span class="preprocessor">#define MM_STACK_ALIGNMENT 0x0</span>
00581 <span class="preprocessor"></span>
<a name="l00582"></a><a class="code" href="../../d2/d9/miia64_8h.html#a122">00582</a> <span class="preprocessor">#define MM_STACK_OFFSET 0x0</span>
00583 <span class="preprocessor"></span>
00584 <span class="comment">//</span>
00585 <span class="comment">// System process definitions</span>
00586 <span class="comment">//</span>
00587 
<a name="l00588"></a><a class="code" href="../../d2/d9/miia64_8h.html#a123">00588</a> <span class="preprocessor">#define PDE_PER_PAGE ((ULONG)(PAGE_SIZE/(1 &lt;&lt; PTE_SHIFT)))</span>
00589 <span class="preprocessor"></span> 
<a name="l00590"></a><a class="code" href="../../d2/d9/miia64_8h.html#a124">00590</a> <span class="preprocessor">#define PTE_PER_PAGE ((ULONG)(PAGE_SIZE/(1 &lt;&lt; PTE_SHIFT)))</span>
00591 <span class="preprocessor"></span>
<a name="l00592"></a><a class="code" href="../../d2/d9/miia64_8h.html#a125">00592</a> <span class="preprocessor">#define PTE_PER_PAGE_BITS 11    // This handles the case where the page is full</span>
00593 <span class="preprocessor"></span>
00594 <span class="preprocessor">#if PTE_PER_PAGE_BITS &gt; 32</span>
00595 <span class="preprocessor"></span>error - too many bits to fit into <a class="code" href="../../d4/d5/struct__MMPTE__SOFTWARE.html">MMPTE_SOFTWARE</a> or <a class="code" href="../../d4/d3/struct__MMPFN.html">MMPFN</a>.u1
00596 <span class="preprocessor">#endif</span>
00597 <span class="preprocessor"></span>
00598 <span class="comment">//</span>
00599 <span class="comment">// Number of page table pages for user addresses.</span>
00600 <span class="comment">//</span>
00601 
<a name="l00602"></a><a class="code" href="../../d2/d9/miia64_8h.html#a126">00602</a> <span class="preprocessor">#define MM_USER_PAGE_TABLE_PAGES PTE_PER_PAGE</span>
00603 <span class="preprocessor"></span>
00604 
00605 <span class="comment">//++</span>
00606 <span class="comment">//VOID</span>
00607 <span class="comment">//MI_MAKE_VALID_PTE (</span>
00608 <span class="comment">//    OUT OUTPTE,</span>
00609 <span class="comment">//    IN FRAME,</span>
00610 <span class="comment">//    IN PMASK,</span>
00611 <span class="comment">//    IN PPTE</span>
00612 <span class="comment">//    );</span>
00613 <span class="comment">//</span>
00614 <span class="comment">// Routine Description:</span>
00615 <span class="comment">//</span>
00616 <span class="comment">//    This macro makes a valid PTE from a page frame number, protection mask,</span>
00617 <span class="comment">//    and owner.</span>
00618 <span class="comment">//</span>
00619 <span class="comment">// Argments</span>
00620 <span class="comment">//</span>
00621 <span class="comment">//    OUTPTE - Supplies the PTE in which to build the transition PTE.</span>
00622 <span class="comment">//</span>
00623 <span class="comment">//    FRAME - Supplies the page frame number for the PTE.</span>
00624 <span class="comment">//</span>
00625 <span class="comment">//    PMASK - Supplies the protection to set in the transition PTE.</span>
00626 <span class="comment">//</span>
00627 <span class="comment">//    PPTE - Supplies a pointer to the PTE which is being made valid.</span>
00628 <span class="comment">//           For prototype PTEs NULL should be specified.</span>
00629 <span class="comment">//</span>
00630 <span class="comment">// Return Value:</span>
00631 <span class="comment">//</span>
00632 <span class="comment">//     None.</span>
00633 <span class="comment">//</span>
00634 <span class="comment">//--</span>
00635 
00636 <span class="preprocessor">#if !defined(_MIALT4K_)</span>
00637 <span class="preprocessor"></span>
00638 <span class="preprocessor">#define MI_MAKE_VALID_PTE(OUTPTE,FRAME,PMASK,PPTE)                            \</span>
00639 <span class="preprocessor">       (OUTPTE).u.Long = 0;                                                   \</span>
00640 <span class="preprocessor">       (OUTPTE).u.Hard.Valid = 1;                                             \</span>
00641 <span class="preprocessor">       (OUTPTE).u.Hard.Cache = MM_PTE_CACHE_ENABLED;                          \</span>
00642 <span class="preprocessor">       (OUTPTE).u.Hard.Accessed = 1;                                          \</span>
00643 <span class="preprocessor">       (OUTPTE).u.Hard.Exception = 1;                                         \</span>
00644 <span class="preprocessor">       (OUTPTE).u.Hard.PageFrameNumber = FRAME;                               \</span>
00645 <span class="preprocessor">       (OUTPTE).u.Hard.Owner = MI_DETERMINE_OWNER(PPTE);                      \</span>
00646 <span class="preprocessor">       (OUTPTE).u.Long |= (MmProtectToPteMask[PMASK]);</span>
00647 <span class="preprocessor"></span>
00648 <span class="preprocessor">#endif</span>
00649 <span class="preprocessor"></span>
00650 <span class="comment">//++</span>
00651 <span class="comment">//VOID</span>
00652 <span class="comment">//MI_MAKE_VALID_PTE_TRANSITION (</span>
00653 <span class="comment">//    IN OUT OUTPTE</span>
00654 <span class="comment">//    IN PROTECT</span>
00655 <span class="comment">//    );</span>
00656 <span class="comment">//</span>
00657 <span class="comment">// Routine Description:</span>
00658 <span class="comment">//</span>
00659 <span class="comment">//    This macro takes a valid pte and turns it into a transition PTE.</span>
00660 <span class="comment">//</span>
00661 <span class="comment">// Argments</span>
00662 <span class="comment">//</span>
00663 <span class="comment">//    OUTPTE - Supplies the current valid PTE.  This PTE is then</span>
00664 <span class="comment">//             modified to become a transition PTE.</span>
00665 <span class="comment">//</span>
00666 <span class="comment">//    PROTECT - Supplies the protection to set in the transition PTE.</span>
00667 <span class="comment">//</span>
00668 <span class="comment">// Return Value:</span>
00669 <span class="comment">//</span>
00670 <span class="comment">//     None.</span>
00671 <span class="comment">//</span>
00672 <span class="comment">//--</span>
00673 
<a name="l00674"></a><a class="code" href="../../d2/d9/miia64_8h.html#a127">00674</a> <span class="preprocessor">#define MI_MAKE_VALID_PTE_TRANSITION(OUTPTE,PROTECT) \</span>
00675 <span class="preprocessor">                (OUTPTE).u.Soft.Transition = 1;           \</span>
00676 <span class="preprocessor">                (OUTPTE).u.Soft.Valid = 0;                \</span>
00677 <span class="preprocessor">                (OUTPTE).u.Soft.Prototype = 0;            \</span>
00678 <span class="preprocessor">                (OUTPTE).u.Soft.Protection = PROTECT;</span>
00679 <span class="preprocessor"></span>
00680 <span class="comment">//++</span>
00681 <span class="comment">//VOID</span>
00682 <span class="comment">//MI_MAKE_TRANSITION_PTE (</span>
00683 <span class="comment">//    OUT OUTPTE,</span>
00684 <span class="comment">//    IN PAGE,</span>
00685 <span class="comment">//    IN PROTECT,</span>
00686 <span class="comment">//    IN PPTE</span>
00687 <span class="comment">//    );</span>
00688 <span class="comment">//</span>
00689 <span class="comment">// Routine Description:</span>
00690 <span class="comment">//</span>
00691 <span class="comment">//    This macro takes a valid pte and turns it into a transition PTE.</span>
00692 <span class="comment">//</span>
00693 <span class="comment">// Argments</span>
00694 <span class="comment">//</span>
00695 <span class="comment">//    OUTPTE - Supplies the PTE in which to build the transition PTE.</span>
00696 <span class="comment">//</span>
00697 <span class="comment">//    PAGE - Supplies the page frame number for the PTE.</span>
00698 <span class="comment">//</span>
00699 <span class="comment">//    PROTECT - Supplies the protection to set in the transition PTE.</span>
00700 <span class="comment">//</span>
00701 <span class="comment">//    PPTE - Supplies a pointer to the PTE, this is used to determine</span>
00702 <span class="comment">//           the owner of the PTE.</span>
00703 <span class="comment">//</span>
00704 <span class="comment">// Return Value:</span>
00705 <span class="comment">//</span>
00706 <span class="comment">//     None.</span>
00707 <span class="comment">//</span>
00708 <span class="comment">//--</span>
00709 
<a name="l00710"></a><a class="code" href="../../d2/d9/miia64_8h.html#a128">00710</a> <span class="preprocessor">#define MI_MAKE_TRANSITION_PTE(OUTPTE,PAGE,PROTECT,PPTE)   \</span>
00711 <span class="preprocessor">                (OUTPTE).u.Long = 0;                       \</span>
00712 <span class="preprocessor">                (OUTPTE).u.Trans.PageFrameNumber = PAGE;   \</span>
00713 <span class="preprocessor">                (OUTPTE).u.Trans.Transition = 1;           \</span>
00714 <span class="preprocessor">                (OUTPTE).u.Trans.Protection = PROTECT;</span>
00715 <span class="preprocessor"></span>
00716 
00717 
00718 <span class="comment">//++</span>
00719 <span class="comment">//VOID</span>
00720 <span class="comment">//MI_MAKE_TRANSITION_PTE_VALID (</span>
00721 <span class="comment">//    OUT OUTPTE,</span>
00722 <span class="comment">//    IN PPTE</span>
00723 <span class="comment">//    );</span>
00724 <span class="comment">//</span>
00725 <span class="comment">// Routine Description:</span>
00726 <span class="comment">//</span>
00727 <span class="comment">//    This macro takes a transition pte and makes it a valid PTE.</span>
00728 <span class="comment">//</span>
00729 <span class="comment">// Argments</span>
00730 <span class="comment">//</span>
00731 <span class="comment">//    OUTPTE - Supplies the PTE in which to build the valid PTE.</span>
00732 <span class="comment">//</span>
00733 <span class="comment">//    PPTE - Supplies a pointer to the transition PTE.</span>
00734 <span class="comment">//</span>
00735 <span class="comment">// Return Value:</span>
00736 <span class="comment">//</span>
00737 <span class="comment">//     None.</span>
00738 <span class="comment">//</span>
00739 <span class="comment">//--</span>
00740 
00741 <span class="preprocessor">#if !defined(_MIALT4K_)</span>
00742 <span class="preprocessor"></span>
00743 <span class="preprocessor">#define MI_MAKE_TRANSITION_PTE_VALID(OUTPTE,PPTE)                             \</span>
00744 <span class="preprocessor">        ASSERT (((PPTE)-&gt;u.Hard.Valid == 0) &amp;&amp;                                \</span>
00745 <span class="preprocessor">                ((PPTE)-&gt;u.Trans.Prototype == 0) &amp;&amp;                           \</span>
00746 <span class="preprocessor">                ((PPTE)-&gt;u.Trans.Transition == 1));                           \</span>
00747 <span class="preprocessor">       (OUTPTE).u.Long = (PPTE)-&gt;u.Long &amp; 0x1FFFFFFFE000;                     \</span>
00748 <span class="preprocessor">       (OUTPTE).u.Hard.Valid = 1;                                             \</span>
00749 <span class="preprocessor">       (OUTPTE).u.Hard.Cache = MM_PTE_CACHE_ENABLED;                          \</span>
00750 <span class="preprocessor">       (OUTPTE).u.Hard.Accessed = 1;                                          \</span>
00751 <span class="preprocessor">       (OUTPTE).u.Hard.Exception = 1;                                         \</span>
00752 <span class="preprocessor">       (OUTPTE).u.Hard.Owner = MI_DETERMINE_OWNER(PPTE);                      \</span>
00753 <span class="preprocessor">       (OUTPTE).u.Long |= (MmProtectToPteMask[(PPTE)-&gt;u.Trans.Protection]);</span>
00754 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00755 <span class="preprocessor"></span>
00756 <span class="comment">//++</span>
00757 <span class="comment">//VOID</span>
00758 <span class="comment">//MI_SET_PTE_IN_WORKING_SET (</span>
00759 <span class="comment">//    OUT PMMPTE PTE,</span>
00760 <span class="comment">//    IN ULONG WSINDEX</span>
00761 <span class="comment">//    );</span>
00762 <span class="comment">//</span>
00763 <span class="comment">// Routine Description:</span>
00764 <span class="comment">//</span>
00765 <span class="comment">//    This macro inserts the specified working set index into the argument PTE.</span>
00766 <span class="comment">//</span>
00767 <span class="comment">//    No TB invalidation is needed for other processors (or this one) even</span>
00768 <span class="comment">//    though the entry may already be in a TB - it's just a software field</span>
00769 <span class="comment">//    update and doesn't affect miss resolution.</span>
00770 <span class="comment">//</span>
00771 <span class="comment">// Arguments</span>
00772 <span class="comment">//</span>
00773 <span class="comment">//    OUTPTE - Supplies the PTE in which to insert the working set index.</span>
00774 <span class="comment">//</span>
00775 <span class="comment">//    WSINDEX - Supplies the working set index for the PTE.</span>
00776 <span class="comment">//</span>
00777 <span class="comment">// Return Value:</span>
00778 <span class="comment">//</span>
00779 <span class="comment">//     None.</span>
00780 <span class="comment">//</span>
00781 <span class="comment">//--</span>
00782 
<a name="l00783"></a><a class="code" href="../../d2/d9/miia64_8h.html#a129">00783</a> <span class="preprocessor">#define MI_SET_PTE_IN_WORKING_SET(PTE, WSINDEX) {             \</span>
00784 <span class="preprocessor">    MMPTE _TempPte;                                           \</span>
00785 <span class="preprocessor">    _TempPte = *(PTE);                                        \</span>
00786 <span class="preprocessor">    _TempPte.u.Hard.SoftwareWsIndex = (WSINDEX);              \</span>
00787 <span class="preprocessor">    *(PTE) = _TempPte;                                        \</span>
00788 <span class="preprocessor">}</span>
00789 <span class="preprocessor"></span>
00790 <span class="comment">//++</span>
00791 <span class="comment">//ULONG WsIndex</span>
00792 <span class="comment">//MI_GET_WORKING_SET_FROM_PTE(</span>
00793 <span class="comment">//    IN PMMPTE PTE</span>
00794 <span class="comment">//    );</span>
00795 <span class="comment">//</span>
00796 <span class="comment">// Routine Description:</span>
00797 <span class="comment">//</span>
00798 <span class="comment">//    This macro returns the working set index from the argument PTE.</span>
00799 <span class="comment">//</span>
00800 <span class="comment">// Arguments</span>
00801 <span class="comment">//</span>
00802 <span class="comment">//    PTE - Supplies the PTE to extract the working set index from.</span>
00803 <span class="comment">//</span>
00804 <span class="comment">// Return Value:</span>
00805 <span class="comment">//</span>
00806 <span class="comment">//    This macro returns the working set index for the argument PTE.</span>
00807 <span class="comment">//</span>
00808 <span class="comment">//--</span>
00809 
<a name="l00810"></a><a class="code" href="../../d2/d9/miia64_8h.html#a130">00810</a> <span class="preprocessor">#define MI_GET_WORKING_SET_FROM_PTE(PTE)  (ULONG)(PTE)-&gt;u.Hard.SoftwareWsIndex</span>
00811 <span class="preprocessor"></span>
00812 <span class="comment">//++</span>
00813 <span class="comment">//VOID</span>
00814 <span class="comment">//MI_SET_PTE_WRITE_COMBINE (</span>
00815 <span class="comment">//    IN MMPTE PTE</span>
00816 <span class="comment">//    );</span>
00817 <span class="comment">//</span>
00818 <span class="comment">// Routine Description:</span>
00819 <span class="comment">//</span>
00820 <span class="comment">//    This macro sets the write combined bit(s) in the specified PTE.</span>
00821 <span class="comment">//</span>
00822 <span class="comment">// Arguments</span>
00823 <span class="comment">//</span>
00824 <span class="comment">//    PTE - Supplies the PTE to set dirty.</span>
00825 <span class="comment">//</span>
00826 <span class="comment">// Return Value:</span>
00827 <span class="comment">//</span>
00828 <span class="comment">//     None.</span>
00829 <span class="comment">//</span>
00830 <span class="comment">//--</span>
00831 
<a name="l00832"></a><a class="code" href="../../d2/d9/miia64_8h.html#a131">00832</a> <span class="preprocessor">#define MI_SET_PTE_WRITE_COMBINE(PTE)  \</span>
00833 <span class="preprocessor">    ((PTE).u.Hard.Cache = MM_PTE_CACHE_DISABLED)</span>
00834 <span class="preprocessor"></span>
<a name="l00835"></a><a class="code" href="../../d2/d9/miia64_8h.html#a132">00835</a> <span class="preprocessor">#define MI_SET_PTE_WRITE_COMBINE2(PTE)  \</span>
00836 <span class="preprocessor">    ((PTE).u.Hard.Cache = MM_PTE_CACHE_DISPLAY)</span>
00837 <span class="preprocessor"></span>
00838 
00839 <span class="comment">//++</span>
00840 <span class="comment">//VOID</span>
00841 <span class="comment">//MI_SET_PTE_DIRTY (</span>
00842 <span class="comment">//    IN MMPTE PTE</span>
00843 <span class="comment">//    );</span>
00844 <span class="comment">//</span>
00845 <span class="comment">// Routine Description:</span>
00846 <span class="comment">//</span>
00847 <span class="comment">//    This macro sets the dirty bit(s) in the specified PTE.</span>
00848 <span class="comment">//</span>
00849 <span class="comment">// Argments</span>
00850 <span class="comment">//</span>
00851 <span class="comment">//    PTE - Supplies the PTE to set dirty.</span>
00852 <span class="comment">//</span>
00853 <span class="comment">// Return Value:</span>
00854 <span class="comment">//</span>
00855 <span class="comment">//     None.</span>
00856 <span class="comment">//</span>
00857 <span class="comment">//--</span>
00858 
<a name="l00859"></a><a class="code" href="../../d2/d9/miia64_8h.html#a133">00859</a> <span class="preprocessor">#define MI_SET_PTE_DIRTY(PTE) (PTE).u.Hard.Dirty = 1</span>
00860 <span class="preprocessor"></span>
00861 
00862 <span class="comment">//++</span>
00863 <span class="comment">//VOID</span>
00864 <span class="comment">//MI_SET_PTE_CLEAN (</span>
00865 <span class="comment">//    IN MMPTE PTE</span>
00866 <span class="comment">//    );</span>
00867 <span class="comment">//</span>
00868 <span class="comment">// Routine Description:</span>
00869 <span class="comment">//</span>
00870 <span class="comment">//    This macro clears the dirty bit(s) in the specified PTE.</span>
00871 <span class="comment">//</span>
00872 <span class="comment">// Argments</span>
00873 <span class="comment">//</span>
00874 <span class="comment">//    PTE - Supplies the PTE to set clear.</span>
00875 <span class="comment">//</span>
00876 <span class="comment">// Return Value:</span>
00877 <span class="comment">//</span>
00878 <span class="comment">//     None.</span>
00879 <span class="comment">//</span>
00880 <span class="comment">//--</span>
00881 
<a name="l00882"></a><a class="code" href="../../d2/d9/miia64_8h.html#a134">00882</a> <span class="preprocessor">#define MI_SET_PTE_CLEAN(PTE) (PTE).u.Hard.Dirty = 0</span>
00883 <span class="preprocessor"></span>
00884 
00885 
00886 <span class="comment">//++</span>
00887 <span class="comment">//VOID</span>
00888 <span class="comment">//MI_IS_PTE_DIRTY (</span>
00889 <span class="comment">//    IN MMPTE PTE</span>
00890 <span class="comment">//    );</span>
00891 <span class="comment">//</span>
00892 <span class="comment">// Routine Description:</span>
00893 <span class="comment">//</span>
00894 <span class="comment">//    This macro checks the dirty bit(s) in the specified PTE.</span>
00895 <span class="comment">//</span>
00896 <span class="comment">// Argments</span>
00897 <span class="comment">//</span>
00898 <span class="comment">//    PTE - Supplies the PTE to check.</span>
00899 <span class="comment">//</span>
00900 <span class="comment">// Return Value:</span>
00901 <span class="comment">//</span>
00902 <span class="comment">//    TRUE if the page is dirty (modified), FALSE otherwise.</span>
00903 <span class="comment">//</span>
00904 <span class="comment">//--</span>
00905 
<a name="l00906"></a><a class="code" href="../../d2/d9/miia64_8h.html#a135">00906</a> <span class="preprocessor">#define MI_IS_PTE_DIRTY(PTE) ((PTE).u.Hard.Dirty != 0)</span>
00907 <span class="preprocessor"></span>
00908 
00909 
00910 <span class="comment">//++</span>
00911 <span class="comment">//VOID</span>
00912 <span class="comment">//MI_SET_GLOBAL_BIT_IF_SYSTEM (</span>
00913 <span class="comment">//    OUT OUTPTE,</span>
00914 <span class="comment">//    IN PPTE</span>
00915 <span class="comment">//    );</span>
00916 <span class="comment">//</span>
00917 <span class="comment">// Routine Description:</span>
00918 <span class="comment">//</span>
00919 <span class="comment">//    This macro sets the global bit if the pointer PTE is within</span>
00920 <span class="comment">//    system space.</span>
00921 <span class="comment">//</span>
00922 <span class="comment">// Argments</span>
00923 <span class="comment">//</span>
00924 <span class="comment">//    OUTPTE - Supplies the PTE in which to build the valid PTE.</span>
00925 <span class="comment">//</span>
00926 <span class="comment">//    PPTE - Supplies a pointer to the PTE becoming valid.</span>
00927 <span class="comment">//</span>
00928 <span class="comment">// Return Value:</span>
00929 <span class="comment">//</span>
00930 <span class="comment">//     None.</span>
00931 <span class="comment">//</span>
00932 <span class="comment">//--</span>
00933 
<a name="l00934"></a><a class="code" href="../../d2/d9/miia64_8h.html#a136">00934</a> <span class="preprocessor">#define MI_SET_GLOBAL_BIT_IF_SYSTEM(OUTPTE,PPTE)</span>
00935 <span class="preprocessor"></span>
00936 
00937 
00938 <span class="comment">//++</span>
00939 <span class="comment">//VOID</span>
00940 <span class="comment">//MI_SET_GLOBAL_STATE (</span>
00941 <span class="comment">//    IN MMPTE PTE,</span>
00942 <span class="comment">//    IN ULONG STATE</span>
00943 <span class="comment">//    );</span>
00944 <span class="comment">//</span>
00945 <span class="comment">// Routine Description:</span>
00946 <span class="comment">//</span>
00947 <span class="comment">//    This macro sets the global bit in the PTE. if the pointer PTE is within</span>
00948 <span class="comment">//</span>
00949 <span class="comment">// Argments</span>
00950 <span class="comment">//</span>
00951 <span class="comment">//    PTE - Supplies the PTE to set global state into.</span>
00952 <span class="comment">//</span>
00953 <span class="comment">//    STATE - Supplies 1 if global, 0 if not.</span>
00954 <span class="comment">//</span>
00955 <span class="comment">// Return Value:</span>
00956 <span class="comment">//</span>
00957 <span class="comment">//     None.</span>
00958 <span class="comment">//</span>
00959 <span class="comment">//--</span>
00960 
<a name="l00961"></a><a class="code" href="../../d2/d9/miia64_8h.html#a137">00961</a> <span class="preprocessor">#define MI_SET_GLOBAL_STATE(PTE,STATE)</span>
00962 <span class="preprocessor"></span>
00963 
00964 
00965 <span class="comment">//++</span>
00966 <span class="comment">//VOID</span>
00967 <span class="comment">//MI_ENABLE_CACHING (</span>
00968 <span class="comment">//    IN MMPTE PTE</span>
00969 <span class="comment">//    );</span>
00970 <span class="comment">//</span>
00971 <span class="comment">// Routine Description:</span>
00972 <span class="comment">//</span>
00973 <span class="comment">//    This macro takes a valid PTE and sets the caching state to be</span>
00974 <span class="comment">//    enabled.</span>
00975 <span class="comment">//</span>
00976 <span class="comment">// Argments</span>
00977 <span class="comment">//</span>
00978 <span class="comment">//    PTE - Supplies a valid PTE.</span>
00979 <span class="comment">//</span>
00980 <span class="comment">// Return Value:</span>
00981 <span class="comment">//</span>
00982 <span class="comment">//     None.</span>
00983 <span class="comment">//</span>
00984 <span class="comment">//--</span>
00985 
<a name="l00986"></a><a class="code" href="../../d2/d9/miia64_8h.html#a138">00986</a> <span class="preprocessor">#define MI_ENABLE_CACHING(PTE) ((PTE).u.Hard.Cache = MM_PTE_CACHE_ENABLED)</span>
00987 <span class="preprocessor"></span>
00988 
00989 
00990 <span class="comment">//++</span>
00991 <span class="comment">//VOID</span>
00992 <span class="comment">//MI_DISABLE_CACHING (</span>
00993 <span class="comment">//    IN MMPTE PTE</span>
00994 <span class="comment">//    );</span>
00995 <span class="comment">//</span>
00996 <span class="comment">// Routine Description:</span>
00997 <span class="comment">//</span>
00998 <span class="comment">//    This macro takes a valid PTE and sets the caching state to be</span>
00999 <span class="comment">//    disabled.</span>
01000 <span class="comment">//</span>
01001 <span class="comment">// Argments</span>
01002 <span class="comment">//</span>
01003 <span class="comment">//    PTE - Supplies a pointer to the valid PTE.</span>
01004 <span class="comment">//</span>
01005 <span class="comment">// Return Value:</span>
01006 <span class="comment">//</span>
01007 <span class="comment">//     None.</span>
01008 <span class="comment">//</span>
01009 <span class="comment">//--</span>
01010 
<a name="l01011"></a><a class="code" href="../../d2/d9/miia64_8h.html#a139">01011</a> <span class="preprocessor">#define MI_DISABLE_CACHING(PTE) ((PTE).u.Hard.Cache = MM_PTE_CACHE_DISABLED)</span>
01012 <span class="preprocessor"></span>
01013 
01014 
01015 
01016 <span class="comment">//++</span>
01017 <span class="comment">//BOOLEAN</span>
01018 <span class="comment">//MI_IS_CACHING_DISABLED (</span>
01019 <span class="comment">//    IN PMMPTE PPTE</span>
01020 <span class="comment">//    );</span>
01021 <span class="comment">//</span>
01022 <span class="comment">// Routine Description:</span>
01023 <span class="comment">//</span>
01024 <span class="comment">//    This macro takes a valid PTE and returns TRUE if caching is</span>
01025 <span class="comment">//    disabled.</span>
01026 <span class="comment">//</span>
01027 <span class="comment">// Argments</span>
01028 <span class="comment">//</span>
01029 <span class="comment">//    PPTE - Supplies a pointer to the valid PTE.</span>
01030 <span class="comment">//</span>
01031 <span class="comment">// Return Value:</span>
01032 <span class="comment">//</span>
01033 <span class="comment">//     TRUE if caching is disabled, FALSE if it is enabled.</span>
01034 <span class="comment">//</span>
01035 <span class="comment">//--</span>
01036 
<a name="l01037"></a><a class="code" href="../../d2/d9/miia64_8h.html#a140">01037</a> <span class="preprocessor">#define MI_IS_CACHING_DISABLED(PPTE) \</span>
01038 <span class="preprocessor">            ((PPTE)-&gt;u.Hard.Cache == MM_PTE_CACHE_DISABLED)</span>
01039 <span class="preprocessor"></span>
01040 
01041 
01042 <span class="comment">//++</span>
01043 <span class="comment">//VOID</span>
01044 <span class="comment">//MI_SET_PFN_DELETED (</span>
01045 <span class="comment">//    IN PMMPFN PPFN</span>
01046 <span class="comment">//    );</span>
01047 <span class="comment">//</span>
01048 <span class="comment">// Routine Description:</span>
01049 <span class="comment">//</span>
01050 <span class="comment">//    This macro takes a pointer to a PFN element and indicates that</span>
01051 <span class="comment">//    the PFN is no longer in use.</span>
01052 <span class="comment">//</span>
01053 <span class="comment">// Argments</span>
01054 <span class="comment">//</span>
01055 <span class="comment">//    PPTE - Supplies a pointer to the PFN element.</span>
01056 <span class="comment">//</span>
01057 <span class="comment">// Return Value:</span>
01058 <span class="comment">//</span>
01059 <span class="comment">//    none.</span>
01060 <span class="comment">//</span>
01061 <span class="comment">//--</span>
01062 
<a name="l01063"></a><a class="code" href="../../d2/d9/miia64_8h.html#a141">01063</a> <span class="preprocessor">#define MI_SET_PFN_DELETED(PPFN) (((PPFN)-&gt;PteAddress = (PMMPTE)((INT_PTR)(LONG)0xFFFFFFFF)))</span>
01064 <span class="preprocessor"></span>
01065 
01066 
01067 
01068 <span class="comment">//++</span>
01069 <span class="comment">//BOOLEAN</span>
01070 <span class="comment">//MI_IS_PFN_DELETED (</span>
01071 <span class="comment">//    IN PMMPFN PPFN</span>
01072 <span class="comment">//    );</span>
01073 <span class="comment">//</span>
01074 <span class="comment">// Routine Description:</span>
01075 <span class="comment">//</span>
01076 <span class="comment">//    This macro takes a pointer to a PFN element a determines if</span>
01077 <span class="comment">//    the PFN is no longer in use.</span>
01078 <span class="comment">//</span>
01079 <span class="comment">// Argments</span>
01080 <span class="comment">//</span>
01081 <span class="comment">//    PPTE - Supplies a pointer to the PFN element.</span>
01082 <span class="comment">//</span>
01083 <span class="comment">// Return Value:</span>
01084 <span class="comment">//</span>
01085 <span class="comment">//     TRUE if PFN is no longer used, FALSE if it is still being used.</span>
01086 <span class="comment">//</span>
01087 <span class="comment">//--</span>
01088 
<a name="l01089"></a><a class="code" href="../../d2/d9/miia64_8h.html#a142">01089</a> <span class="preprocessor">#define MI_IS_PFN_DELETED(PPFN)   \</span>
01090 <span class="preprocessor">            ((PPFN)-&gt;PteAddress == (PMMPTE)((INT_PTR)(LONG)0xFFFFFFFF))</span>
01091 <span class="preprocessor"></span>
01092 
01093 <span class="comment">//++</span>
01094 <span class="comment">//VOID</span>
01095 <span class="comment">//MI_CHECK_PAGE_ALIGNMENT (</span>
01096 <span class="comment">//    IN ULONG PAGE,</span>
01097 <span class="comment">//    IN PMMPTE PPTE</span>
01098 <span class="comment">//    );</span>
01099 <span class="comment">//</span>
01100 <span class="comment">// Routine Description:</span>
01101 <span class="comment">//</span>
01102 <span class="comment">//    This macro takes a PFN element number (Page) and checks to see</span>
01103 <span class="comment">//    if the virtual alignment for the previous address of the page</span>
01104 <span class="comment">//    is compatable with the new address of the page.  If they are</span>
01105 <span class="comment">//    not compatible, the D cache is flushed.</span>
01106 <span class="comment">//</span>
01107 <span class="comment">// Argments</span>
01108 <span class="comment">//</span>
01109 <span class="comment">//    PAGE - Supplies the PFN element.</span>
01110 <span class="comment">//    PPTE - Supplies a pointer to the new PTE which will contain the page.</span>
01111 <span class="comment">//</span>
01112 <span class="comment">// Return Value:</span>
01113 <span class="comment">//</span>
01114 <span class="comment">//    none.</span>
01115 <span class="comment">//</span>
01116 <span class="comment">//--</span>
01117 
01118 <span class="comment">// does nothing on MERCED.</span>
01119 
<a name="l01120"></a><a class="code" href="../../d2/d9/miia64_8h.html#a143">01120</a> <span class="preprocessor">#define MI_CHECK_PAGE_ALIGNMENT(PAGE,PPTE)</span>
01121 <span class="preprocessor"></span>
01122 
01123 
01124 
01125 <span class="comment">//++</span>
01126 <span class="comment">//VOID</span>
01127 <span class="comment">//MI_INITIALIZE_HYPERSPACE_MAP (</span>
01128 <span class="comment">//    VOID</span>
01129 <span class="comment">//    );</span>
01130 <span class="comment">//</span>
01131 <span class="comment">// Routine Description:</span>
01132 <span class="comment">//</span>
01133 <span class="comment">//    This macro initializes the PTEs reserved for double mapping within</span>
01134 <span class="comment">//    hyperspace.</span>
01135 <span class="comment">//</span>
01136 <span class="comment">// Argments</span>
01137 <span class="comment">//</span>
01138 <span class="comment">//    None.</span>
01139 <span class="comment">//</span>
01140 <span class="comment">// Return Value:</span>
01141 <span class="comment">//</span>
01142 <span class="comment">//    None.</span>
01143 <span class="comment">//</span>
01144 <span class="comment">//--</span>
01145 
01146 <span class="comment">// does nothing on MERCED.</span>
01147 
<a name="l01148"></a><a class="code" href="../../d2/d9/miia64_8h.html#a144">01148</a> <span class="preprocessor">#define MI_INITIALIZE_HYPERSPACE_MAP(INDEX)</span>
01149 <span class="preprocessor"></span>
01150 
01151 <span class="comment">//++</span>
01152 <span class="comment">//ULONG</span>
01153 <span class="comment">//MI_GET_PAGE_COLOR_FROM_PTE (</span>
01154 <span class="comment">//    IN PMMPTE PTEADDRESS</span>
01155 <span class="comment">//    );</span>
01156 <span class="comment">//</span>
01157 <span class="comment">// Routine Description:</span>
01158 <span class="comment">//</span>
01159 <span class="comment">//    This macro determines the pages color based on the PTE address</span>
01160 <span class="comment">//    that maps the page.</span>
01161 <span class="comment">//</span>
01162 <span class="comment">// Argments</span>
01163 <span class="comment">//</span>
01164 <span class="comment">//    PTEADDRESS - Supplies the PTE address the page is (or was) mapped at.</span>
01165 <span class="comment">//</span>
01166 <span class="comment">// Return Value:</span>
01167 <span class="comment">//</span>
01168 <span class="comment">//    The pages color.</span>
01169 <span class="comment">//</span>
01170 <span class="comment">//--</span>
01171 
<a name="l01172"></a><a class="code" href="../../d2/d9/miia64_8h.html#a145">01172</a> <span class="preprocessor">#define MI_GET_PAGE_COLOR_FROM_PTE(PTEADDRESS)  \</span>
01173 <span class="preprocessor">         ((ULONG)((MmSystemPageColor++) &amp; MmSecondaryColorMask))</span>
01174 <span class="preprocessor"></span>
01175 
01176 
01177 <span class="comment">//++</span>
01178 <span class="comment">//ULONG</span>
01179 <span class="comment">//MI_GET_PAGE_COLOR_FROM_VA (</span>
01180 <span class="comment">//    IN PVOID ADDRESS</span>
01181 <span class="comment">//    );</span>
01182 <span class="comment">//</span>
01183 <span class="comment">// Routine Description:</span>
01184 <span class="comment">//</span>
01185 <span class="comment">//    This macro determines the pages color based on the PTE address</span>
01186 <span class="comment">//    that maps the page.</span>
01187 <span class="comment">//</span>
01188 <span class="comment">// Argments</span>
01189 <span class="comment">//</span>
01190 <span class="comment">//    ADDRESS - Supplies the address the page is (or was) mapped at.</span>
01191 <span class="comment">//</span>
01192 <span class="comment">// Return Value:</span>
01193 <span class="comment">//</span>
01194 <span class="comment">//    The pages color.</span>
01195 <span class="comment">//</span>
01196 <span class="comment">//--</span>
01197 
01198 
<a name="l01199"></a><a class="code" href="../../d2/d9/miia64_8h.html#a146">01199</a> <span class="preprocessor">#define MI_GET_PAGE_COLOR_FROM_VA(ADDRESS)  \</span>
01200 <span class="preprocessor">         ((ULONG)((MmSystemPageColor++) &amp; MmSecondaryColorMask))</span>
01201 <span class="preprocessor"></span>
01202 
01203 <span class="comment">//++</span>
01204 <span class="comment">//ULONG</span>
01205 <span class="comment">//MI_GET_PAGE_COLOR_FROM_SESSION (</span>
01206 <span class="comment">//    IN PMM_SESSION_SPACE SessionSpace</span>
01207 <span class="comment">//    );</span>
01208 <span class="comment">//</span>
01209 <span class="comment">// Routine Description:</span>
01210 <span class="comment">//</span>
01211 <span class="comment">//    This macro determines the page's color based on the PTE address</span>
01212 <span class="comment">//    that maps the page.</span>
01213 <span class="comment">//</span>
01214 <span class="comment">// Arguments</span>
01215 <span class="comment">//</span>
01216 <span class="comment">//    SessionSpace - Supplies the session space the page will be mapped into.</span>
01217 <span class="comment">//</span>
01218 <span class="comment">// Return Value:</span>
01219 <span class="comment">//</span>
01220 <span class="comment">//    The page's color.</span>
01221 <span class="comment">//</span>
01222 <span class="comment">//--</span>
01223 
01224 
<a name="l01225"></a><a class="code" href="../../d2/d9/miia64_8h.html#a147">01225</a> <span class="preprocessor">#define MI_GET_PAGE_COLOR_FROM_SESSION(_SessionSpace)  \</span>
01226 <span class="preprocessor">         ((ULONG)((_SessionSpace-&gt;Color++) &amp; MmSecondaryColorMask))</span>
01227 <span class="preprocessor"></span>
01228 
01229 <span class="comment">//++</span>
01230 <span class="comment">//ULONG</span>
01231 <span class="comment">//MI_PAGE_COLOR_PTE_PROCESS (</span>
01232 <span class="comment">//    IN PCHAR COLOR,</span>
01233 <span class="comment">//    IN PMMPTE PTE</span>
01234 <span class="comment">//    );</span>
01235 <span class="comment">//</span>
01236 <span class="comment">// Routine Description:</span>
01237 <span class="comment">//</span>
01238 <span class="comment">//    This macro determines the pages color based on the PTE address</span>
01239 <span class="comment">//    that maps the page.</span>
01240 <span class="comment">//</span>
01241 <span class="comment">// Argments</span>
01242 <span class="comment">//</span>
01243 <span class="comment">//</span>
01244 <span class="comment">// Return Value:</span>
01245 <span class="comment">//</span>
01246 <span class="comment">//    The pages color.</span>
01247 <span class="comment">//</span>
01248 <span class="comment">//--</span>
01249 
01250 
<a name="l01251"></a><a class="code" href="../../d2/d9/miia64_8h.html#a148">01251</a> <span class="preprocessor">#define MI_PAGE_COLOR_PTE_PROCESS(PTE,COLOR)  \</span>
01252 <span class="preprocessor">         (ULONG)((ULONG_PTR)((*(COLOR))++) &amp; MmSecondaryColorMask)</span>
01253 <span class="preprocessor"></span>
01254 
01255 
01256 <span class="comment">//++</span>
01257 <span class="comment">//ULONG</span>
01258 <span class="comment">//MI_PAGE_COLOR_VA_PROCESS (</span>
01259 <span class="comment">//    IN PVOID ADDRESS,</span>
01260 <span class="comment">//    IN PEPROCESS COLOR</span>
01261 <span class="comment">//    );</span>
01262 <span class="comment">//</span>
01263 <span class="comment">// Routine Description:</span>
01264 <span class="comment">//</span>
01265 <span class="comment">//    This macro determines the pages color based on the PTE address</span>
01266 <span class="comment">//    that maps the page.</span>
01267 <span class="comment">//</span>
01268 <span class="comment">// Argments</span>
01269 <span class="comment">//</span>
01270 <span class="comment">//    ADDRESS - Supplies the address the page is (or was) mapped at.</span>
01271 <span class="comment">//</span>
01272 <span class="comment">// Return Value:</span>
01273 <span class="comment">//</span>
01274 <span class="comment">//    The pages color.</span>
01275 <span class="comment">//</span>
01276 <span class="comment">//--</span>
01277 
<a name="l01278"></a><a class="code" href="../../d2/d9/miia64_8h.html#a149">01278</a> <span class="preprocessor">#define MI_PAGE_COLOR_VA_PROCESS(ADDRESS,COLOR) \</span>
01279 <span class="preprocessor">         ((ULONG)((*(COLOR))++) &amp; MmSecondaryColorMask)</span>
01280 <span class="preprocessor"></span>
01281 
01282 
01283 <span class="comment">//++</span>
01284 <span class="comment">//ULONG</span>
01285 <span class="comment">//MI_GET_NEXT_COLOR (</span>
01286 <span class="comment">//    IN ULONG COLOR</span>
01287 <span class="comment">//    );</span>
01288 <span class="comment">//</span>
01289 <span class="comment">// Routine Description:</span>
01290 <span class="comment">//</span>
01291 <span class="comment">//    This macro returns the next color in the sequence.</span>
01292 <span class="comment">//</span>
01293 <span class="comment">// Argments</span>
01294 <span class="comment">//</span>
01295 <span class="comment">//    COLOR - Supplies the color to return the next of.</span>
01296 <span class="comment">//</span>
01297 <span class="comment">// Return Value:</span>
01298 <span class="comment">//</span>
01299 <span class="comment">//    Next color in sequence.</span>
01300 <span class="comment">//</span>
01301 <span class="comment">//--</span>
01302 
<a name="l01303"></a><a class="code" href="../../d2/d9/miia64_8h.html#a150">01303</a> <span class="preprocessor">#define MI_GET_NEXT_COLOR(COLOR)  ((COLOR + 1) &amp; MM_COLOR_MASK)</span>
01304 <span class="preprocessor"></span>
01305 
01306 <span class="comment">//++</span>
01307 <span class="comment">//ULONG</span>
01308 <span class="comment">//MI_GET_PREVIOUS_COLOR (</span>
01309 <span class="comment">//    IN ULONG COLOR</span>
01310 <span class="comment">//    );</span>
01311 <span class="comment">//</span>
01312 <span class="comment">// Routine Description:</span>
01313 <span class="comment">//</span>
01314 <span class="comment">//    This macro returns the previous color in the sequence.</span>
01315 <span class="comment">//</span>
01316 <span class="comment">// Argments</span>
01317 <span class="comment">//</span>
01318 <span class="comment">//    COLOR - Supplies the color to return the previous of.</span>
01319 <span class="comment">//</span>
01320 <span class="comment">// Return Value:</span>
01321 <span class="comment">//</span>
01322 <span class="comment">//    Previous color in sequence.</span>
01323 <span class="comment">//</span>
01324 <span class="comment">//--</span>
01325 
<a name="l01326"></a><a class="code" href="../../d2/d9/miia64_8h.html#a151">01326</a> <span class="preprocessor">#define MI_GET_PREVIOUS_COLOR(COLOR)  (0)</span>
01327 <span class="preprocessor"></span>
01328 
<a name="l01329"></a><a class="code" href="../../d2/d9/miia64_8h.html#a152">01329</a> <span class="preprocessor">#define MI_GET_SECONDARY_COLOR(PAGE,PFN) ((ULONG)(PAGE &amp; MmSecondaryColorMask))</span>
01330 <span class="preprocessor"></span>
01331 
<a name="l01332"></a><a class="code" href="../../d2/d9/miia64_8h.html#a153">01332</a> <span class="preprocessor">#define MI_GET_COLOR_FROM_SECONDARY(SECONDARY_COLOR) (0)</span>
01333 <span class="preprocessor"></span>
01334 
01335 <span class="comment">//++</span>
01336 <span class="comment">//VOID</span>
01337 <span class="comment">//MI_GET_MODIFIED_PAGE_BY_COLOR (</span>
01338 <span class="comment">//    OUT ULONG PAGE,</span>
01339 <span class="comment">//    IN ULONG COLOR</span>
01340 <span class="comment">//    );</span>
01341 <span class="comment">//</span>
01342 <span class="comment">// Routine Description:</span>
01343 <span class="comment">//</span>
01344 <span class="comment">//    This macro returns the first page destined for a paging</span>
01345 <span class="comment">//    file with the desired color.  It does NOT remove the page</span>
01346 <span class="comment">//    from its list.</span>
01347 <span class="comment">//</span>
01348 <span class="comment">// Argments</span>
01349 <span class="comment">//</span>
01350 <span class="comment">//    PAGE - Returns the page located, the value MM_EMPTY_LIST is</span>
01351 <span class="comment">//           returned if there is no page of the specified color.</span>
01352 <span class="comment">//</span>
01353 <span class="comment">//    COLOR - Supplies the color of page to locate.</span>
01354 <span class="comment">//</span>
01355 <span class="comment">// Return Value:</span>
01356 <span class="comment">//</span>
01357 <span class="comment">//    none.</span>
01358 <span class="comment">//</span>
01359 <span class="comment">//--</span>
01360 
<a name="l01361"></a><a class="code" href="../../d2/d9/miia64_8h.html#a154">01361</a> <span class="preprocessor">#define MI_GET_MODIFIED_PAGE_BY_COLOR(PAGE,COLOR) \</span>
01362 <span class="preprocessor">            PAGE = MmModifiedPageListByColor[COLOR].Flink</span>
01363 <span class="preprocessor"></span>
01364 
01365 <span class="comment">//++</span>
01366 <span class="comment">//VOID</span>
01367 <span class="comment">//MI_GET_MODIFIED_PAGE_ANY_COLOR (</span>
01368 <span class="comment">//    OUT ULONG PAGE,</span>
01369 <span class="comment">//    IN OUT ULONG COLOR</span>
01370 <span class="comment">//    );</span>
01371 <span class="comment">//</span>
01372 <span class="comment">// Routine Description:</span>
01373 <span class="comment">//</span>
01374 <span class="comment">//    This macro returns the first page destined for a paging</span>
01375 <span class="comment">//    file with the desired color.  If not page of the desired</span>
01376 <span class="comment">//    color exists, all colored lists are searched for a page.</span>
01377 <span class="comment">//    It does NOT remove the page from its list.</span>
01378 <span class="comment">//</span>
01379 <span class="comment">// Argments</span>
01380 <span class="comment">//</span>
01381 <span class="comment">//    PAGE - Returns the page located, the value MM_EMPTY_LIST is</span>
01382 <span class="comment">//           returned if there is no page of the specified color.</span>
01383 <span class="comment">//</span>
01384 <span class="comment">//    COLOR - Supplies the color of page to locate and returns the</span>
01385 <span class="comment">//            color of the page located.</span>
01386 <span class="comment">//</span>
01387 <span class="comment">// Return Value:</span>
01388 <span class="comment">//</span>
01389 <span class="comment">//    none.</span>
01390 <span class="comment">//</span>
01391 <span class="comment">//--</span>
01392 
<a name="l01393"></a><a class="code" href="../../d2/d9/miia64_8h.html#a155">01393</a> <span class="preprocessor">#define MI_GET_MODIFIED_PAGE_ANY_COLOR(PAGE,COLOR) \</span>
01394 <span class="preprocessor">            {                                                                \</span>
01395 <span class="preprocessor">                if (MmTotalPagesForPagingFile == 0) {                        \</span>
01396 <span class="preprocessor">                    PAGE = MM_EMPTY_LIST;                                    \</span>
01397 <span class="preprocessor">                } else {                                                     \</span>
01398 <span class="preprocessor">                    PAGE = MmModifiedPageListByColor[COLOR].Flink;           \</span>
01399 <span class="preprocessor">                }                                                            \</span>
01400 <span class="preprocessor">            }</span>
01401 <span class="preprocessor"></span>
01402 
01403 
01404 <span class="comment">//++</span>
01405 <span class="comment">//VOID</span>
01406 <span class="comment">//MI_MAKE_VALID_PTE_WRITE_COPY (</span>
01407 <span class="comment">//    IN OUT PMMPTE PTE</span>
01408 <span class="comment">//    );</span>
01409 <span class="comment">//</span>
01410 <span class="comment">// Routine Description:</span>
01411 <span class="comment">//</span>
01412 <span class="comment">//    This macro checks to see if the PTE indicates that the</span>
01413 <span class="comment">//    page is writable and if so it clears the write bit and</span>
01414 <span class="comment">//    sets the copy-on-write bit.</span>
01415 <span class="comment">//</span>
01416 <span class="comment">// Argments</span>
01417 <span class="comment">//</span>
01418 <span class="comment">//    PTE - Supplies the PTE to operate upon.</span>
01419 <span class="comment">//</span>
01420 <span class="comment">// Return Value:</span>
01421 <span class="comment">//</span>
01422 <span class="comment">//     None.</span>
01423 <span class="comment">//</span>
01424 <span class="comment">//--</span>
01425 
<a name="l01426"></a><a class="code" href="../../d2/d9/miia64_8h.html#a156">01426</a> <span class="preprocessor">#define MI_MAKE_VALID_PTE_WRITE_COPY(PPTE) \</span>
01427 <span class="preprocessor">                    if ((PPTE)-&gt;u.Hard.Write == 1) {    \</span>
01428 <span class="preprocessor">                        (PPTE)-&gt;u.Hard.CopyOnWrite = 1; \</span>
01429 <span class="preprocessor">                        (PPTE)-&gt;u.Hard.Write = 0;       \</span>
01430 <span class="preprocessor">                    }</span>
01431 <span class="preprocessor"></span>
01432 
01433 <span class="comment">//++</span>
01434 <span class="comment">//ULONG</span>
01435 <span class="comment">//MI_DETERMINE_OWNER (</span>
01436 <span class="comment">//    IN MMPTE PPTE</span>
01437 <span class="comment">//    );</span>
01438 <span class="comment">//</span>
01439 <span class="comment">// Routine Description:</span>
01440 <span class="comment">//</span>
01441 <span class="comment">//    This macro examines the virtual address of the PTE and determines</span>
01442 <span class="comment">//    if the PTE resides in system space or user space.</span>
01443 <span class="comment">//</span>
01444 <span class="comment">// Argments</span>
01445 <span class="comment">//</span>
01446 <span class="comment">//    PTE - Supplies the PTE to operate upon.</span>
01447 <span class="comment">//</span>
01448 <span class="comment">// Return Value:</span>
01449 <span class="comment">//</span>
01450 <span class="comment">//     3 if the owner is USER_MODE, 0 if the owner is KERNEL_MODE.</span>
01451 <span class="comment">//</span>
01452 <span class="comment">//--</span>
01453 
01454 <span class="preprocessor">#if defined(_MIALT4K_)</span>
01455 <span class="preprocessor"></span>
<a name="l01456"></a><a class="code" href="../../d2/d9/miia64_8h.html#a157">01456</a> <span class="preprocessor">#define MI_DETERMINE_OWNER(PPTE)   \</span>
01457 <span class="preprocessor">     ((((((PPTE) &gt;= (PMMPTE)PTE_UBASE) &amp;&amp; ((PPTE) &lt;= MiHighestUserPte))) || \</span>
01458 <span class="preprocessor">       (MI_IS_ALT_PAGE_TABLE_ADDRESS(PPTE))) ? 3 : 0)</span>
01459 <span class="preprocessor"></span>
01460 <span class="preprocessor">#else</span>
01461 <span class="preprocessor"></span>
01462 <span class="preprocessor">#define MI_DETERMINE_OWNER(PPTE)   \</span>
01463 <span class="preprocessor">    ((((PPTE) &gt;= (PMMPTE)PTE_UBASE) &amp;&amp; \</span>
01464 <span class="preprocessor">      ((PPTE) &lt;= MiHighestUserPte)) ? 3 : 0)</span>
01465 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
01466 <span class="preprocessor"></span>
01467 
01468 <span class="comment">//++</span>
01469 <span class="comment">//VOID</span>
01470 <span class="comment">//MI_SET_ACCESSED_IN_PTE (</span>
01471 <span class="comment">//    IN OUT MMPTE PPTE</span>
01472 <span class="comment">//    );</span>
01473 <span class="comment">//</span>
01474 <span class="comment">// Routine Description:</span>
01475 <span class="comment">//</span>
01476 <span class="comment">//    This macro sets the ACCESSED field in the PTE.</span>
01477 <span class="comment">//</span>
01478 <span class="comment">// Argments</span>
01479 <span class="comment">//</span>
01480 <span class="comment">//    PTE - Supplies the PTE to operate upon.</span>
01481 <span class="comment">//</span>
01482 <span class="comment">// Return Value:</span>
01483 <span class="comment">//</span>
01484 <span class="comment">//     1 if the owner is USER_MODE, 0 if the owner is KERNEL_MODE.</span>
01485 <span class="comment">//</span>
01486 <span class="comment">//--</span>
01487 
<a name="l01488"></a><a class="code" href="../../d2/d9/miia64_8h.html#a158">01488</a> <span class="preprocessor">#define MI_SET_ACCESSED_IN_PTE(PPTE,ACCESSED)</span>
01489 <span class="preprocessor"></span>
01490 
01491 
01492 <span class="comment">//++</span>
01493 <span class="comment">//ULONG</span>
01494 <span class="comment">//MI_GET_ACCESSED_IN_PTE (</span>
01495 <span class="comment">//    IN OUT MMPTE PPTE</span>
01496 <span class="comment">//    );</span>
01497 <span class="comment">//</span>
01498 <span class="comment">// Routine Description:</span>
01499 <span class="comment">//</span>
01500 <span class="comment">//    This macro returns the state of the ACCESSED field in the PTE.</span>
01501 <span class="comment">//</span>
01502 <span class="comment">// Argments</span>
01503 <span class="comment">//</span>
01504 <span class="comment">//    PTE - Supplies the PTE to operate upon.</span>
01505 <span class="comment">//</span>
01506 <span class="comment">// Return Value:</span>
01507 <span class="comment">//</span>
01508 <span class="comment">//     The state of the ACCESSED field.</span>
01509 <span class="comment">//</span>
01510 <span class="comment">//--</span>
01511 
<a name="l01512"></a><a class="code" href="../../d2/d9/miia64_8h.html#a159">01512</a> <span class="preprocessor">#define MI_GET_ACCESSED_IN_PTE(PPTE) 0</span>
01513 <span class="preprocessor"></span>
01514 
01515 
01516 <span class="comment">//++</span>
01517 <span class="comment">//VOID</span>
01518 <span class="comment">//MI_SET_OWNER_IN_PTE (</span>
01519 <span class="comment">//    IN PMMPTE PPTE</span>
01520 <span class="comment">//    IN ULONG OWNER</span>
01521 <span class="comment">//    );</span>
01522 <span class="comment">//</span>
01523 <span class="comment">// Routine Description:</span>
01524 <span class="comment">//</span>
01525 <span class="comment">//    This macro sets the owner field in the PTE.</span>
01526 <span class="comment">//</span>
01527 <span class="comment">// Argments</span>
01528 <span class="comment">//</span>
01529 <span class="comment">//    PTE - Supplies the PTE to operate upon.</span>
01530 <span class="comment">//</span>
01531 <span class="comment">// Return Value:</span>
01532 <span class="comment">//</span>
01533 <span class="comment">//    None.</span>
01534 <span class="comment">//</span>
01535 <span class="comment">//--</span>
01536 
<a name="l01537"></a><a class="code" href="../../d2/d9/miia64_8h.html#a160">01537</a> <span class="preprocessor">#define MI_SET_OWNER_IN_PTE(PPTE,OWNER)</span>
01538 <span class="preprocessor"></span>
01539 
01540 
01541 
01542 <span class="comment">//++</span>
01543 <span class="comment">//ULONG</span>
01544 <span class="comment">//MI_GET_OWNER_IN_PTE (</span>
01545 <span class="comment">//    IN PMMPTE PPTE</span>
01546 <span class="comment">//    );</span>
01547 <span class="comment">//</span>
01548 <span class="comment">// Routine Description:</span>
01549 <span class="comment">//</span>
01550 <span class="comment">//    This macro gets the owner field from the PTE.</span>
01551 <span class="comment">//</span>
01552 <span class="comment">// Argments</span>
01553 <span class="comment">//</span>
01554 <span class="comment">//    PTE - Supplies the PTE to operate upon.</span>
01555 <span class="comment">//</span>
01556 <span class="comment">// Return Value:</span>
01557 <span class="comment">//</span>
01558 <span class="comment">//     The state of the OWNER field.</span>
01559 <span class="comment">//</span>
01560 <span class="comment">//--</span>
01561 
<a name="l01562"></a><a class="code" href="../../d2/d9/miia64_8h.html#a161">01562</a> <span class="preprocessor">#define MI_GET_OWNER_IN_PTE(PPTE) KernelMode</span>
01563 <span class="preprocessor"></span>
01564 
01565 
01566 <span class="comment">//</span>
01567 <span class="comment">// bit mask to clear out fields in a PTE to or in prototype pte offset.</span>
01568 <span class="comment">//</span>
01569 
<a name="l01570"></a><a class="code" href="../../d2/d9/miia64_8h.html#a162">01570</a> <span class="preprocessor">#define CLEAR_FOR_PROTO_PTE_ADDRESS ((ULONG)0x701)</span>
01571 <span class="preprocessor"></span>
01572 <span class="comment">//</span>
01573 <span class="comment">// bit mask to clear out fields in a PTE to or in paging file location.</span>
01574 <span class="comment">//</span>
01575 
<a name="l01576"></a><a class="code" href="../../d2/d9/miia64_8h.html#a163">01576</a> <span class="preprocessor">#define CLEAR_FOR_PAGE_FILE 0x000003E0</span>
01577 <span class="preprocessor"></span>
01578 
01579 <span class="comment">//++</span>
01580 <span class="comment">//VOID</span>
01581 <span class="comment">//MI_SET_PAGING_FILE_INFO (</span>
01582 <span class="comment">//    OUT MMPTE OUTPTE,</span>
01583 <span class="comment">//    IN MMPTE PPTE,</span>
01584 <span class="comment">//    IN ULONG FILEINFO,</span>
01585 <span class="comment">//    IN ULONG OFFSET</span>
01586 <span class="comment">//    );</span>
01587 <span class="comment">//</span>
01588 <span class="comment">// Routine Description:</span>
01589 <span class="comment">//</span>
01590 <span class="comment">//    This macro sets into the specified PTE the supplied information</span>
01591 <span class="comment">//    to indicate where the backing store for the page is located.</span>
01592 <span class="comment">//</span>
01593 <span class="comment">// Argments</span>
01594 <span class="comment">//</span>
01595 <span class="comment">//    OUTPTE - Supplies the PTE in which to store the result.</span>
01596 <span class="comment">//</span>
01597 <span class="comment">//    PTE - Supplies the PTE to operate upon.</span>
01598 <span class="comment">//</span>
01599 <span class="comment">//    FILEINFO - Supplies the number of the paging file.</span>
01600 <span class="comment">//</span>
01601 <span class="comment">//    OFFSET - Supplies the offset into the paging file.</span>
01602 <span class="comment">//</span>
01603 <span class="comment">// Return Value:</span>
01604 <span class="comment">//</span>
01605 <span class="comment">//    None.</span>
01606 <span class="comment">//</span>
01607 <span class="comment">//--</span>
01608 
<a name="l01609"></a><a class="code" href="../../d2/d9/miia64_8h.html#a164">01609</a> <span class="preprocessor">#define MI_SET_PAGING_FILE_INFO(OUTPTE,PTE,FILEINFO,OFFSET) \</span>
01610 <span class="preprocessor">        (OUTPTE).u.Long = (((PTE).u.Soft.Protection &lt;&lt; MM_PROTECT_FIELD_SHIFT) | \</span>
01611 <span class="preprocessor">         ((ULONGLONG)(FILEINFO) &lt;&lt; _MM_PAGING_FILE_LOW_SHIFT) | \</span>
01612 <span class="preprocessor">         ((ULONGLONG)(OFFSET) &lt;&lt; _MM_PAGING_FILE_HIGH_SHIFT));</span>
01613 <span class="preprocessor"></span>
01614 
01615 <span class="comment">//++</span>
01616 <span class="comment">//PMMPTE</span>
01617 <span class="comment">//MiPteToProto (</span>
01618 <span class="comment">//    IN OUT MMPTE PPTE,</span>
01619 <span class="comment">//    IN ULONG FILEINFO,</span>
01620 <span class="comment">//    IN ULONG OFFSET</span>
01621 <span class="comment">//    );</span>
01622 <span class="comment">//</span>
01623 <span class="comment">// Routine Description:</span>
01624 <span class="comment">//</span>
01625 <span class="comment">//   This macro returns the address of the corresponding prototype which</span>
01626 <span class="comment">//   was encoded earlier into the supplied PTE.</span>
01627 <span class="comment">//</span>
01628 <span class="comment">//    NOTE THAT AS PROTOPTE CAN ONLY RESIDE IN PAGED POOL!!!!!!</span>
01629 <span class="comment">//</span>
01630 <span class="comment">//    MAX SIZE = 2^(2+7+21) = 2^30 = 1GB.</span>
01631 <span class="comment">//</span>
01632 <span class="comment">//    NOTE, that the valid bit must be zero!</span>
01633 <span class="comment">//</span>
01634 <span class="comment">// Argments</span>
01635 <span class="comment">//</span>
01636 <span class="comment">//    lpte - Supplies the PTE to operate upon.</span>
01637 <span class="comment">//</span>
01638 <span class="comment">// Return Value:</span>
01639 <span class="comment">//</span>
01640 <span class="comment">//    Pointer to the prototype PTE that backs this PTE.</span>
01641 <span class="comment">//</span>
01642 <span class="comment">//--</span>
01643 
01644 
<a name="l01645"></a><a class="code" href="../../d2/d9/miia64_8h.html#a165">01645</a> <span class="preprocessor">#define MiPteToProto(lpte) \</span>
01646 <span class="preprocessor">            ((PMMPTE) ((ULONG_PTR)((lpte)-&gt;u.Proto.ProtoAddress) + MmProtopte_Base))</span>
01647 <span class="preprocessor"></span>
01648 <span class="comment">//++</span>
01649 <span class="comment">//ULONG_PTR</span>
01650 <span class="comment">//MiProtoAddressForPte (</span>
01651 <span class="comment">//    IN PMMPTE proto_va</span>
01652 <span class="comment">//    );</span>
01653 <span class="comment">//</span>
01654 <span class="comment">// Routine Description:</span>
01655 <span class="comment">//</span>
01656 <span class="comment">//    This macro sets into the specified PTE the supplied information</span>
01657 <span class="comment">//    to indicate where the backing store for the page is located.</span>
01658 <span class="comment">//    MiProtoAddressForPte returns the bit field to OR into the PTE to</span>
01659 <span class="comment">//    reference a prototype PTE.  And set the protoPTE bit,</span>
01660 <span class="comment">//    MM_PTE_PROTOTYPE_MASK.</span>
01661 <span class="comment">//</span>
01662 <span class="comment">// Argments</span>
01663 <span class="comment">//</span>
01664 <span class="comment">//    proto_va - Supplies the address of the prototype PTE.</span>
01665 <span class="comment">//</span>
01666 <span class="comment">// Return Value:</span>
01667 <span class="comment">//</span>
01668 <span class="comment">//    Mask to set into the PTE.</span>
01669 <span class="comment">//</span>
01670 <span class="comment">//--</span>
01671 
<a name="l01672"></a><a class="code" href="../../d2/d9/miia64_8h.html#a166">01672</a> <span class="preprocessor">#define MiProtoAddressForPte(proto_va)  \</span>
01673 <span class="preprocessor">        (( (ULONGLONG)((ULONG_PTR)proto_va - MmProtopte_Base) &lt;&lt;  \</span>
01674 <span class="preprocessor">          (_MM_PROTO_ADDRESS_SHIFT)) | MM_PTE_PROTOTYPE_MASK)</span>
01675 <span class="preprocessor"></span>
<a name="l01676"></a><a class="code" href="../../d2/d9/miia64_8h.html#a167">01676</a> <span class="preprocessor">#define MISetProtoAddressForPte(PTE, proto_va) \</span>
01677 <span class="preprocessor">        (PTE).u.Long = 0;                      \</span>
01678 <span class="preprocessor">        (PTE).u.Proto.Prototype = 1;           \</span>
01679 <span class="preprocessor">        (PTE).u.Proto.ProtoAddress = (ULONG_PTR)proto_va - MmProtopte_Base;</span>
01680 <span class="preprocessor"></span>
01681 
01682 <span class="comment">//++</span>
01683 <span class="comment">//ULONG_PTR</span>
01684 <span class="comment">//MiProtoAddressForKernelPte (</span>
01685 <span class="comment">//    IN PMMPTE proto_va</span>
01686 <span class="comment">//    );</span>
01687 <span class="comment">//</span>
01688 <span class="comment">// Routine Description:</span>
01689 <span class="comment">//</span>
01690 <span class="comment">//    This macro sets into the specified PTE the supplied information</span>
01691 <span class="comment">//    to indicate where the backing store for the page is located.</span>
01692 <span class="comment">//    MiProtoAddressForPte returns the bit field to OR into the PTE to</span>
01693 <span class="comment">//    reference a prototype PTE.  And set the protoPTE bit,</span>
01694 <span class="comment">//    MM_PTE_PROTOTYPE_MASK.</span>
01695 <span class="comment">//</span>
01696 <span class="comment">//    This macro also sets any other information (such as global bits)</span>
01697 <span class="comment">//    required for kernel mode PTEs.</span>
01698 <span class="comment">//</span>
01699 <span class="comment">// Argments</span>
01700 <span class="comment">//</span>
01701 <span class="comment">//    proto_va - Supplies the address of the prototype PTE.</span>
01702 <span class="comment">//</span>
01703 <span class="comment">// Return Value:</span>
01704 <span class="comment">//</span>
01705 <span class="comment">//    Mask to set into the PTE.</span>
01706 <span class="comment">//</span>
01707 <span class="comment">//--</span>
01708 
01709 <span class="comment">//  not different on x86.</span>
01710 
<a name="l01711"></a><a class="code" href="../../d2/d9/miia64_8h.html#a168">01711</a> <span class="preprocessor">#define MiProtoAddressForKernelPte(proto_va)  MiProtoAddressForPte(proto_va)</span>
01712 <span class="preprocessor"></span>
01713 
<a name="l01714"></a><a class="code" href="../../d2/d9/miia64_8h.html#a169">01714</a> <span class="preprocessor">#define MM_SUBSECTION_MAP (128*1024*1024)</span>
01715 <span class="preprocessor"></span>
01716 <span class="comment">//++</span>
01717 <span class="comment">//PSUBSECTION</span>
01718 <span class="comment">//MiGetSubsectionAddress (</span>
01719 <span class="comment">//    IN PMMPTE lpte</span>
01720 <span class="comment">//    );</span>
01721 <span class="comment">//</span>
01722 <span class="comment">// Routine Description:</span>
01723 <span class="comment">//</span>
01724 <span class="comment">//   This macro takes a PTE and returns the address of the subsection that</span>
01725 <span class="comment">//   the PTE refers to.  Subsections are quadword structures allocated</span>
01726 <span class="comment">//   from nonpaged pool.</span>
01727 <span class="comment">//</span>
01728 <span class="comment">//   NOTE THIS MACRO LIMITS THE SIZE OF NONPAGED POOL!</span>
01729 <span class="comment">//    MAXIMUM NONPAGED POOL = 2^(3+4+21) = 2^28 = 256mb.</span>
01730 <span class="comment">//</span>
01731 <span class="comment">//</span>
01732 <span class="comment">// Argments</span>
01733 <span class="comment">//</span>
01734 <span class="comment">//    lpte - Supplies the PTE to operate upon.</span>
01735 <span class="comment">//</span>
01736 <span class="comment">// Return Value:</span>
01737 <span class="comment">//</span>
01738 <span class="comment">//    A pointer to the subsection referred to by the supplied PTE.</span>
01739 <span class="comment">//</span>
01740 <span class="comment">//--</span>
01741 
<a name="l01742"></a><a class="code" href="../../d2/d9/miia64_8h.html#a170">01742</a> <span class="preprocessor">#define MiGetSubsectionAddress(lpte)                              \</span>
01743 <span class="preprocessor">    (((lpte)-&gt;u.Subsect.WhichPool == 1) ?                              \</span>
01744 <span class="preprocessor">     ((PSUBSECTION)((ULONG_PTR)MmSubsectionBase +    \</span>
01745 <span class="preprocessor">                    ((ULONG_PTR)(lpte)-&gt;u.Subsect.SubsectionAddress))) \</span>
01746 <span class="preprocessor">     : \</span>
01747 <span class="preprocessor">     ((PSUBSECTION)((ULONG_PTR)MM_NONPAGED_POOL_END -    \</span>
01748 <span class="preprocessor">                    ((ULONG_PTR)(lpte)-&gt;u.Subsect.SubsectionAddress))))</span>
01749 <span class="preprocessor"></span>
01750 <span class="comment">//++</span>
01751 <span class="comment">//ULONGLONG</span>
01752 <span class="comment">//MiGetSubsectionAddressForPte (</span>
01753 <span class="comment">//    IN PSUBSECTION VA</span>
01754 <span class="comment">//    );</span>
01755 <span class="comment">//</span>
01756 <span class="comment">// Routine Description:</span>
01757 <span class="comment">//</span>
01758 <span class="comment">//    This macro takes the address of a subsection and encodes it for use</span>
01759 <span class="comment">//    in a PTE.</span>
01760 <span class="comment">//</span>
01761 <span class="comment">//    NOTE - THE SUBSECTION ADDRESS MUST BE QUADWORD ALIGNED!</span>
01762 <span class="comment">//</span>
01763 <span class="comment">// Argments</span>
01764 <span class="comment">//</span>
01765 <span class="comment">//    VA - Supplies a pointer to the subsection to encode.</span>
01766 <span class="comment">//</span>
01767 <span class="comment">// Return Value:</span>
01768 <span class="comment">//</span>
01769 <span class="comment">//     The mask to set into the PTE to make it reference the supplied</span>
01770 <span class="comment">//     subsetion.</span>
01771 <span class="comment">//</span>
01772 <span class="comment">//--</span>
01773 
<a name="l01774"></a><a class="code" href="../../d2/d9/miia64_8h.html#a171">01774</a> <span class="preprocessor">#define MiGetSubsectionAddressForPte(VA)                   \</span>
01775 <span class="preprocessor">   ( ((ULONG_PTR)(VA) &lt; (ULONG_PTR)KSEG2_BASE) ?                  \</span>
01776 <span class="preprocessor">     ( ((ULONGLONG)((ULONG_PTR)VA - (ULONG_PTR)MmSubsectionBase) \</span>
01777 <span class="preprocessor">          &lt;&lt; (_MM_PTE_SUBSECTION_ADDRESS_SHIFT)) | 0x80) \</span>
01778 <span class="preprocessor">     : \</span>
01779 <span class="preprocessor">       ((ULONGLONG)((ULONG_PTR)MM_NONPAGED_POOL_END - (ULONG_PTR)VA) \</span>
01780 <span class="preprocessor">          &lt;&lt; (_MM_PTE_SUBSECTION_ADDRESS_SHIFT)) )</span>
01781 <span class="preprocessor"></span>
<a name="l01782"></a><a class="code" href="../../d2/d9/miia64_8h.html#a172">01782</a> <span class="preprocessor">#define MiSetSubsectionAddressForPte(PTE, VA)  \</span>
01783 <span class="preprocessor">   (PTE).u.Long = 0;                          \</span>
01784 <span class="preprocessor">   if ((ULONG_PTR)(VA) &lt; (ULONG_PTR)KSEG2_BASE) { \</span>
01785 <span class="preprocessor">       (PTE).u.Subsect.SubsectionAddress = (ULONG_PTR)VA - (ULONG_PTR)MmSubsectionBase; \</span>
01786 <span class="preprocessor">       (PTE).u.Subsect.WhichPool = 1;  \</span>
01787 <span class="preprocessor">   } else { \</span>
01788 <span class="preprocessor">       (PTE).u.Subsect.SubsectionAddress = (ULONG_PTR)MM_NONPAGED_POOL_END - (ULONG_PTR)VA; \</span>
01789 <span class="preprocessor">   }</span>
01790 <span class="preprocessor"></span>
01791 <span class="comment">//++</span>
01792 <span class="comment">//ULONG</span>
01793 <span class="comment">//MiGetPpeOffset (</span>
01794 <span class="comment">//    IN PVOID va</span>
01795 <span class="comment">//    );</span>
01796 <span class="comment">//</span>
01797 <span class="comment">// Routine Description:</span>
01798 <span class="comment">//</span>
01799 <span class="comment">//    MiGetPpeOffset returns the offset into a page root</span>
01800 <span class="comment">//    for a given virtual address.</span>
01801 <span class="comment">//</span>
01802 <span class="comment">// Arguments</span>
01803 <span class="comment">//</span>
01804 <span class="comment">//    Va - Supplies the virtual address to locate the offset for.</span>
01805 <span class="comment">//</span>
01806 <span class="comment">// Return Value:</span>
01807 <span class="comment">//</span>
01808 <span class="comment">//    The offset into the page root table the corresponding PPE is at.</span>
01809 <span class="comment">//</span>
01810 <span class="comment">//    LWFIX: expand for 3-level</span>
01811 <span class="comment">//</span>
01812 <span class="comment">//--</span>
01813 
<a name="l01814"></a><a class="code" href="../../d2/d9/miia64_8h.html#a173">01814</a> <span class="preprocessor">#define MiGetPpeOffset(va) ((ULONG)(((ULONG_PTR)(va) &gt;&gt; PDI1_SHIFT) &amp; PDI_MASK))</span>
01815 <span class="preprocessor"></span>
01816 <span class="comment">//++</span>
01817 <span class="comment">//ULONG_PTR</span>
01818 <span class="comment">//MiGetPdeOffset (</span>
01819 <span class="comment">//    IN PVOID va</span>
01820 <span class="comment">//    );</span>
01821 <span class="comment">//</span>
01822 <span class="comment">// Routine Description:</span>
01823 <span class="comment">//</span>
01824 <span class="comment">//    MiGetPdeOffset returns the offset into a page directory</span>
01825 <span class="comment">//    for a given virtual address.</span>
01826 <span class="comment">//</span>
01827 <span class="comment">// Argments</span>
01828 <span class="comment">//</span>
01829 <span class="comment">//    Va - Supplies the virtual address to locate the offset for.</span>
01830 <span class="comment">//</span>
01831 <span class="comment">// Return Value:</span>
01832 <span class="comment">//</span>
01833 <span class="comment">//    The offset into the page directory table the corresponding PDE is at.</span>
01834 <span class="comment">//</span>
01835 <span class="comment">//--</span>
01836 
<a name="l01837"></a><a class="code" href="../../d2/d9/miia64_8h.html#a174">01837</a> <span class="preprocessor">#define MiGetPdeOffset(va) ((ULONG) (((ULONG_PTR)(va) &gt;&gt; PDI_SHIFT) &amp; PDI_MASK))</span>
01838 <span class="preprocessor"></span>
01839 <span class="comment">//++</span>
01840 <span class="comment">//ULONG</span>
01841 <span class="comment">//MiGetPpePdeOffset (</span>
01842 <span class="comment">//    IN PVOID va</span>
01843 <span class="comment">//    );</span>
01844 <span class="comment">//</span>
01845 <span class="comment">// Routine Description:</span>
01846 <span class="comment">//</span>
01847 <span class="comment">//    MiGetPpePdeOffset returns the offset into a page directory</span>
01848 <span class="comment">//    for a given virtual address.</span>
01849 <span class="comment">//</span>
01850 <span class="comment">//    N.B. This does not mask off PPE bits.</span>
01851 <span class="comment">//</span>
01852 <span class="comment">// Arguments</span>
01853 <span class="comment">//</span>
01854 <span class="comment">//    Va - Supplies the virtual address to locate the offset for.</span>
01855 <span class="comment">//</span>
01856 <span class="comment">// Return Value:</span>
01857 <span class="comment">//</span>
01858 <span class="comment">//    The offset into the page directory (and parent) table the</span>
01859 <span class="comment">//    corresponding PDE is at.</span>
01860 <span class="comment">//</span>
01861 <span class="comment">//--</span>
01862 
<a name="l01863"></a><a class="code" href="../../d2/d9/miia64_8h.html#a175">01863</a> <span class="preprocessor">#define MiGetPpePdeOffset(va) ((ULONG) ((ULONG_PTR)(va) &gt;&gt; PDI_SHIFT))</span>
01864 <span class="preprocessor"></span>
01865 <span class="comment">//++</span>
01866 <span class="comment">//ULONG_PTR</span>
01867 <span class="comment">//MiGetPteOffset (</span>
01868 <span class="comment">//    IN PVOID va</span>
01869 <span class="comment">//    );</span>
01870 <span class="comment">//</span>
01871 <span class="comment">// Routine Description:</span>
01872 <span class="comment">//</span>
01873 <span class="comment">//    MiGetPteOffset returns the offset into a page table page</span>
01874 <span class="comment">//    for a given virtual address.</span>
01875 <span class="comment">//</span>
01876 <span class="comment">// Argments</span>
01877 <span class="comment">//</span>
01878 <span class="comment">//    Va - Supplies the virtual address to locate the offset for.</span>
01879 <span class="comment">//</span>
01880 <span class="comment">// Return Value:</span>
01881 <span class="comment">//</span>
01882 <span class="comment">//    The offset into the page table page table the corresponding PTE is at.</span>
01883 <span class="comment">//</span>
01884 <span class="comment">//--</span>
01885 
<a name="l01886"></a><a class="code" href="../../d2/d9/miia64_8h.html#a176">01886</a> <span class="preprocessor">#define MiGetPteOffset(va) ((ULONG) (((ULONG_PTR)(va) &gt;&gt; PTI_SHIFT) &amp; PDI_MASK))</span>
01887 <span class="preprocessor"></span>
01888 
01889 <span class="comment">//++</span>
01890 <span class="comment">//++</span>
01891 <span class="comment">//PVOID</span>
01892 <span class="comment">//MiGetVirtualAddressMappedByPpe (</span>
01893 <span class="comment">//    IN PMMPTE PTE</span>
01894 <span class="comment">//    );</span>
01895 <span class="comment">//</span>
01896 <span class="comment">// Routine Description:</span>
01897 <span class="comment">//</span>
01898 <span class="comment">//    MiGetVirtualAddressMappedByPpe returns the virtual address</span>
01899 <span class="comment">//    which is mapped by a given PPE address.</span>
01900 <span class="comment">//</span>
01901 <span class="comment">// Arguments</span>
01902 <span class="comment">//</span>
01903 <span class="comment">//    PPE - Supplies the PPE to get the virtual address for.</span>
01904 <span class="comment">//</span>
01905 <span class="comment">// Return Value:</span>
01906 <span class="comment">//</span>
01907 <span class="comment">//    Virtual address mapped by the PPE.</span>
01908 <span class="comment">//</span>
01909 <span class="comment">//--</span>
01910 
<a name="l01911"></a><a class="code" href="../../d2/d9/miia64_8h.html#a177">01911</a> <span class="preprocessor">#define MiGetVirtualAddressMappedByPpe(PPE) \</span>
01912 <span class="preprocessor">    MiGetVirtualAddressMappedByPte(MiGetVirtualAddressMappedByPde(PPE))</span>
01913 <span class="preprocessor"></span>
01914 <span class="comment">//++</span>
01915 <span class="comment">//PVOID</span>
01916 <span class="comment">//MiGetVirtualAddressMappedByPde (</span>
01917 <span class="comment">//    IN PMMPTE PDE</span>
01918 <span class="comment">//    );</span>
01919 <span class="comment">//</span>
01920 <span class="comment">// Routine Description:</span>
01921 <span class="comment">//</span>
01922 <span class="comment">//    MiGetVirtualAddressMappedByPde returns the virtual address</span>
01923 <span class="comment">//    which is mapped by a given PDE address.</span>
01924 <span class="comment">//</span>
01925 <span class="comment">// Arguments</span>
01926 <span class="comment">//</span>
01927 <span class="comment">//    PDE - Supplies the PDE to get the virtual address for.</span>
01928 <span class="comment">//</span>
01929 <span class="comment">// Return Value:</span>
01930 <span class="comment">//</span>
01931 <span class="comment">//    Virtual address mapped by the PDE.</span>
01932 <span class="comment">//</span>
01933 <span class="comment">//--</span>
01934 
<a name="l01935"></a><a class="code" href="../../d2/d9/miia64_8h.html#a178">01935</a> <span class="preprocessor">#define MiGetVirtualAddressMappedByPde(Pde) \</span>
01936 <span class="preprocessor">    MiGetVirtualAddressMappedByPte(MiGetVirtualAddressMappedByPte(Pde))</span>
01937 <span class="preprocessor"></span>
01938 <span class="comment">//++</span>
01939 <span class="comment">//PVOID</span>
01940 <span class="comment">//MiGetVirtualAddressMappedByPte (</span>
01941 <span class="comment">//    IN PMMPTE PTE</span>
01942 <span class="comment">//    );</span>
01943 <span class="comment">//</span>
01944 <span class="comment">// Routine Description:</span>
01945 <span class="comment">//</span>
01946 <span class="comment">//    MiGetVirtualAddressMappedByPte returns the virtual address</span>
01947 <span class="comment">//    which is mapped by a given PTE address.</span>
01948 <span class="comment">//</span>
01949 <span class="comment">// Argments</span>
01950 <span class="comment">//</span>
01951 <span class="comment">//    PTE - Supplies the PTE to get the virtual address for.</span>
01952 <span class="comment">//</span>
01953 <span class="comment">// Return Value:</span>
01954 <span class="comment">//</span>
01955 <span class="comment">//    Virtual address mapped by the PTE.</span>
01956 <span class="comment">//</span>
01957 <span class="comment">//--</span>
01958 
01959 <span class="preprocessor">#ifdef  _WIN64</span>
01960 <span class="preprocessor"></span>
01961 <span class="preprocessor">#define MiGetVirtualAddressMappedByPte(PTE) \</span>
01962 <span class="preprocessor">  (((ULONG_PTR)(PTE) &amp; PTA_SIGN) ? \</span>
01963 <span class="preprocessor">   (PVOID)(((ULONG_PTR)(PTE) &amp; VRN_MASK) | VA_FILL | \</span>
01964 <span class="preprocessor">           (((ULONG_PTR)(PTE)-PTE_BASE) &lt;&lt; (PAGE_SHIFT - PTE_SHIFT))) : \</span>
01965 <span class="preprocessor">   (PVOID)(((ULONG_PTR)(PTE) &amp; VRN_MASK) | (((ULONG_PTR)(PTE)-PTE_BASE) &lt;&lt; (PAGE_SHIFT - PTE_SHIFT))))</span>
01966 <span class="preprocessor"></span>
01967 <span class="preprocessor">#else</span>
01968 <span class="preprocessor"></span>
<a name="l01969"></a><a class="code" href="../../d2/d9/miia64_8h.html#a179">01969</a> <span class="preprocessor">#define MiGetVirtualAddressMappedByPte(PTE) ((PVOID)((ULONG_PTR)(PTE) &lt;&lt; (PAGE_SHIFT - PTE_SHIFT)))</span>
01970 <span class="preprocessor"></span>
01971 <span class="preprocessor">#endif</span>
01972 <span class="preprocessor"></span>
01973 
01974 <span class="comment">//++</span>
01975 <span class="comment">//LOGICAL</span>
01976 <span class="comment">//MiIsVirtualAddressOnPpeBoundary (</span>
01977 <span class="comment">//    IN PVOID VA</span>
01978 <span class="comment">//    );</span>
01979 <span class="comment">//</span>
01980 <span class="comment">// Routine Description:</span>
01981 <span class="comment">//</span>
01982 <span class="comment">//    MiIsVirtualAddressOnPpeBoundary returns TRUE if the virtual address is</span>
01983 <span class="comment">//    on a page directory entry boundary.</span>
01984 <span class="comment">//</span>
01985 <span class="comment">// Arguments</span>
01986 <span class="comment">//</span>
01987 <span class="comment">//    VA - Supplies the virtual address to check.</span>
01988 <span class="comment">//</span>
01989 <span class="comment">// Return Value:</span>
01990 <span class="comment">//</span>
01991 <span class="comment">//    TRUE if on a boundary, FALSE if not.</span>
01992 <span class="comment">//</span>
01993 <span class="comment">//--</span>
01994 
<a name="l01995"></a><a class="code" href="../../d2/d9/miia64_8h.html#a180">01995</a> <span class="preprocessor">#define MiIsVirtualAddressOnPpeBoundary(VA) (((ULONG_PTR)(VA) &amp; PAGE_DIRECTORY1_MASK) == 0)</span>
01996 <span class="preprocessor"></span>
01997 
01998 <span class="comment">//++</span>
01999 <span class="comment">//LOGICAL</span>
02000 <span class="comment">//MiIsVirtualAddressOnPdeBoundary (</span>
02001 <span class="comment">//    IN PVOID VA</span>
02002 <span class="comment">//    );</span>
02003 <span class="comment">//</span>
02004 <span class="comment">// Routine Description:</span>
02005 <span class="comment">//</span>
02006 <span class="comment">//    MiIsVirtualAddressOnPdeBoundary returns TRUE if the virtual address is</span>
02007 <span class="comment">//    on a page directory entry boundary.</span>
02008 <span class="comment">//</span>
02009 <span class="comment">// Arguments</span>
02010 <span class="comment">//</span>
02011 <span class="comment">//    VA - Supplies the virtual address to check.</span>
02012 <span class="comment">//</span>
02013 <span class="comment">// Return Value:</span>
02014 <span class="comment">//</span>
02015 <span class="comment">//    TRUE if on a 4MB PDE boundary, FALSE if not.</span>
02016 <span class="comment">//</span>
02017 <span class="comment">//--</span>
02018 
<a name="l02019"></a><a class="code" href="../../d2/d9/miia64_8h.html#a181">02019</a> <span class="preprocessor">#define MiIsVirtualAddressOnPdeBoundary(VA) (((ULONG_PTR)(VA) &amp; PAGE_DIRECTORY2_MASK) == 0)</span>
02020 <span class="preprocessor"></span>
02021 
02022 <span class="comment">//++</span>
02023 <span class="comment">//LOGICAL</span>
02024 <span class="comment">//MiIsPteOnPpeBoundary (</span>
02025 <span class="comment">//    IN PVOID VA</span>
02026 <span class="comment">//    );</span>
02027 <span class="comment">//</span>
02028 <span class="comment">// Routine Description:</span>
02029 <span class="comment">//</span>
02030 <span class="comment">//    MiIsPteOnPpeBoundary returns TRUE if the PTE is</span>
02031 <span class="comment">//    on a page directory parent entry boundary.</span>
02032 <span class="comment">//</span>
02033 <span class="comment">// Arguments</span>
02034 <span class="comment">//</span>
02035 <span class="comment">//    VA - Supplies the virtual address to check.</span>
02036 <span class="comment">//</span>
02037 <span class="comment">// Return Value:</span>
02038 <span class="comment">//</span>
02039 <span class="comment">//    TRUE if on a boundary, FALSE if not.</span>
02040 <span class="comment">//</span>
02041 <span class="comment">//--</span>
02042 
<a name="l02043"></a><a class="code" href="../../d2/d9/miia64_8h.html#a182">02043</a> <span class="preprocessor">#define MiIsPteOnPpeBoundary(PTE) (((ULONG_PTR)(PTE) &amp; (MM_VA_MAPPED_BY_PDE - 1)) == 0)</span>
02044 <span class="preprocessor"></span>
02045 
02046 
02047 <span class="comment">//++</span>
02048 <span class="comment">//LOGICAL</span>
02049 <span class="comment">//MiIsPteOnPdeBoundary (</span>
02050 <span class="comment">//    IN PVOID PTE</span>
02051 <span class="comment">//    );</span>
02052 <span class="comment">//</span>
02053 <span class="comment">// Routine Description:</span>
02054 <span class="comment">//</span>
02055 <span class="comment">//    MiIsPteOnPdeBoundary returns TRUE if the PTE is</span>
02056 <span class="comment">//    on a page directory entry boundary.</span>
02057 <span class="comment">//</span>
02058 <span class="comment">// Arguments</span>
02059 <span class="comment">//</span>
02060 <span class="comment">//    PTE - Supplies the PTE to check.</span>
02061 <span class="comment">//</span>
02062 <span class="comment">// Return Value:</span>
02063 <span class="comment">//</span>
02064 <span class="comment">//    TRUE if on a 8MB PDE boundary, FALSE if not.</span>
02065 <span class="comment">//</span>
02066 <span class="comment">//--</span>
02067 
<a name="l02068"></a><a class="code" href="../../d2/d9/miia64_8h.html#a183">02068</a> <span class="preprocessor">#define MiIsPteOnPdeBoundary(PTE) (((ULONG_PTR)(PTE) &amp; (PAGE_SIZE - 1)) == 0)</span>
02069 <span class="preprocessor"></span>
02070 
02071 <span class="comment">//++</span>
02072 <span class="comment">//ULONG</span>
02073 <span class="comment">//GET_PAGING_FILE_NUMBER (</span>
02074 <span class="comment">//    IN MMPTE PTE</span>
02075 <span class="comment">//    );</span>
02076 <span class="comment">//</span>
02077 <span class="comment">// Routine Description:</span>
02078 <span class="comment">//</span>
02079 <span class="comment">//    This macro extracts the paging file number from a PTE.</span>
02080 <span class="comment">//</span>
02081 <span class="comment">// Argments</span>
02082 <span class="comment">//</span>
02083 <span class="comment">//    PTE - Supplies the PTE to operate upon.</span>
02084 <span class="comment">//</span>
02085 <span class="comment">// Return Value:</span>
02086 <span class="comment">//</span>
02087 <span class="comment">//    The paging file number.</span>
02088 <span class="comment">//</span>
02089 <span class="comment">//--</span>
02090 
<a name="l02091"></a><a class="code" href="../../d2/d9/miia64_8h.html#a184">02091</a> <span class="preprocessor">#define GET_PAGING_FILE_NUMBER(PTE) ((ULONG) (PTE).u.Soft.PageFileLow)</span>
02092 <span class="preprocessor"></span>
02093 
02094 
02095 <span class="comment">//++</span>
02096 <span class="comment">//ULONG</span>
02097 <span class="comment">//GET_PAGING_FILE_OFFSET (</span>
02098 <span class="comment">//    IN MMPTE PTE</span>
02099 <span class="comment">//    );</span>
02100 <span class="comment">//</span>
02101 <span class="comment">// Routine Description:</span>
02102 <span class="comment">//</span>
02103 <span class="comment">//    This macro extracts the offset into the paging file from a PTE.</span>
02104 <span class="comment">//</span>
02105 <span class="comment">// Argments</span>
02106 <span class="comment">//</span>
02107 <span class="comment">//    PTE - Supplies the PTE to operate upon.</span>
02108 <span class="comment">//</span>
02109 <span class="comment">// Return Value:</span>
02110 <span class="comment">//</span>
02111 <span class="comment">//    The paging file offset.</span>
02112 <span class="comment">//</span>
02113 <span class="comment">//--</span>
02114 
<a name="l02115"></a><a class="code" href="../../d2/d9/miia64_8h.html#a185">02115</a> <span class="preprocessor">#define GET_PAGING_FILE_OFFSET(PTE) ((ULONG) (PTE).u.Soft.PageFileHigh)</span>
02116 <span class="preprocessor"></span>
02117 
02118 
02119 
02120 <span class="comment">//++</span>
02121 <span class="comment">//ULONG_PTR</span>
02122 <span class="comment">//IS_PTE_NOT_DEMAND_ZERO (</span>
02123 <span class="comment">//    IN PMMPTE PPTE</span>
02124 <span class="comment">//    );</span>
02125 <span class="comment">//</span>
02126 <span class="comment">// Routine Description:</span>
02127 <span class="comment">//</span>
02128 <span class="comment">//    This macro checks to see if a given PTE is NOT a demand zero PTE.</span>
02129 <span class="comment">//</span>
02130 <span class="comment">// Argments</span>
02131 <span class="comment">//</span>
02132 <span class="comment">//    PTE - Supplies the PTE to operate upon.</span>
02133 <span class="comment">//</span>
02134 <span class="comment">// Return Value:</span>
02135 <span class="comment">//</span>
02136 <span class="comment">//     Returns 0 if the PTE is demand zero, non-zero otherwise.</span>
02137 <span class="comment">//</span>
02138 <span class="comment">//--</span>
02139 
<a name="l02140"></a><a class="code" href="../../d2/d9/miia64_8h.html#a186">02140</a> <span class="preprocessor">#define IS_PTE_NOT_DEMAND_ZERO(PTE) \</span>
02141 <span class="preprocessor">                 ((PTE).u.Long &amp; ((ULONG_PTR)0xFFFFFFFFFFFFF000 |  \</span>
02142 <span class="preprocessor">                                  MM_PTE_VALID_MASK |       \</span>
02143 <span class="preprocessor">                                  MM_PTE_PROTOTYPE_MASK |   \</span>
02144 <span class="preprocessor">                                  MM_PTE_TRANSITION_MASK))</span>
02145 <span class="preprocessor"></span>
02146 
02147 <span class="comment">//++</span>
02148 <span class="comment">//VOID</span>
02149 <span class="comment">//MI_MAKING_VALID_PTE_INVALID(</span>
02150 <span class="comment">//    IN PMMPTE PPTE</span>
02151 <span class="comment">//    );</span>
02152 <span class="comment">//</span>
02153 <span class="comment">// Routine Description:</span>
02154 <span class="comment">//</span>
02155 <span class="comment">//    Prepare to make a single valid PTE invalid.</span>
02156 <span class="comment">//    No action is required on x86.</span>
02157 <span class="comment">//</span>
02158 <span class="comment">// Argments</span>
02159 <span class="comment">//</span>
02160 <span class="comment">//    SYSTEM_WIDE - Supplies TRUE if this will happen on all processors.</span>
02161 <span class="comment">//</span>
02162 <span class="comment">// Return Value:</span>
02163 <span class="comment">//</span>
02164 <span class="comment">//    None.</span>
02165 <span class="comment">//</span>
02166 <span class="comment">//--</span>
02167 
<a name="l02168"></a><a class="code" href="../../d2/d9/miia64_8h.html#a187">02168</a> <span class="preprocessor">#define MI_MAKING_VALID_PTE_INVALID(SYSTEM_WIDE)</span>
02169 <span class="preprocessor"></span>
02170 
02171 <span class="comment">//++</span>
02172 <span class="comment">//VOID</span>
02173 <span class="comment">//MI_MAKING_VALID_MULTIPLE_PTES_INVALID(</span>
02174 <span class="comment">//    IN PMMPTE PPTE</span>
02175 <span class="comment">//    );</span>
02176 <span class="comment">//</span>
02177 <span class="comment">// Routine Description:</span>
02178 <span class="comment">//</span>
02179 <span class="comment">//    Prepare to make multiple valid PTEs invalid.</span>
02180 <span class="comment">//    No action is required on x86.</span>
02181 <span class="comment">//</span>
02182 <span class="comment">// Argments</span>
02183 <span class="comment">//</span>
02184 <span class="comment">//    SYSTEM_WIDE - Supplies TRUE if this will happen on all processors.</span>
02185 <span class="comment">//</span>
02186 <span class="comment">// Return Value:</span>
02187 <span class="comment">//</span>
02188 <span class="comment">//    None.</span>
02189 <span class="comment">//</span>
02190 <span class="comment">//--</span>
02191 
<a name="l02192"></a><a class="code" href="../../d2/d9/miia64_8h.html#a188">02192</a> <span class="preprocessor">#define MI_MAKING_MULTIPLE_PTES_INVALID(SYSTEM_WIDE)</span>
02193 <span class="preprocessor"></span>
02194 
02195 
02196 <span class="comment">//++</span>
02197 <span class="comment">//VOID</span>
02198 <span class="comment">//MI_MAKE_PROTECT_WRITE_COPY (</span>
02199 <span class="comment">//    IN OUT MMPTE PPTE</span>
02200 <span class="comment">//    );</span>
02201 <span class="comment">//</span>
02202 <span class="comment">// Routine Description:</span>
02203 <span class="comment">//</span>
02204 <span class="comment">//    This macro makes a writable PTE a writeable-copy PTE.</span>
02205 <span class="comment">//</span>
02206 <span class="comment">// Argments</span>
02207 <span class="comment">//</span>
02208 <span class="comment">//    PTE - Supplies the PTE to operate upon.</span>
02209 <span class="comment">//</span>
02210 <span class="comment">// Return Value:</span>
02211 <span class="comment">//</span>
02212 <span class="comment">//    NONE</span>
02213 <span class="comment">//</span>
02214 <span class="comment">//--</span>
02215 
<a name="l02216"></a><a class="code" href="../../d2/d9/miia64_8h.html#a189">02216</a> <span class="preprocessor">#define MI_MAKE_PROTECT_WRITE_COPY(PTE) \</span>
02217 <span class="preprocessor">        if ((PTE).u.Soft.Protection &amp; MM_PROTECTION_WRITE_MASK) {      \</span>
02218 <span class="preprocessor">            (PTE).u.Long |= MM_PROTECTION_COPY_MASK &lt;&lt; MM_PROTECT_FIELD_SHIFT;      \</span>
02219 <span class="preprocessor">        }</span>
02220 <span class="preprocessor"></span>
02221 
02222 <span class="comment">//++</span>
02223 <span class="comment">//VOID</span>
02224 <span class="comment">//MI_SET_PAGE_DIRTY(</span>
02225 <span class="comment">//    IN PMMPTE PPTE,</span>
02226 <span class="comment">//    IN PVOID VA,</span>
02227 <span class="comment">//    IN PVOID PFNHELD</span>
02228 <span class="comment">//    );</span>
02229 <span class="comment">//</span>
02230 <span class="comment">// Routine Description:</span>
02231 <span class="comment">//</span>
02232 <span class="comment">//    This macro sets the dirty bit (and release page file space).</span>
02233 <span class="comment">//</span>
02234 <span class="comment">// Argments</span>
02235 <span class="comment">//</span>
02236 <span class="comment">//    TEMP - Supplies a temporary for usage.</span>
02237 <span class="comment">//</span>
02238 <span class="comment">//    PPTE - Supplies a pointer to the PTE that corresponds to VA.</span>
02239 <span class="comment">//</span>
02240 <span class="comment">//    VA - Supplies a the virtual address of the page fault.</span>
02241 <span class="comment">//</span>
02242 <span class="comment">//    PFNHELD - Supplies TRUE if the PFN lock is held.</span>
02243 <span class="comment">//</span>
02244 <span class="comment">// Return Value:</span>
02245 <span class="comment">//</span>
02246 <span class="comment">//    None.</span>
02247 <span class="comment">//</span>
02248 <span class="comment">//--</span>
02249 
<a name="l02250"></a><a class="code" href="../../d2/d9/miia64_8h.html#a190">02250</a> <span class="preprocessor">#define MI_SET_PAGE_DIRTY(PPTE,VA,PFNHELD)                          \</span>
02251 <span class="preprocessor">            if ((PPTE)-&gt;u.Hard.Dirty == 1) {                        \</span>
02252 <span class="preprocessor">                MiSetDirtyBit ((VA),(PPTE),(PFNHELD));              \</span>
02253 <span class="preprocessor">            }</span>
02254 <span class="preprocessor"></span>
02255 
02256 <span class="comment">//++</span>
02257 <span class="comment">//VOID</span>
02258 <span class="comment">//MI_NO_FAULT_FOUND(</span>
02259 <span class="comment">//    IN TEMP,</span>
02260 <span class="comment">//    IN PMMPTE PPTE,</span>
02261 <span class="comment">//    IN PVOID VA,</span>
02262 <span class="comment">//    IN PVOID PFNHELD</span>
02263 <span class="comment">//    );</span>
02264 <span class="comment">//</span>
02265 <span class="comment">// Routine Description:</span>
02266 <span class="comment">//</span>
02267 <span class="comment">//    This macro handles the case when a page fault is taken and no</span>
02268 <span class="comment">//    PTE with the valid bit clear is found.</span>
02269 <span class="comment">//</span>
02270 <span class="comment">// Argments</span>
02271 <span class="comment">//</span>
02272 <span class="comment">//    TEMP - Supplies a temporary for usage.</span>
02273 <span class="comment">//</span>
02274 <span class="comment">//    PPTE - Supplies a pointer to the PTE that corresponds to VA.</span>
02275 <span class="comment">//</span>
02276 <span class="comment">//    VA - Supplies a the virtual address of the page fault.</span>
02277 <span class="comment">//</span>
02278 <span class="comment">//    PFNHELD - Supplies TRUE if the PFN lock is held.</span>
02279 <span class="comment">//</span>
02280 <span class="comment">// Return Value:</span>
02281 <span class="comment">//</span>
02282 <span class="comment">//    None.</span>
02283 <span class="comment">//</span>
02284 <span class="comment">//--</span>
02285 
<a name="l02286"></a><a class="code" href="../../d2/d9/miia64_8h.html#a191">02286</a> <span class="preprocessor">#define MI_NO_FAULT_FOUND(TEMP,PPTE,VA,PFNHELD) \</span>
02287 <span class="preprocessor">        if (StoreInstruction &amp;&amp; ((PPTE)-&gt;u.Hard.Dirty == 0)) {  \</span>
02288 <span class="preprocessor">            MiSetDirtyBit ((VA),(PPTE),(PFNHELD));     \</span>
02289 <span class="preprocessor">        }</span>
02290 <span class="preprocessor"></span>
02291 
02292 <span class="comment">//++</span>
02293 <span class="comment">//ULONG_PTR</span>
02294 <span class="comment">//MI_CAPTURE_DIRTY_BIT_TO_PFN (</span>
02295 <span class="comment">//    IN PMMPTE PPTE,</span>
02296 <span class="comment">//    IN PMMPFN PPFN</span>
02297 <span class="comment">//    );</span>
02298 <span class="comment">//</span>
02299 <span class="comment">// Routine Description:</span>
02300 <span class="comment">//</span>
02301 <span class="comment">//    This macro gets captures the state of the dirty bit to the PFN</span>
02302 <span class="comment">//    and frees any associated page file space if the PTE has been</span>
02303 <span class="comment">//    modified element.</span>
02304 <span class="comment">//</span>
02305 <span class="comment">//    NOTE - THE PFN LOCK MUST BE HELD!</span>
02306 <span class="comment">//</span>
02307 <span class="comment">// Argments</span>
02308 <span class="comment">//</span>
02309 <span class="comment">//    PPTE - Supplies the PTE to operate upon.</span>
02310 <span class="comment">//</span>
02311 <span class="comment">//    PPFN - Supplies a pointer to the PFN database element that corresponds</span>
02312 <span class="comment">//           to the page mapped by the PTE.</span>
02313 <span class="comment">//</span>
02314 <span class="comment">// Return Value:</span>
02315 <span class="comment">//</span>
02316 <span class="comment">//    None.</span>
02317 <span class="comment">//</span>
02318 <span class="comment">//--</span>
02319 
<a name="l02320"></a><a class="code" href="../../d2/d9/miia64_8h.html#a192">02320</a> <span class="preprocessor">#define MI_CAPTURE_DIRTY_BIT_TO_PFN(PPTE,PPFN)                      \</span>
02321 <span class="preprocessor">         ASSERT (KeGetCurrentIrql() &gt; APC_LEVEL);                   \</span>
02322 <span class="preprocessor">         if (((PPFN)-&gt;u3.e1.Modified == 0) &amp;&amp;                       \</span>
02323 <span class="preprocessor">            ((PPTE)-&gt;u.Hard.Dirty != 0)) {               \</span>
02324 <span class="preprocessor">             (PPFN)-&gt;u3.e1.Modified = 1;                            \</span>
02325 <span class="preprocessor">             if (((PPFN)-&gt;OriginalPte.u.Soft.Prototype == 0) &amp;&amp;     \</span>
02326 <span class="preprocessor">                          ((PPFN)-&gt;u3.e1.WriteInProgress == 0)) {   \</span>
02327 <span class="preprocessor">                 MiReleasePageFileSpace ((PPFN)-&gt;OriginalPte);      \</span>
02328 <span class="preprocessor">                 (PPFN)-&gt;OriginalPte.u.Soft.PageFileHigh = 0;       \</span>
02329 <span class="preprocessor">             }                                                      \</span>
02330 <span class="preprocessor">         }</span>
02331 <span class="preprocessor"></span>
02332 
02333 <span class="comment">//++</span>
02334 <span class="comment">//BOOLEAN</span>
02335 <span class="comment">//MI_IS_PHYSICAL_ADDRESS (</span>
02336 <span class="comment">//    IN PVOID VA</span>
02337 <span class="comment">//    );</span>
02338 <span class="comment">//</span>
02339 <span class="comment">// Routine Description:</span>
02340 <span class="comment">//</span>
02341 <span class="comment">//    This macro deterines if a give virtual address is really a</span>
02342 <span class="comment">//    physical address.</span>
02343 <span class="comment">//</span>
02344 <span class="comment">// Argments</span>
02345 <span class="comment">//</span>
02346 <span class="comment">//    VA - Supplies the virtual address.</span>
02347 <span class="comment">//</span>
02348 <span class="comment">// Return Value:</span>
02349 <span class="comment">//</span>
02350 <span class="comment">//    FALSE if it is not a physical address, TRUE if it is.</span>
02351 <span class="comment">//</span>
02352 <span class="comment">//--</span>
02353 
02354 
<a name="l02355"></a><a class="code" href="../../d2/d9/miia64_8h.html#a193">02355</a> <span class="preprocessor">#define MI_IS_PHYSICAL_ADDRESS(Va) \</span>
02356 <span class="preprocessor">     ((((ULONG_PTR)(Va) &gt;= KSEG3_BASE) &amp;&amp; ((ULONG_PTR)(Va) &lt; KSEG3_LIMIT)) || \</span>
02357 <span class="preprocessor">      (((ULONG_PTR)Va &gt;= KSEG0_BASE) &amp;&amp; ((ULONG_PTR)Va &lt; KSEG2_BASE)))</span>
02358 <span class="preprocessor"></span>
02359 
02360 <span class="comment">//++</span>
02361 <span class="comment">//ULONG_PTR</span>
02362 <span class="comment">//MI_CONVERT_PHYSICAL_TO_PFN (</span>
02363 <span class="comment">//    IN PVOID VA</span>
02364 <span class="comment">//    );</span>
02365 <span class="comment">//</span>
02366 <span class="comment">// Routine Description:</span>
02367 <span class="comment">//</span>
02368 <span class="comment">//    This macro converts a physical address (see MI_IS_PHYSICAL_ADDRESS)</span>
02369 <span class="comment">//    to its corresponding physical frame number.</span>
02370 <span class="comment">//</span>
02371 <span class="comment">// Argments</span>
02372 <span class="comment">//</span>
02373 <span class="comment">//    VA - Supplies a pointer to the physical address.</span>
02374 <span class="comment">//</span>
02375 <span class="comment">// Return Value:</span>
02376 <span class="comment">//</span>
02377 <span class="comment">//    Returns the PFN for the page.</span>
02378 <span class="comment">//</span>
02379 <span class="comment">//--</span>
02380 
02381 PVOID <a class="code" href="../../d2/d9/miia64_8h.html#a300">KiGetPhysicalAddress</a>(
02382     IN PVOID VirtualAddress
02383     );
02384 
<a name="l02385"></a><a class="code" href="../../d2/d9/miia64_8h.html#a194">02385</a> <span class="preprocessor">#define MI_CONVERT_PHYSICAL_TO_PFN(Va)   \</span>
02386 <span class="preprocessor">    (((ULONG_PTR)(Va) &lt; KSEG0_BASE) ?                             \</span>
02387 <span class="preprocessor">     ((PFN_NUMBER)(((ULONG_PTR)(Va) - KSEG3_BASE) &gt;&gt; PAGE_SHIFT)) : \</span>
02388 <span class="preprocessor">     ((PFN_NUMBER)(((ULONG_PTR)KiGetPhysicalAddress(Va)) &gt;&gt; PAGE_SHIFT)))</span>
02389 <span class="preprocessor"></span>
02390 
02391 <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d4/d1/struct__MMCOLOR__TABLES.html">_MMCOLOR_TABLES</a> {
<a name="l02392"></a><a class="code" href="../../d4/d1/struct__MMCOLOR__TABLES.html#o2">02392</a>     PFN_NUMBER <a class="code" href="../../d4/d1/struct__MMCOLOR__TABLES.html#o0">Flink</a>;
02393     PVOID <a class="code" href="../../d4/d1/struct__MMCOLOR__TABLES.html#o1">Blink</a>;
02394 } <a class="code" href="../../d4/d1/struct__MMCOLOR__TABLES.html">MMCOLOR_TABLES</a>, *<a class="code" href="../../d4/d1/struct__MMCOLOR__TABLES.html">PMMCOLOR_TABLES</a>;
02395 
02396 <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d1/d4/struct__MMPRIMARY__COLOR__TABLES.html">_MMPRIMARY_COLOR_TABLES</a> {
02397     LIST_ENTRY ListHead;
02398 } <a class="code" href="../../d1/d4/struct__MMPRIMARY__COLOR__TABLES.html">MMPRIMARY_COLOR_TABLES</a>, *<a class="code" href="../../d1/d4/struct__MMPRIMARY__COLOR__TABLES.html">PMMPRIMARY_COLOR_TABLES</a>;
02399 
02400 
02401 <span class="preprocessor">#if MM_MAXIMUM_NUMBER_OF_COLORS &gt; 1</span>
02402 <span class="preprocessor"></span><span class="keyword">extern</span> <a class="code" href="../../d0/d4/struct__MMPFNLIST.html">MMPFNLIST</a> <a class="code" href="../../d5/d2/datamips_8c.html#a9">MmFreePagesByPrimaryColor</a>[2][<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a55">MM_MAXIMUM_NUMBER_OF_COLORS</a>];
02403 <span class="preprocessor">#endif</span>
02404 <span class="preprocessor"></span>
<a name="l02405"></a><a class="code" href="../../d2/d9/miia64_8h.html#a280">02405</a> <span class="keyword">extern</span> <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a203">PMMCOLOR_TABLES</a> <a class="code" href="../../d4/d2/datalpha_8c.html#a20">MmFreePagesByColor</a>[2];
02406 
<a name="l02407"></a><a class="code" href="../../d2/d9/miia64_8h.html#a281">02407</a> <span class="keyword">extern</span> ULONG <a class="code" href="../../d4/d2/datalpha_8c.html#a23">MmTotalPagesForPagingFile</a>;
02408 
02409 
02410 <span class="comment">//</span>
02411 <span class="comment">// A VALID Page Table Entry on an Intel IA64 has the following definition.</span>
02412 <span class="comment">//</span>
02413 
<a name="l02414"></a><a class="code" href="../../d2/d9/miia64_8h.html#a195">02414</a> <span class="preprocessor">#define _MM_PAGING_FILE_LOW_SHIFT 28</span>
<a name="l02415"></a><a class="code" href="../../d2/d9/miia64_8h.html#a196">02415</a> <span class="preprocessor"></span><span class="preprocessor">#define _MM_PAGING_FILE_HIGH_SHIFT 32</span>
02416 <span class="preprocessor"></span>
<a name="l02417"></a><a class="code" href="../../d2/d9/miia64_8h.html#a197">02417</a> <span class="preprocessor">#define MI_PTE_LOOKUP_NEEDED ((ULONG64)0xffffffff)</span>
02418 <span class="preprocessor"></span>
02419 <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d4/d5/struct__MMPTE__SOFTWARE.html">_MMPTE_SOFTWARE</a> {
<a name="l02420"></a><a class="code" href="../../d4/d5/struct__MMPTE__SOFTWARE.html#o6">02420</a>     ULONGLONG <a class="code" href="../../d4/d5/struct__MMPTE__SOFTWARE.html#o0">Valid</a> : 1;
<a name="l02421"></a><a class="code" href="../../d4/d5/struct__MMPTE__SOFTWARE.html#o7">02421</a>     ULONGLONG <a class="code" href="../../d4/d5/struct__MMPTE__SOFTWARE.html#o1">Prototype</a> : 1;
<a name="l02422"></a><a class="code" href="../../d4/d5/struct__MMPTE__SOFTWARE.html#o9">02422</a>     ULONGLONG <a class="code" href="../../d4/d5/struct__MMPTE__SOFTWARE.html#o3">Protection</a> : 5;
<a name="l02423"></a><a class="code" href="../../d4/d5/struct__MMPTE__SOFTWARE.html#o8">02423</a>     ULONGLONG <a class="code" href="../../d4/d5/struct__MMPTE__SOFTWARE.html#o2">Transition</a> : 1;
<a name="l02424"></a><a class="code" href="../../d4/d5/struct__MMPTE__SOFTWARE.html#o10">02424</a>     ULONGLONG <a class="code" href="../../d4/d5/struct__MMPTE__SOFTWARE.html#o10">UsedPageTableEntries</a> : <a class="code" href="../../d9/d8/axp64_2mialpha_8h.html#a103">PTE_PER_PAGE_BITS</a>;
<a name="l02425"></a><a class="code" href="../../d4/d5/struct__MMPTE__SOFTWARE.html#o11">02425</a>     ULONGLONG <a class="code" href="../../d4/d5/struct__MMPTE__SOFTWARE.html#o11">Reserved</a> : 20 - <a class="code" href="../../d9/d8/axp64_2mialpha_8h.html#a103">PTE_PER_PAGE_BITS</a>;
<a name="l02426"></a><a class="code" href="../../d4/d5/struct__MMPTE__SOFTWARE.html#o12">02426</a>     ULONGLONG <a class="code" href="../../d4/d5/struct__MMPTE__SOFTWARE.html#o4">PageFileLow</a>: 4;
<a name="l02427"></a><a class="code" href="../../d4/d5/struct__MMPTE__SOFTWARE.html#o13">02427</a>     ULONGLONG <a class="code" href="../../d4/d5/struct__MMPTE__SOFTWARE.html#o5">PageFileHigh</a> : 32;
02428 } <a class="code" href="../../d4/d5/struct__MMPTE__SOFTWARE.html">MMPTE_SOFTWARE</a>;
02429 
02430 <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d6/d5/struct__MMPTE__TRANSITION.html">_MMPTE_TRANSITION</a> {
<a name="l02431"></a><a class="code" href="../../d6/d5/struct__MMPTE__TRANSITION.html#o6">02431</a>     ULONGLONG <a class="code" href="../../d6/d5/struct__MMPTE__TRANSITION.html#o0">Valid</a> : 1;
<a name="l02432"></a><a class="code" href="../../d6/d5/struct__MMPTE__TRANSITION.html#o7">02432</a>     ULONGLONG <a class="code" href="../../d6/d5/struct__MMPTE__TRANSITION.html#o1">Prototype</a> : 1;
<a name="l02433"></a><a class="code" href="../../d6/d5/struct__MMPTE__TRANSITION.html#o9">02433</a>     ULONGLONG <a class="code" href="../../d6/d5/struct__MMPTE__TRANSITION.html#o3">Protection</a> : 5;
<a name="l02434"></a><a class="code" href="../../d6/d5/struct__MMPTE__TRANSITION.html#o8">02434</a>     ULONGLONG <a class="code" href="../../d6/d5/struct__MMPTE__TRANSITION.html#o2">Transition</a> : 1;
<a name="l02435"></a><a class="code" href="../../d6/d5/struct__MMPTE__TRANSITION.html#o16">02435</a>     ULONGLONG <a class="code" href="../../d6/d5/struct__MMPTE__TRANSITION.html#o16">Rsvd0</a> : <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a> - 8;
<a name="l02436"></a><a class="code" href="../../d6/d5/struct__MMPTE__TRANSITION.html#o11">02436</a>     ULONGLONG <a class="code" href="../../d6/d5/struct__MMPTE__TRANSITION.html#o5">PageFrameNumber</a> : 50 - <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
<a name="l02437"></a><a class="code" href="../../d6/d5/struct__MMPTE__TRANSITION.html#o17">02437</a>     ULONGLONG <a class="code" href="../../d6/d5/struct__MMPTE__TRANSITION.html#o17">Rsvd1</a> : 14;
02438 } <a class="code" href="../../d6/d5/struct__MMPTE__TRANSITION.html">MMPTE_TRANSITION</a>;
02439 
02440 
<a name="l02441"></a><a class="code" href="../../d2/d9/miia64_8h.html#a198">02441</a> <span class="preprocessor">#define _MM_PROTO_ADDRESS_SHIFT 12</span>
02442 <span class="preprocessor"></span>
02443 <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d3/d5/struct__MMPTE__PROTOTYPE.html">_MMPTE_PROTOTYPE</a> {
<a name="l02444"></a><a class="code" href="../../d3/d5/struct__MMPTE__PROTOTYPE.html#o5">02444</a>     ULONGLONG <a class="code" href="../../d3/d5/struct__MMPTE__PROTOTYPE.html#o0">Valid</a> : 1;
<a name="l02445"></a><a class="code" href="../../d3/d5/struct__MMPTE__PROTOTYPE.html#o6">02445</a>     ULONGLONG <a class="code" href="../../d3/d5/struct__MMPTE__PROTOTYPE.html#o1">Prototype</a> : 1;
<a name="l02446"></a><a class="code" href="../../d3/d5/struct__MMPTE__PROTOTYPE.html#o7">02446</a>     ULONGLONG <a class="code" href="../../d3/d5/struct__MMPTE__PROTOTYPE.html#o2">ReadOnly</a> : 1;  <span class="comment">// if set allow read only access.</span>
<a name="l02447"></a><a class="code" href="../../d3/d5/struct__MMPTE__PROTOTYPE.html#o14">02447</a>     ULONGLONG <a class="code" href="../../d3/d5/struct__MMPTE__PROTOTYPE.html#o14">Rsvd</a> : 9;
<a name="l02448"></a><a class="code" href="../../d3/d5/struct__MMPTE__PROTOTYPE.html#o15">02448</a>     ULONGLONG <a class="code" href="../../d3/d5/struct__MMPTE__PROTOTYPE.html#o4">ProtoAddress</a> : 52;
02449 } <a class="code" href="../../d3/d5/struct__MMPTE__PROTOTYPE.html">MMPTE_PROTOTYPE</a>;
02450 
02451 
<a name="l02452"></a><a class="code" href="../../d2/d9/miia64_8h.html#a199">02452</a> <span class="preprocessor">#define _MM_PTE_SUBSECTION_ADDRESS_SHIFT  12</span>
02453 <span class="preprocessor"></span>
02454 <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d5/d5/struct__MMPTE__SUBSECTION.html">_MMPTE_SUBSECTION</a> {
<a name="l02455"></a><a class="code" href="../../d5/d5/struct__MMPTE__SUBSECTION.html#o5">02455</a>     ULONGLONG <a class="code" href="../../d5/d5/struct__MMPTE__SUBSECTION.html#o0">Valid</a> : 1;
<a name="l02456"></a><a class="code" href="../../d5/d5/struct__MMPTE__SUBSECTION.html#o6">02456</a>     ULONGLONG <a class="code" href="../../d5/d5/struct__MMPTE__SUBSECTION.html#o1">Prototype</a> : 1;
<a name="l02457"></a><a class="code" href="../../d5/d5/struct__MMPTE__SUBSECTION.html#o8">02457</a>     ULONGLONG <a class="code" href="../../d5/d5/struct__MMPTE__SUBSECTION.html#o3">Protection</a> : 5;
<a name="l02458"></a><a class="code" href="../../d5/d5/struct__MMPTE__SUBSECTION.html#o7">02458</a>     ULONGLONG <a class="code" href="../../d5/d5/struct__MMPTE__SUBSECTION.html#o2">WhichPool</a> : 1;
<a name="l02459"></a><a class="code" href="../../d5/d5/struct__MMPTE__SUBSECTION.html#o13">02459</a>     ULONGLONG <a class="code" href="../../d5/d5/struct__MMPTE__SUBSECTION.html#o13">Rsvd</a> : 4;
<a name="l02460"></a><a class="code" href="../../d5/d5/struct__MMPTE__SUBSECTION.html#o14">02460</a>     ULONGLONG <a class="code" href="../../d5/d5/struct__MMPTE__SUBSECTION.html#o4">SubsectionAddress</a> : 52;
02461 } <a class="code" href="../../d5/d5/struct__MMPTE__SUBSECTION.html">MMPTE_SUBSECTION</a>;
02462 
02463 <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d2/d5/struct__MMPTE__LIST.html">_MMPTE_LIST</a> {
<a name="l02464"></a><a class="code" href="../../d2/d5/struct__MMPTE__LIST.html#o5">02464</a>     ULONGLONG <a class="code" href="../../d2/d5/struct__MMPTE__LIST.html#o0">Valid</a> : 1;
<a name="l02465"></a><a class="code" href="../../d2/d5/struct__MMPTE__LIST.html#o7">02465</a>     ULONGLONG <a class="code" href="../../d2/d5/struct__MMPTE__LIST.html#o2">OneEntry</a> : 1;
<a name="l02466"></a><a class="code" href="../../d2/d5/struct__MMPTE__LIST.html#o11">02466</a>     ULONGLONG <a class="code" href="../../d2/d5/struct__MMPTE__LIST.html#o10">filler10</a> : 10;
<a name="l02467"></a><a class="code" href="../../d2/d5/struct__MMPTE__LIST.html#o9">02467</a>     ULONGLONG <a class="code" href="../../d2/d5/struct__MMPTE__LIST.html#o4">NextEntry</a> : 32;
<a name="l02468"></a><a class="code" href="../../d2/d5/struct__MMPTE__LIST.html#o12">02468</a>     ULONGLONG <a class="code" href="../../d2/d5/struct__MMPTE__LIST.html#o12">Rsvd</a> : 20;
02469 } <a class="code" href="../../d2/d5/struct__MMPTE__LIST.html">MMPTE_LIST</a>;
02470 
02471 
02472 <span class="comment">//</span>
02473 <span class="comment">// A Page Table Entry on an Intel IA64 has the following definition.</span>
02474 <span class="comment">//</span>
02475 
<a name="l02476"></a><a class="code" href="../../d2/d9/miia64_8h.html#a200">02476</a> <span class="preprocessor">#define _HARDWARE_PTE_WORKING_SET_BITS  11</span>
02477 <span class="preprocessor"></span>
02478 <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d0/d5/struct__MMPTE__HARDWARE.html">_MMPTE_HARDWARE</a> {
<a name="l02479"></a><a class="code" href="../../d0/d5/struct__MMPTE__HARDWARE.html#o13">02479</a>     ULONGLONG <a class="code" href="../../d0/d5/struct__MMPTE__HARDWARE.html#o0">Valid</a> : 1;
<a name="l02480"></a><a class="code" href="../../d0/d5/struct__MMPTE__HARDWARE.html#o14">02480</a>     ULONGLONG <a class="code" href="../../d0/d5/struct__MMPTE__HARDWARE.html#o14">Rsvd0</a> : 1;
<a name="l02481"></a><a class="code" href="../../d0/d5/struct__MMPTE__HARDWARE.html#o15">02481</a>     ULONGLONG <a class="code" href="../../d0/d5/struct__MMPTE__HARDWARE.html#o15">Cache</a> : 3;
<a name="l02482"></a><a class="code" href="../../d0/d5/struct__MMPTE__HARDWARE.html#o16">02482</a>     ULONGLONG <a class="code" href="../../d0/d5/struct__MMPTE__HARDWARE.html#o5">Accessed</a> : 1;
<a name="l02483"></a><a class="code" href="../../d0/d5/struct__MMPTE__HARDWARE.html#o17">02483</a>     ULONGLONG <a class="code" href="../../d0/d5/struct__MMPTE__HARDWARE.html#o6">Dirty</a> : 1;
<a name="l02484"></a><a class="code" href="../../d0/d5/struct__MMPTE__HARDWARE.html#o18">02484</a>     ULONGLONG <a class="code" href="../../d0/d5/struct__MMPTE__HARDWARE.html#o2">Owner</a> : 2;
<a name="l02485"></a><a class="code" href="../../d0/d5/struct__MMPTE__HARDWARE.html#o19">02485</a>     ULONGLONG <a class="code" href="../../d0/d5/struct__MMPTE__HARDWARE.html#o19">Execute</a> : 1;
<a name="l02486"></a><a class="code" href="../../d0/d5/struct__MMPTE__HARDWARE.html#o20">02486</a>     ULONGLONG <a class="code" href="../../d0/d5/struct__MMPTE__HARDWARE.html#o11">Write</a> : 1;
<a name="l02487"></a><a class="code" href="../../d0/d5/struct__MMPTE__HARDWARE.html#o21">02487</a>     ULONGLONG <a class="code" href="../../d0/d5/struct__MMPTE__HARDWARE.html#o21">Rsvd1</a> : <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a> - 12;
<a name="l02488"></a><a class="code" href="../../d0/d5/struct__MMPTE__HARDWARE.html#o22">02488</a>     ULONGLONG <a class="code" href="../../d0/d5/struct__MMPTE__HARDWARE.html#o9">CopyOnWrite</a> : 1;
<a name="l02489"></a><a class="code" href="../../d0/d5/struct__MMPTE__HARDWARE.html#o23">02489</a>     ULONGLONG <a class="code" href="../../d0/d5/struct__MMPTE__HARDWARE.html#o12">PageFrameNumber</a> : 50 - <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
<a name="l02490"></a><a class="code" href="../../d0/d5/struct__MMPTE__HARDWARE.html#o24">02490</a>     ULONGLONG <a class="code" href="../../d0/d5/struct__MMPTE__HARDWARE.html#o24">Rsvd2</a> : 2;
<a name="l02491"></a><a class="code" href="../../d0/d5/struct__MMPTE__HARDWARE.html#o25">02491</a>     ULONGLONG <a class="code" href="../../d0/d5/struct__MMPTE__HARDWARE.html#o25">Exception</a> : 1;
<a name="l02492"></a><a class="code" href="../../d0/d5/struct__MMPTE__HARDWARE.html#o26">02492</a>     ULONGLONG <a class="code" href="../../d0/d5/struct__MMPTE__HARDWARE.html#o26">SoftwareWsIndex</a> : <a class="code" href="../../d2/d9/miia64_8h.html#a200">_HARDWARE_PTE_WORKING_SET_BITS</a>;
02493 } <a class="code" href="../../d0/d5/struct__MMPTE__HARDWARE.html">MMPTE_HARDWARE</a>, *<a class="code" href="../../d0/d5/struct__MMPTE__HARDWARE.html">PMMPTE_HARDWARE</a>;
02494 
<a name="l02495"></a><a class="code" href="../../d1/d5/struct__MMPTE__LARGEPAGE.html">02495</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d1/d5/struct__MMPTE__LARGEPAGE.html">_MMPTE_LARGEPAGE</a> {
<a name="l02496"></a><a class="code" href="../../d1/d5/struct__MMPTE__LARGEPAGE.html#o0">02496</a>     ULONGLONG <a class="code" href="../../d1/d5/struct__MMPTE__LARGEPAGE.html#o0">Valid</a> : 1;
<a name="l02497"></a><a class="code" href="../../d1/d5/struct__MMPTE__LARGEPAGE.html#o1">02497</a>     ULONGLONG <a class="code" href="../../d1/d5/struct__MMPTE__LARGEPAGE.html#o1">Rsvd0</a> : 1;
<a name="l02498"></a><a class="code" href="../../d1/d5/struct__MMPTE__LARGEPAGE.html#o2">02498</a>     ULONGLONG <a class="code" href="../../d1/d5/struct__MMPTE__LARGEPAGE.html#o2">Cache</a> : 3;
<a name="l02499"></a><a class="code" href="../../d1/d5/struct__MMPTE__LARGEPAGE.html#o3">02499</a>     ULONGLONG <a class="code" href="../../d1/d5/struct__MMPTE__LARGEPAGE.html#o3">Accessed</a> : 1;
<a name="l02500"></a><a class="code" href="../../d1/d5/struct__MMPTE__LARGEPAGE.html#o4">02500</a>     ULONGLONG <a class="code" href="../../d1/d5/struct__MMPTE__LARGEPAGE.html#o4">Dirty</a> : 1;
<a name="l02501"></a><a class="code" href="../../d1/d5/struct__MMPTE__LARGEPAGE.html#o5">02501</a>     ULONGLONG <a class="code" href="../../d1/d5/struct__MMPTE__LARGEPAGE.html#o5">Owner</a> : 2;
<a name="l02502"></a><a class="code" href="../../d1/d5/struct__MMPTE__LARGEPAGE.html#o6">02502</a>     ULONGLONG <a class="code" href="../../d1/d5/struct__MMPTE__LARGEPAGE.html#o6">Execute</a> : 1;
<a name="l02503"></a><a class="code" href="../../d1/d5/struct__MMPTE__LARGEPAGE.html#o7">02503</a>     ULONGLONG <a class="code" href="../../d1/d5/struct__MMPTE__LARGEPAGE.html#o7">Write</a> : 1;
<a name="l02504"></a><a class="code" href="../../d1/d5/struct__MMPTE__LARGEPAGE.html#o8">02504</a>     ULONGLONG <a class="code" href="../../d1/d5/struct__MMPTE__LARGEPAGE.html#o8">Rsvd1</a> : <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a> - 12;
<a name="l02505"></a><a class="code" href="../../d1/d5/struct__MMPTE__LARGEPAGE.html#o9">02505</a>     ULONGLONG <a class="code" href="../../d1/d5/struct__MMPTE__LARGEPAGE.html#o9">CopyOnWrite</a> : 1;
<a name="l02506"></a><a class="code" href="../../d1/d5/struct__MMPTE__LARGEPAGE.html#o10">02506</a>     ULONGLONG <a class="code" href="../../d1/d5/struct__MMPTE__LARGEPAGE.html#o10">PageFrameNumber</a> : 50 - <a class="code" href="../../d6/d7/halmips_8h.html#a447">PAGE_SHIFT</a>;
<a name="l02507"></a><a class="code" href="../../d1/d5/struct__MMPTE__LARGEPAGE.html#o11">02507</a>     ULONGLONG <a class="code" href="../../d1/d5/struct__MMPTE__LARGEPAGE.html#o11">Rsvd2</a> : 2;
<a name="l02508"></a><a class="code" href="../../d1/d5/struct__MMPTE__LARGEPAGE.html#o12">02508</a>     ULONGLONG <a class="code" href="../../d1/d5/struct__MMPTE__LARGEPAGE.html#o12">Exception</a> : 1;
<a name="l02509"></a><a class="code" href="../../d1/d5/struct__MMPTE__LARGEPAGE.html#o13">02509</a>     ULONGLONG <a class="code" href="../../d1/d5/struct__MMPTE__LARGEPAGE.html#o13">Rsvd3</a> : 1;
<a name="l02510"></a><a class="code" href="../../d1/d5/struct__MMPTE__LARGEPAGE.html#o14">02510</a>     ULONGLONG <a class="code" href="../../d1/d5/struct__MMPTE__LARGEPAGE.html#o14">LargePage</a> : 1;
<a name="l02511"></a><a class="code" href="../../d1/d5/struct__MMPTE__LARGEPAGE.html#o15">02511</a>     ULONGLONG <a class="code" href="../../d1/d5/struct__MMPTE__LARGEPAGE.html#o15">PageSize</a> : 6;
<a name="l02512"></a><a class="code" href="../../d1/d5/struct__MMPTE__LARGEPAGE.html#o16">02512</a>     ULONGLONG <a class="code" href="../../d1/d5/struct__MMPTE__LARGEPAGE.html#o16">Rsvd4</a> : 3;
02513 } <a class="code" href="../../d1/d5/struct__MMPTE__LARGEPAGE.html">MMPTE_LARGEPAGE</a>, *<a class="code" href="../../d1/d5/struct__MMPTE__LARGEPAGE.html">PMMPTE_LARGEPAGE</a>;
02514 
<a name="l02515"></a><a class="code" href="../../d5/d6/struct__ALT__4KPTE.html">02515</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d5/d6/struct__ALT__4KPTE.html">_ALT_4KPTE</a> {
<a name="l02516"></a><a class="code" href="../../d5/d6/struct__ALT__4KPTE.html#o0">02516</a>     ULONGLONG <a class="code" href="../../d5/d6/struct__ALT__4KPTE.html#o0">Commit</a> : 1;
<a name="l02517"></a><a class="code" href="../../d5/d6/struct__ALT__4KPTE.html#o1">02517</a>     ULONGLONG <a class="code" href="../../d5/d6/struct__ALT__4KPTE.html#o1">Rsvd0</a> : 1;
<a name="l02518"></a><a class="code" href="../../d5/d6/struct__ALT__4KPTE.html#o2">02518</a>     ULONGLONG <a class="code" href="../../d5/d6/struct__ALT__4KPTE.html#o2">Cache</a> : 3;
<a name="l02519"></a><a class="code" href="../../d5/d6/struct__ALT__4KPTE.html#o3">02519</a>     ULONGLONG <a class="code" href="../../d5/d6/struct__ALT__4KPTE.html#o3">Accessed</a> : 1;
<a name="l02520"></a><a class="code" href="../../d5/d6/struct__ALT__4KPTE.html#o4">02520</a>     ULONGLONG <a class="code" href="../../d5/d6/struct__ALT__4KPTE.html#o4">Dirty</a> : 1;
<a name="l02521"></a><a class="code" href="../../d5/d6/struct__ALT__4KPTE.html#o5">02521</a>     ULONGLONG <a class="code" href="../../d5/d6/struct__ALT__4KPTE.html#o5">Owner</a> : 2;
<a name="l02522"></a><a class="code" href="../../d5/d6/struct__ALT__4KPTE.html#o6">02522</a>     ULONGLONG <a class="code" href="../../d5/d6/struct__ALT__4KPTE.html#o6">Execute</a> : 1;
<a name="l02523"></a><a class="code" href="../../d5/d6/struct__ALT__4KPTE.html#o7">02523</a>     ULONGLONG <a class="code" href="../../d5/d6/struct__ALT__4KPTE.html#o7">Write</a> : 1;
<a name="l02524"></a><a class="code" href="../../d5/d6/struct__ALT__4KPTE.html#o8">02524</a>     ULONGLONG <a class="code" href="../../d5/d6/struct__ALT__4KPTE.html#o8">Rsvd1</a> : 1;
<a name="l02525"></a><a class="code" href="../../d5/d6/struct__ALT__4KPTE.html#o9">02525</a>     ULONGLONG <a class="code" href="../../d5/d6/struct__ALT__4KPTE.html#o9">PteOffset</a> : 32;
<a name="l02526"></a><a class="code" href="../../d5/d6/struct__ALT__4KPTE.html#o10">02526</a>     ULONGLONG <a class="code" href="../../d5/d6/struct__ALT__4KPTE.html#o10">Rsvd2</a> : 8;
<a name="l02527"></a><a class="code" href="../../d5/d6/struct__ALT__4KPTE.html#o11">02527</a>     ULONGLONG <a class="code" href="../../d5/d6/struct__ALT__4KPTE.html#o11">Exception</a> : 1;
<a name="l02528"></a><a class="code" href="../../d5/d6/struct__ALT__4KPTE.html#o12">02528</a>     ULONGLONG <a class="code" href="../../d5/d6/struct__ALT__4KPTE.html#o12">Protection</a> : 5;
<a name="l02529"></a><a class="code" href="../../d5/d6/struct__ALT__4KPTE.html#o13">02529</a>     ULONGLONG <a class="code" href="../../d5/d6/struct__ALT__4KPTE.html#o13">Lock</a> : 1;
<a name="l02530"></a><a class="code" href="../../d5/d6/struct__ALT__4KPTE.html#o14">02530</a>     ULONGLONG <a class="code" href="../../d5/d6/struct__ALT__4KPTE.html#o14">FillZero</a> : 1;
<a name="l02531"></a><a class="code" href="../../d5/d6/struct__ALT__4KPTE.html#o15">02531</a>     ULONGLONG <a class="code" href="../../d5/d6/struct__ALT__4KPTE.html#o15">NoAccess</a> : 1;
<a name="l02532"></a><a class="code" href="../../d5/d6/struct__ALT__4KPTE.html#o16">02532</a>     ULONGLONG <a class="code" href="../../d5/d6/struct__ALT__4KPTE.html#o16">CopyOnWrite</a> : 1;
<a name="l02533"></a><a class="code" href="../../d5/d6/struct__ALT__4KPTE.html#o17">02533</a>     ULONGLONG <a class="code" href="../../d5/d6/struct__ALT__4KPTE.html#o17">PteIndirect</a> : 1;
<a name="l02534"></a><a class="code" href="../../d5/d6/struct__ALT__4KPTE.html#o18">02534</a>     ULONGLONG <a class="code" href="../../d5/d6/struct__ALT__4KPTE.html#o18">Private</a> : 1;
02535 } <a class="code" href="../../d5/d6/struct__ALT__4KPTE.html">ALT_4KPTE</a>, *<a class="code" href="../../d5/d6/struct__ALT__4KPTE.html">PALT_4KPTE</a>;
02536 
<a name="l02537"></a><a class="code" href="../../d2/d9/miia64_8h.html#a201">02537</a> <span class="preprocessor">#define MI_GET_PAGE_FRAME_FROM_PTE(PTE) ((ULONG)((PTE)-&gt;u.Hard.PageFrameNumber))</span>
<a name="l02538"></a><a class="code" href="../../d2/d9/miia64_8h.html#a202">02538</a> <span class="preprocessor"></span><span class="preprocessor">#define MI_GET_PAGE_FRAME_FROM_TRANSITION_PTE(PTE) ((ULONG)((PTE)-&gt;u.Trans.PageFrameNumber))</span>
<a name="l02539"></a><a class="code" href="../../d2/d9/miia64_8h.html#a203">02539</a> <span class="preprocessor"></span><span class="preprocessor">#define MI_GET_PROTECTION_FROM_SOFT_PTE(PTE) ((ULONG)((PTE)-&gt;u.Soft.Protection))</span>
<a name="l02540"></a><a class="code" href="../../d2/d9/miia64_8h.html#a204">02540</a> <span class="preprocessor"></span><span class="preprocessor">#define MI_GET_PROTECTION_FROM_TRANSITION_PTE(PTE) ((ULONG)((PTE)-&gt;u.Trans.Protection))</span>
02541 <span class="preprocessor"></span>
02542 
02543 <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d2/d4/struct__MMPTE.html">_MMPTE</a> {
02544     <span class="keyword">union  </span>{
<a name="l02545"></a><a class="code" href="../../d2/d4/struct__MMPTE.html#o13">02545</a>         ULONGLONG <a class="code" href="../../d2/d4/struct__MMPTE.html#o0">Long</a>;
<a name="l02546"></a><a class="code" href="../../d2/d4/struct__MMPTE.html#o11">02546</a>         <a class="code" href="../../d0/d5/struct__MMPTE__HARDWARE.html">MMPTE_HARDWARE</a> <a class="code" href="../../d2/d4/struct__MMPTE.html#o1">Hard</a>;
<a name="l02547"></a><a class="code" href="../../d2/d4/struct__MMPTE.html#o14">02547</a>         <a class="code" href="../../d1/d5/struct__MMPTE__LARGEPAGE.html">MMPTE_LARGEPAGE</a> <a class="code" href="../../d2/d4/struct__MMPTE.html#o14">Large</a>;
02548         HARDWARE_PTE <a class="code" href="../../d2/d4/struct__MMPTE.html#o2">Flush</a>;
02549         <a class="code" href="../../d3/d5/struct__MMPTE__PROTOTYPE.html">MMPTE_PROTOTYPE</a> <a class="code" href="../../d2/d4/struct__MMPTE.html#o3">Proto</a>;
02550         <a class="code" href="../../d4/d5/struct__MMPTE__SOFTWARE.html">MMPTE_SOFTWARE</a> <a class="code" href="../../d2/d4/struct__MMPTE.html#o4">Soft</a>;
02551         <a class="code" href="../../d6/d5/struct__MMPTE__TRANSITION.html">MMPTE_TRANSITION</a> <a class="code" href="../../d2/d4/struct__MMPTE.html#o5">Trans</a>;
02552         <a class="code" href="../../d5/d5/struct__MMPTE__SUBSECTION.html">MMPTE_SUBSECTION</a> <a class="code" href="../../d2/d4/struct__MMPTE.html#o7">Subsect</a>;
02553         <a class="code" href="../../d2/d5/struct__MMPTE__LIST.html">MMPTE_LIST</a> <a class="code" href="../../d2/d4/struct__MMPTE.html#o6">List</a>;
<a name="l02554"></a><a class="code" href="../../d2/d4/struct__MMPTE.html#o15">02554</a>         <a class="code" href="../../d5/d6/struct__ALT__4KPTE.html">ALT_4KPTE</a> <a class="code" href="../../d2/d4/struct__MMPTE.html#o15">Alt</a>;
02555         } u;
02556 } <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>;
02557 
<a name="l02558"></a><a class="code" href="../../d2/d9/miia64_8h.html#a294">02558</a> <span class="keyword">typedef</span> <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> *<a class="code" href="../../d2/d4/struct__MMPTE.html">PMMPTE</a>;
02559 
02560 <span class="comment">//++</span>
02561 <span class="comment">//VOID</span>
02562 <span class="comment">//MI_WRITE_VALID_PTE (</span>
02563 <span class="comment">//    IN PMMPTE PointerPte,</span>
02564 <span class="comment">//    IN MMPTE PteContents</span>
02565 <span class="comment">//    );</span>
02566 <span class="comment">//</span>
02567 <span class="comment">// Routine Description:</span>
02568 <span class="comment">//</span>
02569 <span class="comment">//    MI_WRITE_VALID_PTE fills in the specified PTE making it valid with the</span>
02570 <span class="comment">//    specified contents.</span>
02571 <span class="comment">//</span>
02572 <span class="comment">// Arguments</span>
02573 <span class="comment">//</span>
02574 <span class="comment">//    PointerPte - Supplies a PTE to fill.</span>
02575 <span class="comment">//</span>
02576 <span class="comment">//    PteContents - Supplies the contents to put in the PTE.</span>
02577 <span class="comment">//</span>
02578 <span class="comment">// Return Value:</span>
02579 <span class="comment">//</span>
02580 <span class="comment">//    None.</span>
02581 <span class="comment">//</span>
02582 <span class="comment">//--</span>
02583 
<a name="l02584"></a><a class="code" href="../../d2/d9/miia64_8h.html#a205">02584</a> <span class="preprocessor">#define MI_WRITE_VALID_PTE(_PointerPte, _PteContents)    \</span>
02585 <span class="preprocessor">            (*(_PointerPte) = (_PteContents))</span>
02586 <span class="preprocessor"></span>
02587 <span class="comment">//++</span>
02588 <span class="comment">//VOID</span>
02589 <span class="comment">//MI_WRITE_INVALID_PTE (</span>
02590 <span class="comment">//    IN PMMPTE PointerPte,</span>
02591 <span class="comment">//    IN MMPTE PteContents</span>
02592 <span class="comment">//    );</span>
02593 <span class="comment">//</span>
02594 <span class="comment">// Routine Description:</span>
02595 <span class="comment">//</span>
02596 <span class="comment">//    MI_WRITE_INVALID_PTE fills in the specified PTE making it invalid with the</span>
02597 <span class="comment">//    specified contents.</span>
02598 <span class="comment">//</span>
02599 <span class="comment">// Arguments</span>
02600 <span class="comment">//</span>
02601 <span class="comment">//    PointerPte - Supplies a PTE to fill.</span>
02602 <span class="comment">//</span>
02603 <span class="comment">//    PteContents - Supplies the contents to put in the PTE.</span>
02604 <span class="comment">//</span>
02605 <span class="comment">// Return Value:</span>
02606 <span class="comment">//</span>
02607 <span class="comment">//    None.</span>
02608 <span class="comment">//</span>
02609 <span class="comment">//--</span>
02610 
<a name="l02611"></a><a class="code" href="../../d2/d9/miia64_8h.html#a206">02611</a> <span class="preprocessor">#define MI_WRITE_INVALID_PTE(_PointerPte, _PteContents)  \</span>
02612 <span class="preprocessor">            (*(_PointerPte) = (_PteContents))</span>
02613 <span class="preprocessor"></span>
02614 <span class="comment">//++</span>
02615 <span class="comment">//VOID</span>
02616 <span class="comment">//MI_WRITE_VALID_PTE_NEW_PROTECTION (</span>
02617 <span class="comment">//    IN PMMPTE PointerPte,</span>
02618 <span class="comment">//    IN MMPTE PteContents</span>
02619 <span class="comment">//    );</span>
02620 <span class="comment">//</span>
02621 <span class="comment">// Routine Description:</span>
02622 <span class="comment">//</span>
02623 <span class="comment">//    MI_WRITE_VALID_PTE_NEW_PROTECTION fills in the specified PTE (which was</span>
02624 <span class="comment">//    already valid) changing only the protection or the dirty bit.</span>
02625 <span class="comment">//</span>
02626 <span class="comment">// Arguments</span>
02627 <span class="comment">//</span>
02628 <span class="comment">//    PointerPte - Supplies a PTE to fill.</span>
02629 <span class="comment">//</span>
02630 <span class="comment">//    PteContents - Supplies the contents to put in the PTE.</span>
02631 <span class="comment">//</span>
02632 <span class="comment">// Return Value:</span>
02633 <span class="comment">//</span>
02634 <span class="comment">//    None.</span>
02635 <span class="comment">//</span>
02636 <span class="comment">//--</span>
02637 
<a name="l02638"></a><a class="code" href="../../d2/d9/miia64_8h.html#a207">02638</a> <span class="preprocessor">#define MI_WRITE_VALID_PTE_NEW_PROTECTION(_PointerPte, _PteContents)    \</span>
02639 <span class="preprocessor">            (*(_PointerPte) = (_PteContents))</span>
02640 <span class="preprocessor"></span>
02641 <span class="comment">//</span>
02642 <span class="comment">// For EM build, need to export this function to ps/psldt.c</span>
02643 <span class="comment">//</span>
02644 
02645 <span class="keyword">extern</span> PVOID
02646 <a class="code" href="../../d4/d5/procsup_8c.html#a20">MiCreatePebOrTeb</a> (
02647     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> TargetProcess,
02648     IN ULONG Size
02649     );
02650 
02651 
02652 <span class="comment">//++</span>
02653 <span class="comment">//VOID</span>
02654 <span class="comment">//MiFillMemoryPte (</span>
02655 <span class="comment">//    IN PMMPTE Destination,</span>
02656 <span class="comment">//    IN ULONG  Length,</span>
02657 <span class="comment">//    IN MMPTE  Pattern,</span>
02658 <span class="comment">//    };</span>
02659 <span class="comment">//</span>
02660 <span class="comment">// Routine Description:</span>
02661 <span class="comment">//</span>
02662 <span class="comment">//    This function fills memory with the specified PTE pattern.</span>
02663 <span class="comment">//</span>
02664 <span class="comment">// Arguments</span>
02665 <span class="comment">//</span>
02666 <span class="comment">//    Destination - Supplies a pointer to the memory to fill.</span>
02667 <span class="comment">//</span>
02668 <span class="comment">//    Length      - Supplies the length, in bytes, of the memory to be</span>
02669 <span class="comment">//                  filled.</span>
02670 <span class="comment">//</span>
02671 <span class="comment">//    Pattern     - Supplies the PTE fill pattern.</span>
02672 <span class="comment">//</span>
02673 <span class="comment">// Return Value:</span>
02674 <span class="comment">//</span>
02675 <span class="comment">//    None.</span>
02676 <span class="comment">//</span>
02677 <span class="comment">//--</span>
02678 
<a name="l02679"></a><a class="code" href="../../d2/d9/miia64_8h.html#a208">02679</a> <span class="preprocessor">#define MiFillMemoryPte(Destination, Length, Pattern) \</span>
02680 <span class="preprocessor">             RtlFillMemoryUlonglong ((Destination), (Length), (Pattern))</span>
02681 <span class="preprocessor"></span>
02682 
<a name="l02683"></a><a class="code" href="../../d2/d9/miia64_8h.html#a209">02683</a> <span class="preprocessor">#define KiWbInvalidateCache</span>
02684 <span class="preprocessor"></span>
02685 
02686 <span class="comment">//++</span>
02687 <span class="comment">//BOOLEAN</span>
02688 <span class="comment">//MI_IS_PAGE_TABLE_ADDRESS (</span>
02689 <span class="comment">//    IN PVOID VA</span>
02690 <span class="comment">//    );</span>
02691 <span class="comment">//</span>
02692 <span class="comment">// Routine Description:</span>
02693 <span class="comment">//</span>
02694 <span class="comment">//    This macro determines if a given virtual address is really a</span>
02695 <span class="comment">//    page table address (PTE, PDE, PPE).</span>
02696 <span class="comment">//</span>
02697 <span class="comment">// Arguments</span>
02698 <span class="comment">//</span>
02699 <span class="comment">//    VA - Supplies the virtual address.</span>
02700 <span class="comment">//</span>
02701 <span class="comment">// Return Value:</span>
02702 <span class="comment">//</span>
02703 <span class="comment">//    FALSE if it is not a page table address, TRUE if it is.</span>
02704 <span class="comment">//</span>
02705 <span class="comment">//--</span>
02706 
02707 <span class="preprocessor">#if defined(_MIALT4K_)</span>
<a name="l02708"></a><a class="code" href="../../d2/d9/miia64_8h.html#a210">02708</a> <span class="preprocessor"></span><span class="preprocessor">#define MI_IS_PAGE_TABLE_ADDRESS(VA) \</span>
02709 <span class="preprocessor">    ((((ULONG_PTR)VA &gt;= PTE_UBASE) &amp;&amp; ((ULONG_PTR)VA &lt;= (PDE_UTBASE + PAGE_SIZE))) || \</span>
02710 <span class="preprocessor">     (((ULONG_PTR)VA &gt;= PTE_KBASE) &amp;&amp; ((ULONG_PTR)VA &lt;= (PDE_KTBASE + PAGE_SIZE))) || \</span>
02711 <span class="preprocessor">     (((ULONG_PTR)VA &gt;= PTE_SBASE) &amp;&amp; ((ULONG_PTR)VA &lt;= (PDE_STBASE + PAGE_SIZE))) || \</span>
02712 <span class="preprocessor">     (((ULONG_PTR)VA &gt;= ALT4KB_PERMISSION_TABLE_START) &amp;&amp; \</span>
02713 <span class="preprocessor">      ((ULONG_PTR)VA &lt;= ALT4KB_PERMISSION_TABLE_END)))</span>
02714 <span class="preprocessor"></span><span class="preprocessor">#else</span>
02715 <span class="preprocessor"></span><span class="preprocessor">#define MI_IS_PAGE_TABLE_ADDRESS(VA) \</span>
02716 <span class="preprocessor">    ((((ULONG_PTR)VA &gt;= PTE_UBASE) &amp;&amp; ((ULONG_PTR)VA &lt;= (PDE_UTBASE + PAGE_SIZE))) || \</span>
02717 <span class="preprocessor">     (((ULONG_PTR)VA &gt;= PTE_KBASE) &amp;&amp; ((ULONG_PTR)VA &lt;= (PDE_KTBASE + PAGE_SIZE))) || \</span>
02718 <span class="preprocessor">     (((ULONG_PTR)VA &gt;= PTE_SBASE) &amp;&amp; ((ULONG_PTR)VA &lt;= (PDE_STBASE + PAGE_SIZE))))</span>
02719 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
02720 <span class="preprocessor"></span>
02721 <span class="comment">//++</span>
02722 <span class="comment">//BOOLEAN</span>
02723 <span class="comment">//MI_IS_HYPER_SPACE_ADDRESS (</span>
02724 <span class="comment">//    IN PVOID VA</span>
02725 <span class="comment">//    );</span>
02726 <span class="comment">//</span>
02727 <span class="comment">// Routine Description:</span>
02728 <span class="comment">//</span>
02729 <span class="comment">//    This macro determines if a given virtual address resides in </span>
02730 <span class="comment">//    the hyper space.</span>
02731 <span class="comment">//</span>
02732 <span class="comment">// Arguments</span>
02733 <span class="comment">//</span>
02734 <span class="comment">//    VA - Supplies the virtual address.</span>
02735 <span class="comment">//</span>
02736 <span class="comment">// Return Value:</span>
02737 <span class="comment">//</span>
02738 <span class="comment">//    FALSE if it is not a hyper space address, TRUE if it is.</span>
02739 <span class="comment">//</span>
02740 <span class="comment">//--</span>
02741 
<a name="l02742"></a><a class="code" href="../../d2/d9/miia64_8h.html#a211">02742</a> <span class="preprocessor">#define MI_IS_HYPER_SPACE_ADDRESS(VA) \</span>
02743 <span class="preprocessor">    (((ULONG_PTR)VA &gt;= (ULONG_PTR)HYPER_SPACE) &amp;&amp; ((ULONG_PTR)VA &lt;= HYPER_SPACE_END))</span>
02744 <span class="preprocessor"></span>
02745 <span class="comment">//++</span>
02746 <span class="comment">//BOOLEAN</span>
02747 <span class="comment">//MI_IS_PTE_ADDRESS (</span>
02748 <span class="comment">//    IN PMMPTE PTE</span>
02749 <span class="comment">//    );</span>
02750 <span class="comment">//</span>
02751 <span class="comment">// Routine Description:</span>
02752 <span class="comment">//</span>
02753 <span class="comment">//    This macro determines if a given virtual address is really a</span>
02754 <span class="comment">//    page table page (PTE) address.</span>
02755 <span class="comment">//</span>
02756 <span class="comment">// Arguments</span>
02757 <span class="comment">//</span>
02758 <span class="comment">//    PTE - Supplies the PTE virtual address.</span>
02759 <span class="comment">//</span>
02760 <span class="comment">// Return Value:</span>
02761 <span class="comment">//</span>
02762 <span class="comment">//    FALSE if it is not a PTE address, TRUE if it is.</span>
02763 <span class="comment">//</span>
02764 <span class="comment">//--</span>
02765 
<a name="l02766"></a><a class="code" href="../../d2/d9/miia64_8h.html#a212">02766</a> <span class="preprocessor">#define MI_IS_PTE_ADDRESS(PTE) \</span>
02767 <span class="preprocessor">    (((PTE &gt;= (PMMPTE)PTE_UBASE) &amp;&amp; (PTE &lt;= (PMMPTE)PTE_UTOP)) || \</span>
02768 <span class="preprocessor">     ((PTE &gt;= (PMMPTE)PTE_KBASE) &amp;&amp; (PTE &lt;= (PMMPTE)PTE_KTOP)) || \</span>
02769 <span class="preprocessor">     ((PTE &gt;= (PMMPTE)PTE_SBASE) &amp;&amp; (PTE &lt;= (PMMPTE)PTE_STOP)))</span>
02770 <span class="preprocessor"></span>
02771 
<a name="l02772"></a><a class="code" href="../../d2/d9/miia64_8h.html#a213">02772</a> <span class="preprocessor">#define MI_IS_PPE_ADDRESS(PTE) \</span>
02773 <span class="preprocessor">    (((PTE &gt;= (PMMPTE)PDE_UTBASE) &amp;&amp; (PTE &lt;= (PMMPTE)(PDE_UTBASE + PAGE_SIZE))) || \</span>
02774 <span class="preprocessor">     ((PTE &gt;= (PMMPTE)PDE_KTBASE) &amp;&amp; (PTE &lt;= (PMMPTE)(PDE_KTBASE + PAGE_SIZE))) || \</span>
02775 <span class="preprocessor">     ((PTE &gt;= (PMMPTE)PDE_STBASE) &amp;&amp; (PTE &lt;= (PMMPTE)(PDE_STBASE + PAGE_SIZE))))</span>
02776 <span class="preprocessor"></span>
02777 <span class="comment">//++</span>
02778 <span class="comment">//BOOLEAN</span>
02779 <span class="comment">//MI_IS_KERNEL_PTE_ADDRESS (</span>
02780 <span class="comment">//    IN PMMPTE PTE</span>
02781 <span class="comment">//    );</span>
02782 <span class="comment">//</span>
02783 <span class="comment">// Routine Description:</span>
02784 <span class="comment">//</span>
02785 <span class="comment">//    This macro determines if a given virtual address is really a</span>
02786 <span class="comment">//    kernel page table page (PTE) address.</span>
02787 <span class="comment">//</span>
02788 <span class="comment">// Arguments</span>
02789 <span class="comment">//</span>
02790 <span class="comment">//    PTE - Supplies the PTE virtual address.</span>
02791 <span class="comment">//</span>
02792 <span class="comment">// Return Value:</span>
02793 <span class="comment">//</span>
02794 <span class="comment">//    FALSE if it is not a kernel PTE address, TRUE if it is.</span>
02795 <span class="comment">//</span>
02796 <span class="comment">//--</span>
02797 
<a name="l02798"></a><a class="code" href="../../d2/d9/miia64_8h.html#a214">02798</a> <span class="preprocessor">#define MI_IS_KERNEL_PTE_ADDRESS(PTE) \</span>
02799 <span class="preprocessor">     (((PMMPTE)PTE &gt;= (PMMPTE)PTE_KBASE) &amp;&amp; ((PMMPTE)PTE &lt;= (PMMPTE)PTE_KTOP))</span>
02800 <span class="preprocessor"></span>
02801 
02802 <span class="comment">//++</span>
02803 <span class="comment">//BOOLEAN</span>
02804 <span class="comment">//MI_IS_USER_PTE_ADDRESS (</span>
02805 <span class="comment">//    IN PMMPTE PTE</span>
02806 <span class="comment">//    );</span>
02807 <span class="comment">//</span>
02808 <span class="comment">// Routine Description:</span>
02809 <span class="comment">//</span>
02810 <span class="comment">//    This macro determines if a given virtual address is really a</span>
02811 <span class="comment">//    page table page (PTE) address.</span>
02812 <span class="comment">//</span>
02813 <span class="comment">// Arguments</span>
02814 <span class="comment">//</span>
02815 <span class="comment">//    PTE - Supplies the PTE virtual address.</span>
02816 <span class="comment">//</span>
02817 <span class="comment">// Return Value:</span>
02818 <span class="comment">//</span>
02819 <span class="comment">//    FALSE if it is not a PTE address, TRUE if it is.</span>
02820 <span class="comment">//</span>
02821 <span class="comment">//--</span>
02822 
<a name="l02823"></a><a class="code" href="../../d2/d9/miia64_8h.html#a215">02823</a> <span class="preprocessor">#define MI_IS_USER_PTE_ADDRESS(PTE) \</span>
02824 <span class="preprocessor">    ((PTE &gt;= (PMMPTE)PTE_UBASE) &amp;&amp; (PTE &lt;= (PMMPTE)PTE_UTOP))</span>
02825 <span class="preprocessor"></span>
02826 
02827 <span class="comment">//++</span>
02828 <span class="comment">//BOOLEAN</span>
02829 <span class="comment">//MI_IS_PAGE_DIRECTORY_ADDRESS (</span>
02830 <span class="comment">//    IN PMMPTE PDE</span>
02831 <span class="comment">//    );</span>
02832 <span class="comment">//</span>
02833 <span class="comment">// Routine Description:</span>
02834 <span class="comment">//</span>
02835 <span class="comment">//    This macro determines if a given virtual address is really a</span>
02836 <span class="comment">//    page directory page (PDE) address.</span>
02837 <span class="comment">//</span>
02838 <span class="comment">// Arguments</span>
02839 <span class="comment">//</span>
02840 <span class="comment">//    PDE - Supplies the virtual address.</span>
02841 <span class="comment">//</span>
02842 <span class="comment">// Return Value:</span>
02843 <span class="comment">//</span>
02844 <span class="comment">//    FALSE if it is not a PDE address, TRUE if it is.</span>
02845 <span class="comment">//</span>
02846 <span class="comment">//--</span>
02847 
<a name="l02848"></a><a class="code" href="../../d2/d9/miia64_8h.html#a216">02848</a> <span class="preprocessor">#define MI_IS_PAGE_DIRECTORY_ADDRESS(PDE) \</span>
02849 <span class="preprocessor">    (((PDE &gt;= (PMMPTE)PDE_UBASE) &amp;&amp; (PDE &lt;= (PMMPTE)PDE_UTOP)) || \</span>
02850 <span class="preprocessor">     ((PDE &gt;= (PMMPTE)PDE_KBASE) &amp;&amp; (PDE &lt;= (PMMPTE)PDE_KTOP)) || \</span>
02851 <span class="preprocessor">     ((PDE &gt;= (PMMPTE)PDE_SBASE) &amp;&amp; (PDE &lt;= (PMMPTE)PDE_STOP)))</span>
02852 <span class="preprocessor"></span>
02853 <span class="comment">//++</span>
02854 <span class="comment">//BOOLEAN</span>
02855 <span class="comment">//MI_IS_USER_PDE_ADDRESS (</span>
02856 <span class="comment">//    IN PMMPTE PDE</span>
02857 <span class="comment">//    );</span>
02858 <span class="comment">//</span>
02859 <span class="comment">// Routine Description:</span>
02860 <span class="comment">//</span>
02861 <span class="comment">//    This macro determines if a given virtual address is really a</span>
02862 <span class="comment">//    user page directory page (PDE) address.</span>
02863 <span class="comment">//</span>
02864 <span class="comment">// Arguments</span>
02865 <span class="comment">//</span>
02866 <span class="comment">//    PDE - Supplies the PDE virtual address.</span>
02867 <span class="comment">//</span>
02868 <span class="comment">// Return Value:</span>
02869 <span class="comment">//</span>
02870 <span class="comment">//    FALSE if it is not a user PDE address, TRUE if it is.</span>
02871 <span class="comment">//</span>
02872 <span class="comment">//--</span>
02873 
<a name="l02874"></a><a class="code" href="../../d2/d9/miia64_8h.html#a217">02874</a> <span class="preprocessor">#define MI_IS_USER_PDE_ADDRESS(PDE) \</span>
02875 <span class="preprocessor">    ((PDE &gt;= (PMMPTE)PDE_UBASE) &amp;&amp; (PDE &lt;= (PMMPTE)PDE_UTOP)) </span>
02876 <span class="preprocessor"></span>
02877 
02878 <span class="comment">//++</span>
02879 <span class="comment">//BOOLEAN</span>
02880 <span class="comment">//MI_IS_KERNEL_PDE_ADDRESS (</span>
02881 <span class="comment">//    IN PMMPTE PDE</span>
02882 <span class="comment">//    );</span>
02883 <span class="comment">//</span>
02884 <span class="comment">// Routine Description:</span>
02885 <span class="comment">//</span>
02886 <span class="comment">//    This macro determines if a given virtual address is really a</span>
02887 <span class="comment">//    kernel page directory page (PDE) address.</span>
02888 <span class="comment">//</span>
02889 <span class="comment">// Arguments</span>
02890 <span class="comment">//</span>
02891 <span class="comment">//    PDE - Supplies the PDE virtual address.</span>
02892 <span class="comment">//</span>
02893 <span class="comment">// Return Value:</span>
02894 <span class="comment">//</span>
02895 <span class="comment">//    FALSE if it is not a user PDE address, TRUE if it is.</span>
02896 <span class="comment">//</span>
02897 <span class="comment">//--</span>
02898 
<a name="l02899"></a><a class="code" href="../../d2/d9/miia64_8h.html#a218">02899</a> <span class="preprocessor">#define MI_IS_KERNEL_PDE_ADDRESS(PDE) \</span>
02900 <span class="preprocessor">    ((PDE &gt;= (PMMPTE)PDE_KBASE) &amp;&amp; (PDE &lt;= (PMMPTE)PDE_KTOP)) </span>
02901 <span class="preprocessor"></span>
02902 
02903 <span class="comment">//++</span>
02904 <span class="comment">//BOOLEAN</span>
02905 <span class="comment">//MI_IS_PROCESS_SPACE_ADDRESS (</span>
02906 <span class="comment">//    IN PVOID VA</span>
02907 <span class="comment">//    );</span>
02908 <span class="comment">//</span>
02909 <span class="comment">// Routine Description:</span>
02910 <span class="comment">//</span>
02911 <span class="comment">//    This macro determines if a given virtual address resides in </span>
02912 <span class="comment">//    the per-process space.</span>
02913 <span class="comment">//</span>
02914 <span class="comment">// Arguments</span>
02915 <span class="comment">//</span>
02916 <span class="comment">//    VA - Supplies the virtual address.</span>
02917 <span class="comment">//</span>
02918 <span class="comment">// Return Value:</span>
02919 <span class="comment">//</span>
02920 <span class="comment">//    FALSE if it is not a per-process address, TRUE if it is.</span>
02921 <span class="comment">//</span>
02922 <span class="comment">//--</span>
02923 
<a name="l02924"></a><a class="code" href="../../d2/d9/miia64_8h.html#a219">02924</a> <span class="preprocessor">#define MI_IS_PROCESS_SPACE_ADDRESS(VA) (((ULONG_PTR)VA &gt;&gt; 61) == UREGION_INDEX)</span>
02925 <span class="preprocessor"></span>
02926 <span class="comment">//++</span>
02927 <span class="comment">//BOOLEAN</span>
02928 <span class="comment">//MI_IS_SYSTEM_ADDRESS (</span>
02929 <span class="comment">//    IN PVOID VA</span>
02930 <span class="comment">//    );</span>
02931 <span class="comment">//</span>
02932 <span class="comment">// Routine Description:</span>
02933 <span class="comment">//</span>
02934 <span class="comment">//    This macro determines if a given virtual address resides in </span>
02935 <span class="comment">//    the system (global) space.</span>
02936 <span class="comment">//</span>
02937 <span class="comment">// Arguments</span>
02938 <span class="comment">//</span>
02939 <span class="comment">//    VA - Supplies the virtual address.</span>
02940 <span class="comment">//</span>
02941 <span class="comment">// Return Value:</span>
02942 <span class="comment">//</span>
02943 <span class="comment">//    FALSE if it is not a system (global) address, TRUE if it is.</span>
02944 <span class="comment">//</span>
02945 <span class="comment">//--</span>
02946 
<a name="l02947"></a><a class="code" href="../../d2/d9/miia64_8h.html#a220">02947</a> <span class="preprocessor">#define MI_IS_SYSTEM_ADDRESS(VA) (((ULONG_PTR)VA &gt;&gt; 61) == KREGION_INDEX)</span>
02948 <span class="preprocessor"></span>
02949 
02950 <span class="comment">//</span>
02951 <span class="comment">// Generate kernel segment physical address</span>
02952 <span class="comment">//</span>
02953 
02954 <span class="comment">//PVOID</span>
02955 <span class="comment">//MiGetKSegAddress (</span>
02956 <span class="comment">//    PFN_NUMBER FrameNumber</span>
02957 <span class="comment">//    );</span>
02958 
02959 <span class="comment">//</span>
02960 <span class="comment">//++</span>
02961 <span class="comment">//PVOID</span>
02962 <span class="comment">//KSEG_ADDRESS (</span>
02963 <span class="comment">//    IN ULONG PAGE</span>
02964 <span class="comment">//    );</span>
02965 <span class="comment">//</span>
02966 <span class="comment">// Routine Description:</span>
02967 <span class="comment">//</span>
02968 <span class="comment">//    This macro returns a KSEG virtual address which maps the page.</span>
02969 <span class="comment">//</span>
02970 <span class="comment">// Arguments:</span>
02971 <span class="comment">//</span>
02972 <span class="comment">//    PAGE - Supplies the physical page frame number</span>
02973 <span class="comment">//</span>
02974 <span class="comment">// Return Value:</span>
02975 <span class="comment">//</span>
02976 <span class="comment">//    The address of the KSEG address</span>
02977 <span class="comment">//</span>
02978 <span class="comment">//--</span>
02979 
02980 <span class="comment">// #define KSEG_ADDRESS(PAGE) ((PVOID)(KSEG3_BASE | ((ULONG_PTR)(PAGE) &lt;&lt; PAGE_SHIFT)))</span>
02981 
02982 <span class="comment">// #define KSEG_ADDRESS(PAGE) MiGetKSegAddress ((ULONG)PAGE)</span>
02983 
02984 
02985 <span class="comment">//</span>
02986 <span class="comment">//++</span>
02987 <span class="comment">//PVOID</span>
02988 <span class="comment">//KSEG0_ADDRESS (</span>
02989 <span class="comment">//    IN ULONG PAGE</span>
02990 <span class="comment">//    );</span>
02991 <span class="comment">//</span>
02992 <span class="comment">// Routine Description:</span>
02993 <span class="comment">//</span>
02994 <span class="comment">//    This macro returns a KSEG0 virtual address which maps the page.</span>
02995 <span class="comment">//</span>
02996 <span class="comment">// Arguments:</span>
02997 <span class="comment">//</span>
02998 <span class="comment">//    PAGE - Supplies the physical page frame number</span>
02999 <span class="comment">//</span>
03000 <span class="comment">// Return Value:</span>
03001 <span class="comment">//</span>
03002 <span class="comment">//    The address of the KSEG address</span>
03003 <span class="comment">//</span>
03004 <span class="comment">//--</span>
03005 
<a name="l03006"></a><a class="code" href="../../d2/d9/miia64_8h.html#a221">03006</a> <span class="preprocessor">#define KSEG0_ADDRESS(PAGE) \</span>
03007 <span class="preprocessor">     (PVOID)(KSEG0_BASE | ((PAGE) &lt;&lt;  PAGE_SHIFT)) </span>
03008 <span class="preprocessor"></span>
03009 
<a name="l03010"></a><a class="code" href="../../d2/d9/miia64_8h.html#a295">03010</a> <span class="keyword">extern</span> <a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a> <a class="code" href="../../d3/d2/dataia64_8c.html#a9">ValidPpePte</a>;
03011 
<a name="l03012"></a><a class="code" href="../../d2/d9/miia64_8h.html#a296">03012</a> <span class="keyword">extern</span> PFN_NUMBER <a class="code" href="../../d6/d2/mm_2ia64_2initia64_8c.html#a20">MmSystemParentTablePage</a>;
03013 
03014 <span class="comment">//++</span>
03015 <span class="comment">//PMMPTE</span>
03016 <span class="comment">//MiGetPpeAddress (</span>
03017 <span class="comment">//    IN PVOID va</span>
03018 <span class="comment">//    );</span>
03019 <span class="comment">//</span>
03020 <span class="comment">// Routine Description:</span>
03021 <span class="comment">//</span>
03022 <span class="comment">//    MiGetPpeAddress returns the address of the page directory parent entry</span>
03023 <span class="comment">//    which maps the given virtual address.  This is one level above the</span>
03024 <span class="comment">//    page directory.</span>
03025 <span class="comment">//</span>
03026 <span class="comment">// Arguments</span>
03027 <span class="comment">//</span>
03028 <span class="comment">//    Va - Supplies the virtual address to locate the PPE for.</span>
03029 <span class="comment">//</span>
03030 <span class="comment">// Return Value:</span>
03031 <span class="comment">//</span>
03032 <span class="comment">//    The address of the PPE.   // LWFIX: expand for 3 level</span>
03033 <span class="comment">//</span>
03034 <span class="comment">//--</span>
03035 
03036 <span class="preprocessor">#if PTE_THASH</span>
03037 <span class="preprocessor"></span>
03038 __inline
03039 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a214">PMMPTE</a>
03040 MiGetPpeAddress_XX(
03041     IN PVOID Va
03042     )
03043 {
03044     <span class="keywordflow">if</span> (((ULONG_PTR)(Va) &amp; PTE_BASE) == PTE_BASE) {
03045         
03046         <span class="keywordflow">return</span> ((<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a214">PMMPTE</a>)(((ULONG_PTR)Va &amp; VRN_MASK) | (PDE_TBASE + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>))));
03047 
03048     } <span class="keywordflow">else</span> {
03049 
03050         <span class="keywordflow">return</span> ((<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a214">PMMPTE</a>)(__thash(__thash(__thash((ULONG_PTR)Va)))));
03051 
03052     }
03053 }
03054 
03055 <span class="preprocessor">#define MiGetPpeAddress(va) MiGetPpeAddress_XX((PVOID)(va))</span>
03056 <span class="preprocessor"></span>
03057 <span class="preprocessor">#else</span>
03058 <span class="preprocessor"></span>
<a name="l03059"></a><a class="code" href="../../d2/d9/miia64_8h.html#a222">03059</a> <span class="preprocessor">#define MiGetPpeAddress(Va) \</span>
03060 <span class="preprocessor">  (((((ULONG_PTR)(Va)) &amp; PTE_BASE) == PTE_BASE) ? \</span>
03061 <span class="preprocessor">   ((PMMPTE)((((ULONG_PTR)(Va)) &amp; VRN_MASK) | (PDE_TBASE + PAGE_SIZE - sizeof(MMPTE)))) :\</span>
03062 <span class="preprocessor">   ((PMMPTE)(((((ULONG_PTR)(Va)) &amp; VRN_MASK)) | \</span>
03063 <span class="preprocessor">              ((((((ULONG_PTR)(Va)) &gt;&gt; PDI1_SHIFT) &lt;&lt; PTE_SHIFT) &amp; \</span>
03064 <span class="preprocessor">                (~(PDE_TBASE|VRN_MASK)) ) + PDE_TBASE))))</span>
03065 <span class="preprocessor"></span>
03066 <span class="preprocessor">#endif</span>
03067 <span class="preprocessor"></span>
03068 <span class="comment">//MiGetPdeAddress (</span>
03069 <span class="comment">//    IN PVOID va</span>
03070 <span class="comment">//    );</span>
03071 <span class="comment">//</span>
03072 <span class="comment">// Routine Description:</span>
03073 <span class="comment">//</span>
03074 <span class="comment">//    MiGetPdeAddress returns the address of the PDE which maps the</span>
03075 <span class="comment">//    given virtual address.</span>
03076 <span class="comment">//</span>
03077 <span class="comment">// Argments</span>
03078 <span class="comment">//</span>
03079 <span class="comment">//    Va - Supplies the virtual address to locate the PDE for.</span>
03080 <span class="comment">//</span>
03081 <span class="comment">// Return Value:</span>
03082 <span class="comment">//</span>
03083 <span class="comment">//    The address of the PDE.</span>
03084 <span class="comment">//</span>
03085 <span class="comment">//--</span>
03086 
03087 <span class="preprocessor">#if PTE_THASH</span>
03088 <span class="preprocessor"></span>
03089 __inline
03090 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a214">PMMPTE</a>
03091 MiGetPdeAddress_XX(
03092     IN PVOID Va
03093     )
03094 {
03095     <span class="keywordflow">if</span> (((ULONG_PTR)(Va) &amp; PDE_BASE) == PDE_BASE) {
03096         
03097         <span class="keywordflow">return</span> ((<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a214">PMMPTE</a>)(((ULONG_PTR)Va &amp; VRN_MASK) | (PDE_TBASE + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>))));
03098 
03099     } <span class="keywordflow">else</span> {
03100 
03101        <span class="keywordflow">return</span> ((<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a214">PMMPTE</a>)(__thash(__thash((ULONG_PTR)(Va)))));
03102     }
03103 }
03104 
03105 <span class="preprocessor">#define MiGetPdeAddress(va) MiGetPdeAddress_XX((PVOID)(va))</span>
03106 <span class="preprocessor"></span>
03107 <span class="preprocessor">#else</span>
03108 <span class="preprocessor"></span>
<a name="l03109"></a><a class="code" href="../../d2/d9/miia64_8h.html#a223">03109</a> <span class="preprocessor">#define MiGetPdeAddress(Va) \</span>
03110 <span class="preprocessor">  (((((ULONG_PTR)(Va)) &amp; PDE_BASE) == PDE_BASE) ? \</span>
03111 <span class="preprocessor">   ((PMMPTE)((((ULONG_PTR)(Va)) &amp; VRN_MASK) | (PDE_TBASE + PAGE_SIZE - sizeof(MMPTE)))) :\</span>
03112 <span class="preprocessor">   ((PMMPTE)(((((ULONG_PTR)(Va)) &amp; VRN_MASK)) | \</span>
03113 <span class="preprocessor">             ((((((ULONG_PTR)(Va)) &gt;&gt; PDI_SHIFT) &lt;&lt; PTE_SHIFT) &amp; (~(PDE_BASE|VRN_MASK))) + PDE_BASE))))</span>
03114 <span class="preprocessor"></span>
03115 <span class="preprocessor">#endif</span>
03116 <span class="preprocessor"></span>
03117 
03118 <span class="comment">//++</span>
03119 <span class="comment">//PMMPTE</span>
03120 <span class="comment">//MiGetPteAddress (</span>
03121 <span class="comment">//    IN PVOID va</span>
03122 <span class="comment">//    );</span>
03123 <span class="comment">//</span>
03124 <span class="comment">// Routine Description:</span>
03125 <span class="comment">//</span>
03126 <span class="comment">//    MiGetPteAddress returns the address of the PTE which maps the</span>
03127 <span class="comment">//    given virtual address.</span>
03128 <span class="comment">//</span>
03129 <span class="comment">// Argments</span>
03130 <span class="comment">//</span>
03131 <span class="comment">//    Va - Supplies the virtual address to locate the PTE for.</span>
03132 <span class="comment">//</span>
03133 <span class="comment">// Return Value:</span>
03134 <span class="comment">//</span>
03135 <span class="comment">//    The address of the PTE.</span>
03136 <span class="comment">//</span>
03137 <span class="comment">//--</span>
03138 
03139 <span class="preprocessor">#if PTE_THASH</span>
03140 <span class="preprocessor"></span>
03141 __inline
03142 <a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a214">PMMPTE</a>
03143 MiGetPteAddress_XX(
03144     IN PVOID Va
03145     )
03146 {
03147     <span class="keywordflow">if</span> (((ULONG_PTR)(Va) &amp; PDE_TBASE) == PDE_TBASE) {
03148         
03149         <span class="keywordflow">return</span> ((<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a214">PMMPTE</a>)(((ULONG_PTR)Va &amp; VRN_MASK) | (PDE_TBASE + <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a> - <span class="keyword">sizeof</span>(<a class="code" href="../../d2/d4/struct__MMPTE.html">MMPTE</a>))));
03150 
03151     } <span class="keywordflow">else</span> {
03152 
03153         <span class="keywordflow">return</span> ((<a class="code" href="../../d8/d8/alpha_2mialpha_8h.html#a214">PMMPTE</a>)(__thash((ULONG_PTR)(Va))));
03154 
03155     }
03156 }
03157 
03158 <span class="preprocessor">#define MiGetPteAddress(va) MiGetPteAddress_XX((PVOID)(va))</span>
03159 <span class="preprocessor"></span>
03160 <span class="preprocessor">#else</span>
03161 <span class="preprocessor"></span>
<a name="l03162"></a><a class="code" href="../../d2/d9/miia64_8h.html#a224">03162</a> <span class="preprocessor">#define MiGetPteAddress(Va) \</span>
03163 <span class="preprocessor">  (((((ULONG_PTR)(Va)) &amp; PDE_TBASE) == PDE_TBASE) ? \</span>
03164 <span class="preprocessor">   ((PMMPTE)((((ULONG_PTR)(Va)) &amp; VRN_MASK) | (PDE_TBASE + PAGE_SIZE - sizeof(MMPTE)))) :\</span>
03165 <span class="preprocessor">   ((PMMPTE)(((((ULONG_PTR)(Va)) &amp; VRN_MASK)) | \</span>
03166 <span class="preprocessor">             ((((((ULONG_PTR)(Va)) &gt;&gt; PTI_SHIFT) &lt;&lt; PTE_SHIFT) &amp; (~(PTE_BASE|VRN_MASK))) + PTE_BASE))))</span>
03167 <span class="preprocessor"></span>
03168 <span class="preprocessor">#endif</span>
03169 <span class="preprocessor"></span>
03170 
<a name="l03171"></a><a class="code" href="../../d2/d9/miia64_8h.html#a225">03171</a> <span class="preprocessor">#define MI_IS_PTE_PROTOTYPE(PointerPte)  (!MI_IS_USER_PTE_ADDRESS (PointerPte))</span>
03172 <span class="preprocessor"></span>
03173 <span class="comment">//++</span>
03174 <span class="comment">//BOOLEAN</span>
03175 <span class="comment">//MI_IS_SYSTEM_CACHE_ADDRESS (</span>
03176 <span class="comment">//    IN PVOID VA</span>
03177 <span class="comment">//    );</span>
03178 <span class="comment">//</span>
03179 <span class="comment">// Routine Description:</span>
03180 <span class="comment">//</span>
03181 <span class="comment">//    This macro takes a virtual address and determines if</span>
03182 <span class="comment">//    it is a system cache address.</span>
03183 <span class="comment">//</span>
03184 <span class="comment">// Arguments</span>
03185 <span class="comment">//</span>
03186 <span class="comment">//    VA - Supplies a virtual address.</span>
03187 <span class="comment">//</span>
03188 <span class="comment">// Return Value:</span>
03189 <span class="comment">//</span>
03190 <span class="comment">//    TRUE if the address is in the system cache, FALSE if not.</span>
03191 <span class="comment">//</span>
03192 <span class="comment">//--</span>
03193 
<a name="l03194"></a><a class="code" href="../../d2/d9/miia64_8h.html#a226">03194</a> <span class="preprocessor">#define MI_IS_SYSTEM_CACHE_ADDRESS(VA)                      \</span>
03195 <span class="preprocessor">         (((PVOID)(VA) &gt;= (PVOID)MmSystemCacheStart &amp;&amp;      \</span>
03196 <span class="preprocessor">                     (PVOID)(VA) &lt;= (PVOID)MmSystemCacheEnd))</span>
03197 <span class="preprocessor"></span>
03198 
03199 <span class="preprocessor">#if defined(_MIALT4K_)</span>
03200 <span class="preprocessor"></span>
03201 <span class="comment">//</span>
03202 <span class="comment">// Define constants and macros for alternate 4kb table.</span>
03203 <span class="comment">//</span>
03204 <span class="comment">// These are constants and defines that mimic the PAGE_SIZE constant but are</span>
03205 <span class="comment">// hard coded to use 4K page values.</span>
03206 <span class="comment">//</span>
03207 
<a name="l03208"></a><a class="code" href="../../d2/d9/miia64_8h.html#a227">03208</a> <span class="preprocessor">#define PAGE_4K         4096</span>
<a name="l03209"></a><a class="code" href="../../d2/d9/miia64_8h.html#a228">03209</a> <span class="preprocessor"></span><span class="preprocessor">#define PAGE_4K_SHIFT   12</span>
<a name="l03210"></a><a class="code" href="../../d2/d9/miia64_8h.html#a229">03210</a> <span class="preprocessor"></span><span class="preprocessor">#define PAGE_4K_MASK    (PAGE_4K - 1)</span>
<a name="l03211"></a><a class="code" href="../../d2/d9/miia64_8h.html#a230">03211</a> <span class="preprocessor"></span><span class="preprocessor">#define PAGE_4K_ALIGN(Va) ((PVOID)((ULONG_PTR)(Va) &amp; ~(PAGE_4K - 1)))</span>
<a name="l03212"></a><a class="code" href="../../d2/d9/miia64_8h.html#a231">03212</a> <span class="preprocessor"></span><span class="preprocessor">#define ROUND_TO_4K_PAGES(Size)  (((ULONG_PTR)(Size) + PAGE_4K - 1) &amp; ~(PAGE_4K - 1))</span>
03213 <span class="preprocessor"></span>
<a name="l03214"></a><a class="code" href="../../d2/d9/miia64_8h.html#a232">03214</a> <span class="preprocessor">#define PAGE_NEXT_ALIGN(Va) ((PVOID)(PAGE_ALIGN((ULONG_PTR)Va + PAGE_SIZE - 1)))</span>
03215 <span class="preprocessor"></span>
<a name="l03216"></a><a class="code" href="../../d2/d9/miia64_8h.html#a233">03216</a> <span class="preprocessor">#define BYTES_TO_4K_PAGES(Size)  ((ULONG)((ULONG_PTR)(Size) &gt;&gt; PAGE_4K_SHIFT) + \</span>
03217 <span class="preprocessor">                               (((ULONG)(Size) &amp; (PAGE_4K - 1)) != 0))</span>
03218 <span class="preprocessor"></span>
03219 <span class="comment">//</span>
03220 <span class="comment">// Relative constants between native pages and 4K pages</span>
03221 <span class="comment">//</span>
03222 
<a name="l03223"></a><a class="code" href="../../d2/d9/miia64_8h.html#a234">03223</a> <span class="preprocessor">#define SPLITS_PER_PAGE (PAGE_SIZE / PAGE_4K)</span>
<a name="l03224"></a><a class="code" href="../../d2/d9/miia64_8h.html#a235">03224</a> <span class="preprocessor"></span><span class="preprocessor">#define PAGE_SHIFT_DIFF (PAGE_SHIFT - PAGE_4K_SHIFT)</span>
03225 <span class="preprocessor"></span>
<a name="l03226"></a><a class="code" href="../../d2/d9/miia64_8h.html#a236">03226</a> <span class="preprocessor">#define ALT_PTE_SHIFT 3</span>
03227 <span class="preprocessor"></span>
<a name="l03228"></a><a class="code" href="../../d2/d9/miia64_8h.html#a237">03228</a> <span class="preprocessor">#define ALT_PROTECTION_MASK (MM_PTE_EXECUTE_MASK|MM_PTE_WRITE_MASK)</span>
03229 <span class="preprocessor"></span>
<a name="l03230"></a><a class="code" href="../../d2/d9/miia64_8h.html#a238">03230</a> <span class="preprocessor">#define MiGetAltPteAddress(VA) \</span>
03231 <span class="preprocessor">      ((PMMPTE) (ALT4KB_PERMISSION_TABLE_START + \</span>
03232 <span class="preprocessor">                     ((((ULONG_PTR) (VA)) &gt;&gt; PAGE_4K_SHIFT) &lt;&lt; ALT_PTE_SHIFT)))</span>
03233 <span class="preprocessor"></span>
03234 <span class="comment">//</span>
03235 <span class="comment">// define Alternate 4k table flags</span>
03236 <span class="comment">//</span>
03237 
<a name="l03238"></a><a class="code" href="../../d2/d9/miia64_8h.html#a239">03238</a> <span class="preprocessor">#define MI_ALTFLG_FLUSH2G         0x0000000000000001</span>
03239 <span class="preprocessor"></span>
03240 <span class="comment">//</span>
03241 <span class="comment">// define MiProtectFor4kPage flages</span>
03242 <span class="comment">//</span>
03243 
<a name="l03244"></a><a class="code" href="../../d2/d9/miia64_8h.html#a240">03244</a> <span class="preprocessor">#define ALT_ALLOCATE      1</span>
<a name="l03245"></a><a class="code" href="../../d2/d9/miia64_8h.html#a241">03245</a> <span class="preprocessor"></span><span class="preprocessor">#define ALT_COMMIT        2</span>
<a name="l03246"></a><a class="code" href="../../d2/d9/miia64_8h.html#a242">03246</a> <span class="preprocessor"></span><span class="preprocessor">#define ALT_CHANGE        4</span>
03247 <span class="preprocessor"></span>
03248 <span class="comment">//</span>
03249 <span class="comment">// define ATE protection bits</span>
03250 <span class="comment">//</span>
03251 
<a name="l03252"></a><a class="code" href="../../d2/d9/miia64_8h.html#a243">03252</a> <span class="preprocessor">#define MM_ATE_COMMIT             0x0000000000000001</span>
<a name="l03253"></a><a class="code" href="../../d2/d9/miia64_8h.html#a244">03253</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_ATE_ACCESS             0x0000000000000020</span>
03254 <span class="preprocessor"></span>
<a name="l03255"></a><a class="code" href="../../d2/d9/miia64_8h.html#a245">03255</a> <span class="preprocessor">#define MM_ATE_READONLY           0x0000000000000200</span>
<a name="l03256"></a><a class="code" href="../../d2/d9/miia64_8h.html#a246">03256</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_ATE_EXECUTE            0x0400000000000200  </span>
<a name="l03257"></a><a class="code" href="../../d2/d9/miia64_8h.html#a247">03257</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_ATE_EXECUTE_READ       0x0400000000000200</span>
<a name="l03258"></a><a class="code" href="../../d2/d9/miia64_8h.html#a248">03258</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_ATE_READWRITE          0x0000000000000600</span>
<a name="l03259"></a><a class="code" href="../../d2/d9/miia64_8h.html#a249">03259</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_ATE_WRITECOPY          0x0020000000000200</span>
<a name="l03260"></a><a class="code" href="../../d2/d9/miia64_8h.html#a250">03260</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_ATE_EXECUTE_READWRITE  0x0400000000000600</span>
<a name="l03261"></a><a class="code" href="../../d2/d9/miia64_8h.html#a251">03261</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_ATE_EXECUTE_WRITECOPY  0x0420000000000400</span>
03262 <span class="preprocessor"></span>
<a name="l03263"></a><a class="code" href="../../d2/d9/miia64_8h.html#a252">03263</a> <span class="preprocessor">#define MM_ATE_ZEROFILL           0x0800000000000000</span>
<a name="l03264"></a><a class="code" href="../../d2/d9/miia64_8h.html#a253">03264</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_ATE_NOACCESS           0x1000000000000000</span>
<a name="l03265"></a><a class="code" href="../../d2/d9/miia64_8h.html#a254">03265</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_ATE_COPY_ON_WRITE      0x2000000000000000</span>
<a name="l03266"></a><a class="code" href="../../d2/d9/miia64_8h.html#a255">03266</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_ATE_PRIVATE            0x8000000000000000</span>
<a name="l03267"></a><a class="code" href="../../d2/d9/miia64_8h.html#a256">03267</a> <span class="preprocessor"></span><span class="preprocessor">#define MM_ATE_PROTO_MASK         0x0000000000000621</span>
03268 <span class="preprocessor"></span>
03269 
03270 <span class="comment">//</span>
03271 <span class="comment">// How big is the IA32 subsystem allowed?</span>
03272 <span class="comment">// Assume it will be "not Large Address Aware" so limited to 2G</span>
03273 <span class="comment">//</span>
<a name="l03274"></a><a class="code" href="../../d2/d9/miia64_8h.html#a257">03274</a> <span class="preprocessor">#define _MAX_WOW64_ADDRESS       (0x00000000080000000UI64)</span>
03275 <span class="preprocessor"></span>
03276 <a class="code" href="../../d2/d9/miia64_8h.html#a302">MmX86Fault</a> (
03277     IN BOOLEAN StoreInstruction,
03278     IN PVOID VirtualAddress, 
03279     IN KPROCESSOR_MODE PreviousMode,
03280     IN PVOID TrapInformation
03281     );
03282 
03283 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
03284 <a class="code" href="../../d2/d9/miia64_8h.html#a303">MiProtectFor4kPage</a>(
03285     IN PVOID Base,
03286     IN SIZE_T Size,
03287     IN ULONG NewProtect,
03288     IN ULONG Flags,
03289     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process
03290     );
03291 
03292 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
03293 <a class="code" href="../../d2/d9/miia64_8h.html#a304">MiProtectMapFileFor4kPage</a>(
03294     IN PVOID Base,
03295     IN SIZE_T Size,
03296     IN ULONG NewProtect,
03297     IN PMMPTE PointerPte,
03298     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process
03299     );
03300 
03301 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
03302 <a class="code" href="../../d2/d9/miia64_8h.html#a305">MiProtectImageFileFor4kPage</a>(
03303     IN PVOID Base,
03304     IN SIZE_T Size,
03305     IN PMMPTE PointerPte,
03306     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process
03307     );
03308 
03309 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
03310 <a class="code" href="../../d2/d9/miia64_8h.html#a306">MiReleaseFor4kPage</a>(
03311     IN PVOID StartVirtual,
03312     IN PVOID EndVirtual,
03313     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process
03314     );
03315 
03316 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
03317 <a class="code" href="../../d2/d9/miia64_8h.html#a307">MiDecommitFor4kPage</a>(
03318     IN PVOID StartVirtual,
03319     IN PVOID EndVirtual,
03320     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process
03321     );
03322 
03323 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
03324 <a class="code" href="../../d2/d9/miia64_8h.html#a308">MiDeleteFor4kPage</a>(
03325     IN PVOID StartVirtual,
03326     IN PVOID EndVirtual,
03327     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process
03328     );
03329 
03330 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
03331 <a class="code" href="../../d2/d9/miia64_8h.html#a309">MiQueryRegionFor4kPage</a>(
03332     IN PVOID BaseAddress,
03333     IN PVOID EndAddress,
03334     IN OUT PSIZE_T RegionSize,
03335     IN OUT PULONG RegionState,
03336     IN OUT PULONG RegionProtect,
03337     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process
03338     );
03339 
03340 ULONG
03341 <a class="code" href="../../d2/d9/miia64_8h.html#a310">MiQueryProtectionFor4kPage</a> (
03342     IN PVOID BaseAddress,
03343     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process
03344     );
03345 
03346 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
03347 <a class="code" href="../../d2/d9/miia64_8h.html#a311">MiInitializeAlternateTable</a>(
03348     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process
03349     );
03350 
03351 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
03352 <a class="code" href="../../d2/d9/miia64_8h.html#a312">MiDeleteAlternateTable</a>(
03353     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process
03354     );
03355 
03356 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
03357 <a class="code" href="../../d2/d9/miia64_8h.html#a313">MiLockFor4kPage</a>(
03358     PVOID CapturedBase,
03359     SIZE_T CapturedRegionSize,
03360     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process
03361     );
03362 
03363 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
03364 <a class="code" href="../../d2/d9/miia64_8h.html#a314">MiUnlockFor4kPage</a>(
03365     PVOID CapturedBase,
03366     SIZE_T CapturedRegionSize,
03367     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process
03368     );
03369 
03370 BOOLEAN
03371 <a class="code" href="../../d2/d9/miia64_8h.html#a315">MiShouldBeUnlockedFor4kPage</a>(
03372     PVOID VirtualAddress,
03373     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process
03374     );
03375 
03376 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
03377 <a class="code" href="../../d2/d9/miia64_8h.html#a316">MiMarkSplitPages</a>(
03378     IN PVOID StartVirtual,
03379     IN PVOID EndVirtual,
03380     IN PULONG Bitmap,
03381     IN BOOLEAN SetBit
03382     );
03383 
03384 ULONG
03385 <a class="code" href="../../d2/d9/miia64_8h.html#a317">MiMakeProtectForNativePage</a>(
03386     IN PVOID VirtualAddress,
03387     IN ULONG NewProtect,
03388     IN <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process
03389     );
03390 
03391 
<a name="l03392"></a><a class="code" href="../../d2/d9/miia64_8h.html#a297">03392</a> <span class="keyword">extern</span> ULONG <a class="code" href="../../d2/d9/miia64_8h.html#a297">MmProtectToPteMaskForIA32</a>[32];
<a name="l03393"></a><a class="code" href="../../d2/d9/miia64_8h.html#a298">03393</a> <span class="keyword">extern</span> ULONG <a class="code" href="../../d2/d9/miia64_8h.html#a298">MmProtectToPteMaskForSplit</a>[32];
<a name="l03394"></a><a class="code" href="../../d2/d9/miia64_8h.html#a299">03394</a> <span class="keyword">extern</span> ULONGLONG <a class="code" href="../../d2/d9/miia64_8h.html#a299">MmProtectToAteMask</a>[32];
03395 
03396 
<a name="l03397"></a><a class="code" href="../../d2/d9/miia64_8h.html#a258">03397</a> <span class="preprocessor">#define MiMakeProtectionAteMask(NewProtect) MmProtectToAteMask[NewProtect]</span>
03398 <span class="preprocessor"></span>
03399 
<a name="l03400"></a><a class="code" href="../../d2/d9/miia64_8h.html#a259">03400</a> <span class="preprocessor">#define _ALTPERM_BITMAP_MASK ((_MAX_WOW64_ADDRESS - 1) &gt;&gt; PTI_SHIFT)</span>
03401 <span class="preprocessor"></span>
03402 <span class="preprocessor">#if 1</span>
<a name="l03403"></a><a class="code" href="../../d2/d9/miia64_8h.html#a260">03403</a> <span class="preprocessor"></span><span class="preprocessor">#define MI_MAKE_VALID_PTE(OUTPTE,FRAME,PMASK,PPTE)                           \</span>
03404 <span class="preprocessor">       (OUTPTE).u.Long = 0;                                                  \</span>
03405 <span class="preprocessor">       (OUTPTE).u.Hard.Valid = 1;                                            \</span>
03406 <span class="preprocessor">       (OUTPTE).u.Hard.Cache = MM_PTE_CACHE_ENABLED;                         \</span>
03407 <span class="preprocessor">       (OUTPTE).u.Hard.Exception = 1;                                        \</span>
03408 <span class="preprocessor">       (OUTPTE).u.Hard.PageFrameNumber = FRAME;                              \</span>
03409 <span class="preprocessor">       (OUTPTE).u.Hard.Owner = MI_DETERMINE_OWNER(PPTE);                     \</span>
03410 <span class="preprocessor">{ \</span>
03411 <span class="preprocessor">  PWOW64_PROCESS _Wow64Process = PsGetCurrentProcess()-&gt;Wow64Process; \</span>
03412 <span class="preprocessor">  if ((_Wow64Process != NULL) &amp;&amp; \</span>
03413 <span class="preprocessor">      ((PPTE &gt;= (PMMPTE)PTE_UBASE) &amp;&amp; \</span>
03414 <span class="preprocessor">       (PPTE &lt; MiGetPteAddress(_MAX_WOW64_ADDRESS)))) {  \</span>
03415 <span class="preprocessor">      if (MI_CHECK_BIT(_Wow64Process-&gt;AltPermBitmap, \</span>
03416 <span class="preprocessor">             ((ULONG_PTR)PPTE &gt;&gt; PTE_SHIFT) &amp; _ALTPERM_BITMAP_MASK) != 0) { \</span>
03417 <span class="preprocessor">          (OUTPTE).u.Long |= (MmProtectToPteMaskForSplit[PMASK]); \</span>
03418 <span class="preprocessor">      } else { \</span>
03419 <span class="preprocessor">          (OUTPTE).u.Long |= (MmProtectToPteMaskForIA32[PMASK]); \</span>
03420 <span class="preprocessor">          (OUTPTE).u.Hard.Accessed = 1; \</span>
03421 <span class="preprocessor">      } \</span>
03422 <span class="preprocessor">  } else { \</span>
03423 <span class="preprocessor">      (OUTPTE).u.Hard.Accessed = 1; \</span>
03424 <span class="preprocessor">      (OUTPTE).u.Long |= (MmProtectToPteMask[PMASK]);\</span>
03425 <span class="preprocessor">  }\</span>
03426 <span class="preprocessor">}</span>
03427 <span class="preprocessor"></span>
03428 
<a name="l03429"></a><a class="code" href="../../d2/d9/miia64_8h.html#a261">03429</a> <span class="preprocessor">#define MI_MAKE_TRANSITION_PTE_VALID(OUTPTE,PPTE)                        \</span>
03430 <span class="preprocessor">        ASSERT (((PPTE)-&gt;u.Hard.Valid == 0) &amp;&amp;                           \</span>
03431 <span class="preprocessor">                ((PPTE)-&gt;u.Trans.Prototype == 0) &amp;&amp;                      \</span>
03432 <span class="preprocessor">                ((PPTE)-&gt;u.Trans.Transition == 1));                      \</span>
03433 <span class="preprocessor">       (OUTPTE).u.Long = (PPTE)-&gt;u.Long &amp; 0x1FFFFFFFE000;                \</span>
03434 <span class="preprocessor">       (OUTPTE).u.Hard.Valid = 1;                                        \</span>
03435 <span class="preprocessor">       (OUTPTE).u.Hard.Cache = MM_PTE_CACHE_ENABLED;                     \</span>
03436 <span class="preprocessor">       (OUTPTE).u.Hard.Exception = 1;                                    \</span>
03437 <span class="preprocessor">       (OUTPTE).u.Hard.Owner = MI_DETERMINE_OWNER(PPTE);                 \</span>
03438 <span class="preprocessor">{ \</span>
03439 <span class="preprocessor">  PWOW64_PROCESS _Wow64Process = PsGetCurrentProcess()-&gt;Wow64Process; \</span>
03440 <span class="preprocessor">  if ((_Wow64Process != NULL) &amp;&amp; \</span>
03441 <span class="preprocessor">      ((PPTE &gt;= (PMMPTE)PTE_UBASE) &amp;&amp; \</span>
03442 <span class="preprocessor">       (PPTE &lt; MiGetPteAddress(_MAX_WOW64_ADDRESS)))) { \</span>
03443 <span class="preprocessor">      if (MI_CHECK_BIT(_Wow64Process-&gt;AltPermBitmap, \</span>
03444 <span class="preprocessor">             ((ULONG_PTR)PPTE &gt;&gt; PTE_SHIFT) &amp; _ALTPERM_BITMAP_MASK) != 0) { \</span>
03445 <span class="preprocessor">          (OUTPTE).u.Long |= (MmProtectToPteMaskForSplit[(PPTE)-&gt;u.Trans.Protection]); \</span>
03446 <span class="preprocessor">      } else { \</span>
03447 <span class="preprocessor">          (OUTPTE).u.Long |= (MmProtectToPteMaskForIA32[(PPTE)-&gt;u.Trans.Protection]); \</span>
03448 <span class="preprocessor">          (OUTPTE).u.Hard.Accessed = 1; \</span>
03449 <span class="preprocessor">      } \</span>
03450 <span class="preprocessor">  } else { \</span>
03451 <span class="preprocessor">      (OUTPTE).u.Hard.Accessed = 1; \</span>
03452 <span class="preprocessor">      (OUTPTE).u.Long |=(MmProtectToPteMask[(PPTE)-&gt;u.Trans.Protection]);\</span>
03453 <span class="preprocessor">  }\</span>
03454 <span class="preprocessor">}</span>
03455 <span class="preprocessor"></span><span class="preprocessor">#else</span>
03456 <span class="preprocessor"></span><span class="preprocessor">#define MI_MAKE_VALID_PTE(OUTPTE,FRAME,PMASK,PPTE)                           \</span>
03457 <span class="preprocessor">       (OUTPTE).u.Long = 0;                                                  \</span>
03458 <span class="preprocessor">       (OUTPTE).u.Hard.Valid = 1;                                            \</span>
03459 <span class="preprocessor">       (OUTPTE).u.Hard.Cache = MM_PTE_CACHE_ENABLED;                         \</span>
03460 <span class="preprocessor">       (OUTPTE).u.Hard.Exception = 1;                                        \</span>
03461 <span class="preprocessor">       (OUTPTE).u.Hard.PageFrameNumber = FRAME;                              \</span>
03462 <span class="preprocessor">       (OUTPTE).u.Hard.Owner = MI_DETERMINE_OWNER(PPTE);                     \</span>
03463 <span class="preprocessor">{ \</span>
03464 <span class="preprocessor">  PWOW64_PROCESS _Wow64Process = PsGetCurrentProcess()-&gt;Wow64Process; \</span>
03465 <span class="preprocessor">  if ((_Wow64Process != NULL) &amp;&amp; \</span>
03466 <span class="preprocessor">      ((PPTE &gt;= (PMMPTE)PTE_UBASE) &amp;&amp; \</span>
03467 <span class="preprocessor">       (PPTE &lt; MiGetPteAddress(_MAX_WOW64_ADDRESS)))) {  \</span>
03468 <span class="preprocessor">      (OUTPTE).u.Long |= MM_PTE_READONLY; \</span>
03469 <span class="preprocessor">  } else { \</span>
03470 <span class="preprocessor">      (OUTPTE).u.Hard.Accessed = 1; \</span>
03471 <span class="preprocessor">      (OUTPTE).u.Long |= (MmProtectToPteMask[PMASK]);\</span>
03472 <span class="preprocessor">  }\</span>
03473 <span class="preprocessor">}</span>
03474 <span class="preprocessor"></span>
03475 
03476 <span class="preprocessor">#define MI_MAKE_TRANSITION_PTE_VALID(OUTPTE,PPTE)                        \</span>
03477 <span class="preprocessor">        ASSERT (((PPTE)-&gt;u.Hard.Valid == 0) &amp;&amp;                           \</span>
03478 <span class="preprocessor">                ((PPTE)-&gt;u.Trans.Prototype == 0) &amp;&amp;                      \</span>
03479 <span class="preprocessor">                ((PPTE)-&gt;u.Trans.Transition == 1));                      \</span>
03480 <span class="preprocessor">       (OUTPTE).u.Long = (PPTE)-&gt;u.Long &amp; 0x1FFFFFFFE000;                \</span>
03481 <span class="preprocessor">       (OUTPTE).u.Hard.Valid = 1;                                        \</span>
03482 <span class="preprocessor">       (OUTPTE).u.Hard.Cache = MM_PTE_CACHE_ENABLED;                     \</span>
03483 <span class="preprocessor">       (OUTPTE).u.Hard.Exception = 1;                                    \</span>
03484 <span class="preprocessor">       (OUTPTE).u.Hard.Owner = MI_DETERMINE_OWNER(PPTE);                 \</span>
03485 <span class="preprocessor">{ \</span>
03486 <span class="preprocessor">  PWOW64_PROCESS _Wow64Process = PsGetCurrentProcess()-&gt;Wow64Process; \</span>
03487 <span class="preprocessor">  if ((_Wow64Process != NULL) &amp;&amp; \</span>
03488 <span class="preprocessor">      ((PPTE &gt;= (PMMPTE)PTE_UBASE) &amp;&amp; \</span>
03489 <span class="preprocessor">       (PPTE &lt; MiGetPteAddress(_MAX_WOW64_ADDRESS)))) { \</span>
03490 <span class="preprocessor">      (OUTPTE).u.Long |= MM_PTE_READONLY; \</span>
03491 <span class="preprocessor">  } else { \</span>
03492 <span class="preprocessor">      (OUTPTE).u.Hard.Accessed = 1; \</span>
03493 <span class="preprocessor">      (OUTPTE).u.Long |=(MmProtectToPteMask[(PPTE)-&gt;u.Trans.Protection]);\</span>
03494 <span class="preprocessor">  }\</span>
03495 <span class="preprocessor">}</span>
03496 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
03497 <span class="preprocessor"></span>
<a name="l03498"></a><a class="code" href="../../d2/d9/miia64_8h.html#a262">03498</a> <span class="preprocessor">#define LOCK_ALTERNATE_TABLE(PWOW64) \</span>
03499 <span class="preprocessor">        ExAcquireFastMutex( &amp;(PWOW64)-&gt;AlternateTableLock)</span>
03500 <span class="preprocessor"></span>
<a name="l03501"></a><a class="code" href="../../d2/d9/miia64_8h.html#a263">03501</a> <span class="preprocessor">#define UNLOCK_ALTERNATE_TABLE(PWOW64) \</span>
03502 <span class="preprocessor">        ExReleaseFastMutex(&amp;(PWOW64)-&gt;AlternateTableLock)</span>
03503 <span class="preprocessor"></span>
<a name="l03504"></a><a class="code" href="../../d2/d9/miia64_8h.html#a264">03504</a> <span class="preprocessor">#define MI_IS_ALT_PAGE_TABLE_ADDRESS(PPTE) \</span>
03505 <span class="preprocessor">            (((PPTE) &gt;= (PMMPTE)ALT4KB_PERMISSION_TABLE_START) &amp;&amp; \</span>
03506 <span class="preprocessor">             ((PPTE) &lt; (PMMPTE)ALT4KB_PERMISSION_TABLE_END))</span>
03507 <span class="preprocessor"></span>
03508 <span class="preprocessor">#endif</span>
03509 <span class="preprocessor"></span>
03510 <span class="comment">//++</span>
03511 <span class="comment">//VOID</span>
03512 <span class="comment">//MI_BARRIER_SYNCHRONIZE (</span>
03513 <span class="comment">//    IN ULONG TimeStamp</span>
03514 <span class="comment">//    );</span>
03515 <span class="comment">//</span>
03516 <span class="comment">// Routine Description:</span>
03517 <span class="comment">//</span>
03518 <span class="comment">//    MI_BARRIER_SYNCHRONIZE compares the argument timestamp against the</span>
03519 <span class="comment">//    current IPI barrier sequence stamp.  When equal, all processors will</span>
03520 <span class="comment">//    issue memory barriers to ensure that newly created pages remain coherent.</span>
03521 <span class="comment">//</span>
03522 <span class="comment">//    When a page is put in the zeroed or free page list the current</span>
03523 <span class="comment">//    barrier sequence stamp is read (interlocked - this is necessary</span>
03524 <span class="comment">//    to get the correct value - memory barriers won't do the trick)</span>
03525 <span class="comment">//    and stored in the pfn entry for the page. The current barrier</span>
03526 <span class="comment">//    sequence stamp is maintained by the IPI send logic and is</span>
03527 <span class="comment">//    incremented (interlocked) when the target set of an IPI send</span>
03528 <span class="comment">//    includes all processors, but the one doing the send. When a page</span>
03529 <span class="comment">//    is needed its sequence number is compared against the current</span>
03530 <span class="comment">//    barrier sequence number.  If it is equal, then the contents of</span>
03531 <span class="comment">//    the page may not be coherent on all processors, and an IPI must</span>
03532 <span class="comment">//    be sent to all processors to ensure a memory barrier is</span>
03533 <span class="comment">//    executed (generic call can be used for this). Sending the IPI</span>
03534 <span class="comment">//    automatically updates the barrier sequence number. The compare</span>
03535 <span class="comment">//    is for equality as this is the only value that requires the IPI</span>
03536 <span class="comment">//    (i.e., the sequence number wraps, values in both directions are</span>
03537 <span class="comment">//    older). When a page is removed in this fashion and either found</span>
03538 <span class="comment">//    to be coherent or made coherent, it cannot be modified between</span>
03539 <span class="comment">//    that time and writing the PTE. If the page is modified between</span>
03540 <span class="comment">//    these times, then an IPI must be sent.</span>
03541 <span class="comment">//</span>
03542 <span class="comment">// Arguments</span>
03543 <span class="comment">//</span>
03544 <span class="comment">//    TimeStamp - Supplies the timestamp at the time when the page was zeroed.</span>
03545 <span class="comment">//</span>
03546 <span class="comment">// Return Value:</span>
03547 <span class="comment">//</span>
03548 <span class="comment">//    None.</span>
03549 <span class="comment">//</span>
03550 <span class="comment">//--</span>
03551 
03552 <span class="comment">// currently does nothing on MERCED.</span>
03553 
<a name="l03554"></a><a class="code" href="../../d2/d9/miia64_8h.html#a265">03554</a> <span class="preprocessor">#define MI_BARRIER_SYNCHRONIZE(TimeStamp)</span>
03555 <span class="preprocessor"></span>
03556 <span class="comment">//++</span>
03557 <span class="comment">//VOID</span>
03558 <span class="comment">//MI_BARRIER_STAMP_ZEROED_PAGE (</span>
03559 <span class="comment">//    IN PULONG PointerTimeStamp</span>
03560 <span class="comment">//    );</span>
03561 <span class="comment">//</span>
03562 <span class="comment">// Routine Description:</span>
03563 <span class="comment">//</span>
03564 <span class="comment">//    MI_BARRIER_STAMP_ZEROED_PAGE issues an interlocked read to get the</span>
03565 <span class="comment">//    current IPI barrier sequence stamp.  This is called AFTER a page is</span>
03566 <span class="comment">//    zeroed.</span>
03567 <span class="comment">//</span>
03568 <span class="comment">// Arguments</span>
03569 <span class="comment">//</span>
03570 <span class="comment">//    PointerTimeStamp - Supplies a timestamp pointer to fill with the</span>
03571 <span class="comment">//                       current IPI barrier sequence stamp.</span>
03572 <span class="comment">//</span>
03573 <span class="comment">// Return Value:</span>
03574 <span class="comment">//</span>
03575 <span class="comment">//    None.</span>
03576 <span class="comment">//</span>
03577 <span class="comment">//--</span>
03578 
03579 <span class="comment">// currently does nothing on MERCED.</span>
03580 
<a name="l03581"></a><a class="code" href="../../d2/d9/miia64_8h.html#a266">03581</a> <span class="preprocessor">#define MI_BARRIER_STAMP_ZEROED_PAGE(PointerTimeStamp)</span>
03582 <span class="preprocessor"></span>
03583 <span class="comment">//++</span>
03584 <span class="comment">//VOID</span>
03585 <span class="comment">//MI_FLUSH_SINGLE_SESSION_TB (</span>
03586 <span class="comment">//    IN PVOID Virtual,</span>
03587 <span class="comment">//    IN ULONG Invalid,</span>
03588 <span class="comment">//    IN LOGICAL AllProcessors,</span>
03589 <span class="comment">//    IN PMMPTE PtePointer,</span>
03590 <span class="comment">//    IN MMPTE PteValue,</span>
03591 <span class="comment">//    IN MMPTE PreviousPte</span>
03592 <span class="comment">//    );</span>
03593 <span class="comment">//</span>
03594 <span class="comment">// Routine Description:</span>
03595 <span class="comment">//</span>
03596 <span class="comment">//    MI_FLUSH_SINGLE_SESSION_TB flushes the requested single address</span>
03597 <span class="comment">//    translation from the TB.  </span>
03598 <span class="comment">//</span>
03599 <span class="comment">//    Since IA64 supports ASNs and session space doesn't have one, the entire</span>
03600 <span class="comment">//    TB needs to be flushed.</span>
03601 <span class="comment">//</span>
03602 <span class="comment">// Arguments</span>
03603 <span class="comment">//</span>
03604 <span class="comment">//    Virtual - Supplies the virtual address to invalidate.</span>
03605 <span class="comment">//</span>
03606 <span class="comment">//    Invalid - TRUE if invalidating.</span>
03607 <span class="comment">//</span>
03608 <span class="comment">//    AllProcessors - TRUE if all processors need to be IPI'd.</span>
03609 <span class="comment">//</span>
03610 <span class="comment">//    PtePointer - Supplies the PTE to invalidate.</span>
03611 <span class="comment">//</span>
03612 <span class="comment">//    PteValue - Supplies the new PTE value.</span>
03613 <span class="comment">//</span>
03614 <span class="comment">//    PreviousPte - The previous PTE value is returned here.</span>
03615 <span class="comment">//</span>
03616 <span class="comment">// Return Value:</span>
03617 <span class="comment">//</span>
03618 <span class="comment">//    None.</span>
03619 <span class="comment">//</span>
03620 <span class="comment">//--</span>
03621 
<a name="l03622"></a><a class="code" href="../../d2/d9/miia64_8h.html#a267">03622</a> <span class="preprocessor">#define MI_FLUSH_SINGLE_SESSION_TB(Virtual, Invalid, AllProcessors, PtePointer, PteValue, PreviousPte) \</span>
03623 <span class="preprocessor">    PreviousPte.u.Flush = *PtePointer;                  \</span>
03624 <span class="preprocessor">    *PtePointer = PteValue;                             \</span>
03625 <span class="preprocessor">    KeFlushEntireTb (TRUE, TRUE);</span>
03626 <span class="preprocessor"></span>
03627 
03628 <span class="comment">//++</span>
03629 <span class="comment">//VOID</span>
03630 <span class="comment">//MI_FLUSH_ENTIRE_SESSION_TB (</span>
03631 <span class="comment">//    IN ULONG Invalid,</span>
03632 <span class="comment">//    IN LOGICAL AllProcessors</span>
03633 <span class="comment">//    );</span>
03634 <span class="comment">//</span>
03635 <span class="comment">// Routine Description:</span>
03636 <span class="comment">//</span>
03637 <span class="comment">//    MI_FLUSH_ENTIRE_SESSION_TB flushes the entire TB on IA64 since</span>
03638 <span class="comment">//    the IA64 supports ASNs.</span>
03639 <span class="comment">//</span>
03640 <span class="comment">// Arguments</span>
03641 <span class="comment">//</span>
03642 <span class="comment">//    Invalid - TRUE if invalidating.</span>
03643 <span class="comment">//</span>
03644 <span class="comment">//    AllProcessors - TRUE if all processors need to be IPI'd.</span>
03645 <span class="comment">//</span>
03646 <span class="comment">// Return Value:</span>
03647 <span class="comment">//</span>
03648 <span class="comment">//    None.</span>
03649 <span class="comment">//</span>
03650 
<a name="l03651"></a><a class="code" href="../../d2/d9/miia64_8h.html#a268">03651</a> <span class="preprocessor">#define MI_FLUSH_ENTIRE_SESSION_TB(Invalid, AllProcessors) \</span>
03652 <span class="preprocessor">    KeFlushEntireTb (Invalid, AllProcessors);</span>
03653 <span class="preprocessor"></span>
03654 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
03655 <a class="code" href="../../d2/d9/miia64_8h.html#a318">MiSweepCacheMachineDependent</a>(
03656     IN PVOID VirtualAddress,
03657     IN SIZE_T Size,
03658     IN MEMORY_CACHING_TYPE CacheType
03659     );
03660 
<a name="l03661"></a><a class="code" href="../../d2/d9/miia64_8h.html#a269">03661</a> <span class="preprocessor">#define MI_IS_PCR_PAGE(Va) (((PVOID)PCR &lt;= Va) &amp;&amp; (Va &lt; (PVOID)(PCR+PAGE_SIZE)))</span>
03662 <span class="preprocessor"></span>
03663 <span class="comment">//++</span>
03664 <span class="comment">//BOOLEAN</span>
03665 <span class="comment">//MI_IS_ADDRESS_VALID_FOR_KD (</span>
03666 <span class="comment">//    IN PVOID VirtualAddress</span>
03667 <span class="comment">//    );</span>
03668 <span class="comment">//</span>
03669 <span class="comment">// Routine Description:</span>
03670 <span class="comment">//</span>
03671 <span class="comment">//    This macro deterines if a give virtual address is really a valid </span>
03672 <span class="comment">//    virtual address for the kerenl debugger memory references</span>
03673 <span class="comment">//</span>
03674 <span class="comment">// Argments</span>
03675 <span class="comment">//</span>
03676 <span class="comment">//    VirtualAddress - Supplies the virtual address.</span>
03677 <span class="comment">//</span>
03678 <span class="comment">// Return Value:</span>
03679 <span class="comment">//</span>
03680 <span class="comment">//    FALSE if it is not a physical address, TRUE if it is.</span>
03681 <span class="comment">//</span>
03682 <span class="comment">//--</span>
03683 
03684 
<a name="l03685"></a><a class="code" href="../../d2/d9/miia64_8h.html#a270">03685</a> <span class="preprocessor">#define MI_IS_ADDRESS_VALID_FOR_KD(VirtualAddress)  \</span>
03686 <span class="preprocessor">         ((VirtualAddress &lt;= (PVOID)(HYPER_SPACE_END)) || \</span>
03687 <span class="preprocessor">          (MI_IS_PTE_ADDRESS((PMMPTE)VirtualAddress)) || \</span>
03688 <span class="preprocessor">          (MI_IS_PAGE_DIRECTORY_ADDRESS((PMMPTE)VirtualAddress)) || \</span>
03689 <span class="preprocessor">          (MI_IS_PPE_ADDRESS((PMMPTE)VirtualAddress)) || \</span>
03690 <span class="preprocessor">          ((VirtualAddress &gt;= MM_SYSTEM_RANGE_START) &amp;&amp; \</span>
03691 <span class="preprocessor">           (VirtualAddress &lt; (PVOID)MM_SYSTEM_SPACE_END)) || \</span>
03692 <span class="preprocessor">          (MI_IS_SESSION_ADDRESS(VirtualAddress)) || \</span>
03693 <span class="preprocessor">          (MI_IS_PHYSICAL_ADDRESS(VirtualAddress)) || \</span>
03694 <span class="preprocessor">          (MI_IS_PCR_PAGE(VirtualAddress)))</span>
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:48 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
