<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: heap.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>heap.c</h1><a href="../../d2/d9/w32_2ntuser_2kernel_2heap_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/****************************** Module Header ******************************\</span>
00002 <span class="comment">* Module Name: heap.c</span>
00003 <span class="comment">*</span>
00004 <span class="comment">* Copyright (c) 1985 - 1999, Microsoft Corporation</span>
00005 <span class="comment">*</span>
00006 <span class="comment">* This module contains kernel-mode heap management code.</span>
00007 <span class="comment">*</span>
00008 <span class="comment">* History:</span>
00009 <span class="comment">* 03-16-95 JimA         Created.</span>
00010 <span class="comment">\***************************************************************************/</span>
00011 
00012 <span class="preprocessor">#include "<a class="code" href="../../d0/d4/w32_2ntuser_2kernel_2precomp_8h.html">precomp.h</a>"</span>
00013 <span class="preprocessor">#pragma hdrstop</span>
00014 <span class="preprocessor"></span>
<a name="l00015"></a><a class="code" href="../../d4/d1/userk_8h.html#a997">00015</a> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d4/d1/userk_8h.html#a997">UserCommitDesktopMemory</a>(
00016     PVOID pBase,
00017     PVOID *ppCommit,
00018     PSIZE_T pCommitSize)
00019 {
00020     <a class="code" href="../../d2/d3/structtagDESKTOPVIEW.html">PDESKTOPVIEW</a>    pdv;
00021     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>           dwCommitOffset;
00022     <a class="code" href="../../d4/d9/structtagWINDOWSTATION.html">PWINDOWSTATION</a>  pwinsta;
00023     <a class="code" href="../../d0/d3/structtagDESKTOP.html">PDESKTOP</a>        pdesk;
00024     <a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>           pUserBase;
00025     <span class="keywordtype">int</span>             dCommit;
00026     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>        <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00027     <a class="code" href="../../d5/d6/struct__ETHREAD.html">ETHREAD</a>         *Thread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
00028 
00029     <span class="comment">/*</span>
00030 <span class="comment">     * If this is a system thread, we have no view of the desktop</span>
00031 <span class="comment">     * and must map it in.  Fortunately, this does not happen often.</span>
00032 <span class="comment">     *</span>
00033 <span class="comment">     * We use the Thread variable because IS_SYSTEM_THREAD is a macro</span>
00034 <span class="comment">     * that multiply resolves the parameter.</span>
00035 <span class="comment">     */</span>
00036     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d9/ps_8h.html#a18">IS_SYSTEM_THREAD</a>(Thread)) {
00037 
00038         <span class="comment">/*</span>
00039 <span class="comment">         * Find the desktop that owns the section.</span>
00040 <span class="comment">         */</span>
00041         <span class="keywordflow">for</span> (pwinsta = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a241">grpWinStaList</a>; pwinsta; pwinsta = pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o0">rpwinstaNext</a>) {
00042             <span class="keywordflow">for</span> (pdesk = pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o1">rpdeskList</a>; pdesk; pdesk = pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o2">rpdeskNext</a>) {
00043                 <span class="keywordflow">if</span> (pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o0">pvDesktopBase</a> == pBase)
00044                     <span class="keywordflow">goto</span> FoundIt;
00045             }
00046         }
00047 FoundIt:
00048         <span class="keywordflow">if</span> (pwinsta == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00049             RIPMSG3(RIP_ERROR, <span class="stringliteral">"UserCommitDesktopMemory failed: pBase %#p, ppCommit %#p, pCommitSize %d"</span>,
00050                     pBase, ppCommit, *pCommitSize);
00051             <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00052         }
00053 
00054         <span class="comment">/*</span>
00055 <span class="comment">         * Map the section into the current process and commit the</span>
00056 <span class="comment">         * first page of the section.</span>
00057 <span class="comment">         */</span>
00058         dwCommitOffset = (ULONG)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)*ppCommit - (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pBase);
00059         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d1/userk_8h.html#a1002">CommitReadOnlyMemory</a>(pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o15">hsectionDesktop</a>, pCommitSize,
00060                     dwCommitOffset, &amp;dCommit);
00061         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00062             *ppCommit = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)*ppCommit + dCommit;
00063         }
00064     } <span class="keywordflow">else</span> {
00065 
00066         <span class="comment">/*</span>
00067 <span class="comment">         * Find the current process' view of the desktop</span>
00068 <span class="comment">         */</span>
00069         <span class="keywordflow">for</span> (pdv = <a class="code" href="../../d4/d1/userk_8h.html#a16">PpiCurrent</a>()-&gt;pdvList; pdv != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>; pdv = pdv-&gt;<a class="code" href="../../d2/d3/structtagDESKTOPVIEW.html#o0">pdvNext</a>) {
00070             <span class="keywordflow">if</span> (pdv-&gt;<a class="code" href="../../d2/d3/structtagDESKTOPVIEW.html#o1">pdesk</a>-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o0">pvDesktopBase</a> == pBase)
00071                 <span class="keywordflow">break</span>;
00072         }
00073         
00074         <span class="comment">/*</span>
00075 <span class="comment">         * 254954: If we didn't find a desktop view then map the desktop view</span>
00076 <span class="comment">         * to the current process.</span>
00077 <span class="comment">         */</span>
00078         <span class="keywordflow">if</span> (pdv == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00079             <span class="comment">/*</span>
00080 <span class="comment">             * Find the desktop that owns the section.</span>
00081 <span class="comment">             */</span>
00082             <span class="keywordflow">for</span> (pwinsta = <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a241">grpWinStaList</a>; pwinsta; pwinsta = pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o0">rpwinstaNext</a>) {
00083                 <span class="keywordflow">for</span> (pdesk = pwinsta-&gt;<a class="code" href="../../d4/d9/structtagWINDOWSTATION.html#o1">rpdeskList</a>; pdesk; pdesk = pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o2">rpdeskNext</a>) {
00084                     <span class="keywordflow">if</span> (pdesk-&gt;<a class="code" href="../../d0/d3/structtagDESKTOP.html#o0">pDeskInfo</a>-&gt;<a class="code" href="../../d1/d3/structtagDESKTOPINFO.html#o0">pvDesktopBase</a> == pBase)
00085                         <span class="keywordflow">goto</span> FoundTheDesktop;
00086                 }
00087             }
00088 
00089 FoundTheDesktop:
00090             <span class="keywordflow">if</span> (pwinsta == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00091                 RIPMSG3(RIP_ERROR, <span class="stringliteral">"UserCommitDesktopMemory failed: pBase %#p, ppCommit %#p, pCommitSize %d"</span>,
00092                         pBase, ppCommit, *pCommitSize);
00093                 <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00094             }
00095 
00096             UserAssert(pdesk != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00097 
00098             <span class="comment">/*</span>
00099 <span class="comment">             * Map the desktop into the current process</span>
00100 <span class="comment">             */</span>
00101             <span class="keywordflow">try</span> {
00102                 <a class="code" href="../../d4/d1/userk_8h.html#a1289">MapDesktop</a>(<a class="code" href="../../d4/d0/ob_8h.html#a100a59">ObOpenHandle</a>, <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>(), pdesk, 0, 1);
00103             } except (W32ExceptionHandler(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, RIP_WARNING)) {
00104                 
00105                   RIPMSG2(RIP_WARNING, <span class="stringliteral">"UserCommitDesktopMemory: Could't map pdesk %#p in ppi %#p"</span>,
00106                         pdesk, <a class="code" href="../../d4/d1/userk_8h.html#a16">PpiCurrent</a>());
00107                 <span class="keywordflow">return</span> STATUS_NO_MEMORY;
00108             }
00109             
00110             pdv = <a class="code" href="../../d4/d1/userk_8h.html#a1283">GetDesktopView</a>(<a class="code" href="../../d4/d1/userk_8h.html#a16">PpiCurrent</a>(), pdesk);
00111         }
00112 
00113         UserAssert(pdv != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00114 
00115         <span class="comment">/*</span>
00116 <span class="comment">         * Commit the memory</span>
00117 <span class="comment">         */</span>
00118         pUserBase = (PVOID)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)*ppCommit - pdv-&gt;<a class="code" href="../../d2/d3/structtagDESKTOPVIEW.html#o2">ulClientDelta</a>);
00119         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwAllocateVirtualMemory(NtCurrentProcess(),
00120                                         &amp;pUserBase,
00121                                         0,
00122                                         pCommitSize,
00123                                         MEM_COMMIT,
00124                                         PAGE_EXECUTE_READ
00125                                         );
00126         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>))
00127             *ppCommit = (PVOID)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pUserBase + pdv-&gt;<a class="code" href="../../d2/d3/structtagDESKTOPVIEW.html#o2">ulClientDelta</a>);
00128     }
00129 
00130     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00131 }
00132 
<a name="l00133"></a><a class="code" href="../../d4/d1/userk_8h.html#a998">00133</a> <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d4/d1/userk_8h.html#a998">UserCommitSharedMemory</a>(
00134     PVOID  pBase,
00135     PVOID *ppCommit,
00136     PSIZE_T pCommitSize)
00137 {
00138     ULONG_PTR   ulClientDelta;
00139     <a class="code" href="../../d0/d5/perfuser_8c.html#a6">DWORD</a>       dwCommitOffset;
00140     <a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>       pUserBase;
00141     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>    <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00142     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>   Process;
00143     <span class="keywordtype">int</span>         dCommit;
00144 
00145 <span class="preprocessor">#if DBG</span>
00146 <span class="preprocessor"></span>    <span class="keywordflow">if</span> (pBase != Win32HeapGetHandle(<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a322">gpvSharedAlloc</a>)) {
00147         RIPMSG0(RIP_WARNING, <span class="stringliteral">"pBase != gpvSharedAlloc"</span>);
00148     }
00149 <span class="preprocessor">#else</span>
00150 <span class="preprocessor"></span>    UNREFERENCED_PARAMETER(pBase);
00151 <span class="preprocessor">#endif</span>
00152 <span class="preprocessor"></span>
00153     Process = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>();
00154 
00155     <a class="code" href="../../d4/d1/userk_8h.html#a519">ValidateProcessSessionId</a>(Process);
00156 
00157     <span class="keywordflow">if</span> (Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o72">Win32Process</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ||
00158         ((<a class="code" href="../../d7/d3/structtagPROCESSINFO.html">PPROCESSINFO</a>)Process-&gt;<a class="code" href="../../d0/d4/struct__EPROCESS.html#o72">Win32Process</a>)-&gt;pClientBase == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00159 
00160         dwCommitOffset = (ULONG)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)*ppCommit - (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a321">gpvSharedBase</a>);
00161         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d1/userk_8h.html#a1002">CommitReadOnlyMemory</a>(
00162                 <a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a320">ghSectionShared</a>, pCommitSize, dwCommitOffset, &amp;dCommit);
00163 
00164         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00165             *ppCommit = (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>) *ppCommit + dCommit;
00166         }
00167     } <span class="keywordflow">else</span> {
00168 
00169         <span class="comment">/*</span>
00170 <span class="comment">         * Commit the memory</span>
00171 <span class="comment">         */</span>
00172         ulClientDelta = (ULONG_PTR)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)<a class="code" href="../../d3/d6/ntuser_2kernel_2globals_8c.html#a321">gpvSharedBase</a> - (<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)(<a class="code" href="../../d4/d1/userk_8h.html#a16">PpiCurrent</a>()-&gt;pClientBase));
00173         pUserBase = (PVOID)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)*ppCommit - ulClientDelta);
00174         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = ZwAllocateVirtualMemory(
00175                          NtCurrentProcess(),
00176                          &amp;pUserBase,
00177                          0,
00178                          pCommitSize,
00179                          MEM_COMMIT,
00180                          PAGE_EXECUTE_READ);
00181         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00182             *ppCommit = (PVOID)((<a class="code" href="../../d9/d7/halvprnt_8c.html#a1">PBYTE</a>)pUserBase + ulClientDelta);
00183         }
00184     }
00185 
00186     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00187 }
00188 
<a name="l00189"></a><a class="code" href="../../d4/d1/userk_8h.html#a999">00189</a> PWIN32HEAP <a class="code" href="../../d4/d1/userk_8h.html#a999">UserCreateHeap</a>(
00190     HANDLE                      hSection,
00191     ULONG                       ulViewOffset,
00192     PVOID                       pvBaseAddress,
00193     DWORD                       dwSize,
00194     PRTL_HEAP_COMMIT_ROUTINE    pfnCommit)
00195 {
00196     PVOID pUserBase;
00197     SIZE_T ulViewSize;
00198     LARGE_INTEGER liOffset;
00199     <a class="code" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> Process = <a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>();
00200     RTL_HEAP_PARAMETERS HeapParams;
00201     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00202     ULONG HeapFlags;
00203 
00204     <span class="comment">/*</span>
00205 <span class="comment">     * Map the section into the current process and commit the</span>
00206 <span class="comment">     * first page of the section.</span>
00207 <span class="comment">     */</span>
00208     ulViewSize        = 0;
00209     liOffset.LowPart  = ulViewOffset;
00210     liOffset.HighPart = 0;
00211     pUserBase         = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00212 
00213     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d5/mapview_8c.html#a21">MmMapViewOfSection</a>(
00214                     hSection,
00215                     Process,
00216                     &amp;pUserBase,
00217                     0,
00218                     <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>,
00219                     &amp;liOffset,
00220                     &amp;ulViewSize,
00221                     ViewUnmap,
00222                     SEC_NO_CHANGE,
00223                     PAGE_EXECUTE_READ);
00224 
00225     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>))
00226         <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00227 
00228     <a class="code" href="../../d4/d9/umapview_8c.html#a1">MmUnmapViewOfSection</a>(Process, pUserBase);
00229 
00230     <span class="comment">/*</span>
00231 <span class="comment">     * We now have a committed page to create the heap in.</span>
00232 <span class="comment">     */</span>
00233     RtlZeroMemory(&amp;HeapParams, <span class="keyword">sizeof</span>(HeapParams));
00234 
00235     HeapParams.Length         = <span class="keyword">sizeof</span>(HeapParams);
00236     HeapParams.InitialCommit  = <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>;
00237     HeapParams.InitialReserve = dwSize;
00238     HeapParams.CommitRoutine  = pfnCommit;
00239 
00240     UserAssert(HeapParams.InitialCommit &lt; dwSize);
00241     
00242     
00243     HeapFlags = HEAP_NO_SERIALIZE | HEAP_ZERO_MEMORY;
00244 
00245 <span class="preprocessor">#if DBG</span>
00246 <span class="preprocessor"></span>    HeapFlags |= HEAP_TAIL_CHECKING_ENABLED;
00247 <span class="preprocessor">#endif // DBG</span>
00248 <span class="preprocessor"></span>
00249     <span class="keywordflow">return</span> Win32HeapCreate(<span class="stringliteral">"UH_HEAD"</span>,
00250                            <span class="stringliteral">"UH_TAIL"</span>,
00251                            HeapFlags,
00252                            pvBaseAddress,
00253                            dwSize,
00254                            <a class="code" href="../../d6/d7/halmips_8h.html#a446">PAGE_SIZE</a>,
00255                            <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00256                            &amp;HeapParams);
00257 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:15 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
