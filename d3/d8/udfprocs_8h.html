<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: udfprocs.h File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>udfprocs.h File Reference</h1><code>#include &lt;ntifs.h&gt;</code><br>
<code>#include &lt;ntddcdrm.h&gt;</code><br>
<code>#include &lt;ntddcdvd.h&gt;</code><br>
<code>#include &lt;ntdddisk.h&gt;</code><br>
<code>#include "<a class="el" href="../../d2/d6/udfs_2nodetype_8h-source.html">nodetype.h</a>"</code><br>
<code>#include "Udf.h"</code><br>
<code>#include "UdfStruc.h"</code><br>
<code>#include "UdfData.h"</code><br>

<p>
<a href="../../d4/d7/udfprocs_8h-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Classes</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>union &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d9/d2/union__UCHAR1.html">_UCHAR1</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>union &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d0/d3/union__UCHAR2.html">_UCHAR2</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>union &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d1/d3/union__UCHAR4.html">_UCHAR4</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>union &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d7/d4/union__USHORT2.html">_USHORT2</a></td></tr>

<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a0">INLINE</a>&nbsp;&nbsp;&nbsp;__inline</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a1">BugCheckFileId</a>&nbsp;&nbsp;&nbsp;(UDFS_BUG_CHECK_STRUCSUP)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a2">Dbg</a>&nbsp;&nbsp;&nbsp;(UDFS_DEBUG_LEVEL_STRUCSUP)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a3">Min</a>(a, b)&nbsp;&nbsp;&nbsp;((a) &lt; (b) ? (a) : (b))</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a4">Max</a>(a, b)&nbsp;&nbsp;&nbsp;((a) &gt; (b) ? (a) : (b))</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a5">FlagMask</a>(F, SF)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a6">BooleanFlagOn</a>(F, SF)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a7">BooleanFlagOff</a>(F, SF)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a8">SetFlag</a>(Flags, SingleFlag)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a9">ClearFlag</a>(Flags, SingleFlag)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a10">Add2Ptr</a>(PTR, INC, CAST)&nbsp;&nbsp;&nbsp;((CAST)((ULONG_PTR)(PTR) + (INC)))</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a11">PtrOffset</a>(BASE, OFFSET)&nbsp;&nbsp;&nbsp;((ULONG)((ULONG)(OFFSET) - (ULONG)(BASE)))</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a12">GenericTruncate</a>(B, U)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a13">GenericAlign</a>(B, U)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a14">GenericOffset</a>(B, U)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a15">GenericRemainder</a>(B, U)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a16">GenericTruncatePtr</a>(B, U)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a17">GenericAlignPtr</a>(B, U)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a18">GenericOffsetPtr</a>(B, U)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a19">GenericRemainderPtr</a>(B, U)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a20">WordAlign</a>(B)&nbsp;&nbsp;&nbsp;GenericAlign((B), 2)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a21">LongAlign</a>(B)&nbsp;&nbsp;&nbsp;GenericAlign((B), 4)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a22">QuadAlign</a>(B)&nbsp;&nbsp;&nbsp;GenericAlign((B), 8)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a23">WordOffset</a>(B)&nbsp;&nbsp;&nbsp;GenericOffset((B), 2)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a24">LongOffset</a>(B)&nbsp;&nbsp;&nbsp;GenericOffset((B), 4)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a25">QuadOffset</a>(B)&nbsp;&nbsp;&nbsp;GenericOffset((B), 8)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a26">WordAlignPtr</a>(P)&nbsp;&nbsp;&nbsp;GenericAlignPtr((P), 2)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a27">LongAlignPtr</a>(P)&nbsp;&nbsp;&nbsp;GenericAlignPtr((P), 4)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a28">QuadAlignPtr</a>(P)&nbsp;&nbsp;&nbsp;GenericAlignPtr((P), 8)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a29">WordOffsetPtr</a>(P)&nbsp;&nbsp;&nbsp;GenericOffsetPtr((P), 2)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a30">LongOffsetPtr</a>(P)&nbsp;&nbsp;&nbsp;GenericOffsetPtr((P), 4)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a31">QuadOffsetPtr</a>(P)&nbsp;&nbsp;&nbsp;GenericOffsetPtr((P), 8)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a32">SectorAlignN</a>(SECTORSIZE, L)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a33">SectorAlign</a>(V, L)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a34">LlSectorAlign</a>(V, L)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a35">SectorTruncate</a>(V, L)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a36">LlSectorTruncate</a>(V, L)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a37">BytesFromSectors</a>(V, L)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a38">SectorsFromBytes</a>(V, L)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a39">LlBytesFromSectors</a>(V, L)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a40">LlSectorsFromBytes</a>(V, L)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a41">SectorsFromBlocks</a>(V, B)&nbsp;&nbsp;&nbsp;(B)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a42">SectorSize</a>(V)&nbsp;&nbsp;&nbsp;((V)-&gt;SectorSize)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a43">SectorOffset</a>(V, L)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a44">BlockAlignN</a>(BLOCKSIZE, L)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a45">BlockAlign</a>(V, L)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a46">LlBlockAlign</a>(V, L)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a47">BlockTruncate</a>(V, L)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a48">LlBlockTruncate</a>(V, L)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a49">BytesFromBlocks</a>(V, L)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a50">BlocksFromBytes</a>(V, L)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a51">LlBytesFromBlocks</a>(V, L)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a52">LlBlocksFromBytes</a>(V, L)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a53">BlocksFromSectors</a>(V, S)&nbsp;&nbsp;&nbsp;(S)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a54">BlockSize</a>(V)&nbsp;&nbsp;&nbsp;(SectorSize(V))</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a55">BlockOffset</a>(V, L)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a56">CopyUchar1</a>(Dst, Src)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a57">CopyUchar2</a>(Dst, Src)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a58">SwapCopyUchar2</a>(Dst, Src)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a59">CopyUchar4</a>(Dst, Src)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a60">SwapCopyUchar4</a>(Dst, Src)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a61">CopyUshort2</a>(Dst, Src)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a62">CanFsdWait</a>(I)&nbsp;&nbsp;&nbsp;IoIsOperationSynchronous(I)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a63">UdfIsFastIoPossible</a>(F)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>(S)&nbsp;&nbsp;&nbsp;{ S; leave; }</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a65">UdfPagedPool</a>&nbsp;&nbsp;&nbsp;PagedPool</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a66">UdfNonPagedPool</a>&nbsp;&nbsp;&nbsp;NonPagedPool</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a67">UdfNonPagedPoolCacheAligned</a>&nbsp;&nbsp;&nbsp;NonPagedPoolCacheAligned</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a68">UdfUnpinView</a>(IC, V)&nbsp;&nbsp;&nbsp;if (((V)-&gt;Bcb) != NULL) { CcUnpinData( ((V)-&gt;Bcb) ); ((V)-&gt;Bcb) = NULL; ((V)-&gt;View) = NULL; }</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a69">UdfUnpinData</a>(IC, B)&nbsp;&nbsp;&nbsp;if (*(B) != NULL) { CcUnpinData( *(B) ); *(B) = NULL; }</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a70">UdfMapUserBuffer</a>(IC, UB)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a71">UdfLockUserBuffer</a>(IC, BL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a72">UdfAcquireUdfData</a>(IC)&nbsp;&nbsp;&nbsp;ExAcquireResourceExclusive( &amp;<a class="el" href="../../d1/d8/udfdata_8h.html#a51">UdfData</a>.DataResource, TRUE )</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a73">UdfReleaseUdfData</a>(IC)&nbsp;&nbsp;&nbsp;ExReleaseResource( &amp;<a class="el" href="../../d1/d8/udfdata_8h.html#a51">UdfData</a>.DataResource )</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a74">UdfAcquireVcbExclusive</a>(IC, V, I)&nbsp;&nbsp;&nbsp;UdfAcquireResource( (IC), &amp;(V)-&gt;VcbResource, (I), AcquireExclusive )</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a75">UdfAcquireVcbShared</a>(IC, V, I)&nbsp;&nbsp;&nbsp;UdfAcquireResource( (IC), &amp;(V)-&gt;VcbResource, (I), AcquireShared )</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a76">UdfReleaseVcb</a>(IC, V)&nbsp;&nbsp;&nbsp;ExReleaseResource( &amp;(V)-&gt;VcbResource )</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a77">UdfAcquireAllFiles</a>(IC, V)&nbsp;&nbsp;&nbsp;UdfAcquireResource( (IC), &amp;(V)-&gt;FileResource, FALSE, AcquireExclusive )</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a78">UdfReleaseAllFiles</a>(IC, V)&nbsp;&nbsp;&nbsp;ExReleaseResource( &amp;(V)-&gt;FileResource )</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a79">UdfAcquireFileExclusive</a>(IC, F)&nbsp;&nbsp;&nbsp;UdfAcquireResource( (IC), (F)-&gt;<a class="el" href="../../d4/d0/tex_8c.html#a21">Resource</a>, FALSE, AcquireExclusive )</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a80">UdfAcquireFileShared</a>(IC, F)&nbsp;&nbsp;&nbsp;UdfAcquireResource( (IC), (F)-&gt;<a class="el" href="../../d4/d0/tex_8c.html#a21">Resource</a>, FALSE, AcquireShared )</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a81">UdfAcquireFileSharedStarveExclusive</a>(IC, F)&nbsp;&nbsp;&nbsp;UdfAcquireResource( (IC), (F)-&gt;<a class="el" href="../../d4/d0/tex_8c.html#a21">Resource</a>, FALSE, AcquireSharedStarveExclusive )</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a82">UdfReleaseFile</a>(IC, F)&nbsp;&nbsp;&nbsp;ExReleaseResource( (F)-&gt;<a class="el" href="../../d4/d0/tex_8c.html#a21">Resource</a> )</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a83">UdfAcquireFcbExclusive</a>(IC, F, I)&nbsp;&nbsp;&nbsp;UdfAcquireResource( (IC), &amp;(F)-&gt;FcbNonpaged-&gt;FcbResource, (I), AcquireExclusive )</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a84">UdfAcquireFcbShared</a>(IC, F, I)&nbsp;&nbsp;&nbsp;UdfAcquireResource( (IC), &amp;(F)-&gt;FcbNonpaged-&gt;FcbResource, (I), AcquireShared )</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a85">UdfReleaseFcb</a>(IC, F)&nbsp;&nbsp;&nbsp;ExReleaseResource( &amp;(F)-&gt;FcbNonpaged-&gt;FcbResource )</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a86">UdfLockUdfData</a>()</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a87">UdfUnlockUdfData</a>()</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a88">UdfLockVcb</a>(IC, V)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a89">UdfUnlockVcb</a>(IC, V)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a90">UdfLockFcb</a>(IC, F)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a91">UdfUnlockFcb</a>(IC, F)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a92">UdfCreateIrpContextLite</a>(IC)&nbsp;&nbsp;&nbsp;ExAllocatePoolWithTag( UdfNonPagedPool, sizeof( <a class="el" href="../../d2/d3/struct__IRP__CONTEXT__LITE.html">IRP_CONTEXT_LITE</a> ), TAG_IRP_CONTEXT_LITE )</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a93">UdfFreeIrpContextLite</a>(ICL)&nbsp;&nbsp;&nbsp;ExFreePool( ICL )</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a94">UdfAllocateIoContext</a>()</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a95">UdfFreeIoContext</a>(IO)&nbsp;&nbsp;&nbsp;ExFreePool( IO )</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a96">UdfIncrementCleanupCounts</a>(IC, F)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a97">UdfDecrementCleanupCounts</a>(IC, F)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a98">UdfIncrementReferenceCounts</a>(IC, F, C, UC)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a99">UdfDecrementReferenceCounts</a>(IC, F, C, UC)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a100">UdfIsRawDevice</a>(IC, S)</td></tr>

<tr><td colspan=2><br><h2>Typedefs</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d9/d2/union__UCHAR1.html">_UCHAR1</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a101">UCHAR1</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d9/d2/union__UCHAR1.html">_UCHAR1</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a102">PUCHAR1</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d0/d3/union__UCHAR2.html">_UCHAR2</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a103">UCHAR2</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d0/d3/union__UCHAR2.html">_UCHAR2</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a104">PUCHAR2</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d1/d3/union__UCHAR4.html">_UCHAR4</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a105">UCHAR4</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d1/d3/union__UCHAR4.html">_UCHAR4</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a106">PUCHAR4</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d7/d4/union__USHORT2.html">_USHORT2</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a107">USHORT2</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef <a class="el" href="../../d7/d4/union__USHORT2.html">_USHORT2</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a108">PUSHORT2</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef enum <a class="el" href="../../d3/d8/udfprocs_8h.html#a263">_TYPE_OF_OPEN</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a109">TYPE_OF_OPEN</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef enum <a class="el" href="../../d3/d8/udfprocs_8h.html#a263">_TYPE_OF_OPEN</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a110">PTYPE_OF_OPEN</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef enum <a class="el" href="../../d3/d8/udfprocs_8h.html#a264">_TYPE_OF_ACQUIRE</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a111">TYPE_OF_ACQUIRE</a></td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>typedef enum <a class="el" href="../../d3/d8/udfprocs_8h.html#a264">_TYPE_OF_ACQUIRE</a> *&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a112">PTYPE_OF_ACQUIRE</a></td></tr>

<tr><td colspan=2><br><h2>Enumerations</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>enum &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a263">_TYPE_OF_OPEN</a> { <br>
&nbsp;&nbsp;<a class="el" href="../../d3/d8/udfprocs_8h.html#a263a113">UnopenedFileObject</a> =  0, 
<a class="el" href="../../d3/d8/udfprocs_8h.html#a263a114">StreamFileOpen</a>, 
<a class="el" href="../../d3/d8/udfprocs_8h.html#a263a115">UserVolumeOpen</a>, 
<a class="el" href="../../d3/d8/udfprocs_8h.html#a263a116">UserDirectoryOpen</a>, 
<br>
&nbsp;&nbsp;<a class="el" href="../../d3/d8/udfprocs_8h.html#a263a117">UserFileOpen</a>, 
<a class="el" href="../../d3/d8/udfprocs_8h.html#a263a118">BeyondValidType</a>
<br>
 }</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>enum &nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a264">_TYPE_OF_ACQUIRE</a> { <a class="el" href="../../d3/d8/udfprocs_8h.html#a264a119">AcquireExclusive</a>, 
<a class="el" href="../../d3/d8/udfprocs_8h.html#a264a120">AcquireShared</a>, 
<a class="el" href="../../d3/d8/udfprocs_8h.html#a264a121">AcquireSharedStarveExclusive</a>
 }</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>INLINE DECLSPEC_NORETURN VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a122">UdfRaiseStatus</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN NTSTATUS <a class="el" href="../../d2/d1/cttoken_8c.html#a18">Status</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>INLINE VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a123">UdfNormalizeAndRaiseStatus</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN NTSTATUS <a class="el" href="../../d2/d1/cttoken_8c.html#a18">Status</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>INLINE VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a124">UdfFreePool</a> (IN PVOID *Pool)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>INLINE BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a125">UdfEqualCountedString</a> (IN PSTRING <a class="el" href="../../d0/d0/tdetach_8c.html#a0">String</a>, IN PCHAR Field)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a126">UdfFsdDispatch</a> (IN <a class="el" href="../../d6/d7/struct__VOLUME__DEVICE__OBJECT.html">PVOLUME_DEVICE_OBJECT</a> VolumeDeviceObject, IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>LONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a127">UdfExceptionFilter</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN PEXCEPTION_POINTERS ExceptionPointer)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a128">UdfProcessException</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext OPTIONAL, IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>, IN NTSTATUS ExceptionCode)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext OPTIONAL, IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a> OPTIONAL, IN NTSTATUS <a class="el" href="../../d2/d1/cttoken_8c.html#a18">Status</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a130">UdfSetThreadContext</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN <a class="el" href="../../d0/d1/struct__THREAD__CONTEXT.html">PTHREAD_CONTEXT</a> <a class="el" href="../../d2/d1/cttoken_8c.html#a62">ThreadContext</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>INLINE VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a131">UdfRestoreThreadContext</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a132">UdfSerial32</a> (IN PCHAR <a class="el" href="../../d8/d6/ttri_8c.html#a3">Buffer</a>, IN ULONG ByteCount)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a133">UdfInitializeCrc16</a> (ULONG Polynomial)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a134">UdfComputeCrc16</a> (IN PUCHAR <a class="el" href="../../d8/d6/ttri_8c.html#a3">Buffer</a>, IN ULONG ByteCount)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a135">UdfComputeCrc16Uni</a> (PWCHAR <a class="el" href="../../d8/d6/ttri_8c.html#a3">Buffer</a>, ULONG CharCount)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a136">UdfHighBit</a> (ULONG Word)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a137">UdfFastQueryBasicInfo</a> (IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject, IN BOOLEAN Wait, IN OUT PFILE_BASIC_INFORMATION <a class="el" href="../../d8/d6/ttri_8c.html#a3">Buffer</a>, OUT PIO_STATUS_BLOCK IoStatus, IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a138">UdfFastIoCheckIfPossible</a> (IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject, IN PLARGE_INTEGER FileOffset, IN ULONG Length, IN BOOLEAN Wait, IN ULONG LockKey, IN BOOLEAN CheckForReadOperation, OUT PIO_STATUS_BLOCK IoStatus, IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a139">UdfFastLock</a> (IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject, IN PLARGE_INTEGER FileOffset, IN PLARGE_INTEGER Length, <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> ProcessId, ULONG <a class="el" href="../../d3/d0/user32_8def.html#a52">Key</a>, BOOLEAN FailImmediately, BOOLEAN ExclusiveLock, OUT PIO_STATUS_BLOCK IoStatus, IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a140">UdfFastQueryNetworkInfo</a> (IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject, IN BOOLEAN Wait, OUT PFILE_NETWORK_OPEN_INFORMATION <a class="el" href="../../d8/d6/ttri_8c.html#a3">Buffer</a>, OUT PIO_STATUS_BLOCK IoStatus, IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a141">UdfFastQueryStdInfo</a> (IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject, IN BOOLEAN Wait, IN OUT PFILE_STANDARD_INFORMATION <a class="el" href="../../d8/d6/ttri_8c.html#a3">Buffer</a>, OUT PIO_STATUS_BLOCK IoStatus, IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a142">UdfFastUnlockSingle</a> (IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject, IN PLARGE_INTEGER FileOffset, IN PLARGE_INTEGER Length, <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> ProcessId, ULONG <a class="el" href="../../d3/d0/user32_8def.html#a52">Key</a>, OUT PIO_STATUS_BLOCK IoStatus, IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a143">UdfFastUnlockAll</a> (IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject, <a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a> ProcessId, OUT PIO_STATUS_BLOCK IoStatus, IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a144">UdfFastUnlockAllByKey</a> (IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject, PVOID ProcessId, ULONG <a class="el" href="../../d3/d0/user32_8def.html#a52">Key</a>, OUT PIO_STATUS_BLOCK IoStatus, IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceObject)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>INLINE BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a145">UdfIllegalFcbAccess</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN <a class="el" href="../../d3/d8/udfprocs_8h.html#a109">TYPE_OF_OPEN</a> TypeOfOpen, IN ACCESS_MASK DesiredAccess)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a146">UdfLookupAllocation</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN <a class="el" href="../../d7/d9/struct__FCB.html">PFCB</a> Fcb, IN LONGLONG FileOffset, OUT PLONGLONG DiskOffset, OUT PULONG ByteCount)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a147">UdfDeletePcb</a> (IN <a class="el" href="../../d4/d9/struct__PCB.html">PPCB</a> Pcb)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a148">UdfInitializePcb</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN <a class="el" href="../../d7/d5/struct__VCB.html">PVCB</a> Vcb, IN OUT <a class="el" href="../../d4/d9/struct__PCB.html">PPCB</a> *Pcb, IN <a class="el" href="../../d6/d2/structNSR__LVOL.html">PNSR_LVOL</a> LVD)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a149">UdfAddToPcb</a> (IN <a class="el" href="../../d4/d9/struct__PCB.html">PPCB</a> Pcb, IN <a class="el" href="../../d7/d2/structNSR__PART.html">PNSR_PART</a> PartitionDescriptor)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a150">UdfCompletePcb</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN <a class="el" href="../../d7/d5/struct__VCB.html">PVCB</a> Vcb, IN <a class="el" href="../../d4/d9/struct__PCB.html">PPCB</a> Pcb)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a151">UdfEquivalentPcb</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN <a class="el" href="../../d4/d9/struct__PCB.html">PPCB</a> Pcb1, IN <a class="el" href="../../d4/d9/struct__PCB.html">PPCB</a> Pcb2)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a152">UdfLookupPsnOfExtent</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN <a class="el" href="../../d7/d5/struct__VCB.html">PVCB</a> Vcb, IN <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a> Reference, IN ULONG Lbn, IN ULONG Len)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a153">UdfLookupMetaVsnOfExtent</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN <a class="el" href="../../d7/d5/struct__VCB.html">PVCB</a> Vcb, IN <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a> Reference, IN ULONG Lbn, IN ULONG Len, IN BOOLEAN ExactEnd)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a154">UdfCreateInternalStream</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN <a class="el" href="../../d7/d5/struct__VCB.html">PVCB</a> Vcb, IN <a class="el" href="../../d7/d9/struct__FCB.html">PFCB</a> Fcb)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a155">UdfDeleteInternalStream</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN <a class="el" href="../../d7/d9/struct__FCB.html">PFCB</a> Fcb)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a156">UdfCompleteMdl</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a157">UdfMapMetadataView</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN <a class="el" href="../../d6/d6/struct__MAPPED__PVIEW.html">PMAPPED_PVIEW</a> View, IN <a class="el" href="../../d7/d5/struct__VCB.html">PVCB</a> Vcb, IN <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a> Partition, IN ULONG Lbn, IN ULONG Length)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a158">UdfPurgeVolume</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN <a class="el" href="../../d7/d5/struct__VCB.html">PVCB</a> Vcb, IN BOOLEAN DismountUnderway)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a159">UdfPerformDevIoCtrl</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN ULONG IoControlCode, IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> Device, OUT PVOID OutputBuffer OPTIONAL, IN ULONG OutputBufferLength, IN BOOLEAN InternalDeviceIoControl, IN BOOLEAN OverrideVerify, OUT PIO_STATUS_BLOCK Iosb OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a160">UdfReadSectors</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN LONGLONG StartingOffset, IN ULONG ByteCount, IN BOOLEAN ReturnError, IN OUT PVOID <a class="el" href="../../d8/d6/ttri_8c.html#a3">Buffer</a>, IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> TargetDeviceObject)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a161">UdfNonCachedRead</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN <a class="el" href="../../d7/d9/struct__FCB.html">PFCB</a> Fcb, IN LONGLONG StartingOffset, IN ULONG ByteCount)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a162">UdfCreateUserMdl</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN ULONG BufferLength, IN BOOLEAN RaiseOnError)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>INLINE ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a163">UdfRawBufferSize</a> (IN <a class="el" href="../../d7/d5/struct__VCB.html">PVCB</a> Vcb, IN ULONG StructureSize)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>INLINE ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a164">UdfRawReadSize</a> (IN <a class="el" href="../../d7/d5/struct__VCB.html">PVCB</a> Vcb, IN ULONG StructureSize)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>INLINE ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a165">UdfRawBufferSizeN</a> (IN ULONG SectorSize, IN ULONG StructureSize)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>INLINE ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a166">UdfRawReadSizeN</a> (IN ULONG SectorSize, IN ULONG StructureSize)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a167">UdfInitializeDirContext</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN <a class="el" href="../../d5/d5/struct__DIR__ENUM__CONTEXT.html">PDIR_ENUM_CONTEXT</a> DirContext)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a168">UdfCleanupDirContext</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN <a class="el" href="../../d5/d5/struct__DIR__ENUM__CONTEXT.html">PDIR_ENUM_CONTEXT</a> DirContext)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a169">UdfLookupInitialDirEntry</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN <a class="el" href="../../d7/d9/struct__FCB.html">PFCB</a> Fcb, IN <a class="el" href="../../d5/d5/struct__DIR__ENUM__CONTEXT.html">PDIR_ENUM_CONTEXT</a> DirContext, IN PLONGLONG InitialOffset OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a170">UdfLookupNextDirEntry</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN <a class="el" href="../../d7/d9/struct__FCB.html">PFCB</a> Fcb, IN <a class="el" href="../../d5/d5/struct__DIR__ENUM__CONTEXT.html">PDIR_ENUM_CONTEXT</a> DirContext)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a171">UdfUpdateDirNames</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN <a class="el" href="../../d5/d5/struct__DIR__ENUM__CONTEXT.html">PDIR_ENUM_CONTEXT</a> DirContext, IN BOOLEAN IgnoreCase)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a172">UdfFindDirEntry</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN <a class="el" href="../../d7/d9/struct__FCB.html">PFCB</a> Fcb, IN PUNICODE_STRING <a class="el" href="../../d9/d3/rules_8c.html#a6">Name</a>, IN BOOLEAN IgnoreCase, IN BOOLEAN ShortName, IN <a class="el" href="../../d5/d5/struct__DIR__ENUM__CONTEXT.html">PDIR_ENUM_CONTEXT</a> DirContext)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a173">UdfSetFileObject</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject, IN <a class="el" href="../../d3/d8/udfprocs_8h.html#a109">TYPE_OF_OPEN</a> TypeOfOpen, IN <a class="el" href="../../d7/d9/struct__FCB.html">PFCB</a> Fcb OPTIONAL, IN <a class="el" href="../../d2/d9/struct__CCB.html">PCCB</a> Ccb OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d3/d8/udfprocs_8h.html#a109">TYPE_OF_OPEN</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a174">UdfDecodeFileObject</a> (IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject, OUT <a class="el" href="../../d7/d9/struct__FCB.html">PFCB</a> *Fcb, OUT <a class="el" href="../../d2/d9/struct__CCB.html">PCCB</a> *Ccb)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d3/d8/udfprocs_8h.html#a109">TYPE_OF_OPEN</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a175">UdfFastDecodeFileObject</a> (IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject, OUT <a class="el" href="../../d7/d9/struct__FCB.html">PFCB</a> *Fcb)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a176">UdfStoreVolumeDescriptorIfPrevailing</a> (IN OUT <a class="el" href="../../d4/d3/structNSR__VD__GENERIC.html">PNSR_VD_GENERIC</a> *StoredVD, IN OUT <a class="el" href="../../d4/d3/structNSR__VD__GENERIC.html">PNSR_VD_GENERIC</a> NewVD)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a177">UdfDissectName</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN OUT PUNICODE_STRING RemainingName, OUT PUNICODE_STRING FinalName)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a178">UdfIs8dot3Name</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN UNICODE_STRING <a class="el" href="../../d8/d1/hivestat_8c.html#a9">FileName</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a179">UdfCandidateShortName</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN PUNICODE_STRING <a class="el" href="../../d9/d3/rules_8c.html#a6">Name</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a180">UdfGenerate8dot3Name</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN PUNICODE_STRING <a class="el" href="../../d8/d1/hivestat_8c.html#a9">FileName</a>, OUT PUNICODE_STRING ShortFileName)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a181">UdfConvertCS0DstringToUnicode</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN PUCHAR Dstring, IN UCHAR Length OPTIONAL, IN UCHAR FieldLength OPTIONAL, IN OUT PUNICODE_STRING <a class="el" href="../../d9/d3/rules_8c.html#a6">Name</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a182">UdfCheckLegalCS0Dstring</a> (<a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, PUCHAR Dstring, UCHAR Length OPTIONAL, UCHAR FieldLength OPTIONAL, BOOLEAN ReturnOnError)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a183">UdfRenderNameToLegalUnicode</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN PUNICODE_STRING <a class="el" href="../../d9/d3/rules_8c.html#a6">Name</a>, IN PUNICODE_STRING RenderedName)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a184">UdfIsNameInExpression</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN PUNICODE_STRING CurrentName, IN PUNICODE_STRING SearchExpression, IN BOOLEAN Wild)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d1/d8/fsrtl_8h.html#a70">FSRTL_COMPARISON_RESULT</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a185">UdfFullCompareNames</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN PUNICODE_STRING NameA, IN PUNICODE_STRING NameB)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>INLINE VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a186">UdfUpcaseName</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN PUNICODE_STRING <a class="el" href="../../d9/d3/rules_8c.html#a6">Name</a>, IN OUT PUNICODE_STRING UpcaseName)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>INLINE <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a187">UdfCS0DstringUnicodeSize</a> (<a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, PCHAR Dstring, UCHAR Length)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>INLINE BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a188">UdfIsCharacterLegal</a> (IN WCHAR Character)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>INLINE BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a189">UdfCS0DstringContainsLegalCharacters</a> (IN PCHAR Dstring, IN ULONG Length)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a190">UdfLockVolumeInternal</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN <a class="el" href="../../d7/d5/struct__VCB.html">PVCB</a> Vcb, IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a191">UdfUnlockVolumeInternal</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN <a class="el" href="../../d7/d5/struct__VCB.html">PVCB</a> Vcb, IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d5/d9/struct__LCB.html">PLCB</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a192">UdfFindPrefix</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN OUT <a class="el" href="../../d7/d9/struct__FCB.html">PFCB</a> *CurrentFcb, IN OUT PUNICODE_STRING RemainingName, IN BOOLEAN IgnoreCase)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a193">UdfInitializeLcbFromDirContext</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN <a class="el" href="../../d5/d9/struct__LCB.html">PLCB</a> Lcb, IN <a class="el" href="../../d5/d5/struct__DIR__ENUM__CONTEXT.html">PDIR_ENUM_CONTEXT</a> DirContext)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d5/d9/struct__LCB.html">PLCB</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a194">UdfInsertPrefix</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN <a class="el" href="../../d7/d9/struct__FCB.html">PFCB</a> Fcb, IN PUNICODE_STRING <a class="el" href="../../d9/d3/rules_8c.html#a6">Name</a>, IN BOOLEAN ShortNameMatch, IN BOOLEAN IgnoreCase, IN <a class="el" href="../../d7/d9/struct__FCB.html">PFCB</a> ParentFcb)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a195">UdfRemovePrefix</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN <a class="el" href="../../d5/d9/struct__LCB.html">PLCB</a> Lcb)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a196">UdfAcquireResource</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN <a class="el" href="../../d6/d4/struct__ERESOURCE.html">PERESOURCE</a> <a class="el" href="../../d4/d0/tex_8c.html#a21">Resource</a>, IN BOOLEAN IgnoreWait, IN <a class="el" href="../../d3/d8/udfprocs_8h.html#a111">TYPE_OF_ACQUIRE</a> Type)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a197">UdfNoopAcquire</a> (IN PVOID Fcb, IN BOOLEAN Wait)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a198">UdfNoopRelease</a> (IN PVOID Fcb)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a199">UdfAcquireForCache</a> (IN <a class="el" href="../../d7/d9/struct__FCB.html">PFCB</a> Fcb, IN BOOLEAN Wait)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a200">UdfReleaseFromCache</a> (IN <a class="el" href="../../d7/d9/struct__FCB.html">PFCB</a> Fcb)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a201">UdfAcquireForCreateSection</a> (IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a202">UdfReleaseForCreateSection</a> (IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a203">UdfInitializeVcb</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN OUT <a class="el" href="../../d7/d5/struct__VCB.html">PVCB</a> Vcb, IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> TargetDeviceObject, IN <a class="el" href="../../d7/d7/struct__VPB.html">PVPB</a> Vpb, IN PDISK_GEOMETRY DiskGeometry, IN ULONG MediaChangeCount)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a204">UdfUpdateVcbPhase0</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN OUT <a class="el" href="../../d7/d5/struct__VCB.html">PVCB</a> Vcb)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a205">UdfUpdateVcbPhase1</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN OUT <a class="el" href="../../d7/d5/struct__VCB.html">PVCB</a> Vcb, IN <a class="el" href="../../d2/d2/structNSR__FSD.html">PNSR_FSD</a> Fsd)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a206">UdfDeleteVcb</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN OUT <a class="el" href="../../d7/d5/struct__VCB.html">PVCB</a> Vcb)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a207">UdfCreateIrpContext</a> (IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>, IN BOOLEAN Wait)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a208">UdfCleanupIrpContext</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN BOOLEAN Post)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a209">UdfInitializeStackIrpContext</a> (OUT <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN <a class="el" href="../../d2/d3/struct__IRP__CONTEXT__LITE.html">PIRP_CONTEXT_LITE</a> IrpContextLite)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a210">UdfTeardownStructures</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN <a class="el" href="../../d7/d9/struct__FCB.html">PFCB</a> StartingFcb, IN BOOLEAN Recursive, OUT PBOOLEAN RemovedStartingFcb)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d7/d9/struct__FCB.html">PFCB</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a211">UdfLookupFcbTable</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN <a class="el" href="../../d7/d5/struct__VCB.html">PVCB</a> Vcb, IN <a class="el" href="../../d6/d8/udfstruc_8h.html#a77">FILE_ID</a> FileId)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d7/d9/struct__FCB.html">PFCB</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a212">UdfGetNextFcb</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN <a class="el" href="../../d7/d5/struct__VCB.html">PVCB</a> Vcb, IN PVOID *RestartKey)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d7/d9/struct__FCB.html">PFCB</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a213">UdfCreateFcb</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN <a class="el" href="../../d6/d8/udfstruc_8h.html#a77">FILE_ID</a> FileId, IN <a class="el" href="../../d1/d7/udfs_2nodetype_8h.html#a89">NODE_TYPE_CODE</a> NodeTypeCode, OUT PBOOLEAN FcbExisted OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a214">UdfDeleteFcb</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN <a class="el" href="../../d7/d9/struct__FCB.html">PFCB</a> Fcb)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a215">UdfInitializeFcbFromIcbContext</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN <a class="el" href="../../d7/d9/struct__FCB.html">PFCB</a> Fcb, IN <a class="el" href="../../d9/d9/struct__ICB__SEARCH__CONTEXT.html">PICB_SEARCH_CONTEXT</a> IcbContext)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top><a class="el" href="../../d2/d9/struct__CCB.html">PCCB</a>&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a216">UdfCreateCcb</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN <a class="el" href="../../d7/d9/struct__FCB.html">PFCB</a> Fcb, IN <a class="el" href="../../d5/d9/struct__LCB.html">PLCB</a> Lcb OPTIONAL, IN ULONG Flags)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a217">UdfDeleteCcb</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN <a class="el" href="../../d2/d9/struct__CCB.html">PCCB</a> Ccb)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>ULONG&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a218">UdfFindInParseTable</a> (IN <a class="el" href="../../d2/d8/struct__PARSE__KEYVALUE.html">PPARSE_KEYVALUE</a> ParseTable, IN PCHAR Id, IN ULONG MaxIdLen)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a219">UdfVerifyDescriptor</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN <a class="el" href="../../d7/d7/structDESTAG.html">PDESTAG</a> Descriptor, IN <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a> Tag, IN ULONG <a class="el" href="../../d9/d7/w98_2lh__open_2pi__mem_8h.html#a0">Size</a>, IN ULONG Lbn, IN BOOLEAN ReturnError)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a220">UdfInitializeIcbContextFromFcb</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN <a class="el" href="../../d9/d9/struct__ICB__SEARCH__CONTEXT.html">PICB_SEARCH_CONTEXT</a> IcbContext, IN <a class="el" href="../../d7/d9/struct__FCB.html">PFCB</a> Fcb)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a221">UdfInitializeIcbContext</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN <a class="el" href="../../d9/d9/struct__ICB__SEARCH__CONTEXT.html">PICB_SEARCH_CONTEXT</a> IcbContext, IN <a class="el" href="../../d7/d5/struct__VCB.html">PVCB</a> Vcb, IN <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a> IcbType, IN <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a> Partition, IN ULONG Lbn, IN ULONG Length)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>INLINE VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a222">UdfFastInitializeIcbContext</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN <a class="el" href="../../d9/d9/struct__ICB__SEARCH__CONTEXT.html">PICB_SEARCH_CONTEXT</a> IcbContext)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a223">UdfLookupActiveIcb</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN <a class="el" href="../../d9/d9/struct__ICB__SEARCH__CONTEXT.html">PICB_SEARCH_CONTEXT</a> IcbContext)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a224">UdfCleanupIcbContext</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN <a class="el" href="../../d9/d9/struct__ICB__SEARCH__CONTEXT.html">PICB_SEARCH_CONTEXT</a> IcbContext)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a225">UdfInitializeAllocations</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN <a class="el" href="../../d7/d9/struct__FCB.html">PFCB</a> Fcb, IN <a class="el" href="../../d9/d9/struct__ICB__SEARCH__CONTEXT.html">PICB_SEARCH_CONTEXT</a> IcbContext)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a226">UdfUpdateTimestampsFromIcbContext</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN <a class="el" href="../../d9/d9/struct__ICB__SEARCH__CONTEXT.html">PICB_SEARCH_CONTEXT</a> IcbContext, IN <a class="el" href="../../d4/d1/struct__TIMESTAMP__BUNDLE.html">PTIMESTAMP_BUNDLE</a> Timestamps)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a227">UdfCreateFileLock</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext OPTIONAL, IN <a class="el" href="../../d7/d9/struct__FCB.html">PFCB</a> Fcb, IN BOOLEAN RaiseOnError)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>INLINE VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a228">UdfConvertUdfTimeToNtTime</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN <a class="el" href="../../d5/d0/structTIMESTAMP.html">PTIMESTAMP</a> UdfTime, OUT PLARGE_INTEGER NtTime)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>INLINE BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a229">UdfEqualEntityId</a> (IN <a class="el" href="../../d6/d6/structREGID.html">PREGID</a> RegID, IN PSTRING Id, IN OPTIONAL PSTRING Suffix)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>INLINE BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a230">UdfDomainIdentifierContained</a> (IN <a class="el" href="../../d6/d6/structREGID.html">PREGID</a> RegID, IN PSTRING Domain, IN <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a> RevisionMin, IN <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a> RevisionMax)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>INLINE BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a231">UdfUdfIdentifierContained</a> (IN <a class="el" href="../../d6/d6/structREGID.html">PREGID</a> RegID, IN PSTRING Type, IN <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a> RevisionMin, IN <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a> RevisionMax, IN UCHAR OSClass, IN UCHAR OSIdentifier)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a232">UdfCheckForDismount</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN <a class="el" href="../../d7/d5/struct__VCB.html">PVCB</a> Vcb, IN BOOLEAN Force)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a233">UdfDismountVcb</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN <a class="el" href="../../d7/d5/struct__VCB.html">PVCB</a> Vcb)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a234">UdfVerifyVcb</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN <a class="el" href="../../d7/d5/struct__VCB.html">PVCB</a> Vcb)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a235">UdfVerifyFcbOperation</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext OPTIONAL, IN <a class="el" href="../../d7/d9/struct__FCB.html">PFCB</a> Fcb)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a236">UdfInitializeVmcb</a> (IN <a class="el" href="../../d1/d7/struct__VMCB.html">PVMCB</a> Vmcb, IN <a class="el" href="../../d5/d8/ex_8h.html#a96">POOL_TYPE</a> PoolType, IN ULONG MaximumLbn, IN ULONG LbSize)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a237">UdfUninitializeVmcb</a> (IN <a class="el" href="../../d1/d7/struct__VMCB.html">PVMCB</a> Vmcb)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a238">UdfResetVmcb</a> (IN <a class="el" href="../../d1/d7/struct__VMCB.html">PVMCB</a> Vmcb)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a239">UdfSetMaximumLbnVmcb</a> (IN <a class="el" href="../../d1/d7/struct__VMCB.html">PVMCB</a> Vmcb, IN ULONG MaximumLbn)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a240">UdfVmcbVbnToLbn</a> (IN <a class="el" href="../../d1/d7/struct__VMCB.html">PVMCB</a> Vmcb, IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a52">VBN</a> Vbn, OUT <a class="el" href="../../d1/d8/fsrtl_8h.html#a51">PLBN</a> Lbn, OUT PULONG SectorCount OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a241">UdfVmcbLbnToVbn</a> (IN <a class="el" href="../../d1/d7/struct__VMCB.html">PVMCB</a> Vmcb, IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a50">LBN</a> Lbn, OUT <a class="el" href="../../d1/d8/fsrtl_8h.html#a53">PVBN</a> Vbn, OUT PULONG SectorCount OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a242">UdfAddVmcbMapping</a> (IN <a class="el" href="../../d1/d7/struct__VMCB.html">PVMCB</a> Vmcb, IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a50">LBN</a> Lbn, IN ULONG SectorCount, IN BOOLEAN ExactEnd, OUT <a class="el" href="../../d1/d8/fsrtl_8h.html#a53">PVBN</a> Vbn, OUT PULONG AlignedSectorCount)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a243">UdfRemoveVmcbMapping</a> (IN <a class="el" href="../../d1/d7/struct__VMCB.html">PVMCB</a> Vmcb, IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a50">LBN</a> Lbn, IN ULONG SectorCount)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a244">UdfPerformVerify</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>, IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> DeviceToVerify)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a245">UdfFsdPostRequest</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a246">UdfPrePostIrp</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a247">UdfOplockComplete</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>INLINE BOOLEAN&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a248">UdfEqualCharspec</a> (IN <a class="el" href="../../d2/d3/structCHARSPEC.html">PCHARSPEC</a> Charspec, IN PSTRING Identifier, IN UCHAR Type)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a249">UdfFspDispatch</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>VOID&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a250">UdfFspClose</a> (IN <a class="el" href="../../d7/d5/struct__VCB.html">PVCB</a> Vcb OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a251">UdfCommonCleanup</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a252">UdfCommonClose</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a253">UdfCommonCreate</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a254">UdfCommonDevControl</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a255">UdfCommonDirControl</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a256">UdfCommonFsControl</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a257">UdfCommonLockControl</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a258">UdfCommonPnp</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a259">UdfCommonQueryInfo</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a260">UdfCommonQueryVolInfo</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a261">UdfCommonRead</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfprocs_8h.html#a262">UdfCommonSetInfo</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>)</td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a10" doxytag="udfprocs.h::Add2Ptr" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define Add2Ptr          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PTR,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>INC,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>CAST&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;((CAST)((ULONG_PTR)(PTR) + (INC)))</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00103">103</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a45" doxytag="udfprocs.h::BlockAlign" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define BlockAlign          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">V,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>L&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>(                                                      \
    <a class="code" href="../../d3/d8/fsrtlp_8h.html#a12">SectorAlign</a>((V), (L))                                                       \
)
</div></pre>
<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00244">244</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a44" doxytag="udfprocs.h::BlockAlignN" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define BlockAlignN          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">BLOCKSIZE,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>L&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>(                                             \
    SectorAlighN((BLOCKSIZE), (L))                                              \
)
</div></pre>
<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00240">240</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a55" doxytag="udfprocs.h::BlockOffset" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define BlockOffset          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">V,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>L&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>(                                                     \
    <a class="code" href="../../d3/d8/udfprocs_8h.html#a43">SectorOffset</a>((V), (L))                                                      \
)
</div></pre>
<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00280">280</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.
<p>
Referenced by <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l02558">UdfFindFileSetDescriptor()</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l03388">UdfInitializeAllocations()</a>, and <a class="el" href="../../d3/d5/allocsup_8c-source.html#l01177">UdfLookupMetaVsnOfExtent()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a50" doxytag="udfprocs.h::BlocksFromBytes" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define BlocksFromBytes          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">V,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>L&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>(                                                 \
    <a class="code" href="../../d3/d8/fsrtlp_8h.html#a13">SectorsFromBytes</a>((V), (L))                                                  \
)
</div></pre>
<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00264">264</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.
<p>
Referenced by <a class="el" href="../../d3/d5/allocsup_8c-source.html#l01177">UdfLookupMetaVsnOfExtent()</a>, and <a class="el" href="../../d3/d5/allocsup_8c-source.html#l01017">UdfLookupPsnOfExtent()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a53" doxytag="udfprocs.h::BlocksFromSectors" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define BlocksFromSectors          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">V,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>S&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;(S)</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00276">276</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.
<p>
Referenced by <a class="el" href="../../d3/d5/allocsup_8c-source.html#l01177">UdfLookupMetaVsnOfExtent()</a>, and <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l00477">UdfUpdateVcbPhase0()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a54" doxytag="udfprocs.h::BlockSize" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define BlockSize          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">V&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;(SectorSize(V))</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00278">278</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.
<p>
Referenced by <a class="el" href="../../d7/d5/ex_2region_8c-source.html#l00024">ExInitializeRegion()</a>, <a class="el" href="../../d9/d0/zone_8c-source.html#l00048">ExInitializeZone()</a>, <a class="el" href="../../d7/d5/ex_2region_8c-source.html#l00110">ExInterlockedExtendRegion()</a>, <a class="el" href="../../d2/d1/rtlinit_8c-source.html#l00221">InitLookaside()</a>, <a class="el" href="../../d4/d1/timerobj_8c-source.html#l00467">KeCheckForTimer()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l02558">UdfFindFileSetDescriptor()</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l04144">UdfGetNextAllocationPostProcessing()</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l03388">UdfInitializeAllocations()</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l02297">UdfInitializeFcbFromIcbContext()</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l02951">UdfInitializeIcbContextFromFcb()</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l03790">UdfLookupActiveIcbInExtent()</a>, <a class="el" href="../../d5/d7/dirsup_8c-source.html#l00916">UdfLookupDirEntryPostProcessing()</a>, <a class="el" href="../../d3/d5/allocsup_8c-source.html#l01017">UdfLookupPsnOfExtent()</a>, <a class="el" href="../../d8/d5/volinfo_8c-source.html#l00302">UdfQueryFsSizeInfo()</a>, and <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l00477">UdfUpdateVcbPhase0()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a47" doxytag="udfprocs.h::BlockTruncate" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define BlockTruncate          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">V,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>L&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>(                                                   \
    <a class="code" href="../../d3/d8/udfprocs_8h.html#a35">SectorTruncate</a>((V), (L))                                                    \
)
</div></pre>
<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00252">252</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a7" doxytag="udfprocs.h::BooleanFlagOff" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define BooleanFlagOff          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">F,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>SF&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>(          \
    (BOOLEAN)(<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>(F, SF)) == 0)      \
)
</div></pre>
<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00076">76</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="udfprocs.h::BooleanFlagOn" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define BooleanFlagOn          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">F,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>SF&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>(           \
    (BOOLEAN)(<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>(F, SF) != 0)       \
)
</div></pre>
<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00072">72</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="udfprocs.h::BugCheckFileId" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define BugCheckFileId&nbsp;&nbsp;&nbsp;(UDFS_BUG_CHECK_STRUCSUP)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00044">44</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a49" doxytag="udfprocs.h::BytesFromBlocks" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define BytesFromBlocks          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">V,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>L&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>(                                                 \
    <a class="code" href="../../d3/d8/fsrtlp_8h.html#a14">BytesFromSectors</a>((V), (L))                                                  \
)
</div></pre>
<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00260">260</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a37" doxytag="udfprocs.h::BytesFromSectors" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define BytesFromSectors          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">V,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>L&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>(                                                \
    ((ULONG) (<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>)) &lt;&lt; ((V)-&gt;SectorShift)                                         \
)
</div></pre>
<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00212">212</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a62" doxytag="udfprocs.h::CanFsdWait" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CanFsdWait          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">I&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;IoIsOperationSynchronous(I)</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00371">371</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.
<p>
Referenced by <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00218">UdfFsdDispatch()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a9" doxytag="udfprocs.h::ClearFlag" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define ClearFlag          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">Flags,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>SingleFlag&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>(   \
    (Flags) &amp;= ~(SingleFlag)            \
)
</div></pre>
<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00084">84</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a56" doxytag="udfprocs.h::CopyUchar1" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CopyUchar1          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">Dst,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>Src&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>{                           \
    *((<a class="code" href="../../d9/d2/union__UCHAR1.html">UCHAR1</a> *)(Dst)) = *((UNALIGNED <a class="code" href="../../d9/d2/union__UCHAR1.html">UCHAR1</a> *)(Src));  \
    }
</div></pre>
<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00313">313</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a57" doxytag="udfprocs.h::CopyUchar2" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CopyUchar2          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">Dst,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>Src&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>{                           \
    *((<a class="code" href="../../d0/d3/union__UCHAR2.html">UCHAR2</a> *)(Dst)) = *((UNALIGNED <a class="code" href="../../d0/d3/union__UCHAR2.html">UCHAR2</a> *)(Src));  \
    }
</div></pre>
<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00321">321</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a59" doxytag="udfprocs.h::CopyUchar4" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CopyUchar4          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">Dst,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>Src&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>{                           \
    *((<a class="code" href="../../d1/d3/union__UCHAR4.html">UCHAR4</a> *)(Dst)) = *((UNALIGNED <a class="code" href="../../d1/d3/union__UCHAR4.html">UCHAR4</a> *)(Src));  \
    }
</div></pre>
<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00339">339</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a61" doxytag="udfprocs.h::CopyUshort2" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define CopyUshort2          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">Dst,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>Src&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>{                          \
    *((<a class="code" href="../../d7/d4/union__USHORT2.html">USHORT2</a> *)(Dst)) = *((UNALIGNED <a class="code" href="../../d7/d4/union__USHORT2.html">USHORT2</a> *)(Src));\
    }
</div></pre>
<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00360">360</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="udfprocs.h::Dbg" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define Dbg&nbsp;&nbsp;&nbsp;(UDFS_DEBUG_LEVEL_STRUCSUP)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00050">50</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="udfprocs.h::FlagMask" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define FlagMask          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">F,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>SF&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>(                \
    ((F) &amp; (SF))                        \
)
</div></pre>
<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00068">68</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.
<p>
Referenced by <a class="el" href="../../d8/d5/sepaudit_8c-source.html#l00571">SepAdtOpenObjectAuditAlarm()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a13" doxytag="udfprocs.h::GenericAlign" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define GenericAlign          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">B,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>U&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>(                                                \
    <a class="code" href="../../d3/d8/udfprocs_8h.html#a12">GenericTruncate</a>((B) + (U) - 1, U)                                       \
)
</div></pre>
<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00118">118</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a17" doxytag="udfprocs.h::GenericAlignPtr" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define GenericAlignPtr          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">B,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>U&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>(                                             \
    <a class="code" href="../../d3/d8/udfprocs_8h.html#a16">GenericTruncatePtr</a>((B) + (U) - 1, (U))                                  \
)
</div></pre>
<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00135">135</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a14" doxytag="udfprocs.h::GenericOffset" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define GenericOffset          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">B,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>U&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>(                                               \
    (B) &amp; ((U) - 1)                                                         \
)
</div></pre>
<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00122">122</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.
<p>
Referenced by <a class="el" href="../../d5/d7/dirsup_8c-source.html#l00165">UdfLookupInitialDirEntry()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a18" doxytag="udfprocs.h::GenericOffsetPtr" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define GenericOffsetPtr          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">B,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>U&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>(                                            \
    (ULONG)(((ULONG_PTR)(B)) &amp; ((U) - 1))                                   \
)
</div></pre>
<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00139">139</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a15" doxytag="udfprocs.h::GenericRemainder" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define GenericRemainder          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">B,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>U&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>(                                            \
    <a class="code" href="../../d3/d8/udfprocs_8h.html#a14">GenericOffset</a>( (U) - <a class="code" href="../../d3/d8/udfprocs_8h.html#a14">GenericOffset</a>((B), (U)), (U) )                     \
)
</div></pre>
<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00126">126</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a19" doxytag="udfprocs.h::GenericRemainderPtr" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define GenericRemainderPtr          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">B,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>U&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>(                                         \
    (ULONG)<a class="code" href="../../d3/d8/udfprocs_8h.html#a14">GenericOffset</a>( (U) - <a class="code" href="../../d3/d8/udfprocs_8h.html#a18">GenericOffsetPtr</a>((B), (U)), (U) )           \
)
</div></pre>
<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00143">143</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.
<p>
Referenced by <a class="el" href="../../d5/d7/dirsup_8c-source.html#l00916">UdfLookupDirEntryPostProcessing()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a12" doxytag="udfprocs.h::GenericTruncate" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define GenericTruncate          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">B,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>U&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>(                                             \
    (B) &amp; ~((U) - 1)                                                        \
)
</div></pre>
<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00114">114</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.
<p>
Referenced by <a class="el" href="../../d5/d7/dirsup_8c-source.html#l00165">UdfLookupInitialDirEntry()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a16" doxytag="udfprocs.h::GenericTruncatePtr" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define GenericTruncatePtr          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">B,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>U&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>(                                          \
    (PVOID)(((ULONG_PTR)(B)) &amp; ~((U) - 1))                                  \
)
</div></pre>
<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00131">131</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.
<p>
Referenced by <a class="el" href="../../d5/d7/dirsup_8c-source.html#l00916">UdfLookupDirEntryPostProcessing()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a0" doxytag="udfprocs.h::INLINE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define INLINE&nbsp;&nbsp;&nbsp;__inline          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00032">32</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a46" doxytag="udfprocs.h::LlBlockAlign" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define LlBlockAlign          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">V,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>L&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>(                                                    \
    <a class="code" href="../../d3/d8/udfprocs_8h.html#a34">LlSectorAlign</a>((V), (L))                                                     \
)
</div></pre>
<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00248">248</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.
<p>
Referenced by <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l02297">UdfInitializeFcbFromIcbContext()</a>, and <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l00334">UdfQueryDirectory()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a52" doxytag="udfprocs.h::LlBlocksFromBytes" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define LlBlocksFromBytes          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">V,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>L&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>(                                               \
    <a class="code" href="../../d3/d8/udfprocs_8h.html#a40">LlSectorsFromBytes</a>((V), (L))                                                \
)
</div></pre>
<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00272">272</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.
<p>
Referenced by <a class="el" href="../../d8/d5/volinfo_8c-source.html#l00302">UdfQueryFsSizeInfo()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a48" doxytag="udfprocs.h::LlBlockTruncate" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define LlBlockTruncate          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">V,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>L&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>(                                                 \
    <a class="code" href="../../d3/d8/udfprocs_8h.html#a36">LlSectorTruncate</a>((V), (L))                                                  \
)
</div></pre>
<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00256">256</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a51" doxytag="udfprocs.h::LlBytesFromBlocks" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define LlBytesFromBlocks          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">V,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>L&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>(                                               \
    <a class="code" href="../../d3/d8/udfprocs_8h.html#a39">LlBytesFromSectors</a>((V), (L))                                                \
)
</div></pre>
<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00268">268</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.
<p>
Referenced by <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l02558">UdfFindFileSetDescriptor()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a39" doxytag="udfprocs.h::LlBytesFromSectors" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define LlBytesFromSectors          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">V,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>L&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>(                                              \
    Int64ShllMod32( (ULONGLONG)(L), ((V)-&gt;SectorShift) )                        \
)
</div></pre>
<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00220">220</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.
<p>
Referenced by <a class="el" href="../../d3/d6/udfs_2devctrl_8c-source.html#l00337">UdfDvdReadStructure()</a>, <a class="el" href="../../d3/d6/udfs_2devctrl_8c-source.html#l00227">UdfDvdTransferKey()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l03307">UdfFindAnchorVolumeDescriptor()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l02558">UdfFindFileSetDescriptor()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l02832">UdfFindVolumeDescriptors()</a>, <a class="el" href="../../d3/d5/allocsup_8c-source.html#l00069">UdfLookupAllocation()</a>, <a class="el" href="../../d3/d5/allocsup_8c-source.html#l01177">UdfLookupMetaVsnOfExtent()</a>, <a class="el" href="../../d9/d1/udfs_2cachesup_8c-source.html#l00337">UdfMapMetadataView()</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l00477">UdfUpdateVcbPhase0()</a>, and <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l00997">UdfUpdateVcbPhase1()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a34" doxytag="udfprocs.h::LlSectorAlign" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define LlSectorAlign          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">V,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>L&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>(                                                   \
    ((((LONGLONG)(<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>)) + (((V)-&gt;SectorSize) - 1)) &amp; ~(((LONGLONG)(V)-&gt;SectorSize) - 1)) \
)
</div></pre>
<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00200">200</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.
<p>
Referenced by <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l00477">UdfUpdateVcbPhase0()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a40" doxytag="udfprocs.h::LlSectorsFromBytes" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define LlSectorsFromBytes          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">V,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>L&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>(                                              \
    Int64ShrlMod32( (ULONGLONG)(L), ((V)-&gt;SectorShift) )                        \
)
</div></pre>
<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00224">224</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.
<p>
Referenced by <a class="el" href="../../d3/d6/udfs_2devctrl_8c-source.html#l00337">UdfDvdReadStructure()</a>, <a class="el" href="../../d3/d6/udfs_2devctrl_8c-source.html#l00227">UdfDvdTransferKey()</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l03388">UdfInitializeAllocations()</a>, <a class="el" href="../../d3/d5/allocsup_8c-source.html#l00069">UdfLookupAllocation()</a>, and <a class="el" href="../../d4/d6/deviosup_8c-source.html#l00685">UdfReadSectors()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a36" doxytag="udfprocs.h::LlSectorTruncate" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define LlSectorTruncate          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">V,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>L&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>(                                                \
    ((LONGLONG)(<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>)) &amp; ~(((LONGLONG)(V)-&gt;SectorSize) - 1)                        \
)
</div></pre>
<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00208">208</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.
<p>
Referenced by <a class="el" href="../../d4/d6/deviosup_8c-source.html#l00883">UdfPrepareBuffers()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a21" doxytag="udfprocs.h::LongAlign" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define LongAlign          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">B&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;GenericAlign((B), 4)</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00153">153</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a27" doxytag="udfprocs.h::LongAlignPtr" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define LongAlignPtr          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">P&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;GenericAlignPtr((P), 4)</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00167">167</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.
<p>
Referenced by <a class="el" href="../../d6/d2/tokenadj_8c-source.html#l00432">NtAdjustGroupsToken()</a>, and <a class="el" href="../../d1/d5/semethod_8c-source.html#l00559">SeQuerySecurityDescriptorInfo()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a24" doxytag="udfprocs.h::LongOffset" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define LongOffset          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">B&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;GenericOffset((B), 4)</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00160">160</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.
<p>
Referenced by <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l02297">UdfInitializeFcbFromIcbContext()</a>, and <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l00477">UdfUpdateVcbPhase0()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a30" doxytag="udfprocs.h::LongOffsetPtr" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define LongOffsetPtr          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">P&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;GenericOffsetPtr((P), 4)</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00174">174</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.
<p>
Referenced by <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l04013">UdfInitializeAllocationContext()</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l03278">UdfLookupEa()</a>, and <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00873">UdfSetThreadContext()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="udfprocs.h::Max" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define Max          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">a,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>b&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;((a) &gt; (b) ? (a) : (b))</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00062">62</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.
<p>
Referenced by <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l01003">UdfInitializeEnumeration()</a>, and <a class="el" href="../../d5/d7/dirsup_8c-source.html#l00360">UdfUpdateDirNames()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="udfprocs.h::Min" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define Min          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">a,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>b&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;((a) &lt; (b) ? (a) : (b))</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00061">61</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.
<p>
Referenced by <a class="el" href="../../d6/d4/namesup_8c-source.html#l00689">UdfConvertCS0DstringToUnicode()</a>, and <a class="el" href="../../d3/d5/allocsup_8c-source.html#l01406">UdfLoadSparingTables()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a11" doxytag="udfprocs.h::PtrOffset" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define PtrOffset          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">BASE,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OFFSET&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;((ULONG)((ULONG)(OFFSET) - (ULONG)(BASE)))</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00105">105</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a22" doxytag="udfprocs.h::QuadAlign" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define QuadAlign          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">B&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;GenericAlign((B), 8)</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00155">155</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a28" doxytag="udfprocs.h::QuadAlignPtr" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define QuadAlignPtr          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">P&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;GenericAlignPtr((P), 8)</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00169">169</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a25" doxytag="udfprocs.h::QuadOffset" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define QuadOffset          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">B&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;GenericOffset((B), 8)</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00162">162</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a31" doxytag="udfprocs.h::QuadOffsetPtr" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define QuadOffsetPtr          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">P&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;GenericOffsetPtr((P), 8)</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00176">176</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a33" doxytag="udfprocs.h::SectorAlign" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define SectorAlign          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">V,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>L&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>(                                                     \
    ((((ULONG)(<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>)) + (((V)-&gt;SectorSize) - 1)) &amp; ~(((V)-&gt;SectorSize) - 1))       \
)
</div></pre>
<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00196">196</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a32" doxytag="udfprocs.h::SectorAlignN" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define SectorAlignN          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">SECTORSIZE,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>L&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>(                                           \
    ((((ULONG)(<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>)) + ((SECTORSIZE) - 1)) &amp; ~((SECTORSIZE) - 1))                 \
)
</div></pre>
<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00192">192</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a43" doxytag="udfprocs.h::SectorOffset" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define SectorOffset          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">V,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>L&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>(                                                    \
    ((ULONG) (<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>)) &amp; (((V)-&gt;SectorSize) - 1)                                     \
)
</div></pre>
<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00232">232</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.
<p>
Referenced by <a class="el" href="../../d1/d7/creasect_8c-source.html#l01424">MiCreateImageFileMap()</a>, <a class="el" href="../../d8/d4/udfs_2read_8c-source.html#l00068">UdfCommonRead()</a>, <a class="el" href="../../d3/d5/allocsup_8c-source.html#l00069">UdfLookupAllocation()</a>, and <a class="el" href="../../d4/d6/deviosup_8c-source.html#l00883">UdfPrepareBuffers()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a41" doxytag="udfprocs.h::SectorsFromBlocks" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define SectorsFromBlocks          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">V,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>B&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;(B)</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00228">228</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.
<p>
Referenced by <a class="el" href="../../d3/d5/allocsup_8c-source.html#l01406">UdfLoadSparingTables()</a>, and <a class="el" href="../../d3/d5/allocsup_8c-source.html#l01017">UdfLookupPsnOfExtent()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a38" doxytag="udfprocs.h::SectorsFromBytes" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define SectorsFromBytes          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">V,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>L&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>(                                                \
    ((ULONG) (<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>)) &gt;&gt; ((V)-&gt;SectorShift)                                         \
)
</div></pre>
<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00216">216</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a42" doxytag="udfprocs.h::SectorSize" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define SectorSize          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">V&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;((V)-&gt;SectorSize)</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00230">230</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.
<p>
Referenced by <a class="el" href="../../d2/d5/fmtexp_8c-source.html#l00273">FmtFillFormatBuffer()</a>, <a class="el" href="../../d2/d5/fmtexp_8c-source.html#l00042">FmtIsFatPartition()</a>, <a class="el" href="../../d2/d5/fmtexp_8c-source.html#l00495">FmtVerifySectors()</a>, <a class="el" href="../../d9/d0/fdengine_8c-source.html#l00342">GetGeometry()</a>, <a class="el" href="../../d5/d7/udfs__rec_8c-source.html#l00157">IsUdfsVolume()</a>, <a class="el" href="../../d2/d5/low_8c-source.html#l00059">LowGetDriveGeometry()</a>, <a class="el" href="../../d2/d5/low_8c-source.html#l00076">LowGetPartitionGeometry()</a>, <a class="el" href="../../d2/d5/low_8c-source.html#l00212">LowReadSectors()</a>, <a class="el" href="../../d2/d5/low_8c-source.html#l00281">LowWriteSectors()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l02832">UdfFindVolumeDescriptors()</a>, <a class="el" href="../../d7/d5/vmcbsup_8c-source.html#l00219">UdfInitializeVmcb()</a>, <a class="el" href="../../d3/d5/allocsup_8c-source.html#l01406">UdfLoadSparingTables()</a>, <a class="el" href="../../d4/d6/deviosup_8c-source.html#l00883">UdfPrepareBuffers()</a>, <a class="el" href="../../d8/d5/volinfo_8c-source.html#l00302">UdfQueryFsSizeInfo()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00951">UdfRawBufferSizeN()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00961">UdfRawReadSizeN()</a>, <a class="el" href="../../d4/d6/deviosup_8c-source.html#l00685">UdfReadSectors()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l03457">UdfRecognizeVolume()</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l00477">UdfUpdateVcbPhase0()</a>, <a class="el" href="../../d8/d1/drivesup_8c-source.html#l00190">xHalExamineMBR()</a>, <a class="el" href="../../d8/d1/drivesup_8c-source.html#l03486">xHalIoClearPartitionTable()</a>, <a class="el" href="../../d8/d1/drivesup_8c-source.html#l01739">xHalIoReadPartitionTable()</a>, <a class="el" href="../../d8/d1/drivesup_8c-source.html#l02485">xHalIoSetPartitionInformation()</a>, <a class="el" href="../../d8/d1/drivesup_8c-source.html#l02879">xHalIoWritePartitionTable()</a>, and <a class="el" href="../../d9/d0/fdengine_8c-source.html#l02823">ZapSector()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a35" doxytag="udfprocs.h::SectorTruncate" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define SectorTruncate          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">V,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>L&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>(                                                  \
    ((ULONG)(<a class="code" href="../../d2/d0/aw_8h.html#a3">L</a>)) &amp; ~(((V)-&gt;SectorSize) - 1)                                     \
)
</div></pre>
<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00204">204</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.
<p>
Referenced by <a class="el" href="../../d4/d6/deviosup_8c-source.html#l00883">UdfPrepareBuffers()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a8" doxytag="udfprocs.h::SetFlag" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define SetFlag          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">Flags,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>SingleFlag&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>(     \
    (Flags) |= (SingleFlag)             \
)
</div></pre>
<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00080">80</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a58" doxytag="udfprocs.h::SwapCopyUchar2" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define SwapCopyUchar2          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">Dst,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>Src&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>{                                       \
    *((UNALIGNED <a class="code" href="../../d9/d2/union__UCHAR1.html">UCHAR1</a> *)(Dst)) = *((UNALIGNED <a class="code" href="../../d9/d2/union__UCHAR1.html">UCHAR1</a> *)(Src) + 1);    \
    *((UNALIGNED <a class="code" href="../../d9/d2/union__UCHAR1.html">UCHAR1</a> *)(Dst) + 1) = *((UNALIGNED <a class="code" href="../../d9/d2/union__UCHAR1.html">UCHAR1</a> *)(Src));    \
}
</div></pre>
<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00330">330</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.
<p>
Referenced by <a class="el" href="../../d6/d4/namesup_8c-source.html#l00689">UdfConvertCS0DstringToUnicode()</a>, and <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01239">UdfCS0DstringContainsLegalCharacters()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a60" doxytag="udfprocs.h::SwapCopyUchar4" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define SwapCopyUchar4          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">Dst,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>Src&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>{                                        \
    *((UNALIGNED <a class="code" href="../../d9/d2/union__UCHAR1.html">UCHAR1</a> *)(Dst)) = *((UNALIGNED <a class="code" href="../../d9/d2/union__UCHAR1.html">UCHAR1</a> *)(Src) + 3);     \
    *((UNALIGNED <a class="code" href="../../d9/d2/union__UCHAR1.html">UCHAR1</a> *)(Dst) + 1) = *((UNALIGNED <a class="code" href="../../d9/d2/union__UCHAR1.html">UCHAR1</a> *)(Src) + 2); \
    *((UNALIGNED <a class="code" href="../../d9/d2/union__UCHAR1.html">UCHAR1</a> *)(Dst) + 2) = *((UNALIGNED <a class="code" href="../../d9/d2/union__UCHAR1.html">UCHAR1</a> *)(Src) + 1); \
    *((UNALIGNED <a class="code" href="../../d9/d2/union__UCHAR1.html">UCHAR1</a> *)(Dst) + 3) = *((UNALIGNED <a class="code" href="../../d9/d2/union__UCHAR1.html">UCHAR1</a> *)(Src));     \
}
</div></pre>
<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00348">348</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.
<p>
Referenced by <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l03817">UdfDetermineVolumeBounding()</a>, and <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l04165">UdfUpdateVolumeSerialNumber()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a64" doxytag="udfprocs.h::try_leave" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define try_leave          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">S&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;{ S; leave; }</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00436">436</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.
<p>
Referenced by <a class="el" href="../../d7/d5/vmcbsup_8c-source.html#l00637">UdfAddVmcbMapping()</a>, <a class="el" href="../../d4/d7/udfs_2create_8c-source.html#l00108">UdfCommonCreate()</a>, <a class="el" href="../../d8/d4/udfs_2read_8c-source.html#l00068">UdfCommonRead()</a>, <a class="el" href="../../d5/d2/fileinfo_8c-source.html#l00385">UdfCommonSetInfo()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l03817">UdfDetermineVolumeBounding()</a>, <a class="el" href="../../d3/d4/lockctrl_8c-source.html#l00152">UdfFastLock()</a>, <a class="el" href="../../d3/d4/lockctrl_8c-source.html#l00436">UdfFastUnlockAll()</a>, <a class="el" href="../../d3/d4/lockctrl_8c-source.html#l00557">UdfFastUnlockAllByKey()</a>, <a class="el" href="../../d3/d4/lockctrl_8c-source.html#l00297">UdfFastUnlockSingle()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l02558">UdfFindFileSetDescriptor()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l02832">UdfFindVolumeDescriptors()</a>, <a class="el" href="../../d5/d7/dirsup_8c-source.html#l00916">UdfLookupDirEntryPostProcessing()</a>, <a class="el" href="../../d3/d5/allocsup_8c-source.html#l01177">UdfLookupMetaVsnOfExtent()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l01444">UdfMountVolume()</a>, <a class="el" href="../../d4/d6/deviosup_8c-source.html#l00201">UdfNonCachedRead()</a>, <a class="el" href="../../d4/d7/udfs_2create_8c-source.html#l01244">UdfOpenObjectByFileId()</a>, <a class="el" href="../../d5/d2/fileinfo_8c-source.html#l01232">UdfQueryAlternateNameInfo()</a>, <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l00334">UdfQueryDirectory()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l02043">UdfVerifyVolume()</a>, and <a class="el" href="../../d7/d5/vmcbsup_8c-source.html#l00461">UdfVmcbVbnToLbn()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a77" doxytag="udfprocs.h::UdfAcquireAllFiles" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define UdfAcquireAllFiles          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IC,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>V&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;UdfAcquireResource( (IC), &amp;(V)-&gt;FileResource, FALSE, AcquireExclusive )</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01524">1524</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d1/udfs_2cachesup_8c-source.html#l00417">UdfPurgeVolume()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a83" doxytag="udfprocs.h::UdfAcquireFcbExclusive" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define UdfAcquireFcbExclusive          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IC,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>F,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>I&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;UdfAcquireResource( (IC), &amp;(F)-&gt;FcbNonpaged-&gt;FcbResource, (I), AcquireExclusive )</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01542">1542</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d6/udfs_2cleanup_8c-source.html#l00042">UdfCommonCleanup()</a>, <a class="el" href="../../d3/d8/close_8c-source.html#l00498">UdfCommonClosePrivate()</a>, <a class="el" href="../../d4/d7/udfs_2create_8c-source.html#l00108">UdfCommonCreate()</a>, <a class="el" href="../../d6/d3/prefxsup_8c-source.html#l00324">UdfFindPrefix()</a>, <a class="el" href="../../d4/d7/udfs_2create_8c-source.html#l01244">UdfOpenObjectByFileId()</a>, <a class="el" href="../../d4/d7/udfs_2create_8c-source.html#l01632">UdfOpenObjectFromDirContext()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l00470">UdfOplockRequest()</a>, and <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l01606">UdfTeardownStructures()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a84" doxytag="udfprocs.h::UdfAcquireFcbShared" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define UdfAcquireFcbShared          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IC,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>F,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>I&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;UdfAcquireResource( (IC), &amp;(F)-&gt;FcbNonpaged-&gt;FcbResource, (I), AcquireShared )</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01545">1545</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.
<p>
Referenced by <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l00470">UdfOplockRequest()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a79" doxytag="udfprocs.h::UdfAcquireFileExclusive" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define UdfAcquireFileExclusive          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IC,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>F&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;UdfAcquireResource( (IC), (F)-&gt;<a class="el" href="../../d4/d0/tex_8c.html#a21">Resource</a>, FALSE, AcquireExclusive )</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01530">1530</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a80" doxytag="udfprocs.h::UdfAcquireFileShared" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define UdfAcquireFileShared          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IC,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>F&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;UdfAcquireResource( (IC), (F)-&gt;<a class="el" href="../../d4/d0/tex_8c.html#a21">Resource</a>, FALSE, AcquireShared )</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01533">1533</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.
<p>
Referenced by <a class="el" href="../../d5/d2/fileinfo_8c-source.html#l00156">UdfCommonQueryInfo()</a>, <a class="el" href="../../d8/d4/udfs_2read_8c-source.html#l00068">UdfCommonRead()</a>, <a class="el" href="../../d5/d2/fileinfo_8c-source.html#l00385">UdfCommonSetInfo()</a>, <a class="el" href="../../d5/d2/fileinfo_8c-source.html#l01232">UdfQueryAlternateNameInfo()</a>, and <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l00334">UdfQueryDirectory()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a81" doxytag="udfprocs.h::UdfAcquireFileSharedStarveExclusive" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define UdfAcquireFileSharedStarveExclusive          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IC,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>F&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;UdfAcquireResource( (IC), (F)-&gt;<a class="el" href="../../d4/d0/tex_8c.html#a21">Resource</a>, FALSE, AcquireSharedStarveExclusive )</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01536">1536</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.
<p>
Referenced by <a class="el" href="../../d8/d4/udfs_2read_8c-source.html#l00068">UdfCommonRead()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a72" doxytag="udfprocs.h::UdfAcquireUdfData" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define UdfAcquireUdfData          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IC&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;ExAcquireResourceExclusive( &amp;<a class="el" href="../../d1/d8/udfdata_8h.html#a51">UdfData</a>.DataResource, TRUE )</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01509">1509</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.
<p>
Referenced by <a class="el" href="../../d3/d8/close_8c-source.html#l00319">UdfCommonClose()</a>, <a class="el" href="../../d3/d8/close_8c-source.html#l00099">UdfFspClose()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l01271">UdfInvalidateVolumes()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l01444">UdfMountVolume()</a>, <a class="el" href="../../d9/d4/udfs_2verfysup_8c-source.html#l00042">UdfPerformVerify()</a>, <a class="el" href="../../d5/d8/udfs_2pnp_8c-source.html#l00194">UdfPnpQueryRemove()</a>, <a class="el" href="../../d5/d8/udfs_2pnp_8c-source.html#l00350">UdfPnpRemove()</a>, <a class="el" href="../../d5/d8/udfs_2pnp_8c-source.html#l00500">UdfPnpSurpriseRemove()</a>, and <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l02043">UdfVerifyVolume()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a74" doxytag="udfprocs.h::UdfAcquireVcbExclusive" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define UdfAcquireVcbExclusive          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IC,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>V,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>I&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;UdfAcquireResource( (IC), &amp;(V)-&gt;VcbResource, (I), AcquireExclusive )</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01515">1515</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d4/udfs_2verfysup_8c-source.html#l00236">UdfCheckForDismount()</a>, <a class="el" href="../../d9/d6/udfs_2cleanup_8c-source.html#l00042">UdfCommonCleanup()</a>, <a class="el" href="../../d4/d7/udfs_2create_8c-source.html#l00108">UdfCommonCreate()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l00966">UdfDismountVolume()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l00780">UdfLockVolume()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l00621">UdfLockVolumeInternal()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l01444">UdfMountVolume()</a>, <a class="el" href="../../d5/d8/udfs_2pnp_8c-source.html#l00632">UdfPnpCancelRemove()</a>, <a class="el" href="../../d5/d8/udfs_2pnp_8c-source.html#l00194">UdfPnpQueryRemove()</a>, <a class="el" href="../../d5/d8/udfs_2pnp_8c-source.html#l00350">UdfPnpRemove()</a>, <a class="el" href="../../d5/d8/udfs_2pnp_8c-source.html#l00500">UdfPnpSurpriseRemove()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l00877">UdfUnlockVolume()</a>, and <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l02043">UdfVerifyVolume()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a75" doxytag="udfprocs.h::UdfAcquireVcbShared" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define UdfAcquireVcbShared          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IC,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>V,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>I&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;UdfAcquireResource( (IC), &amp;(V)-&gt;VcbResource, (I), AcquireShared )</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01518">1518</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.
<p>
Referenced by <a class="el" href="../../d3/d8/close_8c-source.html#l00498">UdfCommonClosePrivate()</a>, <a class="el" href="../../d4/d7/udfs_2create_8c-source.html#l00108">UdfCommonCreate()</a>, <a class="el" href="../../d8/d5/volinfo_8c-source.html#l00082">UdfCommonQueryVolInfo()</a>, <a class="el" href="../../d3/d8/close_8c-source.html#l00099">UdfFspClose()</a>, and <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l00904">UdfNotifyChangeDirectory()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a94" doxytag="udfprocs.h::UdfAllocateIoContext" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define UdfAllocateIoContext          </td>
          <td class="md" valign="top">(&nbsp;</td>
&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div><a class="code" href="../../d1/d8/fsrtl_8h.html#a37">FsRtlAllocatePoolWithTag</a>( UdfNonPagedPool,           \
                              <span class="keyword">sizeof</span>( <a class="code" href="../../d3/d3/struct__UDF__IO__CONTEXT.html">UDF_IO_CONTEXT</a> ),  \
                              TAG_IO_CONTEXT )
</div></pre>
<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01701">1701</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.
<p>
Referenced by <a class="el" href="../../d8/d4/udfs_2read_8c-source.html#l00068">UdfCommonRead()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a92" doxytag="udfprocs.h::UdfCreateIrpContextLite" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define UdfCreateIrpContextLite          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IC&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;ExAllocatePoolWithTag( UdfNonPagedPool, sizeof( <a class="el" href="../../d2/d3/struct__IRP__CONTEXT__LITE.html">IRP_CONTEXT_LITE</a> ), TAG_IRP_CONTEXT_LITE )</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01684">1684</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.
<p>
Referenced by <a class="el" href="../../d3/d8/close_8c-source.html#l00634">UdfQueueClose()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a97" doxytag="udfprocs.h::UdfDecrementCleanupCounts" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define UdfDecrementCleanupCounts          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IC,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>F&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>{        \
    <a class="code" href="../../d1/d8/udfdata_8h.html#a47">ASSERT_LOCKED_VCB</a>( (F)-&gt;Vcb );              \
    (F)-&gt;FcbCleanup -= 1;                       \
    (F)-&gt;Vcb-&gt;VcbCleanup -= 1;                  \
}
</div></pre>
<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01756">1756</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d6/udfs_2cleanup_8c-source.html#l00042">UdfCommonCleanup()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a99" doxytag="udfprocs.h::UdfDecrementReferenceCounts" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define UdfDecrementReferenceCounts          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IC,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>F,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>C,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>UC&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>{ \
    <a class="code" href="../../d1/d8/udfdata_8h.html#a47">ASSERT_LOCKED_VCB</a>( (F)-&gt;Vcb );              \
    (F)-&gt;FcbReference -= (C);                   \
    (F)-&gt;FcbUserReference -= (UC);              \
    (F)-&gt;Vcb-&gt;VcbReference -= (C);              \
    (F)-&gt;Vcb-&gt;VcbUserReference -= (UC);         \
}
</div></pre>
<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01770">1770</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.
<p>
Referenced by <a class="el" href="../../d3/d8/close_8c-source.html#l00498">UdfCommonClosePrivate()</a>, <a class="el" href="../../d9/d1/udfs_2cachesup_8c-source.html#l00046">UdfCreateInternalStream()</a>, and <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l01606">UdfTeardownStructures()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a95" doxytag="udfprocs.h::UdfFreeIoContext" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define UdfFreeIoContext          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IO&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;ExFreePool( IO )</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01706">1706</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.
<p>
Referenced by <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l01437">UdfCleanupIrpContext()</a>, <a class="el" href="../../d4/d6/deviosup_8c-source.html#l01863">UdfMultiAsyncCompletionRoutine()</a>, and <a class="el" href="../../d4/d6/deviosup_8c-source.html#l02039">UdfSingleAsyncCompletionRoutine()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a93" doxytag="udfprocs.h::UdfFreeIrpContextLite" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define UdfFreeIrpContextLite          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">ICL&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;ExFreePool( ICL )</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01687">1687</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.
<p>
Referenced by <a class="el" href="../../d3/d8/close_8c-source.html#l00099">UdfFspClose()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a96" doxytag="udfprocs.h::UdfIncrementCleanupCounts" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define UdfIncrementCleanupCounts          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IC,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>F&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>{        \
    <a class="code" href="../../d1/d8/udfdata_8h.html#a47">ASSERT_LOCKED_VCB</a>( (F)-&gt;Vcb );              \
    (F)-&gt;FcbCleanup += 1;                       \
    (F)-&gt;Vcb-&gt;VcbCleanup += 1;                  \
}
</div></pre>
<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01750">1750</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.
<p>
Referenced by <a class="el" href="../../d4/d7/udfs_2create_8c-source.html#l01955">UdfCompleteFcbOpen()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a98" doxytag="udfprocs.h::UdfIncrementReferenceCounts" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define UdfIncrementReferenceCounts          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IC,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>F,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>C,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>UC&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>{ \
    <a class="code" href="../../d1/d8/udfdata_8h.html#a47">ASSERT_LOCKED_VCB</a>( (F)-&gt;Vcb );              \
    (F)-&gt;FcbReference += (C);                   \
    (F)-&gt;FcbUserReference += (UC);              \
    (F)-&gt;Vcb-&gt;VcbReference += (C);              \
    (F)-&gt;Vcb-&gt;VcbUserReference += (UC);         \
}
</div></pre>
<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01762">1762</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.
<p>
Referenced by <a class="el" href="../../d4/d7/udfs_2create_8c-source.html#l01955">UdfCompleteFcbOpen()</a>, <a class="el" href="../../d9/d1/udfs_2cachesup_8c-source.html#l00046">UdfCreateInternalStream()</a>, <a class="el" href="../../d4/d7/udfs_2create_8c-source.html#l01632">UdfOpenObjectFromDirContext()</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l00477">UdfUpdateVcbPhase0()</a>, and <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l00997">UdfUpdateVcbPhase1()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a63" doxytag="udfprocs.h::UdfIsFastIoPossible" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define UdfIsFastIoPossible          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">F&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>((BOOLEAN)                                           \
    ((((F)-&gt;Vcb-&gt;VcbCondition != <a class="code" href="../../d6/d8/udfstruc_8h.html#a130a119">VcbMounted</a> ) ||                                    \
      !<a class="code" href="../../d5/d2/oplock_8c.html#a60">FsRtlOplockIsFastIoPossible</a>( &amp;(F)-&gt;Oplock )) ?                               \
                                                                                    \
     <a class="code" href="../../d1/d8/fsrtl_8h.html#a188a86">FastIoIsNotPossible</a> :                                                          \
                                                                                    \
     ((((F)-&gt;FileLock != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; <a class="code" href="../../d1/d8/fsrtl_8h.html#a19">FsRtlAreThereCurrentFileLocks</a>( (F)-&gt;FileLock )) ? \
                                                                                    \
        <a class="code" href="../../d1/d8/fsrtl_8h.html#a188a88">FastIoIsQuestionable</a> :                                                      \
                                                                                    \
        <a class="code" href="../../d1/d8/fsrtl_8h.html#a188a87">FastIoIsPossible</a>))                                                          \
)
</div></pre>
<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00385">385</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d6/udfs_2cleanup_8c-source.html#l00042">UdfCommonCleanup()</a>, <a class="el" href="../../d3/d4/lockctrl_8c-source.html#l00046">UdfCommonLockControl()</a>, <a class="el" href="../../d4/d7/udfs_2create_8c-source.html#l01955">UdfCompleteFcbOpen()</a>, <a class="el" href="../../d3/d4/lockctrl_8c-source.html#l00152">UdfFastLock()</a>, <a class="el" href="../../d3/d4/lockctrl_8c-source.html#l00436">UdfFastUnlockAll()</a>, <a class="el" href="../../d3/d4/lockctrl_8c-source.html#l00557">UdfFastUnlockAllByKey()</a>, <a class="el" href="../../d3/d4/lockctrl_8c-source.html#l00297">UdfFastUnlockSingle()</a>, and <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l00470">UdfOplockRequest()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a100" doxytag="udfprocs.h::UdfIsRawDevice" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define UdfIsRawDevice          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IC,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>S&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>(           \
    ((S) == STATUS_DEVICE_NOT_READY) ||  \
    ((S) == STATUS_NO_MEDIA_IN_DEVICE)   \
)
</div></pre>
<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l02115">2115</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.
<p>
Referenced by <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l03457">UdfRecognizeVolume()</a>, and <a class="el" href="../../d9/d4/udfs_2verfysup_8c-source.html#l00603">UdfVerifyVcb()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a90" doxytag="udfprocs.h::UdfLockFcb" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define UdfLockFcb          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IC,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>F&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>{                                                              \
    PVOID _CurrentThread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();                                        \
    <span class="keywordflow">if</span> (_CurrentThread != (F)-&gt;FcbLockThread) {                                         \
        ExAcquireFastMutex( &amp;(F)-&gt;FcbNonpaged-&gt;FcbMutex );                              \
        <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( (F)-&gt;FcbLockCount == 0 );                                               \
        (F)-&gt;FcbLockThread = _CurrentThread;                                            \
    }                                                                                   \
    (F)-&gt;FcbLockCount += 1;                                                             \
}
</div></pre>
<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01567">1567</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d6/udfs_2cleanup_8c-source.html#l00042">UdfCommonCleanup()</a>, <a class="el" href="../../d3/d4/lockctrl_8c-source.html#l00046">UdfCommonLockControl()</a>, <a class="el" href="../../d5/d2/fileinfo_8c-source.html#l00385">UdfCommonSetInfo()</a>, <a class="el" href="../../d4/d7/udfs_2create_8c-source.html#l01955">UdfCompleteFcbOpen()</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l03713">UdfCreateFileLock()</a>, <a class="el" href="../../d9/d1/udfs_2cachesup_8c-source.html#l00046">UdfCreateInternalStream()</a>, <a class="el" href="../../d9/d1/udfs_2cachesup_8c-source.html#l00215">UdfDeleteInternalStream()</a>, <a class="el" href="../../d3/d4/lockctrl_8c-source.html#l00152">UdfFastLock()</a>, <a class="el" href="../../d3/d4/lockctrl_8c-source.html#l00436">UdfFastUnlockAll()</a>, <a class="el" href="../../d3/d4/lockctrl_8c-source.html#l00557">UdfFastUnlockAllByKey()</a>, <a class="el" href="../../d3/d4/lockctrl_8c-source.html#l00297">UdfFastUnlockSingle()</a>, <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l01003">UdfInitializeEnumeration()</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l02297">UdfInitializeFcbFromIcbContext()</a>, <a class="el" href="../../d3/d5/allocsup_8c-source.html#l01177">UdfLookupMetaVsnOfExtent()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l00470">UdfOplockRequest()</a>, <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l00334">UdfQueryDirectory()</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l00477">UdfUpdateVcbPhase0()</a>, and <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l00997">UdfUpdateVcbPhase1()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a86" doxytag="udfprocs.h::UdfLockUdfData" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define UdfLockUdfData          </td>
          <td class="md" valign="top">(&nbsp;</td>
&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>ExAcquireFastMutex( &amp;<a class="code" href="../../d0/d8/udfdata_8c.html#a2">UdfData</a>.<a class="code" href="../../d2/d3/struct__UDF__DATA.html#o18">UdfDataMutex</a> );                                        \
    <a class="code" href="../../d0/d8/udfdata_8c.html#a2">UdfData</a>.<a class="code" href="../../d2/d3/struct__UDF__DATA.html#o17">UdfDataLockThread</a> = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()
</div></pre>
<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01551">1551</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.
<p>
Referenced by <a class="el" href="../../d3/d8/close_8c-source.html#l00634">UdfQueueClose()</a>, and <a class="el" href="../../d3/d8/close_8c-source.html#l00833">UdfRemoveClose()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a71" doxytag="udfprocs.h::UdfLockUserBuffer" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define UdfLockUserBuffer          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IC,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>BL&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>{                   \
    <span class="keywordflow">if</span> ((IC)-&gt;Irp-&gt;MdlAddress == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {             \
        (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d3/d7/deviosup_8c.html#a15">UdfCreateUserMdl</a>( (IC), (BL), TRUE ); \
    }                                                \
}
</div></pre>
<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00911">911</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.
<p>
Referenced by <a class="el" href="../../d3/d8/workque_8c-source.html#l00111">UdfPrePostIrp()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a88" doxytag="udfprocs.h::UdfLockVcb" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define UdfLockVcb          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IC,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>V&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>ExAcquireFastMutex( &amp;(V)-&gt;VcbMutex );                                               \
    (V)-&gt;VcbLockThread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>()
</div></pre>
<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01559">1559</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d4/udfs_2verfysup_8c-source.html#l00236">UdfCheckForDismount()</a>, <a class="el" href="../../d9/d6/udfs_2cleanup_8c-source.html#l00042">UdfCommonCleanup()</a>, <a class="el" href="../../d3/d8/close_8c-source.html#l00498">UdfCommonClosePrivate()</a>, <a class="el" href="../../d4/d7/udfs_2create_8c-source.html#l01955">UdfCompleteFcbOpen()</a>, <a class="el" href="../../d9/d1/udfs_2cachesup_8c-source.html#l00046">UdfCreateInternalStream()</a>, <a class="el" href="../../d9/d4/udfs_2verfysup_8c-source.html#l00365">UdfDismountVcb()</a>, <a class="el" href="../../d6/d3/prefxsup_8c-source.html#l00324">UdfFindPrefix()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l01271">UdfInvalidateVolumes()</a>, <a class="el" href="../../d4/d7/udfs_2create_8c-source.html#l01244">UdfOpenObjectByFileId()</a>, <a class="el" href="../../d4/d7/udfs_2create_8c-source.html#l01632">UdfOpenObjectFromDirContext()</a>, <a class="el" href="../../d5/d8/udfs_2pnp_8c-source.html#l00350">UdfPnpRemove()</a>, <a class="el" href="../../d5/d8/udfs_2pnp_8c-source.html#l00500">UdfPnpSurpriseRemove()</a>, <a class="el" href="../../d9/d1/udfs_2cachesup_8c-source.html#l00417">UdfPurgeVolume()</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l01606">UdfTeardownStructures()</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l00477">UdfUpdateVcbPhase0()</a>, and <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l00997">UdfUpdateVcbPhase1()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a70" doxytag="udfprocs.h::UdfMapUserBuffer" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define UdfMapUserBuffer          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IC,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>UB&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>{                                                   \
            *(UB) = ((PVOID) (((IC)-&gt;Irp-&gt;MdlAddress == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ?                     \
                             (IC)-&gt;Irp-&gt;UserBuffer :                                \
                             <a class="code" href="../../d2/d1/mm_8h.html#a25">MmGetSystemAddressForMdlSafe</a>( (IC)-&gt;<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o2">MdlAddress</a>, NormalPagePriority )));   \
            <span class="keywordflow">if</span> (<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> == *(UB))  {                                                    \
                <a class="code" href="../../d3/d8/udfprocs_8h.html#a122">UdfRaiseStatus</a>( IrpContext, STATUS_INSUFFICIENT_RESOURCES);         \
            }                                                                       \
        }
</div></pre>
<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00902">902</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.
<p>
Referenced by <a class="el" href="../../d8/d4/udfs_2read_8c-source.html#l00068">UdfCommonRead()</a>, <a class="el" href="../../d4/d6/deviosup_8c-source.html#l00201">UdfNonCachedRead()</a>, and <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l00334">UdfQueryDirectory()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a66" doxytag="udfprocs.h::UdfNonPagedPool" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define UdfNonPagedPool&nbsp;&nbsp;&nbsp;NonPagedPool          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00444">444</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.
<p>
Referenced by <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l03307">UdfFindAnchorVolumeDescriptor()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l02558">UdfFindFileSetDescriptor()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l02832">UdfFindVolumeDescriptors()</a>, <a class="el" href="../../d4/d6/deviosup_8c-source.html#l00883">UdfPrepareBuffers()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l03457">UdfRecognizeVolume()</a>, and <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l00235">UdfStoreVolumeDescriptorIfPrevailing()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a67" doxytag="udfprocs.h::UdfNonPagedPoolCacheAligned" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define UdfNonPagedPoolCacheAligned&nbsp;&nbsp;&nbsp;NonPagedPoolCacheAligned          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00445">445</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a65" doxytag="udfprocs.h::UdfPagedPool" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define UdfPagedPool&nbsp;&nbsp;&nbsp;PagedPool          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00443">443</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.
<p>
Referenced by <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l04411">UdfAllocateTable()</a>, <a class="el" href="../../d3/d5/allocsup_8c-source.html#l01357">UdfCreatePcb()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l03817">UdfDetermineVolumeBounding()</a>, <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l01500">UdfEnumerateIndex()</a>, <a class="el" href="../../d5/d7/dirsup_8c-source.html#l00726">UdfFindDirEntry()</a>, <a class="el" href="../../d1/d7/udfdata_8c-source.html#l01083">UdfInitializeCrc16()</a>, <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l01003">UdfInitializeEnumeration()</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l00181">UdfInitializeFcbMcb()</a>, <a class="el" href="../../d6/d3/prefxsup_8c-source.html#l00064">UdfInsertPrefix()</a>, <a class="el" href="../../d5/d7/dirsup_8c-source.html#l00916">UdfLookupDirEntryPostProcessing()</a>, <a class="el" href="../../d4/d7/udfs_2create_8c-source.html#l00809">UdfNormalizeFileNames()</a>, <a class="el" href="../../d5/d7/dirsup_8c-source.html#l00360">UdfUpdateDirNames()</a>, and <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l00477">UdfUpdateVcbPhase0()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a78" doxytag="udfprocs.h::UdfReleaseAllFiles" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define UdfReleaseAllFiles          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IC,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>V&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;ExReleaseResource( &amp;(V)-&gt;FileResource )</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01527">1527</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d1/udfs_2cachesup_8c-source.html#l00417">UdfPurgeVolume()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a85" doxytag="udfprocs.h::UdfReleaseFcb" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define UdfReleaseFcb          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IC,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>F&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;ExReleaseResource( &amp;(F)-&gt;FcbNonpaged-&gt;FcbResource )</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01548">1548</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d6/udfs_2cleanup_8c-source.html#l00042">UdfCommonCleanup()</a>, <a class="el" href="../../d3/d8/close_8c-source.html#l00498">UdfCommonClosePrivate()</a>, <a class="el" href="../../d4/d7/udfs_2create_8c-source.html#l00108">UdfCommonCreate()</a>, <a class="el" href="../../d6/d3/prefxsup_8c-source.html#l00324">UdfFindPrefix()</a>, <a class="el" href="../../d4/d7/udfs_2create_8c-source.html#l01632">UdfOpenObjectFromDirContext()</a>, <a class="el" href="../../d3/d8/workque_8c-source.html#l00222">UdfOplockComplete()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l00470">UdfOplockRequest()</a>, <a class="el" href="../../d3/d8/workque_8c-source.html#l00111">UdfPrePostIrp()</a>, and <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l01606">UdfTeardownStructures()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a82" doxytag="udfprocs.h::UdfReleaseFile" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define UdfReleaseFile          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IC,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>F&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;ExReleaseResource( (F)-&gt;<a class="el" href="../../d4/d0/tex_8c.html#a21">Resource</a> )</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01539">1539</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.
<p>
Referenced by <a class="el" href="../../d5/d2/fileinfo_8c-source.html#l00156">UdfCommonQueryInfo()</a>, <a class="el" href="../../d8/d4/udfs_2read_8c-source.html#l00068">UdfCommonRead()</a>, <a class="el" href="../../d5/d2/fileinfo_8c-source.html#l00385">UdfCommonSetInfo()</a>, <a class="el" href="../../d5/d2/fileinfo_8c-source.html#l01232">UdfQueryAlternateNameInfo()</a>, and <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l00334">UdfQueryDirectory()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a73" doxytag="udfprocs.h::UdfReleaseUdfData" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define UdfReleaseUdfData          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IC&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;ExReleaseResource( &amp;<a class="el" href="../../d1/d8/udfdata_8h.html#a51">UdfData</a>.DataResource )</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01512">1512</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.
<p>
Referenced by <a class="el" href="../../d3/d8/close_8c-source.html#l00319">UdfCommonClose()</a>, <a class="el" href="../../d3/d8/close_8c-source.html#l00099">UdfFspClose()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l01271">UdfInvalidateVolumes()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l01444">UdfMountVolume()</a>, <a class="el" href="../../d9/d4/udfs_2verfysup_8c-source.html#l00042">UdfPerformVerify()</a>, <a class="el" href="../../d5/d8/udfs_2pnp_8c-source.html#l00194">UdfPnpQueryRemove()</a>, <a class="el" href="../../d5/d8/udfs_2pnp_8c-source.html#l00350">UdfPnpRemove()</a>, <a class="el" href="../../d5/d8/udfs_2pnp_8c-source.html#l00500">UdfPnpSurpriseRemove()</a>, and <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l02043">UdfVerifyVolume()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a76" doxytag="udfprocs.h::UdfReleaseVcb" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define UdfReleaseVcb          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IC,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>V&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;ExReleaseResource( &amp;(V)-&gt;VcbResource )</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01521">1521</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d4/udfs_2verfysup_8c-source.html#l00236">UdfCheckForDismount()</a>, <a class="el" href="../../d9/d6/udfs_2cleanup_8c-source.html#l00042">UdfCommonCleanup()</a>, <a class="el" href="../../d3/d8/close_8c-source.html#l00498">UdfCommonClosePrivate()</a>, <a class="el" href="../../d4/d7/udfs_2create_8c-source.html#l00108">UdfCommonCreate()</a>, <a class="el" href="../../d8/d5/volinfo_8c-source.html#l00082">UdfCommonQueryVolInfo()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l00966">UdfDismountVolume()</a>, <a class="el" href="../../d3/d8/close_8c-source.html#l00099">UdfFspClose()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l00780">UdfLockVolume()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l00621">UdfLockVolumeInternal()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l01444">UdfMountVolume()</a>, <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l00904">UdfNotifyChangeDirectory()</a>, <a class="el" href="../../d5/d8/udfs_2pnp_8c-source.html#l00632">UdfPnpCancelRemove()</a>, <a class="el" href="../../d5/d8/udfs_2pnp_8c-source.html#l00194">UdfPnpQueryRemove()</a>, <a class="el" href="../../d5/d8/udfs_2pnp_8c-source.html#l00350">UdfPnpRemove()</a>, <a class="el" href="../../d5/d8/udfs_2pnp_8c-source.html#l00500">UdfPnpSurpriseRemove()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l00877">UdfUnlockVolume()</a>, and <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l02043">UdfVerifyVolume()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a91" doxytag="udfprocs.h::UdfUnlockFcb" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define UdfUnlockFcb          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IC,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>F&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>{                                                            \
    (F)-&gt;FcbLockCount -= 1;                                                             \
    <span class="keywordflow">if</span> ((F)-&gt;FcbLockCount == 0) {                                                       \
        (F)-&gt;FcbLockThread = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;                                                      \
        ExReleaseFastMutex( &amp;(F)-&gt;FcbNonpaged-&gt;FcbMutex );                              \
    }                                                                                   \
}
</div></pre>
<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01577">1577</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d6/udfs_2cleanup_8c-source.html#l00042">UdfCommonCleanup()</a>, <a class="el" href="../../d3/d4/lockctrl_8c-source.html#l00046">UdfCommonLockControl()</a>, <a class="el" href="../../d5/d2/fileinfo_8c-source.html#l00385">UdfCommonSetInfo()</a>, <a class="el" href="../../d4/d7/udfs_2create_8c-source.html#l01955">UdfCompleteFcbOpen()</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l03713">UdfCreateFileLock()</a>, <a class="el" href="../../d9/d1/udfs_2cachesup_8c-source.html#l00046">UdfCreateInternalStream()</a>, <a class="el" href="../../d9/d1/udfs_2cachesup_8c-source.html#l00215">UdfDeleteInternalStream()</a>, <a class="el" href="../../d3/d4/lockctrl_8c-source.html#l00152">UdfFastLock()</a>, <a class="el" href="../../d3/d4/lockctrl_8c-source.html#l00436">UdfFastUnlockAll()</a>, <a class="el" href="../../d3/d4/lockctrl_8c-source.html#l00557">UdfFastUnlockAllByKey()</a>, <a class="el" href="../../d3/d4/lockctrl_8c-source.html#l00297">UdfFastUnlockSingle()</a>, <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l01003">UdfInitializeEnumeration()</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l02297">UdfInitializeFcbFromIcbContext()</a>, <a class="el" href="../../d3/d5/allocsup_8c-source.html#l01177">UdfLookupMetaVsnOfExtent()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l00470">UdfOplockRequest()</a>, <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l00334">UdfQueryDirectory()</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l00477">UdfUpdateVcbPhase0()</a>, and <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l00997">UdfUpdateVcbPhase1()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a87" doxytag="udfprocs.h::UdfUnlockUdfData" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define UdfUnlockUdfData          </td>
          <td class="md" valign="top">(&nbsp;</td>
&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div><a class="code" href="../../d0/d8/udfdata_8c.html#a2">UdfData</a>.<a class="code" href="../../d2/d3/struct__UDF__DATA.html#o17">UdfDataLockThread</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;                                                   \
    ExReleaseFastMutex( &amp;<a class="code" href="../../d0/d8/udfdata_8c.html#a2">UdfData</a>.<a class="code" href="../../d2/d3/struct__UDF__DATA.html#o18">UdfDataMutex</a> )
</div></pre>
<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01555">1555</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.
<p>
Referenced by <a class="el" href="../../d3/d8/close_8c-source.html#l00634">UdfQueueClose()</a>, and <a class="el" href="../../d3/d8/close_8c-source.html#l00833">UdfRemoveClose()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a89" doxytag="udfprocs.h::UdfUnlockVcb" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define UdfUnlockVcb          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IC,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>V&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<b>Value:</b><pre class="fragment"><div>(V)-&gt;VcbLockThread = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;                                                          \
    ExReleaseFastMutex( &amp;(V)-&gt;VcbMutex )
</div></pre>
<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01563">1563</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.
<p>
Referenced by <a class="el" href="../../d9/d4/udfs_2verfysup_8c-source.html#l00236">UdfCheckForDismount()</a>, <a class="el" href="../../d9/d6/udfs_2cleanup_8c-source.html#l00042">UdfCommonCleanup()</a>, <a class="el" href="../../d3/d8/close_8c-source.html#l00498">UdfCommonClosePrivate()</a>, <a class="el" href="../../d4/d7/udfs_2create_8c-source.html#l01955">UdfCompleteFcbOpen()</a>, <a class="el" href="../../d9/d1/udfs_2cachesup_8c-source.html#l00046">UdfCreateInternalStream()</a>, <a class="el" href="../../d9/d4/udfs_2verfysup_8c-source.html#l00365">UdfDismountVcb()</a>, <a class="el" href="../../d6/d3/prefxsup_8c-source.html#l00324">UdfFindPrefix()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l01271">UdfInvalidateVolumes()</a>, <a class="el" href="../../d4/d7/udfs_2create_8c-source.html#l01244">UdfOpenObjectByFileId()</a>, <a class="el" href="../../d4/d7/udfs_2create_8c-source.html#l01632">UdfOpenObjectFromDirContext()</a>, <a class="el" href="../../d5/d8/udfs_2pnp_8c-source.html#l00350">UdfPnpRemove()</a>, <a class="el" href="../../d5/d8/udfs_2pnp_8c-source.html#l00500">UdfPnpSurpriseRemove()</a>, <a class="el" href="../../d9/d1/udfs_2cachesup_8c-source.html#l00417">UdfPurgeVolume()</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l01606">UdfTeardownStructures()</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l00477">UdfUpdateVcbPhase0()</a>, and <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l00997">UdfUpdateVcbPhase1()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a69" doxytag="udfprocs.h::UdfUnpinData" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define UdfUnpinData          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IC,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>B&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;if (*(B) != NULL) { CcUnpinData( *(B) ); *(B) = NULL; }</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00838">838</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.
<p>
Referenced by <a class="el" href="../../d5/d7/dirsup_8c-source.html#l00099">UdfCleanupDirContext()</a>, <a class="el" href="../../d5/d7/dirsup_8c-source.html#l00916">UdfLookupDirEntryPostProcessing()</a>, <a class="el" href="../../d5/d7/dirsup_8c-source.html#l00165">UdfLookupInitialDirEntry()</a>, <a class="el" href="../../d3/d5/allocsup_8c-source.html#l01017">UdfLookupPsnOfExtent()</a>, and <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l00477">UdfUpdateVcbPhase0()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a68" doxytag="udfprocs.h::UdfUnpinView" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define UdfUnpinView          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IC,         <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>V&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;if (((V)-&gt;Bcb) != NULL) { CcUnpinData( ((V)-&gt;Bcb) ); ((V)-&gt;Bcb) = NULL; ((V)-&gt;View) = NULL; }</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00828">828</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.
<p>
Referenced by <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l03183">UdfCleanupIcbContext()</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l03124">UdfLookupActiveIcb()</a>, and <a class="el" href="../../d9/d1/udfs_2cachesup_8c-source.html#l00337">UdfMapMetadataView()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a20" doxytag="udfprocs.h::WordAlign" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define WordAlign          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">B&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;GenericAlign((B), 2)</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00151">151</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a26" doxytag="udfprocs.h::WordAlignPtr" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define WordAlignPtr          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">P&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;GenericAlignPtr((P), 2)</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00165">165</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a23" doxytag="udfprocs.h::WordOffset" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define WordOffset          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">B&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;GenericOffset((B), 2)</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00158">158</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a29" doxytag="udfprocs.h::WordOffsetPtr" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define WordOffsetPtr          </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">P&nbsp;</td>
          <td class="mdname1" valign="top" nowrap>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap>&nbsp;&nbsp;&nbsp;GenericOffsetPtr((P), 2)</td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00172">172</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.    </td>
  </tr>
</table>
<hr><h2>Typedef Documentation</h2>
<a class="anchor" name="a112" doxytag="udfprocs.h::PTYPE_OF_ACQUIRE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef enum <a class="el" href="../../d3/d8/udfprocs_8h.html#a264">_TYPE_OF_ACQUIRE</a> * <a class="el" href="../../d3/d8/udfprocs_8h.html#a112">PTYPE_OF_ACQUIRE</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a110" doxytag="udfprocs.h::PTYPE_OF_OPEN" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef enum <a class="el" href="../../d3/d8/udfprocs_8h.html#a263">_TYPE_OF_OPEN</a> * <a class="el" href="../../d3/d8/udfprocs_8h.html#a110">PTYPE_OF_OPEN</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a102" doxytag="udfprocs.h::PUCHAR1" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef union <a class="el" href="../../d9/d2/union__UCHAR1.html">_UCHAR1</a> * <a class="el" href="../../d9/d2/union__UCHAR1.html">PUCHAR1</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a104" doxytag="udfprocs.h::PUCHAR2" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef union <a class="el" href="../../d0/d3/union__UCHAR2.html">_UCHAR2</a> * <a class="el" href="../../d0/d3/union__UCHAR2.html">PUCHAR2</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a106" doxytag="udfprocs.h::PUCHAR4" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef union <a class="el" href="../../d1/d3/union__UCHAR4.html">_UCHAR4</a> * <a class="el" href="../../d1/d3/union__UCHAR4.html">PUCHAR4</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a108" doxytag="udfprocs.h::PUSHORT2" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef union <a class="el" href="../../d7/d4/union__USHORT2.html">_USHORT2</a> * <a class="el" href="../../d7/d4/union__USHORT2.html">PUSHORT2</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a111" doxytag="udfprocs.h::TYPE_OF_ACQUIRE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef enum <a class="el" href="../../d3/d8/udfprocs_8h.html#a264">_TYPE_OF_ACQUIRE</a>  <a class="el" href="../../d3/d8/udfprocs_8h.html#a111">TYPE_OF_ACQUIRE</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d5/d8/resrcsup_8c-source.html#l00047">UdfAcquireResource()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a109" doxytag="udfprocs.h::TYPE_OF_OPEN" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef enum <a class="el" href="../../d3/d8/udfprocs_8h.html#a263">_TYPE_OF_OPEN</a>  <a class="el" href="../../d3/d8/udfprocs_8h.html#a109">TYPE_OF_OPEN</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d9/d6/udfs_2cleanup_8c-source.html#l00042">UdfCommonCleanup()</a>, <a class="el" href="../../d3/d8/close_8c-source.html#l00319">UdfCommonClose()</a>, <a class="el" href="../../d4/d7/udfs_2create_8c-source.html#l00108">UdfCommonCreate()</a>, <a class="el" href="../../d3/d6/udfs_2devctrl_8c-source.html#l00069">UdfCommonDevControl()</a>, <a class="el" href="../../d3/d4/lockctrl_8c-source.html#l00046">UdfCommonLockControl()</a>, <a class="el" href="../../d5/d2/fileinfo_8c-source.html#l00156">UdfCommonQueryInfo()</a>, <a class="el" href="../../d8/d5/volinfo_8c-source.html#l00082">UdfCommonQueryVolInfo()</a>, <a class="el" href="../../d8/d4/udfs_2read_8c-source.html#l00068">UdfCommonRead()</a>, <a class="el" href="../../d5/d2/fileinfo_8c-source.html#l00385">UdfCommonSetInfo()</a>, <a class="el" href="../../d7/d2/filobsup_8c-source.html#l00133">UdfDecodeFileObject()</a>, <a class="el" href="../../d7/d2/filobsup_8c-source.html#l00201">UdfFastDecodeFileObject()</a>, <a class="el" href="../../d3/d4/lockctrl_8c-source.html#l00152">UdfFastLock()</a>, <a class="el" href="../../d5/d2/fileinfo_8c-source.html#l00496">UdfFastQueryBasicInfo()</a>, <a class="el" href="../../d5/d2/fileinfo_8c-source.html#l00740">UdfFastQueryNetworkInfo()</a>, <a class="el" href="../../d5/d2/fileinfo_8c-source.html#l00614">UdfFastQueryStdInfo()</a>, <a class="el" href="../../d3/d4/lockctrl_8c-source.html#l00436">UdfFastUnlockAll()</a>, <a class="el" href="../../d3/d4/lockctrl_8c-source.html#l00557">UdfFastUnlockAllByKey()</a>, <a class="el" href="../../d3/d4/lockctrl_8c-source.html#l00297">UdfFastUnlockSingle()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l01064">UdfIsVolumeDirty()</a>, <a class="el" href="../../d4/d7/udfs_2create_8c-source.html#l01244">UdfOpenObjectByFileId()</a>, and <a class="el" href="../../d4/d7/udfs_2create_8c-source.html#l01632">UdfOpenObjectFromDirContext()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a101" doxytag="udfprocs.h::UCHAR1" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef union <a class="el" href="../../d9/d2/union__UCHAR1.html">_UCHAR1</a>  <a class="el" href="../../d9/d2/union__UCHAR1.html">UCHAR1</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a103" doxytag="udfprocs.h::UCHAR2" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef union <a class="el" href="../../d0/d3/union__UCHAR2.html">_UCHAR2</a>  <a class="el" href="../../d0/d3/union__UCHAR2.html">UCHAR2</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a105" doxytag="udfprocs.h::UCHAR4" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef union <a class="el" href="../../d1/d3/union__UCHAR4.html">_UCHAR4</a>  <a class="el" href="../../d1/d3/union__UCHAR4.html">UCHAR4</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a107" doxytag="udfprocs.h::USHORT2" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> typedef union <a class="el" href="../../d7/d4/union__USHORT2.html">_USHORT2</a>  <a class="el" href="../../d7/d4/union__USHORT2.html">USHORT2</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<hr><h2>Enumeration Type Documentation</h2>
<a class="anchor" name="a264" doxytag="udfprocs.h::_TYPE_OF_ACQUIRE" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> enum <a class="el" href="../../d3/d8/udfprocs_8h.html#a264">_TYPE_OF_ACQUIRE</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<dl compact><dt><b>Enumeration values: </b></dt><dd>
<table border=0 cellspacing=2 cellpadding=0>
<tr><td valign=top><em><a class="anchor" name="a264a119" doxytag="AcquireExclusive" ></a>AcquireExclusive</em>&nbsp;</td><td>
</td></tr>
<tr><td valign=top><em><a class="anchor" name="a264a120" doxytag="AcquireShared" ></a>AcquireShared</em>&nbsp;</td><td>
</td></tr>
<tr><td valign=top><em><a class="anchor" name="a264a121" doxytag="AcquireSharedStarveExclusive" ></a>AcquireSharedStarveExclusive</em>&nbsp;</td><td>
</td></tr>
</table>
</dl>

<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01381">1381</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.
<p>
<pre class="fragment"><div>01381                               {
01382     
01383     <a class="code" href="../../d3/d8/udfprocs_8h.html#a264a119">AcquireExclusive</a>,
01384     <a class="code" href="../../d3/d8/udfprocs_8h.html#a264a120">AcquireShared</a>,
01385     <a class="code" href="../../d3/d8/udfprocs_8h.html#a264a121">AcquireSharedStarveExclusive</a>
01386 
01387 } <a class="code" href="../../d3/d8/udfprocs_8h.html#a111">TYPE_OF_ACQUIRE</a>, *<a class="code" href="../../d3/d8/udfprocs_8h.html#a112">PTYPE_OF_ACQUIRE</a>;
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a263" doxytag="udfprocs.h::_TYPE_OF_OPEN" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> enum <a class="el" href="../../d3/d8/udfprocs_8h.html#a263">_TYPE_OF_OPEN</a>          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
<dl compact><dt><b>Enumeration values: </b></dt><dd>
<table border=0 cellspacing=2 cellpadding=0>
<tr><td valign=top><em><a class="anchor" name="a263a113" doxytag="UnopenedFileObject" ></a>UnopenedFileObject</em>&nbsp;</td><td>
</td></tr>
<tr><td valign=top><em><a class="anchor" name="a263a114" doxytag="StreamFileOpen" ></a>StreamFileOpen</em>&nbsp;</td><td>
</td></tr>
<tr><td valign=top><em><a class="anchor" name="a263a115" doxytag="UserVolumeOpen" ></a>UserVolumeOpen</em>&nbsp;</td><td>
</td></tr>
<tr><td valign=top><em><a class="anchor" name="a263a116" doxytag="UserDirectoryOpen" ></a>UserDirectoryOpen</em>&nbsp;</td><td>
</td></tr>
<tr><td valign=top><em><a class="anchor" name="a263a117" doxytag="UserFileOpen" ></a>UserFileOpen</em>&nbsp;</td><td>
</td></tr>
<tr><td valign=top><em><a class="anchor" name="a263a118" doxytag="BeyondValidType" ></a>BeyondValidType</em>&nbsp;</td><td>
</td></tr>
</table>
</dl>

<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00487">487</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.
<p>
<pre class="fragment"><div>00487                            {
00488 
00489     <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a113">UnopenedFileObject</a> = 0,
00490     <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a114">StreamFileOpen</a>,
00491     <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a115">UserVolumeOpen</a>,
00492     <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a116">UserDirectoryOpen</a>,
00493     <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a117">UserFileOpen</a>,
00494     <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a118">BeyondValidType</a>
00495 
00496 } <a class="code" href="../../d3/d8/udfprocs_8h.html#a109">TYPE_OF_OPEN</a>, *<a class="code" href="../../d3/d8/udfprocs_8h.html#a110">PTYPE_OF_OPEN</a>;
</div></pre>    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a199" doxytag="udfprocs.h::UdfAcquireForCache" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN UdfAcquireForCache           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d9/struct__FCB.html">PFCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Fcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>Wait</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d8/resrcsup_8c-source.html#l00136">136</a> of file <a class="el" href="../../d5/d8/resrcsup_8c-source.html">resrcsup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02474">ExAcquireResourceShared</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00283">FSRTL_CACHE_TOP_LEVEL_IRP</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l07409">IoGetTopLevelIrp()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l10321">IoSetTopLevelIrp()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d3/d7/udfinit_8c-source.html#l00183">UdfInitializeGlobalData()</a>.
<p>
<pre class="fragment"><div>00143                    :
00144 
00145     The address of <span class="keyword">this</span> routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> specified when creating a CacheMap <span class="keywordflow">for</span>
00146     a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.  It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> subsequently called by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Lazy <a class="code" href="../../d4/d0/tex_8c.html#a44">Writer</a> <span class="keywordflow">for</span> synchronization.
00147 
00148 Arguments:
00149 
00150     Fcb -  The pointer supplied as context to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> cache initialization
00151            routine.
00152 
00153     Wait - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> willing to block.
00154 
00155 Return Value:
00156 
00157     None
00158 
00159 --*/
00160 
00161 {
00162     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00163 
00164     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d4/d6/iosubs_8c.html#a79">IoGetTopLevelIrp</a>() == NULL);
00165     <a class="code" href="../../d4/d6/iosubs_8c.html#a109">IoSetTopLevelIrp</a>((<a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a>)FSRTL_CACHE_TOP_LEVEL_IRP);
00166 
00167     <span class="keywordflow">return</span> <a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a>( Fcb-&gt;Resource, Wait );
00168 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a201" doxytag="udfprocs.h::UdfAcquireForCreateSection" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID UdfAcquireForCreateSection           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>FileObject</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d8/resrcsup_8c-source.html#l00267">267</a> of file <a class="el" href="../../d5/d8/resrcsup_8c-source.html">resrcsup.c</a>.
<p>
References <a class="el" href="../../d6/d7/ex_8h-source.html#l02475">ExAcquireResourceExclusive</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d3/d7/udfinit_8c-source.html#l00183">UdfInitializeGlobalData()</a>.
<p>
<pre class="fragment"><div>00273                    :
00274 
00275     This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> callback routine <span class="keywordflow">for</span> MM to use to acquire <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> exclusively.
00276 
00277 Arguments:
00278 
00279     FileObject - <a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a> object <span class="keywordflow">for</span> a Udffs stream.
00280 
00281 Return Value:
00282 
00283     None
00284 
00285 --*/
00286 
00287 {
00288     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00289 
00290     <span class="comment">//</span>
00291     <span class="comment">//  Get the file resource exclusively.</span>
00292     <span class="comment">//</span>
00293 
00294     <a class="code" href="../../d5/d8/ex_8h.html#a70">ExAcquireResourceExclusive</a>( &amp;((<a class="code" href="../../d7/d9/struct__FCB.html">PFCB</a>) FileObject-&gt;FsContext)-&gt;FcbNonpaged-&gt;FcbResource,
00295                                 TRUE );
00296 
00297     <span class="keywordflow">return</span>;
00298 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a196" doxytag="udfprocs.h::UdfAcquireResource" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN UdfAcquireResource           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d6/d4/struct__ERESOURCE.html">PERESOURCE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Resource</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>IgnoreWait</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d3/d8/udfprocs_8h.html#a111">TYPE_OF_ACQUIRE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Type</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d8/resrcsup_8c-source.html#l00047">47</a> of file <a class="el" href="../../d5/d8/resrcsup_8c-source.html">resrcsup.c</a>.
<p>
References <a class="el" href="../../d3/d8/udfprocs_8h.html#a264a119">AcquireExclusive</a>, <a class="el" href="../../d3/d8/udfprocs_8h.html#a264a120">AcquireShared</a>, <a class="el" href="../../d3/d8/udfprocs_8h.html#a264a121">AcquireSharedStarveExclusive</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02475">ExAcquireResourceExclusive</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02474">ExAcquireResourceShared</a>, <a class="el" href="../../d9/d7/ex_2resource_8c-source.html#l01014">ExAcquireSharedStarveExclusive()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01235">IRP_CONTEXT_FLAG_WAIT</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d9/tex_8c-source.html#l01561">Resource</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d3/d8/udfprocs_8h.html#a111">TYPE_OF_ACQUIRE</a>, and <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00406">UdfRaiseStatus()</a>.
<p>
<pre class="fragment"><div>00056                    :
00057 
00058     This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> single routine used to acquire <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> system resources.  It
00059     looks at <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> IgnoreWait flag to determine whether to <span class="keywordflow">try</span> to acquire <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00060     resource without waiting.  Returning <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>/<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> to indicate success or
00061     <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a>.  Otherwise <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> driven by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> WAIT flag in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> IrpContext and
00062     will raise CANT_WAIT on a <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a>.
00063 
00064 Arguments:
00065 
00066     <a class="code" href="../../d4/d0/tex_8c.html#a21">Resource</a> - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resource to <span class="keywordflow">try</span> and acquire.
00067 
00068     IgnoreWait - If <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> then <span class="keyword">this</span> routine will not wait to acquire <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00069         resource and will <span class="keywordflow">return</span> a <span class="keywordtype">boolean</span> indicating whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resource was
00070         acquired.  Otherwise we use <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> flag in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> IrpContext and raise
00071         <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resource <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not acquired.
00072 
00073     Type - Indicates how we should <span class="keywordflow">try</span> to get <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resource.
00074 
00075 Return Value:
00076 
00077     BOOLEAN - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resource <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> acquired.  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <span class="keywordflow">if</span> not acquired and
00078         IgnoreWait <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> specified.  Otherwise we raise CANT_WAIT.
00079 
00080 --*/
00081 
00082 {
00083     BOOLEAN Wait = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00084     BOOLEAN Acquired;
00085     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00086 
00087     <span class="comment">//</span>
00088     <span class="comment">//  We look first at the IgnoreWait flag, next at the flag in the Irp</span>
00089     <span class="comment">//  Context to decide how to acquire this resource.</span>
00090     <span class="comment">//</span>
00091 
00092     <span class="keywordflow">if</span> (!IgnoreWait &amp;&amp; <a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpContext-&gt;Flags, IRP_CONTEXT_FLAG_WAIT )) {
00093 
00094         Wait = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00095     }
00096 
00097     <span class="comment">//</span>
00098     <span class="comment">//  Attempt to acquire the resource either shared or exclusively.</span>
00099     <span class="comment">//</span>
00100 
00101     <span class="keywordflow">switch</span> (Type) {
00102         <span class="keywordflow">case</span> <a class="code" href="../../d3/d8/udfprocs_8h.html#a264a119">AcquireExclusive</a>:
00103         
00104             Acquired = <a class="code" href="../../d5/d8/ex_8h.html#a70">ExAcquireResourceExclusive</a>( Resource, Wait );
00105             <span class="keywordflow">break</span>;
00106 
00107         <span class="keywordflow">case</span> <a class="code" href="../../d3/d8/udfprocs_8h.html#a264a120">AcquireShared</a>:
00108             
00109             Acquired = <a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a>( Resource, Wait );
00110             <span class="keywordflow">break</span>;
00111 
00112         <span class="keywordflow">case</span> <a class="code" href="../../d3/d8/udfprocs_8h.html#a264a121">AcquireSharedStarveExclusive</a>:
00113             
00114             Acquired = <a class="code" href="../../d5/d8/ex_8h.html#a270">ExAcquireSharedStarveExclusive</a>( Resource, Wait );
00115             <span class="keywordflow">break</span>;
00116 
00117         <span class="keywordflow">default</span>:
00118             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( FALSE );
00119     }
00120 
00121     <span class="comment">//</span>
00122     <span class="comment">//  If not acquired and the user didn't specifiy IgnoreWait then</span>
00123     <span class="comment">//  raise CANT_WAIT.</span>
00124     <span class="comment">//</span>
00125 
00126     <span class="keywordflow">if</span> (!Acquired &amp;&amp; !IgnoreWait) {
00127 
00128         <a class="code" href="../../d3/d8/udfprocs_8h.html#a122">UdfRaiseStatus</a>( IrpContext, STATUS_CANT_WAIT );
00129     }
00130 
00131     <span class="keywordflow">return</span> Acquired;
00132 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a149" doxytag="udfprocs.h::UdfAddToPcb" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID UdfAddToPcb           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d9/struct__PCB.html">PPCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Pcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d7/d2/structNSR__PART.html">PNSR_PART</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PartitionDescriptor</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d5/allocsup_8c-source.html#l00724">724</a> of file <a class="el" href="../../d3/d5/allocsup_8c-source.html">allocsup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00348">ASSERT_PCB</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d6/d8/udfstruc_8h.html#a129a115">Physical</a>, <a class="el" href="../../d0/d7/iso13346_8h.html#a212">PNSR_PART</a>, <a class="el" href="../../d0/d7/iso13346_8h.html#a202">PNSR_VD_GENERIC</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l00235">UdfStoreVolumeDescriptorIfPrevailing()</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>, and <a class="el" href="../../d6/d8/alpha_2exdsptch_8c-source.html#l00105">Virtual</a>.
<p>
Referenced by <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l02832">UdfFindVolumeDescriptors()</a>.
<p>
<pre class="fragment"><div>00731                    :
00732 
00733     This routine possibly adds a partition descriptor into a Pcb <span class="keywordflow">if</span> <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>
00734     turns <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a> to be of higher precendence than a descriptor already
00735     present.  Used in building a Pcb already initialized in preperation
00736     <span class="keywordflow">for</span> <a class="code" href="../../d2/d6/allocsup_8c.html#a8">UdfCompletePcb</a>.
00737 
00738 Arguments:
00739 
00740     Vcb - Vcb of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> volume <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Pcb describes
00741 
00742     Pcb - Pcb being filled in
00743 
00744 Return Value:
00745 
00746     None. An old partition descriptor may be returned in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> input field.
00747 
00748 --*/
00749 
00750 {
00751     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> Reference;
00752 
00753     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00754 
00755     <span class="comment">//</span>
00756     <span class="comment">//  Check inputs</span>
00757     <span class="comment">//</span>
00758 
00759     <a class="code" href="../../d1/d8/udfdata_8h.html#a24">ASSERT_PCB</a>( Pcb );
00760     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( PartitionDescriptor );
00761 
00762     <span class="keywordflow">for</span> (Reference = 0;
00763          Reference &lt; Pcb-&gt;Partitions;
00764          Reference++) {
00765 
00766         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( 0, Dbg, <span class="stringliteral">"UdfAddToPcb,  considering partition reference %d (type %d)\n"</span>, (ULONG)Reference, Pcb-&gt;Partition[Reference].Type));
00767         
00768         <span class="keywordflow">switch</span> (Pcb-&gt;Partition[Reference].Type) {
00769 
00770             <span class="keywordflow">case</span> <a class="code" href="../../d6/d8/udfstruc_8h.html#a129a115">Physical</a>:
00771 
00772                 <span class="comment">//</span>
00773                 <span class="comment">//  Now possibly store this descriptor in the Pcb if it is</span>
00774                 <span class="comment">//  the partition number for this partition reference.</span>
00775                 <span class="comment">//</span>
00776 
00777                 <span class="keywordflow">if</span> (Pcb-&gt;Partition[Reference].Physical.PartitionNumber == PartitionDescriptor-&gt;Number) {
00778 
00779                     <span class="comment">//</span>
00780                     <span class="comment">//  It seems to be legal (if questionable) for multiple partition maps to reference </span>
00781                     <span class="comment">//  the same partition descriptor.  So we make a copy of the descriptor for each </span>
00782                     <span class="comment">//  referencing partitionmap to make life easier when it comes to freeing it.</span>
00783                     <span class="comment">//</span>
00784 
00785                     <a class="code" href="../../d3/d8/udfprocs_8h.html#a176">UdfStoreVolumeDescriptorIfPrevailing</a>( (<a class="code" href="../../d4/d3/structNSR__VD__GENERIC.html">PNSR_VD_GENERIC</a> *) &amp;Pcb-&gt;Partition[Reference].Physical.PartitionDescriptor,
00786                                                           (<a class="code" href="../../d4/d3/structNSR__VD__GENERIC.html">PNSR_VD_GENERIC</a>) PartitionDescriptor );
00787                 }
00788                 
00789                 <span class="keywordflow">break</span>;
00790 
00791             <span class="keywordflow">case</span> <a class="code" href="../../d5/d9/alpha_2exdsptch_8c.html#a2">Virtual</a>:
00792                 <span class="keywordflow">break</span>;
00793 
00794             <span class="keywordflow">default</span>:
00795 
00796                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(FALSE);
00797                 <span class="keywordflow">break</span>;
00798         }
00799     }
00800 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a242" doxytag="udfprocs.h::UdfAddVmcbMapping" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN UdfAddVmcbMapping           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d7/struct__VMCB.html">PVMCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Vmcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a50">LBN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Lbn</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>SectorCount</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>ExactEnd</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d1/d8/fsrtl_8h.html#a53">PVBN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Vbn</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>AlignedSectorCount</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d5/vmcbsup_8c-source.html#l00637">637</a> of file <a class="el" href="../../d7/d5/vmcbsup_8c-source.html">vmcbsup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d9/d2/lfsdata_8h-source.html#l00187">DebugUnwind</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00375">FsRtlAddMcbEntry()</a>, <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00455">FsRtlLookupLastMcbEntry()</a>, <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00392">FsRtlRemoveMcbEntry()</a>, <a class="el" href="../../d4/d4/mutntobj_8c-source.html#l00310">KeReleaseMutex()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00029">LBN</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d5/vmcbsup_8c-source.html#l00127">PageAlign</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00436">try_leave</a>, <a class="el" href="../../d7/d5/vmcbsup_8c-source.html#l00867">UdfRemoveVmcbMapping()</a>, <a class="el" href="../../d7/d5/vmcbsup_8c-source.html#l00964">UdfVmcbLookupMcbEntry()</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00032">VBN</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
Referenced by <a class="el" href="../../d3/d5/allocsup_8c-source.html#l01177">UdfLookupMetaVsnOfExtent()</a>.
<p>
<pre class="fragment"><div>00648                    :
00649 
00650     This routine adds a <span class="keyword">new</span> <a class="code" href="../../d1/d8/fsrtl_8h.html#a50">LBN</a> to <a class="code" href="../../d1/d8/fsrtl_8h.html#a52">VBN</a> mapping to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d1/d7/struct__VMCB.html">VMCB</a> structure.  When
00651     a <span class="keyword">new</span> <a class="code" href="../../d1/d8/fsrtl_8h.html#a50">LBN</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> added to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> structure <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> does <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> on page aligned
00652     boundaries.
00653 
00654     If <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not available to store <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> information <span class="keyword">this</span> routine will
00655     raise a status value indicating insufficient resources.
00656 
00657 Arguments:
00658 
00659     Vmcb - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d1/d7/struct__VMCB.html">VMCB</a> being updated.
00660 
00661     Lbn - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> starting <a class="code" href="../../d1/d8/fsrtl_8h.html#a50">LBN</a> to add to <a class="code" href="../../d1/d7/struct__VMCB.html">VMCB</a>.
00662 
00663     SectorCount - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of Sectors in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> run
00664     
00665     ExactEnd - Indicates that instead of aligning to map sectors beyond
00666         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> end of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> request, use a hole.  Implies trying to look at 
00667         these sectors could be undesireable.
00668 
00669     Vbn - Receives <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> assigned <a class="code" href="../../d1/d8/fsrtl_8h.html#a52">VBN</a>
00670     
00671     AlignedSectorCount - Receives <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> actual sector count created in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00672         Vmcb <span class="keywordflow">for</span> page alignment purposes. Vbn+AlignedSectorCount-1 == LastVbn.
00673 
00674 Return Value:
00675 
00676     BOOLEAN - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a <span class="keyword">new</span> mapping and <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> mapping
00677         <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d1/d8/fsrtl_8h.html#a50">LBN</a> already exists.  If <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> already exists then <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00678         sector count <span class="keywordflow">for</span> <span class="keyword">this</span> <span class="keyword">new</span> addition must already be in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00679         <a class="code" href="../../d1/d7/struct__VMCB.html">VMCB</a> structure
00680 
00681 --*/
00682 
00683 {
00684 
00685     BOOLEAN Result;
00686 
00687     BOOLEAN VbnMcbAdded;
00688     BOOLEAN LbnMcbAdded;
00689 
00690     <a class="code" href="../../d1/d8/fsrtl_8h.html#a50">LBN</a> LocalLbn;
00691     <a class="code" href="../../d1/d8/fsrtl_8h.html#a52">VBN</a> LocalVbn;
00692     ULONG LocalCount;
00693 
00694     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00695 
00696     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( +1, Dbg, <span class="stringliteral">"UdfAddVmcbMapping, Lbn = %08x\n"</span>, Lbn ));
00697     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( 0, Dbg, <span class="stringliteral">" SectorCount = %08x\n"</span>, SectorCount ));
00698 
00699     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( SectorCount != 0 );
00700 
00701     VbnMcbAdded = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00702     LbnMcbAdded = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00703 
00704     <span class="comment">//</span>
00705     <span class="comment">//  Now grab the mutex for the vmcb</span>
00706     <span class="comment">//</span>
00707 
00708     (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>)<a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;Vmcb-&gt;Mutex,
00709                                  Executive,
00710                                  KernelMode,
00711                                  FALSE,
00712                                  (PLARGE_INTEGER) NULL );
00713 
00714     <span class="keywordflow">try</span> {
00715 
00716         <span class="comment">//</span>
00717         <span class="comment">//  Check if the Lbn is already mapped, which means we find an entry</span>
00718         <span class="comment">//  with a non zero mapping Vbn value.</span>
00719         <span class="comment">//</span>
00720 
00721         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/vmcbsup_8c.html#a4">UdfVmcbLookupMcbEntry</a>( &amp;Vmcb-&gt;LbnIndexed,
00722                                    Lbn,
00723                                    Vbn,
00724                                    &amp;LocalCount,
00725                                    NULL )) {
00726 
00727             <span class="comment">//</span>
00728             <span class="comment">//  It is already mapped so now the sector count must not exceed</span>
00729             <span class="comment">//  the count already in the run</span>
00730             <span class="comment">//</span>
00731 
00732             <span class="keywordflow">if</span> (SectorCount &lt;= LocalCount) {
00733 
00734                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( Result = FALSE );
00735             }
00736         }
00737 
00738         <span class="comment">//</span>
00739         <span class="comment">//  At this point, we did not find a full existing mapping for the</span>
00740         <span class="comment">//  Lbn and count.  But there might be some overlapping runs that we'll</span>
00741         <span class="comment">//  need to now remove from the vmcb structure.  So for each Lbn in</span>
00742         <span class="comment">//  the range we're after, check to see if it is mapped and remove the</span>
00743         <span class="comment">//  mapping.  We only need to do this test if the sector count is less</span>
00744         <span class="comment">//  than or equal to a page size.  Because those are the only</span>
00745         <span class="comment">//  structures that we know we'll try an remove/overwrite.</span>
00746         <span class="comment">//</span>
00747 
00748         <span class="keywordflow">if</span> (SectorCount &lt;= <a class="code" href="../../d6/d6/vmcbsup_8c.html#a3">PageAlign</a>(Vmcb, 1)) {
00749 
00750             <span class="keywordflow">if</span> (<a class="code" href="../../d6/d6/vmcbsup_8c.html#a4">UdfVmcbLookupMcbEntry</a>( &amp;Vmcb-&gt;LbnIndexed,
00751                                        Lbn,
00752                                        Vbn,
00753                                        &amp;LocalCount,
00754                                        NULL )) {
00755 
00756                 <a class="code" href="../../d6/d6/vmcbsup_8c.html#a12">UdfRemoveVmcbMapping</a>( Vmcb, *Vbn, <a class="code" href="../../d6/d6/vmcbsup_8c.html#a3">PageAlign</a>(Vmcb, 1) );
00757             }
00758         }
00759 
00760         <span class="comment">//</span>
00761         <span class="comment">//  We need to add this new run at the end of the Vbns.  To do this we</span>
00762         <span class="comment">//  need to look up the last mcb entry or use a vbn for the second</span>
00763         <span class="comment">//  page, if the mcb is empty.  We'll also special case the situation</span>
00764         <span class="comment">//  where the last lbn of the mapping and the mapping we're adding</span>
00765         <span class="comment">//  simply flow into each other in which case we'll not bother bumping</span>
00766         <span class="comment">//  the vbn to a page alignment</span>
00767         <span class="comment">//</span>
00768 
00769         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d8/fsrtl_8h.html#a157">FsRtlLookupLastMcbEntry</a>( &amp;Vmcb-&gt;VbnIndexed, &amp;LocalVbn, &amp;LocalLbn )) {
00770 
00771             <span class="keywordflow">if</span> (LocalLbn + 1 == Lbn) {
00772 
00773                 LocalVbn = LocalVbn + 1;
00774                 LocalLbn = LocalLbn + 1;
00775 
00776             } <span class="keywordflow">else</span> {
00777 
00778                 <span class="comment">//</span>
00779                 <span class="comment">//  Get the next available Vbn Page, and calculate the</span>
00780                 <span class="comment">//  Lbn for the page containing the Lbn</span>
00781                 <span class="comment">//</span>
00782 
00783                 LocalVbn = <a class="code" href="../../d6/d6/vmcbsup_8c.html#a3">PageAlign</a>( Vmcb, LocalVbn + 1 );
00784                 LocalLbn = <a class="code" href="../../d6/d6/vmcbsup_8c.html#a3">PageAlign</a>( Vmcb, Lbn + 1 ) - <a class="code" href="../../d6/d6/vmcbsup_8c.html#a3">PageAlign</a>( Vmcb, 1 );
00785             }
00786 
00787         } <span class="keywordflow">else</span> {
00788 
00789             <span class="comment">//</span>
00790             <span class="comment">//  Get the first available Vbn page, and calculate the</span>
00791             <span class="comment">//  Lbn for the page containing the Lbn.</span>
00792             <span class="comment">//</span>
00793 
00794 
00795             LocalVbn = 0;
00796             LocalLbn = <a class="code" href="../../d6/d6/vmcbsup_8c.html#a3">PageAlign</a>( Vmcb, Lbn + 1 ) - <a class="code" href="../../d6/d6/vmcbsup_8c.html#a3">PageAlign</a>( Vmcb, 1 );
00797         }
00798 
00799         <span class="comment">//</span>
00800         <span class="comment">//  Calculate the number of sectors that we need to map to keep</span>
00801         <span class="comment">//  everything on a page granularity.</span>
00802         <span class="comment">//</span>
00803 
00804         LocalCount = <a class="code" href="../../d6/d6/vmcbsup_8c.html#a3">PageAlign</a>( Vmcb, SectorCount + (Lbn - LocalLbn) );
00805 
00806         <span class="comment">//</span>
00807         <span class="comment">//  See if we should use a hole to map the alignment at the end of the request.</span>
00808         <span class="comment">//</span>
00809         
00810         <span class="keywordflow">if</span> (ExactEnd &amp;&amp; Lbn + SectorCount &lt; LocalLbn + LocalCount) {
00811 
00812             LocalCount = SectorCount + (Lbn - LocalLbn);
00813         }
00814         
00815         <span class="comment">//</span>
00816         <span class="comment">//  Add the double mapping</span>
00817         <span class="comment">//</span>
00818 
00819         <a class="code" href="../../d1/d8/fsrtl_8h.html#a154">FsRtlAddMcbEntry</a>( &amp;Vmcb-&gt;VbnIndexed,
00820                           LocalVbn,
00821                           LocalLbn,
00822                           LocalCount );
00823 
00824         VbnMcbAdded = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00825 
00826         <a class="code" href="../../d1/d8/fsrtl_8h.html#a154">FsRtlAddMcbEntry</a>( &amp;Vmcb-&gt;LbnIndexed,
00827                           LocalLbn,
00828                           LocalVbn,
00829                           LocalCount );
00830 
00831         LbnMcbAdded = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00832 
00833         *Vbn = LocalVbn + (Lbn - LocalLbn);
00834         *AlignedSectorCount = LocalCount - (Lbn - LocalLbn);
00835 
00836         <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( Result = TRUE );
00837 
00838     } finally {
00839 
00840         <span class="comment">//</span>
00841         <span class="comment">//  If this is an abnormal termination then clean up any mcb's that we</span>
00842         <span class="comment">//  might have modified.</span>
00843         <span class="comment">//</span>
00844 
00845         <span class="keywordflow">if</span> (AbnormalTermination()) {
00846 
00847             <span class="keywordflow">if</span> (VbnMcbAdded) { <a class="code" href="../../d1/d8/fsrtl_8h.html#a155">FsRtlRemoveMcbEntry</a>( &amp;Vmcb-&gt;VbnIndexed, LocalVbn, LocalCount ); }
00848             <span class="keywordflow">if</span> (LbnMcbAdded) { <a class="code" href="../../d1/d8/fsrtl_8h.html#a155">FsRtlRemoveMcbEntry</a>( &amp;Vmcb-&gt;LbnIndexed, LocalLbn, LocalCount ); }
00849         }
00850 
00851         (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d3/d5/mutntobj_8c.html#a5">KeReleaseMutex</a>( &amp;Vmcb-&gt;Mutex, FALSE );
00852 
00853         <a class="code" href="../../d8/d3/lfsdata_8h.html#a3">DebugUnwind</a>(<span class="stringliteral">"UdfAddVmcbMapping"</span>);
00854         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( 0, Dbg, <span class="stringliteral">" LocalVbn   = %08x\n"</span>, LocalVbn ));
00855         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( 0, Dbg, <span class="stringliteral">" LocalLbn   = %08x\n"</span>, LocalLbn ));
00856         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( 0, Dbg, <span class="stringliteral">" LocalCount = %08x\n"</span>, LocalCount ));
00857         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( 0, Dbg, <span class="stringliteral">" *Vbn                = %08x\n"</span>, *Vbn ));
00858         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( 0, Dbg, <span class="stringliteral">" *AlignedSectorCount = %08x\n"</span>, *AlignedSectorCount ));
00859         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>((-1, Dbg, <span class="stringliteral">"UdfAddVmcbMapping -&gt; %08x\n"</span>, Result ));
00860     }
00861 
00862     <span class="keywordflow">return</span> Result;
00863 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a179" doxytag="udfprocs.h::UdfCandidateShortName" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN UdfCandidateShortName           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>Name</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d4/namesup_8c-source.html#l00301">301</a> of file <a class="el" href="../../d6/d4/namesup_8c-source.html">namesup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00352">ASSERT_IRP_CONTEXT</a>, <a class="el" href="../../d0/d7/udf_8h-source.html#l00205">BYTE_COUNT_8_DOT_3</a>, <a class="el" href="../../d0/d7/udf_8h-source.html#l00240">CRC_MARK</a>, <a class="el" href="../../d0/d7/udf_8h-source.html#l00227">DOS_CRC_LEN</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d9/d9/geninst_8c-source.html#l00154">Name</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d0/d7/udf_8h-source.html#l00238">PERIOD</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d4/d7/udfs_2create_8c-source.html#l00108">UdfCommonCreate()</a>.
<p>
<pre class="fragment"><div>00308                    :
00309 
00310     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called to determine <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> input name could be a generated
00311     <span class="keywordtype">short</span> name.
00312 
00313 Arguments:
00314 
00315     <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a> - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name to stare at.
00316 
00317 Return Value:
00318 
00319     BOOLEAN True <span class="keywordflow">if</span> <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> possible that <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a shortname, False otherwise.
00320 
00321 --*/
00322 
00323 {
00324     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>, SubIndex;
00325     BOOLEAN LooksShort = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00326     
00327     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00328 
00329     <span class="comment">//</span>
00330     <span class="comment">//  Check inputs.</span>
00331     <span class="comment">//</span>
00332 
00333     <a class="code" href="../../d1/d8/udfdata_8h.html#a28">ASSERT_IRP_CONTEXT</a>( IrpContext );
00334 
00335     <span class="comment">//</span>
00336     <span class="comment">//  The length can't be larger than an 8.3 name and must be</span>
00337     <span class="comment">//  at least as big as the uniqifier stamp.</span>
00338     <span class="comment">//</span>
00339 
00340     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Length != 0 );
00341     
00342     <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Length &gt; <a class="code" href="../../d9/d7/udf_8h.html#a11">BYTE_COUNT_8_DOT_3</a> ||
00343         <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Length &lt; <a class="code" href="../../d9/d7/udf_8h.html#a18">DOS_CRC_LEN</a> * <span class="keyword">sizeof</span>(WCHAR)) {
00344 
00345         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00346     }
00347     
00348     <span class="comment">//</span>
00349     <span class="comment">//  Walk across the name looking for the uniquifier stamp.  The stamp</span>
00350     <span class="comment">//  is of the form #&lt;hex&gt;&lt;hex&gt;&lt;hex&gt; so if we can stop before the end</span>
00351     <span class="comment">//  of the full name.</span>
00352     <span class="comment">//</span>
00353     
00354     <span class="keywordflow">for</span> ( <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0;
00355           <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt;= (<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Length / <span class="keyword">sizeof</span>(WCHAR)) - <a class="code" href="../../d9/d7/udf_8h.html#a18">DOS_CRC_LEN</a>;
00356           <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>++ ) {
00357 
00358         <span class="comment">//</span>
00359         <span class="comment">//  Is the current character the stamp UDF uses to offset the stamp?</span>
00360         <span class="comment">//</span>
00361         
00362         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Buffer[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>] == <a class="code" href="../../d9/d7/udf_8h.html#a28">CRC_MARK</a>) {
00363         
00364             <span class="comment">//</span>
00365             <span class="comment">//  We may potentially have just a CRC at the end</span>
00366             <span class="comment">//  of the name OR have a period following.  If we</span>
00367             <span class="comment">//  do, it is reasonable to think the name may be</span>
00368             <span class="comment">//  a generated shorty.</span>
00369             <span class="comment">//</span>
00370             <span class="comment">//  #123 (a very special case - orignal name was ".")</span>
00371             <span class="comment">//  FOO#123</span>
00372             <span class="comment">//  FOO#123.TXT</span>
00373             <span class="comment">//</span>
00374             
00375             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> == (<a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Length / <span class="keyword">sizeof</span>(WCHAR)) - <a class="code" href="../../d9/d7/udf_8h.html#a18">DOS_CRC_LEN</a> ||
00376                 <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Buffer[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> + <a class="code" href="../../d9/d7/udf_8h.html#a18">DOS_CRC_LEN</a>] == <a class="code" href="../../d9/d7/udf_8h.html#a26">PERIOD</a>) {
00377 
00378                 LooksShort = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00379                 <span class="keywordflow">break</span>;
00380             }
00381         }
00382     }
00383 
00384     <span class="keywordflow">return</span> LooksShort;
00385 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a232" doxytag="udfprocs.h::UdfCheckForDismount" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN UdfCheckForDismount           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d7/d5/struct__VCB.html">PVCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Vcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>Force</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d4/udfs_2verfysup_8c-source.html#l00236">236</a> of file <a class="el" href="../../d9/d4/udfs_2verfysup_8c-source.html">udfs/verfysup.c</a>.
<p>
References <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00363">ASSERT_EXCLUSIVE_UDFDATA</a>, <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00352">ASSERT_IRP_CONTEXT</a>, <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00336">ASSERT_VCB</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l00134">IoAcquireVpbSpinLock()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l09644">IoReleaseVpbSpinLock()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01515">UdfAcquireVcbExclusive</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l01210">UdfDeleteVcb()</a>, <a class="el" href="../../d9/d4/udfs_2verfysup_8c-source.html#l00365">UdfDismountVcb()</a>, <a class="el" href="../../d3/d8/close_8c-source.html#l00099">UdfFspClose()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01559">UdfLockVcb</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01521">UdfReleaseVcb</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01563">UdfUnlockVcb</a>, and <a class="el" href="../../d6/d8/udfstruc_8h.html#a130a121">VcbDismountInProgress</a>.
<p>
Referenced by <a class="el" href="../../d3/d8/close_8c-source.html#l00319">UdfCommonClose()</a>, <a class="el" href="../../d3/d8/close_8c-source.html#l00099">UdfFspClose()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l01271">UdfInvalidateVolumes()</a>, <a class="el" href="../../d9/d4/udfs_2verfysup_8c-source.html#l00042">UdfPerformVerify()</a>, <a class="el" href="../../d5/d8/udfs_2pnp_8c-source.html#l00194">UdfPnpQueryRemove()</a>, <a class="el" href="../../d5/d8/udfs_2pnp_8c-source.html#l00350">UdfPnpRemove()</a>, <a class="el" href="../../d5/d8/udfs_2pnp_8c-source.html#l00500">UdfPnpSurpriseRemove()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l03749">UdfScanForDismountedVcb()</a>, and <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l02043">UdfVerifyVolume()</a>.
<p>
<pre class="fragment"><div>00244                    :
00245 
00246     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called to check <span class="keywordflow">if</span> a volume <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> ready <span class="keywordflow">for</span> dismount.  This
00247     occurs when <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> system references are left on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> volume.
00248 
00249     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> dismount <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not currently underway and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user reference count
00250     has gone to zero then we can begin <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> dismount.
00251 
00252     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> dismount <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> in progress and there are no references left on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00253     volume (we check the Vpb <span class="keywordflow">for</span> outstanding references as well to <span class="keywordflow">catch</span>
00254     any create calls dispatched to the file system) then we can <span class="keyword">delete</span>
00255     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Vcb.
00256 
00257 Arguments:
00258 
00259     Vcb - Vcb <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> volume to <span class="keywordflow">try</span> to dismount.
00260     
00261     Force - Whether we will force <span class="keyword">this</span> volume to be dismounted.
00262 
00263 Return Value:
00264 
00265     BOOLEAN - True <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Vcb was not gone by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> time <span class="keyword">this</span> function finished,
00266         False <span class="keywordflow">if</span> <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> was deleted.
00267         
00268     This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> a trustworthy indication to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller <span class="keywordflow">if</span> <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> had <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> vcb
00269     exclusive itself.
00270 
00271 --*/
00272 
00273 {
00274     BOOLEAN UnlockVcb = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00275     BOOLEAN VcbPresent = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00276     KIRQL SavedIrql;
00277 
00278     <a class="code" href="../../d1/d8/udfdata_8h.html#a28">ASSERT_IRP_CONTEXT</a>( IrpContext );
00279     <a class="code" href="../../d1/d8/udfdata_8h.html#a12">ASSERT_VCB</a>( Vcb );
00280 
00281     <a class="code" href="../../d1/d8/udfdata_8h.html#a39">ASSERT_EXCLUSIVE_UDFDATA</a>;
00282 
00283     <span class="comment">//</span>
00284     <span class="comment">//  Acquire and lock this Vcb to check the dismount state.</span>
00285     <span class="comment">//</span>
00286 
00287     <a class="code" href="../../d3/d8/udfprocs_8h.html#a74">UdfAcquireVcbExclusive</a>( IrpContext, Vcb, FALSE );
00288 
00289     <span class="comment">//</span>
00290     <span class="comment">//  Lets get rid of any pending closes for this volume.</span>
00291     <span class="comment">//</span>
00292 
00293     <a class="code" href="../../d3/d8/udfprocs_8h.html#a250">UdfFspClose</a>( Vcb );
00294 
00295     <a class="code" href="../../d3/d8/udfprocs_8h.html#a88">UdfLockVcb</a>( IrpContext, Vcb );
00296 
00297     <span class="comment">//</span>
00298     <span class="comment">//  If the dismount is not already underway then check if the</span>
00299     <span class="comment">//  user reference count has gone to zero or we are being forced</span>
00300     <span class="comment">//  to disconnect.  If so start the teardown on the Vcb.</span>
00301     <span class="comment">//</span>
00302 
00303     <span class="keywordflow">if</span> (Vcb-&gt;VcbCondition != <a class="code" href="../../d6/d8/udfstruc_8h.html#a130a121">VcbDismountInProgress</a>) {
00304 
00305         <span class="keywordflow">if</span> (Vcb-&gt;VcbUserReference &lt;= Vcb-&gt;VcbResidualUserReference || Force) {
00306 
00307             <a class="code" href="../../d3/d8/udfprocs_8h.html#a89">UdfUnlockVcb</a>( IrpContext, Vcb );
00308             UnlockVcb = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00309             VcbPresent = <a class="code" href="../../d8/d5/udfs_2verfysup_8c.html#a4">UdfDismountVcb</a>( IrpContext, Vcb );
00310         }
00311 
00312     <span class="comment">//</span>
00313     <span class="comment">//  If the teardown is underway and there are absolutely no references</span>
00314     <span class="comment">//  remaining then delete the Vcb.  References here include the</span>
00315     <span class="comment">//  references in the Vcb and Vpb.</span>
00316     <span class="comment">//</span>
00317 
00318     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Vcb-&gt;VcbReference == 0) {
00319 
00320         <a class="code" href="../../d4/d6/iosubs_8c.html#a10">IoAcquireVpbSpinLock</a>( &amp;SavedIrql );
00321 
00322         <span class="comment">//</span>
00323         <span class="comment">//  If there are no file objects and no reference counts in the</span>
00324         <span class="comment">//  Vpb we can delete the Vcb.  Don't forget that we have the</span>
00325         <span class="comment">//  last reference in the Vpb.</span>
00326         <span class="comment">//</span>
00327 
00328         <span class="keywordflow">if</span> (Vcb-&gt;Vpb-&gt;ReferenceCount == 1) {
00329 
00330             <a class="code" href="../../d4/d6/iosubs_8c.html#a102">IoReleaseVpbSpinLock</a>( SavedIrql );
00331             <a class="code" href="../../d3/d8/udfprocs_8h.html#a89">UdfUnlockVcb</a>( IrpContext, Vcb );
00332             UnlockVcb = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00333             <a class="code" href="../../d3/d8/udfprocs_8h.html#a206">UdfDeleteVcb</a>( IrpContext, Vcb );
00334             VcbPresent = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00335 
00336         } <span class="keywordflow">else</span> {
00337 
00338             <a class="code" href="../../d4/d6/iosubs_8c.html#a102">IoReleaseVpbSpinLock</a>( SavedIrql );
00339         }
00340     }
00341 
00342     <span class="comment">//</span>
00343     <span class="comment">//  Unlock the Vcb if still held.</span>
00344     <span class="comment">//</span>
00345 
00346     <span class="keywordflow">if</span> (UnlockVcb) {
00347 
00348         <a class="code" href="../../d3/d8/udfprocs_8h.html#a89">UdfUnlockVcb</a>( IrpContext, Vcb );
00349     }
00350 
00351     <span class="comment">//</span>
00352     <span class="comment">//  Release any resources still acquired.</span>
00353     <span class="comment">//</span>
00354 
00355     <span class="keywordflow">if</span> (VcbPresent) {
00356 
00357         <a class="code" href="../../d3/d8/udfprocs_8h.html#a76">UdfReleaseVcb</a>( IrpContext, Vcb );
00358     }
00359 
00360     <span class="keywordflow">return</span> VcbPresent;
00361 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a182" doxytag="udfprocs.h::UdfCheckLegalCS0Dstring" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN UdfCheckLegalCS0Dstring           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PUCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>Dstring</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>UCHAR Length&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>UCHAR FieldLength&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>ReturnOnError</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d4/namesup_8c-source.html#l00819">819</a> of file <a class="el" href="../../d6/d4/namesup_8c-source.html">namesup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00352">ASSERT_IRP_CONTEXT</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00406">UdfRaiseStatus()</a>.
<p>
Referenced by <a class="el" href="../../d5/d7/dirsup_8c-source.html#l00360">UdfUpdateDirNames()</a>, and <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l04056">UdfUpdateVolumeLabel()</a>.
<p>
<pre class="fragment"><div>00829                    :
00830 
00831     This routine inspects a CS0 Dstring <span class="keywordflow">for</span> conformance.
00832     
00833 Arguments:
00834 
00835     Dstring - a dstring to check
00836     
00837     Length - length of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> dstring.  If unspecified, we assume that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> characters come
00838         from a proper 1/7.2.12 dstring that specifies length in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> last character of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00839         field.
00840     
00841     FieldLength - length of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> dstring field.  If unspecified, we assume that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> characters
00842         come from an uncounted length of CS0 characters and that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Length parameter <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00843         specified.
00844     
00845     ReturnOnError - whether to <span class="keywordflow">return</span> or raise on a discovered error
00846     
00847 Return Value:
00848 
00849     None. Raised status <span class="keywordflow">if</span> corruption <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> found.
00850     
00851 --*/
00852 
00853 {
00854     UCHAR NameLength;
00855 
00856     <span class="comment">//</span>
00857     <span class="comment">//  Check input.</span>
00858     <span class="comment">//</span>
00859 
00860     <a class="code" href="../../d1/d8/udfdata_8h.html#a28">ASSERT_IRP_CONTEXT</a>( IrpContext );
00861 
00862     <span class="comment">//</span>
00863     <span class="comment">//  If the length is unspecified, this is a real 1/7.2.12 dstring and the length is in</span>
00864     <span class="comment">//  the last character of the field.</span>
00865     <span class="comment">//</span>
00866     
00867     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( Length || FieldLength );
00868 
00869     <span class="keywordflow">if</span> (Length) {
00870 
00871         NameLength = FieldLength = Length;
00872     
00873     } <span class="keywordflow">else</span> {
00874 
00875         NameLength = *(Dstring + FieldLength - 1);
00876     }
00877 
00878     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( +1, Dbg,
00879                  <span class="stringliteral">"UdfCheckLegalCS0Dstring, Dstring %08x Length %02x FieldLength %02x (NameLength %02x)\n"</span>,
00880                  Dstring,
00881                  Length,
00882                  FieldLength,
00883                  NameLength ));
00884 
00885     <span class="comment">//</span>
00886     <span class="comment">//  The string must be "compressed" in 8bit or 16bit chunks.  If it</span>
00887     <span class="comment">//  is in 16bit chunks, we better have an integral number of them -</span>
00888     <span class="comment">//  remember we have the compression ID, so the length will be odd.</span>
00889     <span class="comment">//</span>
00890     
00891     <span class="keywordflow">if</span> ((NameLength &lt;= 1 &amp;&amp;
00892          <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( 0, Dbg,
00893                       <span class="stringliteral">"UdfCheckLegalCS0Dstring, NameLength is too small!\n"</span> ))) ||
00894 
00895         (NameLength &gt; FieldLength &amp;&amp;
00896          <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( 0, Dbg,
00897                       <span class="stringliteral">"UdfCheckLegalCS0Dstring, NameLength is bigger than the field itself!\n"</span> ))) ||
00898 
00899         ((*Dstring != 8 &amp;&amp; *Dstring != 16) &amp;&amp;
00900          <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( 0, Dbg,
00901                       <span class="stringliteral">"UdfCheckLegalCS0Dstring, claims encoding %02x, unknown! (not 0x8 or 0x10)\n"</span>,
00902                       *Dstring ))) ||
00903 
00904         ((*Dstring == 16 &amp;&amp; !<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( NameLength, 1)) &amp;&amp;
00905          <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( 0, Dbg,
00906                      <span class="stringliteral">"UdfCheckLegalCS0Dstring, NameLength not odd, encoding 0x10!\n"</span> )))) {
00907 
00908         <span class="keywordflow">if</span> (ReturnOnError) {
00909 
00910             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( -1, Dbg, <span class="stringliteral">"UdfCheckLegalCS0Dstring -&gt; FALSE\n"</span> ));
00911 
00912             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00913         }
00914 
00915         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( -1, Dbg, <span class="stringliteral">"UdfCheckLegalCS0Dstring -&gt; raised status\n"</span> ));
00916 
00917         <a class="code" href="../../d3/d8/udfprocs_8h.html#a122">UdfRaiseStatus</a>( IrpContext, STATUS_FILE_CORRUPT_ERROR );
00918     }
00919 
00920     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( -1, Dbg, <span class="stringliteral">"UdfCheckLegalCS0Dstring -&gt; TRUE\n"</span> ));
00921 
00922     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00923 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a168" doxytag="udfprocs.h::UdfCleanupDirContext" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID UdfCleanupDirContext           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d5/d5/struct__DIR__ENUM__CONTEXT.html">PDIR_ENUM_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DirContext</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d7/dirsup_8c-source.html#l00099">99</a> of file <a class="el" href="../../d5/d7/dirsup_8c-source.html">dirsup.c</a>.
<p>
References <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00352">ASSERT_IRP_CONTEXT</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01706">DIR_CONTEXT_FLAG_FID_BUFFERED</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00453">UdfFreePool()</a>, and <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00838">UdfUnpinData</a>.
<p>
Referenced by <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l00112">UdfCleanupCompoundDirContext()</a>, <a class="el" href="../../d4/d7/udfs_2create_8c-source.html#l00108">UdfCommonCreate()</a>, <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l01003">UdfInitializeEnumeration()</a>, and <a class="el" href="../../d5/d2/fileinfo_8c-source.html#l01232">UdfQueryAlternateNameInfo()</a>.
<p>
<pre class="fragment"><div>00106                    :
00107 
00108     This routine cleans up a directory enumeration context <span class="keywordflow">for</span> reuse.
00109 
00110 Arguments:
00111 
00112     DirContext - a context to clean.
00113 
00114 Return Value:
00115 
00116     None.
00117 
00118 --*/
00119 
00120 {
00121     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00122 
00123     <span class="comment">//</span>
00124     <span class="comment">//  Check input.</span>
00125     <span class="comment">//</span>
00126 
00127     <a class="code" href="../../d1/d8/udfdata_8h.html#a28">ASSERT_IRP_CONTEXT</a>( IrpContext );
00128     
00129     <span class="comment">//</span>
00130     <span class="comment">//  Dump the allocation we store the triple of names in.</span>
00131     <span class="comment">//</span>
00132 
00133     <a class="code" href="../../d3/d8/udfprocs_8h.html#a124">UdfFreePool</a>( &amp;DirContext-&gt;NameBuffer );
00134 
00135     <span class="comment">//</span>
00136     <span class="comment">//  And the short name.</span>
00137     <span class="comment">//</span>
00138 
00139     <a class="code" href="../../d3/d8/udfprocs_8h.html#a124">UdfFreePool</a>( &amp;DirContext-&gt;ShortObjectName.Buffer );
00140 
00141     <span class="comment">//</span>
00142     <span class="comment">//  Unpin the view.</span>
00143     <span class="comment">//</span>
00144 
00145     <a class="code" href="../../d3/d8/udfprocs_8h.html#a69">UdfUnpinData</a>( IrpContext, &amp;DirContext-&gt;Bcb );
00146 
00147     <span class="comment">//</span>
00148     <span class="comment">//  Free a buffered Fid that may remain.</span>
00149     <span class="comment">//</span>
00150     
00151     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( DirContext-&gt;Flags, DIR_CONTEXT_FLAG_FID_BUFFERED )) {
00152 
00153         <a class="code" href="../../d3/d8/udfprocs_8h.html#a124">UdfFreePool</a>( &amp;DirContext-&gt;Fid );
00154     }
00155     
00156     <span class="comment">//</span>
00157     <span class="comment">//  Zero everything else out.</span>
00158     <span class="comment">//</span>
00159 
00160     RtlZeroMemory( DirContext, <span class="keyword">sizeof</span>( <a class="code" href="../../d5/d5/struct__DIR__ENUM__CONTEXT.html">DIR_ENUM_CONTEXT</a> ) );
00161 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a224" doxytag="udfprocs.h::UdfCleanupIcbContext" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID UdfCleanupIcbContext           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d9/d9/struct__ICB__SEARCH__CONTEXT.html">PICB_SEARCH_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IcbContext</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l03183">3183</a> of file <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html">udfs/strucsup.c</a>.
<p>
References <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00352">ASSERT_IRP_CONTEXT</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00828">UdfUnpinView</a>.
<p>
Referenced by <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l00112">UdfCleanupCompoundDirContext()</a>, <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l01688">UdfLookupFileEntryInEnumeration()</a>, <a class="el" href="../../d4/d7/udfs_2create_8c-source.html#l01244">UdfOpenObjectByFileId()</a>, <a class="el" href="../../d4/d7/udfs_2create_8c-source.html#l01632">UdfOpenObjectFromDirContext()</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l00477">UdfUpdateVcbPhase0()</a>, and <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l00997">UdfUpdateVcbPhase1()</a>.
<p>
<pre class="fragment"><div>03190                    :
03191 
03192     This routine cleans an Icb search context <span class="keywordflow">for</span> reuse/deletion.
03193 
03194 Arguments:
03195 
03196     IcbContext - context to clean
03197 
03198 Return Value:
03199 
03200     None.
03201 
03202 --*/
03203 
03204 {
03205     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03206 
03207     <span class="comment">//</span>
03208     <span class="comment">//  Check inputs</span>
03209     <span class="comment">//</span>
03210     
03211     <a class="code" href="../../d1/d8/udfdata_8h.html#a28">ASSERT_IRP_CONTEXT</a>( IrpContext );
03212 
03213     <a class="code" href="../../d3/d8/udfprocs_8h.html#a68">UdfUnpinView</a>( IrpContext, &amp;IcbContext-&gt;Active );
03214     <a class="code" href="../../d3/d8/udfprocs_8h.html#a68">UdfUnpinView</a>( IrpContext, &amp;IcbContext-&gt;Current );
03215 
03216     RtlZeroMemory( IcbContext, <span class="keyword">sizeof</span>( <a class="code" href="../../d9/d9/struct__ICB__SEARCH__CONTEXT.html">ICB_SEARCH_CONTEXT</a> ));
03217 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a208" doxytag="udfprocs.h::UdfCleanupIrpContext" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID UdfCleanupIrpContext           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>Post</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l01437">1437</a> of file <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html">udfs/strucsup.c</a>.
<p>
References <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00352">ASSERT_IRP_CONTEXT</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00509">ClearFlag</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00821">ExFreeToNPagedLookasideList()</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01241">IRP_CONTEXT_FLAG_ALLOC_IO</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01234">IRP_CONTEXT_FLAG_MORE_PROCESSING</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01233">IRP_CONTEXT_FLAG_ON_STACK</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01255">IRP_CONTEXT_FLAGS_CLEAR_ON_POST</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01270">IRP_CONTEXT_FLAGS_CLEAR_ON_RETRY</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01706">UdfFreeIoContext</a>, <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00191">UdfIrpContextLookasideList</a>, and <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00543">UdfRestoreThreadContext()</a>.
<p>
Referenced by <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00809">UdfCompleteRequest()</a>, <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00218">UdfFsdDispatch()</a>, <a class="el" href="../../d1/d7/fspdisp_8c-source.html#l00038">UdfFspDispatch()</a>, <a class="el" href="../../d3/d8/workque_8c-source.html#l00111">UdfPrePostIrp()</a>, and <a class="el" href="../../d3/d8/close_8c-source.html#l00634">UdfQueueClose()</a>.
<p>
<pre class="fragment"><div>01444                    :
01445 
01446     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called to cleanup and possibly deallocate <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> Context.
01447     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> request <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being posted or <span class="keyword">this</span> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> Context <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> possibly on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01448     stack then we <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> cleanup any auxilary structures.
01449 
01450 Arguments:
01451 
01452     Post - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> we are posting <span class="keyword">this</span> request, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <span class="keywordflow">if</span> we are deleting
01453         or retrying <span class="keyword">this</span> in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current thread.
01454 
01455 Return Value:
01456 
01457     None.
01458 
01459 --*/
01460 
01461 {
01462     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01463 
01464     <a class="code" href="../../d1/d8/udfdata_8h.html#a28">ASSERT_IRP_CONTEXT</a>( IrpContext );
01465 
01466     <span class="comment">//</span>
01467     <span class="comment">//  If we aren't doing more processing then deallocate this as appropriate.</span>
01468     <span class="comment">//</span>
01469 
01470     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpContext-&gt;Flags, IRP_CONTEXT_FLAG_MORE_PROCESSING)) {
01471 
01472         <span class="comment">//</span>
01473         <span class="comment">//  If this context is the top level UDFS context then we need to</span>
01474         <span class="comment">//  restore the top level thread context.</span>
01475         <span class="comment">//</span>
01476 
01477         <span class="keywordflow">if</span> (IrpContext-&gt;ThreadContext != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01478 
01479             <a class="code" href="../../d3/d8/udfprocs_8h.html#a131">UdfRestoreThreadContext</a>( IrpContext );
01480         }
01481         
01482         <span class="comment">//</span>
01483         <span class="comment">//  Deallocate the Io context if allocated.</span>
01484         <span class="comment">//</span>
01485 
01486         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpContext-&gt;Flags, IRP_CONTEXT_FLAG_ALLOC_IO )) {
01487 
01488             <a class="code" href="../../d3/d8/udfprocs_8h.html#a95">UdfFreeIoContext</a>( IrpContext-&gt;IoContext );
01489         }
01490         
01491         <span class="comment">//</span>
01492         <span class="comment">//  Deallocate the IrpContext if not from the stack.</span>
01493         <span class="comment">//</span>
01494 
01495         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpContext-&gt;Flags, IRP_CONTEXT_FLAG_ON_STACK )) {
01496 
01497             <a class="code" href="../../d5/d8/ex_8h.html#a249">ExFreeToNPagedLookasideList</a>( &amp;UdfIrpContextLookasideList, IrpContext );
01498         }
01499 
01500     <span class="comment">//</span>
01501     <span class="comment">//  Clear the appropriate flags.</span>
01502     <span class="comment">//</span>
01503 
01504     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Post) {
01505 
01506         <span class="comment">//</span>
01507         <span class="comment">//  If this context is the top level UDFS context then we need to</span>
01508         <span class="comment">//  restore the top level thread context.</span>
01509         <span class="comment">//</span>
01510 
01511         <span class="keywordflow">if</span> (IrpContext-&gt;ThreadContext != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01512 
01513             <a class="code" href="../../d3/d8/udfprocs_8h.html#a131">UdfRestoreThreadContext</a>( IrpContext );
01514         }
01515 
01516         <a class="code" href="../../d5/d5/cc_8h.html#a61">ClearFlag</a>( IrpContext-&gt;Flags, IRP_CONTEXT_FLAGS_CLEAR_ON_POST );
01517 
01518     } <span class="keywordflow">else</span> {
01519 
01520         <a class="code" href="../../d5/d5/cc_8h.html#a61">ClearFlag</a>( IrpContext-&gt;Flags, IRP_CONTEXT_FLAGS_CLEAR_ON_RETRY );
01521     }
01522 
01523     <span class="keywordflow">return</span>;
01524 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a251" doxytag="udfprocs.h::UdfCommonCleanup" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS UdfCommonCleanup           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d6/udfs_2cleanup_8c-source.html#l00042">42</a> of file <a class="el" href="../../d9/d6/udfs_2cleanup_8c-source.html">udfs/cleanup.c</a>.
<p>
References <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00356">ASSERT_IRP</a>, <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00352">ASSERT_IRP_CONTEXT</a>, <a class="el" href="../../d4/d2/cache_8h.html#a59">CcUninitializeCacheMap()</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00509">ClearFlag</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00673">_VCB::DirNotifyList</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01533">_FILE_OBJECT::Flags</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01504">FO_CLEANUP_COMPLETE</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01425">FSRTL_VOLUME_UNLOCK</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l00823">FsRtlCheckOplock()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l03770">FsRtlFastUnlockAll()</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l01795">FsRtlNotifyCleanup()</a>, <a class="el" href="../../d4/d8/fsrtl_2pnp_8c-source.html#l00041">FsRtlNotifyVolumeEvent()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03252">IoGetCurrentIrpStackLocation</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l07374">IoGetRequestorProcess()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l09675">IoRemoveShareAccess()</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00667">_VCB::NotifySync</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d6/d8/udfstruc_8h.html#a91">PCCB</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00505">SetFlag</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01033">_FCB::ShareAccess</a>, <a class="el" href="../../d3/d8/udfprocs_8h.html#a263a114">StreamFileOpen</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d3/d8/udfprocs_8h.html#a109">TYPE_OF_OPEN</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01542">UdfAcquireFcbExclusive</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01515">UdfAcquireVcbExclusive</a>, <a class="el" href="../../d2/d6/udfs_2nodetype_8h-source.html#l00149">UdfBugCheck</a>, <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00809">UdfCompleteRequest()</a>, <a class="el" href="../../d7/d2/filobsup_8c-source.html#l00133">UdfDecodeFileObject()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01756">UdfDecrementCleanupCounts</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00385">UdfIsFastIoPossible</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01567">UdfLockFcb</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01559">UdfLockVcb</a>, <a class="el" href="../../d9/d1/udfs_2cachesup_8c-source.html#l00417">UdfPurgeVolume()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01548">UdfReleaseFcb</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01521">UdfReleaseVcb</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01577">UdfUnlockFcb</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01563">UdfUnlockVcb</a>, <a class="el" href="../../d3/d8/udfprocs_8h.html#a263a116">UserDirectoryOpen</a>, <a class="el" href="../../d3/d8/udfprocs_8h.html#a263a117">UserFileOpen</a>, <a class="el" href="../../d3/d8/udfprocs_8h.html#a263a115">UserVolumeOpen</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00941">_FCB::Vcb</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00683">VCB_STATE_LOCKED</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00611">_VCB::VcbCleanup</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00559">_VCB::VcbCondition</a>, <a class="el" href="../../d6/d8/udfstruc_8h.html#a130a117">VcbNotMounted</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00558">_VCB::VcbState</a>, and <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00565">_VCB::VolumeLockFileObject</a>.
<p>
Referenced by <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00218">UdfFsdDispatch()</a>, and <a class="el" href="../../d1/d7/fspdisp_8c-source.html#l00038">UdfFspDispatch()</a>.
<p>
<pre class="fragment"><div>00049                    :
00050 
00051     This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> common routine <span class="keywordflow">for</span> cleanup of a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>/directory called by both
00052     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> fsd and fsp threads.
00053 
00054     Cleanup <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked whenever <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> last handle to a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> closed.
00055     This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> different than <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Close operation which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> invoked when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> last
00056     reference to a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> deleted.
00057 
00058     The function of cleanup <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to essentially <span class="stringliteral">"cleanup"</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>/directory
00059     after a user <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> done with <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>.  The Fcb/Dcb remains around (because MM
00060     still has the file object referenced) but <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> now available <span class="keywordflow">for</span> another
00061     user to open (i.e., as far as the user is concerned the is now closed).
00062 
00063     See close <span class="keywordflow">for</span> a more complete description of what close does.
00064 
00065     We <span class="keywordflow">do</span> no synchronization in <span class="keyword">this</span> routine until we get to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> point
00066     where we modify <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> counts, share access and volume lock field.
00067 
00068     We need to update <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Fcb and Vcb to show that a user handle has been closed.
00069     The following structures and fields are affected.
00070 
00071     Vcb:
00072 
00073         VolumeLockFileObject - Did <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user lock <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> volume with <span class="keyword">this</span> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object.
00074         VcbState - Check <span class="keywordflow">if</span> we are unlocking <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> volume here.
00075         VcbCleanup - <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> of outstanding handles on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> volume.
00076         DirNotifyQueue - If <span class="keyword">this</span> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object has pending DirNotify Irps.
00077 
00078     Fcb:
00079 
00080         ShareAccess - If <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a user handle.
00081         FcbCleanup - <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> of outstanding handles on <span class="keyword">this</span> Fcb.
00082         Oplock - Any outstanding oplocks on <span class="keyword">this</span> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object.
00083         FileLock - Any outstanding filelocks on <span class="keyword">this</span> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object.
00084 
00085 Arguments:
00086 
00087     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> to process
00088 
00089 Return Value:
00090 
00091     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - The <span class="keywordflow">return</span> status <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation.
00092 
00093 --*/
00094 
00095 {
00096     <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject;
00097     <a class="code" href="../../d3/d8/udfprocs_8h.html#a109">TYPE_OF_OPEN</a> TypeOfOpen;
00098 
00099     BOOLEAN SendUnlockNotification = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00100     BOOLEAN AttemptTeardown;
00101 
00102     <a class="code" href="../../d7/d5/struct__VCB.html">PVCB</a> Vcb;
00103     <a class="code" href="../../d7/d9/struct__FCB.html">PFCB</a> Fcb;
00104     <a class="code" href="../../d2/d9/struct__CCB.html">PCCB</a> Ccb;
00105 
00106     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00107 
00108     <a class="code" href="../../d1/d8/udfdata_8h.html#a28">ASSERT_IRP_CONTEXT</a>( IrpContext );
00109     <a class="code" href="../../d1/d8/udfdata_8h.html#a32">ASSERT_IRP</a>( Irp );
00110 
00111     <span class="comment">//</span>
00112     <span class="comment">//  If we were called with our file system device object instead of a</span>
00113     <span class="comment">//  volume device object, just complete this request with STATUS_SUCCESS.</span>
00114     <span class="comment">//</span>
00115 
00116     <span class="keywordflow">if</span> (IrpContext-&gt;Vcb == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00117 
00118         <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, Irp, STATUS_SUCCESS );
00119         <span class="keywordflow">return</span> STATUS_SUCCESS;
00120     }
00121 
00122     <span class="comment">//</span>
00123     <span class="comment">//  Get the file object out of the Irp and decode the type of open.</span>
00124     <span class="comment">//</span>
00125 
00126     FileObject = <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>( Irp )-&gt;FileObject;
00127 
00128     TypeOfOpen = <a class="code" href="../../d3/d8/udfprocs_8h.html#a174">UdfDecodeFileObject</a>( FileObject,
00129                                       &amp;Fcb,
00130                                       &amp;Ccb );
00131 
00132     <span class="comment">//</span>
00133     <span class="comment">//  No work here for either an UnopenedFile object or a StreamFileObject.</span>
00134     <span class="comment">//</span>
00135 
00136     <span class="keywordflow">if</span> (TypeOfOpen &lt;= <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a114">StreamFileOpen</a>) {
00137 
00138         <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, Irp, STATUS_SUCCESS );
00139 
00140         <span class="keywordflow">return</span> STATUS_SUCCESS;
00141     }
00142 
00143     <span class="comment">//</span>
00144     <span class="comment">//  Keep a local pointer to the Vcb.</span>
00145     <span class="comment">//</span>
00146 
00147     Vcb = Fcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o2">Vcb</a>;
00148 
00149     <span class="comment">//</span>
00150     <span class="comment">//  Acquire the current file.</span>
00151     <span class="comment">//</span>
00152 
00153     <a class="code" href="../../d3/d8/udfprocs_8h.html#a83">UdfAcquireFcbExclusive</a>( IrpContext, Fcb, FALSE );
00154 
00155     <span class="comment">//</span>
00156     <span class="comment">//  Use a try-finally to facilitate cleanup.</span>
00157     <span class="comment">//</span>
00158 
00159     <span class="keywordflow">try</span> {
00160 
00161         <span class="comment">//</span>
00162         <span class="comment">//  Set the flag in the FileObject to indicate that cleanup is complete.</span>
00163         <span class="comment">//</span>
00164 
00165         <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( FileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o18">Flags</a>, FO_CLEANUP_COMPLETE );
00166 
00167         <span class="comment">//</span>
00168         <span class="comment">//  Case on the type of open that we are trying to cleanup.</span>
00169         <span class="comment">//</span>
00170 
00171         <span class="keywordflow">switch</span> (TypeOfOpen) {
00172 
00173         <span class="keywordflow">case</span> <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a116">UserDirectoryOpen</a>:
00174 
00175             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( +1, Dbg,
00176                          <span class="stringliteral">"UdfCommonCleanup, Fcb %08x FO %08x DIR\n"</span>,
00177                          Fcb,
00178                          FileObject ));
00179             
00180             <span class="comment">//</span>
00181             <span class="comment">//  Check if we need to complete any dir notify Irps on this file object.</span>
00182             <span class="comment">//</span>
00183 
00184             <a class="code" href="../../d1/d8/fsrtl_8h.html#a175">FsRtlNotifyCleanup</a>( Vcb-&gt;<a class="code" href="../../d7/d5/struct__VCB.html#o29">NotifySync</a>,
00185                                 &amp;Vcb-&gt;<a class="code" href="../../d7/d5/struct__VCB.html#o30">DirNotifyList</a>,
00186                                 Ccb );
00187 
00188             <span class="keywordflow">break</span>;
00189 
00190         <span class="keywordflow">case</span> <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a117">UserFileOpen</a>:
00191 
00192             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( +1, Dbg,
00193                          <span class="stringliteral">"UdfCommonCleanup, Fcb %08x FO %08x FILE\n"</span>,
00194                          Fcb,
00195                          FileObject ));
00196             
00197             <span class="comment">//</span>
00198             <span class="comment">//  Coordinate the cleanup operation with the oplock state.</span>
00199             <span class="comment">//  Oplock cleanup operations can always cleanup immediately so no</span>
00200             <span class="comment">//  need to check for STATUS_PENDING.</span>
00201             <span class="comment">//</span>
00202 
00203             <a class="code" href="../../d1/d8/fsrtl_8h.html#a165">FsRtlCheckOplock</a>( &amp;Fcb-&gt;Oplock,
00204                               Irp,
00205                               IrpContext,
00206                               NULL,
00207                               NULL );
00208 
00209             <span class="comment">//</span>
00210             <span class="comment">//  Unlock all outstanding file locks.</span>
00211             <span class="comment">//</span>
00212 
00213             <span class="keywordflow">if</span> (Fcb-&gt;FileLock != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00214 
00215                 <a class="code" href="../../d1/d8/fsrtl_8h.html#a123">FsRtlFastUnlockAll</a>( Fcb-&gt;FileLock,
00216                                     FileObject,
00217                                     <a class="code" href="../../d0/d5/io_8h.html#a512">IoGetRequestorProcess</a>( Irp ),
00218                                     NULL );
00219             }
00220 
00221             <span class="comment">//</span>
00222             <span class="comment">//  Cleanup the cache map.</span>
00223             <span class="comment">//</span>
00224 
00225             <a class="code" href="../../d4/d2/cache_8h.html#a59">CcUninitializeCacheMap</a>( FileObject, NULL, NULL );
00226 
00227             <span class="comment">//</span>
00228             <span class="comment">//  Check the fast io state.</span>
00229             <span class="comment">//</span>
00230 
00231             <a class="code" href="../../d3/d8/udfprocs_8h.html#a90">UdfLockFcb</a>( IrpContext, Fcb );
00232             Fcb-&gt;IsFastIoPossible = <a class="code" href="../../d3/d8/udfprocs_8h.html#a63">UdfIsFastIoPossible</a>( Fcb );
00233             <a class="code" href="../../d3/d8/udfprocs_8h.html#a91">UdfUnlockFcb</a>( IrpContext, Fcb );
00234 
00235             <span class="keywordflow">break</span>;
00236 
00237         <span class="keywordflow">case</span> <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a115">UserVolumeOpen</a> :
00238 
00239             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( +1, Dbg,
00240                          <span class="stringliteral">"UdfCommonCleanup, Fcb %08x FO %08x VOL\n"</span>,
00241                          Fcb,
00242                          FileObject ));
00243 
00244             <span class="keywordflow">break</span>;
00245 
00246         <span class="keywordflow">default</span> :
00247 
00248             <a class="code" href="../../d1/d7/udfs_2nodetype_8h.html#a66">UdfBugCheck</a>( TypeOfOpen, 0, 0 );
00249         }
00250 
00251         <span class="comment">//</span>
00252         <span class="comment">//  Now lock the Vcb in order to modify the fields in the in-memory</span>
00253         <span class="comment">//  structures.</span>
00254         <span class="comment">//</span>
00255 
00256         <a class="code" href="../../d3/d8/udfprocs_8h.html#a88">UdfLockVcb</a>( IrpContext, Vcb );
00257 
00258         <span class="comment">//</span>
00259         <span class="comment">//  Decrement the cleanup counts in the Vcb and Fcb.</span>
00260         <span class="comment">//</span>
00261 
00262         <a class="code" href="../../d3/d8/udfprocs_8h.html#a97">UdfDecrementCleanupCounts</a>( IrpContext, Fcb );
00263 
00264         <span class="comment">//</span>
00265         <span class="comment">//  If the cleanup count hit zero and the volume is not mounted, we</span>
00266         <span class="comment">//  will want to try to spark teardown.</span>
00267         <span class="comment">//</span>
00268 
00269         AttemptTeardown = (Vcb-&gt;<a class="code" href="../../d7/d5/struct__VCB.html#o15">VcbCleanup</a> == 0 &amp;&amp; Vcb-&gt;<a class="code" href="../../d7/d5/struct__VCB.html#o8">VcbCondition</a> == <a class="code" href="../../d6/d8/udfstruc_8h.html#a130a117">VcbNotMounted</a>);
00270         
00271         <span class="comment">//</span>
00272         <span class="comment">//  If this file object has locked the volume then perform the unlock operation.</span>
00273         <span class="comment">//</span>
00274 
00275         <span class="keywordflow">if</span> (FileObject == Vcb-&gt;<a class="code" href="../../d7/d5/struct__VCB.html#o9">VolumeLockFileObject</a>) {
00276 
00277             <a class="code" href="../../d5/d5/cc_8h.html#a61">ClearFlag</a>( Vcb-&gt;<a class="code" href="../../d7/d5/struct__VCB.html#o7">VcbState</a>, VCB_STATE_LOCKED );
00278             Vcb-&gt;<a class="code" href="../../d7/d5/struct__VCB.html#o9">VolumeLockFileObject</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00279             SendUnlockNotification = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00280         }
00281 
00282         <a class="code" href="../../d3/d8/udfprocs_8h.html#a89">UdfUnlockVcb</a>( IrpContext, Vcb );
00283 
00284         <span class="comment">//</span>
00285         <span class="comment">//  We must clean up the share access at this time, since we may not</span>
00286         <span class="comment">//  get a Close call for awhile if the file was mapped through this</span>
00287         <span class="comment">//  File Object.</span>
00288         <span class="comment">//</span>
00289 
00290         <a class="code" href="../../d4/d6/iosubs_8c.html#a103">IoRemoveShareAccess</a>( FileObject, &amp;Fcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o18">ShareAccess</a> );
00291 
00292     } finally {
00293 
00294         <a class="code" href="../../d3/d8/udfprocs_8h.html#a85">UdfReleaseFcb</a>( IrpContext, Fcb );
00295 
00296         <span class="keywordflow">if</span> (SendUnlockNotification) {
00297 
00298             <a class="code" href="../../d1/d8/fsrtl_8h.html#a168">FsRtlNotifyVolumeEvent</a>( FileObject, FSRTL_VOLUME_UNLOCK );
00299         }
00300     }
00301 
00302     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( -1, Dbg,
00303                  <span class="stringliteral">"UdfCommonCleanup, Fcb %08x FO %08x -&gt; SUCCESS\n"</span>,
00304                  Fcb,
00305                  FileObject ));
00306     
00307     <span class="comment">//</span>
00308     <span class="comment">//  If appropriate, try to spark teardown by purging the volume.  Should</span>
00309     <span class="comment">//  this very fileobject we were cleaning up be the last reason for the</span>
00310     <span class="comment">//  volume to remain, teardown will commence on completion of this Irp.</span>
00311     <span class="comment">//</span>
00312     
00313     <span class="keywordflow">if</span> (AttemptTeardown) {
00314 
00315         <a class="code" href="../../d3/d8/udfprocs_8h.html#a74">UdfAcquireVcbExclusive</a>( IrpContext, Vcb, FALSE );
00316 
00317         <span class="keywordflow">try</span> {
00318             
00319             <a class="code" href="../../d3/d8/udfprocs_8h.html#a158">UdfPurgeVolume</a>( IrpContext, Vcb, FALSE );
00320 
00321         } finally {
00322 
00323             <a class="code" href="../../d3/d8/udfprocs_8h.html#a76">UdfReleaseVcb</a>( IrpContext, Vcb );
00324         }
00325     }
00326 
00327     <span class="comment">//</span>
00328     <span class="comment">//  If this is a normal termination then complete the request</span>
00329     <span class="comment">//</span>
00330 
00331     <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, Irp, STATUS_SUCCESS );
00332 
00333     <span class="keywordflow">return</span> STATUS_SUCCESS;
00334 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a252" doxytag="udfprocs.h::UdfCommonClose" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS UdfCommonClose           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d8/close_8c-source.html#l00319">319</a> of file <a class="el" href="../../d3/d8/close_8c-source.html">close.c</a>.
<p>
References <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00356">ASSERT_IRP</a>, <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00352">ASSERT_IRP_CONTEXT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00979">_FCB::FcbReference</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03252">IoGetCurrentIrpStackLocation</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01238">IRP_CONTEXT_FLAG_TOP_LEVEL_UDFS</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d3/d8/udfprocs_8h.html#a109">TYPE_OF_OPEN</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01509">UdfAcquireUdfData</a>, <a class="el" href="../../d9/d4/udfs_2verfysup_8c-source.html#l00236">UdfCheckForDismount()</a>, <a class="el" href="../../d3/d8/close_8c-source.html#l00498">UdfCommonClosePrivate()</a>, <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00809">UdfCompleteRequest()</a>, <a class="el" href="../../d7/d2/filobsup_8c-source.html#l00133">UdfDecodeFileObject()</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l02510">UdfDeleteCcb()</a>, <a class="el" href="../../d3/d8/close_8c-source.html#l00634">UdfQueueClose()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01512">UdfReleaseUdfData</a>, <a class="el" href="../../d3/d8/udfprocs_8h.html#a263a113">UnopenedFileObject</a>, <a class="el" href="../../d3/d8/udfprocs_8h.html#a263a116">UserDirectoryOpen</a>, <a class="el" href="../../d3/d8/udfprocs_8h.html#a263a117">UserFileOpen</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00941">_FCB::Vcb</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00611">_VCB::VcbCleanup</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00559">_VCB::VcbCondition</a>, <a class="el" href="../../d6/d8/udfstruc_8h.html#a130a119">VcbMounted</a>, and <a class="el" href="../../d6/d8/udfstruc_8h.html#a130a118">VcbMountInProgress</a>.
<p>
Referenced by <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00218">UdfFsdDispatch()</a>.
<p>
<pre class="fragment"><div>00326                    :
00327 
00328     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Fsd entry <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> close operation.  We decode <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>
00329     object to find <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> UDFS structures and <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of open.  We call our internal
00330     worker routine to perform <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> actual work.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> work wasn'<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> completed
00331     then we post to one of our worker queues.  The Ccb isn'<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> needed after <span class="keyword">this</span>
00332     point so we <span class="keyword">delete</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Ccb and <span class="keywordflow">return</span> STATUS_SUCCESS to our caller in all
00333     cases.
00334 
00335 Arguments:
00336 
00337     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> to process
00338 
00339 Return Value:
00340 
00341     STATUS_SUCCESS
00342 
00343 --*/
00344 
00345 {
00346     <a class="code" href="../../d3/d8/udfprocs_8h.html#a109">TYPE_OF_OPEN</a> TypeOfOpen;
00347 
00348     <a class="code" href="../../d7/d5/struct__VCB.html">PVCB</a> Vcb;
00349     <a class="code" href="../../d7/d9/struct__FCB.html">PFCB</a> Fcb;
00350     <a class="code" href="../../d2/d9/struct__CCB.html">PCCB</a> Ccb;
00351     ULONG UserReference = 0;
00352 
00353     BOOLEAN DelayedClose;
00354     BOOLEAN ReleaseUdfData = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00355 
00356     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00357 
00358     <span class="comment">//</span>
00359     <span class="comment">//  Check input.</span>
00360     <span class="comment">//</span>
00361 
00362     <a class="code" href="../../d1/d8/udfdata_8h.html#a28">ASSERT_IRP_CONTEXT</a>( IrpContext );
00363     <a class="code" href="../../d1/d8/udfdata_8h.html#a32">ASSERT_IRP</a>( Irp );
00364 
00365     <span class="comment">//</span>
00366     <span class="comment">//  If we were called with our file system device object instead of a</span>
00367     <span class="comment">//  volume device object, just complete this request with STATUS_SUCCESS.</span>
00368     <span class="comment">//</span>
00369 
00370     <span class="keywordflow">if</span> (IrpContext-&gt;Vcb == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00371 
00372         <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, Irp, STATUS_SUCCESS );
00373         <span class="keywordflow">return</span> STATUS_SUCCESS;
00374     }
00375 
00376     <span class="comment">//</span>
00377     <span class="comment">//  Decode the file object to get the type of open and Fcb/Ccb.</span>
00378     <span class="comment">//</span>
00379 
00380     TypeOfOpen = <a class="code" href="../../d3/d8/udfprocs_8h.html#a174">UdfDecodeFileObject</a>( <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>( Irp )-&gt;FileObject,
00381                                       &amp;Fcb,
00382                                       &amp;Ccb );
00383 
00384     <span class="comment">//</span>
00385     <span class="comment">//  No work to do for unopened file objects.</span>
00386     <span class="comment">//</span>
00387 
00388     <span class="keywordflow">if</span> (TypeOfOpen == <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a113">UnopenedFileObject</a>) {
00389 
00390         <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, Irp, STATUS_SUCCESS );
00391 
00392         <span class="keywordflow">return</span> STATUS_SUCCESS;
00393     }
00394 
00395     Vcb = Fcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o2">Vcb</a>;
00396 
00397     <span class="comment">//</span>
00398     <span class="comment">//  Call the worker routine to perform the actual work.  This routine</span>
00399     <span class="comment">//  should never raise except for a fatal error.</span>
00400     <span class="comment">//</span>
00401 
00402     <span class="keywordflow">if</span> (Ccb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00403 
00404         UserReference = 1;
00405 
00406         <span class="comment">//</span>
00407         <span class="comment">//  We can always deallocate the Ccb if present.</span>
00408         <span class="comment">//</span>
00409 
00410         <a class="code" href="../../d3/d8/udfprocs_8h.html#a217">UdfDeleteCcb</a>( IrpContext, Ccb );
00411     }
00412 
00413     <span class="comment">//</span>
00414     <span class="comment">//  If this is a user file or directory then check if we should post</span>
00415     <span class="comment">//  this to the delayed close queue.  This has to be the last reference</span>
00416     <span class="comment">//  for a user file or directory open.</span>
00417     <span class="comment">//</span>
00418 
00419     <span class="keywordflow">if</span> ((Vcb-&gt;<a class="code" href="../../d7/d5/struct__VCB.html#o8">VcbCondition</a> == <a class="code" href="../../d6/d8/udfstruc_8h.html#a130a119">VcbMounted</a>) &amp;&amp;
00420         (Fcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o8">FcbReference</a> == 1) &amp;&amp;
00421         ((TypeOfOpen == <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a117">UserFileOpen</a>) ||
00422          (TypeOfOpen == <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a116">UserDirectoryOpen</a>))) {
00423 
00424         <a class="code" href="../../d2/d9/close_8c.html#a3">UdfQueueClose</a>( IrpContext, Fcb, UserReference, TRUE );
00425         IrpContext = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00426 
00427     <span class="comment">//</span>
00428     <span class="comment">//  Otherwise try to process this close.  Post to the async close queue</span>
00429     <span class="comment">//  if we can't acquire all of the resources.</span>
00430     <span class="comment">//</span>
00431 
00432     } <span class="keywordflow">else</span> {
00433 
00434         <span class="comment">//</span>
00435         <span class="comment">//  If we may be dismounting this volume then acquire the UdfData</span>
00436         <span class="comment">//  resource.</span>
00437         <span class="comment">//</span>
00438         <span class="comment">//  Since we now must make volumes go away as soon as reasonable after</span>
00439         <span class="comment">//  the last user handles closes, key off of the cleanup count.  It is</span>
00440         <span class="comment">//  OK to do this more than neccesary.  Since this Fcb could be holding</span>
00441         <span class="comment">//  a number of other Fcbs (and thus their references), a simple check</span>
00442         <span class="comment">//  on reference count is not appropriate.</span>
00443         <span class="comment">//</span>
00444 
00445         <span class="keywordflow">if</span> ((Vcb-&gt;<a class="code" href="../../d7/d5/struct__VCB.html#o15">VcbCleanup</a> == 0) &amp;&amp;
00446             (Vcb-&gt;<a class="code" href="../../d7/d5/struct__VCB.html#o8">VcbCondition</a> != <a class="code" href="../../d6/d8/udfstruc_8h.html#a130a119">VcbMounted</a>) &amp;&amp;
00447             (Vcb-&gt;<a class="code" href="../../d7/d5/struct__VCB.html#o8">VcbCondition</a> != <a class="code" href="../../d6/d8/udfstruc_8h.html#a130a118">VcbMountInProgress</a>) &amp;&amp;
00448             <a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpContext-&gt;Flags, IRP_CONTEXT_FLAG_TOP_LEVEL_UDFS )) {
00449 
00450             <a class="code" href="../../d3/d8/udfprocs_8h.html#a72">UdfAcquireUdfData</a>( IrpContext );
00451             ReleaseUdfData = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00452         }
00453 
00454         <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d9/close_8c.html#a2">UdfCommonClosePrivate</a>( IrpContext, Vcb, Fcb, UserReference, TRUE )) {
00455 
00456             <span class="comment">//</span>
00457             <span class="comment">//  If we didn't complete the request then post the request as needed.</span>
00458             <span class="comment">//</span>
00459 
00460             <a class="code" href="../../d2/d9/close_8c.html#a3">UdfQueueClose</a>( IrpContext, Fcb, UserReference, FALSE );
00461             IrpContext = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00462 
00463         <span class="comment">//</span>
00464         <span class="comment">//  Check whether we should be dismounting the volume and then complete</span>
00465         <span class="comment">//  the request.</span>
00466         <span class="comment">//</span>
00467 
00468         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ReleaseUdfData) {
00469 
00470             <a class="code" href="../../d8/d5/udfs_2verfysup_8c.html#a3">UdfCheckForDismount</a>( IrpContext, Vcb, FALSE );
00471         }
00472     }
00473 
00474     <span class="comment">//</span>
00475     <span class="comment">//  Always complete this request with STATUS_SUCCESS.</span>
00476     <span class="comment">//</span>
00477 
00478     <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, Irp, STATUS_SUCCESS );
00479 
00480     <span class="keywordflow">if</span> (ReleaseUdfData) {
00481 
00482         <a class="code" href="../../d3/d8/udfprocs_8h.html#a73">UdfReleaseUdfData</a>( IrpContext );
00483     }
00484 
00485     <span class="comment">//</span>
00486     <span class="comment">//  Always return STATUS_SUCCESS for closes.</span>
00487     <span class="comment">//</span>
00488 
00489     <span class="keywordflow">return</span> STATUS_SUCCESS;
00490 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a253" doxytag="udfprocs.h::UdfCommonCreate" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS UdfCommonCreate           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d7/udfs_2create_8c-source.html#l00108">108</a> of file <a class="el" href="../../d4/d7/udfs_2create_8c-source.html">udfs/create.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00501">BooleanFlagOn</a>, <a class="el" href="../../d6/d8/udfstruc_8h.html#a112">DIR_ENUM_CONTEXT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01646">_DIR_ENUM_CONTEXT::Fid</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00992">_FCB::FileAttributes</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01534">_FILE_OBJECT::FileName</a>, <a class="el" href="../../d3/d1/rtload_8c-source.html#l00047">FileName</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02494">_IO_STACK_LOCATION::FileObject</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d1/d6/iso13346_8h-source.html#l00783">NSR_FID::Flags</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02030">_IO_STACK_LOCATION::Flags</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03252">IoGetCurrentIrpStackLocation</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01249">IRP_CONTEXT_FLAG_TRAIL_BACKSLASH</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01235">IRP_CONTEXT_FLAG_WAIT</a>, <a class="el" href="../../d1/d6/iso13346_8h-source.html#l00811">NSR_FID_F_DIRECTORY</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01665">_DIR_ENUM_CONTEXT::ObjectName</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02069">_IO_STACK_LOCATION::Parameters</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01524">_FILE_OBJECT::RelatedFileObject</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00629">_VCB::RootIndexFcb</a>, <a class="el" href="../../d2/d6/udfs_2nodetype_8h-source.html#l00063">SafeNodeType</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01867">SL_CASE_SENSITIVE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01864">SL_OPEN_PAGING_FILE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01865">SL_OPEN_TARGET_DIRECTORY</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00436">try_leave</a>, <a class="el" href="../../d3/d8/udfprocs_8h.html#a109">TYPE_OF_OPEN</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01542">UdfAcquireFcbExclusive</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01515">UdfAcquireVcbExclusive</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01518">UdfAcquireVcbShared</a>, <a class="el" href="../../d6/d4/namesup_8c-source.html#l00301">UdfCandidateShortName()</a>, <a class="el" href="../../d5/d7/dirsup_8c-source.html#l00099">UdfCleanupDirContext()</a>, <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00809">UdfCompleteRequest()</a>, <a class="el" href="../../d7/d2/filobsup_8c-source.html#l00133">UdfDecodeFileObject()</a>, <a class="el" href="../../d6/d4/namesup_8c-source.html#l00096">UdfDissectName()</a>, <a class="el" href="../../d5/d7/dirsup_8c-source.html#l00726">UdfFindDirEntry()</a>, <a class="el" href="../../d6/d3/prefxsup_8c-source.html#l00324">UdfFindPrefix()</a>, <a class="el" href="../../d5/d7/dirsup_8c-source.html#l00060">UdfInitializeDirContext()</a>, <a class="el" href="../../d4/d7/udfs_2create_8c-source.html#l00809">UdfNormalizeFileNames()</a>, <a class="el" href="../../d4/d7/udfs_2create_8c-source.html#l01522">UdfOpenExistingFcb()</a>, <a class="el" href="../../d4/d7/udfs_2create_8c-source.html#l01244">UdfOpenObjectByFileId()</a>, <a class="el" href="../../d4/d7/udfs_2create_8c-source.html#l01632">UdfOpenObjectFromDirContext()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00406">UdfRaiseStatus()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01548">UdfReleaseFcb</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01521">UdfReleaseVcb</a>, <a class="el" href="../../d2/d6/udfs_2nodetype_8h-source.html#l00038">UDFS_NTC_FCB_DATA</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l01606">UdfTeardownStructures()</a>, <a class="el" href="../../d9/d4/udfs_2verfysup_8c-source.html#l00603">UdfVerifyVcb()</a>, <a class="el" href="../../d3/d8/udfprocs_8h.html#a263a113">UnopenedFileObject</a>, <a class="el" href="../../d3/d8/udfprocs_8h.html#a263a116">UserDirectoryOpen</a>, <a class="el" href="../../d3/d8/udfprocs_8h.html#a263a117">UserFileOpen</a>, <a class="el" href="../../d3/d8/udfprocs_8h.html#a263a115">UserVolumeOpen</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00683">VCB_STATE_LOCKED</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00558">_VCB::VcbState</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00628">_VCB::VolumeDasdFcb</a>, and <a class="el" href="../../d1/d4/io_8h-source.html#l01518">_FILE_OBJECT::Vpb</a>.
<p>
Referenced by <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00218">UdfFsdDispatch()</a>, and <a class="el" href="../../d1/d7/fspdisp_8c-source.html#l00038">UdfFspDispatch()</a>.
<p>
<pre class="fragment"><div>00115                    :
00116 
00117     This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> common routine <span class="keywordflow">for</span> opening a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> called by both <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00118     Fsp and Fsd threads.
00119 
00120     The <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> can be opened either by name or by <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> Id either with or without
00121     a relative name.  The <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> name field in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object passed to <span class="keyword">this</span> routine
00122     contains either a unicode string or a 64 bit value which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> Id.
00123     If there <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a related <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object with a name then we will already have converted
00124     that name to Oem. 
00125 
00126     We will store <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> full name <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object on a successful
00127     open.  We will allocate a larger buffer <span class="keywordflow">if</span> necessary and combine <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00128     related and <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object names.  The <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> exception <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> relative open
00129     when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> related <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <span class="keywordflow">for</span> an OpenByFileId <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.  If we need to
00130     allocate a buffer <span class="keywordflow">for</span> a <span class="keywordflow">case</span> insensitive name then we allocate <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> at
00131     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> tail of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer we will store into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object.  The upcased
00132     portion will begin immediately after <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name defined by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>
00133     in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object.
00134 
00135     Once we have <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> full name in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object we don'<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> want to split <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00136     name in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> event of a retry.  We use a flag in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> IrpContext to indicate
00137     that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name has been split.
00138 
00139 Arguments:
00140 
00141     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> to process
00142 
00143 Return Value:
00144 
00145     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> status from <span class="keyword">this</span> open operation.
00146 
00147 --*/
00148 
00149 {
00150     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00151     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp = <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>( Irp );
00152 
00153     <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject;
00154 
00155     <a class="code" href="../../d5/d5/struct__DIR__ENUM__CONTEXT.html">DIR_ENUM_CONTEXT</a> DirContext;
00156     BOOLEAN CleanupDirContext = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00157 
00158     BOOLEAN FoundEntry;
00159 
00160     <a class="code" href="../../d7/d5/struct__VCB.html">PVCB</a> Vcb;
00161 
00162     BOOLEAN OpenByFileId;
00163     BOOLEAN IgnoreCase;
00164     ULONG CreateDisposition;
00165 
00166     BOOLEAN ShortNameMatch;
00167 
00168     BOOLEAN VolumeOpen = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00169 
00170     <span class="comment">//</span>
00171     <span class="comment">//  We will be acquiring and releasing file Fcb's as we move down the</span>
00172     <span class="comment">//  directory tree during opens.  At any time we need to know the deepest</span>
00173     <span class="comment">//  point we have traversed down in the tree in case we need to cleanup</span>
00174     <span class="comment">//  any structures created here.</span>
00175     <span class="comment">//</span>
00176     <span class="comment">//  CurrentFcb - represents this point.  If non-null it means we have</span>
00177     <span class="comment">//      acquired it and need to release it in finally clause.</span>
00178     <span class="comment">//</span>
00179     <span class="comment">//  NextFcb - represents the NextFcb to walk to but haven't acquired yet.</span>
00180     <span class="comment">//</span>
00181     <span class="comment">//  CurrentLcb - represents the name of the CurrentFcb.</span>
00182     <span class="comment">//</span>
00183 
00184     <a class="code" href="../../d3/d8/udfprocs_8h.html#a109">TYPE_OF_OPEN</a> RelatedTypeOfOpen = <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a113">UnopenedFileObject</a>;
00185     <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> RelatedFileObject;
00186     <a class="code" href="../../d2/d9/struct__CCB.html">PCCB</a> RelatedCcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00187 
00188     <a class="code" href="../../d7/d9/struct__FCB.html">PFCB</a> NextFcb;
00189     <a class="code" href="../../d7/d9/struct__FCB.html">PFCB</a> CurrentFcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00190 
00191     <a class="code" href="../../d5/d9/struct__LCB.html">PLCB</a> CurrentLcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00192 
00193     <span class="comment">//</span>
00194     <span class="comment">//  During the open we need to combine the related file object name</span>
00195     <span class="comment">//  with the remaining name.  We also may need to upcase the file name</span>
00196     <span class="comment">//  in order to do a case-insensitive name comparison.  We also need</span>
00197     <span class="comment">//  to restore the name in the file object in the event that we retry</span>
00198     <span class="comment">//  the request.  We use the following string variables to manage the</span>
00199     <span class="comment">//  name.  We will can put these strings into either Unicode or Ansi</span>
00200     <span class="comment">//  form.</span>
00201     <span class="comment">//</span>
00202     <span class="comment">//  FileName - Pointer to name as currently stored in the file</span>
00203     <span class="comment">//      object.  We store the full name into the file object early in</span>
00204     <span class="comment">//      the open operation.</span>
00205     <span class="comment">//</span>
00206     <span class="comment">//  RelatedFileName - Pointer to the name in the related file object.</span>
00207     <span class="comment">//</span>
00208     <span class="comment">//  RemainingName - String containing remaining name to parse.</span>
00209     <span class="comment">//</span>
00210 
00211     PUNICODE_STRING <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>;
00212     PUNICODE_STRING RelatedFileName;
00213 
00214     UNICODE_STRING RemainingName;
00215     UNICODE_STRING FinalName;
00216 
00217     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00218 
00219     <span class="comment">//</span>
00220     <span class="comment">//  If we were called with our file system device object instead of a</span>
00221     <span class="comment">//  volume device object, just complete this request with STATUS_SUCCESS.</span>
00222     <span class="comment">//</span>
00223 
00224     <span class="keywordflow">if</span> (IrpContext-&gt;Vcb == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00225 
00226         <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, Irp, STATUS_SUCCESS );
00227         <span class="keywordflow">return</span> STATUS_SUCCESS;
00228     }
00229 
00230     <span class="comment">//</span>
00231     <span class="comment">//  Get create parameters from the Irp.</span>
00232     <span class="comment">//</span>
00233 
00234     OpenByFileId = <a class="code" href="../../d5/d5/cc_8h.html#a59">BooleanFlagOn</a>( IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.Create.Options, FILE_OPEN_BY_FILE_ID );
00235     IgnoreCase = !<a class="code" href="../../d5/d5/cc_8h.html#a59">BooleanFlagOn</a>( IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o2">Flags</a>, SL_CASE_SENSITIVE );
00236     CreateDisposition = (IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.Create.Options &gt;&gt; 24) &amp; 0x000000ff;
00237 
00238     <span class="comment">//</span>
00239     <span class="comment">//  Do some preliminary checks to make sure the operation is supported.</span>
00240     <span class="comment">//  We fail in the following cases immediately.</span>
00241     <span class="comment">//</span>
00242     <span class="comment">//      - Open a paging file.</span>
00243     <span class="comment">//      - Open a target directory.</span>
00244     <span class="comment">//      - Open a file with Eas.</span>
00245     <span class="comment">//      - Create a file.</span>
00246     <span class="comment">//</span>
00247 
00248     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o2">Flags</a>, SL_OPEN_PAGING_FILE | SL_OPEN_TARGET_DIRECTORY) ||
00249         (IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.Create.EaLength != 0) ||
00250         (CreateDisposition == FILE_CREATE)) {
00251 
00252         <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, Irp, STATUS_ACCESS_DENIED );
00253         <span class="keywordflow">return</span> STATUS_ACCESS_DENIED;
00254     }
00255 
00256     <span class="comment">//</span>
00257     <span class="comment">//  Copy the Vcb to a local.  Assume the starting directory is the root.</span>
00258     <span class="comment">//</span>
00259 
00260     Vcb = IrpContext-&gt;Vcb;
00261     NextFcb = Vcb-&gt;<a class="code" href="../../d7/d5/struct__VCB.html#o21">RootIndexFcb</a>;
00262 
00263     <span class="comment">//</span>
00264     <span class="comment">//  Reference our input parameters to make things easier</span>
00265     <span class="comment">//</span>
00266 
00267     FileObject = IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a>;
00268     RelatedFileObject = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00269 
00270     <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a> = &amp;FileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o19">FileName</a>;
00271 
00272     <span class="comment">//</span>
00273     <span class="comment">//  Set up the file object's Vpb pointer in case anything happens.</span>
00274     <span class="comment">//  This will allow us to get a reasonable pop-up.</span>
00275     <span class="comment">//</span>
00276 
00277     <span class="keywordflow">if</span> ((FileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o9">RelatedFileObject</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; !OpenByFileId) {
00278 
00279         RelatedFileObject = FileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o9">RelatedFileObject</a>;
00280         FileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o3">Vpb</a> = RelatedFileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o3">Vpb</a>;
00281 
00282         RelatedTypeOfOpen = <a class="code" href="../../d3/d8/udfprocs_8h.html#a174">UdfDecodeFileObject</a>( RelatedFileObject, &amp;NextFcb, &amp;RelatedCcb );
00283 
00284         <span class="comment">//</span>
00285         <span class="comment">//  Fail the request if this is not a user file object.</span>
00286         <span class="comment">//</span>
00287 
00288         <span class="keywordflow">if</span> (RelatedTypeOfOpen &lt; <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a115">UserVolumeOpen</a>) {
00289 
00290             <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, Irp, STATUS_INVALID_PARAMETER );
00291             <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00292         }
00293 
00294         <span class="comment">//</span>
00295         <span class="comment">//  Remember the name in the related file object.</span>
00296         <span class="comment">//</span>
00297 
00298         RelatedFileName = &amp;RelatedFileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o19">FileName</a>;
00299     }
00300 
00301     <span class="comment">//</span>
00302     <span class="comment">//  If we haven't initialized the names then make sure the strings are valid.</span>
00303     <span class="comment">//  If this an OpenByFileId then verify the file id buffer.</span>
00304     <span class="comment">//</span>
00305     <span class="comment">//  After this routine returns we know that the full name is in the</span>
00306     <span class="comment">//  FileName buffer and the buffer will hold the upcased portion</span>
00307     <span class="comment">//  of the name yet to parse immediately after the full name in the</span>
00308     <span class="comment">//  buffer.  Any trailing backslash has been removed and the flag</span>
00309     <span class="comment">//  in the IrpContext will indicate whether we removed the</span>
00310     <span class="comment">//  backslash.</span>
00311     <span class="comment">//</span>
00312 
00313     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d8/udfs_2create_8c.html#a2">UdfNormalizeFileNames</a>( IrpContext,
00314                                     Vcb,
00315                                     OpenByFileId,
00316                                     IgnoreCase,
00317                                     RelatedTypeOfOpen,
00318                                     RelatedCcb,
00319                                     RelatedFileName,
00320                                     FileName,
00321                                     &amp;RemainingName );
00322 
00323     <span class="comment">//</span>
00324     <span class="comment">//  Return the error code if not successful.</span>
00325     <span class="comment">//</span>
00326 
00327     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00328 
00329         <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, Irp, Status );
00330         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00331     }
00332 
00333     <span class="comment">//</span>
00334     <span class="comment">//  We want to acquire the Vcb.  Exclusively for a volume open, shared otherwise.</span>
00335     <span class="comment">//  The file name is empty for a volume open.</span>
00336     <span class="comment">//</span>
00337 
00338     <span class="keywordflow">if</span> ((<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Length == 0) &amp;&amp;
00339         (RelatedTypeOfOpen &lt;= <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a115">UserVolumeOpen</a>) &amp;&amp;
00340         !OpenByFileId) {
00341 
00342         VolumeOpen = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00343         <a class="code" href="../../d3/d8/udfprocs_8h.html#a74">UdfAcquireVcbExclusive</a>( IrpContext, Vcb, FALSE );
00344 
00345     } <span class="keywordflow">else</span> {
00346 
00347         <a class="code" href="../../d3/d8/udfprocs_8h.html#a75">UdfAcquireVcbShared</a>( IrpContext, Vcb, FALSE );
00348     }
00349 
00350     <span class="comment">//</span>
00351     <span class="comment">//  Use a try-finally to facilitate cleanup.</span>
00352     <span class="comment">//</span>
00353 
00354     <span class="keywordflow">try</span> {
00355 
00356         <span class="comment">//</span>
00357         <span class="comment">//  Verify that the Vcb is not in an unusable condition.  This routine</span>
00358         <span class="comment">//  will raise if not usable.</span>
00359         <span class="comment">//</span>
00360 
00361         <a class="code" href="../../d8/d5/udfs_2verfysup_8c.html#a5">UdfVerifyVcb</a>( IrpContext, Vcb );
00362 
00363         <span class="comment">//</span>
00364         <span class="comment">//  If the Vcb is locked then we cannot open another file</span>
00365         <span class="comment">//</span>
00366 
00367         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Vcb-&gt;<a class="code" href="../../d7/d5/struct__VCB.html#o7">VcbState</a>, VCB_STATE_LOCKED )) {
00368 
00369             <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( Status = STATUS_ACCESS_DENIED );
00370         }
00371 
00372         <span class="comment">//</span>
00373         <span class="comment">//  If we are opening this file by FileId then process this immediately</span>
00374         <span class="comment">//  and exit.</span>
00375         <span class="comment">//</span>
00376 
00377         <span class="keywordflow">if</span> (OpenByFileId) {
00378 
00379             <span class="comment">//</span>
00380             <span class="comment">//  The only create disposition we allow is OPEN.</span>
00381             <span class="comment">//</span>
00382 
00383             <span class="keywordflow">if</span> ((CreateDisposition != FILE_OPEN) &amp;&amp;
00384                 (CreateDisposition != FILE_OPEN_IF)) {
00385 
00386                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( Status = STATUS_ACCESS_DENIED );
00387             }
00388 
00389             <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( Status = <a class="code" href="../../d3/d8/udfs_2create_8c.html#a4">UdfOpenObjectByFileId</a>( IrpContext,
00390                                                        IrpSp,
00391                                                        Vcb,
00392                                                        &amp;CurrentFcb ));
00393         }
00394 
00395         <span class="comment">//</span>
00396         <span class="comment">//  If we are opening this volume Dasd then process this immediately</span>
00397         <span class="comment">//  and exit.</span>
00398         <span class="comment">//</span>
00399 
00400         <span class="keywordflow">if</span> (VolumeOpen) {
00401 
00402             <span class="comment">//</span>
00403             <span class="comment">//  The only create disposition we allow is OPEN.</span>
00404             <span class="comment">//</span>
00405 
00406             <span class="keywordflow">if</span> ((CreateDisposition != FILE_OPEN) &amp;&amp;
00407                 (CreateDisposition != FILE_OPEN_IF)) {
00408 
00409                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( Status = STATUS_ACCESS_DENIED );
00410             }
00411 
00412             <span class="comment">//</span>
00413             <span class="comment">//  If they wanted to open a directory, surprise.</span>
00414             <span class="comment">//</span>
00415             
00416             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.Create.Options, FILE_DIRECTORY_FILE )) {
00417 
00418                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( Status = STATUS_NOT_A_DIRECTORY );
00419             }
00420 
00421             <span class="comment">//</span>
00422             <span class="comment">//  Acquire the Fcb first.</span>
00423             <span class="comment">//</span>
00424 
00425             CurrentFcb = Vcb-&gt;<a class="code" href="../../d7/d5/struct__VCB.html#o20">VolumeDasdFcb</a>;
00426             <a class="code" href="../../d3/d8/udfprocs_8h.html#a83">UdfAcquireFcbExclusive</a>( IrpContext, CurrentFcb, FALSE );
00427 
00428             <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( Status = <a class="code" href="../../d3/d8/udfs_2create_8c.html#a3">UdfOpenExistingFcb</a>( IrpContext,
00429                                                     IrpSp,
00430                                                     &amp;CurrentFcb,
00431                                                     NULL,
00432                                                     UserVolumeOpen,
00433                                                     FALSE,
00434                                                     NULL ));
00435         }
00436 
00437         <span class="comment">//</span>
00438         <span class="comment">//  Acquire the Fcb at the beginning of our search to keep it from being</span>
00439         <span class="comment">//  deleted beneath us.</span>
00440         <span class="comment">//</span>
00441 
00442         <a class="code" href="../../d3/d8/udfprocs_8h.html#a83">UdfAcquireFcbExclusive</a>( IrpContext, NextFcb, FALSE );
00443         CurrentFcb = NextFcb;
00444 
00445         <span class="comment">//</span>
00446         <span class="comment">//  Do a prefix search if there is more of the name to parse.</span>
00447         <span class="comment">//</span>
00448 
00449         <span class="keywordflow">if</span> (RemainingName.Length != 0) {
00450 
00451             <span class="comment">//</span>
00452             <span class="comment">//  Do the prefix search to find the longest matching name.</span>
00453             <span class="comment">//</span>
00454 
00455             CurrentLcb = <a class="code" href="../../d3/d8/udfprocs_8h.html#a192">UdfFindPrefix</a>( IrpContext,
00456                                         &amp;CurrentFcb,
00457                                         &amp;RemainingName,
00458                                         IgnoreCase );
00459         }
00460 
00461         <span class="comment">//</span>
00462         <span class="comment">//  At this point CurrentFcb points at the lowest Fcb in the tree for this</span>
00463         <span class="comment">//  file name, CurrentLcb is that name, and RemainingName is the rest of the</span>
00464         <span class="comment">//  name we have to do any directory traversals for.</span>
00465         <span class="comment">//</span>
00466 
00467         <span class="comment">//</span>
00468         <span class="comment">//  If the remaining name length is zero then we have found our</span>
00469         <span class="comment">//  target.</span>
00470         <span class="comment">//</span>
00471 
00472         <span class="keywordflow">if</span> (RemainingName.Length == 0) {
00473 
00474             <span class="comment">//</span>
00475             <span class="comment">//  If this is a file so verify the user didn't want to open</span>
00476             <span class="comment">//  a directory.</span>
00477             <span class="comment">//</span>
00478 
00479             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d7/udfs_2nodetype_8h.html#a12">SafeNodeType</a>( CurrentFcb ) == <a class="code" href="../../d1/d7/udfs_2nodetype_8h.html#a4">UDFS_NTC_FCB_DATA</a>) {
00480 
00481                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpContext-&gt;Flags, IRP_CONTEXT_FLAG_TRAIL_BACKSLASH ) ||
00482                     <a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.Create.Options, FILE_DIRECTORY_FILE )) {
00483 
00484                     <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( Status = STATUS_NOT_A_DIRECTORY );
00485                 }
00486 
00487                 <span class="comment">//</span>
00488                 <span class="comment">//  The only create disposition we allow is OPEN.</span>
00489                 <span class="comment">//</span>
00490 
00491                 <span class="keywordflow">if</span> ((CreateDisposition != FILE_OPEN) &amp;&amp;
00492                     (CreateDisposition != FILE_OPEN_IF)) {
00493 
00494                     <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( Status = STATUS_ACCESS_DENIED );
00495                 }
00496 
00497                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( Status = <a class="code" href="../../d3/d8/udfs_2create_8c.html#a3">UdfOpenExistingFcb</a>( IrpContext,
00498                                                          IrpSp,
00499                                                          &amp;CurrentFcb,
00500                                                          CurrentLcb,
00501                                                          UserFileOpen,
00502                                                          IgnoreCase,
00503                                                          RelatedCcb ));
00504 
00505             <span class="comment">//</span>
00506             <span class="comment">//  This is a directory.  Verify the user didn't want to open</span>
00507             <span class="comment">//  as a file.</span>
00508             <span class="comment">//</span>
00509 
00510             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.Create.Options, FILE_NON_DIRECTORY_FILE )) {
00511 
00512                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( Status = STATUS_FILE_IS_A_DIRECTORY );
00513 
00514             <span class="comment">//</span>
00515             <span class="comment">//  Open the file as a directory.</span>
00516             <span class="comment">//</span>
00517 
00518             } <span class="keywordflow">else</span> {
00519 
00520                 <span class="comment">//</span>
00521                 <span class="comment">//  The only create disposition we allow is OPEN.</span>
00522                 <span class="comment">//</span>
00523 
00524                 <span class="keywordflow">if</span> ((CreateDisposition != FILE_OPEN) &amp;&amp;
00525                     (CreateDisposition != FILE_OPEN_IF)) {
00526 
00527                     <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( Status = STATUS_ACCESS_DENIED );
00528                 }
00529 
00530                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( Status = <a class="code" href="../../d3/d8/udfs_2create_8c.html#a3">UdfOpenExistingFcb</a>( IrpContext,
00531                                                          IrpSp,
00532                                                          &amp;CurrentFcb,
00533                                                          CurrentLcb,
00534                                                          UserDirectoryOpen,
00535                                                          IgnoreCase,
00536                                                          RelatedCcb ));
00537             }
00538         }
00539 
00540         <span class="comment">//</span>
00541         <span class="comment">//  We have more work to do.  We have a starting Fcb which we own shared.</span>
00542         <span class="comment">//  We also have the remaining name to parse.  Walk through the name</span>
00543         <span class="comment">//  component by component looking for the full name.</span>
00544         <span class="comment">//</span>
00545 
00546         <span class="comment">//</span>
00547         <span class="comment">//  Our starting Fcb better be a directory.</span>
00548         <span class="comment">//</span>
00549 
00550         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( CurrentFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o11">FileAttributes</a>, FILE_ATTRIBUTE_DIRECTORY )) {
00551 
00552             <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( Status = STATUS_OBJECT_PATH_NOT_FOUND );
00553         }
00554 
00555         <span class="comment">//</span>
00556         <span class="comment">//  If we can't wait then post this request.</span>
00557         <span class="comment">//</span>
00558 
00559         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpContext-&gt;Flags, IRP_CONTEXT_FLAG_WAIT )) {
00560 
00561             <a class="code" href="../../d3/d8/udfprocs_8h.html#a122">UdfRaiseStatus</a>( IrpContext, STATUS_CANT_WAIT );
00562         }
00563 
00564         <span class="comment">//</span>
00565         <span class="comment">//  Prepare the enumeration context for use.</span>
00566         <span class="comment">//</span>
00567         
00568         <a class="code" href="../../d3/d8/udfprocs_8h.html#a167">UdfInitializeDirContext</a>( IrpContext, &amp;DirContext );
00569         CleanupDirContext = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00570 
00571         <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00572 
00573             ShortNameMatch = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00574 
00575             <span class="comment">//</span>
00576             <span class="comment">//  Split off the next component from the name.</span>
00577             <span class="comment">//</span>
00578 
00579             <a class="code" href="../../d3/d8/udfprocs_8h.html#a177">UdfDissectName</a>( IrpContext,
00580                             &amp;RemainingName,
00581                             &amp;FinalName );
00582 
00583             <span class="comment">//</span>
00584             <span class="comment">//  Go ahead and look this entry up in the directory.</span>
00585             <span class="comment">//</span>
00586 
00587             FoundEntry = <a class="code" href="../../d3/d8/udfprocs_8h.html#a172">UdfFindDirEntry</a>( IrpContext,
00588                                           CurrentFcb,
00589                                           &amp;FinalName,
00590                                           IgnoreCase,
00591                                           FALSE,
00592                                           &amp;DirContext );
00593 
00594             <span class="comment">//</span>
00595             <span class="comment">//  If we didn't find the entry then check if the current name</span>
00596             <span class="comment">//  is a possible short name.</span>
00597             <span class="comment">//</span>
00598 
00599             <span class="keywordflow">if</span> (!FoundEntry &amp;&amp; <a class="code" href="../../d3/d8/udfprocs_8h.html#a179">UdfCandidateShortName</a>( IrpContext, &amp;FinalName)) {
00600 
00601                 <span class="comment">//</span>
00602                 <span class="comment">//  If the name looks like it could be a short name, try to find</span>
00603                 <span class="comment">//  a matching real directory entry.</span>
00604                 <span class="comment">//</span>
00605 
00606                 ShortNameMatch =
00607                 FoundEntry = <a class="code" href="../../d3/d8/udfprocs_8h.html#a172">UdfFindDirEntry</a>( IrpContext,
00608                                               CurrentFcb,
00609                                               &amp;FinalName,
00610                                               IgnoreCase,
00611                                               TRUE,
00612                                               &amp;DirContext );
00613             }
00614 
00615             <span class="comment">//</span>
00616             <span class="comment">//  If we didn't find a match then check what the caller was trying to do to</span>
00617             <span class="comment">//  determine which error code to return.</span>
00618             <span class="comment">//</span>
00619     
00620             <span class="keywordflow">if</span> (!FoundEntry) {
00621     
00622                 <span class="keywordflow">if</span> ((CreateDisposition == FILE_OPEN) ||
00623                     (CreateDisposition == FILE_OVERWRITE)) {
00624     
00625                     <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( Status = STATUS_OBJECT_NAME_NOT_FOUND );
00626                 }
00627     
00628                 <span class="comment">//</span>
00629                 <span class="comment">//  Any other operation return STATUS_ACCESS_DENIED.</span>
00630                 <span class="comment">//</span>
00631     
00632                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( Status = STATUS_ACCESS_DENIED );
00633             }
00634 
00635             <span class="comment">//</span>
00636             <span class="comment">//  If this is an ignore case open then copy the exact case</span>
00637             <span class="comment">//  in the file object name.</span>
00638             <span class="comment">//</span>
00639 
00640             <span class="keywordflow">if</span> (IgnoreCase &amp;&amp; !ShortNameMatch) {
00641 
00642                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( FinalName.Length == DirContext.<a class="code" href="../../d5/d5/struct__DIR__ENUM__CONTEXT.html#o8">ObjectName</a>.Length );
00643                 
00644                 RtlCopyMemory( FinalName.Buffer,
00645                                DirContext.<a class="code" href="../../d5/d5/struct__DIR__ENUM__CONTEXT.html#o8">ObjectName</a>.Buffer,
00646                                DirContext.<a class="code" href="../../d5/d5/struct__DIR__ENUM__CONTEXT.html#o8">ObjectName</a>.Length );
00647             }
00648 
00649             <span class="comment">//</span>
00650             <span class="comment">//  If we have found the last component then break out to open for the caller.</span>
00651             <span class="comment">//</span>
00652 
00653             <span class="keywordflow">if</span> (RemainingName.Length == 0) {
00654 
00655                 <span class="keywordflow">break</span>;
00656             }
00657             
00658             <span class="comment">//</span>
00659             <span class="comment">//  The object we just found must be a directory.</span>
00660             <span class="comment">//</span>
00661 
00662             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( DirContext.<a class="code" href="../../d5/d5/struct__DIR__ENUM__CONTEXT.html#o5">Fid</a>-&gt;<a class="code" href="../../d1/d2/structNSR__FID.html#o2">Flags</a>, NSR_FID_F_DIRECTORY )) {
00663 
00664                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( Status = STATUS_OBJECT_PATH_NOT_FOUND );
00665             }
00666 
00667             <span class="comment">//</span>
00668             <span class="comment">//  Now open an Fcb for this intermediate index Fcb.</span>
00669             <span class="comment">//</span>
00670 
00671             <a class="code" href="../../d3/d8/udfs_2create_8c.html#a5">UdfOpenObjectFromDirContext</a>( IrpContext,
00672                                          IrpSp,
00673                                          Vcb,
00674                                          &amp;CurrentFcb,
00675                                          ShortNameMatch,
00676                                          IgnoreCase,
00677                                          &amp;DirContext,
00678                                          FALSE,
00679                                          NULL );
00680         }
00681         
00682         <span class="comment">//</span>
00683         <span class="comment">//  Make sure our opener is about to get what they expect.</span>
00684         <span class="comment">//</span>
00685 
00686         <span class="keywordflow">if</span> ((<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpContext-&gt;Flags, IRP_CONTEXT_FLAG_TRAIL_BACKSLASH ) ||
00687              <a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.Create.Options, FILE_DIRECTORY_FILE )) &amp;&amp;
00688             !<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( DirContext.<a class="code" href="../../d5/d5/struct__DIR__ENUM__CONTEXT.html#o5">Fid</a>-&gt;<a class="code" href="../../d1/d2/structNSR__FID.html#o2">Flags</a>, NSR_FID_F_DIRECTORY )) {
00689 
00690             <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( Status = STATUS_NOT_A_DIRECTORY );
00691         
00692         }
00693 
00694         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.Create.Options, FILE_NON_DIRECTORY_FILE ) &amp;&amp;
00695             <a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( DirContext.<a class="code" href="../../d5/d5/struct__DIR__ENUM__CONTEXT.html#o5">Fid</a>-&gt;<a class="code" href="../../d1/d2/structNSR__FID.html#o2">Flags</a>, NSR_FID_F_DIRECTORY )) {
00696 
00697             <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( Status = STATUS_FILE_IS_A_DIRECTORY );
00698         }
00699 
00700         <span class="comment">//</span>
00701         <span class="comment">//  The only create disposition we allow is OPEN.</span>
00702         <span class="comment">//</span>
00703 
00704         <span class="keywordflow">if</span> ((CreateDisposition != FILE_OPEN) &amp;&amp;
00705             (CreateDisposition != FILE_OPEN_IF)) {
00706 
00707             <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( Status = STATUS_ACCESS_DENIED );
00708         }
00709 
00710         <span class="comment">//</span>
00711         <span class="comment">//  Open the object for the caller.</span>
00712         <span class="comment">//</span>
00713 
00714         <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( Status = <a class="code" href="../../d3/d8/udfs_2create_8c.html#a5">UdfOpenObjectFromDirContext</a>( IrpContext,
00715                                                          IrpSp,
00716                                                          Vcb,
00717                                                          &amp;CurrentFcb,
00718                                                          ShortNameMatch,
00719                                                          IgnoreCase,
00720                                                          &amp;DirContext,
00721                                                          TRUE,
00722                                                          RelatedCcb ));
00723     } finally {
00724         
00725         <span class="comment">//</span>
00726         <span class="comment">//  Cleanup the enumeration context if initialized.</span>
00727         <span class="comment">//</span>
00728 
00729         <span class="keywordflow">if</span> (CleanupDirContext) {
00730 
00731             <a class="code" href="../../d3/d8/udfprocs_8h.html#a168">UdfCleanupDirContext</a>( IrpContext, &amp;DirContext );
00732         }
00733 
00734         <span class="comment">//</span>
00735         <span class="comment">//  The result of this open could be success, pending or some error</span>
00736         <span class="comment">//  condition.</span>
00737         <span class="comment">//</span>
00738 
00739         <span class="keywordflow">if</span> (AbnormalTermination()) {
00740 
00741 
00742             <span class="comment">//</span>
00743             <span class="comment">//  In the error path we start by calling our teardown routine if we</span>
00744             <span class="comment">//  have a CurrentFcb.</span>
00745             <span class="comment">//</span>
00746 
00747             <span class="keywordflow">if</span> (CurrentFcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00748 
00749                 BOOLEAN RemovedFcb;
00750 
00751                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a210">UdfTeardownStructures</a>( IrpContext, CurrentFcb, FALSE, &amp;RemovedFcb );
00752 
00753                 <span class="keywordflow">if</span> (RemovedFcb) {
00754 
00755                     CurrentFcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00756                 }
00757             }
00758             
00759             <span class="comment">//</span>
00760             <span class="comment">//  No need to complete the request.</span>
00761             <span class="comment">//</span>
00762 
00763             IrpContext = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00764             <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00765 
00766         <span class="comment">//</span>
00767         <span class="comment">//  If we posted this request through the oplock package we need</span>
00768         <span class="comment">//  to show that there is no reason to complete the request.</span>
00769         <span class="comment">//</span>
00770 
00771         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_PENDING) {
00772 
00773             IrpContext = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00774             <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00775         }
00776 
00777         <span class="comment">//</span>
00778         <span class="comment">//  Release the Current Fcb if still acquired.</span>
00779         <span class="comment">//</span>
00780 
00781         <span class="keywordflow">if</span> (CurrentFcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00782 
00783             <a class="code" href="../../d3/d8/udfprocs_8h.html#a85">UdfReleaseFcb</a>( IrpContext, CurrentFcb );
00784         }
00785 
00786         <span class="comment">//</span>
00787         <span class="comment">//  Release the Vcb.</span>
00788         <span class="comment">//</span>
00789 
00790         <a class="code" href="../../d3/d8/udfprocs_8h.html#a76">UdfReleaseVcb</a>( IrpContext, Vcb );
00791 
00792         <span class="comment">//</span>
00793         <span class="comment">//  Call our completion routine.  It will handle the case where either</span>
00794         <span class="comment">//  the Irp and/or IrpContext are gone.</span>
00795         <span class="comment">//</span>
00796 
00797         <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, Irp, Status );
00798     }
00799 
00800     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00801 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a254" doxytag="udfprocs.h::UdfCommonDevControl" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS UdfCommonDevControl           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d6/udfs_2devctrl_8c-source.html#l00069">69</a> of file <a class="el" href="../../d3/d6/udfs_2devctrl_8c-source.html">udfs/devctrl.c</a>.
<p>
References <a class="el" href="../../d0/d2/struct__IRP.html#o7">_IRP::AssociatedIrp</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02494">_IO_STACK_LOCATION::FileObject</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02865">IoCallDriver</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l04009">IoCopyCurrentIrpStackLocationToNext</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03252">IoGetCurrentIrpStackLocation</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03913">IoSetCompletionRoutine</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01635">_IRP::IoStatus</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02069">_IO_STACK_LOCATION::Parameters</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d3/d8/udfprocs_8h.html#a109">TYPE_OF_OPEN</a>, <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00809">UdfCompleteRequest()</a>, <a class="el" href="../../d7/d2/filobsup_8c-source.html#l00133">UdfDecodeFileObject()</a>, <a class="el" href="../../d3/d6/udfs_2devctrl_8c-source.html#l00451">UdfDevCtrlCompletionRoutine()</a>, <a class="el" href="../../d3/d6/udfs_2devctrl_8c-source.html#l00337">UdfDvdReadStructure()</a>, <a class="el" href="../../d3/d6/udfs_2devctrl_8c-source.html#l00227">UdfDvdTransferKey()</a>, <a class="el" href="../../d9/d4/udfs_2verfysup_8c-source.html#l00603">UdfVerifyVcb()</a>, <a class="el" href="../../d3/d8/udfprocs_8h.html#a263a117">UserFileOpen</a>, <a class="el" href="../../d3/d8/udfprocs_8h.html#a263a115">UserVolumeOpen</a>, and <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00941">_FCB::Vcb</a>.
<p>
Referenced by <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00218">UdfFsdDispatch()</a>, and <a class="el" href="../../d1/d7/fspdisp_8c-source.html#l00038">UdfFspDispatch()</a>.
<p>
<pre class="fragment"><div>00076                    :
00077 
00078     This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> common routine <span class="keywordflow">for</span> doing Device <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> operations called
00079     by both <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> fsd and fsp threads
00080 
00081 Arguments:
00082 
00083     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> to process
00084 
00085 Return Value:
00086 
00087     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - The <span class="keywordflow">return</span> status <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation
00088 
00089 --*/
00090 
00091 {
00092     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00093 
00094     <a class="code" href="../../d3/d8/udfprocs_8h.html#a109">TYPE_OF_OPEN</a> TypeOfOpen;
00095     <a class="code" href="../../d7/d9/struct__FCB.html">PFCB</a> Fcb;
00096     <a class="code" href="../../d2/d9/struct__CCB.html">PCCB</a> Ccb;
00097 
00098     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp;
00099 
00100     PVOID TargetBuffer;
00101 
00102     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00103 
00104     <span class="comment">//</span>
00105     <span class="comment">//  Extract and decode the file object.</span>
00106     <span class="comment">//</span>
00107 
00108     IrpSp = <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>( Irp );
00109 
00110     TypeOfOpen = <a class="code" href="../../d3/d8/udfprocs_8h.html#a174">UdfDecodeFileObject</a>( IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a>,
00111                                       &amp;Fcb,
00112                                       &amp;Ccb );
00113 
00114     <span class="comment">//</span>
00115     <span class="comment">//  A few IOCTLs actually require some intervention on our part to</span>
00116     <span class="comment">//  translate some information from file-based to device-based units.</span>
00117     <span class="comment">//</span>
00118 
00119     <span class="keywordflow">if</span> (TypeOfOpen == <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a117">UserFileOpen</a>) {
00120 
00121         <span class="keywordflow">switch</span> (IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.DeviceIoControl.IoControlCode) {
00122             <span class="keywordflow">case</span> IOCTL_DVD_READ_KEY:
00123             <span class="keywordflow">case</span> IOCTL_DVD_SEND_KEY:
00124 
00125                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d7/udfs_2devctrl_8c.html#a3">UdfDvdTransferKey</a>( IrpContext, Irp, Fcb );
00126                 <span class="keywordflow">break</span>;
00127 
00128             <span class="keywordflow">case</span> IOCTL_DVD_READ_STRUCTURE:
00129 
00130                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d7/udfs_2devctrl_8c.html#a2">UdfDvdReadStructure</a>( IrpContext, Irp, Fcb );
00131                 <span class="keywordflow">break</span>;
00132 
00133             <span class="keywordflow">case</span> IOCTL_STORAGE_SET_READ_AHEAD:
00134 
00135                 <span class="comment">//</span>
00136                 <span class="comment">//  We're just going to no-op this for now.</span>
00137                 <span class="comment">//</span>
00138                 
00139                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00140                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, Irp, Status );
00141                 <span class="keywordflow">break</span>;
00142 
00143             <span class="keywordflow">default</span>:
00144 
00145                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
00146                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, Irp, Status );
00147                 <span class="keywordflow">break</span>;
00148         }
00149 
00150         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00151     }
00152 
00153     <span class="comment">//</span>
00154     <span class="comment">//  Now the only type of opens we accept are user volume opens.</span>
00155     <span class="comment">//</span>
00156 
00157     <span class="keywordflow">if</span> (TypeOfOpen != <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a115">UserVolumeOpen</a>) {
00158 
00159         <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, Irp, STATUS_INVALID_PARAMETER );
00160         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00161     }
00162 
00163     <span class="comment">//</span>
00164     <span class="comment">//  Handle the case of the disk type ourselves.  We're really just going to</span>
00165     <span class="comment">//  lie about this, but it is a good lie.</span>
00166     <span class="comment">//</span>
00167 
00168     <span class="keywordflow">if</span> (IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.DeviceIoControl.IoControlCode == IOCTL_CDROM_DISK_TYPE) {
00169 
00170         <span class="comment">//</span>
00171         <span class="comment">//  Verify the Vcb in this case to detect if the volume has changed.</span>
00172         <span class="comment">//</span>
00173 
00174         <a class="code" href="../../d8/d5/udfs_2verfysup_8c.html#a5">UdfVerifyVcb</a>( IrpContext, Fcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o2">Vcb</a> );
00175 
00176         <span class="comment">//</span>
00177         <span class="comment">//  Check the size of the output buffer.</span>
00178         <span class="comment">//</span>
00179 
00180         <span class="keywordflow">if</span> (IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.DeviceIoControl.OutputBufferLength &lt; <span class="keyword">sizeof</span>( CDROM_DISK_DATA )) {
00181 
00182             <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, Irp, STATUS_BUFFER_TOO_SMALL );
00183             <span class="keywordflow">return</span> STATUS_BUFFER_TOO_SMALL;
00184         }
00185 
00186         <span class="comment">//</span>
00187         <span class="comment">//  Copy the data from the Vcb.</span>
00188         <span class="comment">//</span>
00189 
00190         ((PCDROM_DISK_DATA) <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o7">AssociatedIrp</a>.SystemBuffer)-&gt;DiskData = CDROM_DISK_DATA_TRACK;
00191 
00192         <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information = <span class="keyword">sizeof</span>( CDROM_DISK_DATA );
00193         <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, Irp, STATUS_SUCCESS );
00194         <span class="keywordflow">return</span> STATUS_SUCCESS;
00195     }
00196 
00197     <span class="comment">//</span>
00198     <span class="comment">//  Copy the arguments and set up the completion routine</span>
00199     <span class="comment">//</span>
00200 
00201     <a class="code" href="../../d0/d5/io_8h.html#a239">IoCopyCurrentIrpStackLocationToNext</a>( Irp );
00202     
00203     <a class="code" href="../../d0/d5/io_8h.html#a237">IoSetCompletionRoutine</a>( Irp,
00204                             UdfDevCtrlCompletionRoutine,
00205                             NULL,
00206                             TRUE,
00207                             TRUE,
00208                             TRUE );
00209 
00210     <span class="comment">//</span>
00211     <span class="comment">//  Send the request.</span>
00212     <span class="comment">//</span>
00213 
00214     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d5/io_8h.html#a223">IoCallDriver</a>( IrpContext-&gt;Vcb-&gt;TargetDeviceObject, Irp );
00215 
00216     <span class="comment">//</span>
00217     <span class="comment">//  Cleanup our Irp Context.  The driver has completed the Irp.</span>
00218     <span class="comment">//</span>
00219 
00220     <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, NULL, STATUS_SUCCESS );
00221 
00222     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00223 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a255" doxytag="udfprocs.h::UdfCommonDirControl" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS UdfCommonDirControl           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l00255">255</a> of file <a class="el" href="../../d2/d7/dirctrl_8c-source.html">dirctrl.c</a>.
<p>
References <a class="el" href="../../d1/d4/io_8h-source.html#l02494">_IO_STACK_LOCATION::FileObject</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03252">IoGetCurrentIrpStackLocation</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00104">IRP_MN_NOTIFY_CHANGE_DIRECTORY</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00103">IRP_MN_QUERY_DIRECTORY</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02029">_IO_STACK_LOCATION::MinorFunction</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00809">UdfCompleteRequest()</a>, <a class="el" href="../../d7/d2/filobsup_8c-source.html#l00133">UdfDecodeFileObject()</a>, <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l00904">UdfNotifyChangeDirectory()</a>, <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l00334">UdfQueryDirectory()</a>, and <a class="el" href="../../d3/d8/udfprocs_8h.html#a263a116">UserDirectoryOpen</a>.
<p>
Referenced by <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00218">UdfFsdDispatch()</a>, and <a class="el" href="../../d1/d7/fspdisp_8c-source.html#l00038">UdfFspDispatch()</a>.
<p>
<pre class="fragment"><div>00262                    :
00263 
00264     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> entry point <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> directory <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> operations.  These
00265     are directory enumerations and directory notify calls.  We verify <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00266     user's handle <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <span class="keywordflow">for</span> a directory and then call <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> appropriate routine.
00267 
00268 Arguments:
00269 
00270     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> - <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> <span class="keywordflow">for</span> <span class="keyword">this</span> request.
00271 
00272 Return Value:
00273 
00274     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> returned from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> lower level <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a24">routines</a>.
00275 
00276 --*/
00277 
00278 {
00279     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00280     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp = <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>( Irp );
00281 
00282     <a class="code" href="../../d7/d9/struct__FCB.html">PFCB</a> Fcb;
00283     <a class="code" href="../../d2/d9/struct__CCB.html">PCCB</a> Ccb;
00284 
00285     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00286 
00287     <span class="comment">//</span>
00288     <span class="comment">//  Decode the user file object and fail this request if it is not</span>
00289     <span class="comment">//  a user directory.</span>
00290     <span class="comment">//</span>
00291 
00292     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/udfprocs_8h.html#a174">UdfDecodeFileObject</a>( IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a>,
00293                              &amp;Fcb,
00294                              &amp;Ccb ) != <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a116">UserDirectoryOpen</a>) {
00295 
00296         <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, Irp, STATUS_INVALID_PARAMETER );
00297         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00298     }
00299 
00300     <span class="comment">//</span>
00301     <span class="comment">//  We know this is a directory control so we'll case on the</span>
00302     <span class="comment">//  minor function, and call a internal worker routine to complete</span>
00303     <span class="comment">//  the irp.</span>
00304     <span class="comment">//</span>
00305 
00306     <span class="keywordflow">switch</span> (IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o1">MinorFunction</a>) {
00307 
00308     <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a44">IRP_MN_QUERY_DIRECTORY</a>:
00309 
00310         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d8/dirctrl_8c.html#a11">UdfQueryDirectory</a>( IrpContext, Irp, IrpSp, Fcb, Ccb );
00311         <span class="keywordflow">break</span>;
00312 
00313     <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a45">IRP_MN_NOTIFY_CHANGE_DIRECTORY</a>:
00314 
00315         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d8/dirctrl_8c.html#a12">UdfNotifyChangeDirectory</a>( IrpContext, Irp, IrpSp, Ccb );
00316         <span class="keywordflow">break</span>;
00317 
00318     <span class="keywordflow">default</span>:
00319 
00320         <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, Irp, STATUS_INVALID_DEVICE_REQUEST );
00321         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_DEVICE_REQUEST;
00322         <span class="keywordflow">break</span>;
00323     }
00324 
00325     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00326 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a256" doxytag="udfprocs.h::UdfCommonFsControl" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS UdfCommonFsControl           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l00283">283</a> of file <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html">udfs/fsctrl.c</a>.
<p>
References <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00356">ASSERT_IRP</a>, <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00352">ASSERT_IRP_CONTEXT</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03252">IoGetCurrentIrpStackLocation</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00113">IRP_MN_MOUNT_VOLUME</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00112">IRP_MN_USER_FS_REQUEST</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00114">IRP_MN_VERIFY_VOLUME</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02029">_IO_STACK_LOCATION::MinorFunction</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00809">UdfCompleteRequest()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l01444">UdfMountVolume()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l00363">UdfUserFsctl()</a>, and <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l02043">UdfVerifyVolume()</a>.
<p>
Referenced by <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00218">UdfFsdDispatch()</a>, and <a class="el" href="../../d1/d7/fspdisp_8c-source.html#l00038">UdfFspDispatch()</a>.
<p>
<pre class="fragment"><div>00290                    :
00291 
00292     This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> common routine <span class="keywordflow">for</span> doing FileSystem <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> operations called
00293     by both <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> fsd and fsp threads
00294 
00295 Arguments:
00296 
00297     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> to process
00298 
00299 Return Value:
00300 
00301     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - The <span class="keywordflow">return</span> status <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation
00302 
00303 --*/
00304 
00305 {
00306     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00307     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp = <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>( Irp );
00308 
00309     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00310 
00311     <span class="comment">//</span>
00312     <span class="comment">//  Check the input parameters</span>
00313     <span class="comment">//</span>
00314 
00315     <a class="code" href="../../d1/d8/udfdata_8h.html#a28">ASSERT_IRP_CONTEXT</a>( IrpContext );
00316     <a class="code" href="../../d1/d8/udfdata_8h.html#a32">ASSERT_IRP</a>( Irp );
00317 
00318     <span class="comment">//</span>
00319     <span class="comment">//  Get a pointer to the current Irp stack location</span>
00320     <span class="comment">//</span>
00321 
00322     IrpSp = <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>( Irp );
00323 
00324     <span class="comment">//</span>
00325     <span class="comment">//  We know this is a file system control so we'll case on the</span>
00326     <span class="comment">//  minor function, and call a internal worker routine to complete</span>
00327     <span class="comment">//  the irp.</span>
00328     <span class="comment">//</span>
00329 
00330     <span class="keywordflow">switch</span> (IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o1">MinorFunction</a>) {
00331 
00332     <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a47">IRP_MN_MOUNT_VOLUME</a>:
00333 
00334         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d7/udfs_2fsctrl_8c.html#a15">UdfMountVolume</a>( IrpContext, Irp );
00335         <span class="keywordflow">break</span>;
00336 
00337     <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a48">IRP_MN_VERIFY_VOLUME</a>:
00338 
00339         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d7/udfs_2fsctrl_8c.html#a23">UdfVerifyVolume</a>( IrpContext, Irp );
00340         <span class="keywordflow">break</span>;
00341 
00342     <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a46">IRP_MN_USER_FS_REQUEST</a>:
00343 
00344         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d7/udfs_2fsctrl_8c.html#a22">UdfUserFsctl</a>( IrpContext, Irp );
00345         <span class="keywordflow">break</span>;
00346 
00347     <span class="keywordflow">default</span>:
00348 
00349         <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, Irp, STATUS_INVALID_DEVICE_REQUEST );
00350         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_DEVICE_REQUEST;
00351         <span class="keywordflow">break</span>;
00352     }
00353 
00354     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00355 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a257" doxytag="udfprocs.h::UdfCommonLockControl" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS UdfCommonLockControl           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d4/lockctrl_8c-source.html#l00046">46</a> of file <a class="el" href="../../d3/d4/lockctrl_8c-source.html">lockctrl.c</a>.
<p>
References <a class="el" href="../../d1/d4/io_8h-source.html#l02494">_IO_STACK_LOCATION::FileObject</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l00823">FsRtlCheckOplock()</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l01173">FsRtlProcessFileLock()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03252">IoGetCurrentIrpStackLocation</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d3/d8/udfprocs_8h.html#a109">TYPE_OF_OPEN</a>, <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00809">UdfCompleteRequest()</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l03713">UdfCreateFileLock()</a>, <a class="el" href="../../d7/d2/filobsup_8c-source.html#l00133">UdfDecodeFileObject()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00385">UdfIsFastIoPossible</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01567">UdfLockFcb</a>, <a class="el" href="../../d3/d8/workque_8c-source.html#l00222">UdfOplockComplete()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01577">UdfUnlockFcb</a>, <a class="el" href="../../d9/d4/udfs_2verfysup_8c-source.html#l00760">UdfVerifyFcbOperation()</a>, and <a class="el" href="../../d3/d8/udfprocs_8h.html#a263a117">UserFileOpen</a>.
<p>
Referenced by <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00218">UdfFsdDispatch()</a>, and <a class="el" href="../../d1/d7/fspdisp_8c-source.html#l00038">UdfFspDispatch()</a>.
<p>
<pre class="fragment"><div>00053                    :
00054 
00055     This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> common routine <span class="keywordflow">for</span> <a class="code" href="../../d6/d0/usercli_8h.html#a41">Lock</a> Control called by both <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> fsd and fsp
00056     threads.
00057 
00058 Arguments:
00059 
00060     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> to process
00061 
00062 Return Value:
00063 
00064     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - The <span class="keywordflow">return</span> status <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation
00065 
00066 --*/
00067 
00068 {
00069     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00070     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp = <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>( Irp );
00071 
00072     <a class="code" href="../../d3/d8/udfprocs_8h.html#a109">TYPE_OF_OPEN</a> TypeOfOpen;
00073     <a class="code" href="../../d7/d9/struct__FCB.html">PFCB</a> Fcb;
00074     <a class="code" href="../../d2/d9/struct__CCB.html">PCCB</a> Ccb;
00075 
00076     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00077 
00078     <span class="comment">//</span>
00079     <span class="comment">//  Extract and decode the type of file object we're being asked to process</span>
00080     <span class="comment">//</span>
00081 
00082     TypeOfOpen = <a class="code" href="../../d3/d8/udfprocs_8h.html#a174">UdfDecodeFileObject</a>( IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a>, &amp;Fcb, &amp;Ccb );
00083 
00084     <span class="comment">//</span>
00085     <span class="comment">//  If the file is not a user file open then we reject the request</span>
00086     <span class="comment">//  as an invalid parameter</span>
00087     <span class="comment">//</span>
00088 
00089     <span class="keywordflow">if</span> (TypeOfOpen != <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a117">UserFileOpen</a>) {
00090 
00091         <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, Irp, STATUS_INVALID_PARAMETER );
00092         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00093     }
00094 
00095     <span class="comment">//</span>
00096     <span class="comment">//  We check whether we can proceed based on the state of the file oplocks.</span>
00097     <span class="comment">//  This call might post the irp for us.</span>
00098     <span class="comment">//</span>
00099 
00100     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d8/fsrtl_8h.html#a165">FsRtlCheckOplock</a>( &amp;Fcb-&gt;Oplock,
00101                                Irp,
00102                                IrpContext,
00103                                UdfOplockComplete,
00104                                NULL );
00105 
00106     <span class="comment">//</span>
00107     <span class="comment">//  If we don't get success then the oplock package completed the request.</span>
00108     <span class="comment">//</span>
00109 
00110     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_SUCCESS) {
00111 
00112         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00113     }
00114 
00115     <span class="comment">//</span>
00116     <span class="comment">//  Verify the Fcb.</span>
00117     <span class="comment">//</span>
00118 
00119     <a class="code" href="../../d8/d5/udfs_2verfysup_8c.html#a6">UdfVerifyFcbOperation</a>( IrpContext, Fcb );
00120 
00121     <span class="comment">//</span>
00122     <span class="comment">//  If we don't have a file lock, then get one now.</span>
00123     <span class="comment">//</span>
00124 
00125     <span class="keywordflow">if</span> (Fcb-&gt;FileLock == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) { <a class="code" href="../../d3/d8/udfprocs_8h.html#a227">UdfCreateFileLock</a>( IrpContext, Fcb, TRUE ); }
00126 
00127     <span class="comment">//</span>
00128     <span class="comment">//  Now call the FsRtl routine to do the actual processing of the</span>
00129     <span class="comment">//  Lock request</span>
00130     <span class="comment">//</span>
00131 
00132     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d8/fsrtl_8h.html#a116">FsRtlProcessFileLock</a>( Fcb-&gt;FileLock, Irp, NULL );
00133 
00134     <span class="comment">//</span>
00135     <span class="comment">//  Set the flag indicating if Fast I/O is possible</span>
00136     <span class="comment">//</span>
00137 
00138     <a class="code" href="../../d3/d8/udfprocs_8h.html#a90">UdfLockFcb</a>( IrpContext, Fcb );
00139     Fcb-&gt;IsFastIoPossible = <a class="code" href="../../d3/d8/udfprocs_8h.html#a63">UdfIsFastIoPossible</a>( Fcb );
00140     <a class="code" href="../../d3/d8/udfprocs_8h.html#a91">UdfUnlockFcb</a>( IrpContext, Fcb );
00141 
00142     <span class="comment">//</span>
00143     <span class="comment">//  Complete the request.</span>
00144     <span class="comment">//</span>
00145 
00146     <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, NULL, Status );
00147     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00148 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a258" doxytag="udfprocs.h::UdfCommonPnp" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS UdfCommonPnp           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d8/udfs_2pnp_8c-source.html#l00075">75</a> of file <a class="el" href="../../d5/d8/udfs_2pnp_8c-source.html">udfs/pnp.c</a>.
<p>
References <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00699">_VOLUME_DEVICE_OBJECT::DeviceObject</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02488">_IO_STACK_LOCATION::DeviceObject</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02865">IoCallDriver</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03252">IoGetCurrentIrpStackLocation</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l04044">IoSkipCurrentIrpStackLocation</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01235">IRP_CONTEXT_FLAG_WAIT</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00163">IRP_MN_CANCEL_REMOVE_DEVICE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00161">IRP_MN_QUERY_REMOVE_DEVICE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00162">IRP_MN_REMOVE_DEVICE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00184">IRP_MN_SURPRISE_REMOVAL</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02029">_IO_STACK_LOCATION::MinorFunction</a>, <a class="el" href="../../d1/d6/lfs_2nodetype_8h-source.html#l00051">NodeType</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00505">SetFlag</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01177">_DEVICE_OBJECT::Size</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00541">_VCB::TargetDeviceObject</a>, <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00809">UdfCompleteRequest()</a>, <a class="el" href="../../d5/d8/udfs_2pnp_8c-source.html#l00632">UdfPnpCancelRemove()</a>, <a class="el" href="../../d5/d8/udfs_2pnp_8c-source.html#l00194">UdfPnpQueryRemove()</a>, <a class="el" href="../../d5/d8/udfs_2pnp_8c-source.html#l00350">UdfPnpRemove()</a>, <a class="el" href="../../d5/d8/udfs_2pnp_8c-source.html#l00500">UdfPnpSurpriseRemove()</a>, <a class="el" href="../../d2/d6/udfs_2nodetype_8h-source.html#l00036">UDFS_NTC_VCB</a>, and <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00736">_VOLUME_DEVICE_OBJECT::Vcb</a>.
<p>
Referenced by <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00218">UdfFsdDispatch()</a>, and <a class="el" href="../../d1/d7/fspdisp_8c-source.html#l00038">UdfFspDispatch()</a>.
<p>
<pre class="fragment"><div>00082                    :
00083 
00084     This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> common routine <span class="keywordflow">for</span> doing PnP operations called
00085     by both <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> fsd and fsp threads
00086 
00087 Arguments:
00088 
00089     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> to process
00090 
00091 Return Value:
00092 
00093     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - The <span class="keywordflow">return</span> status <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation
00094 
00095 --*/
00096 
00097 {
00098     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00099     
00100     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp;
00101 
00102     <a class="code" href="../../d6/d7/struct__VOLUME__DEVICE__OBJECT.html">PVOLUME_DEVICE_OBJECT</a> OurDeviceObject;
00103     <a class="code" href="../../d7/d5/struct__VCB.html">PVCB</a> Vcb;
00104 
00105     <span class="comment">//</span>
00106     <span class="comment">//  Get the current Irp stack location.</span>
00107     <span class="comment">//</span>
00108 
00109     IrpSp = <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>( Irp );
00110 
00111     <span class="comment">//</span>
00112     <span class="comment">//  Find our Vcb.  This is tricky since we have no file object in the Irp.</span>
00113     <span class="comment">//</span>
00114 
00115     OurDeviceObject = (<a class="code" href="../../d6/d7/struct__VOLUME__DEVICE__OBJECT.html">PVOLUME_DEVICE_OBJECT</a>) IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o57">DeviceObject</a>;
00116 
00117     <span class="comment">//</span>
00118     <span class="comment">//  Make sure this device object really is big enough to be a volume device</span>
00119     <span class="comment">//  object.  If it isn't, we need to get out before we try to reference some</span>
00120     <span class="comment">//  field that takes us past the end of an ordinary device object.</span>
00121     <span class="comment">//</span>
00122     
00123     <span class="keywordflow">if</span> (OurDeviceObject-&gt;<a class="code" href="../../d6/d7/struct__VOLUME__DEVICE__OBJECT.html#o0">DeviceObject</a>.<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o1">Size</a> != <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d7/struct__VOLUME__DEVICE__OBJECT.html">VOLUME_DEVICE_OBJECT</a>) ||
00124         <a class="code" href="../../d0/d7/lfs_2nodetype_8h.html#a6">NodeType</a>( &amp;OurDeviceObject-&gt;<a class="code" href="../../d6/d7/struct__VOLUME__DEVICE__OBJECT.html#o5">Vcb</a> ) != <a class="code" href="../../d1/d7/udfs_2nodetype_8h.html#a2">UDFS_NTC_VCB</a>) {
00125         
00126         <span class="comment">//</span>
00127         <span class="comment">//  We were called with something we don't understand.</span>
00128         <span class="comment">//</span>
00129         
00130         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
00131         <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, Irp, Status );
00132         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00133     }
00134 
00135     <span class="comment">//</span>
00136     <span class="comment">//  Force all PnP operations to be synchronous.</span>
00137     <span class="comment">//</span>
00138 
00139     <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( IrpContext-&gt;Flags, IRP_CONTEXT_FLAG_WAIT );
00140 
00141     Vcb = &amp;OurDeviceObject-&gt;<a class="code" href="../../d6/d7/struct__VOLUME__DEVICE__OBJECT.html#o5">Vcb</a>;
00142 
00143     <span class="comment">//</span>
00144     <span class="comment">//  Case on the minor code.</span>
00145     <span class="comment">//</span>
00146     
00147     <span class="keywordflow">switch</span> ( IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o1">MinorFunction</a> ) {
00148 
00149         <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a66">IRP_MN_QUERY_REMOVE_DEVICE</a>:
00150             
00151             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d9/udfs_2pnp_8c.html#a1">UdfPnpQueryRemove</a>( IrpContext, Irp, Vcb );
00152             <span class="keywordflow">break</span>;
00153         
00154         <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a87">IRP_MN_SURPRISE_REMOVAL</a>:
00155         
00156             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d9/udfs_2pnp_8c.html#a3">UdfPnpSurpriseRemove</a>( IrpContext, Irp, Vcb );
00157             <span class="keywordflow">break</span>;
00158 
00159         <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a67">IRP_MN_REMOVE_DEVICE</a>:
00160 
00161             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d9/udfs_2pnp_8c.html#a2">UdfPnpRemove</a>( IrpContext, Irp, Vcb );
00162             <span class="keywordflow">break</span>;
00163 
00164         <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a68">IRP_MN_CANCEL_REMOVE_DEVICE</a>:
00165     
00166             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d9/udfs_2pnp_8c.html#a4">UdfPnpCancelRemove</a>( IrpContext, Irp, Vcb );
00167             <span class="keywordflow">break</span>;
00168 
00169         <span class="keywordflow">default</span>:
00170     
00171             <span class="comment">//</span>
00172             <span class="comment">//  Just pass the IRP on.  As we do not need to be in the</span>
00173             <span class="comment">//  way on return, ellide ourselves out of the stack.</span>
00174             <span class="comment">//</span>
00175             
00176             <a class="code" href="../../d0/d5/io_8h.html#a240">IoSkipCurrentIrpStackLocation</a>( Irp );
00177     
00178             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d5/io_8h.html#a223">IoCallDriver</a>(Vcb-&gt;<a class="code" href="../../d7/d5/struct__VCB.html#o4">TargetDeviceObject</a>, Irp);
00179             
00180             <span class="comment">//</span>
00181             <span class="comment">//  Cleanup our Irp Context.  The driver has completed the Irp.</span>
00182             <span class="comment">//</span>
00183         
00184             <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, NULL, STATUS_SUCCESS );
00185             
00186             <span class="keywordflow">break</span>;
00187     }
00188         
00189     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00190 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a259" doxytag="udfprocs.h::UdfCommonQueryInfo" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS UdfCommonQueryInfo           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d2/fileinfo_8c-source.html#l00156">156</a> of file <a class="el" href="../../d5/d2/fileinfo_8c-source.html">fileinfo.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d2/struct__IRP.html#o7">_IRP::AssociatedIrp</a>, <a class="el" href="../../d7/d1/rtqkey_8c-source.html#l00042">Buffer</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01130">CCB_FLAG_OPEN_BY_ID</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01061">FCB_STATE_INITIALIZED</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00986">_FCB::FcbState</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02494">_IO_STACK_LOCATION::FileObject</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01091">_CCB::Flags</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03252">IoGetCurrentIrpStackLocation</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01635">_IRP::IoStatus</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02069">_IO_STACK_LOCATION::Parameters</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d3/d8/udfprocs_8h.html#a109">TYPE_OF_OPEN</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01533">UdfAcquireFileShared</a>, <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00809">UdfCompleteRequest()</a>, <a class="el" href="../../d7/d2/filobsup_8c-source.html#l00133">UdfDecodeFileObject()</a>, <a class="el" href="../../d5/d2/fileinfo_8c-source.html#l01232">UdfQueryAlternateNameInfo()</a>, <a class="el" href="../../d5/d2/fileinfo_8c-source.html#l00875">UdfQueryBasicInfo()</a>, <a class="el" href="../../d5/d2/fileinfo_8c-source.html#l01057">UdfQueryEaInfo()</a>, <a class="el" href="../../d5/d2/fileinfo_8c-source.html#l01009">UdfQueryInternalInfo()</a>, <a class="el" href="../../d5/d2/fileinfo_8c-source.html#l01158">UdfQueryNameInfo()</a>, <a class="el" href="../../d5/d2/fileinfo_8c-source.html#l01429">UdfQueryNetworkInfo()</a>, <a class="el" href="../../d5/d2/fileinfo_8c-source.html#l01105">UdfQueryPositionInfo()</a>, <a class="el" href="../../d5/d2/fileinfo_8c-source.html#l00936">UdfQueryStandardInfo()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01539">UdfReleaseFile</a>, <a class="el" href="../../d9/d4/udfs_2verfysup_8c-source.html#l00760">UdfVerifyFcbOperation()</a>, <a class="el" href="../../d3/d8/udfprocs_8h.html#a263a116">UserDirectoryOpen</a>, and <a class="el" href="../../d3/d8/udfprocs_8h.html#a263a117">UserFileOpen</a>.
<p>
Referenced by <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00218">UdfFsdDispatch()</a>, and <a class="el" href="../../d1/d7/fspdisp_8c-source.html#l00038">UdfFspDispatch()</a>.
<p>
<pre class="fragment"><div>00163                    :
00164 
00165     This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> common routine <span class="keywordflow">for</span> query <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> information called by both <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00166     fsd and fsp threads.
00167 
00168 Arguments:
00169 
00170     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> to process.
00171 
00172 Return Value:
00173 
00174     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - The <span class="keywordflow">return</span> status <span class="keywordflow">for</span> <span class="keyword">this</span> operation.
00175 
00176 --*/
00177 
00178 {
00179     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00180     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp = <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>( Irp );
00181 
00182     ULONG Length;
00183     FILE_INFORMATION_CLASS FileInformationClass;
00184     PFILE_ALL_INFORMATION <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
00185 
00186     <a class="code" href="../../d3/d8/udfprocs_8h.html#a109">TYPE_OF_OPEN</a> TypeOfOpen;
00187     <a class="code" href="../../d7/d9/struct__FCB.html">PFCB</a> Fcb;
00188     <a class="code" href="../../d2/d9/struct__CCB.html">PCCB</a> Ccb;
00189 
00190     BOOLEAN ReleaseFcb = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00191 
00192     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00193 
00194     <span class="comment">//</span>
00195     <span class="comment">//  Reference our input parameters to make things easier</span>
00196     <span class="comment">//</span>
00197 
00198     Length = IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QueryFile.Length;
00199     FileInformationClass = IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QueryFile.FileInformationClass;
00200     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o7">AssociatedIrp</a>.SystemBuffer;
00201 
00202     <span class="comment">//</span>
00203     <span class="comment">//  Decode the file object</span>
00204     <span class="comment">//</span>
00205 
00206     TypeOfOpen = <a class="code" href="../../d3/d8/udfprocs_8h.html#a174">UdfDecodeFileObject</a>( IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a>, &amp;Fcb, &amp;Ccb );
00207 
00208     <span class="comment">//</span>
00209     <span class="comment">//  Use a try-finally to facilitate cleanup.</span>
00210     <span class="comment">//</span>
00211 
00212     <span class="keywordflow">try</span> {
00213 
00214         <span class="comment">//</span>
00215         <span class="comment">//  We only support query on file and directory handles.</span>
00216         <span class="comment">//</span>
00217 
00218         <span class="keywordflow">switch</span> (TypeOfOpen) {
00219 
00220         <span class="keywordflow">case</span> <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a116">UserDirectoryOpen</a> :
00221         <span class="keywordflow">case</span> <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a117">UserFileOpen</a> :
00222 
00223             <span class="comment">//</span>
00224             <span class="comment">//  Acquire shared access to this file.</span>
00225             <span class="comment">//</span>
00226 
00227             <a class="code" href="../../d3/d8/udfprocs_8h.html#a80">UdfAcquireFileShared</a>( IrpContext, Fcb );
00228             ReleaseFcb = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00229 
00230             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Fcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o10">FcbState</a>, FCB_STATE_INITIALIZED ));
00231             
00232             <span class="comment">//</span>
00233             <span class="comment">//  Make sure the Fcb is in a usable condition.  This will raise</span>
00234             <span class="comment">//  an error condition if the volume is unusable</span>
00235             <span class="comment">//</span>
00236 
00237             <a class="code" href="../../d8/d5/udfs_2verfysup_8c.html#a6">UdfVerifyFcbOperation</a>( IrpContext, Fcb );
00238 
00239             <span class="comment">//</span>
00240             <span class="comment">//  Based on the information class we'll do different</span>
00241             <span class="comment">//  actions.  Each of hte procedures that we're calling fills</span>
00242             <span class="comment">//  up the output buffer, if possible.  They will raise the</span>
00243             <span class="comment">//  status STATUS_BUFFER_OVERFLOW for an insufficient buffer.</span>
00244             <span class="comment">//  This is considered a somewhat unusual case and is handled</span>
00245             <span class="comment">//  more cleanly with the exception mechanism rather than</span>
00246             <span class="comment">//  testing a return status value for each call.</span>
00247             <span class="comment">//</span>
00248 
00249             <span class="keywordflow">switch</span> (FileInformationClass) {
00250 
00251             <span class="keywordflow">case</span> FileAllInformation:
00252 
00253                 <span class="comment">//</span>
00254                 <span class="comment">//  We don't allow this operation on a file opened by file Id.</span>
00255                 <span class="comment">//</span>
00256 
00257                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Ccb-&gt;<a class="code" href="../../d2/d9/struct__CCB.html#o2">Flags</a>, CCB_FLAG_OPEN_BY_ID )) {
00258 
00259                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
00260                     <span class="keywordflow">break</span>;
00261                 }
00262 
00263                 <span class="comment">//</span>
00264                 <span class="comment">//  In this case go ahead and call the individual routines to</span>
00265                 <span class="comment">//  fill in the buffer.  Only the name routine will</span>
00266                 <span class="comment">//  pointer to the output buffer and then call the</span>
00267                 <span class="comment">//  individual routines to fill in the buffer.</span>
00268                 <span class="comment">//</span>
00269 
00270                 Length -= (<span class="keyword">sizeof</span>( FILE_ACCESS_INFORMATION ) +
00271                            <span class="keyword">sizeof</span>( FILE_MODE_INFORMATION ) +
00272                            <span class="keyword">sizeof</span>( FILE_ALIGNMENT_INFORMATION ));
00273 
00274                 <a class="code" href="../../d4/d3/fileinfo_8c.html#a3">UdfQueryBasicInfo</a>( IrpContext, Fcb, Ccb, &amp;<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;BasicInformation, &amp;Length );
00275                 <a class="code" href="../../d4/d3/fileinfo_8c.html#a4">UdfQueryStandardInfo</a>( IrpContext, Fcb, &amp;<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;StandardInformation, &amp;Length );
00276                 <a class="code" href="../../d4/d3/fileinfo_8c.html#a5">UdfQueryInternalInfo</a>( IrpContext, Fcb, &amp;<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;InternalInformation, &amp;Length );
00277                 <a class="code" href="../../d4/d3/fileinfo_8c.html#a6">UdfQueryEaInfo</a>( IrpContext, Fcb, &amp;<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;EaInformation, &amp;Length );
00278                 <a class="code" href="../../d4/d3/fileinfo_8c.html#a7">UdfQueryPositionInfo</a>( IrpContext, IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a>, &amp;<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;PositionInformation, &amp;Length );
00279                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d3/fileinfo_8c.html#a8">UdfQueryNameInfo</a>( IrpContext, IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a>, &amp;<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;NameInformation, &amp;Length );
00280 
00281                 <span class="keywordflow">break</span>;
00282 
00283             <span class="keywordflow">case</span> FileBasicInformation:
00284 
00285                 <a class="code" href="../../d4/d3/fileinfo_8c.html#a3">UdfQueryBasicInfo</a>( IrpContext, Fcb, Ccb, (PFILE_BASIC_INFORMATION) Buffer, &amp;Length );
00286                 <span class="keywordflow">break</span>;
00287 
00288             <span class="keywordflow">case</span> FileStandardInformation:
00289 
00290                 <a class="code" href="../../d4/d3/fileinfo_8c.html#a4">UdfQueryStandardInfo</a>( IrpContext, Fcb, (PFILE_STANDARD_INFORMATION) Buffer, &amp;Length );
00291                 <span class="keywordflow">break</span>;
00292 
00293             <span class="keywordflow">case</span> FileInternalInformation:
00294 
00295                 <a class="code" href="../../d4/d3/fileinfo_8c.html#a5">UdfQueryInternalInfo</a>( IrpContext, Fcb, (PFILE_INTERNAL_INFORMATION) Buffer, &amp;Length );
00296                 <span class="keywordflow">break</span>;
00297 
00298             <span class="keywordflow">case</span> FileEaInformation:
00299 
00300                 <a class="code" href="../../d4/d3/fileinfo_8c.html#a6">UdfQueryEaInfo</a>( IrpContext, Fcb, (PFILE_EA_INFORMATION) Buffer, &amp;Length );
00301                 <span class="keywordflow">break</span>;
00302 
00303             <span class="keywordflow">case</span> FilePositionInformation:
00304 
00305                 <a class="code" href="../../d4/d3/fileinfo_8c.html#a7">UdfQueryPositionInfo</a>( IrpContext, IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a>, (PFILE_POSITION_INFORMATION) Buffer, &amp;Length );
00306                 <span class="keywordflow">break</span>;
00307 
00308             <span class="keywordflow">case</span> FileNameInformation:
00309 
00310                 <span class="comment">//</span>
00311                 <span class="comment">//  We don't allow this operation on a file opened by file Id.</span>
00312                 <span class="comment">//</span>
00313 
00314                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Ccb-&gt;<a class="code" href="../../d2/d9/struct__CCB.html#o2">Flags</a>, CCB_FLAG_OPEN_BY_ID )) {
00315 
00316                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d3/fileinfo_8c.html#a8">UdfQueryNameInfo</a>( IrpContext, IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a>, (PFILE_NAME_INFORMATION) Buffer, &amp;Length );
00317 
00318                 } <span class="keywordflow">else</span> {
00319 
00320                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
00321                 }
00322 
00323                 <span class="keywordflow">break</span>;
00324 
00325             <span class="keywordflow">case</span> FileAlternateNameInformation:
00326 
00327                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Ccb-&gt;<a class="code" href="../../d2/d9/struct__CCB.html#o2">Flags</a>, CCB_FLAG_OPEN_BY_ID )) {
00328 
00329                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d3/fileinfo_8c.html#a9">UdfQueryAlternateNameInfo</a>( IrpContext, Fcb, Ccb, (PFILE_NAME_INFORMATION) Buffer, &amp;Length );
00330 
00331                 } <span class="keywordflow">else</span> {
00332 
00333                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
00334                 }
00335 
00336                 <span class="keywordflow">break</span>;
00337 
00338             <span class="keywordflow">case</span> FileNetworkOpenInformation:
00339 
00340                 <a class="code" href="../../d4/d3/fileinfo_8c.html#a10">UdfQueryNetworkInfo</a>( IrpContext, Fcb, Ccb, (PFILE_NETWORK_OPEN_INFORMATION) Buffer, &amp;Length );
00341                 <span class="keywordflow">break</span>;
00342 
00343             <span class="keywordflow">default</span> :
00344 
00345                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
00346             }
00347 
00348             <span class="keywordflow">break</span>;
00349 
00350         <span class="keywordflow">default</span> :
00351 
00352             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
00353         }
00354 
00355         <span class="comment">//</span>
00356         <span class="comment">//  Set the information field to the number of bytes actually filled in</span>
00357         <span class="comment">//  and then complete the request</span>
00358         <span class="comment">//</span>
00359 
00360         <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information = IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QueryFile.Length - Length;
00361 
00362     } finally {
00363 
00364         <span class="comment">//</span>
00365         <span class="comment">//  Release the file.</span>
00366         <span class="comment">//</span>
00367 
00368         <span class="keywordflow">if</span> (ReleaseFcb) {
00369 
00370             <a class="code" href="../../d3/d8/udfprocs_8h.html#a82">UdfReleaseFile</a>( IrpContext, Fcb );
00371         }
00372     }
00373 
00374     <span class="comment">//</span>
00375     <span class="comment">//  Complete the request if we didn't raise.</span>
00376     <span class="comment">//</span>
00377 
00378     <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, Irp, Status );
00379 
00380     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00381 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a260" doxytag="udfprocs.h::UdfCommonQueryVolInfo" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS UdfCommonQueryVolInfo           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d5/volinfo_8c-source.html#l00082">82</a> of file <a class="el" href="../../d8/d5/volinfo_8c-source.html">volinfo.c</a>.
<p>
References <a class="el" href="../../d0/d2/struct__IRP.html#o7">_IRP::AssociatedIrp</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02494">_IO_STACK_LOCATION::FileObject</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03252">IoGetCurrentIrpStackLocation</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01635">_IRP::IoStatus</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02069">_IO_STACK_LOCATION::Parameters</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d3/d8/udfprocs_8h.html#a109">TYPE_OF_OPEN</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01518">UdfAcquireVcbShared</a>, <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00809">UdfCompleteRequest()</a>, <a class="el" href="../../d7/d2/filobsup_8c-source.html#l00133">UdfDecodeFileObject()</a>, <a class="el" href="../../d8/d5/volinfo_8c-source.html#l00421">UdfQueryFsAttributeInfo()</a>, <a class="el" href="../../d8/d5/volinfo_8c-source.html#l00363">UdfQueryFsDeviceInfo()</a>, <a class="el" href="../../d8/d5/volinfo_8c-source.html#l00302">UdfQueryFsSizeInfo()</a>, <a class="el" href="../../d8/d5/volinfo_8c-source.html#l00212">UdfQueryFsVolumeInfo()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01521">UdfReleaseVcb</a>, <a class="el" href="../../d9/d4/udfs_2verfysup_8c-source.html#l00603">UdfVerifyVcb()</a>, <a class="el" href="../../d3/d8/udfprocs_8h.html#a263a113">UnopenedFileObject</a>, and <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00941">_FCB::Vcb</a>.
<p>
Referenced by <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00218">UdfFsdDispatch()</a>, and <a class="el" href="../../d1/d7/fspdisp_8c-source.html#l00038">UdfFspDispatch()</a>.
<p>
<pre class="fragment"><div>00089                    :
00090 
00091     This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> common routine <span class="keywordflow">for</span> querying volume information called by both
00092     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> fsd and fsp threads.
00093 
00094 Arguments:
00095 
00096     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> being processed
00097 
00098 Return Value:
00099 
00100     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - The <span class="keywordflow">return</span> status <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation
00101 
00102 --*/
00103 
00104 {
00105     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
00106     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp = <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>( Irp );
00107 
00108     ULONG Length;
00109 
00110     <a class="code" href="../../d3/d8/udfprocs_8h.html#a109">TYPE_OF_OPEN</a> TypeOfOpen;
00111     <a class="code" href="../../d7/d9/struct__FCB.html">PFCB</a> Fcb;
00112     <a class="code" href="../../d2/d9/struct__CCB.html">PCCB</a> Ccb;
00113 
00114     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00115 
00116     <span class="comment">//</span>
00117     <span class="comment">//  Reference our input parameters to make things easier</span>
00118     <span class="comment">//</span>
00119 
00120     Length = IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QueryVolume.Length;
00121 
00122     <span class="comment">//</span>
00123     <span class="comment">//  Decode the file object and fail if this an unopened file object.</span>
00124     <span class="comment">//</span>
00125 
00126     TypeOfOpen = <a class="code" href="../../d3/d8/udfprocs_8h.html#a174">UdfDecodeFileObject</a>( IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a>, &amp;Fcb, &amp;Ccb );
00127 
00128     <span class="keywordflow">if</span> (TypeOfOpen == <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a113">UnopenedFileObject</a>) {
00129 
00130         <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, Irp, STATUS_INVALID_PARAMETER );
00131         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00132     }
00133 
00134     <span class="comment">//</span>
00135     <span class="comment">//  Acquire the Vcb for this volume.</span>
00136     <span class="comment">//</span>
00137 
00138     <a class="code" href="../../d3/d8/udfprocs_8h.html#a75">UdfAcquireVcbShared</a>( IrpContext, Fcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o2">Vcb</a>, FALSE );
00139 
00140     <span class="comment">//</span>
00141     <span class="comment">//  Use a try-finally to facilitate cleanup.</span>
00142     <span class="comment">//</span>
00143 
00144     <span class="keywordflow">try</span> {
00145 
00146         <span class="comment">//</span>
00147         <span class="comment">//  Verify the Vcb.</span>
00148         <span class="comment">//</span>
00149 
00150         <a class="code" href="../../d8/d5/udfs_2verfysup_8c.html#a5">UdfVerifyVcb</a>( IrpContext, Fcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o2">Vcb</a> );
00151 
00152         <span class="comment">//</span>
00153         <span class="comment">//  Based on the information class we'll do different actions.  Each</span>
00154         <span class="comment">//  of the procedures that we're calling fills up the output buffer</span>
00155         <span class="comment">//  if possible and returns true if it successfully filled the buffer</span>
00156         <span class="comment">//  and false if it couldn't wait for any I/O to complete.</span>
00157         <span class="comment">//</span>
00158 
00159         <span class="keywordflow">switch</span> (IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QueryVolume.FsInformationClass) {
00160 
00161         <span class="keywordflow">case</span> FileFsSizeInformation:
00162 
00163             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d6/volinfo_8c.html#a3">UdfQueryFsSizeInfo</a>( IrpContext, Fcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o2">Vcb</a>, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o7">AssociatedIrp</a>.SystemBuffer, &amp;Length );
00164             <span class="keywordflow">break</span>;
00165 
00166         <span class="keywordflow">case</span> FileFsVolumeInformation:
00167 
00168             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d6/volinfo_8c.html#a2">UdfQueryFsVolumeInfo</a>( IrpContext, Fcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o2">Vcb</a>, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o7">AssociatedIrp</a>.SystemBuffer, &amp;Length );
00169             <span class="keywordflow">break</span>;
00170 
00171         <span class="keywordflow">case</span> FileFsDeviceInformation:
00172 
00173             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d6/volinfo_8c.html#a4">UdfQueryFsDeviceInfo</a>( IrpContext, Fcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o2">Vcb</a>, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o7">AssociatedIrp</a>.SystemBuffer, &amp;Length );
00174             <span class="keywordflow">break</span>;
00175 
00176         <span class="keywordflow">case</span> FileFsAttributeInformation:
00177 
00178             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d6/volinfo_8c.html#a5">UdfQueryFsAttributeInfo</a>( IrpContext, Fcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o2">Vcb</a>, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o7">AssociatedIrp</a>.SystemBuffer, &amp;Length );
00179             <span class="keywordflow">break</span>;
00180         }
00181 
00182         <span class="comment">//</span>
00183         <span class="comment">//  Set the information field to the number of bytes actually filled in</span>
00184         <span class="comment">//</span>
00185 
00186         <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information = IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QueryVolume.Length - Length;
00187 
00188     } finally {
00189 
00190         <span class="comment">//</span>
00191         <span class="comment">//  Release the Vcb.</span>
00192         <span class="comment">//</span>
00193 
00194         <a class="code" href="../../d3/d8/udfprocs_8h.html#a76">UdfReleaseVcb</a>( IrpContext, Fcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o2">Vcb</a> );
00195     }
00196 
00197     <span class="comment">//</span>
00198     <span class="comment">//  Complete the request if we didn't raise.</span>
00199     <span class="comment">//</span>
00200 
00201     <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, Irp, Status );
00202 
00203     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00204 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a261" doxytag="udfprocs.h::UdfCommonRead" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS UdfCommonRead           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d8/d4/udfs_2read_8c-source.html#l00068">68</a> of file <a class="el" href="../../d8/d4/udfs_2read_8c-source.html">udfs/read.c</a>.
<p>
References <a class="el" href="../../d3/d6/notify_8c-source.html#l00236">Add2Ptr</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00501">BooleanFlagOn</a>, <a class="el" href="../../d4/d7/fsrtlp_8h-source.html#l00231">BytesFromSectors</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00287">_UDF_DATA::CacheManagerCallbacks</a>, <a class="el" href="../../d6/d6/copysup_8c-source.html#l00031">CcCopyRead()</a>, <a class="el" href="../../d6/d7/fssup_8c-source.html#l00387">CcInitializeCacheMap()</a>, <a class="el" href="../../d8/d4/mdlsup_8c-source.html#l00030">CcMdlRead()</a>, <a class="el" href="../../d7/d1/cachesub_8c-source.html#l01222">CcSetReadAheadGranularity()</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00509">ClearFlag</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01535">_FILE_OBJECT::CurrentByteOffset</a>, <a class="el" href="../../d9/d2/lfsdata_8h-source.html#l00187">DebugUnwind</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01019">_FCB::EmbeddedOffset</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01018">_FCB::EmbeddedVsn</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02455">ExGetCurrentResourceThread</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01064">FCB_STATE_EMBEDDED_DATA</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00986">_FCB::FcbState</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02494">_IO_STACK_LOCATION::FileObject</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01533">_FILE_OBJECT::Flags</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01602">_IRP::Flags</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01491">FO_SYNCHRONOUS_IO</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l01315">FsRtlCheckLockForReadAccess()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l00823">FsRtlCheckOplock()</a>, <a class="el" href="../../d8/d2/fsrtl_2filter_8c-source.html#l00049">FsRtlNormalizeNtstatus()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03252">IoGetCurrentIrpStackLocation</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03528">IoIsErrorUserInduced</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01635">_IRP::IoStatus</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01241">IRP_CONTEXT_FLAG_ALLOC_IO</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01235">IRP_CONTEXT_FLAG_WAIT</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00140">IRP_MN_MDL</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01549">IRP_NOCACHE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01550">IRP_PAGING_IO</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01066">KeInitializeEvent</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01596">_IRP::MdlAddress</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00630">_VCB::MetadataFcb</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02069">_IO_STACK_LOCATION::Parameters</a>, <a class="el" href="../../d4/d2/cache_8h.html#a13">PCC_FILE_SIZES</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01522">_FILE_OBJECT::PrivateCacheMap</a>, <a class="el" href="../../d8/d4/udfs_2read_8c-source.html#l00060">READ_AHEAD_GRANULARITY</a>, <a class="el" href="../../d8/d4/udfs_2read_8c-source.html#l00048">SafeZeroMemory</a>, <a class="el" href="../../d4/d7/fsrtlp_8h-source.html#l00212">SectorAlign</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00232">SectorOffset</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00505">SetFlag</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d2/d4/internal_8c.html#a2">SynchronousIo</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00436">try_leave</a>, <a class="el" href="../../d3/d8/udfprocs_8h.html#a109">TYPE_OF_OPEN</a>, <a class="el" href="../../d6/d8/udfstruc_8h.html#a96">UDF_IO_CONTEXT</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01533">UdfAcquireFileShared</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01536">UdfAcquireFileSharedStarveExclusive</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01701">UdfAllocateIoContext</a>, <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00809">UdfCompleteRequest()</a>, <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00042">UdfData</a>, <a class="el" href="../../d7/d2/filobsup_8c-source.html#l00133">UdfDecodeFileObject()</a>, <a class="el" href="../../d3/d8/workque_8c-source.html#l00061">UdfFsdPostRequest()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00902">UdfMapUserBuffer</a>, <a class="el" href="../../d4/d6/deviosup_8c-source.html#l00201">UdfNonCachedRead()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00418">UdfNormalizeAndRaiseStatus()</a>, <a class="el" href="../../d3/d8/workque_8c-source.html#l00222">UdfOplockComplete()</a>, <a class="el" href="../../d3/d8/workque_8c-source.html#l00111">UdfPrePostIrp()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00406">UdfRaiseStatus()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01539">UdfReleaseFile</a>, <a class="el" href="../../d9/d4/udfs_2verfysup_8c-source.html#l00760">UdfVerifyFcbOperation()</a>, <a class="el" href="../../d3/d8/udfprocs_8h.html#a263a113">UnopenedFileObject</a>, <a class="el" href="../../d3/d8/udfprocs_8h.html#a263a116">UserDirectoryOpen</a>, <a class="el" href="../../d3/d8/udfprocs_8h.html#a263a117">UserFileOpen</a>, <a class="el" href="../../d3/d8/udfprocs_8h.html#a263a115">UserVolumeOpen</a>, and <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00941">_FCB::Vcb</a>.
<p>
Referenced by <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00218">UdfFsdDispatch()</a>, and <a class="el" href="../../d1/d7/fspdisp_8c-source.html#l00038">UdfFspDispatch()</a>.
<p>
<pre class="fragment"><div>00075                    :
00076 
00077     This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> common entry point <span class="keywordflow">for</span> <a class="code" href="../../d6/d5/io_2read_8c.html#a1">NtReadFile</a> calls.  For synchronous requests,
00078     CommonRead will complete <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> request in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current thread.  If not
00079     synchronous <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> request will be passed to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Fsp <span class="keywordflow">if</span> there <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a need to
00080     block.
00081 
00082 Arguments:
00083 
00084     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> to process
00085 
00086 Return Value:
00087 
00088     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - The result of <span class="keyword">this</span> operation.
00089 
00090 --*/
00091 
00092 {
00093     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00094     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp = <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>( Irp );
00095 
00096     <a class="code" href="../../d3/d8/udfprocs_8h.html#a109">TYPE_OF_OPEN</a> TypeOfOpen;
00097     <a class="code" href="../../d7/d9/struct__FCB.html">PFCB</a> Fcb;
00098     <a class="code" href="../../d2/d9/struct__CCB.html">PCCB</a> Ccb;
00099     <a class="code" href="../../d7/d5/struct__VCB.html">PVCB</a> Vcb;
00100 
00101     BOOLEAN Wait;
00102     ULONG PagingIo;
00103     ULONG <a class="code" href="../../d2/d4/internal_8c.html#a2">SynchronousIo</a>;
00104     ULONG NonCachedIo;
00105 
00106     LONGLONG StartingOffset;
00107     LONGLONG ByteRange;
00108     ULONG ByteCount;
00109     ULONG ReadByteCount;
00110     ULONG OriginalByteCount;
00111 
00112     PVOID SystemBuffer, UserBuffer;
00113 
00114     BOOLEAN ReleaseFile = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00115 
00116     <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> MappingFileObject;
00117 
00118     <a class="code" href="../../d3/d3/struct__UDF__IO__CONTEXT.html">UDF_IO_CONTEXT</a> LocalIoContext;
00119 
00120     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00121 
00122     <span class="comment">//</span>
00123     <span class="comment">//  If this is a zero length read then return SUCCESS immediately.</span>
00124     <span class="comment">//</span>
00125 
00126     <span class="keywordflow">if</span> (IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.Read.Length == 0) {
00127 
00128         <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, Irp, STATUS_SUCCESS );
00129         <span class="keywordflow">return</span> STATUS_SUCCESS;
00130     }
00131 
00132     <span class="comment">//</span>
00133     <span class="comment">//  Decode the file object and verify we support read on this.  It</span>
00134     <span class="comment">//  must be a user file, stream file or volume file (for a data disk).</span>
00135     <span class="comment">//</span>
00136 
00137     TypeOfOpen = <a class="code" href="../../d3/d8/udfprocs_8h.html#a174">UdfDecodeFileObject</a>( IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a>, &amp;Fcb, &amp;Ccb );
00138 
00139     Vcb = Fcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o2">Vcb</a>;
00140 
00141     <span class="keywordflow">if</span> ((TypeOfOpen == <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a113">UnopenedFileObject</a>) || (TypeOfOpen == <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a116">UserDirectoryOpen</a>)) {
00142 
00143         <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, Irp, STATUS_INVALID_DEVICE_REQUEST );
00144         <span class="keywordflow">return</span> STATUS_INVALID_DEVICE_REQUEST;
00145     }
00146 
00147     <span class="comment">//</span>
00148     <span class="comment">//  Examine our input parameters to determine if this is noncached and/or</span>
00149     <span class="comment">//  a paging io operation.</span>
00150     <span class="comment">//</span>
00151 
00152     Wait = <a class="code" href="../../d5/d5/cc_8h.html#a59">BooleanFlagOn</a>( IrpContext-&gt;Flags, IRP_CONTEXT_FLAG_WAIT );
00153     PagingIo = <a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a>, IRP_PAGING_IO );
00154     NonCachedIo = <a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a>, IRP_NOCACHE );
00155     <a class="code" href="../../d2/d4/internal_8c.html#a2">SynchronousIo</a> = <a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a>-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o18">Flags</a>, FO_SYNCHRONOUS_IO );
00156 
00157     <span class="comment">//</span>
00158     <span class="comment">//  Extract the range of the Io.</span>
00159     <span class="comment">//</span>
00160 
00161     StartingOffset = IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.Read.ByteOffset.QuadPart;
00162     OriginalByteCount = ByteCount = IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.Read.Length;
00163 
00164     ByteRange = StartingOffset + ByteCount;
00165 
00166     <span class="comment">//</span>
00167     <span class="comment">//  Make sure that Dasd access is always non-cached.</span>
00168     <span class="comment">//</span>
00169 
00170     <span class="keywordflow">if</span> (TypeOfOpen == <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a115">UserVolumeOpen</a>) {
00171 
00172         NonCachedIo = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00173     }
00174 
00175     <span class="comment">//</span>
00176     <span class="comment">//  Acquire the file shared to perform the read.  If we are doing paging IO,</span>
00177     <span class="comment">//  it may be the case that we would have a deadlock imminent because we may</span>
00178     <span class="comment">//  block on shared access, so starve out any exclusive waiters.  This requires</span>
00179     <span class="comment">//  a degree of caution - we believe that any paging IO bursts will recede and</span>
00180     <span class="comment">//  allow the exclusive waiter in.</span>
00181     <span class="comment">//</span>
00182 
00183     <span class="keywordflow">if</span> (PagingIo) {
00184 
00185         <a class="code" href="../../d3/d8/udfprocs_8h.html#a81">UdfAcquireFileSharedStarveExclusive</a>( IrpContext, Fcb );
00186     
00187     } <span class="keywordflow">else</span> {
00188         
00189         <a class="code" href="../../d3/d8/udfprocs_8h.html#a80">UdfAcquireFileShared</a>( IrpContext, Fcb );
00190     }
00191 
00192     <span class="comment">//</span>
00193     <span class="comment">//  Use a try-finally to facilitate cleanup.</span>
00194     <span class="comment">//</span>
00195 
00196     <span class="keywordflow">try</span> {
00197 
00198         <span class="comment">//</span>
00199         <span class="comment">//  Verify the Fcb.</span>
00200         <span class="comment">//</span>
00201 
00202         <a class="code" href="../../d8/d5/udfs_2verfysup_8c.html#a6">UdfVerifyFcbOperation</a>( IrpContext, Fcb );
00203 
00204         <span class="comment">//</span>
00205         <span class="comment">//  If this is a user request then verify the oplock and filelock state.</span>
00206         <span class="comment">//</span>
00207 
00208         <span class="keywordflow">if</span> (TypeOfOpen == <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a117">UserFileOpen</a>) {
00209 
00210             <span class="comment">//</span>
00211             <span class="comment">//  We check whether we can proceed</span>
00212             <span class="comment">//  based on the state of the file oplocks.</span>
00213             <span class="comment">//</span>
00214 
00215             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d8/fsrtl_8h.html#a165">FsRtlCheckOplock</a>( &amp;Fcb-&gt;Oplock,
00216                                        Irp,
00217                                        IrpContext,
00218                                        UdfOplockComplete,
00219                                        UdfPrePostIrp );
00220 
00221             <span class="comment">//</span>
00222             <span class="comment">//  If the result is not STATUS_SUCCESS then the Irp was completed</span>
00223             <span class="comment">//  elsewhere.</span>
00224             <span class="comment">//</span>
00225 
00226             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_SUCCESS) {
00227 
00228                 <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00229                 IrpContext = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00230 
00231                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( Status );
00232             }
00233 
00234             <span class="keywordflow">if</span> (!PagingIo &amp;&amp;
00235                 (Fcb-&gt;FileLock != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
00236                 !<a class="code" href="../../d1/d8/fsrtl_8h.html#a117">FsRtlCheckLockForReadAccess</a>( Fcb-&gt;FileLock, Irp )) {
00237 
00238                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( Status = STATUS_FILE_LOCK_CONFLICT );
00239             }
00240         }
00241 
00242         <span class="comment">//</span>
00243         <span class="comment">//  Complete the request if it begins beyond the end of file.</span>
00244         <span class="comment">//</span>
00245 
00246         <span class="keywordflow">if</span> (StartingOffset &gt;= Fcb-&gt;FileSize.QuadPart) {
00247 
00248             <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( Status = STATUS_END_OF_FILE );
00249         }
00250 
00251         <span class="comment">//</span>
00252         <span class="comment">//  Truncate the read if it extends beyond the end of the file.</span>
00253         <span class="comment">//</span>
00254 
00255         <span class="keywordflow">if</span> (ByteRange &gt; Fcb-&gt;FileSize.QuadPart) {
00256 
00257             ByteCount = (ULONG) (Fcb-&gt;FileSize.QuadPart - StartingOffset);
00258             ByteRange = Fcb-&gt;FileSize.QuadPart;
00259         }
00260 
00261         <span class="comment">//</span>
00262         <span class="comment">//  Now if the data is embedded in the ICB, map through the metadata</span>
00263         <span class="comment">//  stream to retrieve the bytes.</span>
00264         <span class="comment">//</span>
00265             
00266         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Fcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o10">FcbState</a>, FCB_STATE_EMBEDDED_DATA )) {
00267 
00268             <span class="comment">//</span>
00269             <span class="comment">//  The metadata stream better be here by now.</span>
00270             <span class="comment">//</span>
00271 
00272             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( Vcb-&gt;<a class="code" href="../../d7/d5/struct__VCB.html#o22">MetadataFcb</a>-&gt;FileObject != NULL );
00273 
00274             <span class="comment">//</span>
00275             <span class="comment">//  Bias our starting offset by the offset of the ICB in the metadata</span>
00276             <span class="comment">//  stream plus the offset of the data bytes in that ICB.  Obviously,</span>
00277             <span class="comment">//  we aren't doing non-cached IO here.</span>
00278             <span class="comment">//</span>
00279 
00280             StartingOffset += (<a class="code" href="../../d3/d8/fsrtlp_8h.html#a14">BytesFromSectors</a>( Vcb, Fcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o15">EmbeddedVsn</a> ) + Fcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o16">EmbeddedOffset</a>);
00281             MappingFileObject = Vcb-&gt;<a class="code" href="../../d7/d5/struct__VCB.html#o22">MetadataFcb</a>-&gt;FileObject;
00282             NonCachedIo = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00283 
00284         <span class="comment">//</span>
00285         <span class="comment">//  We are mapping through the caller's fileobject</span>
00286         <span class="comment">//</span>
00287 
00288         } <span class="keywordflow">else</span> {
00289 
00290             MappingFileObject = IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a>;
00291         }
00292         
00293         <span class="comment">//</span>
00294         <span class="comment">//  Handle the non-cached read first.</span>
00295         <span class="comment">//</span>
00296 
00297         <span class="keywordflow">if</span> (NonCachedIo) {
00298 
00299             <span class="comment">//</span>
00300             <span class="comment">//  If we have an unaligned transfer then post this request if</span>
00301             <span class="comment">//  we can't wait.  Unaligned means that the starting offset</span>
00302             <span class="comment">//  is not on a sector boundary or the read is not integral</span>
00303             <span class="comment">//  sectors.</span>
00304             <span class="comment">//</span>
00305 
00306             ReadByteCount = <a class="code" href="../../d3/d8/fsrtlp_8h.html#a12">SectorAlign</a>( Vcb, ByteCount );
00307 
00308             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/udfprocs_8h.html#a43">SectorOffset</a>( Vcb,  StartingOffset ) ||
00309                 (ReadByteCount &gt; OriginalByteCount)) {
00310 
00311                 <span class="keywordflow">if</span> (!Wait) {
00312 
00313                     <a class="code" href="../../d3/d8/udfprocs_8h.html#a122">UdfRaiseStatus</a>( IrpContext, STATUS_CANT_WAIT );
00314                 }
00315 
00316                 <span class="comment">//</span>
00317                 <span class="comment">//  Make sure we don't overwrite the buffer.</span>
00318                 <span class="comment">//</span>
00319 
00320                 ReadByteCount = ByteCount;
00321             }
00322 
00323             <span class="comment">//</span>
00324             <span class="comment">//  Initialize the IoContext for the read.</span>
00325             <span class="comment">//  If there is a context pointer, we need to make sure it was</span>
00326             <span class="comment">//  allocated and not a stale stack pointer.</span>
00327             <span class="comment">//</span>
00328 
00329             <span class="keywordflow">if</span> (IrpContext-&gt;IoContext == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ||
00330                 !<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpContext-&gt;Flags, IRP_CONTEXT_FLAG_ALLOC_IO )) {
00331 
00332                 <span class="comment">//</span>
00333                 <span class="comment">//  If we can wait, use the context on the stack.  Otherwise</span>
00334                 <span class="comment">//  we need to allocate one.</span>
00335                 <span class="comment">//</span>
00336 
00337                 <span class="keywordflow">if</span> (Wait) {
00338 
00339                     IrpContext-&gt;IoContext = &amp;LocalIoContext;
00340                     <a class="code" href="../../d5/d5/cc_8h.html#a61">ClearFlag</a>( IrpContext-&gt;Flags, IRP_CONTEXT_FLAG_ALLOC_IO );
00341 
00342                 } <span class="keywordflow">else</span> {
00343 
00344                     IrpContext-&gt;IoContext = <a class="code" href="../../d3/d8/udfprocs_8h.html#a94">UdfAllocateIoContext</a>();
00345                     <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( IrpContext-&gt;Flags, IRP_CONTEXT_FLAG_ALLOC_IO );
00346                 }
00347             }
00348 
00349             RtlZeroMemory( IrpContext-&gt;IoContext, <span class="keyword">sizeof</span>( <a class="code" href="../../d3/d3/struct__UDF__IO__CONTEXT.html">UDF_IO_CONTEXT</a> ));
00350     
00351             <span class="comment">//</span>
00352             <span class="comment">//  Store whether we allocated this context structure in the structure</span>
00353             <span class="comment">//  itself.</span>
00354             <span class="comment">//</span>
00355     
00356             IrpContext-&gt;IoContext-&gt;AllocatedContext =
00357                 <a class="code" href="../../d5/d5/cc_8h.html#a59">BooleanFlagOn</a>( IrpContext-&gt;Flags, IRP_CONTEXT_FLAG_ALLOC_IO );
00358 
00359             <span class="keywordflow">if</span> (Wait) {
00360 
00361                 <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>( &amp;IrpContext-&gt;IoContext-&gt;SyncEvent,
00362                                    NotificationEvent,
00363                                    FALSE );
00364 
00365             } <span class="keywordflow">else</span> {
00366 
00367                 IrpContext-&gt;IoContext-&gt;ResourceThreadId = <a class="code" href="../../d5/d8/ex_8h.html#a67">ExGetCurrentResourceThread</a>();
00368                 IrpContext-&gt;IoContext-&gt;Resource = Fcb-&gt;Resource;
00369                 IrpContext-&gt;IoContext-&gt;RequestedByteCount = ByteCount;
00370             }
00371     
00372             <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information = ReadByteCount;
00373 
00374             <span class="comment">//</span>
00375             <span class="comment">//  Call the NonCacheIo routine to perform the actual read.</span>
00376             <span class="comment">//</span>
00377 
00378             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d8/udfprocs_8h.html#a161">UdfNonCachedRead</a>( IrpContext, Fcb, StartingOffset, ReadByteCount );
00379 
00380             <span class="comment">//</span>
00381             <span class="comment">//  Don't complete this request now if STATUS_PENDING was returned.</span>
00382             <span class="comment">//</span>
00383 
00384             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_PENDING) {
00385 
00386                 <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00387                 ReleaseFile = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00388 
00389             <span class="comment">//</span>
00390             <span class="comment">//  Test is we should zero part of the buffer or update the</span>
00391             <span class="comment">//  synchronous file position.</span>
00392             <span class="comment">//</span>
00393 
00394             } <span class="keywordflow">else</span> {
00395 
00396                 <span class="comment">//</span>
00397                 <span class="comment">//  Convert any unknown error code to IO_ERROR.</span>
00398                 <span class="comment">//</span>
00399 
00400                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00401 
00402                     <span class="comment">//</span>
00403                     <span class="comment">//  Set the information field to zero.</span>
00404                     <span class="comment">//</span>
00405 
00406                     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information = 0;
00407 
00408                     <span class="comment">//</span>
00409                     <span class="comment">//  Raise if this is a user induced error.</span>
00410                     <span class="comment">//</span>
00411 
00412                     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d5/io_8h.html#a232">IoIsErrorUserInduced</a>( Status )) {
00413 
00414                         <a class="code" href="../../d3/d8/udfprocs_8h.html#a122">UdfRaiseStatus</a>( IrpContext, Status );
00415                     }
00416 
00417                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d8/fsrtl_8h.html#a136">FsRtlNormalizeNtstatus</a>( Status, STATUS_UNEXPECTED_IO_ERROR );
00418 
00419                 <span class="comment">//</span>
00420                 <span class="comment">//  Check if there is any portion of the user's buffer to zero.</span>
00421                 <span class="comment">//</span>
00422 
00423                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ReadByteCount != ByteCount) {
00424 
00425                     <a class="code" href="../../d3/d8/udfprocs_8h.html#a70">UdfMapUserBuffer</a>( IrpContext, &amp;UserBuffer );
00426                     
00427                     <a class="code" href="../../d7/d5/udfs_2read_8c.html#a2">SafeZeroMemory</a>( IrpContext,
00428                                     <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( UserBuffer,
00429                                              ByteCount,
00430                                              PVOID ),
00431                                     ReadByteCount - ByteCount );
00432 
00433                     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information = ByteCount;
00434                 }
00435 
00436                 <span class="comment">//</span>
00437                 <span class="comment">//  Update the file position if this is a synchronous request.</span>
00438                 <span class="comment">//</span>
00439 
00440                 <span class="keywordflow">if</span> (<a class="code" href="../../d2/d4/internal_8c.html#a2">SynchronousIo</a> &amp;&amp; !PagingIo &amp;&amp; <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00441 
00442                     IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a>-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o20">CurrentByteOffset</a>.QuadPart = ByteRange;
00443                 }
00444             }
00445 
00446             <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( NOTHING );
00447         }
00448 
00449         <span class="comment">//</span>
00450         <span class="comment">//  Handle the cached case.  Start by initializing the private</span>
00451         <span class="comment">//  cache map.</span>
00452         <span class="comment">//</span>
00453 
00454         <span class="keywordflow">if</span> (MappingFileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o7">PrivateCacheMap</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00455 
00456             <span class="comment">//</span>
00457             <span class="comment">//  The metadata Fcb stream was fired up before any data read.  We should never</span>
00458             <span class="comment">//  see it here.</span>
00459             <span class="comment">//</span>
00460 
00461             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( MappingFileObject != Vcb-&gt;<a class="code" href="../../d7/d5/struct__VCB.html#o22">MetadataFcb</a>-&gt;FileObject );
00462             
00463             <span class="comment">//</span>
00464             <span class="comment">//  Now initialize the cache map.</span>
00465             <span class="comment">//</span>
00466 
00467             <a class="code" href="../../d4/d2/cache_8h.html#a58">CcInitializeCacheMap</a>( IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a>,
00468                                   (<a class="code" href="../../d1/d9/struct__CC__FILE__SIZES.html">PCC_FILE_SIZES</a>) &amp;Fcb-&gt;AllocationSize,
00469                                   FALSE,
00470                                   &amp;<a class="code" href="../../d0/d8/udfdata_8c.html#a2">UdfData</a>.<a class="code" href="../../d2/d3/struct__UDF__DATA.html#o20">CacheManagerCallbacks</a>,
00471                                   Fcb );
00472 
00473             <a class="code" href="../../d4/d2/cache_8h.html#a86">CcSetReadAheadGranularity</a>( IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a>, READ_AHEAD_GRANULARITY );
00474         }
00475 
00476         <span class="comment">//</span>
00477         <span class="comment">//  Read from the cache if this is not an Mdl read.</span>
00478         <span class="comment">//</span>
00479 
00480         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpContext-&gt;MinorFunction, IRP_MN_MDL )) {
00481 
00482             <span class="comment">//</span>
00483             <span class="comment">// If we are in the Fsp now because we had to wait earlier,</span>
00484             <span class="comment">// we must map the user buffer, otherwise we can use the</span>
00485             <span class="comment">// user's buffer directly.</span>
00486             <span class="comment">//</span>
00487 
00488             <a class="code" href="../../d3/d8/udfprocs_8h.html#a70">UdfMapUserBuffer</a>( IrpContext, &amp;SystemBuffer);
00489 
00490             <span class="comment">//</span>
00491             <span class="comment">// Now try to do the copy.</span>
00492             <span class="comment">//</span>
00493 
00494             <span class="keywordflow">if</span> (!<a class="code" href="../../d4/d2/cache_8h.html#a74">CcCopyRead</a>( MappingFileObject,
00495                              (PLARGE_INTEGER) &amp;StartingOffset,
00496                              ByteCount,
00497                              Wait,
00498                              SystemBuffer,
00499                              &amp;<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a> )) {
00500 
00501                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( Status = STATUS_CANT_WAIT );
00502             }
00503 
00504             <span class="comment">//</span>
00505             <span class="comment">//  If the call didn't succeed, raise the error status</span>
00506             <span class="comment">//</span>
00507 
00508             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status )) {
00509 
00510                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a123">UdfNormalizeAndRaiseStatus</a>( IrpContext, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status );
00511             }
00512 
00513             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status;
00514 
00515         <span class="comment">//</span>
00516         <span class="comment">//  Otherwise perform the MdlRead operation.</span>
00517         <span class="comment">//</span>
00518 
00519         } <span class="keywordflow">else</span> {
00520 
00521             <a class="code" href="../../d4/d2/cache_8h.html#a78">CcMdlRead</a>( MappingFileObject,
00522                        (PLARGE_INTEGER) &amp;StartingOffset,
00523                        ByteCount,
00524                        &amp;<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o2">MdlAddress</a>,
00525                        &amp;<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a> );
00526 
00527             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status;
00528         }
00529 
00530         <span class="comment">//</span>
00531         <span class="comment">//  Update the current file position in the user file object.</span>
00532         <span class="comment">//</span>
00533 
00534         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d4/internal_8c.html#a2">SynchronousIo</a> &amp;&amp; !PagingIo &amp;&amp; <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00535 
00536             IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a>-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o20">CurrentByteOffset</a>.QuadPart = ByteRange;
00537         }
00538 
00539     } finally {
00540 
00541         <a class="code" href="../../d8/d3/lfsdata_8h.html#a3">DebugUnwind</a>( <span class="stringliteral">"UdfCommonRead"</span> );
00542 
00543         <span class="comment">//</span>
00544         <span class="comment">//  Release the Fcb.</span>
00545         <span class="comment">//</span>
00546 
00547         <span class="keywordflow">if</span> (ReleaseFile) {
00548 
00549             <a class="code" href="../../d3/d8/udfprocs_8h.html#a82">UdfReleaseFile</a>( IrpContext, Fcb );
00550         }
00551     }
00552 
00553     <span class="comment">//</span>
00554     <span class="comment">//  Post the request if we got CANT_WAIT.</span>
00555     <span class="comment">//</span>
00556 
00557     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_CANT_WAIT) {
00558 
00559         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d9/workque_8c.html#a4">UdfFsdPostRequest</a>( IrpContext, Irp );
00560 
00561     <span class="comment">//</span>
00562     <span class="comment">//  Otherwise complete the request.</span>
00563     <span class="comment">//</span>
00564 
00565     } <span class="keywordflow">else</span> {
00566 
00567         <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, Irp, Status );
00568     }
00569 
00570     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00571 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a262" doxytag="udfprocs.h::UdfCommonSetInfo" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS UdfCommonSetInfo           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d2/fileinfo_8c-source.html#l00385">385</a> of file <a class="el" href="../../d5/d2/fileinfo_8c-source.html">fileinfo.c</a>.
<p>
References <a class="el" href="../../d1/d4/io_8h-source.html#l01194">_DEVICE_OBJECT::AlignmentRequirement</a>, <a class="el" href="../../d0/d2/struct__IRP.html#o7">_IRP::AssociatedIrp</a>, <a class="el" href="../../d7/d1/rtqkey_8c-source.html#l00042">Buffer</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01535">_FILE_OBJECT::CurrentByteOffset</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02488">_IO_STACK_LOCATION::DeviceObject</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02494">_IO_STACK_LOCATION::FileObject</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01533">_FILE_OBJECT::Flags</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01493">FO_NO_INTERMEDIATE_BUFFERING</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03252">IoGetCurrentIrpStackLocation</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02069">_IO_STACK_LOCATION::Parameters</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00436">try_leave</a>, <a class="el" href="../../d3/d8/udfprocs_8h.html#a109">TYPE_OF_OPEN</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01533">UdfAcquireFileShared</a>, <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00809">UdfCompleteRequest()</a>, <a class="el" href="../../d7/d2/filobsup_8c-source.html#l00133">UdfDecodeFileObject()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01567">UdfLockFcb</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01539">UdfReleaseFile</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01577">UdfUnlockFcb</a>, <a class="el" href="../../d9/d4/udfs_2verfysup_8c-source.html#l00760">UdfVerifyFcbOperation()</a>, and <a class="el" href="../../d3/d8/udfprocs_8h.html#a263a117">UserFileOpen</a>.
<p>
Referenced by <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00218">UdfFsdDispatch()</a>, and <a class="el" href="../../d1/d7/fspdisp_8c-source.html#l00038">UdfFspDispatch()</a>.
<p>
<pre class="fragment"><div>00392                    :
00393 
00394     This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> common routine <span class="keywordflow">for</span> set <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> information called by both <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00395     fsd and fsp threads.  We <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> support operations which set <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> position.
00396 
00397 Arguments:
00398 
00399     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> to process.
00400 
00401 Return Value:
00402 
00403     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - The <span class="keywordflow">return</span> status <span class="keywordflow">for</span> <span class="keyword">this</span> operation.
00404 
00405 --*/
00406 
00407 {
00408     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
00409 
00410     <a class="code" href="../../d3/d8/udfprocs_8h.html#a109">TYPE_OF_OPEN</a> TypeOfOpen;
00411     <a class="code" href="../../d7/d9/struct__FCB.html">PFCB</a> Fcb;
00412     <a class="code" href="../../d2/d9/struct__CCB.html">PCCB</a> Ccb;
00413 
00414     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp = <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>( Irp );
00415 
00416     PFILE_POSITION_INFORMATION <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>;
00417 
00418     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00419 
00420     <span class="comment">//</span>
00421     <span class="comment">//  Decode the file object</span>
00422     <span class="comment">//</span>
00423 
00424     TypeOfOpen = <a class="code" href="../../d3/d8/udfprocs_8h.html#a174">UdfDecodeFileObject</a>( IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a>, &amp;Fcb, &amp;Ccb );
00425 
00426     <span class="comment">//</span>
00427     <span class="comment">//  We only support a SetPositionInformation on a user file.</span>
00428     <span class="comment">//</span>
00429 
00430     <span class="keywordflow">if</span> ((TypeOfOpen != <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a117">UserFileOpen</a>) ||
00431         (IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QueryFile.FileInformationClass != FilePositionInformation)) {
00432 
00433         <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, Irp, Status );
00434         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00435     }
00436 
00437     <span class="comment">//</span>
00438     <span class="comment">//  Acquire shared access to this file.</span>
00439     <span class="comment">//</span>
00440 
00441     <a class="code" href="../../d3/d8/udfprocs_8h.html#a80">UdfAcquireFileShared</a>( IrpContext, Fcb );
00442 
00443     <span class="keywordflow">try</span> {
00444 
00445         <span class="comment">//</span>
00446         <span class="comment">//  Make sure the Fcb is in a usable condition.  This</span>
00447         <span class="comment">//  will raise an error condition if the fcb is unusable</span>
00448         <span class="comment">//</span>
00449 
00450         <a class="code" href="../../d8/d5/udfs_2verfysup_8c.html#a6">UdfVerifyFcbOperation</a>( IrpContext, Fcb );
00451 
00452         <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> = <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o7">AssociatedIrp</a>.SystemBuffer;
00453 
00454         <span class="comment">//</span>
00455         <span class="comment">//  Check if the file does not use intermediate buffering.  If it</span>
00456         <span class="comment">//  does not use intermediate buffering then the new position we're</span>
00457         <span class="comment">//  supplied must be aligned properly for the device</span>
00458         <span class="comment">//</span>
00459 
00460         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a>-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o18">Flags</a>, FO_NO_INTERMEDIATE_BUFFERING ) &amp;&amp;
00461             ((<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;CurrentByteOffset.LowPart &amp; IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o57">DeviceObject</a>-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o17">AlignmentRequirement</a>) != 0)) {
00462 
00463             <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( NOTHING );
00464         }
00465 
00466         <span class="comment">//</span>
00467         <span class="comment">//  The input parameter is fine so set the current byte offset and</span>
00468         <span class="comment">//  complete the request</span>
00469         <span class="comment">//</span>
00470 
00471         <span class="comment">//</span>
00472         <span class="comment">//  Lock the Fcb to provide synchronization.</span>
00473         <span class="comment">//</span>
00474 
00475         <a class="code" href="../../d3/d8/udfprocs_8h.html#a90">UdfLockFcb</a>( IrpContext, Fcb );
00476         IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a>-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o20">CurrentByteOffset</a> = <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;CurrentByteOffset;
00477         <a class="code" href="../../d3/d8/udfprocs_8h.html#a91">UdfUnlockFcb</a>( IrpContext, Fcb );
00478 
00479         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00480 
00481     } finally {
00482 
00483         <a class="code" href="../../d3/d8/udfprocs_8h.html#a82">UdfReleaseFile</a>( IrpContext, Fcb );
00484     }
00485 
00486     <span class="comment">//</span>
00487     <span class="comment">//  Complete the request if there was no raise.</span>
00488     <span class="comment">//</span>
00489 
00490     <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, Irp, Status );
00491     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00492 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a156" doxytag="udfprocs.h::UdfCompleteMdl" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS UdfCompleteMdl           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d1/udfs_2cachesup_8c-source.html#l00285">285</a> of file <a class="el" href="../../d9/d1/udfs_2cachesup_8c-source.html">udfs/cachesup.c</a>.
<p>
References <a class="el" href="../../d8/d4/mdlsup_8c-source.html#l00381">CcMdlReadComplete()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03252">IoGetCurrentIrpStackLocation</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01596">_IRP::MdlAddress</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00809">UdfCompleteRequest()</a>.
<p>
Referenced by <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00218">UdfFsdDispatch()</a>.
<p>
<pre class="fragment"><div>00292                    :
00293 
00294     This routine performs <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function of completing Mdl reads.
00295     It should be called <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> from <a class="code" href="../../d7/d5/udfs_2read_8c.html#a4">UdfCommonRead</a>.
00296 
00297 Arguments:
00298 
00299     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> originating <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>.
00300 
00301 Return Value:
00302 
00303     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - Will always be STATUS_SUCCESS.
00304 
00305 --*/
00306 
00307 {
00308     <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject;
00309 
00310     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00311 
00312     <span class="comment">//</span>
00313     <span class="comment">// Do completion processing.</span>
00314     <span class="comment">//</span>
00315 
00316     FileObject = <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>( Irp )-&gt;FileObject;
00317 
00318     <a class="code" href="../../d4/d2/cache_8h.html#a79">CcMdlReadComplete</a>( FileObject, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o2">MdlAddress</a> );
00319 
00320     <span class="comment">//</span>
00321     <span class="comment">// Mdl is now deallocated.</span>
00322     <span class="comment">//</span>
00323 
00324     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o2">MdlAddress</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00325 
00326     <span class="comment">//</span>
00327     <span class="comment">// Complete the request and exit right away.</span>
00328     <span class="comment">//</span>
00329 
00330     <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, Irp, STATUS_SUCCESS );
00331 
00332     <span class="keywordflow">return</span> STATUS_SUCCESS;
00333 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a150" doxytag="udfprocs.h::UdfCompletePcb" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS UdfCompletePcb           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d7/d5/struct__VCB.html">PVCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Vcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d4/d9/struct__PCB.html">PPCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Pcb</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d5/allocsup_8c-source.html#l00804">804</a> of file <a class="el" href="../../d3/d5/allocsup_8c-source.html">allocsup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00352">ASSERT_IRP_CONTEXT</a>, <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00348">ASSERT_PCB</a>, <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00336">ASSERT_VCB</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d6/d8/udfstruc_8h.html#a129a115">Physical</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00453">UdfFreePool()</a>, <a class="el" href="../../d3/d5/allocsup_8c-source.html#l01406">UdfLoadSparingTables()</a>, and <a class="el" href="../../d6/d8/alpha_2exdsptch_8c-source.html#l00105">Virtual</a>.
<p>
Referenced by <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l01444">UdfMountVolume()</a>, and <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l02043">UdfVerifyVolume()</a>.
<p>
<pre class="fragment"><div>00812                    :
00813 
00814     This routine completes initialization of a Pcb which has been filled
00815     in with partition descriptors.  Initialization-time data such as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00816     physical partition descriptors will be returned to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system.
00817 
00818 Arguments:
00819 
00820     Vcb - Vcb of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> volume <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Pcb describes
00821 
00822     Pcb - Pcb being completed
00823 
00824 Return Value:
00825 
00826     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> according to whether intialization completion was succesful
00827 
00828 --*/
00829 
00830 {
00831     ULONG Reference;
00832 
00833     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00834 
00835     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00836 
00837     <span class="comment">//</span>
00838     <span class="comment">//  Check inputs</span>
00839     <span class="comment">//</span>
00840 
00841     <a class="code" href="../../d1/d8/udfdata_8h.html#a28">ASSERT_IRP_CONTEXT</a>( IrpContext );
00842     <a class="code" href="../../d1/d8/udfdata_8h.html#a12">ASSERT_VCB</a>( Vcb );
00843     <a class="code" href="../../d1/d8/udfdata_8h.html#a24">ASSERT_PCB</a>( Pcb );
00844 
00845     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( +1, Dbg, <span class="stringliteral">"UdfCompletePcb, Vcb %08x Pcb %08x\n"</span>, Vcb, Pcb ));
00846 
00847     <span class="comment">//</span>
00848     <span class="comment">//  Complete intialization all physical partitions</span>
00849     <span class="comment">//</span>
00850 
00851     <span class="keywordflow">for</span> (Reference = 0;
00852          Reference &lt; Pcb-&gt;Partitions;
00853          Reference++) {
00854 
00855         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( 0, Dbg, <span class="stringliteral">"UdfCompletePcb, Examining Ref %u (type %u)!\n"</span>, Reference, Pcb-&gt;Partition[Reference].Type));
00856 
00857         <span class="keywordflow">switch</span> (Pcb-&gt;Partition[Reference].Type) {
00858 
00859             <span class="keywordflow">case</span> <a class="code" href="../../d6/d8/udfstruc_8h.html#a129a115">Physical</a>:
00860 
00861                 <span class="keywordflow">if</span> (Pcb-&gt;Partition[Reference].Physical.PartitionDescriptor == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00862 
00863                     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( 0, Dbg,
00864                                  <span class="stringliteral">"UdfCompletePcb, ... but didn't find Partition# %u!\n"</span>,
00865                                  Pcb-&gt;Partition[Reference].Physical.PartitionNumber ));
00866 
00867                     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( -1, Dbg, <span class="stringliteral">"UdfCompletePcb -&gt; STATUS_DISK_CORRUPT_ERROR\n"</span> ));
00868 
00869                     <span class="keywordflow">return</span> STATUS_DISK_CORRUPT_ERROR;
00870                 }
00871 
00872                 Pcb-&gt;Partition[Reference].Physical.Start =
00873                     Pcb-&gt;Partition[Reference].Physical.PartitionDescriptor-&gt;Start;
00874                 Pcb-&gt;Partition[Reference].Physical.Length =
00875                     Pcb-&gt;Partition[Reference].Physical.PartitionDescriptor-&gt;Length;
00876 
00877 
00878                 <span class="comment">//</span>
00879                 <span class="comment">//  Retrieve the sparing information at this point if appropriate.</span>
00880                 <span class="comment">//  We have to do this when we can map logical -&gt; physical blocks.</span>
00881                 <span class="comment">//</span>
00882 
00883                 <span class="keywordflow">if</span> (Pcb-&gt;Partition[Reference].Physical.SparingMap) {
00884 
00885                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d6/allocsup_8c.html#a3">UdfLoadSparingTables</a>( IrpContext,
00886                                                    Vcb,
00887                                                    Pcb,
00888                                                    Reference );
00889 
00890                     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00891 
00892                         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( -1, Dbg,
00893                                      <span class="stringliteral">"UdfCompletePcb -&gt; %08x\n"</span>, Status ));
00894                         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00895                     }
00896                 }
00897 
00898                 <span class="comment">//</span>
00899                 <span class="comment">//  We will not need the descriptor or sparing map anymore, so drop them.  </span>
00900                 <span class="comment">//</span>
00901 
00902                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a124">UdfFreePool</a>( &amp;Pcb-&gt;Partition[Reference].Physical.PartitionDescriptor );
00903                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a124">UdfFreePool</a>( &amp;Pcb-&gt;Partition[Reference].Physical.SparingMap );
00904                 <span class="keywordflow">break</span>;
00905 
00906             <span class="keywordflow">case</span> <a class="code" href="../../d5/d9/alpha_2exdsptch_8c.html#a2">Virtual</a>:
00907                 <span class="keywordflow">break</span>;
00908 
00909             <span class="keywordflow">default</span>:
00910 
00911                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(FALSE);
00912                 <span class="keywordflow">break</span>;
00913         }
00914     }
00915 
00916     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( -1, Dbg, <span class="stringliteral">"UdfCompletePcb -&gt; STATUS_SUCCESS\n"</span> ));
00917 
00918     <span class="keywordflow">return</span> STATUS_SUCCESS;
00919 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a129" doxytag="udfprocs.h::UdfCompleteRequest" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID UdfCompleteRequest           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN NTSTATUS&nbsp;</td>
          <td class="mdname" nowrap> <em>Status</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00809">809</a> of file <a class="el" href="../../d1/d7/udfdata_8c-source.html">udfdata.c</a>.
<p>
References <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00357">ASSERT_OPTIONAL_IRP</a>, <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00353">ASSERT_OPTIONAL_IRP_CONTEXT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01602">_IRP::Flags</a>, <a class="el" href="../../d8/d7/exboosts_8h-source.html#l00063">IO_CD_ROM_INCREMENT</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02960">IoCompleteRequest</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01635">_IRP::IoStatus</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01556">IRP_INPUT_OPERATION</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00048">NT_ERROR</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l01437">UdfCleanupIrpContext()</a>.
<p>
Referenced by <a class="el" href="../../d9/d6/udfs_2cleanup_8c-source.html#l00042">UdfCommonCleanup()</a>, <a class="el" href="../../d3/d8/close_8c-source.html#l00319">UdfCommonClose()</a>, <a class="el" href="../../d4/d7/udfs_2create_8c-source.html#l00108">UdfCommonCreate()</a>, <a class="el" href="../../d3/d6/udfs_2devctrl_8c-source.html#l00069">UdfCommonDevControl()</a>, <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l00255">UdfCommonDirControl()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l00283">UdfCommonFsControl()</a>, <a class="el" href="../../d3/d4/lockctrl_8c-source.html#l00046">UdfCommonLockControl()</a>, <a class="el" href="../../d5/d8/udfs_2pnp_8c-source.html#l00075">UdfCommonPnp()</a>, <a class="el" href="../../d5/d2/fileinfo_8c-source.html#l00156">UdfCommonQueryInfo()</a>, <a class="el" href="../../d8/d5/volinfo_8c-source.html#l00082">UdfCommonQueryVolInfo()</a>, <a class="el" href="../../d8/d4/udfs_2read_8c-source.html#l00068">UdfCommonRead()</a>, <a class="el" href="../../d5/d2/fileinfo_8c-source.html#l00385">UdfCommonSetInfo()</a>, <a class="el" href="../../d9/d1/udfs_2cachesup_8c-source.html#l00285">UdfCompleteMdl()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l00966">UdfDismountVolume()</a>, <a class="el" href="../../d3/d6/udfs_2devctrl_8c-source.html#l00337">UdfDvdReadStructure()</a>, <a class="el" href="../../d3/d6/udfs_2devctrl_8c-source.html#l00227">UdfDvdTransferKey()</a>, <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00218">UdfFsdDispatch()</a>, <a class="el" href="../../d3/d8/close_8c-source.html#l00099">UdfFspClose()</a>, <a class="el" href="../../d1/d7/fspdisp_8c-source.html#l00038">UdfFspDispatch()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l01271">UdfInvalidateVolumes()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l01236">UdfIsPathnameValid()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l01064">UdfIsVolumeDirty()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l01175">UdfIsVolumeMounted()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l00780">UdfLockVolume()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l01444">UdfMountVolume()</a>, <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l00904">UdfNotifyChangeDirectory()</a>, <a class="el" href="../../d3/d8/workque_8c-source.html#l00222">UdfOplockComplete()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l00470">UdfOplockRequest()</a>, <a class="el" href="../../d9/d4/udfs_2verfysup_8c-source.html#l00042">UdfPerformVerify()</a>, <a class="el" href="../../d5/d8/udfs_2pnp_8c-source.html#l00632">UdfPnpCancelRemove()</a>, <a class="el" href="../../d5/d8/udfs_2pnp_8c-source.html#l00194">UdfPnpQueryRemove()</a>, <a class="el" href="../../d5/d8/udfs_2pnp_8c-source.html#l00350">UdfPnpRemove()</a>, <a class="el" href="../../d5/d8/udfs_2pnp_8c-source.html#l00500">UdfPnpSurpriseRemove()</a>, <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00539">UdfProcessException()</a>, <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l00334">UdfQueryDirectory()</a>, <a class="el" href="../../d3/d8/close_8c-source.html#l00634">UdfQueueClose()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l00877">UdfUnlockVolume()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l00363">UdfUserFsctl()</a>, and <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l02043">UdfVerifyVolume()</a>.
<p>
<pre class="fragment"><div>00817                    :
00818 
00819     This routine completes a <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> and cleans up <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> IrpContext.  Either or
00820     both of these may not be specified.
00821 
00822 Arguments:
00823 
00824     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> being processed.
00825 
00826     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> status to complete <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> with
00827 
00828 Return Value:
00829 
00830     None.
00831 
00832 --*/
00833 
00834 {
00835     <a class="code" href="../../d1/d8/udfdata_8h.html#a29">ASSERT_OPTIONAL_IRP_CONTEXT</a>( IrpContext );
00836     <a class="code" href="../../d1/d8/udfdata_8h.html#a33">ASSERT_OPTIONAL_IRP</a>( Irp );
00837 
00838     <span class="comment">//</span>
00839     <span class="comment">//  Cleanup the IrpContext if passed in here.</span>
00840     <span class="comment">//</span>
00841 
00842     <span class="keywordflow">if</span> (ARGUMENT_PRESENT( IrpContext )) {
00843 
00844         <a class="code" href="../../d3/d8/udfprocs_8h.html#a208">UdfCleanupIrpContext</a>( IrpContext, FALSE );
00845     }
00846 
00847     <span class="comment">//</span>
00848     <span class="comment">//  If we have an Irp then complete the irp.</span>
00849     <span class="comment">//</span>
00850 
00851     <span class="keywordflow">if</span> (ARGUMENT_PRESENT( Irp )) {
00852 
00853         <span class="comment">//</span>
00854         <span class="comment">//  Clear the information field in case we have used this Irp</span>
00855         <span class="comment">//  internally.</span>
00856         <span class="comment">//</span>
00857 
00858         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a3">NT_ERROR</a>( Status ) &amp;&amp;
00859             <a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o3">Flags</a>, IRP_INPUT_OPERATION )) {
00860 
00861             <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information = 0;
00862         }
00863 
00864         <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status = <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00865         <a class="code" href="../../d0/d5/io_8h.html#a224">IoCompleteRequest</a>( Irp, IO_CD_ROM_INCREMENT );
00866     }
00867 
00868     <span class="keywordflow">return</span>;
00869 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a134" doxytag="udfprocs.h::UdfComputeCrc16" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a> UdfComputeCrc16           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PUCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>Buffer</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ByteCount</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Referenced by <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l02617">UdfVerifyDescriptor()</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a135" doxytag="udfprocs.h::UdfComputeCrc16Uni" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a> UdfComputeCrc16Uni           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">PWCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>Buffer</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>CharCount</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d7/udfdata_8c-source.html#l01194">1194</a> of file <a class="el" href="../../d1/d7/udfdata_8c-source.html">udfdata.c</a>.
<p>
References <a class="el" href="../../d7/d1/rtqkey_8c-source.html#l00042">Buffer</a>, <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00202">UdfCrcTable</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d6/d4/namesup_8c-source.html#l00389">UdfGenerate8dot3Name()</a>, and <a class="el" href="../../d6/d4/namesup_8c-source.html#l00927">UdfRenderNameToLegalUnicode()</a>.
<p>
<pre class="fragment"><div>01201                    :
01202 
01203     This routine generates a 16 bit CRC of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> input buffer in accordance
01204     with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> precomputed CRC table.
01205     
01206     It performs a byte-order independent crc (hi then lo). This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a bit
01207     suspect, but <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called <span class="keywordflow">for</span> in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specification. 
01208 
01209 Arguments:
01210 
01211     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer to generate <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> CRC <span class="keywordflow">for</span>.
01212 
01213     ShortCount - Number of wide characters in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer.
01214 
01215 Return Value:
01216 
01217     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> - The 16bit CRC
01218 
01219 --*/
01220 
01221 {
01222     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> Crc = 0;
01223 
01224     <span class="comment">//</span>
01225     <span class="comment">//  Byte order independent CRC, hi byte to low byte per character.</span>
01226     <span class="comment">//</span>
01227 
01228     <span class="keywordflow">while</span> (CharCount-- &gt; 0) {
01229 
01230         Crc = <a class="code" href="../../d0/d8/udfdata_8c.html#a29">UdfCrcTable</a>[((Crc &gt;&gt; 8) ^ (*<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> &gt;&gt; 8)) &amp; 0xff] ^ (Crc &lt;&lt; 8);
01231         Crc = <a class="code" href="../../d0/d8/udfdata_8c.html#a29">UdfCrcTable</a>[((Crc &gt;&gt; 8) ^ (*<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>++ &amp; 0xff)) &amp; 0xff] ^ (Crc &lt;&lt; 8);
01232     }
01233 
01234     <span class="keywordflow">return</span> Crc;
01235 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a181" doxytag="udfprocs.h::UdfConvertCS0DstringToUnicode" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID UdfConvertCS0DstringToUnicode           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>Dstring</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN UCHAR Length&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN UCHAR FieldLength&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>Name</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d4/namesup_8c-source.html#l00689">689</a> of file <a class="el" href="../../d6/d4/namesup_8c-source.html">namesup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00352">ASSERT_IRP_CONTEXT</a>, <a class="el" href="../../d2/d0/bench_8c-source.html#l00050">CHAR</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00061">Min</a>, <a class="el" href="../../d9/d9/geninst_8c-source.html#l00154">Name</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00330">SwapCopyUchar2</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01177">UdfCS0DstringUnicodeSize()</a>, and <a class="el" href="../../d3/d9/nt6_2user32_8def-source.html#l00844">Unicode</a>.
<p>
Referenced by <a class="el" href="../../d5/d7/dirsup_8c-source.html#l00360">UdfUpdateDirNames()</a>, and <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l04056">UdfUpdateVolumeLabel()</a>.
<p>
<pre class="fragment"><div>00699                    :
00700 
00701     This routine will convert <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> CS0 input dstring (1/7.2.12) to Unicode.  We assume that
00702     the length is sane.
00703     
00704     This "compression" in CS0 is really just a special case hack for ASCII.
00705 
00706 Arguments:
00707 
00708     Dstring - the input dstring field
00709     
00710     Length - length of the dstring.  If unspecified, we assume that the characters come
00711         from a proper 1/7.2.12 dstring that specifies length in the last character of the
00712         field.
00713     
00714     FieldLength - length of the dstring field.  If unspecified, we assume that the characters
00715         come from an uncounted length of CS0 characters and that the Length parameter is
00716         specified.
00717     
00718     Name - the output Unicode string
00719 
00720 Return Value:
00721 
00722     None.
00723 
00724 --*/
00725 
00726 {
00727     ULONG CompressID;
00728     ULONG UnicodeIndex, ByteIndex;
00729     PWCHAR <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a96">Unicode</a> = <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Buffer;
00730 
00731     UCHAR NameLength;
00732     ULONG CopyNameLength;
00733 
00734     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00735    
00736     <span class="comment">//</span>
00737     <span class="comment">//  Check input.</span>
00738     <span class="comment">//</span>
00739 
00740     <a class="code" href="../../d1/d8/udfdata_8h.html#a28">ASSERT_IRP_CONTEXT</a>( IrpContext );
00741 
00742     CompressID = *Dstring;
00743 
00744     <span class="comment">//</span>
00745     <span class="comment">//  If the length is unspecified, this is a real 1/7.2.12 dstring and the length is in</span>
00746     <span class="comment">//  the last character of the field.</span>
00747     <span class="comment">//</span>
00748     
00749     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( Length || FieldLength );
00750 
00751     <span class="keywordflow">if</span> (Length) {
00752 
00753         NameLength = FieldLength = Length;
00754     
00755     } <span class="keywordflow">else</span> {
00756 
00757         NameLength = *(Dstring + FieldLength - 1);
00758     }
00759     
00760     <span class="comment">//</span>
00761     <span class="comment">//  If the caller specified a size, they should have made sure the buffer is big enough.</span>
00762     <span class="comment">//  Otherwise, we will trim to fit.</span>
00763     <span class="comment">//</span>
00764     
00765     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( Length == 0 || <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;MaximumLength &gt;= <a class="code" href="../../d3/d8/udfprocs_8h.html#a187">UdfCS0DstringUnicodeSize</a>( IrpContext, Dstring, NameLength ) );
00766  
00767     <span class="comment">//</span>
00768     <span class="comment">//  Decide how many UNICODE bytes to "copy".</span>
00769     <span class="comment">//</span>
00770     
00771     CopyNameLength = <a class="code" href="../../d3/d8/udfprocs_8h.html#a3">Min</a>( <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;MaximumLength, <a class="code" href="../../d3/d8/udfprocs_8h.html#a187">UdfCS0DstringUnicodeSize</a>( IrpContext, Dstring, NameLength ));
00772     
00773     <span class="comment">//</span>
00774     <span class="comment">//  Reset the name length and advance over the compression ID in the dstring.</span>
00775     <span class="comment">//</span>
00776     
00777     <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Length = 0;
00778     Dstring++;
00779  
00780     <span class="comment">//</span>
00781     <span class="comment">//  Loop through all the bytes.</span>
00782     <span class="comment">//</span>
00783 
00784     <span class="keywordflow">while</span> (CopyNameLength &gt; <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Length) {
00785       
00786         <span class="keywordflow">if</span> (CompressID == 16) {
00787        
00788             <span class="comment">//</span>
00789             <span class="comment">//  We're little endian, and this is the single place in the entire UDF/ISO standard</span>
00790             <span class="comment">//  where they use big endian.</span>
00791             <span class="comment">//</span>
00792             <span class="comment">//  Thank you.  Thank you very much.</span>
00793             <span class="comment">//</span>
00794             <span class="comment">//  Do an unaligned swapcopy of this 16bit value.</span>
00795             <span class="comment">//</span>
00796 
00797             <a class="code" href="../../d3/d8/udfprocs_8h.html#a58">SwapCopyUchar2</a>( Unicode, Dstring );
00798             Dstring += <span class="keyword">sizeof</span>(WCHAR);
00799        
00800         } <span class="keywordflow">else</span> {
00801 
00802             <span class="comment">//</span>
00803             <span class="comment">//  Drop the byte into the low bits.</span>
00804             <span class="comment">//</span>
00805                 
00806             *<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a96">Unicode</a> = *Dstring;
00807             Dstring += <span class="keyword">sizeof</span>(<a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a>);
00808         }
00809 
00810         <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Length += <span class="keyword">sizeof</span>(WCHAR);
00811         <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a96">Unicode</a>++;
00812     }
00813 
00814     <span class="keywordflow">return</span>;
00815 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a228" doxytag="udfprocs.h::UdfConvertUdfTimeToNtTime" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> INLINE VOID UdfConvertUdfTimeToNtTime           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d5/d0/structTIMESTAMP.html">PTIMESTAMP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>UdfTime</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PLARGE_INTEGER&nbsp;</td>
          <td class="mdname" nowrap> <em>NtTime</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01921">1921</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.
<p>
References <a class="el" href="../../d0/d7/iso13346_8h.html#a170">PTIMESTAMP</a>, <a class="el" href="../../d2/d1/time_8c-source.html#l00822">RtlTimeFieldsToTime()</a>, <a class="el" href="../../d1/d6/iso13346_8h-source.html#l00080">TIMESTAMP_Z_MAX</a>, <a class="el" href="../../d1/d6/iso13346_8h-source.html#l00079">TIMESTAMP_Z_MIN</a>, and <a class="el" href="../../d1/d6/iso13346_8h-source.html#l00081">TIMESTAMP_Z_NONE</a>.
<p>
Referenced by <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l03595">UdfUpdateTimestampsFromIcbContext()</a>.
<p>
<pre class="fragment"><div>01926 {
01927     TIME_FIELDS TimeField;
01928     
01929     TimeField.Year = UdfTime-&gt;Year;
01930     TimeField.Month = UdfTime-&gt;Month;
01931     TimeField.Day = UdfTime-&gt;Day;
01932     TimeField.Hour = UdfTime-&gt;Hour;
01933     TimeField.Minute = UdfTime-&gt;Minute;
01934     TimeField.Second = UdfTime-&gt;Second;
01935     
01936     <span class="comment">//</span>
01937     <span class="comment">//  This is where it gets hairy.  For some unholy reason, ISO 13346 timestamps</span>
01938     <span class="comment">//  carve the right of the decimal point up into three fields of precision</span>
01939     <span class="comment">//  10-2, 10-4, and 10-6, each ranging from 0-99. Lawdy.</span>
01940     <span class="comment">//</span>
01941     <span class="comment">//  To make it easier, since they cannot cause a wrap into the next second,</span>
01942     <span class="comment">//  just save it all up and add it in after the conversion.</span>
01943     <span class="comment">//</span>
01944     
01945     TimeField.Milliseconds = 0; 
01946     
01947     <span class="keywordflow">if</span> (UdfTime-&gt;Type &lt;= 1 &amp;&amp;
01948         ((UdfTime-&gt;Zone &gt;= <a class="code" href="../../d0/d7/iso13346_8h.html#a12">TIMESTAMP_Z_MIN</a> &amp;&amp; UdfTime-&gt;Zone &lt;= <a class="code" href="../../d0/d7/iso13346_8h.html#a13">TIMESTAMP_Z_MAX</a>) ||
01949          UdfTime-&gt;Zone == <a class="code" href="../../d0/d7/iso13346_8h.html#a14">TIMESTAMP_Z_NONE</a>) &amp;&amp;
01950         <a class="code" href="../../d1/d2/time_8c.html#a28">RtlTimeFieldsToTime</a>( &amp;TimeField, NtTime )) {
01951 
01952         <span class="comment">//</span>
01953         <span class="comment">//  Now fold in the remaining sub-second "precision".  Read as coversions</span>
01954         <span class="comment">//  through the 10-3 units, then into our 10-7 base. (centi-&gt;milli-&gt;micro,</span>
01955         <span class="comment">//  etc).</span>
01956         <span class="comment">//</span>
01957     
01958         NtTime-&gt;QuadPart += ((UdfTime-&gt;CentiSecond * (10 * 1000)) +
01959                              (UdfTime-&gt;Usec100 * 100) +
01960                              UdfTime-&gt;Usec) * 10;
01961 
01962         <span class="comment">//</span>
01963         <span class="comment">//  Perform TZ normalization if this is a local time with</span>
01964         <span class="comment">//  specified timezone.</span>
01965         <span class="comment">//</span>
01966 
01967         <span class="keywordflow">if</span> (UdfTime-&gt;Type == 1 &amp;&amp; UdfTime-&gt;Zone != <a class="code" href="../../d0/d7/iso13346_8h.html#a14">TIMESTAMP_Z_NONE</a>) {
01968             
01969             NtTime-&gt;QuadPart += Int32x32To64( -UdfTime-&gt;Zone, (60 * 10 * 1000 * 1000) );
01970         }
01971     
01972     } <span class="keywordflow">else</span> {
01973 
01974         <span class="comment">//</span>
01975         <span class="comment">//  Epoch.  Malformed timestamp.</span>
01976         <span class="comment">//</span>
01977 
01978         NtTime-&gt;QuadPart = 0;
01979     }
01980 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a216" doxytag="udfprocs.h::UdfCreateCcb" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d2/d9/struct__CCB.html">PCCB</a> UdfCreateCcb           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d7/d9/struct__FCB.html">PFCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Fcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d5/d9/struct__LCB.html">PLCB</a> Lcb&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Flags</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l02433">2433</a> of file <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html">udfs/strucsup.c</a>.
<p>
References <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00338">ASSERT_FCB</a>, <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00352">ASSERT_IRP_CONTEXT</a>, <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00351">ASSERT_OPTIONAL_LCB</a>, <a class="el" href="../../d6/d8/udfstruc_8h.html#a90">CCB</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01118">_CCB::CurrentFileIndex</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01097">_CCB::Fcb</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01091">_CCB::Flags</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01126">_CCB::HighestReturnableFileIndex</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01103">_CCB::Lcb</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01085">_CCB::NodeByteSize</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01084">_CCB::NodeTypeCode</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01119">_CCB::SearchExpression</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l00115">UdfAllocateCcb</a>, and <a class="el" href="../../d2/d6/udfs_2nodetype_8h-source.html#l00040">UDFS_NTC_CCB</a>.
<p>
Referenced by <a class="el" href="../../d4/d7/udfs_2create_8c-source.html#l01955">UdfCompleteFcbOpen()</a>.
<p>
<pre class="fragment"><div>02442                    :
02443 
02444     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called to allocate and initialize <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Ccb structure.
02445 
02446 Arguments:
02447 
02448     Fcb - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Fcb <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> being opened.
02449     
02450     Lcb - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Lcb <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Fcb <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> opened by.
02451 
02452     Flags - User flags to set in <span class="keyword">this</span> Ccb.
02453 
02454 Return Value:
02455 
02456     <a class="code" href="../../d2/d9/struct__CCB.html">PCCB</a> - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> created Ccb.
02457 
02458 --*/
02459 
02460 {
02461     <a class="code" href="../../d2/d9/struct__CCB.html">PCCB</a> NewCcb;
02462     
02463     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02464 
02465     <span class="comment">//</span>
02466     <span class="comment">//  Check inputs.</span>
02467     <span class="comment">//</span>
02468 
02469     <a class="code" href="../../d1/d8/udfdata_8h.html#a28">ASSERT_IRP_CONTEXT</a>( IrpContext );
02470     <a class="code" href="../../d1/d8/udfdata_8h.html#a14">ASSERT_FCB</a>( Fcb );
02471     <a class="code" href="../../d1/d8/udfdata_8h.html#a27">ASSERT_OPTIONAL_LCB</a>( Lcb );
02472 
02473     <span class="comment">//</span>
02474     <span class="comment">//  Allocate and initialize the structure.</span>
02475     <span class="comment">//</span>
02476 
02477     NewCcb = <a class="code" href="../../d9/d7/udfs_2strucsup_8c.html#a8">UdfAllocateCcb</a>( IrpContext );
02478 
02479     <span class="comment">//</span>
02480     <span class="comment">//  Set the proper node type code and node byte size</span>
02481     <span class="comment">//</span>
02482 
02483     NewCcb-&gt;<a class="code" href="../../d2/d9/struct__CCB.html#o0">NodeTypeCode</a> = <a class="code" href="../../d1/d7/udfs_2nodetype_8h.html#a6">UDFS_NTC_CCB</a>;
02484     NewCcb-&gt;<a class="code" href="../../d2/d9/struct__CCB.html#o1">NodeByteSize</a> = <span class="keyword">sizeof</span>( <a class="code" href="../../d2/d9/struct__CCB.html">CCB</a> );
02485 
02486     <span class="comment">//</span>
02487     <span class="comment">//  Set the initial value for the flags and Fcb/Lcb</span>
02488     <span class="comment">//</span>
02489 
02490     NewCcb-&gt;<a class="code" href="../../d2/d9/struct__CCB.html#o2">Flags</a> = Flags;
02491     NewCcb-&gt;<a class="code" href="../../d2/d9/struct__CCB.html#o3">Fcb</a> = Fcb;
02492     NewCcb-&gt;<a class="code" href="../../d2/d9/struct__CCB.html#o4">Lcb</a> = Lcb;
02493 
02494     <span class="comment">//</span>
02495     <span class="comment">//  Initialize the directory enumeration context</span>
02496     <span class="comment">//</span>
02497     
02498     NewCcb-&gt;<a class="code" href="../../d2/d9/struct__CCB.html#o5">CurrentFileIndex</a> = 0;
02499     NewCcb-&gt;<a class="code" href="../../d2/d9/struct__CCB.html#o7">HighestReturnableFileIndex</a> = 0;
02500     
02501     NewCcb-&gt;<a class="code" href="../../d2/d9/struct__CCB.html#o6">SearchExpression</a>.Length = 
02502     NewCcb-&gt;<a class="code" href="../../d2/d9/struct__CCB.html#o6">SearchExpression</a>.MaximumLength = 0;
02503     NewCcb-&gt;<a class="code" href="../../d2/d9/struct__CCB.html#o6">SearchExpression</a>.Buffer = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02504 
02505     <span class="keywordflow">return</span> NewCcb;
02506 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a213" doxytag="udfprocs.h::UdfCreateFcb" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d7/d9/struct__FCB.html">PFCB</a> UdfCreateFcb           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d6/d8/udfstruc_8h.html#a77">FILE_ID</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileId</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d1/d7/udfs_2nodetype_8h.html#a89">NODE_TYPE_CODE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>NodeTypeCode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PBOOLEAN FcbExisted&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l02041">2041</a> of file <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html">udfs/strucsup.c</a>.
<p>
References <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00953">_FCB::ChildLcbQueue</a>, <a class="el" href="../../d9/d2/lfsdata_8h-source.html#l00187">DebugUnwind</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01027">_FCB::FcbNonpaged</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00967">_FCB::FileId</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00952">_FCB::ParentLcbQueue</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01067">SIZEOF_FCB_DATA</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01070">SIZEOF_FCB_INDEX</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l00097">UdfAllocateFcbData</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l00103">UdfAllocateFcbIndex</a>, <a class="el" href="../../d2/d6/udfs_2nodetype_8h-source.html#l00149">UdfBugCheck</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l04269">UdfCreateFcbNonPaged()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00453">UdfFreePool()</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l01949">UdfLookupFcbTable()</a>, <a class="el" href="../../d2/d6/udfs_2nodetype_8h-source.html#l00038">UDFS_NTC_FCB_DATA</a>, <a class="el" href="../../d2/d6/udfs_2nodetype_8h-source.html#l00037">UDFS_NTC_FCB_INDEX</a>, and <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00941">_FCB::Vcb</a>.
<p>
Referenced by <a class="el" href="../../d4/d7/udfs_2create_8c-source.html#l01244">UdfOpenObjectByFileId()</a>, <a class="el" href="../../d4/d7/udfs_2create_8c-source.html#l01632">UdfOpenObjectFromDirContext()</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l00477">UdfUpdateVcbPhase0()</a>, and <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l00997">UdfUpdateVcbPhase1()</a>.
<p>
<pre class="fragment"><div>02050                    :
02051 
02052     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called to find <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Fcb <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> given FileId.  We will
02053     look <span class="keyword">this</span> up first in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Fcb table and <span class="keywordflow">if</span> not found we will create
02054     an Fcb.  We don'<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> initialize <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> or insert <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> FcbTable in <span class="keyword">this</span>
02055     routine.
02056 
02057     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called <span class="keywordflow">while</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Vcb <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> locked.
02058 
02059 Arguments:
02060 
02061     FileId - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Id <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target Fcb.
02062 
02063     NodeTypeCode - Node <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> <span class="keywordflow">for</span> <span class="keyword">this</span> Fcb <span class="keywordflow">if</span> we need to create.
02064 
02065     FcbExisted - If specified, we store whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Fcb existed.
02066 
02067 Return Value:
02068 
02069     <a class="code" href="../../d7/d9/struct__FCB.html">PFCB</a> - The Fcb found in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> table or created <span class="keywordflow">if</span> needed.
02070 
02071 --*/
02072 
02073 {
02074     <a class="code" href="../../d7/d9/struct__FCB.html">PFCB</a> NewFcb;
02075     BOOLEAN LocalFcbExisted;
02076 
02077     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02078 
02079     <span class="comment">//</span>
02080     <span class="comment">//  Use the local boolean if one was not passed in.</span>
02081     <span class="comment">//</span>
02082 
02083     <span class="keywordflow">if</span> (!ARGUMENT_PRESENT( FcbExisted )) {
02084 
02085         FcbExisted = &amp;LocalFcbExisted;
02086     }
02087 
02088     <span class="comment">//</span>
02089     <span class="comment">//  Maybe this is already in the table.</span>
02090     <span class="comment">//</span>
02091 
02092     NewFcb = <a class="code" href="../../d3/d8/udfprocs_8h.html#a211">UdfLookupFcbTable</a>( IrpContext, IrpContext-&gt;Vcb, FileId );
02093 
02094     <span class="comment">//</span>
02095     <span class="comment">//  If not then create the Fcb is requested by our caller.</span>
02096     <span class="comment">//</span>
02097 
02098     <span class="keywordflow">if</span> (NewFcb == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02099 
02100         <span class="comment">//</span>
02101         <span class="comment">//  Use a try-finally for cleanup</span>
02102         <span class="comment">//</span>
02103 
02104         <span class="keywordflow">try</span> {
02105 
02106             <span class="comment">//</span>
02107             <span class="comment">//  Allocate and initialize the structure depending on the</span>
02108             <span class="comment">//  type code.</span>
02109             <span class="comment">//</span>
02110     
02111             <span class="keywordflow">switch</span> (NodeTypeCode) {
02112     
02113             <span class="keywordflow">case</span> <a class="code" href="../../d1/d7/udfs_2nodetype_8h.html#a3">UDFS_NTC_FCB_INDEX</a>:
02114     
02115                 NewFcb = <a class="code" href="../../d9/d7/udfs_2strucsup_8c.html#a4">UdfAllocateFcbIndex</a>( IrpContext );
02116     
02117                 RtlZeroMemory( NewFcb, SIZEOF_FCB_INDEX );
02118     
02119                 NewFcb-&gt;NodeByteSize = <a class="code" href="../../d6/d8/udfstruc_8h.html#a19">SIZEOF_FCB_INDEX</a>;
02120     
02121                 <span class="keywordflow">break</span>;
02122     
02123             <span class="keywordflow">case</span> <a class="code" href="../../d1/d7/udfs_2nodetype_8h.html#a4">UDFS_NTC_FCB_DATA</a> :
02124     
02125                 NewFcb = <a class="code" href="../../d9/d7/udfs_2strucsup_8c.html#a2">UdfAllocateFcbData</a>( IrpContext );
02126     
02127                 RtlZeroMemory( NewFcb, SIZEOF_FCB_DATA );
02128     
02129                 NewFcb-&gt;NodeByteSize = <a class="code" href="../../d6/d8/udfstruc_8h.html#a18">SIZEOF_FCB_DATA</a>;
02130     
02131                 <span class="keywordflow">break</span>;
02132     
02133             <span class="keywordflow">default</span>:
02134     
02135                 <a class="code" href="../../d1/d7/udfs_2nodetype_8h.html#a66">UdfBugCheck</a>( 0, 0, 0 );
02136             }
02137     
02138             <span class="comment">//</span>
02139             <span class="comment">//  Now do the common initialization.</span>
02140             <span class="comment">//</span>
02141     
02142             NewFcb-&gt;NodeTypeCode = NodeTypeCode;
02143     
02144             NewFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o2">Vcb</a> = IrpContext-&gt;Vcb;
02145             NewFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o6">FileId</a> = FileId;
02146     
02147             InitializeListHead( &amp;NewFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o3">ParentLcbQueue</a> );
02148             InitializeListHead( &amp;NewFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o4">ChildLcbQueue</a> );
02149     
02150             <span class="comment">//</span>
02151             <span class="comment">//  Now create the non-paged section object.</span>
02152             <span class="comment">//</span>
02153     
02154             NewFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o17">FcbNonpaged</a> = <a class="code" href="../../d9/d7/udfs_2strucsup_8c.html#a18">UdfCreateFcbNonPaged</a>( IrpContext );
02155     
02156             *FcbExisted = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02157 
02158         } finally {
02159 
02160             <a class="code" href="../../d8/d3/lfsdata_8h.html#a3">DebugUnwind</a>( <span class="stringliteral">"UdfCreateFcb"</span> );
02161    
02162             <span class="keywordflow">if</span> (AbnormalTermination()) {
02163 
02164                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a124">UdfFreePool</a>( &amp;NewFcb );
02165             }
02166         }
02167 
02168     } <span class="keywordflow">else</span> {
02169 
02170         *FcbExisted = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02171     }
02172 
02173     <span class="keywordflow">return</span> NewFcb;
02174 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a227" doxytag="udfprocs.h::UdfCreateFileLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN UdfCreateFileLock           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d7/d9/struct__FCB.html">PFCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Fcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>RaiseOnError</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l03713">3713</a> of file <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html">udfs/strucsup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l01141">FsRtlAllocateFileLock()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00641">PFILE_LOCK</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01567">UdfLockFcb</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00406">UdfRaiseStatus()</a>, and <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01577">UdfUnlockFcb</a>.
<p>
Referenced by <a class="el" href="../../d3/d4/lockctrl_8c-source.html#l00046">UdfCommonLockControl()</a>, <a class="el" href="../../d3/d4/lockctrl_8c-source.html#l00152">UdfFastLock()</a>, <a class="el" href="../../d3/d4/lockctrl_8c-source.html#l00436">UdfFastUnlockAll()</a>, <a class="el" href="../../d3/d4/lockctrl_8c-source.html#l00557">UdfFastUnlockAllByKey()</a>, and <a class="el" href="../../d3/d4/lockctrl_8c-source.html#l00297">UdfFastUnlockSingle()</a>.
<p>
<pre class="fragment"><div>03721                    :
03722 
03723     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called when we want to attach a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> lock structure to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
03724     given Fcb.  It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> possible <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> lock <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> already attached.
03725 
03726     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> sometimes called from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> fast <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a> and sometimes in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
03727     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-based <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a>.  We don'<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> want to raise in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> fast <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a>, just <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>.
03728 
03729 Arguments:
03730 
03731     Fcb - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Fcb to create <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> lock <span class="keywordflow">for</span>.
03732 
03733     RaiseOnError - If <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, we will raise on an allocation <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a>.  Otherwise we
03734         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> on an allocation <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a>.
03735 
03736 Return Value:
03737 
03738     BOOLEAN - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Fcb has a filelock, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise.
03739 
03740 --*/
03741 
03742 {
03743     BOOLEAN Result = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03744     <a class="code" href="../../d7/d1/struct__FILE__LOCK.html">PFILE_LOCK</a> FileLock;
03745 
03746     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03747 
03748     <span class="comment">//</span>
03749     <span class="comment">//  Lock the Fcb and check if there is really any work to do.</span>
03750     <span class="comment">//</span>
03751 
03752     <a class="code" href="../../d3/d8/udfprocs_8h.html#a90">UdfLockFcb</a>( IrpContext, Fcb );
03753 
03754     <span class="keywordflow">if</span> (Fcb-&gt;FileLock != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03755 
03756         <a class="code" href="../../d3/d8/udfprocs_8h.html#a91">UdfUnlockFcb</a>( IrpContext, Fcb );
03757         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03758     }
03759 
03760     Fcb-&gt;FileLock = FileLock =
03761         <a class="code" href="../../d1/d8/fsrtl_8h.html#a112">FsRtlAllocateFileLock</a>( NULL, NULL );
03762 
03763     <a class="code" href="../../d3/d8/udfprocs_8h.html#a91">UdfUnlockFcb</a>( IrpContext, Fcb );
03764 
03765     <span class="comment">//</span>
03766     <span class="comment">//  Return or raise as appropriate.</span>
03767     <span class="comment">//</span>
03768 
03769     <span class="keywordflow">if</span> (FileLock == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03770          
03771         <span class="keywordflow">if</span> (RaiseOnError) {
03772 
03773             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( ARGUMENT_PRESENT( IrpContext ));
03774 
03775             <a class="code" href="../../d3/d8/udfprocs_8h.html#a122">UdfRaiseStatus</a>( IrpContext, STATUS_INSUFFICIENT_RESOURCES );
03776         }
03777 
03778         Result = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03779     }
03780 
03781     <span class="keywordflow">return</span> Result;
03782 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a154" doxytag="udfprocs.h::UdfCreateInternalStream" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID UdfCreateInternalStream           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d7/d5/struct__VCB.html">PVCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Vcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d7/d9/struct__FCB.html">PFCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Fcb</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d1/udfs_2cachesup_8c-source.html#l00046">46</a> of file <a class="el" href="../../d9/d1/udfs_2cachesup_8c-source.html">udfs/cachesup.c</a>.
<p>
References <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00342">ASSERT_FCB_INDEX</a>, <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00352">ASSERT_IRP_CONTEXT</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00287">_UDF_DATA::CacheManagerCallbacks</a>, <a class="el" href="../../d6/d7/fssup_8c-source.html#l00387">CcInitializeCacheMap()</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d9/d2/lfsdata_8h-source.html#l00187">DebugUnwind</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01529">_FILE_OBJECT::DeleteAccess</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l05378">IoCreateStreamFileObject()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01527">_FILE_OBJECT::ReadAccess</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01521">_FILE_OBJECT::SectionObjectPointer</a>, <a class="el" href="../../d3/d8/udfprocs_8h.html#a263a114">StreamFileOpen</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00042">UdfData</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01770">UdfDecrementReferenceCounts</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01762">UdfIncrementReferenceCounts</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01567">UdfLockFcb</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01559">UdfLockVcb</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00406">UdfRaiseStatus()</a>, <a class="el" href="../../d7/d2/filobsup_8c-source.html#l00049">UdfSetFileObject()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01577">UdfUnlockFcb</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01563">UdfUnlockVcb</a>, and <a class="el" href="../../d1/d4/io_8h-source.html#l01528">_FILE_OBJECT::WriteAccess</a>.
<p>
Referenced by <a class="el" href="../../d5/d7/dirsup_8c-source.html#l00165">UdfLookupInitialDirEntry()</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l00477">UdfUpdateVcbPhase0()</a>, and <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l00997">UdfUpdateVcbPhase1()</a>.
<p>
<pre class="fragment"><div>00054                    :
00055 
00056     This function creates an internal stream <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> <span class="keywordflow">for</span> interaction
00057     with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> cache manager.  The Fcb here will be <span class="keywordflow">for</span> a directory
00058     stream.
00059 
00060 Arguments:
00061 
00062     Vcb - Vcb <span class="keywordflow">for</span> <span class="keyword">this</span> volume.
00063 
00064     Fcb - Points to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Fcb <span class="keywordflow">for</span> <span class="keyword">this</span> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.  It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> an <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> Fcb.
00065 
00066 Return Value:
00067 
00068     None.
00069 
00070 --*/
00071 
00072 {
00073     <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> StreamFile = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00074     BOOLEAN DecrementReference = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00075 
00076     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00077 
00078     <span class="comment">//</span>
00079     <span class="comment">//  Check inputs.</span>
00080     <span class="comment">//</span>
00081 
00082     <a class="code" href="../../d1/d8/udfdata_8h.html#a28">ASSERT_IRP_CONTEXT</a>( IrpContext );
00083     <a class="code" href="../../d1/d8/udfdata_8h.html#a18">ASSERT_FCB_INDEX</a>( Fcb );
00084 
00085     <span class="comment">//</span>
00086     <span class="comment">//  We may only have the Fcb shared.  Lock the Fcb and do a</span>
00087     <span class="comment">//  safe test to see if we need to really create the file object.</span>
00088     <span class="comment">//</span>
00089 
00090     <a class="code" href="../../d3/d8/udfprocs_8h.html#a90">UdfLockFcb</a>( IrpContext, Fcb );
00091 
00092     <span class="keywordflow">if</span> (Fcb-&gt;FileObject != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00093 
00094         <a class="code" href="../../d3/d8/udfprocs_8h.html#a91">UdfUnlockFcb</a>( IrpContext, Fcb );
00095         <span class="keywordflow">return</span>;
00096     }
00097 
00098     <span class="comment">//</span>
00099     <span class="comment">//  Use a try-finally to facilitate cleanup.</span>
00100     <span class="comment">//</span>
00101 
00102     <span class="keywordflow">try</span> {
00103 
00104         <span class="comment">//</span>
00105         <span class="comment">//  Create the internal stream.  The Vpb should be pointing at our volume</span>
00106         <span class="comment">//  device object at this point.</span>
00107         <span class="comment">//</span>
00108 
00109         StreamFile = <a class="code" href="../../d4/d6/iosubs_8c.html#a48">IoCreateStreamFileObject</a>( NULL, Vcb-&gt;Vpb-&gt;RealDevice );
00110 
00111         <span class="keywordflow">if</span> (StreamFile == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00112 
00113             <a class="code" href="../../d3/d8/udfprocs_8h.html#a122">UdfRaiseStatus</a>( IrpContext, STATUS_INSUFFICIENT_RESOURCES );
00114         }
00115 
00116         <span class="comment">//</span>
00117         <span class="comment">//  Initialize the fields of the file object.</span>
00118         <span class="comment">//</span>
00119 
00120         StreamFile-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o12">ReadAccess</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00121         StreamFile-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o13">WriteAccess</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00122         StreamFile-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o14">DeleteAccess</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00123 
00124         StreamFile-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o6">SectionObjectPointer</a> = &amp;Fcb-&gt;FcbNonpaged-&gt;SegmentObject;
00125 
00126         <span class="comment">//</span>
00127         <span class="comment">//  Set the file object type and increment the Vcb counts.</span>
00128         <span class="comment">//</span>
00129 
00130         <a class="code" href="../../d3/d8/udfprocs_8h.html#a173">UdfSetFileObject</a>( IrpContext,
00131                          StreamFile,
00132                          StreamFileOpen,
00133                          Fcb,
00134                          NULL );
00135 
00136         <span class="comment">//</span>
00137         <span class="comment">//  We will reference the current Fcb twice to keep it from going</span>
00138         <span class="comment">//  away in the error path.  Otherwise if we dereference it</span>
00139         <span class="comment">//  below in the finally clause a close could cause the Fcb to</span>
00140         <span class="comment">//  be deallocated.</span>
00141         <span class="comment">//</span>
00142 
00143         <a class="code" href="../../d3/d8/udfprocs_8h.html#a88">UdfLockVcb</a>( IrpContext, Vcb );
00144         
00145         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( +1, Dbg, 
00146                      <span class="stringliteral">"UdfCreateInternalStream, Fcb %08x Vcb %d/%d Fcb %d/%d\n"</span>,
00147                      Fcb,
00148                      Vcb-&gt;VcbReference,
00149                      Vcb-&gt;VcbUserReference,
00150                      Fcb-&gt;FcbReference,
00151                      Fcb-&gt;FcbUserReference ));
00152 
00153         <a class="code" href="../../d3/d8/udfprocs_8h.html#a98">UdfIncrementReferenceCounts</a>( IrpContext, Fcb, 2, 0 );
00154         <a class="code" href="../../d3/d8/udfprocs_8h.html#a89">UdfUnlockVcb</a>( IrpContext, Vcb );
00155         DecrementReference = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00156 
00157         <span class="comment">//</span>
00158         <span class="comment">//  Initialize the cache map for the file.</span>
00159         <span class="comment">//</span>
00160 
00161         <a class="code" href="../../d4/d2/cache_8h.html#a58">CcInitializeCacheMap</a>( StreamFile,
00162                               (<a class="code" href="../../d1/d9/struct__CC__FILE__SIZES.html">PCC_FILE_SIZES</a>)&amp;Fcb-&gt;AllocationSize,
00163                               TRUE,
00164                               &amp;<a class="code" href="../../d0/d8/udfdata_8c.html#a2">UdfData</a>.<a class="code" href="../../d2/d3/struct__UDF__DATA.html#o20">CacheManagerCallbacks</a>,
00165                               Fcb );
00166 
00167         <span class="comment">//</span>
00168         <span class="comment">//  Go ahead and store the stream file into the Fcb.</span>
00169         <span class="comment">//</span>
00170 
00171         Fcb-&gt;FileObject = StreamFile;
00172         StreamFile = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00173 
00174     } finally {
00175 
00176         <a class="code" href="../../d8/d3/lfsdata_8h.html#a3">DebugUnwind</a>( <span class="stringliteral">"UdfCreateInternalStream"</span> );
00177 
00178         <span class="comment">//</span>
00179         <span class="comment">//  If we raised then we need to dereference the file object.</span>
00180         <span class="comment">//</span>
00181 
00182         <span class="keywordflow">if</span> (StreamFile != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00183 
00184             <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( StreamFile );
00185             Fcb-&gt;FileObject = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00186         }
00187 
00188         <span class="comment">//</span>
00189         <span class="comment">//  Dereference and unlock the Fcb.</span>
00190         <span class="comment">//</span>
00191 
00192         <span class="keywordflow">if</span> (DecrementReference) {
00193 
00194             <a class="code" href="../../d3/d8/udfprocs_8h.html#a88">UdfLockVcb</a>( IrpContext, Vcb );
00195             <a class="code" href="../../d3/d8/udfprocs_8h.html#a99">UdfDecrementReferenceCounts</a>( IrpContext, Fcb, 1, 0 );
00196             
00197             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( -1, Dbg, 
00198                          <span class="stringliteral">"UdfCreateInternalStream, Vcb %d/%d Fcb %d/%d\n"</span>,
00199                          Vcb-&gt;VcbReference,
00200                          Vcb-&gt;VcbUserReference,
00201                          Fcb-&gt;FcbReference,
00202                          Fcb-&gt;FcbUserReference ));
00203 
00204             <a class="code" href="../../d3/d8/udfprocs_8h.html#a89">UdfUnlockVcb</a>( IrpContext, Vcb );
00205         }
00206 
00207         <a class="code" href="../../d3/d8/udfprocs_8h.html#a91">UdfUnlockFcb</a>( IrpContext, Fcb );
00208     }
00209 
00210     <span class="keywordflow">return</span>;
00211 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a207" doxytag="udfprocs.h::UdfCreateIrpContext" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> UdfCreateIrpContext           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>Wait</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l01301">1301</a> of file <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html">udfs/strucsup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d5/d9/cmconfig_8c-source.html#l00051">Count</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01517">_FILE_OBJECT::DeviceObject</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02488">_IO_STACK_LOCATION::DeviceObject</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00780">ExAllocateFromNPagedLookasideList()</a>, <a class="el" href="../../d1/d3/ex_2alpha_2raisests_8c-source.html#l00157">ExRaiseStatus()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02494">_IO_STACK_LOCATION::FileObject</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00232">_UDF_DATA::FileSystemDeviceObjects</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01186">_IRP_CONTEXT::Flags</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03252">IoGetCurrentIrpStackLocation</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01164">_IRP_CONTEXT::Irp</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d6/d8/udfstruc_8h.html#a92">IRP_CONTEXT</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01236">IRP_CONTEXT_FLAG_FORCE_POST</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01235">IRP_CONTEXT_FLAG_WAIT</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00073">IRP_MJ_CLEANUP</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00057">IRP_MJ_CLOSE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00055">IRP_MJ_CREATE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00068">IRP_MJ_FILE_SYSTEM_CONTROL</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00071">IRP_MJ_SHUTDOWN</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00113">IRP_MN_MOUNT_VOLUME</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00112">IRP_MN_USER_FS_REQUEST</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01215">_IRP_CONTEXT::MajorFunction</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02028">_IO_STACK_LOCATION::MajorFunction</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01216">_IRP_CONTEXT::MinorFunction</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02029">_IO_STACK_LOCATION::MinorFunction</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01158">_IRP_CONTEXT::NodeByteSize</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01157">_IRP_CONTEXT::NodeTypeCode</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00195">NUMBER_OF_FS_OBJECTS</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02069">_IO_STACK_LOCATION::Parameters</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01192">_IRP_CONTEXT::RealDevice</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00505">SetFlag</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00042">UdfData</a>, <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00191">UdfIrpContextLookasideList</a>, <a class="el" href="../../d2/d6/udfs_2nodetype_8h-source.html#l00041">UDFS_NTC_IRP_CONTEXT</a>, and <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01172">_IRP_CONTEXT::Vcb</a>.
<p>
Referenced by <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00218">UdfFsdDispatch()</a>.
<p>
<pre class="fragment"><div>01308                    :
01309 
01310     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called to initialize an IrpContext <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current
01311     UDFS request.  We allocate <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> structure and then initialize <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> from
01312     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> given <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>.
01313 
01314 Arguments:
01315 
01316     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> - <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> <span class="keywordflow">for</span> <span class="keyword">this</span> request.
01317 
01318     Wait - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <span class="keyword">this</span> request <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> synchronous, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise.
01319 
01320 Return Value:
01321 
01322     <a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> - Allocated IrpContext.
01323 
01324 --*/
01325 
01326 {
01327     <a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> NewIrpContext = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01328     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp = <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>( Irp );
01329     BOOLEAN IsFsDo = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01330     ULONG <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>;
01331 
01332     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01333 
01334     <span class="keywordflow">for</span> (<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> = 0; <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> &lt; <a class="code" href="../../d6/d8/udfstruc_8h.html#a0">NUMBER_OF_FS_OBJECTS</a>; <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>++) {
01335     
01336         <span class="keywordflow">if</span> (IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o57">DeviceObject</a> == <a class="code" href="../../d0/d8/udfdata_8c.html#a2">UdfData</a>.<a class="code" href="../../d2/d3/struct__UDF__DATA.html#o7">FileSystemDeviceObjects</a>[<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>]) {
01337 
01338             IsFsDo = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01339             <span class="keywordflow">break</span>;
01340         }
01341     }
01342 
01343     <span class="comment">//</span>
01344     <span class="comment">//  The only operations a filesystem device object should ever receive</span>
01345     <span class="comment">//  are create/teardown of fsdo handles and operations which do not</span>
01346     <span class="comment">//  occur in the context of fileobjects (i.e., mount).</span>
01347     <span class="comment">//</span>
01348 
01349     <span class="keywordflow">if</span> (IsFsDo) {
01350 
01351         <span class="keywordflow">if</span> (IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp;
01352             IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a> != <a class="code" href="../../d0/d5/io_8h.html#a13">IRP_MJ_CREATE</a> &amp;&amp;
01353             IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a> != <a class="code" href="../../d0/d5/io_8h.html#a31">IRP_MJ_CLEANUP</a> &amp;&amp;
01354             IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a> != <a class="code" href="../../d0/d5/io_8h.html#a15">IRP_MJ_CLOSE</a>) {
01355 
01356             <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( STATUS_INVALID_DEVICE_REQUEST );
01357         }
01358 
01359         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a> != NULL ||
01360                 
01361                 (IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a> == IRP_MJ_FILE_SYSTEM_CONTROL &amp;&amp;
01362                  IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o1">MinorFunction</a> == IRP_MN_USER_FS_REQUEST &amp;&amp;
01363                  IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.FileSystemControl.FsControlCode == FSCTL_INVALIDATE_VOLUMES) ||
01364                 
01365                 (IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a> == IRP_MJ_FILE_SYSTEM_CONTROL &amp;&amp;
01366                  IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o1">MinorFunction</a> == IRP_MN_MOUNT_VOLUME ) ||
01367 
01368                 IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a> == IRP_MJ_SHUTDOWN );
01369     }
01370     
01371     NewIrpContext = <a class="code" href="../../d5/d8/ex_8h.html#a248">ExAllocateFromNPagedLookasideList</a>( &amp;UdfIrpContextLookasideList );
01372 
01373     RtlZeroMemory( NewIrpContext, <span class="keyword">sizeof</span>( <a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html">IRP_CONTEXT</a> ));
01374 
01375     <span class="comment">//</span>
01376     <span class="comment">//  Set the proper node type code and node byte size</span>
01377     <span class="comment">//</span>
01378 
01379     NewIrpContext-&gt;<a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html#o0">NodeTypeCode</a> = <a class="code" href="../../d1/d7/udfs_2nodetype_8h.html#a7">UDFS_NTC_IRP_CONTEXT</a>;
01380     NewIrpContext-&gt;<a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html#o1">NodeByteSize</a> = <span class="keyword">sizeof</span>( <a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html">IRP_CONTEXT</a> );
01381 
01382     <span class="comment">//</span>
01383     <span class="comment">//  Set the originating Irp field</span>
01384     <span class="comment">//</span>
01385 
01386     NewIrpContext-&gt;<a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html#o2">Irp</a> = <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>;
01387 
01388     <span class="comment">//</span>
01389     <span class="comment">//  Copy RealDevice for workque algorithms.  We will update this in the Mount or</span>
01390     <span class="comment">//  Verify since they have no file objects to use here.</span>
01391     <span class="comment">//</span>
01392 
01393     <span class="keywordflow">if</span> (IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01394 
01395         NewIrpContext-&gt;<a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html#o6">RealDevice</a> = IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a>-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o2">DeviceObject</a>;
01396     }
01397 
01398     <span class="comment">//</span>
01399     <span class="comment">//  This may be one of our filesystem device objects.  In that case don't</span>
01400     <span class="comment">//  initialize the Vcb field.</span>
01401     <span class="comment">//</span>
01402 
01403     <span class="keywordflow">if</span> (!IsFsDo) {
01404         
01405         NewIrpContext-&gt;<a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html#o3">Vcb</a> = &amp;((<a class="code" href="../../d6/d7/struct__VOLUME__DEVICE__OBJECT.html">PVOLUME_DEVICE_OBJECT</a>) IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o57">DeviceObject</a>)-&gt;Vcb;
01406     }
01407 
01408     <span class="comment">//</span>
01409     <span class="comment">//  Major/Minor Function codes</span>
01410     <span class="comment">//</span>
01411 
01412     NewIrpContext-&gt;<a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html#o10">MajorFunction</a> = IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o0">MajorFunction</a>;
01413     NewIrpContext-&gt;<a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html#o11">MinorFunction</a> = IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o1">MinorFunction</a>;
01414 
01415     <span class="comment">//</span>
01416     <span class="comment">//  Set the wait parameter</span>
01417     <span class="comment">//</span>
01418 
01419     <span class="keywordflow">if</span> (Wait) {
01420 
01421         <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( NewIrpContext-&gt;<a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html#o5">Flags</a>, IRP_CONTEXT_FLAG_WAIT );
01422 
01423     } <span class="keywordflow">else</span> {
01424 
01425         <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( NewIrpContext-&gt;<a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html#o5">Flags</a>, IRP_CONTEXT_FLAG_FORCE_POST );
01426     }
01427 
01428     <span class="comment">//</span>
01429     <span class="comment">//  return and tell the caller</span>
01430     <span class="comment">//</span>
01431 
01432     <span class="keywordflow">return</span> NewIrpContext;
01433 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a162" doxytag="udfprocs.h::UdfCreateUserMdl" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS UdfCreateUserMdl           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>BufferLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>RaiseOnError</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d6/deviosup_8c-source.html#l00474">474</a> of file <a class="el" href="../../d4/d6/deviosup_8c-source.html">deviosup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00356">ASSERT_IRP</a>, <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00352">ASSERT_IRP_CONTEXT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d8/d2/fsrtl_2filter_8c-source.html#l00082">FsRtlIsNtstatusExpected()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l00805">IoAllocateMdl()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l06744">IoFreeMdl()</a>, <a class="el" href="../../d2/d1/mm_8h.html#a344a169">IoWriteAccess</a>, <a class="el" href="../../d6/d5/iosup_8c-source.html#l00238">MmProbeAndLockPages()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00406">UdfRaiseStatus()</a>.
<p>
Referenced by <a class="el" href="../../d4/d6/deviosup_8c-source.html#l00201">UdfNonCachedRead()</a>.
<p>
<pre class="fragment"><div>00482                    :
00483 
00484     This routine locks <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified buffer <span class="keywordflow">for</span> read access (we only write into
00485     the buffer).  The <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> system requires <span class="keyword">this</span> routine since <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> does not
00486     ask <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> I/O system to lock its buffers <span class="keywordflow">for</span> direct I/O.  This routine
00487     may <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> be called from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Fsd <span class="keywordflow">while</span> still in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user context.
00488 
00489     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> called <span class="keywordflow">if</span> there <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not already an Mdl.
00490 
00491 Arguments:
00492 
00493     BufferLength - Length of user buffer.
00494 
00495     RaiseOnError - Indicates <span class="keywordflow">if</span> our caller wants <span class="keyword">this</span> routine to raise on
00496         an error condition.
00497 
00498 Return Value:
00499 
00500     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> from <span class="keyword">this</span> routine.  <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a1">Error</a> status <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> returned <span class="keywordflow">if</span>
00501         RaiseOnError <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>.
00502 
00503 --*/
00504 
00505 {
00506     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INSUFFICIENT_RESOURCES;
00507     <a class="code" href="../../d6/d7/struct__MDL.html">PMDL</a> Mdl;
00508 
00509     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00510 
00511     <a class="code" href="../../d1/d8/udfdata_8h.html#a28">ASSERT_IRP_CONTEXT</a>( IrpContext );
00512     <a class="code" href="../../d1/d8/udfdata_8h.html#a32">ASSERT_IRP</a>( IrpContext-&gt;Irp );
00513     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( IrpContext-&gt;Irp-&gt;MdlAddress == NULL );
00514 
00515     <span class="comment">//</span>
00516     <span class="comment">// Allocate the Mdl, and Raise if we fail.</span>
00517     <span class="comment">//</span>
00518 
00519     Mdl = <a class="code" href="../../d4/d6/iosubs_8c.html#a19">IoAllocateMdl</a>( IrpContext-&gt;Irp-&gt;UserBuffer,
00520                          BufferLength,
00521                          FALSE,
00522                          FALSE,
00523                          IrpContext-&gt;Irp );
00524 
00525     <span class="keywordflow">if</span> (Mdl != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00526 
00527         <span class="comment">//</span>
00528         <span class="comment">//  Now probe the buffer described by the Irp.  If we get an exception,</span>
00529         <span class="comment">//  deallocate the Mdl and return the appropriate "expected" status.</span>
00530         <span class="comment">//</span>
00531 
00532         <span class="keywordflow">try</span> {
00533 
00534             <a class="code" href="../../d5/d6/iosup_8c.html#a41">MmProbeAndLockPages</a>( Mdl, IrpContext-&gt;Irp-&gt;RequestorMode, IoWriteAccess );
00535 
00536             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00537 
00538         } except(EXCEPTION_EXECUTE_HANDLER) {
00539 
00540             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = GetExceptionCode();
00541 
00542             <a class="code" href="../../d4/d6/iosubs_8c.html#a65">IoFreeMdl</a>( Mdl );
00543             IrpContext-&gt;Irp-&gt;MdlAddress = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00544 
00545             <span class="keywordflow">if</span> (!<a class="code" href="../../d1/d8/fsrtl_8h.html#a137">FsRtlIsNtstatusExpected</a>( Status )) {
00546 
00547                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_USER_BUFFER;
00548             }
00549         }
00550     }
00551 
00552     <span class="comment">//</span>
00553     <span class="comment">//  Check if we are to raise or return</span>
00554     <span class="comment">//</span>
00555 
00556     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_SUCCESS) {
00557 
00558         <span class="keywordflow">if</span> (RaiseOnError) {
00559 
00560             <a class="code" href="../../d3/d8/udfprocs_8h.html#a122">UdfRaiseStatus</a>( IrpContext, Status );
00561         }
00562     }
00563 
00564     <span class="comment">//</span>
00565     <span class="comment">//  Return the status code.</span>
00566     <span class="comment">//</span>
00567 
00568     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00569 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a189" doxytag="udfprocs.h::UdfCS0DstringContainsLegalCharacters" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> INLINE BOOLEAN UdfCS0DstringContainsLegalCharacters           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>Dstring</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01239">1239</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.
<p>
References <a class="el" href="../../d2/d0/bench_8c-source.html#l00050">CHAR</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00330">SwapCopyUchar2</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01208">UdfIsCharacterLegal()</a>.
<p>
Referenced by <a class="el" href="../../d5/d7/dirsup_8c-source.html#l00360">UdfUpdateDirNames()</a>.
<p>
<pre class="fragment"><div>01246                    :
01247 
01248     This routine inspects a CS0 dstring <span class="keywordflow">for</span> illegal characters.  The assumption <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
01249     <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a> that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> string <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> legal CS0.
01250     
01251 Arguments:
01252 
01253     <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a> - a name to check
01254     
01255 Return Value:
01256 
01257     BOOLEAN True <span class="keywordflow">if</span> legal characters are found, False otherwise.
01258     
01259 --*/
01260 
01261 {
01262     ULONG Step;
01263     WCHAR Char;
01264     PCHAR Bound = Dstring + Length;
01265 
01266     <span class="comment">//</span>
01267     <span class="comment">//  Determine how big a step we take in the string according to the</span>
01268     <span class="comment">//  "compression" applied.</span>
01269     <span class="comment">//</span>
01270     
01271     <span class="keywordflow">if</span> (*Dstring == 16) {
01272 
01273         Step = <span class="keyword">sizeof</span>( WCHAR );
01274     
01275     } <span class="keywordflow">else</span> {
01276 
01277         Step = <span class="keyword">sizeof</span>( <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> );
01278     }
01279 
01280     <span class="comment">//</span>
01281     <span class="comment">//  Advance past the compression marker and loop over the string.</span>
01282     <span class="comment">//</span>
01283     
01284     <span class="keywordflow">for</span> (Dstring++; Dstring &lt; Bound; Dstring += Step) {
01285 
01286         <span class="comment">//</span>
01287         <span class="comment">//  Perform the endianess swapcopy to convert from UDF bigendian CS0 to our</span>
01288         <span class="comment">//  little endian wide characters.</span>
01289         <span class="comment">//</span>
01290         
01291         <a class="code" href="../../d3/d8/udfprocs_8h.html#a58">SwapCopyUchar2</a>( &amp;Char, Dstring );
01292         
01293         <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d8/udfprocs_8h.html#a188">UdfIsCharacterLegal</a>( Char )) {
01294 
01295             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( 0, Dbg, <span class="stringliteral">"UdfCS0DstringContainsLegalCharacters, Char %04x @ %08x\n"</span>, (WCHAR) Char, Dstring ));
01296 
01297             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01298         }
01299     }
01300 
01301     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01302 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a187" doxytag="udfprocs.h::UdfCS0DstringUnicodeSize" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> INLINE <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a> UdfCS0DstringUnicodeSize           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top"><a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>Dstring</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>UCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01177">1177</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.
<p>
Referenced by <a class="el" href="../../d6/d4/namesup_8c-source.html#l00689">UdfConvertCS0DstringToUnicode()</a>, and <a class="el" href="../../d5/d7/dirsup_8c-source.html#l00360">UdfUpdateDirNames()</a>.
<p>
<pre class="fragment"><div>01185                    :
01186 
01187     This routine computes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of bytes required <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> UNICODE representation
01188     of a CS0 Dstring (1/7.2.12)
01189     
01190 Arguments:
01191 
01192     Dstring - a dstring
01193     
01194     Length - length of the dstring
01195     
01196 Return Value:
01197 
01198     ULONG number of bytes.
01199     
01200 --*/
01201 
01202 {
01203     <span class="keywordflow">return</span> (16 / *Dstring) * (Length - 1);
01204 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a174" doxytag="udfprocs.h::UdfDecodeFileObject" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d3/d8/udfprocs_8h.html#a109">TYPE_OF_OPEN</a> UdfDecodeFileObject           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d7/d9/struct__FCB.html">PFCB</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>Fcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d2/d9/struct__CCB.html">PCCB</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>Ccb</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d2/filobsup_8c-source.html#l00133">133</a> of file <a class="el" href="../../d7/d2/filobsup_8c-source.html">filobsup.c</a>.
<p>
References <a class="el" href="../../d6/d4/cc_8h-source.html#l00509">ClearFlag</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d3/d8/udfprocs_8h.html#a109">TYPE_OF_OPEN</a>, <a class="el" href="../../d7/d2/filobsup_8c-source.html#l00039">TYPE_OF_OPEN_MASK</a>, and <a class="el" href="../../d3/d8/udfprocs_8h.html#a263a113">UnopenedFileObject</a>.
<p>
Referenced by <a class="el" href="../../d9/d6/udfs_2cleanup_8c-source.html#l00042">UdfCommonCleanup()</a>, <a class="el" href="../../d3/d8/close_8c-source.html#l00319">UdfCommonClose()</a>, <a class="el" href="../../d4/d7/udfs_2create_8c-source.html#l00108">UdfCommonCreate()</a>, <a class="el" href="../../d3/d6/udfs_2devctrl_8c-source.html#l00069">UdfCommonDevControl()</a>, <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l00255">UdfCommonDirControl()</a>, <a class="el" href="../../d3/d4/lockctrl_8c-source.html#l00046">UdfCommonLockControl()</a>, <a class="el" href="../../d5/d2/fileinfo_8c-source.html#l00156">UdfCommonQueryInfo()</a>, <a class="el" href="../../d8/d5/volinfo_8c-source.html#l00082">UdfCommonQueryVolInfo()</a>, <a class="el" href="../../d8/d4/udfs_2read_8c-source.html#l00068">UdfCommonRead()</a>, <a class="el" href="../../d5/d2/fileinfo_8c-source.html#l00385">UdfCommonSetInfo()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l00966">UdfDismountVolume()</a>, <a class="el" href="../../d5/d2/fileinfo_8c-source.html#l00496">UdfFastQueryBasicInfo()</a>, <a class="el" href="../../d5/d2/fileinfo_8c-source.html#l00740">UdfFastQueryNetworkInfo()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l01064">UdfIsVolumeDirty()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l01175">UdfIsVolumeMounted()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l00780">UdfLockVolume()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l00470">UdfOplockRequest()</a>, and <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l00877">UdfUnlockVolume()</a>.
<p>
<pre class="fragment"><div>00141                    :
00142 
00143     This routine takes a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object and extracts <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Fcb and Ccb (possibly NULL)
00144     and returns <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of open.
00145 
00146 Arguments:
00147 
00148     FileObject - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object pointer being initialized.
00149 
00150     Fcb - Address to store <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Fcb contained in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object.
00151 
00152     Ccb - Address to store <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Ccb contained in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object.
00153 
00154 Return Value:
00155 
00156     <a class="code" href="../../d3/d8/udfprocs_8h.html#a109">TYPE_OF_OPEN</a> - Indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object.
00157 
00158 --*/
00159 
00160 {
00161     <a class="code" href="../../d3/d8/udfprocs_8h.html#a109">TYPE_OF_OPEN</a> TypeOfOpen;
00162 
00163     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00164 
00165     <span class="comment">//</span>
00166     <span class="comment">//  If this is an unopened file object then return NULL for the</span>
00167     <span class="comment">//  Fcb/Ccb.  Don't trust any other values in the file object.</span>
00168     <span class="comment">//</span>
00169 
00170     TypeOfOpen = (<a class="code" href="../../d3/d8/udfprocs_8h.html#a109">TYPE_OF_OPEN</a>) <a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( (ULONG_PTR) FileObject-&gt;FsContext2,
00171                                         TYPE_OF_OPEN_MASK );
00172 
00173     <span class="keywordflow">if</span> (TypeOfOpen == <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a113">UnopenedFileObject</a>) {
00174 
00175         *Fcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00176         *Ccb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00177 
00178     } <span class="keywordflow">else</span> {
00179 
00180         <span class="comment">//</span>
00181         <span class="comment">//  The Fcb is pointed to by the FsContext field.  The Ccb is in</span>
00182         <span class="comment">//  FsContext2 (after clearing the low three bits).  The low three</span>
00183         <span class="comment">//  bits are the file object type.</span>
00184         <span class="comment">//</span>
00185 
00186         *Fcb = FileObject-&gt;FsContext;
00187         *Ccb = FileObject-&gt;FsContext2;
00188 
00189         <a class="code" href="../../d5/d5/cc_8h.html#a61">ClearFlag</a>( (ULONG_PTR) *Ccb, TYPE_OF_OPEN_MASK );
00190     }
00191 
00192     <span class="comment">//</span>
00193     <span class="comment">//  Now return the type of open.</span>
00194     <span class="comment">//</span>
00195 
00196     <span class="keywordflow">return</span> TypeOfOpen;
00197 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a217" doxytag="udfprocs.h::UdfDeleteCcb" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID UdfDeleteCcb           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d9/struct__CCB.html">PCCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Ccb</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l02510">2510</a> of file <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html">udfs/strucsup.c</a>.
<p>
References <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00346">ASSERT_CCB</a>, <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00352">ASSERT_IRP_CONTEXT</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l00118">UdfDeallocateCcb</a>, and <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00453">UdfFreePool()</a>.
<p>
Referenced by <a class="el" href="../../d3/d8/close_8c-source.html#l00319">UdfCommonClose()</a>.
<p>
<pre class="fragment"><div>02517                    :
02518 
02519     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called to cleanup and deallocate a Ccb structure.
02520 
02521 Arguments:
02522 
02523     Ccb - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Ccb to <span class="keyword">delete</span>.
02524 
02525 Return Value:
02526 
02527     None
02528 
02529 --*/
02530 
02531 {
02532     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02533 
02534     <span class="comment">//</span>
02535     <span class="comment">//  Check inputs.</span>
02536     <span class="comment">//</span>
02537 
02538     <a class="code" href="../../d1/d8/udfdata_8h.html#a28">ASSERT_IRP_CONTEXT</a>( IrpContext );
02539     <a class="code" href="../../d1/d8/udfdata_8h.html#a22">ASSERT_CCB</a>( Ccb );
02540 
02541     <span class="keywordflow">if</span> (Ccb-&gt;SearchExpression.Buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02542 
02543         <a class="code" href="../../d3/d8/udfprocs_8h.html#a124">UdfFreePool</a>( &amp;Ccb-&gt;SearchExpression.Buffer );
02544     }
02545 
02546     <a class="code" href="../../d9/d7/udfs_2strucsup_8c.html#a9">UdfDeallocateCcb</a>( IrpContext, Ccb );
02547     <span class="keywordflow">return</span>;
02548 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a214" doxytag="udfprocs.h::UdfDeleteFcb" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID UdfDeleteFcb           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d7/d9/struct__FCB.html">PFCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Fcb</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l02178">2178</a> of file <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html">udfs/strucsup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00338">ASSERT_FCB</a>, <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00352">ASSERT_IRP_CONTEXT</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l01162">FsRtlFreeFileLock()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l00413">FsRtlUninitializeOplock()</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00630">_VCB::MetadataFcb</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00629">_VCB::RootIndexFcb</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l00100">UdfDeallocateFcbData</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l00106">UdfDeallocateFcbIndex</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l04317">UdfDeleteFcbNonpaged()</a>, <a class="el" href="../../d2/d6/udfs_2nodetype_8h-source.html#l00038">UDFS_NTC_FCB_DATA</a>, <a class="el" href="../../d2/d6/udfs_2nodetype_8h-source.html#l00037">UDFS_NTC_FCB_INDEX</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l00207">UdfUninitializeFcbMcb()</a>, <a class="el" href="../../d7/d5/vmcbsup_8c-source.html#l00325">UdfUninitializeVmcb()</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00631">_VCB::VatFcb</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00612">_VCB::VcbReference</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00613">_VCB::VcbUserReference</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00637">_VCB::Vmcb</a>, and <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00628">_VCB::VolumeDasdFcb</a>.
<p>
Referenced by <a class="el" href="../../d4/d7/udfs_2create_8c-source.html#l01244">UdfOpenObjectByFileId()</a>, <a class="el" href="../../d4/d7/udfs_2create_8c-source.html#l01632">UdfOpenObjectFromDirContext()</a>, and <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l01606">UdfTeardownStructures()</a>.
<p>
<pre class="fragment"><div>02185                    :
02186 
02187     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called to cleanup and deallocate an Fcb.  We know there
02188     are no references remaining.  We cleanup any auxilary structures and
02189     deallocate <span class="keyword">this</span> Fcb.
02190 
02191 Arguments:
02192 
02193     Fcb - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Fcb to deallcoate.
02194 
02195 Return Value:
02196 
02197     None
02198 
02199 --*/
02200 
02201 {
02202     <a class="code" href="../../d7/d5/struct__VCB.html">PVCB</a> Vcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02203     
02204     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02205 
02206     <span class="comment">//</span>
02207     <span class="comment">//  Check inputs.</span>
02208     <span class="comment">//</span>
02209 
02210     <a class="code" href="../../d1/d8/udfdata_8h.html#a28">ASSERT_IRP_CONTEXT</a>( IrpContext );
02211     <a class="code" href="../../d1/d8/udfdata_8h.html#a14">ASSERT_FCB</a>( Fcb );
02212 
02213     <span class="comment">//</span>
02214     <span class="comment">//  Sanity check the counts and Lcb lists.</span>
02215     <span class="comment">//</span>
02216 
02217     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( Fcb-&gt;FcbCleanup == 0 );
02218     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( Fcb-&gt;FcbReference == 0 );
02219 
02220     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( IsListEmpty( &amp;Fcb-&gt;ChildLcbQueue ));
02221     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( IsListEmpty( &amp;Fcb-&gt;ParentLcbQueue ));
02222 
02223     <span class="comment">//</span>
02224     <span class="comment">//  Start with the common structures.</span>
02225     <span class="comment">//</span>
02226 
02227     <a class="code" href="../../d9/d7/udfs_2strucsup_8c.html#a16">UdfUninitializeFcbMcb</a>( Fcb );
02228     
02229     <a class="code" href="../../d9/d7/udfs_2strucsup_8c.html#a19">UdfDeleteFcbNonpaged</a>( IrpContext, Fcb-&gt;FcbNonpaged );
02230 
02231     <span class="comment">//</span>
02232     <span class="comment">//  Now do the type specific structures.</span>
02233     <span class="comment">//</span>
02234 
02235     <span class="keywordflow">switch</span> (Fcb-&gt;NodeTypeCode) {
02236 
02237     <span class="keywordflow">case</span> <a class="code" href="../../d1/d7/udfs_2nodetype_8h.html#a3">UDFS_NTC_FCB_INDEX</a>:
02238 
02239         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( Fcb-&gt;FileObject == NULL );
02240 
02241         <span class="keywordflow">if</span> (Fcb == Fcb-&gt;Vcb-&gt;RootIndexFcb) {
02242 
02243             Vcb = Fcb-&gt;Vcb;
02244             Vcb-&gt;<a class="code" href="../../d7/d5/struct__VCB.html#o21">RootIndexFcb</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02245         
02246         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Fcb == Fcb-&gt;Vcb-&gt;MetadataFcb) {
02247 
02248             Vcb = Fcb-&gt;Vcb;
02249             Vcb-&gt;<a class="code" href="../../d7/d5/struct__VCB.html#o22">MetadataFcb</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02250 
02251             <a class="code" href="../../d6/d6/vmcbsup_8c.html#a6">UdfUninitializeVmcb</a>( &amp;Vcb-&gt;<a class="code" href="../../d7/d5/struct__VCB.html#o24">Vmcb</a> );
02252         
02253         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Fcb == Fcb-&gt;Vcb-&gt;VatFcb) {
02254 
02255             Vcb = Fcb-&gt;Vcb;
02256             Vcb-&gt;<a class="code" href="../../d7/d5/struct__VCB.html#o23">VatFcb</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02257         }
02258 
02259         <a class="code" href="../../d9/d7/udfs_2strucsup_8c.html#a5">UdfDeallocateFcbIndex</a>( IrpContext, Fcb );
02260         <span class="keywordflow">break</span>;
02261 
02262     <span class="keywordflow">case</span> <a class="code" href="../../d1/d7/udfs_2nodetype_8h.html#a4">UDFS_NTC_FCB_DATA</a> :
02263 
02264         <span class="keywordflow">if</span> (Fcb-&gt;FileLock != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02265 
02266             <a class="code" href="../../d1/d8/fsrtl_8h.html#a113">FsRtlFreeFileLock</a>( Fcb-&gt;FileLock );
02267         }
02268 
02269         <a class="code" href="../../d1/d8/fsrtl_8h.html#a163">FsRtlUninitializeOplock</a>( &amp;Fcb-&gt;Oplock );
02270 
02271         <span class="keywordflow">if</span> (Fcb == Fcb-&gt;Vcb-&gt;VolumeDasdFcb) {
02272 
02273             Vcb = Fcb-&gt;Vcb;
02274             Vcb-&gt;<a class="code" href="../../d7/d5/struct__VCB.html#o20">VolumeDasdFcb</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02275         }
02276 
02277         <a class="code" href="../../d9/d7/udfs_2strucsup_8c.html#a3">UdfDeallocateFcbData</a>( IrpContext, Fcb );
02278         <span class="keywordflow">break</span>;
02279     }
02280 
02281     <span class="comment">//</span>
02282     <span class="comment">//  Decrement the Vcb reference count if this is a system</span>
02283     <span class="comment">//  Fcb.</span>
02284     <span class="comment">//</span>
02285 
02286     <span class="keywordflow">if</span> (Vcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02287 
02288         InterlockedDecrement( &amp;Vcb-&gt;<a class="code" href="../../d7/d5/struct__VCB.html#o16">VcbReference</a> );
02289         InterlockedDecrement( &amp;Vcb-&gt;<a class="code" href="../../d7/d5/struct__VCB.html#o17">VcbUserReference</a> );
02290     }
02291 
02292     <span class="keywordflow">return</span>;
02293 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a155" doxytag="udfprocs.h::UdfDeleteInternalStream" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID UdfDeleteInternalStream           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d7/d9/struct__FCB.html">PFCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Fcb</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d1/udfs_2cachesup_8c-source.html#l00215">215</a> of file <a class="el" href="../../d9/d1/udfs_2cachesup_8c-source.html">udfs/cachesup.c</a>.
<p>
References <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00338">ASSERT_FCB</a>, <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00352">ASSERT_IRP_CONTEXT</a>, <a class="el" href="../../d4/d2/cache_8h.html#a59">CcUninitializeCacheMap()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01522">_FILE_OBJECT::PrivateCacheMap</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01567">UdfLockFcb</a>, and <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01577">UdfUnlockFcb</a>.
<p>
Referenced by <a class="el" href="../../d9/d1/udfs_2cachesup_8c-source.html#l00417">UdfPurgeVolume()</a>, and <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l01606">UdfTeardownStructures()</a>.
<p>
<pre class="fragment"><div>00222                    :
00223 
00224     This function creates an internal stream <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> <span class="keywordflow">for</span> interaction
00225     with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> cache manager.  The Fcb here can be <span class="keywordflow">for</span> either a
00226     directory stream or <span class="keywordflow">for</span> a metadata stream.
00227 
00228 Arguments:
00229 
00230     Fcb - Points to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Fcb <span class="keywordflow">for</span> <span class="keyword">this</span> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.  It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> either an <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> or
00231         Metadata Fcb.
00232 
00233 Return Value:
00234 
00235     None.
00236 
00237 --*/
00238 
00239 {
00240     <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject;
00241 
00242     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00243 
00244     <a class="code" href="../../d1/d8/udfdata_8h.html#a28">ASSERT_IRP_CONTEXT</a>( IrpContext );
00245     <a class="code" href="../../d1/d8/udfdata_8h.html#a14">ASSERT_FCB</a>( Fcb );
00246 
00247     <span class="comment">//</span>
00248     <span class="comment">//  Lock the Fcb.</span>
00249     <span class="comment">//</span>
00250 
00251     <a class="code" href="../../d3/d8/udfprocs_8h.html#a90">UdfLockFcb</a>( IrpContext, Fcb );
00252 
00253     <span class="comment">//</span>
00254     <span class="comment">//  Capture the file object.</span>
00255     <span class="comment">//</span>
00256 
00257     FileObject = Fcb-&gt;FileObject;
00258     Fcb-&gt;FileObject = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00259 
00260     <span class="comment">//</span>
00261     <span class="comment">//  It is now safe to unlock the Fcb.</span>
00262     <span class="comment">//</span>
00263 
00264     <a class="code" href="../../d3/d8/udfprocs_8h.html#a91">UdfUnlockFcb</a>( IrpContext, Fcb );
00265 
00266     <span class="comment">//</span>
00267     <span class="comment">//  Dereference the file object if present.</span>
00268     <span class="comment">//</span>
00269 
00270     <span class="keywordflow">if</span> (FileObject != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00271 
00272         <span class="keywordflow">if</span> (FileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o7">PrivateCacheMap</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00273 
00274             <a class="code" href="../../d4/d2/cache_8h.html#a59">CcUninitializeCacheMap</a>( FileObject, NULL, NULL );
00275         }
00276 
00277         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( FileObject );
00278     }
00279 
00280     <span class="keywordflow">return</span>;
00281 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a147" doxytag="udfprocs.h::UdfDeletePcb" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID UdfDeletePcb           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d4/d9/struct__PCB.html">PPCB</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Pcb</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d5/allocsup_8c-source.html#l00309">309</a> of file <a class="el" href="../../d3/d5/allocsup_8c-source.html">allocsup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00670">FsRtlUninitializeLargeMcb()</a>, <a class="el" href="../../d6/d8/udfstruc_8h.html#a129a115">Physical</a>, <a class="el" href="../../d4/d9/arcinst_8h.html#a47">PPARTITION</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00453">UdfFreePool()</a>, <a class="el" href="../../d6/d8/udfstruc_8h.html#a129a114">Uninitialized</a>, and <a class="el" href="../../d6/d8/alpha_2exdsptch_8c-source.html#l00105">Virtual</a>.
<p>
Referenced by <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l01210">UdfDeleteVcb()</a>, <a class="el" href="../../d3/d5/allocsup_8c-source.html#l00367">UdfInitializePcb()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l01444">UdfMountVolume()</a>, and <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l02043">UdfVerifyVolume()</a>.
<p>
<pre class="fragment"><div>00315                    :
00316 
00317     This routine deallocates a Pcb and all ancilliary structures.
00318 
00319 Arguments:
00320 
00321     Pcb - Pcb being deleted
00322 
00323 Return Value:
00324 
00325     None
00326 
00327 --*/
00328 
00329 {
00330     <a class="code" href="../../d2/d9/struct__tagPARTITION.html">PPARTITION</a> Partition;
00331 
00332     <span class="keywordflow">if</span> (Pcb-&gt;SparingMcb) {
00333 
00334         <a class="code" href="../../d1/d8/fsrtl_8h.html#a140">FsRtlUninitializeLargeMcb</a>( Pcb-&gt;SparingMcb );
00335         <a class="code" href="../../d3/d8/udfprocs_8h.html#a124">UdfFreePool</a>( &amp;Pcb-&gt;SparingMcb );
00336     }
00337 
00338     <span class="keywordflow">for</span> (Partition = Pcb-&gt;Partition;
00339          Partition &lt; &amp;Pcb-&gt;Partition[Pcb-&gt;Partitions];
00340          Partition++) {
00341 
00342         <span class="keywordflow">switch</span> (Partition-&gt;Type) {
00343 
00344             <span class="keywordflow">case</span> <a class="code" href="../../d6/d8/udfstruc_8h.html#a129a115">Physical</a>:
00345 
00346                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a124">UdfFreePool</a>( &amp;Partition-&gt;Physical.PartitionDescriptor );
00347                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a124">UdfFreePool</a>( &amp;Partition-&gt;Physical.SparingMap );                
00348 
00349                 <span class="keywordflow">break</span>;
00350 
00351             <span class="keywordflow">case</span> <a class="code" href="../../d5/d9/alpha_2exdsptch_8c.html#a2">Virtual</a>:
00352             <span class="keywordflow">case</span> <a class="code" href="../../d6/d8/udfstruc_8h.html#a129a114">Uninitialized</a>:
00353                 <span class="keywordflow">break</span>;
00354 
00355             <span class="keywordflow">default</span>:
00356 
00357                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( FALSE );
00358                 <span class="keywordflow">break</span>;
00359         }
00360     }
00361 
00362     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( Pcb );
00363 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a206" doxytag="udfprocs.h::UdfDeleteVcb" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID UdfDeleteVcb           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT <a class="el" href="../../d7/d5/struct__VCB.html">PVCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Vcb</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l01210">1210</a> of file <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html">udfs/strucsup.c</a>.
<p>
References <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00363">ASSERT_EXCLUSIVE_UDFDATA</a>, <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00364">ASSERT_EXCLUSIVE_VCB</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02478">ExDeleteResource</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00426">FsRtlNotifyUninitializeSync()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l05951">IoDeleteDevice()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00494">ObDereferenceObject</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d3/d5/allocsup_8c-source.html#l00309">UdfDeletePcb()</a>, and <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00453">UdfFreePool()</a>.
<p>
Referenced by <a class="el" href="../../d9/d4/udfs_2verfysup_8c-source.html#l00236">UdfCheckForDismount()</a>, and <a class="el" href="../../d9/d4/udfs_2verfysup_8c-source.html#l00365">UdfDismountVcb()</a>.
<p>
<pre class="fragment"><div>01217                    :
01218 
01219     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called to <span class="keyword">delete</span> a Vcb which failed mount or has been
01220     dismounted.  The dismount code should have already removed all of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01221     open Fcb's.  We <span class="keywordflow">do</span> nothing here but clean up other auxilary structures.
01222 
01223 Arguments:
01224 
01225     Vcb - Vcb to <span class="keyword">delete</span>.
01226 
01227 Return Value:
01228 
01229     None
01230 
01231 --*/
01232 
01233 {
01234     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01235 
01236     <a class="code" href="../../d1/d8/udfdata_8h.html#a39">ASSERT_EXCLUSIVE_UDFDATA</a>;
01237     <a class="code" href="../../d1/d8/udfdata_8h.html#a40">ASSERT_EXCLUSIVE_VCB</a>( Vcb );
01238 
01239     <span class="comment">//</span>
01240     <span class="comment">//  If there is a Vpb then we must delete it ourselves.</span>
01241     <span class="comment">//</span>
01242 
01243     <span class="keywordflow">if</span> (Vcb-&gt;Vpb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01244 
01245         <a class="code" href="../../d3/d8/udfprocs_8h.html#a124">UdfFreePool</a>( &amp;Vcb-&gt;Vpb );
01246     }
01247 
01248     <span class="comment">//</span>
01249     <span class="comment">//  Drop the Pcb.</span>
01250     <span class="comment">//</span>
01251 
01252     <span class="keywordflow">if</span> (Vcb-&gt;Pcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01253 
01254         <a class="code" href="../../d3/d8/udfprocs_8h.html#a147">UdfDeletePcb</a>( Vcb-&gt;Pcb );
01255     }
01256 
01257     <span class="comment">//</span>
01258     <span class="comment">//  Dereference our target if we haven't already done so.</span>
01259     <span class="comment">//</span>
01260 
01261     <span class="keywordflow">if</span> (Vcb-&gt;TargetDeviceObject != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01262         
01263         <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a>( Vcb-&gt;TargetDeviceObject );
01264     }
01265     
01266     <span class="comment">//</span>
01267     <span class="comment">//  Remove this entry from the global queue.</span>
01268     <span class="comment">//</span>
01269 
01270     RemoveEntryList( &amp;Vcb-&gt;VcbLinks );
01271 
01272     <span class="comment">//</span>
01273     <span class="comment">//  Delete the Vcb and File resources.</span>
01274     <span class="comment">//</span>
01275 
01276     <a class="code" href="../../d5/d8/ex_8h.html#a73">ExDeleteResource</a>( &amp;Vcb-&gt;VcbResource );
01277     <a class="code" href="../../d5/d8/ex_8h.html#a73">ExDeleteResource</a>( &amp;Vcb-&gt;FileResource );
01278 
01279     <span class="comment">//</span>
01280     <span class="comment">//  Uninitialize the notify structures.</span>
01281     <span class="comment">//</span>
01282 
01283     <span class="keywordflow">if</span> (Vcb-&gt;NotifySync != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01284 
01285         <a class="code" href="../../d1/d8/fsrtl_8h.html#a170">FsRtlNotifyUninitializeSync</a>( &amp;Vcb-&gt;NotifySync );
01286     }
01287 
01288     <span class="comment">//</span>
01289     <span class="comment">//  Now delete the volume device object.</span>
01290     <span class="comment">//</span>
01291 
01292     <a class="code" href="../../d4/d6/iosubs_8c.html#a55">IoDeleteDevice</a>( (<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>) CONTAINING_RECORD( Vcb,
01293                                                         <a class="code" href="../../d6/d7/struct__VOLUME__DEVICE__OBJECT.html">VOLUME_DEVICE_OBJECT</a>,
01294                                                         Vcb ));
01295 
01296     <span class="keywordflow">return</span>;
01297 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a233" doxytag="udfprocs.h::UdfDismountVcb" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN UdfDismountVcb           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d7/d5/struct__VCB.html">PVCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Vcb</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d4/udfs_2verfysup_8c-source.html#l00365">365</a> of file <a class="el" href="../../d9/d4/udfs_2verfysup_8c-source.html">udfs/verfysup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00363">ASSERT_EXCLUSIVE_UDFDATA</a>, <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00364">ASSERT_EXCLUSIVE_VCB</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00509">ClearFlag</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01072">_VPB::DeviceObject</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00253">ExAllocatePoolWithTag</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01070">_VPB::Flags</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00044">IO_TYPE_VPB</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l00134">IoAcquireVpbSpinLock()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l09644">IoReleaseVpbSpinLock()</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a175">NonPagedPoolMustSucceed</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01073">_VPB::RealDevice</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01075">_VPB::ReferenceCount</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01069">_VPB::Size</a>, <a class="el" href="../../d2/d6/udfs_2nodetype_8h-source.html#l00174">TAG_VPB</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01068">_VPB::Type</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l01210">UdfDeleteVcb()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00453">UdfFreePool()</a>, <a class="el" href="../../d3/d8/close_8c-source.html#l00099">UdfFspClose()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01559">UdfLockVcb</a>, <a class="el" href="../../d9/d1/udfs_2cachesup_8c-source.html#l00417">UdfPurgeVolume()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01563">UdfUnlockVcb</a>, <a class="el" href="../../d6/d8/udfstruc_8h.html#a130a121">VcbDismountInProgress</a>, <a class="el" href="../../d0/d5/io_8h.html#a332">VPB</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01186">_DEVICE_OBJECT::Vpb</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01054">VPB_MOUNTED</a>, and <a class="el" href="../../d1/d4/io_8h-source.html#l01057">VPB_REMOVE_PENDING</a>.
<p>
Referenced by <a class="el" href="../../d9/d4/udfs_2verfysup_8c-source.html#l00236">UdfCheckForDismount()</a>, and <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l01444">UdfMountVolume()</a>.
<p>
<pre class="fragment"><div>00372                    :
00373 
00374     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called when all of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user references to a volume are
00375     gone.  We will initiate all of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> teardown any system resources.
00376 
00377     If all of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> references to <span class="keyword">this</span> volume are gone at <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> end of <span class="keyword">this</span> routine
00378     then we will complete <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> teardown of <span class="keyword">this</span> Vcb and mark <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current Vpb
00379     as not mounted.  Otherwise we will allocated a <span class="keyword">new</span> Vpb <span class="keywordflow">for</span> <span class="keyword">this</span> device
00380     and keep <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current Vpb attached to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Vcb.
00381 
00382 Arguments:
00383 
00384     Vcb - Vcb <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> volume to dismount.
00385 
00386 Return Value:
00387 
00388     BOOLEAN - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> we didn'<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> <span class="keyword">delete</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Vcb, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise.
00389 
00390 --*/
00391 
00392 {
00393     <a class="code" href="../../d7/d7/struct__VPB.html">PVPB</a> OldVpb;
00394     <a class="code" href="../../d7/d7/struct__VPB.html">PVPB</a> NewVpb;
00395     BOOLEAN VcbPresent = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00396     KIRQL SavedIrql;
00397 
00398     BOOLEAN FinalReference;
00399 
00400     <a class="code" href="../../d1/d8/udfdata_8h.html#a39">ASSERT_EXCLUSIVE_UDFDATA</a>;
00401     <a class="code" href="../../d1/d8/udfdata_8h.html#a40">ASSERT_EXCLUSIVE_VCB</a>( Vcb );
00402 
00403     <a class="code" href="../../d3/d8/udfprocs_8h.html#a88">UdfLockVcb</a>( IrpContext, Vcb );
00404 
00405     <span class="comment">//</span>
00406     <span class="comment">//  We should only take this path once.</span>
00407     <span class="comment">//</span>
00408 
00409     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( Vcb-&gt;VcbCondition != VcbDismountInProgress );
00410 
00411     <span class="comment">//</span>
00412     <span class="comment">//  Mark the Vcb as DismountInProgress.</span>
00413     <span class="comment">//</span>
00414 
00415     Vcb-&gt;VcbCondition = <a class="code" href="../../d6/d8/udfstruc_8h.html#a130a121">VcbDismountInProgress</a>;
00416 
00417     <span class="comment">//</span>
00418     <span class="comment">//  Remove our reference to the internal Fcb's.  The Fcb's will then</span>
00419     <span class="comment">//  be removed in the purge path below.</span>
00420     <span class="comment">//</span>
00421 
00422     <span class="keywordflow">if</span> (Vcb-&gt;RootIndexFcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00423 
00424         Vcb-&gt;RootIndexFcb-&gt;FcbReference -= 1;
00425         Vcb-&gt;RootIndexFcb-&gt;FcbUserReference -= 1;
00426     }
00427 
00428     <span class="keywordflow">if</span> (Vcb-&gt;MetadataFcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00429 
00430         Vcb-&gt;MetadataFcb-&gt;FcbReference -= 1;
00431         Vcb-&gt;MetadataFcb-&gt;FcbUserReference -= 1;
00432     }
00433 
00434     <span class="keywordflow">if</span> (Vcb-&gt;VatFcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00435 
00436         Vcb-&gt;VatFcb-&gt;FcbReference -= 1;
00437         Vcb-&gt;VatFcb-&gt;FcbUserReference -= 1;
00438     }
00439 
00440     <span class="keywordflow">if</span> (Vcb-&gt;VolumeDasdFcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00441 
00442         Vcb-&gt;VolumeDasdFcb-&gt;FcbReference -= 1;
00443         Vcb-&gt;VolumeDasdFcb-&gt;FcbUserReference -= 1;
00444     }
00445 
00446     <a class="code" href="../../d3/d8/udfprocs_8h.html#a89">UdfUnlockVcb</a>( IrpContext, Vcb );
00447 
00448     <span class="comment">//</span>
00449     <span class="comment">//  Purge the volume.</span>
00450     <span class="comment">//</span>
00451 
00452     <a class="code" href="../../d3/d8/udfprocs_8h.html#a158">UdfPurgeVolume</a>( IrpContext, Vcb, TRUE );
00453 
00454     <span class="comment">//</span>
00455     <span class="comment">//  Empty the delayed and async close queues.</span>
00456     <span class="comment">//</span>
00457 
00458     <a class="code" href="../../d3/d8/udfprocs_8h.html#a250">UdfFspClose</a>( Vcb );
00459 
00460     <span class="comment">//</span>
00461     <span class="comment">//  Allocate a new Vpb in case we will need it.</span>
00462     <span class="comment">//</span>
00463 
00464     NewVpb = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>( NonPagedPoolMustSucceed, <span class="keyword">sizeof</span>( <a class="code" href="../../d7/d7/struct__VPB.html">VPB</a> ), TAG_VPB );
00465     RtlZeroMemory( NewVpb, <span class="keyword">sizeof</span>( <a class="code" href="../../d7/d7/struct__VPB.html">VPB</a> ) );
00466 
00467     OldVpb = Vcb-&gt;Vpb;
00468 
00469     <span class="comment">//</span>
00470     <span class="comment">//  Remove the mount volume reference.</span>
00471     <span class="comment">//</span>
00472 
00473     <a class="code" href="../../d3/d8/udfprocs_8h.html#a88">UdfLockVcb</a>( IrpContext, Vcb );
00474     Vcb-&gt;VcbReference -= 1;
00475 
00476     <span class="comment">//</span>
00477     <span class="comment">//  Acquire the Vpb spinlock to check for Vpb references.</span>
00478     <span class="comment">//</span>
00479 
00480     <a class="code" href="../../d4/d6/iosubs_8c.html#a10">IoAcquireVpbSpinLock</a>( &amp;SavedIrql );
00481 
00482     <span class="comment">//</span>
00483     <span class="comment">//  Remember if this is the last reference on this Vcb.  We incremented</span>
00484     <span class="comment">//  the count on the Vpb earlier so we get one last crack it.  If our</span>
00485     <span class="comment">//  reference has gone to zero but the vpb reference count is greater</span>
00486     <span class="comment">//  than zero then the Io system will be responsible for deleting the</span>
00487     <span class="comment">//  Vpb.</span>
00488     <span class="comment">//</span>
00489 
00490     FinalReference = (BOOLEAN) ((Vcb-&gt;VcbReference == 0) &amp;&amp;
00491                                 (OldVpb-&gt;<a class="code" href="../../d7/d7/struct__VPB.html#o7">ReferenceCount</a> == 1));
00492 
00493     <span class="comment">//</span>
00494     <span class="comment">//  There is a reference count in the Vpb and in the Vcb.  We have</span>
00495     <span class="comment">//  incremented the reference count in the Vpb to make sure that</span>
00496     <span class="comment">//  we have last crack at it.  If this is a failed mount then we</span>
00497     <span class="comment">//  want to return the Vpb to the IO system to use for the next</span>
00498     <span class="comment">//  mount request.</span>
00499     <span class="comment">//</span>
00500 
00501     <span class="keywordflow">if</span> (OldVpb-&gt;<a class="code" href="../../d7/d7/struct__VPB.html#o5">RealDevice</a>-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o10">Vpb</a> == OldVpb) {
00502 
00503         <span class="comment">//</span>
00504         <span class="comment">//  If not the final reference then swap out the Vpb.  We must</span>
00505         <span class="comment">//  preserve the REMOVE_PENDING flag so that the device is</span>
00506         <span class="comment">//  not remounted in the middle of a PnP remove operation.</span>
00507         <span class="comment">//</span>
00508 
00509         <span class="keywordflow">if</span> (!FinalReference) {
00510 
00511             NewVpb-&gt;<a class="code" href="../../d7/d7/struct__VPB.html#o0">Type</a> = <a class="code" href="../../d0/d5/io_8h.html#a9">IO_TYPE_VPB</a>;
00512             NewVpb-&gt;<a class="code" href="../../d7/d7/struct__VPB.html#o1">Size</a> = <span class="keyword">sizeof</span>( <a class="code" href="../../d7/d7/struct__VPB.html">VPB</a> );
00513             NewVpb-&gt;<a class="code" href="../../d7/d7/struct__VPB.html#o5">RealDevice</a> = OldVpb-&gt;<a class="code" href="../../d7/d7/struct__VPB.html#o5">RealDevice</a>;
00514 
00515             NewVpb-&gt;<a class="code" href="../../d7/d7/struct__VPB.html#o5">RealDevice</a>-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o10">Vpb</a> = NewVpb;
00516 
00517             NewVpb-&gt;<a class="code" href="../../d7/d7/struct__VPB.html#o2">Flags</a> = <a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( OldVpb-&gt;<a class="code" href="../../d7/d7/struct__VPB.html#o2">Flags</a>, VPB_REMOVE_PENDING );
00518             
00519             NewVpb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00520             <a class="code" href="../../d4/d6/iosubs_8c.html#a102">IoReleaseVpbSpinLock</a>( SavedIrql );
00521             <a class="code" href="../../d3/d8/udfprocs_8h.html#a89">UdfUnlockVcb</a>( IrpContext, Vcb );
00522 
00523         <span class="comment">//</span>
00524         <span class="comment">//  We want to leave the Vpb for the IO system.  Mark it</span>
00525         <span class="comment">//  as being not mounted.  Go ahead and delete the Vcb as</span>
00526         <span class="comment">//  well.</span>
00527         <span class="comment">//</span>
00528 
00529         } <span class="keywordflow">else</span> {
00530 
00531             <span class="comment">//</span>
00532             <span class="comment">//  Make sure to remove the last reference on the Vpb.</span>
00533             <span class="comment">//</span>
00534 
00535             OldVpb-&gt;<a class="code" href="../../d7/d7/struct__VPB.html#o7">ReferenceCount</a> -= 1;
00536 
00537             OldVpb-&gt;<a class="code" href="../../d7/d7/struct__VPB.html#o4">DeviceObject</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00538             <a class="code" href="../../d5/d5/cc_8h.html#a61">ClearFlag</a>( Vcb-&gt;Vpb-&gt;Flags, VPB_MOUNTED );
00539 
00540             <span class="comment">//</span>
00541             <span class="comment">//  Clear the Vpb flag so we know not to delete it.</span>
00542             <span class="comment">//</span>
00543 
00544             Vcb-&gt;Vpb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00545 
00546             <a class="code" href="../../d4/d6/iosubs_8c.html#a102">IoReleaseVpbSpinLock</a>( SavedIrql );
00547             <a class="code" href="../../d3/d8/udfprocs_8h.html#a89">UdfUnlockVcb</a>( IrpContext, Vcb );
00548             <a class="code" href="../../d3/d8/udfprocs_8h.html#a206">UdfDeleteVcb</a>( IrpContext, Vcb );
00549             VcbPresent = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00550         }
00551 
00552     <span class="comment">//</span>
00553     <span class="comment">//  Someone has already swapped in a new Vpb.  If this is the final reference</span>
00554     <span class="comment">//  then the file system is responsible for deleting the Vpb.</span>
00555     <span class="comment">//</span>
00556 
00557     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (FinalReference) {
00558 
00559         <span class="comment">//</span>
00560         <span class="comment">//  Make sure to remove the last reference on the Vpb.</span>
00561         <span class="comment">//</span>
00562 
00563         OldVpb-&gt;<a class="code" href="../../d7/d7/struct__VPB.html#o7">ReferenceCount</a> -= 1;
00564 
00565         <a class="code" href="../../d4/d6/iosubs_8c.html#a102">IoReleaseVpbSpinLock</a>( SavedIrql );
00566         <a class="code" href="../../d3/d8/udfprocs_8h.html#a89">UdfUnlockVcb</a>( IrpContext, Vcb );
00567         <a class="code" href="../../d3/d8/udfprocs_8h.html#a206">UdfDeleteVcb</a>( IrpContext, Vcb );
00568         VcbPresent = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00569 
00570     <span class="comment">//</span>
00571     <span class="comment">//  The current Vpb is no longer the Vpb for the device (the IO system</span>
00572     <span class="comment">//  has already allocated a new one).  We leave our reference in the</span>
00573     <span class="comment">//  Vpb and will be responsible for deleting it at a later time.</span>
00574     <span class="comment">//</span>
00575 
00576     } <span class="keywordflow">else</span> {
00577 
00578         OldVpb-&gt;<a class="code" href="../../d7/d7/struct__VPB.html#o4">DeviceObject</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00579         <a class="code" href="../../d5/d5/cc_8h.html#a61">ClearFlag</a>( Vcb-&gt;Vpb-&gt;Flags, VPB_MOUNTED );
00580 
00581         <a class="code" href="../../d4/d6/iosubs_8c.html#a102">IoReleaseVpbSpinLock</a>( SavedIrql );
00582         <a class="code" href="../../d3/d8/udfprocs_8h.html#a89">UdfUnlockVcb</a>( IrpContext, Vcb );
00583     }
00584 
00585     <span class="comment">//</span>
00586     <span class="comment">//  Deallocate the new Vpb if we don't need it.</span>
00587     <span class="comment">//</span>
00588 
00589     <span class="keywordflow">if</span> (NewVpb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00590 
00591         <a class="code" href="../../d3/d8/udfprocs_8h.html#a124">UdfFreePool</a>( &amp;NewVpb );
00592     }
00593 
00594     <span class="comment">//</span>
00595     <span class="comment">//  Let our caller know whether the Vcb is still present.</span>
00596     <span class="comment">//</span>
00597 
00598     <span class="keywordflow">return</span> VcbPresent;
00599 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a177" doxytag="udfprocs.h::UdfDissectName" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID UdfDissectName           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>RemainingName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>FinalName</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d4/namesup_8c-source.html#l00096">96</a> of file <a class="el" href="../../d6/d4/namesup_8c-source.html">namesup.c</a>.
<p>
References <a class="el" href="../../d3/d6/notify_8c-source.html#l00236">Add2Ptr</a>, <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00352">ASSERT_IRP_CONTEXT</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d4/d7/udfs_2create_8c-source.html#l00108">UdfCommonCreate()</a>, and <a class="el" href="../../d6/d3/prefxsup_8c-source.html#l00324">UdfFindPrefix()</a>.
<p>
<pre class="fragment"><div>00104                    :
00105 
00106     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called to strip off leading components of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name strings.  We search
00107     <span class="keywordflow">for</span> either <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> end of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> string or separating characters.  The input remaining
00108     name strings should have neither a trailing or leading backslash.
00109 
00110 Arguments:
00111 
00112     RemainingName - Remaining name.
00113 
00114     FinalName - Location to store next component of name.
00115 
00116 Return Value:
00117 
00118     None.
00119 
00120 --*/
00121 
00122 {
00123     ULONG NameLength;
00124     PWCHAR NextWchar;
00125 
00126     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00127 
00128     <span class="comment">//</span>
00129     <span class="comment">//  Check inputs.</span>
00130     <span class="comment">//</span>
00131 
00132     <a class="code" href="../../d1/d8/udfdata_8h.html#a28">ASSERT_IRP_CONTEXT</a>( IrpContext );
00133 
00134     <span class="comment">//</span>
00135     <span class="comment">//  Find the offset of the next component separators.</span>
00136     <span class="comment">//</span>
00137 
00138     <span class="keywordflow">for</span> (NameLength = 0, NextWchar = RemainingName-&gt;Buffer;
00139          (NameLength &lt; RemainingName-&gt;Length) &amp;&amp; (*NextWchar != <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\\'</span>);
00140          NameLength += <span class="keyword">sizeof</span>( WCHAR) , NextWchar += 1);
00141 
00142     <span class="comment">//</span>
00143     <span class="comment">//  Adjust all the strings by this amount.</span>
00144     <span class="comment">//</span>
00145 
00146     FinalName-&gt;Buffer = RemainingName-&gt;Buffer;
00147 
00148     FinalName-&gt;MaximumLength = FinalName-&gt;Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) NameLength;
00149 
00150     <span class="comment">//</span>
00151     <span class="comment">//  If this is the last component then set the RemainingName lengths to zero.</span>
00152     <span class="comment">//</span>
00153 
00154     <span class="keywordflow">if</span> (NameLength == RemainingName-&gt;Length) {
00155 
00156         RemainingName-&gt;Length = 0;
00157 
00158     <span class="comment">//</span>
00159     <span class="comment">//  Otherwise we adjust the string by this amount plus the separating character.</span>
00160     <span class="comment">//</span>
00161 
00162     } <span class="keywordflow">else</span> {
00163 
00164         RemainingName-&gt;MaximumLength -= (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) (NameLength + <span class="keyword">sizeof</span>( WCHAR ));
00165         RemainingName-&gt;Length -= (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) (NameLength + <span class="keyword">sizeof</span>( WCHAR ));
00166         RemainingName-&gt;Buffer = <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( RemainingName-&gt;Buffer,
00167                                          NameLength + <span class="keyword">sizeof</span>( WCHAR ),
00168                                          PWCHAR );
00169     }
00170 
00171     <span class="keywordflow">return</span>;
00172 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a230" doxytag="udfprocs.h::UdfDomainIdentifierContained" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> INLINE BOOLEAN UdfDomainIdentifierContained           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d6/d6/structREGID.html">PREGID</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>RegID</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSTRING&nbsp;</td>
          <td class="mdname" nowrap> <em>Domain</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>RevisionMin</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>RevisionMax</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l02027">2027</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.
<p>
References <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01988">UdfEqualEntityId()</a>, and <a class="el" href="../../d0/d7/udf_8h-source.html#l00262">_UDF_SUFFIX_DOMAIN::UdfRevision</a>.
<p>
Referenced by <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l02832">UdfFindVolumeDescriptors()</a>, and <a class="el" href="../../d3/d5/allocsup_8c-source.html#l00367">UdfInitializePcb()</a>.
<p>
<pre class="fragment"><div>02033 {
02034     <a class="code" href="../../d6/d3/struct__UDF__SUFFIX__DOMAIN.html">PUDF_SUFFIX_DOMAIN</a> DomainSuffix = (<a class="code" href="../../d6/d3/struct__UDF__SUFFIX__DOMAIN.html">PUDF_SUFFIX_DOMAIN</a>) RegID-&gt;Suffix;
02035 
02036 <span class="preprocessor">#ifdef UDF_SUPPORT_NONSTANDARD_ALLSTOR</span>
02037 <span class="preprocessor"></span>    
02038     <span class="comment">//</span>
02039     <span class="comment">//  Disable checking of the UDF revision.</span>
02040     <span class="comment">//</span>
02041     <span class="comment">//  Reason: first drop of Allstor media recorded the version number as</span>
02042     <span class="comment">//      a decimal number, not hex (102 = 0x66)</span>
02043     <span class="comment">//</span>
02044 
02045     <span class="keywordflow">return</span> (<a class="code" href="../../d3/d8/udfprocs_8h.html#a229">UdfEqualEntityId</a>( RegID, Domain, NULL ));
02046 
02047 <span class="preprocessor">#else</span>
02048 <span class="preprocessor"></span>
02049     <span class="keywordflow">return</span> ((DomainSuffix-&gt;<a class="code" href="../../d6/d3/struct__UDF__SUFFIX__DOMAIN.html#o0">UdfRevision</a> &lt;= RevisionMax &amp;&amp; DomainSuffix-&gt;<a class="code" href="../../d6/d3/struct__UDF__SUFFIX__DOMAIN.html#o0">UdfRevision</a> &gt;= RevisionMin) &amp;&amp;
02050             <a class="code" href="../../d3/d8/udfprocs_8h.html#a229">UdfEqualEntityId</a>( RegID, Domain, NULL ));
02051 <span class="preprocessor">#endif</span>
02052 <span class="preprocessor"></span>}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a248" doxytag="udfprocs.h::UdfEqualCharspec" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> INLINE BOOLEAN UdfEqualCharspec           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d2/d3/structCHARSPEC.html">PCHARSPEC</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Charspec</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSTRING&nbsp;</td>
          <td class="mdname" nowrap> <em>Identifier</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN UCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>Type</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l02228">2228</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.
<p>
References <a class="el" href="../../d0/d7/iso13346_8h.html#a168">PCHARSPEC</a>, and <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00472">UdfEqualCountedString()</a>.
<p>
Referenced by <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l02832">UdfFindVolumeDescriptors()</a>.
<p>
<pre class="fragment"><div>02233 {
02234     <span class="keywordflow">return</span> ((Charspec-&gt;Type == Type) &amp;&amp; <a class="code" href="../../d3/d8/udfprocs_8h.html#a125">UdfEqualCountedString</a>( Identifier, Charspec-&gt;Info));
02235 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a125" doxytag="udfprocs.h::UdfEqualCountedString" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> INLINE BOOLEAN UdfEqualCountedString           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PSTRING&nbsp;</td>
          <td class="mdname" nowrap> <em>String</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>Field</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00472">472</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.
<p>
References <a class="el" href="../../d2/d0/bench_8c-source.html#l00050">CHAR</a>, and <a class="el" href="../../d5/d8/talloc_8c-source.html#l00027">String</a>.
<p>
Referenced by <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l02228">UdfEqualCharspec()</a>, and <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01988">UdfEqualEntityId()</a>.
<p>
<pre class="fragment"><div>00476 {
00477     <span class="keywordflow">return</span> (RtlEqualMemory( (CHAR UNALIGNED *)<a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>-&gt;Buffer,
00478                             (CHAR UNALIGNED *)Field,
00479                             <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a>-&gt;Length )                    != 0);
00480 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a229" doxytag="udfprocs.h::UdfEqualEntityId" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> INLINE BOOLEAN UdfEqualEntityId           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d6/d6/structREGID.html">PREGID</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>RegID</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSTRING&nbsp;</td>
          <td class="mdname" nowrap> <em>Id</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OPTIONAL PSTRING&nbsp;</td>
          <td class="mdname" nowrap> <em>Suffix</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01988">1988</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.
<p>
References <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00472">UdfEqualCountedString()</a>.
<p>
Referenced by <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l02027">UdfDomainIdentifierContained()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l02832">UdfFindVolumeDescriptors()</a>, and <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l02060">UdfUdfIdentifierContained()</a>.
<p>
<pre class="fragment"><div>01993 {
01994 
01995     <span class="keywordflow">return</span> (<a class="code" href="../../d3/d8/udfprocs_8h.html#a125">UdfEqualCountedString</a>( Id, RegID-&gt;Identifier ) &amp;&amp;
01996 
01997 <span class="preprocessor">#ifndef UDF_SUPPORT_NONSTANDARD_ENTITY_STRINGTERM</span>
01998 <span class="preprocessor"></span>            
01999             <span class="comment">//</span>
02000             <span class="comment">//  Allow disabling of the check that the identifier</span>
02001             <span class="comment">//  seems to be padded with zero.</span>
02002             <span class="comment">//</span>
02003             <span class="comment">//  Reason: a couple samples that are otherwise useful</span>
02004             <span class="comment">//      padded some identifiers with junk.</span>
02005             <span class="comment">//</span>
02006 
02007             ((Id-&gt;Length == <span class="keyword">sizeof</span>(RegID-&gt;Identifier) ||
02008               RegID-&gt;Identifier[Id-&gt;Length] == <span class="charliteral">'\0'</span>) ||
02009              
02010              !<a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( 0, Dbg,
02011                            <span class="stringliteral">"UdfEqualEntityId, RegID seems to be terminated with junk!\n"</span> ))) &amp;&amp;
02012 <span class="preprocessor">#endif</span>
02013 <span class="preprocessor"></span>
02014             ((Suffix == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) || <a class="code" href="../../d3/d8/udfprocs_8h.html#a125">UdfEqualCountedString</a>( Suffix, RegID-&gt;Suffix )));
02015 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a151" doxytag="udfprocs.h::UdfEquivalentPcb" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN UdfEquivalentPcb           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d4/d9/struct__PCB.html">PPCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Pcb1</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d4/d9/struct__PCB.html">PPCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Pcb2</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d5/allocsup_8c-source.html#l00923">923</a> of file <a class="el" href="../../d3/d5/allocsup_8c-source.html">allocsup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00352">ASSERT_IRP_CONTEXT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d9/cmchek_8c-source.html#l00095">Index</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d6/d8/udfstruc_8h.html#a129a115">Physical</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d6/d8/alpha_2exdsptch_8c-source.html#l00105">Virtual</a>.
<p>
Referenced by <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l02043">UdfVerifyVolume()</a>.
<p>
<pre class="fragment"><div>00931                    :
00932 
00933     This routine compares two completed Pcbs to see <span class="keywordflow">if</span> they appear equivalent.
00934 
00935 Arguments:
00936 
00937     Pcb1 - Pcb being compared
00938 
00939     Pcb2 - Pcb being compared
00940 
00941 Return Value:
00942 
00943     BOOLEAN according to whether they are equivalent (TRUE, <span class="keywordflow">else</span> FALSE)
00944 
00945 --*/
00946 
00947 {
00948     ULONG <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00949 
00950     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00951 
00952     <span class="comment">//</span>
00953     <span class="comment">//  Check input.</span>
00954     <span class="comment">//</span>
00955 
00956     <a class="code" href="../../d1/d8/udfdata_8h.html#a28">ASSERT_IRP_CONTEXT</a>( IrpContext );
00957 
00958     <span class="keywordflow">if</span> (Pcb1-&gt;Partitions != Pcb2-&gt;Partitions) {
00959 
00960         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00961     }
00962 
00963     <span class="keywordflow">for</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = 0;
00964          <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; Pcb1-&gt;Partitions;
00965          <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>++) {
00966 
00967         <span class="comment">//</span>
00968         <span class="comment">//  First check that the partitions are of the same type.</span>
00969         <span class="comment">//</span>
00970 
00971         <span class="keywordflow">if</span> (Pcb1-&gt;Partition[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Type != Pcb2-&gt;Partition[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Type) {
00972 
00973             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00974         }
00975 
00976         <span class="comment">//</span>
00977         <span class="comment">//  Now the map content must be the same ...</span>
00978         <span class="comment">//</span>
00979 
00980         <span class="keywordflow">switch</span> (Pcb1-&gt;Partition[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Type) {
00981 
00982             <span class="keywordflow">case</span> <a class="code" href="../../d6/d8/udfstruc_8h.html#a129a115">Physical</a>:
00983 
00984                 <span class="keywordflow">if</span> (Pcb1-&gt;Partition[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Physical.PartitionNumber != Pcb2-&gt;Partition[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Physical.PartitionNumber ||
00985                     Pcb1-&gt;Partition[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Physical.Length != Pcb2-&gt;Partition[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Physical.Length ||
00986                     Pcb1-&gt;Partition[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Physical.Start != Pcb2-&gt;Partition[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Physical.Start) {
00987 
00988                     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00989                 }
00990                 <span class="keywordflow">break</span>;
00991 
00992             <span class="keywordflow">case</span> <a class="code" href="../../d5/d9/alpha_2exdsptch_8c.html#a2">Virtual</a>:
00993 
00994                 <span class="keywordflow">if</span> (Pcb1-&gt;Partition[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Virtual.RelatedReference != Pcb2-&gt;Partition[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Virtual.RelatedReference) {
00995 
00996                     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00997                 }
00998                 <span class="keywordflow">break</span>;
00999 
01000             <span class="keywordflow">default</span>:
01001 
01002                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( FALSE);
01003                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01004                 <span class="keywordflow">break</span>;
01005         }
01006     }
01007 
01008     <span class="comment">//</span>
01009     <span class="comment">//  All map elements were equivalent.</span>
01010     <span class="comment">//</span>
01011 
01012     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01013 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a127" doxytag="udfprocs.h::UdfExceptionFilter" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> LONG UdfExceptionFilter           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PEXCEPTION_POINTERS&nbsp;</td>
          <td class="mdname" nowrap> <em>ExceptionPointer</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00448">448</a> of file <a class="el" href="../../d1/d7/udfdata_8c-source.html">udfdata.c</a>.
<p>
References <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00353">ASSERT_OPTIONAL_IRP_CONTEXT</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00055">EXCEPTION_EXECUTE_HANDLER</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d8/d2/fsrtl_2filter_8c-source.html#l00082">FsRtlIsNtstatusExpected()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, and <a class="el" href="../../d2/d6/udfs_2nodetype_8h-source.html#l00149">UdfBugCheck</a>.
<p>
Referenced by <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l02558">UdfFindFileSetDescriptor()</a>, <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00218">UdfFsdDispatch()</a>, <a class="el" href="../../d1/d7/fspdisp_8c-source.html#l00038">UdfFspDispatch()</a>, <a class="el" href="../../d4/d7/udfs_2create_8c-source.html#l01244">UdfOpenObjectByFileId()</a>, <a class="el" href="../../d9/d4/udfs_2verfysup_8c-source.html#l00042">UdfPerformVerify()</a>, and <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00539">UdfProcessException()</a>.
<p>
<pre class="fragment"><div>00455                    :
00456 
00457     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to decide whether we will handle a raised exception
00458     status.  If UDFS explicitly raised an error then <span class="keyword">this</span> status <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> already
00459     in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> IrpContext.  We choose which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> correct status code and
00460     either indicate that we will handle <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exception or bug-check <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system.
00461 
00462 Arguments:
00463 
00464     ExceptionCode - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exception code to being checked.
00465 
00466 Return Value:
00467 
00468     ULONG - returns <a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a> or bugchecks
00469 
00470 --*/
00471 
00472 {
00473     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> ExceptionCode;
00474     BOOLEAN TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00475 
00476     <a class="code" href="../../d1/d8/udfdata_8h.html#a29">ASSERT_OPTIONAL_IRP_CONTEXT</a>( IrpContext );
00477 
00478     ExceptionCode = ExceptionPointer-&gt;ExceptionRecord-&gt;ExceptionCode;
00479 
00480     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( 0, Dbg,
00481                  <span class="stringliteral">"UdfExceptionFilter: %08x (exr %08x cxr %08x)\n"</span>,
00482                  ExceptionCode,
00483                  ExceptionPointer-&gt;ExceptionRecord,
00484                  ExceptionPointer-&gt;ContextRecord ));
00485 
00486 
00487     <span class="comment">//</span>
00488     <span class="comment">// If the exception is STATUS_IN_PAGE_ERROR, get the I/O error code</span>
00489     <span class="comment">// from the exception record.</span>
00490     <span class="comment">//</span>
00491 
00492     <span class="keywordflow">if</span> ((ExceptionCode == STATUS_IN_PAGE_ERROR) &amp;&amp;
00493         (ExceptionPointer-&gt;ExceptionRecord-&gt;NumberParameters &gt;= 3)) {
00494 
00495         ExceptionCode = (<a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>) ExceptionPointer-&gt;ExceptionRecord-&gt;ExceptionInformation[2];
00496     }
00497 
00498     <span class="comment">//</span>
00499     <span class="comment">//  If there is an Irp context then check which status code to use.</span>
00500     <span class="comment">//</span>
00501 
00502     <span class="keywordflow">if</span> (ARGUMENT_PRESENT( IrpContext )) {
00503 
00504         <span class="keywordflow">if</span> (IrpContext-&gt;ExceptionStatus == STATUS_SUCCESS) {
00505 
00506             <span class="comment">//</span>
00507             <span class="comment">//  Store the real status into the IrpContext.</span>
00508             <span class="comment">//</span>
00509 
00510             IrpContext-&gt;ExceptionStatus = ExceptionCode;
00511 
00512         } <span class="keywordflow">else</span> {
00513 
00514             <span class="comment">//</span>
00515             <span class="comment">//  No need to test the status code if we raised it ourselves.</span>
00516             <span class="comment">//</span>
00517 
00518             TestStatus = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00519         }
00520     }
00521 
00522     <span class="comment">//</span>
00523     <span class="comment">//  Bug check if this status is not supported.</span>
00524     <span class="comment">//</span>
00525 
00526     <span class="keywordflow">if</span> (TestStatus &amp;&amp; !<a class="code" href="../../d1/d8/fsrtl_8h.html#a137">FsRtlIsNtstatusExpected</a>( ExceptionCode )) {
00527 
00528         <a class="code" href="../../d1/d7/udfs_2nodetype_8h.html#a66">UdfBugCheck</a>( (ULONG_PTR) ExceptionPointer-&gt;ExceptionRecord,
00529                      (ULONG_PTR) ExceptionPointer-&gt;ContextRecord,
00530                      (ULONG_PTR) ExceptionPointer-&gt;ExceptionRecord-&gt;ExceptionAddress );
00531 
00532     }
00533 
00534     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>;
00535 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a175" doxytag="udfprocs.h::UdfFastDecodeFileObject" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d3/d8/udfprocs_8h.html#a109">TYPE_OF_OPEN</a> UdfFastDecodeFileObject           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d7/d9/struct__FCB.html">PFCB</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>Fcb</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d2/filobsup_8c-source.html#l00201">201</a> of file <a class="el" href="../../d7/d2/filobsup_8c-source.html">filobsup.c</a>.
<p>
References <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00358">ASSERT_FILE_OBJECT</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d3/d8/udfprocs_8h.html#a109">TYPE_OF_OPEN</a>, and <a class="el" href="../../d7/d2/filobsup_8c-source.html#l00039">TYPE_OF_OPEN_MASK</a>.
<p>
Referenced by <a class="el" href="../../d3/d4/lockctrl_8c-source.html#l00152">UdfFastLock()</a>, <a class="el" href="../../d5/d2/fileinfo_8c-source.html#l00614">UdfFastQueryStdInfo()</a>, <a class="el" href="../../d3/d4/lockctrl_8c-source.html#l00436">UdfFastUnlockAll()</a>, <a class="el" href="../../d3/d4/lockctrl_8c-source.html#l00557">UdfFastUnlockAllByKey()</a>, and <a class="el" href="../../d3/d4/lockctrl_8c-source.html#l00297">UdfFastUnlockSingle()</a>.
<p>
<pre class="fragment"><div>00208                    :
00209 
00210     This <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a69">procedure</a> takes a pointer to a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object, that has already been
00211     opened by Udfs and does a quick decode operation.  It will <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> <span class="keywordflow">return</span>
00212     a non null value <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a user <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> open
00213 
00214 Arguments:
00215 
00216     FileObject - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object pointer being interrogated
00217 
00218     Fcb - Address to store Fcb <span class="keywordflow">if</span> <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a user <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object.  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00219         otherwise.
00220 
00221 Return Value:
00222 
00223     <a class="code" href="../../d3/d8/udfprocs_8h.html#a109">TYPE_OF_OPEN</a> - <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of open of <span class="keyword">this</span> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object.
00224 
00225 --*/
00226 
00227 {
00228     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00229 
00230     <a class="code" href="../../d1/d8/udfdata_8h.html#a34">ASSERT_FILE_OBJECT</a>( FileObject );
00231 
00232     <span class="comment">//</span>
00233     <span class="comment">//  The Fcb is in the FsContext field.  The type of open is in the low</span>
00234     <span class="comment">//  bits of the Ccb.</span>
00235     <span class="comment">//</span>
00236 
00237     *Fcb = FileObject-&gt;FsContext;
00238 
00239     <span class="keywordflow">return</span> (<a class="code" href="../../d3/d8/udfprocs_8h.html#a109">TYPE_OF_OPEN</a>) <a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( (ULONG_PTR) FileObject-&gt;FsContext2, TYPE_OF_OPEN_MASK );
00240 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a222" doxytag="udfprocs.h::UdfFastInitializeIcbContext" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> INLINE VOID UdfFastInitializeIcbContext           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d9/d9/struct__ICB__SEARCH__CONTEXT.html">PICB_SEARCH_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IcbContext</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01872">1872</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.
<p>
Referenced by <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l00096">UdfInitializeCompoundDirContext()</a>.
<p>
<pre class="fragment"><div>01876 {
01877 
01878     RtlZeroMemory( IcbContext, <span class="keyword">sizeof</span>( <a class="code" href="../../d9/d9/struct__ICB__SEARCH__CONTEXT.html">ICB_SEARCH_CONTEXT</a> ));
01879 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a138" doxytag="udfprocs.h::UdfFastIoCheckIfPossible" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN UdfFastIoCheckIfPossible           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLARGE_INTEGER&nbsp;</td>
          <td class="mdname" nowrap> <em>FileOffset</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>Wait</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>LockKey</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>CheckForReadOperation</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PIO_STATUS_BLOCK&nbsp;</td>
          <td class="mdname" nowrap> <em>IoStatus</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00972">972</a> of file <a class="el" href="../../d1/d7/udfdata_8c-source.html">udfdata.c</a>.
<p>
References <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d3/d7/udfinit_8c-source.html#l00183">UdfInitializeGlobalData()</a>.
<p>
<pre class="fragment"><div>00985                    :
00986 
00987     This routine checks <span class="keywordflow">if</span> fast i/o <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> possible <span class="keywordflow">for</span> a read/write operation
00988 
00989 Arguments:
00990 
00991     FileObject - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object used in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> query
00992 
00993     FileOffset - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> starting byte offset <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> read/write operation
00994 
00995     Length - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length, in bytes, of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> read/write operation
00996 
00997     Wait - Indicates <span class="keywordflow">if</span> we can wait
00998 
00999     LockKey - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> lock key
01000 
01001     CheckForReadOperation - Indicates <span class="keywordflow">if</span> <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a check <span class="keywordflow">for</span> a read or write
01002         operation
01003 
01004     IoStatus - Receives <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> status of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation <span class="keywordflow">if</span> our <span class="keywordflow">return</span> value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
01005         FastIoReturnError
01006 
01007 Return Value:
01008 
01009     BOOLEAN - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> fast I/O <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> possible and <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller needs
01010         to take <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keywordtype">long</span> route.
01011 
01012 --*/
01013 
01014 {
01015     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01016 
01017     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01018 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a139" doxytag="udfprocs.h::UdfFastLock" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN UdfFastLock           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLARGE_INTEGER&nbsp;</td>
          <td class="mdname" nowrap> <em>FileOffset</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLARGE_INTEGER&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ProcessId</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Key</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>FailImmediately</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>ExclusiveLock</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PIO_STATUS_BLOCK&nbsp;</td>
          <td class="mdname" nowrap> <em>IoStatus</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d4/lockctrl_8c-source.html#l00152">152</a> of file <a class="el" href="../../d3/d4/lockctrl_8c-source.html">lockctrl.c</a>.
<p>
References <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00358">ASSERT_FILE_OBJECT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d8/fsrtl_8h.html#a188a87">FastIoIsPossible</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01772">FsRtlEnterFileSystem</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01795">FsRtlExitFileSystem</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00785">FsRtlFastLock</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l01116">FsRtlOplockIsFastIoPossible()</a>, <a class="el" href="../../d3/d9/nt6_2user32_8def-source.html#l00417">Key</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00436">try_leave</a>, <a class="el" href="../../d3/d8/udfprocs_8h.html#a109">TYPE_OF_OPEN</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l03713">UdfCreateFileLock()</a>, <a class="el" href="../../d7/d2/filobsup_8c-source.html#l00201">UdfFastDecodeFileObject()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00385">UdfIsFastIoPossible</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01567">UdfLockFcb</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01577">UdfUnlockFcb</a>, <a class="el" href="../../d9/d4/udfs_2verfysup_8c-source.html#l00760">UdfVerifyFcbOperation()</a>, and <a class="el" href="../../d3/d8/udfprocs_8h.html#a263a117">UserFileOpen</a>.
<p>
<pre class="fragment"><div>00166                    :
00167 
00168     This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a call back routine <span class="keywordflow">for</span> doing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> fast lock call.
00169 
00170 Arguments:
00171 
00172     FileObject - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object used in <span class="keyword">this</span> operation
00173 
00174     FileOffset - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> offset used in <span class="keyword">this</span> operation
00175 
00176     Length - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length used in <span class="keyword">this</span> operation
00177 
00178     ProcessId - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a> used in <span class="keyword">this</span> operation
00179 
00180     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key used in <span class="keyword">this</span> operation
00181 
00182     FailImmediately - Indicates <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> request should fail immediately
00183         <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> lock cannot be granted.
00184 
00185     ExclusiveLock - Indicates <span class="keywordflow">if</span> <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a request <span class="keywordflow">for</span> an exclusive or
00186         shared lock
00187 
00188     IoStatus - Receives <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> <span class="keywordflow">if</span> <span class="keyword">this</span> operation <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> successful
00189 
00190 Return Value:
00191 
00192     BOOLEAN - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <span class="keyword">this</span> operation completed and <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <span class="keywordflow">if</span> caller
00193         needs to take <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keywordtype">long</span> route.
00194 
00195 --*/
00196 
00197 {
00198     BOOLEAN Results = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00199 
00200     <a class="code" href="../../d7/d9/struct__FCB.html">PFCB</a> Fcb;
00201     <a class="code" href="../../d3/d8/udfprocs_8h.html#a109">TYPE_OF_OPEN</a> TypeOfOpen;
00202 
00203     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00204 
00205     <a class="code" href="../../d1/d8/udfdata_8h.html#a34">ASSERT_FILE_OBJECT</a>( FileObject );
00206 
00207     IoStatus-&gt;Information = 0;
00208 
00209     <span class="comment">//</span>
00210     <span class="comment">//  Decode the type of file object we're being asked to process and</span>
00211     <span class="comment">//  make sure that is is only a user file open.</span>
00212     <span class="comment">//</span>
00213 
00214     TypeOfOpen = <a class="code" href="../../d3/d8/udfprocs_8h.html#a175">UdfFastDecodeFileObject</a>( FileObject, &amp;Fcb );
00215 
00216     <span class="keywordflow">if</span> (TypeOfOpen != <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a117">UserFileOpen</a>) {
00217 
00218         IoStatus-&gt;Status = STATUS_INVALID_PARAMETER;
00219         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00220     }
00221 
00222     <span class="comment">//</span>
00223     <span class="comment">//  Only deal with 'good' Fcb's.</span>
00224     <span class="comment">//</span>
00225 
00226     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d5/udfs_2verfysup_8c.html#a6">UdfVerifyFcbOperation</a>( NULL, Fcb )) {
00227 
00228         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00229     }
00230 
00231     <a class="code" href="../../d1/d8/fsrtl_8h.html#a48">FsRtlEnterFileSystem</a>();
00232 
00233     <span class="comment">//</span>
00234     <span class="comment">//  Use a try-finally to facilitate cleanup.</span>
00235     <span class="comment">//</span>
00236 
00237     <span class="keywordflow">try</span> {
00238 
00239         <span class="comment">//</span>
00240         <span class="comment">//  We check whether we can proceed based on the state of the file oplocks.</span>
00241         <span class="comment">//</span>
00242 
00243         <span class="keywordflow">if</span> ((Fcb-&gt;Oplock != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; !<a class="code" href="../../d1/d8/fsrtl_8h.html#a166">FsRtlOplockIsFastIoPossible</a>( &amp;Fcb-&gt;Oplock )) {
00244 
00245             <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( NOTHING );
00246         }
00247 
00248         <span class="comment">//</span>
00249         <span class="comment">//  If we don't have a file lock, then get one now.</span>
00250         <span class="comment">//</span>
00251 
00252         <span class="keywordflow">if</span> ((Fcb-&gt;FileLock == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; !<a class="code" href="../../d3/d8/udfprocs_8h.html#a227">UdfCreateFileLock</a>( NULL, Fcb, FALSE )) {
00253 
00254             <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( NOTHING );
00255         }
00256 
00257         <span class="comment">//</span>
00258         <span class="comment">//  Now call the FsRtl routine to perform the lock request.</span>
00259         <span class="comment">//</span>
00260 
00261         <span class="keywordflow">if</span> (Results = <a class="code" href="../../d1/d8/fsrtl_8h.html#a18">FsRtlFastLock</a>( Fcb-&gt;FileLock,
00262                                      FileObject,
00263                                      FileOffset,
00264                                      Length,
00265                                      ProcessId,
00266                                      Key,
00267                                      FailImmediately,
00268                                      ExclusiveLock,
00269                                      IoStatus,
00270                                      NULL,
00271                                      FALSE )) {
00272 
00273             <span class="comment">//</span>
00274             <span class="comment">//  Set the flag indicating if Fast I/O is questionable.  We</span>
00275             <span class="comment">//  only change this flag if the current state is possible.</span>
00276             <span class="comment">//  Retest again after synchronizing on the header.</span>
00277             <span class="comment">//</span>
00278 
00279             <span class="keywordflow">if</span> (Fcb-&gt;IsFastIoPossible == <a class="code" href="../../d1/d8/fsrtl_8h.html#a188a87">FastIoIsPossible</a>) {
00280 
00281                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a90">UdfLockFcb</a>( NULL, Fcb );
00282                 Fcb-&gt;IsFastIoPossible = <a class="code" href="../../d3/d8/udfprocs_8h.html#a63">UdfIsFastIoPossible</a>( Fcb );
00283                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a91">UdfUnlockFcb</a>( NULL, Fcb );
00284             }
00285         }
00286 
00287     } finally {
00288 
00289         <a class="code" href="../../d1/d8/fsrtl_8h.html#a49">FsRtlExitFileSystem</a>();
00290     }
00291 
00292     <span class="keywordflow">return</span> Results;
00293 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a137" doxytag="udfprocs.h::UdfFastQueryBasicInfo" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN UdfFastQueryBasicInfo           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>Wait</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PFILE_BASIC_INFORMATION&nbsp;</td>
          <td class="mdname" nowrap> <em>Buffer</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PIO_STATUS_BLOCK&nbsp;</td>
          <td class="mdname" nowrap> <em>IoStatus</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d2/fileinfo_8c-source.html#l00496">496</a> of file <a class="el" href="../../d5/d2/fileinfo_8c-source.html">fileinfo.c</a>.
<p>
References <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00184">_TIMESTAMP_BUNDLE::AccessTime</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00358">ASSERT_FILE_OBJECT</a>, <a class="el" href="../../d7/d1/rtqkey_8c-source.html#l00042">Buffer</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00183">_TIMESTAMP_BUNDLE::CreationTime</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02474">ExAcquireResourceShared</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02393">ExReleaseResource</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01061">FCB_STATE_INITIALIZED</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00986">_FCB::FcbState</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00992">_FCB::FileAttributes</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01772">FsRtlEnterFileSystem</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01795">FsRtlExitFileSystem</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00185">_TIMESTAMP_BUNDLE::ModificationTime</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01044">_FCB::Timestamps</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d3/d8/udfprocs_8h.html#a109">TYPE_OF_OPEN</a>, <a class="el" href="../../d7/d2/filobsup_8c-source.html#l00133">UdfDecodeFileObject()</a>, <a class="el" href="../../d5/d2/fileinfo_8c-source.html#l00042">UdfGetExtraFileAttributes()</a>, <a class="el" href="../../d9/d4/udfs_2verfysup_8c-source.html#l00760">UdfVerifyFcbOperation()</a>, <a class="el" href="../../d3/d8/udfprocs_8h.html#a263a116">UserDirectoryOpen</a>, and <a class="el" href="../../d3/d8/udfprocs_8h.html#a263a117">UserFileOpen</a>.
<p>
<pre class="fragment"><div>00506                    :
00507 
00508     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> fast query call <span class="keywordflow">for</span> basic <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> information.
00509 
00510 Arguments:
00511 
00512     FileObject - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object used in <span class="keyword">this</span> operation
00513 
00514     Wait - Indicates <span class="keywordflow">if</span> we are allowed to wait <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> information
00515 
00516     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> output buffer to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> basic information
00517 
00518     IoStatus - Receives <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">final</span> status of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation
00519 
00520 Return Value:
00521 
00522     BOOLEAN - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation succeeded and <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller
00523         needs to take <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keywordtype">long</span> route.
00524 
00525 --*/
00526 
00527 {
00528     BOOLEAN Result = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00529     <a class="code" href="../../d3/d8/udfprocs_8h.html#a109">TYPE_OF_OPEN</a> TypeOfOpen;
00530 
00531     <a class="code" href="../../d7/d9/struct__FCB.html">PFCB</a> Fcb;
00532     <a class="code" href="../../d2/d9/struct__CCB.html">PCCB</a> Ccb;
00533 
00534     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00535 
00536     <a class="code" href="../../d1/d8/udfdata_8h.html#a34">ASSERT_FILE_OBJECT</a>( FileObject );
00537 
00538     <a class="code" href="../../d1/d8/fsrtl_8h.html#a48">FsRtlEnterFileSystem</a>();
00539 
00540     <span class="comment">//</span>
00541     <span class="comment">//  Decode the file object to find the type of open and the data</span>
00542     <span class="comment">//  structures.</span>
00543     <span class="comment">//</span>
00544 
00545     TypeOfOpen = <a class="code" href="../../d3/d8/udfprocs_8h.html#a174">UdfDecodeFileObject</a>( FileObject, &amp;Fcb, &amp;Ccb );
00546 
00547     <span class="comment">//</span>
00548     <span class="comment">//  We only support this request on user file or directory objects.</span>
00549     <span class="comment">//</span>
00550 
00551     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Fcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o10">FcbState</a>, FCB_STATE_INITIALIZED ));
00552     
00553     <span class="keywordflow">if</span> (TypeOfOpen != <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a117">UserFileOpen</a> &amp;&amp; TypeOfOpen != <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a116">UserDirectoryOpen</a>) {
00554 
00555         <a class="code" href="../../d1/d8/fsrtl_8h.html#a49">FsRtlExitFileSystem</a>();
00556         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00557     }
00558 
00559     <span class="comment">//</span>
00560     <span class="comment">//  Acquire the file shared to access the Fcb.</span>
00561     <span class="comment">//</span>
00562 
00563     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a>( Fcb-&gt;Resource, Wait )) {
00564 
00565         <a class="code" href="../../d1/d8/fsrtl_8h.html#a49">FsRtlExitFileSystem</a>();
00566         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00567     }
00568 
00569     <span class="comment">//</span>
00570     <span class="comment">//  Use a try-finally to facilitate cleanup.</span>
00571     <span class="comment">//</span>
00572 
00573     <span class="keywordflow">try</span> {
00574 
00575         <span class="comment">//</span>
00576         <span class="comment">//  Only deal with 'good' Fcb's.</span>
00577         <span class="comment">//</span>
00578 
00579         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/udfs_2verfysup_8c.html#a6">UdfVerifyFcbOperation</a>( NULL, Fcb )) {
00580 
00581             <span class="comment">//</span>
00582             <span class="comment">//  Fill in the input buffer from the Fcb fields.</span>
00583             <span class="comment">//</span>
00584 
00585             <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;CreationTime = Fcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o19">Timestamps</a>.<a class="code" href="../../d4/d1/struct__TIMESTAMP__BUNDLE.html#o0">CreationTime</a>;
00586             <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;LastWriteTime =
00587             <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;ChangeTime =  Fcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o19">Timestamps</a>.<a class="code" href="../../d4/d1/struct__TIMESTAMP__BUNDLE.html#o2">ModificationTime</a>;
00588             <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;LastAccessTime = Fcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o19">Timestamps</a>.<a class="code" href="../../d4/d1/struct__TIMESTAMP__BUNDLE.html#o1">AccessTime</a>;
00589 
00590             <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;FileAttributes = Fcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o11">FileAttributes</a> | <a class="code" href="../../d4/d3/fileinfo_8c.html#a2">UdfGetExtraFileAttributes</a>( Ccb );
00591 
00592             <span class="comment">//</span>
00593             <span class="comment">//  Update the IoStatus block with the size of this data.</span>
00594             <span class="comment">//</span>
00595 
00596             IoStatus-&gt;Status = STATUS_SUCCESS;
00597             IoStatus-&gt;Information = <span class="keyword">sizeof</span>( FILE_BASIC_INFORMATION );
00598 
00599             Result = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00600         }
00601 
00602     } finally {
00603 
00604         <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( Fcb-&gt;Resource );
00605 
00606         <a class="code" href="../../d1/d8/fsrtl_8h.html#a49">FsRtlExitFileSystem</a>();
00607     }
00608 
00609     <span class="keywordflow">return</span> Result;
00610 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a140" doxytag="udfprocs.h::UdfFastQueryNetworkInfo" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN UdfFastQueryNetworkInfo           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>Wait</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PFILE_NETWORK_OPEN_INFORMATION&nbsp;</td>
          <td class="mdname" nowrap> <em>Buffer</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PIO_STATUS_BLOCK&nbsp;</td>
          <td class="mdname" nowrap> <em>IoStatus</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d2/fileinfo_8c-source.html#l00740">740</a> of file <a class="el" href="../../d5/d2/fileinfo_8c-source.html">fileinfo.c</a>.
<p>
References <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00184">_TIMESTAMP_BUNDLE::AccessTime</a>, <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00358">ASSERT_FILE_OBJECT</a>, <a class="el" href="../../d7/d1/rtqkey_8c-source.html#l00042">Buffer</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00183">_TIMESTAMP_BUNDLE::CreationTime</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02474">ExAcquireResourceShared</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02393">ExReleaseResource</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00992">_FCB::FileAttributes</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01772">FsRtlEnterFileSystem</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01795">FsRtlExitFileSystem</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00185">_TIMESTAMP_BUNDLE::ModificationTime</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01044">_FCB::Timestamps</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d3/d8/udfprocs_8h.html#a109">TYPE_OF_OPEN</a>, <a class="el" href="../../d7/d2/filobsup_8c-source.html#l00133">UdfDecodeFileObject()</a>, <a class="el" href="../../d5/d2/fileinfo_8c-source.html#l00042">UdfGetExtraFileAttributes()</a>, <a class="el" href="../../d9/d4/udfs_2verfysup_8c-source.html#l00760">UdfVerifyFcbOperation()</a>, <a class="el" href="../../d3/d8/udfprocs_8h.html#a263a116">UserDirectoryOpen</a>, and <a class="el" href="../../d3/d8/udfprocs_8h.html#a263a117">UserFileOpen</a>.
<p>
<pre class="fragment"><div>00750                    :
00751 
00752     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> fast query call <span class="keywordflow">for</span> network <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> information.
00753 
00754 Arguments:
00755 
00756     FileObject - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object used in <span class="keyword">this</span> operation
00757 
00758     Wait - Indicates <span class="keywordflow">if</span> we are allowed to wait <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> information
00759 
00760     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> output buffer to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> basic information
00761 
00762     IoStatus - Receives <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">final</span> status of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation
00763 
00764 Return Value:
00765 
00766     BOOLEAN - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation succeeded and <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller
00767         needs to take <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keywordtype">long</span> route.
00768 
00769 --*/
00770 
00771 {
00772     BOOLEAN Result = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00773     <a class="code" href="../../d3/d8/udfprocs_8h.html#a109">TYPE_OF_OPEN</a> TypeOfOpen;
00774 
00775     <a class="code" href="../../d7/d9/struct__FCB.html">PFCB</a> Fcb;
00776     <a class="code" href="../../d2/d9/struct__CCB.html">PCCB</a> Ccb;
00777 
00778     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00779 
00780     <a class="code" href="../../d1/d8/udfdata_8h.html#a34">ASSERT_FILE_OBJECT</a>( FileObject );
00781 
00782     <a class="code" href="../../d1/d8/fsrtl_8h.html#a48">FsRtlEnterFileSystem</a>();
00783 
00784     <span class="comment">//</span>
00785     <span class="comment">//  Decode the file object to find the type of open and the data</span>
00786     <span class="comment">//  structures.</span>
00787     <span class="comment">//</span>
00788 
00789     TypeOfOpen = <a class="code" href="../../d3/d8/udfprocs_8h.html#a174">UdfDecodeFileObject</a>( FileObject, &amp;Fcb, &amp;Ccb );
00790 
00791     <span class="comment">//</span>
00792     <span class="comment">//  We only support this request on user file or directory objects.</span>
00793     <span class="comment">//</span>
00794 
00795     <span class="keywordflow">if</span> (TypeOfOpen != <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a117">UserFileOpen</a> &amp;&amp; TypeOfOpen != <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a116">UserDirectoryOpen</a>) {
00796 
00797         <a class="code" href="../../d1/d8/fsrtl_8h.html#a49">FsRtlExitFileSystem</a>();
00798         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00799     }
00800 
00801     <span class="comment">//</span>
00802     <span class="comment">//  Acquire the file shared to access the Fcb.</span>
00803     <span class="comment">//</span>
00804 
00805     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a>( Fcb-&gt;Resource, Wait )) {
00806 
00807         <a class="code" href="../../d1/d8/fsrtl_8h.html#a49">FsRtlExitFileSystem</a>();
00808         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00809     }
00810 
00811     <span class="comment">//</span>
00812     <span class="comment">//  Use a try-finally to facilitate cleanup.</span>
00813     <span class="comment">//</span>
00814 
00815     <span class="keywordflow">try</span> {
00816 
00817         <span class="comment">//</span>
00818         <span class="comment">//  Only deal with 'good' Fcb's.</span>
00819         <span class="comment">//</span>
00820 
00821         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/udfs_2verfysup_8c.html#a6">UdfVerifyFcbOperation</a>( NULL, Fcb )) {
00822 
00823             <span class="comment">//</span>
00824             <span class="comment">//  Fill in the input buffer from the Fcb fields.</span>
00825             <span class="comment">//</span>
00826 
00827             <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;CreationTime = Fcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o19">Timestamps</a>.<a class="code" href="../../d4/d1/struct__TIMESTAMP__BUNDLE.html#o0">CreationTime</a>;
00828             <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;LastWriteTime =
00829             <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;ChangeTime =  Fcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o19">Timestamps</a>.<a class="code" href="../../d4/d1/struct__TIMESTAMP__BUNDLE.html#o2">ModificationTime</a>;
00830             <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;LastAccessTime = Fcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o19">Timestamps</a>.<a class="code" href="../../d4/d1/struct__TIMESTAMP__BUNDLE.html#o1">AccessTime</a>;
00831 
00832             <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;FileAttributes = Fcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o11">FileAttributes</a> | <a class="code" href="../../d4/d3/fileinfo_8c.html#a2">UdfGetExtraFileAttributes</a>( Ccb );
00833 
00834             <span class="comment">//</span>
00835             <span class="comment">//  Check whether this is a directory.</span>
00836             <span class="comment">//</span>
00837 
00838             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Fcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o11">FileAttributes</a>, FILE_ATTRIBUTE_DIRECTORY )) {
00839 
00840                 <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;AllocationSize.QuadPart =
00841                 <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;EndOfFile.QuadPart = 0;
00842 
00843             } <span class="keywordflow">else</span> {
00844 
00845                 <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;AllocationSize.QuadPart = Fcb-&gt;AllocationSize.QuadPart;
00846                 <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;EndOfFile.QuadPart = Fcb-&gt;FileSize.QuadPart;
00847             }
00848 
00849             <span class="comment">//</span>
00850             <span class="comment">//  Update the IoStatus block with the size of this data.</span>
00851             <span class="comment">//</span>
00852 
00853             IoStatus-&gt;Status = STATUS_SUCCESS;
00854             IoStatus-&gt;Information = <span class="keyword">sizeof</span>( FILE_NETWORK_OPEN_INFORMATION );
00855 
00856             Result = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00857         }
00858 
00859     } finally {
00860 
00861         <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( Fcb-&gt;Resource );
00862 
00863         <a class="code" href="../../d1/d8/fsrtl_8h.html#a49">FsRtlExitFileSystem</a>();
00864     }
00865 
00866     <span class="keywordflow">return</span> Result;
00867 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a141" doxytag="udfprocs.h::UdfFastQueryStdInfo" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN UdfFastQueryStdInfo           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>Wait</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PFILE_STANDARD_INFORMATION&nbsp;</td>
          <td class="mdname" nowrap> <em>Buffer</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PIO_STATUS_BLOCK&nbsp;</td>
          <td class="mdname" nowrap> <em>IoStatus</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d2/fileinfo_8c-source.html#l00614">614</a> of file <a class="el" href="../../d5/d2/fileinfo_8c-source.html">fileinfo.c</a>.
<p>
References <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00358">ASSERT_FILE_OBJECT</a>, <a class="el" href="../../d7/d1/rtqkey_8c-source.html#l00042">Buffer</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02474">ExAcquireResourceShared</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02393">ExReleaseResource</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00992">_FCB::FileAttributes</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01772">FsRtlEnterFileSystem</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01795">FsRtlExitFileSystem</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01050">_FCB::LinkCount</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d3/d8/udfprocs_8h.html#a109">TYPE_OF_OPEN</a>, <a class="el" href="../../d7/d2/filobsup_8c-source.html#l00201">UdfFastDecodeFileObject()</a>, <a class="el" href="../../d9/d4/udfs_2verfysup_8c-source.html#l00760">UdfVerifyFcbOperation()</a>, <a class="el" href="../../d3/d8/udfprocs_8h.html#a263a116">UserDirectoryOpen</a>, and <a class="el" href="../../d3/d8/udfprocs_8h.html#a263a117">UserFileOpen</a>.
<p>
<pre class="fragment"><div>00624                    :
00625 
00626     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> fast query call <span class="keywordflow">for</span> standard <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> information.
00627 
00628 Arguments:
00629 
00630     FileObject - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object used in <span class="keyword">this</span> operation
00631 
00632     Wait - Indicates <span class="keywordflow">if</span> we are allowed to wait <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> information
00633 
00634     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> output buffer to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> basic information
00635 
00636     IoStatus - Receives <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">final</span> status of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation
00637 
00638 Return Value:
00639 
00640     BOOLEAN - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation succeeded and <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller
00641         needs to take <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keywordtype">long</span> route.
00642 
00643 --*/
00644 
00645 {
00646     BOOLEAN Result = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00647     <a class="code" href="../../d3/d8/udfprocs_8h.html#a109">TYPE_OF_OPEN</a> TypeOfOpen;
00648 
00649     <a class="code" href="../../d7/d9/struct__FCB.html">PFCB</a> Fcb;
00650 
00651     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00652 
00653     <a class="code" href="../../d1/d8/udfdata_8h.html#a34">ASSERT_FILE_OBJECT</a>( FileObject );
00654 
00655     <a class="code" href="../../d1/d8/fsrtl_8h.html#a48">FsRtlEnterFileSystem</a>();
00656 
00657     <span class="comment">//</span>
00658     <span class="comment">//  Decode the file object to find the type of open and the data</span>
00659     <span class="comment">//  structures.</span>
00660     <span class="comment">//</span>
00661 
00662     TypeOfOpen = <a class="code" href="../../d3/d8/udfprocs_8h.html#a175">UdfFastDecodeFileObject</a>( FileObject, &amp;Fcb );
00663 
00664     <span class="comment">//</span>
00665     <span class="comment">//  We only support this request on initialized user file or directory objects.</span>
00666     <span class="comment">//</span>
00667 
00668     <span class="keywordflow">if</span> (TypeOfOpen != <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a117">UserFileOpen</a> &amp;&amp; TypeOfOpen != <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a116">UserDirectoryOpen</a>) {
00669 
00670         <a class="code" href="../../d1/d8/fsrtl_8h.html#a49">FsRtlExitFileSystem</a>();
00671         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00672     }
00673 
00674     <span class="comment">//</span>
00675     <span class="comment">//  Acquire the file shared to access the Fcb.</span>
00676     <span class="comment">//</span>
00677 
00678     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d8/ex_8h.html#a69">ExAcquireResourceShared</a>( Fcb-&gt;Resource, Wait )) {
00679 
00680         <a class="code" href="../../d1/d8/fsrtl_8h.html#a49">FsRtlExitFileSystem</a>();
00681         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00682     }
00683 
00684     <span class="comment">//</span>
00685     <span class="comment">//  Use a try-finally to facilitate cleanup.</span>
00686     <span class="comment">//</span>
00687 
00688     <span class="keywordflow">try</span> {
00689 
00690         <span class="comment">//</span>
00691         <span class="comment">//  Only deal with 'good' Fcb's.</span>
00692         <span class="comment">//</span>
00693 
00694         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d5/udfs_2verfysup_8c.html#a6">UdfVerifyFcbOperation</a>( NULL, Fcb )) {
00695 
00696             <span class="comment">//</span>
00697             <span class="comment">//  Check whether this is a directory.</span>
00698             <span class="comment">//</span>
00699 
00700             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Fcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o11">FileAttributes</a>, FILE_ATTRIBUTE_DIRECTORY )) {
00701 
00702                 <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;AllocationSize.QuadPart =
00703                 <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;EndOfFile.QuadPart = 0;
00704 
00705                 <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;Directory = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00706 
00707             } <span class="keywordflow">else</span> {
00708 
00709                 <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;AllocationSize.QuadPart = Fcb-&gt;AllocationSize.QuadPart;
00710                 <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;EndOfFile.QuadPart = Fcb-&gt;FileSize.QuadPart;
00711 
00712                 <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;Directory = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00713             }
00714 
00715             <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;NumberOfLinks = Fcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o20">LinkCount</a>;
00716             <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>-&gt;DeletePending = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00717 
00718             <span class="comment">//</span>
00719             <span class="comment">//  Update the IoStatus block with the size of this data.</span>
00720             <span class="comment">//</span>
00721 
00722             IoStatus-&gt;Status = STATUS_SUCCESS;
00723             IoStatus-&gt;Information = <span class="keyword">sizeof</span>( FILE_STANDARD_INFORMATION );
00724 
00725             Result = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00726         }
00727 
00728     } finally {
00729 
00730         <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( Fcb-&gt;Resource );
00731 
00732         <a class="code" href="../../d1/d8/fsrtl_8h.html#a49">FsRtlExitFileSystem</a>();
00733     }
00734 
00735     <span class="keywordflow">return</span> Result;
00736 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a143" doxytag="udfprocs.h::UdfFastUnlockAll" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN UdfFastUnlockAll           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ProcessId</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PIO_STATUS_BLOCK&nbsp;</td>
          <td class="mdname" nowrap> <em>IoStatus</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d4/lockctrl_8c-source.html#l00436">436</a> of file <a class="el" href="../../d3/d4/lockctrl_8c-source.html">lockctrl.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01772">FsRtlEnterFileSystem</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01795">FsRtlExitFileSystem</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l03770">FsRtlFastUnlockAll()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l01116">FsRtlOplockIsFastIoPossible()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00436">try_leave</a>, <a class="el" href="../../d3/d8/udfprocs_8h.html#a109">TYPE_OF_OPEN</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l03713">UdfCreateFileLock()</a>, <a class="el" href="../../d7/d2/filobsup_8c-source.html#l00201">UdfFastDecodeFileObject()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00385">UdfIsFastIoPossible</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01567">UdfLockFcb</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01577">UdfUnlockFcb</a>, <a class="el" href="../../d9/d4/udfs_2verfysup_8c-source.html#l00760">UdfVerifyFcbOperation()</a>, and <a class="el" href="../../d3/d8/udfprocs_8h.html#a263a117">UserFileOpen</a>.
<p>
<pre class="fragment"><div>00445                    :
00446 
00447     This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a call back routine <span class="keywordflow">for</span> doing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> fast unlock all call.
00448 
00449 Arguments:
00450 
00451     FileObject - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object used in <span class="keyword">this</span> operation
00452 
00453     ProcessId - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a> used in <span class="keyword">this</span> operation
00454 
00455     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> - Receives <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> <span class="keywordflow">if</span> <span class="keyword">this</span> operation <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> successful
00456 
00457 Return Value:
00458 
00459     BOOLEAN - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <span class="keyword">this</span> operation completed and <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <span class="keywordflow">if</span> caller
00460         needs to take <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keywordtype">long</span> route.
00461 
00462 --*/
00463 
00464 {
00465     BOOLEAN Results = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00466     <a class="code" href="../../d3/d8/udfprocs_8h.html#a109">TYPE_OF_OPEN</a> TypeOfOpen;
00467     <a class="code" href="../../d7/d9/struct__FCB.html">PFCB</a> Fcb;
00468 
00469     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00470 
00471     IoStatus-&gt;Information = 0;
00472 
00473     <span class="comment">//</span>
00474     <span class="comment">//  Decode the type of file object we're being asked to process and</span>
00475     <span class="comment">//  make sure that is is only a user file open.</span>
00476     <span class="comment">//</span>
00477 
00478     TypeOfOpen = <a class="code" href="../../d3/d8/udfprocs_8h.html#a175">UdfFastDecodeFileObject</a>( FileObject, &amp;Fcb );
00479 
00480     <span class="keywordflow">if</span> (TypeOfOpen != <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a117">UserFileOpen</a>) {
00481 
00482         IoStatus-&gt;Status = STATUS_INVALID_PARAMETER;
00483         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00484     }
00485 
00486     <span class="comment">//</span>
00487     <span class="comment">//  Only deal with 'good' Fcb's.</span>
00488     <span class="comment">//</span>
00489 
00490     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d5/udfs_2verfysup_8c.html#a6">UdfVerifyFcbOperation</a>( NULL, Fcb )) {
00491 
00492         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00493     }
00494 
00495     <span class="comment">//</span>
00496     <span class="comment">//  If there is no lock then return immediately.</span>
00497     <span class="comment">//</span>
00498 
00499     <span class="keywordflow">if</span> (Fcb-&gt;FileLock == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00500 
00501         IoStatus-&gt;Status = STATUS_RANGE_NOT_LOCKED;
00502         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00503     }
00504 
00505     <a class="code" href="../../d1/d8/fsrtl_8h.html#a48">FsRtlEnterFileSystem</a>();
00506 
00507     <span class="keywordflow">try</span> {
00508 
00509         <span class="comment">//</span>
00510         <span class="comment">//  We check whether we can proceed based on the state of the file oplocks.</span>
00511         <span class="comment">//</span>
00512 
00513         <span class="keywordflow">if</span> ((Fcb-&gt;Oplock != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; !<a class="code" href="../../d1/d8/fsrtl_8h.html#a166">FsRtlOplockIsFastIoPossible</a>( &amp;Fcb-&gt;Oplock )) {
00514 
00515             <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( NOTHING );
00516         }
00517 
00518         <span class="comment">//</span>
00519         <span class="comment">//  If we don't have a file lock, then get one now.</span>
00520         <span class="comment">//</span>
00521 
00522         <span class="keywordflow">if</span> ((Fcb-&gt;FileLock == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; !<a class="code" href="../../d3/d8/udfprocs_8h.html#a227">UdfCreateFileLock</a>( NULL, Fcb, FALSE )) {
00523 
00524             <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( NOTHING );
00525         }
00526 
00527         <span class="comment">//</span>
00528         <span class="comment">//  Now call the FsRtl routine to do the actual processing of the</span>
00529         <span class="comment">//  Lock request.  The call will always succeed.</span>
00530         <span class="comment">//</span>
00531 
00532         Results = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00533         IoStatus-&gt;Status = <a class="code" href="../../d1/d8/fsrtl_8h.html#a123">FsRtlFastUnlockAll</a>( Fcb-&gt;FileLock,
00534                                                FileObject,
00535                                                ProcessId,
00536                                                NULL );
00537 
00538 
00539         <span class="comment">//</span>
00540         <span class="comment">//  Set the flag indicating if Fast I/O is possible</span>
00541         <span class="comment">//</span>
00542 
00543         <a class="code" href="../../d3/d8/udfprocs_8h.html#a90">UdfLockFcb</a>( IrpContext, Fcb );
00544         Fcb-&gt;IsFastIoPossible = <a class="code" href="../../d3/d8/udfprocs_8h.html#a63">UdfIsFastIoPossible</a>( Fcb );
00545         <a class="code" href="../../d3/d8/udfprocs_8h.html#a91">UdfUnlockFcb</a>( IrpContext, Fcb );
00546 
00547     } finally {
00548 
00549         <a class="code" href="../../d1/d8/fsrtl_8h.html#a49">FsRtlExitFileSystem</a>();
00550     }
00551 
00552     <span class="keywordflow">return</span> Results;
00553 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a144" doxytag="udfprocs.h::UdfFastUnlockAllByKey" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN UdfFastUnlockAllByKey           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>ProcessId</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Key</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PIO_STATUS_BLOCK&nbsp;</td>
          <td class="mdname" nowrap> <em>IoStatus</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d4/lockctrl_8c-source.html#l00557">557</a> of file <a class="el" href="../../d3/d4/lockctrl_8c-source.html">lockctrl.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01772">FsRtlEnterFileSystem</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01795">FsRtlExitFileSystem</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l03814">FsRtlFastUnlockAllByKey()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l01116">FsRtlOplockIsFastIoPossible()</a>, <a class="el" href="../../d3/d9/nt6_2user32_8def-source.html#l00417">Key</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00436">try_leave</a>, <a class="el" href="../../d3/d8/udfprocs_8h.html#a109">TYPE_OF_OPEN</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l03713">UdfCreateFileLock()</a>, <a class="el" href="../../d7/d2/filobsup_8c-source.html#l00201">UdfFastDecodeFileObject()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00385">UdfIsFastIoPossible</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01567">UdfLockFcb</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01577">UdfUnlockFcb</a>, <a class="el" href="../../d9/d4/udfs_2verfysup_8c-source.html#l00760">UdfVerifyFcbOperation()</a>, and <a class="el" href="../../d3/d8/udfprocs_8h.html#a263a117">UserFileOpen</a>.
<p>
<pre class="fragment"><div>00567                    :
00568 
00569     This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a call back routine <span class="keywordflow">for</span> doing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> fast unlock all by key call.
00570 
00571 Arguments:
00572 
00573     FileObject - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object used in <span class="keyword">this</span> operation
00574 
00575     ProcessId - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a> used in <span class="keyword">this</span> operation
00576 
00577     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key used in <span class="keyword">this</span> operation
00578 
00579     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> - Receives <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> <span class="keywordflow">if</span> <span class="keyword">this</span> operation <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> successful
00580 
00581 Return Value:
00582 
00583     BOOLEAN - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <span class="keyword">this</span> operation completed and <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <span class="keywordflow">if</span> caller
00584         needs to take <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keywordtype">long</span> route.
00585 
00586 --*/
00587 
00588 {
00589     BOOLEAN Results = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00590     <a class="code" href="../../d3/d8/udfprocs_8h.html#a109">TYPE_OF_OPEN</a> TypeOfOpen;
00591     <a class="code" href="../../d7/d9/struct__FCB.html">PFCB</a> Fcb;
00592 
00593     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00594 
00595     IoStatus-&gt;Information = 0;
00596 
00597     <span class="comment">//</span>
00598     <span class="comment">//  Decode the type of file object we're being asked to process and</span>
00599     <span class="comment">//  make sure that is is only a user file open.</span>
00600     <span class="comment">//</span>
00601 
00602     TypeOfOpen = <a class="code" href="../../d3/d8/udfprocs_8h.html#a175">UdfFastDecodeFileObject</a>( FileObject, &amp;Fcb );
00603 
00604     <span class="keywordflow">if</span> (TypeOfOpen != <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a117">UserFileOpen</a>) {
00605 
00606         IoStatus-&gt;Status = STATUS_INVALID_PARAMETER;
00607         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00608     }
00609 
00610     <span class="comment">//</span>
00611     <span class="comment">//  Only deal with 'good' Fcb's.</span>
00612     <span class="comment">//</span>
00613 
00614     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d5/udfs_2verfysup_8c.html#a6">UdfVerifyFcbOperation</a>( NULL, Fcb )) {
00615 
00616         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00617     }
00618 
00619     <span class="comment">//</span>
00620     <span class="comment">//  If there is no lock then return immediately.</span>
00621     <span class="comment">//</span>
00622 
00623     <span class="keywordflow">if</span> (Fcb-&gt;FileLock == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00624 
00625         IoStatus-&gt;Status = STATUS_RANGE_NOT_LOCKED;
00626         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00627     }
00628 
00629     <a class="code" href="../../d1/d8/fsrtl_8h.html#a48">FsRtlEnterFileSystem</a>();
00630 
00631     <span class="keywordflow">try</span> {
00632 
00633         <span class="comment">//</span>
00634         <span class="comment">//  We check whether we can proceed based on the state of the file oplocks.</span>
00635         <span class="comment">//</span>
00636 
00637         <span class="keywordflow">if</span> ((Fcb-&gt;Oplock != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; !<a class="code" href="../../d1/d8/fsrtl_8h.html#a166">FsRtlOplockIsFastIoPossible</a>( &amp;Fcb-&gt;Oplock )) {
00638 
00639             <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( NOTHING );
00640         }
00641 
00642         <span class="comment">//</span>
00643         <span class="comment">//  If we don't have a file lock, then get one now.</span>
00644         <span class="comment">//</span>
00645 
00646         <span class="keywordflow">if</span> ((Fcb-&gt;FileLock == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; !<a class="code" href="../../d3/d8/udfprocs_8h.html#a227">UdfCreateFileLock</a>( NULL, Fcb, FALSE )) {
00647 
00648             <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( NOTHING );
00649         }
00650 
00651         <span class="comment">//</span>
00652         <span class="comment">//  Now call the FsRtl routine to do the actual processing of the</span>
00653         <span class="comment">//  Lock request.  The call will always succeed.</span>
00654         <span class="comment">//</span>
00655 
00656         Results = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00657         IoStatus-&gt;Status = <a class="code" href="../../d1/d8/fsrtl_8h.html#a124">FsRtlFastUnlockAllByKey</a>( Fcb-&gt;FileLock,
00658                                                     FileObject,
00659                                                     ProcessId,
00660                                                     Key,
00661                                                     NULL );
00662 
00663 
00664         <span class="comment">//</span>
00665         <span class="comment">//  Set the flag indicating if Fast I/O is possible</span>
00666         <span class="comment">//</span>
00667 
00668         <a class="code" href="../../d3/d8/udfprocs_8h.html#a90">UdfLockFcb</a>( IrpContext, Fcb );
00669         Fcb-&gt;IsFastIoPossible = <a class="code" href="../../d3/d8/udfprocs_8h.html#a63">UdfIsFastIoPossible</a>( Fcb );
00670         <a class="code" href="../../d3/d8/udfprocs_8h.html#a91">UdfUnlockFcb</a>( IrpContext, Fcb );
00671 
00672     } finally {
00673 
00674         <a class="code" href="../../d1/d8/fsrtl_8h.html#a49">FsRtlExitFileSystem</a>();
00675     }
00676 
00677     <span class="keywordflow">return</span> Results;
00678 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a142" doxytag="udfprocs.h::UdfFastUnlockSingle" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN UdfFastUnlockSingle           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLARGE_INTEGER&nbsp;</td>
          <td class="mdname" nowrap> <em>FileOffset</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLARGE_INTEGER&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d0/d4/struct__EPROCESS.html">PEPROCESS</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ProcessId</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Key</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PIO_STATUS_BLOCK&nbsp;</td>
          <td class="mdname" nowrap> <em>IoStatus</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceObject</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d4/lockctrl_8c-source.html#l00297">297</a> of file <a class="el" href="../../d3/d4/lockctrl_8c-source.html">lockctrl.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d8/fsrtl_8h.html#a188a87">FastIoIsPossible</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00807">FsRtlAreThereCurrentFileLocks</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01772">FsRtlEnterFileSystem</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01795">FsRtlExitFileSystem</a>, <a class="el" href="../../d6/d2/filelock_8c-source.html#l03241">FsRtlFastUnlockSingle()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l01116">FsRtlOplockIsFastIoPossible()</a>, <a class="el" href="../../d3/d9/nt6_2user32_8def-source.html#l00417">Key</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00436">try_leave</a>, <a class="el" href="../../d3/d8/udfprocs_8h.html#a109">TYPE_OF_OPEN</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l03713">UdfCreateFileLock()</a>, <a class="el" href="../../d7/d2/filobsup_8c-source.html#l00201">UdfFastDecodeFileObject()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00385">UdfIsFastIoPossible</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01567">UdfLockFcb</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01577">UdfUnlockFcb</a>, <a class="el" href="../../d9/d4/udfs_2verfysup_8c-source.html#l00760">UdfVerifyFcbOperation()</a>, and <a class="el" href="../../d3/d8/udfprocs_8h.html#a263a117">UserFileOpen</a>.
<p>
<pre class="fragment"><div>00309                    :
00310 
00311     This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a call back routine <span class="keywordflow">for</span> doing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> fast unlock single call.
00312 
00313 Arguments:
00314 
00315     FileObject - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object used in <span class="keyword">this</span> operation
00316 
00317     FileOffset - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> offset used in <span class="keyword">this</span> operation
00318 
00319     Length - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> length used in <span class="keyword">this</span> operation
00320 
00321     ProcessId - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> process <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a> used in <span class="keyword">this</span> operation
00322 
00323     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key used in <span class="keyword">this</span> operation
00324 
00325     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> - Receives <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> <span class="keywordflow">if</span> <span class="keyword">this</span> operation <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> successful
00326 
00327 Return Value:
00328 
00329     BOOLEAN - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <span class="keyword">this</span> operation completed and <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> <span class="keywordflow">if</span> caller
00330         needs to take <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keywordtype">long</span> route.
00331 
00332 --*/
00333 
00334 {
00335     BOOLEAN Results = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00336     <a class="code" href="../../d3/d8/udfprocs_8h.html#a109">TYPE_OF_OPEN</a> TypeOfOpen;
00337     <a class="code" href="../../d7/d9/struct__FCB.html">PFCB</a> Fcb;
00338 
00339     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00340 
00341     IoStatus-&gt;Information = 0;
00342 
00343     <span class="comment">//</span>
00344     <span class="comment">//  Decode the type of file object we're being asked to process and</span>
00345     <span class="comment">//  make sure that is is only a user file open.</span>
00346     <span class="comment">//</span>
00347 
00348     TypeOfOpen = <a class="code" href="../../d3/d8/udfprocs_8h.html#a175">UdfFastDecodeFileObject</a>( FileObject, &amp;Fcb );
00349 
00350     <span class="keywordflow">if</span> (TypeOfOpen != <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a117">UserFileOpen</a>) {
00351 
00352         IoStatus-&gt;Status = STATUS_INVALID_PARAMETER;
00353         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00354     }
00355 
00356     <span class="comment">//</span>
00357     <span class="comment">//  Only deal with 'good' Fcb's.</span>
00358     <span class="comment">//</span>
00359 
00360     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d5/udfs_2verfysup_8c.html#a6">UdfVerifyFcbOperation</a>( NULL, Fcb )) {
00361 
00362         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00363     }
00364 
00365     <span class="comment">//</span>
00366     <span class="comment">//  If there is no lock then return immediately.</span>
00367     <span class="comment">//</span>
00368 
00369     <span class="keywordflow">if</span> (Fcb-&gt;FileLock == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00370 
00371         IoStatus-&gt;Status = STATUS_RANGE_NOT_LOCKED;
00372         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00373     }
00374 
00375     <a class="code" href="../../d1/d8/fsrtl_8h.html#a48">FsRtlEnterFileSystem</a>();
00376 
00377     <span class="keywordflow">try</span> {
00378 
00379         <span class="comment">//</span>
00380         <span class="comment">//  We check whether we can proceed based on the state of the file oplocks.</span>
00381         <span class="comment">//</span>
00382 
00383         <span class="keywordflow">if</span> ((Fcb-&gt;Oplock != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; !<a class="code" href="../../d1/d8/fsrtl_8h.html#a166">FsRtlOplockIsFastIoPossible</a>( &amp;Fcb-&gt;Oplock )) {
00384 
00385             <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( NOTHING );
00386         }
00387 
00388         <span class="comment">//</span>
00389         <span class="comment">//  If we don't have a file lock, then get one now.</span>
00390         <span class="comment">//</span>
00391 
00392         <span class="keywordflow">if</span> ((Fcb-&gt;FileLock == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; !<a class="code" href="../../d3/d8/udfprocs_8h.html#a227">UdfCreateFileLock</a>( NULL, Fcb, FALSE )) {
00393 
00394             <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( NOTHING );
00395         }
00396 
00397         <span class="comment">//</span>
00398         <span class="comment">//  Now call the FsRtl routine to do the actual processing of the</span>
00399         <span class="comment">//  Lock request.  The call will always succeed.</span>
00400         <span class="comment">//</span>
00401 
00402         Results = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00403         IoStatus-&gt;Status = <a class="code" href="../../d1/d8/fsrtl_8h.html#a122">FsRtlFastUnlockSingle</a>( Fcb-&gt;FileLock,
00404                                                   FileObject,
00405                                                   FileOffset,
00406                                                   Length,
00407                                                   ProcessId,
00408                                                   Key,
00409                                                   NULL,
00410                                                   FALSE );
00411 
00412         <span class="comment">//</span>
00413         <span class="comment">//  Set the flag indicating if Fast I/O is possible.  We are</span>
00414         <span class="comment">//  only concerned if there are no longer any filelocks on this</span>
00415         <span class="comment">//  file.</span>
00416         <span class="comment">//</span>
00417 
00418         <span class="keywordflow">if</span> (!<a class="code" href="../../d1/d8/fsrtl_8h.html#a19">FsRtlAreThereCurrentFileLocks</a>( Fcb-&gt;FileLock ) &amp;&amp;
00419             (Fcb-&gt;IsFastIoPossible != <a class="code" href="../../d1/d8/fsrtl_8h.html#a188a87">FastIoIsPossible</a>)) {
00420 
00421             <a class="code" href="../../d3/d8/udfprocs_8h.html#a90">UdfLockFcb</a>( IrpContext, Fcb );
00422             Fcb-&gt;IsFastIoPossible = <a class="code" href="../../d3/d8/udfprocs_8h.html#a63">UdfIsFastIoPossible</a>( Fcb );
00423             <a class="code" href="../../d3/d8/udfprocs_8h.html#a91">UdfUnlockFcb</a>( IrpContext, Fcb );
00424         }
00425 
00426     } finally {
00427 
00428         <a class="code" href="../../d1/d8/fsrtl_8h.html#a49">FsRtlExitFileSystem</a>();
00429     }
00430 
00431     <span class="keywordflow">return</span> Results;
00432 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a172" doxytag="udfprocs.h::UdfFindDirEntry" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN UdfFindDirEntry           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d7/d9/struct__FCB.html">PFCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Fcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>Name</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>IgnoreCase</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>ShortName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d5/d5/struct__DIR__ENUM__CONTEXT.html">PDIR_ENUM_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DirContext</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d7/dirsup_8c-source.html#l00726">726</a> of file <a class="el" href="../../d5/d7/dirsup_8c-source.html">dirsup.c</a>.
<p>
References <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00342">ASSERT_FCB_INDEX</a>, <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00352">ASSERT_IRP_CONTEXT</a>, <a class="el" href="../../d0/d7/udf_8h-source.html#l00205">BYTE_COUNT_8_DOT_3</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01699">DIR_CONTEXT_FLAG_SEEN_NONCONSTANT</a>, <a class="el" href="../../d1/d8/fsrtl_8h.html#a189a90">EqualTo</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01101">FsRtlAllocatePoolWithTag</a>, <a class="el" href="../../d9/d9/geninst_8c-source.html#l00154">Name</a>, <a class="el" href="../../d1/d6/iso13346_8h-source.html#l00812">NSR_FID_F_DELETED</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d6/udfs_2nodetype_8h-source.html#l00173">TAG_SHORT_FILE_NAME</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d6/d4/namesup_8c-source.html#l01274">UdfFullCompareNames()</a>, <a class="el" href="../../d6/d4/namesup_8c-source.html#l00389">UdfGenerate8dot3Name()</a>, <a class="el" href="../../d6/d4/namesup_8c-source.html#l00176">UdfIs8dot3Name()</a>, <a class="el" href="../../d5/d7/dirsup_8c-source.html#l00165">UdfLookupInitialDirEntry()</a>, <a class="el" href="../../d5/d7/dirsup_8c-source.html#l00287">UdfLookupNextDirEntry()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00443">UdfPagedPool</a>, and <a class="el" href="../../d5/d7/dirsup_8c-source.html#l00360">UdfUpdateDirNames()</a>.
<p>
Referenced by <a class="el" href="../../d4/d7/udfs_2create_8c-source.html#l00108">UdfCommonCreate()</a>, and <a class="el" href="../../d5/d2/fileinfo_8c-source.html#l01232">UdfQueryAlternateNameInfo()</a>.
<p>
<pre class="fragment"><div>00737                    :
00738 
00739     This routine walks <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> directory specified <span class="keywordflow">for</span> an entry which matches <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> input
00740     criteria.
00741 
00742 Arguments:
00743 
00744     Fcb - <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> directory to search
00745     
00746     <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a> - name to search <span class="keywordflow">for</span>
00747     
00748     IgnoreCase - whether <span class="keyword">this</span> search should be <span class="keywordflow">case</span>-insensitive (Name will already
00749         be upcased)
00750         
00751     ShortName - whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name should be searched <span class="keywordflow">for</span> according to <span class="keywordtype">short</span> name rules
00752     
00753     DirContext - context structure to use and <span class="keywordflow">return</span> results in
00754 
00755 Return Value:
00756 
00757     BOOLEAN True <span class="keywordflow">if</span> a <a class="code" href="../../d7/d1/genuedef_8c.html#a7">matching</a> directory entry <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being returned, False otherwise.
00758 
00759 --*/
00760 
00761 {
00762     PUNICODE_STRING MatchName;
00763 
00764     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00765 
00766     <span class="comment">//</span>
00767     <span class="comment">//  Check inputs.</span>
00768     <span class="comment">//</span>
00769 
00770     <a class="code" href="../../d1/d8/udfdata_8h.html#a28">ASSERT_IRP_CONTEXT</a>( IrpContext );
00771     <a class="code" href="../../d1/d8/udfdata_8h.html#a18">ASSERT_FCB_INDEX</a>( Fcb );
00772 
00773     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( +1, Dbg,
00774                  <span class="stringliteral">"UdfFindDirEntry, Fcb=%08x Name=\"%wZ\" Ignore=%u Short=%u, DC=%08x\n"</span>,
00775                  Fcb,
00776                  Name,
00777                  IgnoreCase,
00778                  ShortName,
00779                  DirContext ));
00780 
00781     <span class="comment">//</span>
00782     <span class="comment">//  Depending on the kind of search we are performing a different flavor of the found name</span>
00783     <span class="comment">//  wil be used in the comparison.</span>
00784     <span class="comment">//</span>
00785     
00786     <span class="keywordflow">if</span> (ShortName) {
00787 
00788         MatchName = &amp;DirContext-&gt;ShortObjectName;
00789     
00790     } <span class="keywordflow">else</span> {
00791 
00792         MatchName = &amp;DirContext-&gt;CaseObjectName;
00793     }
00794 
00795 
00796     <span class="comment">//</span>
00797     <span class="comment">//  Go get the first entry.</span>
00798     <span class="comment">//</span>
00799 
00800     <a class="code" href="../../d3/d8/udfprocs_8h.html#a169">UdfLookupInitialDirEntry</a>( IrpContext,
00801                               Fcb,
00802                               DirContext,
00803                               NULL );
00804 
00805     <span class="comment">//</span>
00806     <span class="comment">//  Now loop looking for a good match.</span>
00807     <span class="comment">//</span>
00808     
00809     <span class="keywordflow">do</span> {
00810 
00811         <span class="comment">//</span>
00812         <span class="comment">//  If it is deleted, we obviously aren't interested in it.</span>
00813         <span class="comment">//</span>
00814         
00815         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( DirContext-&gt;Fid-&gt;Flags, NSR_FID_F_DELETED )) {
00816 
00817             <span class="keywordflow">continue</span>;
00818         }
00819 
00820         <a class="code" href="../../d3/d8/udfprocs_8h.html#a171">UdfUpdateDirNames</a>( IrpContext,
00821                            DirContext,
00822                            IgnoreCase );
00823             
00824         
00825         <span class="comment">//</span>
00826         <span class="comment">//  If this is a constant entry, just keep going.</span>
00827         <span class="comment">//</span>
00828         
00829         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( DirContext-&gt;Flags, DIR_CONTEXT_FLAG_SEEN_NONCONSTANT )) {
00830             
00831             <span class="keywordflow">continue</span>;
00832         }
00833 
00834         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( 0, Dbg,
00835                      <span class="stringliteral">"\"%wZ\" (pure \"%wZ\") @ +%08x\n"</span>,
00836                      &amp;DirContext-&gt;ObjectName,
00837                      &amp;DirContext-&gt;PureObjectName,
00838                      DirContext-&gt;ViewOffset ));
00839 
00840         <span class="comment">//</span>
00841         <span class="comment">//  If we are searching for generated shortnames, a small subset of the names</span>
00842         <span class="comment">//  in the directory are actually candidates for a match.  Go get the name.</span>
00843         <span class="comment">//</span>
00844         
00845         <span class="keywordflow">if</span> (ShortName) {
00846 
00847             <span class="comment">//</span>
00848             <span class="comment">//  Now, only if this Fid's name is non 8.3 is it neccesary to work with it.</span>
00849             <span class="comment">//</span>
00850             
00851             <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d8/udfprocs_8h.html#a178">UdfIs8dot3Name</a>( IrpContext, DirContext-&gt;ObjectName )) {
00852 
00853                 <span class="comment">//</span>
00854                 <span class="comment">//  Allocate the shortname if it isn't already done.</span>
00855                 <span class="comment">//</span>
00856                 
00857                 <span class="keywordflow">if</span> (DirContext-&gt;ShortObjectName.Buffer == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00858 
00859                     DirContext-&gt;ShortObjectName.Buffer = <a class="code" href="../../d1/d8/fsrtl_8h.html#a37">FsRtlAllocatePoolWithTag</a>( UdfPagedPool,
00860                                                                                    BYTE_COUNT_8_DOT_3,
00861                                                                                    TAG_SHORT_FILE_NAME );
00862                     DirContext-&gt;ShortObjectName.MaximumLength = <a class="code" href="../../d9/d7/udf_8h.html#a11">BYTE_COUNT_8_DOT_3</a>;
00863                 }
00864 
00865                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a180">UdfGenerate8dot3Name</a>( IrpContext,
00866                                       &amp;DirContext-&gt;PureObjectName,
00867                                       &amp;DirContext-&gt;ShortObjectName );
00868 
00869                 <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( 0, Dbg,
00870                              <span class="stringliteral">"built shortname \"%wZ\"\n"</span>, &amp;DirContext-&gt;ShortObjectName ));
00871 
00872             } <span class="keywordflow">else</span> {
00873 
00874                 <span class="comment">//</span>
00875                 <span class="comment">//  As an 8.3 name already, this name will not have caused us to have to generate</span>
00876                 <span class="comment">//  a short name, so it can't be the case that the caller is looking for it.</span>
00877                 <span class="comment">//</span>
00878                 
00879                 <span class="keywordflow">continue</span>;
00880             }
00881         }
00882 
00883         <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/udfprocs_8h.html#a185">UdfFullCompareNames</a>( IrpContext,
00884                                  MatchName,
00885                                  Name ) == <a class="code" href="../../d1/d8/fsrtl_8h.html#a189a90">EqualTo</a>) {
00886 
00887             <span class="comment">//</span>
00888             <span class="comment">//  Got a match, so give it up.</span>
00889             <span class="comment">//</span>
00890 
00891             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>((  0, Dbg, <span class="stringliteral">"HIT\n"</span> ));
00892             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( -1, Dbg, <span class="stringliteral">"UdfFindDirEntry -&gt; TRUE\n"</span> ));
00893 
00894             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00895         }
00896 
00897     } <span class="keywordflow">while</span> ( <a class="code" href="../../d3/d8/udfprocs_8h.html#a170">UdfLookupNextDirEntry</a>( IrpContext,
00898                                      Fcb,
00899                                      DirContext ));
00900 
00901     <span class="comment">//</span>
00902     <span class="comment">//  No match was found.</span>
00903     <span class="comment">//</span>
00904 
00905     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( -1, Dbg, <span class="stringliteral">"UdfFindDirEntry -&gt; FALSE\n"</span> ));
00906 
00907     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00908 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a218" doxytag="udfprocs.h::UdfFindInParseTable" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG UdfFindInParseTable           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d2/d8/struct__PARSE__KEYVALUE.html">PPARSE_KEYVALUE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ParseTable</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>Id</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>MaxIdLen</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l02552">2552</a> of file <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html">udfs/strucsup.c</a>.
<p>
References <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d5/d8/udfs__rec_8h.html#a17">PPARSE_KEYVALUE</a>.
<p>
Referenced by <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l03457">UdfRecognizeVolume()</a>.
<p>
<pre class="fragment"><div>02560                    :
02561 
02562     This routine walks a table of string key/value information <span class="keywordflow">for</span> a match of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
02563     input Id.  MaxIdLen can be set to get a prefix match.
02564 
02565 Arguments:
02566 
02567     Table - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> table being searched.
02568 
02569     Id - <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a> value.
02570 
02571     MaxIdLen - Maximum possible length of Id.
02572 
02573 Return Value:
02574 
02575     Value of <a class="code" href="../../d7/d1/genuedef_8c.html#a7">matching</a> entry, or <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> terminating (NULL) entry's value.
02576 
02577 --*/
02578 
02579 {
02580     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02581 
02582     <span class="keywordflow">while</span> (ParseTable-&gt;Key != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02583 
02584         <span class="keywordflow">if</span> (RtlEqualMemory(ParseTable-&gt;Key, Id, MaxIdLen)) {
02585 
02586             <span class="keywordflow">break</span>;
02587         }
02588 
02589         ParseTable++;
02590     }
02591 
02592     <span class="keywordflow">return</span> ParseTable-&gt;Value;
02593 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a192" doxytag="udfprocs.h::UdfFindPrefix" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d5/d9/struct__LCB.html">PLCB</a> UdfFindPrefix           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT <a class="el" href="../../d7/d9/struct__FCB.html">PFCB</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>CurrentFcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>RemainingName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>IgnoreCase</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d3/prefxsup_8c-source.html#l00324">324</a> of file <a class="el" href="../../d6/d3/prefxsup_8c-source.html">prefxsup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00367">ASSERT_EXCLUSIVE_FCB</a>, <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00338">ASSERT_FCB</a>, <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00352">ASSERT_IRP_CONTEXT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01235">IRP_CONTEXT_FLAG_WAIT</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d6/udfs_2nodetype_8h-source.html#l00063">SafeNodeType</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01542">UdfAcquireFcbExclusive</a>, <a class="el" href="../../d6/d4/namesup_8c-source.html#l00096">UdfDissectName()</a>, <a class="el" href="../../d6/d3/prefxsup_8c-source.html#l00557">UdfFindNameLink()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01559">UdfLockVcb</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00406">UdfRaiseStatus()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01548">UdfReleaseFcb</a>, <a class="el" href="../../d2/d6/udfs_2nodetype_8h-source.html#l00037">UDFS_NTC_FCB_INDEX</a>, and <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01563">UdfUnlockVcb</a>.
<p>
Referenced by <a class="el" href="../../d4/d7/udfs_2create_8c-source.html#l00108">UdfCommonCreate()</a>.
<p>
<pre class="fragment"><div>00333                    :
00334 
00335     This routine begins from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> given CurrentFcb and walks through all of
00336     components of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name looking <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> longest match in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> prefix
00337     splay trees.  The search <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> relative to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> starting Fcb so <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00338     full name may not begin with a <span class="charliteral">'\'</span>.  On <span class="keywordflow">return</span> <span class="keyword">this</span> routine will
00339     update Current Fcb with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> lowest point <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> has travelled in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00340     tree.  It will also hold <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> that resource on <span class="keywordflow">return</span> and <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> must
00341     hold that resource.
00342 
00343 Arguments:
00344 
00345     CurrentFcb - Address to store <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> lowest Fcb we find on <span class="keyword">this</span> search.
00346         On <span class="keywordflow">return</span> we will have acquired <span class="keyword">this</span> Fcb.  On entry <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00347         Fcb to examine.
00348         
00349     RemainingName - Supplies a buffer to store <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exact <span class="keywordflow">case</span> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name being
00350         searched <span class="keywordflow">for</span>.  Initially will contain <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d7/d6/nlsboot_8c.html#a0">upcase</a> name based on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00351         IgnoreCase flag.
00352 
00353     IgnoreCase - Indicates <span class="keywordflow">if</span> we are doing a <span class="keywordflow">case</span>-insensitive compare.
00354 
00355 Return Value:
00356 
00357     The Lcb used to find <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current Fcb, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> <span class="keywordflow">if</span> we didn'<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> find any prefix
00358     Fcbs.
00359 
00360 --*/
00361 
00362 {
00363     UNICODE_STRING LocalRemainingName;
00364     UNICODE_STRING FinalName;
00365 
00366     <a class="code" href="../../d5/d9/struct__LCB.html">PLCB</a> NameLink;
00367     <a class="code" href="../../d5/d9/struct__LCB.html">PLCB</a> CurrentLcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00368 
00369     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00370 
00371     <span class="comment">//</span>
00372     <span class="comment">//  Check inputs.</span>
00373     <span class="comment">//</span>
00374 
00375     <a class="code" href="../../d1/d8/udfdata_8h.html#a28">ASSERT_IRP_CONTEXT</a>( IrpContext );
00376     <a class="code" href="../../d1/d8/udfdata_8h.html#a14">ASSERT_FCB</a>( *CurrentFcb );
00377     <a class="code" href="../../d1/d8/udfdata_8h.html#a43">ASSERT_EXCLUSIVE_FCB</a>( *CurrentFcb );
00378 
00379     <span class="comment">//</span>
00380     <span class="comment">//  Make a local copy of the input strings.</span>
00381     <span class="comment">//</span>
00382 
00383     LocalRemainingName = *RemainingName;
00384 
00385     <span class="comment">//</span>
00386     <span class="comment">//  Loop until we find the longest matching prefix.</span>
00387     <span class="comment">//</span>
00388 
00389     <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00390 
00391         <span class="comment">//</span>
00392         <span class="comment">//  If there are no characters left or we are not at an IndexFcb then</span>
00393         <span class="comment">//  return immediately.</span>
00394         <span class="comment">//</span>
00395 
00396         <span class="keywordflow">if</span> ((LocalRemainingName.Length == 0) ||
00397             (<a class="code" href="../../d1/d7/udfs_2nodetype_8h.html#a12">SafeNodeType</a>( *CurrentFcb ) != <a class="code" href="../../d1/d7/udfs_2nodetype_8h.html#a3">UDFS_NTC_FCB_INDEX</a>)) {
00398 
00399             <span class="keywordflow">return</span> CurrentLcb;
00400         }
00401 
00402         <span class="comment">//</span>
00403         <span class="comment">//  Split off the next component from the name.</span>
00404         <span class="comment">//</span>
00405 
00406         <a class="code" href="../../d3/d8/udfprocs_8h.html#a177">UdfDissectName</a>( IrpContext,
00407                         &amp;LocalRemainingName,
00408                         &amp;FinalName );
00409 
00410         <span class="comment">//</span>
00411         <span class="comment">//  Check if this name is in the splay tree for this Scb.</span>
00412         <span class="comment">//</span>
00413 
00414         <span class="keywordflow">if</span> (IgnoreCase) {
00415 
00416             NameLink = <a class="code" href="../../d5/d4/prefxsup_8c.html#a2">UdfFindNameLink</a>( IrpContext,
00417                                         &amp;(*CurrentFcb)-&gt;IgnoreCaseRoot,
00418                                         &amp;FinalName );
00419 
00420         } <span class="keywordflow">else</span> {
00421 
00422             NameLink = <a class="code" href="../../d5/d4/prefxsup_8c.html#a2">UdfFindNameLink</a>( IrpContext,
00423                                         &amp;(*CurrentFcb)-&gt;ExactCaseRoot,
00424                                         &amp;FinalName );
00425         }
00426 
00427         <span class="comment">//</span>
00428         <span class="comment">//  If we didn't find a match then exit.</span>
00429         <span class="comment">//</span>
00430 
00431         <span class="keywordflow">if</span> (NameLink == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) { 
00432 
00433             <span class="keywordflow">break</span>;
00434         }
00435 
00436         CurrentLcb = NameLink;
00437 
00438         <span class="comment">//</span>
00439         <span class="comment">//  If this is a case-insensitive match then copy the exact case of the name into</span>
00440         <span class="comment">//  the input buffer.</span>
00441         <span class="comment">//</span>
00442 
00443         <span class="keywordflow">if</span> (IgnoreCase) {
00444 
00445             RtlCopyMemory( FinalName.Buffer,
00446                            NameLink-&gt;FileName.Buffer,
00447                            NameLink-&gt;FileName.Length );
00448         }
00449 
00450         <span class="comment">//</span>
00451         <span class="comment">//  Update the caller's remaining name string to reflect the fact that we found</span>
00452         <span class="comment">//  a match.</span>
00453         <span class="comment">//</span>
00454 
00455         *RemainingName = LocalRemainingName;
00456 
00457         <span class="comment">//</span>
00458         <span class="comment">//  Move down to the next component in the tree.  Acquire without waiting.</span>
00459         <span class="comment">//  If this fails then lock the Fcb to reference this Fcb and then drop</span>
00460         <span class="comment">//  the parent and acquire the child.</span>
00461         <span class="comment">//</span>
00462 
00463         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( NameLink-&gt;ParentFcb == *CurrentFcb );
00464 
00465         <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d8/udfprocs_8h.html#a83">UdfAcquireFcbExclusive</a>( IrpContext, NameLink-&gt;ChildFcb, TRUE )) {
00466 
00467             <span class="comment">//</span>
00468             <span class="comment">//  If we can't wait then raise CANT_WAIT.</span>
00469             <span class="comment">//</span>
00470 
00471             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpContext-&gt;Flags, IRP_CONTEXT_FLAG_WAIT )) {
00472 
00473                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a122">UdfRaiseStatus</a>( IrpContext, STATUS_CANT_WAIT );
00474             }
00475 
00476             <a class="code" href="../../d3/d8/udfprocs_8h.html#a88">UdfLockVcb</a>( IrpContext, IrpContext-&gt;Vcb );
00477             NameLink-&gt;ChildFcb-&gt;FcbReference += 1;
00478             NameLink-&gt;Reference += 1;
00479             <a class="code" href="../../d3/d8/udfprocs_8h.html#a89">UdfUnlockVcb</a>( IrpContext, IrpContext-&gt;Vcb );
00480 
00481             <a class="code" href="../../d3/d8/udfprocs_8h.html#a85">UdfReleaseFcb</a>( IrpContext, *CurrentFcb );
00482             <a class="code" href="../../d3/d8/udfprocs_8h.html#a83">UdfAcquireFcbExclusive</a>( IrpContext, NameLink-&gt;ChildFcb, FALSE );
00483 
00484             <a class="code" href="../../d3/d8/udfprocs_8h.html#a88">UdfLockVcb</a>( IrpContext, IrpContext-&gt;Vcb );
00485             NameLink-&gt;ChildFcb-&gt;FcbReference -= 1;
00486             NameLink-&gt;Reference -= 1;
00487             <a class="code" href="../../d3/d8/udfprocs_8h.html#a89">UdfUnlockVcb</a>( IrpContext, IrpContext-&gt;Vcb );
00488 
00489         } <span class="keywordflow">else</span> {
00490 
00491             <a class="code" href="../../d3/d8/udfprocs_8h.html#a85">UdfReleaseFcb</a>( IrpContext, *CurrentFcb );
00492         }
00493 
00494         *CurrentFcb = NameLink-&gt;ChildFcb;
00495     }
00496 
00497     <span class="keywordflow">return</span> CurrentLcb;
00498 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a124" doxytag="udfprocs.h::UdfFreePool" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> INLINE VOID UdfFreePool           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID *&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Pool</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00453">453</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.
<p>
References <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, and <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>.
<p>
Referenced by <a class="el" href="../../d5/d7/dirsup_8c-source.html#l00099">UdfCleanupDirContext()</a>, <a class="el" href="../../d3/d5/allocsup_8c-source.html#l00804">UdfCompletePcb()</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l02041">UdfCreateFcb()</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l02510">UdfDeleteCcb()</a>, <a class="el" href="../../d3/d5/allocsup_8c-source.html#l00309">UdfDeletePcb()</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l01210">UdfDeleteVcb()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l03817">UdfDetermineVolumeBounding()</a>, <a class="el" href="../../d9/d4/udfs_2verfysup_8c-source.html#l00365">UdfDismountVcb()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l02558">UdfFindFileSetDescriptor()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l02832">UdfFindVolumeDescriptors()</a>, <a class="el" href="../../d4/d6/deviosup_8c-source.html#l01280">UdfFinishBuffers()</a>, <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l01003">UdfInitializeEnumeration()</a>, <a class="el" href="../../d6/d3/prefxsup_8c-source.html#l00064">UdfInsertPrefix()</a>, <a class="el" href="../../d3/d5/allocsup_8c-source.html#l01406">UdfLoadSparingTables()</a>, <a class="el" href="../../d5/d7/dirsup_8c-source.html#l00916">UdfLookupDirEntryPostProcessing()</a>, <a class="el" href="../../d5/d7/dirsup_8c-source.html#l00287">UdfLookupNextDirEntry()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l01444">UdfMountVolume()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l03457">UdfRecognizeVolume()</a>, <a class="el" href="../../d5/d7/dirsup_8c-source.html#l00360">UdfUpdateDirNames()</a>, and <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l02043">UdfVerifyVolume()</a>.
<p>
<pre class="fragment"><div>00456 {
00457     <span class="keywordflow">if</span> (*Pool != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00458 
00459         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>(*Pool);
00460         *Pool = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00461     }
00462 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a126" doxytag="udfprocs.h::UdfFsdDispatch" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS UdfFsdDispatch           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d6/d7/struct__VOLUME__DEVICE__OBJECT.html">PVOLUME_DEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>VolumeDeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00218">218</a> of file <a class="el" href="../../d1/d7/udfdata_8c-source.html">udfdata.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00357">ASSERT_OPTIONAL_IRP</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00371">CanFsdWait</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01186">_IRP_CONTEXT::Flags</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01772">FsRtlEnterFileSystem</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01795">FsRtlExitFileSystem</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03252">IoGetCurrentIrpStackLocation</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l07409">IoGetTopLevelIrp()</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01234">IRP_CONTEXT_FLAG_MORE_PROCESSING</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00073">IRP_MJ_CLEANUP</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00057">IRP_MJ_CLOSE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00055">IRP_MJ_CREATE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00069">IRP_MJ_DEVICE_CONTROL</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00067">IRP_MJ_DIRECTORY_CONTROL</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00068">IRP_MJ_FILE_SYSTEM_CONTROL</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00072">IRP_MJ_LOCK_CONTROL</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00082">IRP_MJ_PNP</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00060">IRP_MJ_QUERY_INFORMATION</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00065">IRP_MJ_QUERY_VOLUME_INFORMATION</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00058">IRP_MJ_READ</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00061">IRP_MJ_SET_INFORMATION</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00141">IRP_MN_COMPLETE</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01215">_IRP_CONTEXT::MajorFunction</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01216">_IRP_CONTEXT::MinorFunction</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d2/d6/udfs_2nodetype_8h-source.html#l00063">SafeNodeType</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00505">SetFlag</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d6/d8/udfstruc_8h.html#a98">THREAD_CONTEXT</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00137">ThreadContext</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01209">_IRP_CONTEXT::TopLevel</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l01437">UdfCleanupIrpContext()</a>, <a class="el" href="../../d9/d6/udfs_2cleanup_8c-source.html#l00042">UdfCommonCleanup()</a>, <a class="el" href="../../d3/d8/close_8c-source.html#l00319">UdfCommonClose()</a>, <a class="el" href="../../d4/d7/udfs_2create_8c-source.html#l00108">UdfCommonCreate()</a>, <a class="el" href="../../d3/d6/udfs_2devctrl_8c-source.html#l00069">UdfCommonDevControl()</a>, <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l00255">UdfCommonDirControl()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l00283">UdfCommonFsControl()</a>, <a class="el" href="../../d3/d4/lockctrl_8c-source.html#l00046">UdfCommonLockControl()</a>, <a class="el" href="../../d5/d8/udfs_2pnp_8c-source.html#l00075">UdfCommonPnp()</a>, <a class="el" href="../../d5/d2/fileinfo_8c-source.html#l00156">UdfCommonQueryInfo()</a>, <a class="el" href="../../d8/d5/volinfo_8c-source.html#l00082">UdfCommonQueryVolInfo()</a>, <a class="el" href="../../d8/d4/udfs_2read_8c-source.html#l00068">UdfCommonRead()</a>, <a class="el" href="../../d5/d2/fileinfo_8c-source.html#l00385">UdfCommonSetInfo()</a>, <a class="el" href="../../d9/d1/udfs_2cachesup_8c-source.html#l00285">UdfCompleteMdl()</a>, <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00809">UdfCompleteRequest()</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l01301">UdfCreateIrpContext()</a>, <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00448">UdfExceptionFilter()</a>, <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00539">UdfProcessException()</a>, <a class="el" href="../../d2/d6/udfs_2nodetype_8h-source.html#l00041">UDFS_NTC_IRP_CONTEXT</a>, and <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00873">UdfSetThreadContext()</a>.
<p>
<pre class="fragment"><div>00225                    :
00226 
00227     This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver entry to all of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Fsd dispatch points.
00228 
00229     Conceptually <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Io routine will call <span class="keyword">this</span> routine on all requests
00230     to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> system.  We <span class="keywordflow">case</span> on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of request and invoke <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00231     correct handler <span class="keywordflow">for</span> <span class="keyword">this</span> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of request.  There <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> an exception filter
00232     to <span class="keywordflow">catch</span> any exceptions in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> UDFS code as well as <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> UDFS process
00233     exception routine.
00234 
00235     This routine allocates and initializes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> IrpContext <span class="keywordflow">for</span> <span class="keyword">this</span> request as
00236     well as updating <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> top-level thread context as necessary.  We may loop
00237     in <span class="keyword">this</span> routine <span class="keywordflow">if</span> we need to retry <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> request <span class="keywordflow">for</span> any <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a10">reason</a>.  The
00238     status code STATUS_CANT_WAIT <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to indicate <span class="keyword">this</span>.  Suppose <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> disk
00239     in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> drive has changed.  An Fsd request will proceed normally until <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>
00240     recognizes <span class="keyword">this</span> condition.  STATUS_VERIFY_REQUIRED <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> raised at that point
00241     and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exception code will handle <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> verify and either <span class="keywordflow">return</span>
00242     STATUS_CANT_WAIT or STATUS_PENDING depending on whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> request was
00243     posted.
00244 
00245 Arguments:
00246 
00247     VolumeDeviceObject - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> volume device object <span class="keywordflow">for</span> <span class="keyword">this</span> request
00248 
00249     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> being processed
00250 
00251 Return Value:
00252 
00253     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - The FSD status <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a>
00254 
00255 --*/
00256 
00257 {
00258     <a class="code" href="../../d0/d1/struct__THREAD__CONTEXT.html">THREAD_CONTEXT</a> <a class="code" href="../../d2/d1/cttoken_8c.html#a62">ThreadContext</a>;
00259     <a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00260     BOOLEAN Wait;
00261 
00262 <span class="preprocessor">#ifdef UDF_SANITY</span>
00263 <span class="preprocessor"></span>    PVOID PreviousTopLevel;
00264 <span class="preprocessor">#endif</span>
00265 <span class="preprocessor"></span>
00266     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00267 
00268     KIRQL SaveIrql = KeGetCurrentIrql();
00269 
00270     <a class="code" href="../../d1/d8/udfdata_8h.html#a33">ASSERT_OPTIONAL_IRP</a>( Irp );
00271 
00272     <a class="code" href="../../d1/d8/fsrtl_8h.html#a48">FsRtlEnterFileSystem</a>();
00273 
00274 <span class="preprocessor">#ifdef UDF_SANITY</span>
00275 <span class="preprocessor"></span>    PreviousTopLevel = <a class="code" href="../../d4/d6/iosubs_8c.html#a79">IoGetTopLevelIrp</a>();
00276 <span class="preprocessor">#endif</span>
00277 <span class="preprocessor"></span>
00278     <span class="comment">//</span>
00279     <span class="comment">//  Loop until this request has been completed or posted.</span>
00280     <span class="comment">//</span>
00281 
00282     <span class="keywordflow">do</span> {
00283 
00284         <span class="comment">//</span>
00285         <span class="comment">//  Use a try-except to handle the exception cases.</span>
00286         <span class="comment">//</span>
00287 
00288         <span class="keywordflow">try</span> {
00289 
00290             <span class="comment">//</span>
00291             <span class="comment">//  If the IrpContext is NULL then this is the first pass through</span>
00292             <span class="comment">//  this loop.</span>
00293             <span class="comment">//</span>
00294 
00295             <span class="keywordflow">if</span> (IrpContext == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00296 
00297                 <span class="comment">//</span>
00298                 <span class="comment">//  Decide if this request is waitable an allocate the IrpContext.</span>
00299                 <span class="comment">//  If the file object in the stack location is NULL then this</span>
00300                 <span class="comment">//  is a mount which is always waitable.  Otherwise we look at</span>
00301                 <span class="comment">//  the file object flags.</span>
00302                 <span class="comment">//</span>
00303 
00304                 <span class="keywordflow">if</span> (<a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>( Irp )-&gt;FileObject == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00305 
00306                     Wait = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00307 
00308                 } <span class="keywordflow">else</span> {
00309 
00310                     Wait = <a class="code" href="../../d3/d8/udfprocs_8h.html#a62">CanFsdWait</a>( Irp );
00311                 }
00312 
00313                 IrpContext = <a class="code" href="../../d3/d8/udfprocs_8h.html#a207">UdfCreateIrpContext</a>( Irp, Wait );
00314 
00315                 <span class="comment">//</span>
00316                 <span class="comment">//  Update the thread context information.</span>
00317                 <span class="comment">//</span>
00318 
00319                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a130">UdfSetThreadContext</a>( IrpContext, &amp;ThreadContext );
00320 
00321 <span class="preprocessor">#ifdef UDF_SANITY</span>
00322 <span class="preprocessor"></span>                <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( !UdfTestTopLevel ||
00323                         <a class="code" href="../../d1/d7/udfs_2nodetype_8h.html#a12">SafeNodeType</a>( IrpContext-&gt;<a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html#o9">TopLevel</a> ) == UDFS_NTC_IRP_CONTEXT );
00324 <span class="preprocessor">#endif</span>
00325 <span class="preprocessor"></span>
00326             <span class="comment">//</span>
00327             <span class="comment">//  Otherwise cleanup the IrpContext for the retry.</span>
00328             <span class="comment">//</span>
00329 
00330             } <span class="keywordflow">else</span> {
00331 
00332                 <span class="comment">//</span>
00333                 <span class="comment">//  Set the MORE_PROCESSING flag to make sure the IrpContext</span>
00334                 <span class="comment">//  isn't inadvertently deleted here.  Then cleanup the</span>
00335                 <span class="comment">//  IrpContext to perform the retry.</span>
00336                 <span class="comment">//</span>
00337 
00338                 <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( IrpContext-&gt;<a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html#o5">Flags</a>, IRP_CONTEXT_FLAG_MORE_PROCESSING );
00339                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a208">UdfCleanupIrpContext</a>( IrpContext, FALSE );
00340             }
00341 
00342             <span class="comment">//</span>
00343             <span class="comment">//  Case on the major irp code.</span>
00344             <span class="comment">//</span>
00345 
00346             <span class="keywordflow">switch</span> (IrpContext-&gt;<a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html#o10">MajorFunction</a>) {
00347 
00348                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a31">IRP_MJ_CLEANUP</a> :
00349                     
00350                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d8/udfprocs_8h.html#a251">UdfCommonCleanup</a>( IrpContext, Irp );
00351                     <span class="keywordflow">break</span>;
00352     
00353                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a15">IRP_MJ_CLOSE</a> :
00354 
00355                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d8/udfprocs_8h.html#a252">UdfCommonClose</a>( IrpContext, Irp );
00356                     <span class="keywordflow">break</span>;
00357 
00358                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a13">IRP_MJ_CREATE</a> :
00359                     
00360                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d8/udfprocs_8h.html#a253">UdfCommonCreate</a>( IrpContext, Irp );
00361                     <span class="keywordflow">break</span>;
00362     
00363                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a27">IRP_MJ_DEVICE_CONTROL</a> :
00364     
00365                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d8/udfprocs_8h.html#a254">UdfCommonDevControl</a>( IrpContext, Irp );
00366                     <span class="keywordflow">break</span>;
00367     
00368                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a25">IRP_MJ_DIRECTORY_CONTROL</a> :
00369 
00370                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d8/udfprocs_8h.html#a255">UdfCommonDirControl</a>( IrpContext, Irp );
00371                     <span class="keywordflow">break</span>;
00372 
00373                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a26">IRP_MJ_FILE_SYSTEM_CONTROL</a> :
00374     
00375                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d8/udfprocs_8h.html#a256">UdfCommonFsControl</a>( IrpContext, Irp );
00376                     <span class="keywordflow">break</span>;
00377 
00378                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a30">IRP_MJ_LOCK_CONTROL</a> :
00379 
00380                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d8/udfprocs_8h.html#a257">UdfCommonLockControl</a>( IrpContext, Irp );
00381                     <span class="keywordflow">break</span>;
00382 
00383                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a40">IRP_MJ_PNP</a> :
00384 
00385                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d8/udfprocs_8h.html#a258">UdfCommonPnp</a>( IrpContext, Irp );
00386                     <span class="keywordflow">break</span>;
00387 
00388                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a18">IRP_MJ_QUERY_INFORMATION</a> :
00389 
00390                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d8/udfprocs_8h.html#a259">UdfCommonQueryInfo</a>( IrpContext, Irp );
00391                     <span class="keywordflow">break</span>;
00392                 
00393                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a23">IRP_MJ_QUERY_VOLUME_INFORMATION</a> :
00394 
00395                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d6/volinfo_8c.html#a6">UdfCommonQueryVolInfo</a>( IrpContext, Irp );
00396                     <span class="keywordflow">break</span>;
00397                 
00398                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a16">IRP_MJ_READ</a> :
00399     
00400                     <span class="comment">//</span>
00401                     <span class="comment">//  If this is an Mdl complete request, don't go through</span>
00402                     <span class="comment">//  common read.</span>
00403                     <span class="comment">//</span>
00404     
00405                     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpContext-&gt;<a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html#o11">MinorFunction</a>, IRP_MN_COMPLETE )) {
00406     
00407                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d8/udfprocs_8h.html#a156">UdfCompleteMdl</a>( IrpContext, Irp );
00408     
00409                     } <span class="keywordflow">else</span> {
00410     
00411                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d8/udfprocs_8h.html#a261">UdfCommonRead</a>( IrpContext, Irp );
00412                     }
00413     
00414                     <span class="keywordflow">break</span>;
00415 
00416                 <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a19">IRP_MJ_SET_INFORMATION</a> :
00417 
00418                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d8/udfprocs_8h.html#a262">UdfCommonSetInfo</a>( IrpContext, Irp );
00419                     <span class="keywordflow">break</span>;
00420                 
00421                 <span class="keywordflow">default</span> :
00422                             
00423                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_DEVICE_REQUEST;
00424                     <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, Irp, Status );
00425             }
00426 
00427         } except( <a class="code" href="../../d3/d8/udfprocs_8h.html#a127">UdfExceptionFilter</a>( IrpContext, GetExceptionInformation() )) {
00428 
00429             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d8/udfprocs_8h.html#a128">UdfProcessException</a>( IrpContext, Irp, GetExceptionCode() );
00430         }
00431 
00432     } <span class="keywordflow">while</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_CANT_WAIT);
00433 
00434 <span class="preprocessor">#ifdef UDF_SANITY</span>
00435 <span class="preprocessor"></span>    <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( !UdfTestTopLevel ||
00436             (PreviousTopLevel == <a class="code" href="../../d4/d6/iosubs_8c.html#a79">IoGetTopLevelIrp</a>()) );
00437 <span class="preprocessor">#endif</span>
00438 <span class="preprocessor"></span>
00439     <a class="code" href="../../d1/d8/fsrtl_8h.html#a49">FsRtlExitFileSystem</a>();
00440 
00441     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( SaveIrql == KeGetCurrentIrql( ));
00442 
00443     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00444 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a245" doxytag="udfprocs.h::UdfFsdPostRequest" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS UdfFsdPostRequest           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d8/workque_8c-source.html#l00061">61</a> of file <a class="el" href="../../d3/d8/workque_8c-source.html">workque.c</a>.
<p>
References <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00356">ASSERT_IRP</a>, <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00352">ASSERT_IRP_CONTEXT</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d3/d8/workque_8c-source.html#l00316">UdfAddToWorkque()</a>, and <a class="el" href="../../d3/d8/workque_8c-source.html#l00111">UdfPrePostIrp()</a>.
<p>
Referenced by <a class="el" href="../../d8/d4/udfs_2read_8c-source.html#l00068">UdfCommonRead()</a>, <a class="el" href="../../d9/d4/udfs_2verfysup_8c-source.html#l00042">UdfPerformVerify()</a>, and <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00539">UdfProcessException()</a>.
<p>
<pre class="fragment"><div>00068                    :
00069 
00070     This routine enqueues <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> request packet specified by IrpContext to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00071     work queue associated with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> FileSystemDeviceObject.  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a FSD
00072     routine.
00073 
00074 Arguments:
00075 
00076     IrpContext - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> IrpContext to be queued to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Fsp.
00077 
00078     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> - I/O <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a24">Request</a> Packet.
00079 
00080 Return Value:
00081 
00082     STATUS_PENDING
00083 
00084 --*/
00085 
00086 {
00087     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00088 
00089     <a class="code" href="../../d1/d8/udfdata_8h.html#a28">ASSERT_IRP_CONTEXT</a>( IrpContext );
00090     <a class="code" href="../../d1/d8/udfdata_8h.html#a32">ASSERT_IRP</a>( Irp );
00091 
00092     <span class="comment">//</span>
00093     <span class="comment">//  Posting is a three step operation.  First lock down any buffers</span>
00094     <span class="comment">//  in the Irp.  Next cleanup the IrpContext for the post and finally</span>
00095     <span class="comment">//  add this to a workque.</span>
00096     <span class="comment">//</span>
00097 
00098     <a class="code" href="../../d2/d9/workque_8c.html#a5">UdfPrePostIrp</a>( IrpContext, Irp );
00099 
00100     <a class="code" href="../../d2/d9/workque_8c.html#a3">UdfAddToWorkque</a>( IrpContext, Irp );
00101 
00102     <span class="comment">//</span>
00103     <span class="comment">//  And return to our caller</span>
00104     <span class="comment">//</span>
00105 
00106     <span class="keywordflow">return</span> STATUS_PENDING;
00107 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a250" doxytag="udfprocs.h::UdfFspClose" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID UdfFspClose           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d5/struct__VCB.html">PVCB</a> Vcb&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>OPTIONAL</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d8/close_8c-source.html#l00099">99</a> of file <a class="el" href="../../d3/d8/close_8c-source.html">close.c</a>.
<p>
References <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00337">ASSERT_OPTIONAL_VCB</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00509">ClearFlag</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01180">_IRP_CONTEXT::ExceptionStatus</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00979">_FCB::FcbReference</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00980">_FCB::FcbUserReference</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01186">_IRP_CONTEXT::Flags</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01772">FsRtlEnterFileSystem</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01795">FsRtlExitFileSystem</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01164">_IRP_CONTEXT::Irp</a>, <a class="el" href="../../d6/d8/udfstruc_8h.html#a92">IRP_CONTEXT</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01237">IRP_CONTEXT_FLAG_TOP_LEVEL</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01238">IRP_CONTEXT_FLAG_TOP_LEVEL_UDFS</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01280">IRP_CONTEXT_FSP_FLAGS</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00267">_UDF_DATA::MinDelayedCloseCount</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d6/d8/udfstruc_8h.html#a95">PIRP_CONTEXT_LITE</a>, <a class="el" href="../../d2/d6/udfs_2nodetype_8h-source.html#l00063">SafeNodeType</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00505">SetFlag</a>, <a class="el" href="../../d6/d8/udfstruc_8h.html#a98">THREAD_CONTEXT</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00137">ThreadContext</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01509">UdfAcquireUdfData</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01518">UdfAcquireVcbShared</a>, <a class="el" href="../../d9/d4/udfs_2verfysup_8c-source.html#l00236">UdfCheckForDismount()</a>, <a class="el" href="../../d3/d8/close_8c-source.html#l00498">UdfCommonClosePrivate()</a>, <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00809">UdfCompleteRequest()</a>, <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00042">UdfData</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01687">UdfFreeIrpContextLite</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l01528">UdfInitializeStackIrpContext()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01512">UdfReleaseUdfData</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01521">UdfReleaseVcb</a>, <a class="el" href="../../d3/d8/close_8c-source.html#l00833">UdfRemoveClose()</a>, <a class="el" href="../../d2/d6/udfs_2nodetype_8h-source.html#l00041">UDFS_NTC_IRP_CONTEXT</a>, <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00873">UdfSetThreadContext()</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00941">_FCB::Vcb</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00611">_VCB::VcbCleanup</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00559">_VCB::VcbCondition</a>, <a class="el" href="../../d6/d8/udfstruc_8h.html#a130a119">VcbMounted</a>, <a class="el" href="../../d6/d8/udfstruc_8h.html#a130a118">VcbMountInProgress</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00612">_VCB::VcbReference</a>, and <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00613">_VCB::VcbUserReference</a>.
<p>
Referenced by <a class="el" href="../../d9/d4/udfs_2verfysup_8c-source.html#l00236">UdfCheckForDismount()</a>, <a class="el" href="../../d4/d7/udfs_2create_8c-source.html#l01955">UdfCompleteFcbOpen()</a>, <a class="el" href="../../d9/d4/udfs_2verfysup_8c-source.html#l00365">UdfDismountVcb()</a>, <a class="el" href="../../d3/d7/udfinit_8c-source.html#l00183">UdfInitializeGlobalData()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l00621">UdfLockVolumeInternal()</a>, and <a class="el" href="../../d9/d1/udfs_2cachesup_8c-source.html#l00417">UdfPurgeVolume()</a>.
<p>
<pre class="fragment"><div>00105                    :
00106 
00107     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called to process <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> close queues in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d8/udfdata_8c.html#a2">UdfData</a>.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00108     Vcb <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> passed then we want to remove all of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> closes <span class="keywordflow">for</span> <span class="keyword">this</span> Vcb.
00109     Otherwise we will <span class="keywordflow">do</span> as many of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> delayed closes as we need to <span class="keywordflow">do</span>.
00110 
00111 Arguments:
00112 
00113     Vcb - If specified then we are looking <span class="keywordflow">for</span> all of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> closes <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00114         given Vcb.
00115 
00116 Return Value:
00117 
00118     None
00119 
00120 --*/
00121 
00122 {
00123     <a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext;
00124     <a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html">IRP_CONTEXT</a> StackIrpContext;
00125 
00126     <a class="code" href="../../d0/d1/struct__THREAD__CONTEXT.html">THREAD_CONTEXT</a> <a class="code" href="../../d2/d1/cttoken_8c.html#a62">ThreadContext</a>;
00127 
00128     <a class="code" href="../../d7/d9/struct__FCB.html">PFCB</a> Fcb;
00129     ULONG UserReference;
00130 
00131     ULONG VcbHoldCount = 0;
00132     <a class="code" href="../../d7/d5/struct__VCB.html">PVCB</a> CurrentVcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00133 
00134     BOOLEAN ReleaseUdfData = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00135 
00136     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00137 
00138     <span class="comment">//</span>
00139     <span class="comment">//  Check input.</span>
00140     <span class="comment">//</span>
00141 
00142     <a class="code" href="../../d1/d8/udfdata_8h.html#a13">ASSERT_OPTIONAL_VCB</a>( Vcb );
00143 
00144     <a class="code" href="../../d1/d8/fsrtl_8h.html#a48">FsRtlEnterFileSystem</a>();
00145 
00146     <span class="comment">//</span>
00147     <span class="comment">//  Continue processing until there are no more closes to process.</span>
00148     <span class="comment">//</span>
00149 
00150     <span class="keywordflow">while</span> (IrpContext = <a class="code" href="../../d2/d9/close_8c.html#a4">UdfRemoveClose</a>( Vcb )) {
00151 
00152         <span class="comment">//</span>
00153         <span class="comment">//  If we don't have an IrpContext then use the one on the stack.</span>
00154         <span class="comment">//  Initialize it for this request.</span>
00155         <span class="comment">//</span>
00156 
00157         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d7/udfs_2nodetype_8h.html#a12">SafeNodeType</a>( IrpContext ) != <a class="code" href="../../d1/d7/udfs_2nodetype_8h.html#a7">UDFS_NTC_IRP_CONTEXT</a> ) {
00158 
00159             <span class="comment">//</span>
00160             <span class="comment">//  Update the local values from the IrpContextLite.</span>
00161             <span class="comment">//</span>
00162 
00163             Fcb = ((<a class="code" href="../../d2/d3/struct__IRP__CONTEXT__LITE.html">PIRP_CONTEXT_LITE</a>) IrpContext)-&gt;Fcb;
00164             UserReference = ((<a class="code" href="../../d2/d3/struct__IRP__CONTEXT__LITE.html">PIRP_CONTEXT_LITE</a>) IrpContext)-&gt;UserReference;
00165 
00166             <span class="comment">//</span>
00167             <span class="comment">//  Update the stack irp context with the values from the</span>
00168             <span class="comment">//  IrpContextLite.</span>
00169             <span class="comment">//</span>
00170 
00171             <a class="code" href="../../d3/d8/udfprocs_8h.html#a209">UdfInitializeStackIrpContext</a>( &amp;StackIrpContext,
00172                                           (<a class="code" href="../../d2/d3/struct__IRP__CONTEXT__LITE.html">PIRP_CONTEXT_LITE</a>) IrpContext );
00173 
00174             <span class="comment">//</span>
00175             <span class="comment">//  Free the IrpContextLite.</span>
00176             <span class="comment">//</span>
00177 
00178             <a class="code" href="../../d3/d8/udfprocs_8h.html#a93">UdfFreeIrpContextLite</a>( (<a class="code" href="../../d2/d3/struct__IRP__CONTEXT__LITE.html">PIRP_CONTEXT_LITE</a>) IrpContext );
00179 
00180             <span class="comment">//</span>
00181             <span class="comment">//  Remember we have the IrpContext from the stack.</span>
00182             <span class="comment">//</span>
00183 
00184             IrpContext = &amp;StackIrpContext;
00185 
00186         <span class="comment">//</span>
00187         <span class="comment">//  Otherwise cleanup the existing IrpContext.</span>
00188         <span class="comment">//</span>
00189 
00190         } <span class="keywordflow">else</span> {
00191 
00192             <span class="comment">//</span>
00193             <span class="comment">//  Remember the Fcb and user reference count.</span>
00194             <span class="comment">//</span>
00195 
00196             Fcb = (<a class="code" href="../../d7/d9/struct__FCB.html">PFCB</a>) IrpContext-&gt;<a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html#o2">Irp</a>;
00197             IrpContext-&gt;<a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html#o2">Irp</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00198 
00199             UserReference = (ULONG) IrpContext-&gt;<a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html#o4">ExceptionStatus</a>;
00200             IrpContext-&gt;<a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html#o4">ExceptionStatus</a> = STATUS_SUCCESS;
00201         }
00202 
00203         <span class="comment">//</span>
00204         <span class="comment">//  We have an IrpContext.  Now we need to set the top level thread</span>
00205         <span class="comment">//  context.</span>
00206         <span class="comment">//</span>
00207 
00208         <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( IrpContext-&gt;<a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html#o5">Flags</a>, IRP_CONTEXT_FSP_FLAGS );
00209 
00210         <span class="comment">//</span>
00211         <span class="comment">//  If we were given a Vcb then there is a request on top of this.</span>
00212         <span class="comment">//</span>
00213 
00214         <span class="keywordflow">if</span> (ARGUMENT_PRESENT( Vcb )) {
00215 
00216             <a class="code" href="../../d5/d5/cc_8h.html#a61">ClearFlag</a>( IrpContext-&gt;<a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html#o5">Flags</a>,
00217                        IRP_CONTEXT_FLAG_TOP_LEVEL | IRP_CONTEXT_FLAG_TOP_LEVEL_UDFS );
00218         }
00219 
00220         <a class="code" href="../../d3/d8/udfprocs_8h.html#a130">UdfSetThreadContext</a>( IrpContext, &amp;ThreadContext );
00221 
00222         <span class="comment">//</span>
00223         <span class="comment">//  If we have hit the maximum number of requests to process without</span>
00224         <span class="comment">//  releasing the Vcb then release the Vcb now.  If we are holding</span>
00225         <span class="comment">//  a different Vcb to this one then release the previous Vcb.</span>
00226         <span class="comment">//</span>
00227         <span class="comment">//  In either case acquire the current Vcb.</span>
00228         <span class="comment">//</span>
00229         <span class="comment">//  We use the MinDelayedCloseCount from the UdfData since it is</span>
00230         <span class="comment">//  a convenient value based on the system size.  Only thing we are trying</span>
00231         <span class="comment">//  to do here is prevent this routine starving other threads which</span>
00232         <span class="comment">//  may need this Vcb exclusively.</span>
00233         <span class="comment">//</span>
00234 
00235         ReleaseUdfData = !ARGUMENT_PRESENT( Vcb ) &amp;&amp;
00236                          (Fcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o2">Vcb</a>-&gt;<a class="code" href="../../d7/d5/struct__VCB.html#o8">VcbCondition</a> != <a class="code" href="../../d6/d8/udfstruc_8h.html#a130a119">VcbMounted</a>) &amp;&amp;
00237                          (Fcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o2">Vcb</a>-&gt;<a class="code" href="../../d7/d5/struct__VCB.html#o8">VcbCondition</a> != <a class="code" href="../../d6/d8/udfstruc_8h.html#a130a118">VcbMountInProgress</a>) &amp;&amp;
00238                          (Fcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o2">Vcb</a>-&gt;<a class="code" href="../../d7/d5/struct__VCB.html#o15">VcbCleanup</a> == 0);
00239 
00240         <span class="keywordflow">if</span> (ReleaseUdfData ||
00241             (VcbHoldCount &gt; <a class="code" href="../../d0/d8/udfdata_8c.html#a2">UdfData</a>.<a class="code" href="../../d2/d3/struct__UDF__DATA.html#o16">MinDelayedCloseCount</a>) ||
00242             (Fcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o2">Vcb</a> != CurrentVcb)) {
00243 
00244             <span class="keywordflow">if</span> (CurrentVcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00245 
00246                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a76">UdfReleaseVcb</a>( IrpContext, CurrentVcb );
00247             }
00248 
00249             <span class="keywordflow">if</span> (ReleaseUdfData) {
00250 
00251                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a72">UdfAcquireUdfData</a>( IrpContext );
00252             }
00253 
00254             CurrentVcb = Fcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o2">Vcb</a>;
00255             <a class="code" href="../../d3/d8/udfprocs_8h.html#a75">UdfAcquireVcbShared</a>( IrpContext, CurrentVcb, FALSE );
00256 
00257             VcbHoldCount = 0;
00258 
00259         } <span class="keywordflow">else</span> {
00260 
00261             VcbHoldCount += 1;
00262         }
00263 
00264         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( +1, Dbg,
00265                      <span class="stringliteral">"UdfFspClose, Fcb %08x %4s Vcb %d/%d Fcb %d/%d\n"</span>,
00266                      Fcb,
00267                      ( UserReference? <span class="stringliteral">"USER"</span> : <span class="stringliteral">"SYS"</span> ),
00268                      CurrentVcb-&gt;<a class="code" href="../../d7/d5/struct__VCB.html#o16">VcbReference</a>,
00269                      CurrentVcb-&gt;<a class="code" href="../../d7/d5/struct__VCB.html#o17">VcbUserReference</a>,
00270                      Fcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o8">FcbReference</a>,
00271                      Fcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o9">FcbUserReference</a> ));
00272 
00273         <span class="comment">//</span>
00274         <span class="comment">//  Call our worker routine to perform the close operation.</span>
00275         <span class="comment">//</span>
00276 
00277         <a class="code" href="../../d2/d9/close_8c.html#a2">UdfCommonClosePrivate</a>( IrpContext, CurrentVcb, Fcb, UserReference, FALSE );
00278 
00279         <span class="comment">//</span>
00280         <span class="comment">//  If the reference count on this Vcb is below our residual reference</span>
00281         <span class="comment">//  then check if we should dismount the volume.</span>
00282         <span class="comment">//</span>
00283 
00284         <span class="keywordflow">if</span> (ReleaseUdfData) {
00285 
00286             <a class="code" href="../../d3/d8/udfprocs_8h.html#a76">UdfReleaseVcb</a>( IrpContext, CurrentVcb );
00287             <a class="code" href="../../d8/d5/udfs_2verfysup_8c.html#a3">UdfCheckForDismount</a>( IrpContext, CurrentVcb, FALSE );
00288 
00289             CurrentVcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00290 
00291             <a class="code" href="../../d3/d8/udfprocs_8h.html#a73">UdfReleaseUdfData</a>( IrpContext );
00292             ReleaseUdfData = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00293         }
00294 
00295         <span class="comment">//</span>
00296         <span class="comment">//  Complete the current request to cleanup the IrpContext.</span>
00297         <span class="comment">//</span>
00298 
00299         <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, NULL, STATUS_SUCCESS );
00300 
00301         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( -1, Dbg, <span class="stringliteral">"UdfFspClose -&gt; VOID\n"</span> ));
00302     }
00303 
00304     <span class="comment">//</span>
00305     <span class="comment">//  Release any Vcb we may still hold.</span>
00306     <span class="comment">//</span>
00307 
00308     <span class="keywordflow">if</span> (CurrentVcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00309 
00310         <a class="code" href="../../d3/d8/udfprocs_8h.html#a76">UdfReleaseVcb</a>( IrpContext, CurrentVcb );
00311     }
00312 
00313     <a class="code" href="../../d1/d8/fsrtl_8h.html#a49">FsRtlExitFileSystem</a>();
00314     <span class="keywordflow">return</span>;
00315 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a249" doxytag="udfprocs.h::UdfFspDispatch" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID UdfFspDispatch           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>IrpContext</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d7/fspdisp_8c-source.html#l00038">38</a> of file <a class="el" href="../../d1/d7/fspdisp_8c-source.html">fspdisp.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02488">_IO_STACK_LOCATION::DeviceObject</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02494">_IO_STACK_LOCATION::FileObject</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01772">FsRtlEnterFileSystem</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01795">FsRtlExitFileSystem</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03252">IoGetCurrentIrpStackLocation</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01635">_IRP::IoStatus</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01234">IRP_CONTEXT_FLAG_MORE_PROCESSING</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01280">IRP_CONTEXT_FSP_FLAGS</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00073">IRP_MJ_CLEANUP</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00057">IRP_MJ_CLOSE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00055">IRP_MJ_CREATE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00069">IRP_MJ_DEVICE_CONTROL</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00067">IRP_MJ_DIRECTORY_CONTROL</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00068">IRP_MJ_FILE_SYSTEM_CONTROL</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00072">IRP_MJ_LOCK_CONTROL</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00082">IRP_MJ_PNP</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00060">IRP_MJ_QUERY_INFORMATION</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00065">IRP_MJ_QUERY_VOLUME_INFORMATION</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00058">IRP_MJ_READ</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00061">IRP_MJ_SET_INFORMATION</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l02007">KeAcquireSpinLock</a>, <a class="el" href="../../d9/d5/verifier_8c.html#a119">KeReleaseSpinLock()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00724">_VOLUME_DEVICE_OBJECT::OverflowQueue</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00716">_VOLUME_DEVICE_OBJECT::OverflowQueueCount</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00730">_VOLUME_DEVICE_OBJECT::OverflowQueueSpinLock</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00709">_VOLUME_DEVICE_OBJECT::PostedRequestCount</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00505">SetFlag</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00137">ThreadContext</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l01437">UdfCleanupIrpContext()</a>, <a class="el" href="../../d9/d6/udfs_2cleanup_8c-source.html#l00042">UdfCommonCleanup()</a>, <a class="el" href="../../d4/d7/udfs_2create_8c-source.html#l00108">UdfCommonCreate()</a>, <a class="el" href="../../d3/d6/udfs_2devctrl_8c-source.html#l00069">UdfCommonDevControl()</a>, <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l00255">UdfCommonDirControl()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l00283">UdfCommonFsControl()</a>, <a class="el" href="../../d3/d4/lockctrl_8c-source.html#l00046">UdfCommonLockControl()</a>, <a class="el" href="../../d5/d8/udfs_2pnp_8c-source.html#l00075">UdfCommonPnp()</a>, <a class="el" href="../../d5/d2/fileinfo_8c-source.html#l00156">UdfCommonQueryInfo()</a>, <a class="el" href="../../d8/d5/volinfo_8c-source.html#l00082">UdfCommonQueryVolInfo()</a>, <a class="el" href="../../d8/d4/udfs_2read_8c-source.html#l00068">UdfCommonRead()</a>, <a class="el" href="../../d5/d2/fileinfo_8c-source.html#l00385">UdfCommonSetInfo()</a>, <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00809">UdfCompleteRequest()</a>, <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00448">UdfExceptionFilter()</a>, <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00539">UdfProcessException()</a>, and <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00873">UdfSetThreadContext()</a>.
<p>
Referenced by <a class="el" href="../../d3/d8/workque_8c-source.html#l00316">UdfAddToWorkque()</a>.
<p>
<pre class="fragment"><div>00044                    :
00045 
00046     This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d9/arcinst_8c.html#a19">main</a> FSP thread routine that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> executed to receive
00047     and dispatch <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> requests.  Each FSP thread begins its execution here.
00048     There <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> one thread created at system initialization time and subsequent
00049     threads created as needed.
00050 
00051 Arguments:
00052 
00053     IrpContext - IrpContext <span class="keywordflow">for</span> a request to process.
00054 
00055 Return Value:
00056 
00057     None
00058 
00059 --*/
00060 
00061 {
00062     <a class="code" href="../../d0/d1/struct__THREAD__CONTEXT.html">THREAD_CONTEXT</a> <a class="code" href="../../d2/d1/cttoken_8c.html#a62">ThreadContext</a>;
00063     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00064 
00065     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> = IrpContext-&gt;Irp;
00066     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp = <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>( Irp );
00067 
00068     <a class="code" href="../../d6/d7/struct__VOLUME__DEVICE__OBJECT.html">PVOLUME_DEVICE_OBJECT</a> VolDo = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00069 
00070     <span class="comment">//</span>
00071     <span class="comment">//  If this request has an associated volume device object, remember it.</span>
00072     <span class="comment">//</span>
00073 
00074     <span class="keywordflow">if</span> (IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00075 
00076         VolDo = CONTAINING_RECORD( IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o57">DeviceObject</a>,
00077                                    <a class="code" href="../../d6/d7/struct__VOLUME__DEVICE__OBJECT.html">VOLUME_DEVICE_OBJECT</a>,
00078                                    DeviceObject );
00079     }
00080 
00081     <span class="comment">//</span>
00082     <span class="comment">//  Now case on the function code.  For each major function code,</span>
00083     <span class="comment">//  either call the appropriate worker routine.  This routine that</span>
00084     <span class="comment">//  we call is responsible for completing the IRP, and not us.</span>
00085     <span class="comment">//  That way the routine can complete the IRP and then continue</span>
00086     <span class="comment">//  post processing as required.  For example, a read can be</span>
00087     <span class="comment">//  satisfied right away and then read can be done.</span>
00088     <span class="comment">//</span>
00089     <span class="comment">//  We'll do all of the work within an exception handler that</span>
00090     <span class="comment">//  will be invoked if ever some underlying operation gets into</span>
00091     <span class="comment">//  trouble.</span>
00092     <span class="comment">//</span>
00093 
00094     <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00095 
00096         <span class="comment">//</span>
00097         <span class="comment">//  Set all the flags indicating we are in the Fsp.</span>
00098         <span class="comment">//</span>
00099 
00100         <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( IrpContext-&gt;Flags, IRP_CONTEXT_FSP_FLAGS );
00101 
00102         <a class="code" href="../../d1/d8/fsrtl_8h.html#a48">FsRtlEnterFileSystem</a>();
00103 
00104         <a class="code" href="../../d3/d8/udfprocs_8h.html#a130">UdfSetThreadContext</a>( IrpContext, &amp;ThreadContext );
00105 
00106         <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00107 
00108             <span class="keywordflow">try</span> {
00109 
00110                 <span class="comment">//</span>
00111                 <span class="comment">//  Reinitialize for the next try at completing this</span>
00112                 <span class="comment">//  request.</span>
00113                 <span class="comment">//</span>
00114 
00115                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> =
00116                 IrpContext-&gt;ExceptionStatus = STATUS_SUCCESS;
00117 
00118                 <span class="comment">//</span>
00119                 <span class="comment">//  Initialize the Io status field in the Irp.</span>
00120                 <span class="comment">//</span>
00121 
00122                 <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status = STATUS_SUCCESS;
00123                 <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information = 0;
00124 
00125                 <span class="comment">//</span>
00126                 <span class="comment">//  Case on the major irp code.</span>
00127                 <span class="comment">//</span>
00128 
00129                 <span class="keywordflow">switch</span> (IrpContext-&gt;MajorFunction) {
00130 
00131                     <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a31">IRP_MJ_CLEANUP</a> :
00132                         
00133                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d8/udfprocs_8h.html#a251">UdfCommonCleanup</a>( IrpContext, Irp );
00134                         <span class="keywordflow">break</span>;
00135         
00136                     <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a15">IRP_MJ_CLOSE</a> :
00137 
00138                         <span class="comment">//</span>
00139                         <span class="comment">//  Closes should never be posted.</span>
00140                         <span class="comment">//</span>
00141                         
00142                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( FALSE );
00143                         <span class="keywordflow">break</span>;
00144 
00145                     <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a13">IRP_MJ_CREATE</a> :
00146                         
00147                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d8/udfprocs_8h.html#a253">UdfCommonCreate</a>( IrpContext, Irp );
00148                         <span class="keywordflow">break</span>;
00149         
00150                     <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a27">IRP_MJ_DEVICE_CONTROL</a> :
00151     
00152                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d8/udfprocs_8h.html#a254">UdfCommonDevControl</a>( IrpContext, Irp );
00153                         <span class="keywordflow">break</span>;
00154     
00155                     <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a25">IRP_MJ_DIRECTORY_CONTROL</a> :
00156     
00157                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d8/udfprocs_8h.html#a255">UdfCommonDirControl</a>( IrpContext, Irp );
00158                         <span class="keywordflow">break</span>;
00159     
00160                     <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a26">IRP_MJ_FILE_SYSTEM_CONTROL</a> :
00161     
00162                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d8/udfprocs_8h.html#a256">UdfCommonFsControl</a>( IrpContext, Irp );
00163                         <span class="keywordflow">break</span>;
00164     
00165                     <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a30">IRP_MJ_LOCK_CONTROL</a> :
00166 
00167                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d8/udfprocs_8h.html#a257">UdfCommonLockControl</a>( IrpContext, Irp );
00168                         <span class="keywordflow">break</span>;
00169 
00170                     <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a40">IRP_MJ_PNP</a> :
00171 
00172                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( FALSE );
00173                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d8/udfprocs_8h.html#a258">UdfCommonPnp</a>( IrpContext, Irp );
00174                         <span class="keywordflow">break</span>;
00175 
00176                     <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a18">IRP_MJ_QUERY_INFORMATION</a> :
00177 
00178                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d8/udfprocs_8h.html#a259">UdfCommonQueryInfo</a>( IrpContext, Irp );
00179                         <span class="keywordflow">break</span>;
00180                 
00181                     <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a23">IRP_MJ_QUERY_VOLUME_INFORMATION</a> :
00182 
00183                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d6/volinfo_8c.html#a6">UdfCommonQueryVolInfo</a>( IrpContext, Irp );
00184                         <span class="keywordflow">break</span>;
00185                 
00186                     <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a16">IRP_MJ_READ</a> :
00187     
00188                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d8/udfprocs_8h.html#a261">UdfCommonRead</a>( IrpContext, Irp );
00189                         <span class="keywordflow">break</span>;
00190     
00191                     <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a19">IRP_MJ_SET_INFORMATION</a> :
00192                 
00193                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d8/udfprocs_8h.html#a262">UdfCommonSetInfo</a>( IrpContext, Irp );
00194                         <span class="keywordflow">break</span>;
00195                 
00196                     <span class="keywordflow">default</span> :
00197     
00198                         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_DEVICE_REQUEST;
00199                         <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, Irp, Status );
00200                 }
00201 
00202             } except( <a class="code" href="../../d3/d8/udfprocs_8h.html#a127">UdfExceptionFilter</a>( IrpContext, GetExceptionInformation() )) {
00203 
00204                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d8/udfprocs_8h.html#a128">UdfProcessException</a>( IrpContext, Irp, GetExceptionCode() );
00205             }
00206 
00207             <span class="comment">//</span>
00208             <span class="comment">//  Break out of the loop if we didn't get CANT_WAIT.</span>
00209             <span class="comment">//</span>
00210 
00211             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_CANT_WAIT) { <span class="keywordflow">break</span>; }
00212 
00213             <span class="comment">//</span>
00214             <span class="comment">//  We are retrying this request.  Cleanup the IrpContext for the retry.</span>
00215             <span class="comment">//</span>
00216 
00217             <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( IrpContext-&gt;Flags, IRP_CONTEXT_FLAG_MORE_PROCESSING );
00218             <a class="code" href="../../d3/d8/udfprocs_8h.html#a208">UdfCleanupIrpContext</a>( IrpContext, FALSE );
00219         }
00220 
00221         <a class="code" href="../../d1/d8/fsrtl_8h.html#a49">FsRtlExitFileSystem</a>();
00222 
00223         <span class="comment">//</span>
00224         <span class="comment">//  If there are any entries on this volume's overflow queue, service</span>
00225         <span class="comment">//  them.</span>
00226         <span class="comment">//</span>
00227 
00228         <span class="keywordflow">if</span> (VolDo != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00229 
00230             KIRQL SavedIrql;
00231             PVOID Entry = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00232 
00233             <span class="comment">//</span>
00234             <span class="comment">//  We have a volume device object so see if there is any work</span>
00235             <span class="comment">//  left to do in its overflow queue.</span>
00236             <span class="comment">//</span>
00237 
00238             <a class="code" href="../../d4/d9/ke_8h.html#a37">KeAcquireSpinLock</a>( &amp;VolDo-&gt;<a class="code" href="../../d6/d7/struct__VOLUME__DEVICE__OBJECT.html#o4">OverflowQueueSpinLock</a>, &amp;SavedIrql );
00239 
00240             <span class="keywordflow">if</span> (VolDo-&gt;<a class="code" href="../../d6/d7/struct__VOLUME__DEVICE__OBJECT.html#o2">OverflowQueueCount</a> &gt; 0) {
00241 
00242                 <span class="comment">//</span>
00243                 <span class="comment">//  There is overflow work to do in this volume so we'll</span>
00244                 <span class="comment">//  decrement the Overflow count, dequeue the IRP, and release</span>
00245                 <span class="comment">//  the Event</span>
00246                 <span class="comment">//</span>
00247 
00248                 VolDo-&gt;<a class="code" href="../../d6/d7/struct__VOLUME__DEVICE__OBJECT.html#o2">OverflowQueueCount</a> -= 1;
00249 
00250                 Entry = RemoveHeadList( &amp;VolDo-&gt;<a class="code" href="../../d6/d7/struct__VOLUME__DEVICE__OBJECT.html#o3">OverflowQueue</a> );
00251             }
00252 
00253             <a class="code" href="../../d9/d5/verifier_8c.html#a119">KeReleaseSpinLock</a>( &amp;VolDo-&gt;<a class="code" href="../../d6/d7/struct__VOLUME__DEVICE__OBJECT.html#o4">OverflowQueueSpinLock</a>, SavedIrql );
00254 
00255             <span class="comment">//</span>
00256             <span class="comment">//  There wasn't an entry, break out of the loop and return to</span>
00257             <span class="comment">//  the Ex Worker thread.</span>
00258             <span class="comment">//</span>
00259 
00260             <span class="keywordflow">if</span> (Entry == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) { <span class="keywordflow">break</span>; }
00261 
00262             <span class="comment">//</span>
00263             <span class="comment">//  Extract the IrpContext , Irp, set wait to TRUE, and loop.</span>
00264             <span class="comment">//</span>
00265 
00266             IrpContext = CONTAINING_RECORD( Entry,
00267                                             <a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html">IRP_CONTEXT</a>,
00268                                             WorkQueueItem.List );
00269 
00270             <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> = IrpContext-&gt;Irp;
00271             IrpSp = <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>( Irp );
00272 
00273             <span class="keywordflow">continue</span>;
00274         }
00275 
00276         <span class="keywordflow">break</span>;
00277     }
00278 
00279     <span class="comment">//</span>
00280     <span class="comment">//  Decrement the PostedRequestCount if there was a volume device object.</span>
00281     <span class="comment">//</span>
00282 
00283     <span class="keywordflow">if</span> (VolDo) {
00284 
00285         InterlockedDecrement( &amp;VolDo-&gt;<a class="code" href="../../d6/d7/struct__VOLUME__DEVICE__OBJECT.html#o1">PostedRequestCount</a> );
00286     }
00287 
00288     <span class="keywordflow">return</span>;
00289 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a185" doxytag="udfprocs.h::UdfFullCompareNames" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d1/d8/fsrtl_8h.html#a70">FSRTL_COMPARISON_RESULT</a> UdfFullCompareNames           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>NameA</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>NameB</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d4/namesup_8c-source.html#l01274">1274</a> of file <a class="el" href="../../d6/d4/namesup_8c-source.html">namesup.c</a>.
<p>
References <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00352">ASSERT_IRP_CONTEXT</a>, <a class="el" href="../../d1/d8/fsrtl_8h.html#a189a90">EqualTo</a>, <a class="el" href="../../d1/d8/fsrtl_8h.html#a70">FSRTL_COMPARISON_RESULT</a>, <a class="el" href="../../d1/d8/fsrtl_8h.html#a189a91">GreaterThan</a>, <a class="el" href="../../d1/d8/fsrtl_8h.html#a189a89">LessThan</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d5/d7/dirsup_8c-source.html#l00726">UdfFindDirEntry()</a>, <a class="el" href="../../d6/d3/prefxsup_8c-source.html#l00557">UdfFindNameLink()</a>, <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l01003">UdfInitializeEnumeration()</a>, and <a class="el" href="../../d6/d3/prefxsup_8c-source.html#l00660">UdfInsertNameLink()</a>.
<p>
<pre class="fragment"><div>01282                    :
01283 
01284     This function compares two names as fast as possible.  Note that since
01285     <span class="keyword">this</span> comparison <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <span class="keywordflow">case</span> sensitive we can <span class="keywordflow">do</span> a direct memory comparison.
01286 
01287 Arguments:
01288 
01289     NameA &amp; NameB - The names to compare.
01290 
01291 Return Value:
01292 
01293     <a class="code" href="../../d4/d4/prefix_8c.html#a7">COMPARISON</a> - returns
01294 
01295         <a class="code" href="../../d1/d8/fsrtl_8h.html#a189a89">LessThan</a>    <span class="keywordflow">if</span> NameA &lt; NameB lexicalgraphically,
01296         <a class="code" href="../../d1/d8/fsrtl_8h.html#a189a91">GreaterThan</a> <span class="keywordflow">if</span> NameA &gt; NameB lexicalgraphically,
01297         <a class="code" href="../../d1/d8/fsrtl_8h.html#a189a90">EqualTo</a>     <span class="keywordflow">if</span> NameA <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> equal to NameB
01298 
01299 --*/
01300 
01301 {
01302     ULONG i;
01303     ULONG MinLength = NameA-&gt;Length;
01304     <a class="code" href="../../d1/d8/fsrtl_8h.html#a70">FSRTL_COMPARISON_RESULT</a> Result = <a class="code" href="../../d1/d8/fsrtl_8h.html#a189a89">LessThan</a>;
01305 
01306     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01307 
01308     <span class="comment">//</span>
01309     <span class="comment">//  Check inputs.</span>
01310     <span class="comment">//</span>
01311 
01312     <a class="code" href="../../d1/d8/udfdata_8h.html#a28">ASSERT_IRP_CONTEXT</a>( IrpContext );
01313 
01314     <span class="comment">//</span>
01315     <span class="comment">//  Figure out the minimum of the two lengths</span>
01316     <span class="comment">//</span>
01317 
01318     <span class="keywordflow">if</span> (NameA-&gt;Length &gt; NameB-&gt;Length) {
01319 
01320         MinLength = NameB-&gt;Length;
01321         Result = <a class="code" href="../../d1/d8/fsrtl_8h.html#a189a91">GreaterThan</a>;
01322 
01323     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (NameA-&gt;Length == NameB-&gt;Length) {
01324 
01325         Result = <a class="code" href="../../d1/d8/fsrtl_8h.html#a189a90">EqualTo</a>;
01326     }
01327 
01328     <span class="comment">//</span>
01329     <span class="comment">//  Loop through looking at all of the characters in both strings</span>
01330     <span class="comment">//  testing for equalilty, less than, and greater than</span>
01331     <span class="comment">//</span>
01332 
01333     i = (ULONG) RtlCompareMemory( NameA-&gt;Buffer, NameB-&gt;Buffer, MinLength );
01334 
01335     <span class="keywordflow">if</span> (i &lt; MinLength) {
01336 
01337         <span class="comment">//</span>
01338         <span class="comment">//  We know the offset of the first character which is different.</span>
01339         <span class="comment">//</span>
01340 
01341         <span class="keywordflow">return</span> ((NameA-&gt;Buffer[ i / 2 ] &lt; NameB-&gt;Buffer[ i / 2 ]) ?
01342                  <a class="code" href="../../d1/d8/fsrtl_8h.html#a189a89">LessThan</a> :
01343                  <a class="code" href="../../d1/d8/fsrtl_8h.html#a189a91">GreaterThan</a>);
01344     }
01345 
01346     <span class="comment">//</span>
01347     <span class="comment">//  The names match up to the length of the shorter string.</span>
01348     <span class="comment">//  The shorter string lexically appears first.</span>
01349     <span class="comment">//</span>
01350 
01351     <span class="keywordflow">return</span> Result;
01352 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a180" doxytag="udfprocs.h::UdfGenerate8dot3Name" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID UdfGenerate8dot3Name           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>FileName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>ShortFileName</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d4/namesup_8c-source.html#l00389">389</a> of file <a class="el" href="../../d6/d4/namesup_8c-source.html">namesup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d7/udf_8h-source.html#l00240">CRC_MARK</a>, <a class="el" href="../../d0/d7/udf_8h-source.html#l00227">DOS_CRC_LEN</a>, <a class="el" href="../../d0/d7/udf_8h-source.html#l00226">DOS_EXT_LEN</a>, <a class="el" href="../../d0/d7/udf_8h-source.html#l00225">DOS_NAME_LEN</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d1/rtload_8c-source.html#l00047">FileName</a>, <a class="el" href="../../d0/d7/udf_8h-source.html#l00241">ILLEGAL_CHAR_MARK</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00035">INT16</a>, <a class="el" href="../../d0/d7/udf_8h-source.html#l00230">IsDeviceName</a>, <a class="el" href="../../d0/d7/udf_8h-source.html#l00229">IsFileNameCharLegal</a>, <a class="el" href="../../d6/d4/namesup_8c-source.html#l00056">NativeDosCharLength()</a>, <a class="el" href="../../d0/d7/udf_8h-source.html#l00238">PERIOD</a>, <a class="el" href="../../d0/d7/udf_8h-source.html#l00239">SPACE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d1/d7/udfdata_8c-source.html#l01194">UdfComputeCrc16Uni()</a>, <a class="el" href="../../d6/d4/namesup_8c-source.html#l00039">UdfCrcChar</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01131">UdfUpcaseName()</a>, <a class="el" href="../../d0/d7/udf_8h-source.html#l00235">UINT16</a>, <a class="el" href="../../d0/d7/udf_8h-source.html#l00236">UNICODE_CHAR</a>, <a class="el" href="../../d0/d7/udf_8h-source.html#l00232">UnicodeToUpper</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l01500">UdfEnumerateIndex()</a>, <a class="el" href="../../d5/d7/dirsup_8c-source.html#l00726">UdfFindDirEntry()</a>, <a class="el" href="../../d5/d2/fileinfo_8c-source.html#l01232">UdfQueryAlternateNameInfo()</a>, and <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l00334">UdfQueryDirectory()</a>.
<p>
<pre class="fragment"><div>00397                    :
00398 
00399     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called to generate a <span class="keywordtype">short</span> name from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> given <span class="keywordtype">long</span> name.  We will
00400     generate a <span class="keywordtype">short</span> name from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> given <span class="keywordtype">long</span> name.
00401 
00402     The <span class="keywordtype">short</span> form <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to convert all runs of illegal characters to <span class="stringliteral">"_"</span> and tack
00403     on a base41 representation of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> CRC of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> original name.  The algorithm <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00404     nearly directly lifted from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> UDF (2.01 proposed!) standard, so apologies for the
00405     style clash.
00406     
00407 Arguments:
00408 
00409     FileName - String of bytes containing the name.
00410 
00411     ShortFileName - Pointer to the string to store the <span class="keywordtype">short</span> name into.
00412         
00413 Return Value:
00414 
00415     None.
00416 
00417 --*/
00418 
00419 {
00420     <a class="code" href="../../d9/d7/udf_8h.html#a23">INT16</a> index;
00421     <a class="code" href="../../d9/d7/udf_8h.html#a23">INT16</a> targetIndex;
00422     <a class="code" href="../../d9/d7/udf_8h.html#a23">INT16</a> crcIndex;
00423     <a class="code" href="../../d9/d7/udf_8h.html#a23">INT16</a> extLen;
00424     <a class="code" href="../../d9/d7/udf_8h.html#a23">INT16</a> nameLen;
00425     <a class="code" href="../../d9/d7/udf_8h.html#a23">INT16</a> charLen;
00426     <a class="code" href="../../d9/d7/udf_8h.html#a23">INT16</a> overlayBytes;
00427     <a class="code" href="../../d9/d7/udf_8h.html#a23">INT16</a> bytesLeft;
00428     <a class="code" href="../../d9/d7/udf_8h.html#a25">UNICODE_CHAR</a> current;
00429     BOOLEAN needsCRC;
00430     <a class="code" href="../../d9/d7/udf_8h.html#a25">UNICODE_CHAR</a> ext[<a class="code" href="../../d9/d7/udf_8h.html#a17">DOS_EXT_LEN</a>];
00431 
00432     <span class="comment">//</span>
00433     <span class="comment">//  So as to lift as directly as possible from the standard, chunk things around.</span>
00434     <span class="comment">//</span>
00435  
00436     PWCHAR dosName = ShortFileName-&gt;Buffer;
00437     PWCHAR udfName = <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Buffer;
00438     LONG udfNameLen = <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Length / <span class="keyword">sizeof</span>(WCHAR);
00439     
00440     needsCRC = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00441 
00442     <span class="comment">/* Start at the end of the UDF file name and scan for a period */</span>
00443     <span class="comment">/* ('.').  This will be where the DOS extension starts (if     */</span>
00444     <span class="comment">/* any).                                                       */</span>
00445     index = udfNameLen;
00446     <span class="keywordflow">while</span> (index-- &gt; 0) {
00447         <span class="keywordflow">if</span> (udfName[index] == <a class="code" href="../../d9/d7/udf_8h.html#a26">PERIOD</a>)
00448             <span class="keywordflow">break</span>;
00449     }
00450 
00451     <span class="keywordflow">if</span> (index &lt; 0) {
00452         <span class="comment">/* There name was scanned to the beginning of the buffer   */</span>
00453         <span class="comment">/* and no extension was found.                             */</span>
00454         extLen = 0;
00455         nameLen = udfNameLen;
00456     }
00457     <span class="keywordflow">else</span> {
00458         <span class="comment">/* A DOS extension was found, process it first.            */</span>
00459         extLen = udfNameLen - index - 1;
00460         nameLen = index;
00461         targetIndex = 0;
00462         bytesLeft = <a class="code" href="../../d9/d7/udf_8h.html#a17">DOS_EXT_LEN</a>;
00463 
00464         <span class="keywordflow">while</span> (++index &lt; udfNameLen &amp;&amp; bytesLeft &gt; 0) {
00465             <span class="comment">/* Get the current character and convert it to upper   */</span>
00466             <span class="comment">/* case.                                               */</span>
00467             current = <a class="code" href="../../d9/d7/udf_8h.html#a22">UnicodeToUpper</a>(udfName[index]);
00468             <span class="keywordflow">if</span> (current == <a class="code" href="../../d9/d7/udf_8h.html#a27">SPACE</a>) {
00469                 <span class="comment">/* If a space is found, a CRC must be appended to  */</span>
00470                 <span class="comment">/* the mangled file name.                          */</span>
00471                 needsCRC = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00472             }
00473             <span class="keywordflow">else</span> {
00474                 <span class="comment">/* Determine if this is a valid file name char and */</span>
00475                 <span class="comment">/* calculate its corresponding BCS character byte  */</span>
00476                 <span class="comment">/* length (zero if the char is not legal or        */</span>
00477                 <span class="comment">/* undisplayable on this system).                  */</span>
00478                 charLen = (<a class="code" href="../../d9/d7/udf_8h.html#a19">IsFileNameCharLegal</a>(current)) ?
00479                     <a class="code" href="../../d5/d5/namesup_8c.html#a3">NativeDosCharLength</a>(current) : 0;
00480 
00481                 <span class="comment">/* If the char is larger than the available space  */</span>
00482                 <span class="comment">/* in the buffer, pretend it is undisplayable.     */</span>
00483                 <span class="keywordflow">if</span> (charLen &gt; bytesLeft)
00484                     charLen = 0;
00485 
00486                 <span class="keywordflow">if</span> (charLen == 0) {
00487                     <span class="comment">/* Undisplayable or illegal characters are     */</span>
00488                     <span class="comment">/* substituted with an underscore ("_"), and   */</span>
00489                     <span class="comment">/* required a CRC code appended to the mangled */</span>
00490                     <span class="comment">/* file name.                                  */</span>
00491                     needsCRC = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00492                     charLen = 1;
00493                     current = <a class="code" href="../../d9/d7/udf_8h.html#a29">ILLEGAL_CHAR_MARK</a>;
00494 
00495                     <span class="comment">/* Skip over any following undiplayable or     */</span>
00496                     <span class="comment">/* illegal chars.                              */</span>
00497                     <span class="keywordflow">while</span> (index + 1 &lt; udfNameLen &amp;&amp;
00498                         (!<a class="code" href="../../d9/d7/udf_8h.html#a19">IsFileNameCharLegal</a>(udfName[index + 1]) ||
00499                         <a class="code" href="../../d5/d5/namesup_8c.html#a3">NativeDosCharLength</a>(udfName[index + 1]) == 0))
00500                         index++;
00501                 }
00502 
00503                 <span class="comment">/* Assign the resulting char to the next index in  */</span>
00504                 <span class="comment">/* the extension buffer and determine how many BCS */</span>
00505                 <span class="comment">/* bytes are left.                                 */</span>
00506                 ext[targetIndex++] = current;
00507                 bytesLeft -= charLen;
00508             }
00509         }
00510 
00511         <span class="comment">/* Save the number of Unicode characters in the extension  */</span>
00512         extLen = targetIndex;
00513 
00514         <span class="comment">/* If the extension was too large, or it was zero length   */</span>
00515         <span class="comment">/* (i.e. the name ended in a period), a CRC code must be   */</span>
00516         <span class="comment">/* appended to the mangled name.                           */</span>
00517         <span class="keywordflow">if</span> (index &lt; udfNameLen || extLen == 0)
00518             needsCRC = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00519     }
00520 
00521     <span class="comment">/* Now process the actual file name.                           */</span>
00522     index = 0;
00523     targetIndex = 0;
00524     crcIndex = 0;
00525     overlayBytes = -1;
00526     bytesLeft = <a class="code" href="../../d9/d7/udf_8h.html#a16">DOS_NAME_LEN</a>;
00527     <span class="keywordflow">while</span> (index &lt; nameLen &amp;&amp; bytesLeft &gt; 0) {
00528         <span class="comment">/* Get the current character and convert it to upper case. */</span>
00529         current = <a class="code" href="../../d9/d7/udf_8h.html#a22">UnicodeToUpper</a>(udfName[index]);
00530         <span class="keywordflow">if</span> (current == <a class="code" href="../../d9/d7/udf_8h.html#a27">SPACE</a> || current == <a class="code" href="../../d9/d7/udf_8h.html#a26">PERIOD</a>) {
00531             <span class="comment">/* Spaces and periods are just skipped, a CRC code     */</span>
00532             <span class="comment">/* must be added to the mangled file name.             */</span>
00533             needsCRC = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00534         }
00535         <span class="keywordflow">else</span> {
00536             <span class="comment">/* Determine if this is a valid file name char and     */</span>
00537             <span class="comment">/* calculate its corresponding BCS character byte      */</span>
00538             <span class="comment">/* length (zero if the char is not legal or            */</span>
00539             <span class="comment">/* undisplayable on this system).                      */</span>
00540             charLen = (<a class="code" href="../../d9/d7/udf_8h.html#a19">IsFileNameCharLegal</a>(current)) ?
00541                 <a class="code" href="../../d5/d5/namesup_8c.html#a3">NativeDosCharLength</a>(current) : 0;
00542 
00543             <span class="comment">/* If the char is larger than the available space in   */</span>
00544             <span class="comment">/* the buffer, pretend it is undisplayable.            */</span>
00545             <span class="keywordflow">if</span> (charLen &gt; bytesLeft)
00546                 charLen = 0;
00547 
00548             <span class="keywordflow">if</span> (charLen == 0) {
00549                 <span class="comment">/* Undisplayable or illegal characters are         */</span>
00550                 <span class="comment">/* substituted with an underscore ("_"), and       */</span>
00551                 <span class="comment">/* required a CRC code appended to the mangled     */</span>
00552                 <span class="comment">/* file name.                                      */</span>
00553                 needsCRC = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00554                 charLen = 1;
00555                 current = <a class="code" href="../../d9/d7/udf_8h.html#a29">ILLEGAL_CHAR_MARK</a>;
00556 
00557                 <span class="comment">/* Skip over any following undiplayable or illegal */</span>
00558                 <span class="comment">/* chars.                                          */</span>
00559                 <span class="keywordflow">while</span> (index + 1 &lt; nameLen &amp;&amp;
00560                     (!<a class="code" href="../../d9/d7/udf_8h.html#a19">IsFileNameCharLegal</a>(udfName[index + 1]) ||
00561                     <a class="code" href="../../d5/d5/namesup_8c.html#a3">NativeDosCharLength</a>(udfName[index + 1]) == 0))
00562                     index++;
00563 
00564                 <span class="comment">/* Terminate loop if at the end of the file name.  */</span>
00565                 <span class="keywordflow">if</span> (index &gt;= nameLen)
00566                     <span class="keywordflow">break</span>;
00567             }
00568 
00569             <span class="comment">/* Assign the resulting char to the next index in the  */</span>
00570             <span class="comment">/* file name buffer and determine how many BCS bytes   */</span>
00571             <span class="comment">/* are left.                                           */</span>
00572             dosName[targetIndex++] = current;
00573             bytesLeft -= charLen;
00574 
00575             <span class="comment">/* This figures out where the CRC code needs to start  */</span>
00576             <span class="comment">/* in the file name buffer.                            */</span>
00577             <span class="keywordflow">if</span> (bytesLeft &gt;= <a class="code" href="../../d9/d7/udf_8h.html#a18">DOS_CRC_LEN</a>) {
00578                 <span class="comment">/* If there is enough space left, just tack it     */</span>
00579                 <span class="comment">/* onto the end.                                   */</span>
00580                 crcIndex = targetIndex;
00581             }
00582             <span class="keywordflow">else</span> {
00583                 <span class="comment">/* If there is not enough space left, the CRC      */</span>
00584                 <span class="comment">/* must overlay a character already in the file    */</span>
00585                 <span class="comment">/* name buffer.  Once this condition has been      */</span>
00586                 <span class="comment">/* met, the value will not change.                 */</span>
00587                 <span class="keywordflow">if</span> (overlayBytes &lt; 0) {
00588                     <span class="comment">/* Determine the index and save the length of  */</span>
00589                     <span class="comment">/* the BCS character that is overlayed.  It    */</span>
00590                     <span class="comment">/* is possible that the CRC might overlay      */</span>
00591                     <span class="comment">/* half of a two-byte BCS character depending  */</span>
00592                     <span class="comment">/* upon how the character boundaries line up.  */</span>
00593                     overlayBytes = (bytesLeft + charLen &gt; <a class="code" href="../../d9/d7/udf_8h.html#a18">DOS_CRC_LEN</a>)
00594                         ? 1 : 0;
00595                     crcIndex = targetIndex - 1;
00596                 }
00597             }
00598         }
00599 
00600         <span class="comment">/* Advance to the next character.                          */</span>
00601         index++;
00602     }
00603 
00604     <span class="comment">/* If the scan did not reach the end of the file name, or the  */</span>
00605     <span class="comment">/* length of the file name is zero, a CRC code is needed.      */</span>
00606     <span class="keywordflow">if</span> (index &lt; nameLen || index == 0)
00607         needsCRC = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00608 
00609     <span class="comment">/* If the name has illegal characters or and extension, it     */</span>
00610     <span class="comment">/* is not a DOS device name.                                   */</span>
00611     <span class="keywordflow">if</span> (needsCRC == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> &amp;&amp; extLen == 0) {
00612         <span class="comment">/* If this is the name of a DOS device, a CRC code should  */</span>
00613         <span class="comment">/* be appended to the file name.                           */</span>
00614         <span class="keywordflow">if</span> (<a class="code" href="../../d9/d7/udf_8h.html#a20">IsDeviceName</a>(udfName, udfNameLen))
00615             needsCRC = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00616     }
00617 
00618     <span class="comment">/* Append the CRC code to the file name, if needed.            */</span>
00619     <span class="keywordflow">if</span> (needsCRC) {
00620         <span class="comment">/* Get the CRC value for the original Unicode string       */</span>
00621         <a class="code" href="../../d9/d7/udf_8h.html#a24">UINT16</a> udfCRCValue;
00622         <a class="code" href="../../d9/d7/udf_8h.html#a24">UINT16</a> modulus;
00623 
00624         <span class="comment">//</span>
00625         <span class="comment">//  In UDF 2.00, the sample code changed to take the CRC</span>
00626         <span class="comment">//  from the UNICODE expansion of the CS0 as opposed to</span>
00627         <span class="comment">//  the CS0 itself.  In UDF 2.01, the wording of the spec</span>
00628         <span class="comment">//  will actually match this.</span>
00629         <span class="comment">//</span>
00630         <span class="comment">//  Additionally, the checksum changes to be byte-order</span>
00631         <span class="comment">//  independent.</span>
00632         <span class="comment">//</span>
00633         
00634         udfCRCValue = <a class="code" href="../../d3/d8/udfprocs_8h.html#a135">UdfComputeCrc16Uni</a>(udfName, udfNameLen);
00635 
00636         <span class="comment">/* Determine the character index where the CRC should      */</span>
00637         <span class="comment">/* begin.                                                  */</span>
00638         targetIndex = crcIndex;
00639 
00640         <span class="comment">/* If the character being overlayed is a two-byte BCS      */</span>
00641         <span class="comment">/* character, replace the first byte with an underscore.   */</span>
00642         <span class="keywordflow">if</span> (overlayBytes &gt; 0)
00643             dosName[targetIndex++] = <a class="code" href="../../d9/d7/udf_8h.html#a29">ILLEGAL_CHAR_MARK</a>;
00644 
00645         <span class="comment">//</span>
00646         <span class="comment">//  UDF 2.01 changes to a base 41 encoding.  UDF 1.50 and</span>
00647         <span class="comment">//  UDF 2.00 exchanged the # delimeter with the high 4bits</span>
00648         <span class="comment">//  of the CRC.</span>
00649         <span class="comment">//</span>
00650 
00651         dosName[targetIndex++] = <a class="code" href="../../d9/d7/udf_8h.html#a28">CRC_MARK</a>;
00652         
00653         dosName[targetIndex++] =
00654             <a class="code" href="../../d5/d5/namesup_8c.html#a2">UdfCrcChar</a>[udfCRCValue / (41 * 41)];
00655         udfCRCValue %= (41 * 41);
00656         
00657         dosName[targetIndex++] =
00658             <a class="code" href="../../d5/d5/namesup_8c.html#a2">UdfCrcChar</a>[udfCRCValue / 41];
00659         udfCRCValue %= 41;
00660         
00661         dosName[targetIndex++] =
00662             <a class="code" href="../../d5/d5/namesup_8c.html#a2">UdfCrcChar</a>[udfCRCValue];
00663     }
00664 
00665     <span class="comment">/* Append the extension, if any.                               */</span>
00666     <span class="keywordflow">if</span> (extLen &gt; 0) {
00667         <span class="comment">/* Tack on a period and each successive byte in the        */</span>
00668         <span class="comment">/* extension buffer.                                       */</span>
00669         dosName[targetIndex++] = <a class="code" href="../../d9/d7/udf_8h.html#a26">PERIOD</a>;
00670         <span class="keywordflow">for</span> (index = 0; index &lt; extLen; index++)
00671             dosName[targetIndex++] = ext[index];
00672     }
00673 
00674     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( (targetIndex * <span class="keyword">sizeof</span>(WCHAR)) &lt;= ShortFileName-&gt;MaximumLength );
00675  
00676     ShortFileName-&gt;Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) (targetIndex * <span class="keyword">sizeof</span>(WCHAR));
00677 
00678     <span class="comment">//</span>
00679     <span class="comment">//  Now we upcase the whole name at once.</span>
00680     <span class="comment">//</span>
00681 
00682     <a class="code" href="../../d3/d8/udfprocs_8h.html#a186">UdfUpcaseName</a>( IrpContext,
00683                    ShortFileName,
00684                    ShortFileName );
00685 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a212" doxytag="udfprocs.h::UdfGetNextFcb" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d7/d9/struct__FCB.html">PFCB</a> UdfGetNextFcb           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d7/d5/struct__VCB.html">PVCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Vcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PVOID *&nbsp;</td>
          <td class="mdname" nowrap> <em>RestartKey</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l01997">1997</a> of file <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html">udfs/strucsup.c</a>.
<p>
References <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d9/d7/udfs_2strucsup_8c.html#a13">PFCB_TABLE_ELEMENT</a>, and <a class="el" href="../../d7/d0/gentable_8c-source.html#l01110">RtlEnumerateGenericTableWithoutSplaying()</a>.
<p>
Referenced by <a class="el" href="../../d9/d1/udfs_2cachesup_8c-source.html#l00417">UdfPurgeVolume()</a>.
<p>
<pre class="fragment"><div>02005                    :
02006 
02007     This routine will enumerate through all of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Fcb's in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Fcb table.
02008 
02009 Arguments:
02010 
02011     Vcb - Vcb <span class="keywordflow">for</span> <span class="keyword">this</span> volume.
02012 
02013     RestartKey - This value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> table <span class="keyword">package </span>to maintain
02014         its position in the enumeration.  It is initialized to NULL
02015         for the first search.
02016 
02017 Return Value:
02018 
02019     PFCB - A pointer to the next fcb or NULL if the enumeration is
02020         completed
02021 
02022 --*/
02023 
02024 {
02025     PFCB Fcb;
02026 
02027     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02028 
02029     Fcb = (<a class="code" href="../../d7/d9/struct__FCB.html">PFCB</a>) <a class="code" href="../../d6/d1/gentable_8c.html#a13">RtlEnumerateGenericTableWithoutSplaying</a>( &amp;Vcb-&gt;FcbTable, RestartKey );
02030 
02031     <span class="keywordflow">if</span> (Fcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
02032 
02033         Fcb = ((<a class="code" href="../../d5/d0/struct__FCB__TABLE__ELEMENT.html">PFCB_TABLE_ELEMENT</a>)(Fcb))-&gt;Fcb;
02034     }
02035 
02036     <span class="keywordflow">return</span> Fcb;
02037 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a136" doxytag="udfprocs.h::UdfHighBit" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG UdfHighBit           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">ULONG&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Word</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d7/udfdata_8c-source.html#l01239">1239</a> of file <a class="el" href="../../d1/d7/udfdata_8c-source.html">udfdata.c</a>.
<p>
References <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00033">Offset</a>.
<p>
Referenced by <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l00331">UdfInitializeVcb()</a>, and <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l01444">UdfMountVolume()</a>.
<p>
<pre class="fragment"><div>01245                    :
01246 
01247     This routine discovers <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> highest set bit of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> input word.  It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
01248     equivalent to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> integer logarithim base 2.
01249 
01250 Arguments:
01251 
01252     Word - word to check
01253 
01254 Return Value:
01255 
01256     Bit offset of highest set bit. If no bit <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> set, <span class="keywordflow">return</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> zero.
01257 
01258 --*/
01259 
01260 {
01261     ULONG <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a> = 31;
01262     ULONG Mask = (ULONG)(1 &lt;&lt; 31);
01263 
01264     <span class="keywordflow">if</span> (Word == 0) {
01265 
01266         <span class="keywordflow">return</span> 0;
01267     }
01268 
01269     <span class="keywordflow">while</span> ((Word &amp; Mask) == 0) {
01270 
01271         <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>--;
01272         Mask &gt;&gt;= 1;
01273     }
01274 
01275     <span class="keywordflow">return</span> <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
01276 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a145" doxytag="udfprocs.h::UdfIllegalFcbAccess" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> INLINE BOOLEAN UdfIllegalFcbAccess           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d3/d8/udfprocs_8h.html#a109">TYPE_OF_OPEN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>TypeOfOpen</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>DesiredAccess</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00675">675</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.
<p>
References <a class="el" href="../../d6/d4/cc_8h-source.html#l00501">BooleanFlagOn</a>, and <a class="el" href="../../d3/d8/udfprocs_8h.html#a263a115">UserVolumeOpen</a>.
<p>
Referenced by <a class="el" href="../../d4/d7/udfs_2create_8c-source.html#l01522">UdfOpenExistingFcb()</a>, <a class="el" href="../../d4/d7/udfs_2create_8c-source.html#l01244">UdfOpenObjectByFileId()</a>, and <a class="el" href="../../d4/d7/udfs_2create_8c-source.html#l01632">UdfOpenObjectFromDirContext()</a>.
<p>
<pre class="fragment"><div>00683                    :
00684 
00685     This routine simply asserts that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> access <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> legal <span class="keywordflow">for</span> a readonly filesystem.
00686     
00687 Arguments:
00688 
00689     TypeOfOpen - <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of open <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Fcb in question.
00690     
00691     DesiredAccess - mask of access <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> trying <span class="keywordflow">for</span>.
00692 
00693 Return Value:
00694 
00695     BOOLEAN True <span class="keywordflow">if</span> illegal access, <span class="keyword">false</span> otherwise.
00696 
00697 --*/
00698 
00699 {
00700     <span class="keywordflow">return</span> <a class="code" href="../../d5/d5/cc_8h.html#a59">BooleanFlagOn</a>( DesiredAccess,
00701                           (TypeOfOpen != UserVolumeOpen ?
00702                            (FILE_WRITE_ATTRIBUTES           |
00703                             FILE_WRITE_DATA                 |
00704                             FILE_WRITE_EA                   |
00705                             FILE_ADD_FILE                   |                     
00706                             FILE_ADD_SUBDIRECTORY           |
00707                             FILE_APPEND_DATA) : 0)          |
00708                           FILE_DELETE_CHILD                 |
00709                           DELETE                            |
00710                           WRITE_DAC );
00711 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a225" doxytag="udfprocs.h::UdfInitializeAllocations" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID UdfInitializeAllocations           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d7/d9/struct__FCB.html">PFCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Fcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d9/d9/struct__ICB__SEARCH__CONTEXT.html">PICB_SEARCH_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IcbContext</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l03388">3388</a> of file <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html">udfs/strucsup.c</a>.
<p>
References <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01599">_ALLOC_ENUM_CONTEXT::Alloc</a>, <a class="el" href="../../d6/d8/udfstruc_8h.html#a110">ALLOC_ENUM_CONTEXT</a>, <a class="el" href="../../d1/d6/iso13346_8h-source.html#l00955">ICBFILE::AllocLength</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01605">_ALLOC_ENUM_CONTEXT::AllocType</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00338">ASSERT_FCB</a>, <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00352">ASSERT_IRP_CONTEXT</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00280">BlockOffset</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00278">BlockSize</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d1/d6/iso13346_8h-source.html#l00936">ICBFILE::Destag</a>, <a class="el" href="../../d1/d6/iso13346_8h-source.html#l00954">ICBFILE::EALength</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01064">FCB_STATE_EMBEDDED_DATA</a>, <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00977">FsRtlAddLargeMcbEntry()</a>, <a class="el" href="../../d1/d6/iso13346_8h-source.html#l00884">ICBTAG_F_ALLOC_IMMEDIATE</a>, <a class="el" href="../../d1/d6/iso13346_8h-source.html#l00311">DESTAG::Lbn</a>, <a class="el" href="../../d1/d6/iso13346_8h-source.html#l00141">NSRLENGTH::Length</a>, <a class="el" href="../../d1/d6/iso13346_8h-source.html#l00158">SHORTAD::Length</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00224">LlSectorsFromBytes</a>, <a class="el" href="../../d1/d6/iso13346_8h-source.html#l00145">NSRLENGTH_TYPE_RECORDED</a>, <a class="el" href="../../d1/d6/iso13346_8h-source.html#l00146">NSRLENGTH_TYPE_UNRECORDED</a>, <a class="el" href="../../d1/d6/iso13346_8h-source.html#l00162">PAD_GENERIC</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d4/d7/fsrtlp_8h-source.html#l00212">SectorAlign</a>, <a class="el" href="../../d4/d7/fsrtlp_8h-source.html#l00222">SectorsFromBytes</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00505">SetFlag</a>, <a class="el" href="../../d1/d6/iso13346_8h-source.html#l00159">SHORTAD::Start</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d1/d6/iso13346_8h-source.html#l00142">NSRLENGTH::Type</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l04103">UdfGetNextAllocation()</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l00160">UdfGetPartitionOfCurrentAllocation()</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l04013">UdfInitializeAllocationContext()</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l00181">UdfInitializeFcbMcb()</a>, <a class="el" href="../../d3/d5/allocsup_8c-source.html#l01177">UdfLookupMetaVsnOfExtent()</a>, <a class="el" href="../../d3/d5/allocsup_8c-source.html#l01017">UdfLookupPsnOfExtent()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00406">UdfRaiseStatus()</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l00207">UdfUninitializeFcbMcb()</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l02297">UdfInitializeFcbFromIcbContext()</a>, and <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l00477">UdfUpdateVcbPhase0()</a>.
<p>
<pre class="fragment"><div>03396                    :
03397 
03398     This routine fills in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> data retrieval information <span class="keywordflow">for</span> an Fcb.
03399 
03400 Arguments:
03401 
03402     Fcb - Fcb to add retrieval information to.
03403     
03404     IcbContext - Elaborated ICB search context corresponding to <span class="keyword">this</span> Fcb.
03405 
03406 Return Value:
03407 
03408     None.
03409 
03410 --*/
03411 
03412 {
03413     <a class="code" href="../../d8/d0/structICBFILE.html">PICBFILE</a> Icb = IcbContext-&gt;Active.View;
03414     <a class="code" href="../../d2/d7/structSHORTAD.html">PAD_GENERIC</a> GenericAd;
03415     
03416     <a class="code" href="../../d2/d6/struct__ALLOC__ENUM__CONTEXT.html">ALLOC_ENUM_CONTEXT</a> AllocContext;
03417 
03418     LONGLONG RunningOffset;
03419     ULONG Psn;
03420     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> Partition;
03421 
03422     <a class="code" href="../../d7/d5/struct__VCB.html">PVCB</a> Vcb = Fcb-&gt;Vcb;
03423 
03424     BOOLEAN Result;
03425     BOOLEAN InFileTail = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03426 
03427     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03428 
03429     <span class="comment">//</span>
03430     <span class="comment">//  Check inputs</span>
03431     <span class="comment">//</span>
03432     
03433     <a class="code" href="../../d1/d8/udfdata_8h.html#a28">ASSERT_IRP_CONTEXT</a>( IrpContext );
03434     <a class="code" href="../../d1/d8/udfdata_8h.html#a14">ASSERT_FCB</a>( Fcb );
03435 
03436     <span class="comment">//</span>
03437     <span class="comment">//  Immediately return for objects with zero information space.  Note that</span>
03438     <span class="comment">//  passing this test does not indicate that the file has any recorded space.</span>
03439     <span class="comment">//</span>
03440 
03441     <span class="keywordflow">if</span> (Fcb-&gt;FileSize.QuadPart == 0) {
03442 
03443         <span class="keywordflow">return</span>;
03444     }
03445 
03446     <a class="code" href="../../d9/d7/udfs_2strucsup_8c.html#a22">UdfInitializeAllocationContext</a>( IrpContext,
03447                                     &amp;AllocContext,
03448                                     IcbContext );
03449 
03450     <span class="comment">//</span>
03451     <span class="comment">//  Handle the case of embedded data.</span>
03452     <span class="comment">//</span>
03453 
03454     <span class="keywordflow">if</span> (AllocContext.<a class="code" href="../../d2/d6/struct__ALLOC__ENUM__CONTEXT.html#o2">AllocType</a> == <a class="code" href="../../d0/d7/iso13346_8h.html#a115">ICBTAG_F_ALLOC_IMMEDIATE</a>) {
03455 
03456         <span class="comment">//</span>
03457         <span class="comment">//  Teardown any existing mcb.</span>
03458         <span class="comment">//</span>
03459 
03460         <a class="code" href="../../d9/d7/udfs_2strucsup_8c.html#a16">UdfUninitializeFcbMcb</a>( Fcb );
03461         
03462         <span class="comment">//</span>
03463         <span class="comment">//  Establish a single block mapping to the Icb itself and mark the Fcb as</span>
03464         <span class="comment">//  having embedded data.  Mapping will occur through the Metadata stream.</span>
03465         <span class="comment">//  Note that by virtue of having an Icb here we know it has already had</span>
03466         <span class="comment">//  a mapping established in the Metadata stream, so just retrieve that.</span>
03467         <span class="comment">//</span>
03468 
03469         <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( Fcb-&gt;FcbState, FCB_STATE_EMBEDDED_DATA );
03470 
03471         Fcb-&gt;EmbeddedVsn = <a class="code" href="../../d3/d8/udfprocs_8h.html#a153">UdfLookupMetaVsnOfExtent</a>( IrpContext,
03472                                                      Vcb,
03473                                                      IcbContext-&gt;Active.Partition,
03474                                                      Icb-&gt;<a class="code" href="../../d8/d0/structICBFILE.html#o0">Destag</a>.<a class="code" href="../../d7/d7/structDESTAG.html#o7">Lbn</a>,
03475                                                      <a class="code" href="../../d3/d8/udfprocs_8h.html#a54">BlockSize</a>( Vcb ),
03476                                                      FALSE );
03477         
03478         <span class="comment">//</span>
03479         <span class="comment">//  Note the offset of the data in the Icb.</span>
03480         <span class="comment">//</span>
03481 
03482         Fcb-&gt;EmbeddedOffset = FIELD_OFFSET( <a class="code" href="../../d8/d0/structICBFILE.html">ICBFILE</a>, EAs ) + Icb-&gt;<a class="code" href="../../d8/d0/structICBFILE.html#o18">EALength</a>;
03483 
03484         <span class="comment">//</span>
03485         <span class="comment">//  Check that the information length agrees.</span>
03486         <span class="comment">//</span>
03487 
03488         <span class="keywordflow">if</span> (Icb-&gt;<a class="code" href="../../d8/d0/structICBFILE.html#o19">AllocLength</a> != Fcb-&gt;FileSize.LowPart) {
03489 
03490             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( 0, Dbg, <span class="stringliteral">"UdfInitializeAllocations, embedded alloc %08x != filesize %08x\n"</span>,
03491                          Icb-&gt;<a class="code" href="../../d8/d0/structICBFILE.html#o19">AllocLength</a>,
03492                          Fcb-&gt;FileSize.LowPart ));
03493             <a class="code" href="../../d3/d8/udfprocs_8h.html#a122">UdfRaiseStatus</a>( IrpContext, STATUS_FILE_CORRUPT_ERROR );
03494         }
03495 
03496         <span class="keywordflow">return</span>;
03497     }
03498 
03499     <span class="comment">//</span>
03500     <span class="comment">//  Now initialize the mapping structure for this Fcb.</span>
03501     <span class="comment">//</span>
03502 
03503     <a class="code" href="../../d9/d7/udfs_2strucsup_8c.html#a15">UdfInitializeFcbMcb</a>( Fcb );
03504 
03505     <span class="comment">//</span>
03506     <span class="comment">//  Now walk the chain of allocation descriptors for the object, adding them into the</span>
03507     <span class="comment">//  mapping.</span>
03508     <span class="comment">//</span>
03509 
03510     RunningOffset = 0;
03511 
03512     <span class="keywordflow">do</span> {
03513         
03514         <span class="comment">//</span>
03515         <span class="comment">//  Do file tail consistency checking (4/12.1).  We will have a file body</span>
03516         <span class="comment">//  which is exactly the size of the information length, and a run of allocated</span>
03517         <span class="comment">//  but unrecorded space following.</span>
03518         <span class="comment">//</span>
03519         
03520         <span class="keywordflow">if</span> (Fcb-&gt;FileSize.QuadPart == RunningOffset) {
03521 
03522             InFileTail = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03523         }
03524         
03525         <span class="comment">//</span>
03526         <span class="comment">//  It is impermissible for an interior body extent of an object to not be</span>
03527         <span class="comment">//  an integral multiple of a logical block in size (note that the last</span>
03528         <span class="comment">//  will tend to be).  Also check that the body didn't overshoot the information</span>
03529         <span class="comment">//  length and that the tail descriptor type is correct.</span>
03530         <span class="comment">//</span>
03531         
03532         GenericAd = AllocContext.<a class="code" href="../../d2/d6/struct__ALLOC__ENUM__CONTEXT.html#o1">Alloc</a>;
03533 
03534         <span class="keywordflow">if</span> ((!InFileTail &amp;&amp; (<a class="code" href="../../d3/d8/udfprocs_8h.html#a55">BlockOffset</a>( Vcb, RunningOffset ) ||
03535                              Fcb-&gt;FileSize.QuadPart &lt; RunningOffset)) ||
03536             (InFileTail &amp;&amp; GenericAd-&gt;<a class="code" href="../../d2/d7/structSHORTAD.html#o0">Length</a>.<a class="code" href="../../d7/d3/structNSRLENGTH.html#o1">Type</a> != <a class="code" href="../../d0/d7/iso13346_8h.html#a22">NSRLENGTH_TYPE_UNRECORDED</a>)) {
03537 
03538             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( 0, Dbg, <span class="stringliteral">"UdfInitializeAllocations, InFileTail == %u, bad alloc\n"</span>,
03539                          InFileTail ));
03540             <a class="code" href="../../d3/d8/udfprocs_8h.html#a122">UdfRaiseStatus</a>( IrpContext, STATUS_FILE_CORRUPT_ERROR );
03541         }
03542 
03543         <span class="comment">//</span>
03544         <span class="comment">//  In the file tail we'll just slum along an be a nitpick.  Technically, as a</span>
03545         <span class="comment">//  readonly implementation I don't have to care at all about what is here.</span>
03546         <span class="comment">//</span>
03547             
03548         <span class="keywordflow">if</span> (InFileTail) {
03549             
03550             <span class="keywordflow">continue</span>;
03551         }
03552             
03553         <span class="comment">//</span>
03554         <span class="comment">//  Based on the descriptor type, pull it apart and add the mapping.</span>
03555         <span class="comment">//</span>
03556 
03557         <span class="keywordflow">if</span> (GenericAd-&gt;<a class="code" href="../../d2/d7/structSHORTAD.html#o0">Length</a>.<a class="code" href="../../d7/d3/structNSRLENGTH.html#o1">Type</a> == <a class="code" href="../../d0/d7/iso13346_8h.html#a21">NSRLENGTH_TYPE_RECORDED</a>) {
03558 
03559             <span class="comment">//</span>
03560             <span class="comment">//  Grab the Psn this extent starts at and add the allocation.</span>
03561             <span class="comment">//</span>
03562 
03563             Psn = <a class="code" href="../../d3/d8/udfprocs_8h.html#a152">UdfLookupPsnOfExtent</a>( IrpContext,
03564                                         Vcb,
03565                                         <a class="code" href="../../d9/d7/udfs_2strucsup_8c.html#a14">UdfGetPartitionOfCurrentAllocation</a>( &amp;AllocContext ),
03566                                         GenericAd-&gt;<a class="code" href="../../d2/d7/structSHORTAD.html#o1">Start</a>,
03567                                         GenericAd-&gt;<a class="code" href="../../d2/d7/structSHORTAD.html#o0">Length</a>.<a class="code" href="../../d7/d3/structNSRLENGTH.html#o0">Length</a> );
03568 
03569             Result = <a class="code" href="../../d1/d8/fsrtl_8h.html#a143">FsRtlAddLargeMcbEntry</a>( &amp;Fcb-&gt;Mcb,
03570                                             <a class="code" href="../../d3/d8/udfprocs_8h.html#a40">LlSectorsFromBytes</a>( Vcb, RunningOffset ),
03571                                             Psn,
03572                                             <a class="code" href="../../d3/d8/fsrtlp_8h.html#a13">SectorsFromBytes</a>( Vcb, <a class="code" href="../../d3/d8/fsrtlp_8h.html#a12">SectorAlign</a>( Vcb, GenericAd-&gt;<a class="code" href="../../d2/d7/structSHORTAD.html#o0">Length</a>.<a class="code" href="../../d7/d3/structNSRLENGTH.html#o0">Length</a> ) ));
03573 
03574             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( Result );
03575         }
03576 
03577         RunningOffset += GenericAd-&gt;<a class="code" href="../../d2/d7/structSHORTAD.html#o0">Length</a>.<a class="code" href="../../d7/d3/structNSRLENGTH.html#o0">Length</a>;
03578     
03579     } <span class="keywordflow">while</span> ( <a class="code" href="../../d9/d7/udfs_2strucsup_8c.html#a23">UdfGetNextAllocation</a>( IrpContext, &amp;AllocContext ));
03580 
03581     <span class="comment">//</span>
03582     <span class="comment">//  We must have had body allocation descriptors for the entire file</span>
03583     <span class="comment">//  information length.</span>
03584     <span class="comment">//</span>
03585 
03586     <span class="keywordflow">if</span> (Fcb-&gt;FileSize.QuadPart != RunningOffset) {
03587 
03588         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( 0, Dbg, <span class="stringliteral">"UdfInitializeAllocations, total descriptors != filesize\n"</span> ));
03589         <a class="code" href="../../d3/d8/udfprocs_8h.html#a122">UdfRaiseStatus</a>( IrpContext, STATUS_FILE_CORRUPT_ERROR );
03590     }
03591 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a133" doxytag="udfprocs.h::UdfInitializeCrc16" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID UdfInitializeCrc16           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">ULONG&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Polynomial</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d7/udfdata_8c-source.html#l01083">1083</a> of file <a class="el" href="../../d1/d7/udfdata_8c-source.html">udfdata.c</a>.
<p>
References <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01101">FsRtlAllocatePoolWithTag</a>, <a class="el" href="../../d8/d9/exts_8h-source.html#l00092">n</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00085">PUSHORT</a>, <a class="el" href="../../d2/d6/udfs_2nodetype_8h-source.html#l00159">TAG_CRC_TABLE</a>, <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00202">UdfCrcTable</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00443">UdfPagedPool</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d3/d7/udfinit_8c-source.html#l00183">UdfInitializeGlobalData()</a>.
<p>
<pre class="fragment"><div>01089                    :
01090 
01091     This routine generates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> 16bit CRC Table to be used in CRC calculation.
01092 
01093 Arguments:
01094 
01095     Polynomial - Starting seed <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> generation
01096 
01097 Return Value:
01098 
01099     None
01100 
01101 --*/
01102 
01103 {
01104     ULONG <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a>, i, Crc;
01105 
01106     <span class="comment">//</span>
01107     <span class="comment">//  All CRC code was devised by Don P. Mitchell of AT&amp;T Bell Laboratories</span>
01108     <span class="comment">//  and Ned W. Rhodes of Software Systems Group.  It has been published in</span>
01109     <span class="comment">//  "Design and Validation of Computer Protocols", Prentice Hall, Englewood</span>
01110     <span class="comment">//  Cliffs, NJ, 1991, Chapter 3, ISBN 0-13-539925-4.</span>
01111     <span class="comment">//</span>
01112     <span class="comment">//  Copyright is held by AT&amp;T.</span>
01113     <span class="comment">//</span>
01114     <span class="comment">//  AT&amp;T gives permission for the free use of the source code.</span>
01115     <span class="comment">//</span>
01116 
01117     <a class="code" href="../../d0/d8/udfdata_8c.html#a29">UdfCrcTable</a> = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a22">PUSHORT</a>) <a class="code" href="../../d1/d8/fsrtl_8h.html#a37">FsRtlAllocatePoolWithTag</a>( UdfPagedPool,
01118                                                       256 * <span class="keyword">sizeof</span>(USHORT),
01119                                                       TAG_CRC_TABLE );
01120 
01121     <span class="keywordflow">for</span> (<a class="code" href="../../d7/d0/exts_8h.html#a0">n</a> = 0; <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a> &lt; 256; <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a>++) {
01122 
01123         Crc = <a class="code" href="../../d7/d0/exts_8h.html#a0">n</a> &lt;&lt; 8;
01124 
01125         <span class="keywordflow">for</span> (i = 0; i &lt; 8; i++) {
01126 
01127             <span class="keywordflow">if</span>(Crc &amp; 0x8000) {
01128 
01129                 Crc = (Crc &lt;&lt; 1) ^ Polynomial;
01130 
01131             } <span class="keywordflow">else</span> {
01132 
01133                 Crc &lt;&lt;= 1;
01134             }
01135 
01136             Crc &amp;= 0xffff;
01137         }
01138 
01139         <a class="code" href="../../d0/d8/udfdata_8c.html#a29">UdfCrcTable</a>[<a class="code" href="../../d7/d0/exts_8h.html#a0">n</a>] = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) Crc;
01140     }
01141 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a167" doxytag="udfprocs.h::UdfInitializeDirContext" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID UdfInitializeDirContext           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d5/d5/struct__DIR__ENUM__CONTEXT.html">PDIR_ENUM_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DirContext</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d7/dirsup_8c-source.html#l00060">60</a> of file <a class="el" href="../../d5/d7/dirsup_8c-source.html">dirsup.c</a>.
<p>
References <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00352">ASSERT_IRP_CONTEXT</a>.
<p>
Referenced by <a class="el" href="../../d4/d7/udfs_2create_8c-source.html#l00108">UdfCommonCreate()</a>, <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l00096">UdfInitializeCompoundDirContext()</a>, <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l01003">UdfInitializeEnumeration()</a>, and <a class="el" href="../../d5/d2/fileinfo_8c-source.html#l01232">UdfQueryAlternateNameInfo()</a>.
<p>
<pre class="fragment"><div>00067                    :
00068 
00069     This routine initializes a directory enumeartion context.
00070     
00071     Call <span class="keyword">this</span> exactly once in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> lifetime of a context.
00072 
00073 Arguments:
00074 
00075     DirContext - a context to initialize
00076 
00077 Return Value:
00078 
00079     None.
00080 
00081 --*/
00082 
00083 {
00084     <span class="comment">//</span>
00085     <span class="comment">//  Check inputs.</span>
00086     <span class="comment">//</span>
00087 
00088     <a class="code" href="../../d1/d8/udfdata_8h.html#a28">ASSERT_IRP_CONTEXT</a>( IrpContext );
00089 
00090     <span class="comment">//</span>
00091     <span class="comment">//  Provide defaults for fields, nothing too special.</span>
00092     <span class="comment">//</span>
00093 
00094     RtlZeroMemory( DirContext, <span class="keyword">sizeof</span>(<a class="code" href="../../d5/d5/struct__DIR__ENUM__CONTEXT.html">DIR_ENUM_CONTEXT</a>) );
00095 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a215" doxytag="udfprocs.h::UdfInitializeFcbFromIcbContext" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID UdfInitializeFcbFromIcbContext           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d7/d9/struct__FCB.html">PFCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Fcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d9/d9/struct__ICB__SEARCH__CONTEXT.html">PICB_SEARCH_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IcbContext</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l02297">2297</a> of file <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html">udfs/strucsup.c</a>.
<p>
References <a class="el" href="../../d1/d6/iso13346_8h-source.html#l00955">ICBFILE::AllocLength</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00338">ASSERT_FCB</a>, <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00352">ASSERT_IRP_CONTEXT</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00278">BlockSize</a>, <a class="el" href="../../d1/d6/iso13346_8h-source.html#l00936">ICBFILE::Destag</a>, <a class="el" href="../../d1/d6/iso13346_8h-source.html#l00339">DESTAG_ID_NSR_FILE</a>, <a class="el" href="../../d6/d8/udfstruc_8h.html#a108">EA_SEARCH_CONTEXT</a>, <a class="el" href="../../d1/d6/iso13346_8h-source.html#l00954">ICBFILE::EALength</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01062">FCB_STATE_IN_FCB_TABLE</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01061">FCB_STATE_INITIALIZED</a>, <a class="el" href="../../d1/d6/iso13346_8h-source.html#l00847">ICBTAG::FileType</a>, <a class="el" href="../../d1/d6/iso13346_8h-source.html#l00937">ICBFILE::Icbtag</a>, <a class="el" href="../../d1/d6/iso13346_8h-source.html#l00868">ICBTAG_FILE_T_DIRECTORY</a>, <a class="el" href="../../d1/d6/iso13346_8h-source.html#l00869">ICBTAG_FILE_T_FILE</a>, <a class="el" href="../../d1/d6/iso13346_8h-source.html#l00304">DESTAG::Ident</a>, <a class="el" href="../../d1/d6/iso13346_8h-source.html#l00945">ICBFILE::InfoLength</a>, <a class="el" href="../../d1/d6/iso13346_8h-source.html#l00941">ICBFILE::LinkCount</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00248">LlBlockAlign</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00160">LongOffset</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00505">SetFlag</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l03388">UdfInitializeAllocations()</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l00136">UdfInsertFcbTable</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01567">UdfLockFcb</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00406">UdfRaiseStatus()</a>, <a class="el" href="../../d2/d6/udfs_2nodetype_8h-source.html#l00038">UDFS_NTC_FCB_DATA</a>, <a class="el" href="../../d2/d6/udfs_2nodetype_8h-source.html#l00037">UDFS_NTC_FCB_INDEX</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01577">UdfUnlockFcb</a>, and <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l03595">UdfUpdateTimestampsFromIcbContext()</a>.
<p>
Referenced by <a class="el" href="../../d4/d7/udfs_2create_8c-source.html#l01244">UdfOpenObjectByFileId()</a>, <a class="el" href="../../d4/d7/udfs_2create_8c-source.html#l01632">UdfOpenObjectFromDirContext()</a>, and <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l00997">UdfUpdateVcbPhase1()</a>.
<p>
<pre class="fragment"><div>02305                    :
02306 
02307     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called to initialize an Fcb from a direct ICB.  It should
02308     <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> be called once in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> lifetime of an Fcb and will fill in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Mcb
02309     from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> chained allocation descriptors of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ICB.
02310 
02311 Arguments:
02312 
02313     Fcb - The Fcb being initialized
02314 
02315     IcbOontext - An search context containing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> active direct ICB <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object
02316 
02317 Return Value:
02318 
02319     None.
02320 
02321 --*/
02322 
02323 {
02324     <a class="code" href="../../d6/d1/struct__EA__SEARCH__CONTEXT.html">EA_SEARCH_CONTEXT</a> EaContext;
02325     <a class="code" href="../../d8/d0/structICBFILE.html">PICBFILE</a> Icb;
02326 
02327     <a class="code" href="../../d7/d5/struct__VCB.html">PVCB</a> Vcb;
02328 
02329     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02330 
02331     <span class="comment">//</span>
02332     <span class="comment">//  Check inputs</span>
02333     <span class="comment">//</span>
02334 
02335     <a class="code" href="../../d1/d8/udfdata_8h.html#a28">ASSERT_IRP_CONTEXT</a>( IrpContext );
02336     <a class="code" href="../../d1/d8/udfdata_8h.html#a14">ASSERT_FCB</a>( Fcb );
02337 
02338     <span class="comment">//</span>
02339     <span class="comment">//  Directly reference for convenience</span>
02340     <span class="comment">//</span>
02341 
02342     Icb = IcbContext-&gt;Active.View;
02343     Vcb = Fcb-&gt;Vcb;
02344 
02345     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( IcbContext-&gt;IcbType == DESTAG_ID_NSR_FILE &amp;&amp; Icb-&gt;<a class="code" href="../../d8/d0/structICBFILE.html#o0">Destag</a>.<a class="code" href="../../d7/d7/structDESTAG.html#o0">Ident</a> == DESTAG_ID_NSR_FILE );
02346     
02347     <span class="comment">//</span>
02348     <span class="comment">//  Check that the full indicated size of the direct entry is sane and</span>
02349     <span class="comment">//  that the length of the EA segment is correctly aligned.  A direct</span>
02350     <span class="comment">//  entry is less than a single logical block in size.</span>
02351     <span class="comment">//</span>
02352     
02353     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/udfprocs_8h.html#a24">LongOffset</a>( Icb-&gt;<a class="code" href="../../d8/d0/structICBFILE.html#o18">EALength</a> ) ||
02354         FIELD_OFFSET( <a class="code" href="../../d8/d0/structICBFILE.html">ICBFILE</a>, EAs ) + Icb-&gt;<a class="code" href="../../d8/d0/structICBFILE.html#o18">EALength</a> + Icb-&gt;<a class="code" href="../../d8/d0/structICBFILE.html#o19">AllocLength</a> &gt; <a class="code" href="../../d3/d8/udfprocs_8h.html#a54">BlockSize</a>( IcbContext-&gt;Vcb )) {
02355 
02356         <a class="code" href="../../d3/d8/udfprocs_8h.html#a122">UdfRaiseStatus</a>( IrpContext, STATUS_FILE_CORRUPT_ERROR );
02357     }
02358 
02359     <a class="code" href="../../d3/d8/udfprocs_8h.html#a90">UdfLockFcb</a>( IrpContext, Fcb );
02360 
02361     <span class="comment">//</span>
02362     <span class="comment">//  Try-finally for cleanup.</span>
02363     <span class="comment">//</span>
02364 
02365     <span class="keywordflow">try</span> {
02366         
02367         <span class="comment">//</span>
02368         <span class="comment">//  Verify that the types mesh and set state flags.</span>
02369         <span class="comment">//</span>
02370     
02371         <span class="keywordflow">if</span> (Fcb-&gt;NodeTypeCode == <a class="code" href="../../d1/d7/udfs_2nodetype_8h.html#a3">UDFS_NTC_FCB_INDEX</a> &amp;&amp; Icb-&gt;<a class="code" href="../../d8/d0/structICBFILE.html#o1">Icbtag</a>.<a class="code" href="../../d1/d1/structICBTAG.html#o5">FileType</a> == <a class="code" href="../../d0/d7/iso13346_8h.html#a102">ICBTAG_FILE_T_DIRECTORY</a>) {
02372     
02373             <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( Fcb-&gt;FileAttributes, FILE_ATTRIBUTE_DIRECTORY );
02374         
02375         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!(Fcb-&gt;NodeTypeCode == <a class="code" href="../../d1/d7/udfs_2nodetype_8h.html#a4">UDFS_NTC_FCB_DATA</a> &amp;&amp; Icb-&gt;<a class="code" href="../../d8/d0/structICBFILE.html#o1">Icbtag</a>.<a class="code" href="../../d1/d1/structICBTAG.html#o5">FileType</a> == <a class="code" href="../../d0/d7/iso13346_8h.html#a103">ICBTAG_FILE_T_FILE</a>)) {
02376     
02377             <a class="code" href="../../d3/d8/udfprocs_8h.html#a122">UdfRaiseStatus</a>( IrpContext, STATUS_FILE_CORRUPT_ERROR );
02378         }
02379     
02380         <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( Fcb-&gt;FileAttributes, FILE_ATTRIBUTE_READONLY );
02381         
02382         <span class="comment">//</span>
02383         <span class="comment">//  Initialize the common header in the Fcb.</span>
02384         <span class="comment">//</span>
02385     
02386         Fcb-&gt;Resource = &amp;Fcb-&gt;Vcb-&gt;FileResource;
02387     
02388         <span class="comment">//</span>
02389         <span class="comment">//  Size and lookup all allocations for this object.</span>
02390         <span class="comment">//</span>
02391     
02392         Fcb-&gt;AllocationSize.QuadPart = <a class="code" href="../../d3/d8/udfprocs_8h.html#a46">LlBlockAlign</a>( Vcb, Icb-&gt;<a class="code" href="../../d8/d0/structICBFILE.html#o9">InfoLength</a> );
02393     
02394         Fcb-&gt;FileSize.QuadPart =
02395         Fcb-&gt;ValidDataLength.QuadPart = Icb-&gt;<a class="code" href="../../d8/d0/structICBFILE.html#o9">InfoLength</a>;
02396     
02397         <a class="code" href="../../d3/d8/udfprocs_8h.html#a225">UdfInitializeAllocations</a>( IrpContext,
02398                                   Fcb,
02399                                   IcbContext );
02400 
02401         <span class="comment">//</span>
02402         <span class="comment">//  Lift all of the timestamps for this guy.</span>
02403         <span class="comment">//</span>
02404         
02405         <a class="code" href="../../d3/d8/udfprocs_8h.html#a226">UdfUpdateTimestampsFromIcbContext</a>( IrpContext,
02406                                            IcbContext,
02407                                            &amp;Fcb-&gt;Timestamps );
02408 
02409         <span class="comment">//</span>
02410         <span class="comment">//  Pick up the link count.</span>
02411         <span class="comment">//</span>
02412 
02413         Fcb-&gt;LinkCount = Icb-&gt;<a class="code" href="../../d8/d0/structICBFILE.html#o5">LinkCount</a>;
02414     
02415         <span class="comment">//</span>
02416         <span class="comment">//  Link into the Fcb table.  Someone else is responsible for the name linkage, which is</span>
02417         <span class="comment">//  all that remains.  We also note that the Fcb is fully initialized at this point.</span>
02418         <span class="comment">//</span>
02419     
02420         <a class="code" href="../../d9/d7/udfs_2strucsup_8c.html#a10">UdfInsertFcbTable</a>( IrpContext, Fcb );
02421         <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( Fcb-&gt;FcbState, FCB_STATE_IN_FCB_TABLE | FCB_STATE_INITIALIZED );
02422 
02423     } finally {
02424 
02425         <a class="code" href="../../d3/d8/udfprocs_8h.html#a91">UdfUnlockFcb</a>( IrpContext, Fcb );
02426     }
02427 
02428     <span class="keywordflow">return</span>;
02429 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a221" doxytag="udfprocs.h::UdfInitializeIcbContext" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID UdfInitializeIcbContext           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d9/d9/struct__ICB__SEARCH__CONTEXT.html">PICB_SEARCH_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IcbContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d7/d5/struct__VCB.html">PVCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Vcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IcbType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Partition</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Lbn</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l03060">3060</a> of file <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html">udfs/strucsup.c</a>.
<p>
References <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00352">ASSERT_IRP_CONTEXT</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d9/d1/udfs_2cachesup_8c-source.html#l00337">UdfMapMetadataView()</a>.
<p>
Referenced by <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l01688">UdfLookupFileEntryInEnumeration()</a>.
<p>
<pre class="fragment"><div>03072                    :
03073 
03074     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called to initialize a context to search an Icb hierarchy.
03075 
03076 Arguments:
03077 
03078     Vcb - Vcb <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> volume.
03079     
03080     IcbType - Type of direct entry we expect to find (DESTAG_ID...)
03081     
03082     Partition - partition of the hierarchy.
03083     
03084     Lbn - lbn of the hierarchy.
03085     
03086     Length - length of the root extent of the hierarchy.
03087 
03088 Return Value:
03089 
03090     None.
03091 
03092 --*/
03093 
03094 {
03095     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03096 
03097     <span class="comment">//</span>
03098     <span class="comment">//  Check input parameters.</span>
03099     <span class="comment">//</span>
03100 
03101     <a class="code" href="../../d1/d8/udfdata_8h.html#a28">ASSERT_IRP_CONTEXT</a>( IrpContext );
03102 
03103     RtlZeroMemory( IcbContext, <span class="keyword">sizeof</span>( <a class="code" href="../../d9/d9/struct__ICB__SEARCH__CONTEXT.html">ICB_SEARCH_CONTEXT</a> ));
03104 
03105     IcbContext-&gt;Vcb = Vcb;
03106     IcbContext-&gt;IcbType = IcbType;
03107     
03108     <span class="comment">//</span>
03109     <span class="comment">//  Map the first extent into the current slot.</span>
03110     <span class="comment">//</span>
03111 
03112     <a class="code" href="../../d8/d2/udfs_2cachesup_8c.html#a5">UdfMapMetadataView</a>( IrpContext,
03113                         &amp;IcbContext-&gt;Current,
03114                         Vcb,
03115                         Partition,
03116                         Lbn,
03117                         Length );
03118     <span class="keywordflow">return</span>;
03119 
03120 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a220" doxytag="udfprocs.h::UdfInitializeIcbContextFromFcb" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID UdfInitializeIcbContextFromFcb           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d9/d9/struct__ICB__SEARCH__CONTEXT.html">PICB_SEARCH_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IcbContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d7/d9/struct__FCB.html">PFCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Fcb</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l02951">2951</a> of file <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html">udfs/strucsup.c</a>.
<p>
References <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00338">ASSERT_FCB</a>, <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00352">ASSERT_IRP_CONTEXT</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00278">BlockSize</a>, <a class="el" href="../../d1/d6/iso13346_8h-source.html#l00936">ICBFILE::Destag</a>, <a class="el" href="../../d1/d6/iso13346_8h-source.html#l00339">DESTAG_ID_NSR_FILE</a>, <a class="el" href="../../d1/d6/iso13346_8h-source.html#l00337">DESTAG_ID_NSR_ICBIND</a>, <a class="el" href="../../d1/d6/iso13346_8h-source.html#l00338">DESTAG_ID_NSR_ICBTRM</a>, <a class="el" href="../../d1/d6/iso13346_8h-source.html#l00343">DESTAG_ID_NSR_PINTEG</a>, <a class="el" href="../../d1/d6/iso13346_8h-source.html#l00341">DESTAG_ID_NSR_UASE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d6/iso13346_8h-source.html#l00937">ICBFILE::Icbtag</a>, <a class="el" href="../../d1/d6/iso13346_8h-source.html#l00304">DESTAG::Ident</a>, <a class="el" href="../../d1/d6/iso13346_8h-source.html#l00845">ICBTAG::MaxEntries</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01460">UdfGetFidLbn</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01461">UdfGetFidPartition</a>, <a class="el" href="../../d9/d1/udfs_2cachesup_8c-source.html#l00337">UdfMapMetadataView()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00406">UdfRaiseStatus()</a>, and <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l02617">UdfVerifyDescriptor()</a>.
<p>
Referenced by <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l01688">UdfLookupFileEntryInEnumeration()</a>, <a class="el" href="../../d4/d7/udfs_2create_8c-source.html#l01244">UdfOpenObjectByFileId()</a>, <a class="el" href="../../d4/d7/udfs_2create_8c-source.html#l01632">UdfOpenObjectFromDirContext()</a>, and <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l00997">UdfUpdateVcbPhase1()</a>.
<p>
<pre class="fragment"><div>02959                    :
02960 
02961     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called to initialize a context to search <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Icb hierarchy
02962     associated with an Fcb.
02963 
02964 Arguments:
02965 
02966     Fcb - Fcb associated with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> hierarchy to search.
02967 
02968 Return Value:
02969 
02970     None.
02971 
02972 --*/
02973 
02974 {
02975     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02976 
02977     <span class="comment">//</span>
02978     <span class="comment">//  Check input parameters.</span>
02979     <span class="comment">//</span>
02980 
02981     <a class="code" href="../../d1/d8/udfdata_8h.html#a28">ASSERT_IRP_CONTEXT</a>( IrpContext );
02982     <a class="code" href="../../d1/d8/udfdata_8h.html#a14">ASSERT_FCB</a>( Fcb );
02983 
02984     RtlZeroMemory( IcbContext, <span class="keyword">sizeof</span>( <a class="code" href="../../d9/d9/struct__ICB__SEARCH__CONTEXT.html">ICB_SEARCH_CONTEXT</a> ));
02985 
02986     IcbContext-&gt;Vcb = Fcb-&gt;Vcb;
02987     IcbContext-&gt;IcbType = <a class="code" href="../../d0/d7/iso13346_8h.html#a54">DESTAG_ID_NSR_FILE</a>;
02988     
02989     <span class="comment">//</span>
02990     <span class="comment">//  It is possible that we don't have an idea what the length of the root extent is.</span>
02991     <span class="comment">//  This will commonly happen in the OpenById case.</span>
02992     <span class="comment">//</span>
02993     
02994     <span class="keywordflow">if</span> (Fcb-&gt;RootExtentLength == 0) {
02995 
02996         <a class="code" href="../../d8/d0/structICBFILE.html">PICBFILE</a> Icb;
02997 
02998         <span class="comment">//</span>
02999         <span class="comment">//  We have to lift the first entry from this (possibly bogus!) extent</span>
03000         <span class="comment">//  and find out how many entries can be recorded, then unmap/remap the view</span>
03001         <span class="comment">//  to try to get the extent.</span>
03002         <span class="comment">//</span>
03003 
03004         <a class="code" href="../../d3/d8/udfprocs_8h.html#a157">UdfMapMetadataView</a>( IrpContext,
03005                             &amp;IcbContext-&gt;Current,
03006                             IcbContext-&gt;Vcb,
03007                             <a class="code" href="../../d6/d8/udfstruc_8h.html#a46">UdfGetFidPartition</a>( Fcb-&gt;FileId ),
03008                             <a class="code" href="../../d6/d8/udfstruc_8h.html#a45">UdfGetFidLbn</a>( Fcb-&gt;FileId ),
03009                             <a class="code" href="../../d3/d8/udfprocs_8h.html#a54">BlockSize</a>( IcbContext-&gt;Vcb ));
03010 
03011         Icb = IcbContext-&gt;Current.View;
03012         
03013         <span class="comment">//</span>
03014         <span class="comment">//  We can only accomplish the guess if we have a descriptor which contains an ICB</span>
03015         <span class="comment">//  Tag, which contains a field that can tell us what we need to know.</span>
03016         <span class="comment">//</span>
03017         
03018         <span class="keywordflow">if</span> (Icb-&gt;<a class="code" href="../../d8/d0/structICBFILE.html#o0">Destag</a>.<a class="code" href="../../d7/d7/structDESTAG.html#o0">Ident</a> == <a class="code" href="../../d0/d7/iso13346_8h.html#a52">DESTAG_ID_NSR_ICBIND</a> ||
03019             Icb-&gt;<a class="code" href="../../d8/d0/structICBFILE.html#o0">Destag</a>.<a class="code" href="../../d7/d7/structDESTAG.html#o0">Ident</a> == <a class="code" href="../../d0/d7/iso13346_8h.html#a53">DESTAG_ID_NSR_ICBTRM</a> ||
03020             Icb-&gt;<a class="code" href="../../d8/d0/structICBFILE.html#o0">Destag</a>.<a class="code" href="../../d7/d7/structDESTAG.html#o0">Ident</a> == <a class="code" href="../../d0/d7/iso13346_8h.html#a54">DESTAG_ID_NSR_FILE</a> ||
03021             Icb-&gt;<a class="code" href="../../d8/d0/structICBFILE.html#o0">Destag</a>.<a class="code" href="../../d7/d7/structDESTAG.html#o0">Ident</a> == <a class="code" href="../../d0/d7/iso13346_8h.html#a56">DESTAG_ID_NSR_UASE</a> ||
03022             Icb-&gt;<a class="code" href="../../d8/d0/structICBFILE.html#o0">Destag</a>.<a class="code" href="../../d7/d7/structDESTAG.html#o0">Ident</a> == <a class="code" href="../../d0/d7/iso13346_8h.html#a58">DESTAG_ID_NSR_PINTEG</a>) {
03023         
03024             <a class="code" href="../../d3/d8/udfprocs_8h.html#a219">UdfVerifyDescriptor</a>( IrpContext,
03025                                  &amp;Icb-&gt;<a class="code" href="../../d8/d0/structICBFILE.html#o0">Destag</a>,
03026                                  Icb-&gt;<a class="code" href="../../d8/d0/structICBFILE.html#o0">Destag</a>.<a class="code" href="../../d7/d7/structDESTAG.html#o0">Ident</a>,
03027                                  <a class="code" href="../../d3/d8/udfprocs_8h.html#a54">BlockSize</a>( IcbContext-&gt;Vcb ),
03028                                  <a class="code" href="../../d6/d8/udfstruc_8h.html#a45">UdfGetFidLbn</a>( Fcb-&gt;FileId ),
03029                                  FALSE );
03030         } <span class="keywordflow">else</span> {
03031 
03032             <a class="code" href="../../d3/d8/udfprocs_8h.html#a122">UdfRaiseStatus</a>( IrpContext, STATUS_FILE_CORRUPT_ERROR );
03033         }
03034 
03035         <span class="comment">//</span>
03036         <span class="comment">//  Now the MaxEntries (4/14.6.4) field of the Icb Tag should tell us how big the extent</span>
03037         <span class="comment">//  should be.  The tail of this could be unrecorded.  We could even have landed in the middle</span>
03038         <span class="comment">//  of an extent.  This is only a guess.  For whatever reason we are having to guess this</span>
03039         <span class="comment">//  information, any results are expected to be coming with few guarantees.</span>
03040         <span class="comment">//</span>
03041 
03042         Fcb-&gt;RootExtentLength = Icb-&gt;<a class="code" href="../../d8/d0/structICBFILE.html#o1">Icbtag</a>.<a class="code" href="../../d1/d1/structICBTAG.html#o3">MaxEntries</a> * <a class="code" href="../../d3/d8/udfprocs_8h.html#a54">BlockSize</a>( IcbContext-&gt;Vcb );
03043     }
03044     
03045     <span class="comment">//</span>
03046     <span class="comment">//  Map the first extent into the current slot.</span>
03047     <span class="comment">//</span>
03048 
03049     <a class="code" href="../../d3/d8/udfprocs_8h.html#a157">UdfMapMetadataView</a>( IrpContext,
03050                         &amp;IcbContext-&gt;Current,
03051                         IcbContext-&gt;Vcb,
03052                         <a class="code" href="../../d6/d8/udfstruc_8h.html#a46">UdfGetFidPartition</a>( Fcb-&gt;FileId ),
03053                         <a class="code" href="../../d6/d8/udfstruc_8h.html#a45">UdfGetFidLbn</a>( Fcb-&gt;FileId ),
03054                         Fcb-&gt;RootExtentLength );
03055     <span class="keywordflow">return</span>;
03056 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a193" doxytag="udfprocs.h::UdfInitializeLcbFromDirContext" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID UdfInitializeLcbFromDirContext           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d5/d9/struct__LCB.html">PLCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Lcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d5/d5/struct__DIR__ENUM__CONTEXT.html">PDIR_ENUM_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DirContext</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d3/prefxsup_8c-source.html#l00503">503</a> of file <a class="el" href="../../d6/d3/prefxsup_8c-source.html">prefxsup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00352">ASSERT_IRP_CONTEXT</a>, <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00350">ASSERT_LCB</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d1/d6/iso13346_8h-source.html#l00810">NSR_FID_F_HIDDEN</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d6/d8/udfstruc_8h.html#a113">PDIR_ENUM_CONTEXT</a>, and <a class="el" href="../../d6/d4/cc_8h-source.html#l00505">SetFlag</a>.
<p>
Referenced by <a class="el" href="../../d4/d7/udfs_2create_8c-source.html#l01632">UdfOpenObjectFromDirContext()</a>.
<p>
<pre class="fragment"><div>00511                    :
00512 
00513     This routine performs common initialization of Lcbs from found directory
00514     entries.
00515 
00516 Arguments:
00517 
00518     Lcb - <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Lcb to initialize.
00519     
00520     DirContext - <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> directory enumeration context, enumerated to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> FID associated
00521         with <span class="keyword">this</span> Lcb.
00522     
00523 Return Value:
00524 
00525     None.
00526 
00527 --*/
00528 
00529 {
00530     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00531 
00532     <span class="comment">//</span>
00533     <span class="comment">//  Check inputs.</span>
00534     <span class="comment">//</span>
00535 
00536     <a class="code" href="../../d1/d8/udfdata_8h.html#a28">ASSERT_IRP_CONTEXT</a>( IrpContext );
00537     <a class="code" href="../../d1/d8/udfdata_8h.html#a26">ASSERT_LCB</a>( Lcb );
00538 
00539     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( DirContext-&gt;Fid != NULL );
00540 
00541     <span class="comment">//</span>
00542     <span class="comment">//  This is falling down trivial now.  Simply update the hidden flag in the Lcb.</span>
00543     <span class="comment">//</span>
00544 
00545     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( DirContext-&gt;Fid-&gt;Flags, NSR_FID_F_HIDDEN )) {
00546 
00547         <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( Lcb-&gt;FileAttributes, FILE_ATTRIBUTE_HIDDEN );
00548     }
00549 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a148" doxytag="udfprocs.h::UdfInitializePcb" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS UdfInitializePcb           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d7/d5/struct__VCB.html">PVCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Vcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT <a class="el" href="../../d4/d9/struct__PCB.html">PPCB</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>Pcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d6/d2/structNSR__LVOL.html">PNSR_LVOL</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>LVD</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d5/allocsup_8c-source.html#l00367">367</a> of file <a class="el" href="../../d3/d5/allocsup_8c-source.html">allocsup.c</a>.
<p>
References <a class="el" href="../../d3/d6/notify_8c-source.html#l00236">Add2Ptr</a>, <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00349">ASSERT_OPTIONAL_PCB</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01101">FsRtlAllocatePoolWithTag</a>, <a class="el" href="../../d1/d6/iso13346_8h-source.html#l00558">ISONsrLvolSize</a>, <a class="el" href="../../d0/d7/udf_8h-source.html#l00356">_PARTMAP_UDF_GENERIC::Length</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d5/d8/ex_8h.html#a329a174">PagedPool</a>, <a class="el" href="../../d0/d7/udf_8h-source.html#l00358">_PARTMAP_UDF_GENERIC::PartID</a>, <a class="el" href="../../d0/d7/udf_8h-source.html#l00410">_PARTMAP_SPARABLE::Partition</a>, <a class="el" href="../../d0/d7/udf_8h-source.html#l00379">_PARTMAP_VIRTUAL::Partition</a>, <a class="el" href="../../d1/d6/iso13346_8h-source.html#l00591">PARTMAP_PHYSICAL::Partition</a>, <a class="el" href="../../d4/d9/arcinst_8h.html#a46">PARTITION</a>, <a class="el" href="../../d5/d8/arcinst_8h-source.html#l00385">_tagPARTITION::PartitionNumber</a>, <a class="el" href="../../d9/d7/udf_8h.html#a72">PARTMAP_SPARABLE</a>, <a class="el" href="../../d1/d6/iso13346_8h-source.html#l00576">PARTMAP_TYPE_PHYSICAL</a>, <a class="el" href="../../d1/d6/iso13346_8h-source.html#l00577">PARTMAP_TYPE_PROXY</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00443">PCB_FLAG_PHYSICAL_PARTITION</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00445">PCB_FLAG_SPARABLE_PARTITION</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00444">PCB_FLAG_VIRTUAL_PARTITION</a>, <a class="el" href="../../d6/d8/udfstruc_8h.html#a129a115">Physical</a>, <a class="el" href="../../d0/d7/iso13346_8h.html#a216">PNSR_LVOL</a>, <a class="el" href="../../d0/d7/iso13346_8h.html#a220">PPARTMAP_PHYSICAL</a>, <a class="el" href="../../d9/d7/udf_8h.html#a73">PPARTMAP_SPARABLE</a>, <a class="el" href="../../d9/d7/udf_8h.html#a69">PPARTMAP_UDF_GENERIC</a>, <a class="el" href="../../d9/d7/udf_8h.html#a71">PPARTMAP_VIRTUAL</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00505">SetFlag</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d2/d6/udfs_2nodetype_8h-source.html#l00177">TAG_NSR_FSD</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d0/d7/udf_8h-source.html#l00355">_PARTMAP_UDF_GENERIC::Type</a>, <a class="el" href="../../d0/d7/udf_8h-source.html#l00141">UDF_VERSION_150</a>, <a class="el" href="../../d0/d7/udf_8h-source.html#l00143">UDF_VERSION_RECOGNIZED</a>, <a class="el" href="../../d3/d5/allocsup_8c-source.html#l01357">UdfCreatePcb()</a>, <a class="el" href="../../d3/d5/allocsup_8c-source.html#l00309">UdfDeletePcb()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l02027">UdfDomainIdentifierContained()</a>, <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00135">UdfSparablePartitionDomainIdentifier</a>, <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00114">UdfVirtualPartitionDomainIdentifier</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>, <a class="el" href="../../d6/d8/alpha_2exdsptch_8c-source.html#l00105">Virtual</a>, <a class="el" href="../../d0/d7/udf_8h-source.html#l00409">_PARTMAP_SPARABLE::VolSetSeq</a>, and <a class="el" href="../../d1/d6/iso13346_8h-source.html#l00590">PARTMAP_PHYSICAL::VolSetSeq</a>.
<p>
Referenced by <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l02832">UdfFindVolumeDescriptors()</a>.
<p>
<pre class="fragment"><div>00376                    :
00377 
00378     This routine walks through <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> partition map of a Logical Volume Descriptor
00379     and builds an intializing Pcb from <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>.  The Pcb will be ready to be used
00380     in searching <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> partition descriptors of a volume.
00381 
00382 Arguments:
00383 
00384     Vcb - The volume <span class="keyword">this</span> Pcb will pertain to
00385 
00386     Pcb - Caller's pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Pcb
00387 
00388     LVD - The Logical Volume Descriptor being used
00389 
00390 Return Value:
00391 
00392     STATUS_SUCCESS <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> partition map <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> good and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Pcb <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> built
00393 
00394     STATUS_DISK_CORRUPT_ERROR <span class="keywordflow">if</span> corrupt maps are found
00395 
00396     STATUS_UNRECOGNIZED_VOLUME <span class="keywordflow">if</span> noncompliant maps are found
00397 
00398 --*/
00399 
00400 {
00401     <a class="code" href="../../d0/d9/struct__PARTMAP__UDF__GENERIC.html">PPARTMAP_UDF_GENERIC</a> Map;
00402     <a class="code" href="../../d2/d9/struct__tagPARTITION.html">PPARTITION</a> Partition;
00403 
00404     BOOLEAN Found;
00405 
00406     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00407 
00408     <span class="comment">//</span>
00409     <span class="comment">//  Check the input parameters</span>
00410     <span class="comment">//</span>
00411 
00412     <a class="code" href="../../d1/d8/udfdata_8h.html#a25">ASSERT_OPTIONAL_PCB</a>( *Pcb );
00413 
00414     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( +1, Dbg,
00415                  <span class="stringliteral">"UdfInitializePcb, Lvd %08x\n"</span>,
00416                  LVD ));
00417 
00418     <span class="comment">//</span>
00419     <span class="comment">//  Delete a pre-existing (partially initialized from a failed</span>
00420     <span class="comment">//  crawl of a VDS) Pcb.</span>
00421     <span class="comment">//</span>
00422 
00423     <span class="keywordflow">if</span> (*Pcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00424 
00425         <a class="code" href="../../d3/d8/udfprocs_8h.html#a147">UdfDeletePcb</a>( *Pcb );
00426         *Pcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00427     }
00428 
00429     *Pcb = <a class="code" href="../../d2/d6/allocsup_8c.html#a2">UdfCreatePcb</a>( LVD-&gt;MapTableCount );
00430 
00431     <span class="comment">//</span>
00432     <span class="comment">//  Walk the table of partition maps intializing the Pcb for the descriptor</span>
00433     <span class="comment">//  initialization pass.</span>
00434     <span class="comment">//</span>
00435 
00436     <span class="keywordflow">for</span> (Map = (<a class="code" href="../../d0/d9/struct__PARTMAP__UDF__GENERIC.html">PPARTMAP_UDF_GENERIC</a>) LVD-&gt;MapTable,
00437          Partition = (*Pcb)-&gt;Partition;
00438 
00439          Partition &lt; &amp;(*Pcb)-&gt;Partition[(*Pcb)-&gt;Partitions];
00440 
00441          Map = <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( Map, Map-&gt;<a class="code" href="../../d0/d9/struct__PARTMAP__UDF__GENERIC.html#o1">Length</a>, <a class="code" href="../../d0/d9/struct__PARTMAP__UDF__GENERIC.html">PPARTMAP_UDF_GENERIC</a> ),
00442          Partition++) {
00443 
00444         <span class="comment">//</span>
00445         <span class="comment">//  Now check that this LVD can actually contain this map entry.  First check that</span>
00446         <span class="comment">//  the descriptor can contain the first few fields, then check that it can hold</span>
00447         <span class="comment">//  all of the bytes claimed by the descriptor.</span>
00448         <span class="comment">//</span>
00449 
00450         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( Map, <span class="keyword">sizeof</span>( <a class="code" href="../../d9/d3/structPARTMAP__GENERIC.html">PARTMAP_GENERIC</a> ), PCHAR ) &gt; <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( LVD, <a class="code" href="../../d0/d7/iso13346_8h.html#a80">ISONsrLvolSize</a>( LVD ), PCHAR ) ||
00451             <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( Map, Map-&gt;<a class="code" href="../../d0/d9/struct__PARTMAP__UDF__GENERIC.html#o1">Length</a>,               PCHAR ) &gt; <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( LVD, <a class="code" href="../../d0/d7/iso13346_8h.html#a80">ISONsrLvolSize</a>( LVD ), PCHAR )) {
00452 
00453             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( 0, Dbg,
00454                          <span class="stringliteral">"UdfInitializePcb, map at +%04x beyond Lvd size %04x\n"</span>,
00455                          (PCHAR) Map - (PCHAR) LVD,
00456                          <a class="code" href="../../d0/d7/iso13346_8h.html#a80">ISONsrLvolSize</a>( LVD )));
00457 
00458             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( -1, Dbg,
00459                          <span class="stringliteral">"UdfInitializePcb -&gt; STATUS_DISK_CORRUPT_ERROR\n"</span> ));
00460 
00461             <span class="keywordflow">return</span> STATUS_DISK_CORRUPT_ERROR;
00462         }
00463 
00464         <span class="comment">//</span>
00465         <span class="comment">//  Now load up this map entry.</span>
00466         <span class="comment">//</span>
00467 
00468         <span class="keywordflow">switch</span> (Map-&gt;<a class="code" href="../../d0/d9/struct__PARTMAP__UDF__GENERIC.html#o0">Type</a>) {
00469 
00470             <span class="keywordflow">case</span> <a class="code" href="../../d0/d7/iso13346_8h.html#a82">PARTMAP_TYPE_PHYSICAL</a>:
00471 
00472                 {
00473                     <a class="code" href="../../d0/d4/structPARTMAP__PHYSICAL.html">PPARTMAP_PHYSICAL</a> MapPhysical = (<a class="code" href="../../d0/d4/structPARTMAP__PHYSICAL.html">PPARTMAP_PHYSICAL</a>) Map;
00474 
00475                     <span class="comment">//</span>
00476                     <span class="comment">//  Type 1 - Physical Partition</span>
00477                     <span class="comment">//</span>
00478 
00479                     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( 0, Dbg,
00480                                  <span class="stringliteral">"UdfInitializePcb, map reference %02x is Physical (Partition # %08x)\n"</span>,
00481                                  (Partition - (*Pcb)-&gt;Partition)/<span class="keyword">sizeof</span>(<a class="code" href="../../d2/d9/struct__tagPARTITION.html">PARTITION</a>),
00482                                  MapPhysical-&gt;<a class="code" href="../../d0/d4/structPARTMAP__PHYSICAL.html#o3">Partition</a> ));
00483 
00484                     <span class="comment">//</span>
00485                     <span class="comment">//  It must be the case that the volume the partition is on is the first</span>
00486                     <span class="comment">//  one since we only do single disc UDF.  This will have already been</span>
00487                     <span class="comment">//  checked by the caller.</span>
00488                     <span class="comment">//</span>
00489 
00490                     <span class="keywordflow">if</span> (MapPhysical-&gt;<a class="code" href="../../d0/d4/structPARTMAP__PHYSICAL.html#o2">VolSetSeq</a> &gt; 1) {
00491 
00492                         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( 0, Dbg,
00493                                      <span class="stringliteral">"UdfInitializePcb, ... but physical partition resides on volume set volume # %08x (&gt; 1)!\n"</span>,
00494                                      MapPhysical-&gt;<a class="code" href="../../d0/d4/structPARTMAP__PHYSICAL.html#o2">VolSetSeq</a> ));
00495 
00496                         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( -1, Dbg,
00497                                      <span class="stringliteral">"UdfInitializePcb -&gt; STATUS_DISK_CORRUPT_ERROR\n"</span> ));
00498 
00499                         <span class="keywordflow">return</span> STATUS_DISK_CORRUPT_ERROR;
00500                     }
00501 
00502                     <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( (*Pcb)-&gt;Flags, PCB_FLAG_PHYSICAL_PARTITION );
00503                     Partition-&gt;Type = <a class="code" href="../../d6/d8/udfstruc_8h.html#a129a115">Physical</a>;
00504                     Partition-&gt;Physical.<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o6">PartitionNumber</a> = MapPhysical-&gt;<a class="code" href="../../d0/d4/structPARTMAP__PHYSICAL.html#o3">Partition</a>;
00505                 }
00506 
00507                 <span class="keywordflow">break</span>;
00508 
00509             <span class="keywordflow">case</span> <a class="code" href="../../d0/d7/iso13346_8h.html#a83">PARTMAP_TYPE_PROXY</a>:
00510 
00511                 <span class="comment">//</span>
00512                 <span class="comment">//  Type 2 - a Proxy Partition, something not explicitly physical.</span>
00513                 <span class="comment">//</span>
00514 
00515                 <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( 0, Dbg,
00516                              <span class="stringliteral">"UdfInitializePcb, map reference %02x is a proxy\n"</span>,
00517                              (Partition - (*Pcb)-&gt;Partition)/<span class="keyword">sizeof</span>(<a class="code" href="../../d2/d9/struct__tagPARTITION.html">PARTITION</a>)));
00518 
00519                 <span class="comment">//</span>
00520                 <span class="comment">//  Handle the various types of proxy partitions we recognize</span>
00521                 <span class="comment">//</span>
00522 
00523                 <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/udfprocs_8h.html#a230">UdfDomainIdentifierContained</a>( &amp;Map-&gt;<a class="code" href="../../d0/d9/struct__PARTMAP__UDF__GENERIC.html#o3">PartID</a>,
00524                                                   &amp;UdfVirtualPartitionDomainIdentifier,
00525                                                   UDF_VERSION_150,
00526                                                   UDF_VERSION_RECOGNIZED )) {
00527 
00528                     {
00529                         <a class="code" href="../../d1/d9/struct__PARTMAP__VIRTUAL.html">PPARTMAP_VIRTUAL</a> MapVirtual = (<a class="code" href="../../d1/d9/struct__PARTMAP__VIRTUAL.html">PPARTMAP_VIRTUAL</a>) Map;
00530 
00531                         <span class="comment">//</span>
00532                         <span class="comment">//  Only one of these guys can exist, since there can be only one VAT per media surface.</span>
00533                         <span class="comment">//</span>
00534 
00535                         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( (*Pcb)-&gt;Flags, PCB_FLAG_VIRTUAL_PARTITION )) {
00536 
00537                             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( 0, Dbg,
00538                                          <span class="stringliteral">"UdfInitializePcb, ... but this is a second virtual partition!?!!\n"</span> ));
00539 
00540                             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( -1, Dbg,
00541                                          <span class="stringliteral">"UdfInitializePcb -&gt; STATUS_UNCRECOGNIZED_VOLUME\n"</span> ));
00542 
00543                             <span class="keywordflow">return</span> STATUS_UNRECOGNIZED_VOLUME;
00544                         }
00545 
00546                         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( 0, Dbg,
00547                                      <span class="stringliteral">"UdfInitializePcb, ... Virtual (Partition # %08x)\n"</span>,
00548                                      MapVirtual-&gt;<a class="code" href="../../d1/d9/struct__PARTMAP__VIRTUAL.html#o5">Partition</a> ));
00549 
00550                         <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( (*Pcb)-&gt;Flags, PCB_FLAG_VIRTUAL_PARTITION );
00551                         Partition-&gt;Type = <a class="code" href="../../d5/d9/alpha_2exdsptch_8c.html#a2">Virtual</a>;
00552 
00553                         <span class="comment">//</span>
00554                         <span class="comment">//  We will convert the partition number to a partition reference</span>
00555                         <span class="comment">//  before returning.</span>
00556                         <span class="comment">//</span>
00557 
00558                         Partition-&gt;Virtual.RelatedReference = MapVirtual-&gt;<a class="code" href="../../d1/d9/struct__PARTMAP__VIRTUAL.html#o5">Partition</a>;
00559                     }
00560 
00561                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/udfprocs_8h.html#a230">UdfDomainIdentifierContained</a>( &amp;Map-&gt;<a class="code" href="../../d0/d9/struct__PARTMAP__UDF__GENERIC.html#o3">PartID</a>,
00562                                                          &amp;UdfSparablePartitionDomainIdentifier,
00563                                                          UDF_VERSION_150,
00564                                                          UDF_VERSION_RECOGNIZED )) {
00565 
00566                     {
00567                         <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00568                         <a class="code" href="../../d9/d8/struct__PARTMAP__SPARABLE.html">PPARTMAP_SPARABLE</a> MapSparable = (<a class="code" href="../../d9/d8/struct__PARTMAP__SPARABLE.html">PPARTMAP_SPARABLE</a>) Map;
00569 
00570                         <span class="comment">//</span>
00571                         <span class="comment">//  It must be the case that the volume the partition is on is the first</span>
00572                         <span class="comment">//  one since we only do single disc UDF.  This will have already been</span>
00573                         <span class="comment">//  checked by the caller.</span>
00574                         <span class="comment">//</span>
00575 
00576                         <span class="keywordflow">if</span> (MapSparable-&gt;<a class="code" href="../../d9/d8/struct__PARTMAP__SPARABLE.html#o4">VolSetSeq</a> &gt; 1) {
00577 
00578                             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( 0, Dbg,
00579                                          <span class="stringliteral">"UdfInitializePcb, ... but sparable partition resides on volume set volume # %08x (&gt; 1)!\n"</span>,
00580                                          MapSparable-&gt;<a class="code" href="../../d9/d8/struct__PARTMAP__SPARABLE.html#o4">VolSetSeq</a> ));
00581 
00582                             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( -1, Dbg,
00583                                          <span class="stringliteral">"UdfInitializePcb -&gt; STATUS_DISK_CORRUPT_ERROR\n"</span> ));
00584 
00585                             <span class="keywordflow">return</span> STATUS_DISK_CORRUPT_ERROR;
00586                         }
00587 
00588                         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( 0, Dbg,
00589                                      <span class="stringliteral">"UdfInitializePcb, ... Sparable (Partition # %08x)\n"</span>,
00590                                      MapSparable-&gt;<a class="code" href="../../d9/d8/struct__PARTMAP__SPARABLE.html#o5">Partition</a> ));
00591 
00592                         <span class="comment">//</span>
00593                         <span class="comment">//  We pretend that sparable partitions are basically the same as</span>
00594                         <span class="comment">//  physical partitions.  Since we are not r/w (and will never be</span>
00595                         <span class="comment">//  on media that requires host-based sparing in any case), this</span>
00596                         <span class="comment">//  is a good simplification.</span>
00597                         <span class="comment">//</span>
00598 
00599                         <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( (*Pcb)-&gt;Flags, PCB_FLAG_SPARABLE_PARTITION );
00600                         Partition-&gt;Type = <a class="code" href="../../d6/d8/udfstruc_8h.html#a129a115">Physical</a>;
00601                         Partition-&gt;Physical.<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o6">PartitionNumber</a> = MapSparable-&gt;<a class="code" href="../../d9/d8/struct__PARTMAP__SPARABLE.html#o5">Partition</a>;
00602 
00603                         <span class="comment">//</span>
00604                         <span class="comment">//  Save this map for use when the partition descriptor is found.</span>
00605                         <span class="comment">//  We can't load the sparing table at this time because we have</span>
00606                         <span class="comment">//  to turn the Lbn-&gt;Psn mapping into a Psn-&gt;Psn mapping.  UDF</span>
00607                         <span class="comment">//  believes that the way sparing will be used in concert with</span>
00608                         <span class="comment">//  the Lbn-&gt;Psn mapping engine (like UdfLookupPsnOfExtent).</span>
00609                         <span class="comment">//</span>
00610                         <span class="comment">//  Unfortunately, this would be a bit painful at this time.</span>
00611                         <span class="comment">//  The users of UdfLookupPsnOfExtent would need to iterate</span>
00612                         <span class="comment">//  over a new interface (not so bad) but the Vmcb package</span>
00613                         <span class="comment">//  would need to be turned inside out so that it didn't do</span>
00614                         <span class="comment">//  the page-filling alignment of blocks in the metadata</span>
00615                         <span class="comment">//  stream - instead, UdfLookupMetaVsnOfExtent would need to</span>
00616                         <span class="comment">//  do this itself.  I choose to lay the sparing engine into</span>
00617                         <span class="comment">//  the read path and raw sector read engine instead.</span>
00618                         <span class="comment">//</span>
00619 
00620                         Partition-&gt;Physical.SparingMap = <a class="code" href="../../d1/d8/fsrtl_8h.html#a37">FsRtlAllocatePoolWithTag</a>( PagedPool,
00621                                                                                    <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d8/struct__PARTMAP__SPARABLE.html">PARTMAP_SPARABLE</a>),
00622                                                                                    TAG_NSR_FSD);
00623                         RtlCopyMemory( Partition-&gt;Physical.SparingMap,
00624                                        MapSparable,
00625                                        <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d8/struct__PARTMAP__SPARABLE.html">PARTMAP_SPARABLE</a>));
00626                     }
00627 
00628                 } <span class="keywordflow">else</span> {
00629 
00630                     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( 0, Dbg,
00631                                  <span class="stringliteral">"UdfInitializePcb, ... but we don't recognize this proxy!\n"</span> ));
00632 
00633                     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( -1, Dbg,
00634                                  <span class="stringliteral">"UdfInitializePcb -&gt; STATUS_UNRECOGNIZED_VOLUME\n"</span> ));
00635 
00636                     <span class="keywordflow">return</span> STATUS_UNRECOGNIZED_VOLUME;
00637                 }
00638 
00639                 <span class="keywordflow">break</span>;
00640 
00641             <span class="keywordflow">default</span>:
00642 
00643                 <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( 0, Dbg,
00644                              <span class="stringliteral">"UdfInitializePcb, map reference %02x is of unknown type %02x\n"</span>,
00645                              Map-&gt;<a class="code" href="../../d0/d9/struct__PARTMAP__UDF__GENERIC.html#o0">Type</a> ));
00646 
00647                 <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( -1, Dbg,
00648                              <span class="stringliteral">"UdfInitializePcb -&gt; STATUS_UNRECOGNIZED_VOLUME\n"</span> ));
00649 
00650                 <span class="keywordflow">return</span> STATUS_UNRECOGNIZED_VOLUME;
00651                 <span class="keywordflow">break</span>;
00652         }
00653     }
00654 
00655     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( (*Pcb)-&gt;Flags, PCB_FLAG_PHYSICAL_PARTITION | PCB_FLAG_SPARABLE_PARTITION )) {
00656 
00657         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( 0, Dbg,
00658                      <span class="stringliteral">"UdfInitializePcb, no physical partition seen on this logical volume!\n"</span> ));
00659 
00660         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( -1, Dbg,
00661                      <span class="stringliteral">"UdfInitializePcb -&gt; STATUS_UNRECOGNIZED_VOLUME\n"</span> ));
00662 
00663         <span class="keywordflow">return</span> STATUS_UNRECOGNIZED_VOLUME;
00664     }
00665 
00666     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( (*Pcb)-&gt;Flags, PCB_FLAG_VIRTUAL_PARTITION )) {
00667 
00668         <a class="code" href="../../d2/d9/struct__tagPARTITION.html">PPARTITION</a> Host;
00669 
00670         <span class="comment">//</span>
00671         <span class="comment">//  Confirm the validity of any type 2 virtual maps on this volume</span>
00672         <span class="comment">//  and convert partition numbers to partition references that will</span>
00673         <span class="comment">//  immediately index an element of the Pcb.</span>
00674         <span class="comment">//</span>
00675 
00676         <span class="keywordflow">for</span> (Partition = (*Pcb)-&gt;Partition;
00677              Partition &lt; &amp;(*Pcb)-&gt;Partition[(*Pcb)-&gt;Partitions];
00678              Partition++) {
00679 
00680             <span class="keywordflow">if</span> (Partition-&gt;Type == <a class="code" href="../../d5/d9/alpha_2exdsptch_8c.html#a2">Virtual</a>) {
00681 
00682                 <span class="comment">//</span>
00683                 <span class="comment">//  Go find the partition this thing is talking about</span>
00684                 <span class="comment">//</span>
00685 
00686                 Found = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00687 
00688                 <span class="keywordflow">for</span> (Host = (*Pcb)-&gt;Partition;
00689                      Host &lt; &amp;(*Pcb)-&gt;Partition[(*Pcb)-&gt;Partitions];
00690                      Host++) {
00691 
00692                     <span class="keywordflow">if</span> (Host-&gt;Type == <a class="code" href="../../d6/d8/udfstruc_8h.html#a129a115">Physical</a> &amp;&amp;
00693                         Host-&gt;Physical.<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o6">PartitionNumber</a> ==
00694                         Partition-&gt;Virtual.RelatedReference) {
00695 
00696                         Partition-&gt;Virtual.RelatedReference =
00697                             (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(Host - (*Pcb)-&gt;Partition)/<span class="keyword">sizeof</span>(<a class="code" href="../../d2/d9/struct__tagPARTITION.html">PARTITION</a>);
00698                         Found = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00699                         <span class="keywordflow">break</span>;
00700                     }
00701                 }
00702 
00703                 <span class="comment">//</span>
00704                 <span class="comment">//  Failure to find a physical partition for this virtual guy</span>
00705                 <span class="comment">//  is not a good sign.</span>
00706                 <span class="comment">//</span>
00707 
00708                 <span class="keywordflow">if</span> (!Found) {
00709 
00710                     <span class="keywordflow">return</span> STATUS_DISK_CORRUPT_ERROR;
00711                 }
00712             }
00713         }
00714     }
00715 
00716     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( -1, Dbg,
00717              <span class="stringliteral">"UdfInitializePcb -&gt; STATUS_SUCCESS\n"</span> ));
00718 
00719     <span class="keywordflow">return</span> STATUS_SUCCESS;
00720 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a209" doxytag="udfprocs.h::UdfInitializeStackIrpContext" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID UdfInitializeStackIrpContext           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">OUT <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d3/struct__IRP__CONTEXT__LITE.html">PIRP_CONTEXT_LITE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContextLite</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l01528">1528</a> of file <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html">udfs/strucsup.c</a>.
<p>
References <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00354">ASSERT_IRP_CONTEXT_LITE</a>, <a class="el" href="../../d6/d8/udfstruc_8h.html#a92">IRP_CONTEXT</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01233">IRP_CONTEXT_FLAG_ON_STACK</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01235">IRP_CONTEXT_FLAG_WAIT</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00057">IRP_MJ_CLOSE</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d6/d8/udfstruc_8h.html#a95">PIRP_CONTEXT_LITE</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00505">SetFlag</a>, and <a class="el" href="../../d2/d6/udfs_2nodetype_8h-source.html#l00041">UDFS_NTC_IRP_CONTEXT</a>.
<p>
Referenced by <a class="el" href="../../d3/d8/close_8c-source.html#l00099">UdfFspClose()</a>.
<p>
<pre class="fragment"><div>01535                    :
01536 
01537     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called to initialize an IrpContext <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current
01538     UDFS request.  The IrpContext <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> stack and we need to initialize
01539     <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current request.  The request <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a close operation.
01540 
01541 Arguments:
01542 
01543     IrpContext - IrpContext to initialize.
01544 
01545     IrpContextLite - Structure containing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> details of <span class="keyword">this</span> request.
01546 
01547 Return Value:
01548 
01549     None
01550 
01551 --*/
01552 
01553 {
01554     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01555 
01556     <a class="code" href="../../d1/d8/udfdata_8h.html#a30">ASSERT_IRP_CONTEXT_LITE</a>( IrpContextLite );
01557 
01558     <span class="comment">//</span>
01559     <span class="comment">//  Zero and then initialize the structure.</span>
01560     <span class="comment">//</span>
01561 
01562     RtlZeroMemory( IrpContext, <span class="keyword">sizeof</span>( <a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html">IRP_CONTEXT</a> ));
01563 
01564     <span class="comment">//</span>
01565     <span class="comment">//  Set the proper node type code and node byte size</span>
01566     <span class="comment">//</span>
01567 
01568     IrpContext-&gt;NodeTypeCode = <a class="code" href="../../d1/d7/udfs_2nodetype_8h.html#a7">UDFS_NTC_IRP_CONTEXT</a>;
01569     IrpContext-&gt;NodeByteSize = <span class="keyword">sizeof</span>( <a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html">IRP_CONTEXT</a> );
01570 
01571     <span class="comment">//</span>
01572     <span class="comment">//  Note that this is from the stack.</span>
01573     <span class="comment">//</span>
01574 
01575     <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( IrpContext-&gt;Flags, IRP_CONTEXT_FLAG_ON_STACK );
01576 
01577     <span class="comment">//</span>
01578     <span class="comment">//  Copy RealDevice for workque algorithms.</span>
01579     <span class="comment">//</span>
01580 
01581     IrpContext-&gt;RealDevice = IrpContextLite-&gt;RealDevice;
01582 
01583     <span class="comment">//</span>
01584     <span class="comment">//  The Vcb is found in the Fcb.</span>
01585     <span class="comment">//</span>
01586 
01587     IrpContext-&gt;Vcb = IrpContextLite-&gt;Fcb-&gt;Vcb;
01588 
01589     <span class="comment">//</span>
01590     <span class="comment">//  Major/Minor Function codes</span>
01591     <span class="comment">//</span>
01592 
01593     IrpContext-&gt;MajorFunction = <a class="code" href="../../d0/d5/io_8h.html#a15">IRP_MJ_CLOSE</a>;
01594 
01595     <span class="comment">//</span>
01596     <span class="comment">//  Set the wait parameter</span>
01597     <span class="comment">//</span>
01598 
01599     <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( IrpContext-&gt;Flags, IRP_CONTEXT_FLAG_WAIT );
01600 
01601     <span class="keywordflow">return</span>;
01602 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a203" doxytag="udfprocs.h::UdfInitializeVcb" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN UdfInitializeVcb           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT <a class="el" href="../../d7/d5/struct__VCB.html">PVCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Vcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>TargetDeviceObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d7/d7/struct__VPB.html">PVPB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Vpb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PDISK_GEOMETRY&nbsp;</td>
          <td class="mdname" nowrap> <em>DiskGeometry</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>MediaChangeCount</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l00331">331</a> of file <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html">udfs/strucsup.c</a>.
<p>
References <a class="el" href="../../d6/d7/ex_8h-source.html#l00367">ExInitializeFastMutex</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02473">ExInitializeResource</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d3/d6/notify_8c-source.html#l00371">FsRtlNotifyInitializeSync()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d9/ob_8h-source.html#l00514">ObReferenceObject</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d7/d0/gentable_8c-source.html#l00213">RtlInitializeGenericTable()</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00505">SetFlag</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l04411">UdfAllocateTable()</a>, <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00042">UdfData</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l04446">UdfDeallocateTable()</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l04354">UdfFcbTableCompare()</a>, <a class="el" href="../../d1/d7/udfdata_8c-source.html#l01239">UdfHighBit()</a>, <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00052">UDFS_BASE_RESIDUAL_REFERENCE</a>, <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00053">UDFS_BASE_RESIDUAL_USER_REFERENCE</a>, <a class="el" href="../../d2/d6/udfs_2nodetype_8h-source.html#l00036">UDFS_NTC_VCB</a>, <a class="el" href="../../d6/d8/udfstruc_8h.html#a73">VCB</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00684">VCB_STATE_REMOVABLE_MEDIA</a>, <a class="el" href="../../d6/d8/udfstruc_8h.html#a130a118">VcbMountInProgress</a>, and <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00216">_UDF_DATA::VcbQueue</a>.
<p>
Referenced by <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l01444">UdfMountVolume()</a>.
<p>
<pre class="fragment"><div>00342                    :
00343 
00344     This routine initializes and inserts a <span class="keyword">new</span> Vcb record into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> in-memory
00345     data structure.  The Vcb record <span class="stringliteral">"hangs"</span> off <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> end of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Volume device
00346     object and must be allocated by our caller.
00347 
00348 Arguments:
00349 
00350     Vcb - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Vcb record being initialized.
00351 
00352     TargetDeviceObject - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target device object to
00353         associate with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Vcb record.
00354 
00355     Vpb - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> address of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Vpb to associate with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Vcb record.
00356 
00357     MediaChangeCount - Initial media change count of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> target device
00358 
00359 Return Value:
00360 
00361     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a21">Boolean</a> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> volume looks reasonable to <span class="keywordflow">continue</span> mounting, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
00362     otherwise.  This routine can raise on allocation <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a>.
00363 
00364 --*/
00365 
00366 {
00367     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00368 
00369     <span class="comment">//</span>
00370     <span class="comment">//  We start by first zeroing out all of the VCB, this will guarantee</span>
00371     <span class="comment">//  that any stale data is wiped clean.</span>
00372     <span class="comment">//</span>
00373 
00374     RtlZeroMemory( Vcb, <span class="keyword">sizeof</span>( <a class="code" href="../../d7/d5/struct__VCB.html">VCB</a> ));
00375 
00376     <span class="comment">//</span>
00377     <span class="comment">//  Set the proper node type code and node byte size.</span>
00378     <span class="comment">//</span>
00379 
00380     Vcb-&gt;NodeTypeCode = <a class="code" href="../../d1/d7/udfs_2nodetype_8h.html#a2">UDFS_NTC_VCB</a>;
00381     Vcb-&gt;NodeByteSize = <span class="keyword">sizeof</span>( <a class="code" href="../../d7/d5/struct__VCB.html">VCB</a> );
00382 
00383     <span class="comment">//</span>
00384     <span class="comment">//  Initialize the DirNotify structures.  Do this first so there is</span>
00385     <span class="comment">//  no cleanup if it raises.  Nothing else below will fail with</span>
00386     <span class="comment">//  a raise.</span>
00387     <span class="comment">//</span>
00388 
00389     InitializeListHead( &amp;Vcb-&gt;DirNotifyList );
00390     <a class="code" href="../../d1/d8/fsrtl_8h.html#a169">FsRtlNotifyInitializeSync</a>( &amp;Vcb-&gt;NotifySync );
00391 
00392     <span class="comment">//</span>
00393     <span class="comment">//  Initialize the resource variable for the Vcb and files.</span>
00394     <span class="comment">//</span>
00395 
00396     <a class="code" href="../../d5/d8/ex_8h.html#a68">ExInitializeResource</a>( &amp;Vcb-&gt;VcbResource );
00397     <a class="code" href="../../d5/d8/ex_8h.html#a68">ExInitializeResource</a>( &amp;Vcb-&gt;FileResource );
00398     <a class="code" href="../../d5/d8/ex_8h.html#a8">ExInitializeFastMutex</a>( &amp;Vcb-&gt;VcbMutex );
00399 
00400     <span class="comment">//</span>
00401     <span class="comment">//  Insert this Vcb record on the UdfData.VcbQueue.</span>
00402     <span class="comment">//</span>
00403 
00404     InsertHeadList( &amp;<a class="code" href="../../d0/d8/udfdata_8c.html#a2">UdfData</a>.<a class="code" href="../../d2/d3/struct__UDF__DATA.html#o3">VcbQueue</a>, &amp;Vcb-&gt;VcbLinks );
00405 
00406     <span class="comment">//</span>
00407     <span class="comment">//  Set the Target Device Object and Vpb fields, referencing the</span>
00408     <span class="comment">//  target device.</span>
00409     <span class="comment">//</span>
00410 
00411     <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a>( TargetDeviceObject );
00412     Vcb-&gt;TargetDeviceObject = TargetDeviceObject;
00413     Vcb-&gt;Vpb = Vpb;
00414 
00415     <span class="comment">//</span>
00416     <span class="comment">//  Set the removable media flag based on the real device's</span>
00417     <span class="comment">//  characteristics</span>
00418     <span class="comment">//</span>
00419 
00420     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Vpb-&gt;RealDevice-&gt;Characteristics, FILE_REMOVABLE_MEDIA )) {
00421 
00422         <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( Vcb-&gt;VcbState, VCB_STATE_REMOVABLE_MEDIA );
00423     }
00424 
00425     <span class="comment">//</span>
00426     <span class="comment">//  Initialize the generic Fcb Table.</span>
00427     <span class="comment">//</span>
00428 
00429     <a class="code" href="../../d6/d1/gentable_8c.html#a3">RtlInitializeGenericTable</a>( &amp;Vcb-&gt;FcbTable,
00430                                (PRTL_GENERIC_COMPARE_ROUTINE) UdfFcbTableCompare,
00431                                (PRTL_GENERIC_ALLOCATE_ROUTINE) UdfAllocateTable,
00432                                (PRTL_GENERIC_FREE_ROUTINE) UdfDeallocateTable,
00433                                NULL );
00434 
00435     <span class="comment">//</span>
00436     <span class="comment">//  Show that we have a mount in progress.</span>
00437     <span class="comment">//</span>
00438 
00439     Vcb-&gt;VcbCondition = <a class="code" href="../../d6/d8/udfstruc_8h.html#a130a118">VcbMountInProgress</a>;
00440 
00441     <span class="comment">//</span>
00442     <span class="comment">//  Refererence the Vcb for two reasons.  The first is a reference</span>
00443     <span class="comment">//  that prevents the Vcb from going away on the last close unless</span>
00444     <span class="comment">//  dismount has already occurred.  The second is to make sure</span>
00445     <span class="comment">//  we don't go into the dismount path on any error during mount</span>
00446     <span class="comment">//  until we get to the Mount cleanup.</span>
00447     <span class="comment">//</span>
00448 
00449     Vcb-&gt;VcbResidualReference = <a class="code" href="../../d1/d8/udfdata_8h.html#a0">UDFS_BASE_RESIDUAL_REFERENCE</a>;
00450     Vcb-&gt;VcbResidualUserReference = <a class="code" href="../../d1/d8/udfdata_8h.html#a1">UDFS_BASE_RESIDUAL_USER_REFERENCE</a>;
00451 
00452     Vcb-&gt;VcbReference = 1 + Vcb-&gt;VcbResidualReference;
00453 
00454     <span class="comment">//</span>
00455     <span class="comment">//  Set the sector size.</span>
00456     <span class="comment">//</span>
00457 
00458     Vcb-&gt;SectorSize = DiskGeometry-&gt;BytesPerSector;
00459 
00460     <span class="comment">//</span>
00461     <span class="comment">//  Set the sector shift amount.</span>
00462     <span class="comment">//</span>
00463 
00464     Vcb-&gt;SectorShift = <a class="code" href="../../d3/d8/udfprocs_8h.html#a136">UdfHighBit</a>( DiskGeometry-&gt;BytesPerSector );
00465 
00466     <span class="comment">//</span>
00467     <span class="comment">//  Set the media change count on the device</span>
00468     <span class="comment">//</span>
00469 
00470     Vcb-&gt;MediaChangeCount = MediaChangeCount;
00471 
00472     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00473 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a236" doxytag="udfprocs.h::UdfInitializeVmcb" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID UdfInitializeVmcb           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d7/struct__VMCB.html">PVMCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Vmcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d5/d8/ex_8h.html#a96">POOL_TYPE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>PoolType</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>MaximumLbn</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>LbSize</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d5/vmcbsup_8c-source.html#l00219">219</a> of file <a class="el" href="../../d7/d5/vmcbsup_8c-source.html">vmcbsup.c</a>.
<p>
References <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d9/d2/lfsdata_8h-source.html#l00187">DebugUnwind</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00334">FsRtlInitializeMcb()</a>, <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00348">FsRtlUninitializeMcb()</a>, <a class="el" href="../../d4/d4/mutntobj_8c-source.html#l00099">KeInitializeMutex()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d7/d0/gentable_8c-source.html#l00213">RtlInitializeGenericTable()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00230">SectorSize</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l00477">UdfUpdateVcbPhase0()</a>.
<p>
<pre class="fragment"><div>00228                    :
00229 
00230     This routine initializes a <span class="keyword">new</span> Vmcb Structure.  The caller must
00231     supply <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> memory <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> structure.  This must precede all other calls
00232     that set/query <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> volume <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> mapping.
00233 
00234     If <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not available <span class="keyword">this</span> routine will raise a status value
00235     indicating insufficient resources.
00236 
00237 Arguments:
00238 
00239     Vmcb - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> volume <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> structure to initialize.
00240 
00241     PoolType - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d4/d6/regext_8c.html#a17">pool</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> to use when allocating additional
00242         internal structures.
00243 
00244     MaximumLbn - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> maximum Lbn value that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> valid <span class="keywordflow">for</span> <span class="keyword">this</span>
00245         volume.
00246 
00247     LbSize - <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> of a sector on <span class="keyword">this</span> volume
00248 
00249 Return Value:
00250 
00251     None
00252 
00253 --*/
00254 
00255 {
00256     BOOLEAN VbnInitialized;
00257     BOOLEAN LbnInitialized;
00258 
00259     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00260 
00261     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( +1, Dbg, <span class="stringliteral">"UdfInitializeVmcb, Vmcb = %08x\n"</span>, Vmcb ));
00262 
00263     VbnInitialized = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00264     LbnInitialized = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00265 
00266     <span class="keywordflow">try</span> {
00267 
00268         <span class="comment">//</span>
00269         <span class="comment">//  Initialize the fields in the vmcb structure</span>
00270         <span class="comment">//</span>
00271 
00272         <a class="code" href="../../d3/d5/mutntobj_8c.html#a2">KeInitializeMutex</a>( &amp;Vmcb-&gt;Mutex, 0 );
00273 
00274         <a class="code" href="../../d1/d8/fsrtl_8h.html#a151">FsRtlInitializeMcb</a>( &amp;Vmcb-&gt;VbnIndexed, PoolType );
00275         VbnInitialized = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00276 
00277         <a class="code" href="../../d1/d8/fsrtl_8h.html#a151">FsRtlInitializeMcb</a>( &amp;Vmcb-&gt;LbnIndexed, PoolType );
00278         LbnInitialized = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00279 
00280         Vmcb-&gt;MaximumLbn = MaximumLbn;
00281 
00282         Vmcb-&gt;SectorSize = <a class="code" href="../../d3/d8/udfprocs_8h.html#a42">SectorSize</a>;
00283 
00284 <span class="preprocessor">#if VMCB_WRITE_SUPPORT</span>
00285 <span class="preprocessor"></span>
00286         <span class="comment">//</span>
00287         <span class="comment">//  For the dirty table we store in the table context field the pool</span>
00288         <span class="comment">//  type to use for allocating additional structures</span>
00289         <span class="comment">//</span>
00290 
00291         <a class="code" href="../../d6/d1/gentable_8c.html#a3">RtlInitializeGenericTable</a>( &amp;Vmcb-&gt;DirtyTable,
00292                                    PbCompareDirtyVmcb,
00293                                    PbAllocateDirtyVmcb,
00294                                    PbDeallocateDirtyVmcb,
00295                                    (PVOID)PoolType );
00296 
00297 <span class="preprocessor">#endif // VMCB_WRITE_SUPPORT</span>
00298 <span class="preprocessor"></span>
00299     } finally {
00300 
00301         <span class="comment">//</span>
00302         <span class="comment">//  If this is an abnormal termination then check if we need to</span>
00303         <span class="comment">//  uninitialize the mcb structures</span>
00304         <span class="comment">//</span>
00305 
00306         <span class="keywordflow">if</span> (AbnormalTermination()) {
00307 
00308             <span class="keywordflow">if</span> (VbnInitialized) { <a class="code" href="../../d1/d8/fsrtl_8h.html#a152">FsRtlUninitializeMcb</a>( &amp;Vmcb-&gt;VbnIndexed ); }
00309             <span class="keywordflow">if</span> (LbnInitialized) { <a class="code" href="../../d1/d8/fsrtl_8h.html#a152">FsRtlUninitializeMcb</a>( &amp;Vmcb-&gt;LbnIndexed ); }
00310         }
00311 
00312         <a class="code" href="../../d8/d3/lfsdata_8h.html#a3">DebugUnwind</a>(<span class="stringliteral">"UdfInitializeVmcb"</span>);
00313         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( -1, Dbg, <span class="stringliteral">"UdfInitializeVmcb -&gt; VOID\n"</span> ));
00314     }
00315 
00316     <span class="comment">//</span>
00317     <span class="comment">//  And return to our caller</span>
00318     <span class="comment">//</span>
00319 
00320     <span class="keywordflow">return</span>;
00321 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a194" doxytag="udfprocs.h::UdfInsertPrefix" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d5/d9/struct__LCB.html">PLCB</a> UdfInsertPrefix           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d7/d9/struct__FCB.html">PFCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Fcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>Name</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>ShortNameMatch</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>IgnoreCase</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d7/d9/struct__FCB.html">PFCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ParentFcb</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d3/prefxsup_8c-source.html#l00064">64</a> of file <a class="el" href="../../d6/d3/prefxsup_8c-source.html">prefxsup.c</a>.
<p>
References <a class="el" href="../../d3/d6/notify_8c-source.html#l00236">Add2Ptr</a>, <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00367">ASSERT_EXCLUSIVE_FCB</a>, <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00338">ASSERT_FCB</a>, <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00342">ASSERT_FCB_INDEX</a>, <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00352">ASSERT_IRP_CONTEXT</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00778">_LCB::ChildFcb</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00777">_LCB::ChildFcbLinks</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00906">ExAllocateFromPagedLookasideList()</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00798">_LCB::FileAttributes</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00810">_LCB::FileName</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00790">_LCB::Flags</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01101">FsRtlAllocatePoolWithTag</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00814">LCB_FLAG_IGNORE_CASE</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00816">LCB_FLAG_POOL_ALLOCATED</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00815">LCB_FLAG_SHORT_NAME</a>, <a class="el" href="../../d9/d9/geninst_8c-source.html#l00154">Name</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00762">_LCB::NodeByteSize</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00761">_LCB::NodeTypeCode</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00770">_LCB::ParentFcb</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00769">_LCB::ParentFcbLinks</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00784">_LCB::Reference</a>, <a class="el" href="../../d2/d6/udfs_2nodetype_8h-source.html#l00063">SafeNodeType</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00505">SetFlag</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00822">SIZEOF_LOOKASIDE_LCB</a>, <a class="el" href="../../d2/d6/udfs_2nodetype_8h-source.html#l00171">TAG_LCB</a>, <a class="el" href="../../d6/d3/prefxsup_8c-source.html#l00557">UdfFindNameLink()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00453">UdfFreePool()</a>, <a class="el" href="../../d6/d3/prefxsup_8c-source.html#l00660">UdfInsertNameLink()</a>, <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00196">UdfLcbLookasideList</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00443">UdfPagedPool</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00406">UdfRaiseStatus()</a>, <a class="el" href="../../d2/d6/udfs_2nodetype_8h-source.html#l00037">UDFS_NTC_FCB_INDEX</a>, and <a class="el" href="../../d2/d6/udfs_2nodetype_8h-source.html#l00043">UDFS_NTC_LCB</a>.
<p>
Referenced by <a class="el" href="../../d4/d7/udfs_2create_8c-source.html#l01632">UdfOpenObjectFromDirContext()</a>.
<p>
<pre class="fragment"><div>00075                    :
00076 
00077     This routine inserts an Lcb linking <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> two Fcbs together.
00078 
00079 Arguments:
00080 
00081     Fcb - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Fcb whose name <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being inserted into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> tree.
00082 
00083     <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a> - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> component.
00084     
00085     ShortNameMatch - Indicates whether <span class="keyword">this</span> name was found on an <span class="keyword">explicit</span> 8.3 search
00086 
00087     IgnoreCase - Indicates <span class="keywordflow">if</span> we should insert into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keywordflow">case</span>-insensitive tree.
00088 
00089     ParentFcb - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> ParentFcb.  The prefix tree <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> attached to <span class="keyword">this</span>.
00090 
00091 Return Value:
00092 
00093     <a class="code" href="../../d5/d9/struct__LCB.html">PLCB</a> - <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Lcb inserted.
00094 
00095 --*/
00096 
00097 {
00098     <a class="code" href="../../d5/d9/struct__LCB.html">PLCB</a> Lcb;
00099     PRTL_SPLAY_LINKS *TreeRoot;
00100     PLIST_ENTRY ListLinks;
00101     ULONG Flags;
00102 
00103     PWCHAR NameBuffer;
00104 
00105     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00106 
00107     <span class="comment">//</span>
00108     <span class="comment">//  Check inputs.</span>
00109     <span class="comment">//</span>
00110 
00111     <a class="code" href="../../d1/d8/udfdata_8h.html#a28">ASSERT_IRP_CONTEXT</a>( IrpContext );
00112     <a class="code" href="../../d1/d8/udfdata_8h.html#a14">ASSERT_FCB</a>( Fcb );
00113 
00114     <a class="code" href="../../d1/d8/udfdata_8h.html#a43">ASSERT_EXCLUSIVE_FCB</a>( Fcb );
00115     <a class="code" href="../../d1/d8/udfdata_8h.html#a43">ASSERT_EXCLUSIVE_FCB</a>( ParentFcb );
00116     <a class="code" href="../../d1/d8/udfdata_8h.html#a18">ASSERT_FCB_INDEX</a>( ParentFcb );
00117 
00118     <span class="comment">//</span>
00119     <span class="comment">//  It must be the case that an index Fcb is only referenced by a single index.  Now</span>
00120     <span class="comment">//  we walk the child's Lcb queue to insure that if any prefixes have already been</span>
00121     <span class="comment">//  inserted, they all refer to the index Fcb we are linking to.  This is the only way</span>
00122     <span class="comment">//  we can detect directory cross-linkage.</span>
00123     <span class="comment">//</span>
00124 
00125     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d7/udfs_2nodetype_8h.html#a12">SafeNodeType</a>( Fcb ) == <a class="code" href="../../d1/d7/udfs_2nodetype_8h.html#a3">UDFS_NTC_FCB_INDEX</a>) {
00126 
00127         <span class="keywordflow">for</span> (ListLinks = Fcb-&gt;ParentLcbQueue.Flink;
00128              ListLinks != &amp;Fcb-&gt;ParentLcbQueue;
00129              ListLinks = ListLinks-&gt;Flink) {
00130 
00131             Lcb = CONTAINING_RECORD( ListLinks, <a class="code" href="../../d5/d9/struct__LCB.html">LCB</a>, ChildFcbLinks );
00132 
00133             <span class="keywordflow">if</span> (Lcb-&gt;<a class="code" href="../../d5/d9/struct__LCB.html#o9">ParentFcb</a> != ParentFcb) {
00134 
00135                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a122">UdfRaiseStatus</a>( IrpContext, STATUS_DISK_CORRUPT_ERROR );
00136             }
00137         }
00138     }
00139     
00140     <span class="comment">//</span>
00141     <span class="comment">//  Capture the separate cases.</span>
00142     <span class="comment">//</span>
00143 
00144     <span class="keywordflow">if</span> (IgnoreCase) {
00145 
00146         TreeRoot = &amp;ParentFcb-&gt;IgnoreCaseRoot;
00147         Flags = <a class="code" href="../../d6/d8/udfstruc_8h.html#a9">LCB_FLAG_IGNORE_CASE</a>;
00148 
00149     } <span class="keywordflow">else</span> {
00150 
00151         TreeRoot = &amp;ParentFcb-&gt;ExactCaseRoot;
00152         Flags = 0;
00153     }
00154 
00155     <span class="keywordflow">if</span> (ShortNameMatch) {
00156 
00157         <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( Flags, LCB_FLAG_SHORT_NAME );
00158     }
00159 
00160     <span class="comment">//</span>
00161     <span class="comment">//  Allocate space for the Lcb.</span>
00162     <span class="comment">//</span>
00163 
00164     <span class="keywordflow">if</span> ( <span class="keyword">sizeof</span>( <a class="code" href="../../d5/d9/struct__LCB.html">LCB</a> ) + <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Length &gt; <a class="code" href="../../d6/d8/udfstruc_8h.html#a12">SIZEOF_LOOKASIDE_LCB</a> ) {
00165     
00166         Lcb = <a class="code" href="../../d1/d8/fsrtl_8h.html#a37">FsRtlAllocatePoolWithTag</a>( UdfPagedPool,
00167                                         <span class="keyword">sizeof</span>( <a class="code" href="../../d5/d9/struct__LCB.html">LCB</a> ) + <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Length,
00168                                         TAG_LCB );
00169 
00170         <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( Flags, LCB_FLAG_POOL_ALLOCATED );
00171 
00172     } <span class="keywordflow">else</span> {
00173 
00174         Lcb = <a class="code" href="../../d5/d8/ex_8h.html#a252">ExAllocateFromPagedLookasideList</a>( &amp;UdfLcbLookasideList );
00175     }
00176 
00177     <span class="comment">//</span>
00178     <span class="comment">//  Set the type and size.</span>
00179     <span class="comment">//</span>
00180 
00181     Lcb-&gt;<a class="code" href="../../d5/d9/struct__LCB.html#o0">NodeTypeCode</a> = <a class="code" href="../../d1/d7/udfs_2nodetype_8h.html#a9">UDFS_NTC_LCB</a>;
00182     Lcb-&gt;<a class="code" href="../../d5/d9/struct__LCB.html#o1">NodeByteSize</a> = <span class="keyword">sizeof</span>( <a class="code" href="../../d5/d9/struct__LCB.html">LCB</a> ) + <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Length;
00183 
00184     <span class="comment">//</span>
00185     <span class="comment">//  Initialize the name-based file attributes.</span>
00186     <span class="comment">//</span>
00187     
00188     Lcb-&gt;<a class="code" href="../../d5/d9/struct__LCB.html#o14">FileAttributes</a> = 0;
00189     
00190     <span class="comment">//</span>
00191     <span class="comment">//  Set up the filename in the Lcb.</span>
00192     <span class="comment">//</span>
00193 
00194     Lcb-&gt;<a class="code" href="../../d5/d9/struct__LCB.html#o16">FileName</a>.Length =
00195     Lcb-&gt;<a class="code" href="../../d5/d9/struct__LCB.html#o16">FileName</a>.MaximumLength = <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Length;
00196 
00197     Lcb-&gt;<a class="code" href="../../d5/d9/struct__LCB.html#o16">FileName</a>.Buffer = <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( Lcb, <span class="keyword">sizeof</span>( <a class="code" href="../../d5/d9/struct__LCB.html">LCB</a> ), PWCHAR );
00198 
00199     RtlCopyMemory( Lcb-&gt;<a class="code" href="../../d5/d9/struct__LCB.html#o16">FileName</a>.Buffer,
00200                    <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Buffer,
00201                    <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Length );
00202     
00203     <span class="comment">//</span>
00204     <span class="comment">//  Insert the Lcb into the prefix tree.</span>
00205     <span class="comment">//</span>
00206     
00207     Lcb-&gt;<a class="code" href="../../d5/d9/struct__LCB.html#o13">Flags</a> = Flags;
00208     
00209     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d4/prefxsup_8c.html#a3">UdfInsertNameLink</a>( IrpContext,
00210                             TreeRoot,
00211                             Lcb )) {
00212 
00213         <span class="comment">//</span>
00214         <span class="comment">//  This will very rarely occur.</span>
00215         <span class="comment">//</span>
00216 
00217         <a class="code" href="../../d3/d8/udfprocs_8h.html#a124">UdfFreePool</a>( &amp;Lcb );
00218 
00219         Lcb = <a class="code" href="../../d5/d4/prefxsup_8c.html#a2">UdfFindNameLink</a>( IrpContext,
00220                                TreeRoot,
00221                                Name );
00222 
00223         <span class="keywordflow">if</span> (Lcb == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00224 
00225             <span class="comment">//</span>
00226             <span class="comment">//  Even worse.</span>
00227             <span class="comment">//</span>
00228 
00229             <a class="code" href="../../d3/d8/udfprocs_8h.html#a122">UdfRaiseStatus</a>( IrpContext, STATUS_DRIVER_INTERNAL_ERROR );
00230         }
00231 
00232         <span class="keywordflow">return</span> Lcb;
00233     }
00234 
00235     <span class="comment">//</span>
00236     <span class="comment">//  Link the Fcbs together through the Lcb.</span>
00237     <span class="comment">//</span>
00238 
00239     Lcb-&gt;<a class="code" href="../../d5/d9/struct__LCB.html#o9">ParentFcb</a> = ParentFcb;
00240     Lcb-&gt;<a class="code" href="../../d5/d9/struct__LCB.html#o11">ChildFcb</a> = Fcb;
00241 
00242     InsertHeadList( &amp;ParentFcb-&gt;ChildLcbQueue, &amp;Lcb-&gt;<a class="code" href="../../d5/d9/struct__LCB.html#o8">ParentFcbLinks</a> );
00243     InsertHeadList( &amp;Fcb-&gt;ParentLcbQueue, &amp;Lcb-&gt;<a class="code" href="../../d5/d9/struct__LCB.html#o10">ChildFcbLinks</a> );
00244 
00245     <span class="comment">//</span>
00246     <span class="comment">//  Initialize the reference count.</span>
00247     <span class="comment">//</span>
00248 
00249     Lcb-&gt;<a class="code" href="../../d5/d9/struct__LCB.html#o12">Reference</a> = 0;
00250     
00251     <span class="keywordflow">return</span> Lcb;
00252 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a178" doxytag="udfprocs.h::UdfIs8dot3Name" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN UdfIs8dot3Name           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN UNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>FileName</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d4/namesup_8c-source.html#l00176">176</a> of file <a class="el" href="../../d6/d4/namesup_8c-source.html">namesup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00352">ASSERT_IRP_CONTEXT</a>, <a class="el" href="../../d0/d7/udf_8h-source.html#l00205">BYTE_COUNT_8_DOT_3</a>, <a class="el" href="../../d2/d0/bench_8c-source.html#l00050">CHAR</a>, <a class="el" href="../../d5/d9/cmconfig_8c-source.html#l00051">Count</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d3/d1/rtload_8c-source.html#l00047">FileName</a>, <a class="el" href="../../d2/d2/dbcsname_8c-source.html#l00081">FsRtlIsFatDbcsLegal()</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l00816">RtlUnicodeStringToCountedOemString()</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l01500">UdfEnumerateIndex()</a>, <a class="el" href="../../d5/d7/dirsup_8c-source.html#l00726">UdfFindDirEntry()</a>, <a class="el" href="../../d5/d2/fileinfo_8c-source.html#l01232">UdfQueryAlternateNameInfo()</a>, and <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l00334">UdfQueryDirectory()</a>.
<p>
<pre class="fragment"><div>00183                    :
00184 
00185     This routine checks <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name follows <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> 8.3 name conventions.  We check <span class="keywordflow">for</span>
00186     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name length and whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> characters are valid.
00187 
00188 Arguments:
00189 
00190     <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a> - <a class="code" href="../../d4/d9/talloc_8c.html#a0">String</a> of bytes containing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name.
00191 
00192 Return Value:
00193 
00194     BOOLEAN - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <span class="keyword">this</span> name <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a legal 8.3 name, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise.
00195 
00196 --*/
00197 
00198 {
00199     <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> DbcsNameBuffer[ <a class="code" href="../../d9/d7/udf_8h.html#a11">BYTE_COUNT_8_DOT_3</a> ];
00200     STRING DbcsName;
00201 
00202     PWCHAR NextWchar;
00203     ULONG <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a>;
00204 
00205     ULONG DotCount = 0;
00206     BOOLEAN LastCharDot = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00207 
00208     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00209 
00210     <span class="comment">//</span>
00211     <span class="comment">//  Check inputs.</span>
00212     <span class="comment">//</span>
00213 
00214     <a class="code" href="../../d1/d8/udfdata_8h.html#a28">ASSERT_IRP_CONTEXT</a>( IrpContext );
00215 
00216     <span class="comment">//</span>
00217     <span class="comment">//  The length must be less than 24 bytes.</span>
00218     <span class="comment">//</span>
00219 
00220     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>.Length != 0 );
00221     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>.Length &gt; <a class="code" href="../../d9/d7/udf_8h.html#a11">BYTE_COUNT_8_DOT_3</a>) {
00222 
00223         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00224     }
00225 
00226     <span class="comment">//</span>
00227     <span class="comment">//  Walk though and check for a space character.</span>
00228     <span class="comment">//</span>
00229 
00230     NextWchar = <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>.Buffer;
00231     <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> = 0;
00232 
00233     <span class="keywordflow">do</span> {
00234 
00235         <span class="comment">//</span>
00236         <span class="comment">//  No spaces allowed.</span>
00237         <span class="comment">//</span>
00238 
00239         <span class="keywordflow">if</span> (*NextWchar == <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">' '</span>) { <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>; }
00240 
00241         <span class="keywordflow">if</span> (*NextWchar == <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'.'</span>) {
00242 
00243             <span class="comment">//</span>
00244             <span class="comment">//  Not an 8.3 name if more than 1 dot or more than 8 characters</span>
00245             <span class="comment">//  remaining.  (It is legal for the dot to be in the ninth</span>
00246             <span class="comment">//  position)</span>
00247             <span class="comment">//</span>
00248 
00249             <span class="keywordflow">if</span> ((DotCount &gt; 0) ||
00250                 (<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> &gt; 8 * <span class="keyword">sizeof</span>( WCHAR ))) {
00251 
00252                 <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00253             }
00254 
00255             DotCount += 1;
00256             LastCharDot = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00257 
00258         } <span class="keywordflow">else</span> {
00259 
00260             LastCharDot = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00261         }
00262 
00263         <a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> += 2;
00264         NextWchar += 1;
00265 
00266     } <span class="keywordflow">while</span> (<a class="code" href="../../d4/d0/cmconfig_8c.html#a6">Count</a> &lt; <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>.Length);
00267 
00268     <span class="comment">//</span>
00269     <span class="comment">//  We can't have a period at the end of the name.</span>
00270     <span class="comment">//</span>
00271 
00272     <span class="keywordflow">if</span> (LastCharDot) {
00273 
00274         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00275     }
00276 
00277     <span class="comment">//</span>
00278     <span class="comment">//  Create an Oem name to use to check for a valid short name.</span>
00279     <span class="comment">//</span>
00280 
00281     DbcsName.MaximumLength = <a class="code" href="../../d9/d7/udf_8h.html#a11">BYTE_COUNT_8_DOT_3</a>;
00282     DbcsName.Buffer = DbcsNameBuffer;
00283 
00284     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d6/d6/nls_8c.html#a29">RtlUnicodeStringToCountedOemString</a>( &amp;DbcsName,
00285                                                          &amp;FileName,
00286                                                          FALSE ))) {
00287 
00288         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00289     }
00290 
00291     <span class="comment">//</span>
00292     <span class="comment">//  We have now initialized the Oem string.  Call the FsRtl package to check for a</span>
00293     <span class="comment">//  valid FAT name.</span>
00294     <span class="comment">//</span>
00295 
00296     <span class="keywordflow">return</span> <a class="code" href="../../d1/d8/fsrtl_8h.html#a134">FsRtlIsFatDbcsLegal</a>( DbcsName, FALSE, FALSE, FALSE );
00297 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a188" doxytag="udfprocs.h::UdfIsCharacterLegal" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> INLINE BOOLEAN UdfIsCharacterLegal           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN WCHAR&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Character</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01208">1208</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00962">FsRtlIsAnsiCharacterLegalHpfs</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01239">UdfCS0DstringContainsLegalCharacters()</a>.
<p>
<pre class="fragment"><div>01214                    :
01215 
01216     This routine checks that a given UNICODE character <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> legal.
01217     
01218 Arguments:
01219 
01220     Character - a character to check
01221     
01222 Return Value:
01223 
01224     BOOLEAN True <span class="keywordflow">if</span> a legal character, False otherwise.
01225     
01226 --*/
01227 
01228 {
01229     <span class="keywordflow">if</span> (Character &lt; 0xff &amp;&amp; !<a class="code" href="../../d1/d8/fsrtl_8h.html#a31">FsRtlIsAnsiCharacterLegalHpfs</a>( Character, FALSE )) {
01230 
01231         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01232     }
01233 
01234     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01235 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a184" doxytag="udfprocs.h::UdfIsNameInExpression" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN UdfIsNameInExpression           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>CurrentName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>SearchExpression</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>Wild</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d4/namesup_8c-source.html#l01203">1203</a> of file <a class="el" href="../../d6/d4/namesup_8c-source.html">namesup.c</a>.
<p>
References <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00352">ASSERT_IRP_CONTEXT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d4/name_8c-source.html#l00415">FsRtlIsNameInExpression()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l01500">UdfEnumerateIndex()</a>.
<p>
<pre class="fragment"><div>01212                    :
01213 
01214     This routine will compare two <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a96">Unicode</a> strings.  We assume that <span class="keywordflow">if</span> <span class="keyword">this</span>
01215     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to be a <span class="keywordflow">case</span>-insensitive search then they are already upcased.
01216 
01217 Arguments:
01218 
01219     CurrentName - Filename from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> disk.
01220 
01221     SearchExpression - Filename expression to use <span class="keywordflow">for</span> match.
01222     
01223     Wild - True <span class="keywordflow">if</span> wildcards are present in SearchExpression.
01224 
01225 Return Value:
01226 
01227     BOOLEAN - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> expressions match, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise.
01228 
01229 --*/
01230 
01231 {
01232     BOOLEAN Match = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01233     
01234     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01235 
01236     <span class="comment">//</span>
01237     <span class="comment">//  Check inputs.</span>
01238     <span class="comment">//</span>
01239 
01240     <a class="code" href="../../d1/d8/udfdata_8h.html#a28">ASSERT_IRP_CONTEXT</a>( IrpContext );
01241 
01242     <span class="comment">//</span>
01243     <span class="comment">//  If there are wildcards in the expression then we call the</span>
01244     <span class="comment">//  appropriate FsRtlRoutine.</span>
01245     <span class="comment">//</span>
01246 
01247     <span class="keywordflow">if</span> (Wild) {
01248 
01249         Match = <a class="code" href="../../d1/d8/fsrtl_8h.html#a179">FsRtlIsNameInExpression</a>( SearchExpression,
01250                                          CurrentName,
01251                                          FALSE,
01252                                          NULL );
01253 
01254     <span class="comment">//</span>
01255     <span class="comment">//  Otherwise do a direct memory comparison for the name string.</span>
01256     <span class="comment">//</span>
01257 
01258     } <span class="keywordflow">else</span> {
01259 
01260         <span class="keywordflow">if</span> ((CurrentName-&gt;Length != SearchExpression-&gt;Length) ||
01261             (!RtlEqualMemory( CurrentName-&gt;Buffer,
01262                               SearchExpression-&gt;Buffer,
01263                               CurrentName-&gt;Length ))) {
01264 
01265             Match = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01266         }
01267     }
01268 
01269     <span class="keywordflow">return</span> Match;
01270 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a190" doxytag="udfprocs.h::UdfLockVolumeInternal" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS UdfLockVolumeInternal           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d7/d5/struct__VCB.html">PVCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Vcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l00621">621</a> of file <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html">udfs/fsctrl.c</a>.
<p>
References <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00364">ASSERT_EXCLUSIVE_VCB</a>, <a class="el" href="../../d6/d0/lazyrite_8c-source.html#l00158">CcWaitForCurrentLazyWriterActivity()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01235">IRP_CONTEXT_FLAG_WAIT</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00505">SetFlag</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01515">UdfAcquireVcbExclusive</a>, <a class="el" href="../../d3/d8/close_8c-source.html#l00099">UdfFspClose()</a>, <a class="el" href="../../d9/d1/udfs_2cachesup_8c-source.html#l00417">UdfPurgeVolume()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01521">UdfReleaseVcb</a>, and <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00683">VCB_STATE_LOCKED</a>.
<p>
Referenced by <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l00780">UdfLockVolume()</a>, and <a class="el" href="../../d5/d8/udfs_2pnp_8c-source.html#l00194">UdfPnpQueryRemove()</a>.
<p>
<pre class="fragment"><div>00629                    :
00630 
00631     This routine performs <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> actual lock volume operation.  It will be called
00632     by anyone wishing to <span class="keywordflow">try</span> to protect <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> volume <span class="keywordflow">for</span> a <span class="keywordtype">long</span> duration.  PNP
00633     operations are such a user.
00634     
00635     The volume must be held exclusive by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller.
00636 
00637 Arguments:
00638 
00639     Vcb - The volume being locked.
00640     
00641     FileObject - <a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a> corresponding to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle locking <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> volume.  If <span class="keyword">this</span>
00642         <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not specified, a system lock <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> assumed.
00643 
00644 Return Value:
00645 
00646     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - The <span class="keywordflow">return</span> status <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation
00647 
00648 --*/
00649 
00650 {
00651     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00652     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> FinalStatus = (FileObject? STATUS_ACCESS_DENIED: STATUS_DEVICE_BUSY);
00653     ULONG RemainingUserReferences = (FileObject? 1: 0);
00654 
00655     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00656 
00657     <a class="code" href="../../d1/d8/udfdata_8h.html#a40">ASSERT_EXCLUSIVE_VCB</a>( Vcb );
00658     
00659     <span class="comment">//</span>
00660     <span class="comment">//  If the volume is already locked then complete with success if this file</span>
00661     <span class="comment">//  object has the volume locked, fail otherwise.</span>
00662     <span class="comment">//</span>
00663 
00664     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Vcb-&gt;VcbState, VCB_STATE_LOCKED )) {
00665 
00666         <span class="keywordflow">if</span> (FileObject &amp;&amp; Vcb-&gt;VolumeLockFileObject == FileObject) {
00667 
00668             FinalStatus = STATUS_SUCCESS;
00669         }
00670 
00671     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Vcb-&gt;VcbCleanup == RemainingUserReferences) {
00672 
00673         <span class="comment">//</span>
00674         <span class="comment">//  The cleanup count for the volume only reflects the fileobject that</span>
00675         <span class="comment">//  will lock the volume.  Otherwise, we must fail the request.</span>
00676         <span class="comment">//</span>
00677         <span class="comment">//  Since the only cleanup is for the provided fileobject, we will try</span>
00678         <span class="comment">//  to get rid of all of the other user references.  If there is only one</span>
00679         <span class="comment">//  remaining after the purge then we can allow the volume to be locked.</span>
00680         <span class="comment">//</span>
00681         
00682         <a class="code" href="../../d3/d8/udfprocs_8h.html#a158">UdfPurgeVolume</a>( IrpContext, Vcb, FALSE );
00683 
00684         <span class="comment">//</span>
00685         <span class="comment">//  Now back out of our synchronization and wait for the lazy writer</span>
00686         <span class="comment">//  to finish off any lazy closes that could have been outstanding.</span>
00687         <span class="comment">//</span>
00688         <span class="comment">//  Since we purged, we know that the lazy writer will issue all</span>
00689         <span class="comment">//  possible lazy closes in the next tick - if we hadn't, an otherwise</span>
00690         <span class="comment">//  unopened file with a large amount of dirty data could have hung</span>
00691         <span class="comment">//  around for a while as the data trickled out to the disk.</span>
00692         <span class="comment">//</span>
00693         <span class="comment">//  This is even more important now since we send notification to</span>
00694         <span class="comment">//  alert other folks that this style of check is about to happen so</span>
00695         <span class="comment">//  that they can close their handles.  We don't want to enter a fast</span>
00696         <span class="comment">//  race with the lazy writer tearing down his references to the file.</span>
00697         <span class="comment">//</span>
00698 
00699         <a class="code" href="../../d3/d8/udfprocs_8h.html#a76">UdfReleaseVcb</a>( IrpContext, Vcb );
00700 
00701         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d1/lazyrite_8c.html#a6">CcWaitForCurrentLazyWriterActivity</a>();
00702 
00703         <span class="comment">//</span>
00704         <span class="comment">//  This is intentional. If we were able to get the Vcb before, just</span>
00705         <span class="comment">//  wait for it and take advantage of knowing that it is OK to leave</span>
00706         <span class="comment">//  the flag up.</span>
00707         <span class="comment">//</span>
00708 
00709         <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( IrpContext-&gt;Flags, IRP_CONTEXT_FLAG_WAIT );
00710         <a class="code" href="../../d3/d8/udfprocs_8h.html#a74">UdfAcquireVcbExclusive</a>( IrpContext, Vcb, FALSE );
00711         
00712         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00713 
00714             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00715         }
00716 
00717         <a class="code" href="../../d3/d8/udfprocs_8h.html#a250">UdfFspClose</a>( Vcb );
00718 
00719         <span class="keywordflow">if</span> (Vcb-&gt;VcbUserReference == Vcb-&gt;VcbResidualUserReference + RemainingUserReferences) {
00720 
00721             <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( Vcb-&gt;VcbState, VCB_STATE_LOCKED );
00722             Vcb-&gt;VolumeLockFileObject = FileObject;
00723             FinalStatus = STATUS_SUCCESS;
00724         }
00725     }
00726     
00727     <span class="keywordflow">return</span> FinalStatus;
00728 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a223" doxytag="udfprocs.h::UdfLookupActiveIcb" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID UdfLookupActiveIcb           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d9/d9/struct__ICB__SEARCH__CONTEXT.html">PICB_SEARCH_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IcbContext</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l03124">3124</a> of file <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html">udfs/strucsup.c</a>.
<p>
References <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00352">ASSERT_IRP_CONTEXT</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d0/d7/udf_8h-source.html#l00248">UDF_ICB_RECURSION_LIMIT</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l03790">UdfLookupActiveIcbInExtent()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00406">UdfRaiseStatus()</a>, and <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00828">UdfUnpinView</a>.
<p>
Referenced by <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l01688">UdfLookupFileEntryInEnumeration()</a>, <a class="el" href="../../d4/d7/udfs_2create_8c-source.html#l01244">UdfOpenObjectByFileId()</a>, <a class="el" href="../../d4/d7/udfs_2create_8c-source.html#l01632">UdfOpenObjectFromDirContext()</a>, and <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l00997">UdfUpdateVcbPhase1()</a>.
<p>
<pre class="fragment"><div>03131                    :
03132 
03133     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called to cause <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> active Icb <span class="keywordflow">for</span> an Icb hierarchy to be mapped.
03134     <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> context initialized by <a class="code" href="../../d3/d8/udfprocs_8h.html#a221">UdfInitializeIcbContext</a>() is required.
03135 
03136 Arguments:
03137 
03138     IcbContext - Context which has been initialized to point into an Icb hierarchy.
03139 
03140 Return Value:
03141 
03142     None.
03143     
03144     Raised status if the Icb hierarchy is invalid.
03145 
03146 --*/
03147 
03148 {
03149     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03150 
03151     <span class="comment">//</span>
03152     <span class="comment">//  Check input parameters.</span>
03153     <span class="comment">//</span>
03154 
03155     <a class="code" href="../../d1/d8/udfdata_8h.html#a28">ASSERT_IRP_CONTEXT</a>( IrpContext );
03156 
03157     <span class="comment">//</span>
03158     <span class="comment">//  Travel the Icb hierarchy.  Due to the design of ISO 13346, it is convenient to</span>
03159     <span class="comment">//  recursively descend the hierarchy.  Place a limit on this recursion which will</span>
03160     <span class="comment">//  allow traversal of most reasonable hierarchies (this will tail recurse off of</span>
03161     <span class="comment">//  the end of extents).</span>
03162     <span class="comment">//</span>
03163 
03164     <a class="code" href="../../d9/d7/udfs_2strucsup_8c.html#a25">UdfLookupActiveIcbInExtent</a>( IrpContext,
03165                                 IcbContext,
03166                                 UDF_ICB_RECURSION_LIMIT );
03167 
03168     <span class="comment">//</span>
03169     <span class="comment">//  We must have found an active ICB.  Drop the last mapped part of the enumeration</span>
03170     <span class="comment">//  at this point.</span>
03171     <span class="comment">//</span>
03172 
03173     <a class="code" href="../../d3/d8/udfprocs_8h.html#a68">UdfUnpinView</a>( IrpContext, &amp;IcbContext-&gt;Current );
03174 
03175     <span class="keywordflow">if</span> (IcbContext-&gt;Active.View == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
03176 
03177         <a class="code" href="../../d3/d8/udfprocs_8h.html#a122">UdfRaiseStatus</a>( IrpContext, STATUS_FILE_CORRUPT_ERROR );
03178     }
03179 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a146" doxytag="udfprocs.h::UdfLookupAllocation" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN UdfLookupAllocation           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d7/d9/struct__FCB.html">PFCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Fcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN LONGLONG&nbsp;</td>
          <td class="mdname" nowrap> <em>FileOffset</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PLONGLONG&nbsp;</td>
          <td class="mdname" nowrap> <em>DiskOffset</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ByteCount</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d5/allocsup_8c-source.html#l00069">69</a> of file <a class="el" href="../../d3/d5/allocsup_8c-source.html">allocsup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00338">ASSERT_FCB</a>, <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00352">ASSERT_IRP_CONTEXT</a>, <a class="el" href="../../d4/d7/fsrtlp_8h-source.html#l00231">BytesFromSectors</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01064">FCB_STATE_EMBEDDED_DATA</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01065">FCB_STATE_MCB_INITIALIZED</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01063">FCB_STATE_VMCB_MAPPING</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d1/d8/fsrtl_8h.html#a145">FsRtlLookupLargeMcbEntry()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00220">LlBytesFromSectors</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00224">LlSectorsFromBytes</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00535">_VCB::Pcb</a>, <a class="el" href="../../d6/d8/udfstruc_8h.html#a89">PFCB</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00232">SectorOffset</a>, <a class="el" href="../../d4/d7/fsrtlp_8h-source.html#l00222">SectorsFromBytes</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00428">_PCB::SparingMcb</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d0/d7/udf_8h-source.html#l00197">UdfMethod2NextRunoutInSectors</a>, <a class="el" href="../../d0/d7/udf_8h-source.html#l00181">UdfMethod2TransformByteOffset</a>, <a class="el" href="../../d7/d5/vmcbsup_8c-source.html#l00461">UdfVmcbVbnToLbn()</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00686">VCB_STATE_METHOD_2_FIXUP</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00558">_VCB::VcbState</a>, and <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00637">_VCB::Vmcb</a>.
<p>
Referenced by <a class="el" href="../../d4/d6/deviosup_8c-source.html#l00883">UdfPrepareBuffers()</a>.
<p>
<pre class="fragment"><div>00079                    :
00080 
00081     This routine looks through <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> mapping information <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>
00082     to find <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> logical diskoffset and number of bytes at that offset.
00083 
00084     This routine assumes we are looking up a valid range in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.  If
00085     a mapping does not exist,
00086 
00087 Arguments:
00088 
00089     Fcb - Fcb representing <span class="keyword">this</span> stream.
00090 
00091     FileOffset - Lookup <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> allocation beginning at <span class="keyword">this</span> point.
00092 
00093     DiskOffset - Address to store <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> logical disk offset.
00094 
00095     ByteCount - Address to store <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of contiguous bytes beginning
00096         at DiskOffset above.
00097 
00098 Return Value:
00099 
00100     BOOLEAN - whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> extent <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> unrecorded data
00101 
00102 --*/
00103 
00104 {
00105     <a class="code" href="../../d7/d5/struct__VCB.html">PVCB</a> Vcb;
00106 
00107     BOOLEAN Recorded = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00108 
00109     BOOLEAN Result;
00110 
00111     LARGE_INTEGER LocalPsn;
00112     LARGE_INTEGER LocalSectorCount;
00113 
00114     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00115 
00116     <span class="comment">//</span>
00117     <span class="comment">//  Check inputs</span>
00118     <span class="comment">//</span>
00119 
00120     <a class="code" href="../../d1/d8/udfdata_8h.html#a28">ASSERT_IRP_CONTEXT</a>( IrpContext );
00121     <a class="code" href="../../d1/d8/udfdata_8h.html#a14">ASSERT_FCB</a>( Fcb );
00122 
00123     <span class="comment">//</span>
00124     <span class="comment">//  We will never be looking up the allocations of embedded objects.</span>
00125     <span class="comment">//</span>
00126 
00127     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( !<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Fcb-&gt;FcbState, FCB_STATE_EMBEDDED_DATA ));
00128 
00129     Vcb = Fcb-&gt;Vcb;
00130 
00131     LocalPsn.QuadPart = LocalSectorCount.QuadPart = 0;
00132 
00133     <span class="comment">//</span>
00134     <span class="comment">//  Lookup the entry containing this file offset.</span>
00135     <span class="comment">//</span>
00136 
00137     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Fcb-&gt;FcbState, FCB_STATE_VMCB_MAPPING )) {
00138 
00139         <span class="comment">//</span>
00140         <span class="comment">//  Map this offset into the metadata stream.</span>
00141         <span class="comment">//</span>
00142 
00143         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d3/d8/udfprocs_8h.html#a43">SectorOffset</a>( Vcb, FileOffset ) == 0 );
00144 
00145         Result = <a class="code" href="../../d6/d6/vmcbsup_8c.html#a9">UdfVmcbVbnToLbn</a>( &amp;Vcb-&gt;<a class="code" href="../../d7/d5/struct__VCB.html#o24">Vmcb</a>,
00146                                   <a class="code" href="../../d3/d8/fsrtlp_8h.html#a13">SectorsFromBytes</a>( Vcb, FileOffset ),
00147                                   &amp;LocalPsn.LowPart,
00148                                   &amp;LocalSectorCount.LowPart );
00149 
00150         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( Result );
00151 
00152     } <span class="keywordflow">else</span> {
00153 
00154         <span class="comment">//</span>
00155         <span class="comment">//  Map this offset in a regular stream.</span>
00156         <span class="comment">//</span>
00157 
00158         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Fcb-&gt;FcbState, FCB_STATE_MCB_INITIALIZED ));
00159 
00160         Result = <a class="code" href="../../d1/d8/fsrtl_8h.html#a145">FsRtlLookupLargeMcbEntry</a>( &amp;Fcb-&gt;Mcb,
00161                                            <a class="code" href="../../d3/d8/udfprocs_8h.html#a40">LlSectorsFromBytes</a>( Vcb, FileOffset ),
00162                                            &amp;LocalPsn.QuadPart,
00163                                            &amp;LocalSectorCount.QuadPart,
00164                                            NULL,
00165                                            NULL,
00166                                            NULL );
00167     }
00168 
00169     <span class="comment">//</span>
00170     <span class="comment">//  If within the Mcb then we use the data out of this entry and are nearly done.</span>
00171     <span class="comment">//</span>
00172 
00173     <span class="keywordflow">if</span> (Result) {
00174 
00175         <span class="keywordflow">if</span> ( LocalPsn.QuadPart == -1 ) {
00176 
00177             <span class="comment">//</span>
00178             <span class="comment">//  Regular files can have holey allocations which represent unrecorded extents.  For</span>
00179             <span class="comment">//  such extents which are sandwiched in between recorded extents of the file, the Mcb</span>
00180             <span class="comment">//  package tells us that it found a valid mapping but that it doesn't correspond to</span>
00181             <span class="comment">//  any extents on the media yet.  In this case, simply fake the disk offset.  The</span>
00182             <span class="comment">//  returned sector count is accurate.</span>
00183             <span class="comment">//</span>
00184 
00185             *DiskOffset = 0;
00186 
00187             Recorded = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00188 
00189         } <span class="keywordflow">else</span> {
00190 
00191             <span class="comment">//</span>
00192             <span class="comment">//  Now mimic the effects of physical sector sparing.  This may shrink the size of the</span>
00193             <span class="comment">//  returned run if sparing interrupted the extent on disc.</span>
00194             <span class="comment">//</span>
00195 
00196             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( LocalPsn.HighPart == 0 );
00197 
00198             <span class="keywordflow">if</span> (Vcb-&gt;<a class="code" href="../../d7/d5/struct__VCB.html#o3">Pcb</a>-&gt;<a class="code" href="../../d4/d9/struct__PCB.html#o4">SparingMcb</a>) {
00199 
00200                 LONGLONG SparingPsn;
00201                 LONGLONG SparingSectorCount;
00202 
00203                 <span class="keywordflow">if</span> (<a class="code" href="../../d1/d8/fsrtl_8h.html#a145">FsRtlLookupLargeMcbEntry</a>( Vcb-&gt;<a class="code" href="../../d7/d5/struct__VCB.html#o3">Pcb</a>-&gt;<a class="code" href="../../d4/d9/struct__PCB.html#o4">SparingMcb</a>,
00204                                               LocalPsn.LowPart,
00205                                               &amp;SparingPsn,
00206                                               &amp;SparingSectorCount,
00207                                               NULL,
00208                                               NULL,
00209                                               NULL )) {
00210 
00211                     <span class="comment">//</span>
00212                     <span class="comment">//  Only emit noise if we will really change anything as a result</span>
00213                     <span class="comment">//  of the sparing table.</span>
00214                     <span class="comment">//</span>
00215 
00216                     <span class="keywordflow">if</span> (SparingPsn != -1 ||
00217                         SparingSectorCount &lt; LocalSectorCount.QuadPart) {
00218 
00219                         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( 0, Dbg, <span class="stringliteral">"UdfLookupAllocation, spared [%x, +%x) onto [%x, +%x)\n"</span>,
00220                                              LocalPsn.LowPart,
00221                                              LocalSectorCount.LowPart,
00222                                              (ULONG) SparingPsn,
00223                                              (ULONG) SparingSectorCount ));
00224                     }
00225 
00226                     <span class="comment">//</span>
00227                     <span class="comment">//  If we did not land in a hole, map the sector.</span>
00228                     <span class="comment">//</span>
00229 
00230                     <span class="keywordflow">if</span> (SparingPsn != -1) {
00231 
00232                         LocalPsn.QuadPart = SparingPsn;
00233                     }
00234 
00235                     <span class="comment">//</span>
00236                     <span class="comment">//  The returned sector count now reduces the previous sector count.</span>
00237                     <span class="comment">//  If we landed in a hole, this indicates that the trailing edge of</span>
00238                     <span class="comment">//  the extent is spared, if not this indicates that the leading</span>
00239                     <span class="comment">//  edge is spared.</span>
00240                     <span class="comment">//</span>
00241 
00242                     <span class="keywordflow">if</span> (SparingSectorCount &lt; LocalSectorCount.QuadPart) {
00243 
00244                         LocalSectorCount.QuadPart = SparingSectorCount;
00245                     }
00246                 }
00247             }
00248 
00249             *DiskOffset = <a class="code" href="../../d3/d8/udfprocs_8h.html#a39">LlBytesFromSectors</a>( Vcb, LocalPsn.QuadPart ) + <a class="code" href="../../d3/d8/udfprocs_8h.html#a43">SectorOffset</a>( Vcb, FileOffset );
00250 
00251             <span class="comment">//</span>
00252             <span class="comment">//  Now we can apply method 2 fixups, which will again interrupt the size of the extent.</span>
00253             <span class="comment">//</span>
00254 
00255             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Vcb-&gt;<a class="code" href="../../d7/d5/struct__VCB.html#o7">VcbState</a>, VCB_STATE_METHOD_2_FIXUP )) {
00256 
00257                 LARGE_INTEGER SectorsToRunout;
00258 
00259                 SectorsToRunout.QuadPart= <a class="code" href="../../d9/d7/udf_8h.html#a10">UdfMethod2NextRunoutInSectors</a>( Vcb, *DiskOffset );
00260 
00261                 <span class="keywordflow">if</span> (SectorsToRunout.QuadPart &lt; LocalSectorCount.QuadPart) {
00262 
00263                     LocalSectorCount.QuadPart = SectorsToRunout.QuadPart;
00264                 }
00265 
00266                 *DiskOffset = <a class="code" href="../../d9/d7/udf_8h.html#a8">UdfMethod2TransformByteOffset</a>( Vcb, *DiskOffset );
00267             }
00268         }
00269 
00270     } <span class="keywordflow">else</span> {
00271 
00272         <span class="comment">//</span>
00273         <span class="comment">//  We know that prior to this call the system has restricted IO to points within the</span>
00274         <span class="comment">//  the file data.  Since we failed to find a mapping this is an unrecorded extent at</span>
00275         <span class="comment">//  the end of the file, so just conjure up a proper representation.</span>
00276         <span class="comment">//</span>
00277 
00278         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( FileOffset &lt; Fcb-&gt;FileSize.QuadPart );
00279 
00280         *DiskOffset = 0;
00281 
00282         LocalSectorCount.QuadPart = <a class="code" href="../../d3/d8/udfprocs_8h.html#a40">LlSectorsFromBytes</a>( Vcb, Fcb-&gt;FileSize.QuadPart ) -
00283                                     <a class="code" href="../../d3/d8/udfprocs_8h.html#a40">LlSectorsFromBytes</a>( Vcb, FileOffset ) +
00284                                     1;
00285 
00286         Recorded = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00287     }
00288 
00289     <span class="comment">//</span>
00290     <span class="comment">//  Restrict to MAXULONG bytes of allocation</span>
00291     <span class="comment">//</span>
00292 
00293     <span class="keywordflow">if</span> (LocalSectorCount.QuadPart &gt; <a class="code" href="../../d3/d8/fsrtlp_8h.html#a13">SectorsFromBytes</a>( Vcb, MAXULONG )) {
00294 
00295         *ByteCount = MAXULONG;
00296 
00297     } <span class="keywordflow">else</span> {
00298 
00299         *ByteCount = <a class="code" href="../../d3/d8/fsrtlp_8h.html#a14">BytesFromSectors</a>( Vcb, LocalSectorCount.LowPart );
00300     }
00301 
00302     *ByteCount -= <a class="code" href="../../d3/d8/udfprocs_8h.html#a43">SectorOffset</a>( Vcb, FileOffset );
00303 
00304     <span class="keywordflow">return</span> Recorded;
00305 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a211" doxytag="udfprocs.h::UdfLookupFcbTable" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> <a class="el" href="../../d7/d9/struct__FCB.html">PFCB</a> UdfLookupFcbTable           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d7/d5/struct__VCB.html">PVCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Vcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d6/d8/udfstruc_8h.html#a77">FILE_ID</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileId</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l01949">1949</a> of file <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html">udfs/strucsup.c</a>.
<p>
References <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l00043">_FCB_TABLE_ELEMENT::Fcb</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00746">FILE_ID</a>, <a class="el" href="../../d3/d9/nt6_2user32_8def-source.html#l00417">Key</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d9/d7/udfs_2strucsup_8c.html#a13">PFCB_TABLE_ELEMENT</a>, and <a class="el" href="../../d7/d0/gentable_8c-source.html#l00619">RtlLookupElementGenericTable()</a>.
<p>
Referenced by <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l02041">UdfCreateFcb()</a>.
<p>
<pre class="fragment"><div>01957                    :
01958 
01959     This routine will look through <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Fcb table looking <span class="keywordflow">for</span> a <a class="code" href="../../d7/d1/genuedef_8c.html#a7">matching</a>
01960     entry.
01961 
01962 Arguments:
01963 
01964     Vcb - Vcb <span class="keywordflow">for</span> <span class="keyword">this</span> volume.
01965 
01966     FileId - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> key value to use <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> search.
01967 
01968 Return Value:
01969 
01970     <a class="code" href="../../d7/d9/struct__FCB.html">PFCB</a> - <a class="code" href="../../d2/d1/bench_8h.html#a5">A</a> pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a7">matching</a> entry or <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> otherwise.
01971 
01972 --*/
01973 
01974 {
01975     <a class="code" href="../../d5/d0/struct__FCB__TABLE__ELEMENT.html">FCB_TABLE_ELEMENT</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>;
01976     <a class="code" href="../../d5/d0/struct__FCB__TABLE__ELEMENT.html">PFCB_TABLE_ELEMENT</a> Hit;
01977     <a class="code" href="../../d7/d9/struct__FCB.html">PFCB</a> ReturnFcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01978 
01979     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01980 
01981     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a51">Key</a>.FileId = FileId;
01982 
01983     Hit = (<a class="code" href="../../d5/d0/struct__FCB__TABLE__ELEMENT.html">PFCB_TABLE_ELEMENT</a>) <a class="code" href="../../d6/d1/gentable_8c.html#a7">RtlLookupElementGenericTable</a>( &amp;Vcb-&gt;FcbTable, &amp;Key );
01984 
01985     <span class="keywordflow">if</span> (Hit != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01986 
01987         ReturnFcb = Hit-&gt;<a class="code" href="../../d5/d0/struct__FCB__TABLE__ELEMENT.html#o1">Fcb</a>;
01988     }
01989 
01990     <span class="keywordflow">return</span> ReturnFcb;
01991 
01992     UNREFERENCED_PARAMETER( IrpContext );
01993 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a169" doxytag="udfprocs.h::UdfLookupInitialDirEntry" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN UdfLookupInitialDirEntry           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d7/d9/struct__FCB.html">PFCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Fcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d5/d5/struct__DIR__ENUM__CONTEXT.html">PDIR_ENUM_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DirContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PLONGLONG InitialOffset&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d7/dirsup_8c-source.html#l00165">165</a> of file <a class="el" href="../../d5/d7/dirsup_8c-source.html">dirsup.c</a>.
<p>
References <a class="el" href="../../d3/d6/notify_8c-source.html#l00236">Add2Ptr</a>, <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00342">ASSERT_FCB_INDEX</a>, <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00352">ASSERT_IRP_CONTEXT</a>, <a class="el" href="../../d3/d8/pinsup_8c-source.html#l00052">CcMapData()</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01699">DIR_CONTEXT_FLAG_SEEN_NONCONSTANT</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01700">DIR_CONTEXT_FLAG_SEEN_PARENT</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00122">GenericOffset</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00114">GenericTruncate</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d9/d1/udfs_2cachesup_8c-source.html#l00046">UdfCreateInternalStream()</a>, <a class="el" href="../../d5/d7/dirsup_8c-source.html#l00916">UdfLookupDirEntryPostProcessing()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00838">UdfUnpinData</a>, and <a class="el" href="../../d5/d1/cache_8h-source.html#l00030">VACB_MAPPING_GRANULARITY</a>.
<p>
Referenced by <a class="el" href="../../d5/d7/dirsup_8c-source.html#l00726">UdfFindDirEntry()</a>, <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l01800">UdfLookupInitialFileIndex()</a>, and <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l01863">UdfLookupNextFileIndex()</a>.
<p>
<pre class="fragment"><div>00174                    :
00175 
00176     This routine begins <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> enumeration of a directory by setting <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> context
00177     at <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> first avaliable directory entry.
00178 
00179 Arguments:
00180 
00181     Fcb - <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> directory being enumerated.
00182     
00183     DirContext - a corresponding context <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> enumeration.
00184     
00185     InitialOffset - an optional starting byte offset to base <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> enumeration.
00186 
00187 Return Value:
00188 
00189     If InitialOffset <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> unspecified, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> will always be returned.  Failure will result
00190     in a raised status indicating corruption.
00191     
00192     If InitialOffset <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> specified, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> will be returned <span class="keywordflow">if</span> a valid entry <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> found at <span class="keyword">this</span>
00193     offset, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise.
00194 
00195 --*/
00196 
00197 {
00198     BOOLEAN Result;
00199 
00200     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00201     
00202     <span class="comment">//</span>
00203     <span class="comment">//  Check inputs.</span>
00204     <span class="comment">//</span>
00205 
00206     <a class="code" href="../../d1/d8/udfdata_8h.html#a28">ASSERT_IRP_CONTEXT</a>( IrpContext );
00207     <a class="code" href="../../d1/d8/udfdata_8h.html#a18">ASSERT_FCB_INDEX</a>( Fcb );
00208     
00209     <span class="comment">//</span>
00210     <span class="comment">//  Create the internal stream if it isn't already in place.</span>
00211     <span class="comment">//</span>
00212 
00213     <span class="keywordflow">if</span> (Fcb-&gt;FileObject == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00214 
00215         <a class="code" href="../../d3/d8/udfprocs_8h.html#a154">UdfCreateInternalStream</a>( IrpContext, Fcb-&gt;Vcb, Fcb );
00216     }
00217 
00218     <span class="comment">//</span>
00219     <span class="comment">//  Reset the flags.</span>
00220     <span class="comment">//</span>
00221 
00222     DirContext-&gt;Flags = 0;
00223     
00224     <span class="keywordflow">if</span> (InitialOffset) {
00225 
00226         <span class="comment">//</span>
00227         <span class="comment">//  If we are beginning in the middle of the stream, adjust the sanity check flags.</span>
00228         <span class="comment">//</span>
00229         
00230         <span class="keywordflow">if</span> (*InitialOffset != 0) {
00231 
00232             DirContext-&gt;Flags = <a class="code" href="../../d6/d8/udfstruc_8h.html#a52">DIR_CONTEXT_FLAG_SEEN_NONCONSTANT</a> | <a class="code" href="../../d6/d8/udfstruc_8h.html#a53">DIR_CONTEXT_FLAG_SEEN_PARENT</a>;
00233         }
00234 
00235         <span class="comment">//</span>
00236         <span class="comment">//  Now set up the range we will map.  This is constrained by the size of a cache view.</span>
00237         <span class="comment">//</span>
00238         
00239         DirContext-&gt;BaseOffset.QuadPart = <a class="code" href="../../d3/d8/udfprocs_8h.html#a12">GenericTruncate</a>( *InitialOffset, VACB_MAPPING_GRANULARITY );
00240         DirContext-&gt;ViewOffset = (ULONG) <a class="code" href="../../d3/d8/udfprocs_8h.html#a14">GenericOffset</a>( *InitialOffset, VACB_MAPPING_GRANULARITY );
00241 
00242     } <span class="keywordflow">else</span> {
00243         
00244         <span class="comment">//</span>
00245         <span class="comment">//  Map at the beginning.</span>
00246         <span class="comment">//</span>
00247     
00248         DirContext-&gt;BaseOffset.QuadPart = 0;
00249         DirContext-&gt;ViewOffset = 0;
00250     }
00251 
00252     <span class="comment">//</span>
00253     <span class="comment">//  Contain the view length by the size of the stream and map.</span>
00254     <span class="comment">//</span>
00255 
00256     DirContext-&gt;ViewLength = <a class="code" href="../../d4/d2/cache_8h.html#a0">VACB_MAPPING_GRANULARITY</a>;
00257 
00258     <span class="keywordflow">if</span> (DirContext-&gt;BaseOffset.QuadPart + DirContext-&gt;ViewLength &gt; Fcb-&gt;FileSize.QuadPart) {
00259 
00260         DirContext-&gt;ViewLength = (ULONG) (Fcb-&gt;FileSize.QuadPart - DirContext-&gt;BaseOffset.QuadPart);
00261     }
00262     
00263     <a class="code" href="../../d3/d8/udfprocs_8h.html#a69">UdfUnpinData</a>( IrpContext, &amp;DirContext-&gt;Bcb );
00264     
00265     <a class="code" href="../../d4/d2/cache_8h.html#a88">CcMapData</a>( Fcb-&gt;FileObject,
00266                &amp;DirContext-&gt;BaseOffset,
00267                DirContext-&gt;ViewLength,
00268                TRUE,
00269                &amp;DirContext-&gt;Bcb,
00270                &amp;DirContext-&gt;View );
00271 
00272     DirContext-&gt;Fid = <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( DirContext-&gt;View, DirContext-&gt;ViewOffset, <a class="code" href="../../d1/d2/structNSR__FID.html">PNSR_FID</a> );
00273 
00274     <span class="comment">//</span>
00275     <span class="comment">//  The state of the context is now valid.  Tail off into our common post-processor</span>
00276     <span class="comment">//  to finish the work.</span>
00277     <span class="comment">//</span>
00278 
00279     <span class="keywordflow">return</span> <a class="code" href="../../d4/d8/dirsup_8c.html#a2">UdfLookupDirEntryPostProcessing</a>( IrpContext,
00280                                             Fcb,
00281                                             DirContext,
00282                                             (BOOLEAN) (InitialOffset != NULL));
00283 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a153" doxytag="udfprocs.h::UdfLookupMetaVsnOfExtent" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG UdfLookupMetaVsnOfExtent           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d7/d5/struct__VCB.html">PVCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Vcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Reference</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Lbn</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Len</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>ExactEnd</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d5/allocsup_8c-source.html#l01177">1177</a> of file <a class="el" href="../../d3/d5/allocsup_8c-source.html">allocsup.c</a>.
<p>
References <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00352">ASSERT_IRP_CONTEXT</a>, <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00336">ASSERT_VCB</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00280">BlockOffset</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00264">BlocksFromBytes</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00276">BlocksFromSectors</a>, <a class="el" href="../../d6/d7/fssup_8c-source.html#l01821">CcSetFileSizes()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00220">LlBytesFromSectors</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d4/d2/cache_8h.html#a13">PCC_FILE_SIZES</a>, <a class="el" href="../../d4/d7/fsrtlp_8h-source.html#l00222">SectorsFromBytes</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00436">try_leave</a>, <a class="el" href="../../d7/d5/vmcbsup_8c-source.html#l00637">UdfAddVmcbMapping()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01567">UdfLockFcb</a>, <a class="el" href="../../d3/d5/allocsup_8c-source.html#l01017">UdfLookupPsnOfExtent()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00406">UdfRaiseStatus()</a>, <a class="el" href="../../d7/d5/vmcbsup_8c-source.html#l00867">UdfRemoveVmcbMapping()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01577">UdfUnlockFcb</a>, and <a class="el" href="../../d7/d5/vmcbsup_8c-source.html#l00553">UdfVmcbLbnToVbn()</a>.
<p>
Referenced by <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l03388">UdfInitializeAllocations()</a>, <a class="el" href="../../d9/d1/udfs_2cachesup_8c-source.html#l00337">UdfMapMetadataView()</a>, and <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l00477">UdfUpdateVcbPhase0()</a>.
<p>
<pre class="fragment"><div>01188                    :
01189 
01190     This routine maps <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> input logical block extent on a given partition to
01191     a starting <span class="keyword">virtual</span> block in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> metadata stream.  If a mapping does not
01192     exist, one will be created and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> metadata stream extended.
01193 
01194 Arguments:
01195 
01196     Vcb - Vcb of logical volume
01197 
01198     Reference - Partition reference to use in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> mapping
01199 
01200     Lbn - Logical block number
01201 
01202     Len - Length of extent in bytes
01203     
01204     ExactEnd - Indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a6">extension</a> policy <span class="keywordflow">if</span> these blocks are not mapped.
01205 
01206 Return Value:
01207 
01208     ULONG <span class="keyword">virtual</span> sector number
01209 
01210     Raised status <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Lbn extent <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> split across multiple Vbn extents.
01211 
01212 --*/
01213 
01214 {
01215     ULONG Vsn;
01216     ULONG Psn;
01217     ULONG SectorCount;
01218 
01219     BOOLEAN Result;
01220 
01221     BOOLEAN UnwindExtension = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01222     LONGLONG UnwindAllocationSize;
01223 
01224     <a class="code" href="../../d7/d9/struct__FCB.html">PFCB</a> Fcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01225 
01226     <span class="comment">//</span>
01227     <span class="comment">//  Check inputs</span>
01228     <span class="comment">//</span>
01229 
01230     <a class="code" href="../../d1/d8/udfdata_8h.html#a28">ASSERT_IRP_CONTEXT</a>( IrpContext );
01231     <a class="code" href="../../d1/d8/udfdata_8h.html#a12">ASSERT_VCB</a>( Vcb );
01232 
01233     <span class="comment">//</span>
01234     <span class="comment">//  The extent must be an integral number of logical blocks in length.</span>
01235     <span class="comment">//</span>
01236 
01237     <span class="keywordflow">if</span> (Len == 0 || <a class="code" href="../../d3/d8/udfprocs_8h.html#a55">BlockOffset</a>( Vcb, Len )) {
01238 
01239         <a class="code" href="../../d3/d8/udfprocs_8h.html#a122">UdfRaiseStatus</a>( IrpContext, STATUS_FILE_CORRUPT_ERROR );
01240     }
01241 
01242 
01243     <span class="comment">//</span>
01244     <span class="comment">//  Get the physical mapping of the extent.  The Mcb package operates on ULONG/ULONG</span>
01245     <span class="comment">//  keys and values so we must render our 48bit address into 32.  We can do this since</span>
01246     <span class="comment">//  this is a single surface implementation, and it is guaranteed that a surface cannot</span>
01247     <span class="comment">//  contain more than MAXULONG physical sectors.</span>
01248     <span class="comment">//</span>
01249 
01250     Psn = <a class="code" href="../../d3/d8/udfprocs_8h.html#a152">UdfLookupPsnOfExtent</a>( IrpContext,
01251                                 Vcb,
01252                                 Reference,
01253                                 Lbn,
01254                                 Len );
01255 
01256     <span class="comment">//</span>
01257     <span class="comment">//  Use try-finally for cleanup</span>
01258     <span class="comment">//</span>
01259 
01260     <span class="keywordflow">try</span> {
01261 
01262         <span class="comment">//</span>
01263         <span class="comment">//  We must safely establish a mapping and extend the metadata stream so that cached</span>
01264         <span class="comment">//  reads can occur on this new extent.</span>
01265         <span class="comment">//</span>
01266 
01267         Fcb = Vcb-&gt;MetadataFcb;
01268         <a class="code" href="../../d3/d8/udfprocs_8h.html#a90">UdfLockFcb</a>( IrpContext, Fcb );
01269         
01270         Result = <a class="code" href="../../d6/d6/vmcbsup_8c.html#a10">UdfVmcbLbnToVbn</a>( &amp;Vcb-&gt;Vmcb,
01271                                   Psn,
01272                                   &amp;Vsn,
01273                                   &amp;SectorCount );
01274 
01275         <span class="keywordflow">if</span> (Result) {
01276 
01277             <span class="comment">//</span>
01278             <span class="comment">//  If the mapping covers the extent, we can give this back.</span>
01279             <span class="comment">//</span>
01280 
01281             <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/udfprocs_8h.html#a53">BlocksFromSectors</a>( Vcb, SectorCount ) &gt;= <a class="code" href="../../d3/d8/udfprocs_8h.html#a50">BlocksFromBytes</a>( Vcb, Len )) {
01282 
01283                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( NOTHING );
01284 
01285             }
01286 
01287             <span class="comment">//</span>
01288             <span class="comment">//  It is a fatal error if the extent we are mapping is not wholly contained</span>
01289             <span class="comment">//  by an extent of Vsns in the Vmcb.  This will indicate that some structure</span>
01290             <span class="comment">//  is trying to overlap another.</span>
01291             <span class="comment">//</span>
01292 
01293             <a class="code" href="../../d3/d8/udfprocs_8h.html#a122">UdfRaiseStatus</a>( IrpContext, STATUS_FILE_CORRUPT_ERROR );
01294         }
01295 
01296         <span class="comment">//</span>
01297         <span class="comment">//  Add the new mapping.  We know that it is being added to the end of the stream.</span>
01298         <span class="comment">//</span>
01299 
01300         <a class="code" href="../../d6/d6/vmcbsup_8c.html#a11">UdfAddVmcbMapping</a>( &amp;Vcb-&gt;Vmcb,
01301                            Psn,
01302                            <a class="code" href="../../d3/d8/fsrtlp_8h.html#a13">SectorsFromBytes</a>( Vcb, Len ),
01303                            ExactEnd,
01304                            &amp;Vsn,
01305                            &amp;SectorCount );
01306 
01307         UnwindAllocationSize = Fcb-&gt;AllocationSize.QuadPart;
01308         UnwindExtension = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01309 
01310         Fcb-&gt;AllocationSize.QuadPart =
01311         Fcb-&gt;FileSize.QuadPart =
01312         Fcb-&gt;ValidDataLength.QuadPart = <a class="code" href="../../d3/d8/udfprocs_8h.html#a39">LlBytesFromSectors</a>( Vcb, Vsn + SectorCount);
01313 
01314         <a class="code" href="../../d4/d2/cache_8h.html#a60">CcSetFileSizes</a>( Fcb-&gt;FileObject, (<a class="code" href="../../d1/d9/struct__CC__FILE__SIZES.html">PCC_FILE_SIZES</a>) &amp;Fcb-&gt;AllocationSize );
01315         UnwindExtension = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01316 
01317         <span class="comment">//</span>
01318         <span class="comment">//  We do not need to purge the cache maps since the Vmcb will always be</span>
01319         <span class="comment">//  page aligned, and thus any reads will have filled it with valid data.</span>
01320         <span class="comment">//</span>
01321 
01322     } finally {
01323 
01324         <span class="keywordflow">if</span> (UnwindExtension) {
01325 
01326             ULONG FirstZappedVsn;
01327 
01328             <span class="comment">//</span>
01329             <span class="comment">//  Strip off the additional mappings we made.</span>
01330             <span class="comment">//</span>
01331 
01332             Fcb-&gt;AllocationSize.QuadPart =
01333             Fcb-&gt;FileSize.QuadPart =
01334             Fcb-&gt;ValidDataLength.QuadPart = UnwindAllocationSize;
01335 
01336             FirstZappedVsn = <a class="code" href="../../d3/d8/fsrtlp_8h.html#a13">SectorsFromBytes</a>( Vcb, UnwindAllocationSize );
01337 
01338             <a class="code" href="../../d6/d6/vmcbsup_8c.html#a12">UdfRemoveVmcbMapping</a>( &amp;Vcb-&gt;Vmcb,
01339                                   FirstZappedVsn,
01340                                   Vsn + SectorCount - FirstZappedVsn );
01341 
01342             <a class="code" href="../../d4/d2/cache_8h.html#a60">CcSetFileSizes</a>( Fcb-&gt;FileObject, (<a class="code" href="../../d1/d9/struct__CC__FILE__SIZES.html">PCC_FILE_SIZES</a>) &amp;Fcb-&gt;AllocationSize );
01343         }
01344 
01345         <span class="keywordflow">if</span> (Fcb) { <a class="code" href="../../d3/d8/udfprocs_8h.html#a91">UdfUnlockFcb</a>( IrpContext, Fcb ); }
01346     }
01347 
01348     <span class="keywordflow">return</span> Vsn;
01349 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a170" doxytag="udfprocs.h::UdfLookupNextDirEntry" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN UdfLookupNextDirEntry           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d7/d9/struct__FCB.html">PFCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Fcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d5/d5/struct__DIR__ENUM__CONTEXT.html">PDIR_ENUM_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DirContext</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d7/dirsup_8c-source.html#l00287">287</a> of file <a class="el" href="../../d5/d7/dirsup_8c-source.html">dirsup.c</a>.
<p>
References <a class="el" href="../../d3/d6/notify_8c-source.html#l00236">Add2Ptr</a>, <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00342">ASSERT_FCB_INDEX</a>, <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00352">ASSERT_IRP_CONTEXT</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00509">ClearFlag</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01706">DIR_CONTEXT_FLAG_FID_BUFFERED</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00453">UdfFreePool()</a>, and <a class="el" href="../../d5/d7/dirsup_8c-source.html#l00916">UdfLookupDirEntryPostProcessing()</a>.
<p>
Referenced by <a class="el" href="../../d5/d7/dirsup_8c-source.html#l00726">UdfFindDirEntry()</a>, and <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l01863">UdfLookupNextFileIndex()</a>.
<p>
<pre class="fragment"><div>00295                    :
00296 
00297     This routine advances <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> enumeration of a directory by one entry.
00298 
00299 Arguments:
00300 
00301     Fcb - <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> directory being enumerated.
00302     
00303     DirContext - a corresponding context <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> enumeration.
00304 
00305 Return Value:
00306 
00307     BOOLEAN True <span class="keywordflow">if</span> another Fid <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> avaliable, False <span class="keywordflow">if</span> we are at <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> end.
00308 
00309 --*/
00310 
00311 {
00312     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00313     
00314     <span class="comment">//</span>
00315     <span class="comment">//  Check inputs.</span>
00316     <span class="comment">//</span>
00317 
00318     <a class="code" href="../../d1/d8/udfdata_8h.html#a28">ASSERT_IRP_CONTEXT</a>( IrpContext );
00319     <a class="code" href="../../d1/d8/udfdata_8h.html#a18">ASSERT_FCB_INDEX</a>( Fcb );
00320 
00321     <span class="comment">//</span>
00322     <span class="comment">//  If we have reached the end, stop.</span>
00323     <span class="comment">//</span>
00324     
00325     <span class="keywordflow">if</span> (DirContext-&gt;BaseOffset.QuadPart + DirContext-&gt;NextFidOffset == Fcb-&gt;FileSize.QuadPart) {
00326 
00327         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00328     }
00329 
00330     <span class="comment">//</span>
00331     <span class="comment">//  If the previous Fid was buffered, dismantle it now.</span>
00332     <span class="comment">//</span>
00333     
00334     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( DirContext-&gt;Flags, DIR_CONTEXT_FLAG_FID_BUFFERED )) {
00335 
00336         <a class="code" href="../../d5/d5/cc_8h.html#a61">ClearFlag</a>( DirContext-&gt;Flags, DIR_CONTEXT_FLAG_FID_BUFFERED );
00337         <a class="code" href="../../d3/d8/udfprocs_8h.html#a124">UdfFreePool</a>( &amp;DirContext-&gt;Fid );
00338     }
00339     
00340     <span class="comment">//</span>
00341     <span class="comment">//  Move the pointers based on the knowledge generated in the previous iteration.</span>
00342     <span class="comment">//</span>
00343 
00344     DirContext-&gt;ViewOffset = DirContext-&gt;NextFidOffset;
00345     DirContext-&gt;Fid = <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( DirContext-&gt;View, DirContext-&gt;ViewOffset, <a class="code" href="../../d1/d2/structNSR__FID.html">PNSR_FID</a> );
00346 
00347     <span class="comment">//</span>
00348     <span class="comment">//  The state of the context is now valid.  Tail off into our common post-processor</span>
00349     <span class="comment">//  to finish the work.</span>
00350     <span class="comment">//</span>
00351 
00352     <span class="keywordflow">return</span> <a class="code" href="../../d4/d8/dirsup_8c.html#a2">UdfLookupDirEntryPostProcessing</a>( IrpContext,
00353                                             Fcb,
00354                                             DirContext,
00355                                             FALSE );
00356 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a152" doxytag="udfprocs.h::UdfLookupPsnOfExtent" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG UdfLookupPsnOfExtent           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d7/d5/struct__VCB.html">PVCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Vcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Reference</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Lbn</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Len</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d5/allocsup_8c-source.html#l01017">1017</a> of file <a class="el" href="../../d3/d5/allocsup_8c-source.html">allocsup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00352">ASSERT_IRP_CONTEXT</a>, <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00348">ASSERT_PCB</a>, <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00336">ASSERT_VCB</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00264">BlocksFromBytes</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00278">BlockSize</a>, <a class="el" href="../../d3/d8/pinsup_8c-source.html#l00052">CcMapData()</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d9/d2/lfsdata_8h-source.html#l00187">DebugUnwind</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d8/arcinst_8h-source.html#l00382">_tagPARTITION::Length</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00033">Offset</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00435">_PCB::Partition</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00416">_PCB::Partitions</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l01340">PBCB</a>, <a class="el" href="../../d6/d8/udfstruc_8h.html#a129a115">Physical</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00228">SectorsFromBlocks</a>, <a class="el" href="../../d4/d7/fsrtlp_8h-source.html#l00222">SectorsFromBytes</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d3/d5/allocsup_8c-source.html#l01017">UdfLookupPsnOfExtent()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00406">UdfRaiseStatus()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00838">UdfUnpinData</a>, and <a class="el" href="../../d6/d8/alpha_2exdsptch_8c-source.html#l00105">Virtual</a>.
<p>
Referenced by <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l02558">UdfFindFileSetDescriptor()</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l03388">UdfInitializeAllocations()</a>, <a class="el" href="../../d3/d5/allocsup_8c-source.html#l01177">UdfLookupMetaVsnOfExtent()</a>, and <a class="el" href="../../d3/d5/allocsup_8c-source.html#l01017">UdfLookupPsnOfExtent()</a>.
<p>
<pre class="fragment"><div>01027                    :
01028 
01029     This routine maps <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> input logical block extent on a given partition to
01030     a starting physical sector.  It doubles as a bounds checker - <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> routine
01031     does not raise, <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> guaranteed that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> extent lies within <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01032     partition.
01033 
01034 Arguments:
01035 
01036     Vcb - Vcb of logical volume
01037 
01038     Reference - Partition reference to use in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> mapping
01039 
01040     Lbn - Logical block number
01041 
01042     Len - Length of extent in bytes
01043 
01044 Return Value:
01045 
01046     ULONG physical sector number
01047 
01048 --*/
01049 
01050 {
01051     <a class="code" href="../../d4/d9/struct__PCB.html">PPCB</a> Pcb = Vcb-&gt;Pcb;
01052     ULONG Psn;
01053 
01054     <a class="code" href="../../d4/d3/struct__BCB.html">PBCB</a> Bcb;
01055     LARGE_INTEGER <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
01056     PULONG MappedLbn;
01057 
01058     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01059 
01060     <span class="comment">//</span>
01061     <span class="comment">//  Check inputs</span>
01062     <span class="comment">//</span>
01063 
01064     <a class="code" href="../../d1/d8/udfdata_8h.html#a28">ASSERT_IRP_CONTEXT</a>( IrpContext );
01065     <a class="code" href="../../d1/d8/udfdata_8h.html#a12">ASSERT_VCB</a>( Vcb );
01066     <a class="code" href="../../d1/d8/udfdata_8h.html#a24">ASSERT_PCB</a>( Pcb );
01067 
01068     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( +1, Dbg, <span class="stringliteral">"UdfLookupPsnOfExtent, [%04x/%08x, +%08x)\n"</span>, Reference, Lbn, Len ));
01069 
01070     <span class="keywordflow">if</span> (Reference &lt; Pcb-&gt;<a class="code" href="../../d4/d9/struct__PCB.html#o2">Partitions</a>) {
01071 
01072         <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
01073 
01074             <span class="keywordflow">switch</span> (Pcb-&gt;<a class="code" href="../../d4/d9/struct__PCB.html#o5">Partition</a>[Reference].Type) {
01075 
01076                 <span class="keywordflow">case</span> <a class="code" href="../../d6/d8/udfstruc_8h.html#a129a115">Physical</a>:
01077 
01078                     <span class="comment">//</span>
01079                     <span class="comment">//  Check that the input extent lies inside the partition.  Calculate the</span>
01080                     <span class="comment">//  Lbn of the last block and see that it is interior.</span>
01081                     <span class="comment">//</span>
01082 
01083                     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/udfprocs_8h.html#a41">SectorsFromBlocks</a>( Vcb, Lbn ) + <a class="code" href="../../d3/d8/fsrtlp_8h.html#a13">SectorsFromBytes</a>( Vcb, Len ) &gt;
01084                         Pcb-&gt;<a class="code" href="../../d4/d9/struct__PCB.html#o5">Partition</a>[Reference].Physical.<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o3">Length</a>) {
01085 
01086                         <span class="keywordflow">goto</span> NoGood;
01087                     }
01088 
01089                     Psn = Pcb-&gt;<a class="code" href="../../d4/d9/struct__PCB.html#o5">Partition</a>[Reference].Physical.Start + <a class="code" href="../../d3/d8/udfprocs_8h.html#a41">SectorsFromBlocks</a>( Vcb, Lbn );
01090 
01091                     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( -1, Dbg, <span class="stringliteral">"UdfLookupPsnOfExtent -&gt; %08x\n"</span>, Psn ));
01092                     <span class="keywordflow">return</span> Psn;
01093 
01094                 <span class="keywordflow">case</span> <a class="code" href="../../d5/d9/alpha_2exdsptch_8c.html#a2">Virtual</a>:
01095 
01096                     <span class="comment">//</span>
01097                     <span class="comment">//  Bounds check.  Per UDF 2.00 2.3.10 and implied in UDF 1.50, virtual</span>
01098                     <span class="comment">//  extent lengths cannot be greater than one block in size.</span>
01099                     <span class="comment">//</span>
01100 
01101                     <span class="keywordflow">if</span> (Lbn + <a class="code" href="../../d3/d8/udfprocs_8h.html#a50">BlocksFromBytes</a>( Vcb, Len ) &gt; Pcb-&gt;<a class="code" href="../../d4/d9/struct__PCB.html#o5">Partition</a>[Reference].Virtual.<a class="code" href="../../d2/d9/struct__tagPARTITION.html#o3">Length</a> ||
01102                         Len &gt; <a class="code" href="../../d3/d8/udfprocs_8h.html#a54">BlockSize</a>( Vcb )) {
01103 
01104                         <span class="keywordflow">goto</span> NoGood;
01105                     }
01106 
01107                     <span class="keywordflow">try</span> {
01108 
01109                         <span class="comment">//</span>
01110                         <span class="comment">//  Calculate the location of the mapping element in the VAT</span>
01111                         <span class="comment">//  and retrieve.</span>
01112                         <span class="comment">//</span>
01113 
01114                         <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>.QuadPart = Lbn * <span class="keyword">sizeof</span>(ULONG);
01115 
01116                         <a class="code" href="../../d4/d2/cache_8h.html#a88">CcMapData</a>( Vcb-&gt;VatFcb-&gt;FileObject,
01117                                    &amp;Offset,
01118                                    <span class="keyword">sizeof</span>(ULONG),
01119                                    TRUE,
01120                                    &amp;Bcb,
01121                                    &amp;MappedLbn );
01122 
01123                         <span class="comment">//</span>
01124                         <span class="comment">//  Now rewrite the inputs in terms of the virtual mapping.  We</span>
01125                         <span class="comment">//  will reloop to perform the logical -&gt; physical mapping.</span>
01126                         <span class="comment">//</span>
01127 
01128                         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( 0, Dbg,
01129                                      <span class="stringliteral">"UdfLookupPsnOfExtent, Mapping V %04x/%08x -&gt; L %04x/%08x\n"</span>,
01130                                      Reference,
01131                                      Lbn,
01132                                      Pcb-&gt;<a class="code" href="../../d4/d9/struct__PCB.html#o5">Partition</a>[Reference].Virtual.RelatedReference,
01133                                      *MappedLbn ));
01134 
01135                         Lbn = *MappedLbn;
01136                         Reference = Pcb-&gt;<a class="code" href="../../d4/d9/struct__PCB.html#o5">Partition</a>[Reference].Virtual.RelatedReference;
01137 
01138                     } finally {
01139 
01140                         <a class="code" href="../../d8/d3/lfsdata_8h.html#a3">DebugUnwind</a>( UdfLookupPsnOfExtent );
01141 
01142                         <a class="code" href="../../d3/d8/udfprocs_8h.html#a69">UdfUnpinData</a>( IrpContext, &amp;Bcb );
01143                     }
01144 
01145                     <span class="comment">//</span>
01146                     <span class="comment">//  An Lbn of ~0 in the VAT is defined to indicate that the sector is unused,</span>
01147                     <span class="comment">//  so we should never see such a thing.</span>
01148                     <span class="comment">//</span>
01149 
01150                     <span class="keywordflow">if</span> (Lbn == ~0) {
01151 
01152                         <span class="keywordflow">goto</span> NoGood;
01153                     }
01154 
01155                     <span class="keywordflow">break</span>;
01156 
01157                 <span class="keywordflow">default</span>:
01158 
01159                     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(FALSE);
01160                     <span class="keywordflow">break</span>;
01161             }
01162         }
01163     }
01164 
01165     NoGood:
01166 
01167     <span class="comment">//</span>
01168     <span class="comment">//  Some people have misinterpreted a partition number to equal a</span>
01169     <span class="comment">//  partition reference, or perhaps this is just corrupt media.</span>
01170     <span class="comment">//</span>
01171 
01172     <a class="code" href="../../d3/d8/udfprocs_8h.html#a122">UdfRaiseStatus</a>( IrpContext, STATUS_FILE_CORRUPT_ERROR );
01173 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a157" doxytag="udfprocs.h::UdfMapMetadataView" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID UdfMapMetadataView           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d6/d6/struct__MAPPED__PVIEW.html">PMAPPED_PVIEW</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>View</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d7/d5/struct__VCB.html">PVCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Vcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Partition</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Lbn</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Length</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d1/udfs_2cachesup_8c-source.html#l00337">337</a> of file <a class="el" href="../../d9/d1/udfs_2cachesup_8c-source.html">udfs/cachesup.c</a>.
<p>
References <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00352">ASSERT_IRP_CONTEXT</a>, <a class="el" href="../../d3/d8/pinsup_8c-source.html#l00052">CcMapData()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00220">LlBytesFromSectors</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00033">Offset</a>, <a class="el" href="../../d6/d8/udfstruc_8h.html#a103">PMAPPED_PVIEW</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d3/d5/allocsup_8c-source.html#l01177">UdfLookupMetaVsnOfExtent()</a>, and <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00828">UdfUnpinView</a>.
<p>
Referenced by <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l04144">UdfGetNextAllocationPostProcessing()</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l03060">UdfInitializeIcbContext()</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l02951">UdfInitializeIcbContextFromFcb()</a>, and <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l03790">UdfLookupActiveIcbInExtent()</a>.
<p>
<pre class="fragment"><div>00348                    :
00349 
00350     Perform <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> common work of mapping an extent of metadata into a mapped view.
00351 
00352 Arguments:
00353 
00354     View - View structure to map <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> bytes into
00355     
00356     Vcb - Vcb of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> volume <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> extent <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> on
00357     
00358     Partition - Partition of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> extent
00359     
00360     Lbn - Lbn of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> extent
00361     
00362     Length - Length of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> extent
00363 
00364 Return Value:
00365 
00366     None.
00367 
00368 --*/
00369 
00370 {
00371     LARGE_INTEGER <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
00372     ULONG Vsn;
00373 
00374     <a class="code" href="../../d1/d8/udfdata_8h.html#a28">ASSERT_IRP_CONTEXT</a>( IrpContext );
00375 
00376     <span class="comment">//</span>
00377     <span class="comment">//  Remove any existing mapping</span>
00378     <span class="comment">//</span>
00379     
00380     <a class="code" href="../../d3/d8/udfprocs_8h.html#a68">UdfUnpinView</a>( IrpContext, View );
00381 
00382     <span class="comment">//</span>
00383     <span class="comment">//  Update the view information.</span>
00384     <span class="comment">//</span>
00385 
00386     View-&gt;Partition = Partition;
00387     View-&gt;Lbn = Lbn;
00388     View-&gt;Length = Length;
00389 
00390     <span class="comment">//</span>
00391     <span class="comment">//  Find the mapping of this extent in the Metadata stream.</span>
00392     <span class="comment">//</span>
00393 
00394     Vsn = <a class="code" href="../../d3/d8/udfprocs_8h.html#a153">UdfLookupMetaVsnOfExtent</a>( IrpContext,
00395                                     Vcb,
00396                                     Partition,
00397                                     Lbn,
00398                                     Length,
00399                                     FALSE );
00400 
00401     <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>.QuadPart = <a class="code" href="../../d3/d8/udfprocs_8h.html#a39">LlBytesFromSectors</a>( Vcb, Vsn );
00402 
00403     <span class="comment">//</span>
00404     <span class="comment">//  Map the extent</span>
00405     <span class="comment">//</span>
00406 
00407     <a class="code" href="../../d4/d2/cache_8h.html#a88">CcMapData</a>( Vcb-&gt;MetadataFcb-&gt;FileObject,
00408                &amp;Offset,
00409                Length,
00410                TRUE,
00411                &amp;View-&gt;Bcb,
00412                &amp;View-&gt;View );
00413 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a161" doxytag="udfprocs.h::UdfNonCachedRead" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS UdfNonCachedRead           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d7/d9/struct__FCB.html">PFCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Fcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN LONGLONG&nbsp;</td>
          <td class="mdname" nowrap> <em>StartingOffset</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ByteCount</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d6/deviosup_8c-source.html#l00201">201</a> of file <a class="el" href="../../d4/d6/deviosup_8c-source.html">deviosup.c</a>.
<p>
References <a class="el" href="../../d3/d6/notify_8c-source.html#l00236">Add2Ptr</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00509">ClearFlag</a>, <a class="el" href="../../d9/d2/lfsdata_8h-source.html#l00187">DebugUnwind</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01064">FCB_STATE_EMBEDDED_DATA</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01063">FCB_STATE_VMCB_MAPPING</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01241">IRP_CONTEXT_FLAG_ALLOC_IO</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01235">IRP_CONTEXT_FLAG_WAIT</a>, <a class="el" href="../../d4/d4/ppc_2flush_8c-source.html#l00693">KeFlushIoBuffers()</a>, <a class="el" href="../../d4/d6/deviosup_8c-source.html#l00107">MAX_PARALLEL_IOS</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00436">try_leave</a>, <a class="el" href="../../d4/d6/deviosup_8c-source.html#l00474">UdfCreateUserMdl()</a>, <a class="el" href="../../d4/d6/deviosup_8c-source.html#l01280">UdfFinishBuffers()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00902">UdfMapUserBuffer</a>, <a class="el" href="../../d4/d6/deviosup_8c-source.html#l01435">UdfMultipleAsync()</a>, <a class="el" href="../../d4/d6/deviosup_8c-source.html#l00883">UdfPrepareBuffers()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00406">UdfRaiseStatus()</a>, <a class="el" href="../../d4/d6/deviosup_8c-source.html#l01642">UdfSingleAsync()</a>, and <a class="el" href="../../d4/d6/deviosup_8c-source.html#l01740">UdfWaitSync()</a>.
<p>
Referenced by <a class="el" href="../../d8/d4/udfs_2read_8c-source.html#l00068">UdfCommonRead()</a>.
<p>
<pre class="fragment"><div>00210                    :
00211 
00212     This routine performs <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> non-cached reads of sectors.  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> done by
00213     performing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> following in a loop.
00214 
00215         Fill in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> IoRuns array <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> next block of Io.
00216         Send <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Io to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device.
00217         Perform any cleanup on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Io runs array.
00218 
00219     We will not <span class="keywordflow">do</span> async Io to any request that generates non-aligned Io.
00220     Also we will not perform async Io <span class="keywordflow">if</span> <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> will exceed <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> size of our
00221     IoRuns array.  These should be <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> unusual cases but we will raise
00222     or <span class="keywordflow">return</span> CANT_WAIT in <span class="keyword">this</span> routine <span class="keywordflow">if</span> we detect <span class="keyword">this</span> <span class="keywordflow">case</span>.
00223 
00224 Arguments:
00225 
00226     Fcb - Fcb representing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> to read.
00227 
00228     StartingOffset - Logical offset in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> to read from.
00229 
00230     ByteCount - Number of bytes to read.
00231 
00232 Return Value:
00233 
00234     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> indicating <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> result of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation.
00235 
00236 --*/
00237 
00238 {
00239     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00240 
00241     <a class="code" href="../../d0/d5/struct__IO__RUN.html">IO_RUN</a> IoRuns[<a class="code" href="../../d3/d7/deviosup_8c.html#a2">MAX_PARALLEL_IOS</a>];
00242     ULONG RunCount = 0;
00243     ULONG CleanupRunCount = 0;
00244 
00245     PVOID UserBuffer;
00246     ULONG UserBufferOffset = 0;
00247     LONGLONG CurrentOffset = StartingOffset;
00248     ULONG RemainingByteCount = ByteCount;
00249     ULONG ThisByteCount;
00250 
00251     BOOLEAN Unaligned;
00252     BOOLEAN SparseRuns;
00253     BOOLEAN FlushIoBuffers = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00254     BOOLEAN FirstPass = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00255 
00256     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00257 
00258     <span class="comment">//</span>
00259     <span class="comment">//  We want to make sure the user's buffer is locked in all cases.</span>
00260     <span class="comment">//</span>
00261 
00262     <span class="keywordflow">if</span> (IrpContext-&gt;Irp-&gt;MdlAddress == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00263 
00264         <a class="code" href="../../d3/d8/udfprocs_8h.html#a162">UdfCreateUserMdl</a>( IrpContext, ByteCount, TRUE );
00265     }
00266 
00267     <span class="comment">//</span>
00268     <span class="comment">//  Use a try-finally to perform the final cleanup.</span>
00269     <span class="comment">//</span>
00270 
00271     <span class="keywordflow">try</span> {
00272 
00273         <a class="code" href="../../d3/d8/udfprocs_8h.html#a70">UdfMapUserBuffer</a>( IrpContext, &amp;UserBuffer);
00274 
00275         <span class="comment">//</span>
00276         <span class="comment">//  Loop while there are more bytes to transfer.</span>
00277         <span class="comment">//</span>
00278 
00279         <span class="keywordflow">do</span> {
00280 
00281             <span class="comment">//</span>
00282             <span class="comment">//  Call prepare buffers to set up the next entries</span>
00283             <span class="comment">//  in the IoRuns array.  Remember if there are any</span>
00284             <span class="comment">//  unaligned entries.</span>
00285             <span class="comment">//</span>
00286 
00287             RtlZeroMemory( IoRuns, <span class="keyword">sizeof</span>( IoRuns ));
00288 
00289             Unaligned = <a class="code" href="../../d3/d7/deviosup_8c.html#a18">UdfPrepareBuffers</a>( IrpContext,
00290                                            IrpContext-&gt;Irp,
00291                                            Fcb,
00292                                            UserBuffer,
00293                                            UserBufferOffset,
00294                                            CurrentOffset,
00295                                            RemainingByteCount,
00296                                            IoRuns,
00297                                            &amp;CleanupRunCount,
00298                                            &amp;ThisByteCount,
00299                                            &amp;SparseRuns );
00300 
00301 
00302             RunCount = CleanupRunCount;
00303 
00304             <span class="comment">//</span>
00305             <span class="comment">//  Quickly finish if we wound up having no IO to perform.  This will</span>
00306             <span class="comment">//  occur in the presence of unrecorded sectors.</span>
00307             <span class="comment">//</span>
00308 
00309             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( !(SparseRuns &amp;&amp; <a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Fcb-&gt;FcbState, FCB_STATE_VMCB_MAPPING|FCB_STATE_EMBEDDED_DATA )));
00310 
00311             <span class="keywordflow">if</span> (RunCount == 0) {
00312 
00313                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( Status = IrpContext-&gt;Irp-&gt;IoStatus.Status = STATUS_SUCCESS );
00314             }
00315 
00316             <span class="comment">//</span>
00317             <span class="comment">//  If this is an async request and there aren't enough entries</span>
00318             <span class="comment">//  in the Io array then post the request.  This routine will</span>
00319             <span class="comment">//  always raise if we are doing any unaligned Io for an</span>
00320             <span class="comment">//  async request.</span>
00321             <span class="comment">//</span>
00322 
00323             <span class="keywordflow">if</span> ((ThisByteCount &lt; RemainingByteCount) &amp;&amp;
00324                 !<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpContext-&gt;Flags, IRP_CONTEXT_FLAG_WAIT )) {
00325 
00326                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a122">UdfRaiseStatus</a>( IrpContext, STATUS_CANT_WAIT );
00327             }
00328 
00329             <span class="comment">//</span>
00330             <span class="comment">//  If the entire Io is contained in a single run then</span>
00331             <span class="comment">//  we can pass the Io down to the driver.  Send the driver down</span>
00332             <span class="comment">//  and wait on the result if this is synchronous.  We cannot</span>
00333             <span class="comment">//  do this simple form (just chucking the IRP down) if some</span>
00334             <span class="comment">//  sparse runs were encountered.</span>
00335             <span class="comment">//</span>
00336 
00337             <span class="keywordflow">if</span> ((RunCount == 1) &amp;&amp; !Unaligned &amp;&amp; !SparseRuns &amp;&amp; FirstPass) {
00338 
00339                 <a class="code" href="../../d3/d7/deviosup_8c.html#a8">UdfSingleAsync</a>( IrpContext,
00340                                 IoRuns[0].DiskOffset,
00341                                 IoRuns[0].DiskByteCount );
00342 
00343                 <span class="comment">//</span>
00344                 <span class="comment">//  No cleanup needed for the IoRuns array here.</span>
00345                 <span class="comment">//</span>
00346 
00347                 CleanupRunCount = 0;
00348 
00349                 <span class="comment">//</span>
00350                 <span class="comment">//  Wait if we are synchronous, otherwise return</span>
00351                 <span class="comment">//</span>
00352 
00353                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpContext-&gt;Flags, IRP_CONTEXT_FLAG_WAIT )) {
00354 
00355                     <a class="code" href="../../d3/d7/deviosup_8c.html#a9">UdfWaitSync</a>( IrpContext );
00356 
00357                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = IrpContext-&gt;Irp-&gt;IoStatus.Status;
00358 
00359                 <span class="comment">//</span>
00360                 <span class="comment">//  Our completion routine will free the Io context but</span>
00361                 <span class="comment">//  we do want to return STATUS_PENDING.</span>
00362                 <span class="comment">//</span>
00363 
00364                 } <span class="keywordflow">else</span> {
00365 
00366                     <a class="code" href="../../d5/d5/cc_8h.html#a61">ClearFlag</a>( IrpContext-&gt;Flags, IRP_CONTEXT_FLAG_ALLOC_IO );
00367                     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_PENDING;
00368                 }
00369 
00370                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( NOTHING );
00371             }
00372 
00373             <span class="comment">//</span>
00374             <span class="comment">//  Otherwise we will perform multiple Io to read in the data.</span>
00375             <span class="comment">//</span>
00376             
00377             <a class="code" href="../../d3/d7/deviosup_8c.html#a7">UdfMultipleAsync</a>( IrpContext, RunCount, IoRuns );
00378 
00379             <span class="comment">//</span>
00380             <span class="comment">//  No cleanup needed on the IoRuns now.</span>
00381             <span class="comment">//</span>
00382 
00383             CleanupRunCount = 0;
00384 
00385             <span class="comment">//</span>
00386             <span class="comment">//  If this is a synchronous request then perform any necessary</span>
00387             <span class="comment">//  post-processing.</span>
00388             <span class="comment">//</span>
00389 
00390             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpContext-&gt;Flags, IRP_CONTEXT_FLAG_WAIT )) {
00391 
00392                 <span class="comment">//</span>
00393                 <span class="comment">//  Wait for the request to complete.</span>
00394                 <span class="comment">//</span>
00395 
00396                 <a class="code" href="../../d3/d7/deviosup_8c.html#a9">UdfWaitSync</a>( IrpContext );
00397 
00398                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = IrpContext-&gt;Irp-&gt;IoStatus.Status;
00399 
00400                 <span class="comment">//</span>
00401                 <span class="comment">//  Exit this loop if there is an error.</span>
00402                 <span class="comment">//</span>
00403 
00404                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00405 
00406                     <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( NOTHING );
00407                 }
00408 
00409                 <span class="comment">//</span>
00410                 <span class="comment">//  Perform post read operations on the IoRuns if</span>
00411                 <span class="comment">//  necessary.</span>
00412                 <span class="comment">//</span>
00413 
00414                 <span class="keywordflow">if</span> (Unaligned &amp;&amp;
00415                     <a class="code" href="../../d3/d7/deviosup_8c.html#a6">UdfFinishBuffers</a>( IrpContext, IoRuns, RunCount, FALSE )) {
00416 
00417                     FlushIoBuffers = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00418                 }
00419 
00420                 <span class="comment">//</span>
00421                 <span class="comment">//  Exit this loop if there are no more bytes to transfer</span>
00422                 <span class="comment">//  or we have any error.</span>
00423                 <span class="comment">//</span>
00424 
00425                 RemainingByteCount -= ThisByteCount;
00426                 CurrentOffset += ThisByteCount;
00427                 UserBuffer = <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( UserBuffer, ThisByteCount, PVOID );
00428                 UserBufferOffset += ThisByteCount;
00429 
00430             <span class="comment">//</span>
00431             <span class="comment">//  Otherwise this is an asynchronous request.  Always return</span>
00432             <span class="comment">//  STATUS_PENDING.</span>
00433             <span class="comment">//</span>
00434 
00435             } <span class="keywordflow">else</span> {
00436 
00437                 <a class="code" href="../../d5/d5/cc_8h.html#a61">ClearFlag</a>( IrpContext-&gt;Flags, IRP_CONTEXT_FLAG_ALLOC_IO );
00438                 CleanupRunCount = 0;
00439                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( Status = STATUS_PENDING );
00440                 <span class="keywordflow">break</span>;
00441             }
00442 
00443             FirstPass = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00444         } <span class="keywordflow">while</span> (RemainingByteCount != 0);
00445 
00446         <span class="comment">//</span>
00447         <span class="comment">//  Flush the hardware cache if we performed any copy operations.</span>
00448         <span class="comment">//</span>
00449 
00450         <span class="keywordflow">if</span> (FlushIoBuffers) {
00451 
00452             <a class="code" href="../../d3/d5/ppc_2flush_8c.html#a9">KeFlushIoBuffers</a>( IrpContext-&gt;Irp-&gt;MdlAddress, TRUE, FALSE );
00453         }
00454 
00455     } finally {
00456 
00457         <a class="code" href="../../d8/d3/lfsdata_8h.html#a3">DebugUnwind</a>( <span class="stringliteral">"UdfNonCachedRead"</span> );
00458 
00459         <span class="comment">//</span>
00460         <span class="comment">//  Perform final cleanup on the IoRuns if necessary.</span>
00461         <span class="comment">//</span>
00462 
00463         <span class="keywordflow">if</span> (CleanupRunCount != 0) {
00464 
00465             <a class="code" href="../../d3/d7/deviosup_8c.html#a6">UdfFinishBuffers</a>( IrpContext, IoRuns, CleanupRunCount, TRUE );
00466         }
00467     }
00468 
00469     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00470 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a197" doxytag="udfprocs.h::UdfNoopAcquire" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN UdfNoopAcquire           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Fcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>Wait</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d8/resrcsup_8c-source.html#l00208">208</a> of file <a class="el" href="../../d5/d8/resrcsup_8c-source.html">resrcsup.c</a>.
<p>
References <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d3/d7/udfinit_8c-source.html#l00183">UdfInitializeGlobalData()</a>.
<p>
<pre class="fragment"><div>00215                    :
00216 
00217     This routine does nothing.
00218 
00219 Arguments:
00220 
00221     Fcb - The Fcb/Vcb which was specified as a context parameter <span class="keywordflow">for</span> <span class="keyword">this</span>
00222           routine.
00223 
00224     Wait - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> willing to block.
00225 
00226 Return Value:
00227 
00228     <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>
00229 
00230 --*/
00231 
00232 {
00233     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00234     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00235 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a198" doxytag="udfprocs.h::UdfNoopRelease" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID UdfNoopRelease           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PVOID&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Fcb</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d8/resrcsup_8c-source.html#l00239">239</a> of file <a class="el" href="../../d5/d8/resrcsup_8c-source.html">resrcsup.c</a>.
<p>
References <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d3/d7/udfinit_8c-source.html#l00183">UdfInitializeGlobalData()</a>.
<p>
<pre class="fragment"><div>00245                    :
00246 
00247     This routine does nothing.
00248 
00249 Arguments:
00250 
00251     Fcb - The Fcb/Vcb which was specified as a context parameter <span class="keywordflow">for</span> <span class="keyword">this</span>
00252           routine.
00253 
00254 Return Value:
00255 
00256     None
00257 
00258 --*/
00259 
00260 {
00261     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00262     <span class="keywordflow">return</span>;
00263 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a123" doxytag="udfprocs.h::UdfNormalizeAndRaiseStatus" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> INLINE VOID UdfNormalizeAndRaiseStatus           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN NTSTATUS&nbsp;</td>
          <td class="mdname" nowrap> <em>Status</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00418">418</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.
<p>
References <a class="el" href="../../d1/d3/ex_2alpha_2raisests_8c-source.html#l00157">ExRaiseStatus()</a>, <a class="el" href="../../d8/d2/fsrtl_2filter_8c-source.html#l00049">FsRtlNormalizeNtstatus()</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
Referenced by <a class="el" href="../../d8/d4/udfs_2read_8c-source.html#l00068">UdfCommonRead()</a>, <a class="el" href="../../d9/d4/udfs_2verfysup_8c-source.html#l00042">UdfPerformVerify()</a>, <a class="el" href="../../d4/d6/deviosup_8c-source.html#l00685">UdfReadSectors()</a>, and <a class="el" href="../../d9/d4/udfs_2verfysup_8c-source.html#l00603">UdfVerifyVcb()</a>.
<p>
<pre class="fragment"><div>00422 {
00423     IrpContext-&gt;ExceptionStatus = <a class="code" href="../../d1/d8/fsrtl_8h.html#a136">FsRtlNormalizeNtstatus</a>( Status, STATUS_UNEXPECTED_IO_ERROR );
00424     <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( IrpContext-&gt;ExceptionStatus );
00425 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a247" doxytag="udfprocs.h::UdfOplockComplete" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID UdfOplockComplete           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d8/workque_8c-source.html#l00222">222</a> of file <a class="el" href="../../d3/d8/workque_8c-source.html">workque.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01635">_IRP::IoStatus</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00055">IRP_MJ_CREATE</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d3/d8/workque_8c-source.html#l00316">UdfAddToWorkque()</a>, <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00809">UdfCompleteRequest()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01548">UdfReleaseFcb</a>, and <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l01606">UdfTeardownStructures()</a>.
<p>
Referenced by <a class="el" href="../../d3/d4/lockctrl_8c-source.html#l00046">UdfCommonLockControl()</a>, <a class="el" href="../../d8/d4/udfs_2read_8c-source.html#l00068">UdfCommonRead()</a>, and <a class="el" href="../../d4/d7/udfs_2create_8c-source.html#l01955">UdfCompleteFcbOpen()</a>.
<p>
<pre class="fragment"><div>00229                    :
00230 
00231     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> oplock <span class="keyword">package </span>when an oplock break has
00232     completed, allowing an Irp to resume execution.  If the status in
00233     the Irp is STATUS_SUCCESS, then we queue the Irp to the Fsp queue.
00234     Otherwise we complete the Irp with the status in the Irp.
00235 
00236     If we are completing due to an error then check if there is any
00237     cleanup to do.
00238 
00239 Arguments:
00240 
00241     Irp - I/O Request Packet.
00242 
00243 Return Value:
00244 
00245     None.
00246 
00247 --*/
00248 
00249 {
00250     BOOLEAN RemovedFcb;
00251 
00252     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00253 
00254     <span class="comment">//</span>
00255     <span class="comment">//  Check on the return value in the Irp.  If success then we</span>
00256     <span class="comment">//  are to post this request.</span>
00257     <span class="comment">//</span>
00258 
00259     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status == STATUS_SUCCESS) {
00260 
00261         <span class="comment">//</span>
00262         <span class="comment">//  Check if there is any cleanup work to do.</span>
00263         <span class="comment">//</span>
00264 
00265         <span class="keywordflow">switch</span> (IrpContext-&gt;MajorFunction) {
00266 
00267         <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a13">IRP_MJ_CREATE</a> :
00268 
00269             <span class="comment">//</span>
00270             <span class="comment">//  If called from the oplock package then there is an</span>
00271             <span class="comment">//  Fcb to possibly teardown.  We will call the teardown</span>
00272             <span class="comment">//  routine and release the Fcb if still present.  The cleanup</span>
00273             <span class="comment">//  code in create will know not to release this Fcb because</span>
00274             <span class="comment">//  we will clear the pointer.</span>
00275             <span class="comment">//</span>
00276 
00277             <span class="keywordflow">if</span> (IrpContext-&gt;TeardownFcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00278 
00279                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a210">UdfTeardownStructures</a>( IrpContext, *(IrpContext-&gt;TeardownFcb), FALSE, &amp;RemovedFcb );
00280 
00281                 <span class="keywordflow">if</span> (!RemovedFcb) {
00282 
00283                     <a class="code" href="../../d3/d8/udfprocs_8h.html#a85">UdfReleaseFcb</a>( IrpContext, *(IrpContext-&gt;TeardownFcb) );
00284                 }
00285 
00286                 *(IrpContext-&gt;TeardownFcb) = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00287                 IrpContext-&gt;TeardownFcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00288             }
00289 
00290             <span class="keywordflow">break</span>;
00291         }
00292         <span class="comment">//</span>
00293         <span class="comment">//  Insert the Irp context in the workqueue.</span>
00294         <span class="comment">//</span>
00295 
00296         <a class="code" href="../../d2/d9/workque_8c.html#a3">UdfAddToWorkque</a>( IrpContext, Irp );
00297 
00298     <span class="comment">//</span>
00299     <span class="comment">//  Otherwise complete the request.</span>
00300     <span class="comment">//</span>
00301 
00302     } <span class="keywordflow">else</span> {
00303 
00304         <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, Irp, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status );
00305     }
00306 
00307     <span class="keywordflow">return</span>;
00308 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a159" doxytag="udfprocs.h::UdfPerformDevIoCtrl" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS UdfPerformDevIoCtrl           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>IoControlCode</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Device</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PVOID OutputBuffer&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>OutputBufferLength</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>InternalDeviceIoControl</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>OverrideVerify</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PIO_STATUS_BLOCK Iosb&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d6/deviosup_8c-source.html#l00573">573</a> of file <a class="el" href="../../d4/d6/deviosup_8c-source.html">deviosup.c</a>.
<p>
References <a class="el" href="../../d9/d8/client_2ntstubs_8c-source.html#l00086">Event()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l01552">IoBuildDeviceIoControlRequest()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02865">IoCallDriver</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03398">IoGetNextIrpStackLocation</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01066">KeInitializeEvent</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00505">SetFlag</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01874">SL_OVERRIDE_VERIFY_VOLUME</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
Referenced by <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l03817">UdfDetermineVolumeBounding()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l01444">UdfMountVolume()</a>, <a class="el" href="../../d9/d4/udfs_2verfysup_8c-source.html#l00603">UdfVerifyVcb()</a>, and <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l02043">UdfVerifyVolume()</a>.
<p>
<pre class="fragment"><div>00586                    :
00587 
00588     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called to perform DevIoCtrl <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a16">functions</a> internally within
00589     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> filesystem.  We take <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> status from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver and <span class="keywordflow">return</span> <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> to our
00590     caller.
00591 
00592 Arguments:
00593 
00594     IoControlCode - Code to send to driver.
00595 
00596     Device - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device to send <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> request to.
00597 
00598     OutPutBuffer - Pointer to output buffer.
00599 
00600     OutputBufferLength - Length of output buffer above.
00601 
00602     InternalDeviceIoControl - Indicates <span class="keywordflow">if</span> <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> an internal or external
00603         Io <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a58">control</a> code.
00604 
00605     OverrideVerify - Indicates <span class="keywordflow">if</span> we should tell <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver not to <span class="keywordflow">return</span>
00606         STATUS_VERIFY_REQUIRED <span class="keywordflow">for</span> mount and verify.
00607 
00608     Iosb - If specified, we <span class="keywordflow">return</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> results of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation here.
00609 
00610 Return Value:
00611 
00612     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> returned by next lower driver.
00613 
00614 --*/
00615 
00616 {
00617     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00618     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>;
00619     <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>;
00620     IO_STATUS_BLOCK LocalIosb;
00621     PIO_STATUS_BLOCK IosbToUse = &amp;LocalIosb;
00622 
00623     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00624 
00625     <span class="comment">//</span>
00626     <span class="comment">//  Check if the user gave us an Iosb.</span>
00627     <span class="comment">//</span>
00628 
00629     <span class="keywordflow">if</span> (ARGUMENT_PRESENT( Iosb )) {
00630 
00631         IosbToUse = Iosb;
00632     }
00633 
00634     IosbToUse-&gt;Status = 0;
00635     IosbToUse-&gt;Information = 0;
00636 
00637     <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>( &amp;Event, NotificationEvent, FALSE );
00638 
00639     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> = <a class="code" href="../../d4/d6/iosubs_8c.html#a25">IoBuildDeviceIoControlRequest</a>( IoControlCode,
00640                                          Device,
00641                                          NULL,
00642                                          0,
00643                                          OutputBuffer,
00644                                          OutputBufferLength,
00645                                          InternalDeviceIoControl,
00646                                          &amp;Event,
00647                                          IosbToUse );
00648 
00649     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00650 
00651         <span class="keywordflow">return</span> STATUS_INSUFFICIENT_RESOURCES;
00652     }
00653 
00654     <span class="keywordflow">if</span> (OverrideVerify) {
00655 
00656         <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( <a class="code" href="../../d0/d5/io_8h.html#a230">IoGetNextIrpStackLocation</a>( Irp )-&gt;Flags, SL_OVERRIDE_VERIFY_VOLUME );
00657     }
00658 
00659     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d5/io_8h.html#a223">IoCallDriver</a>( Device, Irp );
00660 
00661     <span class="comment">//</span>
00662     <span class="comment">//  We check for device not ready by first checking Status</span>
00663     <span class="comment">//  and then if status pending was returned, the Iosb status</span>
00664     <span class="comment">//  value.</span>
00665     <span class="comment">//</span>
00666 
00667     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_PENDING) {
00668 
00669         (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;Event,
00670                                       Executive,
00671                                       KernelMode,
00672                                       FALSE,
00673                                       (PLARGE_INTEGER)NULL );
00674 
00675         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = IosbToUse-&gt;Status;
00676     }
00677 
00678     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00679 
00680     UNREFERENCED_PARAMETER( IrpContext );
00681 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a244" doxytag="udfprocs.h::UdfPerformVerify" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS UdfPerformVerify           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DeviceToVerify</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d4/udfs_2verfysup_8c-source.html#l00042">42</a> of file <a class="el" href="../../d9/d4/udfs_2verfysup_8c-source.html">udfs/verfysup.c</a>.
<p>
References <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00356">ASSERT_IRP</a>, <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00352">ASSERT_IRP_CONTEXT</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02488">_IO_STACK_LOCATION::DeviceObject</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01153">DO_VERIFY_VOLUME</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01534">_FILE_OBJECT::FileName</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02494">_IO_STACK_LOCATION::FileObject</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00251">IO_REMOUNT</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03252">IoGetCurrentIrpStackLocation</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03528">IoIsErrorUserInduced</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l09796">IoSetHardErrorOrVerifyDevice()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01635">_IRP::IoStatus</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l11389">IoVerifyVolume()</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00055">IRP_MJ_CREATE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00068">IRP_MJ_FILE_SYSTEM_CONTROL</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00113">IRP_MN_MOUNT_VOLUME</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00114">IRP_MN_VERIFY_VOLUME</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01524">_FILE_OBJECT::RelatedFileObject</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01509">UdfAcquireUdfData</a>, <a class="el" href="../../d9/d4/udfs_2verfysup_8c-source.html#l00236">UdfCheckForDismount()</a>, <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00809">UdfCompleteRequest()</a>, <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00448">UdfExceptionFilter()</a>, <a class="el" href="../../d3/d8/workque_8c-source.html#l00061">UdfFsdPostRequest()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00418">UdfNormalizeAndRaiseStatus()</a>, <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00539">UdfProcessException()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01512">UdfReleaseUdfData</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00559">_VCB::VcbCondition</a>, <a class="el" href="../../d6/d8/udfstruc_8h.html#a130a121">VcbDismountInProgress</a>, <a class="el" href="../../d6/d8/udfstruc_8h.html#a130a120">VcbInvalid</a>, <a class="el" href="../../d6/d8/udfstruc_8h.html#a130a119">VcbMounted</a>, <a class="el" href="../../d6/d8/udfstruc_8h.html#a130a117">VcbNotMounted</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00612">_VCB::VcbReference</a>, and <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00620">_VCB::VcbResidualReference</a>.
<p>
Referenced by <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00539">UdfProcessException()</a>.
<p>
<pre class="fragment"><div>00050                    :
00051 
00052     This <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a24">routines</a> performs an <a class="code" href="../../d0/d5/io_8h.html#a564">IoVerifyVolume</a> operation and takes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00053     appropriate action.  If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> verify <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> successful then we send <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> originating
00054     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> off to an Ex Worker Thread.  This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exception handler.
00055 
00056     No <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> system resources are held when <span class="keyword">this</span> routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called.
00057 
00058 Arguments:
00059 
00060     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> - The irp to send off after all <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> well and done.
00061 
00062     Device - The real device needing verification.
00063 
00064 Return Value:
00065 
00066     None.
00067 
00068 --*/
00069 
00070 {
00071     <a class="code" href="../../d7/d5/struct__VCB.html">PVCB</a> Vcb;
00072     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00073     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp;
00074 
00075     <a class="code" href="../../d1/d8/udfdata_8h.html#a28">ASSERT_IRP_CONTEXT</a>( IrpContext );
00076     <a class="code" href="../../d1/d8/udfdata_8h.html#a32">ASSERT_IRP</a>( Irp );
00077 
00078     <span class="comment">//</span>
00079     <span class="comment">//  Check if this Irp has a status of Verify required and if it does</span>
00080     <span class="comment">//  then call the I/O system to do a verify.</span>
00081     <span class="comment">//</span>
00082     <span class="comment">//  Skip the IoVerifyVolume if this is a mount or verify request</span>
00083     <span class="comment">//  itself.  Trying a recursive mount will cause a deadlock with</span>
00084     <span class="comment">//  the DeviceObject-&gt;DeviceLock.</span>
00085     <span class="comment">//</span>
00086 
00087     <span class="keywordflow">if</span> ((IrpContext-&gt;MajorFunction == <a class="code" href="../../d0/d5/io_8h.html#a26">IRP_MJ_FILE_SYSTEM_CONTROL</a>) &amp;&amp;
00088         ((IrpContext-&gt;MinorFunction == <a class="code" href="../../d0/d5/io_8h.html#a47">IRP_MN_MOUNT_VOLUME</a>) ||
00089          (IrpContext-&gt;MinorFunction == <a class="code" href="../../d0/d5/io_8h.html#a48">IRP_MN_VERIFY_VOLUME</a>))) {
00090 
00091         <span class="keywordflow">return</span> <a class="code" href="../../d2/d9/workque_8c.html#a4">UdfFsdPostRequest</a>( IrpContext, Irp );
00092     }
00093 
00094     <span class="comment">//</span>
00095     <span class="comment">//  Extract a pointer to the Vcb from the VolumeDeviceObject.</span>
00096     <span class="comment">//  Note that since we have specifically excluded mount,</span>
00097     <span class="comment">//  requests, we know that IrpSp-&gt;DeviceObject is indeed a</span>
00098     <span class="comment">//  volume device object.</span>
00099     <span class="comment">//</span>
00100 
00101     IrpSp = <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>( Irp );
00102 
00103     Vcb = &amp;CONTAINING_RECORD( IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o57">DeviceObject</a>,
00104                               <a class="code" href="../../d6/d7/struct__VOLUME__DEVICE__OBJECT.html">VOLUME_DEVICE_OBJECT</a>,
00105                               DeviceObject )-&gt;Vcb;
00106 
00107     <span class="comment">//</span>
00108     <span class="comment">//  Check if the volume still thinks it needs to be verified,</span>
00109     <span class="comment">//  if it doesn't then we can skip doing a verify because someone</span>
00110     <span class="comment">//  else beat us to it.</span>
00111     <span class="comment">//</span>
00112 
00113     <span class="keywordflow">try</span> {
00114 
00115         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( DeviceToVerify-&gt;Flags, DO_VERIFY_VOLUME )) {
00116 
00117             BOOLEAN AllowRawMount = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00118 
00119             <span class="comment">//</span>
00120             <span class="comment">//  We will allow Raw to mount this volume if we were doing a</span>
00121             <span class="comment">//  an absolute DASD open.</span>
00122             <span class="comment">//</span>
00123 
00124             <span class="keywordflow">if</span> ((IrpContext-&gt;MajorFunction == <a class="code" href="../../d0/d5/io_8h.html#a13">IRP_MJ_CREATE</a>) &amp;&amp;
00125                 (IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a>-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o19">FileName</a>.Length == 0) &amp;&amp;
00126                 (IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a>-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o9">RelatedFileObject</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00127 
00128                 AllowRawMount = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00129             }
00130 
00131             <span class="comment">//</span>
00132             <span class="comment">//  If the IopMount in IoVerifyVolume did something, and</span>
00133             <span class="comment">//  this is an absolute open, force a reparse.</span>
00134             <span class="comment">//</span>
00135 
00136             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d6/iosubs_8c.html#a122">IoVerifyVolume</a>( DeviceToVerify, AllowRawMount );
00137 
00138             <span class="comment">//</span>
00139             <span class="comment">//  If the verify operation completed it will return</span>
00140             <span class="comment">//  either STATUS_SUCCESS or STATUS_WRONG_VOLUME, exactly.</span>
00141             <span class="comment">//</span>
00142             <span class="comment">//  If UdfVerifyVolume encountered an error during</span>
00143             <span class="comment">//  processing, it will return that error.  If we got</span>
00144             <span class="comment">//  STATUS_WRONG_VOLUME from the verify, and our volume</span>
00145             <span class="comment">//  is now mounted, commute the status to STATUS_SUCCESS.</span>
00146             <span class="comment">//</span>
00147 
00148             <span class="keywordflow">if</span> ((<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_WRONG_VOLUME) &amp;&amp;
00149                 (Vcb-&gt;<a class="code" href="../../d7/d5/struct__VCB.html#o8">VcbCondition</a> == <a class="code" href="../../d6/d8/udfstruc_8h.html#a130a119">VcbMounted</a>)) {
00150 
00151                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00152             }
00153 
00154             <span class="comment">//</span>
00155             <span class="comment">//  Do a quick unprotected check here.  The routine will do</span>
00156             <span class="comment">//  a safe check.  After here we can release the resource.</span>
00157             <span class="comment">//  Note that if the volume really went away, we will be taking</span>
00158             <span class="comment">//  the Reparse path.</span>
00159             <span class="comment">//</span>
00160 
00161             <span class="comment">//</span>
00162             <span class="comment">//  If the device might need to go away then call our dismount routine.</span>
00163             <span class="comment">//</span>
00164 
00165             <span class="keywordflow">if</span> (((Vcb-&gt;<a class="code" href="../../d7/d5/struct__VCB.html#o8">VcbCondition</a> == <a class="code" href="../../d6/d8/udfstruc_8h.html#a130a117">VcbNotMounted</a>) ||
00166                  (Vcb-&gt;<a class="code" href="../../d7/d5/struct__VCB.html#o8">VcbCondition</a> == <a class="code" href="../../d6/d8/udfstruc_8h.html#a130a120">VcbInvalid</a>) ||
00167                  (Vcb-&gt;<a class="code" href="../../d7/d5/struct__VCB.html#o8">VcbCondition</a> == <a class="code" href="../../d6/d8/udfstruc_8h.html#a130a121">VcbDismountInProgress</a>)) &amp;&amp;
00168                 (Vcb-&gt;<a class="code" href="../../d7/d5/struct__VCB.html#o16">VcbReference</a> &lt;= Vcb-&gt;<a class="code" href="../../d7/d5/struct__VCB.html#o18">VcbResidualReference</a>)) {
00169 
00170                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a72">UdfAcquireUdfData</a>( IrpContext );
00171                 <a class="code" href="../../d8/d5/udfs_2verfysup_8c.html#a3">UdfCheckForDismount</a>( IrpContext, Vcb, FALSE );
00172                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a73">UdfReleaseUdfData</a>( IrpContext );
00173             }
00174 
00175             <span class="comment">//</span>
00176             <span class="comment">//  If this is a create and the verify succeeded then complete the</span>
00177             <span class="comment">//  request with a REPARSE status.</span>
00178             <span class="comment">//</span>
00179 
00180             <span class="keywordflow">if</span> ((IrpContext-&gt;MajorFunction == <a class="code" href="../../d0/d5/io_8h.html#a13">IRP_MJ_CREATE</a>) &amp;&amp;
00181                 (IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a>-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o9">RelatedFileObject</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
00182                 ((<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS) || (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_WRONG_VOLUME))) {
00183 
00184                 <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Information = <a class="code" href="../../d0/d5/io_8h.html#a109">IO_REMOUNT</a>;
00185 
00186                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, Irp, STATUS_REPARSE );
00187                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_REPARSE;
00188                 <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00189                 IrpContext = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00190 
00191             <span class="comment">//</span>
00192             <span class="comment">//  If there is still an error to process then call the Io system</span>
00193             <span class="comment">//  for a popup.</span>
00194             <span class="comment">//</span>
00195 
00196             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; !<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00197 
00198                 <span class="comment">//</span>
00199                 <span class="comment">//  Fill in the device object if required.</span>
00200                 <span class="comment">//</span>
00201 
00202                 <span class="keywordflow">if</span> (<a class="code" href="../../d0/d5/io_8h.html#a232">IoIsErrorUserInduced</a>( Status ) ) {
00203 
00204                     <a class="code" href="../../d4/d6/iosubs_8c.html#a105">IoSetHardErrorOrVerifyDevice</a>( Irp, DeviceToVerify );
00205                 }
00206 
00207                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a123">UdfNormalizeAndRaiseStatus</a>( IrpContext, Status );
00208             }
00209         }
00210 
00211         <span class="comment">//</span>
00212         <span class="comment">//  If there is still an Irp, send it off to an Ex Worker thread.</span>
00213         <span class="comment">//</span>
00214 
00215         <span class="keywordflow">if</span> (IrpContext != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00216 
00217             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d9/workque_8c.html#a4">UdfFsdPostRequest</a>( IrpContext, Irp );
00218         }
00219 
00220     } except(<a class="code" href="../../d3/d8/udfprocs_8h.html#a127">UdfExceptionFilter</a>( IrpContext, GetExceptionInformation() )) {
00221 
00222         <span class="comment">//</span>
00223         <span class="comment">//  We had some trouble trying to perform the verify or raised</span>
00224         <span class="comment">//  an error ourselves.  So we'll abort the I/O request with</span>
00225         <span class="comment">//  the error status that we get back from the execption code.</span>
00226         <span class="comment">//</span>
00227 
00228         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d8/udfprocs_8h.html#a128">UdfProcessException</a>( IrpContext, Irp, GetExceptionCode() );
00229     }
00230 
00231     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00232 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a246" doxytag="udfprocs.h::UdfPrePostIrp" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID UdfPrePostIrp           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d3/d8/workque_8c-source.html#l00111">111</a> of file <a class="el" href="../../d3/d8/workque_8c-source.html">workque.c</a>.
<p>
References <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00356">ASSERT_IRP</a>, <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00352">ASSERT_IRP_CONTEXT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03252">IoGetCurrentIrpStackLocation</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03620">IoMarkIrpPending</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01234">IRP_CONTEXT_FLAG_MORE_PROCESSING</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00055">IRP_MJ_CREATE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00067">IRP_MJ_DIRECTORY_CONTROL</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00058">IRP_MJ_READ</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00140">IRP_MN_MDL</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00103">IRP_MN_QUERY_DIRECTORY</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02069">_IO_STACK_LOCATION::Parameters</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00505">SetFlag</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l01437">UdfCleanupIrpContext()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00911">UdfLockUserBuffer</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01548">UdfReleaseFcb</a>, and <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l01606">UdfTeardownStructures()</a>.
<p>
Referenced by <a class="el" href="../../d8/d4/udfs_2read_8c-source.html#l00068">UdfCommonRead()</a>, <a class="el" href="../../d4/d7/udfs_2create_8c-source.html#l01955">UdfCompleteFcbOpen()</a>, and <a class="el" href="../../d3/d8/workque_8c-source.html#l00061">UdfFsdPostRequest()</a>.
<p>
<pre class="fragment"><div>00118                    :
00119 
00120     This routine performs any neccessary work before STATUS_PENDING <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00121     returned with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Fsd thread.  This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called within <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00122     filesystem and by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> oplock package.
00123 
00124 Arguments:
00125 
00126     Context - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> IrpContext to be queued to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Fsp
00127 
00128     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> - I/O <a class="code" href="../../d5/d4/kernel_2ddetrack_8c.html#a24">Request</a> Packet.
00129 
00130 Return Value:
00131 
00132     None.
00133 
00134 --*/
00135 
00136 {
00137     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp = <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>( Irp );
00138     BOOLEAN RemovedFcb;
00139 
00140     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00141 
00142     <a class="code" href="../../d1/d8/udfdata_8h.html#a28">ASSERT_IRP_CONTEXT</a>( IrpContext );
00143     <a class="code" href="../../d1/d8/udfdata_8h.html#a32">ASSERT_IRP</a>( Irp );
00144 
00145     <span class="comment">//</span>
00146     <span class="comment">//  Case on the type of the operation.</span>
00147     <span class="comment">//</span>
00148 
00149     <span class="keywordflow">switch</span> (IrpContext-&gt;MajorFunction) {
00150 
00151     <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a13">IRP_MJ_CREATE</a> :
00152 
00153         <span class="comment">//</span>
00154         <span class="comment">//  If called from the oplock package then there is an</span>
00155         <span class="comment">//  Fcb to possibly teardown.  We will call the teardown</span>
00156         <span class="comment">//  routine and release the Fcb if still present.  The cleanup</span>
00157         <span class="comment">//  code in create will know not to release this Fcb because</span>
00158         <span class="comment">//  we will clear the pointer.</span>
00159         <span class="comment">//</span>
00160 
00161         <span class="keywordflow">if</span> ((IrpContext-&gt;TeardownFcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
00162             *(IrpContext-&gt;TeardownFcb) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00163 
00164             <a class="code" href="../../d3/d8/udfprocs_8h.html#a210">UdfTeardownStructures</a>( IrpContext, *(IrpContext-&gt;TeardownFcb), FALSE, &amp;RemovedFcb );
00165 
00166             <span class="keywordflow">if</span> (!RemovedFcb) {
00167 
00168                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a85">UdfReleaseFcb</a>( IrpContext, *(IrpContext-&gt;TeardownFcb) );
00169             }
00170 
00171             *(IrpContext-&gt;TeardownFcb) = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00172             IrpContext-&gt;TeardownFcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00173         }
00174 
00175         <span class="keywordflow">break</span>;
00176 
00177     <span class="comment">//</span>
00178     <span class="comment">//  We need to lock the user's buffer, unless this is an MDL-read,</span>
00179     <span class="comment">//  in which case there is no user buffer.</span>
00180     <span class="comment">//</span>
00181 
00182     <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a16">IRP_MJ_READ</a> :
00183 
00184         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpContext-&gt;MinorFunction, IRP_MN_MDL )) {
00185 
00186             <a class="code" href="../../d3/d8/udfprocs_8h.html#a71">UdfLockUserBuffer</a>( IrpContext, IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.Read.Length );
00187         }
00188 
00189         <span class="keywordflow">break</span>;
00190 
00191     <span class="comment">//</span>
00192     <span class="comment">//  We also need to check whether this is a query file operation.</span>
00193     <span class="comment">//</span>
00194     
00195     <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a25">IRP_MJ_DIRECTORY_CONTROL</a> :
00196 
00197         <span class="keywordflow">if</span> (IrpContext-&gt;MinorFunction == <a class="code" href="../../d0/d5/io_8h.html#a44">IRP_MN_QUERY_DIRECTORY</a>) {
00198 
00199             <a class="code" href="../../d3/d8/udfprocs_8h.html#a71">UdfLockUserBuffer</a>( IrpContext, IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QueryDirectory.Length );
00200         }
00201 
00202         <span class="keywordflow">break</span>;
00203     }
00204     <span class="comment">//</span>
00205     <span class="comment">//  Cleanup the IrpContext for the post.</span>
00206     <span class="comment">//</span>
00207 
00208     <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( IrpContext-&gt;Flags, IRP_CONTEXT_FLAG_MORE_PROCESSING );
00209     <a class="code" href="../../d3/d8/udfprocs_8h.html#a208">UdfCleanupIrpContext</a>( IrpContext, TRUE );
00210 
00211     <span class="comment">//</span>
00212     <span class="comment">//  Mark the Irp to show that we've already returned pending to the user.</span>
00213     <span class="comment">//</span>
00214 
00215     <a class="code" href="../../d0/d5/io_8h.html#a234">IoMarkIrpPending</a>( Irp );
00216 
00217     <span class="keywordflow">return</span>;
00218 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a128" doxytag="udfprocs.h::UdfProcessException" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS UdfProcessException           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN NTSTATUS&nbsp;</td>
          <td class="mdname" nowrap> <em>ExceptionCode</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00539">539</a> of file <a class="el" href="../../d1/d7/udfdata_8c-source.html">udfdata.c</a>.
<p>
References <a class="el" href="../../d7/d6/halmips_8h-source.html#l00086">APC_LEVEL</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00356">ASSERT_IRP</a>, <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00353">ASSERT_OPTIONAL_IRP_CONTEXT</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00509">ClearFlag</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03252">IoGetCurrentIrpStackLocation</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l07093">IoGetDeviceToVerify()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03528">IoIsErrorUserInduced</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03620">IoMarkIrpPending</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l08769">IoRaiseHardError()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l09757">IoSetDeviceToVerify()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01635">_IRP::IoStatus</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01242">IRP_CONTEXT_FLAG_DISABLE_POPUPS</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01236">IRP_CONTEXT_FLAG_FORCE_POST</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01234">IRP_CONTEXT_FLAG_MORE_PROCESSING</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01237">IRP_CONTEXT_FLAG_TOP_LEVEL</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d2/d8/ps_8h-source.html#l00645">PsGetCurrentThread</a>, <a class="el" href="../../d0/d2/struct__IRP.html#o38">_IRP::Tail</a>, <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00809">UdfCompleteRequest()</a>, <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00448">UdfExceptionFilter()</a>, <a class="el" href="../../d3/d8/workque_8c-source.html#l00061">UdfFsdPostRequest()</a>, and <a class="el" href="../../d9/d4/udfs_2verfysup_8c-source.html#l00042">UdfPerformVerify()</a>.
<p>
Referenced by <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00218">UdfFsdDispatch()</a>, <a class="el" href="../../d1/d7/fspdisp_8c-source.html#l00038">UdfFspDispatch()</a>, and <a class="el" href="../../d9/d4/udfs_2verfysup_8c-source.html#l00042">UdfPerformVerify()</a>.
<p>
<pre class="fragment"><div>00547                    :
00548 
00549     This routine processes an exception.  It either completes <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> request
00550     with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> exception status in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> IrpContext, sends <span class="keyword">this</span> off to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Fsp
00551     workque or causes <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> to be retried in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current thread <span class="keywordflow">if</span> a verification
00552     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> needed.
00553 
00554     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> volume needs to be verified (STATUS_VERIFY_REQUIRED) and we can
00555     do the work in the current thread we will translate the status code
00556     to STATUS_CANT_WAIT to indicate that we need to retry the request.
00557 
00558 Arguments:
00559 
00560     Irp - Supplies the Irp being processed
00561 
00562     ExceptionCode - Supplies the normalized exception status being handled
00563 
00564 Return Value:
00565 
00566     NTSTATUS - Returns the results of either posting the Irp or the
00567         saved completion status.
00568 
00569 --*/
00570 
00571 {
00572     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> Device;
00573     <a class="code" href="../../d7/d7/struct__VPB.html">PVPB</a> Vpb;
00574     <a class="code" href="../../d5/d6/struct__ETHREAD.html">PETHREAD</a> Thread;
00575 
00576     <a class="code" href="../../d1/d8/udfdata_8h.html#a29">ASSERT_OPTIONAL_IRP_CONTEXT</a>( IrpContext );
00577     <a class="code" href="../../d1/d8/udfdata_8h.html#a32">ASSERT_IRP</a>( Irp );
00578 
00579     <span class="comment">//</span>
00580     <span class="comment">//  If there is not an irp context, then complete the request with the</span>
00581     <span class="comment">//  current status code.</span>
00582     <span class="comment">//</span>
00583 
00584     <span class="keywordflow">if</span> (!ARGUMENT_PRESENT( IrpContext )) {
00585 
00586         <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( NULL, Irp, ExceptionCode );
00587         <span class="keywordflow">return</span> ExceptionCode;
00588     }
00589 
00590     <span class="comment">//</span>
00591     <span class="comment">//  Get the real exception status from the IrpContext.</span>
00592     <span class="comment">//</span>
00593 
00594     ExceptionCode = IrpContext-&gt;ExceptionStatus;
00595 
00596     <span class="comment">//</span>
00597     <span class="comment">//  If we are not a top level request then we just complete the request</span>
00598     <span class="comment">//  with the current status code.</span>
00599     <span class="comment">//</span>
00600 
00601     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpContext-&gt;Flags, IRP_CONTEXT_FLAG_TOP_LEVEL )) {
00602 
00603         <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, Irp, ExceptionCode );
00604 
00605         <span class="keywordflow">return</span> ExceptionCode;
00606     }
00607 
00608     <span class="comment">//</span>
00609     <span class="comment">//  Check if we are posting this request.  One of the following must be true</span>
00610     <span class="comment">//  if we are to post a request.</span>
00611     <span class="comment">//</span>
00612     <span class="comment">//      - Status code is STATUS_CANT_WAIT and the request is asynchronous</span>
00613     <span class="comment">//          or we are forcing this to be posted.</span>
00614     <span class="comment">//</span>
00615     <span class="comment">//      - Status code is STATUS_VERIFY_REQUIRED and we are at APC level</span>
00616     <span class="comment">//          or higher.  Can't wait for IO in the verify path in this case.</span>
00617     <span class="comment">//</span>
00618     <span class="comment">//  Set the MORE_PROCESSING flag in the IrpContext to keep if from being</span>
00619     <span class="comment">//  deleted if this is a retryable condition.</span>
00620     <span class="comment">//</span>
00621     <span class="comment">//  Note:  Children of UdfFsdPostRequest() can raise.</span>
00622     <span class="comment">//</span>
00623 
00624     <span class="keywordflow">try</span> {
00625     
00626         <span class="keywordflow">if</span> (ExceptionCode == STATUS_CANT_WAIT) {
00627 
00628             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpContext-&gt;Flags, IRP_CONTEXT_FLAG_FORCE_POST )) {
00629 
00630                 ExceptionCode = <a class="code" href="../../d2/d9/workque_8c.html#a4">UdfFsdPostRequest</a>( IrpContext, Irp );
00631             }
00632 
00633         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ExceptionCode == STATUS_VERIFY_REQUIRED) {
00634 
00635             <span class="keywordflow">if</span> (KeGetCurrentIrql() &gt;= <a class="code" href="../../d6/d7/halmips_8h.html#a52">APC_LEVEL</a>) {
00636 
00637                 ExceptionCode = <a class="code" href="../../d2/d9/workque_8c.html#a4">UdfFsdPostRequest</a>( IrpContext, Irp );
00638             }
00639         }
00640     }
00641     except (<a class="code" href="../../d3/d8/udfprocs_8h.html#a127">UdfExceptionFilter</a>( IrpContext, GetExceptionInformation()))  {
00642     
00643         ExceptionCode = GetExceptionCode(); 
00644     }
00645 
00646     <span class="comment">//</span>
00647     <span class="comment">//  If we posted the request or our caller will retry then just return here.</span>
00648     <span class="comment">//</span>
00649 
00650     <span class="keywordflow">if</span> ((ExceptionCode == STATUS_PENDING) ||
00651         (ExceptionCode == STATUS_CANT_WAIT)) {
00652 
00653         <span class="keywordflow">return</span> ExceptionCode;
00654     }
00655 
00656     <a class="code" href="../../d5/d5/cc_8h.html#a61">ClearFlag</a>( IrpContext-&gt;Flags, IRP_CONTEXT_FLAG_MORE_PROCESSING );
00657 
00658     <span class="comment">//</span>
00659     <span class="comment">//  Store this error into the Irp for posting back to the Io system.</span>
00660     <span class="comment">//</span>
00661 
00662     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status = ExceptionCode;
00663 
00664     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d5/io_8h.html#a232">IoIsErrorUserInduced</a>( ExceptionCode )) {
00665 
00666         <span class="comment">//</span>
00667         <span class="comment">//  Check for the various error conditions that can be caused by,</span>
00668         <span class="comment">//  and possibly resolved my the user.</span>
00669         <span class="comment">//</span>
00670 
00671         <span class="keywordflow">if</span> (ExceptionCode == STATUS_VERIFY_REQUIRED) {
00672 
00673             <span class="comment">//</span>
00674             <span class="comment">//  Now we are at the top level file system entry point.</span>
00675             <span class="comment">//</span>
00676             <span class="comment">//  If we have already posted this request then the device to</span>
00677             <span class="comment">//  verify is in the original thread.  Find this via the Irp.</span>
00678             <span class="comment">//</span>
00679 
00680             Device = <a class="code" href="../../d4/d6/iosubs_8c.html#a72">IoGetDeviceToVerify</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.Thread );
00681             <a class="code" href="../../d4/d6/iosubs_8c.html#a104">IoSetDeviceToVerify</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.Thread, NULL );
00682 
00683             <span class="comment">//</span>
00684             <span class="comment">//  If there is no device in that location then check in the</span>
00685             <span class="comment">//  current thread.</span>
00686             <span class="comment">//</span>
00687 
00688             <span class="keywordflow">if</span> (Device == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00689 
00690                 Device = <a class="code" href="../../d4/d6/iosubs_8c.html#a72">IoGetDeviceToVerify</a>( <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>() );
00691                 <a class="code" href="../../d4/d6/iosubs_8c.html#a104">IoSetDeviceToVerify</a>( <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>(), NULL );
00692 
00693                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( Device != NULL );
00694 
00695                 <span class="comment">//</span>
00696                 <span class="comment">//  Let's not BugCheck just because the driver screwed up.</span>
00697                 <span class="comment">//</span>
00698 
00699                 <span class="keywordflow">if</span> (Device == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00700 
00701                     ExceptionCode = STATUS_DRIVER_INTERNAL_ERROR;
00702 
00703                     <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, Irp, ExceptionCode );
00704 
00705                     <span class="keywordflow">return</span> ExceptionCode;
00706                 }
00707             }
00708 
00709             <span class="comment">//</span>
00710             <span class="comment">//  CdPerformVerify() will do the right thing with the Irp.</span>
00711             <span class="comment">//  If we return STATUS_CANT_WAIT then the current thread</span>
00712             <span class="comment">//  can retry the request.</span>
00713             <span class="comment">//</span>
00714 
00715             <span class="keywordflow">return</span> <a class="code" href="../../d8/d5/udfs_2verfysup_8c.html#a2">UdfPerformVerify</a>( IrpContext, Irp, Device );
00716         }
00717 
00718         <span class="comment">//</span>
00719         <span class="comment">//  The other user induced conditions generate an error unless</span>
00720         <span class="comment">//  they have been disabled for this request.</span>
00721         <span class="comment">//</span>
00722 
00723         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpContext-&gt;Flags, IRP_CONTEXT_FLAG_DISABLE_POPUPS )) {
00724 
00725             <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, Irp, ExceptionCode );
00726 
00727             <span class="keywordflow">return</span> ExceptionCode;
00728 
00729         } <span class="keywordflow">else</span> {
00730 
00731             <span class="comment">//</span>
00732             <span class="comment">//  Generate a pop-up</span>
00733             <span class="comment">//</span>
00734 
00735             <span class="keywordflow">if</span> (<a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>( Irp )-&gt;FileObject != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00736 
00737                 Vpb = <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>( Irp )-&gt;FileObject-&gt;Vpb;
00738 
00739             } <span class="keywordflow">else</span> {
00740 
00741                 Vpb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00742             }
00743 
00744             <span class="comment">//</span>
00745             <span class="comment">//  The device to verify is either in my thread local storage</span>
00746             <span class="comment">//  or that of the thread that owns the Irp.</span>
00747             <span class="comment">//</span>
00748 
00749             Thread = <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o38">Tail</a>.Overlay.Thread;
00750             Device = <a class="code" href="../../d4/d6/iosubs_8c.html#a72">IoGetDeviceToVerify</a>( Thread );
00751 
00752             <span class="keywordflow">if</span> (Device == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00753 
00754                 Thread = <a class="code" href="../../d1/d9/ps_8h.html#a20">PsGetCurrentThread</a>();
00755                 Device = <a class="code" href="../../d4/d6/iosubs_8c.html#a72">IoGetDeviceToVerify</a>( Thread );
00756 
00757                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( Device != NULL );
00758 
00759                 <span class="comment">//</span>
00760                 <span class="comment">//  Let's not BugCheck just because the driver screwed up.</span>
00761                 <span class="comment">//</span>
00762 
00763                 <span class="keywordflow">if</span> (Device == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00764 
00765                     <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, Irp, ExceptionCode );
00766 
00767                     <span class="keywordflow">return</span> ExceptionCode;
00768                 }
00769             }
00770 
00771             <span class="comment">//</span>
00772             <span class="comment">//  This routine actually causes the pop-up.  It usually</span>
00773             <span class="comment">//  does this by queuing an APC to the callers thread,</span>
00774             <span class="comment">//  but in some cases it will complete the request immediately,</span>
00775             <span class="comment">//  so it is very important to IoMarkIrpPending() first.</span>
00776             <span class="comment">//</span>
00777 
00778             <a class="code" href="../../d0/d5/io_8h.html#a234">IoMarkIrpPending</a>( Irp );
00779             <a class="code" href="../../d4/d6/iosubs_8c.html#a93">IoRaiseHardError</a>( Irp, Vpb, Device );
00780 
00781             <span class="comment">//</span>
00782             <span class="comment">//  We will be handing control back to the caller here, so</span>
00783             <span class="comment">//  reset the saved device object.</span>
00784             <span class="comment">//</span>
00785 
00786             <a class="code" href="../../d4/d6/iosubs_8c.html#a104">IoSetDeviceToVerify</a>( Thread, NULL );
00787 
00788             <span class="comment">//</span>
00789             <span class="comment">//  The Irp will be completed by Io or resubmitted.  In either</span>
00790             <span class="comment">//  case we must clean up the IrpContext here.</span>
00791             <span class="comment">//</span>
00792 
00793             <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, NULL, STATUS_SUCCESS );
00794             <span class="keywordflow">return</span> STATUS_PENDING;
00795         }
00796     }
00797 
00798     <span class="comment">//</span>
00799     <span class="comment">//  This is just a run of the mill error.</span>
00800     <span class="comment">//</span>
00801 
00802     <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, Irp, ExceptionCode );
00803 
00804     <span class="keywordflow">return</span> ExceptionCode;
00805 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a158" doxytag="udfprocs.h::UdfPurgeVolume" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS UdfPurgeVolume           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d7/d5/struct__VCB.html">PVCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Vcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>DismountUnderway</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d1/udfs_2cachesup_8c-source.html#l00417">417</a> of file <a class="el" href="../../d9/d1/udfs_2cachesup_8c-source.html">udfs/cachesup.c</a>.
<p>
References <a class="el" href="../../d6/d7/fssup_8c-source.html#l02331">CcPurgeCacheSection()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01471">_SECTION_OBJECT_POINTERS::DataSectionObject</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01027">_FCB::FcbNonpaged</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00979">_FCB::FcbReference</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01473">_SECTION_OBJECT_POINTERS::ImageSectionObject</a>, <a class="el" href="../../d2/d1/mm_8h.html#a346a180">MmFlushForWrite</a>, <a class="el" href="../../d7/d4/flushsec_8c-source.html#l02094">MmFlushImageSection()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d6/udfs_2nodetype_8h-source.html#l00063">SafeNodeType</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00853">_FCB_NONPAGED::SegmentObject</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01524">UdfAcquireAllFiles</a>, <a class="el" href="../../d9/d1/udfs_2cachesup_8c-source.html#l00215">UdfDeleteInternalStream()</a>, <a class="el" href="../../d3/d8/close_8c-source.html#l00099">UdfFspClose()</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l01997">UdfGetNextFcb()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01559">UdfLockVcb</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01527">UdfReleaseAllFiles</a>, <a class="el" href="../../d2/d6/udfs_2nodetype_8h-source.html#l00038">UDFS_NTC_FCB_DATA</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l01606">UdfTeardownStructures()</a>, and <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01563">UdfUnlockVcb</a>.
<p>
Referenced by <a class="el" href="../../d9/d6/udfs_2cleanup_8c-source.html#l00042">UdfCommonCleanup()</a>, <a class="el" href="../../d4/d7/udfs_2create_8c-source.html#l01955">UdfCompleteFcbOpen()</a>, <a class="el" href="../../d9/d4/udfs_2verfysup_8c-source.html#l00365">UdfDismountVcb()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l01271">UdfInvalidateVolumes()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l00621">UdfLockVolumeInternal()</a>, and <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l02043">UdfVerifyVolume()</a>.
<p>
<pre class="fragment"><div>00425                    :
00426 
00427     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called to purge <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> volume.  The purpose <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to make all <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> stale <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>
00428     objects in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> system go away, minimizing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> reference counts, so that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> volume may
00429     be locked or deleted.
00430 
00431     The Vcb <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> already acquired exclusively.  We will lock <a class="code" href="../../d6/d0/wsprintf_8c.html#a0">out</a> all <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> operations by
00432     acquiring <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> global <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> resource.  Then we will walk through all of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Fcb's and
00433     perform <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> purge.
00434 
00435 Arguments:
00436 
00437     Vcb - Vcb <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> volume to purge.
00438 
00439     DismountUnderway - Indicates that we are trying to <span class="keyword">delete</span> all of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> objects.
00440         We will purge <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Metadata and VolumeDasd and dereference all internal streams.
00441 
00442 Return Value:
00443 
00444     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - The first <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> purge operation.
00445 
00446 --*/
00447 
00448 {
00449     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00450 
00451     PVOID RestartKey = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00452     <a class="code" href="../../d7/d9/struct__FCB.html">PFCB</a> ThisFcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00453     <a class="code" href="../../d7/d9/struct__FCB.html">PFCB</a> NextFcb;
00454 
00455     BOOLEAN RemovedFcb;
00456 
00457     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00458 
00459     <span class="comment">//</span>
00460     <span class="comment">//  Force any remaining Fcb's in the delayed close queue to be closed.</span>
00461     <span class="comment">//</span>
00462 
00463     <a class="code" href="../../d3/d8/udfprocs_8h.html#a250">UdfFspClose</a>( Vcb );
00464 
00465     <span class="comment">//</span>
00466     <span class="comment">//  Acquire the global file resource.</span>
00467     <span class="comment">//</span>
00468 
00469     <a class="code" href="../../d3/d8/udfprocs_8h.html#a77">UdfAcquireAllFiles</a>( IrpContext, Vcb );
00470 
00471     <span class="comment">//</span>
00472     <span class="comment">//  Loop through each Fcb in the Fcb Table and perform the flush.</span>
00473     <span class="comment">//</span>
00474 
00475     <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00476 
00477         <span class="comment">//</span>
00478         <span class="comment">//  Lock the Vcb to lookup the next Fcb.</span>
00479         <span class="comment">//</span>
00480 
00481         <a class="code" href="../../d3/d8/udfprocs_8h.html#a88">UdfLockVcb</a>( IrpContext, Vcb );
00482         NextFcb = <a class="code" href="../../d3/d8/udfprocs_8h.html#a212">UdfGetNextFcb</a>( IrpContext, Vcb, &amp;RestartKey );
00483 
00484         <span class="comment">//</span>
00485         <span class="comment">//  Reference the NextFcb if present.</span>
00486         <span class="comment">//</span>
00487 
00488         <span class="keywordflow">if</span> (NextFcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00489 
00490             NextFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o8">FcbReference</a> += 1;
00491         }
00492 
00493         <span class="comment">//</span>
00494         <span class="comment">//  If the last Fcb is present then decrement reference count and call teardown</span>
00495         <span class="comment">//  to see if it should be removed.</span>
00496         <span class="comment">//</span>
00497 
00498         <span class="keywordflow">if</span> (ThisFcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00499 
00500             ThisFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o8">FcbReference</a> -= 1;
00501 
00502             <a class="code" href="../../d3/d8/udfprocs_8h.html#a89">UdfUnlockVcb</a>( IrpContext, Vcb );
00503 
00504             <a class="code" href="../../d3/d8/udfprocs_8h.html#a210">UdfTeardownStructures</a>( IrpContext, ThisFcb, FALSE, &amp;RemovedFcb );
00505 
00506         } <span class="keywordflow">else</span> {
00507 
00508             <a class="code" href="../../d3/d8/udfprocs_8h.html#a89">UdfUnlockVcb</a>( IrpContext, Vcb );
00509         }
00510 
00511         <span class="comment">//</span>
00512         <span class="comment">//  Break out of the loop if no more Fcb's.</span>
00513         <span class="comment">//</span>
00514 
00515         <span class="keywordflow">if</span> (NextFcb == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00516 
00517             <span class="keywordflow">break</span>;
00518         }
00519 
00520         <span class="comment">//</span>
00521         <span class="comment">//  Move to the next Fcb.</span>
00522         <span class="comment">//</span>
00523 
00524         ThisFcb = NextFcb;
00525 
00526         <span class="comment">//</span>
00527         <span class="comment">//  If there is a image section then see if that can be closed.</span>
00528         <span class="comment">//</span>
00529 
00530         <span class="keywordflow">if</span> (ThisFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o17">FcbNonpaged</a>-&gt;<a class="code" href="../../d4/d0/struct__FCB__NONPAGED.html#o2">SegmentObject</a>.<a class="code" href="../../d7/d0/struct__SECTION__OBJECT__POINTERS.html#o2">ImageSectionObject</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00531 
00532             <a class="code" href="../../d6/d5/flushsec_8c.html#a13">MmFlushImageSection</a>( &amp;ThisFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o17">FcbNonpaged</a>-&gt;<a class="code" href="../../d4/d0/struct__FCB__NONPAGED.html#o2">SegmentObject</a>, MmFlushForWrite );
00533         }
00534 
00535         <span class="comment">//</span>
00536         <span class="comment">//  If there is a data section then purge this.  If there is an image</span>
00537         <span class="comment">//  section then we won't be able to.  Remember this if it is our first</span>
00538         <span class="comment">//  error.</span>
00539         <span class="comment">//</span>
00540 
00541         <span class="keywordflow">if</span> ((ThisFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o17">FcbNonpaged</a>-&gt;<a class="code" href="../../d4/d0/struct__FCB__NONPAGED.html#o2">SegmentObject</a>.<a class="code" href="../../d7/d0/struct__SECTION__OBJECT__POINTERS.html#o0">DataSectionObject</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
00542             !<a class="code" href="../../d4/d2/cache_8h.html#a61">CcPurgeCacheSection</a>( &amp;ThisFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o17">FcbNonpaged</a>-&gt;<a class="code" href="../../d4/d0/struct__FCB__NONPAGED.html#o2">SegmentObject</a>,
00543                                    NULL,
00544                                    0,
00545                                    FALSE ) &amp;&amp;
00546             (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS)) {
00547 
00548             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_UNABLE_TO_DELETE_SECTION;
00549         }
00550 
00551         <span class="comment">//</span>
00552         <span class="comment">//  Dereference the internal stream if dismounting.</span>
00553         <span class="comment">//</span>
00554 
00555         <span class="keywordflow">if</span> (DismountUnderway &amp;&amp;
00556             (<a class="code" href="../../d1/d7/udfs_2nodetype_8h.html#a12">SafeNodeType</a>( ThisFcb ) != <a class="code" href="../../d1/d7/udfs_2nodetype_8h.html#a4">UDFS_NTC_FCB_DATA</a>) &amp;&amp;
00557             (ThisFcb-&gt;FileObject != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00558 
00559             <a class="code" href="../../d3/d8/udfprocs_8h.html#a155">UdfDeleteInternalStream</a>( IrpContext, ThisFcb );
00560         }
00561     }
00562 
00563     <span class="comment">//</span>
00564     <span class="comment">//  Now look at the Root Index, Metadata, Volume Dasd and VAT Fcbs.</span>
00565     <span class="comment">//  Note that we usually hit the Root Index in the loop above, but</span>
00566     <span class="comment">//  it is possible miss it if it didn't get into the Fcb table in the</span>
00567     <span class="comment">//  first place!</span>
00568     <span class="comment">//</span>
00569 
00570     <span class="keywordflow">if</span> (DismountUnderway) {
00571 
00572         <span class="keywordflow">if</span> (Vcb-&gt;RootIndexFcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00573 
00574             ThisFcb = Vcb-&gt;RootIndexFcb;
00575             InterlockedIncrement( &amp;ThisFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o8">FcbReference</a> );
00576 
00577             <span class="keywordflow">if</span> ((ThisFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o17">FcbNonpaged</a>-&gt;<a class="code" href="../../d4/d0/struct__FCB__NONPAGED.html#o2">SegmentObject</a>.<a class="code" href="../../d7/d0/struct__SECTION__OBJECT__POINTERS.html#o0">DataSectionObject</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
00578                 !<a class="code" href="../../d4/d2/cache_8h.html#a61">CcPurgeCacheSection</a>( &amp;ThisFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o17">FcbNonpaged</a>-&gt;<a class="code" href="../../d4/d0/struct__FCB__NONPAGED.html#o2">SegmentObject</a>,
00579                                        NULL,
00580                                        0,
00581                                        FALSE ) &amp;&amp;
00582                 (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS)) {
00583 
00584                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_UNABLE_TO_DELETE_SECTION;
00585             }
00586 
00587             <a class="code" href="../../d3/d8/udfprocs_8h.html#a155">UdfDeleteInternalStream</a>( IrpContext, ThisFcb );
00588             InterlockedDecrement( &amp;ThisFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o8">FcbReference</a> );
00589             <a class="code" href="../../d3/d8/udfprocs_8h.html#a210">UdfTeardownStructures</a>( IrpContext, ThisFcb, FALSE, &amp;RemovedFcb );
00590         }
00591         
00592         <span class="keywordflow">if</span> (Vcb-&gt;MetadataFcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00593 
00594             ThisFcb = Vcb-&gt;MetadataFcb;
00595             InterlockedIncrement( &amp;ThisFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o8">FcbReference</a> );
00596 
00597             <span class="keywordflow">if</span> ((ThisFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o17">FcbNonpaged</a>-&gt;<a class="code" href="../../d4/d0/struct__FCB__NONPAGED.html#o2">SegmentObject</a>.<a class="code" href="../../d7/d0/struct__SECTION__OBJECT__POINTERS.html#o0">DataSectionObject</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
00598                 !<a class="code" href="../../d4/d2/cache_8h.html#a61">CcPurgeCacheSection</a>( &amp;ThisFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o17">FcbNonpaged</a>-&gt;<a class="code" href="../../d4/d0/struct__FCB__NONPAGED.html#o2">SegmentObject</a>,
00599                                        NULL,
00600                                        0,
00601                                        FALSE ) &amp;&amp;
00602                 (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS)) {
00603 
00604                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_UNABLE_TO_DELETE_SECTION;
00605             }
00606 
00607             <a class="code" href="../../d3/d8/udfprocs_8h.html#a155">UdfDeleteInternalStream</a>( IrpContext, ThisFcb );
00608             InterlockedDecrement( &amp;ThisFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o8">FcbReference</a> );
00609             <a class="code" href="../../d3/d8/udfprocs_8h.html#a210">UdfTeardownStructures</a>( IrpContext, ThisFcb, FALSE, &amp;RemovedFcb );
00610         }
00611 
00612         <span class="keywordflow">if</span> (Vcb-&gt;VatFcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00613 
00614             ThisFcb = Vcb-&gt;VatFcb;
00615             InterlockedIncrement( &amp;ThisFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o8">FcbReference</a> );
00616 
00617             <span class="keywordflow">if</span> ((ThisFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o17">FcbNonpaged</a>-&gt;<a class="code" href="../../d4/d0/struct__FCB__NONPAGED.html#o2">SegmentObject</a>.<a class="code" href="../../d7/d0/struct__SECTION__OBJECT__POINTERS.html#o0">DataSectionObject</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
00618                 !<a class="code" href="../../d4/d2/cache_8h.html#a61">CcPurgeCacheSection</a>( &amp;ThisFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o17">FcbNonpaged</a>-&gt;<a class="code" href="../../d4/d0/struct__FCB__NONPAGED.html#o2">SegmentObject</a>,
00619                                        NULL,
00620                                        0,
00621                                        FALSE ) &amp;&amp;
00622                 (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS)) {
00623 
00624                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_UNABLE_TO_DELETE_SECTION;
00625             }
00626 
00627             <a class="code" href="../../d3/d8/udfprocs_8h.html#a155">UdfDeleteInternalStream</a>( IrpContext, ThisFcb );
00628             InterlockedDecrement( &amp;ThisFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o8">FcbReference</a> );
00629             <a class="code" href="../../d3/d8/udfprocs_8h.html#a210">UdfTeardownStructures</a>( IrpContext, ThisFcb, FALSE, &amp;RemovedFcb );
00630         }
00631 
00632         <span class="keywordflow">if</span> (Vcb-&gt;VolumeDasdFcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00633 
00634             ThisFcb = Vcb-&gt;VolumeDasdFcb;
00635             InterlockedIncrement( &amp;ThisFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o8">FcbReference</a> );
00636 
00637             <span class="keywordflow">if</span> ((ThisFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o17">FcbNonpaged</a>-&gt;<a class="code" href="../../d4/d0/struct__FCB__NONPAGED.html#o2">SegmentObject</a>.<a class="code" href="../../d7/d0/struct__SECTION__OBJECT__POINTERS.html#o0">DataSectionObject</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
00638                 !<a class="code" href="../../d4/d2/cache_8h.html#a61">CcPurgeCacheSection</a>( &amp;ThisFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o17">FcbNonpaged</a>-&gt;<a class="code" href="../../d4/d0/struct__FCB__NONPAGED.html#o2">SegmentObject</a>,
00639                                        NULL,
00640                                        0,
00641                                        FALSE ) &amp;&amp;
00642                 (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_SUCCESS)) {
00643 
00644                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_UNABLE_TO_DELETE_SECTION;
00645             }
00646 
00647             InterlockedDecrement( &amp;ThisFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o8">FcbReference</a> );
00648             <a class="code" href="../../d3/d8/udfprocs_8h.html#a210">UdfTeardownStructures</a>( IrpContext, ThisFcb, FALSE, &amp;RemovedFcb );
00649         }
00650     }
00651 
00652     <span class="comment">//</span>
00653     <span class="comment">//  Release all of the files.</span>
00654     <span class="comment">//</span>
00655 
00656     <a class="code" href="../../d3/d8/udfprocs_8h.html#a78">UdfReleaseAllFiles</a>( IrpContext, Vcb );
00657 
00658     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00659 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a122" doxytag="udfprocs.h::UdfRaiseStatus" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> INLINE DECLSPEC_NORETURN VOID UdfRaiseStatus           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN NTSTATUS&nbsp;</td>
          <td class="mdname" nowrap> <em>Status</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00406">406</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.
<p>
References <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00332">DebugBreakOnStatus</a>, <a class="el" href="../../d1/d3/ex_2alpha_2raisests_8c-source.html#l00157">ExRaiseStatus()</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
Referenced by <a class="el" href="../../d5/d8/resrcsup_8c-source.html#l00047">UdfAcquireResource()</a>, <a class="el" href="../../d6/d4/namesup_8c-source.html#l00819">UdfCheckLegalCS0Dstring()</a>, <a class="el" href="../../d4/d7/udfs_2create_8c-source.html#l00108">UdfCommonCreate()</a>, <a class="el" href="../../d8/d4/udfs_2read_8c-source.html#l00068">UdfCommonRead()</a>, <a class="el" href="../../d4/d7/udfs_2create_8c-source.html#l01955">UdfCompleteFcbOpen()</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l03713">UdfCreateFileLock()</a>, <a class="el" href="../../d9/d1/udfs_2cachesup_8c-source.html#l00046">UdfCreateInternalStream()</a>, <a class="el" href="../../d4/d6/deviosup_8c-source.html#l00474">UdfCreateUserMdl()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l03817">UdfDetermineVolumeBounding()</a>, <a class="el" href="../../d6/d3/prefxsup_8c-source.html#l00324">UdfFindPrefix()</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l04144">UdfGetNextAllocationPostProcessing()</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l04013">UdfInitializeAllocationContext()</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l03388">UdfInitializeAllocations()</a>, <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l01003">UdfInitializeEnumeration()</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l02297">UdfInitializeFcbFromIcbContext()</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l02951">UdfInitializeIcbContextFromFcb()</a>, <a class="el" href="../../d6/d3/prefxsup_8c-source.html#l00064">UdfInsertPrefix()</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l03124">UdfLookupActiveIcb()</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l03790">UdfLookupActiveIcbInExtent()</a>, <a class="el" href="../../d5/d7/dirsup_8c-source.html#l00916">UdfLookupDirEntryPostProcessing()</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l03278">UdfLookupEa()</a>, <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l01688">UdfLookupFileEntryInEnumeration()</a>, <a class="el" href="../../d3/d5/allocsup_8c-source.html#l01177">UdfLookupMetaVsnOfExtent()</a>, <a class="el" href="../../d3/d5/allocsup_8c-source.html#l01017">UdfLookupPsnOfExtent()</a>, <a class="el" href="../../d4/d6/deviosup_8c-source.html#l01435">UdfMultipleAsync()</a>, <a class="el" href="../../d4/d6/deviosup_8c-source.html#l00201">UdfNonCachedRead()</a>, <a class="el" href="../../d4/d7/udfs_2create_8c-source.html#l01244">UdfOpenObjectByFileId()</a>, <a class="el" href="../../d4/d6/deviosup_8c-source.html#l00883">UdfPrepareBuffers()</a>, <a class="el" href="../../d4/d6/deviosup_8c-source.html#l00685">UdfReadSectors()</a>, <a class="el" href="../../d5/d7/dirsup_8c-source.html#l00360">UdfUpdateDirNames()</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l00477">UdfUpdateVcbPhase0()</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l02617">UdfVerifyDescriptor()</a>, <a class="el" href="../../d9/d4/udfs_2verfysup_8c-source.html#l00760">UdfVerifyFcbOperation()</a>, and <a class="el" href="../../d9/d4/udfs_2verfysup_8c-source.html#l00603">UdfVerifyVcb()</a>.
<p>
<pre class="fragment"><div>00410 {
00411     IrpContext-&gt;ExceptionStatus = <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00412     <a class="code" href="../../d1/d8/udfdata_8h.html#a9">DebugBreakOnStatus</a>( Status );
00413     <a class="code" href="../../d5/d8/ex_8h.html#a303">ExRaiseStatus</a>( Status );
00414 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a163" doxytag="udfprocs.h::UdfRawBufferSize" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> INLINE ULONG UdfRawBufferSize           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d5/struct__VCB.html">PVCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Vcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>StructureSize</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00931">931</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.
<p>
References <a class="el" href="../../d3/d0/mm_8h-source.html#l00117">ROUND_TO_PAGES</a>, and <a class="el" href="../../d4/d7/fsrtlp_8h-source.html#l00212">SectorAlign</a>.
<p>
Referenced by <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l03307">UdfFindAnchorVolumeDescriptor()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l02558">UdfFindFileSetDescriptor()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l02832">UdfFindVolumeDescriptors()</a>, and <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l00477">UdfUpdateVcbPhase0()</a>.
<p>
<pre class="fragment"><div>00935 {
00936     <span class="keywordflow">return</span> (ULONG)<a class="code" href="../../d2/d1/mm_8h.html#a4">ROUND_TO_PAGES</a>( <a class="code" href="../../d3/d8/fsrtlp_8h.html#a12">SectorAlign</a>( Vcb, StructureSize ));
00937 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a165" doxytag="udfprocs.h::UdfRawBufferSizeN" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> INLINE ULONG UdfRawBufferSizeN           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>SectorSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>StructureSize</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00951">951</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.
<p>
References <a class="el" href="../../d3/d0/mm_8h-source.html#l00117">ROUND_TO_PAGES</a>, <a class="el" href="../../d6/d7/udfs__rec_8h-source.html#l00110">SectorAlignN</a>, and <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00230">SectorSize</a>.
<p>
Referenced by <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l03457">UdfRecognizeVolume()</a>.
<p>
<pre class="fragment"><div>00955 {
00956     <span class="keywordflow">return</span> (ULONG)<a class="code" href="../../d2/d1/mm_8h.html#a4">ROUND_TO_PAGES</a>( <a class="code" href="../../d5/d8/udfs__rec_8h.html#a11">SectorAlignN</a>( SectorSize, StructureSize ));
00957 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a164" doxytag="udfprocs.h::UdfRawReadSize" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> INLINE ULONG UdfRawReadSize           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d5/struct__VCB.html">PVCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Vcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>StructureSize</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00941">941</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.
<p>
References <a class="el" href="../../d4/d7/fsrtlp_8h-source.html#l00212">SectorAlign</a>.
<p>
Referenced by <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l03307">UdfFindAnchorVolumeDescriptor()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l02558">UdfFindFileSetDescriptor()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l02832">UdfFindVolumeDescriptors()</a>, and <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l00477">UdfUpdateVcbPhase0()</a>.
<p>
<pre class="fragment"><div>00945 {
00946     <span class="keywordflow">return</span> <a class="code" href="../../d3/d8/fsrtlp_8h.html#a12">SectorAlign</a>( Vcb, StructureSize );
00947 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a166" doxytag="udfprocs.h::UdfRawReadSizeN" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> INLINE ULONG UdfRawReadSizeN           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>SectorSize</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>StructureSize</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00961">961</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.
<p>
References <a class="el" href="../../d6/d7/udfs__rec_8h-source.html#l00110">SectorAlignN</a>, and <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00230">SectorSize</a>.
<p>
Referenced by <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l03457">UdfRecognizeVolume()</a>.
<p>
<pre class="fragment"><div>00965 {
00966     <span class="keywordflow">return</span> <a class="code" href="../../d5/d8/udfs__rec_8h.html#a11">SectorAlignN</a>( SectorSize, StructureSize );
00967 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a160" doxytag="udfprocs.h::UdfReadSectors" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS UdfReadSectors           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN LONGLONG&nbsp;</td>
          <td class="mdname" nowrap> <em>StartingOffset</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ByteCount</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>ReturnError</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PVOID&nbsp;</td>
          <td class="mdname" nowrap> <em>Buffer</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>TargetDeviceObject</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d6/deviosup_8c-source.html#l00685">685</a> of file <a class="el" href="../../d4/d6/deviosup_8c-source.html">deviosup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d1/rtqkey_8c-source.html#l00042">Buffer</a>, <a class="el" href="../../d4/d7/fsrtlp_8h-source.html#l00231">BytesFromSectors</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d9/d8/client_2ntstubs_8c-source.html#l00086">Event()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d1/d8/fsrtl_8h.html#a145">FsRtlLookupLargeMcbEntry()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l01933">IoBuildSynchronousFsdRequest()</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02865">IoCallDriver</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03398">IoGetNextIrpStackLocation</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l00058">IRP_MJ_READ</a>, <a class="el" href="../../d5/d8/ke_8h-source.html#l01066">KeInitializeEvent</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00224">LlSectorsFromBytes</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00230">SectorSize</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00505">SetFlag</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01874">SL_OVERRIDE_VERIFY_VOLUME</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d0/d7/udf_8h-source.html#l00181">UdfMethod2TransformByteOffset</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00418">UdfNormalizeAndRaiseStatus()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00406">UdfRaiseStatus()</a>, and <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00686">VCB_STATE_METHOD_2_FIXUP</a>.
<p>
Referenced by <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l03307">UdfFindAnchorVolumeDescriptor()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l02558">UdfFindFileSetDescriptor()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l02832">UdfFindVolumeDescriptors()</a>, <a class="el" href="../../d3/d5/allocsup_8c-source.html#l01406">UdfLoadSparingTables()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l03457">UdfRecognizeVolume()</a>, and <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l00477">UdfUpdateVcbPhase0()</a>.
<p>
<pre class="fragment"><div>00696                    :
00697 
00698     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called to transfer sectors from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> disk to a
00699     specified buffer.  It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used <span class="keywordflow">for</span> mount and volume verify operations.
00700 
00701     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> synchronous, <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> will not <span class="keywordflow">return</span> until <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation
00702     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> complete or until <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation fails.
00703 
00704     The routine allocates an <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> and then passes <span class="keyword">this</span> <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> to a lower
00705     level driver.  Errors may occur in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> allocation of <span class="keyword">this</span> <a class="code" href="../../d0/d2/struct__IRP.html">IRP</a> or
00706     in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> lower driver.
00707 
00708 Arguments:
00709 
00710     StartingOffset - Logical offset on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> disk to start <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> read.  This
00711         must be on a sector boundary, no check <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a> here.
00712 
00713     ByteCount - Number of bytes to read.  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> an integral number of
00714         sectors, or otherwise a value we know <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> driver can handle,
00715         no check <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d3/d0/user32_8def.html#a107">made</a> here to confirm <span class="keyword">this</span>.
00716 
00717     ReturnError - Indicates whether we should <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> or <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>
00718         to indicate an error or raise an error condition.  This <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> applies
00719         to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> result of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> IO.  Any other error may cause a raise.
00720 
00721     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> - <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> to transfer <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> disk data into.
00722 
00723     TargetDeviceObject - The device object <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> volume to be read.
00724 
00725 Return Value:
00726 
00727     The <span class="keyword">final</span> status of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation.
00728 
00729 --*/
00730 
00731 {
00732     PLONGLONG UseStartingOffset;
00733     LONGLONG LocalStartingOffset;
00734     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00735     <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a>  <a class="code" href="../../d8/d9/client_2ntstubs_8c.html#a5">Event</a>;
00736     <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>;
00737 
00738     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00739 
00740     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( +1, Dbg,
00741                  <span class="stringliteral">"UdfReadSectors, %x%08x +%x -&gt; %08x from DO %08x\n"</span>,
00742                  ((PLARGE_INTEGER)&amp;StartingOffset)-&gt;HighPart,
00743                  ((PLARGE_INTEGER)&amp;StartingOffset)-&gt;LowPart,
00744                  ByteCount,
00745                  Buffer,
00746                  TargetDeviceObject ));
00747     
00748     <span class="comment">//</span>
00749     <span class="comment">//  For the time being, we assume that we only read sector-at-a-time.</span>
00750     <span class="comment">//  This simplifies sparing, and is the only way I am aware of this</span>
00751     <span class="comment">//  code would not be ready for blocksize != sectorsize.  It just is</span>
00752     <span class="comment">//  not worth writing dead (but straightforward) code right now.</span>
00753     <span class="comment">//</span>
00754 
00755     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( IrpContext-&gt;Vcb == NULL || ByteCount == <a class="code" href="../../d3/d8/udfprocs_8h.html#a42">SectorSize</a>( IrpContext-&gt;Vcb ));
00756 
00757     <span class="comment">//</span>
00758     <span class="comment">//  If the volume is spared (and at a point where sparing is possible),</span>
00759     <span class="comment">//  check if a mapping needs to be performed.</span>
00760     <span class="comment">//</span>
00761     
00762     <span class="keywordflow">if</span> (IrpContext-&gt;Vcb &amp;&amp;
00763         IrpContext-&gt;Vcb-&gt;Pcb &amp;&amp;
00764         IrpContext-&gt;Vcb-&gt;Pcb-&gt;SparingMcb) {
00765         
00766         LONGLONG SparingPsn;
00767     
00768         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d8/fsrtl_8h.html#a145">FsRtlLookupLargeMcbEntry</a>( IrpContext-&gt;Vcb-&gt;Pcb-&gt;SparingMcb,
00769                                       <a class="code" href="../../d3/d8/udfprocs_8h.html#a40">LlSectorsFromBytes</a>( IrpContext-&gt;Vcb, StartingOffset ),
00770                                       &amp;SparingPsn,
00771                                       NULL,
00772                                       NULL,
00773                                       NULL,
00774                                       NULL ) &amp;&amp;
00775             SparingPsn != -1) {
00776 
00777             StartingOffset = <a class="code" href="../../d3/d8/fsrtlp_8h.html#a14">BytesFromSectors</a>( IrpContext-&gt;Vcb, (ULONG) SparingPsn );
00778         }
00779     }
00780     
00781     <span class="comment">//</span>
00782     <span class="comment">//  Initialize the event.</span>
00783     <span class="comment">//</span>
00784 
00785     <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a>( &amp;Event, NotificationEvent, FALSE );
00786 
00787     <span class="comment">//</span>
00788     <span class="comment">//  Correct the starting offset by the method 2 fixup if neccesary.  This also</span>
00789     <span class="comment">//  assumes sector-at-a-time and sector == block so we don't need to fragment</span>
00790     <span class="comment">//  the request or check if it spans a packet boundary.</span>
00791     <span class="comment">//</span>
00792     <span class="comment">//  We assume that no fixups are required until a Vcb exists.  This is true</span>
00793     <span class="comment">//  since volume recognition may proceed in the first packet.</span>
00794     <span class="comment">//</span>
00795 
00796     UseStartingOffset = &amp;StartingOffset;
00797 
00798     <span class="keywordflow">if</span> (IrpContext-&gt;Vcb &amp;&amp;
00799         <a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpContext-&gt;Vcb-&gt;VcbState, VCB_STATE_METHOD_2_FIXUP )) {
00800 
00801         LocalStartingOffset = <a class="code" href="../../d9/d7/udf_8h.html#a8">UdfMethod2TransformByteOffset</a>( IrpContext-&gt;Vcb, StartingOffset );
00802         UseStartingOffset = &amp;LocalStartingOffset;
00803 
00804         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( 0, Dbg,
00805                      <span class="stringliteral">"UdfReadSectors, Method2 Fixup to %x%08x\n"</span>,
00806                      ((PLARGE_INTEGER)UseStartingOffset)-&gt;HighPart,
00807                      ((PLARGE_INTEGER)UseStartingOffset)-&gt;LowPart ));
00808     }
00809 
00810     <span class="comment">//</span>
00811     <span class="comment">//  Attempt to allocate the IRP.  If unsuccessful, raise</span>
00812     <span class="comment">//  STATUS_INSUFFICIENT_RESOURCES.</span>
00813     <span class="comment">//</span>
00814 
00815     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> = <a class="code" href="../../d4/d6/iosubs_8c.html#a27">IoBuildSynchronousFsdRequest</a>( IRP_MJ_READ,
00816                                         TargetDeviceObject,
00817                                         Buffer,
00818                                         ByteCount,
00819                                         (PLARGE_INTEGER) UseStartingOffset,
00820                                         &amp;Event,
00821                                         &amp;IrpContext-&gt;Irp-&gt;IoStatus );
00822 
00823     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00824 
00825         <a class="code" href="../../d3/d8/udfprocs_8h.html#a122">UdfRaiseStatus</a>( IrpContext, STATUS_INSUFFICIENT_RESOURCES );
00826     }
00827 
00828     <span class="comment">//</span>
00829     <span class="comment">//  Ignore the change line (verify) for mount and verify requests</span>
00830     <span class="comment">//</span>
00831 
00832     <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( <a class="code" href="../../d0/d5/io_8h.html#a230">IoGetNextIrpStackLocation</a>( Irp )-&gt;Flags, SL_OVERRIDE_VERIFY_VOLUME );
00833 
00834     <span class="comment">//</span>
00835     <span class="comment">//  Send the request down to the driver.  If an error occurs return</span>
00836     <span class="comment">//  it to the caller.</span>
00837     <span class="comment">//</span>
00838 
00839     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d5/io_8h.html#a223">IoCallDriver</a>( TargetDeviceObject, Irp );
00840 
00841     <span class="comment">//</span>
00842     <span class="comment">//  If the status was STATUS_PENDING then wait on the event.</span>
00843     <span class="comment">//</span>
00844 
00845     <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_PENDING) {
00846 
00847         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;Event,
00848                                         Executive,
00849                                         KernelMode,
00850                                         FALSE,
00851                                         NULL );
00852 
00853         <span class="comment">//</span>
00854         <span class="comment">//  On a successful wait pull the status out of the IoStatus block.</span>
00855         <span class="comment">//</span>
00856 
00857         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00858 
00859             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = IrpContext-&gt;Irp-&gt;IoStatus.Status;
00860         }
00861     }
00862 
00863     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( -1, Dbg, <span class="stringliteral">"UdfReadSectors -&gt; %08x\n"</span>, Status ));
00864     
00865     <span class="comment">//</span>
00866     <span class="comment">//  Check whether we should raise in the error case.</span>
00867     <span class="comment">//</span>
00868 
00869     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status ) &amp;&amp; !ReturnError) {
00870 
00871         <a class="code" href="../../d3/d8/udfprocs_8h.html#a123">UdfNormalizeAndRaiseStatus</a>( IrpContext, Status );
00872     }
00873 
00874     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00875 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a202" doxytag="udfprocs.h::UdfReleaseForCreateSection" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID UdfReleaseForCreateSection           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>FileObject</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d8/resrcsup_8c-source.html#l00302">302</a> of file <a class="el" href="../../d5/d8/resrcsup_8c-source.html">resrcsup.c</a>.
<p>
References <a class="el" href="../../d6/d7/ex_8h-source.html#l02393">ExReleaseResource</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d3/d7/udfinit_8c-source.html#l00183">UdfInitializeGlobalData()</a>.
<p>
<pre class="fragment"><div>00308                    :
00309 
00310     This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> callback routine <span class="keywordflow">for</span> MM to use to release a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> acquired with
00311     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> AcquireForCreateSection call above.
00312 
00313 Arguments:
00314 
00315     FileObject - <a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a> object <span class="keywordflow">for</span> a Udffs stream.
00316 
00317 Return Value:
00318 
00319     None
00320 
00321 --*/
00322 
00323 {
00324     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00325 
00326     <span class="comment">//</span>
00327     <span class="comment">//  Release the resource in the Fcb.</span>
00328     <span class="comment">//</span>
00329 
00330     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( &amp;((<a class="code" href="../../d7/d9/struct__FCB.html">PFCB</a>) FileObject-&gt;FsContext)-&gt;FcbNonpaged-&gt;FcbResource );
00331 
00332     <span class="keywordflow">return</span>;
00333 }
}
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a200" doxytag="udfprocs.h::UdfReleaseFromCache" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID UdfReleaseFromCache           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d7/d9/struct__FCB.html">PFCB</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Fcb</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d8/resrcsup_8c-source.html#l00172">172</a> of file <a class="el" href="../../d5/d8/resrcsup_8c-source.html">resrcsup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l02393">ExReleaseResource</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l00283">FSRTL_CACHE_TOP_LEVEL_IRP</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l07409">IoGetTopLevelIrp()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l10321">IoSetTopLevelIrp()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d3/d7/udfinit_8c-source.html#l00183">UdfInitializeGlobalData()</a>.
<p>
<pre class="fragment"><div>00178                    :
00179 
00180     The address of <span class="keyword">this</span> routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> specified when creating a CacheMap <span class="keywordflow">for</span>
00181     a <span class="keyword">virtual</span> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.  It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> subsequently called by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Lazy <a class="code" href="../../d4/d0/tex_8c.html#a44">Writer</a> to release
00182     a resource acquired above.
00183 
00184 Arguments:
00185 
00186     Fcb -  The pointer supplied as context to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> cache initialization
00187            routine.
00188 
00189 Return Value:
00190 
00191     None
00192 
00193 --*/
00194 
00195 {
00196     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00197 
00198     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(<a class="code" href="../../d4/d6/iosubs_8c.html#a79">IoGetTopLevelIrp</a>() == (<a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a>)FSRTL_CACHE_TOP_LEVEL_IRP);
00199     <a class="code" href="../../d4/d6/iosubs_8c.html#a109">IoSetTopLevelIrp</a>( NULL );
00200 
00201     <a class="code" href="../../d5/d8/ex_8h.html#a66">ExReleaseResource</a>( Fcb-&gt;Resource );
00202 
00203     <span class="keywordflow">return</span>;
00204 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a195" doxytag="udfprocs.h::UdfRemovePrefix" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID UdfRemovePrefix           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d5/d9/struct__LCB.html">PLCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Lcb</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d3/prefxsup_8c-source.html#l00256">256</a> of file <a class="el" href="../../d6/d3/prefxsup_8c-source.html">prefxsup.c</a>.
<p>
References <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00366">ASSERT_EXCLUSIVE_FCB_OR_VCB</a>, <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00352">ASSERT_IRP_CONTEXT</a>, <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00350">ASSERT_LCB</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d6/d7/ex_8h-source.html#l00947">ExFreeToPagedLookasideList()</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00814">LCB_FLAG_IGNORE_CASE</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00816">LCB_FLAG_POOL_ALLOCATED</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d4/d3/splay_8c-source.html#l00385">RtlDelete()</a>, and <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00196">UdfLcbLookasideList</a>.
<p>
Referenced by <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l01606">UdfTeardownStructures()</a>.
<p>
<pre class="fragment"><div>00263                    :
00264 
00265     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called to remove a given prefix of an Fcb.
00266 
00267 Arguments:
00268 
00269     Lcb - <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> prefix being removed.
00270 
00271 Return Value:
00272 
00273     None
00274 
00275 --*/
00276 
00277 {
00278     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00279 
00280     <span class="comment">//</span>
00281     <span class="comment">//  Check inputs.</span>
00282     <span class="comment">//</span>
00283 
00284     <a class="code" href="../../d1/d8/udfdata_8h.html#a28">ASSERT_IRP_CONTEXT</a>( IrpContext );
00285     <a class="code" href="../../d1/d8/udfdata_8h.html#a26">ASSERT_LCB</a>( Lcb );
00286 
00287     <span class="comment">//</span>
00288     <span class="comment">//  Check the acquisition of the two Fcbs.</span>
00289     <span class="comment">//</span>
00290 
00291     <a class="code" href="../../d1/d8/udfdata_8h.html#a42">ASSERT_EXCLUSIVE_FCB_OR_VCB</a>( Lcb-&gt;ParentFcb );
00292     <a class="code" href="../../d1/d8/udfdata_8h.html#a42">ASSERT_EXCLUSIVE_FCB_OR_VCB</a>( Lcb-&gt;ChildFcb );
00293 
00294     <span class="comment">//</span>
00295     <span class="comment">//  Now remove the linkage and delete the Lcb.</span>
00296     <span class="comment">//</span>
00297     
00298     RemoveEntryList( &amp;Lcb-&gt;ParentFcbLinks );
00299     RemoveEntryList( &amp;Lcb-&gt;ChildFcbLinks );
00300 
00301     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Lcb-&gt;Flags, LCB_FLAG_IGNORE_CASE )) {
00302 
00303         Lcb-&gt;ParentFcb-&gt;IgnoreCaseRoot = <a class="code" href="../../d3/d4/splay_8c.html#a4">RtlDelete</a>( &amp;Lcb-&gt;Links );
00304     
00305     } <span class="keywordflow">else</span> {
00306 
00307         Lcb-&gt;ParentFcb-&gt;ExactCaseRoot = <a class="code" href="../../d3/d4/splay_8c.html#a4">RtlDelete</a>( &amp;Lcb-&gt;Links );
00308     }
00309 
00310     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Lcb-&gt;Flags, LCB_FLAG_POOL_ALLOCATED )) {
00311 
00312         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( Lcb );
00313 
00314     } <span class="keywordflow">else</span> {
00315 
00316         <a class="code" href="../../d5/d8/ex_8h.html#a253">ExFreeToPagedLookasideList</a>( &amp;UdfLcbLookasideList, Lcb );
00317     }
00318     
00319     <span class="keywordflow">return</span>;
00320 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a243" doxytag="udfprocs.h::UdfRemoveVmcbMapping" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID UdfRemoveVmcbMapping           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d7/struct__VMCB.html">PVMCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Vmcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a50">LBN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Lbn</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>SectorCount</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<a class="anchor" name="a183" doxytag="udfprocs.h::UdfRenderNameToLegalUnicode" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID UdfRenderNameToLegalUnicode           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>Name</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>RenderedName</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d6/d4/namesup_8c-source.html#l00927">927</a> of file <a class="el" href="../../d6/d4/namesup_8c-source.html">namesup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d0/d7/udf_8h-source.html#l00223">CRC_LEN</a>, <a class="el" href="../../d0/d7/udf_8h-source.html#l00240">CRC_MARK</a>, <a class="el" href="../../d0/d7/udf_8h-source.html#l00222">EXT_LEN</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d0/d7/udf_8h-source.html#l00241">ILLEGAL_CHAR_MARK</a>, <a class="el" href="../../d0/d7/udf_8h-source.html#l00234">INT16</a>, <a class="el" href="../../d0/d7/udf_8h-source.html#l00230">IsDeviceName</a>, <a class="el" href="../../d0/d7/udf_8h-source.html#l00229">IsFileNameCharLegal</a>, <a class="el" href="../../d0/d7/udf_8h-source.html#l00221">MAX_LEN</a>, <a class="el" href="../../d9/d9/geninst_8c-source.html#l00154">Name</a>, <a class="el" href="../../d0/d7/udf_8h-source.html#l00231">NativeCharLength</a>, <a class="el" href="../../d0/d7/udf_8h-source.html#l00238">PERIOD</a>, <a class="el" href="../../d0/d7/udf_8h-source.html#l00239">SPACE</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d1/d7/udfdata_8c-source.html#l01194">UdfComputeCrc16Uni()</a>, <a class="el" href="../../d6/d4/namesup_8c-source.html#l00039">UdfCrcChar</a>, <a class="el" href="../../d0/d7/udf_8h-source.html#l00235">UINT16</a>, <a class="el" href="../../d0/d7/udf_8h-source.html#l00236">UNICODE_CHAR</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d5/d7/dirsup_8c-source.html#l00360">UdfUpdateDirNames()</a>.
<p>
<pre class="fragment"><div>00935                    :
00936 
00937     This routine will take a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a96">Unicode</a> string containing illegal characters and
00938     run <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> through <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> UDF standard algorithim to render <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> into a <span class="stringliteral">"legal"</span>
00939     name.
00940     
00941     The <span class="keywordtype">short</span> form <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> to convert all runs of illegal characters to <span class="stringliteral">"_"</span> and tack
00942     on a hex representation of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> CRC of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> original name.  The algorithm <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00943     nearly directly lifted from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> UDF (2.01 proposed!) standard, so apologies
00944     for the style clash.
00945     
00946 Arguments:
00947 
00948     Name - the actual name
00949     
00950     RenderedName - the name rendered into legal characters
00951     
00952 Return Value:
00953 
00954     BOOLEAN - TRUE if the expressions match, FALSE otherwise.
00955 
00956 --*/
00957 
00958 {
00959     <a class="code" href="../../d9/d7/udf_8h.html#a23">INT16</a> index;
00960     <a class="code" href="../../d9/d7/udf_8h.html#a23">INT16</a> targetIndex;
00961     <a class="code" href="../../d9/d7/udf_8h.html#a23">INT16</a> crcIndex;
00962     <a class="code" href="../../d9/d7/udf_8h.html#a23">INT16</a> extLen;
00963     <a class="code" href="../../d9/d7/udf_8h.html#a23">INT16</a> nameLen;
00964     <a class="code" href="../../d9/d7/udf_8h.html#a23">INT16</a> charLen;
00965     <a class="code" href="../../d9/d7/udf_8h.html#a23">INT16</a> overlayBytes;
00966     <a class="code" href="../../d9/d7/udf_8h.html#a23">INT16</a> bytesLeft;
00967     <a class="code" href="../../d9/d7/udf_8h.html#a25">UNICODE_CHAR</a> current;
00968     BOOLEAN needsCRC;
00969     BOOLEAN foundDot;
00970     <a class="code" href="../../d9/d7/udf_8h.html#a25">UNICODE_CHAR</a> ext[<a class="code" href="../../d9/d7/udf_8h.html#a14">EXT_LEN</a>];
00971 
00972     <span class="comment">//</span>
00973     <span class="comment">//  So as to lift as directly as possible from the standard, chunk things around.</span>
00974     <span class="comment">//</span>
00975  
00976     PWCHAR newName = RenderedName-&gt;Buffer;
00977     PWCHAR udfName = <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Buffer;
00978     LONG udfNameLen = <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a>-&gt;Length / <span class="keyword">sizeof</span>(WCHAR);
00979 
00980     <span class="comment">/* Remove trailing periods ('.') and spaces (' '), Windows     */</span>
00981     <span class="comment">/* does not like them.                                         */</span>
00982     foundDot = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00983     index = udfNameLen;
00984     <span class="keywordflow">while</span> (index-- &gt; 0) {
00985         <span class="keywordflow">if</span> (udfName[index] == <a class="code" href="../../d9/d7/udf_8h.html#a26">PERIOD</a>)
00986             foundDot = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00987         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (udfName[index] != <a class="code" href="../../d9/d7/udf_8h.html#a27">SPACE</a>)
00988             <span class="keywordflow">break</span>;
00989     }
00990 
00991     <span class="comment">/* If any trailing periods or spaces were found, a CRC code    */</span>
00992     <span class="comment">/* needs to be added to the resulting file name.               */</span>
00993     nameLen = index + 1;
00994     <span class="keywordflow">if</span> (nameLen &lt; udfNameLen)
00995         needsCRC = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00996 
00997     needsCRC = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00998     bytesLeft = <a class="code" href="../../d9/d7/udf_8h.html#a13">MAX_LEN</a>;
00999     extLen = 0;
01000 
01001     <span class="keywordflow">if</span> (needsCRC == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> || foundDot == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
01002         <span class="comment">/* Look for an extension in the file name.  We do not      */</span>
01003         <span class="comment">/* need to look for one if there were any trailing periods */</span>
01004         <span class="comment">/* removed.                                                */</span>
01005         <a class="code" href="../../d9/d7/udf_8h.html#a23">INT16</a> endIndex;
01006         <a class="code" href="../../d9/d7/udf_8h.html#a23">INT16</a> prevCharLen = 1;
01007         <a class="code" href="../../d9/d7/udf_8h.html#a23">INT16</a> extBytes = 0;
01008 
01009         targetIndex = 0;
01010         index = nameLen;
01011 
01012         <span class="comment">/* Determine how many bytes we need to scan to find the    */</span>
01013         <span class="comment">/* extension delimiter.  The extension has a maximum of    */</span>
01014         <span class="comment">/* five characters, but we do not want to scan past the    */</span>
01015         <span class="comment">/* beginning of the buffer.                                */</span>
01016         endIndex = (udfNameLen &gt; <a class="code" href="../../d9/d7/udf_8h.html#a14">EXT_LEN</a> + 1) ?
01017             udfNameLen - <a class="code" href="../../d9/d7/udf_8h.html#a14">EXT_LEN</a> - 1 : 1;
01018 
01019         <span class="comment">/* Start at the end of the name and scan backward, looking */</span>
01020         <span class="comment">/* for the extension delimiter (".").                      */</span>
01021         <span class="keywordflow">while</span> (index-- &gt; endIndex) {
01022             <span class="comment">/* Get the character to test.                          */</span>
01023             current = udfName[index];
01024 
01025             <span class="keywordflow">if</span> (current == <span class="charliteral">'.'</span>) {
01026                 <span class="comment">/* The extension delimiter was found, figure out   */</span>
01027                 <span class="comment">/* how many characters the extension contains and  */</span>
01028                 <span class="comment">/* the length of the resulting file name without   */</span>
01029                 <span class="comment">/* the extension.                                  */</span>
01030                 extLen = nameLen - index - 1;
01031                 nameLen = index;
01032                 <span class="keywordflow">break</span>;
01033             }
01034 
01035             <span class="comment">/* Determine the byte length of the current character  */</span>
01036             <span class="comment">/* when converted to native format.                    */</span>
01037             charLen = (<a class="code" href="../../d9/d7/udf_8h.html#a19">IsFileNameCharLegal</a>(current)) ?
01038                 <a class="code" href="../../d9/d7/udf_8h.html#a21">NativeCharLength</a>(current) : 0;
01039 
01040             <span class="keywordflow">if</span> (charLen == 0) {
01041                 <span class="comment">/* If the character byte length is zero, it is     */</span>
01042                 <span class="comment">/* illegal or unprintable, place an underscore     */</span>
01043                 <span class="comment">/* ("_") in the extension buffer if the previous   */</span>
01044                 <span class="comment">/* character tested was legal.  Not that the       */</span>
01045                 <span class="comment">/* characters placed in the extension buffer are   */</span>
01046                 <span class="comment">/* in reverse order.                               */</span>
01047                 <span class="keywordflow">if</span> (prevCharLen != 0) {
01048                     ext[targetIndex++] = <a class="code" href="../../d9/d7/udf_8h.html#a29">ILLEGAL_CHAR_MARK</a>;
01049                     extBytes++;
01050                 }
01051             }
01052             <span class="keywordflow">else</span> {
01053                 <span class="comment">/* The current character is legal and printable,   */</span>
01054                 <span class="comment">/* put it in the extension buffer.  Note that the  */</span>
01055                 <span class="comment">/* characters placed in the extension buffer are   */</span>
01056                 <span class="comment">/* in reverse order.                               */</span>
01057                 ext[targetIndex++] = current;
01058                 extBytes += charLen;
01059             }
01060 
01061             <span class="comment">/* Save the byte length of the current character, so   */</span>
01062             <span class="comment">/* we can determine if it was a legal character during */</span>
01063             <span class="comment">/* the next test.                                      */</span>
01064             prevCharLen = charLen;
01065         }
01066 
01067         <span class="comment">/* If an extension was found, determine how many bytes     */</span>
01068         <span class="comment">/* remain in the file name buffer once we account for it.  */</span>
01069         <span class="keywordflow">if</span> (extLen &gt; 0)
01070             bytesLeft -= extBytes + 1;
01071     }
01072 
01073     index = 0;
01074     targetIndex = 0;
01075     crcIndex = 0;
01076     overlayBytes = -1;
01077     <span class="keywordflow">while</span> (index &lt; nameLen &amp;&amp; bytesLeft &gt; 0) {
01078         <span class="comment">/* Get the current character and convert it to upper case. */</span>
01079         current = udfName[index];
01080 
01081         <span class="comment">/* Determine if this is a valid file name char and         */</span>
01082         <span class="comment">/* calculate its corresponding native character byte       */</span>
01083         <span class="comment">/* length (zero if the char is not legal or undiplayable   */</span>
01084         <span class="comment">/* on this system).                                        */</span>
01085         charLen = (<a class="code" href="../../d9/d7/udf_8h.html#a19">IsFileNameCharLegal</a>(current)) ?
01086             <a class="code" href="../../d9/d7/udf_8h.html#a21">NativeCharLength</a>(current) : 0;
01087 
01088         <span class="comment">/* If the char is larger than the available space in the   */</span>
01089         <span class="comment">/* buffer, pretend it is undisplayable.                    */</span>
01090         <span class="keywordflow">if</span> (charLen &gt; bytesLeft)
01091             charLen = 0;
01092 
01093         <span class="keywordflow">if</span> (charLen == 0) {
01094             <span class="comment">/* Undisplayable or illegal characters are substituted */</span>
01095             <span class="comment">/* with an underscore ("_"), and requires a CRC code   */</span>
01096             <span class="comment">/* appended to the mangled file name.                  */</span>
01097             needsCRC = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01098             charLen = 1;
01099             current = <span class="charliteral">'_'</span>;
01100 
01101             <span class="comment">/* Skip over any following undiplayable or illegal     */</span>
01102             <span class="comment">/* chars.                                              */</span>
01103             <span class="keywordflow">while</span> (index + 1 &lt; udfNameLen &amp;&amp;
01104                 (!<a class="code" href="../../d9/d7/udf_8h.html#a19">IsFileNameCharLegal</a>(udfName[index + 1]) ||
01105                 <a class="code" href="../../d9/d7/udf_8h.html#a21">NativeCharLength</a>(udfName[index + 1]) == 0))
01106                 index++;
01107 
01108             <span class="comment">/* Terminate loop if at the end of the file name.      */</span>
01109             <span class="keywordflow">if</span> (index &gt;= udfNameLen)
01110                 <span class="keywordflow">break</span>;
01111         }
01112 
01113         <span class="comment">/* Assign the resulting char to the next index in the file */</span>
01114         <span class="comment">/* name buffer and determine how many native bytes are     */</span>
01115         <span class="comment">/* left.                                                   */</span>
01116         newName[targetIndex++] = current;
01117         bytesLeft -= charLen;
01118 
01119         <span class="comment">/* This figures out where the CRC code needs to start in   */</span>
01120         <span class="comment">/* the file name buffer.                                   */</span>
01121         <span class="keywordflow">if</span> (bytesLeft &gt;= <a class="code" href="../../d9/d7/udf_8h.html#a15">CRC_LEN</a>) {
01122             <span class="comment">/* If there is enough space left, just tack it onto    */</span>
01123             <span class="comment">/* the end.                                            */</span>
01124             crcIndex = targetIndex;
01125         }
01126         <span class="keywordflow">else</span> {
01127             <span class="comment">/* If there is not enough space left, the CRC must     */</span>
01128             <span class="comment">/* overlay a character already in the file name        */</span>
01129             <span class="comment">/* buffer.  Once this condition has been met, the      */</span>
01130             <span class="comment">/* value will not change.                              */</span>
01131             <span class="keywordflow">if</span> (overlayBytes &lt; 0) {
01132                 <span class="comment">/* Determine the index and save the length of the  */</span>
01133                 <span class="comment">/* native character that is overlayed.  It is      */</span>
01134                 <span class="comment">/* possible that the CRC might overlay half of a   */</span>
01135                 <span class="comment">/* two-byte native character depending upon how    */</span>
01136                 <span class="comment">/* the character boundaries line up.               */</span>
01137                 overlayBytes = (bytesLeft + charLen &gt; <a class="code" href="../../d9/d7/udf_8h.html#a15">CRC_LEN</a>)
01138                     ? 1 : 0;
01139                 crcIndex = targetIndex - 1;
01140             }
01141         }
01142 
01143         <span class="comment">/* Advance to the next character.                          */</span>
01144         index++;
01145     }
01146 
01147     <span class="comment">/* If the scan did not reach the end of the file name, or the  */</span>
01148     <span class="comment">/* length of the file name is zero, a CRC code is needed.      */</span>
01149     <span class="keywordflow">if</span> (index &lt; nameLen || index == 0)
01150         needsCRC = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01151 
01152     <span class="comment">/* If the name has illegal characters or and extension, it     */</span>
01153     <span class="comment">/* is not a DOS device name.                                   */</span>
01154     <span class="keywordflow">if</span> (needsCRC == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> &amp;&amp; extLen == 0) {
01155         <span class="comment">/* If this is the name of a DOS device, a CRC code should  */</span>
01156         <span class="comment">/* be appended to the file name.                           */</span>
01157         <span class="keywordflow">if</span> (<a class="code" href="../../d9/d7/udf_8h.html#a20">IsDeviceName</a>(udfName, udfNameLen))
01158             needsCRC = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01159     }
01160 
01161     <span class="comment">/* Append the CRC code to the file name, if needed.            */</span>
01162     <span class="keywordflow">if</span> (needsCRC) {
01163         <span class="comment">/* Get the CRC value for the original Unicode string       */</span>
01164         <a class="code" href="../../d9/d7/udf_8h.html#a24">UINT16</a> udfCRCValue = <a class="code" href="../../d3/d8/udfprocs_8h.html#a135">UdfComputeCrc16Uni</a>(udfName, udfNameLen);
01165 
01166         <span class="comment">/* Determine the character index where the CRC should      */</span>
01167         <span class="comment">/* begin.                                                  */</span>
01168         targetIndex = crcIndex;
01169 
01170         <span class="comment">/* If the character being overlayed is a two-byte native   */</span>
01171         <span class="comment">/* character, replace the first byte with an underscore.   */</span>
01172         <span class="keywordflow">if</span> (overlayBytes &gt; 0)
01173             newName[targetIndex++] = <a class="code" href="../../d9/d7/udf_8h.html#a29">ILLEGAL_CHAR_MARK</a>;
01174 
01175         <span class="comment">/* Append the encoded CRC value with delimiter.            */</span>
01176         newName[targetIndex++] = <a class="code" href="../../d9/d7/udf_8h.html#a28">CRC_MARK</a>;
01177         newName[targetIndex++] = <a class="code" href="../../d5/d5/namesup_8c.html#a2">UdfCrcChar</a>[(udfCRCValue &amp; 0xf000) &gt;&gt; 12];
01178         newName[targetIndex++] = <a class="code" href="../../d5/d5/namesup_8c.html#a2">UdfCrcChar</a>[(udfCRCValue &amp; 0x0f00) &gt;&gt; 8];
01179         newName[targetIndex++] = <a class="code" href="../../d5/d5/namesup_8c.html#a2">UdfCrcChar</a>[(udfCRCValue &amp; 0x00f0) &gt;&gt; 4];
01180         newName[targetIndex++] = <a class="code" href="../../d5/d5/namesup_8c.html#a2">UdfCrcChar</a>[(udfCRCValue &amp; 0x000f)];
01181     }
01182 
01183 
01184     <span class="comment">/* If an extension was found, append it here.                  */</span>
01185     <span class="keywordflow">if</span> (extLen &gt; 0) {
01186         <span class="comment">/* Add the period ('.') for the extension delimiter.       */</span>
01187         newName[targetIndex++] = <a class="code" href="../../d9/d7/udf_8h.html#a26">PERIOD</a>;
01188 
01189         <span class="comment">/* Append the characters in the extension buffer.  They    */</span>
01190         <span class="comment">/* were stored in reverse order, so we need to begin with  */</span>
01191         <span class="comment">/* the last character and work forward.                    */</span>
01192         <span class="keywordflow">while</span> (extLen-- &gt; 0)
01193             newName[targetIndex++] = ext[extLen];
01194     }
01195 
01196     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( (targetIndex * <span class="keyword">sizeof</span>(WCHAR)) &lt;= RenderedName-&gt;MaximumLength );
01197  
01198     RenderedName-&gt;Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) (targetIndex * <span class="keyword">sizeof</span>(WCHAR));
01199 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a238" doxytag="udfprocs.h::UdfResetVmcb" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID UdfResetVmcb           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d7/struct__VMCB.html">PVMCB</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Vmcb</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d5/vmcbsup_8c-source.html#l00370">370</a> of file <a class="el" href="../../d7/d5/vmcbsup_8c-source.html">vmcbsup.c</a>.
<p>
References <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00922">FsRtlResetLargeMcb()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01140">PLARGE_MCB</a>, and <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>.
<p>
Referenced by <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l00477">UdfUpdateVcbPhase0()</a>.
<p>
<pre class="fragment"><div>00376                    :
00377 
00378     This routine resets <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> mappings in an existing <a class="code" href="../../d1/d7/struct__VMCB.html">VMCB</a> structure.
00379 
00380 Arguments:
00381 
00382     Vmcb - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d1/d7/struct__VMCB.html">VMCB</a> structure to reset.
00383 
00384 Return Value:
00385 
00386     None.
00387 
00388 --*/
00389 
00390 {
00391     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00392 
00393     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( +1, Dbg, <span class="stringliteral">"UdfResetVmcb, Vmcb = %08x\n"</span>, Vmcb ));
00394 
00395     <span class="comment">//</span>
00396     <span class="comment">//  Unitialize the fields in the Vmcb structure</span>
00397     <span class="comment">//</span>
00398 
00399     <a class="code" href="../../d1/d8/fsrtl_8h.html#a141">FsRtlResetLargeMcb</a>( (<a class="code" href="../../d0/d9/struct__LARGE__MCB.html">PLARGE_MCB</a>) &amp;Vmcb-&gt;VbnIndexed, TRUE );
00400     <a class="code" href="../../d1/d8/fsrtl_8h.html#a141">FsRtlResetLargeMcb</a>( (<a class="code" href="../../d0/d9/struct__LARGE__MCB.html">PLARGE_MCB</a>) &amp;Vmcb-&gt;LbnIndexed, TRUE );
00401 
00402     <span class="comment">//</span>
00403     <span class="comment">//  And return to our caller</span>
00404     <span class="comment">//</span>
00405 
00406     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( -1, Dbg, <span class="stringliteral">"UdfResetVmcb -&gt; VOID\n"</span> ));
00407 
00408     <span class="keywordflow">return</span>;
00409 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a131" doxytag="udfprocs.h::UdfRestoreThreadContext" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> INLINE VOID UdfRestoreThreadContext           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>IrpContext</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00543">543</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.
<p>
References <a class="el" href="../../d5/d5/iosubs_8c-source.html#l10321">IoSetTopLevelIrp()</a>, and <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>.
<p>
Referenced by <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l01437">UdfCleanupIrpContext()</a>.
<p>
<pre class="fragment"><div>00546 {
00547     IrpContext-&gt;ThreadContext-&gt;Udfs = 0;
00548     <a class="code" href="../../d4/d6/iosubs_8c.html#a109">IoSetTopLevelIrp</a>( IrpContext-&gt;ThreadContext-&gt;SavedTopLevelIrp );
00549     IrpContext-&gt;ThreadContext = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00550 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a132" doxytag="udfprocs.h::UdfSerial32" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> ULONG UdfSerial32           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN PCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>Buffer</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>ByteCount</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d7/udfdata_8c-source.html#l01022">1022</a> of file <a class="el" href="../../d1/d7/udfdata_8c-source.html">udfdata.c</a>.
<p>
References <a class="el" href="../../d7/d1/rtqkey_8c-source.html#l00042">Buffer</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, and <a class="el" href="../../d3/d4/mapper_8c-source.html#l00206">SerialId</a>.
<p>
Referenced by <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l04165">UdfUpdateVolumeSerialNumber()</a>.
<p>
<pre class="fragment"><div>01029                    :
01030 
01031     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called to generate a 32 bit serial number.  This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
01032     done by doing four separate checksums into an array of bytes and
01033     then treating <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> bytes as a ULONG.
01034 
01035 Arguments:
01036 
01037     <a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a> - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer to generate <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d4/d9/smbtrsup_8c.html#a7">ID</a> <span class="keywordflow">for</span>.
01038 
01039     ByteCount - Number of bytes in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer.
01040 
01041 Return Value:
01042 
01043     ULONG - The 32 bit serial number.
01044 
01045 --*/
01046 
01047 {
01048     <span class="keyword">union </span>{
01049         UCHAR   Bytes[4];
01050         ULONG   <a class="code" href="../../d2/d5/mapper_8c.html#a30">SerialId</a>;
01051     } Checksum;
01052 
01053     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01054 
01055     <span class="comment">//</span>
01056     <span class="comment">//  Initialize the serial number.</span>
01057     <span class="comment">//</span>
01058 
01059     Checksum.SerialId = 0;
01060 
01061     <span class="comment">//</span>
01062     <span class="comment">//  Continue while there are more bytes to use.</span>
01063     <span class="comment">//</span>
01064 
01065     <span class="keywordflow">while</span> (ByteCount--) {
01066 
01067         <span class="comment">//</span>
01068         <span class="comment">//  Increment this sub-checksum.</span>
01069         <span class="comment">//</span>
01070 
01071         Checksum.Bytes[ByteCount &amp; 0x3] += *(<a class="code" href="../../d6/d2/rtqkey_8c.html#a3">Buffer</a>++);
01072     }
01073 
01074     <span class="comment">//</span>
01075     <span class="comment">//  Return the checksums as a ULONG.</span>
01076     <span class="comment">//</span>
01077 
01078     <span class="keywordflow">return</span> Checksum.SerialId;
01079 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a173" doxytag="udfprocs.h::UdfSetFileObject" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID UdfSetFileObject           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>FileObject</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d3/d8/udfprocs_8h.html#a109">TYPE_OF_OPEN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>TypeOfOpen</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d7/d9/struct__FCB.html">PFCB</a> Fcb&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d9/struct__CCB.html">PCCB</a> Ccb&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d2/filobsup_8c-source.html#l00049">49</a> of file <a class="el" href="../../d7/d2/filobsup_8c-source.html">filobsup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00147">ASSERTMSG</a>, <a class="el" href="../../d3/d8/udfprocs_8h.html#a263a118">BeyondValidType</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00505">SetFlag</a>, <a class="el" href="../../d7/d2/filobsup_8c-source.html#l00039">TYPE_OF_OPEN_MASK</a>, and <a class="el" href="../../d3/d8/udfprocs_8h.html#a263a113">UnopenedFileObject</a>.
<p>
Referenced by <a class="el" href="../../d4/d7/udfs_2create_8c-source.html#l01955">UdfCompleteFcbOpen()</a>, and <a class="el" href="../../d9/d1/udfs_2cachesup_8c-source.html#l00046">UdfCreateInternalStream()</a>.
<p>
<pre class="fragment"><div>00059                    :
00060 
00061     This routine will initialize <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> FileObject context fields based on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00062     input <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> and data structures.
00063 
00064 Arguments:
00065 
00066     FileObject - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object pointer being initialized.
00067 
00068     TypeOfOpen - Sets <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of open.
00069 
00070     Fcb - Fcb <span class="keywordflow">for</span> <span class="keyword">this</span> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object.  Ignored <span class="keywordflow">for</span> <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a113">UnopenedFileObject</a>.
00071 
00072     Ccb - Ccb <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle corresponding to <span class="keyword">this</span> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object.  Will not
00073         be present <span class="keywordflow">for</span> stream <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> objects.
00074 
00075 Return Value:
00076 
00077     None.
00078 
00079 --*/
00080 
00081 {
00082     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00083 
00084     <span class="comment">//</span>
00085     <span class="comment">//  We only have values 0 to 7 available so make sure we didn't</span>
00086     <span class="comment">//  inadvertantly add a new type.</span>
00087     <span class="comment">//</span>
00088 
00089     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a8">ASSERTMSG</a>( <span class="stringliteral">"FileObject types exceed available bits\n"</span>, BeyondValidType &lt;= 8 );
00090 
00091     <span class="comment">//</span>
00092     <span class="comment">//  Setting a file object to type UnopenedFileObject means just</span>
00093     <span class="comment">//  clearing all of the context fields.  All the other input</span>
00094     <span class="comment">//</span>
00095 
00096     <span class="keywordflow">if</span> (TypeOfOpen == <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a113">UnopenedFileObject</a>) {
00097 
00098         FileObject-&gt;FsContext =
00099         FileObject-&gt;FsContext2 = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00100 
00101         <span class="keywordflow">return</span>;
00102     }
00103 
00104     <span class="comment">//</span>
00105     <span class="comment">//  Check that the 3 low-order bits of the Ccb are clear.</span>
00106     <span class="comment">//</span>
00107 
00108     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a8">ASSERTMSG</a>( <span class="stringliteral">"Ccb is not quad-aligned\n"</span>, !<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( ((ULONG_PTR) Ccb), TYPE_OF_OPEN_MASK ));
00109 
00110     <span class="comment">//</span>
00111     <span class="comment">//  We will or the type of open into the low order bits of FsContext2</span>
00112     <span class="comment">//  along with the Ccb value.</span>
00113     <span class="comment">//  The Fcb is stored into the FsContext field.</span>
00114     <span class="comment">//</span>
00115 
00116     FileObject-&gt;FsContext = Fcb;
00117     FileObject-&gt;FsContext2 = Ccb;
00118 
00119     <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( ((ULONG_PTR) FileObject-&gt;FsContext2), TypeOfOpen );
00120 
00121     <span class="comment">//</span>
00122     <span class="comment">//  Set the Vpb field in the file object.</span>
00123     <span class="comment">//</span>
00124 
00125     FileObject-&gt;Vpb = Fcb-&gt;Vcb-&gt;Vpb;
00126 
00127     <span class="keywordflow">return</span>;
00128 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a239" doxytag="udfprocs.h::UdfSetMaximumLbnVmcb" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID UdfSetMaximumLbnVmcb           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d7/struct__VMCB.html">PVMCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Vmcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>MaximumLbn</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d5/vmcbsup_8c-source.html#l00413">413</a> of file <a class="el" href="../../d7/d5/vmcbsup_8c-source.html">vmcbsup.c</a>.
<p>
References <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
<pre class="fragment"><div>00420                    :
00421 
00422     This routine sets/resets <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> maximum allowed <a class="code" href="../../d1/d8/fsrtl_8h.html#a50">LBN</a> <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> specified
00423     Vmcb structure.  The Vmcb structure must already have been initialized
00424     by calling <a class="code" href="../../d3/d8/udfprocs_8h.html#a236">UdfInitializeVmcb</a>.
00425 
00426 Arguments:
00427 
00428     Vmcb - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> volume <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> structure to initialize.
00429 
00430     MaximumLbn - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> maximum Lbn value that <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> valid <span class="keywordflow">for</span> <span class="keyword">this</span>
00431         volume.
00432 
00433 Return Value:
00434 
00435     None
00436 
00437 --*/
00438 
00439 {
00440     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00441 
00442     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( +1, Dbg, <span class="stringliteral">"UdfSetMaximumLbnVmcb, Vmcb = %08x\n"</span>, Vmcb ));
00443 
00444     <span class="comment">//</span>
00445     <span class="comment">//  Set the field</span>
00446     <span class="comment">//</span>
00447 
00448     Vmcb-&gt;MaximumLbn = MaximumLbn;
00449 
00450     <span class="comment">//</span>
00451     <span class="comment">//  And return to our caller</span>
00452     <span class="comment">//</span>
00453 
00454     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( -1, Dbg, <span class="stringliteral">"UdfSetMaximumLbnVmcb -&gt; VOID\n"</span> ));
00455 
00456     <span class="keywordflow">return</span>;
00457 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a130" doxytag="udfprocs.h::UdfSetThreadContext" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID UdfSetThreadContext           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d1/struct__THREAD__CONTEXT.html">PTHREAD_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>ThreadContext</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00873">873</a> of file <a class="el" href="../../d1/d7/udfdata_8c-source.html">udfdata.c</a>.
<p>
References <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00352">ASSERT_IRP_CONTEXT</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d0/d5/io_8h.html#a508">IoGetStackLimits()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l07409">IoGetTopLevelIrp()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l10321">IoSetTopLevelIrp()</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01237">IRP_CONTEXT_FLAG_TOP_LEVEL</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01238">IRP_CONTEXT_FLAG_TOP_LEVEL_UDFS</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00174">LongOffsetPtr</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d6/d8/udfstruc_8h.html#a99">PTHREAD_CONTEXT</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00505">SetFlag</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00137">ThreadContext</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01400">_THREAD_CONTEXT::TopLevelIrpContext</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01386">_THREAD_CONTEXT::Udfs</a>, and <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00062">UDFS_SIGNATURE</a>.
<p>
Referenced by <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00218">UdfFsdDispatch()</a>, <a class="el" href="../../d3/d8/close_8c-source.html#l00099">UdfFspClose()</a>, and <a class="el" href="../../d1/d7/fspdisp_8c-source.html#l00038">UdfFspDispatch()</a>.
<p>
<pre class="fragment"><div>00880                    :
00881 
00882     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called at each Fsd/Fsp entry point set up <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> IrpContext
00883     and thread local storage to track top level requests.  If there <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00884     not a Udfs context in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> thread local storage then we use <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> input one.
00885     Otherwise we use <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> one already there.  This routine also updates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00886     IrpContext based on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> state of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> top-level context.
00887 
00888     If <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> TOP_LEVEL flag in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> IrpContext <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> already set when we are called
00889     then we force <span class="keyword">this</span> request to appear top level.
00890 
00891 Arguments:
00892 
00893     <a class="code" href="../../d2/d1/cttoken_8c.html#a62">ThreadContext</a> - Address on stack <span class="keywordflow">for</span> local storage <span class="keywordflow">if</span> not already present.
00894 
00895     ForceTopLevel - We force <span class="keyword">this</span> request to appear top level regardless of
00896         any previous stack value.
00897 
00898 Return Value:
00899 
00900     None
00901 
00902 --*/
00903 
00904 {
00905     <a class="code" href="../../d0/d1/struct__THREAD__CONTEXT.html">PTHREAD_CONTEXT</a> CurrentThreadContext;
00906     ULONG_PTR StackTop;
00907     ULONG_PTR StackBottom;
00908 
00909     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00910 
00911     <a class="code" href="../../d1/d8/udfdata_8h.html#a28">ASSERT_IRP_CONTEXT</a>( IrpContext );
00912 
00913     <span class="comment">//</span>
00914     <span class="comment">//  Get the current top-level irp out of the thread storage.</span>
00915     <span class="comment">//  If NULL then this is the top-level request.</span>
00916     <span class="comment">//</span>
00917 
00918     CurrentThreadContext = (<a class="code" href="../../d0/d1/struct__THREAD__CONTEXT.html">PTHREAD_CONTEXT</a>) <a class="code" href="../../d4/d6/iosubs_8c.html#a79">IoGetTopLevelIrp</a>();
00919 
00920     <span class="keywordflow">if</span> (CurrentThreadContext == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00921 
00922         <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( IrpContext-&gt;Flags, IRP_CONTEXT_FLAG_TOP_LEVEL );
00923     }
00924 
00925     <span class="comment">//</span>
00926     <span class="comment">//  Initialize the input context unless we are using the current</span>
00927     <span class="comment">//  thread context block.  We use the new block if our caller</span>
00928     <span class="comment">//  specified this or the existing block is invalid.</span>
00929     <span class="comment">//</span>
00930     <span class="comment">//  The following must be true for the current to be a valid Udfs context.</span>
00931     <span class="comment">//</span>
00932     <span class="comment">//      Structure must lie within current stack.</span>
00933     <span class="comment">//      Address must be ULONG aligned.</span>
00934     <span class="comment">//      Udfs signature must be present.</span>
00935     <span class="comment">//</span>
00936     <span class="comment">//  If this is not a valid Udfs context then use the input thread</span>
00937     <span class="comment">//  context and store it in the top level context.</span>
00938     <span class="comment">//</span>
00939 
00940     <a class="code" href="../../d0/d5/io_8h.html#a508">IoGetStackLimits</a>( &amp;StackTop, &amp;StackBottom);
00941 
00942     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpContext-&gt;Flags, IRP_CONTEXT_FLAG_TOP_LEVEL ) ||
00943         (((ULONG_PTR) CurrentThreadContext &gt; StackBottom - <span class="keyword">sizeof</span>( <a class="code" href="../../d0/d1/struct__THREAD__CONTEXT.html">THREAD_CONTEXT</a> )) ||
00944          ((ULONG_PTR) CurrentThreadContext &lt;= StackTop) ||
00945          <a class="code" href="../../d3/d8/udfprocs_8h.html#a30">LongOffsetPtr</a>( CurrentThreadContext ) ||
00946          (CurrentThreadContext-&gt;<a class="code" href="../../d0/d1/struct__THREAD__CONTEXT.html#o0">Udfs</a> != <a class="code" href="../../d1/d8/udfdata_8h.html#a4">UDFS_SIGNATURE</a>))) {
00947 
00948         <a class="code" href="../../d2/d1/cttoken_8c.html#a62">ThreadContext</a>-&gt;Udfs = <a class="code" href="../../d1/d8/udfdata_8h.html#a4">UDFS_SIGNATURE</a>;
00949         <a class="code" href="../../d2/d1/cttoken_8c.html#a62">ThreadContext</a>-&gt;SavedTopLevelIrp = (<a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a>) CurrentThreadContext;
00950         <a class="code" href="../../d2/d1/cttoken_8c.html#a62">ThreadContext</a>-&gt;TopLevelIrpContext = IrpContext;
00951         <a class="code" href="../../d4/d6/iosubs_8c.html#a109">IoSetTopLevelIrp</a>( (<a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a>) ThreadContext );
00952 
00953         IrpContext-&gt;TopLevel = IrpContext;
00954         IrpContext-&gt;ThreadContext = <a class="code" href="../../d2/d1/cttoken_8c.html#a62">ThreadContext</a>;
00955 
00956         <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( IrpContext-&gt;Flags, IRP_CONTEXT_FLAG_TOP_LEVEL_UDFS );
00957 
00958     <span class="comment">//</span>
00959     <span class="comment">//  Otherwise use the IrpContext in the thread context.</span>
00960     <span class="comment">//</span>
00961 
00962     } <span class="keywordflow">else</span> {
00963 
00964         IrpContext-&gt;TopLevel = CurrentThreadContext-&gt;<a class="code" href="../../d0/d1/struct__THREAD__CONTEXT.html#o2">TopLevelIrpContext</a>;
00965     }
00966 
00967     <span class="keywordflow">return</span>;
00968 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a176" doxytag="udfprocs.h::UdfStoreVolumeDescriptorIfPrevailing" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID UdfStoreVolumeDescriptorIfPrevailing           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN OUT <a class="el" href="../../d4/d3/structNSR__VD__GENERIC.html">PNSR_VD_GENERIC</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>StoredVD</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT <a class="el" href="../../d4/d3/structNSR__VD__GENERIC.html">PNSR_VD_GENERIC</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>NewVD</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l00235">235</a> of file <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html">udfs/fsctrl.c</a>.
<p>
References <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01101">FsRtlAllocatePoolWithTag</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d2/d6/udfs_2nodetype_8h-source.html#l00179">TAG_NSR_VDSD</a>, and <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00444">UdfNonPagedPool</a>.
<p>
Referenced by <a class="el" href="../../d3/d5/allocsup_8c-source.html#l00724">UdfAddToPcb()</a>, and <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l02832">UdfFindVolumeDescriptors()</a>.
<p>
<pre class="fragment"><div>00242                    :
00243 
00244     This routine updates Volume Descriptor <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> descriptor
00245     <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> more prevailing than <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> one currently stored.
00246 
00247 Arguments:
00248 
00249     StoredVD - pointer to a currently stored descriptor
00250 
00251     NewVD - pointer to a candidate descriptor
00252 
00253 Return Value:
00254 
00255     None.
00256 
00257 --*/
00258 
00259 {
00260     <a class="code" href="../../d4/d3/structNSR__VD__GENERIC.html">PNSR_VD_GENERIC</a> TempVD;
00261 
00262     <span class="comment">//</span>
00263     <span class="comment">//  If we haven't stored a volume descriptor or the sequence number</span>
00264     <span class="comment">//  of the stored descriptor is less than the new descriptor, make a copy</span>
00265     <span class="comment">//  of it and store it.</span>
00266     <span class="comment">//</span>
00267 
00268     <span class="keywordflow">if</span> ((<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> == *StoredVD) || ((*StoredVD)-&gt;Sequence &lt; NewVD-&gt;Sequence)) {
00269 
00270         <span class="keywordflow">if</span> ( <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> == *StoredVD)  {
00271 
00272             *StoredVD = (<a class="code" href="../../d4/d3/structNSR__VD__GENERIC.html">PNSR_VD_GENERIC</a>) <a class="code" href="../../d1/d8/fsrtl_8h.html#a37">FsRtlAllocatePoolWithTag</a>( UdfNonPagedPool,
00273                                                                     <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d3/structNSR__VD__GENERIC.html">NSR_VD_GENERIC</a>),
00274                                                                     TAG_NSR_VDSD );
00275         }
00276 
00277         RtlCopyMemory( *StoredVD,  NewVD,  <span class="keyword">sizeof</span>( <a class="code" href="../../d4/d3/structNSR__VD__GENERIC.html">NSR_VD_GENERIC</a>));
00278     }
00279 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a210" doxytag="udfprocs.h::UdfTeardownStructures" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID UdfTeardownStructures           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d7/d9/struct__FCB.html">PFCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>StartingFcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>Recursive</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PBOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>RemovedStartingFcb</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l01606">1606</a> of file <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html">udfs/strucsup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00338">ASSERT_FCB</a>, <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00352">ASSERT_IRP_CONTEXT</a>, <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00350">ASSERT_LCB</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00778">_LCB::ChildFcb</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00509">ClearFlag</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01062">FCB_STATE_IN_FCB_TABLE</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00979">_FCB::FcbReference</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00986">_FCB::FcbState</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00980">_FCB::FcbUserReference</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01240">IRP_CONTEXT_FLAG_IN_TEARDOWN</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00770">_LCB::ParentFcb</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00952">_FCB::ParentLcbQueue</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00784">_LCB::Reference</a>, <a class="el" href="../../d2/d6/udfs_2nodetype_8h-source.html#l00063">SafeNodeType</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00505">SetFlag</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01542">UdfAcquireFcbExclusive</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01770">UdfDecrementReferenceCounts</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l02178">UdfDeleteFcb()</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l00146">UdfDeleteFcbTable</a>, <a class="el" href="../../d9/d1/udfs_2cachesup_8c-source.html#l00215">UdfDeleteInternalStream()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01559">UdfLockVcb</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01548">UdfReleaseFcb</a>, <a class="el" href="../../d6/d3/prefxsup_8c-source.html#l00256">UdfRemovePrefix()</a>, <a class="el" href="../../d2/d6/udfs_2nodetype_8h-source.html#l00038">UDFS_NTC_FCB_DATA</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01563">UdfUnlockVcb</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00612">_VCB::VcbReference</a>, and <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00613">_VCB::VcbUserReference</a>.
<p>
Referenced by <a class="el" href="../../d3/d8/close_8c-source.html#l00498">UdfCommonClosePrivate()</a>, <a class="el" href="../../d4/d7/udfs_2create_8c-source.html#l00108">UdfCommonCreate()</a>, <a class="el" href="../../d3/d8/workque_8c-source.html#l00222">UdfOplockComplete()</a>, <a class="el" href="../../d3/d8/workque_8c-source.html#l00111">UdfPrePostIrp()</a>, and <a class="el" href="../../d9/d1/udfs_2cachesup_8c-source.html#l00417">UdfPurgeVolume()</a>.
<p>
<pre class="fragment"><div>01615                    :
01616 
01617     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> used to walk from some starting point in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Fcb tree towards
01618     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> root.  It will remove <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Fcb and <span class="keywordflow">continue</span> walking up <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> tree until
01619     <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> finds a point where we can'<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> remove an Fcb.
01620 
01621     We look at <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> following fields in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Fcb to determine whether we can
01622     remove <span class="keyword">this</span>.
01623 
01624         1 - <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> count must be zero.
01625         2 - If directory then <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> reference can be <span class="keywordflow">for</span> a stream <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
01626         3 - Reference count must either be zero or go to zero here.
01627 
01628     We <span class="keywordflow">return</span> immediately <span class="keywordflow">if</span> we are recursively entering <span class="keyword">this</span> routine.
01629 
01630 Arguments:
01631 
01632     StartingFcb - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Fcb node in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> tree to begin with.  This Fcb
01633         must currently be acquired exclusively.
01634         
01635     Recursive - Indicates <span class="keywordflow">if</span> <span class="keyword">this</span> call <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> an intentional recursion.
01636 
01637     RemovedStartingFcb - Address to store whether we removed <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> starting Fcb.
01638 
01639 Return Value:
01640 
01641     None
01642 
01643 --*/
01644 
01645 {
01646     <a class="code" href="../../d7/d5/struct__VCB.html">PVCB</a> Vcb = StartingFcb-&gt;Vcb;
01647     <a class="code" href="../../d7/d9/struct__FCB.html">PFCB</a> CurrentFcb = StartingFcb;
01648     BOOLEAN AcquiredCurrentFcb = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01649     <a class="code" href="../../d7/d9/struct__FCB.html">PFCB</a> ParentFcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01650     <a class="code" href="../../d5/d9/struct__LCB.html">PLCB</a> Lcb;
01651 
01652     PLIST_ENTRY ListLinks;
01653     BOOLEAN Abort = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01654     BOOLEAN Removed;
01655     
01656     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01657 
01658     <span class="comment">//</span>
01659     <span class="comment">//  Check input.</span>
01660     <span class="comment">//</span>
01661 
01662     <a class="code" href="../../d1/d8/udfdata_8h.html#a28">ASSERT_IRP_CONTEXT</a>( IrpContext );
01663     <a class="code" href="../../d1/d8/udfdata_8h.html#a14">ASSERT_FCB</a>( StartingFcb );
01664 
01665     *RemovedStartingFcb = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01666 
01667     <span class="comment">//</span>
01668     <span class="comment">//  If this is not an intentionally recursive call we need to check if this</span>
01669     <span class="comment">//  is a layered close and we're already in another instance of teardown.</span>
01670     <span class="comment">//</span>
01671 
01672     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( +1, Dbg,
01673                  <span class="stringliteral">"UdfTeardownStructures, StartingFcb %08x %s\n"</span>,
01674                  StartingFcb,
01675                  ( Recursive? <span class="stringliteral">"Recursive"</span> : <span class="stringliteral">"Flat"</span> )));
01676     
01677     <span class="keywordflow">if</span> (!Recursive) {
01678     
01679         <span class="comment">//</span>
01680         <span class="comment">//  If this is a recursive call to TearDownStructures we return immediately</span>
01681         <span class="comment">//  doing no operation.</span>
01682         <span class="comment">//</span>
01683 
01684         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpContext-&gt;TopLevel-&gt;Flags, IRP_CONTEXT_FLAG_IN_TEARDOWN )) {
01685 
01686             <span class="keywordflow">return</span>;
01687         }
01688 
01689         <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( IrpContext-&gt;TopLevel-&gt;Flags, IRP_CONTEXT_FLAG_IN_TEARDOWN );
01690     }
01691 
01692     <span class="comment">//</span>
01693     <span class="comment">//  Use a try-finally to safely clear the top-level field.</span>
01694     <span class="comment">//</span>
01695 
01696     <span class="keywordflow">try</span> {
01697 
01698         <span class="comment">//</span>
01699         <span class="comment">//  Loop until we find an Fcb we can't remove.</span>
01700         <span class="comment">//</span>
01701 
01702         <span class="keywordflow">do</span> {
01703 
01704             <span class="comment">//</span>
01705             <span class="comment">//  See if there is an internal stream we should delete.</span>
01706             <span class="comment">//  Only do this if it is the last reference on the Fcb.</span>
01707             <span class="comment">//</span>
01708 
01709             <span class="keywordflow">if</span> ((<a class="code" href="../../d1/d7/udfs_2nodetype_8h.html#a12">SafeNodeType</a>( CurrentFcb ) != <a class="code" href="../../d1/d7/udfs_2nodetype_8h.html#a4">UDFS_NTC_FCB_DATA</a>) &amp;&amp;
01710                 (CurrentFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o9">FcbUserReference</a> == 0) &amp;&amp;
01711                 (CurrentFcb-&gt;FileObject != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
01712 
01713                 <span class="comment">//</span>
01714                 <span class="comment">//  Go ahead and delete the stream file object.</span>
01715                 <span class="comment">//</span>
01716 
01717                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a155">UdfDeleteInternalStream</a>( IrpContext, CurrentFcb );
01718             }
01719 
01720             <span class="comment">//</span>
01721             <span class="comment">//  If the reference count is non-zero then break.</span>
01722             <span class="comment">//</span>
01723 
01724             <span class="keywordflow">if</span> (CurrentFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o8">FcbReference</a> != 0) {
01725 
01726                 <span class="keywordflow">break</span>;
01727             }
01728 
01729             <span class="comment">//</span>
01730             <span class="comment">//  It looks like we have a candidate for removal here.  We</span>
01731             <span class="comment">//  will need to walk the list of prefixes and delete them</span>
01732             <span class="comment">//  from their parents.  If it turns out that we have multiple</span>
01733             <span class="comment">//  parents of this Fcb, we are going to recursively teardown</span>
01734             <span class="comment">//  on each of these.</span>
01735             <span class="comment">//</span>
01736 
01737             <span class="keywordflow">for</span> ( ListLinks = CurrentFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o3">ParentLcbQueue</a>.Flink;
01738                   ListLinks != &amp;CurrentFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o3">ParentLcbQueue</a>; ) {
01739 
01740                 Lcb = CONTAINING_RECORD( ListLinks, <a class="code" href="../../d5/d9/struct__LCB.html">LCB</a>, ChildFcbLinks );
01741 
01742                 <a class="code" href="../../d1/d8/udfdata_8h.html#a26">ASSERT_LCB</a>( Lcb );
01743 
01744                 <span class="comment">//</span>
01745                 <span class="comment">//  We advance the pointer now because we will be toasting this guy,</span>
01746                 <span class="comment">//  invalidating whatever is here.</span>
01747                 <span class="comment">//</span>
01748 
01749                 ListLinks = ListLinks-&gt;Flink;
01750 
01751                 <span class="comment">//</span>
01752                 <span class="comment">//  We may have multiple parents through hard links.  If the previous parent we</span>
01753                 <span class="comment">//  dealt with is not the parent of this new Lcb, lets do some work.</span>
01754                 <span class="comment">//</span>
01755                 
01756                 <span class="keywordflow">if</span> (ParentFcb != Lcb-&gt;<a class="code" href="../../d5/d9/struct__LCB.html#o9">ParentFcb</a>) {
01757 
01758                     <span class="comment">//</span>
01759                     <span class="comment">//  We need to deal with the previous parent.  It may now be the case that</span>
01760                     <span class="comment">//  we deleted the last child reference and it wants to go away at this point.</span>
01761                     <span class="comment">//</span>
01762                     
01763                     <span class="keywordflow">if</span> (ParentFcb) {
01764 
01765                         <span class="comment">//</span>
01766                         <span class="comment">//  It should never be the case that we have to recurse more than one level on</span>
01767                         <span class="comment">//  any teardown since no cross-linkage of directories is possible.</span>
01768                         <span class="comment">//</span>
01769                     
01770                         <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( !Recursive );
01771                           
01772                         <a class="code" href="../../d3/d8/udfprocs_8h.html#a210">UdfTeardownStructures</a>( IrpContext, ParentFcb, TRUE, &amp;Removed );
01773 
01774                         <span class="keywordflow">if</span> (!Removed) {
01775 
01776                             <a class="code" href="../../d3/d8/udfprocs_8h.html#a85">UdfReleaseFcb</a>( IrpContext, ParentFcb );
01777                         }
01778                     }
01779 
01780                     <span class="comment">//</span>
01781                     <span class="comment">//  Get this new parent Fcb to work on.</span>
01782                     <span class="comment">//</span>
01783                     
01784                     ParentFcb = Lcb-&gt;<a class="code" href="../../d5/d9/struct__LCB.html#o9">ParentFcb</a>;
01785                     <a class="code" href="../../d3/d8/udfprocs_8h.html#a83">UdfAcquireFcbExclusive</a>( IrpContext, ParentFcb, FALSE );
01786                 }
01787                 
01788                 <span class="comment">//</span>
01789                 <span class="comment">//  Lock the Vcb so we can look at references.</span>
01790                 <span class="comment">//</span>
01791 
01792                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a88">UdfLockVcb</a>( IrpContext, Vcb );
01793 
01794                 <span class="comment">//</span>
01795                 <span class="comment">//  Now check that the reference counts on the Lcb are zero.</span>
01796                 <span class="comment">//</span>
01797 
01798                 <span class="keywordflow">if</span> ( Lcb-&gt;<a class="code" href="../../d5/d9/struct__LCB.html#o12">Reference</a> != 0 ) {
01799 
01800                     <span class="comment">//</span>
01801                     <span class="comment">//  A create is interested in getting in here, so we should</span>
01802                     <span class="comment">//  stop right now.</span>
01803                     <span class="comment">//</span>
01804 
01805                     <a class="code" href="../../d3/d8/udfprocs_8h.html#a89">UdfUnlockVcb</a>( IrpContext, Vcb );
01806                     <a class="code" href="../../d3/d8/udfprocs_8h.html#a85">UdfReleaseFcb</a>( IrpContext, ParentFcb );
01807                     Abort = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01808 
01809                     <span class="keywordflow">break</span>;
01810                 }
01811 
01812                 <span class="comment">//</span>
01813                 <span class="comment">//  Now remove this prefix and drop the references to the parent.</span>
01814                 <span class="comment">//</span>
01815 
01816                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( Lcb-&gt;<a class="code" href="../../d5/d9/struct__LCB.html#o11">ChildFcb</a> == CurrentFcb );
01817                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( Lcb-&gt;<a class="code" href="../../d5/d9/struct__LCB.html#o9">ParentFcb</a> == ParentFcb );
01818                 
01819                 <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( +0, Dbg,
01820                              <span class="stringliteral">"UdfTeardownStructures, Lcb %08x P %08x &lt;-&gt; C %08x Vcb %d/%d PFcb %d/%d CFcb %d/%d\n"</span>,
01821                              Lcb,
01822                              ParentFcb,
01823                              CurrentFcb,
01824                              Vcb-&gt;<a class="code" href="../../d7/d5/struct__VCB.html#o16">VcbReference</a>,
01825                              Vcb-&gt;<a class="code" href="../../d7/d5/struct__VCB.html#o17">VcbUserReference</a>,
01826                              ParentFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o8">FcbReference</a>,
01827                              ParentFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o9">FcbUserReference</a>,
01828                              CurrentFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o8">FcbReference</a>,
01829                              CurrentFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o9">FcbUserReference</a> ));
01830 
01831                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a195">UdfRemovePrefix</a>( IrpContext, Lcb );
01832                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a99">UdfDecrementReferenceCounts</a>( IrpContext, ParentFcb, 1, 1 );
01833 
01834                 <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( +0, Dbg,
01835                              <span class="stringliteral">"UdfTeardownStructures, Vcb %d/%d PFcb %d/%d\n"</span>,
01836                              Vcb-&gt;<a class="code" href="../../d7/d5/struct__VCB.html#o16">VcbReference</a>,
01837                              Vcb-&gt;<a class="code" href="../../d7/d5/struct__VCB.html#o17">VcbUserReference</a>,
01838                              ParentFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o8">FcbReference</a>,
01839                              ParentFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o9">FcbUserReference</a> ));
01840 
01841                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a89">UdfUnlockVcb</a>( IrpContext, Vcb );
01842             }
01843 
01844             <span class="comment">//</span>
01845             <span class="comment">//  Now really leave if we have to.</span>
01846             <span class="comment">//</span>
01847             
01848             <span class="keywordflow">if</span> (Abort) {
01849 
01850                 <span class="keywordflow">break</span>;
01851             }
01852 
01853             <span class="comment">//</span>
01854             <span class="comment">//  Now that we have removed all of the prefixes of this Fcb we can make the final check.</span>
01855             <span class="comment">//  Lock the Vcb again so we can inspect the child's references.</span>
01856             <span class="comment">//</span>
01857 
01858             <a class="code" href="../../d3/d8/udfprocs_8h.html#a88">UdfLockVcb</a>( IrpContext, Vcb );
01859 
01860             <span class="keywordflow">if</span> (CurrentFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o8">FcbReference</a> != 0) {
01861 
01862                 <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( +0, Dbg,
01863                              <span class="stringliteral">"UdfTeardownStructures, saving Fcb %08x %d/%d\n"</span>,
01864                              CurrentFcb,
01865                              CurrentFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o8">FcbReference</a>,
01866                              CurrentFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o9">FcbUserReference</a> ));
01867                 
01868                 <span class="comment">//</span>
01869                 <span class="comment">//  Nope, nothing more to do.  Stop right now.</span>
01870                 <span class="comment">//</span>
01871                 
01872                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a89">UdfUnlockVcb</a>( IrpContext, Vcb );
01873 
01874                 <span class="keywordflow">if</span> (ParentFcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01875 
01876                     <a class="code" href="../../d3/d8/udfprocs_8h.html#a85">UdfReleaseFcb</a>( IrpContext, ParentFcb );
01877                 }
01878 
01879                 <span class="keywordflow">break</span>;
01880             }
01881 
01882             <span class="comment">//</span>
01883             <span class="comment">//  This Fcb is toast.  Remove it from the Fcb Table as appropriate and delete.</span>
01884             <span class="comment">//</span>
01885 
01886             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( CurrentFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o10">FcbState</a>, FCB_STATE_IN_FCB_TABLE )) {
01887 
01888                 <a class="code" href="../../d9/d7/udfs_2strucsup_8c.html#a11">UdfDeleteFcbTable</a>( IrpContext, CurrentFcb );
01889                 <a class="code" href="../../d5/d5/cc_8h.html#a61">ClearFlag</a>( CurrentFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o10">FcbState</a>, FCB_STATE_IN_FCB_TABLE );
01890 
01891             }
01892 
01893             <span class="comment">//</span>
01894             <span class="comment">//  Unlock the Vcb but hold the parent in order to walk up</span>
01895             <span class="comment">//  the tree.</span>
01896             <span class="comment">//</span>
01897 
01898             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( +0, Dbg,
01899                          <span class="stringliteral">"UdfTeardownStructures, toasting Fcb %08x %d/%d\n"</span>,
01900                          CurrentFcb,
01901                          CurrentFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o8">FcbReference</a>,
01902                          CurrentFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o9">FcbUserReference</a> ));
01903 
01904             <a class="code" href="../../d3/d8/udfprocs_8h.html#a89">UdfUnlockVcb</a>( IrpContext, Vcb );
01905             <a class="code" href="../../d3/d8/udfprocs_8h.html#a214">UdfDeleteFcb</a>( IrpContext, CurrentFcb );
01906 
01907             <span class="comment">//</span>
01908             <span class="comment">//  Move to the parent Fcb.</span>
01909             <span class="comment">//</span>
01910 
01911             CurrentFcb = ParentFcb;
01912             ParentFcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01913             AcquiredCurrentFcb = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01914 
01915         } <span class="keywordflow">while</span> (CurrentFcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
01916 
01917     } finally {
01918 
01919         <span class="comment">//</span>
01920         <span class="comment">//  Release the current Fcb if we have acquired it.</span>
01921         <span class="comment">//</span>
01922 
01923         <span class="keywordflow">if</span> (AcquiredCurrentFcb &amp;&amp; (CurrentFcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
01924 
01925             <a class="code" href="../../d3/d8/udfprocs_8h.html#a85">UdfReleaseFcb</a>( IrpContext, CurrentFcb );
01926         }
01927 
01928         <span class="comment">//</span>
01929         <span class="comment">//  Clear the teardown flag.</span>
01930         <span class="comment">//</span>
01931 
01932         <span class="keywordflow">if</span> (!Recursive) {
01933         
01934             <a class="code" href="../../d5/d5/cc_8h.html#a61">ClearFlag</a>( IrpContext-&gt;TopLevel-&gt;Flags, IRP_CONTEXT_FLAG_IN_TEARDOWN );
01935         }
01936     }
01937 
01938     *RemovedStartingFcb = (CurrentFcb != StartingFcb);
01939 
01940     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( -1, Dbg,
01941                  <span class="stringliteral">"UdfTeardownStructures, RemovedStartingFcb -&gt; %c\n"</span>,
01942                  ( *RemovedStartingFcb? <span class="charliteral">'T'</span> : <span class="charliteral">'F'</span> )));
01943 
01944     <span class="keywordflow">return</span>;
01945 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a231" doxytag="udfprocs.h::UdfUdfIdentifierContained" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> INLINE BOOLEAN UdfUdfIdentifierContained           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d6/d6/structREGID.html">PREGID</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>RegID</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PSTRING&nbsp;</td>
          <td class="mdname" nowrap> <em>Type</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>RevisionMin</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>RevisionMax</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN UCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>OSClass</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN UCHAR&nbsp;</td>
          <td class="mdname" nowrap> <em>OSIdentifier</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l02060">2060</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.
<p>
References <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d0/d7/udf_8h-source.html#l00279">_UDF_SUFFIX_UDF::OSClass</a>, <a class="el" href="../../d0/d7/udf_8h-source.html#l00307">OSCLASS_INVALID</a>, <a class="el" href="../../d0/d7/udf_8h-source.html#l00280">_UDF_SUFFIX_UDF::OSIdentifier</a>, <a class="el" href="../../d0/d7/udf_8h-source.html#l00308">OSIDENTIFIER_INVALID</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01988">UdfEqualEntityId()</a>, and <a class="el" href="../../d0/d7/udf_8h-source.html#l00278">_UDF_SUFFIX_UDF::UdfRevision</a>.
<p>
Referenced by <a class="el" href="../../d3/d5/allocsup_8c-source.html#l01406">UdfLoadSparingTables()</a>, and <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l00477">UdfUpdateVcbPhase0()</a>.
<p>
<pre class="fragment"><div>02068 {
02069     <a class="code" href="../../d8/d3/struct__UDF__SUFFIX__UDF.html">PUDF_SUFFIX_UDF</a> UdfSuffix = (<a class="code" href="../../d8/d3/struct__UDF__SUFFIX__UDF.html">PUDF_SUFFIX_UDF</a>) RegID-&gt;Suffix;
02070 
02071     <span class="keywordflow">return</span> ((UdfSuffix-&gt;<a class="code" href="../../d8/d3/struct__UDF__SUFFIX__UDF.html#o0">UdfRevision</a> &lt;= RevisionMax &amp;&amp; UdfSuffix-&gt;<a class="code" href="../../d8/d3/struct__UDF__SUFFIX__UDF.html#o0">UdfRevision</a> &gt;= RevisionMin) &amp;&amp;
02072             (OSClass == <a class="code" href="../../d9/d7/udf_8h.html#a33">OSCLASS_INVALID</a> || UdfSuffix-&gt;<a class="code" href="../../d8/d3/struct__UDF__SUFFIX__UDF.html#o1">OSClass</a> == OSClass) &amp;&amp;
02073             (OSIdentifier == <a class="code" href="../../d9/d7/udf_8h.html#a34">OSIDENTIFIER_INVALID</a> || UdfSuffix-&gt;<a class="code" href="../../d8/d3/struct__UDF__SUFFIX__UDF.html#o2">OSIdentifier</a> == OSIdentifier) &amp;&amp;
02074             <a class="code" href="../../d3/d8/udfprocs_8h.html#a229">UdfEqualEntityId</a>( RegID, Type, NULL ));
02075 }
</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a237" doxytag="udfprocs.h::UdfUninitializeVmcb" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID UdfUninitializeVmcb           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d7/struct__VMCB.html">PVMCB</a>&nbsp;</td>
          <td class="mdname1" valign="top" nowrap> <em>Vmcb</em>          </td>
          <td class="md" valign="top">&nbsp;)&nbsp;</td>
          <td class="md" nowrap></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d5/vmcbsup_8c-source.html#l00325">325</a> of file <a class="el" href="../../d7/d5/vmcbsup_8c-source.html">vmcbsup.c</a>.
<p>
References <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00348">FsRtlUninitializeMcb()</a>, and <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>.
<p>
Referenced by <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l02178">UdfDeleteFcb()</a>.
<p>
<pre class="fragment"><div>00331                    :
00332 
00333     This routine uninitializes an existing <a class="code" href="../../d1/d7/struct__VMCB.html">VMCB</a> structure.  After calling
00334     <span class="keyword">this</span> routine <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> input <a class="code" href="../../d1/d7/struct__VMCB.html">VMCB</a> structure must be re-initialized before
00335     being used again.
00336 
00337 Arguments:
00338 
00339     Vmcb - Supplies a pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d1/d7/struct__VMCB.html">VMCB</a> structure to uninitialize.
00340 
00341 Return Value:
00342 
00343     None.
00344 
00345 --*/
00346 
00347 {
00348     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00349 
00350     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( +1, Dbg, <span class="stringliteral">"UdfUninitializeVmcb, Vmcb = %08x\n"</span>, Vmcb ));
00351 
00352     <span class="comment">//</span>
00353     <span class="comment">//  Unitialize the fields in the Vmcb structure</span>
00354     <span class="comment">//</span>
00355 
00356     <a class="code" href="../../d1/d8/fsrtl_8h.html#a152">FsRtlUninitializeMcb</a>( &amp;Vmcb-&gt;VbnIndexed );
00357     <a class="code" href="../../d1/d8/fsrtl_8h.html#a152">FsRtlUninitializeMcb</a>( &amp;Vmcb-&gt;LbnIndexed );
00358 
00359     <span class="comment">//</span>
00360     <span class="comment">//  And return to our caller</span>
00361     <span class="comment">//</span>
00362 
00363     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( -1, Dbg, <span class="stringliteral">"UdfUninitializeVmcb -&gt; VOID\n"</span> ));
00364 
00365     <span class="keywordflow">return</span>;
00366 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a191" doxytag="udfprocs.h::UdfUnlockVolumeInternal" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS UdfUnlockVolumeInternal           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d7/d5/struct__VCB.html">PVCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Vcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l00732">732</a> of file <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html">udfs/fsctrl.c</a>.
<p>
References <a class="el" href="../../d6/d4/cc_8h-source.html#l00509">ClearFlag</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, and <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00683">VCB_STATE_LOCKED</a>.
<p>
Referenced by <a class="el" href="../../d5/d8/udfs_2pnp_8c-source.html#l00632">UdfPnpCancelRemove()</a>, <a class="el" href="../../d5/d8/udfs_2pnp_8c-source.html#l00350">UdfPnpRemove()</a>, and <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l00877">UdfUnlockVolume()</a>.
<p>
<pre class="fragment"><div>00740                    :
00741 
00742     This routine performs <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> actual unlock volume operation. 
00743     
00744     The volume must be held exclusive by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller.
00745 
00746 Arguments:
00747 
00748     Vcb - The volume being locked.
00749     
00750     FileObject - <a class="code" href="../../d1/d9/icmui_8def.html#a0">File</a> corresponding to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> handle locking <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> volume.  If <span class="keyword">this</span>
00751         <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> not specified, a system lock <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> assumed.
00752 
00753 Return Value:
00754 
00755     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - The <span class="keywordflow">return</span> status <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation
00756     
00757     Attempting to remove a system lock that did not exist <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> OK.
00758 
00759 --*/
00760 
00761 {
00762     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
00763     
00764     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>(Vcb-&gt;VcbState, VCB_STATE_LOCKED) &amp;&amp; FileObject == Vcb-&gt;VolumeLockFileObject) {
00765 
00766         <a class="code" href="../../d5/d5/cc_8h.html#a61">ClearFlag</a>( Vcb-&gt;VcbState, VCB_STATE_LOCKED );
00767         Vcb-&gt;VolumeLockFileObject = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00768         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00769     }
00770 
00771     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00772 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a186" doxytag="udfprocs.h::UdfUpcaseName" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> INLINE VOID UdfUpcaseName           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>Name</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>UpcaseName</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01131">1131</a> of file <a class="el" href="../../d4/d7/udfprocs_8h-source.html">udfprocs.h</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d9/d9/geninst_8c-source.html#l00154">Name</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d7/d5/nls_8c-source.html#l01038">RtlUpcaseUnicodeString()</a>, and <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>.
<p>
Referenced by <a class="el" href="../../d6/d4/namesup_8c-source.html#l00389">UdfGenerate8dot3Name()</a>, <a class="el" href="../../d4/d7/udfs_2create_8c-source.html#l00809">UdfNormalizeFileNames()</a>, and <a class="el" href="../../d5/d7/dirsup_8c-source.html#l00360">UdfUpdateDirNames()</a>.
<p>
<pre class="fragment"><div>01139                    :
01140 
01141     This routine upcases a name with an assertion of success.
01142     
01143 Arguments:
01144 
01145     <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a> - an name to <a class="code" href="../../d7/d6/nlsboot_8c.html#a0">upcase</a>
01146     
01147     Length - a place to put <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> upcased name (can be the same as Name)
01148     
01149 Return Value:
01150 
01151     None.
01152     
01153 --*/
01154 
01155 {
01156     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01157 
01158     <span class="comment">//</span>
01159     <span class="comment">//  Upcase the string using the correct upcase routine.</span>
01160     <span class="comment">//</span>
01161 
01162     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d6/nls_8c.html#a31">RtlUpcaseUnicodeString</a>( UpcaseName,
01163                                      Name,
01164                                      FALSE );
01165 
01166     <span class="comment">//</span>
01167     <span class="comment">//  This should never fail.</span>
01168     <span class="comment">//</span>
01169 
01170     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( Status == STATUS_SUCCESS );
01171 
01172     <span class="keywordflow">return</span>;
01173 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a171" doxytag="udfprocs.h::UdfUpdateDirNames" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID UdfUpdateDirNames           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d5/d5/struct__DIR__ENUM__CONTEXT.html">PDIR_ENUM_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DirContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>IgnoreCase</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d5/d7/dirsup_8c-source.html#l00360">360</a> of file <a class="el" href="../../d5/d7/dirsup_8c-source.html">dirsup.c</a>.
<p>
References <a class="el" href="../../d3/d6/notify_8c-source.html#l00236">Add2Ptr</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00352">ASSERT_IRP_CONTEXT</a>, <a class="el" href="../../d0/d7/udf_8h-source.html#l00205">BYTE_COUNT_8_DOT_3</a>, <a class="el" href="../../d0/d7/udf_8h-source.html#l00223">CRC_LEN</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01699">DIR_CONTEXT_FLAG_SEEN_NONCONSTANT</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01700">DIR_CONTEXT_FLAG_SEEN_PARENT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01101">FsRtlAllocatePoolWithTag</a>, <a class="el" href="../../d1/d6/iso13346_8h-source.html#l00805">ISONsrFidConstantSize</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00062">Max</a>, <a class="el" href="../../d0/d7/udf_8h-source.html#l00221">MAX_LEN</a>, <a class="el" href="../../d1/d6/iso13346_8h-source.html#l00813">NSR_FID_F_PARENT</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00069">PARENT_ENTRY</a>, <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00068">SELF_ENTRY</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00505">SetFlag</a>, <a class="el" href="../../d2/d6/udfs_2nodetype_8h-source.html#l00165">TAG_FILE_NAME</a>, <a class="el" href="../../d6/d4/namesup_8c-source.html#l00819">UdfCheckLegalCS0Dstring()</a>, <a class="el" href="../../d6/d4/namesup_8c-source.html#l00689">UdfConvertCS0DstringToUnicode()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01239">UdfCS0DstringContainsLegalCharacters()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01177">UdfCS0DstringUnicodeSize()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00453">UdfFreePool()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00443">UdfPagedPool</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00406">UdfRaiseStatus()</a>, <a class="el" href="../../d6/d4/namesup_8c-source.html#l00927">UdfRenderNameToLegalUnicode()</a>, <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00081">UdfUnicodeDirectoryNames</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01131">UdfUpcaseName()</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l01500">UdfEnumerateIndex()</a>, <a class="el" href="../../d5/d7/dirsup_8c-source.html#l00726">UdfFindDirEntry()</a>, and <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l01003">UdfInitializeEnumeration()</a>.
<p>
<pre class="fragment"><div>00368                    :
00369 
00370     This routine fills in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> non-<span class="keywordtype">short</span> names of a directory enumeration context
00371     <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Fid currently referenced.
00372 
00373 Arguments:
00374 
00375     DirContext - a corresponding context to fill in.
00376     
00377     IgnoreCase - whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller wants to be insensitive to <span class="keywordflow">case</span>.
00378 
00379 Return Value:
00380 
00381     None.
00382     
00383 --*/
00384 
00385 {
00386     PUCHAR NameDstring;
00387     BOOLEAN ContainsIllegal;
00388     
00389     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> NameLength;
00390     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> BufferLength;
00391     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> PresentLength;
00392      
00393     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00394 
00395     <span class="comment">//</span>
00396     <span class="comment">//  Check input.</span>
00397     <span class="comment">//</span>
00398 
00399     <a class="code" href="../../d1/d8/udfdata_8h.html#a28">ASSERT_IRP_CONTEXT</a>( IrpContext );
00400 
00401     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( +1, Dbg, <span class="stringliteral">"UdfUpdateDirNames\n"</span> ));
00402 
00403     <span class="comment">//</span>
00404     <span class="comment">//  Handle the case of the self directory entry.</span>
00405     <span class="comment">//</span>
00406 
00407     <span class="keywordflow">if</span> (DirContext-&gt;Fid == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00408 
00409         <span class="comment">//</span>
00410         <span class="comment">//  Simply synthesize</span>
00411         <span class="comment">//</span>
00412         
00413         <span class="comment">//</span>
00414         <span class="comment">//  It doesn't hurt to be pedantic about initialization, so do it all.</span>
00415         <span class="comment">//</span>
00416         
00417         DirContext-&gt;PureObjectName.Length =
00418         DirContext-&gt;CaseObjectName.Length =
00419         DirContext-&gt;ObjectName.Length = <a class="code" href="../../d0/d8/udfdata_8c.html#a6">UdfUnicodeDirectoryNames</a>[<a class="code" href="../../d1/d8/udfdata_8h.html#a5">SELF_ENTRY</a>].Length;
00420         
00421         DirContext-&gt;PureObjectName.MaximumLength =
00422         DirContext-&gt;CaseObjectName.MaximumLength =
00423         DirContext-&gt;ObjectName.MaximumLength = <a class="code" href="../../d0/d8/udfdata_8c.html#a6">UdfUnicodeDirectoryNames</a>[<a class="code" href="../../d1/d8/udfdata_8h.html#a5">SELF_ENTRY</a>].MaximumLength;
00424 
00425         DirContext-&gt;PureObjectName.Buffer = 
00426         DirContext-&gt;CaseObjectName.Buffer = 
00427         DirContext-&gt;ObjectName.Buffer = <a class="code" href="../../d0/d8/udfdata_8c.html#a6">UdfUnicodeDirectoryNames</a>[<a class="code" href="../../d1/d8/udfdata_8h.html#a5">SELF_ENTRY</a>].Buffer;
00428 
00429         <span class="comment">//</span>
00430         <span class="comment">//  All done.</span>
00431         <span class="comment">//</span>
00432 
00433         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>((  0, Dbg, <span class="stringliteral">"Self Entry case\n"</span> ));
00434         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( -1, Dbg, <span class="stringliteral">"UdfUpdateDirNames -&gt; VOID\n"</span> ));
00435         
00436         <span class="keywordflow">return</span>;
00437     }
00438     
00439     <span class="comment">//</span>
00440     <span class="comment">//  Handle the case of the parent directory entry.</span>
00441     <span class="comment">//</span>
00442 
00443     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( DirContext-&gt;Fid-&gt;Flags, NSR_FID_F_PARENT )) {
00444 
00445         <span class="comment">//</span>
00446         <span class="comment">//  Parent entries must occur at the front of the directory and</span>
00447         <span class="comment">//  have a fid length of zero (13346 4/14.4.4).</span>
00448         <span class="comment">//</span>
00449 
00450         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( DirContext-&gt;Flags, DIR_CONTEXT_FLAG_SEEN_NONCONSTANT ) ||
00451             DirContext-&gt;Fid-&gt;FileIDLen != 0) {
00452 
00453             <a class="code" href="../../d3/d8/udfprocs_8h.html#a122">UdfRaiseStatus</a>( IrpContext, STATUS_FILE_CORRUPT_ERROR );
00454         }
00455 
00456         <span class="comment">//</span>
00457         <span class="comment">//  Note that we have seen the parent entry.</span>
00458         <span class="comment">//</span>
00459 
00460         <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( DirContext-&gt;Flags, DIR_CONTEXT_FLAG_SEEN_PARENT );
00461         
00462         <span class="comment">//</span>
00463         <span class="comment">//  It doesn't hurt to be pedantic about initialization, so do it all.</span>
00464         <span class="comment">//</span>
00465         
00466         DirContext-&gt;PureObjectName.Length =
00467         DirContext-&gt;CaseObjectName.Length =
00468         DirContext-&gt;ObjectName.Length = <a class="code" href="../../d0/d8/udfdata_8c.html#a6">UdfUnicodeDirectoryNames</a>[<a class="code" href="../../d1/d8/udfdata_8h.html#a6">PARENT_ENTRY</a>].Length;
00469         
00470         DirContext-&gt;PureObjectName.MaximumLength =
00471         DirContext-&gt;CaseObjectName.MaximumLength =
00472         DirContext-&gt;ObjectName.MaximumLength = <a class="code" href="../../d0/d8/udfdata_8c.html#a6">UdfUnicodeDirectoryNames</a>[<a class="code" href="../../d1/d8/udfdata_8h.html#a6">PARENT_ENTRY</a>].MaximumLength;
00473 
00474         DirContext-&gt;PureObjectName.Buffer = 
00475         DirContext-&gt;CaseObjectName.Buffer = 
00476         DirContext-&gt;ObjectName.Buffer = <a class="code" href="../../d0/d8/udfdata_8c.html#a6">UdfUnicodeDirectoryNames</a>[<a class="code" href="../../d1/d8/udfdata_8h.html#a6">PARENT_ENTRY</a>].Buffer;
00477 
00478         <span class="comment">//</span>
00479         <span class="comment">//  All done.</span>
00480         <span class="comment">//</span>
00481 
00482         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>((  0, Dbg, <span class="stringliteral">"Parent Entry case\n"</span> ));
00483         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( -1, Dbg, <span class="stringliteral">"UdfUpdateDirNames -&gt; VOID\n"</span> ));
00484         
00485         <span class="keywordflow">return</span>;
00486     }
00487 
00488     <span class="comment">//</span>
00489     <span class="comment">//  We now know that we will need to convert the name in a real FID, so figure out where</span>
00490     <span class="comment">//  it sits in the descriptor.</span>
00491     <span class="comment">//</span>
00492     
00493     NameDstring = <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( DirContext-&gt;Fid, ISONsrFidConstantSize + DirContext-&gt;Fid-&gt;ImpUseLen, PUCHAR );
00494      
00495     <span class="comment">//</span>
00496     <span class="comment">//  Every directory must record a parent entry.</span>
00497     <span class="comment">//</span>
00498     
00499     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( DirContext-&gt;Flags, DIR_CONTEXT_FLAG_SEEN_PARENT)) {
00500     
00501         <a class="code" href="../../d3/d8/udfprocs_8h.html#a122">UdfRaiseStatus</a>( IrpContext, STATUS_FILE_CORRUPT_ERROR );
00502     }
00503     
00504     <span class="comment">//</span>
00505     <span class="comment">//  Note that we are proceeding into the non-constant portion of a directory.</span>
00506     <span class="comment">//</span>
00507     
00508     <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( DirContext-&gt;Flags, DIR_CONTEXT_FLAG_SEEN_NONCONSTANT );
00509     
00510     <span class="comment">//</span>
00511     <span class="comment">//  Make sure the dstring is good CS0</span>
00512     <span class="comment">//</span>
00513     
00514     <a class="code" href="../../d3/d8/udfprocs_8h.html#a182">UdfCheckLegalCS0Dstring</a>( IrpContext,
00515                              NameDstring,
00516                              DirContext-&gt;Fid-&gt;FileIDLen,
00517                              0,
00518                              FALSE );
00519     
00520     <span class="comment">//</span>
00521     <span class="comment">//  Don't bother allocating tiny buffers - always make sure we get enough for an 8.3 name.</span>
00522     <span class="comment">//</span>
00523 
00524     BufferLength =
00525     NameLength = <a class="code" href="../../d3/d8/udfprocs_8h.html#a4">Max</a>( BYTE_COUNT_8_DOT_3, <a class="code" href="../../d3/d8/udfprocs_8h.html#a187">UdfCS0DstringUnicodeSize</a>( IrpContext,
00526                                                                     NameDstring,
00527                                                                     DirContext-&gt;Fid-&gt;FileIDLen) );
00528 
00529     <span class="comment">//</span>
00530     <span class="comment">//  Illegality is both actual illegal characters and too many characters.</span>
00531     <span class="comment">//</span>
00532     
00533     ContainsIllegal = (!<a class="code" href="../../d3/d8/udfprocs_8h.html#a189">UdfCS0DstringContainsLegalCharacters</a>( NameDstring, DirContext-&gt;Fid-&gt;FileIDLen ) ||
00534                        (NameLength / <span class="keyword">sizeof</span>( WCHAR )) &gt; <a class="code" href="../../d9/d7/udf_8h.html#a13">MAX_LEN</a>);
00535 
00536     
00537     <span class="comment">//</span>
00538     <span class="comment">//  If we're illegal, we will need more characters to hold the uniqifying stamp.</span>
00539     <span class="comment">//</span>
00540     
00541     <span class="keywordflow">if</span> (ContainsIllegal) {
00542 
00543         BufferLength = (NameLength += (<a class="code" href="../../d9/d7/udf_8h.html#a15">CRC_LEN</a> * <span class="keyword">sizeof</span>(WCHAR)));
00544     }
00545     
00546     
00547     <span class="comment">//</span>
00548     <span class="comment">//  If we need to build a case insensitive name, need more space.</span>
00549     <span class="comment">//</span>
00550         
00551     <span class="keywordflow">if</span> (IgnoreCase) {
00552 
00553         BufferLength += NameLength;
00554     }
00555     
00556     <span class="comment">//</span>
00557     <span class="comment">//  If we need to render the names due to illegal characters, more space again.</span>
00558     <span class="comment">//</span>
00559         
00560     <span class="keywordflow">if</span> (ContainsIllegal) {
00561 
00562         BufferLength += NameLength;
00563     
00564     } <span class="keywordflow">else</span> {
00565 
00566         <span class="comment">//</span>
00567         <span class="comment">//  Make sure the names aren't seperated. If more illegal names are found we can</span>
00568         <span class="comment">//  resplit the buffer but until then avoid the expense of having to copy bytes</span>
00569         <span class="comment">//  ... odds are that illegal characters are going to be a rarish occurance.</span>
00570         <span class="comment">//</span>
00571         
00572         DirContext-&gt;PureObjectName.Buffer = DirContext-&gt;ObjectName.Buffer;
00573     }
00574 
00575     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( 0, Dbg,
00576                  <span class="stringliteral">"Ob %s%sneeds %d bytes (%d byte chunks), have %d\n"</span>,
00577                  (IgnoreCase? <span class="stringliteral">"Ic "</span> : <span class="stringliteral">""</span>),
00578                  (ContainsIllegal? <span class="stringliteral">"Ci "</span> : <span class="stringliteral">""</span>),
00579                  BufferLength,
00580                  NameLength,
00581                  DirContext-&gt;AllocLength ));
00582 
00583     <span class="comment">//</span>
00584     <span class="comment">//  Check if we need more space for the names.  We will need more if the name size is greater</span>
00585     <span class="comment">//  than the maximum we can currently store, or if we have stumbled across illegal characters</span>
00586     <span class="comment">//  and the current Pure name is not seperated from the exposed Object name.</span>
00587     <span class="comment">//</span>
00588     <span class="comment">//  Note that IgnoreCase remains constant across usage of a context so we don't have to wonder</span>
00589     <span class="comment">//  if it has been seperated from the ObjectName - it'll always be correct.</span>
00590     <span class="comment">//</span>
00591     
00592     <span class="keywordflow">if</span> ((NameLength &gt; DirContext-&gt;ObjectName.MaximumLength) ||
00593         (ContainsIllegal &amp;&amp; DirContext-&gt;ObjectName.Buffer == DirContext-&gt;PureObjectName.Buffer)) {
00594 
00595         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( 0, Dbg, <span class="stringliteral">"Resizing buffers\n"</span> ));
00596         
00597         <span class="comment">//</span>
00598         <span class="comment">//  For some reason the sizing is not good for the current name we have to unroll.  Figure</span>
00599         <span class="comment">//  out if we can break up the current allocation in a different way before falling back</span>
00600         <span class="comment">//  to a new allocation.</span>
00601         <span class="comment">//</span>
00602 
00603         <span class="keywordflow">if</span> (DirContext-&gt;AllocLength &gt;= BufferLength) {
00604 
00605             <span class="comment">//</span>
00606             <span class="comment">//  So we can still use the current allocation.  Chop it up into the required number</span>
00607             <span class="comment">//  of chunks.</span>
00608             <span class="comment">//</span>
00609 
00610             DirContext-&gt;PureObjectName.MaximumLength =
00611             DirContext-&gt;CaseObjectName.MaximumLength =
00612             DirContext-&gt;ObjectName.MaximumLength = DirContext-&gt;AllocLength / (1 +
00613                                                                               (IgnoreCase? 1 : 0) +
00614                                                                               (ContainsIllegal? 1 : 0));
00615 
00616             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( 0, Dbg, 
00617                          <span class="stringliteral">"... by resplit into %d byte chunks\n"</span>,
00618                          DirContext-&gt;ObjectName.MaximumLength ));
00619             
00620             <span class="comment">//</span>
00621             <span class="comment">//  Set the buffer pointers up.  Required adjustment will occur below.</span>
00622             <span class="comment">//</span>
00623                 
00624             DirContext-&gt;PureObjectName.Buffer = 
00625             DirContext-&gt;CaseObjectName.Buffer = 
00626             DirContext-&gt;ObjectName.Buffer = DirContext-&gt;NameBuffer;
00627         
00628         } <span class="keywordflow">else</span> {
00629 
00630             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( 0, Dbg, <span class="stringliteral">"... by allocating new pool\n"</span> ));
00631             
00632             <span class="comment">//</span>
00633             <span class="comment">//  Oh well, no choice but to fall back into the pool.  Drop our previous hunk.</span>
00634             <span class="comment">//</span>
00635             
00636             <a class="code" href="../../d3/d8/udfprocs_8h.html#a124">UdfFreePool</a>( &amp;DirContext-&gt;NameBuffer );
00637             DirContext-&gt;AllocLength = 0;
00638             
00639             <span class="comment">//</span>
00640             <span class="comment">//  The names share an allocation for efficiency.</span>
00641             <span class="comment">//</span>
00642             
00643             DirContext-&gt;PureObjectName.MaximumLength =
00644             DirContext-&gt;CaseObjectName.MaximumLength =
00645             DirContext-&gt;ObjectName.MaximumLength = NameLength;
00646     
00647             DirContext-&gt;NameBuffer =
00648             DirContext-&gt;PureObjectName.Buffer = 
00649             DirContext-&gt;CaseObjectName.Buffer = 
00650             DirContext-&gt;ObjectName.Buffer = <a class="code" href="../../d1/d8/fsrtl_8h.html#a37">FsRtlAllocatePoolWithTag</a>( UdfPagedPool,
00651                                                                       BufferLength,
00652                                                                       TAG_FILE_NAME );
00653 
00654             DirContext-&gt;AllocLength = BufferLength;
00655         }
00656         
00657         <span class="comment">//</span>
00658         <span class="comment">//  In the presence of the "as appropriate" names, adjust the buffer locations.  Note</span>
00659         <span class="comment">//  that ObjectName.Buffer is always the base of the allocated space.</span>
00660         <span class="comment">//</span>
00661         
00662         <span class="keywordflow">if</span> (IgnoreCase) {
00663 
00664             DirContext-&gt;CaseObjectName.Buffer = <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( DirContext-&gt;ObjectName.Buffer, 
00665                                                          DirContext-&gt;ObjectName.MaximumLength,
00666                                                          PWCHAR );
00667         }
00668 
00669         <span class="keywordflow">if</span> (ContainsIllegal) {
00670             
00671             DirContext-&gt;PureObjectName.Buffer = <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( DirContext-&gt;CaseObjectName.Buffer,
00672                                                          DirContext-&gt;CaseObjectName.MaximumLength,
00673                                                          PWCHAR );
00674         }
00675     }
00676 
00677     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( BufferLength &lt;= DirContext-&gt;AllocLength );
00678 
00679     <span class="comment">//</span>
00680     <span class="comment">//  Convert the dstring.</span>
00681     <span class="comment">//</span>
00682     
00683     <a class="code" href="../../d3/d8/udfprocs_8h.html#a181">UdfConvertCS0DstringToUnicode</a>( IrpContext,
00684                                    NameDstring,
00685                                    DirContext-&gt;Fid-&gt;FileIDLen,
00686                                    0,
00687                                    &amp;DirContext-&gt;PureObjectName );
00688 
00689     <span class="comment">//</span>
00690     <span class="comment">//  If illegal characters were present, run the name through the UDF transmogrifier.</span>
00691     <span class="comment">//</span>
00692 
00693     <span class="keywordflow">if</span> (ContainsIllegal) {
00694 
00695         <a class="code" href="../../d3/d8/udfprocs_8h.html#a183">UdfRenderNameToLegalUnicode</a>( IrpContext,
00696                                      &amp;DirContext-&gt;PureObjectName,
00697                                      &amp;DirContext-&gt;ObjectName );
00698 
00699     <span class="comment">//</span>
00700     <span class="comment">//  The ObjectName is the same as the PureObjectName.</span>
00701     <span class="comment">//</span>
00702 
00703     } <span class="keywordflow">else</span> {
00704 
00705         DirContext-&gt;ObjectName.Length = DirContext-&gt;PureObjectName.Length;
00706     }
00707 
00708     <span class="comment">//</span>
00709     <span class="comment">//  Upcase the result if required.</span>
00710     <span class="comment">//</span>
00711 
00712     <span class="keywordflow">if</span> (IgnoreCase) {
00713 
00714         <a class="code" href="../../d3/d8/udfprocs_8h.html#a186">UdfUpcaseName</a>( IrpContext,
00715                        &amp;DirContext-&gt;ObjectName,
00716                        &amp;DirContext-&gt;CaseObjectName );
00717     }
00718 
00719     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( -1, Dbg, <span class="stringliteral">"UdfUpdateDirNames -&gt; VOID\n"</span> ));
00720     
00721     <span class="keywordflow">return</span>;
00722 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a226" doxytag="udfprocs.h::UdfUpdateTimestampsFromIcbContext" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID UdfUpdateTimestampsFromIcbContext           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d9/d9/struct__ICB__SEARCH__CONTEXT.html">PICB_SEARCH_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IcbContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d4/d1/struct__TIMESTAMP__BUNDLE.html">PTIMESTAMP_BUNDLE</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Timestamps</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l03595">3595</a> of file <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html">udfs/strucsup.c</a>.
<p>
References <a class="el" href="../../d1/d6/iso13346_8h-source.html#l00947">ICBFILE::AccessTime</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00352">ASSERT_IRP_CONTEXT</a>, <a class="el" href="../../d1/d6/iso13346_8h-source.html#l00936">ICBFILE::Destag</a>, <a class="el" href="../../d1/d6/iso13346_8h-source.html#l00339">DESTAG_ID_NSR_FILE</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01564">_EA_SEARCH_CONTEXT::Ea</a>, <a class="el" href="../../d1/d6/iso13346_8h-source.html#l01054">EA_FILETIMES_E_CREATION</a>, <a class="el" href="../../d1/d6/iso13346_8h-source.html#l01066">EA_INFOTIMES_E_CREATION</a>, <a class="el" href="../../d1/d6/iso13346_8h-source.html#l01067">EA_INFOTIMES_E_MODIFICATION</a>, <a class="el" href="../../d1/d6/iso13346_8h-source.html#l01029">EA_SUBTYPE_BASE</a>, <a class="el" href="../../d1/d6/iso13346_8h-source.html#l01023">EA_TYPE_FILETIMES</a>, <a class="el" href="../../d1/d6/iso13346_8h-source.html#l01024">EA_TYPE_INFOTIMES</a>, <a class="el" href="../../d1/d6/iso13346_8h-source.html#l01046">NSR_EA_FILETIMES::Existence</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d1/d6/iso13346_8h-source.html#l00304">DESTAG::Ident</a>, <a class="el" href="../../d1/d6/iso13346_8h-source.html#l00948">ICBFILE::ModifyTime</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d0/d7/iso13346_8h.html#a252">PNSR_EA_FILETIMES</a>, <a class="el" href="../../d6/d8/udfstruc_8h.html#a57">PTIMESTAMP_BUNDLE</a>, <a class="el" href="../../d1/d6/iso13346_8h-source.html#l01047">NSR_EA_FILETIMES::Stamps</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01921">UdfConvertUdfTimeToNtTime()</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l03221">UdfInitializeEaContext()</a>, and <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l03278">UdfLookupEa()</a>.
<p>
Referenced by <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l02297">UdfInitializeFcbFromIcbContext()</a>, and <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l00334">UdfQueryDirectory()</a>.
<p>
<pre class="fragment"><div>03603                    :
03604 
03605     This routine converts <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> set of timestamps associated with a given ICB into
03606     an NT native form.
03607 
03608 Arguments:
03609 
03610     IcbOontext - An search context containing <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> active direct ICB <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object
03611     
03612     Timestamps - <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> bundle of timestamps to receive <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> converted times.
03613 
03614 Return Value:
03615 
03616     None.
03617 
03618 --*/
03619 
03620 {
03621     <a class="code" href="../../d6/d1/struct__EA__SEARCH__CONTEXT.html">EA_SEARCH_CONTEXT</a> EaContext;
03622     <a class="code" href="../../d8/d0/structICBFILE.html">PICBFILE</a> Icb;
03623 
03624     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
03625 
03626     <span class="comment">//</span>
03627     <span class="comment">//  Check inputs</span>
03628     <span class="comment">//</span>
03629 
03630     <a class="code" href="../../d1/d8/udfdata_8h.html#a28">ASSERT_IRP_CONTEXT</a>( IrpContext );
03631 
03632     <span class="comment">//</span>
03633     <span class="comment">//  Directly reference for convenience.</span>
03634     <span class="comment">//</span>
03635 
03636     Icb = IcbContext-&gt;Active.View;
03637 
03638     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( Icb-&gt;<a class="code" href="../../d8/d0/structICBFILE.html#o0">Destag</a>.<a class="code" href="../../d7/d7/structDESTAG.html#o0">Ident</a> == DESTAG_ID_NSR_FILE );
03639 
03640     <span class="comment">//</span>
03641     <span class="comment">//  Initialize the timestamps for this object.  Due to basic idiocy in ISO 13346,</span>
03642     <span class="comment">//  we must gather EAs and figure out which of several timestamps is most valid.</span>
03643     <span class="comment">//</span>
03644 
03645     <span class="comment">//</span>
03646     <span class="comment">//  Begin by using the fields in the ICB itself.</span>
03647     <span class="comment">//</span>
03648 
03649     <a class="code" href="../../d3/d8/udfprocs_8h.html#a228">UdfConvertUdfTimeToNtTime</a>( IrpContext,
03650                                &amp;Icb-&gt;<a class="code" href="../../d8/d0/structICBFILE.html#o12">ModifyTime</a>,
03651                                (PLARGE_INTEGER) &amp;Timestamps-&gt;ModificationTime );
03652 
03653     Timestamps-&gt;CreationTime = Timestamps-&gt;ModificationTime;
03654 
03655     <a class="code" href="../../d3/d8/udfprocs_8h.html#a228">UdfConvertUdfTimeToNtTime</a>( IrpContext,
03656                                &amp;Icb-&gt;<a class="code" href="../../d8/d0/structICBFILE.html#o11">AccessTime</a>,
03657                                (PLARGE_INTEGER) &amp;Timestamps-&gt;AccessTime );
03658 
03659     <span class="comment">//</span>
03660     <span class="comment">//  Gather the File Times and Information Times EAs for this object, if they exist,</span>
03661     <span class="comment">//  and set the timestamps.  Just override timestamps if they exist.</span>
03662     <span class="comment">//</span>
03663 
03664     <a class="code" href="../../d9/d7/udfs_2strucsup_8c.html#a26">UdfInitializeEaContext</a>( IrpContext,
03665                             &amp;EaContext,
03666                             IcbContext,
03667                             EA_TYPE_FILETIMES,
03668                             EA_SUBTYPE_BASE );
03669 
03670     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d7/udfs_2strucsup_8c.html#a27">UdfLookupEa</a>( IrpContext, &amp;EaContext )) {
03671 
03672         <a class="code" href="../../d8/d1/structNSR__EA__FILETIMES.html">PNSR_EA_FILETIMES</a> FileTimes = EaContext.<a class="code" href="../../d6/d1/struct__EA__SEARCH__CONTEXT.html#o1">Ea</a>;
03673     
03674         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>(FileTimes-&gt;<a class="code" href="../../d8/d1/structNSR__EA__FILETIMES.html#o5">Existence</a>, EA_FILETIMES_E_CREATION)) {
03675 
03676             <a class="code" href="../../d3/d8/udfprocs_8h.html#a228">UdfConvertUdfTimeToNtTime</a>( IrpContext,
03677                                        &amp;FileTimes-&gt;<a class="code" href="../../d8/d1/structNSR__EA__FILETIMES.html#o6">Stamps</a>[0],
03678                                        (PLARGE_INTEGER) &amp;Timestamps-&gt;CreationTime );
03679         }
03680     }
03681 
03682     <a class="code" href="../../d9/d7/udfs_2strucsup_8c.html#a26">UdfInitializeEaContext</a>( IrpContext,
03683                             &amp;EaContext,
03684                             IcbContext,
03685                             EA_TYPE_INFOTIMES,
03686                             EA_SUBTYPE_BASE );
03687 
03688     <span class="keywordflow">if</span> (<a class="code" href="../../d9/d7/udfs_2strucsup_8c.html#a27">UdfLookupEa</a>( IrpContext, &amp;EaContext )) {
03689 
03690         <a class="code" href="../../d8/d1/structNSR__EA__FILETIMES.html">PNSR_EA_FILETIMES</a> InfoTimes = EaContext.<a class="code" href="../../d6/d1/struct__EA__SEARCH__CONTEXT.html#o1">Ea</a>;
03691         BOOLEAN CreationPresent = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
03692 
03693         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>(InfoTimes-&gt;<a class="code" href="../../d8/d1/structNSR__EA__FILETIMES.html#o5">Existence</a>, EA_INFOTIMES_E_CREATION)) {
03694 
03695             <a class="code" href="../../d3/d8/udfprocs_8h.html#a228">UdfConvertUdfTimeToNtTime</a>( IrpContext,
03696                                        &amp;InfoTimes-&gt;<a class="code" href="../../d8/d1/structNSR__EA__FILETIMES.html#o6">Stamps</a>[0],
03697                                        (PLARGE_INTEGER) &amp;Timestamps-&gt;CreationTime );
03698 
03699             CreationPresent = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
03700         }
03701 
03702         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>(InfoTimes-&gt;<a class="code" href="../../d8/d1/structNSR__EA__FILETIMES.html#o5">Existence</a>, EA_INFOTIMES_E_MODIFICATION)) {
03703 
03704             <a class="code" href="../../d3/d8/udfprocs_8h.html#a228">UdfConvertUdfTimeToNtTime</a>( IrpContext,
03705                                        &amp;InfoTimes-&gt;<a class="code" href="../../d8/d1/structNSR__EA__FILETIMES.html#o6">Stamps</a>[CreationPresent? 1: 0],
03706                                        (PLARGE_INTEGER) &amp;Timestamps-&gt;CreationTime );
03707         }
03708     }
03709 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a204" doxytag="udfprocs.h::UdfUpdateVcbPhase0" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID UdfUpdateVcbPhase0           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT <a class="el" href="../../d7/d5/struct__VCB.html">PVCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Vcb</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l00477">477</a> of file <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html">udfs/strucsup.c</a>.
<p>
References <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01527">_ICB_SEARCH_CONTEXT::Active</a>, <a class="el" href="../../d1/d6/iso13346_8h-source.html#l00361">ANCHOR_SECTOR</a>, <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00352">ASSERT_IRP_CONTEXT</a>, <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00336">ASSERT_VCB</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00276">BlocksFromSectors</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00278">BlockSize</a>, <a class="el" href="../../d3/d8/pinsup_8c-source.html#l00052">CcMapData()</a>, <a class="el" href="../../d6/d7/fssup_8c-source.html#l02331">CcPurgeCacheSection()</a>, <a class="el" href="../../d6/d7/fssup_8c-source.html#l01821">CcSetFileSizes()</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d9/d2/lfsdata_8h-source.html#l00187">DebugUnwind</a>, <a class="el" href="../../d1/d6/iso13346_8h-source.html#l00339">DESTAG_ID_NSR_FILE</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01061">FCB_STATE_INITIALIZED</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01063">FCB_STATE_VMCB_MAPPING</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01101">FsRtlAllocatePoolWithTag</a>, <a class="el" href="../../d6/d8/udfstruc_8h.html#a104">ICB_SEARCH_CONTEXT</a>, <a class="el" href="../../d1/d6/iso13346_8h-source.html#l00864">ICBTAG_FILE_T_NOTSPEC</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01494">_MAPPED_PVIEW::Lbn</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00220">LlBytesFromSectors</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00200">LlSectorAlign</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00160">LongOffset</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d5/d8/heapdbg_8c-source.html#l00033">Offset</a>, <a class="el" href="../../d0/d7/udf_8h-source.html#l00307">OSCLASS_INVALID</a>, <a class="el" href="../../d0/d7/udf_8h-source.html#l00308">OSIDENTIFIER_INVALID</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01493">_MAPPED_PVIEW::Partition</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00444">PCB_FLAG_VIRTUAL_PARTITION</a>, <a class="el" href="../../d0/d7/iso13346_8h.html#a198">PDESTAG</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00746">PFILE_ID</a>, <a class="el" href="../../d6/d8/udfstruc_8h.html#a129a115">Physical</a>, <a class="el" href="../../d0/d7/iso13346_8h.html#a246">PICBFILE</a>, <a class="el" href="../../d0/d7/iso13346_8h.html#a172">PREGID</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00230">SectorSize</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00505">SetFlag</a>, <a class="el" href="../../d2/d6/udfs_2nodetype_8h-source.html#l00179">TAG_NSR_VDSD</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d0/d7/udf_8h-source.html#l00396">UDF_CDUDF_MAXIMUM_VAT_SIZE</a>, <a class="el" href="../../d0/d7/udf_8h-source.html#l00395">UDF_CDUDF_MINIMUM_VAT_SIZE</a>, <a class="el" href="../../d0/d7/udf_8h-source.html#l00393">UDF_CDUDF_TRAILING_DATA_SIZE</a>, <a class="el" href="../../d0/d7/udf_8h-source.html#l00141">UDF_VERSION_150</a>, <a class="el" href="../../d0/d7/udf_8h-source.html#l00143">UDF_VERSION_RECOGNIZED</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l03183">UdfCleanupIcbContext()</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l02041">UdfCreateFcb()</a>, <a class="el" href="../../d9/d1/udfs_2cachesup_8c-source.html#l00046">UdfCreateInternalStream()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01762">UdfIncrementReferenceCounts</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l03388">UdfInitializeAllocations()</a>, <a class="el" href="../../d7/d5/vmcbsup_8c-source.html#l00219">UdfInitializeVmcb()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01567">UdfLockFcb</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01559">UdfLockVcb</a>, <a class="el" href="../../d3/d5/allocsup_8c-source.html#l01177">UdfLookupMetaVsnOfExtent()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00443">UdfPagedPool</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00406">UdfRaiseStatus()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00931">UdfRawBufferSize()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00941">UdfRawReadSize()</a>, <a class="el" href="../../d4/d6/deviosup_8c-source.html#l00685">UdfReadSectors()</a>, <a class="el" href="../../d7/d5/vmcbsup_8c-source.html#l00370">UdfResetVmcb()</a>, <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00055">UDFS_CDUDF_RESIDUAL_REFERENCE</a>, <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00056">UDFS_CDUDF_RESIDUAL_USER_REFERENCE</a>, <a class="el" href="../../d2/d6/udfs_2nodetype_8h-source.html#l00037">UDFS_NTC_FCB_INDEX</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l02060">UdfUdfIdentifierContained()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01577">UdfUnlockFcb</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01563">UdfUnlockVcb</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00838">UdfUnpinData</a>, <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00125">UdfVatTableIdentifier</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l02617">UdfVerifyDescriptor()</a>, <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01486">_MAPPED_PVIEW::View</a>, and <a class="el" href="../../d6/d8/alpha_2exdsptch_8c-source.html#l00105">Virtual</a>.
<p>
Referenced by <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l01444">UdfMountVolume()</a>.
<p>
<pre class="fragment"><div>00484                    :
00485 
00486     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called to perform <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> initial spinup of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> volume so that
00487     we can <span class="keywordflow">do</span> reads into <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>.  Primarily, <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> required since <span class="keyword">virtual</span> partitions
00488     make us lift <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> remapping table, and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">final</span> sets of descriptors from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> volume
00489     can be off in these <span class="keyword">virtual</span> partitions.
00490     
00491     So, we need to get everything set up to read.
00492 
00493 Arguments:
00494 
00495     Vcb - Vcb <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> volume being mounted.  We have already set up and completed
00496         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Pcb.
00497 
00498 Return Value:
00499 
00500     None
00501 
00502 --*/
00503 
00504 {
00505     <a class="code" href="../../d9/d9/struct__ICB__SEARCH__CONTEXT.html">ICB_SEARCH_CONTEXT</a> IcbContext;
00506 
00507     LONGLONG FileId = 0;
00508 
00509     <a class="code" href="../../d8/d0/structICBFILE.html">PICBFILE</a> VatIcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00510     <a class="code" href="../../d6/d6/structREGID.html">PREGID</a> RegId;
00511     ULONG ThisPass;
00512     ULONG Psn;
00513     ULONG Vsn;
00514     ULONG Lbn;
00515     ULONG SectorCount;
00516     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> Reference;
00517 
00518     BOOLEAN UnlockVcb = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00519     BOOLEAN CleanupIcbContext = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00520 
00521     <a class="code" href="../../d4/d3/struct__BCB.html">PBCB</a> Bcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00522     LARGE_INTEGER <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>;
00523 
00524     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00525 
00526     <span class="comment">//</span>
00527     <span class="comment">//  Check input.</span>
00528     <span class="comment">//</span>
00529 
00530     <a class="code" href="../../d1/d8/udfdata_8h.html#a28">ASSERT_IRP_CONTEXT</a>( IrpContext );
00531     <a class="code" href="../../d1/d8/udfdata_8h.html#a12">ASSERT_VCB</a>( Vcb );
00532 
00533     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( +1, Dbg, <span class="stringliteral">"UdfUpdateVcbPhase0, Vcb %08x\n"</span>, Vcb ));
00534 
00535     <span class="keywordflow">try</span> {
00536         
00538         <span class="comment">//</span>
00539         <span class="comment">//  Create the Metadata Fcb and refererence it and the Vcb.</span>
00540         <span class="comment">//</span>
00542 <span class="comment"></span>
00543         <a class="code" href="../../d3/d8/udfprocs_8h.html#a88">UdfLockVcb</a>( IrpContext, Vcb );
00544         UnlockVcb = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00545 
00546         Vcb-&gt;MetadataFcb = <a class="code" href="../../d3/d8/udfprocs_8h.html#a213">UdfCreateFcb</a>( IrpContext,
00547                                          *((PFILE_ID) &amp;FileId),
00548                                          UDFS_NTC_FCB_INDEX,
00549                                          NULL );
00550 
00551         <a class="code" href="../../d3/d8/udfprocs_8h.html#a98">UdfIncrementReferenceCounts</a>( IrpContext, Vcb-&gt;MetadataFcb, 1, 1 );
00552         <a class="code" href="../../d3/d8/udfprocs_8h.html#a89">UdfUnlockVcb</a>( IrpContext, Vcb );
00553         UnlockVcb = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00554 
00555         <span class="comment">//</span>
00556         <span class="comment">//  The metadata stream is grown lazily as we reference disk structures.</span>
00557         <span class="comment">//</span>
00558 
00559         Vcb-&gt;MetadataFcb-&gt;FileSize.QuadPart =
00560         Vcb-&gt;MetadataFcb-&gt;ValidDataLength.QuadPart = 
00561         Vcb-&gt;MetadataFcb-&gt;AllocationSize.QuadPart = 0;
00562 
00563         <span class="comment">//</span>
00564         <span class="comment">//  Initialize the volume Vmcb</span>
00565         <span class="comment">//</span>
00566 
00567         <a class="code" href="../../d3/d8/udfprocs_8h.html#a90">UdfLockFcb</a>( IrpContext, Vcb-&gt;MetadataFcb );
00568 
00569         <a class="code" href="../../d6/d6/vmcbsup_8c.html#a5">UdfInitializeVmcb</a>( &amp;Vcb-&gt;Vmcb,
00570                            UdfPagedPool,
00571                            MAXULONG,
00572                            <a class="code" href="../../d3/d8/udfprocs_8h.html#a42">SectorSize</a>(Vcb) );
00573 
00574         <a class="code" href="../../d3/d8/udfprocs_8h.html#a91">UdfUnlockFcb</a>( IrpContext, Vcb-&gt;MetadataFcb );
00575 
00576         <span class="comment">//</span>
00577         <span class="comment">//  Point to the file resource and set the flag that will cause mappings</span>
00578         <span class="comment">//  to go through the Vmcb</span>
00579         <span class="comment">//</span>
00580 
00581         Vcb-&gt;MetadataFcb-&gt;Resource = &amp;Vcb-&gt;FileResource;
00582 
00583         <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( Vcb-&gt;MetadataFcb-&gt;FcbState, FCB_STATE_VMCB_MAPPING | FCB_STATE_INITIALIZED );
00584 
00585         <span class="comment">//</span>
00586         <span class="comment">//  Create the stream file for this.</span>
00587         <span class="comment">//</span>
00588 
00589         <a class="code" href="../../d3/d8/udfprocs_8h.html#a154">UdfCreateInternalStream</a>( IrpContext, Vcb, Vcb-&gt;MetadataFcb );
00590 
00592         <span class="comment">//</span>
00593         <span class="comment">//  If this is a volume containing a virtual partition, set up the</span>
00594         <span class="comment">//  Virtual Allocation Table Fcb and adjust the residual reference</span>
00595         <span class="comment">//  counts comensurately.</span>
00596         <span class="comment">//</span>
00598 <span class="comment"></span>
00599         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Vcb-&gt;Pcb-&gt;Flags, PCB_FLAG_VIRTUAL_PARTITION )) {
00600 
00601             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( 0, Dbg, <span class="stringliteral">"UdfUpdateVcbPhase0, handling VAT setup\n"</span> ));
00602 
00603             <span class="comment">//</span>
00604             <span class="comment">//  Now if some dummy has stuck us in the situation of not giving us</span>
00605             <span class="comment">//  the tools to figure out where the end of the media is, tough luck.</span>
00606             <span class="comment">//</span>
00607 
00608             <span class="keywordflow">if</span> (!Vcb-&gt;BoundN || Vcb-&gt;BoundN &lt; <a class="code" href="../../d0/d7/iso13346_8h.html#a63">ANCHOR_SECTOR</a>) {
00609 
00610                 <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( 0, Dbg, <span class="stringliteral">"UdfUpdateVcbPhase0, no end bound was discoverable!\n"</span> ));
00611 
00612                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a122">UdfRaiseStatus</a>( IrpContext, STATUS_UNRECOGNIZED_VOLUME );
00613             }
00614 
00615             <span class="comment">//</span>
00616             <span class="comment">//  We take care of this first since the residuals must be in place</span>
00617             <span class="comment">//  if we raise while finding the VAT, else we will get horribly</span>
00618             <span class="comment">//  confused when the in-progress references are seen.  We will think</span>
00619             <span class="comment">//  that the extra real referenes are indications that the volume can't</span>
00620             <span class="comment">//  be dismounted.</span>
00621             <span class="comment">//</span>
00622             
00623             Vcb-&gt;VcbResidualReference += <a class="code" href="../../d1/d8/udfdata_8h.html#a2">UDFS_CDUDF_RESIDUAL_REFERENCE</a>;
00624             Vcb-&gt;VcbResidualUserReference += <a class="code" href="../../d1/d8/udfdata_8h.html#a3">UDFS_CDUDF_RESIDUAL_USER_REFERENCE</a>;
00625 
00626             Vcb-&gt;VcbReference += <a class="code" href="../../d1/d8/udfdata_8h.html#a2">UDFS_CDUDF_RESIDUAL_REFERENCE</a>;
00627 
00628             <span class="comment">//</span>
00629             <span class="comment">//  Now, we need to hunt about for the VAT ICB.  This is defined, on</span>
00630             <span class="comment">//  closed media (meaning that the sessions have been finalized for use</span>
00631             <span class="comment">//  in CDROM drives), to be in the very last information sector on the</span>
00632             <span class="comment">//  media.  Complicating this simple picture is that CDROMs tell us the</span>
00633             <span class="comment">//  "last sector" by telling us where the start of the leadout area is,</span>
00634             <span class="comment">//  not where the end of the informational sectors are.  This is an</span>
00635             <span class="comment">//  important distinction because any combination of the following can</span>
00636             <span class="comment">//  be used in closing a CDROM session: 2 runout sectors, and/or 150</span>
00637             <span class="comment">//  sectors (2 seconds) of postgap, or nothing.  Immediately after these</span>
00638             <span class="comment">//  "closing" writes is where the leadout begins.</span>
00639             <span class="comment">//</span>
00640             <span class="comment">//  Runout is usually found on CD-E media and corresponds to the time it</span>
00641             <span class="comment">//  will take to turn the writing laser off.  Postgap is what is used to</span>
00642             <span class="comment">//  generate audio pauses.  It is easy to see that the kind of media and</span>
00643             <span class="comment">//  kind of mastering tool/system used will affect us here.  There is no</span>
00644             <span class="comment">//  way to know either ahead of time.</span>
00645             <span class="comment">//</span>
00646             <span class="comment">//  So, finally, these are the offsets from our previously discovered</span>
00647             <span class="comment">//  bounding information where we might find the last information sector:</span>
00648             <span class="comment">//</span>
00649             <span class="comment">//          -152    runout + postgap</span>
00650             <span class="comment">//          -150    postgap</span>
00651             <span class="comment">//          -2      runout</span>
00652             <span class="comment">//          0       nothing</span>
00653             <span class="comment">//</span>
00654             <span class="comment">//  We must search these from low to high since it is extrememly expensive</span>
00655             <span class="comment">//  to guess wrong - CDROMs will sit there for tens of seconds trying to</span>
00656             <span class="comment">//  read unwritten/unreadable sectors.  Hopefully we will find the VAT</span>
00657             <span class="comment">//  ICB beforehand.</span>
00658             <span class="comment">//</span>
00659             <span class="comment">//  This should all be highly disturbing.</span>
00660             <span class="comment">//</span>
00661 
00662             VatIcb = <a class="code" href="../../d1/d8/fsrtl_8h.html#a37">FsRtlAllocatePoolWithTag</a>( UdfPagedPool,
00663                                                <a class="code" href="../../d3/d8/udfprocs_8h.html#a163">UdfRawBufferSize</a>( Vcb, <a class="code" href="../../d3/d8/udfprocs_8h.html#a54">BlockSize</a>( Vcb )),
00664                                                TAG_NSR_VDSD);
00665 
00666             <span class="keywordflow">for</span> (ThisPass = 0; ThisPass &lt; 4; ThisPass++) {
00667 
00668                 <span class="comment">//</span>
00669                 <span class="comment">//  Lift the appropriate sector.  The discerning reader will be confused that</span>
00670                 <span class="comment">//  this is done in sector terms, not block.  So is the implementor.</span>
00671                 <span class="comment">//</span>
00672                 
00673                 Psn = Vcb-&gt;BoundN - ( ThisPass == 0? 152 :
00674                                     ( ThisPass == 1? 150 :
00675                                     ( ThisPass == 2? 2 : 0 )));
00676 
00677                 <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( 0, Dbg, <span class="stringliteral">"UdfUpdateVcbPhase0, looking at Psn 0x%08x\n"</span>, Psn ));
00678 
00679                 <span class="comment">//</span>
00680                 <span class="comment">//  Now, try to figure out what physical partition this sector lives in so</span>
00681                 <span class="comment">//  that we can eventually establish workable metadata mappings to it and</span>
00682                 <span class="comment">//  dereference short allocation descriptors it may use.</span>
00683                 <span class="comment">//</span>
00684 
00685                 <span class="keywordflow">for</span> (Reference = 0;
00686                      Reference &lt; Vcb-&gt;Pcb-&gt;Partitions;
00687                      Reference++) {
00688     
00689                     <span class="keywordflow">if</span> (Vcb-&gt;Pcb-&gt;Partition[Reference].Type == <a class="code" href="../../d6/d8/udfstruc_8h.html#a129a115">Physical</a> &amp;&amp;
00690                         Vcb-&gt;Pcb-&gt;Partition[Reference].Physical.Start &lt;= Psn &amp;&amp;
00691                         Vcb-&gt;Pcb-&gt;Partition[Reference].Physical.Start +
00692                         Vcb-&gt;Pcb-&gt;Partition[Reference].Physical.Length &gt; Psn) {
00693     
00694                         <span class="keywordflow">break</span>;
00695                     }
00696                 }
00697                 
00698                 <span class="comment">//</span>
00699                 <span class="comment">//  If this sector is not contained in a partition, we do not</span>
00700                 <span class="comment">//  need to look at it.</span>
00701                 <span class="comment">//</span>
00702                 
00703                 <span class="keywordflow">if</span> (Reference == Vcb-&gt;Pcb-&gt;Partitions) {
00704                     
00705                     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( 0, Dbg, <span class="stringliteral">"UdfUpdateVcbPhase0, ... but it isn't in a partition.\n"</span> ));
00706 
00707                     <span class="keywordflow">continue</span>;
00708                 }
00709                 
00710                 <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( 0, Dbg, <span class="stringliteral">"UdfUpdateVcbPhase0, ... in partition Ref %u.\n"</span>,  Reference ));
00711 
00712                 <span class="comment">//</span>
00713                 <span class="comment">//  We must locate the Lbn of this Psn by figuring out the offset of it</span>
00714                 <span class="comment">//  in the partition we already know that it is recorded in.</span>
00715                 <span class="comment">//</span>
00716                 
00717                 Lbn = <a class="code" href="../../d3/d8/udfprocs_8h.html#a53">BlocksFromSectors</a>( Vcb, Psn - Vcb-&gt;Pcb-&gt;Partition[Reference].Physical.Start );
00718 
00719                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( <a class="code" href="../../d3/d8/udfprocs_8h.html#a160">UdfReadSectors</a>( IrpContext,
00720                                                  <a class="code" href="../../d3/d8/udfprocs_8h.html#a39">LlBytesFromSectors</a>( Vcb, Psn ),
00721                                                  <a class="code" href="../../d3/d8/udfprocs_8h.html#a164">UdfRawReadSize</a>( Vcb, <a class="code" href="../../d3/d8/udfprocs_8h.html#a54">BlockSize</a>( Vcb )),
00722                                                  TRUE,
00723                                                  VatIcb,
00724                                                  Vcb-&gt;TargetDeviceObject ))) {
00725                     
00726                     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( 0, Dbg, <span class="stringliteral">"UdfUpdateVcbPhase0, ... but couldn't read it.\n"</span> ));
00727 
00728                     <span class="keywordflow">continue</span>;
00729                 }
00730 
00731                 <span class="comment">//</span>
00732                 <span class="comment">//  First make sure this looks vageuly like a file entry.</span>
00733                 <span class="comment">//</span>
00734                 
00735                 <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d8/udfprocs_8h.html#a219">UdfVerifyDescriptor</a>( IrpContext,
00736                                           (<a class="code" href="../../d7/d7/structDESTAG.html">PDESTAG</a>) VatIcb,
00737                                           DESTAG_ID_NSR_FILE,
00738                                           <a class="code" href="../../d3/d8/udfprocs_8h.html#a54">BlockSize</a>( Vcb ),
00739                                           Lbn,
00740                                           TRUE )) {
00741                     
00742                     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( 0, Dbg, <span class="stringliteral">"UdfUpdateVcbPhase0, ... but it didn't verify.\n"</span> ));
00743 
00744                     <span class="keywordflow">continue</span>;
00745                 }
00746 
00747                 <span class="comment">//</span>
00748                 <span class="comment">//  Make sure this is a NOTSPEC object.  We can also presume that a VAT isn't</span>
00749                 <span class="comment">//  linked into any directory, so it would be surprising if the link count was</span>
00750                 <span class="comment">//  nonzero.</span>
00751                 <span class="comment">//</span>
00752 
00753                 <span class="keywordflow">if</span> (VatIcb-&gt;Icbtag.FileType != <a class="code" href="../../d0/d7/iso13346_8h.html#a98">ICBTAG_FILE_T_NOTSPEC</a> ||
00754                     VatIcb-&gt;LinkCount) {
00755 
00756                     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( 0, Dbg, <span class="stringliteral">"UdfUpdateVcbPhase0, ... but the type/linkcount is wrong.\n"</span> ));
00757 
00758                     <span class="keywordflow">continue</span>;
00759                 }
00760 
00761                 <span class="comment">//</span>
00762                 <span class="comment">//  The VAT must be at least large enough to contain the required information and</span>
00763                 <span class="comment">//  be a multiple of 4byte elements in length.  We also have defined a sanity upper</span>
00764                 <span class="comment">//  bound beyond which we never expect to see a VAT go.</span>
00765                 <span class="comment">//</span>
00766 
00767                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( !<a class="code" href="../../d3/d8/udfprocs_8h.html#a24">LongOffset</a>( UDF_CDUDF_MINIMUM_VAT_SIZE ));
00768             
00769                 <span class="keywordflow">if</span> (VatIcb-&gt;InfoLength &lt; <a class="code" href="../../d9/d7/udf_8h.html#a57">UDF_CDUDF_MINIMUM_VAT_SIZE</a> ||
00770                     VatIcb-&gt;InfoLength &gt; <a class="code" href="../../d9/d7/udf_8h.html#a58">UDF_CDUDF_MAXIMUM_VAT_SIZE</a> ||
00771                     <a class="code" href="../../d3/d8/udfprocs_8h.html#a24">LongOffset</a>( VatIcb-&gt;InfoLength )) {
00772                 
00773                     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( 0, Dbg, <span class="stringliteral">"UdfUpdateVcbPhase0, ... but the size looks pretty bogus.\n"</span> ));
00774 
00775                     <span class="keywordflow">continue</span>;
00776                 }
00777 
00778                 <span class="comment">//</span>
00779                 <span class="comment">//  At this point we have to take a wild guess that this will be the guy.  Since the only</span>
00780                 <span class="comment">//  way to be sure is to look at the very end of the file an look for the regid, we've got</span>
00781                 <span class="comment">//  to go map this thing.</span>
00782                 <span class="comment">//</span>
00783             
00784                 <span class="comment">//</span>
00785                 <span class="comment">//  This is pretty ugly, but we have to cobble this maybe-Icb into the metadata stream</span>
00786                 <span class="comment">//  so that initialization/use is possible (embedded data!).  Normally regular Icb searches</span>
00787                 <span class="comment">//  would have done this for us, but since we have to go through such an amusing search</span>
00788                 <span class="comment">//  procedure that isn't possible.  So, add it as a single sector mapping.</span>
00789                 <span class="comment">//</span>
00790                 <span class="comment">//  Since this lives in a partition, we can just do the "lookup" in the metadata stream.</span>
00791                 <span class="comment">//  If we did not have this guarantee, we'd need to do a bit more of this by hand.</span>
00792                 <span class="comment">//</span>
00793                 <span class="comment">//  As this is at mount time, we are very sure we are the only person messing with the</span>
00794                 <span class="comment">//  metadata stream.</span>
00795                 <span class="comment">//</span>
00796     
00797                 <span class="comment">//</span>
00798                 <span class="comment">//  Zap the previous mapping and invalidate the metadata and VAT stream content.</span>
00799                 <span class="comment">//</span>
00800                 
00801                 <span class="keywordflow">if</span> (Vcb-&gt;VatFcb) {
00802                 
00803                     <a class="code" href="../../d6/d6/vmcbsup_8c.html#a7">UdfResetVmcb</a>( &amp;Vcb-&gt;Vmcb );
00804 
00805                     <a class="code" href="../../d3/d8/udfprocs_8h.html#a69">UdfUnpinData</a>( IrpContext, &amp;Bcb );
00806 
00807                     <a class="code" href="../../d4/d2/cache_8h.html#a61">CcPurgeCacheSection</a>( Vcb-&gt;MetadataFcb-&gt;FileObject-&gt;SectionObjectPointer,
00808                                          NULL,
00809                                          0,
00810                                          FALSE );
00811                     
00812                     <a class="code" href="../../d4/d2/cache_8h.html#a61">CcPurgeCacheSection</a>( Vcb-&gt;VatFcb-&gt;FileObject-&gt;SectionObjectPointer,
00813                                          NULL,
00814                                          0,
00815                                          FALSE );
00816                 }
00817 
00818                 Vsn = <a class="code" href="../../d3/d8/udfprocs_8h.html#a153">UdfLookupMetaVsnOfExtent</a>( IrpContext,
00819                                                 Vcb,
00820                                                 Reference,
00821                                                 Lbn,
00822                                                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a54">BlockSize</a>( Vcb ),
00823                                                 TRUE );
00824                 
00825                 <span class="keywordflow">if</span> (Vcb-&gt;VatFcb == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00826                     
00827                     <span class="comment">//</span>
00828                     <span class="comment">//  Now stamp out the Fcb.</span>
00829                     <span class="comment">//</span>
00830         
00831                     <a class="code" href="../../d3/d8/udfprocs_8h.html#a88">UdfLockVcb</a>( IrpContext, Vcb );
00832                     UnlockVcb = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00833         
00834                     Vcb-&gt;VatFcb = <a class="code" href="../../d3/d8/udfprocs_8h.html#a213">UdfCreateFcb</a>( IrpContext,
00835                                                 *((PFILE_ID) &amp;FileId),
00836                                                 UDFS_NTC_FCB_INDEX,
00837                                                 NULL );
00838         
00839                     <a class="code" href="../../d3/d8/udfprocs_8h.html#a98">UdfIncrementReferenceCounts</a>( IrpContext, Vcb-&gt;VatFcb, 1, 1 );
00840                     <a class="code" href="../../d3/d8/udfprocs_8h.html#a89">UdfUnlockVcb</a>( IrpContext, Vcb );
00841                     UnlockVcb = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00842                                         
00843                     <span class="comment">//</span>
00844                     <span class="comment">//  Point to the file resource and set the flag that will cause mappings</span>
00845                     <span class="comment">//  to go through the Vmcb</span>
00846                     <span class="comment">//</span>
00847     
00848                     Vcb-&gt;VatFcb-&gt;Resource = &amp;Vcb-&gt;FileResource;
00849                 }
00850                 
00851                 <span class="comment">//</span>
00852                 <span class="comment">//  Now size and try to pick up all of the allocation descriptors for this guy.</span>
00853                 <span class="comment">//  We're going to need to conjure an IcbContext for this.</span>
00854                 <span class="comment">//</span>
00855     
00856                 Vcb-&gt;VatFcb-&gt;AllocationSize.QuadPart = <a class="code" href="../../d3/d8/udfprocs_8h.html#a34">LlSectorAlign</a>( Vcb, VatIcb-&gt;InfoLength );
00857             
00858                 Vcb-&gt;VatFcb-&gt;FileSize.QuadPart =
00859                 Vcb-&gt;VatFcb-&gt;ValidDataLength.QuadPart = VatIcb-&gt;InfoLength;
00860 
00861                 <span class="comment">//</span>
00862                 <span class="comment">//  Clean out any previous failed attempts.</span>
00863                 <span class="comment">//</span>
00864                 
00865                 <span class="keywordflow">if</span> (CleanupIcbContext) {
00866 
00867                     <a class="code" href="../../d3/d8/udfprocs_8h.html#a224">UdfCleanupIcbContext</a>( IrpContext, &amp;IcbContext );
00868                 
00869                 } <span class="keywordflow">else</span> {
00870 
00871                     RtlZeroMemory( &amp;IcbContext, <span class="keyword">sizeof</span>( <a class="code" href="../../d9/d9/struct__ICB__SEARCH__CONTEXT.html">ICB_SEARCH_CONTEXT</a> ));
00872                 }
00873 
00874                 <span class="comment">//</span>
00875                 <span class="comment">//  Now construct the ICB search context we would have had</span>
00876                 <span class="comment">//  made in the process of normal ICB discovery.  Since we</span>
00877                 <span class="comment">//  were unable to do that, gotta do it by hand.</span>
00878                 <span class="comment">//</span>
00879                 
00880                 IcbContext.<a class="code" href="../../d9/d9/struct__ICB__SEARCH__CONTEXT.html#o2">Active</a>.<a class="code" href="../../d6/d6/struct__MAPPED__PVIEW.html#o0">View</a> = (PVOID) VatIcb;
00881                 IcbContext.<a class="code" href="../../d9/d9/struct__ICB__SEARCH__CONTEXT.html#o2">Active</a>.<a class="code" href="../../d6/d6/struct__MAPPED__PVIEW.html#o2">Partition</a> = Reference;
00882                 IcbContext.<a class="code" href="../../d9/d9/struct__ICB__SEARCH__CONTEXT.html#o2">Active</a>.<a class="code" href="../../d6/d6/struct__MAPPED__PVIEW.html#o3">Lbn</a> = Lbn;
00883                 CleanupIcbContext = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00884     
00885                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a225">UdfInitializeAllocations</a>( IrpContext,
00886                                           Vcb-&gt;VatFcb,
00887                                           &amp;IcbContext );
00888     
00889                 <span class="comment">//</span>
00890                 <span class="comment">//  Create or resize the stream file for the VAT as appropriate.</span>
00891                 <span class="comment">//</span>
00892 
00893                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Vcb-&gt;VatFcb-&gt;FcbState, FCB_STATE_INITIALIZED )) {
00894                 
00895                     <a class="code" href="../../d3/d8/udfprocs_8h.html#a154">UdfCreateInternalStream</a>( IrpContext, Vcb, Vcb-&gt;VatFcb );
00896                     <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( Vcb-&gt;VatFcb-&gt;FcbState, FCB_STATE_INITIALIZED );
00897     
00898                 } <span class="keywordflow">else</span> {
00899 
00900                     <a class="code" href="../../d4/d2/cache_8h.html#a60">CcSetFileSizes</a>( Vcb-&gt;VatFcb-&gt;FileObject, (<a class="code" href="../../d1/d9/struct__CC__FILE__SIZES.html">PCC_FILE_SIZES</a>) &amp;Vcb-&gt;VatFcb-&gt;AllocationSize );
00901                 }
00902 
00903                 <span class="comment">//</span>
00904                 <span class="comment">//  To complete VAT discovery, we now look for the regid at the end of the stream</span>
00905                 <span class="comment">//  that will definitively tell us that this is really a VAT.  Bias from the back</span>
00906                 <span class="comment">//  by the previous VAT pointer and the regid itself.  We already know the stream</span>
00907                 <span class="comment">//  is big enough by virtue of our preliminary sanity checks.</span>
00908                 <span class="comment">//</span>
00909 
00910                 <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>.QuadPart = Vcb-&gt;VatFcb-&gt;FileSize.QuadPart - <a class="code" href="../../d9/d7/udf_8h.html#a56">UDF_CDUDF_TRAILING_DATA_SIZE</a>;
00911 
00912                 <a class="code" href="../../d4/d2/cache_8h.html#a88">CcMapData</a>( Vcb-&gt;VatFcb-&gt;FileObject,
00913                            &amp;Offset,
00914                            <span class="keyword">sizeof</span>(<a class="code" href="../../d6/d6/structREGID.html">REGID</a>),
00915                            TRUE,
00916                            &amp;Bcb,
00917                            &amp;RegId );
00918 
00919                 <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d8/udfprocs_8h.html#a231">UdfUdfIdentifierContained</a>( RegId,
00920                                                 &amp;UdfVatTableIdentifier,
00921                                                 UDF_VERSION_150,
00922                                                 UDF_VERSION_RECOGNIZED,
00923                                                 OSCLASS_INVALID,
00924                                                 OSIDENTIFIER_INVALID )) {
00925 
00926                     <span class="comment">//</span>
00927                     <span class="comment">//  Oh well, no go here.</span>
00928                     <span class="comment">//</span>
00929 
00930                     <span class="keywordflow">continue</span>;
00931                 }
00932 
00933                 <span class="comment">//</span>
00934                 <span class="comment">//  Got it!</span>
00935                 <span class="comment">//</span>
00936 
00937                 <span class="keywordflow">break</span>;
00938             }
00939 
00940             <span class="comment">//</span>
00941             <span class="comment">//  If we didn't find anything ...</span>
00942             <span class="comment">//</span>
00943             
00944             <span class="keywordflow">if</span> (ThisPass == 4) {
00945 
00946                 <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( 0, Dbg, <span class="stringliteral">"UdfUpdateVcbPhase0, ... and so we didn't find a VAT!\n"</span> ));
00947 
00948                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a122">UdfRaiseStatus</a>( IrpContext, STATUS_DISK_CORRUPT_ERROR );
00949             }
00950 
00951             <span class="comment">//</span>
00952             <span class="comment">//  Go find the virtual reference so we can further update the Pcb</span>
00953             <span class="comment">//  with information from the VAT.</span>
00954             <span class="comment">//</span>
00955 
00956             <span class="keywordflow">for</span> (Reference = 0;
00957                  Reference &lt; Vcb-&gt;Pcb-&gt;Partitions;
00958                  Reference++) {
00959 
00960                 <span class="keywordflow">if</span> (Vcb-&gt;Pcb-&gt;Partition[Reference].Type == <a class="code" href="../../d5/d9/alpha_2exdsptch_8c.html#a2">Virtual</a>) {
00961 
00962                     <span class="keywordflow">break</span>;
00963                 }
00964             }
00965 
00966             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( Reference &lt; Vcb-&gt;Pcb-&gt;Partitions );
00967 
00968             <span class="comment">//</span>
00969             <span class="comment">//  We note the length so we can easily do bounds checking for</span>
00970             <span class="comment">//  virtual mappings.</span>
00971             <span class="comment">//</span>
00972             
00973             <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>.QuadPart = (Vcb-&gt;VatFcb-&gt;FileSize.QuadPart -
00974                                <a class="code" href="../../d9/d7/udf_8h.html#a56">UDF_CDUDF_TRAILING_DATA_SIZE</a>) / <span class="keyword">sizeof</span>(ULONG);
00975 
00976             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>.HighPart == 0 );
00977             Vcb-&gt;Pcb-&gt;Partition[Reference].Virtual.Length = <a class="code" href="../../d4/d9/heapdbg_8c.html#a3">Offset</a>.LowPart;
00978 
00979             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( 0, Dbg, <span class="stringliteral">"UdfUpdateVcbPhase0, ... got it!\n"</span> ));
00980         }
00981 
00982     } finally {
00983 
00984         <a class="code" href="../../d8/d3/lfsdata_8h.html#a3">DebugUnwind</a>( <span class="stringliteral">"UdfUpdateVcbPhase0"</span> );
00985 
00986         <a class="code" href="../../d3/d8/udfprocs_8h.html#a69">UdfUnpinData</a>( IrpContext, &amp;Bcb );
00987         <span class="keywordflow">if</span> (CleanupIcbContext) { <a class="code" href="../../d3/d8/udfprocs_8h.html#a224">UdfCleanupIcbContext</a>( IrpContext, &amp;IcbContext ); }
00988         <span class="keywordflow">if</span> (UnlockVcb) { <a class="code" href="../../d3/d8/udfprocs_8h.html#a89">UdfUnlockVcb</a>( IrpContext, Vcb ); }
00989         <span class="keywordflow">if</span> (VatIcb) { <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( VatIcb ); }
00990     }
00991 
00992     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( -1, Dbg, <span class="stringliteral">"UdfUpdateVcbPhase0 -&gt; VOID\n"</span> ));
00993 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a205" doxytag="udfprocs.h::UdfUpdateVcbPhase1" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID UdfUpdateVcbPhase1           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT <a class="el" href="../../d7/d5/struct__VCB.html">PVCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Vcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d2/structNSR__FSD.html">PNSR_FSD</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Fsd</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l00997">997</a> of file <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html">udfs/strucsup.c</a>.
<p>
References <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00352">ASSERT_IRP_CONTEXT</a>, <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00336">ASSERT_VCB</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d9/d2/lfsdata_8h-source.html#l00187">DebugUnwind</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01061">FCB_STATE_INITIALIZED</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00986">_FCB::FcbState</a>, <a class="el" href="../../d2/d0/largemcb_8c-source.html#l00977">FsRtlAddLargeMcbEntry()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00220">LlBytesFromSectors</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01014">_FCB::Mcb</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00746">PFILE_ID</a>, <a class="el" href="../../d6/d8/udfstruc_8h.html#a129a115">Physical</a>, <a class="el" href="../../d0/d7/iso13346_8h.html#a232">PNSR_FSD</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00505">SetFlag</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l03183">UdfCleanupIcbContext()</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l02041">UdfCreateFcb()</a>, <a class="el" href="../../d9/d1/udfs_2cachesup_8c-source.html#l00046">UdfCreateInternalStream()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01762">UdfIncrementReferenceCounts</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l02297">UdfInitializeFcbFromIcbContext()</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l00181">UdfInitializeFcbMcb()</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l02951">UdfInitializeIcbContextFromFcb()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01567">UdfLockFcb</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01559">UdfLockVcb</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l03124">UdfLookupActiveIcb()</a>, <a class="el" href="../../d2/d6/udfs_2nodetype_8h-source.html#l00038">UDFS_NTC_FCB_DATA</a>, <a class="el" href="../../d2/d6/udfs_2nodetype_8h-source.html#l00037">UDFS_NTC_FCB_INDEX</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01465">UdfSetFidDirectory</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01457">UdfSetFidFromLbAddr</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01577">UdfUnlockFcb</a>, and <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01563">UdfUnlockVcb</a>.
<p>
Referenced by <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l01444">UdfMountVolume()</a>.
<p>
<pre class="fragment"><div>01005                    :
01006 
01007     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called to perform <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">final</span> initialization of a Vcb and Vpb
01008     from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> volume descriptors on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> disk.
01009 
01010 Arguments:
01011 
01012     Vcb - Vcb <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> volume being mounted.  We have already done phase 0.
01013 
01014     Fsd - The fileset descriptor <span class="keywordflow">for</span> <span class="keyword">this</span> volume.
01015     
01016 Return Value:
01017 
01018     None
01019 
01020 --*/
01021 
01022 {
01023     <a class="code" href="../../d9/d9/struct__ICB__SEARCH__CONTEXT.html">ICB_SEARCH_CONTEXT</a> IcbContext;
01024 
01025     LONGLONG FileId = 0;
01026 
01027     <a class="code" href="../../d7/d9/struct__FCB.html">PFCB</a> Fcb;
01028 
01029     BOOLEAN UnlockVcb = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01030     BOOLEAN UnlockFcb = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01031     BOOLEAN CleanupIcbContext = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01032 
01033     ULONG Reference;
01034 
01035     ULONG BoundSector = 0;
01036 
01037     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01038 
01039     <span class="comment">//</span>
01040     <span class="comment">//  Check input.</span>
01041     <span class="comment">//</span>
01042 
01043     <a class="code" href="../../d1/d8/udfdata_8h.html#a28">ASSERT_IRP_CONTEXT</a>( IrpContext );
01044     <a class="code" href="../../d1/d8/udfdata_8h.html#a12">ASSERT_VCB</a>( Vcb );
01045 
01046     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( +1, Dbg, <span class="stringliteral">"UdfUpdateVcbPhase1, Vcb %08x Fsd %08x\n"</span>, Vcb, Fsd ));
01047 
01048     <span class="comment">//</span>
01049     <span class="comment">//  Use a try-finally to facilitate cleanup.</span>
01050     <span class="comment">//</span>
01051 
01052     <span class="keywordflow">try</span> {
01053 
01054         <span class="comment">//</span>
01055         <span class="comment">//  Do the final internal Fcb's and other Vcb fields.</span>
01056         <span class="comment">//</span>
01057 
01059         <span class="comment">//</span>
01060         <span class="comment">//  Create the root index and reference it in the Vcb.</span>
01061         <span class="comment">//</span>
01063 <span class="comment"></span>
01064         <a class="code" href="../../d3/d8/udfprocs_8h.html#a88">UdfLockVcb</a>( IrpContext, Vcb );
01065         UnlockVcb = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01066         
01067         Vcb-&gt;RootIndexFcb = <a class="code" href="../../d3/d8/udfprocs_8h.html#a213">UdfCreateFcb</a>( IrpContext,
01068                                           *((PFILE_ID) &amp;FileId),
01069                                           UDFS_NTC_FCB_INDEX,
01070                                           NULL );
01071 
01072         <a class="code" href="../../d3/d8/udfprocs_8h.html#a98">UdfIncrementReferenceCounts</a>( IrpContext, Vcb-&gt;RootIndexFcb, 1, 1 );
01073         <a class="code" href="../../d3/d8/udfprocs_8h.html#a89">UdfUnlockVcb</a>( IrpContext, Vcb );
01074         UnlockVcb = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01075 
01076         <span class="comment">//</span>
01077         <span class="comment">//  Create the File id by hand for this Fcb.</span>
01078         <span class="comment">//</span>
01079 
01080         <a class="code" href="../../d6/d8/udfstruc_8h.html#a44">UdfSetFidFromLbAddr</a>( Vcb-&gt;RootIndexFcb-&gt;FileId, Fsd-&gt;IcbRoot.Start );
01081         <a class="code" href="../../d6/d8/udfstruc_8h.html#a49">UdfSetFidDirectory</a>( Vcb-&gt;RootIndexFcb-&gt;FileId );
01082         Vcb-&gt;RootIndexFcb-&gt;RootExtentLength = Fsd-&gt;IcbRoot.Length.Length;
01083 
01084         <span class="comment">//</span>
01085         <span class="comment">//  Get the direct entry for the root directory and initialize</span>
01086         <span class="comment">//  the Fcb from it.</span>
01087         <span class="comment">//</span>
01088 
01089         <a class="code" href="../../d3/d8/udfprocs_8h.html#a220">UdfInitializeIcbContextFromFcb</a>( IrpContext,
01090                                         &amp;IcbContext,
01091                                         Vcb-&gt;RootIndexFcb );
01092         CleanupIcbContext = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01093 
01094         <a class="code" href="../../d3/d8/udfprocs_8h.html#a223">UdfLookupActiveIcb</a>( IrpContext, &amp;IcbContext );
01095 
01096         <a class="code" href="../../d3/d8/udfprocs_8h.html#a215">UdfInitializeFcbFromIcbContext</a>( IrpContext,
01097                                         Vcb-&gt;RootIndexFcb,
01098                                         &amp;IcbContext );
01099 
01100         <a class="code" href="../../d3/d8/udfprocs_8h.html#a224">UdfCleanupIcbContext</a>( IrpContext, &amp;IcbContext );
01101         CleanupIcbContext = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01102 
01103         <span class="comment">//</span>
01104         <span class="comment">//  Create the stream file for the root directory.</span>
01105         <span class="comment">//</span>
01106 
01107         <a class="code" href="../../d3/d8/udfprocs_8h.html#a154">UdfCreateInternalStream</a>( IrpContext, Vcb, Vcb-&gt;RootIndexFcb );
01108 
01110         <span class="comment">//</span>
01111         <span class="comment">//  Now do the volume dasd Fcb.  Create this and reference it in the</span>
01112         <span class="comment">//  Vcb.</span>
01113         <span class="comment">//</span>
01115 <span class="comment"></span>
01116         <a class="code" href="../../d3/d8/udfprocs_8h.html#a88">UdfLockVcb</a>( IrpContext, Vcb );
01117         UnlockVcb = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01118 
01119         Vcb-&gt;VolumeDasdFcb = <a class="code" href="../../d3/d8/udfprocs_8h.html#a213">UdfCreateFcb</a>( IrpContext,
01120                                            *((PFILE_ID) &amp;FileId),
01121                                            UDFS_NTC_FCB_DATA,
01122                                            NULL );
01123 
01124         <a class="code" href="../../d3/d8/udfprocs_8h.html#a98">UdfIncrementReferenceCounts</a>( IrpContext, Vcb-&gt;VolumeDasdFcb, 1, 1 );
01125         <a class="code" href="../../d3/d8/udfprocs_8h.html#a89">UdfUnlockVcb</a>( IrpContext, Vcb );
01126         UnlockVcb = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01127 
01128         Fcb = Vcb-&gt;VolumeDasdFcb;
01129         <a class="code" href="../../d3/d8/udfprocs_8h.html#a90">UdfLockFcb</a>( IrpContext, Fcb );
01130         UnlockFcb = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01131 
01132         <span class="comment">//</span>
01133         <span class="comment">//  If we were unable to determine a last sector on the media, walk the Pcb and guess</span>
01134         <span class="comment">//  that it is probably OK to think of the last sector of the last partition as The</span>
01135         <span class="comment">//  Last Sector.  Note that we couldn't do this before since the notion of a last</span>
01136         <span class="comment">//  sector has significance at mount time, if it had been possible to find one.</span>
01137         <span class="comment">//</span>
01138 
01139         <span class="keywordflow">for</span> ( Reference = 0;
01140               Reference &lt; Vcb-&gt;Pcb-&gt;Partitions;
01141               Reference++ ) {
01142 
01143             <span class="keywordflow">if</span> (Vcb-&gt;Pcb-&gt;Partition[Reference].Type == <a class="code" href="../../d6/d8/udfstruc_8h.html#a129a115">Physical</a> &amp;&amp;
01144                 Vcb-&gt;Pcb-&gt;Partition[Reference].Physical.Start +
01145                 Vcb-&gt;Pcb-&gt;Partition[Reference].Physical.Length &gt; BoundSector) {
01146 
01147                 BoundSector = Vcb-&gt;Pcb-&gt;Partition[Reference].Physical.Start +
01148                               Vcb-&gt;Pcb-&gt;Partition[Reference].Physical.Length;
01149             }
01150         }
01151 
01152         <span class="comment">//</span>
01153         <span class="comment">//  Note that we cannot restrict the bound by the "physical" bound discovered</span>
01154         <span class="comment">//  eariler.  This is because the MSF format of the TOC request we send is only</span>
01155         <span class="comment">//  capable of representing about 2.3gb, and a lot of media we will be on that</span>
01156         <span class="comment">//  responds to TOCs will be quite a bit larger - ex: DVD.</span>
01157         <span class="comment">//</span>
01158         <span class="comment">//  This, of course, barring proper means of discovering media bounding, prohibits</span>
01159         <span class="comment">//  the possibility of having UDF virtual partitions on DVD-R.</span>
01160         <span class="comment">//</span>
01161 
01162         <span class="comment">//</span>
01163         <span class="comment">//  Build the mapping from [0, Bound).  We have to initialize the Mcb by hand since</span>
01164         <span class="comment">//  this is usually left to when we lift retrieval information from an Icb in</span>
01165         <span class="comment">//  UdfInitializeAllocations.</span>
01166         <span class="comment">//</span>
01167 
01168         <a class="code" href="../../d9/d7/udfs_2strucsup_8c.html#a15">UdfInitializeFcbMcb</a>( Fcb );
01169 
01170         <a class="code" href="../../d1/d8/fsrtl_8h.html#a143">FsRtlAddLargeMcbEntry</a>( &amp;Fcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o14">Mcb</a>,
01171                                (LONGLONG) 0,
01172                                (LONGLONG) 0,
01173                                (LONGLONG) BoundSector );
01174                                
01175         Fcb-&gt;FileSize.QuadPart += <a class="code" href="../../d3/d8/udfprocs_8h.html#a39">LlBytesFromSectors</a>( Vcb, BoundSector );
01176 
01177         Fcb-&gt;AllocationSize.QuadPart =
01178         Fcb-&gt;ValidDataLength.QuadPart = Fcb-&gt;FileSize.QuadPart;
01179 
01180         <a class="code" href="../../d3/d8/udfprocs_8h.html#a91">UdfUnlockFcb</a>( IrpContext, Fcb );
01181         UnlockFcb = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01182 
01183         <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( Fcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o10">FcbState</a>, FCB_STATE_INITIALIZED );
01184 
01185         <span class="comment">//</span>
01186         <span class="comment">//  Point to the file resource.</span>
01187         <span class="comment">//</span>
01188 
01189         Vcb-&gt;VolumeDasdFcb-&gt;Resource = &amp;Vcb-&gt;FileResource;
01190 
01191         Vcb-&gt;VolumeDasdFcb-&gt;FileAttributes = FILE_ATTRIBUTE_READONLY;
01192 
01193     } finally {
01194 
01195         <a class="code" href="../../d8/d3/lfsdata_8h.html#a3">DebugUnwind</a>( <span class="stringliteral">"UdfUpdateVcbPhase1"</span> );
01196 
01197         <span class="keywordflow">if</span> (CleanupIcbContext) { <a class="code" href="../../d3/d8/udfprocs_8h.html#a224">UdfCleanupIcbContext</a>( IrpContext, &amp;IcbContext ); }
01198 
01199         <span class="keywordflow">if</span> (UnlockFcb) { <a class="code" href="../../d3/d8/udfprocs_8h.html#a91">UdfUnlockFcb</a>( IrpContext, Fcb ); }
01200         <span class="keywordflow">if</span> (UnlockVcb) { <a class="code" href="../../d3/d8/udfprocs_8h.html#a89">UdfUnlockVcb</a>( IrpContext, Vcb ); }
01201     }
01202 
01203     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( -1, Dbg, <span class="stringliteral">"UdfUpdateVcbPhase1 -&gt; VOID\n"</span> ));
01204 
01205     <span class="keywordflow">return</span>;
01206 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a219" doxytag="udfprocs.h::UdfVerifyDescriptor" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN UdfVerifyDescriptor           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d7/d7/structDESTAG.html">PDESTAG</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Descriptor</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d6/jul98_2test_2icc__i386_8h.html#a14">USHORT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Tag</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Size</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>Lbn</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>ReturnError</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l02617">2617</a> of file <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html">udfs/strucsup.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00352">ASSERT_IRP_CONTEXT</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d1/d6/iso13346_8h-source.html#l00350">DESTAG_VER_CURRENT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d9/d6/lh__open_2pi__mem_8h-source.html#l00017">Size</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d3/d8/udfprocs_8h.html#a134">UdfComputeCrc16()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00406">UdfRaiseStatus()</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l03307">UdfFindAnchorVolumeDescriptor()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l02558">UdfFindFileSetDescriptor()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l02832">UdfFindVolumeDescriptors()</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l04144">UdfGetNextAllocationPostProcessing()</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l02951">UdfInitializeIcbContextFromFcb()</a>, <a class="el" href="../../d3/d5/allocsup_8c-source.html#l01406">UdfLoadSparingTables()</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l03790">UdfLookupActiveIcbInExtent()</a>, <a class="el" href="../../d5/d7/dirsup_8c-source.html#l00916">UdfLookupDirEntryPostProcessing()</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l03278">UdfLookupEa()</a>, and <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l00477">UdfUpdateVcbPhase0()</a>.
<p>
<pre class="fragment"><div>02628                    :
02629 
02630     This routine verifies that a descriptor <span class="keyword">using</span> a Descriptor tag (3/7.2) is 
02631     consistent with itself and the descriptor data.
02632 
02633 Arguments:
02634 
02635     Descriptor - This is the pointer to the descriptor tag, which is always
02636         at the front of a descriptor
02637 
02638     Tag - The Tag Identifier this descriptor should have
02639 
02640     Size - Size of this descriptor
02641 
02642     Lbn - The logical block number this descriptor should claim it is recorded at
02643 
02644     ReturnError - Whether this routine should return an error or raise
02645 
02646 Return Value:
02647 
02648     Boolean TRUE if the descriptor is consistent, FALSE or a raised status of
02649     STATUS_DISK_CORRUPT_ERROR otherwise.
02650 
02651 --*/
02652 
02653 {
02654     UCHAR Checksum = 0;
02655     PCHAR CheckPtr;
02656     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> Crc;
02657 
02658 <span class="preprocessor">#ifdef UDF_SANITY</span>
02659 <span class="preprocessor"></span>    
02660     VERIFY_FAILURE FailReason = Nothing;
02661 
02662 <span class="preprocessor">#endif</span>
02663 <span class="preprocessor"></span>    
02664     <span class="comment">//</span>
02665     <span class="comment">//  Check our inputs</span>
02666     <span class="comment">//</span>
02667 
02668     <a class="code" href="../../d1/d8/udfdata_8h.html#a28">ASSERT_IRP_CONTEXT</a>( IrpContext );
02669 
02670     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02671 
02672 <span class="preprocessor">#ifdef UDF_SANITY</span>
02673 <span class="preprocessor"></span>
02674     <span class="keywordflow">if</span> (UdfNoisyVerifyDescriptor) {
02675 
02676         <span class="keywordflow">goto</span> BeNoisy;
02677     }
02678 
02679     RegularEntry:
02680 
02681 <span class="preprocessor">#endif</span>
02682 <span class="preprocessor"></span>
02683     <span class="comment">//</span>
02684     <span class="comment">//  The version of the Descriptor Tag specified in ISO 13346 and used in</span>
02685     <span class="comment">//  UDF is a particular value; presumeably, previous versions were used</span>
02686     <span class="comment">//  in some older revision of the standard.</span>
02687     <span class="comment">//</span>
02688 
02689 <span class="preprocessor">#ifdef UDF_SUPPORT_NONSTANDARD_ADAPTEC</span>
02690 <span class="preprocessor"></span>
02691     <span class="comment">//</span>
02692     <span class="comment">//  Let bad descriptor version numbers through.</span>
02693     <span class="comment">//</span>
02694     <span class="comment">//  Reasons:</span>
02695     <span class="comment">//</span>
02696     <span class="comment">//      ADAPTEC - early CDUDF wrote version 1 as opposed to version 2.</span>
02697     <span class="comment">//</span>
02698 
02699     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)
02700 
02701 <span class="preprocessor">#else</span>
02702 <span class="preprocessor"></span>
02703     <span class="keywordflow">if</span> (Descriptor-&gt;Version == <a class="code" href="../../d0/d7/iso13346_8h.html#a61">DESTAG_VER_CURRENT</a>)
02704 
02705 <span class="preprocessor">#endif</span>
02706 <span class="preprocessor"></span>
02707     {
02708 
02709         <span class="comment">//</span>
02710         <span class="comment">//  A descriptor is stamped in four ways. First, the Lbn of the sector</span>
02711         <span class="comment">//  containing the descriptor is written here. (3/7.2.8)</span>
02712         <span class="comment">//</span>
02713 
02714         
02715 <span class="preprocessor">#ifdef UDF_SUPPORT_NONSTANDARD_HP</span>
02716 <span class="preprocessor"></span>        
02717         <span class="comment">//</span>
02718         <span class="comment">//  Let bad lbn through.</span>
02719         <span class="comment">//</span>
02720         <span class="comment">//  Reasons:</span>
02721         <span class="comment">//</span>
02722         <span class="comment">//      HP - Rob Sim;s CD-RW model disc doesn't record this reliably.</span>
02723         <span class="comment">//</span>
02724 
02725         <span class="keywordflow">if</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)
02726 
02727 <span class="preprocessor">#else</span>
02728 <span class="preprocessor"></span>        
02729         <span class="keywordflow">if</span> (Descriptor-&gt;Lbn == Lbn)
02730 
02731 <span class="preprocessor">#endif</span>
02732 <span class="preprocessor"></span>        {
02733             <span class="comment">//</span>
02734             <span class="comment">//  Next, the descriptor tag itself has an identifier which should match</span>
02735             <span class="comment">//  the type we expect to find here (3/7.2.1)</span>
02736             <span class="comment">//</span>
02737             
02738             <span class="keywordflow">if</span> (Descriptor-&gt;Ident == Tag) {
02739         
02740                 <span class="comment">//</span>
02741                 <span class="comment">//  Next, the descriptor tag itself is checksumed, minus the byte</span>
02742                 <span class="comment">//  used to store the checksum. (3/7.2.3)</span>
02743                 <span class="comment">//</span>
02744             
02745                 <span class="keywordflow">for</span> (CheckPtr = (PCHAR) Descriptor;
02746                      CheckPtr &lt; (PCHAR) Descriptor + FIELD_OFFSET( <a class="code" href="../../d7/d7/structDESTAG.html">DESTAG</a>, Checksum );
02747                      CheckPtr++) {
02748             
02749                     Checksum += *CheckPtr;
02750                 }
02751         
02752                 <span class="keywordflow">for</span> (CheckPtr = (PCHAR) Descriptor + FIELD_OFFSET( <a class="code" href="../../d7/d7/structDESTAG.html">DESTAG</a>, Checksum ) + <span class="keyword">sizeof</span>(UCHAR);
02753                      CheckPtr &lt; (PCHAR) Descriptor + <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d7/structDESTAG.html">DESTAG</a>);
02754                      CheckPtr++) {
02755             
02756                     Checksum += *CheckPtr;
02757                 }
02758         
02759                 <span class="keywordflow">if</span> (Descriptor-&gt;Checksum == Checksum) {
02760             
02761                     <span class="comment">//</span>
02762                     <span class="comment">//  Now we check that the CRC in the Descriptor tag is sized sanely</span>
02763                     <span class="comment">//  and matches the Descriptor data. (3/7.2.6)</span>
02764                     <span class="comment">//</span>
02765 
02766 <span class="preprocessor">#ifdef UDF_SUPPORT_NONSTANDARD_HP</span>
02767 <span class="preprocessor"></span>
02768                     <span class="comment">//</span>
02769                     <span class="comment">//  Let zero-length CRCs through.</span>
02770                     <span class="comment">//</span>
02771                     <span class="comment">//  Reasons:</span>
02772                     <span class="comment">//</span>
02773                     <span class="comment">//      HP - early CDUDF didn't CRC the terminationg descriptors (tag 8).</span>
02774                     <span class="comment">//</span>
02775                     
02776                     <span class="keywordflow">if</span> (!Descriptor-&gt;CRCLen ||
02777                         Descriptor-&gt;CRCLen &lt;= <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> - <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d7/structDESTAG.html">DESTAG</a>))
02778 <span class="preprocessor">#else</span>
02779 <span class="preprocessor"></span>                    
02780                     <span class="keywordflow">if</span> (Descriptor-&gt;CRCLen &amp;&amp;
02781                         Descriptor-&gt;CRCLen &lt;= <a class="code" href="../../d8/d7/lh__open_2pi__mem_8h.html#a0">Size</a> - <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d7/structDESTAG.html">DESTAG</a>))
02782 
02783 <span class="preprocessor">#endif                        </span>
02784 <span class="preprocessor"></span>                    {
02785     
02786                         Crc = <a class="code" href="../../d3/d8/udfprocs_8h.html#a134">UdfComputeCrc16</a>( (PCHAR) Descriptor + <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d7/structDESTAG.html">DESTAG</a>),
02787                                                Descriptor-&gt;CRCLen );
02788                         
02789 <span class="preprocessor">#ifdef UDF_SUPPORT_NONSTANDARD_HP</span>
02790 <span class="preprocessor"></span>
02791                         <span class="comment">//</span>
02792                         <span class="comment">//  Let zero-length CRCs through.</span>
02793                         <span class="comment">//</span>
02794                         <span class="comment">//  Reasons: as above.</span>
02795                         <span class="comment">//</span>
02796                     
02797                         <span class="keywordflow">if</span> (!Descriptor-&gt;CRCLen ||
02798                             Descriptor-&gt;CRC == Crc)
02799 
02800 <span class="preprocessor">#else</span>
02801 <span class="preprocessor"></span>
02802                         <span class="keywordflow">if</span> (Descriptor-&gt;CRC == Crc)
02803 
02804 <span class="preprocessor">#endif</span>
02805 <span class="preprocessor"></span>                        {
02806                             
02807                             <span class="comment">//</span>
02808                             <span class="comment">//  This descriptor checks out.</span>
02809                             <span class="comment">//</span>
02810     
02811 <span class="preprocessor">#ifdef UDF_SANITY</span>
02812 <span class="preprocessor"></span>                            <span class="keywordflow">if</span> (UdfNoisyVerifyDescriptor) {
02813                             
02814                                 <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( -1, Dbg, <span class="stringliteral">"UdfVerifyDescriptor -&gt; TRUE\n"</span> ));
02815                             }
02816 <span class="preprocessor">#endif</span>
02817 <span class="preprocessor"></span>                            <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02818                     
02819                         } <span class="keywordflow">else</span> {
02820 <span class="preprocessor">#ifdef UDF_SANITY</span>
02821 <span class="preprocessor"></span>                            FailReason = BadCrc;
02822                             <span class="keywordflow">goto</span> ReportFailure;
02823 <span class="preprocessor">#endif</span>
02824 <span class="preprocessor"></span>                        }
02825     
02826                     } <span class="keywordflow">else</span> {
02827 <span class="preprocessor">#ifdef UDF_SANITY</span>
02828 <span class="preprocessor"></span>                        FailReason = BadCrcLength;
02829                         <span class="keywordflow">goto</span> ReportFailure;
02830 <span class="preprocessor">#endif</span>
02831 <span class="preprocessor"></span>                    }
02832             
02833                 } <span class="keywordflow">else</span> {
02834 <span class="preprocessor">#ifdef UDF_SANITY</span>
02835 <span class="preprocessor"></span>                    FailReason = BadChecksum;
02836                     <span class="keywordflow">goto</span> ReportFailure;
02837 <span class="preprocessor">#endif</span>
02838 <span class="preprocessor"></span>                }
02839             
02840             } <span class="keywordflow">else</span> {
02841 <span class="preprocessor">#ifdef UDF_SANITY</span>
02842 <span class="preprocessor"></span>                FailReason = BadTag;
02843                 <span class="keywordflow">goto</span> ReportFailure;
02844 <span class="preprocessor">#endif</span>
02845 <span class="preprocessor"></span>            }
02846         
02847         } <span class="keywordflow">else</span> {
02848 <span class="preprocessor">#ifdef UDF_SANITY</span>
02849 <span class="preprocessor"></span>            FailReason = BadLbn;
02850             <span class="keywordflow">goto</span> ReportFailure;
02851 <span class="preprocessor">#endif</span>
02852 <span class="preprocessor"></span>        }
02853     
02854     } <span class="keywordflow">else</span> {
02855 <span class="preprocessor">#ifdef UDF_SANITY</span>
02856 <span class="preprocessor"></span>        FailReason = BadDestagVersion;
02857         <span class="keywordflow">goto</span> ReportFailure;
02858 <span class="preprocessor">#endif</span>
02859 <span class="preprocessor"></span>    }
02860 
02861 <span class="preprocessor">#ifdef UDF_SANITY</span>
02862 <span class="preprocessor"></span>
02863     BeNoisy:
02864     
02865     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( +1, Dbg,
02866                  <span class="stringliteral">"UdfVerifyDescriptor, Destag %08x, Tag %x, Size %x, Lbn %x\n"</span>,
02867                  Descriptor,
02868                  Tag,
02869                  Size,
02870                  Lbn ));
02871 
02872     <span class="keywordflow">if</span> (FailReason == Nothing) {
02873 
02874         <span class="keywordflow">goto</span> RegularEntry;
02875     
02876     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!UdfNoisyVerifyDescriptor) {
02877 
02878         <span class="keywordflow">goto</span> ReallyReportFailure;
02879     }
02880 
02881     ReportFailure:
02882 
02883     <span class="keywordflow">if</span> (!UdfNoisyVerifyDescriptor) {
02884 
02885         <span class="keywordflow">goto</span> BeNoisy;
02886     }
02887 
02888     ReallyReportFailure:
02889 
02890     <span class="keywordflow">switch</span> (FailReason) {
02891         <span class="keywordflow">case</span> BadLbn:
02892             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( 0, Dbg, 
02893                          <span class="stringliteral">"Lbn mismatch - Lbn %x != expected %x\n"</span>,
02894                          Descriptor-&gt;Lbn,
02895                          Lbn ));
02896             <span class="keywordflow">break</span>;
02897 
02898         <span class="keywordflow">case</span> BadTag:
02899             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( 0, Dbg,
02900                          <span class="stringliteral">"Tag mismatch - Ident %x != expected %x\n"</span>,
02901                          Descriptor-&gt;Ident,
02902                          Tag ));
02903             <span class="keywordflow">break</span>;
02904 
02905         <span class="keywordflow">case</span> BadChecksum:
02906             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( 0, Dbg,
02907                          <span class="stringliteral">"Checksum mismatch - Checksum %x != descriptor's %x\n"</span>,
02908                          Checksum,
02909                          Descriptor-&gt;Checksum ));
02910             <span class="keywordflow">break</span>;
02911 
02912         <span class="keywordflow">case</span> BadCrcLength:
02913             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( 0, Dbg,
02914                          <span class="stringliteral">"CRC'd size bad - CrcLen %x is 0 or &gt; max %x\n"</span>,
02915                          Descriptor-&gt;CRCLen,
02916                          Size - <span class="keyword">sizeof</span>(<a class="code" href="../../d7/d7/structDESTAG.html">DESTAG</a>) ));
02917             <span class="keywordflow">break</span>;
02918 
02919         <span class="keywordflow">case</span> BadCrc:
02920             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( 0, Dbg,
02921                          <span class="stringliteral">"CRC mismatch - Crc %x != descriptor's %x\n"</span>,
02922                          Crc,
02923                          Descriptor-&gt;CRC ));
02924             <span class="keywordflow">break</span>;
02925 
02926         <span class="keywordflow">case</span> BadDestagVersion:
02927             <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( 0, Dbg,
02928                          <span class="stringliteral">"Bad Destag Verion - %x != descriptor's %x\n"</span>,
02929                          DESTAG_VER_CURRENT,
02930                          Descriptor-&gt;Version ));
02931             <span class="keywordflow">break</span>;
02932 
02933         <span class="keywordflow">default</span>:
02934             <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( FALSE );
02935     }
02936     
02937     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( -1, Dbg, <span class="stringliteral">"UdfVerifyDescriptor -&gt; FALSE\n"</span> ));
02938 
02939 <span class="preprocessor">#endif</span>
02940 <span class="preprocessor"></span>    
02941     <span class="keywordflow">if</span> (!ReturnError) {
02942 
02943         <a class="code" href="../../d3/d8/udfprocs_8h.html#a122">UdfRaiseStatus</a>( IrpContext, STATUS_CRC_ERROR );
02944     }
02945 
02946     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02947 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a235" doxytag="udfprocs.h::UdfVerifyFcbOperation" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN UdfVerifyFcbOperation           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d7/d9/struct__FCB.html">PFCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Fcb</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d4/udfs_2verfysup_8c-source.html#l00760">760</a> of file <a class="el" href="../../d9/d4/udfs_2verfysup_8c-source.html">udfs/verfysup.c</a>.
<p>
References <a class="el" href="../../d1/d4/io_8h-source.html#l01153">DO_VERIFY_VOLUME</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01184">_DEVICE_OBJECT::Flags</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l09796">IoSetHardErrorOrVerifyDevice()</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01073">_VPB::RealDevice</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00505">SetFlag</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00406">UdfRaiseStatus()</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00559">_VCB::VcbCondition</a>, <a class="el" href="../../d6/d8/udfstruc_8h.html#a130a121">VcbDismountInProgress</a>, <a class="el" href="../../d6/d8/udfstruc_8h.html#a130a120">VcbInvalid</a>, <a class="el" href="../../d6/d8/udfstruc_8h.html#a130a119">VcbMounted</a>, <a class="el" href="../../d6/d8/udfstruc_8h.html#a130a118">VcbMountInProgress</a>, <a class="el" href="../../d6/d8/udfstruc_8h.html#a130a117">VcbNotMounted</a>, and <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00529">_VCB::Vpb</a>.
<p>
Referenced by <a class="el" href="../../d3/d4/lockctrl_8c-source.html#l00046">UdfCommonLockControl()</a>, <a class="el" href="../../d5/d2/fileinfo_8c-source.html#l00156">UdfCommonQueryInfo()</a>, <a class="el" href="../../d8/d4/udfs_2read_8c-source.html#l00068">UdfCommonRead()</a>, <a class="el" href="../../d5/d2/fileinfo_8c-source.html#l00385">UdfCommonSetInfo()</a>, <a class="el" href="../../d3/d4/lockctrl_8c-source.html#l00152">UdfFastLock()</a>, <a class="el" href="../../d5/d2/fileinfo_8c-source.html#l00496">UdfFastQueryBasicInfo()</a>, <a class="el" href="../../d5/d2/fileinfo_8c-source.html#l00740">UdfFastQueryNetworkInfo()</a>, <a class="el" href="../../d5/d2/fileinfo_8c-source.html#l00614">UdfFastQueryStdInfo()</a>, <a class="el" href="../../d3/d4/lockctrl_8c-source.html#l00436">UdfFastUnlockAll()</a>, <a class="el" href="../../d3/d4/lockctrl_8c-source.html#l00557">UdfFastUnlockAllByKey()</a>, <a class="el" href="../../d3/d4/lockctrl_8c-source.html#l00297">UdfFastUnlockSingle()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l00470">UdfOplockRequest()</a>, and <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l00334">UdfQueryDirectory()</a>.
<p>
<pre class="fragment"><div>00767                    :
00768 
00769     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called to verify that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> state of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Fcb <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> valid
00770     to allow <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current operation to <span class="keywordflow">continue</span>.  We use <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> state of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00771     Vcb, target device and <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of operation to determine <span class="keyword">this</span>.
00772 
00773 Arguments:
00774 
00775     IrpContext - IrpContext <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> request.  If not present then we
00776         were called from <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> fast IO <a class="code" href="../../d3/d3/dumpuser_8c.html#a14">path</a>.
00777 
00778     Fcb - Fcb to perform <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> request on.
00779 
00780 Return Value:
00781 
00782     BOOLEAN - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> request can <span class="keywordflow">continue</span>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise.
00783 
00784 --*/
00785 
00786 {
00787     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00788     <a class="code" href="../../d7/d5/struct__VCB.html">PVCB</a> Vcb = Fcb-&gt;Vcb;
00789     <a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html">PDEVICE_OBJECT</a> RealDevice = Vcb-&gt;<a class="code" href="../../d7/d5/struct__VCB.html#o2">Vpb</a>-&gt;<a class="code" href="../../d7/d7/struct__VPB.html#o5">RealDevice</a>;
00790 
00791     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00792 
00793     <span class="comment">//</span>
00794     <span class="comment">//  Fail immediately if the volume is in the progress of being dismounted</span>
00795     <span class="comment">//  or has been marked invalid.</span>
00796     <span class="comment">//</span>
00797 
00798     <span class="keywordflow">if</span> ((Vcb-&gt;<a class="code" href="../../d7/d5/struct__VCB.html#o8">VcbCondition</a> == <a class="code" href="../../d6/d8/udfstruc_8h.html#a130a120">VcbInvalid</a>) ||
00799         (Vcb-&gt;<a class="code" href="../../d7/d5/struct__VCB.html#o8">VcbCondition</a> == <a class="code" href="../../d6/d8/udfstruc_8h.html#a130a121">VcbDismountInProgress</a>)) {
00800 
00801         <span class="keywordflow">if</span> (ARGUMENT_PRESENT( IrpContext )) {
00802 
00803             <a class="code" href="../../d3/d8/udfprocs_8h.html#a122">UdfRaiseStatus</a>( IrpContext, STATUS_FILE_INVALID );
00804         }
00805 
00806         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00807     }
00808 
00809     <span class="comment">//</span>
00810     <span class="comment">//  Always fail if the volume needs to be verified.</span>
00811     <span class="comment">//</span>
00812 
00813     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( RealDevice-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o8">Flags</a>, DO_VERIFY_VOLUME )) {
00814 
00815         <span class="keywordflow">if</span> (ARGUMENT_PRESENT( IrpContext )) {
00816 
00817             <a class="code" href="../../d4/d6/iosubs_8c.html#a105">IoSetHardErrorOrVerifyDevice</a>( IrpContext-&gt;Irp,
00818                                           RealDevice );
00819 
00820             <a class="code" href="../../d3/d8/udfprocs_8h.html#a122">UdfRaiseStatus</a>( IrpContext, STATUS_VERIFY_REQUIRED );
00821         }
00822 
00823         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00824 
00825     <span class="comment">//</span>
00826     <span class="comment">//  All operations are allowed on mounted volumes.</span>
00827     <span class="comment">//</span>
00828 
00829     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((Vcb-&gt;<a class="code" href="../../d7/d5/struct__VCB.html#o8">VcbCondition</a> == <a class="code" href="../../d6/d8/udfstruc_8h.html#a130a119">VcbMounted</a>) ||
00830                (Vcb-&gt;<a class="code" href="../../d7/d5/struct__VCB.html#o8">VcbCondition</a> == <a class="code" href="../../d6/d8/udfstruc_8h.html#a130a118">VcbMountInProgress</a>)) {
00831 
00832         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00833 
00834     <span class="comment">//</span>
00835     <span class="comment">//  Fail all requests for fast Io on other Vcb conditions.</span>
00836     <span class="comment">//</span>
00837 
00838     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!ARGUMENT_PRESENT( IrpContext )) {
00839 
00840         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00841 
00842     <span class="comment">//</span>
00843     <span class="comment">//  The remaining case is VcbNotMounted.</span>
00844     <span class="comment">//  Mark the device to be verified and raise WRONG_VOLUME.</span>
00845     <span class="comment">//</span>
00846 
00847     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Vcb-&gt;<a class="code" href="../../d7/d5/struct__VCB.html#o8">VcbCondition</a> == <a class="code" href="../../d6/d8/udfstruc_8h.html#a130a117">VcbNotMounted</a>) {
00848 
00849         <span class="keywordflow">if</span> (ARGUMENT_PRESENT( IrpContext )) {
00850 
00851             <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>(RealDevice-&gt;<a class="code" href="../../d8/d4/struct__DEVICE__OBJECT.html#o8">Flags</a>, DO_VERIFY_VOLUME);
00852 
00853             <a class="code" href="../../d4/d6/iosubs_8c.html#a105">IoSetHardErrorOrVerifyDevice</a>( IrpContext-&gt;Irp, RealDevice );
00854             <a class="code" href="../../d3/d8/udfprocs_8h.html#a122">UdfRaiseStatus</a>( IrpContext, STATUS_WRONG_VOLUME );
00855         }
00856 
00857         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00858     }
00859 
00860     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00861 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a234" doxytag="udfprocs.h::UdfVerifyVcb" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> VOID UdfVerifyVcb           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d7/d5/struct__VCB.html">PVCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Vcb</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d9/d4/udfs_2verfysup_8c-source.html#l00603">603</a> of file <a class="el" href="../../d9/d4/udfs_2verfysup_8c-source.html">udfs/verfysup.c</a>.
<p>
References <a class="el" href="../../d1/d4/io_8h-source.html#l01153">DO_VERIFY_VOLUME</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l09796">IoSetHardErrorOrVerifyDevice()</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00505">SetFlag</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l02115">UdfIsRawDevice</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00418">UdfNormalizeAndRaiseStatus()</a>, <a class="el" href="../../d4/d6/deviosup_8c-source.html#l00573">UdfPerformDevIoCtrl()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00406">UdfRaiseStatus()</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00684">VCB_STATE_REMOVABLE_MEDIA</a>, <a class="el" href="../../d6/d8/udfstruc_8h.html#a130a121">VcbDismountInProgress</a>, <a class="el" href="../../d6/d8/udfstruc_8h.html#a130a120">VcbInvalid</a>, <a class="el" href="../../d6/d8/udfstruc_8h.html#a130a119">VcbMounted</a>, <a class="el" href="../../d6/d8/udfstruc_8h.html#a130a118">VcbMountInProgress</a>, <a class="el" href="../../d6/d8/udfstruc_8h.html#a130a117">VcbNotMounted</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
Referenced by <a class="el" href="../../d4/d7/udfs_2create_8c-source.html#l00108">UdfCommonCreate()</a>, <a class="el" href="../../d3/d6/udfs_2devctrl_8c-source.html#l00069">UdfCommonDevControl()</a>, <a class="el" href="../../d8/d5/volinfo_8c-source.html#l00082">UdfCommonQueryVolInfo()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l01175">UdfIsVolumeMounted()</a>, <a class="el" href="../../d0/d7/udfs_2fsctrl_8c-source.html#l00780">UdfLockVolume()</a>, and <a class="el" href="../../d2/d7/dirctrl_8c-source.html#l00904">UdfNotifyChangeDirectory()</a>.
<p>
<pre class="fragment"><div>00610                    :
00611 
00612     This routine checks that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current Vcb <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> valid and currently mounted
00613     on <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> device.  It will raise on an error condition.
00614 
00615     We check whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> volume needs verification and <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current state
00616     of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Vcb.
00617 
00618 Arguments:
00619 
00620     Vcb - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> volume to verify.
00621 
00622 Return Value:
00623 
00624     None
00625 
00626 --*/
00627 
00628 {
00629     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00630     IO_STATUS_BLOCK Iosb;
00631     ULONG MediaChangeCount = 0;
00632 
00633     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00634 
00635     <span class="comment">//</span>
00636     <span class="comment">//  Fail immediately if the volume is in the progress of being dismounted</span>
00637     <span class="comment">//  or has been marked invalid.</span>
00638     <span class="comment">//</span>
00639 
00640     <span class="keywordflow">if</span> ((Vcb-&gt;VcbCondition == <a class="code" href="../../d6/d8/udfstruc_8h.html#a130a120">VcbInvalid</a>) ||
00641         (Vcb-&gt;VcbCondition == <a class="code" href="../../d6/d8/udfstruc_8h.html#a130a121">VcbDismountInProgress</a>)) {
00642 
00643         <a class="code" href="../../d3/d8/udfprocs_8h.html#a122">UdfRaiseStatus</a>( IrpContext, STATUS_FILE_INVALID );
00644     }
00645 
00646     <span class="comment">//</span>
00647     <span class="comment">//  If the media is removable and the verify volume flag in the</span>
00648     <span class="comment">//  device object is not set then we want to ping the device</span>
00649     <span class="comment">//  to see if it needs to be verified</span>
00650     <span class="comment">//</span>
00651 
00652     <span class="keywordflow">if</span> ((Vcb-&gt;VcbCondition != <a class="code" href="../../d6/d8/udfstruc_8h.html#a130a118">VcbMountInProgress</a>) &amp;&amp;
00653         <a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Vcb-&gt;VcbState, VCB_STATE_REMOVABLE_MEDIA ) &amp;&amp;
00654         !<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Vcb-&gt;Vpb-&gt;RealDevice-&gt;Flags, DO_VERIFY_VOLUME )) {
00655 
00656         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d8/udfprocs_8h.html#a159">UdfPerformDevIoCtrl</a>( IrpContext,
00657                                       ( Vcb-&gt;Vpb-&gt;RealDevice-&gt;DeviceType == FILE_DEVICE_CD_ROM ?
00658                                         IOCTL_CDROM_CHECK_VERIFY :
00659                                         IOCTL_DISK_CHECK_VERIFY ),
00660                                       Vcb-&gt;TargetDeviceObject,
00661                                       &amp;MediaChangeCount,
00662                                       <span class="keyword">sizeof</span>(ULONG),
00663                                       FALSE,
00664                                       FALSE,
00665                                       &amp;Iosb );
00666 
00667         <span class="keywordflow">if</span> (Iosb.Information != <span class="keyword">sizeof</span>(ULONG)) {
00668     
00669             <span class="comment">//</span>
00670             <span class="comment">//  Be safe about the count in case the driver didn't fill it in</span>
00671             <span class="comment">//</span>
00672     
00673             MediaChangeCount = 0;
00674         }
00675 
00676         <span class="comment">//</span>
00677         <span class="comment">//  If the volume is now an empty device, or we have receieved a</span>
00678         <span class="comment">//  bare STATUS_VERIFY_REQUIRED (various hardware conditions such</span>
00679         <span class="comment">//  as bus resets, etc., will trigger this in the drivers), or the</span>
00680         <span class="comment">//  media change count has moved since we last inspected the device,</span>
00681         <span class="comment">//  then mark the volume to be verified.</span>
00682         <span class="comment">//      </span>
00683 
00684         <span class="keywordflow">if</span> ((Vcb-&gt;VcbCondition == <a class="code" href="../../d6/d8/udfstruc_8h.html#a130a119">VcbMounted</a> &amp;&amp;
00685              <a class="code" href="../../d3/d8/udfprocs_8h.html#a100">UdfIsRawDevice</a>( IrpContext, Status )) ||
00686             (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_VERIFY_REQUIRED) ||
00687             (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status) &amp;&amp;
00688              (Vcb-&gt;MediaChangeCount != MediaChangeCount))) {
00689 
00690             <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( Vcb-&gt;Vpb-&gt;RealDevice-&gt;Flags, DO_VERIFY_VOLUME );
00691 
00692             <span class="comment">//</span>
00693             <span class="comment">//  If the volume is not mounted and we got a media change count,</span>
00694             <span class="comment">//  update the Vcb so we do not trigger a verify again at this</span>
00695             <span class="comment">//  count value.  If the verify-&gt;mount path detects that the media</span>
00696             <span class="comment">//  has actually changed and this Vcb is valid again, this will have</span>
00697             <span class="comment">//  done nothing.  We are already synchronized since the caller has</span>
00698             <span class="comment">//  the Vcb.</span>
00699             <span class="comment">//</span>
00700 
00701             <span class="keywordflow">if</span> ((Vcb-&gt;VcbCondition == <a class="code" href="../../d6/d8/udfstruc_8h.html#a130a117">VcbNotMounted</a>) &amp;&amp;
00702                 <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(Status)) {
00703 
00704                 Vcb-&gt;MediaChangeCount = MediaChangeCount;
00705             }
00706 
00707         <span class="comment">//</span>
00708         <span class="comment">//  Raise the error condition otherwise.</span>
00709         <span class="comment">//</span>
00710 
00711         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00712 
00713             <a class="code" href="../../d3/d8/udfprocs_8h.html#a123">UdfNormalizeAndRaiseStatus</a>( IrpContext, Status );
00714         }
00715 
00716     }
00717 
00718     <span class="comment">//</span>
00719     <span class="comment">//  The Vcb may be mounted but the underlying real device may need to be verified.</span>
00720     <span class="comment">//  If it does then we'll set the Iosb in the irp to be our real device</span>
00721     <span class="comment">//  and raise Verify required</span>
00722     <span class="comment">//</span>
00723 
00724     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Vcb-&gt;Vpb-&gt;RealDevice-&gt;Flags, DO_VERIFY_VOLUME )) {
00725 
00726         <a class="code" href="../../d4/d6/iosubs_8c.html#a105">IoSetHardErrorOrVerifyDevice</a>( IrpContext-&gt;Irp,
00727                                       Vcb-&gt;Vpb-&gt;RealDevice );
00728 
00729         <a class="code" href="../../d3/d8/udfprocs_8h.html#a122">UdfRaiseStatus</a>( IrpContext, STATUS_VERIFY_REQUIRED );
00730     }
00731 
00732     <span class="comment">//</span>
00733     <span class="comment">//  Based on the condition of the Vcb we'll either return to our</span>
00734     <span class="comment">//  caller or raise an error condition</span>
00735     <span class="comment">//</span>
00736 
00737     <span class="keywordflow">switch</span> (Vcb-&gt;VcbCondition) {
00738 
00739     <span class="keywordflow">case</span> <a class="code" href="../../d6/d8/udfstruc_8h.html#a130a117">VcbNotMounted</a>:
00740 
00741         <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( Vcb-&gt;Vpb-&gt;RealDevice-&gt;Flags, DO_VERIFY_VOLUME );
00742 
00743         <a class="code" href="../../d4/d6/iosubs_8c.html#a105">IoSetHardErrorOrVerifyDevice</a>( IrpContext-&gt;Irp, Vcb-&gt;Vpb-&gt;RealDevice );
00744 
00745         <a class="code" href="../../d3/d8/udfprocs_8h.html#a122">UdfRaiseStatus</a>( IrpContext, STATUS_WRONG_VOLUME );
00746         <span class="keywordflow">break</span>;
00747 
00748     <span class="keywordflow">case</span> <a class="code" href="../../d6/d8/udfstruc_8h.html#a130a120">VcbInvalid</a>:
00749     <span class="keywordflow">case</span> <a class="code" href="../../d6/d8/udfstruc_8h.html#a130a121">VcbDismountInProgress</a> :
00750 
00751         <a class="code" href="../../d3/d8/udfprocs_8h.html#a122">UdfRaiseStatus</a>( IrpContext, STATUS_FILE_INVALID );
00752         <span class="keywordflow">break</span>;
00753     }
00754 
00755     <span class="keywordflow">return</span>;
00756 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a241" doxytag="udfprocs.h::UdfVmcbLbnToVbn" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN UdfVmcbLbnToVbn           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d7/struct__VMCB.html">PVMCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Vmcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a50">LBN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Lbn</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d1/d8/fsrtl_8h.html#a53">PVBN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Vbn</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG SectorCount&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d7/d5/vmcbsup_8c-source.html#l00553">553</a> of file <a class="el" href="../../d7/d5/vmcbsup_8c-source.html">vmcbsup.c</a>.
<p>
References <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d9/d2/lfsdata_8h-source.html#l00187">DebugUnwind</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00623">Executive</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d4/d4/mutntobj_8c-source.html#l00310">KeReleaseMutex()</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00624">KernelMode</a>, <a class="el" href="../../d2/d6/wait_8c-source.html#l00810">KeWaitForSingleObject()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d7/d5/vmcbsup_8c-source.html#l00964">UdfVmcbLookupMcbEntry()</a>, and <a class="el" href="../../d2/d7/hal_8h.html#a212">VOID()</a>.
<p>
Referenced by <a class="el" href="../../d3/d5/allocsup_8c-source.html#l01177">UdfLookupMetaVsnOfExtent()</a>.
<p>
<pre class="fragment"><div>00562                    :
00563 
00564     This routine translates an <a class="code" href="../../d1/d8/fsrtl_8h.html#a50">LBN</a> to a <a class="code" href="../../d1/d8/fsrtl_8h.html#a52">VBN</a>.
00565 
00566 Arguments:
00567 
00568     Vmcb - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d1/d7/struct__VMCB.html">VMCB</a> structure being queried.
00569 
00570     Lbn - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d1/d8/fsrtl_8h.html#a50">LBN</a> to translate from.
00571 
00572     Vbn - Recieves <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d1/d8/fsrtl_8h.html#a52">VBN</a> mapped by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> input <a class="code" href="../../d1/d8/fsrtl_8h.html#a50">LBN</a>.  This value <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a>
00573         <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> valid <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> function result <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>.
00574 
00575     SectorCount - Optionally receives <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> number of sectors corresponding
00576         to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> run.
00577 
00578 Return Value:
00579 
00580     BOOLEAN - <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> mapping <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> valid and <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> otherwise.
00581 
00582 --*/
00583 
00584 {
00585     BOOLEAN Result;
00586 
00587     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00588 
00589     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( +1, Dbg, <span class="stringliteral">"UdfVmcbLbnToVbn, Lbn = %08x\n"</span>, Lbn ));
00590 
00591     <span class="comment">//</span>
00592     <span class="comment">//  If the requested Lbn is greater than the maximum allowed Lbn</span>
00593     <span class="comment">//  then the result is FALSE</span>
00594     <span class="comment">//</span>
00595 
00596     <span class="keywordflow">if</span> (Lbn &gt; Vmcb-&gt;MaximumLbn) {
00597 
00598         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( -1, Dbg, <span class="stringliteral">"Lbn too large, UdfVmcbLbnToVbn -&gt; FALSE\n"</span> ));
00599 
00600         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00601     }
00602 
00603     <span class="comment">//</span>
00604     <span class="comment">//  Now grab the mutex for the vmcb</span>
00605     <span class="comment">//</span>
00606 
00607     (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>)<a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a>( &amp;Vmcb-&gt;Mutex,
00608                                  Executive,
00609                                  KernelMode,
00610                                  FALSE,
00611                                  (PLARGE_INTEGER) NULL );
00612 
00613     <span class="keywordflow">try</span> {
00614 
00615         Result = <a class="code" href="../../d6/d6/vmcbsup_8c.html#a4">UdfVmcbLookupMcbEntry</a>( &amp;Vmcb-&gt;LbnIndexed,
00616                                         Lbn,
00617                                         Vbn,
00618                                         SectorCount,
00619                                         NULL );
00620 
00621         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( 0, Dbg, <span class="stringliteral">"*Vbn = %08x\n"</span>, *Vbn ));
00622 
00623     } finally {
00624 
00625         (<a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>) <a class="code" href="../../d3/d5/mutntobj_8c.html#a5">KeReleaseMutex</a>( &amp;Vmcb-&gt;Mutex, FALSE );
00626 
00627 
00628         <a class="code" href="../../d8/d3/lfsdata_8h.html#a3">DebugUnwind</a>(<span class="stringliteral">"UdfVmcbLbnToVbn"</span>);
00629         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( -1, Dbg, <span class="stringliteral">"UdfVmcbLbnToVbn -&gt; Result = %08x\n"</span>, Result ));
00630     }
00631 
00632     <span class="keywordflow">return</span> Result;
00633 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a240" doxytag="udfprocs.h::UdfVmcbVbnToLbn" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> BOOLEAN UdfVmcbVbnToLbn           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d1/d7/struct__VMCB.html">PVMCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Vmcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d1/d8/fsrtl_8h.html#a52">VBN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Vbn</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT <a class="el" href="../../d1/d8/fsrtl_8h.html#a51">PLBN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Lbn</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>OUT PULONG SectorCount&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>
    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:45:51 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
