<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: close.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>close.c</h1><a href="../../d2/d9/close_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    Close.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module implements the File Close routine for Udfs called by the</span>
00012 <span class="comment">    Fsd/Fsp dispatch routines.</span>
00013 <span class="comment"></span>
00014 <span class="comment">    The close operation interacts with both the async and delayed close queues</span>
00015 <span class="comment">    in the UdfData structure.  Since close may be called recursively we may</span>
00016 <span class="comment">    violate the locking order in acquiring the Vcb or Fcb.  In this case</span>
00017 <span class="comment">    we may move the request to the async close queue.  If this is the last</span>
00018 <span class="comment">    reference on the Fcb and there is a chance the user may reopen this</span>
00019 <span class="comment">    file again soon we would like to defer the close.  In this case we</span>
00020 <span class="comment">    may move the request to the delayed close queue.</span>
00021 <span class="comment"></span>
00022 <span class="comment">    Once we are past the decode file operation there is no need for the</span>
00023 <span class="comment">    file object.  If we are moving the request to either of the work</span>
00024 <span class="comment">    queues then we remember all of the information from the file object and</span>
00025 <span class="comment">    complete the request with STATUS_SUCCESS.  The Io system can then</span>
00026 <span class="comment">    reuse the file object and we can complete the request when convenient.</span>
00027 <span class="comment"></span>
00028 <span class="comment">    The async close queue consists of requests which we would like to</span>
00029 <span class="comment">    complete as soon as possible.  They are queued using the original</span>
00030 <span class="comment">    IrpContext where some of the fields have been overwritten with</span>
00031 <span class="comment">    information from the file object.  We will extract this information,</span>
00032 <span class="comment">    cleanup the IrpContext and then call the close worker routine.</span>
00033 <span class="comment"></span>
00034 <span class="comment">    The delayed close queue consists of requests which we would like to</span>
00035 <span class="comment">    defer the close for.  We keep size of this list within a range</span>
00036 <span class="comment">    determined by the size of the system.  We let it grow to some maximum</span>
00037 <span class="comment">    value and then shrink to some minimum value.  We allocate a small</span>
00038 <span class="comment">    structure which contains the key information from the file object</span>
00039 <span class="comment">    and use this information along with an IrpContext on the stack</span>
00040 <span class="comment">    to complete the request.</span>
00041 <span class="comment"></span>
00042 <span class="comment">Author:</span>
00043 <span class="comment"></span>
00044 <span class="comment">    Dan Lovinger    [DanLo]     04-Nov-1996</span>
00045 <span class="comment"></span>
00046 <span class="comment">Revision History:</span>
00047 <span class="comment"></span>
00048 <span class="comment">--*/</span>
00049 
00050 <span class="preprocessor">#include "UdfProcs.h"</span>
00051 
00052 <span class="comment">//</span>
00053 <span class="comment">//  The Bug check file id for this module</span>
00054 <span class="comment">//</span>
00055 
<a name="l00056"></a><a class="code" href="../../d2/d9/close_8c.html#a0">00056</a> <span class="preprocessor">#define BugCheckFileId                   (UDFS_BUG_CHECK_CLOSE)</span>
00057 <span class="preprocessor"></span>
00058 <span class="comment">//</span>
00059 <span class="comment">//  The local debug trace level</span>
00060 <span class="comment">//</span>
00061 
<a name="l00062"></a><a class="code" href="../../d2/d9/close_8c.html#a1">00062</a> <span class="preprocessor">#define Dbg                              (UDFS_DEBUG_LEVEL_CLOSE)</span>
00063 <span class="preprocessor"></span>
00064 <span class="comment">//</span>
00065 <span class="comment">//  Local support routines</span>
00066 <span class="comment">//</span>
00067 
00068 BOOLEAN
00069 <a class="code" href="../../d2/d9/close_8c.html#a2">UdfCommonClosePrivate</a> (
00070     IN <a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext,
00071     IN <a class="code" href="../../d7/d5/struct__VCB.html">PVCB</a> Vcb,
00072     IN <a class="code" href="../../d7/d9/struct__FCB.html">PFCB</a> Fcb,
00073     IN ULONG UserReference,
00074     IN BOOLEAN FromFsd
00075     );
00076 
00077 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00078 <a class="code" href="../../d2/d9/close_8c.html#a3">UdfQueueClose</a> (
00079     IN <a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext,
00080     IN <a class="code" href="../../d7/d9/struct__FCB.html">PFCB</a> Fcb,
00081     IN ULONG UserReference,
00082     IN BOOLEAN DelayedClose
00083     );
00084 
00085 <a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>
00086 <a class="code" href="../../d2/d9/close_8c.html#a4">UdfRemoveClose</a> (
00087     IN <a class="code" href="../../d7/d5/struct__VCB.html">PVCB</a> Vcb OPTIONAL
00088     );
00089 
00090 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00091 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, UdfCommonClose)</span>
00092 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, UdfCommonClosePrivate)</span>
00093 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, UdfQueueClose)</span>
00094 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, UdfRemoveClose)</span>
00095 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00096 <span class="preprocessor"></span>
00097 
00098 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00099"></a><a class="code" href="../../d3/d8/udfprocs_8h.html#a250">00099</a> <a class="code" href="../../d3/d8/udfprocs_8h.html#a250">UdfFspClose</a> (
00100     IN <a class="code" href="../../d7/d5/struct__VCB.html">PVCB</a> Vcb OPTIONAL
00101     )
00102 
00103 <span class="comment">/*++</span>
00104 <span class="comment"></span>
00105 <span class="comment">Routine Description:</span>
00106 <span class="comment"></span>
00107 <span class="comment">    This routine is called to process the close queues in the UdfData.  If the</span>
00108 <span class="comment">    Vcb is passed then we want to remove all of the closes for this Vcb.</span>
00109 <span class="comment">    Otherwise we will do as many of the delayed closes as we need to do.</span>
00110 <span class="comment"></span>
00111 <span class="comment">Arguments:</span>
00112 <span class="comment"></span>
00113 <span class="comment">    Vcb - If specified then we are looking for all of the closes for the</span>
00114 <span class="comment">        given Vcb.</span>
00115 <span class="comment"></span>
00116 <span class="comment">Return Value:</span>
00117 <span class="comment"></span>
00118 <span class="comment">    None</span>
00119 <span class="comment"></span>
00120 <span class="comment">--*/</span>
00121 
00122 {
00123     <a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext;
00124     <a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html">IRP_CONTEXT</a> StackIrpContext;
00125 
00126     <a class="code" href="../../d0/d1/struct__THREAD__CONTEXT.html">THREAD_CONTEXT</a> <a class="code" href="../../d2/d1/cttoken_8c.html#a62">ThreadContext</a>;
00127 
00128     <a class="code" href="../../d7/d9/struct__FCB.html">PFCB</a> Fcb;
00129     ULONG UserReference;
00130 
00131     ULONG VcbHoldCount = 0;
00132     <a class="code" href="../../d7/d5/struct__VCB.html">PVCB</a> CurrentVcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00133 
00134     BOOLEAN ReleaseUdfData = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00135 
00136     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00137 
00138     <span class="comment">//</span>
00139     <span class="comment">//  Check input.</span>
00140     <span class="comment">//</span>
00141 
00142     <a class="code" href="../../d1/d8/udfdata_8h.html#a13">ASSERT_OPTIONAL_VCB</a>( Vcb );
00143 
00144     <a class="code" href="../../d1/d8/fsrtl_8h.html#a48">FsRtlEnterFileSystem</a>();
00145 
00146     <span class="comment">//</span>
00147     <span class="comment">//  Continue processing until there are no more closes to process.</span>
00148     <span class="comment">//</span>
00149 
00150     <span class="keywordflow">while</span> (IrpContext = <a class="code" href="../../d2/d9/close_8c.html#a4">UdfRemoveClose</a>( Vcb )) {
00151 
00152         <span class="comment">//</span>
00153         <span class="comment">//  If we don't have an IrpContext then use the one on the stack.</span>
00154         <span class="comment">//  Initialize it for this request.</span>
00155         <span class="comment">//</span>
00156 
00157         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d7/udfs_2nodetype_8h.html#a12">SafeNodeType</a>( IrpContext ) != <a class="code" href="../../d1/d7/udfs_2nodetype_8h.html#a7">UDFS_NTC_IRP_CONTEXT</a> ) {
00158 
00159             <span class="comment">//</span>
00160             <span class="comment">//  Update the local values from the IrpContextLite.</span>
00161             <span class="comment">//</span>
00162 
00163             Fcb = ((<a class="code" href="../../d2/d3/struct__IRP__CONTEXT__LITE.html">PIRP_CONTEXT_LITE</a>) IrpContext)-&gt;Fcb;
00164             UserReference = ((<a class="code" href="../../d2/d3/struct__IRP__CONTEXT__LITE.html">PIRP_CONTEXT_LITE</a>) IrpContext)-&gt;UserReference;
00165 
00166             <span class="comment">//</span>
00167             <span class="comment">//  Update the stack irp context with the values from the</span>
00168             <span class="comment">//  IrpContextLite.</span>
00169             <span class="comment">//</span>
00170 
00171             <a class="code" href="../../d3/d8/udfprocs_8h.html#a209">UdfInitializeStackIrpContext</a>( &amp;StackIrpContext,
00172                                           (<a class="code" href="../../d2/d3/struct__IRP__CONTEXT__LITE.html">PIRP_CONTEXT_LITE</a>) IrpContext );
00173 
00174             <span class="comment">//</span>
00175             <span class="comment">//  Free the IrpContextLite.</span>
00176             <span class="comment">//</span>
00177 
00178             <a class="code" href="../../d3/d8/udfprocs_8h.html#a93">UdfFreeIrpContextLite</a>( (<a class="code" href="../../d2/d3/struct__IRP__CONTEXT__LITE.html">PIRP_CONTEXT_LITE</a>) IrpContext );
00179 
00180             <span class="comment">//</span>
00181             <span class="comment">//  Remember we have the IrpContext from the stack.</span>
00182             <span class="comment">//</span>
00183 
00184             IrpContext = &amp;StackIrpContext;
00185 
00186         <span class="comment">//</span>
00187         <span class="comment">//  Otherwise cleanup the existing IrpContext.</span>
00188         <span class="comment">//</span>
00189 
00190         } <span class="keywordflow">else</span> {
00191 
00192             <span class="comment">//</span>
00193             <span class="comment">//  Remember the Fcb and user reference count.</span>
00194             <span class="comment">//</span>
00195 
00196             Fcb = (<a class="code" href="../../d7/d9/struct__FCB.html">PFCB</a>) IrpContext-&gt;<a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html#o2">Irp</a>;
00197             IrpContext-&gt;<a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html#o2">Irp</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00198 
00199             UserReference = (ULONG) IrpContext-&gt;<a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html#o4">ExceptionStatus</a>;
00200             IrpContext-&gt;<a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html#o4">ExceptionStatus</a> = STATUS_SUCCESS;
00201         }
00202 
00203         <span class="comment">//</span>
00204         <span class="comment">//  We have an IrpContext.  Now we need to set the top level thread</span>
00205         <span class="comment">//  context.</span>
00206         <span class="comment">//</span>
00207 
00208         <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( IrpContext-&gt;<a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html#o5">Flags</a>, <a class="code" href="../../d6/d8/udfstruc_8h.html#a42">IRP_CONTEXT_FSP_FLAGS</a> );
00209 
00210         <span class="comment">//</span>
00211         <span class="comment">//  If we were given a Vcb then there is a request on top of this.</span>
00212         <span class="comment">//</span>
00213 
00214         <span class="keywordflow">if</span> (ARGUMENT_PRESENT( Vcb )) {
00215 
00216             <a class="code" href="../../d5/d5/cc_8h.html#a61">ClearFlag</a>( IrpContext-&gt;<a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html#o5">Flags</a>,
00217                        <a class="code" href="../../d6/d8/udfstruc_8h.html#a32">IRP_CONTEXT_FLAG_TOP_LEVEL</a> | <a class="code" href="../../d6/d8/udfstruc_8h.html#a33">IRP_CONTEXT_FLAG_TOP_LEVEL_UDFS</a> );
00218         }
00219 
00220         <a class="code" href="../../d3/d8/udfprocs_8h.html#a130">UdfSetThreadContext</a>( IrpContext, &amp;<a class="code" href="../../d2/d1/cttoken_8c.html#a62">ThreadContext</a> );
00221 
00222         <span class="comment">//</span>
00223         <span class="comment">//  If we have hit the maximum number of requests to process without</span>
00224         <span class="comment">//  releasing the Vcb then release the Vcb now.  If we are holding</span>
00225         <span class="comment">//  a different Vcb to this one then release the previous Vcb.</span>
00226         <span class="comment">//</span>
00227         <span class="comment">//  In either case acquire the current Vcb.</span>
00228         <span class="comment">//</span>
00229         <span class="comment">//  We use the MinDelayedCloseCount from the UdfData since it is</span>
00230         <span class="comment">//  a convenient value based on the system size.  Only thing we are trying</span>
00231         <span class="comment">//  to do here is prevent this routine starving other threads which</span>
00232         <span class="comment">//  may need this Vcb exclusively.</span>
00233         <span class="comment">//</span>
00234 
00235         ReleaseUdfData = !ARGUMENT_PRESENT( Vcb ) &amp;&amp;
00236                          (Fcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o2">Vcb</a>-&gt;<a class="code" href="../../d7/d5/struct__VCB.html#o8">VcbCondition</a> != <a class="code" href="../../d6/d8/udfstruc_8h.html#a130a119">VcbMounted</a>) &amp;&amp;
00237                          (Fcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o2">Vcb</a>-&gt;<a class="code" href="../../d7/d5/struct__VCB.html#o8">VcbCondition</a> != <a class="code" href="../../d6/d8/udfstruc_8h.html#a130a118">VcbMountInProgress</a>) &amp;&amp;
00238                          (Fcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o2">Vcb</a>-&gt;<a class="code" href="../../d7/d5/struct__VCB.html#o15">VcbCleanup</a> == 0);
00239 
00240         <span class="keywordflow">if</span> (ReleaseUdfData ||
00241             (VcbHoldCount &gt; <a class="code" href="../../d0/d8/udfdata_8c.html#a2">UdfData</a>.<a class="code" href="../../d2/d3/struct__UDF__DATA.html#o16">MinDelayedCloseCount</a>) ||
00242             (Fcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o2">Vcb</a> != CurrentVcb)) {
00243 
00244             <span class="keywordflow">if</span> (CurrentVcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00245 
00246                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a76">UdfReleaseVcb</a>( IrpContext, CurrentVcb );
00247             }
00248 
00249             <span class="keywordflow">if</span> (ReleaseUdfData) {
00250 
00251                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a72">UdfAcquireUdfData</a>( IrpContext );
00252             }
00253 
00254             CurrentVcb = Fcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o2">Vcb</a>;
00255             <a class="code" href="../../d3/d8/udfprocs_8h.html#a75">UdfAcquireVcbShared</a>( IrpContext, CurrentVcb, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00256 
00257             VcbHoldCount = 0;
00258 
00259         } <span class="keywordflow">else</span> {
00260 
00261             VcbHoldCount += 1;
00262         }
00263 
00264         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( +1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>,
00265                      <span class="stringliteral">"UdfFspClose, Fcb %08x %4s Vcb %d/%d Fcb %d/%d\n"</span>,
00266                      Fcb,
00267                      ( UserReference? <span class="stringliteral">"USER"</span> : <span class="stringliteral">"SYS"</span> ),
00268                      CurrentVcb-&gt;<a class="code" href="../../d7/d5/struct__VCB.html#o16">VcbReference</a>,
00269                      CurrentVcb-&gt;<a class="code" href="../../d7/d5/struct__VCB.html#o17">VcbUserReference</a>,
00270                      Fcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o8">FcbReference</a>,
00271                      Fcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o9">FcbUserReference</a> ));
00272 
00273         <span class="comment">//</span>
00274         <span class="comment">//  Call our worker routine to perform the close operation.</span>
00275         <span class="comment">//</span>
00276 
00277         <a class="code" href="../../d2/d9/close_8c.html#a2">UdfCommonClosePrivate</a>( IrpContext, CurrentVcb, Fcb, UserReference, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00278 
00279         <span class="comment">//</span>
00280         <span class="comment">//  If the reference count on this Vcb is below our residual reference</span>
00281         <span class="comment">//  then check if we should dismount the volume.</span>
00282         <span class="comment">//</span>
00283 
00284         <span class="keywordflow">if</span> (ReleaseUdfData) {
00285 
00286             <a class="code" href="../../d3/d8/udfprocs_8h.html#a76">UdfReleaseVcb</a>( IrpContext, CurrentVcb );
00287             <a class="code" href="../../d8/d5/udfs_2verfysup_8c.html#a3">UdfCheckForDismount</a>( IrpContext, CurrentVcb, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00288 
00289             CurrentVcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00290 
00291             <a class="code" href="../../d3/d8/udfprocs_8h.html#a73">UdfReleaseUdfData</a>( IrpContext );
00292             ReleaseUdfData = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00293         }
00294 
00295         <span class="comment">//</span>
00296         <span class="comment">//  Complete the current request to cleanup the IrpContext.</span>
00297         <span class="comment">//</span>
00298 
00299         <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, STATUS_SUCCESS );
00300 
00301         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( -1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"UdfFspClose -&gt; VOID\n"</span> ));
00302     }
00303 
00304     <span class="comment">//</span>
00305     <span class="comment">//  Release any Vcb we may still hold.</span>
00306     <span class="comment">//</span>
00307 
00308     <span class="keywordflow">if</span> (CurrentVcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00309 
00310         <a class="code" href="../../d3/d8/udfprocs_8h.html#a76">UdfReleaseVcb</a>( IrpContext, CurrentVcb );
00311     }
00312 
00313     <a class="code" href="../../d1/d8/fsrtl_8h.html#a49">FsRtlExitFileSystem</a>();
00314     <span class="keywordflow">return</span>;
00315 }
00316 
00317 
00318 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00319"></a><a class="code" href="../../d3/d8/udfprocs_8h.html#a252">00319</a> <a class="code" href="../../d3/d8/udfprocs_8h.html#a252">UdfCommonClose</a> (
00320     IN <a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext,
00321     IN <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> Irp
00322     )
00323 
00324 <span class="comment">/*++</span>
00325 <span class="comment"></span>
00326 <span class="comment">Routine Description:</span>
00327 <span class="comment"></span>
00328 <span class="comment">    This routine is the Fsd entry for the close operation.  We decode the file</span>
00329 <span class="comment">    object to find the UDFS structures and type of open.  We call our internal</span>
00330 <span class="comment">    worker routine to perform the actual work.  If the work wasn't completed</span>
00331 <span class="comment">    then we post to one of our worker queues.  The Ccb isn't needed after this</span>
00332 <span class="comment">    point so we delete the Ccb and return STATUS_SUCCESS to our caller in all</span>
00333 <span class="comment">    cases.</span>
00334 <span class="comment"></span>
00335 <span class="comment">Arguments:</span>
00336 <span class="comment"></span>
00337 <span class="comment">    Irp - Supplies the Irp to process</span>
00338 <span class="comment"></span>
00339 <span class="comment">Return Value:</span>
00340 <span class="comment"></span>
00341 <span class="comment">    STATUS_SUCCESS</span>
00342 <span class="comment"></span>
00343 <span class="comment">--*/</span>
00344 
00345 {
00346     <a class="code" href="../../d3/d8/udfprocs_8h.html#a109">TYPE_OF_OPEN</a> TypeOfOpen;
00347 
00348     <a class="code" href="../../d7/d5/struct__VCB.html">PVCB</a> Vcb;
00349     <a class="code" href="../../d7/d9/struct__FCB.html">PFCB</a> Fcb;
00350     <a class="code" href="../../d2/d9/struct__CCB.html">PCCB</a> Ccb;
00351     ULONG UserReference = 0;
00352 
00353     BOOLEAN DelayedClose;
00354     BOOLEAN ReleaseUdfData = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00355 
00356     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00357 
00358     <span class="comment">//</span>
00359     <span class="comment">//  Check input.</span>
00360     <span class="comment">//</span>
00361 
00362     <a class="code" href="../../d1/d8/udfdata_8h.html#a28">ASSERT_IRP_CONTEXT</a>( IrpContext );
00363     <a class="code" href="../../d1/d8/udfdata_8h.html#a32">ASSERT_IRP</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> );
00364 
00365     <span class="comment">//</span>
00366     <span class="comment">//  If we were called with our file system device object instead of a</span>
00367     <span class="comment">//  volume device object, just complete this request with STATUS_SUCCESS.</span>
00368     <span class="comment">//</span>
00369 
00370     <span class="keywordflow">if</span> (IrpContext-&gt;Vcb == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00371 
00372         <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>, STATUS_SUCCESS );
00373         <span class="keywordflow">return</span> STATUS_SUCCESS;
00374     }
00375 
00376     <span class="comment">//</span>
00377     <span class="comment">//  Decode the file object to get the type of open and Fcb/Ccb.</span>
00378     <span class="comment">//</span>
00379 
00380     TypeOfOpen = <a class="code" href="../../d3/d8/udfprocs_8h.html#a174">UdfDecodeFileObject</a>( <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> )-&gt;FileObject,
00381                                       &amp;Fcb,
00382                                       &amp;Ccb );
00383 
00384     <span class="comment">//</span>
00385     <span class="comment">//  No work to do for unopened file objects.</span>
00386     <span class="comment">//</span>
00387 
00388     <span class="keywordflow">if</span> (TypeOfOpen == <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a113">UnopenedFileObject</a>) {
00389 
00390         <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>, STATUS_SUCCESS );
00391 
00392         <span class="keywordflow">return</span> STATUS_SUCCESS;
00393     }
00394 
00395     Vcb = Fcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o2">Vcb</a>;
00396 
00397     <span class="comment">//</span>
00398     <span class="comment">//  Call the worker routine to perform the actual work.  This routine</span>
00399     <span class="comment">//  should never raise except for a fatal error.</span>
00400     <span class="comment">//</span>
00401 
00402     <span class="keywordflow">if</span> (Ccb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00403 
00404         UserReference = 1;
00405 
00406         <span class="comment">//</span>
00407         <span class="comment">//  We can always deallocate the Ccb if present.</span>
00408         <span class="comment">//</span>
00409 
00410         <a class="code" href="../../d3/d8/udfprocs_8h.html#a217">UdfDeleteCcb</a>( IrpContext, Ccb );
00411     }
00412 
00413     <span class="comment">//</span>
00414     <span class="comment">//  If this is a user file or directory then check if we should post</span>
00415     <span class="comment">//  this to the delayed close queue.  This has to be the last reference</span>
00416     <span class="comment">//  for a user file or directory open.</span>
00417     <span class="comment">//</span>
00418 
00419     <span class="keywordflow">if</span> ((Vcb-&gt;<a class="code" href="../../d7/d5/struct__VCB.html#o8">VcbCondition</a> == <a class="code" href="../../d6/d8/udfstruc_8h.html#a130a119">VcbMounted</a>) &amp;&amp;
00420         (Fcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o8">FcbReference</a> == 1) &amp;&amp;
00421         ((TypeOfOpen == <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a117">UserFileOpen</a>) ||
00422          (TypeOfOpen == <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a116">UserDirectoryOpen</a>))) {
00423 
00424         <a class="code" href="../../d2/d9/close_8c.html#a3">UdfQueueClose</a>( IrpContext, Fcb, UserReference, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
00425         IrpContext = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00426 
00427     <span class="comment">//</span>
00428     <span class="comment">//  Otherwise try to process this close.  Post to the async close queue</span>
00429     <span class="comment">//  if we can't acquire all of the resources.</span>
00430     <span class="comment">//</span>
00431 
00432     } <span class="keywordflow">else</span> {
00433 
00434         <span class="comment">//</span>
00435         <span class="comment">//  If we may be dismounting this volume then acquire the UdfData</span>
00436         <span class="comment">//  resource.</span>
00437         <span class="comment">//</span>
00438         <span class="comment">//  Since we now must make volumes go away as soon as reasonable after</span>
00439         <span class="comment">//  the last user handles closes, key off of the cleanup count.  It is</span>
00440         <span class="comment">//  OK to do this more than neccesary.  Since this Fcb could be holding</span>
00441         <span class="comment">//  a number of other Fcbs (and thus their references), a simple check</span>
00442         <span class="comment">//  on reference count is not appropriate.</span>
00443         <span class="comment">//</span>
00444 
00445         <span class="keywordflow">if</span> ((Vcb-&gt;<a class="code" href="../../d7/d5/struct__VCB.html#o15">VcbCleanup</a> == 0) &amp;&amp;
00446             (Vcb-&gt;<a class="code" href="../../d7/d5/struct__VCB.html#o8">VcbCondition</a> != <a class="code" href="../../d6/d8/udfstruc_8h.html#a130a119">VcbMounted</a>) &amp;&amp;
00447             (Vcb-&gt;<a class="code" href="../../d7/d5/struct__VCB.html#o8">VcbCondition</a> != <a class="code" href="../../d6/d8/udfstruc_8h.html#a130a118">VcbMountInProgress</a>) &amp;&amp;
00448             <a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpContext-&gt;Flags, <a class="code" href="../../d6/d8/udfstruc_8h.html#a33">IRP_CONTEXT_FLAG_TOP_LEVEL_UDFS</a> )) {
00449 
00450             <a class="code" href="../../d3/d8/udfprocs_8h.html#a72">UdfAcquireUdfData</a>( IrpContext );
00451             ReleaseUdfData = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00452         }
00453 
00454         <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d9/close_8c.html#a2">UdfCommonClosePrivate</a>( IrpContext, Vcb, Fcb, UserReference, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> )) {
00455 
00456             <span class="comment">//</span>
00457             <span class="comment">//  If we didn't complete the request then post the request as needed.</span>
00458             <span class="comment">//</span>
00459 
00460             <a class="code" href="../../d2/d9/close_8c.html#a3">UdfQueueClose</a>( IrpContext, Fcb, UserReference, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00461             IrpContext = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00462 
00463         <span class="comment">//</span>
00464         <span class="comment">//  Check whether we should be dismounting the volume and then complete</span>
00465         <span class="comment">//  the request.</span>
00466         <span class="comment">//</span>
00467 
00468         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ReleaseUdfData) {
00469 
00470             <a class="code" href="../../d8/d5/udfs_2verfysup_8c.html#a3">UdfCheckForDismount</a>( IrpContext, Vcb, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> );
00471         }
00472     }
00473 
00474     <span class="comment">//</span>
00475     <span class="comment">//  Always complete this request with STATUS_SUCCESS.</span>
00476     <span class="comment">//</span>
00477 
00478     <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>, STATUS_SUCCESS );
00479 
00480     <span class="keywordflow">if</span> (ReleaseUdfData) {
00481 
00482         <a class="code" href="../../d3/d8/udfprocs_8h.html#a73">UdfReleaseUdfData</a>( IrpContext );
00483     }
00484 
00485     <span class="comment">//</span>
00486     <span class="comment">//  Always return STATUS_SUCCESS for closes.</span>
00487     <span class="comment">//</span>
00488 
00489     <span class="keywordflow">return</span> STATUS_SUCCESS;
00490 }
00491 
00492 
00493 <span class="comment">//</span>
00494 <span class="comment">//  Local support routine</span>
00495 <span class="comment">//</span>
00496 
00497 BOOLEAN
<a name="l00498"></a><a class="code" href="../../d2/d9/close_8c.html#a2">00498</a> <a class="code" href="../../d2/d9/close_8c.html#a2">UdfCommonClosePrivate</a> (
00499     IN <a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext,
00500     IN <a class="code" href="../../d7/d5/struct__VCB.html">PVCB</a> Vcb,
00501     IN <a class="code" href="../../d7/d9/struct__FCB.html">PFCB</a> Fcb,
00502     IN ULONG UserReference,
00503     IN BOOLEAN FromFsd
00504     )
00505 
00506 <span class="comment">/*++</span>
00507 <span class="comment"></span>
00508 <span class="comment">Routine Description:</span>
00509 <span class="comment"></span>
00510 <span class="comment">    This is the worker routine for the close operation.  We can be called in</span>
00511 <span class="comment">    an Fsd thread or from a worker Fsp thread.  If called from the Fsd thread</span>
00512 <span class="comment">    then we acquire the resources without waiting.  Otherwise we know it is</span>
00513 <span class="comment">    safe to wait.</span>
00514 <span class="comment"></span>
00515 <span class="comment">    We check to see whether we should post this request to the delayed close</span>
00516 <span class="comment">    queue.  If we are to process the close here then we acquire the Vcb and</span>
00517 <span class="comment">    Fcb.  We will adjust the counts and call our teardown routine to see</span>
00518 <span class="comment">    if any of the structures should go away.</span>
00519 <span class="comment"></span>
00520 <span class="comment">Arguments:</span>
00521 <span class="comment"></span>
00522 <span class="comment">    Vcb - Vcb for this volume.</span>
00523 <span class="comment"></span>
00524 <span class="comment">    Fcb - Fcb for this request.</span>
00525 <span class="comment"></span>
00526 <span class="comment">    UserReference - Number of user references for this file object.  This is</span>
00527 <span class="comment">        zero for an internal stream.</span>
00528 <span class="comment"></span>
00529 <span class="comment">    FromFsd - This request was called from an Fsd thread.  Indicates whether</span>
00530 <span class="comment">        we should wait to acquire resources.</span>
00531 <span class="comment"></span>
00532 <span class="comment">Return Value:</span>
00533 <span class="comment"></span>
00534 <span class="comment">    BOOLEAN - TRUE if this thread processed the close, FALSE otherwise.</span>
00535 <span class="comment"></span>
00536 <span class="comment">--*/</span>
00537 
00538 {
00539     BOOLEAN CompletedClose;
00540     BOOLEAN RemovedFcb;
00541 
00542     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00543 
00544     <span class="comment">//</span>
00545     <span class="comment">//  Check inputs.</span>
00546     <span class="comment">//</span>
00547     
00548     <a class="code" href="../../d1/d8/udfdata_8h.html#a28">ASSERT_IRP_CONTEXT</a>( IrpContext );
00549     <a class="code" href="../../d1/d8/udfdata_8h.html#a12">ASSERT_VCB</a>( Vcb );
00550     <a class="code" href="../../d1/d8/udfdata_8h.html#a14">ASSERT_FCB</a>( Fcb );
00551 
00552     <span class="comment">//</span>
00553     <span class="comment">//  Try to acquire the Vcb and Fcb.  If we can't acquire them then return</span>
00554     <span class="comment">//  and let our caller know he should post the request to the async</span>
00555     <span class="comment">//  queue.</span>
00556     <span class="comment">//</span>
00557 
00558     <span class="keywordflow">if</span> (<a class="code" href="../../d3/d8/udfprocs_8h.html#a75">UdfAcquireVcbShared</a>( IrpContext, Vcb, FromFsd )) {
00559 
00560         <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d8/udfprocs_8h.html#a83">UdfAcquireFcbExclusive</a>( IrpContext, Fcb, FromFsd )) {
00561 
00562             <span class="comment">//</span>
00563             <span class="comment">//  We couldn't get the Fcb.  Release the Vcb and let our caller</span>
00564             <span class="comment">//  know to post this request.</span>
00565             <span class="comment">//</span>
00566 
00567             <a class="code" href="../../d3/d8/udfprocs_8h.html#a76">UdfReleaseVcb</a>( IrpContext, Vcb );
00568             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00569         }
00570 
00571     <span class="comment">//</span>
00572     <span class="comment">//  We didn't get the Vcb.  Let our caller know to post this request.</span>
00573     <span class="comment">//</span>
00574 
00575     } <span class="keywordflow">else</span> {
00576 
00577         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00578     }
00579 
00580     <span class="comment">//</span>
00581     <span class="comment">//  Lock the Vcb and decrement the reference counts.</span>
00582     <span class="comment">//</span>
00583 
00584     <a class="code" href="../../d3/d8/udfprocs_8h.html#a88">UdfLockVcb</a>( IrpContext, Vcb );
00585     
00586     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( +1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>,
00587                  <span class="stringliteral">"UdfCommonClosePrivate, Fcb %08x %4s Vcb %d/%d Fcb %d/%d\n"</span>, Fcb,
00588                  ( UserReference? <span class="stringliteral">"USER"</span> : <span class="stringliteral">"SYS"</span> ),
00589                  Vcb-&gt;VcbReference,
00590                  Vcb-&gt;VcbUserReference,
00591                  Fcb-&gt;FcbReference,
00592                  Fcb-&gt;FcbUserReference ));
00593 
00594     <a class="code" href="../../d3/d8/udfprocs_8h.html#a99">UdfDecrementReferenceCounts</a>( IrpContext, Fcb, 1, UserReference );
00595 
00596     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( +0, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>,
00597                  <span class="stringliteral">"UdfCommonClosePrivate, Vcb %d/%d Fcb %d/%d\n"</span>,
00598                  Vcb-&gt;VcbReference,
00599                  Vcb-&gt;VcbUserReference,
00600                  Fcb-&gt;FcbReference,
00601                  Fcb-&gt;FcbUserReference ));
00602 
00603     <a class="code" href="../../d3/d8/udfprocs_8h.html#a89">UdfUnlockVcb</a>( IrpContext, Vcb );
00604 
00605     <span class="comment">//</span>
00606     <span class="comment">//  Call our teardown routine to see if this object can go away.</span>
00607     <span class="comment">//  If we don't remove the Fcb then release it.</span>
00608     <span class="comment">//</span>
00609 
00610     <a class="code" href="../../d3/d8/udfprocs_8h.html#a210">UdfTeardownStructures</a>( IrpContext, Fcb, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, &amp;RemovedFcb );
00611 
00612     <span class="keywordflow">if</span> (!RemovedFcb) {
00613 
00614         <a class="code" href="../../d3/d8/udfprocs_8h.html#a85">UdfReleaseFcb</a>( IrpContext, Fcb );
00615     }
00616 
00617     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( -1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>,
00618                  <span class="stringliteral">"UdfCommonClosePrivate, RemovedFcb %08x -&gt; %c\n"</span>,
00619                  Fcb,
00620                  ( RemovedFcb? <span class="charliteral">'T'</span> : <span class="charliteral">'F'</span> )));
00621 
00622     <span class="comment">//</span>
00623     <span class="comment">//  Release the Vcb and return to our caller.  Let him know we completed</span>
00624     <span class="comment">//  this request.</span>
00625     <span class="comment">//</span>
00626 
00627     <a class="code" href="../../d3/d8/udfprocs_8h.html#a76">UdfReleaseVcb</a>( IrpContext, Vcb );
00628 
00629     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00630 }
00631 
00632 
00633 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00634"></a><a class="code" href="../../d2/d9/close_8c.html#a3">00634</a> <a class="code" href="../../d2/d9/close_8c.html#a3">UdfQueueClose</a> (
00635     IN <a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext,
00636     IN <a class="code" href="../../d7/d9/struct__FCB.html">PFCB</a> Fcb,
00637     IN ULONG UserReference,
00638     IN BOOLEAN DelayedClose
00639     )
00640 
00641 <span class="comment">/*++</span>
00642 <span class="comment"></span>
00643 <span class="comment">Routine Description:</span>
00644 <span class="comment"></span>
00645 <span class="comment">    This routine is called to queue a request to either the async or delayed</span>
00646 <span class="comment">    close queue.  For the delayed queue we need to allocate a smaller</span>
00647 <span class="comment">    structure to contain the information about the file object.  We do</span>
00648 <span class="comment">    that so we don't put the larger IrpContext structures into this long</span>
00649 <span class="comment">    lived queue.  If we can allocate this structure then we put this</span>
00650 <span class="comment">    on the async queue instead.</span>
00651 <span class="comment"></span>
00652 <span class="comment">Arguments:</span>
00653 <span class="comment"></span>
00654 <span class="comment">    Fcb - Fcb for this file object.</span>
00655 <span class="comment"></span>
00656 <span class="comment">    UserReference - Number of user references for this file object.  This is</span>
00657 <span class="comment">        zero for an internal stream.</span>
00658 <span class="comment"></span>
00659 <span class="comment">    DelayedClose - Indicates whether this should go on the async or delayed</span>
00660 <span class="comment">        close queue.</span>
00661 <span class="comment"></span>
00662 <span class="comment">Return Value:</span>
00663 <span class="comment"></span>
00664 <span class="comment">    None</span>
00665 <span class="comment"></span>
00666 <span class="comment">--*/</span>
00667 
00668 {
00669     <a class="code" href="../../d2/d3/struct__IRP__CONTEXT__LITE.html">PIRP_CONTEXT_LITE</a> IrpContextLite = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00670     BOOLEAN StartWorker = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00671 
00672     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00673 
00674     <span class="comment">//</span>
00675     <span class="comment">//  Check inputs.</span>
00676     <span class="comment">//</span>
00677     
00678     <a class="code" href="../../d1/d8/udfdata_8h.html#a28">ASSERT_IRP_CONTEXT</a>( IrpContext );
00679     <a class="code" href="../../d1/d8/udfdata_8h.html#a14">ASSERT_FCB</a>( Fcb );
00680 
00681     <span class="comment">//</span>
00682     <span class="comment">//  Start with the delayed queue request.  We can move this to the async</span>
00683     <span class="comment">//  queue if there is an allocation failure.</span>
00684     <span class="comment">//</span>
00685 
00686     <span class="keywordflow">if</span> (DelayedClose) {
00687 
00688         <span class="comment">//</span>
00689         <span class="comment">//  Try to allocate non-paged pool for the IRP_CONTEXT_LITE.</span>
00690         <span class="comment">//</span>
00691 
00692         IrpContextLite = <a class="code" href="../../d3/d8/udfprocs_8h.html#a92">UdfCreateIrpContextLite</a>( IrpContext );
00693     }
00694 
00695     <span class="comment">//</span>
00696     <span class="comment">//  We want to clear the top level context in this thread if</span>
00697     <span class="comment">//  necessary.  Call our cleanup routine to do the work.</span>
00698     <span class="comment">//</span>
00699 
00700     <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( IrpContext-&gt;Flags, <a class="code" href="../../d6/d8/udfstruc_8h.html#a29">IRP_CONTEXT_FLAG_MORE_PROCESSING</a> );
00701     <a class="code" href="../../d3/d8/udfprocs_8h.html#a208">UdfCleanupIrpContext</a>( IrpContext, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
00702 
00703     <span class="comment">//</span>
00704     <span class="comment">//  Synchronize with the UdfData lock.</span>
00705     <span class="comment">//</span>
00706 
00707     <a class="code" href="../../d3/d8/udfprocs_8h.html#a86">UdfLockUdfData</a>();
00708 
00709     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( +1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>,
00710                  <span class="stringliteral">"UdfQueueClose, Fcb %08x %4s %5s\n"</span>,
00711                  Fcb,
00712                  ( UserReference? <span class="stringliteral">"USER"</span> : <span class="stringliteral">"SYS"</span> ),
00713                  ( IrpContextLite? <span class="stringliteral">"DELAY"</span> : <span class="stringliteral">"ASYNC"</span> )));
00714 
00715 
00716     <span class="comment">//</span>
00717     <span class="comment">//  If we have an IrpContext then put the request on the delayed close queue.</span>
00718     <span class="comment">//</span>
00719 
00720     <span class="keywordflow">if</span> (IrpContextLite != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00721 
00722         <span class="comment">//</span>
00723         <span class="comment">//  Initialize the IrpContextLite.</span>
00724         <span class="comment">//</span>
00725 
00726         IrpContextLite-&gt;<a class="code" href="../../d2/d3/struct__IRP__CONTEXT__LITE.html#o0">NodeTypeCode</a> = <a class="code" href="../../d1/d7/udfs_2nodetype_8h.html#a8">UDFS_NTC_IRP_CONTEXT_LITE</a>;
00727         IrpContextLite-&gt;<a class="code" href="../../d2/d3/struct__IRP__CONTEXT__LITE.html#o1">NodeByteSize</a> = <span class="keyword">sizeof</span>( <a class="code" href="../../d2/d3/struct__IRP__CONTEXT__LITE.html">IRP_CONTEXT_LITE</a> );
00728         IrpContextLite-&gt;<a class="code" href="../../d2/d3/struct__IRP__CONTEXT__LITE.html#o2">Fcb</a> = Fcb;
00729         IrpContextLite-&gt;<a class="code" href="../../d2/d3/struct__IRP__CONTEXT__LITE.html#o4">UserReference</a> = UserReference;
00730         IrpContextLite-&gt;<a class="code" href="../../d2/d3/struct__IRP__CONTEXT__LITE.html#o5">RealDevice</a> = IrpContext-&gt;RealDevice;
00731 
00732         <span class="comment">//</span>
00733         <span class="comment">//  Add this to the delayed close list and increment</span>
00734         <span class="comment">//  the count.</span>
00735         <span class="comment">//</span>
00736 
00737         InsertTailList( &amp;<a class="code" href="../../d0/d8/udfdata_8c.html#a2">UdfData</a>.<a class="code" href="../../d2/d3/struct__UDF__DATA.html#o13">DelayedCloseQueue</a>,
00738                         &amp;IrpContextLite-&gt;<a class="code" href="../../d2/d3/struct__IRP__CONTEXT__LITE.html#o3">DelayedCloseLinks</a> );
00739 
00740         <a class="code" href="../../d0/d8/udfdata_8c.html#a2">UdfData</a>.<a class="code" href="../../d2/d3/struct__UDF__DATA.html#o14">DelayedCloseCount</a> += 1;
00741 
00742         <span class="comment">//</span>
00743         <span class="comment">//  If we are above our threshold then start the delayed</span>
00744         <span class="comment">//  close operation.</span>
00745         <span class="comment">//</span>
00746 
00747         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d8/udfdata_8c.html#a2">UdfData</a>.<a class="code" href="../../d2/d3/struct__UDF__DATA.html#o14">DelayedCloseCount</a> &gt; <a class="code" href="../../d0/d8/udfdata_8c.html#a2">UdfData</a>.<a class="code" href="../../d2/d3/struct__UDF__DATA.html#o15">MaxDelayedCloseCount</a>) {
00748 
00749             <a class="code" href="../../d0/d8/udfdata_8c.html#a2">UdfData</a>.<a class="code" href="../../d2/d3/struct__UDF__DATA.html#o11">ReduceDelayedClose</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00750 
00751             <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d8/udfdata_8c.html#a2">UdfData</a>.<a class="code" href="../../d2/d3/struct__UDF__DATA.html#o10">FspCloseActive</a>) {
00752 
00753                 <a class="code" href="../../d0/d8/udfdata_8c.html#a2">UdfData</a>.<a class="code" href="../../d2/d3/struct__UDF__DATA.html#o10">FspCloseActive</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00754                 StartWorker = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00755             }
00756         }
00757 
00758         <span class="comment">//</span>
00759         <span class="comment">//  Unlock the global data.</span>
00760         <span class="comment">//</span>
00761 
00762         <a class="code" href="../../d3/d8/udfprocs_8h.html#a87">UdfUnlockUdfData</a>();
00763 
00764         <span class="comment">//</span>
00765         <span class="comment">//  Cleanup the IrpContext.</span>
00766         <span class="comment">//</span>
00767 
00768         <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, STATUS_SUCCESS );
00769 
00770     <span class="comment">//</span>
00771     <span class="comment">//  Otherwise drop into the async case below.</span>
00772     <span class="comment">//</span>
00773 
00774     } <span class="keywordflow">else</span> {
00775 
00776         <span class="comment">//</span>
00777         <span class="comment">//  Store the information about the file object into the IrpContext.</span>
00778         <span class="comment">//</span>
00779 
00780         IrpContext-&gt;Irp = (<a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a>) Fcb;
00781         IrpContext-&gt;ExceptionStatus = (<a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>) UserReference;
00782 
00783         <span class="comment">//</span>
00784         <span class="comment">//  Add this to the async close list and increment the count.</span>
00785         <span class="comment">//</span>
00786 
00787         InsertTailList( &amp;<a class="code" href="../../d0/d8/udfdata_8c.html#a2">UdfData</a>.<a class="code" href="../../d2/d3/struct__UDF__DATA.html#o8">AsyncCloseQueue</a>,
00788                         &amp;IrpContext-&gt;WorkQueueItem.List );
00789 
00790         <a class="code" href="../../d0/d8/udfdata_8c.html#a2">UdfData</a>.<a class="code" href="../../d2/d3/struct__UDF__DATA.html#o9">AsyncCloseCount</a> += 1;
00791 
00792         <span class="comment">//</span>
00793         <span class="comment">//  Remember to start the Fsp close thread if not currently started.</span>
00794         <span class="comment">//</span>
00795 
00796         <span class="keywordflow">if</span> (!<a class="code" href="../../d0/d8/udfdata_8c.html#a2">UdfData</a>.<a class="code" href="../../d2/d3/struct__UDF__DATA.html#o10">FspCloseActive</a>) {
00797 
00798             <a class="code" href="../../d0/d8/udfdata_8c.html#a2">UdfData</a>.<a class="code" href="../../d2/d3/struct__UDF__DATA.html#o10">FspCloseActive</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00799             StartWorker = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00800         }
00801 
00802         <span class="comment">//</span>
00803         <span class="comment">//  Unlock the global data.</span>
00804         <span class="comment">//</span>
00805 
00806         <a class="code" href="../../d3/d8/udfprocs_8h.html#a87">UdfUnlockUdfData</a>();
00807     }
00808 
00809     <span class="comment">//</span>
00810     <span class="comment">//  Start the FspClose thread if we need to.</span>
00811     <span class="comment">//</span>
00812 
00813     <span class="keywordflow">if</span> (StartWorker) {
00814 
00815         <a class="code" href="../../d5/d8/ex_8h.html#a261">ExQueueWorkItem</a>( &amp;<a class="code" href="../../d0/d8/udfdata_8c.html#a2">UdfData</a>.<a class="code" href="../../d2/d3/struct__UDF__DATA.html#o22">CloseItem</a>, <a class="code" href="../../d5/d8/ex_8h.html#a332a205">CriticalWorkQueue</a> );
00816     }
00817 
00818     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( -1, <a class="code" href="../../d9/d5/cdfs__rec_8c.html#a0">Dbg</a>, <span class="stringliteral">"UdfQueueClose -&gt; VOID\n"</span> ));
00819 
00820     <span class="comment">//</span>
00821     <span class="comment">//  Return to our caller.</span>
00822     <span class="comment">//</span>
00823 
00824     <span class="keywordflow">return</span>;
00825 }
00826 
00827 
00828 <span class="comment">//</span>
00829 <span class="comment">//  Local support routine</span>
00830 <span class="comment">//</span>
00831 
00832 <a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>
<a name="l00833"></a><a class="code" href="../../d2/d9/close_8c.html#a4">00833</a> <a class="code" href="../../d2/d9/close_8c.html#a4">UdfRemoveClose</a> (
00834     IN <a class="code" href="../../d7/d5/struct__VCB.html">PVCB</a> Vcb OPTIONAL
00835     )
00836 
00837 <span class="comment">/*++</span>
00838 <span class="comment"></span>
00839 <span class="comment">Routine Description:</span>
00840 <span class="comment"></span>
00841 <span class="comment">Arguments:</span>
00842 <span class="comment"></span>
00843 <span class="comment">    This routine is called to scan the async and delayed close queues looking</span>
00844 <span class="comment">    for a suitable entry.  If the Vcb is specified then we scan both queues</span>
00845 <span class="comment">    looking for an entry with the same Vcb.  Otherwise we will look in the</span>
00846 <span class="comment">    async queue first for any close item.  If none found there then we look</span>
00847 <span class="comment">    in the delayed close queue provided that we have triggered the delayed</span>
00848 <span class="comment">    close operation.</span>
00849 <span class="comment"></span>
00850 <span class="comment">Return Value:</span>
00851 <span class="comment"></span>
00852 <span class="comment">    PIRP_CONTEXT - NULL if no work item found.  Otherwise it is the pointer to</span>
00853 <span class="comment">        either the IrpContext or IrpContextLite for this request.</span>
00854 <span class="comment"></span>
00855 <span class="comment">--*/</span>
00856 
00857 {
00858     <a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00859     <a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> NextIrpContext;
00860     <a class="code" href="../../d2/d3/struct__IRP__CONTEXT__LITE.html">PIRP_CONTEXT_LITE</a> NextIrpContextLite;
00861 
00862     PLIST_ENTRY Entry;
00863 
00864     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00865 
00866     <a class="code" href="../../d1/d8/udfdata_8h.html#a13">ASSERT_OPTIONAL_VCB</a>( Vcb );
00867 
00868     <span class="comment">//</span>
00869     <span class="comment">//  Lock the UdfData to perform the scan.</span>
00870     <span class="comment">//</span>
00871 
00872     <a class="code" href="../../d3/d8/udfprocs_8h.html#a86">UdfLockUdfData</a>();
00873 
00874     <span class="comment">//</span>
00875     <span class="comment">//  First check the list of async closes.</span>
00876     <span class="comment">//</span>
00877 
00878     Entry = <a class="code" href="../../d0/d8/udfdata_8c.html#a2">UdfData</a>.<a class="code" href="../../d2/d3/struct__UDF__DATA.html#o8">AsyncCloseQueue</a>.Flink;
00879 
00880     <span class="keywordflow">while</span> (Entry != &amp;<a class="code" href="../../d0/d8/udfdata_8c.html#a2">UdfData</a>.<a class="code" href="../../d2/d3/struct__UDF__DATA.html#o8">AsyncCloseQueue</a>) {
00881 
00882         <span class="comment">//</span>
00883         <span class="comment">//  Extract the IrpContext.</span>
00884         <span class="comment">//</span>
00885 
00886         NextIrpContext = CONTAINING_RECORD( Entry,
00887                                             <a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html">IRP_CONTEXT</a>,
00888                                             WorkQueueItem.List );
00889 
00890         <span class="comment">//</span>
00891         <span class="comment">//  If no Vcb was specified or this Vcb is for our volume</span>
00892         <span class="comment">//  then perform the close.</span>
00893         <span class="comment">//</span>
00894 
00895         <span class="keywordflow">if</span> (!ARGUMENT_PRESENT( Vcb ) || (NextIrpContext-&gt;<a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html#o3">Vcb</a> == Vcb)) {
00896 
00897             RemoveEntryList( Entry );
00898             <a class="code" href="../../d0/d8/udfdata_8c.html#a2">UdfData</a>.<a class="code" href="../../d2/d3/struct__UDF__DATA.html#o9">AsyncCloseCount</a> -= 1;
00899 
00900             IrpContext = NextIrpContext;
00901             <span class="keywordflow">break</span>;
00902         }
00903 
00904         <span class="comment">//</span>
00905         <span class="comment">//  Move to the next entry.</span>
00906         <span class="comment">//</span>
00907 
00908         Entry = Entry-&gt;Flink;
00909     }
00910 
00911     <span class="comment">//</span>
00912     <span class="comment">//  If we didn't find anything look through the delayed close</span>
00913     <span class="comment">//  queue.</span>
00914     <span class="comment">//</span>
00915     <span class="comment">//  We will only check the delayed close queue if we were given</span>
00916     <span class="comment">//  a Vcb or the delayed close operation is active.</span>
00917     <span class="comment">//</span>
00918 
00919     <span class="keywordflow">if</span> ((IrpContext == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
00920         (ARGUMENT_PRESENT( Vcb ) ||
00921          (<a class="code" href="../../d0/d8/udfdata_8c.html#a2">UdfData</a>.<a class="code" href="../../d2/d3/struct__UDF__DATA.html#o11">ReduceDelayedClose</a> &amp;&amp;
00922           (<a class="code" href="../../d0/d8/udfdata_8c.html#a2">UdfData</a>.<a class="code" href="../../d2/d3/struct__UDF__DATA.html#o14">DelayedCloseCount</a> &gt; <a class="code" href="../../d0/d8/udfdata_8c.html#a2">UdfData</a>.<a class="code" href="../../d2/d3/struct__UDF__DATA.html#o16">MinDelayedCloseCount</a>)))) {
00923 
00924         Entry = <a class="code" href="../../d0/d8/udfdata_8c.html#a2">UdfData</a>.<a class="code" href="../../d2/d3/struct__UDF__DATA.html#o13">DelayedCloseQueue</a>.Flink;
00925 
00926         <span class="keywordflow">while</span> (Entry != &amp;<a class="code" href="../../d0/d8/udfdata_8c.html#a2">UdfData</a>.<a class="code" href="../../d2/d3/struct__UDF__DATA.html#o13">DelayedCloseQueue</a>) {
00927 
00928             <span class="comment">//</span>
00929             <span class="comment">//  Extract the IrpContext.</span>
00930             <span class="comment">//</span>
00931 
00932             NextIrpContextLite = CONTAINING_RECORD( Entry,
00933                                                     <a class="code" href="../../d2/d3/struct__IRP__CONTEXT__LITE.html">IRP_CONTEXT_LITE</a>,
00934                                                     DelayedCloseLinks );
00935 
00936             <span class="comment">//</span>
00937             <span class="comment">//  If no Vcb was specified or this Vcb is for our volume</span>
00938             <span class="comment">//  then perform the close.</span>
00939             <span class="comment">//</span>
00940 
00941             <span class="keywordflow">if</span> (!ARGUMENT_PRESENT( Vcb ) || (NextIrpContextLite-&gt;<a class="code" href="../../d2/d3/struct__IRP__CONTEXT__LITE.html#o2">Fcb</a>-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o2">Vcb</a> == Vcb)) {
00942 
00943                 RemoveEntryList( Entry );
00944                 <a class="code" href="../../d0/d8/udfdata_8c.html#a2">UdfData</a>.<a class="code" href="../../d2/d3/struct__UDF__DATA.html#o14">DelayedCloseCount</a> -= 1;
00945 
00946                 IrpContext = (<a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>) NextIrpContextLite;
00947                 <span class="keywordflow">break</span>;
00948             }
00949 
00950             <span class="comment">//</span>
00951             <span class="comment">//  Move to the next entry.</span>
00952             <span class="comment">//</span>
00953 
00954             Entry = Entry-&gt;Flink;
00955         }
00956     }
00957 
00958     <span class="comment">//</span>
00959     <span class="comment">//  If the Vcb wasn't specified and we couldn't find an entry</span>
00960     <span class="comment">//  then turn off the Fsp thread.</span>
00961     <span class="comment">//</span>
00962 
00963     <span class="keywordflow">if</span> (!ARGUMENT_PRESENT( Vcb ) &amp;&amp; (IrpContext == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>)) {
00964 
00965         <a class="code" href="../../d0/d8/udfdata_8c.html#a2">UdfData</a>.<a class="code" href="../../d2/d3/struct__UDF__DATA.html#o10">FspCloseActive</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00966         <a class="code" href="../../d0/d8/udfdata_8c.html#a2">UdfData</a>.<a class="code" href="../../d2/d3/struct__UDF__DATA.html#o11">ReduceDelayedClose</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00967     }
00968 
00969     <span class="comment">//</span>
00970     <span class="comment">//  Unlock the global data.</span>
00971     <span class="comment">//</span>
00972 
00973     <a class="code" href="../../d3/d8/udfprocs_8h.html#a87">UdfUnlockUdfData</a>();
00974 
00975     <span class="keywordflow">return</span> IrpContext;
00976 }
00977 
00978 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:25 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
