<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: workque.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>workque.c</h1><a href="../../d2/d9/workque_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    WorkQue.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module implements the Work queue routines for the Udfs File</span>
00012 <span class="comment">    system.</span>
00013 <span class="comment"></span>
00014 <span class="comment">Author:</span>
00015 <span class="comment"></span>
00016 <span class="comment">    Dan Lovinger    [DanLo]     23-Sep-1996</span>
00017 <span class="comment"></span>
00018 <span class="comment">Revision History:</span>
00019 <span class="comment"></span>
00020 <span class="comment">--*/</span>
00021 
00022 <span class="preprocessor">#include "UdfProcs.h"</span>
00023 
00024 <span class="comment">//</span>
00025 <span class="comment">//  The Bug check file id for this module</span>
00026 <span class="comment">//</span>
00027 
<a name="l00028"></a><a class="code" href="../../d2/d9/workque_8c.html#a0">00028</a> <span class="preprocessor">#define BugCheckFileId                   (UDFS_BUG_CHECK_WORKQUE)</span>
00029 <span class="preprocessor"></span>
00030 <span class="comment">//</span>
00031 <span class="comment">//  The local debug trace level</span>
00032 <span class="comment">//</span>
00033 
<a name="l00034"></a><a class="code" href="../../d2/d9/workque_8c.html#a1">00034</a> <span class="preprocessor">#define Dbg                              (UDFS_DEBUG_LEVEL_WORKQUE)</span>
00035 <span class="preprocessor"></span>
00036 <span class="comment">//</span>
00037 <span class="comment">//  The following constant is the maximum number of ExWorkerThreads that we</span>
00038 <span class="comment">//  will allow to be servicing a particular target device at any one time.</span>
00039 <span class="comment">//</span>
00040 
<a name="l00041"></a><a class="code" href="../../d2/d9/workque_8c.html#a2">00041</a> <span class="preprocessor">#define FSP_PER_DEVICE_THRESHOLD         (2)</span>
00042 <span class="preprocessor"></span>
00043 <span class="comment">//</span>
00044 <span class="comment">//  Local support routines</span>
00045 <span class="comment">//</span>
00046 
00047 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00048 <a class="code" href="../../d2/d9/workque_8c.html#a3">UdfAddToWorkque</a> (
00049     IN <a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext,
00050     IN <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> Irp
00051     );
00052 
00053 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00054 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, UdfFsdPostRequest)</span>
00055 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, UdfOplockComplete)</span>
00056 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, UdfPrePostIrp)</span>
00057 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00058 <span class="preprocessor"></span>
00059 
00060 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00061"></a><a class="code" href="../../d2/d9/workque_8c.html#a4">00061</a> <a class="code" href="../../d2/d9/workque_8c.html#a4">UdfFsdPostRequest</a> (
00062     IN <a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext,
00063     IN <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> Irp
00064     )
00065 
00066 <span class="comment">/*++</span>
00067 <span class="comment"></span>
00068 <span class="comment">Routine Description:</span>
00069 <span class="comment"></span>
00070 <span class="comment">    This routine enqueues the request packet specified by IrpContext to the</span>
00071 <span class="comment">    work queue associated with the FileSystemDeviceObject.  This is a FSD</span>
00072 <span class="comment">    routine.</span>
00073 <span class="comment"></span>
00074 <span class="comment">Arguments:</span>
00075 <span class="comment"></span>
00076 <span class="comment">    IrpContext - Pointer to the IrpContext to be queued to the Fsp.</span>
00077 <span class="comment"></span>
00078 <span class="comment">    Irp - I/O Request Packet.</span>
00079 <span class="comment"></span>
00080 <span class="comment">Return Value:</span>
00081 <span class="comment"></span>
00082 <span class="comment">    STATUS_PENDING</span>
00083 <span class="comment"></span>
00084 <span class="comment">--*/</span>
00085 
00086 {
00087     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00088 
00089     <a class="code" href="../../d1/d8/udfdata_8h.html#a28">ASSERT_IRP_CONTEXT</a>( IrpContext );
00090     <a class="code" href="../../d1/d8/udfdata_8h.html#a32">ASSERT_IRP</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> );
00091 
00092     <span class="comment">//</span>
00093     <span class="comment">//  Posting is a three step operation.  First lock down any buffers</span>
00094     <span class="comment">//  in the Irp.  Next cleanup the IrpContext for the post and finally</span>
00095     <span class="comment">//  add this to a workque.</span>
00096     <span class="comment">//</span>
00097 
00098     <a class="code" href="../../d2/d9/workque_8c.html#a5">UdfPrePostIrp</a>( IrpContext, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> );
00099 
00100     <a class="code" href="../../d2/d9/workque_8c.html#a3">UdfAddToWorkque</a>( IrpContext, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> );
00101 
00102     <span class="comment">//</span>
00103     <span class="comment">//  And return to our caller</span>
00104     <span class="comment">//</span>
00105 
00106     <span class="keywordflow">return</span> STATUS_PENDING;
00107 }
00108 
00109 
00110 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00111"></a><a class="code" href="../../d2/d9/workque_8c.html#a5">00111</a> <a class="code" href="../../d2/d9/workque_8c.html#a5">UdfPrePostIrp</a> (
00112     IN <a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext,
00113     IN <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> Irp
00114     )
00115 
00116 <span class="comment">/*++</span>
00117 <span class="comment"></span>
00118 <span class="comment">Routine Description:</span>
00119 <span class="comment"></span>
00120 <span class="comment">    This routine performs any neccessary work before STATUS_PENDING is</span>
00121 <span class="comment">    returned with the Fsd thread.  This routine is called within the</span>
00122 <span class="comment">    filesystem and by the oplock package.</span>
00123 <span class="comment"></span>
00124 <span class="comment">Arguments:</span>
00125 <span class="comment"></span>
00126 <span class="comment">    Context - Pointer to the IrpContext to be queued to the Fsp</span>
00127 <span class="comment"></span>
00128 <span class="comment">    Irp - I/O Request Packet.</span>
00129 <span class="comment"></span>
00130 <span class="comment">Return Value:</span>
00131 <span class="comment"></span>
00132 <span class="comment">    None.</span>
00133 <span class="comment"></span>
00134 <span class="comment">--*/</span>
00135 
00136 {
00137     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp = <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> );
00138     BOOLEAN RemovedFcb;
00139 
00140     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00141 
00142     <a class="code" href="../../d1/d8/udfdata_8h.html#a28">ASSERT_IRP_CONTEXT</a>( IrpContext );
00143     <a class="code" href="../../d1/d8/udfdata_8h.html#a32">ASSERT_IRP</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> );
00144 
00145     <span class="comment">//</span>
00146     <span class="comment">//  Case on the type of the operation.</span>
00147     <span class="comment">//</span>
00148 
00149     <span class="keywordflow">switch</span> (IrpContext-&gt;MajorFunction) {
00150 
00151     <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a13">IRP_MJ_CREATE</a> :
00152 
00153         <span class="comment">//</span>
00154         <span class="comment">//  If called from the oplock package then there is an</span>
00155         <span class="comment">//  Fcb to possibly teardown.  We will call the teardown</span>
00156         <span class="comment">//  routine and release the Fcb if still present.  The cleanup</span>
00157         <span class="comment">//  code in create will know not to release this Fcb because</span>
00158         <span class="comment">//  we will clear the pointer.</span>
00159         <span class="comment">//</span>
00160 
00161         <span class="keywordflow">if</span> ((IrpContext-&gt;TeardownFcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
00162             *(IrpContext-&gt;TeardownFcb) != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00163 
00164             <a class="code" href="../../d3/d8/udfprocs_8h.html#a210">UdfTeardownStructures</a>( IrpContext, *(IrpContext-&gt;TeardownFcb), <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, &amp;RemovedFcb );
00165 
00166             <span class="keywordflow">if</span> (!RemovedFcb) {
00167 
00168                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a85">UdfReleaseFcb</a>( IrpContext, *(IrpContext-&gt;TeardownFcb) );
00169             }
00170 
00171             *(IrpContext-&gt;TeardownFcb) = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00172             IrpContext-&gt;TeardownFcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00173         }
00174 
00175         <span class="keywordflow">break</span>;
00176 
00177     <span class="comment">//</span>
00178     <span class="comment">//  We need to lock the user's buffer, unless this is an MDL-read,</span>
00179     <span class="comment">//  in which case there is no user buffer.</span>
00180     <span class="comment">//</span>
00181 
00182     <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a16">IRP_MJ_READ</a> :
00183 
00184         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpContext-&gt;MinorFunction, <a class="code" href="../../d0/d5/io_8h.html#a58">IRP_MN_MDL</a> )) {
00185 
00186             <a class="code" href="../../d3/d8/udfprocs_8h.html#a71">UdfLockUserBuffer</a>( IrpContext, IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.Read.Length );
00187         }
00188 
00189         <span class="keywordflow">break</span>;
00190 
00191     <span class="comment">//</span>
00192     <span class="comment">//  We also need to check whether this is a query file operation.</span>
00193     <span class="comment">//</span>
00194     
00195     <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a25">IRP_MJ_DIRECTORY_CONTROL</a> :
00196 
00197         <span class="keywordflow">if</span> (IrpContext-&gt;MinorFunction == <a class="code" href="../../d0/d5/io_8h.html#a44">IRP_MN_QUERY_DIRECTORY</a>) {
00198 
00199             <a class="code" href="../../d3/d8/udfprocs_8h.html#a71">UdfLockUserBuffer</a>( IrpContext, IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.QueryDirectory.Length );
00200         }
00201 
00202         <span class="keywordflow">break</span>;
00203     }
00204     <span class="comment">//</span>
00205     <span class="comment">//  Cleanup the IrpContext for the post.</span>
00206     <span class="comment">//</span>
00207 
00208     <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( IrpContext-&gt;Flags, <a class="code" href="../../d6/d8/udfstruc_8h.html#a29">IRP_CONTEXT_FLAG_MORE_PROCESSING</a> );
00209     <a class="code" href="../../d3/d8/udfprocs_8h.html#a208">UdfCleanupIrpContext</a>( IrpContext, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a> );
00210 
00211     <span class="comment">//</span>
00212     <span class="comment">//  Mark the Irp to show that we've already returned pending to the user.</span>
00213     <span class="comment">//</span>
00214 
00215     <a class="code" href="../../d0/d5/io_8h.html#a234">IoMarkIrpPending</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> );
00216 
00217     <span class="keywordflow">return</span>;
00218 }
00219 
00220 
00221 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00222"></a><a class="code" href="../../d2/d9/workque_8c.html#a6">00222</a> <a class="code" href="../../d2/d9/workque_8c.html#a6">UdfOplockComplete</a> (
00223     IN <a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext,
00224     IN <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> Irp
00225     )
00226 
00227 <span class="comment">/*++</span>
00228 <span class="comment"></span>
00229 <span class="comment">Routine Description:</span>
00230 <span class="comment"></span>
00231 <span class="comment">    This routine is called by the oplock package when an oplock break has</span>
00232 <span class="comment">    completed, allowing an Irp to resume execution.  If the status in</span>
00233 <span class="comment">    the Irp is STATUS_SUCCESS, then we queue the Irp to the Fsp queue.</span>
00234 <span class="comment">    Otherwise we complete the Irp with the status in the Irp.</span>
00235 <span class="comment"></span>
00236 <span class="comment">    If we are completing due to an error then check if there is any</span>
00237 <span class="comment">    cleanup to do.</span>
00238 <span class="comment"></span>
00239 <span class="comment">Arguments:</span>
00240 <span class="comment"></span>
00241 <span class="comment">    Irp - I/O Request Packet.</span>
00242 <span class="comment"></span>
00243 <span class="comment">Return Value:</span>
00244 <span class="comment"></span>
00245 <span class="comment">    None.</span>
00246 <span class="comment"></span>
00247 <span class="comment">--*/</span>
00248 
00249 {
00250     BOOLEAN RemovedFcb;
00251 
00252     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00253 
00254     <span class="comment">//</span>
00255     <span class="comment">//  Check on the return value in the Irp.  If success then we</span>
00256     <span class="comment">//  are to post this request.</span>
00257     <span class="comment">//</span>
00258 
00259     <span class="keywordflow">if</span> (<a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status == STATUS_SUCCESS) {
00260 
00261         <span class="comment">//</span>
00262         <span class="comment">//  Check if there is any cleanup work to do.</span>
00263         <span class="comment">//</span>
00264 
00265         <span class="keywordflow">switch</span> (IrpContext-&gt;MajorFunction) {
00266 
00267         <span class="keywordflow">case</span> <a class="code" href="../../d0/d5/io_8h.html#a13">IRP_MJ_CREATE</a> :
00268 
00269             <span class="comment">//</span>
00270             <span class="comment">//  If called from the oplock package then there is an</span>
00271             <span class="comment">//  Fcb to possibly teardown.  We will call the teardown</span>
00272             <span class="comment">//  routine and release the Fcb if still present.  The cleanup</span>
00273             <span class="comment">//  code in create will know not to release this Fcb because</span>
00274             <span class="comment">//  we will clear the pointer.</span>
00275             <span class="comment">//</span>
00276 
00277             <span class="keywordflow">if</span> (IrpContext-&gt;TeardownFcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00278 
00279                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a210">UdfTeardownStructures</a>( IrpContext, *(IrpContext-&gt;TeardownFcb), <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, &amp;RemovedFcb );
00280 
00281                 <span class="keywordflow">if</span> (!RemovedFcb) {
00282 
00283                     <a class="code" href="../../d3/d8/udfprocs_8h.html#a85">UdfReleaseFcb</a>( IrpContext, *(IrpContext-&gt;TeardownFcb) );
00284                 }
00285 
00286                 *(IrpContext-&gt;TeardownFcb) = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00287                 IrpContext-&gt;TeardownFcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00288             }
00289 
00290             <span class="keywordflow">break</span>;
00291         }
00292         <span class="comment">//</span>
00293         <span class="comment">//  Insert the Irp context in the workqueue.</span>
00294         <span class="comment">//</span>
00295 
00296         <a class="code" href="../../d2/d9/workque_8c.html#a3">UdfAddToWorkque</a>( IrpContext, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> );
00297 
00298     <span class="comment">//</span>
00299     <span class="comment">//  Otherwise complete the request.</span>
00300     <span class="comment">//</span>
00301 
00302     } <span class="keywordflow">else</span> {
00303 
00304         <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>, <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>-&gt;<a class="code" href="../../d0/d2/struct__IRP.html#o9">IoStatus</a>.Status );
00305     }
00306 
00307     <span class="keywordflow">return</span>;
00308 }
00309 
00310 
00311 <span class="comment">//</span>
00312 <span class="comment">//  Local support routine</span>
00313 <span class="comment">//</span>
00314 
00315 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00316"></a><a class="code" href="../../d2/d9/workque_8c.html#a3">00316</a> <a class="code" href="../../d2/d9/workque_8c.html#a3">UdfAddToWorkque</a> (
00317     IN <a class="code" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext,
00318     IN <a class="code" href="../../d0/d2/struct__IRP.html">PIRP</a> Irp
00319     )
00320 
00321 <span class="comment">/*++</span>
00322 <span class="comment"></span>
00323 <span class="comment">Routine Description:</span>
00324 <span class="comment"></span>
00325 <span class="comment">    This routine is called to acually store the posted Irp to the Fsp</span>
00326 <span class="comment">    workque.</span>
00327 <span class="comment"></span>
00328 <span class="comment">Arguments:</span>
00329 <span class="comment"></span>
00330 <span class="comment">    IrpContext - Pointer to the IrpContext to be queued to the Fsp</span>
00331 <span class="comment"></span>
00332 <span class="comment">    Irp - I/O Request Packet.</span>
00333 <span class="comment"></span>
00334 <span class="comment">Return Value:</span>
00335 <span class="comment"></span>
00336 <span class="comment">    None.</span>
00337 <span class="comment"></span>
00338 <span class="comment">--*/</span>
00339 
00340 {
00341     <a class="code" href="../../d6/d7/struct__VOLUME__DEVICE__OBJECT.html">PVOLUME_DEVICE_OBJECT</a> Vdo;
00342     KIRQL SavedIrql;
00343     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp = <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>( <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> );
00344 
00345     <span class="comment">//</span>
00346     <span class="comment">//  Check if this request has an associated file object, and thus volume</span>
00347     <span class="comment">//  device object.</span>
00348     <span class="comment">//</span>
00349 
00350     <span class="keywordflow">if</span> (IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00351 
00352 
00353         Vdo = CONTAINING_RECORD( IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o57">DeviceObject</a>,
00354                                  <a class="code" href="../../d6/d7/struct__VOLUME__DEVICE__OBJECT.html">VOLUME_DEVICE_OBJECT</a>,
00355                                  DeviceObject );
00356 
00357         <span class="comment">//</span>
00358         <span class="comment">//  Check to see if this request should be sent to the overflow</span>
00359         <span class="comment">//  queue.  If not, then send it off to an exworker thread.</span>
00360         <span class="comment">//</span>
00361 
00362         <a class="code" href="../../d4/d9/ke_8h.html#a37">KeAcquireSpinLock</a>( &amp;Vdo-&gt;<a class="code" href="../../d6/d7/struct__VOLUME__DEVICE__OBJECT.html#o4">OverflowQueueSpinLock</a>, &amp;SavedIrql );
00363 
00364         <span class="keywordflow">if</span> (Vdo-&gt;<a class="code" href="../../d6/d7/struct__VOLUME__DEVICE__OBJECT.html#o1">PostedRequestCount</a> &gt; <a class="code" href="../../d2/d9/workque_8c.html#a2">FSP_PER_DEVICE_THRESHOLD</a>) {
00365 
00366             <span class="comment">//</span>
00367             <span class="comment">//  We cannot currently respond to this IRP so we'll just enqueue it</span>
00368             <span class="comment">//  to the overflow queue on the volume.</span>
00369             <span class="comment">//</span>
00370 
00371             InsertTailList( &amp;Vdo-&gt;<a class="code" href="../../d6/d7/struct__VOLUME__DEVICE__OBJECT.html#o3">OverflowQueue</a>,
00372                             &amp;IrpContext-&gt;WorkQueueItem.List );
00373 
00374             Vdo-&gt;<a class="code" href="../../d6/d7/struct__VOLUME__DEVICE__OBJECT.html#o2">OverflowQueueCount</a> += 1;
00375 
00376             <a class="code" href="../../d9/d5/verifier_8c.html#a119">KeReleaseSpinLock</a>( &amp;Vdo-&gt;<a class="code" href="../../d6/d7/struct__VOLUME__DEVICE__OBJECT.html#o4">OverflowQueueSpinLock</a>, SavedIrql );
00377 
00378             <span class="keywordflow">return</span>;
00379 
00380         } <span class="keywordflow">else</span> {
00381 
00382             <span class="comment">//</span>
00383             <span class="comment">//  We are going to send this Irp to an ex worker thread so up</span>
00384             <span class="comment">//  the count.</span>
00385             <span class="comment">//</span>
00386 
00387             Vdo-&gt;<a class="code" href="../../d6/d7/struct__VOLUME__DEVICE__OBJECT.html#o1">PostedRequestCount</a> += 1;
00388 
00389             <a class="code" href="../../d9/d5/verifier_8c.html#a119">KeReleaseSpinLock</a>( &amp;Vdo-&gt;<a class="code" href="../../d6/d7/struct__VOLUME__DEVICE__OBJECT.html#o4">OverflowQueueSpinLock</a>, SavedIrql );
00390         }
00391     }
00392 
00393     <span class="comment">//</span>
00394     <span class="comment">//  Send it off.....</span>
00395     <span class="comment">//</span>
00396 
00397     <a class="code" href="../../d5/d8/ex_8h.html#a55">ExInitializeWorkItem</a>( &amp;IrpContext-&gt;WorkQueueItem,
00398                           <a class="code" href="../../d0/d8/fspdisp_8c.html#a2">UdfFspDispatch</a>,
00399                           IrpContext );
00400 
00401     <a class="code" href="../../d5/d8/ex_8h.html#a261">ExQueueWorkItem</a>( &amp;IrpContext-&gt;WorkQueueItem, <a class="code" href="../../d5/d8/ex_8h.html#a332a205">CriticalWorkQueue</a> );
00402 
00403     <span class="keywordflow">return</span>;
00404 }
00405 
00406 
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:42:27 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
