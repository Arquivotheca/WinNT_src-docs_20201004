<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: uipriv.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>uipriv.c</h1><a href="../../d2/d9/uipriv_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    priv.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module provides a command capability to enable and disable</span>
00012 <span class="comment">    privileges.  This command is expected to be an internal cmd.exe</span>
00013 <span class="comment">    command, but is expected to be passed parameters as if it were</span>
00014 <span class="comment">    an external command.</span>
00015 <span class="comment"></span>
00016 <span class="comment"></span>
00017 <span class="comment">    THIS IS A TEMPORARY COMMAND.  IF IT IS DESIRED TO MAKE THIS A</span>
00018 <span class="comment">    PERMANENT COMMAND, THEN THIS FILE NEEDS TO BE GONE THROUGH WITH</span>
00019 <span class="comment">    A FINE-TOOTH COMB TO ROBUSTLY HANDLE ALL ERROR SITUATIONS AND TO</span>
00020 <span class="comment">    PROVIDE APPROPRIATE ERROR MESSAGES.</span>
00021 <span class="comment"></span>
00022 <span class="comment">Author:</span>
00023 <span class="comment"></span>
00024 <span class="comment">    Jim Kelly  1-Apr-1991.</span>
00025 <span class="comment"></span>
00026 <span class="comment">Revision History:</span>
00027 <span class="comment"></span>
00028 <span class="comment">--*/</span>
00029 
00030 <span class="preprocessor">#include &lt;nt.h&gt;</span>
00031 <span class="preprocessor">#include &lt;ntrtl.h&gt;</span>
00032 
00033 <span class="comment">//#include &lt;sys\types.h&gt;</span>
00034 <span class="comment">//#include &lt;sys\stat.h&gt;</span>
00035 <span class="comment">//#include &lt;malloc.h&gt;</span>
00036 <span class="comment">//#include &lt;stdlib.h&gt;</span>
00037 <span class="comment">//#include &lt;ctype.h&gt;</span>
00038 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00039 <span class="preprocessor">#include &lt;string.h&gt;</span>
00040 
00041 <span class="comment">//#include &lt;tools.h&gt;</span>
00042 
00043 <span class="comment">//</span>
00044 <span class="comment">// command qualifier flag values</span>
00045 <span class="comment">//</span>
00046 
<a name="l00047"></a><a class="code" href="../../d2/d9/uipriv_8c.html#a1">00047</a> BOOLEAN <a class="code" href="../../d2/d9/uipriv_8c.html#a1">SwitchEnable</a>  = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
<a name="l00048"></a><a class="code" href="../../d2/d9/uipriv_8c.html#a2">00048</a> BOOLEAN <a class="code" href="../../d2/d9/uipriv_8c.html#a2">SwitchDisable</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
<a name="l00049"></a><a class="code" href="../../d2/d9/uipriv_8c.html#a3">00049</a> BOOLEAN <a class="code" href="../../d2/d9/uipriv_8c.html#a3">SwitchReset</a>   = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
<a name="l00050"></a><a class="code" href="../../d2/d9/uipriv_8c.html#a4">00050</a> BOOLEAN <a class="code" href="../../d2/d9/uipriv_8c.html#a4">SwitchAll</a>     = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00051 
00052 <span class="preprocessor">#ifndef SHIFT</span>
<a name="l00053"></a><a class="code" href="../../d2/d9/uipriv_8c.html#a0">00053</a> <span class="preprocessor"></span><span class="preprocessor">#define SHIFT(c,v)      {c--; v++;}</span>
00054 <span class="preprocessor"></span><span class="preprocessor">#endif //SHIFT</span>
00055 <span class="preprocessor"></span>
00056 
00057 
00058 
00059 <span class="comment">//</span>
00060 <span class="comment">// Function definitions...</span>
00061 <span class="comment">//</span>
00062 
00063 
00064 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00065 <a class="code" href="../../d1/d1/hivedmp_8c.html#a6">Usage</a> ( VOID );
00066 
00067 BOOLEAN
00068 <a class="code" href="../../d2/d9/uipriv_8c.html#a6">OpenAppropriateToken</a>(
00069     OUT PHANDLE Token
00070     );
00071 
00072 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00073 <a class="code" href="../../d2/d9/uipriv_8c.html#a7">EnableAllPrivileges</a>( VOID );
00074 
00075 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00076 <a class="code" href="../../d2/d9/uipriv_8c.html#a8">ResetAllPrivileges</a>( VOID );
00077 
00078 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00079 <a class="code" href="../../d2/d9/uipriv_8c.html#a9">DisableAllPrivileges</a>( VOID );
00080 
00081 <span class="keywordtype">int</span>
00082 <a class="code" href="../../d2/d9/uipriv_8c.html#a10">PrivMain</a> (
00083     IN <span class="keywordtype">int</span> c,
00084     IN PCHAR v[]
00085     );
00086 
00087 
00088 
00089 
00090 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00091 <a class="code" href="../../d1/d1/hivedmp_8c.html#a6">Usage</a> (
00092     VOID
00093     )
00094 <span class="comment">/*++</span>
00095 <span class="comment"></span>
00096 <span class="comment"></span>
00097 <span class="comment">Routine Description:</span>
00098 <span class="comment"></span>
00099 <span class="comment">    This routine prints the "Usage:" message.</span>
00100 <span class="comment"></span>
00101 <span class="comment">Arguments:</span>
00102 <span class="comment"></span>
00103 <span class="comment">    None.</span>
00104 <span class="comment"></span>
00105 <span class="comment">Return Value:</span>
00106 <span class="comment"></span>
00107 <span class="comment">    None.</span>
00108 <span class="comment"></span>
00109 <span class="comment">--*/</span>
00110 {
00111 
00112     printf( <span class="stringliteral">"\n"</span>);
00113     printf( <span class="stringliteral">"\n"</span>);
00114 
00115     printf( <span class="stringliteral">"Usage: priv [/EDRA] {PrivilegeName}\n"</span>);
00116     printf( <span class="stringliteral">"           /E - Enable Privilege(s)\n"</span>);
00117     printf( <span class="stringliteral">"           /D - Disable Privilege(s)\n"</span>);
00118     printf( <span class="stringliteral">"           /R - Reset to default setting(s)\n"</span>);
00119     printf( <span class="stringliteral">"           /A - Apply To All Privileges\n"</span>);
00120     printf( <span class="stringliteral">"\n"</span>);
00121 
00122     printf( <span class="stringliteral">"    The qualifiers /E and /D are mutually exclusive and can not\n"</span>);
00123     printf( <span class="stringliteral">"    be used in the same command.\n"</span>);
00124     printf( <span class="stringliteral">"    If /A is specified, then the PrivilegeName is ignored.\n"</span>);
00125     printf( <span class="stringliteral">"\n"</span>);
00126     printf( <span class="stringliteral">"\n"</span>);
00127     printf( <span class="stringliteral">"Examples:\n"</span>);
00128     printf( <span class="stringliteral">"\n"</span>);
00129     printf( <span class="stringliteral">"    priv /ae\n"</span>);
00130     printf( <span class="stringliteral">"    (enables all held privileges.\n"</span>);
00131     printf( <span class="stringliteral">"\n"</span>);
00132     printf( <span class="stringliteral">"    priv /ad\n"</span>);
00133     printf( <span class="stringliteral">"    disables all held privileges.\n"</span>);
00134     printf( <span class="stringliteral">"\n"</span>);
00135     printf( <span class="stringliteral">"    priv /ar\n"</span>);
00136     printf( <span class="stringliteral">"    (returns all privileges to their default setting.\n"</span>);
00137     printf( <span class="stringliteral">"\n"</span>);
00138     printf( <span class="stringliteral">"    priv /e SeSetTimePrivilege\n"</span>);
00139     printf( <span class="stringliteral">"    (enables the privileges called: SeSetTimePrivilege\n"</span>);
00140     printf( <span class="stringliteral">"\n"</span>);
00141     printf( <span class="stringliteral">"\n"</span>);
00142 
00143     <span class="keywordflow">return</span>;
00144 }
00145 
00146 
00147 BOOLEAN
<a name="l00148"></a><a class="code" href="../../d2/d9/uipriv_8c.html#a6">00148</a> <a class="code" href="../../d2/d9/uipriv_8c.html#a6">OpenAppropriateToken</a>(
00149     OUT PHANDLE Token
00150     )
00151 <span class="comment">/*++</span>
00152 <span class="comment"></span>
00153 <span class="comment"></span>
00154 <span class="comment">Routine Description:</span>
00155 <span class="comment"></span>
00156 <span class="comment">    This routine opens the appropriate TOKEN object.  For an internal</span>
00157 <span class="comment">    command, this is the current process's token.  If this command is</span>
00158 <span class="comment">    ever made external, then it will be the parent process's token.</span>
00159 <span class="comment"></span>
00160 <span class="comment">    If the token can't be openned, then a messages is printed indicating</span>
00161 <span class="comment">    a problem has been encountered.</span>
00162 <span class="comment"></span>
00163 <span class="comment">    The caller is expected to close this token when no longer needed.</span>
00164 <span class="comment"></span>
00165 <span class="comment"></span>
00166 <span class="comment">Arguments:</span>
00167 <span class="comment"></span>
00168 <span class="comment">    Token - Receives the handle value of the openned token.</span>
00169 <span class="comment"></span>
00170 <span class="comment"></span>
00171 <span class="comment">Return Value:</span>
00172 <span class="comment"></span>
00173 <span class="comment">    TRUE - Indicates the token was successfully openned.</span>
00174 <span class="comment"></span>
00175 <span class="comment">    FALSE - Indicates the token was NOT successfully openned.</span>
00176 <span class="comment"></span>
00177 <span class="comment">--*/</span>
00178 
00179 {
00180     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>, IgnoreStatus;
00181     OBJECT_ATTRIBUTES ProcessAttributes;
00182     HANDLE Process;
00183     PTEB CurrentTeb;
00184 
00185     CurrentTeb = NtCurrentTeb();
00186     InitializeObjectAttributes(&amp;ProcessAttributes, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, 0, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>, <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>);
00187     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/psopen_8c.html#a0">NtOpenProcess</a>(
00188                  &amp;Process,                   <span class="comment">// TargetHandle</span>
00189                  PROCESS_QUERY_INFORMATION,  <span class="comment">// DesiredAccess</span>
00190                  &amp;ProcessAttributes,         <span class="comment">// ObjectAttributes</span>
00191                  &amp;CurrentTeb-&gt;ClientId       <span class="comment">// ClientId</span>
00192                  );
00193 
00194     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00195 
00196         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d3/tokenopn_8c.html#a1">NtOpenProcessToken</a>(
00197                      Process,
00198                      TOKEN_ADJUST_PRIVILEGES |
00199                      TOKEN_QUERY,
00200                      <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>
00201                      );
00202 
00203          IgnoreStatus = <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( Process );
00204 
00205          <span class="keywordflow">if</span> ( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) ) {
00206 
00207              <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00208 
00209          }
00210 
00211     }
00212 
00213     printf( <span class="stringliteral">"\n"</span>);
00214     printf( <span class="stringliteral">"\n"</span>);
00215     printf( <span class="stringliteral">"You are not allowed to change your own privilege settings.\n"</span>);
00216     printf( <span class="stringliteral">"Operation failed.\n"</span>);
00217 
00218     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00219 
00220 }
00221 
00222 
00223 
00224 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00225"></a><a class="code" href="../../d2/d9/uipriv_8c.html#a7">00225</a> <a class="code" href="../../d2/d9/uipriv_8c.html#a7">EnableAllPrivileges</a>(
00226     VOID
00227     )
00228 <span class="comment">/*++</span>
00229 <span class="comment"></span>
00230 <span class="comment"></span>
00231 <span class="comment">Routine Description:</span>
00232 <span class="comment"></span>
00233 <span class="comment">    This routine enables all privileges in the token.</span>
00234 <span class="comment"></span>
00235 <span class="comment">Arguments:</span>
00236 <span class="comment"></span>
00237 <span class="comment">    None.</span>
00238 <span class="comment"></span>
00239 <span class="comment">Return Value:</span>
00240 <span class="comment"></span>
00241 <span class="comment">    None.</span>
00242 <span class="comment"></span>
00243 <span class="comment">--*/</span>
00244 {
00245     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00246     HANDLE <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>;
00247     ULONG ReturnLength, <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00248     PTOKEN_PRIVILEGES  NewState;
00249 
00250 
00251     <span class="keywordflow">if</span> ( !<a class="code" href="../../d2/d9/uipriv_8c.html#a6">OpenAppropriateToken</a>(&amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>) ) {
00252         <span class="keywordflow">return</span>;
00253     }
00254 
00255     <span class="comment">//</span>
00256     <span class="comment">// Get the size needed to query current privilege settings...</span>
00257     <span class="comment">//</span>
00258 
00259     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
00260                  <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>,                      <span class="comment">// TokenHandle</span>
00261                  TokenPrivileges,            <span class="comment">// TokenInformationClass</span>
00262                  NewState,                   <span class="comment">// TokenInformation</span>
00263                  0,                          <span class="comment">// TokenInformationLength</span>
00264                  &amp;ReturnLength               <span class="comment">// ReturnLength</span>
00265                  );
00266     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_BUFFER_TOO_SMALL );
00267 
00268     NewState = <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>( RtlProcessHeap(), 0, ReturnLength );
00269     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( NewState != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00270 
00271 
00272     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
00273                  <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>,                      <span class="comment">// TokenHandle</span>
00274                  TokenPrivileges,            <span class="comment">// TokenInformationClass</span>
00275                  NewState,                   <span class="comment">// TokenInformation</span>
00276                  ReturnLength,               <span class="comment">// TokenInformationLength</span>
00277                  &amp;ReturnLength               <span class="comment">// ReturnLength</span>
00278                  );
00279     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) || <a class="code" href="../../d5/d6/stierr_8h.html#a1">NT_INFORMATION</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) );
00280 
00281 
00282     <span class="comment">//</span>
00283     <span class="comment">// Set the state settings so that all privileges are enabled...</span>
00284     <span class="comment">//</span>
00285 
00286     <span class="keywordflow">if</span> (NewState-&gt;PrivilegeCount &gt; 0) {
00287         <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = NewState-&gt;PrivilegeCount;
00288 
00289         <span class="keywordflow">while</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; NewState-&gt;PrivilegeCount) {
00290             NewState-&gt;Privileges[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Attributes = SE_PRIVILEGE_ENABLED;
00291             <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1;
00292         }
00293     }
00294 
00295 
00296     <span class="comment">//</span>
00297     <span class="comment">// Change the settings in the token...</span>
00298     <span class="comment">//</span>
00299 
00300     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d3/tokenadj_8c.html#a0">NtAdjustPrivilegesToken</a>(
00301                  <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>,                            <span class="comment">// TokenHandle</span>
00302                  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,                            <span class="comment">// DisableAllPrivileges</span>
00303                  NewState,                         <span class="comment">// NewState (OPTIONAL)</span>
00304                  ReturnLength,                     <span class="comment">// BufferLength</span>
00305                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,                             <span class="comment">// PreviousState (OPTIONAL)</span>
00306                  &amp;ReturnLength                     <span class="comment">// ReturnLength</span>
00307                  );
00308     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) || <a class="code" href="../../d5/d6/stierr_8h.html#a1">NT_INFORMATION</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) );
00309 
00310 
00311 
00312     <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>( RtlProcessHeap(), 0, NewState );
00313     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00314 
00315     <span class="keywordflow">return</span>;
00316 
00317 }
00318 
00319 
00320 
00321 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00322"></a><a class="code" href="../../d2/d9/uipriv_8c.html#a8">00322</a> <a class="code" href="../../d2/d9/uipriv_8c.html#a8">ResetAllPrivileges</a>(
00323     VOID
00324     )
00325 <span class="comment">/*++</span>
00326 <span class="comment"></span>
00327 <span class="comment"></span>
00328 <span class="comment">Routine Description:</span>
00329 <span class="comment"></span>
00330 <span class="comment">    This routine resets all privileges in the token to their default state.</span>
00331 <span class="comment"></span>
00332 <span class="comment">Arguments:</span>
00333 <span class="comment"></span>
00334 <span class="comment">    None.</span>
00335 <span class="comment"></span>
00336 <span class="comment">Return Value:</span>
00337 <span class="comment"></span>
00338 <span class="comment">    None.</span>
00339 <span class="comment"></span>
00340 <span class="comment">--*/</span>
00341 {
00342     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00343     HANDLE <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>;
00344     ULONG ReturnLength, <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>;
00345     PTOKEN_PRIVILEGES  NewState;
00346 
00347 
00348     <span class="keywordflow">if</span> ( !<a class="code" href="../../d2/d9/uipriv_8c.html#a6">OpenAppropriateToken</a>(&amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>) ) {
00349         printf( <span class="stringliteral">"\n"</span>);
00350         printf( <span class="stringliteral">"\n"</span>);
00351         printf( <span class="stringliteral">"You are not allowed to change your own privilege settings.\n"</span>);
00352         printf( <span class="stringliteral">"Operation failed.\n"</span>);
00353         <span class="keywordflow">return</span>;
00354     }
00355 
00356     <span class="comment">//</span>
00357     <span class="comment">// Get the size needed to query current privilege settings...</span>
00358     <span class="comment">//</span>
00359 
00360     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
00361                  <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>,                      <span class="comment">// TokenHandle</span>
00362                  TokenPrivileges,            <span class="comment">// TokenInformationClass</span>
00363                  NewState,                   <span class="comment">// TokenInformation</span>
00364                  0,                          <span class="comment">// TokenInformationLength</span>
00365                  &amp;ReturnLength               <span class="comment">// ReturnLength</span>
00366                  );
00367     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( STATUS_BUFFER_TOO_SMALL );
00368 
00369     NewState = <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a0">RtlAllocateHeap</a>( RtlProcessHeap(), 0, ReturnLength );
00370     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( NewState != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> );
00371 
00372 
00373     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d9/d3/tokenqry_8c.html#a0">NtQueryInformationToken</a>(
00374                  <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>,                      <span class="comment">// TokenHandle</span>
00375                  TokenPrivileges,            <span class="comment">// TokenInformationClass</span>
00376                  NewState,                   <span class="comment">// TokenInformation</span>
00377                  ReturnLength,               <span class="comment">// TokenInformationLength</span>
00378                  &amp;ReturnLength               <span class="comment">// ReturnLength</span>
00379                  );
00380     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) || <a class="code" href="../../d5/d6/stierr_8h.html#a1">NT_INFORMATION</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) );
00381 
00382 
00383     <span class="comment">//</span>
00384     <span class="comment">// Set the state settings so that all privileges are reset to</span>
00385     <span class="comment">// their default settings...</span>
00386     <span class="comment">//</span>
00387 
00388     <span class="keywordflow">if</span> (NewState-&gt;PrivilegeCount &gt; 0) {
00389         <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> = NewState-&gt;PrivilegeCount;
00390 
00391         <span class="keywordflow">while</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> &lt; NewState-&gt;PrivilegeCount) {
00392             <span class="keywordflow">if</span> (NewState-&gt;Privileges[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Attributes ==
00393                 SE_PRIVILEGE_ENABLED_BY_DEFAULT) {
00394                 NewState-&gt;Privileges[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Attributes = SE_PRIVILEGE_ENABLED;
00395             }
00396             <span class="keywordflow">else</span> {
00397                 NewState-&gt;Privileges[<a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a>].Attributes = 0;
00398             }
00399 
00400             <a class="code" href="../../d1/d0/cmchek_8c.html#a10">Index</a> += 1;
00401         }
00402     }
00403 
00404 
00405     <span class="comment">//</span>
00406     <span class="comment">// Change the settings in the token...</span>
00407     <span class="comment">//</span>
00408 
00409     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d3/tokenadj_8c.html#a0">NtAdjustPrivilegesToken</a>(
00410                  <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>,                            <span class="comment">// TokenHandle</span>
00411                  <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,                            <span class="comment">// DisableAllPrivileges</span>
00412                  NewState,                         <span class="comment">// NewState (OPTIONAL)</span>
00413                  ReturnLength,                     <span class="comment">// BufferLength</span>
00414                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,                             <span class="comment">// PreviousState (OPTIONAL)</span>
00415                  &amp;ReturnLength                     <span class="comment">// ReturnLength</span>
00416                  );
00417     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) || <a class="code" href="../../d5/d6/stierr_8h.html#a1">NT_INFORMATION</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) );
00418 
00419 
00420 
00421     <a class="code" href="../../d3/d7/config_2utils_2regutil_8c.html#a1">RtlFreeHeap</a>( RtlProcessHeap(), 0, NewState );
00422     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00423 
00424     <span class="keywordflow">return</span>;
00425 
00426 }
00427 
00428 
00429 
00430 
00431 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00432"></a><a class="code" href="../../d2/d9/uipriv_8c.html#a9">00432</a> <a class="code" href="../../d2/d9/uipriv_8c.html#a9">DisableAllPrivileges</a>(
00433     VOID
00434     )
00435 <span class="comment">/*++</span>
00436 <span class="comment"></span>
00437 <span class="comment"></span>
00438 <span class="comment">Routine Description:</span>
00439 <span class="comment"></span>
00440 <span class="comment">    This routine disables all privileges in the token.</span>
00441 <span class="comment"></span>
00442 <span class="comment">Arguments:</span>
00443 <span class="comment"></span>
00444 <span class="comment">    None.</span>
00445 <span class="comment"></span>
00446 <span class="comment">Return Value:</span>
00447 <span class="comment"></span>
00448 <span class="comment">    None.</span>
00449 <span class="comment"></span>
00450 <span class="comment">--*/</span>
00451 {
00452     ULONG IgnoredReturnLength;
00453     HANDLE <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>;
00454     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00455 
00456     <span class="keywordflow">if</span> ( !<a class="code" href="../../d2/d9/uipriv_8c.html#a6">OpenAppropriateToken</a>(&amp;<a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>) ) {
00457         printf( <span class="stringliteral">"\n"</span>);
00458         printf( <span class="stringliteral">"\n"</span>);
00459         printf( <span class="stringliteral">"You are not allowed to change your own privilege settings.\n"</span>);
00460         printf( <span class="stringliteral">"Operation failed.\n"</span>);
00461         <span class="keywordflow">return</span>;
00462     }
00463 
00464     <span class="comment">//</span>
00465     <span class="comment">// Disable all the privileges.</span>
00466     <span class="comment">//</span>
00467 
00468 
00469     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d3/tokenadj_8c.html#a0">NtAdjustPrivilegesToken</a>(
00470                  <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a>,                            <span class="comment">// TokenHandle</span>
00471                  <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,                             <span class="comment">// DisableAllPrivileges</span>
00472                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,                             <span class="comment">// NewState (OPTIONAL)</span>
00473                  0,                                <span class="comment">// BufferLength</span>
00474                  <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,                             <span class="comment">// PreviousState (OPTIONAL)</span>
00475                  &amp;IgnoredReturnLength              <span class="comment">// ReturnLength</span>
00476                  );
00477     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( <a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) || <a class="code" href="../../d5/d6/stierr_8h.html#a1">NT_INFORMATION</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) );
00478 
00479     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a>( <a class="code" href="../../d6/d0/ctaccess_8c.html#a29">Token</a> );
00480     <span class="keywordflow">return</span>;
00481 
00482 }
00483 
00484 
00485 <span class="keywordtype">int</span>
<a name="l00486"></a><a class="code" href="../../d2/d9/uipriv_8c.html#a10">00486</a> <a class="code" href="../../d2/d9/uipriv_8c.html#a10">PrivMain</a> (
00487     IN <span class="keywordtype">int</span> c,
00488     IN PCHAR v[]
00489     )
00490 <span class="comment">/*++</span>
00491 <span class="comment"></span>
00492 <span class="comment"></span>
00493 <span class="comment">Routine Description:</span>
00494 <span class="comment"></span>
00495 <span class="comment">    This routine is the main entry routine for the "priv" command.</span>
00496 <span class="comment"></span>
00497 <span class="comment">Arguments:</span>
00498 <span class="comment"></span>
00499 <span class="comment">    TBS</span>
00500 <span class="comment"></span>
00501 <span class="comment">Return Value:</span>
00502 <span class="comment"></span>
00503 <span class="comment">    TBS</span>
00504 <span class="comment"></span>
00505 <span class="comment">--*/</span>
00506 {
00507     PCHAR p;
00508     <a class="code" href="../../d1/d1/bench_8c.html#a16">CHAR</a> ch;
00509     ULONG DispositionDirectives;
00510 
00511 
00512     <span class="keywordflow">try</span> {
00513         DispositionDirectives = 0;
00514         <a class="code" href="../../d2/d9/uipriv_8c.html#a0">SHIFT</a> (<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a>,v);
00515         <span class="keywordflow">while</span> ((<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a> &gt; 0) &amp;&amp; ((ch = *v[0]))) {
00516             p = *v;
00517             <span class="keywordflow">if</span> (ch == <span class="charliteral">'/'</span>) {
00518                 <span class="keywordflow">while</span> (*++p != <span class="charliteral">'\0'</span>) {
00519                     <span class="keywordflow">if</span> (*p == <span class="charliteral">'E'</span>) {
00520                         <a class="code" href="../../d2/d9/uipriv_8c.html#a1">SwitchEnable</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00521                         DispositionDirectives += 1;
00522                     }
00523                     <span class="keywordflow">if</span> (*p == <span class="charliteral">'D'</span>) {
00524                         <a class="code" href="../../d2/d9/uipriv_8c.html#a2">SwitchDisable</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00525                         DispositionDirectives += 1;
00526                     }
00527                     <span class="keywordflow">if</span> (*p == <span class="charliteral">'R'</span>) {
00528                         <a class="code" href="../../d2/d9/uipriv_8c.html#a3">SwitchReset</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00529                         DispositionDirectives += 1;
00530                     }
00531                     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*p == <span class="charliteral">'A'</span>) {
00532                         <a class="code" href="../../d2/d9/uipriv_8c.html#a4">SwitchAll</a>  = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00533                     }
00534                     <span class="keywordflow">else</span> {
00535                         <a class="code" href="../../d1/d1/hivedmp_8c.html#a6">Usage</a>();
00536                     }
00537                 }
00538             <a class="code" href="../../d2/d9/uipriv_8c.html#a0">SHIFT</a>(<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a>,v);
00539             }
00540         }
00541 
00542         <span class="comment">//</span>
00543         <span class="comment">// Make sure we don't have conflicting parameters</span>
00544         <span class="comment">//</span>
00545         <span class="comment">// Rules:</span>
00546         <span class="comment">//</span>
00547         <span class="comment">//      If /A isn't specified, then a privilege name must be.</span>
00548         <span class="comment">//      Exactly one of /E, /D, and /R must be specified.</span>
00549         <span class="comment">//</span>
00550         <span class="comment">//</span>
00551 
00552 
00553         <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d9/uipriv_8c.html#a4">SwitchAll</a> &amp;&amp; (<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a35">c</a> == 0)) {
00554             printf( <span class="stringliteral">"\n"</span>);
00555             printf( <span class="stringliteral">"\n"</span>);
00556             printf( <span class="stringliteral">"You must provide privilege name or use the /A switch.\n"</span>);
00557             <a class="code" href="../../d1/d1/hivedmp_8c.html#a6">Usage</a>();
00558             <span class="keywordflow">return</span> ( 0 );
00559         }
00560 
00561         <span class="keywordflow">if</span> (DispositionDirectives != 1) {
00562             printf( <span class="stringliteral">"\n"</span>);
00563             printf( <span class="stringliteral">"\n"</span>);
00564             printf( <span class="stringliteral">"You must provide one and only one of the following"</span>);
00565             printf( <span class="stringliteral">"switches: /E, /D, /R\n"</span>);
00566             <a class="code" href="../../d1/d1/hivedmp_8c.html#a6">Usage</a>();
00567             <span class="keywordflow">return</span> ( 0 );
00568 
00569         }
00570 
00571 
00572         <span class="comment">//</span>
00573         <span class="comment">// Everything appears legitimate</span>
00574         <span class="comment">//</span>
00575 
00576         <span class="keywordflow">if</span> (<a class="code" href="../../d2/d9/uipriv_8c.html#a4">SwitchAll</a>) {
00577 
00578             <span class="comment">//</span>
00579             <span class="comment">// /A switch specified</span>
00580             <span class="comment">//</span>
00581 
00582             <span class="keywordflow">if</span> (<a class="code" href="../../d2/d9/uipriv_8c.html#a1">SwitchEnable</a>) {
00583                 <a class="code" href="../../d2/d9/uipriv_8c.html#a7">EnableAllPrivileges</a>();
00584             }
00585             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d2/d9/uipriv_8c.html#a2">SwitchDisable</a>) {
00586                 <a class="code" href="../../d2/d9/uipriv_8c.html#a9">DisableAllPrivileges</a>();
00587             }
00588             <span class="keywordflow">else</span> {
00589                 <a class="code" href="../../d2/d9/uipriv_8c.html#a8">ResetAllPrivileges</a>();
00590             }
00591         }
00592 
00593         <span class="comment">//</span>
00594         <span class="comment">// privilege name specified...</span>
00595         <span class="comment">//</span>
00596 
00597         <span class="keywordflow">else</span> {
00598             printf( <span class="stringliteral">"\n"</span>);
00599             printf( <span class="stringliteral">"I'm sorry, but due to the lack of time and interest,\n"</span>);
00600             printf( <span class="stringliteral">"individual privilege selection is not yet supported.\n"</span>);
00601             printf( <span class="stringliteral">"Please use the /A qualifier for the time being.\n"</span>);
00602             printf( <span class="stringliteral">"\n"</span>);
00603         }
00604 
00605     } finally {
00606         <span class="keywordflow">return</span> ( 0 );
00607     }
00608 
00609     <span class="keywordflow">return</span>( 0 );
00610 
00611 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:42:11 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
