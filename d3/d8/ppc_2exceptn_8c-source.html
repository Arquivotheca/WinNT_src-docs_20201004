<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: exceptn.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>exceptn.c</h1><a href="../../d2/d9/ppc_2exceptn_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1993  IBM Corporation and Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    exceptn.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This module implements the code necessary to dispatch expections to the</span>
00012 <span class="comment">    proper mode and invoke the exception dispatcher.</span>
00013 <span class="comment"></span>
00014 <span class="comment">Author:</span>
00015 <span class="comment"></span>
00016 <span class="comment">    Rick Simpson   2-Aug-1993</span>
00017 <span class="comment">    Adapted from MIPS version by David N. Cutler (davec) 3-Apr-1990</span>
00018 <span class="comment"></span>
00019 <span class="comment">Environment:</span>
00020 <span class="comment"></span>
00021 <span class="comment">    Kernel mode only.</span>
00022 <span class="comment"></span>
00023 <span class="comment">Revision History:</span>
00024 <span class="comment"></span>
00025 <span class="comment">--*/</span>
00026 
00027 <span class="preprocessor">#include "<a class="code" href="../../d0/d0/ki_8h.html">ki.h</a>"</span>
00028 <span class="preprocessor">#pragma hdrstop</span>
<a name="l00029"></a><a class="code" href="../../d2/d9/ppc_2exceptn_8c.html#a0">00029</a> <span class="preprocessor"></span><span class="preprocessor">#define _KXPPC_C_HEADER_</span>
00030 <span class="preprocessor"></span><span class="preprocessor">#include "kxppc.h"</span>
00031 
00032 BOOLEAN
00033 <a class="code" href="../../d2/d9/ppc_2exceptn_8c.html#a8">KiEmulateDcbz</a> (
00034     IN OUT PEXCEPTION_RECORD ExceptionRecord,
00035     IN OUT PKEXCEPTION_FRAME ExceptionFrame,
00036     IN OUT PKTRAP_FRAME TrapFrame
00037     );
00038 
00039 <span class="comment">//</span>
00040 <span class="comment">// Data misalignment exception (auto alignment fixup) control.</span>
00041 <span class="comment">//</span>
00042 <span class="comment">// If KiEnableAlignmentFaultExceptions is false, then no alignment</span>
00043 <span class="comment">// exceptions are raised and all misaligned user and kernel mode data</span>
00044 <span class="comment">// references are emulated.</span>
00045 <span class="comment">//</span>
00046 <span class="comment">// Otherwise if KiEnableAlignmentFaultExceptions is true, then the</span>
00047 <span class="comment">// current thread automatic alignment fixup enable determines whether</span>
00048 <span class="comment">// emulation is attempted in user mode.</span>
00049 <span class="comment">//</span>
00050 <span class="comment">// N.B. This default value may be reset from the Registry during init.</span>
00051 <span class="comment">//</span>
00052 
<a name="l00053"></a><a class="code" href="../../d2/d9/ppc_2exceptn_8c.html#a6">00053</a> ULONG <a class="code" href="../../d8/d8/alpha_2exceptn_8c.html#a1">KiEnableAlignmentFaultExceptions</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00054 
00055 <span class="comment">//</span>
00056 <span class="comment">// Breakpoint is a trap word immediate with a TO field of all ones.</span>
00057 <span class="comment">//</span>
00058 
<a name="l00059"></a><a class="code" href="../../d2/d9/ppc_2exceptn_8c.html#a1">00059</a> <span class="preprocessor">#define BREAK_INST  (TRAP_INSTR | TO_BREAKPOINT)</span>
00060 <span class="preprocessor"></span>
00061 <span class="comment">//</span>
00062 <span class="comment">// Define multiply overflow and divide by zero breakpoint instruction values.</span>
00063 <span class="comment">//</span>
00064 
<a name="l00065"></a><a class="code" href="../../d2/d9/ppc_2exceptn_8c.html#a2">00065</a> <span class="preprocessor">#define DIVIDE_BREAKPOINT   (TRAP_INSTR | TO_DIVIDE_BY_ZERO)</span>
<a name="l00066"></a><a class="code" href="../../d2/d9/ppc_2exceptn_8c.html#a3">00066</a> <span class="preprocessor"></span><span class="preprocessor">#define UDIVIDE_BREAKPOINT  (TRAP_INSTR | TO_UNCONDITIONAL_DIVIDE_BY_ZERO)</span>
00067 <span class="preprocessor"></span>
00068 <span class="comment">//</span>
00069 <span class="comment">// Define external kernel breakpoint and breakin breakpoint instructions.</span>
00070 <span class="comment">//</span>
00071 
<a name="l00072"></a><a class="code" href="../../d2/d9/ppc_2exceptn_8c.html#a4">00072</a> <span class="preprocessor">#define KERNEL_BREAKPOINT_INSTRUCTION (BREAK_INSTR | DEBUG_STOP_BREAKPOINT)</span>
<a name="l00073"></a><a class="code" href="../../d2/d9/ppc_2exceptn_8c.html#a5">00073</a> <span class="preprocessor"></span><span class="preprocessor">#define KDDEBUG_BREAKPOINT  (BREAK_INSTR | BREAKIN_BREAKPOINT)</span>
00074 <span class="preprocessor"></span>
00075 <span class="comment">//</span>
00076 <span class="comment">// Define available hardware breakpoint register mask</span>
00077 <span class="comment">//</span>
<a name="l00078"></a><a class="code" href="../../d2/d9/ppc_2exceptn_8c.html#a7">00078</a> ULONG <a class="code" href="../../d2/d9/ppc_2exceptn_8c.html#a7">KiBreakPoints</a>;
00079 
00080 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00081"></a><a class="code" href="../../d2/d9/ppc_2exceptn_8c.html#a9">00081</a> <a class="code" href="../../d2/d9/ppc_2exceptn_8c.html#a9">KeContextFromKframes</a> (
00082     IN PKTRAP_FRAME TrapFrame,
00083     IN PKEXCEPTION_FRAME ExceptionFrame,
00084     IN OUT PCONTEXT ContextFrame
00085     )
00086 
00087 <span class="comment">/*++</span>
00088 <span class="comment"></span>
00089 <span class="comment">Routine Description:</span>
00090 <span class="comment"></span>
00091 <span class="comment">    This routine moves the selected contents of the specified trap and exception frames</span>
00092 <span class="comment">    frames into the specified context frame according to the specified context</span>
00093 <span class="comment">    flags.</span>
00094 <span class="comment"></span>
00095 <span class="comment">Arguments:</span>
00096 <span class="comment"></span>
00097 <span class="comment">    TrapFrame - Supplies a pointer to a trap frame from which volatile context</span>
00098 <span class="comment">        should be copied into the context record.</span>
00099 <span class="comment"></span>
00100 <span class="comment">    ExceptionFrame - Supplies a pointer to an exception frame from which context</span>
00101 <span class="comment">        should be copied into the context record.</span>
00102 <span class="comment"></span>
00103 <span class="comment">    ContextFrame - Supplies a pointer to the context frame that receives the</span>
00104 <span class="comment">        context copied from the trap and exception frames.</span>
00105 <span class="comment"></span>
00106 <span class="comment">Return Value:</span>
00107 <span class="comment"></span>
00108 <span class="comment">    None.</span>
00109 <span class="comment"></span>
00110 <span class="comment">--*/</span>
00111 
00112 {
00113 
00114     <span class="comment">//</span>
00115     <span class="comment">// Set control information if specified.</span>
00116     <span class="comment">//</span>
00117 
00118     <span class="keywordflow">if</span> ((ContextFrame-&gt;ContextFlags &amp; <a class="code" href="../../d6/d7/halmips_8h.html#a153">CONTEXT_CONTROL</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a153">CONTEXT_CONTROL</a>) {
00119 
00120         <span class="comment">//</span>
00121         <span class="comment">// Set machine state, instr address, link, count registers</span>
00122         <span class="comment">//</span>
00123 
00124         ContextFrame-&gt;Msr = TrapFrame-&gt;Msr;
00125         ContextFrame-&gt;Iar = TrapFrame-&gt;Iar;
00126         ContextFrame-&gt;Lr  = TrapFrame-&gt;Lr;
00127         ContextFrame-&gt;Ctr = TrapFrame-&gt;Ctr;
00128     }
00129 
00130     <span class="comment">//</span>
00131     <span class="comment">// Set integer register contents if specified.</span>
00132     <span class="comment">//</span>
00133 
00134     <span class="keywordflow">if</span> ((ContextFrame-&gt;ContextFlags &amp; <a class="code" href="../../d6/d7/halmips_8h.html#a155">CONTEXT_INTEGER</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a155">CONTEXT_INTEGER</a>) {
00135 
00136         <span class="comment">//</span>
00137         <span class="comment">// Volatile integer regs in trap frame are 0..12</span>
00138         <span class="comment">//</span>
00139 
00140         RtlMoveMemory (&amp;ContextFrame-&gt;Gpr0, &amp;TrapFrame-&gt;Gpr0,
00141                        sizeof (ULONG) * 13);
00142 
00143         <span class="comment">//</span>
00144         <span class="comment">// Non-volatile integer regs in exception frame are 13..31</span>
00145         <span class="comment">//</span>
00146 
00147         RtlMoveMemory (&amp;ContextFrame-&gt;Gpr13, &amp;ExceptionFrame-&gt;Gpr13,
00148                        sizeof (ULONG) * 19);
00149 
00150         <span class="comment">//</span>
00151         <span class="comment">// The CR is made up of volatile and non-volatile fields,</span>
00152         <span class="comment">// but the entire CR is saved in the trap frame</span>
00153         <span class="comment">//</span>
00154 
00155         ContextFrame-&gt;Cr = TrapFrame-&gt;Cr;
00156 
00157         <span class="comment">//</span>
00158         <span class="comment">// Fixed Point Exception Register (XER) is part of the</span>
00159         <span class="comment">// integer state</span>
00160         <span class="comment">//</span>
00161 
00162         ContextFrame-&gt;Xer = TrapFrame-&gt;Xer;
00163     }
00164 
00165     <span class="comment">//</span>
00166     <span class="comment">// Set floating register contents if specified.</span>
00167     <span class="comment">//</span>
00168 
00169     <span class="keywordflow">if</span> ((ContextFrame-&gt;ContextFlags &amp; <a class="code" href="../../d6/d7/halmips_8h.html#a154">CONTEXT_FLOATING_POINT</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a154">CONTEXT_FLOATING_POINT</a>) {
00170 
00171         <span class="comment">//</span>
00172         <span class="comment">// Volatile floating point regs in trap frame are 0..13</span>
00173         <span class="comment">//</span>
00174 
00175         RtlMoveMemory(&amp;ContextFrame-&gt;Fpr0, &amp;TrapFrame-&gt;Fpr0,
00176                      <span class="keyword">sizeof</span>(DOUBLE) * (14));
00177 
00178         <span class="comment">//</span>
00179         <span class="comment">// Non-volatile floating point regs in exception frame are 14..31</span>
00180         <span class="comment">//</span>
00181 
00182         RtlMoveMemory(&amp;ContextFrame-&gt;Fpr14, &amp;ExceptionFrame-&gt;Fpr14,
00183                      <span class="keyword">sizeof</span>(DOUBLE) * (18));
00184 
00185         <span class="comment">//</span>
00186         <span class="comment">// Set floating point status and control register.</span>
00187         <span class="comment">//</span>
00188 
00189         ContextFrame-&gt;Fpscr = TrapFrame-&gt;Fpscr;
00190     }
00191 
00192     <span class="comment">//</span>
00193     <span class="comment">// Fetch Dr register contents if requested.  Values may be trash.</span>
00194     <span class="comment">//</span>
00195 
00196     <span class="keywordflow">if</span> ((ContextFrame-&gt;ContextFlags &amp; CONTEXT_DEBUG_REGISTERS) ==
00197         CONTEXT_DEBUG_REGISTERS) {
00198 
00199         ContextFrame-&gt;Dr0 = TrapFrame-&gt;Dr0;
00200         ContextFrame-&gt;Dr1 = TrapFrame-&gt;Dr1;
00201         ContextFrame-&gt;Dr2 = TrapFrame-&gt;Dr2;
00202         ContextFrame-&gt;Dr3 = TrapFrame-&gt;Dr3;
00203         ContextFrame-&gt;Dr6 = TrapFrame-&gt;Dr6;
00204         ContextFrame-&gt;Dr6 |= <a class="code" href="../../d2/d9/ppc_2exceptn_8c.html#a7">KiBreakPoints</a>;
00205         ContextFrame-&gt;Dr5 = 0;            <span class="comment">// Zero initialize unused regs</span>
00206         ContextFrame-&gt;Dr4 = 0;
00207 
00208         <span class="comment">//</span>
00209         <span class="comment">// If it's a user mode frame, and the thread doesn't have DRs set,</span>
00210         <span class="comment">// and we just return the trash in the frame, we risk accidentally</span>
00211         <span class="comment">// making the thread active with trash values on a set.  Therefore,</span>
00212         <span class="comment">// Dr7 must be set to the number of available data address breakpoint</span>
00213         <span class="comment">// registers if we get a non-active user mode frame.</span>
00214         <span class="comment">//</span>
00215 
00216         <span class="keywordflow">if</span> (((TrapFrame-&gt;PreviousMode) != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) &amp;&amp;
00217             (<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>()-&gt;DebugActive)) {
00218 
00219             ContextFrame-&gt;Dr7 = TrapFrame-&gt;Dr7;
00220         } <span class="keywordflow">else</span> {
00221 
00222             ContextFrame-&gt;Dr7 = 0;
00223         }
00224     }
00225 
00226     <span class="keywordflow">return</span>;
00227 }
00228 
00229 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00230"></a><a class="code" href="../../d2/d9/ppc_2exceptn_8c.html#a10">00230</a> <a class="code" href="../../d2/d9/ppc_2exceptn_8c.html#a10">KeContextToKframes</a> (
00231     IN OUT PKTRAP_FRAME TrapFrame,
00232     IN OUT PKEXCEPTION_FRAME ExceptionFrame,
00233     IN PCONTEXT ContextFrame,
00234     IN ULONG ContextFlags,
00235     IN KPROCESSOR_MODE PreviousMode
00236     )
00237 
00238 <span class="comment">/*++</span>
00239 <span class="comment"></span>
00240 <span class="comment">Routine Description:</span>
00241 <span class="comment"></span>
00242 <span class="comment">    This routine moves the selected contents of the specified context frame into</span>
00243 <span class="comment">    the specified trap and exception frames according to the specified context</span>
00244 <span class="comment">    flags.</span>
00245 <span class="comment"></span>
00246 <span class="comment">Arguments:</span>
00247 <span class="comment"></span>
00248 <span class="comment">    TrapFrame - Supplies a pointer to a trap frame that receives the volatile</span>
00249 <span class="comment">        context from the context record.</span>
00250 <span class="comment"></span>
00251 <span class="comment">    ExceptionFrame - Supplies a pointer to an exception frame that receives</span>
00252 <span class="comment">        the nonvolatile context from the context record.</span>
00253 <span class="comment"></span>
00254 <span class="comment">    ContextFrame - Supplies a pointer to a context frame that contains the</span>
00255 <span class="comment">        context that is to be copied into the trap and exception frames.</span>
00256 <span class="comment"></span>
00257 <span class="comment">    ContextFlags - Supplies the set of flags that specify which parts of the</span>
00258 <span class="comment">        context frame are to be copied into the trap and exception frames.</span>
00259 <span class="comment"></span>
00260 <span class="comment">    PreviousMode - Supplies the processor mode for which the trap and exception</span>
00261 <span class="comment">        frames are being built.</span>
00262 <span class="comment"></span>
00263 <span class="comment">Return Value:</span>
00264 <span class="comment"></span>
00265 <span class="comment">    None.</span>
00266 <span class="comment"></span>
00267 <span class="comment">--*/</span>
00268 
00269 {
00270 
00271     <span class="comment">//</span>
00272     <span class="comment">// Set control information if specified.</span>
00273     <span class="comment">//</span>
00274 
00275     <span class="keywordflow">if</span> ((ContextFlags &amp; <a class="code" href="../../d6/d7/halmips_8h.html#a153">CONTEXT_CONTROL</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a153">CONTEXT_CONTROL</a>) {
00276 
00277         <span class="comment">//</span>
00278         <span class="comment">// Set instruction address, link, count, and machine state registers</span>
00279         <span class="comment">//</span>
00280 
00281         TrapFrame-&gt;Iar = ContextFrame-&gt;Iar;
00282         TrapFrame-&gt;Lr  = ContextFrame-&gt;Lr;
00283         TrapFrame-&gt;Ctr = ContextFrame-&gt;Ctr;
00284         TrapFrame-&gt;Msr = SANITIZE_MSR(ContextFrame-&gt;Msr, PreviousMode);
00285     }
00286 
00287     <span class="comment">//</span>
00288     <span class="comment">// Set integer registers contents if specified.</span>
00289     <span class="comment">//</span>
00290 
00291     <span class="keywordflow">if</span> ((ContextFlags &amp; <a class="code" href="../../d6/d7/halmips_8h.html#a155">CONTEXT_INTEGER</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a155">CONTEXT_INTEGER</a>) {
00292 
00293         <span class="comment">//</span>
00294         <span class="comment">// Volatile integer regs are 0..12</span>
00295         <span class="comment">//</span>
00296 
00297         RtlMoveMemory(&amp;TrapFrame-&gt;Gpr0, &amp;ContextFrame-&gt;Gpr0,
00298                      <span class="keyword">sizeof</span>(ULONG) * (13));
00299 
00300         <span class="comment">//</span>
00301         <span class="comment">// Non-volatile integer regs are 13..31</span>
00302         <span class="comment">//</span>
00303 
00304         RtlMoveMemory(&amp;ExceptionFrame-&gt;Gpr13, &amp;ContextFrame-&gt;Gpr13,
00305                      <span class="keyword">sizeof</span>(ULONG) * (19));
00306 
00307         <span class="comment">//</span>
00308         <span class="comment">// Copy the Condition Reg and Fixed Point Exception Reg</span>
00309         <span class="comment">//</span>
00310 
00311         TrapFrame-&gt;Cr = ContextFrame-&gt;Cr;
00312         TrapFrame-&gt;Xer = ContextFrame-&gt;Xer;
00313     }
00314 
00315     <span class="comment">//</span>
00316     <span class="comment">// Set floating register contents if specified.</span>
00317     <span class="comment">//</span>
00318 
00319     <span class="keywordflow">if</span> ((ContextFlags &amp; <a class="code" href="../../d6/d7/halmips_8h.html#a154">CONTEXT_FLOATING_POINT</a>) == <a class="code" href="../../d6/d7/halmips_8h.html#a154">CONTEXT_FLOATING_POINT</a>) {
00320 
00321         <span class="comment">//</span>
00322         <span class="comment">// Volatile floating point regs are 0..13</span>
00323         <span class="comment">//</span>
00324 
00325         RtlMoveMemory(&amp;TrapFrame-&gt;Fpr0, &amp;ContextFrame-&gt;Fpr0,
00326                      <span class="keyword">sizeof</span>(DOUBLE) * (14));
00327 
00328         <span class="comment">//</span>
00329         <span class="comment">// Non-volatile floating point regs are 14..31</span>
00330         <span class="comment">//</span>
00331 
00332         RtlMoveMemory(&amp;ExceptionFrame-&gt;Fpr14, &amp;ContextFrame-&gt;Fpr14,
00333                      <span class="keyword">sizeof</span>(DOUBLE) * (18));
00334 
00335         <span class="comment">//</span>
00336         <span class="comment">// Set floating point status and control register.</span>
00337         <span class="comment">//</span>
00338 
00339         TrapFrame-&gt;Fpscr = SANITIZE_FPSCR(ContextFrame-&gt;Fpscr, PreviousMode);
00340     }
00341 
00342     <span class="comment">//</span>
00343     <span class="comment">// Set debug register state if specified.  If previous mode is user</span>
00344     <span class="comment">// mode (i.e. it's a user frame we're setting) and if effect will be to</span>
00345     <span class="comment">// cause at least one of the debug register enable bits in Dr7</span>
00346     <span class="comment">// to be set then set DebugActive to the enable bit mask.</span>
00347     <span class="comment">//</span>
00348 
00349     <span class="keywordflow">if</span> ((ContextFlags &amp; CONTEXT_DEBUG_REGISTERS) == CONTEXT_DEBUG_REGISTERS) {
00350 
00351         <span class="comment">//</span>
00352         <span class="comment">// Set the debug control register for the 601 and 604</span>
00353         <span class="comment">// indicating the number of address breakpoints supported.</span>
00354         <span class="comment">//</span>
00355 
00356         TrapFrame-&gt;Dr0 = SANITIZE_DRADDR(ContextFrame-&gt;Dr0, PreviousMode);
00357         TrapFrame-&gt;Dr1 = SANITIZE_DRADDR(ContextFrame-&gt;Dr1, PreviousMode);
00358         TrapFrame-&gt;Dr2 = SANITIZE_DRADDR(ContextFrame-&gt;Dr2, PreviousMode);
00359         TrapFrame-&gt;Dr3 = SANITIZE_DRADDR(ContextFrame-&gt;Dr3, PreviousMode);
00360         TrapFrame-&gt;Dr6 = SANITIZE_DR6(ContextFrame-&gt;Dr6, PreviousMode);
00361         TrapFrame-&gt;Dr7 = SANITIZE_DR7(ContextFrame-&gt;Dr7, PreviousMode);
00362 
00363         <span class="keywordflow">if</span> (PreviousMode != <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00364               <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a1">KeGetPcr</a>()-&gt;DebugActive = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>()-&gt;DebugActive =
00365                                         (UCHAR)(TrapFrame-&gt;Dr7 &amp; DR7_ACTIVE);
00366         }
00367     }
00368 
00369     <span class="keywordflow">return</span>;
00370 }
00371 
00372 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00373"></a><a class="code" href="../../d2/d9/ppc_2exceptn_8c.html#a11">00373</a> <a class="code" href="../../d2/d9/ppc_2exceptn_8c.html#a11">KiDispatchException</a> (
00374     IN PEXCEPTION_RECORD ExceptionRecord,
00375     IN PKEXCEPTION_FRAME ExceptionFrame,
00376     IN PKTRAP_FRAME TrapFrame,
00377     IN KPROCESSOR_MODE PreviousMode,
00378     IN BOOLEAN FirstChance
00379     )
00380 
00381 <span class="comment">/*++</span>
00382 <span class="comment"></span>
00383 <span class="comment">Routine Description:</span>
00384 <span class="comment"></span>
00385 <span class="comment">    This function is called to dispatch an exception to the proper mode and</span>
00386 <span class="comment">    to cause the exception dispatcher to be called.</span>
00387 <span class="comment"></span>
00388 <span class="comment">    If the exception is a data misalignment, this is the first chance for</span>
00389 <span class="comment">    handling the exception, and the current thread has enabled automatic</span>
00390 <span class="comment">    alignment fixup, then an attempt is made to emulate the unaligned</span>
00391 <span class="comment">    reference.</span>
00392 <span class="comment"></span>
00393 <span class="comment">    If the exception is a floating exception (N.B. the pseudo status</span>
00394 <span class="comment">    STATUS_FLOAT_STACK_CHECK is used to signify this), we convert the</span>
00395 <span class="comment">    exception code to the correct STATUS based on the FPSCR.</span>
00396 <span class="comment">    It is up to the handler to figure out what to do to emulate/repair</span>
00397 <span class="comment">    the operation.</span>
00398 <span class="comment"></span>
00399 <span class="comment">    If the exception is neither a data misalignment nor a floating point</span>
00400 <span class="comment">    exception and the the previous mode is kernel, then the exception</span>
00401 <span class="comment">    dispatcher is called directly to process the exception. Otherwise the</span>
00402 <span class="comment">    exception record, exception frame, and trap frame contents are copied</span>
00403 <span class="comment">    to the user mode stack. The contents of the exception frame and trap</span>
00404 <span class="comment">    are then modified such that when control is returned, execution will</span>
00405 <span class="comment">    commence in user mode in a routine which will call the exception</span>
00406 <span class="comment">    dispatcher.</span>
00407 <span class="comment"></span>
00408 <span class="comment">Arguments:</span>
00409 <span class="comment"></span>
00410 <span class="comment">    ExceptionRecord - Supplies a pointer to an exception record.</span>
00411 <span class="comment"></span>
00412 <span class="comment">    ExceptionFrame - Supplies a pointer to an exception frame.</span>
00413 <span class="comment"></span>
00414 <span class="comment">    TrapFrame - Supplies a pointer to a trap frame.</span>
00415 <span class="comment"></span>
00416 <span class="comment">    PreviousMode - Supplies the previous processor mode.</span>
00417 <span class="comment"></span>
00418 <span class="comment">    FirstChance - Supplies a boolean variable that specifies whether this</span>
00419 <span class="comment">        is the first (TRUE) or second (FALSE) time that this exception has</span>
00420 <span class="comment">        been processed.</span>
00421 <span class="comment"></span>
00422 <span class="comment">Return Value:</span>
00423 <span class="comment"></span>
00424 <span class="comment">    None.</span>
00425 <span class="comment"></span>
00426 <span class="comment">--*/</span>
00427 
00428 {
00429 
00430     CONTEXT ContextFrame;
00431     EXCEPTION_RECORD ExceptionRecord1;
00432     LONG Length;
00433     BOOLEAN UserApcPending;
00434 
00435     <span class="comment">//</span>
00436     <span class="comment">// If the exception is a data misalignment, this is the first chance for</span>
00437     <span class="comment">// handling the exception, and the current thread has enabled automatic</span>
00438     <span class="comment">// alignment fixup, then attempt to emulate the unaligned reference.</span>
00439     <span class="comment">//</span>
00440     <span class="comment">// We always emulate dcbz, even if the thread hasn't enabled automatic</span>
00441     <span class="comment">// alignment fixup.  This is because the hardware declares an alignment</span>
00442     <span class="comment">// fault if dcbz is attempted on noncached memory.</span>
00443     <span class="comment">//</span>
00444 
00445     <span class="keywordflow">if</span> (ExceptionRecord-&gt;ExceptionCode == STATUS_DATATYPE_MISALIGNMENT) {
00446         <span class="keywordflow">if</span> (FirstChance != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00447 
00448             <span class="comment">//</span>
00449             <span class="comment">// If alignment fault exceptions are not enabled, then no exception</span>
00450             <span class="comment">// should be raised and the data reference should be emulated.</span>
00451             <span class="comment">//</span>
00452 
00453             <span class="keywordflow">if</span> ((<a class="code" href="../../d8/d8/alpha_2exceptn_8c.html#a1">KiEnableAlignmentFaultExceptions</a> == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) ||
00454                 (<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>()-&gt;AutoAlignment != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) ||
00455                 (<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>()-&gt;ApcState.Process-&gt;AutoAlignment != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
00456                 <span class="keywordflow">if</span> (<a class="code" href="../../d7/d5/ppc_2alignem_8c.html#a18">KiEmulateReference</a>(ExceptionRecord, ExceptionFrame, TrapFrame) != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00457                     <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a2">KeGetCurrentPrcb</a>()-&gt;KeAlignmentFixupCount += 1;
00458                     <span class="keywordflow">goto</span> Handled2;
00459                 }
00460             } <span class="keywordflow">else</span> {
00461                 <span class="keywordflow">if</span> (<a class="code" href="../../d2/d9/ppc_2exceptn_8c.html#a8">KiEmulateDcbz</a>(ExceptionRecord, ExceptionFrame, TrapFrame) != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00462                     <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a2">KeGetCurrentPrcb</a>()-&gt;KeAlignmentFixupCount += 1;
00463                     <span class="keywordflow">goto</span> Handled2;
00464                 }
00465             }
00466         }
00467     }
00468 
00469     <span class="comment">//</span>
00470     <span class="comment">// If the exception is a breakpoint, then translate it to an appropriate</span>
00471     <span class="comment">// exception code if it is a division by zero or an integer overflow</span>
00472     <span class="comment">// caused by multiplication.</span>
00473     <span class="comment">//</span>
00474 
00475     <span class="keywordflow">if</span> (ExceptionRecord-&gt;ExceptionCode == STATUS_BREAKPOINT) {
00476 
00477         ULONG Instr = ExceptionRecord-&gt;ExceptionInformation[0];
00478 
00479         <span class="keywordflow">if</span> ((Instr &amp; 0xffe0ffff) == <a class="code" href="../../d1/d9/mips_2exceptn_8c.html#a2">DIVIDE_BREAKPOINT</a> ||
00480             (Instr &amp; 0xffe0ffff) == <a class="code" href="../../d2/d9/ppc_2exceptn_8c.html#a3">UDIVIDE_BREAKPOINT</a>) {
00481             ExceptionRecord-&gt;ExceptionCode = STATUS_INTEGER_DIVIDE_BY_ZERO;
00482         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (Instr == <a class="code" href="../../d1/d9/mips_2exceptn_8c.html#a1">KDDEBUG_BREAKPOINT</a>) {
00483             TrapFrame-&gt;Iar += 4;
00484         }
00485     }
00486 
00487     <span class="comment">//</span>
00488     <span class="comment">// If the exception is a floating point exception, then the</span>
00489     <span class="comment">// ExceptionCode was set to STATUS_FLOAT_STACK_CHECK.  We now sort</span>
00490     <span class="comment">// that out and set a more correct STATUS code.  We clear the</span>
00491     <span class="comment">// exception enable bit in the FPSCR of the exception being reported</span>
00492     <span class="comment">// to eliminate floating point exception recursion.</span>
00493     <span class="comment">//</span>
00494 
00495     <span class="keywordflow">if</span> (ExceptionRecord-&gt;ExceptionCode == STATUS_FLOAT_STACK_CHECK) {
00496 
00497         PFPSCR Fpscr = (PFPSCR)(&amp;TrapFrame-&gt;Fpscr);
00498 
00499         <span class="keywordflow">if</span> ((Fpscr-&gt;XE == 1) &amp;&amp; (Fpscr-&gt;XX == 1)) {
00500 
00501             ExceptionRecord-&gt;ExceptionCode = STATUS_FLOAT_INEXACT_RESULT;
00502             Fpscr-&gt;XE = 0;
00503 
00504         }
00505         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((Fpscr-&gt;ZE == 1) &amp;&amp; (Fpscr-&gt;ZX == 1)) {
00506 
00507             ExceptionRecord-&gt;ExceptionCode = STATUS_FLOAT_DIVIDE_BY_ZERO;
00508             Fpscr-&gt;ZE = 0;
00509 
00510         }
00511         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((Fpscr-&gt;UE == 1) &amp;&amp; (Fpscr-&gt;UX == 1)) {
00512 
00513             ExceptionRecord-&gt;ExceptionCode = STATUS_FLOAT_UNDERFLOW;
00514             Fpscr-&gt;UE = 0;
00515 
00516         }
00517 
00518         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((Fpscr-&gt;OE == 1) &amp;&amp; (Fpscr-&gt;OX == 1)) {
00519 
00520             ExceptionRecord-&gt;ExceptionCode = STATUS_FLOAT_OVERFLOW;
00521             Fpscr-&gt;OE = 0;
00522 
00523         }
00524         <span class="keywordflow">else</span> {
00525 
00526             <span class="comment">// Must be some form of Invalid Operation</span>
00527 
00528             ExceptionRecord-&gt;ExceptionCode = STATUS_FLOAT_INVALID_OPERATION;
00529             Fpscr-&gt;VE = 0;
00530         }
00531     }
00532 
00533     <span class="comment">//</span>
00534     <span class="comment">// Move machine state from trap and exception frames to a context frame,</span>
00535     <span class="comment">// and increment the number of exceptions dispatched.</span>
00536     <span class="comment">//</span>
00537 
00538     ContextFrame.ContextFlags = <a class="code" href="../../d6/d7/halmips_8h.html#a152">CONTEXT_FULL</a> | CONTEXT_DEBUG_REGISTERS;
00539     <a class="code" href="../../d2/d9/ppc_2exceptn_8c.html#a9">KeContextFromKframes</a>(TrapFrame, ExceptionFrame, &amp;ContextFrame);
00540     <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a2">KeGetCurrentPrcb</a>()-&gt;KeExceptionDispatchCount += 1;
00541 
00542     <span class="comment">//</span>
00543     <span class="comment">// Select the method of handling the exception based on the previous mode.</span>
00544     <span class="comment">//</span>
00545 
00546     <span class="keywordflow">if</span> (PreviousMode == <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) {
00547 
00548         <span class="comment">//</span>
00549         <span class="comment">// Previous mode was kernel.</span>
00550         <span class="comment">//</span>
00551         <span class="comment">// If this is the first chance, the kernel debugger is active, and</span>
00552         <span class="comment">// the exception is a kernel breakpoint, then give the kernel debugger</span>
00553         <span class="comment">// a chance to handle the exception.</span>
00554         <span class="comment">//</span>
00555         <span class="comment">// If this is the first chance and the kernel debugger is not active</span>
00556         <span class="comment">// or does not handle the exception, then attempt to find a frame</span>
00557         <span class="comment">// handler to handle the exception.</span>
00558         <span class="comment">//</span>
00559         <span class="comment">// If this is the second chance or the exception is not handled, then</span>
00560         <span class="comment">// if the kernel debugger is active, then give the kernel debugger a</span>
00561         <span class="comment">// second chance to handle the exception. If the kernel debugger does</span>
00562         <span class="comment">// not handle the exception, then bug check.</span>
00563         <span class="comment">//</span>
00564 
00565         <span class="keywordflow">if</span> (FirstChance != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00566 
00567             <span class="comment">//</span>
00568             <span class="comment">// If the kernel debugger is active, the exception is a breakpoint,</span>
00569             <span class="comment">// and the breakpoint is handled by the kernel debugger, then give</span>
00570             <span class="comment">// the kernel debugger a chance to handle the exception.</span>
00571             <span class="comment">//</span>
00572 
00573             <span class="keywordflow">if</span> ((<a class="code" href="../../d0/d7/kdp_8h.html#a24">KiDebugRoutine</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
00574                ((ExceptionRecord-&gt;ExceptionCode == STATUS_BREAKPOINT) ||
00575                 (ExceptionRecord-&gt;ExceptionCode == STATUS_SINGLE_STEP))  &amp;&amp;
00576                (<a class="code" href="../../d3/d9/4_2ia64_2kdtrap_8c.html#a1">KdIsThisAKdTrap</a>(ExceptionRecord,
00577                                 &amp;ContextFrame,
00578                                 <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>) != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
00579 
00580                 <span class="keywordflow">if</span> (((<a class="code" href="../../d0/d7/kdp_8h.html#a24">KiDebugRoutine</a>) (TrapFrame,
00581                                        ExceptionFrame,
00582                                        ExceptionRecord,
00583                                        &amp;ContextFrame,
00584                                        <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
00585                                        <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00586 
00587                     <span class="keywordflow">goto</span> Handled1;
00588                 }
00589             }
00590 
00591             <span class="comment">//</span>
00592             <span class="comment">// This is the first chance to handle the exception.</span>
00593             <span class="comment">//</span>
00594 
00595             <span class="keywordflow">if</span> (<a class="code" href="../../d9/d9/ppc_2exdsptch_8c.html#a7">RtlDispatchException</a>(ExceptionRecord, &amp;ContextFrame) != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00596                 <span class="keywordflow">goto</span> Handled1;
00597             }
00598         }
00599 
00600         <span class="comment">//</span>
00601         <span class="comment">// This is the second chance to handle the exception.</span>
00602         <span class="comment">//</span>
00603 
00604         <span class="keywordflow">if</span> (<a class="code" href="../../d0/d7/kdp_8h.html#a24">KiDebugRoutine</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00605             <span class="keywordflow">if</span> (((<a class="code" href="../../d0/d7/kdp_8h.html#a24">KiDebugRoutine</a>) (TrapFrame,
00606                                    ExceptionFrame,
00607                                    ExceptionRecord,
00608                                    &amp;ContextFrame,
00609                                    PreviousMode,
00610                                    <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00611                 <span class="keywordflow">goto</span> Handled1;
00612             }
00613         }
00614 
00615         <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a13">KMODE_EXCEPTION_NOT_HANDLED</a>,
00616                      ExceptionRecord-&gt;ExceptionCode,
00617                      (ULONG)ExceptionRecord-&gt;ExceptionAddress,
00618                      ExceptionRecord-&gt;ExceptionInformation[0],
00619                      ExceptionRecord-&gt;ExceptionInformation[1]);
00620 
00621     } <span class="keywordflow">else</span> {
00622 
00623         <span class="comment">//</span>
00624         <span class="comment">// Previous mode was user.</span>
00625         <span class="comment">//</span>
00626         <span class="comment">// If this is the first chance, the kernel debugger is active, the</span>
00627         <span class="comment">// exception is a kernel breakpoint, and the current process is not</span>
00628         <span class="comment">// being debugged, or the current process is being debugged, but the</span>
00629         <span class="comment">// the breakpoint is not a kernel breakpoint instruction, then give</span>
00630         <span class="comment">// the kernel debugger a chance to handle the exception.</span>
00631         <span class="comment">//</span>
00632         <span class="comment">// If this is the first chance and the current process has a debugger</span>
00633         <span class="comment">// port, then send a message to the debugger port and wait for a reply.</span>
00634         <span class="comment">// If the debugger handles the exception, then continue execution. Else</span>
00635         <span class="comment">// transfer the exception information to the user stack, transition to</span>
00636         <span class="comment">// user mode, and attempt to dispatch the exception to a frame based</span>
00637         <span class="comment">// handler. If a frame based handler handles the exception, then continue</span>
00638         <span class="comment">// execution. Otherwise, execute the raise exception system service</span>
00639         <span class="comment">// which will call this routine a second time to process the exception.</span>
00640         <span class="comment">//</span>
00641         <span class="comment">// If this is the second chance and the current process has a debugger</span>
00642         <span class="comment">// port, then send a message to the debugger port and wait for a reply.</span>
00643         <span class="comment">// If the debugger handles the exception, then continue execution. Else</span>
00644         <span class="comment">// if the current process has a subsystem port, then send a message to</span>
00645         <span class="comment">// the subsystem port and wait for a reply. If the subsystem handles the</span>
00646         <span class="comment">// exception, then continue execution. Else terminate the thread.</span>
00647         <span class="comment">//</span>
00648 
00649         <span class="keywordflow">if</span> (FirstChance != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00650 
00651             <span class="comment">//</span>
00652             <span class="comment">// If the kernel debugger is active, the exception is a kernel</span>
00653             <span class="comment">// breakpoint, and the current process is not being debugged,</span>
00654             <span class="comment">// or the current process is being debugged, but the breakpoint</span>
00655             <span class="comment">// is not a kernel breakpoint instruction, then give the kernel</span>
00656             <span class="comment">// debugger a chance to handle the exception.</span>
00657             <span class="comment">//</span>
00658 
00659             <span class="keywordflow">if</span> ((<a class="code" href="../../d0/d7/kdp_8h.html#a24">KiDebugRoutine</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
00660                 ((ExceptionRecord-&gt;ExceptionCode == STATUS_BREAKPOINT) ||
00661                 (ExceptionRecord-&gt;ExceptionCode == STATUS_SINGLE_STEP)) &amp;&amp;
00662                 (<a class="code" href="../../d3/d9/4_2ia64_2kdtrap_8c.html#a1">KdIsThisAKdTrap</a>(ExceptionRecord,
00663                                 &amp;ContextFrame,
00664                                 <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>) != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) &amp;&amp;
00665                ((<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;DebugPort == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) ||
00666                ((<a class="code" href="../../d1/d9/ps_8h.html#a19">PsGetCurrentProcess</a>()-&gt;DebugPort != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp;
00667                (ExceptionRecord-&gt;ExceptionInformation[0] !=
00668                                             <a class="code" href="../../d1/d9/mips_2exceptn_8c.html#a5">KERNEL_BREAKPOINT_INSTRUCTION</a>)))) {
00669 
00670                <span class="keywordflow">if</span> (((<a class="code" href="../../d0/d7/kdp_8h.html#a24">KiDebugRoutine</a>) (TrapFrame,
00671                                       ExceptionFrame,
00672                                       ExceptionRecord,
00673                                       &amp;ContextFrame,
00674                                       <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>,
00675                                       <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) {
00676 
00677                     <span class="keywordflow">goto</span> Handled1;
00678                 }
00679             }
00680 
00681             <span class="comment">//</span>
00682             <span class="comment">// This is the first chance to handle the exception.</span>
00683             <span class="comment">//</span>
00684 
00685             <span class="keywordflow">if</span> (<a class="code" href="../../d4/d3/dbgk_8h.html#a5">DbgkForwardException</a>(ExceptionRecord, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
00686                 TrapFrame-&gt;Fpscr = SANITIZE_FPSCR(TrapFrame-&gt;Fpscr, <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>);
00687                 <span class="keywordflow">goto</span> Handled2;
00688             }
00689 
00690             <span class="comment">//</span>
00691             <span class="comment">// Transfer exception information to the user stack, transition</span>
00692             <span class="comment">// to user mode, and attempt to dispatch the exception to a frame</span>
00693             <span class="comment">// based handler.</span>
00694             <span class="comment">//</span>
00695             <span class="comment">// We are running on the kernel stack now.  On the user stack, we</span>
00696             <span class="comment">// build a stack frame containing the following:</span>
00697             <span class="comment">//</span>
00698             <span class="comment">//               |                                   |</span>
00699             <span class="comment">//               |-----------------------------------|</span>
00700             <span class="comment">//               |                                   |</span>
00701             <span class="comment">//               |   Stack frame header              |</span>
00702             <span class="comment">//               |                                   |</span>
00703             <span class="comment">//               |- - - - - - - - - - - - - - - - - -|</span>
00704             <span class="comment">//               |                                   |</span>
00705             <span class="comment">//               |   Exception record                |</span>
00706             <span class="comment">//               |                                   |</span>
00707             <span class="comment">//               |- - - - - - - - - - - - - - - - - -|</span>
00708             <span class="comment">//               |                                   |</span>
00709             <span class="comment">//               |   Context record                  |</span>
00710             <span class="comment">//               |                                   |</span>
00711             <span class="comment">//               |                                   |</span>
00712             <span class="comment">//               |                                   |</span>
00713             <span class="comment">//               |- - - - - - - - - - - - - - - - - -|</span>
00714             <span class="comment">//               |   Saved TOC for backtrack         |</span>
00715             <span class="comment">//               |- - - - - - - - - - - - - - - - - -|</span>
00716             <span class="comment">//               |                                   |</span>
00717             <span class="comment">//               |                                   |</span>
00718             <span class="comment">//               |   STK_SLACK_SPACE                 |</span>
00719             <span class="comment">//               |                                   |</span>
00720             <span class="comment">//               |                                   |</span>
00721             <span class="comment">//               |                                   |</span>
00722             <span class="comment">//               |- - - - - - - - - - - - - - - - - -|</span>
00723             <span class="comment">//               |                                   |</span>
00724             <span class="comment">//               |   User's stack frame              |</span>
00725             <span class="comment">//               |                                   |</span>
00726             <span class="comment">//               |                                   |</span>
00727             <span class="comment">//</span>
00728             <span class="comment">// This stack frame is for KiUserExceptionDispatcher, the assembly</span>
00729             <span class="comment">// langauge routine that effects transfer in user mode to</span>
00730             <span class="comment">// RtlDispatchException.  KiUserExceptionDispatcher is passed</span>
00731             <span class="comment">// pointers to the Exception Record and Context Record as</span>
00732             <span class="comment">// parameters.</span>
00733 
00734         repeat:
00735             <span class="keywordflow">try</span> {
00736 
00737                 <span class="comment">//</span>
00738                 <span class="comment">// Compute positions on user stack of items shown above</span>
00739                 <span class="comment">//</span>
00740 
00741                 ULONG Length = (<span class="keyword">sizeof</span> (STACK_FRAME_HEADER) + <span class="keyword">sizeof</span> (EXCEPTION_RECORD) +
00742                                 <span class="keyword">sizeof</span> (CONTEXT) + <span class="keyword">sizeof</span> (ULONG) + STK_SLACK_SPACE + 7) &amp; (~7);
00743 
00744                 ULONG UserStack = (ContextFrame.Gpr1 &amp; (~7)) - Length;
00745                 ULONG ExceptSlot = UserStack + <span class="keyword">sizeof</span> (STACK_FRAME_HEADER);
00746                 ULONG ContextSlot = ExceptSlot + <span class="keyword">sizeof</span> (EXCEPTION_RECORD);
00747                 ULONG TocSlot = ContextSlot + <span class="keyword">sizeof</span> (CONTEXT);
00748 
00749                 <span class="comment">//</span>
00750                 <span class="comment">// Probe user stack area for writeability and then transfer the</span>
00751                 <span class="comment">// exception record and context record to the user stack area.</span>
00752                 <span class="comment">//</span>
00753 
00754                 <a class="code" href="../../d5/d8/ex_8h.html#a259">ProbeForWrite</a>((PCHAR) UserStack, ContextFrame.Gpr1 - UserStack, <span class="keyword">sizeof</span>(QUAD));
00755                 RtlMoveMemory((PVOID) ExceptSlot, ExceptionRecord, <span class="keyword">sizeof</span> (EXCEPTION_RECORD));
00756                 RtlMoveMemory((PVOID) ContextSlot, &amp;ContextFrame, <span class="keyword">sizeof</span> (CONTEXT));
00757 
00758                 <span class="comment">//</span>
00759                 <span class="comment">// Fill in TOC value as if it had been saved by prologue to</span>
00760                 <span class="comment">// KiUserExceptionDispatcher</span>
00761                 <span class="comment">//</span>
00762 
00763                 *((PULONG) TocSlot) = ContextFrame.Gpr2;
00764 
00765                 <span class="comment">//</span>
00766                 <span class="comment">// Set back chain from newly-constructed stack frame</span>
00767                 <span class="comment">//</span>
00768 
00769                 *((PULONG) UserStack) = ContextFrame.Gpr1;
00770 
00771                 <span class="comment">//</span>
00772                 <span class="comment">// Set address of exception record, context record,</span>
00773                 <span class="comment">// and the new stack pointer in the current trap frame.</span>
00774                 <span class="comment">//</span>
00775 
00776                 TrapFrame-&gt;Gpr1 = UserStack;        <span class="comment">// Stack pointer</span>
00777                 TrapFrame-&gt;Gpr3 = ExceptSlot;       <span class="comment">// First parameter</span>
00778                 TrapFrame-&gt;Gpr4 = ContextSlot;      <span class="comment">// Second parameter</span>
00779 
00780                 <span class="comment">//</span>
00781                 <span class="comment">// Sanitize the floating status register so a recursive</span>
00782                 <span class="comment">// exception will not occur.</span>
00783                 <span class="comment">//</span>
00784 
00785                 TrapFrame-&gt;Fpscr = SANITIZE_FPSCR(ContextFrame.Fpscr, <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>);
00786 
00787                 <span class="comment">//</span>
00788                 <span class="comment">// Set the execution address and TOC pointer of the exception</span>
00789                 <span class="comment">// routine that will call the exception dispatcher and then return</span>
00790                 <span class="comment">// to the trap handler.  The trap handler will restore the exception</span>
00791                 <span class="comment">// and trap frame context and continue execution in the routine</span>
00792                 <span class="comment">// that will call the exception dispatcher.</span>
00793                 <span class="comment">//</span>
00794 
00795                 {
00796                     PULONG FnDesc = (PULONG) <a class="code" href="../../d4/d9/ke_8h.html#a150">KeUserExceptionDispatcher</a>;
00797                     TrapFrame-&gt;Iar = FnDesc[0];
00798                     TrapFrame-&gt;Gpr2 = FnDesc[1];
00799                 }
00800 
00801                 <span class="keywordflow">return</span>;
00802 
00803             <span class="comment">//</span>
00804             <span class="comment">// If an exception occurs, then copy the new exception information</span>
00805             <span class="comment">// to an exception record and handle the exception.</span>
00806             <span class="comment">//</span>
00807 
00808             } except (<a class="code" href="../../d2/d9/ppc_2exceptn_8c.html#a12">KiCopyInformation</a>(&amp;ExceptionRecord1,
00809                                (GetExceptionInformation())-&gt;ExceptionRecord)) {
00810 
00811                 <span class="comment">//</span>
00812                 <span class="comment">// If the exception is a stack overflow, then attempt</span>
00813                 <span class="comment">// to raise the stack overflow exception. Otherwise,</span>
00814                 <span class="comment">// the user's stack is not accessible, or is misaligned,</span>
00815                 <span class="comment">// and second chance processing is performed.</span>
00816                 <span class="comment">//</span>
00817 
00818                 <span class="keywordflow">if</span> (ExceptionRecord1.ExceptionCode == STATUS_STACK_OVERFLOW) {
00819                     ExceptionRecord1.ExceptionAddress = ExceptionRecord-&gt;ExceptionAddress;
00820                     RtlMoveMemory((PVOID)ExceptionRecord,
00821                                   &amp;ExceptionRecord1, <span class="keyword">sizeof</span>(EXCEPTION_RECORD));
00822                     <span class="keywordflow">goto</span> repeat;
00823                 }
00824             }
00825         }
00826 
00827         <span class="comment">//</span>
00828         <span class="comment">// This is the second chance to handle the exception.</span>
00829         <span class="comment">//</span>
00830 
00831         UserApcPending = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>()-&gt;ApcState.UserApcPending;
00832         <span class="keywordflow">if</span> (<a class="code" href="../../d4/d3/dbgk_8h.html#a5">DbgkForwardException</a>(ExceptionRecord, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
00833             TrapFrame-&gt;Fpscr = SANITIZE_FPSCR(TrapFrame-&gt;Fpscr, <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>);
00834             <span class="keywordflow">goto</span> Handled2;
00835 
00836         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d4/d3/dbgk_8h.html#a5">DbgkForwardException</a>(ExceptionRecord, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>, <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>)) {
00837             <span class="comment">//</span>
00838             <span class="comment">// If a user APC was not previously pending and one is now</span>
00839             <span class="comment">// pending, then the thread has been terminated and the PC</span>
00840             <span class="comment">// must be forced to a legal address so an infinite loop does</span>
00841             <span class="comment">// not occur for the case where a jump to an unmapped address</span>
00842             <span class="comment">// occurred.</span>
00843             <span class="comment">//</span>
00844 
00845             <span class="keywordflow">if</span> ((UserApcPending == <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>) &amp;&amp;
00846                 (<a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>()-&gt;ApcState.UserApcPending != <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>)) {
00847 <span class="comment">// TEMPORARY .... PAT</span>
00848 <span class="comment">// Commenting out reference to USPCR (a known legal address ..</span>
00849 <span class="comment">//              TrapFrame-&gt;Iar = (ULONG)USPCR;</span>
00850             }
00851 
00852             TrapFrame-&gt;Fpscr = SANITIZE_FPSCR(TrapFrame-&gt;Fpscr, <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>);
00853             <span class="keywordflow">goto</span> Handled2;
00854 
00855         } <span class="keywordflow">else</span> {
00856             ZwTerminateProcess(NtCurrentProcess(), ExceptionRecord-&gt;ExceptionCode);
00857             <a class="code" href="../../d9/d1/bugcheck_8c.html#a19">KeBugCheckEx</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a13">KMODE_EXCEPTION_NOT_HANDLED</a>,
00858                          ExceptionRecord-&gt;ExceptionCode,
00859                          (ULONG)ExceptionRecord-&gt;ExceptionAddress,
00860                          ExceptionRecord-&gt;ExceptionInformation[0],
00861                          ExceptionRecord-&gt;ExceptionInformation[1]);
00862         }
00863     }
00864 
00865     <span class="comment">//</span>
00866     <span class="comment">// Move machine state from context frame to trap and exception frames and</span>
00867     <span class="comment">// then return to continue execution with the restored state.</span>
00868     <span class="comment">//</span>
00869 
00870 Handled1:
00871     <a class="code" href="../../d2/d9/ppc_2exceptn_8c.html#a10">KeContextToKframes</a>(TrapFrame, ExceptionFrame, &amp;ContextFrame,
00872                        ContextFrame.ContextFlags, PreviousMode);
00873 
00874     <span class="comment">//</span>
00875     <span class="comment">// Exception was handled by the debugger or the associated subsystem</span>
00876     <span class="comment">// and state was modified, if necessary, using the get state and set</span>
00877     <span class="comment">// state capabilities. Therefore the context frame does not need to</span>
00878     <span class="comment">// be transfered to the trap and exception frames.</span>
00879     <span class="comment">//</span>
00880 
00881 Handled2:
00882     <span class="keywordflow">return</span>;
00883 }
00884 
00885 ULONG
<a name="l00886"></a><a class="code" href="../../d2/d9/ppc_2exceptn_8c.html#a12">00886</a> <a class="code" href="../../d2/d9/ppc_2exceptn_8c.html#a12">KiCopyInformation</a> (
00887     IN OUT PEXCEPTION_RECORD ExceptionRecord1,
00888     IN PEXCEPTION_RECORD ExceptionRecord2
00889     )
00890 
00891 <span class="comment">/*++</span>
00892 <span class="comment"></span>
00893 <span class="comment">Routine Description:</span>
00894 <span class="comment"></span>
00895 <span class="comment">    This function is called from an exception filter to copy the exception</span>
00896 <span class="comment">    information from one exception record to another when an exception occurs.</span>
00897 <span class="comment"></span>
00898 <span class="comment">Arguments:</span>
00899 <span class="comment"></span>
00900 <span class="comment">    ExceptionRecord1 - Supplies a pointer to the destination exception record.</span>
00901 <span class="comment"></span>
00902 <span class="comment">    ExceptionRecord2 - Supplies a pointer to the source exception record.</span>
00903 <span class="comment"></span>
00904 <span class="comment">Return Value:</span>
00905 <span class="comment"></span>
00906 <span class="comment">    A value of EXCEPTION_EXECUTE_HANDLER is returned as the function value.</span>
00907 <span class="comment"></span>
00908 <span class="comment">--*/</span>
00909 
00910 {
00911 
00912     <span class="comment">//</span>
00913     <span class="comment">// Copy one exception record to another and return value that causes</span>
00914     <span class="comment">// an exception handler to be executed.</span>
00915     <span class="comment">//</span>
00916 
00917     RtlMoveMemory((PVOID)ExceptionRecord1,
00918                   (PVOID)ExceptionRecord2,
00919                   <span class="keyword">sizeof</span>(EXCEPTION_RECORD));
00920 
00921     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>;
00922 }
00923 
00924 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00925"></a><a class="code" href="../../d2/d9/ppc_2exceptn_8c.html#a13">00925</a> <a class="code" href="../../d2/d9/ppc_2exceptn_8c.html#a13">KeRaiseUserException</a>(
00926     IN NTSTATUS ExceptionCode
00927     )
00928 
00929 <span class="comment">/*++</span>
00930 <span class="comment"></span>
00931 <span class="comment">Routine Description:</span>
00932 <span class="comment"></span>
00933 <span class="comment">    This function causes an exception to be raised in the calling thread's user-mode</span>
00934 <span class="comment">    context. It does this by editing the trap frame the kernel was entered with to</span>
00935 <span class="comment">    point to trampoline code that raises the requested exception.</span>
00936 <span class="comment"></span>
00937 <span class="comment">Arguments:</span>
00938 <span class="comment"></span>
00939 <span class="comment">    ExceptionCode - Supplies the status value to be used as the exception</span>
00940 <span class="comment">        code for the exception that is to be raised.</span>
00941 <span class="comment"></span>
00942 <span class="comment">Return Value:</span>
00943 <span class="comment"></span>
00944 <span class="comment">    The status value that should be returned by the caller.</span>
00945 <span class="comment"></span>
00946 <span class="comment">--*/</span>
00947 
00948 {
00949     PKTRAP_FRAME TrapFrame;
00950     PULONG FnDesc;
00951 
00952     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>(KeGetPreviousMode() == <a class="code" href="../../d0/d9/ntosdef_8h.html#a76a70">UserMode</a>);
00953 
00954     TrapFrame = <a class="code" href="../../d2/d7/alpha_2kdpcpu_8h.html#a3">KeGetCurrentThread</a>()-&gt;TrapFrame;
00955     FnDesc = (PULONG)<a class="code" href="../../d4/d9/ke_8h.html#a151">KeRaiseUserExceptionDispatcher</a>;
00956 
00957     TrapFrame-&gt;Iar = FnDesc[0];
00958     TrapFrame-&gt;Gpr2 = FnDesc[1];
00959 
00960     <span class="keywordflow">return</span>(ExceptionCode);
00961 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:57 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
