<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: udfs/create.c File Reference</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>create.c File Reference</h1><code>#include "UdfProcs.h"</code><br>

<p>
<a href="../../d4/d7/udfs_2create_8c-source.html">Go to the source code of this file.</a><table border=0 cellpadding=0 cellspacing=0>
<tr><td></td></tr>
<tr><td colspan=2><br><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfs_2create_8c.html#a0">BugCheckFileId</a>&nbsp;&nbsp;&nbsp;(UDFS_BUG_CHECK_CREATE)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>#define&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfs_2create_8c.html#a1">Dbg</a>&nbsp;&nbsp;&nbsp;(UDFS_DEBUG_LEVEL_CREATE)</td></tr>

<tr><td colspan=2><br><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfs_2create_8c.html#a2">UdfNormalizeFileNames</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN <a class="el" href="../../d7/d5/struct__VCB.html">PVCB</a> Vcb, IN BOOLEAN OpenByFileId, IN BOOLEAN IgnoreCase, IN <a class="el" href="../../d3/d8/udfprocs_8h.html#a109">TYPE_OF_OPEN</a> RelatedTypeOfOpen, IN <a class="el" href="../../d2/d9/struct__CCB.html">PCCB</a> RelatedCcb OPTIONAL, IN PUNICODE_STRING RelatedFileName OPTIONAL, IN OUT PUNICODE_STRING <a class="el" href="../../d8/d1/hivestat_8c.html#a9">FileName</a>, IN OUT PUNICODE_STRING RemainingName)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfs_2create_8c.html#a3">UdfOpenExistingFcb</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN <a class="el" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp, IN OUT <a class="el" href="../../d7/d9/struct__FCB.html">PFCB</a> *CurrentFcb, IN <a class="el" href="../../d5/d9/struct__LCB.html">PLCB</a> OpenLcb, IN <a class="el" href="../../d3/d8/udfprocs_8h.html#a109">TYPE_OF_OPEN</a> TypeOfOpen, IN BOOLEAN IgnoreCase, IN <a class="el" href="../../d2/d9/struct__CCB.html">PCCB</a> RelatedCcb OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfs_2create_8c.html#a4">UdfOpenObjectByFileId</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN <a class="el" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp, IN <a class="el" href="../../d7/d5/struct__VCB.html">PVCB</a> Vcb, IN OUT <a class="el" href="../../d7/d9/struct__FCB.html">PFCB</a> *CurrentFcb)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfs_2create_8c.html#a5">UdfOpenObjectFromDirContext</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN <a class="el" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp, IN <a class="el" href="../../d7/d5/struct__VCB.html">PVCB</a> Vcb, IN OUT <a class="el" href="../../d7/d9/struct__FCB.html">PFCB</a> *CurrentFcb, IN BOOLEAN ShortNameMatch, IN BOOLEAN IgnoreCase, IN <a class="el" href="../../d5/d5/struct__DIR__ENUM__CONTEXT.html">PDIR_ENUM_CONTEXT</a> DirContext, IN BOOLEAN PerformUserOpen, IN <a class="el" href="../../d2/d9/struct__CCB.html">PCCB</a> RelatedCcb OPTIONAL)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfs_2create_8c.html#a6">UdfCompleteFcbOpen</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, <a class="el" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp, IN <a class="el" href="../../d7/d5/struct__VCB.html">PVCB</a> Vcb, IN OUT <a class="el" href="../../d7/d9/struct__FCB.html">PFCB</a> *CurrentFcb, IN <a class="el" href="../../d5/d9/struct__LCB.html">PLCB</a> OpenLcb, IN <a class="el" href="../../d3/d8/udfprocs_8h.html#a109">TYPE_OF_OPEN</a> TypeOfOpen, IN ULONG UserCcbFlags, IN ACCESS_MASK DesiredAccess)</td></tr>

<tr><td class="memItemLeft" nowrap align=right valign=top>NTSTATUS&nbsp;</td><td class="memItemRight" valign=bottom><a class="el" href="../../d3/d8/udfs_2create_8c.html#a7">UdfCommonCreate</a> (IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a> IrpContext, IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a> <a class="el" href="../../d0/d6/iop_8h.html#a35">Irp</a>)</td></tr>

</table>
<hr><h2>Define Documentation</h2>
<a class="anchor" name="a0" doxytag="udfs/create.c::BugCheckFileId" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define BugCheckFileId&nbsp;&nbsp;&nbsp;(UDFS_BUG_CHECK_CREATE)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d7/udfs_2create_8c-source.html#l00028">28</a> of file <a class="el" href="../../d4/d7/udfs_2create_8c-source.html">udfs/create.c</a>.    </td>
  </tr>
</table>
<a class="anchor" name="a1" doxytag="udfs/create.c::Dbg" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> #define Dbg&nbsp;&nbsp;&nbsp;(UDFS_DEBUG_LEVEL_CREATE)          </td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d7/udfs_2create_8c-source.html#l00034">34</a> of file <a class="el" href="../../d4/d7/udfs_2create_8c-source.html">udfs/create.c</a>.    </td>
  </tr>
</table>
<hr><h2>Function Documentation</h2>
<a class="anchor" name="a7" doxytag="udfs/create.c::UdfCommonCreate" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS UdfCommonCreate           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d0/d2/struct__IRP.html">PIRP</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Irp</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d7/udfs_2create_8c-source.html#l00108">108</a> of file <a class="el" href="../../d4/d7/udfs_2create_8c-source.html">udfs/create.c</a>.
<p>
References <a class="el" href="../../d7/d4/ntgdi_2icm_2inc_2debug_8h-source.html#l00146">ASSERT</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00501">BooleanFlagOn</a>, <a class="el" href="../../d6/d8/udfstruc_8h.html#a112">DIR_ENUM_CONTEXT</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01646">_DIR_ENUM_CONTEXT::Fid</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00992">_FCB::FileAttributes</a>, <a class="el" href="../../d3/d1/rtload_8c-source.html#l00047">FileName</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01534">_FILE_OBJECT::FileName</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02494">_IO_STACK_LOCATION::FileObject</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02030">_IO_STACK_LOCATION::Flags</a>, <a class="el" href="../../d1/d6/iso13346_8h-source.html#l00783">NSR_FID::Flags</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l03252">IoGetCurrentIrpStackLocation</a>, <a class="el" href="../../d1/d5/iop_8h-source.html#l00130">Irp</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01249">IRP_CONTEXT_FLAG_TRAIL_BACKSLASH</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01235">IRP_CONTEXT_FLAG_WAIT</a>, <a class="el" href="../../d1/d6/iso13346_8h-source.html#l00811">NSR_FID_F_DIRECTORY</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01665">_DIR_ENUM_CONTEXT::ObjectName</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02069">_IO_STACK_LOCATION::Parameters</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01524">_FILE_OBJECT::RelatedFileObject</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00629">_VCB::RootIndexFcb</a>, <a class="el" href="../../d2/d6/udfs_2nodetype_8h-source.html#l00063">SafeNodeType</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01867">SL_CASE_SENSITIVE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01864">SL_OPEN_PAGING_FILE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01865">SL_OPEN_TARGET_DIRECTORY</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00436">try_leave</a>, <a class="el" href="../../d3/d8/udfprocs_8h.html#a109">TYPE_OF_OPEN</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01542">UdfAcquireFcbExclusive</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01515">UdfAcquireVcbExclusive</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01518">UdfAcquireVcbShared</a>, <a class="el" href="../../d6/d4/namesup_8c-source.html#l00301">UdfCandidateShortName()</a>, <a class="el" href="../../d5/d7/dirsup_8c-source.html#l00099">UdfCleanupDirContext()</a>, <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00809">UdfCompleteRequest()</a>, <a class="el" href="../../d7/d2/filobsup_8c-source.html#l00133">UdfDecodeFileObject()</a>, <a class="el" href="../../d6/d4/namesup_8c-source.html#l00096">UdfDissectName()</a>, <a class="el" href="../../d5/d7/dirsup_8c-source.html#l00726">UdfFindDirEntry()</a>, <a class="el" href="../../d6/d3/prefxsup_8c-source.html#l00324">UdfFindPrefix()</a>, <a class="el" href="../../d5/d7/dirsup_8c-source.html#l00060">UdfInitializeDirContext()</a>, <a class="el" href="../../d4/d7/udfs_2create_8c-source.html#l00809">UdfNormalizeFileNames()</a>, <a class="el" href="../../d4/d7/udfs_2create_8c-source.html#l01522">UdfOpenExistingFcb()</a>, <a class="el" href="../../d4/d7/udfs_2create_8c-source.html#l01244">UdfOpenObjectByFileId()</a>, <a class="el" href="../../d4/d7/udfs_2create_8c-source.html#l01632">UdfOpenObjectFromDirContext()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00406">UdfRaiseStatus()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01548">UdfReleaseFcb</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01521">UdfReleaseVcb</a>, <a class="el" href="../../d2/d6/udfs_2nodetype_8h-source.html#l00038">UDFS_NTC_FCB_DATA</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l01606">UdfTeardownStructures()</a>, <a class="el" href="../../d9/d4/udfs_2verfysup_8c-source.html#l00603">UdfVerifyVcb()</a>, <a class="el" href="../../d3/d8/udfprocs_8h.html#a263a113">UnopenedFileObject</a>, <a class="el" href="../../d3/d8/udfprocs_8h.html#a263a116">UserDirectoryOpen</a>, <a class="el" href="../../d3/d8/udfprocs_8h.html#a263a117">UserFileOpen</a>, <a class="el" href="../../d3/d8/udfprocs_8h.html#a263a115">UserVolumeOpen</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00683">VCB_STATE_LOCKED</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00558">_VCB::VcbState</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00628">_VCB::VolumeDasdFcb</a>, and <a class="el" href="../../d1/d4/io_8h-source.html#l01518">_FILE_OBJECT::Vpb</a>.
<p>
Referenced by <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00218">UdfFsdDispatch()</a>, and <a class="el" href="../../d1/d7/fspdisp_8c-source.html#l00038">UdfFspDispatch()</a>.
<p>
<pre class="fragment"><div>00115                    :
00116 
00117     This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> common routine <span class="keywordflow">for</span> opening a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> called by both <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00118     Fsp and Fsd threads.
00119 
00120     The <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> can be opened either by name or by <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> Id either with or without
00121     a relative name.  The <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> name field in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object passed to <span class="keyword">this</span> routine
00122     contains either a unicode string or a 64 bit value which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> Id.
00123     If there <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a related <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object with a name then we will already have converted
00124     that name to Oem. 
00125 
00126     We will store <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> full name <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object on a successful
00127     open.  We will allocate a larger buffer <span class="keywordflow">if</span> necessary and combine <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00128     related and <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object names.  The <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> exception <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> relative open
00129     when <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> related <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <span class="keywordflow">for</span> an OpenByFileId <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.  If we need to
00130     allocate a buffer <span class="keywordflow">for</span> a <span class="keywordflow">case</span> insensitive name then we allocate <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> at
00131     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> tail of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> buffer we will store into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object.  The upcased
00132     portion will begin immediately after <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name defined by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>
00133     in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object.
00134 
00135     Once we have <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> full name in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object we don'<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> want to split <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00136     name in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> event of a retry.  We use a flag in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> IrpContext to indicate
00137     that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name has been split.
00138 
00139 Arguments:
00140 
00141     <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> - Supplies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> to process
00142 
00143 Return Value:
00144 
00145     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> status from <span class="keyword">this</span> open operation.
00146 
00147 --*/
00148 
00149 {
00150     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
00151     <a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a> IrpSp = <a class="code" href="../../d0/d5/io_8h.html#a228">IoGetCurrentIrpStackLocation</a>( Irp );
00152 
00153     <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> FileObject;
00154 
00155     <a class="code" href="../../d5/d5/struct__DIR__ENUM__CONTEXT.html">DIR_ENUM_CONTEXT</a> DirContext;
00156     BOOLEAN CleanupDirContext = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00157 
00158     BOOLEAN FoundEntry;
00159 
00160     <a class="code" href="../../d7/d5/struct__VCB.html">PVCB</a> Vcb;
00161 
00162     BOOLEAN OpenByFileId;
00163     BOOLEAN IgnoreCase;
00164     ULONG CreateDisposition;
00165 
00166     BOOLEAN ShortNameMatch;
00167 
00168     BOOLEAN VolumeOpen = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00169 
00170     <span class="comment">//</span>
00171     <span class="comment">//  We will be acquiring and releasing file Fcb's as we move down the</span>
00172     <span class="comment">//  directory tree during opens.  At any time we need to know the deepest</span>
00173     <span class="comment">//  point we have traversed down in the tree in case we need to cleanup</span>
00174     <span class="comment">//  any structures created here.</span>
00175     <span class="comment">//</span>
00176     <span class="comment">//  CurrentFcb - represents this point.  If non-null it means we have</span>
00177     <span class="comment">//      acquired it and need to release it in finally clause.</span>
00178     <span class="comment">//</span>
00179     <span class="comment">//  NextFcb - represents the NextFcb to walk to but haven't acquired yet.</span>
00180     <span class="comment">//</span>
00181     <span class="comment">//  CurrentLcb - represents the name of the CurrentFcb.</span>
00182     <span class="comment">//</span>
00183 
00184     <a class="code" href="../../d3/d8/udfprocs_8h.html#a109">TYPE_OF_OPEN</a> RelatedTypeOfOpen = <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a113">UnopenedFileObject</a>;
00185     <a class="code" href="../../d9/d1/struct__FILE__OBJECT.html">PFILE_OBJECT</a> RelatedFileObject;
00186     <a class="code" href="../../d2/d9/struct__CCB.html">PCCB</a> RelatedCcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00187 
00188     <a class="code" href="../../d7/d9/struct__FCB.html">PFCB</a> NextFcb;
00189     <a class="code" href="../../d7/d9/struct__FCB.html">PFCB</a> CurrentFcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00190 
00191     <a class="code" href="../../d5/d9/struct__LCB.html">PLCB</a> CurrentLcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00192 
00193     <span class="comment">//</span>
00194     <span class="comment">//  During the open we need to combine the related file object name</span>
00195     <span class="comment">//  with the remaining name.  We also may need to upcase the file name</span>
00196     <span class="comment">//  in order to do a case-insensitive name comparison.  We also need</span>
00197     <span class="comment">//  to restore the name in the file object in the event that we retry</span>
00198     <span class="comment">//  the request.  We use the following string variables to manage the</span>
00199     <span class="comment">//  name.  We will can put these strings into either Unicode or Ansi</span>
00200     <span class="comment">//  form.</span>
00201     <span class="comment">//</span>
00202     <span class="comment">//  FileName - Pointer to name as currently stored in the file</span>
00203     <span class="comment">//      object.  We store the full name into the file object early in</span>
00204     <span class="comment">//      the open operation.</span>
00205     <span class="comment">//</span>
00206     <span class="comment">//  RelatedFileName - Pointer to the name in the related file object.</span>
00207     <span class="comment">//</span>
00208     <span class="comment">//  RemainingName - String containing remaining name to parse.</span>
00209     <span class="comment">//</span>
00210 
00211     PUNICODE_STRING <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>;
00212     PUNICODE_STRING RelatedFileName;
00213 
00214     UNICODE_STRING RemainingName;
00215     UNICODE_STRING FinalName;
00216 
00217     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00218 
00219     <span class="comment">//</span>
00220     <span class="comment">//  If we were called with our file system device object instead of a</span>
00221     <span class="comment">//  volume device object, just complete this request with STATUS_SUCCESS.</span>
00222     <span class="comment">//</span>
00223 
00224     <span class="keywordflow">if</span> (IrpContext-&gt;Vcb == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00225 
00226         <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, Irp, STATUS_SUCCESS );
00227         <span class="keywordflow">return</span> STATUS_SUCCESS;
00228     }
00229 
00230     <span class="comment">//</span>
00231     <span class="comment">//  Get create parameters from the Irp.</span>
00232     <span class="comment">//</span>
00233 
00234     OpenByFileId = <a class="code" href="../../d5/d5/cc_8h.html#a59">BooleanFlagOn</a>( IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.Create.Options, FILE_OPEN_BY_FILE_ID );
00235     IgnoreCase = !<a class="code" href="../../d5/d5/cc_8h.html#a59">BooleanFlagOn</a>( IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o2">Flags</a>, SL_CASE_SENSITIVE );
00236     CreateDisposition = (IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.Create.Options &gt;&gt; 24) &amp; 0x000000ff;
00237 
00238     <span class="comment">//</span>
00239     <span class="comment">//  Do some preliminary checks to make sure the operation is supported.</span>
00240     <span class="comment">//  We fail in the following cases immediately.</span>
00241     <span class="comment">//</span>
00242     <span class="comment">//      - Open a paging file.</span>
00243     <span class="comment">//      - Open a target directory.</span>
00244     <span class="comment">//      - Open a file with Eas.</span>
00245     <span class="comment">//      - Create a file.</span>
00246     <span class="comment">//</span>
00247 
00248     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o2">Flags</a>, SL_OPEN_PAGING_FILE | SL_OPEN_TARGET_DIRECTORY) ||
00249         (IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.Create.EaLength != 0) ||
00250         (CreateDisposition == FILE_CREATE)) {
00251 
00252         <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, Irp, STATUS_ACCESS_DENIED );
00253         <span class="keywordflow">return</span> STATUS_ACCESS_DENIED;
00254     }
00255 
00256     <span class="comment">//</span>
00257     <span class="comment">//  Copy the Vcb to a local.  Assume the starting directory is the root.</span>
00258     <span class="comment">//</span>
00259 
00260     Vcb = IrpContext-&gt;Vcb;
00261     NextFcb = Vcb-&gt;<a class="code" href="../../d7/d5/struct__VCB.html#o21">RootIndexFcb</a>;
00262 
00263     <span class="comment">//</span>
00264     <span class="comment">//  Reference our input parameters to make things easier</span>
00265     <span class="comment">//</span>
00266 
00267     FileObject = IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a>;
00268     RelatedFileObject = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00269 
00270     <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a> = &amp;FileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o19">FileName</a>;
00271 
00272     <span class="comment">//</span>
00273     <span class="comment">//  Set up the file object's Vpb pointer in case anything happens.</span>
00274     <span class="comment">//  This will allow us to get a reasonable pop-up.</span>
00275     <span class="comment">//</span>
00276 
00277     <span class="keywordflow">if</span> ((FileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o9">RelatedFileObject</a> != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) &amp;&amp; !OpenByFileId) {
00278 
00279         RelatedFileObject = FileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o9">RelatedFileObject</a>;
00280         FileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o3">Vpb</a> = RelatedFileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o3">Vpb</a>;
00281 
00282         RelatedTypeOfOpen = <a class="code" href="../../d3/d8/udfprocs_8h.html#a174">UdfDecodeFileObject</a>( RelatedFileObject, &amp;NextFcb, &amp;RelatedCcb );
00283 
00284         <span class="comment">//</span>
00285         <span class="comment">//  Fail the request if this is not a user file object.</span>
00286         <span class="comment">//</span>
00287 
00288         <span class="keywordflow">if</span> (RelatedTypeOfOpen &lt; <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a115">UserVolumeOpen</a>) {
00289 
00290             <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, Irp, STATUS_INVALID_PARAMETER );
00291             <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00292         }
00293 
00294         <span class="comment">//</span>
00295         <span class="comment">//  Remember the name in the related file object.</span>
00296         <span class="comment">//</span>
00297 
00298         RelatedFileName = &amp;RelatedFileObject-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o19">FileName</a>;
00299     }
00300 
00301     <span class="comment">//</span>
00302     <span class="comment">//  If we haven't initialized the names then make sure the strings are valid.</span>
00303     <span class="comment">//  If this an OpenByFileId then verify the file id buffer.</span>
00304     <span class="comment">//</span>
00305     <span class="comment">//  After this routine returns we know that the full name is in the</span>
00306     <span class="comment">//  FileName buffer and the buffer will hold the upcased portion</span>
00307     <span class="comment">//  of the name yet to parse immediately after the full name in the</span>
00308     <span class="comment">//  buffer.  Any trailing backslash has been removed and the flag</span>
00309     <span class="comment">//  in the IrpContext will indicate whether we removed the</span>
00310     <span class="comment">//  backslash.</span>
00311     <span class="comment">//</span>
00312 
00313     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d8/udfs_2create_8c.html#a2">UdfNormalizeFileNames</a>( IrpContext,
00314                                     Vcb,
00315                                     OpenByFileId,
00316                                     IgnoreCase,
00317                                     RelatedTypeOfOpen,
00318                                     RelatedCcb,
00319                                     RelatedFileName,
00320                                     FileName,
00321                                     &amp;RemainingName );
00322 
00323     <span class="comment">//</span>
00324     <span class="comment">//  Return the error code if not successful.</span>
00325     <span class="comment">//</span>
00326 
00327     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
00328 
00329         <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, Irp, Status );
00330         <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00331     }
00332 
00333     <span class="comment">//</span>
00334     <span class="comment">//  We want to acquire the Vcb.  Exclusively for a volume open, shared otherwise.</span>
00335     <span class="comment">//  The file name is empty for a volume open.</span>
00336     <span class="comment">//</span>
00337 
00338     <span class="keywordflow">if</span> ((<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Length == 0) &amp;&amp;
00339         (RelatedTypeOfOpen &lt;= <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a115">UserVolumeOpen</a>) &amp;&amp;
00340         !OpenByFileId) {
00341 
00342         VolumeOpen = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00343         <a class="code" href="../../d3/d8/udfprocs_8h.html#a74">UdfAcquireVcbExclusive</a>( IrpContext, Vcb, FALSE );
00344 
00345     } <span class="keywordflow">else</span> {
00346 
00347         <a class="code" href="../../d3/d8/udfprocs_8h.html#a75">UdfAcquireVcbShared</a>( IrpContext, Vcb, FALSE );
00348     }
00349 
00350     <span class="comment">//</span>
00351     <span class="comment">//  Use a try-finally to facilitate cleanup.</span>
00352     <span class="comment">//</span>
00353 
00354     <span class="keywordflow">try</span> {
00355 
00356         <span class="comment">//</span>
00357         <span class="comment">//  Verify that the Vcb is not in an unusable condition.  This routine</span>
00358         <span class="comment">//  will raise if not usable.</span>
00359         <span class="comment">//</span>
00360 
00361         <a class="code" href="../../d8/d5/udfs_2verfysup_8c.html#a5">UdfVerifyVcb</a>( IrpContext, Vcb );
00362 
00363         <span class="comment">//</span>
00364         <span class="comment">//  If the Vcb is locked then we cannot open another file</span>
00365         <span class="comment">//</span>
00366 
00367         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( Vcb-&gt;<a class="code" href="../../d7/d5/struct__VCB.html#o7">VcbState</a>, VCB_STATE_LOCKED )) {
00368 
00369             <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( Status = STATUS_ACCESS_DENIED );
00370         }
00371 
00372         <span class="comment">//</span>
00373         <span class="comment">//  If we are opening this file by FileId then process this immediately</span>
00374         <span class="comment">//  and exit.</span>
00375         <span class="comment">//</span>
00376 
00377         <span class="keywordflow">if</span> (OpenByFileId) {
00378 
00379             <span class="comment">//</span>
00380             <span class="comment">//  The only create disposition we allow is OPEN.</span>
00381             <span class="comment">//</span>
00382 
00383             <span class="keywordflow">if</span> ((CreateDisposition != FILE_OPEN) &amp;&amp;
00384                 (CreateDisposition != FILE_OPEN_IF)) {
00385 
00386                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( Status = STATUS_ACCESS_DENIED );
00387             }
00388 
00389             <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( Status = <a class="code" href="../../d3/d8/udfs_2create_8c.html#a4">UdfOpenObjectByFileId</a>( IrpContext,
00390                                                        IrpSp,
00391                                                        Vcb,
00392                                                        &amp;CurrentFcb ));
00393         }
00394 
00395         <span class="comment">//</span>
00396         <span class="comment">//  If we are opening this volume Dasd then process this immediately</span>
00397         <span class="comment">//  and exit.</span>
00398         <span class="comment">//</span>
00399 
00400         <span class="keywordflow">if</span> (VolumeOpen) {
00401 
00402             <span class="comment">//</span>
00403             <span class="comment">//  The only create disposition we allow is OPEN.</span>
00404             <span class="comment">//</span>
00405 
00406             <span class="keywordflow">if</span> ((CreateDisposition != FILE_OPEN) &amp;&amp;
00407                 (CreateDisposition != FILE_OPEN_IF)) {
00408 
00409                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( Status = STATUS_ACCESS_DENIED );
00410             }
00411 
00412             <span class="comment">//</span>
00413             <span class="comment">//  If they wanted to open a directory, surprise.</span>
00414             <span class="comment">//</span>
00415             
00416             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.Create.Options, FILE_DIRECTORY_FILE )) {
00417 
00418                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( Status = STATUS_NOT_A_DIRECTORY );
00419             }
00420 
00421             <span class="comment">//</span>
00422             <span class="comment">//  Acquire the Fcb first.</span>
00423             <span class="comment">//</span>
00424 
00425             CurrentFcb = Vcb-&gt;<a class="code" href="../../d7/d5/struct__VCB.html#o20">VolumeDasdFcb</a>;
00426             <a class="code" href="../../d3/d8/udfprocs_8h.html#a83">UdfAcquireFcbExclusive</a>( IrpContext, CurrentFcb, FALSE );
00427 
00428             <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( Status = <a class="code" href="../../d3/d8/udfs_2create_8c.html#a3">UdfOpenExistingFcb</a>( IrpContext,
00429                                                     IrpSp,
00430                                                     &amp;CurrentFcb,
00431                                                     NULL,
00432                                                     UserVolumeOpen,
00433                                                     FALSE,
00434                                                     NULL ));
00435         }
00436 
00437         <span class="comment">//</span>
00438         <span class="comment">//  Acquire the Fcb at the beginning of our search to keep it from being</span>
00439         <span class="comment">//  deleted beneath us.</span>
00440         <span class="comment">//</span>
00441 
00442         <a class="code" href="../../d3/d8/udfprocs_8h.html#a83">UdfAcquireFcbExclusive</a>( IrpContext, NextFcb, FALSE );
00443         CurrentFcb = NextFcb;
00444 
00445         <span class="comment">//</span>
00446         <span class="comment">//  Do a prefix search if there is more of the name to parse.</span>
00447         <span class="comment">//</span>
00448 
00449         <span class="keywordflow">if</span> (RemainingName.Length != 0) {
00450 
00451             <span class="comment">//</span>
00452             <span class="comment">//  Do the prefix search to find the longest matching name.</span>
00453             <span class="comment">//</span>
00454 
00455             CurrentLcb = <a class="code" href="../../d3/d8/udfprocs_8h.html#a192">UdfFindPrefix</a>( IrpContext,
00456                                         &amp;CurrentFcb,
00457                                         &amp;RemainingName,
00458                                         IgnoreCase );
00459         }
00460 
00461         <span class="comment">//</span>
00462         <span class="comment">//  At this point CurrentFcb points at the lowest Fcb in the tree for this</span>
00463         <span class="comment">//  file name, CurrentLcb is that name, and RemainingName is the rest of the</span>
00464         <span class="comment">//  name we have to do any directory traversals for.</span>
00465         <span class="comment">//</span>
00466 
00467         <span class="comment">//</span>
00468         <span class="comment">//  If the remaining name length is zero then we have found our</span>
00469         <span class="comment">//  target.</span>
00470         <span class="comment">//</span>
00471 
00472         <span class="keywordflow">if</span> (RemainingName.Length == 0) {
00473 
00474             <span class="comment">//</span>
00475             <span class="comment">//  If this is a file so verify the user didn't want to open</span>
00476             <span class="comment">//  a directory.</span>
00477             <span class="comment">//</span>
00478 
00479             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d7/udfs_2nodetype_8h.html#a12">SafeNodeType</a>( CurrentFcb ) == <a class="code" href="../../d1/d7/udfs_2nodetype_8h.html#a4">UDFS_NTC_FCB_DATA</a>) {
00480 
00481                 <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpContext-&gt;Flags, IRP_CONTEXT_FLAG_TRAIL_BACKSLASH ) ||
00482                     <a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.Create.Options, FILE_DIRECTORY_FILE )) {
00483 
00484                     <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( Status = STATUS_NOT_A_DIRECTORY );
00485                 }
00486 
00487                 <span class="comment">//</span>
00488                 <span class="comment">//  The only create disposition we allow is OPEN.</span>
00489                 <span class="comment">//</span>
00490 
00491                 <span class="keywordflow">if</span> ((CreateDisposition != FILE_OPEN) &amp;&amp;
00492                     (CreateDisposition != FILE_OPEN_IF)) {
00493 
00494                     <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( Status = STATUS_ACCESS_DENIED );
00495                 }
00496 
00497                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( Status = <a class="code" href="../../d3/d8/udfs_2create_8c.html#a3">UdfOpenExistingFcb</a>( IrpContext,
00498                                                          IrpSp,
00499                                                          &amp;CurrentFcb,
00500                                                          CurrentLcb,
00501                                                          UserFileOpen,
00502                                                          IgnoreCase,
00503                                                          RelatedCcb ));
00504 
00505             <span class="comment">//</span>
00506             <span class="comment">//  This is a directory.  Verify the user didn't want to open</span>
00507             <span class="comment">//  as a file.</span>
00508             <span class="comment">//</span>
00509 
00510             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.Create.Options, FILE_NON_DIRECTORY_FILE )) {
00511 
00512                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( Status = STATUS_FILE_IS_A_DIRECTORY );
00513 
00514             <span class="comment">//</span>
00515             <span class="comment">//  Open the file as a directory.</span>
00516             <span class="comment">//</span>
00517 
00518             } <span class="keywordflow">else</span> {
00519 
00520                 <span class="comment">//</span>
00521                 <span class="comment">//  The only create disposition we allow is OPEN.</span>
00522                 <span class="comment">//</span>
00523 
00524                 <span class="keywordflow">if</span> ((CreateDisposition != FILE_OPEN) &amp;&amp;
00525                     (CreateDisposition != FILE_OPEN_IF)) {
00526 
00527                     <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( Status = STATUS_ACCESS_DENIED );
00528                 }
00529 
00530                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( Status = <a class="code" href="../../d3/d8/udfs_2create_8c.html#a3">UdfOpenExistingFcb</a>( IrpContext,
00531                                                          IrpSp,
00532                                                          &amp;CurrentFcb,
00533                                                          CurrentLcb,
00534                                                          UserDirectoryOpen,
00535                                                          IgnoreCase,
00536                                                          RelatedCcb ));
00537             }
00538         }
00539 
00540         <span class="comment">//</span>
00541         <span class="comment">//  We have more work to do.  We have a starting Fcb which we own shared.</span>
00542         <span class="comment">//  We also have the remaining name to parse.  Walk through the name</span>
00543         <span class="comment">//  component by component looking for the full name.</span>
00544         <span class="comment">//</span>
00545 
00546         <span class="comment">//</span>
00547         <span class="comment">//  Our starting Fcb better be a directory.</span>
00548         <span class="comment">//</span>
00549 
00550         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( CurrentFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o11">FileAttributes</a>, FILE_ATTRIBUTE_DIRECTORY )) {
00551 
00552             <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( Status = STATUS_OBJECT_PATH_NOT_FOUND );
00553         }
00554 
00555         <span class="comment">//</span>
00556         <span class="comment">//  If we can't wait then post this request.</span>
00557         <span class="comment">//</span>
00558 
00559         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpContext-&gt;Flags, IRP_CONTEXT_FLAG_WAIT )) {
00560 
00561             <a class="code" href="../../d3/d8/udfprocs_8h.html#a122">UdfRaiseStatus</a>( IrpContext, STATUS_CANT_WAIT );
00562         }
00563 
00564         <span class="comment">//</span>
00565         <span class="comment">//  Prepare the enumeration context for use.</span>
00566         <span class="comment">//</span>
00567         
00568         <a class="code" href="../../d3/d8/udfprocs_8h.html#a167">UdfInitializeDirContext</a>( IrpContext, &amp;DirContext );
00569         CleanupDirContext = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00570 
00571         <span class="keywordflow">while</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>) {
00572 
00573             ShortNameMatch = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00574 
00575             <span class="comment">//</span>
00576             <span class="comment">//  Split off the next component from the name.</span>
00577             <span class="comment">//</span>
00578 
00579             <a class="code" href="../../d3/d8/udfprocs_8h.html#a177">UdfDissectName</a>( IrpContext,
00580                             &amp;RemainingName,
00581                             &amp;FinalName );
00582 
00583             <span class="comment">//</span>
00584             <span class="comment">//  Go ahead and look this entry up in the directory.</span>
00585             <span class="comment">//</span>
00586 
00587             FoundEntry = <a class="code" href="../../d3/d8/udfprocs_8h.html#a172">UdfFindDirEntry</a>( IrpContext,
00588                                           CurrentFcb,
00589                                           &amp;FinalName,
00590                                           IgnoreCase,
00591                                           FALSE,
00592                                           &amp;DirContext );
00593 
00594             <span class="comment">//</span>
00595             <span class="comment">//  If we didn't find the entry then check if the current name</span>
00596             <span class="comment">//  is a possible short name.</span>
00597             <span class="comment">//</span>
00598 
00599             <span class="keywordflow">if</span> (!FoundEntry &amp;&amp; <a class="code" href="../../d3/d8/udfprocs_8h.html#a179">UdfCandidateShortName</a>( IrpContext, &amp;FinalName)) {
00600 
00601                 <span class="comment">//</span>
00602                 <span class="comment">//  If the name looks like it could be a short name, try to find</span>
00603                 <span class="comment">//  a matching real directory entry.</span>
00604                 <span class="comment">//</span>
00605 
00606                 ShortNameMatch =
00607                 FoundEntry = <a class="code" href="../../d3/d8/udfprocs_8h.html#a172">UdfFindDirEntry</a>( IrpContext,
00608                                               CurrentFcb,
00609                                               &amp;FinalName,
00610                                               IgnoreCase,
00611                                               TRUE,
00612                                               &amp;DirContext );
00613             }
00614 
00615             <span class="comment">//</span>
00616             <span class="comment">//  If we didn't find a match then check what the caller was trying to do to</span>
00617             <span class="comment">//  determine which error code to return.</span>
00618             <span class="comment">//</span>
00619     
00620             <span class="keywordflow">if</span> (!FoundEntry) {
00621     
00622                 <span class="keywordflow">if</span> ((CreateDisposition == FILE_OPEN) ||
00623                     (CreateDisposition == FILE_OVERWRITE)) {
00624     
00625                     <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( Status = STATUS_OBJECT_NAME_NOT_FOUND );
00626                 }
00627     
00628                 <span class="comment">//</span>
00629                 <span class="comment">//  Any other operation return STATUS_ACCESS_DENIED.</span>
00630                 <span class="comment">//</span>
00631     
00632                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( Status = STATUS_ACCESS_DENIED );
00633             }
00634 
00635             <span class="comment">//</span>
00636             <span class="comment">//  If this is an ignore case open then copy the exact case</span>
00637             <span class="comment">//  in the file object name.</span>
00638             <span class="comment">//</span>
00639 
00640             <span class="keywordflow">if</span> (IgnoreCase &amp;&amp; !ShortNameMatch) {
00641 
00642                 <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a>( FinalName.Length == DirContext.<a class="code" href="../../d5/d5/struct__DIR__ENUM__CONTEXT.html#o8">ObjectName</a>.Length );
00643                 
00644                 RtlCopyMemory( FinalName.Buffer,
00645                                DirContext.<a class="code" href="../../d5/d5/struct__DIR__ENUM__CONTEXT.html#o8">ObjectName</a>.Buffer,
00646                                DirContext.<a class="code" href="../../d5/d5/struct__DIR__ENUM__CONTEXT.html#o8">ObjectName</a>.Length );
00647             }
00648 
00649             <span class="comment">//</span>
00650             <span class="comment">//  If we have found the last component then break out to open for the caller.</span>
00651             <span class="comment">//</span>
00652 
00653             <span class="keywordflow">if</span> (RemainingName.Length == 0) {
00654 
00655                 <span class="keywordflow">break</span>;
00656             }
00657             
00658             <span class="comment">//</span>
00659             <span class="comment">//  The object we just found must be a directory.</span>
00660             <span class="comment">//</span>
00661 
00662             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( DirContext.<a class="code" href="../../d5/d5/struct__DIR__ENUM__CONTEXT.html#o5">Fid</a>-&gt;<a class="code" href="../../d1/d2/structNSR__FID.html#o2">Flags</a>, NSR_FID_F_DIRECTORY )) {
00663 
00664                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( Status = STATUS_OBJECT_PATH_NOT_FOUND );
00665             }
00666 
00667             <span class="comment">//</span>
00668             <span class="comment">//  Now open an Fcb for this intermediate index Fcb.</span>
00669             <span class="comment">//</span>
00670 
00671             <a class="code" href="../../d3/d8/udfs_2create_8c.html#a5">UdfOpenObjectFromDirContext</a>( IrpContext,
00672                                          IrpSp,
00673                                          Vcb,
00674                                          &amp;CurrentFcb,
00675                                          ShortNameMatch,
00676                                          IgnoreCase,
00677                                          &amp;DirContext,
00678                                          FALSE,
00679                                          NULL );
00680         }
00681         
00682         <span class="comment">//</span>
00683         <span class="comment">//  Make sure our opener is about to get what they expect.</span>
00684         <span class="comment">//</span>
00685 
00686         <span class="keywordflow">if</span> ((<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpContext-&gt;Flags, IRP_CONTEXT_FLAG_TRAIL_BACKSLASH ) ||
00687              <a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.Create.Options, FILE_DIRECTORY_FILE )) &amp;&amp;
00688             !<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( DirContext.<a class="code" href="../../d5/d5/struct__DIR__ENUM__CONTEXT.html#o5">Fid</a>-&gt;<a class="code" href="../../d1/d2/structNSR__FID.html#o2">Flags</a>, NSR_FID_F_DIRECTORY )) {
00689 
00690             <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( Status = STATUS_NOT_A_DIRECTORY );
00691         
00692         }
00693 
00694         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.Create.Options, FILE_NON_DIRECTORY_FILE ) &amp;&amp;
00695             <a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( DirContext.<a class="code" href="../../d5/d5/struct__DIR__ENUM__CONTEXT.html#o5">Fid</a>-&gt;<a class="code" href="../../d1/d2/structNSR__FID.html#o2">Flags</a>, NSR_FID_F_DIRECTORY )) {
00696 
00697             <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( Status = STATUS_FILE_IS_A_DIRECTORY );
00698         }
00699 
00700         <span class="comment">//</span>
00701         <span class="comment">//  The only create disposition we allow is OPEN.</span>
00702         <span class="comment">//</span>
00703 
00704         <span class="keywordflow">if</span> ((CreateDisposition != FILE_OPEN) &amp;&amp;
00705             (CreateDisposition != FILE_OPEN_IF)) {
00706 
00707             <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( Status = STATUS_ACCESS_DENIED );
00708         }
00709 
00710         <span class="comment">//</span>
00711         <span class="comment">//  Open the object for the caller.</span>
00712         <span class="comment">//</span>
00713 
00714         <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( Status = <a class="code" href="../../d3/d8/udfs_2create_8c.html#a5">UdfOpenObjectFromDirContext</a>( IrpContext,
00715                                                          IrpSp,
00716                                                          Vcb,
00717                                                          &amp;CurrentFcb,
00718                                                          ShortNameMatch,
00719                                                          IgnoreCase,
00720                                                          &amp;DirContext,
00721                                                          TRUE,
00722                                                          RelatedCcb ));
00723     } finally {
00724         
00725         <span class="comment">//</span>
00726         <span class="comment">//  Cleanup the enumeration context if initialized.</span>
00727         <span class="comment">//</span>
00728 
00729         <span class="keywordflow">if</span> (CleanupDirContext) {
00730 
00731             <a class="code" href="../../d3/d8/udfprocs_8h.html#a168">UdfCleanupDirContext</a>( IrpContext, &amp;DirContext );
00732         }
00733 
00734         <span class="comment">//</span>
00735         <span class="comment">//  The result of this open could be success, pending or some error</span>
00736         <span class="comment">//  condition.</span>
00737         <span class="comment">//</span>
00738 
00739         <span class="keywordflow">if</span> (AbnormalTermination()) {
00740 
00741 
00742             <span class="comment">//</span>
00743             <span class="comment">//  In the error path we start by calling our teardown routine if we</span>
00744             <span class="comment">//  have a CurrentFcb.</span>
00745             <span class="comment">//</span>
00746 
00747             <span class="keywordflow">if</span> (CurrentFcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00748 
00749                 BOOLEAN RemovedFcb;
00750 
00751                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a210">UdfTeardownStructures</a>( IrpContext, CurrentFcb, FALSE, &amp;RemovedFcb );
00752 
00753                 <span class="keywordflow">if</span> (RemovedFcb) {
00754 
00755                     CurrentFcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00756                 }
00757             }
00758             
00759             <span class="comment">//</span>
00760             <span class="comment">//  No need to complete the request.</span>
00761             <span class="comment">//</span>
00762 
00763             IrpContext = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00764             <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00765 
00766         <span class="comment">//</span>
00767         <span class="comment">//  If we posted this request through the oplock package we need</span>
00768         <span class="comment">//  to show that there is no reason to complete the request.</span>
00769         <span class="comment">//</span>
00770 
00771         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_PENDING) {
00772 
00773             IrpContext = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00774             <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a> = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00775         }
00776 
00777         <span class="comment">//</span>
00778         <span class="comment">//  Release the Current Fcb if still acquired.</span>
00779         <span class="comment">//</span>
00780 
00781         <span class="keywordflow">if</span> (CurrentFcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00782 
00783             <a class="code" href="../../d3/d8/udfprocs_8h.html#a85">UdfReleaseFcb</a>( IrpContext, CurrentFcb );
00784         }
00785 
00786         <span class="comment">//</span>
00787         <span class="comment">//  Release the Vcb.</span>
00788         <span class="comment">//</span>
00789 
00790         <a class="code" href="../../d3/d8/udfprocs_8h.html#a76">UdfReleaseVcb</a>( IrpContext, Vcb );
00791 
00792         <span class="comment">//</span>
00793         <span class="comment">//  Call our completion routine.  It will handle the case where either</span>
00794         <span class="comment">//  the Irp and/or IrpContext are gone.</span>
00795         <span class="comment">//</span>
00796 
00797         <a class="code" href="../../d3/d8/udfprocs_8h.html#a129">UdfCompleteRequest</a>( IrpContext, Irp, Status );
00798     }
00799 
00800     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00801 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a6" doxytag="udfs/create.c::UdfCompleteFcbOpen" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS UdfCompleteFcbOpen           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap><a class="el" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpSp</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d7/d5/struct__VCB.html">PVCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Vcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT <a class="el" href="../../d7/d9/struct__FCB.html">PFCB</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>CurrentFcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d5/d9/struct__LCB.html">PLCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>OpenLcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d3/d8/udfprocs_8h.html#a109">TYPE_OF_OPEN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>TypeOfOpen</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ULONG&nbsp;</td>
          <td class="mdname" nowrap> <em>UserCcbFlags</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN ACCESS_MASK&nbsp;</td>
          <td class="mdname" nowrap> <em>DesiredAccess</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d7/udfs_2create_8c-source.html#l01955">1955</a> of file <a class="el" href="../../d4/d7/udfs_2create_8c-source.html">udfs/create.c</a>.
<p>
References <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d1/d8/fsrtl_8h.html#a188a86">FastIoIsNotPossible</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00978">_FCB::FcbCleanup</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01027">_FCB::FcbNonpaged</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00979">_FCB::FcbReference</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00980">_FCB::FcbUserReference</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02494">_IO_STACK_LOCATION::FileObject</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01533">_FILE_OBJECT::Flags</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01496">FO_CACHE_SUPPORTED</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01493">FO_NO_INTERMEDIATE_BUFFERING</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l00823">FsRtlCheckOplock()</a>, <a class="el" href="../../d6/d1/oplock_8c-source.html#l01169">FsRtlCurrentBatchOplock()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l03032">IoCheckShareAccess()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l10175">IoSetShareAccess()</a>, <a class="el" href="../../d5/d5/iosubs_8c-source.html#l11330">IoUpdateShareAccess()</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01235">IRP_CONTEXT_FLAG_WAIT</a>, <a class="el" href="../../d6/d5/stierr_8h-source.html#l00030">NT_SUCCESS</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l02069">_IO_STACK_LOCATION::Parameters</a>, <a class="el" href="../../d1/d4/io_8h-source.html#l01521">_FILE_OBJECT::SectionObjectPointer</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00853">_FCB_NONPAGED::SegmentObject</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00505">SetFlag</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01033">_FCB::ShareAccess</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l02433">UdfCreateCcb()</a>, <a class="el" href="../../d3/d8/close_8c-source.html#l00099">UdfFspClose()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01750">UdfIncrementCleanupCounts</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01762">UdfIncrementReferenceCounts</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00385">UdfIsFastIoPossible</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01567">UdfLockFcb</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01559">UdfLockVcb</a>, <a class="el" href="../../d3/d8/workque_8c-source.html#l00222">UdfOplockComplete()</a>, <a class="el" href="../../d3/d8/workque_8c-source.html#l00111">UdfPrePostIrp()</a>, <a class="el" href="../../d9/d1/udfs_2cachesup_8c-source.html#l00417">UdfPurgeVolume()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00406">UdfRaiseStatus()</a>, <a class="el" href="../../d7/d2/filobsup_8c-source.html#l00049">UdfSetFileObject()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01577">UdfUnlockFcb</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01563">UdfUnlockVcb</a>, <a class="el" href="../../d3/d8/udfprocs_8h.html#a263a117">UserFileOpen</a>, <a class="el" href="../../d3/d8/udfprocs_8h.html#a263a115">UserVolumeOpen</a>, and <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00683">VCB_STATE_LOCKED</a>.
<p>
Referenced by <a class="el" href="../../d4/d7/udfs_2create_8c-source.html#l01522">UdfOpenExistingFcb()</a>, <a class="el" href="../../d4/d7/udfs_2create_8c-source.html#l01244">UdfOpenObjectByFileId()</a>, and <a class="el" href="../../d4/d7/udfs_2create_8c-source.html#l01632">UdfOpenObjectFromDirContext()</a>.
<p>
<pre class="fragment"><div>01968                    :
01969 
01970     This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> worker routine which takes an existing Fcb and completes
01971     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> open.  We will <span class="keywordflow">do</span> any necessary oplock checks and sharing checks.
01972     Finally we will create <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Ccb and update <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object and any
01973     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object flags.
01974 
01975 Arguments:
01976 
01977     IrpSp - Stack location <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current request.
01978 
01979     Vcb - Vcb <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current volume.
01980 
01981     CurrentFcb - Address of pointer to Fcb to open.  We clear <span class="keyword">this</span> field <span class="keywordflow">if</span>
01982         we release <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> resource <span class="keywordflow">for</span> <span class="keyword">this</span> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.
01983         
01984     OpenLcb - Lcb <span class="keyword">this</span> Fcb <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> being opened by
01985 
01986     TypeOfOpen - Type of open <span class="keywordflow">for</span> <span class="keyword">this</span> request.
01987 
01988     UserCcbFlags - Flags to OR into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Ccb flags.
01989 
01990     DesiredAccess - Desired access <span class="keywordflow">for</span> <span class="keyword">this</span> open.
01991 
01992 Return Value:
01993 
01994     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - STATUS_SUCCESS <span class="keywordflow">if</span> we complete <span class="keyword">this</span> request, STATUS_PENDING <span class="keywordflow">if</span>
01995         <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> oplock <span class="keyword">package </span>takes the Irp or SHARING_VIOLATION if there is a
01996         sharing check conflict.
01997 
01998 --*/
01999 
02000 {
02001     NTSTATUS Status;
02002     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> OplockStatus = STATUS_SUCCESS;
02003     ULONG Information = FILE_OPENED;
02004 
02005     BOOLEAN LockVolume = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02006 
02007     <a class="code" href="../../d7/d9/struct__FCB.html">PFCB</a> Fcb = *CurrentFcb;
02008     <a class="code" href="../../d2/d9/struct__CCB.html">PCCB</a> Ccb;
02009 
02010     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
02011 
02012     <span class="comment">//</span>
02013     <span class="comment">//  If this a volume open and the user wants to lock the volume then</span>
02014     <span class="comment">//  purge and lock the volume.</span>
02015     <span class="comment">//</span>
02016 
02017     <span class="keywordflow">if</span> ((TypeOfOpen &lt;= <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a115">UserVolumeOpen</a>) &amp;&amp;
02018         !<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.Create.ShareAccess, FILE_SHARE_READ )) {
02019 
02020         <span class="comment">//</span>
02021         <span class="comment">//  If there are open handles then fail this immediately.</span>
02022         <span class="comment">//</span>
02023 
02024         <span class="keywordflow">if</span> (Vcb-&gt;VcbCleanup != 0) {
02025 
02026             <span class="keywordflow">return</span> STATUS_SHARING_VIOLATION;
02027         }
02028 
02029         <span class="comment">//</span>
02030         <span class="comment">//  If we can't wait then force this to be posted.</span>
02031         <span class="comment">//</span>
02032 
02033         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpContext-&gt;Flags, IRP_CONTEXT_FLAG_WAIT )) {
02034 
02035             <a class="code" href="../../d3/d8/udfprocs_8h.html#a122">UdfRaiseStatus</a>( IrpContext, STATUS_CANT_WAIT );
02036         }
02037 
02038         LockVolume = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02039 
02040         <span class="comment">//</span>
02041         <span class="comment">//  Purge the volume and make sure all of the user references</span>
02042         <span class="comment">//  are gone.</span>
02043         <span class="comment">//</span>
02044 
02045         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d8/udfprocs_8h.html#a158">UdfPurgeVolume</a>( IrpContext, Vcb, FALSE );
02046 
02047         <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> != STATUS_SUCCESS) {
02048 
02049             <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02050         }
02051 
02052         <span class="comment">//</span>
02053         <span class="comment">//  Now force all of the delayed close operations to go away.</span>
02054         <span class="comment">//</span>
02055 
02056         <a class="code" href="../../d3/d8/udfprocs_8h.html#a250">UdfFspClose</a>( Vcb );
02057 
02058         <span class="keywordflow">if</span> (Vcb-&gt;VcbUserReference &gt; Vcb-&gt;VcbResidualUserReference) {
02059 
02060             <span class="keywordflow">return</span> STATUS_SHARING_VIOLATION;
02061         }
02062     }
02063 
02064     <span class="comment">//</span>
02065     <span class="comment">//  If the Fcb already existed then we need to check the oplocks and</span>
02066     <span class="comment">//  the share access.</span>
02067     <span class="comment">//</span>
02068 
02069     <span class="keywordflow">if</span> (Fcb-&gt;FcbCleanup != 0) {
02070 
02071         <span class="comment">//</span>
02072         <span class="comment">//  If this is a user file open then check whether there are any</span>
02073         <span class="comment">//  batch oplock.</span>
02074         <span class="comment">//</span>
02075 
02076         <span class="keywordflow">if</span> (TypeOfOpen == <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a117">UserFileOpen</a>) {
02077 
02078             <span class="comment">//</span>
02079             <span class="comment">//  Store the address of the Fcb for a possible teardown into</span>
02080             <span class="comment">//  the IrpContext.  We will release this in the call to</span>
02081             <span class="comment">//  prepost the Irp.</span>
02082             <span class="comment">//</span>
02083 
02084             IrpContext-&gt;TeardownFcb = CurrentFcb;
02085 
02086             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d8/fsrtl_8h.html#a167">FsRtlCurrentBatchOplock</a>( &amp;Fcb-&gt;Oplock )) {
02087 
02088                 <span class="comment">//</span>
02089                 <span class="comment">//  We remember if a batch oplock break is underway for the</span>
02090                 <span class="comment">//  case where the sharing check fails.</span>
02091                 <span class="comment">//</span>
02092 
02093                 Information = FILE_OPBATCH_BREAK_UNDERWAY;
02094 
02095                 OplockStatus = <a class="code" href="../../d1/d8/fsrtl_8h.html#a165">FsRtlCheckOplock</a>( &amp;Fcb-&gt;Oplock,
02096                                                  IrpContext-&gt;Irp,
02097                                                  IrpContext,
02098                                                  UdfOplockComplete,
02099                                                  UdfPrePostIrp );
02100 
02101                 <span class="keywordflow">if</span> (OplockStatus == STATUS_PENDING) {
02102 
02103                     <span class="keywordflow">return</span> STATUS_PENDING;
02104                 }
02105             }
02106 
02107             <span class="comment">//</span>
02108             <span class="comment">//  Check the share access before breaking any exclusive oplocks.</span>
02109             <span class="comment">//</span>
02110 
02111             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d6/iosubs_8c.html#a38">IoCheckShareAccess</a>( DesiredAccess,
02112                                          IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.Create.ShareAccess,
02113                                          IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a>,
02114                                          &amp;Fcb-&gt;ShareAccess,
02115                                          FALSE );
02116 
02117             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
02118 
02119                 <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02120             }
02121 
02122             <span class="comment">//</span>
02123             <span class="comment">//  Now check that we can continue based on the oplock state of the</span>
02124             <span class="comment">//  file.</span>
02125             <span class="comment">//</span>
02126 
02127             OplockStatus = <a class="code" href="../../d1/d8/fsrtl_8h.html#a165">FsRtlCheckOplock</a>( &amp;Fcb-&gt;Oplock,
02128                                              IrpContext-&gt;Irp,
02129                                              IrpContext,
02130                                              UdfOplockComplete,
02131                                              UdfPrePostIrp );
02132 
02133             <span class="keywordflow">if</span> (OplockStatus == STATUS_PENDING) {
02134 
02135                 <span class="keywordflow">return</span> STATUS_PENDING;
02136             }
02137 
02138             IrpContext-&gt;TeardownFcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02139 
02140         <span class="comment">//</span>
02141         <span class="comment">//  Otherwise just do the sharing check.</span>
02142         <span class="comment">//</span>
02143 
02144         } <span class="keywordflow">else</span> {
02145 
02146             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d4/d6/iosubs_8c.html#a38">IoCheckShareAccess</a>( DesiredAccess,
02147                                          IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.Create.ShareAccess,
02148                                          IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a>,
02149                                          &amp;Fcb-&gt;ShareAccess,
02150                                          FALSE );
02151 
02152             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
02153 
02154                 <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02155             }
02156         }
02157     }
02158 
02159     <span class="comment">//</span>
02160     <span class="comment">//  Create the Ccb now.</span>
02161     <span class="comment">//</span>
02162 
02163     Ccb = <a class="code" href="../../d3/d8/udfprocs_8h.html#a216">UdfCreateCcb</a>( IrpContext, Fcb, OpenLcb, UserCcbFlags );
02164 
02165     <span class="comment">//</span>
02166     <span class="comment">//  Update the share access.</span>
02167     <span class="comment">//</span>
02168 
02169     <span class="keywordflow">if</span> (Fcb-&gt;FcbCleanup == 0) {
02170 
02171         <a class="code" href="../../d4/d6/iosubs_8c.html#a107">IoSetShareAccess</a>( DesiredAccess,
02172                           IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.Create.ShareAccess,
02173                           IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a>,
02174                           &amp;Fcb-&gt;ShareAccess );
02175 
02176     } <span class="keywordflow">else</span> {
02177 
02178         <a class="code" href="../../d4/d6/iosubs_8c.html#a121">IoUpdateShareAccess</a>( IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a>, &amp;Fcb-&gt;ShareAccess );
02179     }
02180 
02181     <span class="comment">//</span>
02182     <span class="comment">//  Set the file object type.</span>
02183     <span class="comment">//</span>
02184 
02185     <a class="code" href="../../d3/d8/udfprocs_8h.html#a173">UdfSetFileObject</a>( IrpContext, IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a>, TypeOfOpen, Fcb, Ccb );
02186 
02187     <span class="comment">//</span>
02188     <span class="comment">//  Set the appropriate cache flags for a user file object.</span>
02189     <span class="comment">//</span>
02190 
02191     <span class="keywordflow">if</span> (TypeOfOpen == <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a117">UserFileOpen</a>) {
02192 
02193         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o11">Parameters</a>.Create.Options, FILE_NO_INTERMEDIATE_BUFFERING )) {
02194 
02195             <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a>-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o18">Flags</a>, FO_NO_INTERMEDIATE_BUFFERING );
02196 
02197         } <span class="keywordflow">else</span> {
02198 
02199             <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a>-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o18">Flags</a>, FO_CACHE_SUPPORTED );
02200         }
02201     }
02202     <span class="comment">//</span>
02203     <span class="comment">//  Update the open and cleanup counts.  Check the fast io state here.</span>
02204     <span class="comment">//</span>
02205 
02206     <a class="code" href="../../d3/d8/udfprocs_8h.html#a88">UdfLockVcb</a>( IrpContext, Vcb );
02207 
02208     <a class="code" href="../../d3/d8/udfprocs_8h.html#a96">UdfIncrementCleanupCounts</a>( IrpContext, Fcb );
02209     
02210     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( +1, Dbg,
02211                  <span class="stringliteral">"UdfCompleteFcbOpen, Fcb %08x Vcb %d/%d Fcb %d/%d\n"</span>, Fcb,
02212                  Vcb-&gt;VcbReference,
02213                  Vcb-&gt;VcbUserReference,
02214                  Fcb-&gt;FcbReference,
02215                  Fcb-&gt;FcbUserReference ));
02216 
02217     <a class="code" href="../../d3/d8/udfprocs_8h.html#a98">UdfIncrementReferenceCounts</a>( IrpContext, Fcb, 1, 1 );
02218     
02219     <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( -1, Dbg,
02220                  <span class="stringliteral">"UdfCompleteFcbOpen, Vcb %d/%d Fcb %d/%d\n"</span>,
02221                  Vcb-&gt;VcbReference,
02222                  Vcb-&gt;VcbUserReference,
02223                  Fcb-&gt;FcbReference,
02224                  Fcb-&gt;FcbUserReference ));
02225 
02226     <span class="keywordflow">if</span> (LockVolume) {
02227 
02228         Vcb-&gt;VolumeLockFileObject = IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a>;
02229         <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( Vcb-&gt;VcbState, VCB_STATE_LOCKED );
02230     }
02231 
02232     <a class="code" href="../../d3/d8/udfprocs_8h.html#a89">UdfUnlockVcb</a>( IrpContext, Vcb );
02233 
02234     <a class="code" href="../../d3/d8/udfprocs_8h.html#a90">UdfLockFcb</a>( IrpContext, Fcb );
02235 
02236     <span class="keywordflow">if</span> (TypeOfOpen == <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a117">UserFileOpen</a>) {
02237 
02238         Fcb-&gt;IsFastIoPossible = <a class="code" href="../../d3/d8/udfprocs_8h.html#a63">UdfIsFastIoPossible</a>( Fcb );
02239 
02240     } <span class="keywordflow">else</span> {
02241 
02242         Fcb-&gt;IsFastIoPossible = <a class="code" href="../../d1/d8/fsrtl_8h.html#a188a86">FastIoIsNotPossible</a>;
02243     }
02244 
02245     <a class="code" href="../../d3/d8/udfprocs_8h.html#a91">UdfUnlockFcb</a>( IrpContext, Fcb );
02246 
02247     <span class="comment">//</span>
02248     <span class="comment">//  Show that we opened the file.</span>
02249     <span class="comment">//</span>
02250 
02251     IrpContext-&gt;Irp-&gt;IoStatus.Information = Information;
02252 
02253     <span class="comment">//</span>
02254     <span class="comment">//  Point to the section object pointer in the non-paged Fcb.</span>
02255     <span class="comment">//</span>
02256 
02257     IrpSp-&gt;<a class="code" href="../../d2/d5/struct__IO__STACK__LOCATION.html#o28">FileObject</a>-&gt;<a class="code" href="../../d9/d1/struct__FILE__OBJECT.html#o6">SectionObjectPointer</a> = &amp;Fcb-&gt;FcbNonpaged-&gt;SegmentObject;
02258     <span class="keywordflow">return</span> OplockStatus;
02259 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a2" doxytag="udfs/create.c::UdfNormalizeFileNames" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS UdfNormalizeFileNames           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d7/d5/struct__VCB.html">PVCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Vcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>OpenByFileId</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>IgnoreCase</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d3/d8/udfprocs_8h.html#a109">TYPE_OF_OPEN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>RelatedTypeOfOpen</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d9/struct__CCB.html">PCCB</a> RelatedCcb&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN PUNICODE_STRING RelatedFileName&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>FileName</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT PUNICODE_STRING&nbsp;</td>
          <td class="mdname" nowrap> <em>RemainingName</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d7/udfs_2create_8c-source.html#l00809">809</a> of file <a class="el" href="../../d4/d7/udfs_2create_8c-source.html">udfs/create.c</a>.
<p>
References <a class="el" href="../../d3/d6/notify_8c-source.html#l00236">Add2Ptr</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01130">CCB_FLAG_OPEN_BY_ID</a>, <a class="el" href="../../d7/d2/cmwraper_8c-source.html#l00304">ExFreePool()</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00746">FILE_ID</a>, <a class="el" href="../../d3/d1/rtload_8c-source.html#l00047">FileName</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d2/d7/fsrtl_8h-source.html#l01101">FsRtlAllocatePoolWithTag</a>, <a class="el" href="../../d5/d4/name_8c-source.html#l00229">FsRtlDoesNameContainWildCards()</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01248">IRP_CONTEXT_FLAG_FULL_NAME</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01249">IRP_CONTEXT_FLAG_TRAIL_BACKSLASH</a>, <a class="el" href="../../d3/d9/aw_8h-source.html#l00031">L</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00505">SetFlag</a>, <a class="el" href="../../d2/d6/udfs_2nodetype_8h-source.html#l00165">TAG_FILE_NAME</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00443">UdfPagedPool</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01131">UdfUpcaseName()</a>, <a class="el" href="../../d3/d8/udfprocs_8h.html#a263a113">UnopenedFileObject</a>, <a class="el" href="../../d3/d8/udfprocs_8h.html#a263a116">UserDirectoryOpen</a>, <a class="el" href="../../d3/d8/udfprocs_8h.html#a263a117">UserFileOpen</a>, <a class="el" href="../../d3/d8/udfprocs_8h.html#a263a115">UserVolumeOpen</a>, and <a class="el" href="../../d5/d4/aug98_2dll32_2icc__i386_8h-source.html#l00064">USHORT</a>.
<p>
Referenced by <a class="el" href="../../d4/d7/udfs_2create_8c-source.html#l00108">UdfCommonCreate()</a>.
<p>
<pre class="fragment"><div>00823                    :
00824 
00825     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called to store <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> full name and upcased name into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
00826     filename buffer.  We <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> <a class="code" href="../../d7/d6/nlsboot_8c.html#a0">upcase</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> portion yet to parse.  We also
00827     check <span class="keywordflow">for</span> a trailing backslash and lead-in <span class="keywordtype">double</span> backslashes.  This
00828     routine also verifies <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> mode of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> related open against <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name
00829     currently in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> filename.
00830 
00831 Arguments:
00832 
00833     Vcb - Vcb <span class="keywordflow">for</span> <span class="keyword">this</span> volume.
00834 
00835     OpenByFileId - Indicates <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> filename should be a 64 bit FileId.
00836 
00837     IgnoreCase - Indicates <span class="keywordflow">if</span> <span class="keyword">this</span> open <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> a <span class="keywordflow">case</span>-insensitive operation.
00838 
00839     RelatedTypeOfOpen - Indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d3/d5/i386_2trapc_8c.html#a9">type</a> of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> related <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object.
00840 
00841     RelatedCcb - Ccb <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> related open.  Ignored <span class="keywordflow">if</span> no relative open.
00842 
00843     RelatedFileName - <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a> buffer <span class="keywordflow">for</span> related open.  Ignored <span class="keywordflow">if</span> no
00844         relative open.
00845 
00846     <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a> - <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a> to update in <span class="keyword">this</span> routine.  The name should
00847         either be a 64-bit FileId or a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a96">Unicode</a> string.
00848 
00849     RemainingName - <a class="code" href="../../d8/d0/geninst_8c.html#a20">Name</a> with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> remaining portion of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name.  This
00850         will begin after <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> related name and any separator.  For a
00851         non-relative open we also step over <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> initial separator.
00852 
00853 Return Value:
00854 
00855     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - STATUS_SUCCESS <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> names are OK, appropriate error code
00856         otherwise.
00857 
00858 --*/
00859 
00860 {
00861     ULONG RemainingNameLength;
00862     ULONG RelatedNameLength = 0;
00863     ULONG SeparatorLength = 0;
00864 
00865     ULONG BufferLength;
00866 
00867     UNICODE_STRING NewFileName;
00868 
00869     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00870 
00871     <span class="comment">//</span>
00872     <span class="comment">//  If this is the first pass then we need to build the full name and</span>
00873     <span class="comment">//  check for name compatibility.</span>
00874     <span class="comment">//</span>
00875 
00876     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpContext-&gt;Flags, IRP_CONTEXT_FLAG_FULL_NAME )) {
00877 
00878         <span class="comment">//</span>
00879         <span class="comment">//  Deal with the regular file name case first.</span>
00880         <span class="comment">//</span>
00881 
00882         <span class="keywordflow">if</span> (!OpenByFileId) {
00883 
00884             <span class="comment">//</span>
00885             <span class="comment">//  Here is the  "M A R K   L U C O V S K Y"  hack.</span>
00886             <span class="comment">//</span>
00887             <span class="comment">//  It's here because Mark says he can't avoid sending me double beginning</span>
00888             <span class="comment">//  backslashes via the Win32 layer.</span>
00889             <span class="comment">//</span>
00890 
00891             <span class="keywordflow">if</span> ((<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Length &gt; <span class="keyword">sizeof</span>( WCHAR )) &amp;&amp;
00892                 (<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Buffer[1] == <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\\'</span>) &amp;&amp;
00893                 (<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Buffer[0] == <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\\'</span>)) {
00894 
00895                 <span class="comment">//</span>
00896                 <span class="comment">//  If there are still two beginning backslashes, the name is bogus.</span>
00897                 <span class="comment">//</span>
00898 
00899                 <span class="keywordflow">if</span> ((<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Length &gt; 2 * <span class="keyword">sizeof</span>( WCHAR )) &amp;&amp;
00900                     (<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Buffer[2] == <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\\'</span>)) {
00901 
00902                     <span class="keywordflow">return</span> STATUS_OBJECT_NAME_INVALID;
00903                 }
00904 
00905                 <span class="comment">//</span>
00906                 <span class="comment">//  Slide the name down in the buffer.</span>
00907                 <span class="comment">//</span>
00908 
00909                 RtlMoveMemory( <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Buffer,
00910                                <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Buffer + 1,
00911                                <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Length );
00912 
00913                 <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Length -= <span class="keyword">sizeof</span>( WCHAR );
00914             }
00915 
00916             <span class="comment">//</span>
00917             <span class="comment">//  Check for a trailing backslash.  Don't strip off if only character</span>
00918             <span class="comment">//  in the full name or for relative opens where this is illegal.</span>
00919             <span class="comment">//</span>
00920 
00921             <span class="keywordflow">if</span> (((<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Length &gt; <span class="keyword">sizeof</span>( WCHAR)) ||
00922                  ((<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Length == <span class="keyword">sizeof</span>( WCHAR )) &amp;&amp; (RelatedTypeOfOpen == <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a116">UserDirectoryOpen</a>))) &amp;&amp;
00923                 (<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Buffer[ (<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Length/2) - 1 ] == <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\\'</span>)) {
00924 
00925                 <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( IrpContext-&gt;Flags, IRP_CONTEXT_FLAG_TRAIL_BACKSLASH );
00926                 <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Length -= <span class="keyword">sizeof</span>( WCHAR );
00927             }
00928 
00929             <span class="comment">//</span>
00930             <span class="comment">//  Remember the length we need for this portion of the name.</span>
00931             <span class="comment">//</span>
00932 
00933             RemainingNameLength = <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Length;
00934 
00935             <span class="comment">//</span>
00936             <span class="comment">//  If this is a related file object then we verify the compatibility</span>
00937             <span class="comment">//  of the name in the file object with the relative file object.</span>
00938             <span class="comment">//</span>
00939 
00940             <span class="keywordflow">if</span> (RelatedTypeOfOpen != <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a113">UnopenedFileObject</a>) {
00941 
00942                 <span class="comment">//</span>
00943                 <span class="comment">//  If the filename length was zero then it must be legal.</span>
00944                 <span class="comment">//  If there are characters then check with the related</span>
00945                 <span class="comment">//  type of open.</span>
00946                 <span class="comment">//</span>
00947 
00948                 <span class="keywordflow">if</span> (<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Length != 0) {
00949 
00950                     <span class="comment">//</span>
00951                     <span class="comment">//  The name length must always be zero for a volume open.</span>
00952                     <span class="comment">//</span>
00953 
00954                     <span class="keywordflow">if</span> (RelatedTypeOfOpen &lt;= <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a115">UserVolumeOpen</a>) {
00955 
00956                         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00957 
00958                     <span class="comment">//</span>
00959                     <span class="comment">//  The remaining name cannot begin with a backslash.</span>
00960                     <span class="comment">//</span>
00961 
00962                     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Buffer[0] == <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\\'</span> ) {
00963 
00964                         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00965 
00966                     <span class="comment">//</span>
00967                     <span class="comment">//  If the related file is a user file then there</span>
00968                     <span class="comment">//  is no file with this path.</span>
00969                     <span class="comment">//</span>
00970 
00971                     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (RelatedTypeOfOpen == <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a117">UserFileOpen</a>) {
00972 
00973                         <span class="keywordflow">return</span> STATUS_OBJECT_PATH_NOT_FOUND;
00974                     }
00975                 }
00976 
00977                 <span class="comment">//</span>
00978                 <span class="comment">//  Remember the length of the related name when building</span>
00979                 <span class="comment">//  the full name.  We leave the RelatedNameLength and</span>
00980                 <span class="comment">//  SeparatorLength at zero if the relative file is opened</span>
00981                 <span class="comment">//  by Id.</span>
00982                 <span class="comment">//</span>
00983 
00984                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( RelatedCcb-&gt;Flags, CCB_FLAG_OPEN_BY_ID )) {
00985 
00986                     <span class="comment">//</span>
00987                     <span class="comment">//  Add a separator if the name length is non-zero</span>
00988                     <span class="comment">//  unless the relative Fcb is at the root.</span>
00989                     <span class="comment">//</span>
00990 
00991                     <span class="keywordflow">if</span> ((<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Length != 0) &amp;&amp;
00992                         (RelatedCcb-&gt;Fcb != Vcb-&gt;RootIndexFcb)) {
00993 
00994                         SeparatorLength = <span class="keyword">sizeof</span>( WCHAR );
00995                     }
00996 
00997                     RelatedNameLength = RelatedFileName-&gt;Length;
00998                 }
00999 
01000             <span class="comment">//</span>
01001             <span class="comment">//  The full name is already in the filename.  It must either</span>
01002             <span class="comment">//  be length 0 or begin with a backslash.</span>
01003             <span class="comment">//</span>
01004 
01005             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Length != 0) {
01006 
01007                 <span class="keywordflow">if</span> (<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Buffer[0] != <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\\'</span>) {
01008 
01009                     <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
01010                 }
01011 
01012                 <span class="comment">//</span>
01013                 <span class="comment">//  We will want to trim the leading backslash from the</span>
01014                 <span class="comment">//  remaining name we return.</span>
01015                 <span class="comment">//</span>
01016 
01017                 RemainingNameLength -= <span class="keyword">sizeof</span>( WCHAR );
01018                 SeparatorLength = <span class="keyword">sizeof</span>( WCHAR );
01019             }
01020 
01021             <span class="comment">//</span>
01022             <span class="comment">//  Now see if the buffer is large enough to hold the full name.</span>
01023             <span class="comment">//</span>
01024 
01025             BufferLength = RelatedNameLength + SeparatorLength + RemainingNameLength;
01026 
01027             <span class="comment">//</span>
01028             <span class="comment">//  Check for an overflow of the maximum filename size.</span>
01029             <span class="comment">//</span>
01030             
01031             <span class="keywordflow">if</span> (BufferLength &gt; MAXUSHORT) {
01032 
01033                 <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
01034             }
01035 
01036             <span class="comment">//</span>
01037             <span class="comment">//  Now see if we need to allocate a new buffer.</span>
01038             <span class="comment">//</span>
01039 
01040             <span class="keywordflow">if</span> (<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;MaximumLength &lt; BufferLength) {
01041 
01042                 NewFileName.Buffer = <a class="code" href="../../d1/d8/fsrtl_8h.html#a37">FsRtlAllocatePoolWithTag</a>( UdfPagedPool,
01043                                                                BufferLength,
01044                                                                TAG_FILE_NAME );
01045 
01046                 NewFileName.MaximumLength = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) BufferLength;
01047 
01048             } <span class="keywordflow">else</span> {
01049 
01050                 NewFileName.Buffer = <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Buffer;
01051                 NewFileName.MaximumLength = <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;MaximumLength;
01052             }
01053 
01054             <span class="comment">//</span>
01055             <span class="comment">//  If there is a related name then we need to slide the remaining bytes up and</span>
01056             <span class="comment">//  insert the related name.  Otherwise the name is in the correct position</span>
01057             <span class="comment">//  already.</span>
01058             <span class="comment">//</span>
01059 
01060             <span class="keywordflow">if</span> (RelatedNameLength != 0) {
01061 
01062                 <span class="comment">//</span>
01063                 <span class="comment">//  Store the remaining name in its correct position.</span>
01064                 <span class="comment">//</span>
01065 
01066                 <span class="keywordflow">if</span> (RemainingNameLength != 0) {
01067 
01068                     RtlMoveMemory( <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( NewFileName.Buffer, RelatedNameLength + SeparatorLength, PVOID ),
01069                                    <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Buffer,
01070                                    RemainingNameLength );
01071                 }
01072 
01073                 RtlCopyMemory( NewFileName.Buffer,
01074                                RelatedFileName-&gt;Buffer,
01075                                RelatedNameLength );
01076 
01077                 <span class="comment">//</span>
01078                 <span class="comment">//  Add the separator if needed.</span>
01079                 <span class="comment">//</span>
01080 
01081                 <span class="keywordflow">if</span> (SeparatorLength != 0) {
01082 
01083                     *(<a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( NewFileName.Buffer, RelatedNameLength, PWCHAR )) = <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\\'</span>;
01084                 }
01085 
01086                 <span class="comment">//</span>
01087                 <span class="comment">//  Update the filename value we got from the user.</span>
01088                 <span class="comment">//</span>
01089 
01090                 <span class="keywordflow">if</span> (NewFileName.Buffer != <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Buffer) {
01091 
01092                     <span class="keywordflow">if</span> (<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Buffer != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01093 
01094                         <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a>( <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Buffer );
01095                     }
01096 
01097                     <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Buffer = NewFileName.Buffer;
01098                     <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;MaximumLength = NewFileName.MaximumLength;
01099                 }
01100 
01101                 <span class="comment">//</span>
01102                 <span class="comment">//  Copy the name length to the user's filename.</span>
01103                 <span class="comment">//</span>
01104 
01105                 <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) (RelatedNameLength + SeparatorLength + RemainingNameLength);
01106             }
01107 
01108             <span class="comment">//</span>
01109             <span class="comment">//  Now update the remaining name to parse.</span>
01110             <span class="comment">//</span>
01111 
01112             RemainingName-&gt;MaximumLength =
01113             RemainingName-&gt;Length = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) RemainingNameLength;
01114 
01115             RemainingName-&gt;Buffer = <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( <a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Buffer,
01116                                              RelatedNameLength + SeparatorLength,
01117                                              PWCHAR );
01118 
01119             <span class="comment">//</span>
01120             <span class="comment">//  Upcase the name if necessary.</span>
01121             <span class="comment">//</span>
01122 
01123             <span class="keywordflow">if</span> (IgnoreCase &amp;&amp; (RemainingNameLength != 0)) {
01124 
01125                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a186">UdfUpcaseName</a>( IrpContext,
01126                                RemainingName,
01127                                RemainingName );
01128             }
01129 
01130             <span class="comment">//</span>
01131             <span class="comment">//  Do a quick check to make sure there are no wildcards.</span>
01132             <span class="comment">//</span>
01133 
01134             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d8/fsrtl_8h.html#a177">FsRtlDoesNameContainWildCards</a>( RemainingName )) {
01135 
01136                 <span class="keywordflow">return</span> STATUS_OBJECT_NAME_INVALID;
01137             }
01138 
01139         <span class="comment">//</span>
01140         <span class="comment">//  For the open by file Id case we verify the name really contains</span>
01141         <span class="comment">//  a 64 bit value.</span>
01142         <span class="comment">//</span>
01143 
01144         } <span class="keywordflow">else</span> {
01145 
01146             <span class="comment">//</span>
01147             <span class="comment">//  Check for validity of the buffer.</span>
01148             <span class="comment">//</span>
01149 
01150             <span class="keywordflow">if</span> (<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>-&gt;Length != <span class="keyword">sizeof</span>( <a class="code" href="../../d6/d8/udfstruc_8h.html#a77">FILE_ID</a> )) {
01151 
01152                 <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
01153             }
01154         }
01155 
01156         <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( IrpContext-&gt;Flags, IRP_CONTEXT_FLAG_FULL_NAME );
01157 
01158     <span class="comment">//</span>
01159     <span class="comment">//  If we are in the retry path then the full name is already in the</span>
01160     <span class="comment">//  file object name.  If this is a case-sensitive operation then</span>
01161     <span class="comment">//  we need to upcase the name from the end of any related file name already stored</span>
01162     <span class="comment">//  there.</span>
01163     <span class="comment">//</span>
01164 
01165     } <span class="keywordflow">else</span> {
01166 
01167         <span class="comment">//</span>
01168         <span class="comment">//  Assume there is no relative name.</span>
01169         <span class="comment">//</span>
01170 
01171         *RemainingName = *<a class="code" href="../../d2/d2/rtload_8c.html#a3">FileName</a>;
01172 
01173         <span class="comment">//</span>
01174         <span class="comment">//  Nothing to do if the name length is zero.</span>
01175         <span class="comment">//</span>
01176 
01177         <span class="keywordflow">if</span> (RemainingName-&gt;Length != 0) {
01178 
01179             <span class="comment">//</span>
01180             <span class="comment">//  If there is a relative name then we need to walk past it.</span>
01181             <span class="comment">//</span>
01182 
01183             <span class="keywordflow">if</span> (RelatedTypeOfOpen != <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a113">UnopenedFileObject</a>) {
01184 
01185                 <span class="comment">//</span>
01186                 <span class="comment">//  Nothing to walk past if the RelatedCcb is opened by FileId.</span>
01187                 <span class="comment">//</span>
01188 
01189 
01190                 <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( RelatedCcb-&gt;Flags, CCB_FLAG_OPEN_BY_ID )) {
01191 
01192                     <span class="comment">//</span>
01193                     <span class="comment">//  Related file name is a proper prefix of the full name.</span>
01194                     <span class="comment">//  We step over the related name and if we are then</span>
01195                     <span class="comment">//  pointing at a separator character we step over that.</span>
01196                     <span class="comment">//</span>
01197 
01198                     RemainingName-&gt;Buffer = <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( RemainingName-&gt;Buffer,
01199                                                      RelatedFileName-&gt;Length,
01200                                                      PWCHAR );
01201 
01202                     RemainingName-&gt;Length -= RelatedFileName-&gt;Length;
01203                 }
01204             }
01205 
01206             <span class="comment">//</span>
01207             <span class="comment">//  If we are pointing at a separator character then step past that.</span>
01208             <span class="comment">//</span>
01209 
01210             <span class="keywordflow">if</span> (RemainingName-&gt;Length != 0) {
01211 
01212                 <span class="keywordflow">if</span> (*(RemainingName-&gt;Buffer) == <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="charliteral">'\\'</span>) {
01213 
01214                     RemainingName-&gt;Buffer = <a class="code" href="../../d2/d7/notify_8c.html#a7">Add2Ptr</a>( RemainingName-&gt;Buffer,
01215                                                      <span class="keyword">sizeof</span>( WCHAR ),
01216                                                      PWCHAR );
01217 
01218                     RemainingName-&gt;Length -= <span class="keyword">sizeof</span>( WCHAR );
01219                 }
01220             }
01221         }
01222 
01223         <span class="comment">//</span>
01224         <span class="comment">//  Upcase the name if necessary.</span>
01225         <span class="comment">//</span>
01226 
01227         <span class="keywordflow">if</span> (IgnoreCase &amp;&amp; (RemainingName-&gt;Length != 0)) {
01228 
01229             <a class="code" href="../../d3/d8/udfprocs_8h.html#a186">UdfUpcaseName</a>( IrpContext,
01230                            RemainingName,
01231                            RemainingName );
01232         }
01233     }
01234 
01235     <span class="keywordflow">return</span> STATUS_SUCCESS;
01236 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a3" doxytag="udfs/create.c::UdfOpenExistingFcb" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS UdfOpenExistingFcb           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpSp</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT <a class="el" href="../../d7/d9/struct__FCB.html">PFCB</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>CurrentFcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d5/d9/struct__LCB.html">PLCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>OpenLcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d3/d8/udfprocs_8h.html#a109">TYPE_OF_OPEN</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>TypeOfOpen</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>IgnoreCase</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d9/struct__CCB.html">PCCB</a> RelatedCcb&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d7/udfs_2create_8c-source.html#l01522">1522</a> of file <a class="el" href="../../d4/d7/udfs_2create_8c-source.html">udfs/create.c</a>.
<p>
References <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00367">ASSERT_EXCLUSIVE_FCB</a>, <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00352">ASSERT_IRP_CONTEXT</a>, <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00347">ASSERT_OPTIONAL_CCB</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01132">CCB_FLAG_IGNORE_CASE</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01130">CCB_FLAG_OPEN_BY_ID</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01131">CCB_FLAG_OPEN_RELATIVE_BY_ID</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00505">SetFlag</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d4/d7/udfs_2create_8c-source.html#l01955">UdfCompleteFcbOpen()</a>, and <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00675">UdfIllegalFcbAccess()</a>.
<p>
Referenced by <a class="el" href="../../d4/d7/udfs_2create_8c-source.html#l00108">UdfCommonCreate()</a>.
<p>
<pre class="fragment"><div>01534                    :
01535 
01536     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called to open an Fcb which <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> already in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Fcb table.
01537     We will verify <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> access to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> and then call our worker routine
01538     to perform <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">final</span> operations.
01539 
01540 Arguments:
01541 
01542     IrpSp - Pointer to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> stack location <span class="keywordflow">for</span> <span class="keyword">this</span> open.
01543 
01544     CurrentFcb - Address of Fcb to open.  We will clear <span class="keyword">this</span> <span class="keywordflow">if</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Fcb
01545         <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> released here.
01546         
01547     OpenLcb - Lcb used to find <span class="keyword">this</span> Fcb.
01548 
01549     TypeOfOpen - Indicates whether we are opening a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>, directory or volume.
01550 
01551     IgnoreCase - Indicates <span class="keywordflow">if</span> <span class="keyword">this</span> open <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <span class="keywordflow">case</span>-insensitive.
01552 
01553     RelatedCcb - Ccb <span class="keywordflow">for</span> related <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object <span class="keywordflow">if</span> relative open.  We use
01554         <span class="keyword">this</span> when setting <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Ccb flags <span class="keywordflow">for</span> <span class="keyword">this</span> open.  It will tell
01555         us whether <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> name currently in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> relative or
01556         absolute.
01557 
01558 Return Value:
01559 
01560     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> indicating <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> result of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation.
01561 
01562 --*/
01563 
01564 {
01565     ULONG CcbFlags = 0;
01566 
01567     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_ACCESS_DENIED;
01568 
01569     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01570 
01571     <span class="comment">//</span>
01572     <span class="comment">//  Check inputs.</span>
01573     <span class="comment">//</span>
01574 
01575     <a class="code" href="../../d1/d8/udfdata_8h.html#a28">ASSERT_IRP_CONTEXT</a>( IrpContext );
01576     <a class="code" href="../../d1/d8/udfdata_8h.html#a43">ASSERT_EXCLUSIVE_FCB</a>( *CurrentFcb );
01577     <a class="code" href="../../d1/d8/udfdata_8h.html#a23">ASSERT_OPTIONAL_CCB</a>( RelatedCcb );
01578 
01579     <span class="comment">//</span>
01580     <span class="comment">//  Check that the desired access is legal.</span>
01581     <span class="comment">//</span>
01582 
01583     <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d8/udfprocs_8h.html#a145">UdfIllegalFcbAccess</a>( IrpContext,
01584                               TypeOfOpen,
01585                               IrpSp-&gt;Parameters.Create.SecurityContext-&gt;DesiredAccess )) {
01586 
01587         <span class="comment">//</span>
01588         <span class="comment">//  Set the Ignore case.</span>
01589         <span class="comment">//</span>
01590 
01591         <span class="keywordflow">if</span> (IgnoreCase) {
01592 
01593             <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( CcbFlags, CCB_FLAG_IGNORE_CASE );
01594         }
01595 
01596         <span class="comment">//</span>
01597         <span class="comment">//  Check the related Ccb to see if this was an OpenByFileId and</span>
01598         <span class="comment">//  whether there was a version.</span>
01599         <span class="comment">//</span>
01600 
01601         <span class="keywordflow">if</span> (ARGUMENT_PRESENT( RelatedCcb )) {
01602 
01603             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( RelatedCcb-&gt;Flags, CCB_FLAG_OPEN_BY_ID | CCB_FLAG_OPEN_RELATIVE_BY_ID )) {
01604 
01605                 <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( CcbFlags, CCB_FLAG_OPEN_RELATIVE_BY_ID );
01606             }
01607         }
01608 
01609         <span class="comment">//</span>
01610         <span class="comment">//  Call our worker routine to complete the open.</span>
01611         <span class="comment">//</span>
01612 
01613         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d8/udfs_2create_8c.html#a6">UdfCompleteFcbOpen</a>( IrpContext,
01614                                      IrpSp,
01615                                      (*CurrentFcb)-&gt;Vcb,
01616                                      CurrentFcb,
01617                                      OpenLcb,
01618                                      TypeOfOpen,
01619                                      CcbFlags,
01620                                      IrpSp-&gt;Parameters.Create.SecurityContext-&gt;DesiredAccess );
01621     }
01622 
01623     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01624 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a4" doxytag="udfs/create.c::UdfOpenObjectByFileId" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS UdfOpenObjectByFileId           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpSp</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d7/d5/struct__VCB.html">PVCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Vcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT <a class="el" href="../../d7/d9/struct__FCB.html">PFCB</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>CurrentFcb</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d7/udfs_2create_8c-source.html#l01244">1244</a> of file <a class="el" href="../../d4/d7/udfs_2create_8c-source.html">udfs/create.c</a>.
<p>
References <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00352">ASSERT_IRP_CONTEXT</a>, <a class="el" href="../../d2/d7/udfdata_8h-source.html#l00336">ASSERT_VCB</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01130">CCB_FLAG_OPEN_BY_ID</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01061">FCB_STATE_INITIALIZED</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00979">_FCB::FcbReference</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00986">_FCB::FcbState</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00746">FILE_ID</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00992">_FCB::FileAttributes</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00967">_FCB::FileId</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d6/d8/udfstruc_8h.html#a104">ICB_SEARCH_CONTEXT</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01235">IRP_CONTEXT_FLAG_WAIT</a>, <a class="el" href="../../d1/d6/lfs_2nodetype_8h-source.html#l00027">NODE_TYPE_CODE</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00436">try_leave</a>, <a class="el" href="../../d3/d8/udfprocs_8h.html#a109">TYPE_OF_OPEN</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01542">UdfAcquireFcbExclusive</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l03183">UdfCleanupIcbContext()</a>, <a class="el" href="../../d4/d7/udfs_2create_8c-source.html#l01955">UdfCompleteFcbOpen()</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l02041">UdfCreateFcb()</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l02178">UdfDeleteFcb()</a>, <a class="el" href="../../d1/d7/udfdata_8c-source.html#l00448">UdfExceptionFilter()</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01462">UdfGetFidReservedZero</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00675">UdfIllegalFcbAccess()</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l02297">UdfInitializeFcbFromIcbContext()</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l02951">UdfInitializeIcbContextFromFcb()</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01468">UdfIsFidDirectory</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01559">UdfLockVcb</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l03124">UdfLookupActiveIcb()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00406">UdfRaiseStatus()</a>, <a class="el" href="../../d2/d6/udfs_2nodetype_8h-source.html#l00038">UDFS_NTC_FCB_DATA</a>, <a class="el" href="../../d2/d6/udfs_2nodetype_8h-source.html#l00037">UDFS_NTC_FCB_INDEX</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01563">UdfUnlockVcb</a>, <a class="el" href="../../d3/d8/udfprocs_8h.html#a263a116">UserDirectoryOpen</a>, and <a class="el" href="../../d3/d8/udfprocs_8h.html#a263a117">UserFileOpen</a>.
<p>
Referenced by <a class="el" href="../../d4/d7/udfs_2create_8c-source.html#l00108">UdfCommonCreate()</a>.
<p>
<pre class="fragment"><div>01253                    :
01254 
01255     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called to open a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> FileId.  The <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> Id <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> in
01256     <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> FileObject name buffer and has been verified to be 64 bits.
01257 
01258     We extract <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Id number and then check to see whether we are opening a
01259     <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> or directory and compare that with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> create options.  If <span class="keyword">this</span>
01260     generates no error then optimistically look up <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Fcb in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Fcb Table.
01261 
01262     If we don'<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> find <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Fcb then we take what <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> effectively a wild-a** guess.
01263     Since we would need more than 64bits to contain <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> root extent length along
01264     with <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> partition, lbn and <a class="code" href="../../d7/d4/conexts_8c.html#a29">dir</a>/<a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> flag we have to speculate that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01265     opener knows what they are doing and <span class="keywordflow">try</span> to crack an ICB hierarchy at <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01266     specified location.  This can fail <span class="keywordflow">for</span> any number of reasons, which then have
01267     to be mapped to an open <a class="code" href="../../d8/d0/rtbatcr_8c.html#a1">failure</a>.
01268     
01269     If found then build <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Fcb from <span class="keyword">this</span> entry and store <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> Fcb in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01270     tree.
01271 
01272     Finally we call our worker routine to complete <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> open on <span class="keyword">this</span> Fcb.
01273 
01274 Arguments:
01275 
01276     IrpSp - Stack location within <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> create <a class="code" href="../../d0/d6/iop_8h.html#a35">Irp</a>.
01277 
01278     Vcb - Vcb <span class="keywordflow">for</span> <span class="keyword">this</span> volume.
01279 
01280     CurrentFcb - Address to store <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Fcb <span class="keywordflow">for</span> <span class="keyword">this</span> open.  We <a class="code" href="../../d3/d0/imm32_8def.html#a1">only</a> store <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a>
01281         CurrentFcb here when we have acquired <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> so our caller knows to
01282         free or deallocate <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a>.
01283 
01284 Return Value:
01285 
01286     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> indicating <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> result of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation.
01287 
01288 --*/
01289 
01290 {
01291     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_ACCESS_DENIED;
01292 
01293     BOOLEAN UnlockVcb = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01294     BOOLEAN Found;
01295     BOOLEAN FcbExisted;
01296 
01297     <a class="code" href="../../d9/d9/struct__ICB__SEARCH__CONTEXT.html">ICB_SEARCH_CONTEXT</a> IcbContext;
01298     BOOLEAN CleanupIcbContext = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01299 
01300     <a class="code" href="../../d0/d7/lfs_2nodetype_8h.html#a7">NODE_TYPE_CODE</a> NodeTypeCode;
01301     <a class="code" href="../../d3/d8/udfprocs_8h.html#a109">TYPE_OF_OPEN</a> TypeOfOpen;
01302 
01303     <a class="code" href="../../d6/d8/udfstruc_8h.html#a77">FILE_ID</a> FileId;
01304 
01305     <a class="code" href="../../d7/d9/struct__FCB.html">PFCB</a> NextFcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01306 
01307     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01308 
01309     <span class="comment">//</span>
01310     <span class="comment">//  Check inputs.</span>
01311     <span class="comment">//</span>
01312 
01313     <a class="code" href="../../d1/d8/udfdata_8h.html#a28">ASSERT_IRP_CONTEXT</a>( IrpContext );
01314     <a class="code" href="../../d1/d8/udfdata_8h.html#a12">ASSERT_VCB</a>( Vcb );
01315 
01316     <span class="comment">//</span>
01317     <span class="comment">//  Extract the FileId from the FileObject.</span>
01318     <span class="comment">//</span>
01319 
01320     RtlCopyMemory( &amp;FileId, IrpSp-&gt;FileObject-&gt;FileName.Buffer, <span class="keyword">sizeof</span>( FILE_ID ));
01321 
01322     <span class="comment">//</span>
01323     <span class="comment">//  Now do a quick check that the reserved, unused chunk of the fileid is</span>
01324     <span class="comment">//  unused in this specimen.</span>
01325     <span class="comment">//</span>
01326 
01327     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d8/udfstruc_8h.html#a47">UdfGetFidReservedZero</a>( FileId )) {
01328 
01329         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
01330     }
01331 
01332     <span class="comment">//</span>
01333     <span class="comment">//  Go ahead and figure out the TypeOfOpen and NodeType.  We can</span>
01334     <span class="comment">//  get these from the input FileId.</span>
01335     <span class="comment">//</span>
01336 
01337     <span class="keywordflow">if</span> (<a class="code" href="../../d6/d8/udfstruc_8h.html#a51">UdfIsFidDirectory</a>( FileId )) {
01338 
01339         TypeOfOpen = <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a116">UserDirectoryOpen</a>;
01340         NodeTypeCode = <a class="code" href="../../d1/d7/udfs_2nodetype_8h.html#a3">UDFS_NTC_FCB_INDEX</a>;
01341 
01342     } <span class="keywordflow">else</span> {
01343 
01344         TypeOfOpen = <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a117">UserFileOpen</a>;
01345         NodeTypeCode = <a class="code" href="../../d1/d7/udfs_2nodetype_8h.html#a4">UDFS_NTC_FCB_DATA</a>;
01346     }
01347 
01348     <span class="comment">//</span>
01349     <span class="comment">//  Use a try-finally to facilitate cleanup.</span>
01350     <span class="comment">//</span>
01351 
01352     <span class="keywordflow">try</span> {
01353 
01354         <span class="comment">//</span>
01355         <span class="comment">//  Acquire the Vcb and check if there is already an Fcb.</span>
01356         <span class="comment">//  If not we will need to carefully hunt for the on-disc</span>
01357         <span class="comment">//  structures.</span>
01358         <span class="comment">//</span>
01359         <span class="comment">//  We will post the request if we don't find the Fcb and this</span>
01360         <span class="comment">//  request can't wait.</span>
01361         <span class="comment">//</span>
01362 
01363         <a class="code" href="../../d3/d8/udfprocs_8h.html#a88">UdfLockVcb</a>( IrpContext, Vcb );
01364         UnlockVcb = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01365 
01366         NextFcb = <a class="code" href="../../d3/d8/udfprocs_8h.html#a213">UdfCreateFcb</a>( IrpContext, FileId, NodeTypeCode, &amp;FcbExisted );
01367 
01368         <span class="comment">//</span>
01369         <span class="comment">//  Now, if the Fcb was not already here we have some work to do.</span>
01370         <span class="comment">//</span>
01371         
01372         <span class="keywordflow">if</span> (!FcbExisted) {
01373 
01374             <span class="comment">//</span>
01375             <span class="comment">//  If we can't wait then post this request.</span>
01376             <span class="comment">//</span>
01377     
01378             <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpContext-&gt;Flags, IRP_CONTEXT_FLAG_WAIT )) {
01379     
01380                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a122">UdfRaiseStatus</a>( IrpContext, STATUS_CANT_WAIT );
01381             }
01382     
01383             <span class="comment">//</span>
01384             <span class="comment">//  Use a try-finally to transform errors we get as a result of going</span>
01385             <span class="comment">//  off on a wild goose chase into a simple open failure.</span>
01386             <span class="comment">//</span>
01387             
01388             <span class="keywordflow">try</span> {
01389 
01390                 NextFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o6">FileId</a> = FileId;
01391                 
01392                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a220">UdfInitializeIcbContextFromFcb</a>( IrpContext, &amp;IcbContext, NextFcb );
01393                 CleanupIcbContext = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01394     
01395                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a223">UdfLookupActiveIcb</a>( IrpContext, &amp;IcbContext );
01396                 
01397                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a215">UdfInitializeFcbFromIcbContext</a>( IrpContext,
01398                                                 NextFcb,
01399                                                 &amp;IcbContext );
01400     
01401                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a224">UdfCleanupIcbContext</a>( IrpContext, &amp;IcbContext );
01402                 CleanupIcbContext = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01403 
01404             } except( <a class="code" href="../../d3/d8/udfprocs_8h.html#a127">UdfExceptionFilter</a>( IrpContext, GetExceptionInformation() )) {
01405 
01406                 <span class="comment">//</span>
01407                 <span class="comment">//   Any error we receive is an indication that the given fileid is</span>
01408                 <span class="comment">//   not valid.</span>
01409                 <span class="comment">//</span>
01410 
01411                 <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_INVALID_PARAMETER;
01412             }
01413 
01414             <span class="comment">//</span>
01415             <span class="comment">//  Do a little dance to leave the exception handler if we had problems.</span>
01416             <span class="comment">//</span>
01417             
01418             <span class="keywordflow">if</span> (<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> == STATUS_INVALID_PARAMETER) {
01419 
01420                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( NOTHING );
01421             }
01422         }
01423         
01424         <span class="comment">//</span>
01425         <span class="comment">//  We have the Fcb.  Check that the type of the file is compatible with</span>
01426         <span class="comment">//  the desired type of file to open.</span>
01427         <span class="comment">//</span>
01428 
01429         <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( NextFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o11">FileAttributes</a>, FILE_ATTRIBUTE_DIRECTORY )) {
01430 
01431             <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpSp-&gt;Parameters.Create.Options, FILE_NON_DIRECTORY_FILE )) {
01432 
01433                 <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( Status = STATUS_FILE_IS_A_DIRECTORY );
01434             }
01435 
01436         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( IrpSp-&gt;Parameters.Create.Options, FILE_DIRECTORY_FILE )) {
01437 
01438             <a class="code" href="../../d3/d8/udfprocs_8h.html#a64">try_leave</a>( Status = STATUS_NOT_A_DIRECTORY );
01439         }
01440 
01441         <span class="comment">//</span>
01442         <span class="comment">//  We now know the Fcb and currently hold the Vcb lock.</span>
01443         <span class="comment">//  Try to acquire this Fcb without waiting.  Otherwise we</span>
01444         <span class="comment">//  need to reference it, drop the Vcb, acquire the Fcb, the</span>
01445         <span class="comment">//  Vcb and then dereference the Fcb.</span>
01446         <span class="comment">//</span>
01447 
01448         <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d8/udfprocs_8h.html#a83">UdfAcquireFcbExclusive</a>( IrpContext, NextFcb, TRUE )) {
01449 
01450             NextFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o8">FcbReference</a> += 1;
01451             <a class="code" href="../../d3/d8/udfprocs_8h.html#a89">UdfUnlockVcb</a>( IrpContext, Vcb );
01452 
01453             <a class="code" href="../../d3/d8/udfprocs_8h.html#a83">UdfAcquireFcbExclusive</a>( IrpContext, NextFcb, FALSE );
01454 
01455             <a class="code" href="../../d3/d8/udfprocs_8h.html#a88">UdfLockVcb</a>( IrpContext, Vcb );
01456             NextFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o8">FcbReference</a> -= 1;
01457         }
01458 
01459         <a class="code" href="../../d3/d8/udfprocs_8h.html#a89">UdfUnlockVcb</a>( IrpContext, Vcb );
01460         UnlockVcb = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01461 
01462         <span class="comment">//</span>
01463         <span class="comment">//  Move to this Fcb.</span>
01464         <span class="comment">//</span>
01465 
01466         *CurrentFcb = NextFcb;
01467 
01468         <span class="comment">//</span>
01469         <span class="comment">//  Check the requested access on this Fcb.</span>
01470         <span class="comment">//</span>
01471 
01472         <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d8/udfprocs_8h.html#a145">UdfIllegalFcbAccess</a>( IrpContext,
01473                                   TypeOfOpen,
01474                                   IrpSp-&gt;Parameters.Create.SecurityContext-&gt;DesiredAccess )) {
01475 
01476             <span class="comment">//</span>
01477             <span class="comment">//  Call our worker routine to complete the open.</span>
01478             <span class="comment">//</span>
01479 
01480             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d8/udfs_2create_8c.html#a6">UdfCompleteFcbOpen</a>( IrpContext,
01481                                          IrpSp,
01482                                          Vcb,
01483                                          CurrentFcb,
01484                                          NULL,
01485                                          TypeOfOpen,
01486                                          CCB_FLAG_OPEN_BY_ID,
01487                                          IrpSp-&gt;Parameters.Create.SecurityContext-&gt;DesiredAccess );
01488         }
01489 
01490     } finally {
01491 
01492         <span class="keywordflow">if</span> (UnlockVcb) {
01493 
01494             <a class="code" href="../../d3/d8/udfprocs_8h.html#a89">UdfUnlockVcb</a>( IrpContext, Vcb );
01495         }
01496 
01497         <span class="keywordflow">if</span> (CleanupIcbContext) {
01498 
01499             <a class="code" href="../../d3/d8/udfprocs_8h.html#a224">UdfCleanupIcbContext</a>( IrpContext, &amp;IcbContext );
01500         }
01501         
01502         <span class="comment">//</span>
01503         <span class="comment">//  Destroy the new Fcb if it was not fully initialized.</span>
01504         <span class="comment">//</span>
01505 
01506         <span class="keywordflow">if</span> (NextFcb &amp;&amp; !<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( NextFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o10">FcbState</a>, FCB_STATE_INITIALIZED )) {
01507 
01508             <a class="code" href="../../d3/d8/udfprocs_8h.html#a214">UdfDeleteFcb</a>( IrpContext, NextFcb );
01509         }
01510 
01511     }
01512 
01513     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01514 }

</div></pre>    </td>
  </tr>
</table>
<a class="anchor" name="a5" doxytag="udfs/create.c::UdfOpenObjectFromDirContext" ></a><p>
<table class="mdTable" width="100%" cellpadding="2" cellspacing="0">
  <tr>
    <td class="mdRow">
      <table cellpadding="0" cellspacing="0" border="0">
        <tr>
          <td class="md" nowrap valign="top"> NTSTATUS UdfOpenObjectFromDirContext           </td>
          <td class="md" valign="top">(&nbsp;</td>
          <td class="md" nowrap valign="top">IN <a class="el" href="../../d0/d3/struct__IRP__CONTEXT.html">PIRP_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d5/struct__IO__STACK__LOCATION.html">PIO_STACK_LOCATION</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>IrpSp</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d7/d5/struct__VCB.html">PVCB</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>Vcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN OUT <a class="el" href="../../d7/d9/struct__FCB.html">PFCB</a> *&nbsp;</td>
          <td class="mdname" nowrap> <em>CurrentFcb</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>ShortNameMatch</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>IgnoreCase</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d5/d5/struct__DIR__ENUM__CONTEXT.html">PDIR_ENUM_CONTEXT</a>&nbsp;</td>
          <td class="mdname" nowrap> <em>DirContext</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN BOOLEAN&nbsp;</td>
          <td class="mdname" nowrap> <em>PerformUserOpen</em>, </td>
        </tr>
        <tr>
          <td class="md" nowrap align="right"></td>
          <td></td>
          <td class="md" nowrap>IN <a class="el" href="../../d2/d9/struct__CCB.html">PCCB</a> RelatedCcb&nbsp;</td>
          <td class="mdname" nowrap> <em>OPTIONAL</em></td>
        </tr>
        <tr>
          <td></td>
          <td class="md">)&nbsp;</td>
          <td class="md" colspan="2"></td>
        </tr>
      </table>
    </td>
  </tr>
</table>
<table cellspacing=5 cellpadding=0 border=0>
  <tr>
    <td>
      &nbsp;
    </td>
    <td>

<p>

<p>
Definition at line <a class="el" href="../../d4/d7/udfs_2create_8c-source.html#l01632">1632</a> of file <a class="el" href="../../d4/d7/udfs_2create_8c-source.html">udfs/create.c</a>.
<p>
References <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01132">CCB_FLAG_IGNORE_CASE</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01130">CCB_FLAG_OPEN_BY_ID</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01131">CCB_FLAG_OPEN_RELATIVE_BY_ID</a>, <a class="el" href="../../d0/d5/cdfs__rec_8c-source.html#l00032">Dbg</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l02290">DebugTrace</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00625">FALSE</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01061">FCB_STATE_INITIALIZED</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00979">_FCB::FcbReference</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00986">_FCB::FcbState</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00980">_FCB::FcbUserReference</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00746">FILE_ID</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00497">FlagOn</a>, <a class="el" href="../../d1/d6/lfs_2nodetype_8h-source.html#l00027">NODE_TYPE_CODE</a>, <a class="el" href="../../d1/d6/iso13346_8h-source.html#l00811">NSR_FID_F_DIRECTORY</a>, <a class="el" href="../../d0/d6/iop_8h.html#a144">NTSTATUS()</a>, <a class="el" href="../../d5/d5/lh__open_2pi__basic_8h-source.html#l00023">NULL</a>, <a class="el" href="../../d1/d8/ntosdef_8h-source.html#l00462">PAGED_CODE</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l00961">_FCB::RootExtentLength</a>, <a class="el" href="../../d6/d4/cc_8h-source.html#l00505">SetFlag</a>, <a class="el" href="../../d3/d0/cttoken_8c-source.html#l00135">Status</a>, <a class="el" href="../../d7/d6/halmips_8h-source.html#l00626">TRUE</a>, <a class="el" href="../../d3/d8/udfprocs_8h.html#a109">TYPE_OF_OPEN</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01542">UdfAcquireFcbExclusive</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l03183">UdfCleanupIcbContext()</a>, <a class="el" href="../../d4/d7/udfs_2create_8c-source.html#l01955">UdfCompleteFcbOpen()</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l02041">UdfCreateFcb()</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l02178">UdfDeleteFcb()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l00675">UdfIllegalFcbAccess()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01762">UdfIncrementReferenceCounts</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l02297">UdfInitializeFcbFromIcbContext()</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l02951">UdfInitializeIcbContextFromFcb()</a>, <a class="el" href="../../d6/d3/prefxsup_8c-source.html#l00503">UdfInitializeLcbFromDirContext()</a>, <a class="el" href="../../d6/d3/prefxsup_8c-source.html#l00064">UdfInsertPrefix()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01559">UdfLockVcb</a>, <a class="el" href="../../d0/d7/udfs_2strucsup_8c-source.html#l03124">UdfLookupActiveIcb()</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01548">UdfReleaseFcb</a>, <a class="el" href="../../d2/d6/udfs_2nodetype_8h-source.html#l00038">UDFS_NTC_FCB_DATA</a>, <a class="el" href="../../d2/d6/udfs_2nodetype_8h-source.html#l00037">UDFS_NTC_FCB_INDEX</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01465">UdfSetFidDirectory</a>, <a class="el" href="../../d7/d7/udfstruc_8h-source.html#l01457">UdfSetFidFromLbAddr</a>, <a class="el" href="../../d4/d7/udfprocs_8h-source.html#l01563">UdfUnlockVcb</a>, <a class="el" href="../../d3/d8/udfprocs_8h.html#a263a116">UserDirectoryOpen</a>, and <a class="el" href="../../d3/d8/udfprocs_8h.html#a263a117">UserFileOpen</a>.
<p>
Referenced by <a class="el" href="../../d4/d7/udfs_2create_8c-source.html#l00108">UdfCommonCreate()</a>.
<p>
<pre class="fragment"><div>01646                    :
01647 
01648     This routine <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> called to open an object found in a directory scan.  This
01649     can be a directory or a <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> as indicated in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> scan's results.
01650 
01651     We first check that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> desired access <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> legal <span class="keywordflow">for</span> <span class="keyword">this</span> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a>.  Then we
01652     construct <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> FileId <span class="keywordflow">for</span> <span class="keyword">this</span> and <span class="keywordflow">do</span> a check to see <span class="keywordflow">if</span> <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Fcb
01653     Table.  It <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> always possible that either <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> was created since or simply
01654     wasn'<a class="code" href="../../d4/d1/genmips_8c.html#a17">t</a> in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> prefix table at <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> time of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> prefix table search.
01655     Lookup <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> active ICB, initialize <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Fcb and store into <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> FcbTable
01656     <span class="keywordflow">if</span> not present.
01657 
01658     Next we will add <span class="keyword">this</span> to <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> prefix table of our parent <span class="keywordflow">if</span> needed.
01659 
01660     Once we know that <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keyword">new</span> Fcb has been initialized then we <a class="code" href="../../d7/d4/conexts_8c.html#a1">move</a> our pointer
01661     in <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> tree down to <span class="keyword">this</span> position.
01662 
01663     This routine does not own <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Vcb lock on entry.  We must be sure to release
01664     <a class="code" href="../../d1/d9/icmui_8def.html#a4">it</a> on <a class="code" href="../../d9/d1/fedefs_8h.html#a16">exit</a>.
01665 
01666 Arguments:
01667 
01668     IrpSp - Stack location <span class="keywordflow">for</span> <span class="keyword">this</span> request.
01669 
01670     Vcb - Vcb <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> current volume.
01671 
01672     CurrentFcb - On input <span class="keyword">this</span> <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> parent of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Fcb to open.  On output we
01673         store <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> Fcb <span class="keywordflow">for</span> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> being opened.
01674         
01675     ShortNameMatch - Indicates whether <span class="keyword">this</span> object was opened by <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> shortname.
01676 
01677     IgnoreCase - Indicates <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> <span class="keywordflow">case</span> sensitivity of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> caller.
01678 
01679     DirContext - This <a class="code" href="../../d3/d0/user32_8def.html#a108">is</a> <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> context used to find <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object.
01680     
01681     PerformUserOpen - Indicates <span class="keywordflow">if</span> we are at <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> object <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> user wants to finally open.
01682 
01683     RelatedCcb - RelatedCcb <span class="keywordflow">for</span> relative <a class="code" href="../../d2/d0/nt6_2user32_8def.html#a9">file</a> object used to make <span class="keyword">this</span> open.
01684 
01685 Return Value:
01686 
01687     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> - <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> indicating <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> result of <a class="code" href="../../d7/d1/genuedef_8c.html#a2">the</a> operation.
01688 
01689 --*/
01690 
01691 {
01692     ULONG CcbFlags = 0;
01693     <a class="code" href="../../d6/d8/udfstruc_8h.html#a77">FILE_ID</a> FileId;
01694 
01695     BOOLEAN UnlockVcb = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01696     BOOLEAN FcbExisted;
01697 
01698     <a class="code" href="../../d7/d9/struct__FCB.html">PFCB</a> NextFcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01699     <a class="code" href="../../d7/d9/struct__FCB.html">PFCB</a> ParentFcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01700 
01701     <a class="code" href="../../d3/d8/udfprocs_8h.html#a109">TYPE_OF_OPEN</a> TypeOfOpen;
01702     <a class="code" href="../../d0/d7/lfs_2nodetype_8h.html#a7">NODE_TYPE_CODE</a> NodeTypeCode;
01703 
01704     <a class="code" href="../../d9/d9/struct__ICB__SEARCH__CONTEXT.html">ICB_SEARCH_CONTEXT</a> IcbContext;
01705     BOOLEAN CleanupIcbContext = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01706 
01707     <a class="code" href="../../d5/d9/struct__LCB.html">PLCB</a> OpenLcb;
01708 
01709     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01710 
01711     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
01712 
01713     <span class="comment">//</span>
01714     <span class="comment">//  Figure out what kind of open we will be performing here.  The caller has already insured</span>
01715     <span class="comment">//  that the user is expecting us to do this.</span>
01716     <span class="comment">//</span>
01717 
01718     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( DirContext-&gt;Fid-&gt;Flags, NSR_FID_F_DIRECTORY )) {
01719 
01720         TypeOfOpen = <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a116">UserDirectoryOpen</a>;
01721         NodeTypeCode = <a class="code" href="../../d1/d7/udfs_2nodetype_8h.html#a3">UDFS_NTC_FCB_INDEX</a>;
01722     
01723     } <span class="keywordflow">else</span> {
01724         
01725         TypeOfOpen = <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a117">UserFileOpen</a>;
01726         NodeTypeCode = <a class="code" href="../../d1/d7/udfs_2nodetype_8h.html#a4">UDFS_NTC_FCB_DATA</a>;
01727     }
01728 
01729     <span class="comment">//</span>
01730     <span class="comment">//  Check for illegal access to this file.</span>
01731     <span class="comment">//</span>
01732 
01733     <span class="keywordflow">if</span> (PerformUserOpen &amp;&amp;
01734         <a class="code" href="../../d3/d8/udfprocs_8h.html#a145">UdfIllegalFcbAccess</a>( IrpContext,
01735                              TypeOfOpen,
01736                              IrpSp-&gt;Parameters.Create.SecurityContext-&gt;DesiredAccess )) {
01737 
01738         <span class="keywordflow">return</span> STATUS_ACCESS_DENIED;
01739     }
01740 
01741     <span class="comment">//</span>
01742     <span class="comment">//  Use a try-finally to facilitate cleanup.</span>
01743     <span class="comment">//</span>
01744 
01745     <span class="keywordflow">try</span> {
01746 
01747         <span class="comment">//</span>
01748         <span class="comment">//  Check the related Ccb to see if this was an OpenByFileId.</span>
01749         <span class="comment">//</span>
01750 
01751         <span class="keywordflow">if</span> (ARGUMENT_PRESENT( RelatedCcb ) &amp;&amp;
01752             <a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( RelatedCcb-&gt;Flags, CCB_FLAG_OPEN_BY_ID | CCB_FLAG_OPEN_RELATIVE_BY_ID )) {
01753 
01754             <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( CcbFlags, CCB_FLAG_OPEN_RELATIVE_BY_ID );
01755         }
01756 
01757         <span class="keywordflow">if</span> (IgnoreCase) {
01758 
01759             <a class="code" href="../../d5/d5/cc_8h.html#a60">SetFlag</a>( CcbFlags, CCB_FLAG_IGNORE_CASE );
01760         }
01761 
01762         <span class="comment">//</span>
01763         <span class="comment">//  Build the file Id for this object.</span>
01764         <span class="comment">//</span>
01765         
01766         <a class="code" href="../../d6/d8/udfstruc_8h.html#a44">UdfSetFidFromLbAddr</a>( FileId, DirContext-&gt;Fid-&gt;Icb.Start );
01767 
01768         <span class="keywordflow">if</span> (TypeOfOpen == <a class="code" href="../../d3/d8/udfprocs_8h.html#a263a116">UserDirectoryOpen</a>) {
01769 
01770             <a class="code" href="../../d6/d8/udfstruc_8h.html#a49">UdfSetFidDirectory</a>( FileId );
01771         }
01772 
01773         <span class="comment">//</span>
01774         <span class="comment">//  Lock the Vcb so we can examine the Fcb Table.</span>
01775         <span class="comment">//</span>
01776 
01777         <a class="code" href="../../d3/d8/udfprocs_8h.html#a88">UdfLockVcb</a>( IrpContext, Vcb );
01778         UnlockVcb = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01779 
01780         <span class="comment">//</span>
01781         <span class="comment">//  Get the Fcb for this file.</span>
01782         <span class="comment">//</span>
01783 
01784         NextFcb = <a class="code" href="../../d3/d8/udfprocs_8h.html#a213">UdfCreateFcb</a>( IrpContext, FileId, NodeTypeCode, &amp;FcbExisted );
01785 
01786         <span class="comment">//</span>
01787         <span class="comment">//  If the Fcb was created here then initialize from the values in the</span>
01788         <span class="comment">//  dirent.  We have optimistically assumed that there isn't any corrupt</span>
01789         <span class="comment">//  information to this point - we're about to discover it if there is.</span>
01790         <span class="comment">//</span>
01791 
01792         <span class="keywordflow">if</span> (!FcbExisted) {
01793 
01794             <span class="comment">//</span>
01795             <span class="comment">//  Set the root extent length and go get the active ICB, initialize.</span>
01796             <span class="comment">//</span>
01797 
01798             NextFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o5">RootExtentLength</a> = DirContext-&gt;Fid-&gt;Icb.Length.Length;
01799 
01800             <a class="code" href="../../d3/d8/udfprocs_8h.html#a220">UdfInitializeIcbContextFromFcb</a>( IrpContext, &amp;IcbContext, NextFcb );
01801             CleanupIcbContext = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
01802 
01803             <a class="code" href="../../d3/d8/udfprocs_8h.html#a223">UdfLookupActiveIcb</a>( IrpContext, &amp;IcbContext );
01804             
01805             <a class="code" href="../../d3/d8/udfprocs_8h.html#a215">UdfInitializeFcbFromIcbContext</a>( IrpContext,
01806                                             NextFcb,
01807                                             &amp;IcbContext );
01808 
01809             <a class="code" href="../../d3/d8/udfprocs_8h.html#a224">UdfCleanupIcbContext</a>( IrpContext, &amp;IcbContext );
01810             CleanupIcbContext = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01811 
01812         }
01813 
01814         <span class="comment">//</span>
01815         <span class="comment">//  Now try to acquire the new Fcb without waiting.  We will reference</span>
01816         <span class="comment">//  the Fcb and retry with wait if unsuccessful.</span>
01817         <span class="comment">//</span>
01818 
01819         <span class="keywordflow">if</span> (!<a class="code" href="../../d3/d8/udfprocs_8h.html#a83">UdfAcquireFcbExclusive</a>( IrpContext, NextFcb, TRUE )) {
01820 
01821             NextFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o8">FcbReference</a> += 1;
01822 
01823             <a class="code" href="../../d3/d8/udfprocs_8h.html#a89">UdfUnlockVcb</a>( IrpContext, Vcb );
01824 
01825             <a class="code" href="../../d3/d8/udfprocs_8h.html#a85">UdfReleaseFcb</a>( IrpContext, *CurrentFcb );
01826             <a class="code" href="../../d3/d8/udfprocs_8h.html#a83">UdfAcquireFcbExclusive</a>( IrpContext, NextFcb, FALSE );
01827             <a class="code" href="../../d3/d8/udfprocs_8h.html#a83">UdfAcquireFcbExclusive</a>( IrpContext, *CurrentFcb, FALSE );
01828 
01829             <a class="code" href="../../d3/d8/udfprocs_8h.html#a88">UdfLockVcb</a>( IrpContext, Vcb );
01830             NextFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o8">FcbReference</a> -= 1;
01831         }
01832 
01833         <span class="comment">//</span>
01834         <span class="comment">//  Move down to this new Fcb.  Remember that we still own the parent however.</span>
01835         <span class="comment">//</span>
01836 
01837         ParentFcb = *CurrentFcb;
01838         *CurrentFcb = NextFcb;
01839 
01840         <span class="comment">//</span>
01841         <span class="comment">//  Store this name into the prefix table for the parent.</span>
01842         <span class="comment">//</span>
01843 
01844         OpenLcb = <a class="code" href="../../d3/d8/udfprocs_8h.html#a194">UdfInsertPrefix</a>( IrpContext,
01845                                    NextFcb,
01846                                    ( ShortNameMatch?
01847                                      &amp;DirContext-&gt;ShortObjectName :
01848                                      &amp;DirContext-&gt;CaseObjectName ),
01849                                    ShortNameMatch,
01850                                    IgnoreCase,
01851                                    ParentFcb );
01852 
01853         <span class="comment">//</span>
01854         <span class="comment">//  Now increment the reference counts for the parent and drop the Vcb.</span>
01855         <span class="comment">//</span>
01856 
01857         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( +1, Dbg,
01858                      <span class="stringliteral">"UdfOpenObjectFromDirContext, PFcb %08x Vcb %d/%d Fcb %d/%d\n"</span>, ParentFcb,
01859                      Vcb-&gt;VcbReference,
01860                      Vcb-&gt;VcbUserReference,
01861                      ParentFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o8">FcbReference</a>,
01862                      ParentFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o9">FcbUserReference</a> ));
01863 
01864         <a class="code" href="../../d3/d8/udfprocs_8h.html#a98">UdfIncrementReferenceCounts</a>( IrpContext, ParentFcb, 1, 1 );
01865         
01866         <a class="code" href="../../d5/d5/cc_8h.html#a91">DebugTrace</a>(( -1, Dbg, 
01867                      <span class="stringliteral">"UdfOpenObjectFromDirContext, Vcb %d/%d Fcb %d/%d\n"</span>,
01868                      Vcb-&gt;VcbReference,
01869                      Vcb-&gt;VcbUserReference,
01870                      ParentFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o8">FcbReference</a>,
01871                      ParentFcb-&gt;<a class="code" href="../../d7/d9/struct__FCB.html#o9">FcbUserReference</a> ));
01872 
01873         <a class="code" href="../../d3/d8/udfprocs_8h.html#a89">UdfUnlockVcb</a>( IrpContext, Vcb );
01874         UnlockVcb = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
01875 
01876         <span class="comment">//</span>
01877         <span class="comment">//  Perform initialization associated with the directory context.</span>
01878         <span class="comment">//</span>
01879             
01880         <a class="code" href="../../d3/d8/udfprocs_8h.html#a193">UdfInitializeLcbFromDirContext</a>( IrpContext,
01881                                         OpenLcb,
01882                                         DirContext );
01883 
01884         <span class="comment">//</span>
01885         <span class="comment">//  Release the parent Fcb at this point.</span>
01886         <span class="comment">//</span>
01887 
01888         <a class="code" href="../../d3/d8/udfprocs_8h.html#a85">UdfReleaseFcb</a>( IrpContext, ParentFcb );
01889         ParentFcb = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
01890 
01891         <span class="comment">//</span>
01892         <span class="comment">//  Call our worker routine to complete the open.</span>
01893         <span class="comment">//</span>
01894 
01895         <span class="keywordflow">if</span> (PerformUserOpen) {
01896 
01897             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d3/d8/udfs_2create_8c.html#a6">UdfCompleteFcbOpen</a>( IrpContext,
01898                                          IrpSp,
01899                                          Vcb,
01900                                          CurrentFcb,
01901                                          OpenLcb,
01902                                          TypeOfOpen,
01903                                          CcbFlags,
01904                                          IrpSp-&gt;Parameters.Create.SecurityContext-&gt;DesiredAccess );
01905         }
01906 
01907     } finally {
01908 
01909         <span class="comment">//</span>
01910         <span class="comment">//  Unlock the Vcb if held.</span>
01911         <span class="comment">//</span>
01912 
01913         <span class="keywordflow">if</span> (UnlockVcb) {
01914 
01915             <a class="code" href="../../d3/d8/udfprocs_8h.html#a89">UdfUnlockVcb</a>( IrpContext, Vcb );
01916         }
01917 
01918         <span class="comment">//</span>
01919         <span class="comment">//  Release the parent if held.</span>
01920         <span class="comment">//</span>
01921 
01922         <span class="keywordflow">if</span> (ParentFcb != <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
01923 
01924             <a class="code" href="../../d3/d8/udfprocs_8h.html#a85">UdfReleaseFcb</a>( IrpContext, ParentFcb );
01925         }
01926 
01927         <span class="comment">//</span>
01928         <span class="comment">//  Destroy the new Fcb if it was not fully initialized.</span>
01929         <span class="comment">//</span>
01930 
01931         <span class="keywordflow">if</span> (NextFcb &amp;&amp; !<a class="code" href="../../d5/d5/cc_8h.html#a58">FlagOn</a>( NextFcb-&gt;FcbState, FCB_STATE_INITIALIZED )) {
01932 
01933             <a class="code" href="../../d3/d8/udfprocs_8h.html#a214">UdfDeleteFcb</a>( IrpContext, NextFcb );
01934         }
01935 
01936         <span class="comment">//</span>
01937         <span class="comment">//  Clean up the Icb context if used.</span>
01938         <span class="comment">//</span>
01939 
01940         <span class="keywordflow">if</span> (CleanupIcbContext) {
01941 
01942             <a class="code" href="../../d3/d8/udfprocs_8h.html#a224">UdfCleanupIcbContext</a>( IrpContext, &amp;IcbContext );
01943         }
01944     }
01945 
01946     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
01947 }

</div></pre>    </td>
  </tr>
</table>
<hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:43:18 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
