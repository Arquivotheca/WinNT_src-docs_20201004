<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: floatem.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>floatem.c</h1><a href="../../d2/d4/ia64_2floatem_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 
00010 <span class="comment">/*++</span>
00011 <span class="comment"></span>
00012 <span class="comment">Copyright (c) 1996  Intel Corporation</span>
00013 <span class="comment"></span>
00014 <span class="comment">Module Name:</span>
00015 <span class="comment"></span>
00016 <span class="comment">    floatem.c</span>
00017 <span class="comment"></span>
00018 <span class="comment">Abstract:</span>
00019 <span class="comment"></span>
00020 <span class="comment">    This module implements IA64 machine dependent floating point emulation</span>
00021 <span class="comment">    functions to support the IEEE floating point standard.</span>
00022 <span class="comment"></span>
00023 <span class="comment">Author:</span>
00024 <span class="comment"></span>
00025 <span class="comment">    Marius Cornea-Hasegan  Sep-96</span>
00026 <span class="comment"></span>
00027 <span class="comment">Environment:</span>
00028 <span class="comment"></span>
00029 <span class="comment">    Kernel mode only.</span>
00030 <span class="comment"></span>
00031 <span class="comment">Revision History:</span>
00032 <span class="comment"> </span>
00033 <span class="comment">    Modfied  Jan. 97, Jan 98, Jun 98 (new API)</span>
00034 <span class="comment"></span>
00035 <span class="comment">--*/</span>
00036 
00037 <span class="preprocessor">#if 0</span>
00038 <span class="preprocessor"></span><span class="comment">/* #define this in floatem.c, fedefs.h and fesupport.c */</span>
00039 <span class="preprocessor">#define DEBUG_UNIX</span>
00040 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00041 <span class="preprocessor"></span>
00042 <span class="preprocessor">#include "<a class="code" href="../../d0/d0/ki_8h.html">ki.h</a>"</span>
00043 <span class="preprocessor">#include "<a class="code" href="../../d9/d1/fedefs_8h.html">fedefs.h</a>"</span>
00044 <span class="preprocessor">#include "<a class="code" href="../../d2/d3/fetypes_8h.html">fetypes.h</a>"</span>
00045 <span class="preprocessor">#include "<a class="code" href="../../d1/d3/fesupprt_8h.html">fesupprt.h</a>"</span>
00046 <span class="preprocessor">#include "<a class="code" href="../../d6/d2/feproto_8h.html">feproto.h</a>"</span>
00047 
00048 <span class="preprocessor">#ifdef TRUE</span>
00049 <span class="preprocessor"></span><span class="preprocessor">#undef TRUE</span>
00050 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00051"></a><a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a0">00051</a> <span class="preprocessor"></span><span class="preprocessor">#define TRUE            0</span>
00052 <span class="preprocessor"></span>
00053 <span class="preprocessor">#ifdef FALSE</span>
00054 <span class="preprocessor"></span><span class="preprocessor">#undef FALSE</span>
00055 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00056"></a><a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a1">00056</a> <span class="preprocessor"></span><span class="preprocessor">#define FALSE           1</span>
00057 <span class="preprocessor"></span>
<a name="l00058"></a><a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a2">00058</a> <span class="preprocessor">#define FP_EMUL_ERROR          -1</span>
<a name="l00059"></a><a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a3">00059</a> <span class="preprocessor"></span><span class="preprocessor">#define FAULT_TO_TRAP           2</span>
<a name="l00060"></a><a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a4">00060</a> <span class="preprocessor"></span><span class="preprocessor">#define SIMD_INSTRUCTION        4</span>
<a name="l00061"></a><a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a5">00061</a> <span class="preprocessor"></span><span class="preprocessor">#define FPFLT 1</span>
<a name="l00062"></a><a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a6">00062</a> <span class="preprocessor"></span><span class="preprocessor">#define FPTRAP 0</span>
<a name="l00063"></a><a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a7">00063</a> <span class="preprocessor"></span><span class="preprocessor">#define FP_REG_EMIN             -65534</span>
<a name="l00064"></a><a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a8">00064</a> <span class="preprocessor"></span><span class="preprocessor">#define FP_REG_EMAX             65535</span>
<a name="l00065"></a><a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a9">00065</a> <span class="preprocessor"></span><span class="preprocessor">#define N64                     64</span>
00066 <span class="preprocessor"></span>
<a name="l00067"></a><a class="code" href="../../d5/d5/struct__BUNDLE.html">00067</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d5/d5/struct__BUNDLE.html">_BUNDLE</a> {
<a name="l00068"></a><a class="code" href="../../d5/d5/struct__BUNDLE.html#o0">00068</a>   <a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a> <a class="code" href="../../d5/d5/struct__BUNDLE.html#o0">BundleLow</a>;
<a name="l00069"></a><a class="code" href="../../d5/d5/struct__BUNDLE.html#o1">00069</a>   <a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a> <a class="code" href="../../d5/d5/struct__BUNDLE.html#o1">BundleHigh</a>;
00070 } <a class="code" href="../../d5/d5/struct__BUNDLE.html">BUNDLE</a>;
00071 
00072 <span class="preprocessor">#ifdef WIN32_OR_WIN64</span>
<a name="l00073"></a><a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a82">00073</a> <span class="preprocessor"></span><span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a82">__declspec</a>(align(16)) _FLOAT128_TYPE {
00074 <span class="preprocessor">#else</span>
00075 <span class="preprocessor"></span><span class="keyword">typedef</span> <span class="keyword">struct </span>_FLOAT128_TYPE {
00076 <span class="preprocessor">#endif</span>
00077 <span class="preprocessor"></span>     <a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a> loFlt64;
00078      <a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a> hiFlt64;
<a name="l00079"></a><a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a81">00079</a> } <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a81">FLOAT128_TYPE</a>;
00080 
00081 
00082 <span class="preprocessor">#ifndef CONST_FORMAT</span>
00083 <span class="preprocessor"></span>
00084 <span class="preprocessor">#ifndef WIN32_OR_WIN64</span>
00085 <span class="preprocessor"></span><span class="preprocessor">#define CONST_FORMAT(num) num##LL</span>
00086 <span class="preprocessor"></span><span class="preprocessor">#else</span>
00087 <span class="preprocessor"></span><span class="preprocessor">#define CONST_FORMAT(num) ((EM_uint64_t)(num))</span>
00088 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00089 <span class="preprocessor"></span>
00090 <span class="preprocessor">#endif</span>
00091 <span class="preprocessor"></span>
00092 
00093 <span class="comment">// Functions (static or external)</span>
00094 
00095 <span class="keywordtype">int</span>
00096 <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a83">swa_trap</a> (EM_opcode_sf_type sf, EM_uint64_t FPSR, EM_uint_t ISRlow);
00097 
00098 <a class="code" href="../../d0/d0/structfp__reg__struct.html">EM_fp_reg_type</a>
00099 <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a84">FP128ToFPReg</a> (
00100     FLOAT128_TYPE f128
00101     );
00102 
00103 <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a81">FLOAT128_TYPE</a>
00104 <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a85">FPRegToFP128</a> (
00105     <a class="code" href="../../d0/d0/structfp__reg__struct.html">EM_fp_reg_type</a> fpreg
00106     );
00107 
00108 <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a81">FLOAT128_TYPE</a>
00109 <a class="code" href="../../d6/d5/ia64_2getsetrg_8c.html#a8">get_fp_register</a> (
00110     <span class="keywordtype">int</span> reg,
00111     <span class="keywordtype">void</span> *fp_state
00112     );
00113 
00114 <span class="keywordtype">void</span>
00115 <a class="code" href="../../d6/d5/ia64_2getsetrg_8c.html#a9">set_fp_register</a> (
00116     <span class="keywordtype">int</span> reg,
00117     FLOAT128_TYPE value,
00118     <span class="keywordtype">void</span> *fp_state
00119     );
00120 
00121 
00122 <span class="keywordtype">void</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a88">run_fms</a> (EM_uint64_t *fpsr, 
00123     FLOAT128_TYPE *d, FLOAT128_TYPE *a, FLOAT128_TYPE *b, FLOAT128_TYPE *c);
00124 <span class="keywordtype">void</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a89">thmF</a> (EM_uint64_t *fpsr, FLOAT128_TYPE *a, FLOAT128_TYPE *b,
00125     FLOAT128_TYPE *c);
00126 <span class="keywordtype">void</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a90">thmL</a> (EM_uint64_t *fpsr, FLOAT128_TYPE *a, FLOAT128_TYPE *s);
00127 
00128 
00129 
00130 <span class="comment">// Masks and patterns for the different faulting FP instruction types </span>
00131 <span class="comment">// Note: Fn_MIN_MASK and Fn_PATTERN need to be checked if new opcodes </span>
00132 <span class="comment">// are inserted in this function</span>
00133 
00134 
<a name="l00135"></a><a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a10">00135</a> <span class="preprocessor">#define F1_MIN_MASK                     CONST_FORMAT(0x010000000000)</span>
<a name="l00136"></a><a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a11">00136</a> <span class="preprocessor"></span><span class="preprocessor">#define F1_PATTERN                      CONST_FORMAT(0x010000000000)</span>
00137 <span class="preprocessor"></span>
<a name="l00138"></a><a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a12">00138</a> <span class="preprocessor">#define F1_MASK                         CONST_FORMAT(0x01F000000000)</span>
00139 <span class="preprocessor"></span>
<a name="l00140"></a><a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a13">00140</a> <span class="preprocessor">#define FMA_PATTERN                     CONST_FORMAT(0x010000000000)</span>
<a name="l00141"></a><a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a14">00141</a> <span class="preprocessor"></span><span class="preprocessor">#define FMA_S_PATTERN                   CONST_FORMAT(0x011000000000)</span>
<a name="l00142"></a><a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a15">00142</a> <span class="preprocessor"></span><span class="preprocessor">#define FMA_D_PATTERN                   CONST_FORMAT(0x012000000000)</span>
<a name="l00143"></a><a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a16">00143</a> <span class="preprocessor"></span><span class="preprocessor">#define FPMA_PATTERN                    CONST_FORMAT(0x013000000000)</span>
00144 <span class="preprocessor"></span>
<a name="l00145"></a><a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a17">00145</a> <span class="preprocessor">#define FMS_PATTERN                     CONST_FORMAT(0x014000000000)</span>
<a name="l00146"></a><a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a18">00146</a> <span class="preprocessor"></span><span class="preprocessor">#define FMS_S_PATTERN                   CONST_FORMAT(0x015000000000)</span>
<a name="l00147"></a><a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a19">00147</a> <span class="preprocessor"></span><span class="preprocessor">#define FMS_D_PATTERN                   CONST_FORMAT(0x016000000000)</span>
<a name="l00148"></a><a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a20">00148</a> <span class="preprocessor"></span><span class="preprocessor">#define FPMS_PATTERN                    CONST_FORMAT(0x017000000000)</span>
00149 <span class="preprocessor"></span>
<a name="l00150"></a><a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a21">00150</a> <span class="preprocessor">#define FNMA_PATTERN                    CONST_FORMAT(0x018000000000)</span>
<a name="l00151"></a><a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a22">00151</a> <span class="preprocessor"></span><span class="preprocessor">#define FNMA_S_PATTERN                  CONST_FORMAT(0x019000000000)</span>
<a name="l00152"></a><a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a23">00152</a> <span class="preprocessor"></span><span class="preprocessor">#define FNMA_D_PATTERN                  CONST_FORMAT(0x01A000000000)</span>
<a name="l00153"></a><a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a24">00153</a> <span class="preprocessor"></span><span class="preprocessor">#define FPNMA_PATTERN                   CONST_FORMAT(0x01B000000000)</span>
00154 <span class="preprocessor"></span>
00155 
<a name="l00156"></a><a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a25">00156</a> <span class="preprocessor">#define F4_MIN_MASK                     CONST_FORMAT(0x018000000000)</span>
<a name="l00157"></a><a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a26">00157</a> <span class="preprocessor"></span><span class="preprocessor">#define F4_PATTERN                      CONST_FORMAT(0x008000000000)</span>
00158 <span class="preprocessor"></span>
<a name="l00159"></a><a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a27">00159</a> <span class="preprocessor">#define F4_MASK                         CONST_FORMAT(0x01F200001000)</span>
00160 <span class="preprocessor"></span>
<a name="l00161"></a><a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a28">00161</a> <span class="preprocessor">#define FCMP_EQ_PATTERN                 CONST_FORMAT(0x008000000000)</span>
<a name="l00162"></a><a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a29">00162</a> <span class="preprocessor"></span><span class="preprocessor">#define FCMP_LT_PATTERN                 CONST_FORMAT(0x009000000000)</span>
<a name="l00163"></a><a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a30">00163</a> <span class="preprocessor"></span><span class="preprocessor">#define FCMP_LE_PATTERN                 CONST_FORMAT(0x008200000000)</span>
<a name="l00164"></a><a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a31">00164</a> <span class="preprocessor"></span><span class="preprocessor">#define FCMP_UNORD_PATTERN              CONST_FORMAT(0x009200000000)</span>
<a name="l00165"></a><a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a32">00165</a> <span class="preprocessor"></span><span class="preprocessor">#define FCMP_EQ_UNC_PATTERN             CONST_FORMAT(0x008000001000)</span>
<a name="l00166"></a><a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a33">00166</a> <span class="preprocessor"></span><span class="preprocessor">#define FCMP_LT_UNC_PATTERN             CONST_FORMAT(0x009000001000)</span>
<a name="l00167"></a><a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a34">00167</a> <span class="preprocessor"></span><span class="preprocessor">#define FCMP_LE_UNC_PATTERN             CONST_FORMAT(0x008200001000)</span>
<a name="l00168"></a><a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a35">00168</a> <span class="preprocessor"></span><span class="preprocessor">#define FCMP_UNORD_UNC_PATTERN          CONST_FORMAT(0x009200001000)</span>
00169 <span class="preprocessor"></span>
00170 
<a name="l00171"></a><a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a36">00171</a> <span class="preprocessor">#define F6_MIN_MASK                     CONST_FORMAT(0x019200000000)</span>
<a name="l00172"></a><a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a37">00172</a> <span class="preprocessor"></span><span class="preprocessor">#define F6_PATTERN                      CONST_FORMAT(0x000200000000)</span>
00173 <span class="preprocessor"></span>
<a name="l00174"></a><a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a38">00174</a> <span class="preprocessor">#define F6_MASK                         CONST_FORMAT(0x01F200000000)</span>
00175 <span class="preprocessor"></span>
<a name="l00176"></a><a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a39">00176</a> <span class="preprocessor">#define FRCPA_PATTERN                   CONST_FORMAT(0x000200000000)</span>
<a name="l00177"></a><a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a40">00177</a> <span class="preprocessor"></span><span class="preprocessor">#define FPRCPA_PATTERN                  CONST_FORMAT(0x002200000000)</span>
00178 <span class="preprocessor"></span>
00179 
<a name="l00180"></a><a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a41">00180</a> <span class="preprocessor">#define F7_MIN_MASK                     CONST_FORMAT(0x019200000000)</span>
<a name="l00181"></a><a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a42">00181</a> <span class="preprocessor"></span><span class="preprocessor">#define F7_PATTERN                      CONST_FORMAT(0x001200000000)</span>
00182 <span class="preprocessor"></span>
<a name="l00183"></a><a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a43">00183</a> <span class="preprocessor">#define F7_MASK                         CONST_FORMAT(0x01F200000000)</span>
00184 <span class="preprocessor"></span>
<a name="l00185"></a><a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a44">00185</a> <span class="preprocessor">#define FRSQRTA_PATTERN                 CONST_FORMAT(0x001200000000)</span>
<a name="l00186"></a><a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a45">00186</a> <span class="preprocessor"></span><span class="preprocessor">#define FPRSQRTA_PATTERN                CONST_FORMAT(0x003200000000)</span>
00187 <span class="preprocessor"></span>
00188 
<a name="l00189"></a><a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a46">00189</a> <span class="preprocessor">#define F8_MIN_MASK                     CONST_FORMAT(0x018240000000)</span>
<a name="l00190"></a><a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a47">00190</a> <span class="preprocessor"></span><span class="preprocessor">#define F8_PATTERN                      CONST_FORMAT(0x000000000000)</span>
00191 <span class="preprocessor"></span>
<a name="l00192"></a><a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a48">00192</a> <span class="preprocessor">#define F8_MASK                         CONST_FORMAT(0x01E3F8000000)</span>
00193 <span class="preprocessor"></span>
<a name="l00194"></a><a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a49">00194</a> <span class="preprocessor">#define FMIN_PATTERN                    CONST_FORMAT(0x0000A0000000)</span>
<a name="l00195"></a><a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a50">00195</a> <span class="preprocessor"></span><span class="preprocessor">#define FMAX_PATTERN                    CONST_FORMAT(0x0000A8000000)</span>
<a name="l00196"></a><a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a51">00196</a> <span class="preprocessor"></span><span class="preprocessor">#define FAMIN_PATTERN                   CONST_FORMAT(0x0000B0000000)</span>
<a name="l00197"></a><a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a52">00197</a> <span class="preprocessor"></span><span class="preprocessor">#define FAMAX_PATTERN                   CONST_FORMAT(0x0000B8000000)</span>
<a name="l00198"></a><a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a53">00198</a> <span class="preprocessor"></span><span class="preprocessor">#define FPMIN_PATTERN                   CONST_FORMAT(0x0020A0000000)</span>
<a name="l00199"></a><a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a54">00199</a> <span class="preprocessor"></span><span class="preprocessor">#define FPMAX_PATTERN                   CONST_FORMAT(0x0020A8000000)</span>
<a name="l00200"></a><a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a55">00200</a> <span class="preprocessor"></span><span class="preprocessor">#define FPAMIN_PATTERN                  CONST_FORMAT(0x0020B0000000)</span>
<a name="l00201"></a><a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a56">00201</a> <span class="preprocessor"></span><span class="preprocessor">#define FPAMAX_PATTERN                  CONST_FORMAT(0x0020B8000000)</span>
<a name="l00202"></a><a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a57">00202</a> <span class="preprocessor"></span><span class="preprocessor">#define FPCMP_EQ_PATTERN                CONST_FORMAT(0x002180000000)</span>
<a name="l00203"></a><a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a58">00203</a> <span class="preprocessor"></span><span class="preprocessor">#define FPCMP_LT_PATTERN                CONST_FORMAT(0x002188000000)</span>
<a name="l00204"></a><a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a59">00204</a> <span class="preprocessor"></span><span class="preprocessor">#define FPCMP_LE_PATTERN                CONST_FORMAT(0x002190000000)</span>
<a name="l00205"></a><a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a60">00205</a> <span class="preprocessor"></span><span class="preprocessor">#define FPCMP_UNORD_PATTERN             CONST_FORMAT(0x002198000000)</span>
<a name="l00206"></a><a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a61">00206</a> <span class="preprocessor"></span><span class="preprocessor">#define FPCMP_NEQ_PATTERN               CONST_FORMAT(0x0021A0000000)</span>
<a name="l00207"></a><a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a62">00207</a> <span class="preprocessor"></span><span class="preprocessor">#define FPCMP_NLT_PATTERN               CONST_FORMAT(0x0021A8000000)</span>
<a name="l00208"></a><a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a63">00208</a> <span class="preprocessor"></span><span class="preprocessor">#define FPCMP_NLE_PATTERN               CONST_FORMAT(0x0021B0000000)</span>
<a name="l00209"></a><a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a64">00209</a> <span class="preprocessor"></span><span class="preprocessor">#define FPCMP_ORD_PATTERN               CONST_FORMAT(0x0021B8000000)</span>
00210 <span class="preprocessor"></span>
00211 
<a name="l00212"></a><a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a65">00212</a> <span class="preprocessor">#define F10_MIN_MASK                    CONST_FORMAT(0x018240000000)</span>
<a name="l00213"></a><a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a66">00213</a> <span class="preprocessor"></span><span class="preprocessor">#define F10_PATTERN                     CONST_FORMAT(0x000040000000)</span>
00214 <span class="preprocessor"></span>
<a name="l00215"></a><a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a67">00215</a> <span class="preprocessor">#define F10_MASK                        CONST_FORMAT(0x01E3F8000000)</span>
00216 <span class="preprocessor"></span>
<a name="l00217"></a><a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a68">00217</a> <span class="preprocessor">#define FCVT_FX_PATTERN                 CONST_FORMAT(0x0000C0000000)</span>
<a name="l00218"></a><a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a69">00218</a> <span class="preprocessor"></span><span class="preprocessor">#define FCVT_FXU_PATTERN                CONST_FORMAT(0x0000C8000000)</span>
<a name="l00219"></a><a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a70">00219</a> <span class="preprocessor"></span><span class="preprocessor">#define FCVT_FX_TRUNC_PATTERN           CONST_FORMAT(0x0000D0000000)</span>
<a name="l00220"></a><a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a71">00220</a> <span class="preprocessor"></span><span class="preprocessor">#define FCVT_FXU_TRUNC_PATTERN          CONST_FORMAT(0x0000D8000000)</span>
<a name="l00221"></a><a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a72">00221</a> <span class="preprocessor"></span><span class="preprocessor">#define FPCVT_FX_PATTERN                CONST_FORMAT(0x0020C0000000)</span>
<a name="l00222"></a><a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a73">00222</a> <span class="preprocessor"></span><span class="preprocessor">#define FPCVT_FXU_PATTERN               CONST_FORMAT(0x0020C8000000)</span>
<a name="l00223"></a><a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a74">00223</a> <span class="preprocessor"></span><span class="preprocessor">#define FPCVT_FX_TRUNC_PATTERN          CONST_FORMAT(0x0020D0000000)</span>
<a name="l00224"></a><a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a75">00224</a> <span class="preprocessor"></span><span class="preprocessor">#define FPCVT_FXU_TRUNC_PATTERN         CONST_FORMAT(0x0020D8000000)</span>
00225 <span class="preprocessor"></span>
00226 
00227 
00228 <span class="comment">// minimum and maximum values of the exponent</span>
00229 
<a name="l00230"></a><a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a76">00230</a> <span class="preprocessor">#define EMIN_08_BITS    -126</span>
<a name="l00231"></a><a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a77">00231</a> <span class="preprocessor"></span><span class="preprocessor">#define EMIN_11_BITS    -1022</span>
<a name="l00232"></a><a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a78">00232</a> <span class="preprocessor"></span><span class="preprocessor">#define EMIN_15_BITS    -16382</span>
<a name="l00233"></a><a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a79">00233</a> <span class="preprocessor"></span><span class="preprocessor">#define EMIN_17_BITS    -65534</span>
00234 <span class="preprocessor"></span>
00235 
00236 
00237 <span class="keywordtype">int</span>
<a name="l00238"></a><a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a91">00238</a> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a91">fp_emulate</a> (
00239     <span class="keywordtype">int</span> trap_type,
00240     <a class="code" href="../../d5/d5/struct__BUNDLE.html">BUNDLE</a> *pbundle,
00241     EM_int64_t *pipsr,
00242     EM_int64_t *pfpsr,
00243     EM_int64_t *pisr,
00244     EM_int64_t *ppreds,
00245     EM_int64_t *pifs,
00246     <span class="keywordtype">void</span> *fp_state
00247     )
00248 
00249 {
00250 
00251   <a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a> BundleHigh;
00252   <a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a> BundleLow;
00253   <a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a> ISRlow;
00254   <a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a> ei;
00255   <a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a> OpCode;
00256 
00257   <a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a> fault_ISR_code;
00258   <a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a> trap_ISR_code;
00259 
00260   <a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a> <a class="code" href="../../d9/d2/festate_8h.html#a0">FPSR</a>;
00261   <a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a> FPSR1;
00262   <a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a> CFM;
00263 
00264   <span class="comment">// arguments to emulation functions</span>
00265   <a class="code" href="../../d2/d3/fetypes_8h.html#a449">EM_opcode_sf_type</a> sf;
00266   <a class="code" href="../../d2/d3/fetypes_8h.html#a444">EM_pred_reg_specifier</a> qp;
00267   <a class="code" href="../../d2/d3/fetypes_8h.html#a446">EM_fp_reg_specifier</a> f1;
00268   <a class="code" href="../../d2/d3/fetypes_8h.html#a446">EM_fp_reg_specifier</a> f2;
00269   <a class="code" href="../../d2/d3/fetypes_8h.html#a446">EM_fp_reg_specifier</a> f3;
00270   <a class="code" href="../../d2/d3/fetypes_8h.html#a446">EM_fp_reg_specifier</a> f4;
00271   <a class="code" href="../../d2/d3/fetypes_8h.html#a444">EM_pred_reg_specifier</a> p1;
00272   <a class="code" href="../../d2/d3/fetypes_8h.html#a444">EM_pred_reg_specifier</a> p2;
00273 
00274   <a class="code" href="../../d2/d3/fetypes_8h.html#a448">EM_opcode_pc_type</a> opcode_pc;
00275   <a class="code" href="../../d2/d3/fetypes_8h.html#a454">EM_sf_pc_type</a> pc;
00276   <a class="code" href="../../d2/d3/fetypes_8h.html#a455">EM_sf_rc_type</a> rc;
00277   <a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a> wre;
00278 
00279   <span class="keywordtype">int</span> significand_size;
00280 
00281   <a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a> fpa, fpa_lo, fpa_hi;
00282   <a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a> I_exc, I_exc_lo, I_exc_hi;
00283   <a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a> U_exc, U_exc_lo, U_exc_hi;
00284   <a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a> O_exc, O_exc_lo, O_exc_hi;
00285   <a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a> sign, sign_lo, sign_hi;
00286   <a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a> exponent, exponent_lo, exponent_hi;
00287   <a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a> significand;
00288   <a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a> significand_lo, significand_hi;
00289   <a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a> low_half;
00290   <a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a> high_half;
00291   <a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a> lsb, lsb_lo, lsb_hi;
00292   <a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a> round, round_lo, round_hi;
00293   <a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a> sticky, sticky_lo, sticky_hi;
00294   <a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a> I_dis, U_dis, O_dis;
00295   <a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a> Z_dis, D_dis, V_dis;
00296 
00297   <a class="code" href="../../d0/d0/structfp__reg__struct.html">EM_fp_reg_type</a> tmp_fp;
00298 
00299   <a class="code" href="../../d2/d3/fetypes_8h.html#a11">EM_int_t</a> true_bexp, true_bexp_lo, true_bexp_hi;
00300   <a class="code" href="../../d2/d3/fetypes_8h.html#a11">EM_int_t</a> shift_cnt, shift_cnt_lo, shift_cnt_hi;
00301   <a class="code" href="../../d2/d3/fetypes_8h.html#a11">EM_int_t</a> emin;
00302   <a class="code" href="../../d2/d3/fetypes_8h.html#a11">EM_int_t</a> decr_exp, decr_exp_lo, decr_exp_hi;
00303   <span class="keywordtype">int</span> ind;
00304 
00305   <a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a> EmulationExceptionCode;
00306 
00307   <a class="code" href="../../d9/d8/structEM__state__struct.html">EM_state_type</a> proc_state, *ps;
00308 
00309   <a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a> SIMD_instruction;
00310 
00311   <span class="comment">// sign, exponent, and significand for the operands of a and b </span>
00312   <span class="comment">// in FRCPA and FRSQRTA</span>
00313 
00314   <a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a> sign_a;
00315   <a class="code" href="../../d2/d3/fetypes_8h.html#a11">EM_int_t</a> exponent_a;
00316   <a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a> significand_a;
00317   <a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a> sign_b;
00318   <a class="code" href="../../d2/d3/fetypes_8h.html#a11">EM_int_t</a> exponent_b;
00319   <a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a> significand_b;
00320   <a class="code" href="../../d2/d3/fetypes_8h.html#a11">EM_int_t</a> sign_c;
00321   <a class="code" href="../../d2/d3/fetypes_8h.html#a11">EM_int_t</a> exponent_c;
00322   <a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a> significand_c;
00323 
00324   <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a81">FLOAT128_TYPE</a> a_float128;
00325   <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a81">FLOAT128_TYPE</a> b_float128;
00326   <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a81">FLOAT128_TYPE</a> c_float128;
00327   <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a81">FLOAT128_TYPE</a> c1_float128;
00328   <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a81">FLOAT128_TYPE</a> d_float128;
00329   <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a81">FLOAT128_TYPE</a> s_float128;
00330   <span class="keywordtype">int</span> I_flag;
00331   <span class="keywordtype">int</span> ftz;
00332   <span class="keywordtype">int</span> unnormal;
00333   <span class="keywordtype">int</span> new_trap_type;
00334 
00335   <span class="comment">// local index registers</span>
00336   <span class="keywordtype">int</span> lf1 = 5;
00337   <span class="keywordtype">int</span> lf2 = 2;
00338   <span class="keywordtype">int</span> lf3 = 3;
00339   <span class="keywordtype">int</span> lf4 = 4;
00340 
00341   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> rrbpr;
00342   <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> rrbfr;
00343 
00344 
00345 <span class="preprocessor">#ifdef DEBUG_UNIX</span>
00346 <span class="preprocessor"></span>  printf (<span class="stringliteral">"**** DEBUG: ENTERING fp_emulate () ****\n"</span>);
00347 <span class="preprocessor">#endif</span>
00348 <span class="preprocessor"></span>
00349   ps = &amp;proc_state;
00350   <a class="code" href="../../d1/d3/fesupprt_8h.html#a19">EM_initialize_state</a> (ps); 
00351   <span class="comment">// do not reg any exception handlers</span>
00352 <span class="preprocessor">#ifndef unix</span>
00353 <span class="preprocessor"></span>  f1 = 127; <span class="comment">// initialize f1 (for MS compiler only; not really needed)</span>
00354 <span class="preprocessor">#endif</span>
00355 <span class="preprocessor"></span>  SIMD_instruction = 2;
00356   ei = (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)0;
00357   OpCode = (<a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a>)0;
00358 
00359   BundleLow = pbundle-&gt;<a class="code" href="../../d5/d5/struct__BUNDLE.html#o0">BundleLow</a>;
00360   BundleHigh = pbundle-&gt;<a class="code" href="../../d5/d5/struct__BUNDLE.html#o1">BundleHigh</a>;
00361 <span class="preprocessor">#ifdef DEBUG_UNIX</span>
00362 <span class="preprocessor"></span>  printf (<span class="stringliteral">"fp_emulate DEBUG: Bundle High/Low  = %Lx %Lx\n"</span>, 
00363       BundleHigh, BundleLow);
00364 <span class="preprocessor">#endif</span>
00365 <span class="preprocessor"></span>
00366   ISRlow = (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)(*pisr);
00367 
00368   <span class="comment">// FP status reg</span>
00369   <a class="code" href="../../d9/d2/festate_8h.html#a0">FPSR</a> = *pfpsr;
00370   CFM = *pifs &amp; <a class="code" href="../../d2/d3/fetypes_8h.html#a3">CONST_FORMAT</a>(0x03fffffffff);
00371   rrbpr = (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)((CFM &gt;&gt; 32) &amp; 0x3f);
00372   rrbfr = (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)((CFM &gt;&gt; 25) &amp; 0x7f);
00373 <span class="preprocessor">#ifdef DEBUG_UNIX</span>
00374 <span class="preprocessor"></span>  printf (<span class="stringliteral">"fp_emulate DEBUG: FPSR = %Lx\n"</span>, <a class="code" href="../../d9/d2/festate_8h.html#a0">FPSR</a>);
00375   printf (<span class="stringliteral">"fp_emulate DEBUG: CFM = %Lx\n"</span>, CFM);
00376   printf (<span class="stringliteral">"fp_emulate DEBUG: rrbpr = %x rrbfr = %x\n"</span>, rrbpr, rrbfr);
00377   printf (<span class="stringliteral">"fp_emulate DEBUG: PREDS = %Lx\n"</span>, *ppreds);
00378   printf (<span class="stringliteral">"fp_emulate DEBUG: ISRlow = %x\n"</span>, ISRlow);
00379 <span class="preprocessor">#endif</span>
00380 <span class="preprocessor"></span>
00381   <span class="comment">// copy the FPSR into AR[0]</span>
00382   ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o2">state_AR</a>[0].<a class="code" href="../../d9/d0/unionar__union.html#o1">uint_value</a> = <a class="code" href="../../d9/d2/festate_8h.html#a0">FPSR</a>;
00383 
00384 <span class="preprocessor">#ifdef DEBUG_UNIX</span>
00385 <span class="preprocessor"></span>  OpCode = (BundleLow &gt;&gt; 5) &amp; <a class="code" href="../../d2/d3/fetypes_8h.html#a3">CONST_FORMAT</a>(0x01ffffffffff);
00386   printf (<span class="stringliteral">"DEBUG: OpCode0 = %Lx\n"</span>, OpCode);
00387   OpCode = ((BundleHigh &amp; <a class="code" href="../../d2/d3/fetypes_8h.html#a3">CONST_FORMAT</a>(0x07fffff)) &lt;&lt; 18) |
00388       ((BundleLow &gt;&gt; 46) &amp; <a class="code" href="../../d2/d3/fetypes_8h.html#a3">CONST_FORMAT</a>(0x03ffff));
00389   printf (<span class="stringliteral">"DEBUG: OpCode1 = %Lx\n"</span>, OpCode);
00390   OpCode = (BundleHigh &gt;&gt; 23) &amp; <a class="code" href="../../d2/d3/fetypes_8h.html#a3">CONST_FORMAT</a>(0x01ffffffffff);
00391   printf (<span class="stringliteral">"DEBUG: OpCode2 = %Lx\n"</span>, OpCode);
00392 <span class="preprocessor">#endif</span>
00393 <span class="preprocessor"></span>
00394   <span class="comment">// excepting instruction in bundle: slot 0, 1, or 2</span>
00395   ei = (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)(((*pisr) &gt;&gt; 41) &amp; 0x03);
00396   <span class="comment">// cut the faulting instruction opcode (41 bits)</span>
00397   <span class="keywordflow">if</span> (ei == 0) { <span class="comment">// no template for this case</span>
00398     <span class="comment">// OpCode = (BundleLow &gt;&gt; 5) &amp; CONST_FORMAT(0x01ffffffffff);</span>
00399 <span class="preprocessor">#ifndef unix</span>
00400 <span class="preprocessor"></span><span class="preprocessor"># if DBG</span>
00401 <span class="preprocessor"></span>    <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"fp_emulate () Internal Error: template FXX\n"</span>);
00402 <span class="preprocessor"># endif</span>
00403 <span class="preprocessor"></span><span class="preprocessor">#else</span>
00404 <span class="preprocessor"></span>    <a class="code" href="../../d9/d1/fedefs_8h.html#a1">FP_EMULATION_ERROR0</a> (<span class="stringliteral">"fp_emulate () Internal Error: template FXX\n"</span>);
00405     <span class="keywordflow">return</span> (<a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a2">FP_EMUL_ERROR</a>);
00406 <span class="preprocessor">#endif</span>
00407 <span class="preprocessor"></span>  } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ei == 1) { <span class="comment">// templates: MFI, MFB</span>
00408     OpCode = ((BundleHigh &amp; <a class="code" href="../../d2/d3/fetypes_8h.html#a3">CONST_FORMAT</a>(0x07fffff)) &lt;&lt; 18) | 
00409         ((BundleLow &gt;&gt; 46) &amp; <a class="code" href="../../d2/d3/fetypes_8h.html#a3">CONST_FORMAT</a>(0x03ffff));
00410 <span class="preprocessor">#ifdef DEBUG_UNIX</span>
00411 <span class="preprocessor"></span>  printf (<span class="stringliteral">"DEBUG: ei = 1 OpCode = %Lx\n"</span>, OpCode);
00412 <span class="preprocessor">#endif</span>
00413 <span class="preprocessor"></span>  } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ei == 2) { <span class="comment">// templates: MMF</span>
00414     OpCode = (BundleHigh &gt;&gt; 23) &amp; <a class="code" href="../../d2/d3/fetypes_8h.html#a3">CONST_FORMAT</a>(0x01ffffffffff);
00415 <span class="preprocessor">#ifdef DEBUG_UNIX</span>
00416 <span class="preprocessor"></span>  printf (<span class="stringliteral">"DEBUG: ei = 2 OpCode = %Lx\n"</span>, OpCode);
00417 <span class="preprocessor">#endif</span>
00418 <span class="preprocessor"></span>  } <span class="keywordflow">else</span> {
00419 <span class="preprocessor">#ifndef unix</span>
00420 <span class="preprocessor"></span><span class="preprocessor"># if DBG</span>
00421 <span class="preprocessor"></span>    <a class="code" href="../../d6/d6/memprint_8h.html#a7">DbgPrint</a> (<span class="stringliteral">"fp_emulate () Internal Error: instruction slot 3 is invalid\n"</span>);
00422 <span class="preprocessor"># endif</span>
00423 <span class="preprocessor"></span><span class="preprocessor">#else</span>
00424 <span class="preprocessor"></span>    <a class="code" href="../../d9/d1/fedefs_8h.html#a1">FP_EMULATION_ERROR0</a> (<span class="stringliteral">"fp_emulate () Internal Error: \</span>
00425 <span class="stringliteral">instruction slot 3 is not valid\n"</span>);
00426     <span class="keywordflow">return</span> (<a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a2">FP_EMUL_ERROR</a>);
00427 <span class="preprocessor">#endif</span>
00428 <span class="preprocessor"></span>  }
00429 
00430   <span class="comment">// decode the instruction opcode; assume fp_emulate () is only called</span>
00431   <span class="comment">// for FP instructions that caused an FP fault or trap</span>
00432 
00433   <span class="comment">// sf and qp have the same offset, for all the FP instructions</span>
00434   sf = (<a class="code" href="../../d2/d3/fetypes_8h.html#a449">EM_opcode_sf_type</a>)((OpCode &gt;&gt; 34) &amp; <a class="code" href="../../d2/d3/fetypes_8h.html#a3">CONST_FORMAT</a>(0x000000000003));
00435   qp = (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)(OpCode &amp; <a class="code" href="../../d2/d3/fetypes_8h.html#a3">CONST_FORMAT</a>(0x00000000003F));
00436   <span class="keywordflow">if</span> (qp &gt;= 16) qp = 16 + (rrbpr + qp - 16) % 48;
00437 
00438   <span class="comment">// read predicate reg qp</span>
00439   ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o5">state_PR</a>[qp] = (<a class="code" href="../../d2/d3/fetypes_8h.html#a15">EM_boolean_t</a>)(((*ppreds) &gt;&gt; qp) &amp; 0x01);
00440 
00441   <span class="keywordflow">if</span> (ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o5">state_PR</a>[qp] == 0) {
00442 <span class="preprocessor">#ifdef DEBUG_UNIX</span>
00443 <span class="preprocessor"></span>    printf (<span class="stringliteral">"fp_emulate DEBUG: QUALIFYING PREDICATE %d IS 0\n"</span>, qp);
00444 <span class="preprocessor">#endif</span>
00445 <span class="preprocessor"></span><span class="preprocessor">#ifndef unix</span>
00446 <span class="preprocessor"></span>    <a class="code" href="../../d9/d1/fedefs_8h.html#a2">FP_EMULATION_ERROR1</a> (<span class="stringliteral">"fp_emulate () Internal Error: \</span>
00447 <span class="stringliteral">qualifying predicate PR[%2.2d] = 0\n"</span>, qp);
00448 <span class="preprocessor">#else</span>
00449 <span class="preprocessor"></span>    <a class="code" href="../../d9/d1/fedefs_8h.html#a2">FP_EMULATION_ERROR1</a> (<span class="stringliteral">"fp_emulate ()  Internal Error: \</span>
00450 <span class="stringliteral">qualifying predicate PR[%2.2d] = 0\n"</span>, qp);
00451     <span class="keywordflow">return</span> (<a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a2">FP_EMUL_ERROR</a>);
00452 <span class="preprocessor">#endif</span>
00453 <span class="preprocessor"></span>  }
00454 
00455   I_dis = sf != 0 &amp;&amp; ((<a class="code" href="../../d9/d2/festate_8h.html#a0">FPSR</a> &gt;&gt; (6 + 6 + 13 * (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)sf)) &amp; 0x01) || 
00456       ((<a class="code" href="../../d9/d2/festate_8h.html#a0">FPSR</a> &gt;&gt; 5) &amp; 0x01);
00457   U_dis = sf != 0 &amp;&amp; ((<a class="code" href="../../d9/d2/festate_8h.html#a0">FPSR</a> &gt;&gt; (6 + 6 + 13 * (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)sf)) &amp; 0x01) || 
00458       ((<a class="code" href="../../d9/d2/festate_8h.html#a0">FPSR</a> &gt;&gt; 4) &amp; 0x01);
00459   O_dis = sf != 0 &amp;&amp; ((<a class="code" href="../../d9/d2/festate_8h.html#a0">FPSR</a> &gt;&gt; (6 + 6 + 13 * (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)sf)) &amp; 0x01) || 
00460       ((<a class="code" href="../../d9/d2/festate_8h.html#a0">FPSR</a> &gt;&gt; 3) &amp; 0x01);
00461   Z_dis = sf != 0 &amp;&amp; ((<a class="code" href="../../d9/d2/festate_8h.html#a0">FPSR</a> &gt;&gt; (6 + 6 + 13 * (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)sf)) &amp; 0x01) || 
00462       ((<a class="code" href="../../d9/d2/festate_8h.html#a0">FPSR</a> &gt;&gt; 2) &amp; 0x01);
00463   D_dis = sf != 0 &amp;&amp; ((<a class="code" href="../../d9/d2/festate_8h.html#a0">FPSR</a> &gt;&gt; (6 + 6 + 13 * (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)sf)) &amp; 0x01) || 
00464       ((<a class="code" href="../../d9/d2/festate_8h.html#a0">FPSR</a> &gt;&gt; 1) &amp; 0x01);
00465   V_dis = sf != 0 &amp;&amp; ((<a class="code" href="../../d9/d2/festate_8h.html#a0">FPSR</a> &gt;&gt; (6 + 6 + 13 * (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)sf)) &amp; 0x01) || 
00466       (<a class="code" href="../../d9/d2/festate_8h.html#a0">FPSR</a> &amp; 0x01);
00467 
00468 
00469   <span class="keywordflow">if</span> ((trap_type == <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a5">FPFLT</a>) &amp;&amp;
00470       (ISRlow &amp; 0x0088)) { <span class="comment">// if this is a SWA fault</span>
00471 
00472     <span class="comment">// this will occur only for unnormal inputs for Merced, or for</span>
00473     <span class="comment">// architecturally mandated conditions for divide and square root</span>
00474     <span class="comment">// reciprocal approximations</span>
00475 
00476     <span class="comment">// decode the rest of the instruction</span>
00477     <span class="keywordflow">if</span> ((OpCode &amp; <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a10">F1_MIN_MASK</a>) == <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a11">F1_PATTERN</a>) {
00478       <span class="comment">// F1 instruction</span>
00479 
00480       <span class="comment">// extract f4, f3, f2, and f1</span>
00481       f4 = (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)((OpCode &gt;&gt; 27) &amp; <a class="code" href="../../d2/d3/fetypes_8h.html#a3">CONST_FORMAT</a>(0x00000000007F));
00482       <span class="keywordflow">if</span> (f4 &gt;= 32) f4 = 32 + (rrbfr + f4 - 32) % 96;
00483       f3 = (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)((OpCode &gt;&gt; 20) &amp; <a class="code" href="../../d2/d3/fetypes_8h.html#a3">CONST_FORMAT</a>(0x00000000007F));
00484       <span class="keywordflow">if</span> (f3 &gt;= 32) f3 = 32 + (rrbfr + f3 - 32) % 96;
00485       f2 = (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)((OpCode &gt;&gt; 13) &amp; <a class="code" href="../../d2/d3/fetypes_8h.html#a3">CONST_FORMAT</a>(0x00000000007F));
00486       <span class="keywordflow">if</span> (f2 &gt;= 32) f2 = 32 + (rrbfr + f2 - 32) % 96;
00487       f1 = (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)((OpCode &gt;&gt;  6) &amp; <a class="code" href="../../d2/d3/fetypes_8h.html#a3">CONST_FORMAT</a>(0x00000000007F));
00488       <span class="keywordflow">if</span> (f1 &gt;= 32) f1 = 32 + (rrbfr + f1 - 32) % 96;
00489 
00490 <span class="preprocessor">#ifdef DEBUG_UNIX</span>
00491 <span class="preprocessor"></span>printf (<span class="stringliteral">"DEBUG BEF. F1 SWA FAULT: f1 f2 f3 f4 = %x %x %x %x\n"</span>, f1, f2, f3, f4);
00492 <span class="preprocessor">#endif</span>
00493 <span class="preprocessor"></span>
00494       <span class="comment">// get source floating-point reg values</span>
00495       ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf2] = <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a84">FP128ToFPReg</a> (<a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a86">get_fp_register</a> (f2, fp_state));
00496       ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf3] = <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a84">FP128ToFPReg</a> (<a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a86">get_fp_register</a> (f3, fp_state));
00497       ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf4] = <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a84">FP128ToFPReg</a> (<a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a86">get_fp_register</a> (f4, fp_state));
00498 
00499 <span class="preprocessor">#ifdef DEBUG_UNIX</span>
00500 <span class="preprocessor"></span>printf (<span class="stringliteral">"DEBUG BEFORE F1 SWA FAULT: ps-&gt;state_FR[lf2] = %x %x %Lx\n"</span>,
00501   ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf2].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o2">sign</a>, ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf2].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o1">exponent</a>, ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf2].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o0">significand</a>);
00502 printf (<span class="stringliteral">"DEBUG BEFORE F1 SWA FAULT: ps-&gt;state_FR[lf3] = %x %x %Lx\n"</span>,
00503   ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf3].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o2">sign</a>, ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf3].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o1">exponent</a>, ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf3].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o0">significand</a>);
00504 printf (<span class="stringliteral">"DEBUG BEFORE F1 SWA FAULT: ps-&gt;state_FR[lf4] = %x %x %Lx\n"</span>,
00505   ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf4].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o2">sign</a>, ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf4].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o1">exponent</a>, ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf4].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o0">significand</a>);
00506 <span class="preprocessor">#endif</span>
00507 <span class="preprocessor"></span>
00508       <span class="keywordflow">switch</span> (OpCode &amp; <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a12">F1_MASK</a>) {
00509 
00510         <span class="keywordflow">case</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a13">FMA_PATTERN</a>:
00511           SIMD_instruction = 0;
00512           <a class="code" href="../../d6/d2/feproto_8h.html#a24">fma</a> (ps, <a class="code" href="../../d2/d3/fetypes_8h.html#a448a368">pc_sf</a>, sf, qp, lf1, lf3, lf4, lf2);
00513           <span class="keywordflow">break</span>;
00514         <span class="keywordflow">case</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a14">FMA_S_PATTERN</a>:
00515           SIMD_instruction = 0;
00516           <a class="code" href="../../d6/d2/feproto_8h.html#a24">fma</a> (ps, <a class="code" href="../../d2/d3/fetypes_8h.html#a448a366">pc_s</a>, sf, qp, lf1, lf3, lf4, lf2);
00517           <span class="keywordflow">break</span>;
00518         <span class="keywordflow">case</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a15">FMA_D_PATTERN</a>:
00519           SIMD_instruction = 0;
00520           <a class="code" href="../../d6/d2/feproto_8h.html#a24">fma</a> (ps, <a class="code" href="../../d2/d3/fetypes_8h.html#a448a367">pc_d</a>, sf, qp, lf1, lf3, lf4, lf2);
00521           <span class="keywordflow">break</span>;
00522         <span class="keywordflow">case</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a16">FPMA_PATTERN</a>:
00523           SIMD_instruction = 1;
00524           <a class="code" href="../../d6/d2/feproto_8h.html#a25">fpma</a> (ps, sf, qp, lf1, lf3, lf4, lf2);
00525           <span class="keywordflow">break</span>;
00526 
00527         <span class="keywordflow">case</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a17">FMS_PATTERN</a>:
00528           SIMD_instruction = 0;
00529           <a class="code" href="../../d6/d2/feproto_8h.html#a30">fms</a> (ps, <a class="code" href="../../d2/d3/fetypes_8h.html#a448a368">pc_sf</a>, sf, qp, lf1, lf3, lf4, lf2);
00530           <span class="keywordflow">break</span>;
00531         <span class="keywordflow">case</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a18">FMS_S_PATTERN</a>:
00532           SIMD_instruction = 0;
00533           <a class="code" href="../../d6/d2/feproto_8h.html#a30">fms</a> (ps, <a class="code" href="../../d2/d3/fetypes_8h.html#a448a366">pc_s</a>, sf, qp, lf1, lf3, lf4, lf2);
00534           <span class="keywordflow">break</span>;
00535         <span class="keywordflow">case</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a19">FMS_D_PATTERN</a>:
00536           SIMD_instruction = 0;
00537           <a class="code" href="../../d6/d2/feproto_8h.html#a30">fms</a> (ps, <a class="code" href="../../d2/d3/fetypes_8h.html#a448a367">pc_d</a>, sf, qp, lf1, lf3, lf4, lf2);
00538           <span class="keywordflow">break</span>;
00539         <span class="keywordflow">case</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a20">FPMS_PATTERN</a>:
00540           SIMD_instruction = 1;
00541           <a class="code" href="../../d6/d2/feproto_8h.html#a31">fpms</a> (ps, sf, qp, lf1, lf3, lf4, lf2);
00542           <span class="keywordflow">break</span>;
00543 
00544         <span class="keywordflow">case</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a21">FNMA_PATTERN</a>:
00545           SIMD_instruction = 0;
00546           <a class="code" href="../../d6/d2/feproto_8h.html#a32">fnma</a> (ps, <a class="code" href="../../d2/d3/fetypes_8h.html#a448a368">pc_sf</a>, sf, qp, lf1, lf3, lf4, lf2);
00547           <span class="keywordflow">break</span>;
00548         <span class="keywordflow">case</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a22">FNMA_S_PATTERN</a>:
00549           SIMD_instruction = 0;
00550           <a class="code" href="../../d6/d2/feproto_8h.html#a32">fnma</a> (ps, <a class="code" href="../../d2/d3/fetypes_8h.html#a448a366">pc_s</a>, sf, qp, lf1, lf3, lf4, lf2);
00551           <span class="keywordflow">break</span>;
00552         <span class="keywordflow">case</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a23">FNMA_D_PATTERN</a>:
00553           SIMD_instruction = 0;
00554           <a class="code" href="../../d6/d2/feproto_8h.html#a32">fnma</a> (ps, <a class="code" href="../../d2/d3/fetypes_8h.html#a448a367">pc_d</a>, sf, qp, lf1, lf3, lf4, lf2);
00555           <span class="keywordflow">break</span>;
00556         <span class="keywordflow">case</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a24">FPNMA_PATTERN</a>:
00557           SIMD_instruction = 1;
00558           <a class="code" href="../../d6/d2/feproto_8h.html#a33">fpnma</a> (ps, sf, qp, lf1, lf3, lf4, lf2);
00559           <span class="keywordflow">break</span>;
00560         <span class="keywordflow">default</span>:
00561           <span class="comment">// unrecognized instruction type</span>
00562 <span class="preprocessor">#ifndef unix</span>
00563 <span class="preprocessor"></span>          <a class="code" href="../../d9/d1/fedefs_8h.html#a2">FP_EMULATION_ERROR1</a> (<span class="stringliteral">"fp_emulate () Internal Error: \</span>
00564 <span class="stringliteral">instruction opcode %8x %8x not recognized\n"</span>, OpCode);
00565 <span class="preprocessor">#else</span>
00566 <span class="preprocessor"></span>          <a class="code" href="../../d9/d1/fedefs_8h.html#a2">FP_EMULATION_ERROR1</a> (<span class="stringliteral">"fp_emulate () Internal Error: \</span>
00567 <span class="stringliteral">instruction opcode %Lx not recognized\n"</span>, OpCode);
00568           <span class="keywordflow">return</span> (<a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a2">FP_EMUL_ERROR</a>);
00569 <span class="preprocessor">#endif</span>
00570 <span class="preprocessor"></span>
00571       }
00572 
00573       <span class="keywordflow">if</span> ((ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o8">state_MERCED_RTL</a> &gt;&gt; 16) &amp; 0x0ffff) <span class="keywordflow">goto</span> new_exception;
00574 
00575       <span class="comment">// successful emulation</span>
00576       <span class="comment">// set the destination floating-point reg value</span>
00577 <span class="preprocessor">#ifdef DEBUG_UNIX</span>
00578 <span class="preprocessor"></span>printf (<span class="stringliteral">"DEBUG AFTER F1 SWA FAULT: ps-&gt;state_FR[lf1] = %x %x %Lx\n"</span>,
00579   ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o2">sign</a>, ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o1">exponent</a>, 
00580   ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o0">significand</a>);
00581 <span class="preprocessor">#endif</span>
00582 <span class="preprocessor"></span>      <a class="code" href="../../d6/d5/ia64_2getsetrg_8c.html#a9">set_fp_register</a> (f1, <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a85">FPRegToFP128</a>(ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1]), fp_state);
00583       <span class="keywordflow">if</span> (f1 &lt; 32)
00584         *pipsr = *pipsr | (<a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a>)0x10; <span class="comment">// set mfl bit</span>
00585       <span class="keywordflow">else</span>
00586         *pipsr = *pipsr | (<a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a>)0x20; <span class="comment">// set mfh bit</span>
00587 
00588       *pfpsr =  ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o2">state_AR</a>[0].<a class="code" href="../../d9/d0/unionar__union.html#o1">uint_value</a>;
00589       <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00590 
00591 
00592     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((OpCode &amp; <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a25">F4_MIN_MASK</a>) == <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a26">F4_PATTERN</a>) {
00593       <span class="comment">// F4 instruction</span>
00594 
00595       <span class="comment">// extract p2, f3, f2, and p1</span>
00596       p2 = (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)((OpCode &gt;&gt; 27) &amp; <a class="code" href="../../d2/d3/fetypes_8h.html#a3">CONST_FORMAT</a>(0x00000000003f));
00597       <span class="keywordflow">if</span> (p2 &gt;= 16) p2 = 16 + (rrbpr + p2 - 16) % 48;
00598       f3 = (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)((OpCode &gt;&gt; 20) &amp; <a class="code" href="../../d2/d3/fetypes_8h.html#a3">CONST_FORMAT</a>(0x00000000007F));
00599       <span class="keywordflow">if</span> (f3 &gt;= 32) f3 = 32 + (rrbfr + f3 - 32) % 96;
00600       f2 = (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)((OpCode &gt;&gt; 13) &amp; <a class="code" href="../../d2/d3/fetypes_8h.html#a3">CONST_FORMAT</a>(0x00000000007F));
00601       <span class="keywordflow">if</span> (f2 &gt;= 32) f2 = 32 + (rrbfr + f2 - 32) % 96;
00602       p1 = (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)((OpCode &gt;&gt;  6) &amp; <a class="code" href="../../d2/d3/fetypes_8h.html#a3">CONST_FORMAT</a>(0x00000000003F));
00603       <span class="keywordflow">if</span> (p1 &gt;= 16) p1 = 16 + (rrbpr + p1 - 16) % 48;
00604 
00605       <span class="comment">// get source floating-point reg values</span>
00606       ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf2] = <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a84">FP128ToFPReg</a> (<a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a86">get_fp_register</a> (f2, fp_state));
00607       ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf3] = <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a84">FP128ToFPReg</a> (<a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a86">get_fp_register</a> (f3, fp_state));
00608 <span class="preprocessor">#ifdef DEBUG_UNIX</span>
00609 <span class="preprocessor"></span>printf (<span class="stringliteral">"DEBUG BEFORE F4 SWA FAULT: ps-&gt;state_FR[lf2] = %x %x %Lx\n"</span>,
00610   ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf2].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o2">sign</a>, ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf2].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o1">exponent</a>, ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf2].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o0">significand</a>);
00611 printf (<span class="stringliteral">"DEBUG BEFORE F4 SWA FAULT: ps-&gt;state_FR[lf3] = %x %x %Lx\n"</span>,
00612   ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf3].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o2">sign</a>, ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf3].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o1">exponent</a>, ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf3].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o0">significand</a>);
00613 <span class="preprocessor">#endif</span>
00614 <span class="preprocessor"></span>
00615       <span class="keywordflow">switch</span> (OpCode &amp; <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a27">F4_MASK</a>) {
00616 
00617         <span class="keywordflow">case</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a28">FCMP_EQ_PATTERN</a>:
00618           SIMD_instruction = 0;
00619           <a class="code" href="../../d6/d2/feproto_8h.html#a4">fcmp_eq</a> (ps, <a class="code" href="../../d2/d3/fetypes_8h.html#a450a383">ctype_none</a>, sf, qp, p1, p2, lf2, lf3);
00620           <span class="keywordflow">break</span>;
00621         <span class="keywordflow">case</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a29">FCMP_LT_PATTERN</a>:
00622           SIMD_instruction = 0;
00623           <a class="code" href="../../d6/d2/feproto_8h.html#a5">fcmp_lt</a> (ps, <a class="code" href="../../d2/d3/fetypes_8h.html#a450a383">ctype_none</a>, sf, qp, p1, p2, lf2, lf3);
00624           <span class="keywordflow">break</span>;
00625         <span class="keywordflow">case</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a30">FCMP_LE_PATTERN</a>:
00626           SIMD_instruction = 0;
00627           <a class="code" href="../../d6/d2/feproto_8h.html#a6">fcmp_le</a> (ps, <a class="code" href="../../d2/d3/fetypes_8h.html#a450a383">ctype_none</a>, sf, qp, p1, p2, lf2, lf3);
00628           <span class="keywordflow">break</span>;
00629         <span class="keywordflow">case</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a31">FCMP_UNORD_PATTERN</a>:
00630           SIMD_instruction = 0;
00631           <a class="code" href="../../d6/d2/feproto_8h.html#a7">fcmp_unord</a> (ps, <a class="code" href="../../d2/d3/fetypes_8h.html#a450a383">ctype_none</a>, sf, qp, p1, p2, lf2, lf3);
00632           <span class="keywordflow">break</span>;
00633 
00634         <span class="keywordflow">case</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a32">FCMP_EQ_UNC_PATTERN</a>:
00635           SIMD_instruction = 0;
00636           <a class="code" href="../../d6/d2/feproto_8h.html#a4">fcmp_eq</a> (ps, <a class="code" href="../../d2/d3/fetypes_8h.html#a450a376">fctypeUNC</a>, sf, qp, p1, p2, lf2, lf3);
00637           <span class="keywordflow">break</span>;
00638         <span class="keywordflow">case</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a33">FCMP_LT_UNC_PATTERN</a>:
00639           SIMD_instruction = 0;
00640           <a class="code" href="../../d6/d2/feproto_8h.html#a5">fcmp_lt</a> (ps, <a class="code" href="../../d2/d3/fetypes_8h.html#a450a376">fctypeUNC</a>, sf, qp, p1, p2, lf2, lf3);
00641           <span class="keywordflow">break</span>;
00642         <span class="keywordflow">case</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a34">FCMP_LE_UNC_PATTERN</a>:
00643           SIMD_instruction = 0;
00644           <a class="code" href="../../d6/d2/feproto_8h.html#a6">fcmp_le</a> (ps, <a class="code" href="../../d2/d3/fetypes_8h.html#a450a376">fctypeUNC</a>, sf, qp, p1, p2, lf2, lf3);
00645           <span class="keywordflow">break</span>;
00646         <span class="keywordflow">case</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a35">FCMP_UNORD_UNC_PATTERN</a>:
00647           SIMD_instruction = 0;
00648           <a class="code" href="../../d6/d2/feproto_8h.html#a7">fcmp_unord</a> (ps, <a class="code" href="../../d2/d3/fetypes_8h.html#a450a376">fctypeUNC</a>, sf, qp, p1, p2, lf2, lf3);
00649           <span class="keywordflow">break</span>;
00650         <span class="keywordflow">default</span>:
00651           <span class="comment">// unrecognized instruction type</span>
00652 <span class="preprocessor">#ifndef unix</span>
00653 <span class="preprocessor"></span>          <a class="code" href="../../d9/d1/fedefs_8h.html#a2">FP_EMULATION_ERROR1</a> (<span class="stringliteral">"fp_emulate () Internal Error: \</span>
00654 <span class="stringliteral">instruction opcode %8x %8x not recognized\n"</span>, OpCode);
00655 <span class="preprocessor">#else</span>
00656 <span class="preprocessor"></span>          <a class="code" href="../../d9/d1/fedefs_8h.html#a2">FP_EMULATION_ERROR1</a> (<span class="stringliteral">"fp_emulate () Internal Error: \</span>
00657 <span class="stringliteral">instruction opcode %Lx not recognized\n"</span>, OpCode);
00658           <span class="keywordflow">return</span> (<a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a2">FP_EMUL_ERROR</a>);
00659 <span class="preprocessor">#endif</span>
00660 <span class="preprocessor"></span>
00661       }
00662 
00663       <span class="keywordflow">if</span> ((ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o8">state_MERCED_RTL</a> &gt;&gt; 16) &amp; 0x0ffff) <span class="keywordflow">goto</span> new_exception;
00664 
00665       <span class="comment">// successful emulation</span>
00666       <span class="comment">// set the destination predicate reg values</span>
00667       *ppreds &amp;= (~(((<a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a>)1) &lt;&lt; (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)p1));
00668       *ppreds |= (((<a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a>)(ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o5">state_PR</a>[p1] &amp; 0x01)) &lt;&lt; (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)p1);
00669       *ppreds &amp;= (~(((<a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a>)1) &lt;&lt; (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)p2));
00670       *ppreds |= (((<a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a>)(ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o5">state_PR</a>[p2] &amp; 0x01)) &lt;&lt; (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)p2);
00671       *pfpsr =  ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o2">state_AR</a>[0].<a class="code" href="../../d9/d0/unionar__union.html#o1">uint_value</a>;
00672 <span class="preprocessor">#ifdef DEBUG_UNIX</span>
00673 <span class="preprocessor"></span>printf (<span class="stringliteral">"DEBUG AFTER F4 SWA FAULT: *ppreds = %Lx\n"</span>, (*ppreds));
00674 <span class="preprocessor">#endif</span>
00675 <span class="preprocessor"></span>      <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00676 
00677     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((OpCode &amp; <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a36">F6_MIN_MASK</a>) == <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a37">F6_PATTERN</a>) {
00678       <span class="comment">// F6 instruction</span>
00679       <span class="keywordflow">switch</span> (OpCode &amp; <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a38">F6_MASK</a>) {
00680 
00681         <span class="keywordflow">case</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a39">FRCPA_PATTERN</a>:
00682           SIMD_instruction = 0;
00683           <span class="keywordflow">break</span>;
00684         <span class="keywordflow">case</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a40">FPRCPA_PATTERN</a>:
00685           SIMD_instruction = 1;
00686           <span class="keywordflow">break</span>;
00687         <span class="keywordflow">default</span>:
00688           <span class="comment">// unrecognized instruction type</span>
00689 <span class="preprocessor">#ifndef unix</span>
00690 <span class="preprocessor"></span>          <a class="code" href="../../d9/d1/fedefs_8h.html#a2">FP_EMULATION_ERROR1</a> (<span class="stringliteral">"fp_emulate () Internal Error: \</span>
00691 <span class="stringliteral">instruction opcode %8x %8x not recognized\n"</span>, OpCode);
00692 <span class="preprocessor">#else</span>
00693 <span class="preprocessor"></span>          <a class="code" href="../../d9/d1/fedefs_8h.html#a2">FP_EMULATION_ERROR1</a> (<span class="stringliteral">"fp_emulate () Internal Error: \</span>
00694 <span class="stringliteral">instruction opcode %Lx not recognized\n"</span>, OpCode);
00695           <span class="keywordflow">return</span> (<a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a2">FP_EMUL_ERROR</a>);
00696 <span class="preprocessor">#endif</span>
00697 <span class="preprocessor"></span>      }
00698 
00699       <span class="comment">// extract the ftz bit</span>
00700       ftz = (<span class="keywordtype">int</span>)((<a class="code" href="../../d9/d2/festate_8h.html#a0">FPSR</a> &gt;&gt; 6) &amp; 0x01);
00701 
00702       <span class="comment">// extract the rounding mode</span>
00703       rc = (<a class="code" href="../../d2/d3/fetypes_8h.html#a455">EM_sf_rc_type</a>)((<a class="code" href="../../d9/d2/festate_8h.html#a0">FPSR</a> &gt;&gt; (6 + 4 + 13 * (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)sf)) &amp; 0x03);
00704 
00705       <span class="comment">// extract p2, f3, f2, and f1</span>
00706       p2 = (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)((OpCode &gt;&gt; 27) &amp; <a class="code" href="../../d2/d3/fetypes_8h.html#a3">CONST_FORMAT</a>(0x00000000003f));
00707       <span class="keywordflow">if</span> (p2 &gt;= 16) p2 = 16 + (rrbpr + p2 - 16) % 48;
00708       f3 = (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)((OpCode &gt;&gt; 20) &amp; <a class="code" href="../../d2/d3/fetypes_8h.html#a3">CONST_FORMAT</a>(0x00000000007F));
00709       <span class="keywordflow">if</span> (f3 &gt;= 32) f3 = 32 + (rrbfr + f3 - 32) % 96;
00710       f2 = (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)((OpCode &gt;&gt; 13) &amp; <a class="code" href="../../d2/d3/fetypes_8h.html#a3">CONST_FORMAT</a>(0x00000000007F));
00711       <span class="keywordflow">if</span> (f2 &gt;= 32) f2 = 32 + (rrbfr + f2 - 32) % 96;
00712       f1 = (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)((OpCode &gt;&gt;  6) &amp; <a class="code" href="../../d2/d3/fetypes_8h.html#a3">CONST_FORMAT</a>(0x00000000007F));
00713       <span class="keywordflow">if</span> (f1 &gt;= 32) f1 = 32 + (rrbfr + f1 - 32) % 96;
00714 
00715       <span class="comment">// get source floating-point reg values</span>
00716       ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf2] = <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a84">FP128ToFPReg</a> (<a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a86">get_fp_register</a> (f2, fp_state));
00717       ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf3] = <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a84">FP128ToFPReg</a> (<a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a86">get_fp_register</a> (f3, fp_state));
00718 <span class="preprocessor">#ifdef DEBUG_UNIX</span>
00719 <span class="preprocessor"></span>printf (<span class="stringliteral">"DEBUG BEFORE F6 SWA FAULT: ps-&gt;state_FR[lf2] = %x %x %Lx\n"</span>,
00720   ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf2].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o2">sign</a>, ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf2].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o1">exponent</a>, ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf2].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o0">significand</a>);
00721 printf (<span class="stringliteral">"DEBUG BEFORE F6 SWA FAULT: ps-&gt;state_FR[lf3] = %x %x %Lx\n"</span>,
00722   ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf3].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o2">sign</a>, ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf3].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o1">exponent</a>, ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf3].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o0">significand</a>);
00723 <span class="preprocessor">#endif</span>
00724 <span class="preprocessor"></span>
00725       <span class="keywordflow">switch</span> (OpCode &amp; <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a38">F6_MASK</a>) {
00726 
00727         <span class="keywordflow">case</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a39">FRCPA_PATTERN</a>:
00728 
00729           <span class="comment">// extract sign, exponent, and significand of a</span>
00730           sign_a = (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf2].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o2">sign</a>;
00731           exponent_a = (<a class="code" href="../../d2/d3/fetypes_8h.html#a11">EM_int_t</a>)ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf2].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o1">exponent</a>;
00732           significand_a = ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf2].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o0">significand</a>;
00733 
00734           <span class="comment">// extract sign, exponent, and significand of b</span>
00735           <span class="comment">// note that b cannot be 0</span>
00736           sign_b = (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf3].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o2">sign</a>;
00737           exponent_b = (<a class="code" href="../../d2/d3/fetypes_8h.html#a11">EM_int_t</a>)ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf3].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o1">exponent</a>;
00738           significand_b = ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf3].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o0">significand</a>;
00739 
00740           <span class="comment">// if any of a or b is zero or pseudo-zero, return the result</span>
00741           <span class="keywordflow">if</span> (significand_a == 0 || significand_b == 0) {
00742 
00743             <a class="code" href="../../d6/d2/feproto_8h.html#a34">frcpa</a> (ps, sf, qp, lf1, p2, lf2, lf3);
00744 
00745             <span class="keywordflow">if</span> ((ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o8">state_MERCED_RTL</a> &gt;&gt; 16) &amp; 0x0ffff) <span class="keywordflow">goto</span> new_exception;
00746 
00747             *pfpsr =  ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o2">state_AR</a>[0].<a class="code" href="../../d9/d0/unionar__union.html#o1">uint_value</a>;
00748 
00749             <span class="comment">// set the destination floating-point and predicate reg values</span>
00750 <span class="preprocessor">#ifdef DEBUG_UNIX</span>
00751 <span class="preprocessor"></span>printf (<span class="stringliteral">"DEBUG AFTER F6 SWA FAULT FOR a OR b ZERO/PSEUDO-ZERO: ps-&gt;state_FR[lf1] = %x %x %Lx\n"</span>,
00752   ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o2">sign</a>, ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o1">exponent</a>,
00753   ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o0">significand</a>);
00754 <span class="preprocessor">#endif</span>
00755 <span class="preprocessor"></span>            <a class="code" href="../../d6/d5/ia64_2getsetrg_8c.html#a9">set_fp_register</a> (f1, <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a85">FPRegToFP128</a>(ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1]), fp_state);
00756             <span class="keywordflow">if</span> (f1 &lt; 32)
00757               *pipsr = *pipsr | (<a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a>)0x10; <span class="comment">// set mfl bit</span>
00758             <span class="keywordflow">else</span>
00759               *pipsr = *pipsr | (<a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a>)0x20; <span class="comment">// set mfh bit</span>
00760             <span class="comment">// ps-&gt;state_PR[p2] = 0 for a or b zero or pseudo-zero</span>
00761             *ppreds &amp;= (~(((<a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a>)1) &lt;&lt; (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)p2));
00762 <span class="preprocessor">#ifdef DEBUG_UNIX</span>
00763 <span class="preprocessor"></span>printf (<span class="stringliteral">"DEBUG AFTER F6 SWA FAULT FOR a OR b ZERO/PSEUDO-ZERO: p2 = %x\n"</span>, p2);
00764 <span class="preprocessor">#endif</span>
00765 <span class="preprocessor"></span><span class="preprocessor">#ifdef DEBUG_UNIX</span>
00766 <span class="preprocessor"></span>printf (<span class="stringliteral">"DEBUG AFTER F6 SWA FAULT FOR a OR b ZERO/PSEUDO-ZERO: *ppreds = %Lx\n"</span>,
00767  *ppreds);
00768 <span class="preprocessor">#endif</span>
00769 <span class="preprocessor"></span>            <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00770 
00771           }
00772 
00773           <span class="comment">// if any of a or b is infinity, return the result</span>
00774           <span class="keywordflow">if</span> (exponent_a == 0x1ffff &amp;&amp; 
00775               significand_a == <a class="code" href="../../d2/d3/fetypes_8h.html#a3">CONST_FORMAT</a>(0x8000000000000000) || 
00776               exponent_b == 0x1ffff &amp;&amp; 
00777               significand_b == <a class="code" href="../../d2/d3/fetypes_8h.html#a3">CONST_FORMAT</a>(0x8000000000000000)) {
00778 
00779             <a class="code" href="../../d6/d2/feproto_8h.html#a34">frcpa</a> (ps, sf, qp, lf1, p2, lf2, lf3);
00780 
00781             <span class="keywordflow">if</span> ((ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o8">state_MERCED_RTL</a> &gt;&gt; 16) &amp; 0x0ffff) <span class="keywordflow">goto</span> new_exception;
00782                 <span class="comment">// will never happen</span>
00783 
00784             *pfpsr =  ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o2">state_AR</a>[0].<a class="code" href="../../d9/d0/unionar__union.html#o1">uint_value</a>;
00785 
00786             <span class="comment">// set the destination floating-point and predicate reg values</span>
00787 <span class="preprocessor">#ifdef DEBUG_UNIX</span>
00788 <span class="preprocessor"></span>printf (<span class="stringliteral">"DEBUG AFTER F6 SWA FAULT FOR a OR b INFINITY: ps-&gt;state_FR[lf1] = %x %x %Lx\n"</span>,
00789   ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o2">sign</a>, ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o1">exponent</a>,
00790   ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o0">significand</a>);
00791 <span class="preprocessor">#endif</span>
00792 <span class="preprocessor"></span>            <a class="code" href="../../d6/d5/ia64_2getsetrg_8c.html#a9">set_fp_register</a> (f1, <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a85">FPRegToFP128</a>(ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1]), fp_state);
00793             <span class="keywordflow">if</span> (f1 &lt; 32)
00794               *pipsr = *pipsr | (<a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a>)0x10; <span class="comment">// set mfl bit</span>
00795             <span class="keywordflow">else</span>
00796               *pipsr = *pipsr | (<a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a>)0x20; <span class="comment">// set mfh bit</span>
00797 
00798             <span class="comment">// ps-&gt;state_PR[p2] = 0; clear the output predicate for a or b inf</span>
00799             *ppreds &amp;= (~(((<a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a>)1) &lt;&lt; (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)p2));
00800 <span class="preprocessor">#ifdef DEBUG_UNIX</span>
00801 <span class="preprocessor"></span>printf (<span class="stringliteral">"DEBUG AFTER F6 SWA FAULT FOR a OR b INFINITY: p2 = %x\n"</span>, p2);
00802 <span class="preprocessor">#endif</span>
00803 <span class="preprocessor"></span><span class="preprocessor">#ifdef DEBUG_UNIX</span>
00804 <span class="preprocessor"></span>printf (<span class="stringliteral">"DEBUG AFTER F6 SWA FAULT FOR a OR b INFINITY: *ppreds = %Lx\n"</span>,
00805  *ppreds);
00806 <span class="preprocessor">#endif</span>
00807 <span class="preprocessor"></span>            <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00808 
00809           }
00810 
00811           <span class="comment">// a and b are not [pseudo]0, and are not special (a and be are</span>
00812           <span class="comment">// normal or unnormal [denormal] floating-point numbers)</span>
00813 
00814           <span class="keywordflow">if</span> (exponent_a == 0) exponent_a = 0xc001;
00815               <span class="comment">// this covers double-extended real [pseudo-]denormals</span>
00816           <span class="comment">// un-bias the exponent of a</span>
00817           exponent_a = exponent_a - 0xffff;
00818 
00819           <span class="keywordflow">if</span> (exponent_b == 0) exponent_b = 0xc001;
00820               <span class="comment">// this covers double-extended real [pseudo-]denormals</span>
00821           <span class="comment">// un-bias the exponent of b</span>
00822           exponent_b = exponent_b - 0xffff;
00823 
00824           unnormal = 0;
00825           <span class="comment">// check whether a is unnormal; will set D in FPSR.sfx if true</span>
00826           <span class="comment">// and denormal exceptions are disabled</span>
00827           <span class="keywordflow">if</span> (!(significand_a &amp; <a class="code" href="../../d2/d3/fetypes_8h.html#a3">CONST_FORMAT</a>(0x8000000000000000))) {
00828             unnormal = 1;
00829           }
00830           <span class="comment">// check whether b is unnormal; will set D in FPSR.sfx if true</span>
00831           <span class="comment">// and denormal exceptions are disabled</span>
00832           <span class="keywordflow">if</span> (!(significand_b &amp; <a class="code" href="../../d2/d3/fetypes_8h.html#a3">CONST_FORMAT</a>(0x8000000000000000))) {
00833             unnormal = 1;
00834           }
00835 <span class="preprocessor">#ifdef DEBUG_UNIX</span>
00836 <span class="preprocessor"></span><span class="keywordflow">if</span> (unnormal) printf (<span class="stringliteral">"DEBUG F6 FRCPA SWA FAULT: unnormal = 1\n"</span>);
00837 <span class="preprocessor">#endif</span>
00838 <span class="preprocessor"></span>
00839           <span class="keywordflow">if</span> (unnormal &amp;&amp; !D_dis) {
00840             ISRlow = 0x0002; <span class="comment">// denormal bit set</span>
00841             *pisr = ((*pisr) &amp; 0xffffffffffff0000) | ISRlow;
00842             <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>); <span class="comment">// will raise D fault</span>
00843           }
00844 
00845           <span class="comment">// normalize a (even if exponent_a becomes less than e_min)</span>
00846           <span class="keywordflow">while</span> (!(significand_a &amp; <a class="code" href="../../d2/d3/fetypes_8h.html#a3">CONST_FORMAT</a>(0x8000000000000000))) {
00847             significand_a = significand_a &lt;&lt; 1;
00848             exponent_a--;
00849           }
00850 
00851           <span class="comment">// normalize b (even if exponent_b becomes less than e_min)</span>
00852           <span class="keywordflow">while</span> (!(significand_b &amp; <a class="code" href="../../d2/d3/fetypes_8h.html#a3">CONST_FORMAT</a>(0x8000000000000000))) {
00853             significand_b = significand_b &lt;&lt; 1;
00854             exponent_b--;
00855           }
00856 
00857           <span class="comment">// Case (I) and Case (II)</span>
00858           <span class="comment">// |a/b| &gt; MAXFP ==&gt; might have O or I traps</span>
00859 
00860           <span class="keywordflow">if</span> ((exponent_b &lt;= exponent_a - <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a8">FP_REG_EMAX</a> - 2) ||
00861             (exponent_b == exponent_a - <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a8">FP_REG_EMAX</a> - 1) &amp;&amp;
00862             (significand_a &gt;= significand_b)) {
00863 
00864 <span class="preprocessor">#ifdef DEBUG_UNIX</span>
00865 <span class="preprocessor"></span>printf (<span class="stringliteral">"DEBUG: BEGIN F6 SWA FAULT CASE (I) - (II)\n"</span>);
00866 <span class="preprocessor">#endif</span>
00867 <span class="preprocessor"></span>
00868             <span class="comment">// scale a to a' and b to b', such that c' = a'/ b' will be</span>
00869             <span class="comment">// normal </span>
00870 
00871             <span class="comment">// set the scaled (possibly normalized) value of a' (sign ok)</span>
00872             ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf2].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o1">exponent</a> = (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)(0xffff);
00873             ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf2].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o0">significand</a> = significand_a;
00874 
00875             <span class="comment">// set the scaled (possibly normalized) value of b' (sign ok)</span>
00876             ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf3].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o1">exponent</a> = (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)(0xffff);
00877             ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf3].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o0">significand</a> = significand_b;
00878 
00879             <span class="comment">// convert a' and b' to FLOAT128</span>
00880             a_float128 = <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a85">FPRegToFP128</a> (ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf2]);
00881             b_float128 = <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a85">FPRegToFP128</a> (ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf3]);
00882 
00883             <span class="comment">// invoke the divide algorithm to calculate c' = a' / b';</span>
00884             <span class="comment">// the algorithm uses sf0 with user settings, and sf1 with</span>
00885             <span class="comment">// rn, 64-bits, wre, traps disabled;</span>
00886             <span class="comment">// copy FPSR.sfx with clear flags to FPSR1.sf0; rn,64,wre in sf1</span>
00887             FPSR1 = (<a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a>)((<a class="code" href="../../d9/d2/festate_8h.html#a0">FPSR</a> &gt;&gt; ((<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)sf * 13)) &amp; 0x01fc0)
00888                 | 0x000000000270003f; <span class="comment">// set sf0,sf1 and disable fp exceptions</span>
00889             <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a89">thmF</a> (&amp;FPSR1, &amp;a_float128, &amp;b_float128, &amp;c_float128);
00890             I_flag = FPSR1 &amp; 0x40000 ? 1 : 0;
00891 
00892             <span class="keywordflow">if</span> (O_dis &amp;&amp; (I_dis || !I_flag)) {
00893 
00894               <span class="comment">// overflow exceptions are disabled and (inexact exceptions</span>
00895               <span class="comment">// are disabled or the result is exact) =&gt; return the </span>
00896               <span class="comment">// IEEE mandated result</span>
00897 
00898               <span class="keywordflow">if</span> (sign_a ^ sign_b) { <span class="comment">// opposite signs</span>
00899                 <span class="keywordflow">if</span> (rc == <a class="code" href="../../d2/d3/fetypes_8h.html#a455a412">rc_rn</a> || rc == <a class="code" href="../../d2/d3/fetypes_8h.html#a455a413">rc_rm</a>) {
00900                   <span class="comment">// -Inf</span>
00901                   ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o2">sign</a> = 1;
00902                   ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o1">exponent</a> = 0x1ffff;
00903                   ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o0">significand</a> = 
00904                       <a class="code" href="../../d2/d3/fetypes_8h.html#a3">CONST_FORMAT</a>(0x8000000000000000);
00905                 } <span class="keywordflow">else</span> { <span class="comment">// if (rc == rc_rp || rc == rc_rz)</span>
00906                   <span class="comment">// -MAX_FP_REG_VAL</span>
00907                   ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o2">sign</a> = 1;
00908                   ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o1">exponent</a> = 0x1fffe;
00909                   ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o0">significand</a> = 
00910                       <a class="code" href="../../d2/d3/fetypes_8h.html#a3">CONST_FORMAT</a>(0xffffffffffffffff);
00911                 }
00912               } <span class="keywordflow">else</span> { <span class="comment">// same sign</span>
00913                 <span class="keywordflow">if</span> (rc == <a class="code" href="../../d2/d3/fetypes_8h.html#a455a412">rc_rn</a> || rc == <a class="code" href="../../d2/d3/fetypes_8h.html#a455a414">rc_rp</a>) {
00914                   <span class="comment">// Inf</span>
00915                   ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o2">sign</a> = 0;
00916                   ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o1">exponent</a> = 0x1ffff;
00917                   ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o0">significand</a> = 
00918                       <a class="code" href="../../d2/d3/fetypes_8h.html#a3">CONST_FORMAT</a>(0x8000000000000000);
00919                 } <span class="keywordflow">else</span> { <span class="comment">// if (rc == rc_rm || rc == rc_rz)</span>
00920                   <span class="comment">// MAX_FP_REG_VAL</span>
00921                   ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o2">sign</a> = 0;
00922                   ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o1">exponent</a> = 0x1fffe;
00923                   ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o0">significand</a> = 
00924                       <a class="code" href="../../d2/d3/fetypes_8h.html#a3">CONST_FORMAT</a>(0xffffffffffffffff);
00925                 }
00926               }
00927 
00928               <span class="comment">// set D in FPSR.sfx if any of a and b was unnormal</span>
00929               <span class="keywordflow">if</span> (unnormal) {
00930                 <span class="comment">// set D = 1 in *pfpsr</span>
00931                 *pfpsr = *pfpsr |
00932                     ((<a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a>)1 &lt;&lt; (6 + (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)sf * 13 + 8));
00933               }
00934 
00935               <span class="comment">// set I = 1 and O = 1 in *pfpsr</span>
00936               <span class="comment">// set O = 1</span>
00937               *pfpsr = *pfpsr | 
00938                   ((<a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a>)1 &lt;&lt; (6 + (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)sf * 13 + 10));
00939               <span class="comment">// set I = 1</span>
00940               *pfpsr = *pfpsr |
00941                   ((<a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a>)1 &lt;&lt; (6 + (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)sf * 13 + 12));
00942               <span class="comment">// set the destination floating-point and predicate reg values</span>
00943 <span class="preprocessor">#ifdef DEBUG_UNIX</span>
00944 <span class="preprocessor"></span>printf (<span class="stringliteral">"DEBUG Case (I), (II) AFTER F6 SWA FAULT 1: ps-&gt;state_FR[lf1] = %x %x %Lx\n"</span>,
00945 ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o2">sign</a>, ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o1">exponent</a>, 
00946 ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o0">significand</a>);
00947 <span class="preprocessor">#endif</span>
00948 <span class="preprocessor"></span>              <a class="code" href="../../d6/d5/ia64_2getsetrg_8c.html#a9">set_fp_register</a> (f1, <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a85">FPRegToFP128</a>(ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1]), fp_state);
00949               <span class="keywordflow">if</span> (f1 &lt; 32)
00950                 *pipsr = *pipsr | (<a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a>)0x10; <span class="comment">// set mfl bit</span>
00951               <span class="keywordflow">else</span>
00952                 *pipsr = *pipsr | (<a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a>)0x20; <span class="comment">// set mfh bit</span>
00953 
00954               <span class="comment">// ps-&gt;state_PR[p2] = 0; clear the output predicate</span>
00955               *ppreds &amp;= (~(((<a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a>)1) &lt;&lt; (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)p2));
00956 <span class="preprocessor">#ifdef DEBUG_UNIX</span>
00957 <span class="preprocessor"></span>printf (<span class="stringliteral">"DEBUG Case (I), (II) AFTER F6 SWA FAULT 1 a: *ppreds = %Lx\n"</span>,
00958 *ppreds);
00959 <span class="preprocessor">#endif</span>
00960 <span class="preprocessor"></span>              <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00961 
00962             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!O_dis) {
00963 
00964               <span class="comment">// overflow exceptions are enabled =&gt; compute the result, and</span>
00965               <span class="comment">// propagate an overflow exception (deliver the result with</span>
00966               <span class="comment">// the exponent mod 2^17</span>
00967 
00968               <span class="comment">// convert c' (normal fp#) from FLOAT128 to EM_fp_reg_type</span>
00969               ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1] = <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a84">FP128ToFPReg</a> (c_float128);
00970               <span class="comment">// scale c' to c and take the mod 2^17 exponent</span>
00971               exponent_c = (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o1">exponent</a> + 
00972                   exponent_a - exponent_b;
00973               ISRlow = 0x0801; <span class="comment">// O = 1</span>
00974               ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o1">exponent</a> = exponent_c &amp; 0x1ffff;
00975 
00976               <span class="comment">// determine fpa, and set the values of I and fpa in ISRlow</span>
00977               <span class="comment">// if (I_flag == 0) fpa = 0</span>
00978               <span class="keywordflow">if</span> (I_flag == 1) {
00979 
00980                 <span class="comment">// calculate d' = |b'| * |c'| - |a'| to determine fpa</span>
00981                 c_float128.hiFlt64 = c_float128.hiFlt64 &amp; 
00982                     <a class="code" href="../../d2/d3/fetypes_8h.html#a3">CONST_FORMAT</a>(0x000000000001ffff); <span class="comment">// take |c'|</span>
00983                 b_float128.hiFlt64 = b_float128.hiFlt64 &amp; 
00984                     <a class="code" href="../../d2/d3/fetypes_8h.html#a3">CONST_FORMAT</a>(0x000000000001ffff); <span class="comment">// take |b'|</span>
00985                 a_float128.hiFlt64 = a_float128.hiFlt64 &amp; 
00986                     <a class="code" href="../../d2/d3/fetypes_8h.html#a3">CONST_FORMAT</a>(0x000000000001ffff); <span class="comment">// take |a'|</span>
00987 
00988                 FPSR1 = <a class="code" href="../../d2/d3/fetypes_8h.html#a3">CONST_FORMAT</a>(0x00000000000003bf); <span class="comment">// rn,64,wre=1,dis</span>
00989                 <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a88">run_fms</a> (&amp;FPSR1, &amp;d_float128, &amp;b_float128, &amp;c_float128, 
00990                     &amp;a_float128); <span class="comment">// d' = |b'| * |c'| - |a'|</span>
00991 
00992                 <span class="keywordflow">if</span> (d_float128.hiFlt64 &amp; <a class="code" href="../../d2/d3/fetypes_8h.html#a3">CONST_FORMAT</a>(0x020000)) {
00993                   <span class="comment">// if d' &lt; 0, I = 1 and fpa = 0</span>
00994                   ISRlow = ISRlow | 0x2000;
00995                 } <span class="keywordflow">else</span> {
00996                   <span class="comment">// if d' &gt; 0, I = 1 and fpa = 1</span>
00997                   ISRlow = ISRlow | 0x6000;
00998                 }
00999 
01000               }
01001 
01002               <span class="comment">// set the destination floating-point and predicate reg values</span>
01003               *pisr = ((*pisr) &amp; 0xffffffffffff0000) | ISRlow;
01004 
01005 <span class="preprocessor">#ifdef DEBUG_UNIX</span>
01006 <span class="preprocessor"></span>printf (<span class="stringliteral">"DEBUG Case (I), (II) AFTER F6 SWA FAULT 2: ps-&gt;state_FR[lf1] = %x %x %Lx\n"</span>,
01007 ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o2">sign</a>, ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o1">exponent</a>, 
01008 ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o0">significand</a>);
01009 <span class="preprocessor">#endif</span>
01010 <span class="preprocessor"></span>              <a class="code" href="../../d6/d5/ia64_2getsetrg_8c.html#a9">set_fp_register</a> (f1, <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a85">FPRegToFP128</a>(ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1]), fp_state);
01011               <span class="keywordflow">if</span> (f1 &lt; 32)
01012                 *pipsr = *pipsr | (<a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a>)0x10; <span class="comment">// set mfl bit</span>
01013               <span class="keywordflow">else</span>
01014                 *pipsr = *pipsr | (<a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a>)0x20; <span class="comment">// set mfh bit</span>
01015 
01016               <span class="comment">// ps-&gt;state_PR[p2] = 0; clear the output predicate</span>
01017               <span class="comment">// update (*ppreds) [as if O disabled]</span>
01018               *ppreds &amp;= (~(((<a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a>)1) &lt;&lt; (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)p2));
01019 <span class="preprocessor">#ifdef DEBUG_UNIX</span>
01020 <span class="preprocessor"></span>printf (<span class="stringliteral">"DEBUG Case (I), (II) AFTER F6 SWA FAULT 2 a: *ppreds = %Lx\n"</span>, *ppreds);
01021 <span class="preprocessor">#endif</span>
01022 <span class="preprocessor"></span>              <span class="comment">// update *pfpsr</span>
01023               <span class="comment">// set D in FPSR.sfx if any of a and b was unnormal</span>
01024               <span class="keywordflow">if</span> (unnormal) {
01025                 <span class="comment">// set D = 1 in *pfpsr</span>
01026                 *pfpsr = *pfpsr |
01027                     ((<a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a>)1 &lt;&lt; (6 + (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)sf * 13 + 8));
01028               }
01029               <span class="comment">// set O = 1</span>
01030               *pfpsr = *pfpsr |
01031                   ((<a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a>)1 &lt;&lt; (6 + (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)sf * 13 + 10));
01032               <span class="comment">// set I = 1 if I_flag = 1</span>
01033               <span class="keywordflow">if</span> (I_flag) *pfpsr = *pfpsr |
01034                   ((<a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a>)1 &lt;&lt; (6 + (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)sf * 13 + 12));
01035 
01036               <span class="comment">// caller will advance instruction pointer</span>
01037               <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> | <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a3">FAULT_TO_TRAP</a>); <span class="comment">// will raise O trap</span>
01038 
01039             } <span class="keywordflow">else</span> { <span class="comment">// if (!I_dis &amp;&amp; I_flag)</span>
01040 
01041               <span class="comment">// overflow exceptions are disabled, but the inexact </span>
01042               <span class="comment">// exceptions are enabled and the result is inexact =&gt; </span>
01043               <span class="comment">// provide the IEEE mandated result, and</span>
01044               <span class="comment">// propagate an inexact exception</span>
01045 
01046               <span class="keywordflow">if</span> (sign_a ^ sign_b) { <span class="comment">// opposite signs</span>
01047                 <span class="keywordflow">if</span> (rc == <a class="code" href="../../d2/d3/fetypes_8h.html#a455a412">rc_rn</a> || rc == <a class="code" href="../../d2/d3/fetypes_8h.html#a455a413">rc_rm</a>) {
01048                   <span class="comment">// -Inf</span>
01049                   ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o2">sign</a> = 1;
01050                   ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o1">exponent</a> = 0x1ffff;
01051                   ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o0">significand</a> = 
01052                       <a class="code" href="../../d2/d3/fetypes_8h.html#a3">CONST_FORMAT</a>(0x8000000000000000);
01053                   fpa = 1;
01054                 } <span class="keywordflow">else</span> { <span class="comment">// if (rc == rc_rp || rc == rc_rz)</span>
01055                   <span class="comment">// -MAX_FP_REG_VAL</span>
01056                   ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o2">sign</a> = 1;
01057                   ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o1">exponent</a> = 0x1fffe;
01058                   ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o0">significand</a> = 
01059                       <a class="code" href="../../d2/d3/fetypes_8h.html#a3">CONST_FORMAT</a>(0xffffffffffffffff);
01060                   fpa = 0;
01061                 }
01062               } <span class="keywordflow">else</span> { <span class="comment">// same sign</span>
01063                 <span class="keywordflow">if</span> (rc == <a class="code" href="../../d2/d3/fetypes_8h.html#a455a412">rc_rn</a> || rc == <a class="code" href="../../d2/d3/fetypes_8h.html#a455a414">rc_rp</a>) {
01064                   <span class="comment">// Inf</span>
01065                   ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o2">sign</a> = 0;
01066                   ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o1">exponent</a> = 0x1ffff;
01067                   ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o0">significand</a> = 
01068                       <a class="code" href="../../d2/d3/fetypes_8h.html#a3">CONST_FORMAT</a>(0x8000000000000000);
01069                   fpa = 1;
01070                 } <span class="keywordflow">else</span> { <span class="comment">// if (rc == rc_rm || rc == rc_rz)</span>
01071                   <span class="comment">// MAX_FP_REG_VAL</span>
01072                   ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o2">sign</a> = 0;
01073                   ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o1">exponent</a> = 0x1fffe;
01074                   ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o0">significand</a> = 
01075                       <a class="code" href="../../d2/d3/fetypes_8h.html#a3">CONST_FORMAT</a>(0xffffffffffffffff);
01076                   fpa = 0;
01077                 }
01078               }
01079 
01080               ISRlow = 0x2001 | (fpa == 1 ? 0x4000 : 0x0000); <span class="comment">// I = 1 and fpa</span>
01081               *pisr = ((*pisr) &amp; 0xffffffffffff0000) | ISRlow;
01082 
01083               <span class="comment">// set the destination floating-point and predicate reg values</span>
01084 <span class="preprocessor">#ifdef DEBUG_UNIX</span>
01085 <span class="preprocessor"></span>printf (<span class="stringliteral">"DEBUG Case (I), (II) AFTER F6 SWA FAULT 3: ps-&gt;state_FR[lf1] = %x %x %Lx\n"</span>,
01086 ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o2">sign</a>, ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o1">exponent</a>, 
01087 ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o0">significand</a>);
01088 <span class="preprocessor">#endif</span>
01089 <span class="preprocessor"></span>              <a class="code" href="../../d6/d5/ia64_2getsetrg_8c.html#a9">set_fp_register</a> (f1, <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a85">FPRegToFP128</a>(ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1]), fp_state);
01090               <span class="keywordflow">if</span> (f1 &lt; 32)
01091                 *pipsr = *pipsr | (<a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a>)0x10; <span class="comment">// set mfl bit</span>
01092               <span class="keywordflow">else</span>
01093                 *pipsr = *pipsr | (<a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a>)0x20; <span class="comment">// set mfh bit</span>
01094 
01095               <span class="comment">// ps-&gt;state_PR[p2] = 0; clear the output predicate</span>
01096               <span class="comment">// update *ppreds [as if O disabled]</span>
01097               *ppreds &amp;= (~(((<a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a>)1) &lt;&lt; (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)p2));
01098 <span class="preprocessor">#ifdef DEBUG_UNIX</span>
01099 <span class="preprocessor"></span>printf (<span class="stringliteral">"DEBUG Case (I), (II) AFTER F6 SWA FAULT 3 a: *ppreds = %Lx\n"</span>,
01100 *ppreds);
01101 <span class="preprocessor">#endif</span>
01102 <span class="preprocessor"></span>              <span class="comment">// update *pfpsr</span>
01103               <span class="comment">// set D in FPSR.sfx if any of a and b was unnormal</span>
01104               <span class="keywordflow">if</span> (unnormal) {
01105                 <span class="comment">// set D = 1 in *pfpsr</span>
01106                 *pfpsr = *pfpsr |
01107                     ((<a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a>)1 &lt;&lt; (6 + (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)sf * 13 + 8));
01108               }
01109               <span class="comment">// set I = 1 and O = 1 in *pfpsr</span>
01110               <span class="comment">// set O = 1</span>
01111               *pfpsr = *pfpsr |
01112                   ((<a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a>)1 &lt;&lt; (6 + (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)sf * 13 + 10));
01113               <span class="comment">// set I = 1</span>
01114               *pfpsr = *pfpsr |
01115                   ((<a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a>)1 &lt;&lt; (6 + (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)sf * 13 + 12));
01116 
01117               <span class="comment">// caller will advance instruction pointer</span>
01118               <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> | <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a3">FAULT_TO_TRAP</a>); <span class="comment">// will raise I trap</span>
01119 
01120             }
01121 
01122           <span class="comment">// Case (III), Case (IV), Case (V), Case (VI), and Case (VII)</span>
01123           <span class="comment">// a/b is normal, non-zero ==&gt; might have an I trap</span>
01124 
01125           } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((exponent_b == exponent_a - <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a8">FP_REG_EMAX</a> - 1) &amp;&amp;
01126             (significand_a &lt; significand_b) ||
01127             (exponent_b == exponent_a - <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a8">FP_REG_EMAX</a>) ||
01128             (exponent_a - <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a8">FP_REG_EMAX</a> + 1 &lt;= exponent_b ) &amp;&amp;
01129             (exponent_b &lt;= exponent_a - <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a7">FP_REG_EMIN</a> - 2) &amp;&amp;
01130             ((exponent_a &lt;= <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a7">FP_REG_EMIN</a> + <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a9">N64</a> - 1) ||
01131             (exponent_b &lt;= <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a7">FP_REG_EMIN</a> - 1) ||
01132             (exponent_b &gt;= <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a8">FP_REG_EMAX</a> - 2)) ||
01133             (exponent_b == exponent_a - <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a7">FP_REG_EMIN</a> - 1) ||
01134             (exponent_b == exponent_a - <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a7">FP_REG_EMIN</a>) &amp;&amp;
01135             (significand_a &gt;= significand_b)) {
01136 
01137 <span class="preprocessor">#ifdef DEBUG_UNIX</span>
01138 <span class="preprocessor"></span>printf (<span class="stringliteral">"DEBUG: BEGIN F6 SWA FAULT CASE (III) - (VII)\n"</span>);
01139 <span class="preprocessor">#endif</span>
01140 <span class="preprocessor"></span>
01141             <span class="comment">// scale a to a' and b to b', such that c' = a'/ b' will be </span>
01142             <span class="comment">// normal</span>
01143 
01144             <span class="comment">// set the scaled (possibly normalized) value of a' (sign ok)</span>
01145             ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf2].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o1">exponent</a> = (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)(0xffff);
01146             ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf2].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o0">significand</a> = significand_a;
01147 
01148             <span class="comment">// set the scaled (possibly normalized) value of b' (sign ok)</span>
01149             ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf3].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o1">exponent</a> = (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)(0xffff);
01150             ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf3].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o0">significand</a> = significand_b;
01151 
01152             <span class="comment">// convert a' and b' to FLOAT128</span>
01153             a_float128 = <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a85">FPRegToFP128</a> (ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf2]);
01154             b_float128 = <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a85">FPRegToFP128</a> (ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf3]);
01155 
01156             <span class="comment">// invoke the divide algorithm to calculate c' = a' / b';</span>
01157             <span class="comment">// the algorithm uses sf0 with user settings, and sf1 with</span>
01158             <span class="comment">// rn, 64-bits, wre, traps disabled;</span>
01159             <span class="comment">// copy FPSR.sfx with clear flags to FPSR1.sf0; rn,64,wre in sf1</span>
01160             FPSR1 = (<a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a>)((<a class="code" href="../../d9/d2/festate_8h.html#a0">FPSR</a> &gt;&gt; ((<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)sf * 13)) &amp; 0x01fc0)
01161                 | 0x000000000270003f; <span class="comment">// set sf0,sf1 and disable fp exceptions</span>
01162             <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a89">thmF</a> (&amp;FPSR1, &amp;a_float128, &amp;b_float128, &amp;c_float128);
01163             I_flag = FPSR1 &amp; 0x40000 ? 1 : 0;
01164 
01165             <span class="comment">// set the result</span>
01166             <span class="comment">// convert c' (normal fp#) from FLOAT128 to EM_fp_reg_type</span>
01167             ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1] = <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a84">FP128ToFPReg</a> (c_float128);
01168             <span class="comment">// scale c' to c</span>
01169             ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o1">exponent</a> = (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o1">exponent</a>
01170                 + exponent_a - exponent_b;
01171 
01172             <span class="keywordflow">if</span> (I_dis || !I_flag) {
01173 
01174               <span class="comment">// set D in FPSR.sfx if any of a and b was unnormal</span>
01175               <span class="keywordflow">if</span> (unnormal) {
01176                 <span class="comment">// set D = 1 in *pfpsr</span>
01177                 *pfpsr = *pfpsr |
01178                     ((<a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a>)1 &lt;&lt; (6 + (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)sf * 13 + 8));
01179               }
01180 
01181               <span class="comment">// set I in *pfpsr</span>
01182               <span class="keywordflow">if</span> (I_flag) *pfpsr = *pfpsr |
01183                   ((<a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a>)1 &lt;&lt; (6 + (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)sf * 13 + 12));
01184               <span class="comment">// set the destination floating-point and predicate reg values</span>
01185 <span class="preprocessor">#ifdef DEBUG_UNIX</span>
01186 <span class="preprocessor"></span>printf (<span class="stringliteral">"DEBUG Case (III) - (VII) AFTER F6 SWA FAULT 4: ps-&gt;state_FR[lf1] = %x %x %Lx\n"</span>,
01187 ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o2">sign</a>, ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o1">exponent</a>, 
01188 ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o0">significand</a>);
01189 <span class="preprocessor">#endif</span>
01190 <span class="preprocessor"></span>              <a class="code" href="../../d6/d5/ia64_2getsetrg_8c.html#a9">set_fp_register</a> (f1, <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a85">FPRegToFP128</a>(ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1]), fp_state);
01191               <span class="keywordflow">if</span> (f1 &lt; 32)
01192                 *pipsr = *pipsr | (<a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a>)0x10; <span class="comment">// set mfl bit</span>
01193               <span class="keywordflow">else</span>
01194                 *pipsr = *pipsr | (<a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a>)0x20; <span class="comment">// set mfh bit</span>
01195 
01196               <span class="comment">// ps-&gt;state_PR[p2] = 0; clear the output predicate</span>
01197               *ppreds &amp;= (~(((<a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a>)1) &lt;&lt; (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)p2));
01198 <span class="preprocessor">#ifdef DEBUG_UNIX</span>
01199 <span class="preprocessor"></span>printf (<span class="stringliteral">"DEBUG Case (III) - (VII) AFTER F6 SWA FAULT 4 a: *ppreds = %Lx\n"</span>,
01200 *ppreds);
01201 <span class="preprocessor">#endif</span>
01202 <span class="preprocessor"></span>              <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01203 
01204             } <span class="keywordflow">else</span> { <span class="comment">// if (!I_dis &amp;&amp; I_flag)</span>
01205 
01206               <span class="comment">// calculate d' = |b'| * |c'| - |a'| to determine fpa</span>
01207               c_float128.hiFlt64 = c_float128.hiFlt64 &amp;
01208                   <a class="code" href="../../d2/d3/fetypes_8h.html#a3">CONST_FORMAT</a>(0x000000000001ffff); <span class="comment">// take |c'|</span>
01209               b_float128.hiFlt64 = b_float128.hiFlt64 &amp;
01210                   <a class="code" href="../../d2/d3/fetypes_8h.html#a3">CONST_FORMAT</a>(0x000000000001ffff); <span class="comment">// take |b'|</span>
01211               a_float128.hiFlt64 = a_float128.hiFlt64 &amp;
01212                   <a class="code" href="../../d2/d3/fetypes_8h.html#a3">CONST_FORMAT</a>(0x000000000001ffff); <span class="comment">// take |a'|</span>
01213               FPSR1 = <a class="code" href="../../d2/d3/fetypes_8h.html#a3">CONST_FORMAT</a>(0x00000000000003bf); <span class="comment">// rn,64,wre=1,dis</span>
01214               <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a88">run_fms</a> (&amp;FPSR1, &amp;d_float128, &amp;b_float128, &amp;c_float128,
01215                   &amp;a_float128); <span class="comment">// d' = |b'| * |c'| - |a'|</span>
01216 
01217               <span class="keywordflow">if</span> (d_float128.hiFlt64 &amp; <a class="code" href="../../d2/d3/fetypes_8h.html#a3">CONST_FORMAT</a>(0x0000000000020000)) {
01218                 <span class="comment">// if d' &lt; 0, I = 1 and fpa = 0</span>
01219                 ISRlow = 0x2001;
01220               } <span class="keywordflow">else</span> {
01221                 <span class="comment">// if d' &gt; 0, I = 1 and fpa = 1</span>
01222                 ISRlow = 0x6001;
01223               }
01224 
01225               *pisr = ((*pisr) &amp; 0xffffffffffff0000) | ISRlow;
01226 
01227               <span class="comment">// set the destination floating-point and predicate reg values</span>
01228 <span class="preprocessor">#ifdef DEBUG_UNIX</span>
01229 <span class="preprocessor"></span>printf (<span class="stringliteral">"DEBUG Case (III) - (VII) AFTER F6 SWA FAULT 5: ps-&gt;state_FR[lf1] = %x %x %Lx\n"</span>,
01230 ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o2">sign</a>, ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o1">exponent</a>, 
01231 ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o0">significand</a>);
01232 <span class="preprocessor">#endif</span>
01233 <span class="preprocessor"></span>              <a class="code" href="../../d6/d5/ia64_2getsetrg_8c.html#a9">set_fp_register</a> (f1, <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a85">FPRegToFP128</a>(ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1]), fp_state);
01234               <span class="keywordflow">if</span> (f1 &lt; 32)
01235                 *pipsr = *pipsr | (<a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a>)0x10; <span class="comment">// set mfl bit</span>
01236               <span class="keywordflow">else</span>
01237                 *pipsr = *pipsr | (<a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a>)0x20; <span class="comment">// set mfh bit</span>
01238 
01239               <span class="comment">// ps-&gt;state_PR[p2] = 0; clear the output predicate</span>
01240               <span class="comment">// update *ppreds</span>
01241               *ppreds &amp;= (~(((<a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a>)1) &lt;&lt; (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)p2));
01242 <span class="preprocessor">#ifdef DEBUG_UNIX</span>
01243 <span class="preprocessor"></span>printf (<span class="stringliteral">"DEBUG Case (III) -(VII) AFTER F6 SWA FAULT 5 a: *ppreds = %Lx\n"</span>,
01244 *ppreds);
01245 <span class="preprocessor">#endif</span>
01246 <span class="preprocessor"></span>              <span class="comment">// update *pfpsr</span>
01247               <span class="comment">// set D = 1 in FPSR.sfx if any of a and b was unnormal</span>
01248               <span class="keywordflow">if</span> (unnormal) {
01249                 <span class="comment">// set D = 1 in *pfpsr</span>
01250                 *pfpsr = *pfpsr |
01251                     ((<a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a>)1 &lt;&lt; (6 + (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)sf * 13 + 8));
01252               }
01253               <span class="comment">// set I = 1 in *pfpsr</span>
01254               <span class="keywordflow">if</span> (I_flag) *pfpsr = *pfpsr |
01255                   ((<a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a>)1 &lt;&lt; (6 + (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)sf * 13 + 12));
01256 
01257               <span class="comment">// caller will advance instruction pointer</span>
01258               <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> | <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a3">FAULT_TO_TRAP</a>); <span class="comment">// will raise I trap</span>
01259 
01260             }
01261 
01262           <span class="comment">// Case (VIII), Case (IX), Case (X), Case (XI), and Case (XII)</span>
01263           <span class="comment">// 0 &lt; |a/b| &lt; SMALLEST NORMAL ==&gt; might have U or I traps</span>
01264           <span class="comment">// As a/b cannot contain more than N-1 consecutive 1's or N-1</span>
01265           <span class="comment">// consecutive 0's, even if fpa = 1 is added in the first IEEE</span>
01266           <span class="comment">// rounding, that does not change the quotient's exponent</span>
01267 
01268           } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( (exponent_b == exponent_a - <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a7">FP_REG_EMIN</a>) &amp;&amp;
01269             (significand_a &lt; significand_b) ||
01270             (exponent_b &gt;= exponent_a - <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a7">FP_REG_EMIN</a> + 1)) {
01271 
01272 <span class="preprocessor">#ifdef DEBUG_UNIX</span>
01273 <span class="preprocessor"></span>printf (<span class="stringliteral">"DEBUG: BEGIN F6 SWA FAULT CASE (VIII) - (XII)\n"</span>);
01274 <span class="preprocessor">#endif</span>
01275 <span class="preprocessor"></span>            <span class="comment">// scale a to a' and b to b', such that c' = a'/ b' will be </span>
01276             <span class="comment">// normal</span>
01277 
01278             <span class="comment">// set the scaled (possibly normalized) value of a' (sign ok)</span>
01279             ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf2].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o1">exponent</a> = (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)(0xffff);
01280             ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf2].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o0">significand</a> = significand_a;
01281 
01282             <span class="comment">// set the scaled (possibly normalized) value of b' (sign ok)</span>
01283             ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf3].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o1">exponent</a> = (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)(0xffff);
01284             ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf3].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o0">significand</a> = significand_b;
01285 
01286             <span class="comment">// convert a' and b' to FLOAT128</span>
01287             a_float128 = <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a85">FPRegToFP128</a> (ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf2]);
01288             b_float128 = <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a85">FPRegToFP128</a> (ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf3]);
01289 
01290             <span class="comment">// invoke the divide algorithm to calculate c' = a' / b';</span>
01291             <span class="comment">// the algorithm uses sf0 with user settings, and sf1 with </span>
01292             <span class="comment">// rn, 64-bits, wre, traps disabled;</span>
01293             <span class="comment">// copy FPSR.sfx with clear flags to FPSR1.sf0; rn,64,wre in sf1</span>
01294             FPSR1 = (<a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a>)((<a class="code" href="../../d9/d2/festate_8h.html#a0">FPSR</a> &gt;&gt; ((<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)sf * 13)) &amp; 0x01fc0)
01295                 | 0x000000000270003f; <span class="comment">// set sf0,sf1 and disable fp exceptions</span>
01296             <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a89">thmF</a> (&amp;FPSR1, &amp;a_float128, &amp;b_float128, &amp;c_float128);
01297             I_flag = FPSR1 &amp; 0x40000 ? 1 : 0;
01298 
01299             c1_float128 = c_float128;
01300 
01301             <span class="keywordflow">if</span> (I_flag == 1) {
01302               <span class="comment">// calculate d' = |b'| * |c'| - |a'| to determine fpa (used</span>
01303               <span class="comment">// only if a U or I exception will be raised)</span>
01304               c1_float128.hiFlt64 = c1_float128.hiFlt64 &amp; 
01305                   <a class="code" href="../../d2/d3/fetypes_8h.html#a3">CONST_FORMAT</a>(0x000000000001ffff); <span class="comment">// take |c'|</span>
01306               b_float128.hiFlt64 = b_float128.hiFlt64 &amp; 
01307                   <a class="code" href="../../d2/d3/fetypes_8h.html#a3">CONST_FORMAT</a>(0x000000000001ffff); <span class="comment">// take |b'|</span>
01308               a_float128.hiFlt64 = a_float128.hiFlt64 &amp; 
01309                   <a class="code" href="../../d2/d3/fetypes_8h.html#a3">CONST_FORMAT</a>(0x000000000001ffff); <span class="comment">// take |a'|</span>
01310               FPSR1 = <a class="code" href="../../d2/d3/fetypes_8h.html#a3">CONST_FORMAT</a>(0x00000000000003bf); <span class="comment">// rn,64,wre=1,dis</span>
01311               <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a88">run_fms</a> (&amp;FPSR1, &amp;d_float128, &amp;b_float128, &amp;c1_float128,
01312                   &amp;a_float128); <span class="comment">// d' = |b'| * |c'| - |a'|</span>
01313               <span class="keywordflow">if</span> (d_float128.hiFlt64 &amp; <a class="code" href="../../d2/d3/fetypes_8h.html#a3">CONST_FORMAT</a>(0x020000)) {
01314                 <span class="comment">// if d' &lt; 0, I = 1 and fpa = 0</span>
01315                 fpa = 0;
01316               } <span class="keywordflow">else</span> {
01317                 <span class="comment">// if d' &gt; 0, I = 1 and fpa = 1</span>
01318                 fpa = 1;
01319               }
01320             } <span class="keywordflow">else</span> { <span class="comment">// if (I_flag == 0) fpa = 0</span>
01321               fpa = 0;
01322             }
01323 
01324             <span class="keywordflow">if</span> (!U_dis) {
01325 
01326               <span class="comment">// underflow exceptions are enabled =&gt; compute the result, and</span>
01327               <span class="comment">// propagate an underflow exception (deliver the result with</span>
01328               <span class="comment">// the exponent mod 2^17</span>
01329 
01330               <span class="comment">// convert c' (normal fp#) from FLOAT128 to EM_fp_reg_type</span>
01331               ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1] = <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a84">FP128ToFPReg</a> (c_float128);
01332               <span class="comment">// scale c' to c and take the mod 2^17 exponent</span>
01333               exponent_c = (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o1">exponent</a> + 
01334                   exponent_a - exponent_b;
01335               ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o1">exponent</a> = exponent_c &amp; 0x1ffff;
01336 
01337               ISRlow = 0x1001; <span class="comment">// U = 1</span>
01338               <span class="comment">// set the values of I and fpa in ISRlow</span>
01339               <span class="keywordflow">if</span> (I_flag == 1) {
01340                 <span class="keywordflow">if</span> (fpa == 0) {
01341                   ISRlow = ISRlow | 0x2000; <span class="comment">// I = 1</span>
01342                 } <span class="keywordflow">else</span> {
01343                   ISRlow = ISRlow | 0x6000; <span class="comment">// I = 1, fpa = 1</span>
01344                 }
01345               }
01346 
01347               *pisr = ((*pisr) &amp; 0xffffffffffff0000) | ISRlow;
01348 
01349               <span class="comment">// set the destination floating-point and predicate reg values</span>
01350 <span class="preprocessor">#ifdef DEBUG_UNIX</span>
01351 <span class="preprocessor"></span>printf (<span class="stringliteral">"DEBUG Case (VIII) - (XII) AFTER F6 SWA FAULT 7: ps-&gt;state_FR[lf1] = %x %x %Lx\n"</span>,
01352 ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o2">sign</a>, ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o1">exponent</a>, 
01353 ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o0">significand</a>);
01354 <span class="preprocessor">#endif</span>
01355 <span class="preprocessor"></span>              <a class="code" href="../../d6/d5/ia64_2getsetrg_8c.html#a9">set_fp_register</a> (f1, <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a85">FPRegToFP128</a>(ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1]), fp_state);
01356               <span class="keywordflow">if</span> (f1 &lt; 32)
01357                 *pipsr = *pipsr | (<a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a>)0x10; <span class="comment">// set mfl bit</span>
01358               <span class="keywordflow">else</span>
01359                 *pipsr = *pipsr | (<a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a>)0x20; <span class="comment">// set mfh bit</span>
01360 
01361               <span class="comment">// ps-&gt;state_PR[p2] = 0; clear the output predicate</span>
01362               <span class="comment">// update *ppreds</span>
01363               *ppreds &amp;= (~(((<a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a>)1) &lt;&lt; (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)p2));
01364 <span class="preprocessor">#ifdef DEBUG_UNIX</span>
01365 <span class="preprocessor"></span>printf (<span class="stringliteral">"DEBUG Case (VIII) - (XII) AFTER F6 SWA FAULT 7 a: *ppreds = %Lx\n"</span>,
01366 *ppreds);
01367 <span class="preprocessor">#endif</span>
01368 <span class="preprocessor"></span>              <span class="comment">// update *pfpsr</span>
01369               <span class="comment">// set D in FPSR.sfx if any of a and b was unnormal</span>
01370               <span class="keywordflow">if</span> (unnormal) {
01371                 <span class="comment">// set D = 1 in *pfpsr</span>
01372                 *pfpsr = *pfpsr |
01373                     ((<a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a>)1 &lt;&lt; (6 + (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)sf * 13 + 8));
01374               }
01375               <span class="comment">// set U = 1</span>
01376               *pfpsr = *pfpsr | 
01377                   ((<a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a>)1 &lt;&lt; (6 + (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)sf * 13 + 11));
01378               <span class="comment">// set I = 1 if I_flag = 1</span>
01379               <span class="keywordflow">if</span> (I_flag) {
01380                 *pfpsr = *pfpsr |
01381                     ((<a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a>)1 &lt;&lt; (6 + (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)sf * 13 + 12));
01382               }
01383 
01384               <span class="comment">// caller will advance instruction pointer</span>
01385               <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> | <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a3">FAULT_TO_TRAP</a>); <span class="comment">// will raise U trap</span>
01386 
01387             } <span class="keywordflow">else</span>  { <span class="comment">// if (U_dis)</span>
01388 
01389               <span class="comment">// underflow exceptions are disabled</span>
01390 
01391               <span class="comment">// convert c' (normal fp#) from FLOAT128 to EM_fp_reg_type</span>
01392               ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1] = <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a84">FP128ToFPReg</a> (c_float128);
01393 
01394               <span class="keywordflow">if</span> (ftz == 0) {
01395 
01396                 <span class="comment">// denormalize</span>
01397                 sign_c = ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o2">sign</a>;
01398                 exponent_c = ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o1">exponent</a>;
01399                 significand_c = ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o0">significand</a>;
01400                 <span class="keywordflow">if</span> (fpa) significand_c = significand_c - 1;
01401                     <span class="comment">// Note: if fpa = 1, significand_c cannot be 1.0...0,</span>
01402                     <span class="comment">// because it could not have been 1.1...1 before adding</span>
01403                     <span class="comment">// 1 to it (cannot have N consecutive 1's in the result);</span>
01404                     <span class="comment">// this means that significand_c - 1 above does not </span>
01405                     <span class="comment">// require an exponent correction (it does not lose </span>
01406                     <span class="comment">// the J-bit)</span>
01407                 true_bexp = exponent_c + exponent_a - exponent_b;
01408                 <span class="comment">// true_bexp - 0x0ffff is the true unbiased exponent after</span>
01409                 <span class="comment">// the first IEEE rounding</span>
01410 
01411                 <span class="comment">// perform the second IEEE rounding</span>
01412     
01413                 significand_size = <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a9">N64</a>;
01414                 shift_cnt = <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a7">FP_REG_EMIN</a> - true_bexp + 0x0ffff;
01415 
01416                 <span class="keywordflow">if</span> (shift_cnt &lt;= significand_size) {
01417                   <span class="comment">// do the actual shift to denormalize the result; the </span>
01418                   <span class="comment">// result will be a denormal, or zero</span>
01419                   round = I_flag;
01420                   sticky = 0;
01421                   <span class="keywordflow">for</span> (ind = 0 ; ind &lt; shift_cnt ; ind++) {
01422                     sticky = round | sticky;
01423                     round = (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)(significand_c &amp; 0x01);
01424                     significand_c = significand_c &gt;&gt; 1;
01425                   }
01426                   true_bexp = true_bexp + shift_cnt; <span class="comment">// e_min + 0xffff</span>
01427                 } <span class="keywordflow">else</span> { <span class="comment">// all the significand bits shift out into sticky</span>
01428                   significand_c = 0;
01429                   round = 0;
01430                   sticky = 1;
01431                   true_bexp = true_bexp + shift_cnt; <span class="comment">// e_min + 0xffff</span>
01432                 }
01433 
01434                 <span class="comment">// perform the rounding; the result is 0, denormal, or </span>
01435                 <span class="comment">// 1.0 x 2^emin</span>
01436                 <span class="keywordflow">switch</span> (rc) {
01437                   <span class="keywordflow">case</span> <a class="code" href="../../d2/d3/fetypes_8h.html#a455a412">rc_rn</a>:
01438                     lsb = (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)(significand_c &amp; 0x01);
01439                     fpa = round &amp; (lsb | sticky);
01440                     <span class="keywordflow">break</span>;
01441                   <span class="keywordflow">case</span> <a class="code" href="../../d2/d3/fetypes_8h.html#a455a413">rc_rm</a>:
01442                     fpa = (sign_c == 0 ? 0 : (round | sticky));
01443                     <span class="keywordflow">break</span>;
01444                   <span class="keywordflow">case</span> <a class="code" href="../../d2/d3/fetypes_8h.html#a455a414">rc_rp</a>:
01445                     fpa = (sign_c == 1 ? 0 : (round | sticky));
01446                     <span class="keywordflow">break</span>;
01447                   <span class="keywordflow">case</span> <a class="code" href="../../d2/d3/fetypes_8h.html#a455a415">rc_rz</a>:
01448                     fpa = 0;
01449                     <span class="keywordflow">break</span>;
01450                   <span class="keywordflow">default</span>:
01451 <span class="preprocessor">#ifndef unix</span>
01452 <span class="preprocessor"></span>                    <a class="code" href="../../d9/d1/fedefs_8h.html#a2">FP_EMULATION_ERROR1</a> (<span class="stringliteral">"fp_emulate () Internal \</span>
01453 <span class="stringliteral">Error: invalid rc = %d\n"</span>, rc);
01454 <span class="preprocessor">#else</span>
01455 <span class="preprocessor"></span>                    <a class="code" href="../../d9/d1/fedefs_8h.html#a2">FP_EMULATION_ERROR1</a> (<span class="stringliteral">"fp_emulate () Internal Error: \</span>
01456 <span class="stringliteral">invalid rc = %d\n"</span>, rc);
01457                     <span class="keywordflow">return</span> (<a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a2">FP_EMUL_ERROR</a>);
01458 <span class="preprocessor">#endif</span>
01459 <span class="preprocessor"></span>                }
01460 
01461 
01462                 <span class="comment">// add fpa to the significand if fpa = 1</span>
01463                 <span class="keywordflow">if</span> (fpa == 1) {
01464                   significand_c = significand_c + 1;
01465                 }
01466     
01467                 <span class="keywordflow">if</span> (significand_c == 0) {
01468                   true_bexp = 0; <span class="comment">// ow it is e_min</span>
01469                 }
01470     
01471                 exponent_c = true_bexp;
01472     
01473                 <span class="comment">// determine the new value of I_flag (must be 1)</span>
01474                 I_flag = round | sticky; <span class="comment">// not used except for check below</span>
01475                 <span class="comment">// ps-&gt;state_FR[lf1].sign unchanged</span>
01476                 ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o1">exponent</a> = exponent_c;
01477                 ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o0">significand</a> = significand_c;
01478  
01479               } <span class="keywordflow">else</span> { <span class="comment">// if ftz == 1</span>
01480 
01481                 fpa = 0;
01482                 <span class="comment">// ps-&gt;state_FR[lf1].sign unchanged</span>
01483                 ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o1">exponent</a> = 0;
01484                 ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o0">significand</a> = 0;
01485                 I_flag = 1;
01486 
01487               }
01488 
01489               <span class="comment">// update *pfpsr</span>
01490               <span class="comment">// set D in FPSR.sfx if any of a and b was unnormal</span>
01491               <span class="keywordflow">if</span> (unnormal) {
01492                 <span class="comment">// set D = 1 in *pfpsr</span>
01493                 *pfpsr = *pfpsr |
01494                     ((<a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a>)1 &lt;&lt; (6 + (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)sf * 13 + 8));
01495               }
01496               <span class="keywordflow">if</span> (I_flag) {
01497                 <span class="comment">// set U = 1</span>
01498                 *pfpsr = *pfpsr |
01499                     ((<a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a>)1 &lt;&lt; (6 + (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)sf * 13 + 11));
01500                 <span class="comment">// set I = 1</span>
01501                 *pfpsr = *pfpsr |
01502                     ((<a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a>)1 &lt;&lt; (6 + (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)sf * 13 + 12));
01503               }
01504 
01505               <span class="comment">// set the destination floating-point and predicate reg values</span>
01506 <span class="preprocessor">#ifdef DEBUG_UNIX</span>
01507 <span class="preprocessor"></span>printf (<span class="stringliteral">"DEBUG Case (VIII) - (XII) AFTER F6 SWA FAULT 8: ps-&gt;state_FR[lf1] = %x %x %Lx\n"</span>,
01508 ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o2">sign</a>, ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o1">exponent</a>,
01509 ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o0">significand</a>);
01510 <span class="preprocessor">#endif</span>
01511 <span class="preprocessor"></span>              <a class="code" href="../../d6/d5/ia64_2getsetrg_8c.html#a9">set_fp_register</a> (f1, <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a85">FPRegToFP128</a>(ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1]), fp_state);
01512               <span class="keywordflow">if</span> (f1 &lt; 32)
01513                 *pipsr = *pipsr | (<a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a>)0x10; <span class="comment">// set mfl bit</span>
01514               <span class="keywordflow">else</span>
01515                 *pipsr = *pipsr | (<a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a>)0x20; <span class="comment">// set mfh bit</span>
01516  
01517               <span class="comment">// ps-&gt;state_PR[p2] = 0; clear the output predicate</span>
01518               <span class="comment">// update *ppreds [as if O disabled]</span>
01519               *ppreds &amp;= (~(((<a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a>)1) &lt;&lt; (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)p2));
01520 <span class="preprocessor">#ifdef DEBUG_UNIX</span>
01521 <span class="preprocessor"></span>printf (<span class="stringliteral">"DEBUG Case (VIII) - (XII) AFTER F6 SWA FAULT 8 a: *ppreds = %Lx\n"</span>,
01522 *ppreds);
01523 <span class="preprocessor">#endif</span>
01524 <span class="preprocessor"></span>
01525               <span class="keywordflow">if</span> (I_flag &amp;&amp; !I_dis) {
01526 
01527                 <span class="comment">// underflow exceptions are disabled, but the inexact </span>
01528                 <span class="comment">// exceptions are enabled and the result is inexact =&gt; </span>
01529                 <span class="comment">// provide the IEEE mandated result, and</span>
01530                 <span class="comment">// propagate an inexact exception</span>
01531 
01532                 ISRlow = 0x2001; <span class="comment">// I = 1</span>
01533                 <span class="keywordflow">if</span> (fpa) ISRlow = ISRlow | 0x4000; <span class="comment">// fpa = 1</span>
01534                 *pisr = ((*pisr) &amp; 0xffffffffffff0000) | ISRlow;
01535 
01536                 <span class="comment">// caller will advance instruction pointer</span>
01537                 <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> | <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a3">FAULT_TO_TRAP</a>); <span class="comment">// will raise I trap</span>
01538 
01539               } <span class="comment">// else no trap (tiny and inexact result)</span>
01540     
01541               <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01542 
01543             }
01544 
01545           <span class="comment">// Case (XIII)</span>
01546           } <span class="keywordflow">else</span> { 
01547 
01548 <span class="preprocessor">#ifdef DEBUG_UNIX</span>
01549 <span class="preprocessor"></span>printf (<span class="stringliteral">"DEBUG: BEGIN F6 SWA FAULT CASE (XIII)\n"</span>);
01550 <span class="preprocessor">#endif</span>
01551 <span class="preprocessor"></span>
01552             <span class="comment">// this must be a Merced specific SWA fault (e.g. for single,</span>
01553             <span class="comment">// double, or double-extended denormals)</span>
01554             <a class="code" href="../../d6/d2/feproto_8h.html#a34">frcpa</a> (ps, sf, qp, lf1, p2, lf2, lf3);
01555 
01556             <span class="keywordflow">if</span> ((ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o8">state_MERCED_RTL</a> &gt;&gt; 16) &amp; 0x0ffff) <span class="keywordflow">goto</span> new_exception;
01557 
01558             *pfpsr =  ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o2">state_AR</a>[0].<a class="code" href="../../d9/d0/unionar__union.html#o1">uint_value</a>;
01559             <span class="comment">// set the destination floating-point and predicate reg values</span>
01560 <span class="preprocessor">#ifdef DEBUG_UNIX</span>
01561 <span class="preprocessor"></span>printf (<span class="stringliteral">"DEBUG Case (XIII) AFTER F6 SWA FAULT 14: ps-&gt;state_FR[lf1] = %x %x %Lx\n"</span>,
01562 ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o2">sign</a>, ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o1">exponent</a>, 
01563 ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o0">significand</a>);
01564 <span class="preprocessor">#endif</span>
01565 <span class="preprocessor"></span>            <a class="code" href="../../d6/d5/ia64_2getsetrg_8c.html#a9">set_fp_register</a> (f1, <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a85">FPRegToFP128</a>(ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1]), fp_state);
01566             <span class="keywordflow">if</span> (f1 &lt; 32)
01567               *pipsr = *pipsr | (<a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a>)0x10; <span class="comment">// set mfl bit</span>
01568             <span class="keywordflow">else</span>
01569               *pipsr = *pipsr | (<a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a>)0x20; <span class="comment">// set mfh bit</span>
01570 
01571             <span class="comment">// update ps-&gt;state_PR[p2] = 1;</span>
01572             *ppreds &amp;= (~(((<a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a>)1) &lt;&lt; (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)p2));
01573             *ppreds |=
01574                 (((<a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a>)(ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o5">state_PR</a>[p2] &amp; 0x01)) &lt;&lt; (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)p2);
01575 <span class="preprocessor">#ifdef DEBUG_UNIX</span>
01576 <span class="preprocessor"></span>printf (<span class="stringliteral">"DEBUG Case (XIII) AFTER F6 SWA FAULT 14 a: *ppreds = %Lx\n"</span>,
01577 *ppreds);
01578 <span class="preprocessor">#endif</span>
01579 <span class="preprocessor"></span>            <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01580 
01581           }
01582 
01583           <span class="keywordflow">break</span>;
01584 
01585         <span class="keywordflow">case</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a40">FPRCPA_PATTERN</a>:
01586 
01587           <span class="comment">// should get here only for denormal inputs</span>
01588           <a class="code" href="../../d6/d2/feproto_8h.html#a35">fprcpa</a> (ps, sf, qp, lf1, p2, lf2, lf3);
01589 
01590           <span class="keywordflow">if</span> ((ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o8">state_MERCED_RTL</a> &gt;&gt; 16) &amp; 0x0ffff) <span class="keywordflow">goto</span> new_exception;
01591 
01592           *pfpsr =  ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o2">state_AR</a>[0].<a class="code" href="../../d9/d0/unionar__union.html#o1">uint_value</a>;
01593           <span class="comment">// set the destination floating-point and predicate </span>
01594           <span class="comment">// reg values (redundant, as the output predicate will be cleared)</span>
01595 <span class="preprocessor">#ifdef DEBUG_UNIX</span>
01596 <span class="preprocessor"></span>printf (<span class="stringliteral">"DEBUG AFTER F6 FPRCPA SWA FAULT 15: ps-&gt;state_FR[lf1] = %x %x %Lx\n"</span>,
01597   ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o2">sign</a>, ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o1">exponent</a>, 
01598   ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o0">significand</a>);
01599 <span class="preprocessor">#endif</span>
01600 <span class="preprocessor"></span>          <a class="code" href="../../d6/d5/ia64_2getsetrg_8c.html#a9">set_fp_register</a> (f1, <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a85">FPRegToFP128</a>(ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1]), fp_state);
01601           <span class="keywordflow">if</span> (f1 &lt; 32)
01602             *pipsr = *pipsr | (<a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a>)0x10; <span class="comment">// set mfl bit</span>
01603           <span class="keywordflow">else</span>
01604             *pipsr = *pipsr | (<a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a>)0x20; <span class="comment">// set mfh bit</span>
01605 
01606           <span class="comment">// update ps-&gt;state_PR[p2] = 0; clear the output predicate</span>
01607           *ppreds &amp;= (~(((<a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a>)1) &lt;&lt; (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)p2));
01608           *ppreds |= 
01609               (((<a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a>)(ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o5">state_PR</a>[p2] &amp; 0x01)) &lt;&lt; (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)p2);
01610 <span class="preprocessor">#ifdef DEBUG_UNIX</span>
01611 <span class="preprocessor"></span>printf (<span class="stringliteral">"DEBUG AFTER F6 FPRCPA SWA FAULT 15 a: *ppreds = %Lx\n"</span>,
01612   *ppreds);
01613 <span class="preprocessor">#endif</span>
01614 <span class="preprocessor"></span>        <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01615 
01616       }
01617 
01618     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((OpCode &amp; <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a41">F7_MIN_MASK</a>) == <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a42">F7_PATTERN</a>) {
01619       <span class="comment">// F7 instruction</span>
01620 
01621       <span class="keywordflow">switch</span> (OpCode &amp; <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a43">F7_MASK</a>) {
01622 
01623         <span class="keywordflow">case</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a44">FRSQRTA_PATTERN</a>:
01624           SIMD_instruction = 0;
01625           <span class="keywordflow">break</span>;
01626         <span class="keywordflow">case</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a45">FPRSQRTA_PATTERN</a>:
01627           SIMD_instruction = 1;
01628           <span class="keywordflow">break</span>;
01629         <span class="keywordflow">default</span>:
01630           <span class="comment">// unrecognized instruction type</span>
01631 <span class="preprocessor">#ifndef unix</span>
01632 <span class="preprocessor"></span>          <a class="code" href="../../d9/d1/fedefs_8h.html#a2">FP_EMULATION_ERROR1</a> (<span class="stringliteral">"fp_emulate () Internal Error: \</span>
01633 <span class="stringliteral">instruction opcode %8x %8x not recognized\n"</span>, OpCode);
01634 <span class="preprocessor">#else</span>
01635 <span class="preprocessor"></span>          <a class="code" href="../../d9/d1/fedefs_8h.html#a2">FP_EMULATION_ERROR1</a> (<span class="stringliteral">"fp_emulate () Internal Error: \</span>
01636 <span class="stringliteral">instruction opcode %Lx not recognized\n"</span>, OpCode);
01637           <span class="keywordflow">return</span> (<a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a2">FP_EMUL_ERROR</a>);
01638 <span class="preprocessor">#endif</span>
01639 <span class="preprocessor"></span>      }
01640 
01641       <span class="comment">// extract the rounding mode</span>
01642       rc = (<a class="code" href="../../d2/d3/fetypes_8h.html#a455">EM_sf_rc_type</a>)((<a class="code" href="../../d9/d2/festate_8h.html#a0">FPSR</a> &gt;&gt; (6 + 4 + 13 * (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)sf)) &amp; 0x03);
01643 
01644       <span class="comment">// extract p2, f3, and f1</span>
01645       p2 = (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)((OpCode &gt;&gt; 27) &amp; <a class="code" href="../../d2/d3/fetypes_8h.html#a3">CONST_FORMAT</a>(0x00000000003f));
01646       <span class="keywordflow">if</span> (p2 &gt;= 16) p2 = 16 + (rrbpr + p2 - 16) % 48;
01647 <span class="preprocessor">#ifdef DEBUG_UNIX</span>
01648 <span class="preprocessor"></span>printf (<span class="stringliteral">"DEBUG F7 instruction: p2 = %x\n"</span>, p2);
01649 <span class="preprocessor">#endif</span>
01650 <span class="preprocessor"></span>      f3 = (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)((OpCode &gt;&gt; 20) &amp; <a class="code" href="../../d2/d3/fetypes_8h.html#a3">CONST_FORMAT</a>(0x00000000007F));
01651       <span class="keywordflow">if</span> (f3 &gt;= 32) f3 = 32 + (rrbfr + f3 - 32) % 96;
01652       f1 = (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)((OpCode &gt;&gt;  6) &amp; <a class="code" href="../../d2/d3/fetypes_8h.html#a3">CONST_FORMAT</a>(0x00000000007F));
01653       <span class="keywordflow">if</span> (f1 &gt;= 32) f1 = 32 + (rrbfr + f1 - 32) % 96;
01654 
01655       <span class="comment">// get source floating-point reg value</span>
01656       ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf3] = <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a84">FP128ToFPReg</a> (<a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a86">get_fp_register</a> (f3, fp_state));
01657 <span class="preprocessor">#ifdef DEBUG_UNIX</span>
01658 <span class="preprocessor"></span>printf (<span class="stringliteral">"DEBUG BEFORE F7 SWA FAULT: ps-&gt;state_FR[lf3] = %x %x %Lx\n"</span>,
01659   ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf3].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o2">sign</a>, ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf3].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o1">exponent</a>, ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf3].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o0">significand</a>);
01660 <span class="preprocessor">#endif</span>
01661 <span class="preprocessor"></span>
01662       <span class="keywordflow">switch</span> (OpCode &amp; <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a43">F7_MASK</a>) {
01663 
01664         <span class="keywordflow">case</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a44">FRSQRTA_PATTERN</a>:
01665 
01666           <span class="comment">// extract sign, exponent, and significand of a</span>
01667           <span class="comment">// note that a is (a non-zero positive normal, or a positive</span>
01668           <span class="comment">// pseudo-zero or unnormal/denormal fp#), or (a negative pseudo-zero</span>
01669           <span class="comment">// or non-zero unnormal/denormal fp#)</span>
01670           sign_a = (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf3].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o2">sign</a>;
01671           exponent_a = (<a class="code" href="../../d2/d3/fetypes_8h.html#a11">EM_int_t</a>)ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf3].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o1">exponent</a>;
01672           significand_a = ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf3].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o0">significand</a>;
01673           <span class="keywordflow">if</span> (exponent_a == 0 &amp;&amp; significand_a != 0) exponent_a = 0xc001;
01674 
01675           unnormal = 0;
01676           <span class="keywordflow">if</span> (!(significand_a &amp; <a class="code" href="../../d2/d3/fetypes_8h.html#a3">CONST_FORMAT</a>(0x8000000000000000))) {
01677             unnormal = 1;
01678           }
01679 <span class="preprocessor">#ifdef DEBUG_UNIX</span>
01680 <span class="preprocessor"></span><span class="keywordflow">if</span> (unnormal) printf (<span class="stringliteral">"DEBUG F7 FRSQRTA SWA FAULT: unnormal = 1\n"</span>);
01681 <span class="preprocessor">#endif</span>
01682 <span class="preprocessor"></span>
01683           <span class="comment">// raise a D trap if an unnormal, but not a non-zero negative one</span>
01684           <span class="keywordflow">if</span> (unnormal &amp;&amp; !D_dis &amp;&amp; !(sign_a == 1 &amp;&amp; significand_a != 0)) {
01685             ISRlow = 0x0002; <span class="comment">// denormal</span>
01686             *pisr = ((*pisr) &amp; 0xffffffffffff0000) | ISRlow;
01687             <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>); <span class="comment">// will raise D trap</span>
01688           }
01689 
01690           <span class="comment">// if a pseudo-zero or negative non-zero, return the result</span>
01691           <span class="keywordflow">if</span> (exponent_a != 0 &amp;&amp; significand_a == 0 || 
01692               sign_a == 1 &amp;&amp; significand_a != 0) { 
01693               <span class="comment">// a is pseudo-zero or negative non-zero</span>
01694 
01695             <a class="code" href="../../d6/d2/feproto_8h.html#a36">frsqrta</a> (ps, sf, qp, lf1, p2, lf3);
01696 
01697             <span class="keywordflow">if</span> ((ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o8">state_MERCED_RTL</a> &gt;&gt; 16) &amp; 0x0ffff) <span class="keywordflow">goto</span> new_exception;
01698 
01699             *pfpsr =  ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o2">state_AR</a>[0].<a class="code" href="../../d9/d0/unionar__union.html#o1">uint_value</a>;
01700 
01701             <span class="comment">// set the destination floating-point and predicate reg values</span>
01702 <span class="preprocessor">#ifdef DEBUG_UNIX</span>
01703 <span class="preprocessor"></span>printf (<span class="stringliteral">"DEBUG AFTER F7 SWA FAULT FOR PSEUDO-ZERO OR -DEN: ps-&gt;state_FR[lf1] = %x %x %Lx\n"</span>,
01704   ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o2">sign</a>, ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o1">exponent</a>,
01705   ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o0">significand</a>);
01706 <span class="preprocessor">#endif</span>
01707 <span class="preprocessor"></span>            <a class="code" href="../../d6/d5/ia64_2getsetrg_8c.html#a9">set_fp_register</a> (f1, <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a85">FPRegToFP128</a>(ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1]), fp_state);
01708             <span class="keywordflow">if</span> (f1 &lt; 32)
01709               *pipsr = *pipsr | (<a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a>)0x10; <span class="comment">// set mfl bit</span>
01710             <span class="keywordflow">else</span>
01711               *pipsr = *pipsr | (<a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a>)0x20; <span class="comment">// set mfh bit</span>
01712 
01713             <span class="comment">// ps-&gt;state_PR[p2] = 0 for zero or negative argument</span>
01714             *ppreds &amp;= (~(((<a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a>)1) &lt;&lt; (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)p2));
01715             *ppreds |= 
01716                 (((<a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a>)(ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o5">state_PR</a>[p2] &amp; 0x01)) &lt;&lt; (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)p2);
01717 <span class="preprocessor">#ifdef DEBUG_UNIX</span>
01718 <span class="preprocessor"></span>printf (<span class="stringliteral">"DEBUG  AFTER F7 SWA FAULT FOR PSEUDO-ZERO OR -DEN: p2 = %x\n"</span>, p2);
01719 <span class="preprocessor">#endif</span>
01720 <span class="preprocessor"></span><span class="preprocessor">#ifdef DEBUG_UNIX</span>
01721 <span class="preprocessor"></span>printf (<span class="stringliteral">"DEBUG AFTER F7 SWA FAULT FOR PSEUDO-ZERO OR -DEN: *ppreds = %Lx\n"</span>, *ppreds);
01722 <span class="preprocessor">#endif</span>
01723 <span class="preprocessor"></span>            <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01724 
01725           }
01726 
01727           <span class="comment">// normalize a (even if exponent_a becomes less than e_min)</span>
01728           <span class="keywordflow">while</span> (!(significand_a &amp; <a class="code" href="../../d2/d3/fetypes_8h.html#a3">CONST_FORMAT</a>(0x8000000000000000))) {
01729             significand_a = significand_a &lt;&lt; 1;
01730             exponent_a--;
01731           }
01732 
01733           <span class="comment">// Case (I)</span>
01734           <span class="comment">// sqrt (a) is normal ==&gt; might have an I trap</span>
01735 
01736           <span class="keywordflow">if</span> (exponent_a - 0xffff &lt;= <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a7">FP_REG_EMIN</a> + <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a9">N64</a> - 1) {
01737 
01738             <span class="comment">// scale a to a', such that s' = sqrt (a') will be normal</span>
01739 
01740             <span class="comment">// set the scaled (and possibly normalized) value of a' (sign ok)</span>
01741             <span class="keywordflow">if</span> (exponent_a % 2 != 0) <span class="comment">// exponent_a is biased</span>
01742               ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf3].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o1">exponent</a> = (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)0xffff;
01743             <span class="keywordflow">else</span>
01744               ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf3].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o1">exponent</a> = (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)0x10000;
01745             ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf3].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o0">significand</a> = significand_a;
01746 
01747             <span class="comment">// convert a' to FLOAT128</span>
01748             a_float128 = <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a85">FPRegToFP128</a> (ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf3]);
01749 
01750             <span class="comment">// invoke the square root algorithm to calculate s' = sqrt (a');</span>
01751             <span class="comment">// the algorithm uses sf0 with user settings, and sf1 with</span>
01752             <span class="comment">// rn, 64-bits, wre, traps disabled;</span>
01753             <span class="comment">// the current FPSR is not affected</span>
01754             <span class="comment">// copy FPSR.sfx with clear flags to FPSR1.sf0; rn,64,wre in sf1</span>
01755             FPSR1 = (<a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a>)((<a class="code" href="../../d9/d2/festate_8h.html#a0">FPSR</a> &gt;&gt; ((<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)sf * 13)) &amp; 0x01fc0) |
01756                 0x000000000270003f; <span class="comment">// set sf0,sf1 and disable fp exceptions</span>
01757             <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a90">thmL</a> (&amp;FPSR1, &amp;a_float128, &amp;s_float128);
01758             I_flag = FPSR1 &amp; 0x40000 ? 1 : 0;
01759 
01760             <span class="comment">// convert s' (normal fp#) from FLOAT128 to EM_fp_reg_type</span>
01761             ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1] = <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a84">FP128ToFPReg</a> (s_float128);
01762 
01763             <span class="comment">// scale s' to s</span>
01764             <span class="keywordflow">if</span> (exponent_a % 2 != 0) <span class="comment">// exponent_a is biased</span>
01765               ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o1">exponent</a> += ((exponent_a - 0xffff) / 2);
01766             <span class="keywordflow">else</span>
01767               ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o1">exponent</a> += ((exponent_a - 0xffff - 1) / 2);
01768 
01769             <span class="keywordflow">if</span> (I_dis || !I_flag) {
01770 
01771               <span class="comment">// set D in FPSR.sfx if unnormal operand (and denormal exeptions</span>
01772               <span class="comment">// are disabled)</span>
01773               <span class="keywordflow">if</span> (unnormal) { <span class="comment">// if (unnormal &amp;&amp; D_dis)</span>
01774                 <span class="comment">// set D in FPSR.sfx (set D = 1 in *pfpsr)</span>
01775                 *pfpsr = *pfpsr |
01776                     ((<a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a>)1 &lt;&lt; (6 + (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)sf * 13 + 8));
01777               }
01778               <span class="keywordflow">if</span> (I_flag) { <span class="comment">// set I in FPSR</span>
01779                 <span class="comment">// set I = 1 in *pfpsr</span>
01780                 *pfpsr = *pfpsr |
01781                     ((<a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a>)1 &lt;&lt; (6 + (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)sf * 13 + 12));
01782               }
01783 
01784               <span class="comment">// set the destination floating-point and predicate reg values</span>
01785 <span class="preprocessor">#ifdef DEBUG_UNIX</span>
01786 <span class="preprocessor"></span>printf (<span class="stringliteral">"DEBUG Case (I) AFTER F7 SWA FAULT 1: ps-&gt;state_FR[lf1] = %x %x %Lx\n"</span>,
01787   ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o2">sign</a>, ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o1">exponent</a>, 
01788   ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o0">significand</a>);
01789 <span class="preprocessor">#endif</span>
01790 <span class="preprocessor"></span>              <a class="code" href="../../d6/d5/ia64_2getsetrg_8c.html#a9">set_fp_register</a> (f1, <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a85">FPRegToFP128</a>(ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1]), fp_state);
01791               <span class="keywordflow">if</span> (f1 &lt; 32)
01792                 *pipsr = *pipsr | (<a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a>)0x10; <span class="comment">// set mfl bit</span>
01793               <span class="keywordflow">else</span>
01794                 *pipsr = *pipsr | (<a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a>)0x20; <span class="comment">// set mfh bit</span>
01795 
01796               <span class="comment">// ps-&gt;state_PR[p2] = 0; clear the output predicate</span>
01797               *ppreds &amp;= (~(((<a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a>)1) &lt;&lt; (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)p2));
01798 <span class="preprocessor">#ifdef DEBUG_UNIX</span>
01799 <span class="preprocessor"></span>printf (<span class="stringliteral">"DEBUG Case (I) AFTER F7 SWA FAULT 1 a: *ppreds = %Lx\n"</span>,
01800   *ppreds);
01801 <span class="preprocessor">#endif</span>
01802 <span class="preprocessor"></span>              <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01803 
01804             } <span class="keywordflow">else</span> { <span class="comment">// if (!I_dis &amp;&amp; I_flag)</span>
01805 
01806               <span class="comment">// determine fpa, and set the values of I and fpa in ISRlow</span>
01807               <span class="comment">// calculate d' = s' * s' - a' to determine fpa</span>
01808               FPSR1 = <a class="code" href="../../d2/d3/fetypes_8h.html#a3">CONST_FORMAT</a>(0x00000000000003bf);
01809               <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a88">run_fms</a> (&amp;FPSR1, &amp;d_float128, &amp;s_float128, &amp;s_float128, 
01810                   &amp;a_float128); <span class="comment">// d' = s' * s' - a'</span>
01811 
01812               <span class="keywordflow">if</span> (d_float128.hiFlt64 &amp; <a class="code" href="../../d2/d3/fetypes_8h.html#a3">CONST_FORMAT</a>(0x0000000000020000)) {
01813                 <span class="comment">// if d' &lt; 0, I = 1 and fpa = 0</span>
01814                 ISRlow = 0x2001;
01815               } <span class="keywordflow">else</span> {
01816                 <span class="comment">// if d' &gt; 0, I = 1 and fpa = 1</span>
01817                 ISRlow = 0x6001;
01818               }
01819 
01820               *pisr = ((*pisr) &amp; 0xffffffffffff0000) | ISRlow;
01821 
01822               <span class="comment">// set the destination floating-point and predicate reg values</span>
01823 <span class="preprocessor">#ifdef DEBUG_UNIX</span>
01824 <span class="preprocessor"></span>printf (<span class="stringliteral">"DEBUG Case (I) AFTER F7 SWA FAULT 2: ps-&gt;state_FR[lf1] = %x %x %Lx\n"</span>,
01825   ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o2">sign</a>, ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o1">exponent</a>, 
01826   ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o0">significand</a>);
01827 <span class="preprocessor">#endif</span>
01828 <span class="preprocessor"></span>              <a class="code" href="../../d6/d5/ia64_2getsetrg_8c.html#a9">set_fp_register</a> (f1, <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a85">FPRegToFP128</a>(ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1]), fp_state);
01829               <span class="keywordflow">if</span> (f1 &lt; 32)
01830                 *pipsr = *pipsr | (<a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a>)0x10; <span class="comment">// set mfl bit</span>
01831               <span class="keywordflow">else</span>
01832                 *pipsr = *pipsr | (<a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a>)0x20; <span class="comment">// set mfh bit</span>
01833 
01834               <span class="comment">//update *ppreds</span>
01835               <span class="comment">// ps-&gt;state_PR[p2] = 0; clear the output predicate</span>
01836               *ppreds &amp;= (~(((<a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a>)1) &lt;&lt; (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)p2));
01837 <span class="preprocessor">#ifdef DEBUG_UNIX</span>
01838 <span class="preprocessor"></span>printf (<span class="stringliteral">"DEBUG Case (I) AFTER F7 SWA FAULT 2 a: *ppreds = %Lx\n"</span>,
01839   *ppreds);
01840 <span class="preprocessor">#endif</span>
01841 <span class="preprocessor"></span>              <span class="comment">// set D in FPSR.sfx if unnormal operand (and denormal exeptions</span>
01842               <span class="comment">// are disabled)</span>
01843               <span class="keywordflow">if</span> (unnormal) { <span class="comment">// if (unnormal &amp;&amp; D_dis)</span>
01844                 <span class="comment">// set D in FPSR.sfx (set D = 1 in *pfpsr)</span>
01845                 *pfpsr = *pfpsr |
01846                     ((<a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a>)1 &lt;&lt; (6 + (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)sf * 13 + 8));
01847               }
01848               <span class="comment">// update: *pfpsr: set I = 1</span>
01849               *pfpsr = *pfpsr |
01850                   ((<a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a>)1 &lt;&lt; (6 + (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)sf * 13 + 12));
01851 
01852               <span class="comment">// caller will advance instruction pointer</span>
01853               <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> | <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a3">FAULT_TO_TRAP</a>); <span class="comment">// will raise I trap</span>
01854 
01855             }
01856 
01857           <span class="comment">// Case (II)</span>
01858           } <span class="keywordflow">else</span> {
01859 
01860             <a class="code" href="../../d6/d2/feproto_8h.html#a36">frsqrta</a> (ps, sf, qp, lf1, p2, lf3);
01861 
01862             <span class="keywordflow">if</span> ((ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o8">state_MERCED_RTL</a> &gt;&gt; 16) &amp; 0x0ffff) <span class="keywordflow">goto</span> new_exception;
01863 
01864             *pfpsr =  ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o2">state_AR</a>[0].<a class="code" href="../../d9/d0/unionar__union.html#o1">uint_value</a>;
01865             <span class="comment">// set the destination floating-point and predicate reg values</span>
01866 <span class="preprocessor">#ifdef DEBUG_UNIX</span>
01867 <span class="preprocessor"></span>printf (<span class="stringliteral">"DEBUG Case (II) AFTER F7 SWA FAULT 3: ps-&gt;state_FR[lf1] = %x %x %Lx\n"</span>,
01868   ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o2">sign</a>, ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o1">exponent</a>, 
01869   ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o0">significand</a>);
01870 <span class="preprocessor">#endif</span>
01871 <span class="preprocessor"></span>            <a class="code" href="../../d6/d5/ia64_2getsetrg_8c.html#a9">set_fp_register</a> (f1, <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a85">FPRegToFP128</a>(ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1]), fp_state);
01872             <span class="keywordflow">if</span> (f1 &lt; 32)
01873               *pipsr = *pipsr | (<a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a>)0x10; <span class="comment">// set mfl bit</span>
01874             <span class="keywordflow">else</span>
01875               *pipsr = *pipsr | (<a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a>)0x20; <span class="comment">// set mfh bit</span>
01876 
01877             <span class="comment">// update ps-&gt;state_PR[p2] = 1 for positive arguments only</span>
01878             *ppreds &amp;= (~(((<a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a>)1) &lt;&lt; (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)p2));
01879             *ppreds |=
01880                 (((<a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a>)(ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o5">state_PR</a>[p2] &amp; 0x01)) &lt;&lt; (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)p2);
01881 <span class="preprocessor">#ifdef DEBUG_UNIX</span>
01882 <span class="preprocessor"></span>printf (<span class="stringliteral">"DEBUG  Case (II) AFTER F7 SWA FAULT 3 a: p2 = %x\n"</span>, p2);
01883 <span class="preprocessor">#endif</span>
01884 <span class="preprocessor"></span><span class="preprocessor">#ifdef DEBUG_UNIX</span>
01885 <span class="preprocessor"></span>printf (<span class="stringliteral">"DEBUG Case (II) AFTER F7 SWA FAULT 3 a: *ppreds = %Lx\n"</span>, *ppreds);
01886 <span class="preprocessor">#endif</span>
01887 <span class="preprocessor"></span>            <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01888 
01889           }
01890 
01891           <span class="keywordflow">break</span>;
01892 
01893         <span class="keywordflow">case</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a45">FPRSQRTA_PATTERN</a>:
01894 
01895           <span class="comment">// should get here only for denormal inputs</span>
01896           <a class="code" href="../../d6/d2/feproto_8h.html#a37">fprsqrta</a> (ps, sf, qp, lf1, p2, lf3);
01897 
01898           <span class="keywordflow">if</span> ((ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o8">state_MERCED_RTL</a> &gt;&gt; 16) &amp; 0x0ffff) <span class="keywordflow">goto</span> new_exception;
01899 
01900           *pfpsr =  ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o2">state_AR</a>[0].<a class="code" href="../../d9/d0/unionar__union.html#o1">uint_value</a>;
01901           <span class="comment">// set the destination floating-point and predicate </span>
01902           <span class="comment">// reg values (redundant, as the output predicate will be cleared)</span>
01903 <span class="preprocessor">#ifdef DEBUG_UNIX</span>
01904 <span class="preprocessor"></span>printf (<span class="stringliteral">"DEBUG AFTER F7 FPRSQRTA SWA FAULT 4: ps-&gt;state_FR[lf1] = %x %x %Lx\n"</span>,
01905   ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o2">sign</a>, ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o1">exponent</a>, 
01906   ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o0">significand</a>);
01907 <span class="preprocessor">#endif</span>
01908 <span class="preprocessor"></span>          <a class="code" href="../../d6/d5/ia64_2getsetrg_8c.html#a9">set_fp_register</a> (f1, <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a85">FPRegToFP128</a>(ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1]), fp_state);
01909           <span class="keywordflow">if</span> (f1 &lt; 32)
01910             *pipsr = *pipsr | (<a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a>)0x10; <span class="comment">// set mfl bit</span>
01911           <span class="keywordflow">else</span>
01912             *pipsr = *pipsr | (<a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a>)0x20; <span class="comment">// set mfh bit</span>
01913 
01914           <span class="comment">// update ps-&gt;state_PR[p2] = 0; clear the output predicate</span>
01915           *ppreds &amp;= (~(((<a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a>)1) &lt;&lt; (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)p2));
01916           *ppreds |= 
01917               (((<a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a>)(ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o5">state_PR</a>[p2] &amp; 0x01)) &lt;&lt; (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)p2);
01918 <span class="preprocessor">#ifdef DEBUG_UNIX</span>
01919 <span class="preprocessor"></span>printf (<span class="stringliteral">"DEBUG AFTER F7 FPRSQRTA SWA FAULT 4 a: *ppreds = %Lx\n"</span>, *ppreds);
01920 <span class="preprocessor">#endif</span>
01921 <span class="preprocessor"></span>          <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
01922 
01923       }
01924 
01925     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((OpCode &amp; <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a46">F8_MIN_MASK</a>) == <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a47">F8_PATTERN</a>) {
01926       <span class="comment">// F8 instruction</span>
01927 
01928       <span class="comment">// extract f3, f2, and f1</span>
01929       f3 = (<a class="code" href="../../d2/d3/fetypes_8h.html#a446">EM_fp_reg_specifier</a>)((OpCode &gt;&gt; 20) &amp; <a class="code" href="../../d2/d3/fetypes_8h.html#a3">CONST_FORMAT</a>(0x00000000007F));
01930       <span class="keywordflow">if</span> (f3 &gt;= 32) f3 = 32 + (rrbfr + f3 - 32) % 96;
01931       f2 = (<a class="code" href="../../d2/d3/fetypes_8h.html#a446">EM_fp_reg_specifier</a>)((OpCode &gt;&gt; 13) &amp; <a class="code" href="../../d2/d3/fetypes_8h.html#a3">CONST_FORMAT</a>(0x00000000007F));
01932       <span class="keywordflow">if</span> (f2 &gt;= 32) f2 = 32 + (rrbfr + f2 - 32) % 96;
01933       f1 = (<a class="code" href="../../d2/d3/fetypes_8h.html#a446">EM_fp_reg_specifier</a>)((OpCode &gt;&gt;  6) &amp; <a class="code" href="../../d2/d3/fetypes_8h.html#a3">CONST_FORMAT</a>(0x00000000007F));
01934       <span class="keywordflow">if</span> (f1 &gt;= 32) f1 = 32 + (rrbfr + f1 - 32) % 96;
01935 
01936       <span class="comment">// get source floating-point reg values</span>
01937       ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf2] = <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a84">FP128ToFPReg</a> (<a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a86">get_fp_register</a> (f2, fp_state));
01938       ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf3] = <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a84">FP128ToFPReg</a> (<a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a86">get_fp_register</a> (f3, fp_state));
01939 <span class="preprocessor">#ifdef DEBUG_UNIX</span>
01940 <span class="preprocessor"></span>printf (<span class="stringliteral">"DEBUG BEFORE F8 SWA FAULT: ps-&gt;state_FR[lf2] = %x %x %Lx\n"</span>,
01941   ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf2].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o2">sign</a>, ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf2].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o1">exponent</a>, ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf2].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o0">significand</a>);
01942 printf (<span class="stringliteral">"DEBUG BEFORE F8 SWA FAULT: ps-&gt;state_FR[lf3] = %x %x %Lx\n"</span>,
01943   ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf3].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o2">sign</a>, ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf3].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o1">exponent</a>, ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf3].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o0">significand</a>);
01944 <span class="preprocessor">#endif</span>
01945 <span class="preprocessor"></span>
01946       <span class="keywordflow">switch</span> (OpCode &amp; <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a48">F8_MASK</a>) {
01947 
01948         <span class="keywordflow">case</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a49">FMIN_PATTERN</a>:
01949           SIMD_instruction = 0;
01950           <a class="code" href="../../d6/d2/feproto_8h.html#a28">fmin</a> (ps, sf, qp, lf1, lf2, lf3);
01951           <span class="keywordflow">break</span>;
01952         <span class="keywordflow">case</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a50">FMAX_PATTERN</a>:
01953           SIMD_instruction = 0;
01954           <a class="code" href="../../d6/d2/feproto_8h.html#a26">fmax</a> (ps, sf, qp, lf1, lf2, lf3);
01955           <span class="keywordflow">break</span>;
01956         <span class="keywordflow">case</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a51">FAMIN_PATTERN</a>:
01957           SIMD_instruction = 0;
01958           <a class="code" href="../../d6/d2/feproto_8h.html#a2">famin</a> (ps, sf, qp, lf1, lf2, lf3);
01959           <span class="keywordflow">break</span>;
01960         <span class="keywordflow">case</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a52">FAMAX_PATTERN</a>:
01961           SIMD_instruction = 0;
01962           <a class="code" href="../../d6/d2/feproto_8h.html#a0">famax</a> (ps, sf, qp, lf1, lf2, lf3);
01963           <span class="keywordflow">break</span>;
01964         <span class="keywordflow">case</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a53">FPMIN_PATTERN</a>:
01965           SIMD_instruction = 1;
01966           <a class="code" href="../../d6/d2/feproto_8h.html#a29">fpmin</a> (ps, sf, qp, lf1, lf2, lf3);
01967           <span class="keywordflow">break</span>;
01968         <span class="keywordflow">case</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a54">FPMAX_PATTERN</a>:
01969           SIMD_instruction = 1;
01970           <a class="code" href="../../d6/d2/feproto_8h.html#a27">fpmax</a> (ps, sf, qp, lf1, lf2, lf3);
01971           <span class="keywordflow">break</span>;
01972         <span class="keywordflow">case</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a55">FPAMIN_PATTERN</a>:
01973           SIMD_instruction = 1;
01974           <a class="code" href="../../d6/d2/feproto_8h.html#a3">fpamin</a> (ps, sf, qp, lf1, lf2, lf3);
01975           <span class="keywordflow">break</span>;
01976         <span class="keywordflow">case</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a56">FPAMAX_PATTERN</a>:
01977           SIMD_instruction = 1;
01978           <a class="code" href="../../d6/d2/feproto_8h.html#a1">fpamax</a> (ps, sf, qp, lf1, lf2, lf3);
01979           <span class="keywordflow">break</span>;
01980 
01981         <span class="keywordflow">case</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a57">FPCMP_EQ_PATTERN</a>:
01982           SIMD_instruction = 1;
01983           <a class="code" href="../../d6/d2/feproto_8h.html#a8">fpcmp_eq</a> (ps, sf, qp, lf1, lf2, lf3);
01984           <span class="keywordflow">break</span>;
01985         <span class="keywordflow">case</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a58">FPCMP_LT_PATTERN</a>:
01986           SIMD_instruction = 1;
01987           <a class="code" href="../../d6/d2/feproto_8h.html#a9">fpcmp_lt</a> (ps, sf, qp, lf1, lf2, lf3);
01988           <span class="keywordflow">break</span>;
01989         <span class="keywordflow">case</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a59">FPCMP_LE_PATTERN</a>:
01990           SIMD_instruction = 1;
01991           <a class="code" href="../../d6/d2/feproto_8h.html#a10">fpcmp_le</a> (ps, sf, qp, lf1, lf2, lf3);
01992           <span class="keywordflow">break</span>;
01993         <span class="keywordflow">case</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a60">FPCMP_UNORD_PATTERN</a>:
01994           SIMD_instruction = 1;
01995           <a class="code" href="../../d6/d2/feproto_8h.html#a11">fpcmp_unord</a> (ps, sf, qp, lf1, lf2, lf3);
01996           <span class="keywordflow">break</span>;
01997         <span class="keywordflow">case</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a61">FPCMP_NEQ_PATTERN</a>:
01998           SIMD_instruction = 1;
01999           <a class="code" href="../../d6/d2/feproto_8h.html#a12">fpcmp_neq</a> (ps, sf, qp, lf1, lf2, lf3);
02000           <span class="keywordflow">break</span>;
02001         <span class="keywordflow">case</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a62">FPCMP_NLT_PATTERN</a>:
02002           SIMD_instruction = 1;
02003           <a class="code" href="../../d6/d2/feproto_8h.html#a13">fpcmp_nlt</a> (ps, sf, qp, lf1, lf2, lf3);
02004           <span class="keywordflow">break</span>;
02005         <span class="keywordflow">case</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a63">FPCMP_NLE_PATTERN</a>:
02006           SIMD_instruction = 1;
02007           <a class="code" href="../../d6/d2/feproto_8h.html#a14">fpcmp_nle</a> (ps, sf, qp, lf1, lf2, lf3);
02008           <span class="keywordflow">break</span>;
02009         <span class="keywordflow">case</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a64">FPCMP_ORD_PATTERN</a>:
02010           SIMD_instruction = 1;
02011           <a class="code" href="../../d6/d2/feproto_8h.html#a15">fpcmp_ord</a> (ps, sf, qp, lf1, lf2, lf3);
02012           <span class="keywordflow">break</span>;
02013 
02014         <span class="keywordflow">default</span>:
02015           <span class="comment">// unrecognized instruction type</span>
02016 <span class="preprocessor">#ifndef unix</span>
02017 <span class="preprocessor"></span>          <a class="code" href="../../d9/d1/fedefs_8h.html#a2">FP_EMULATION_ERROR1</a> (<span class="stringliteral">"fp_emulate () Internal Error: \</span>
02018 <span class="stringliteral">instruction opcode %8x %8x not recognized\n"</span>, OpCode);
02019 <span class="preprocessor">#else</span>
02020 <span class="preprocessor"></span>          <a class="code" href="../../d9/d1/fedefs_8h.html#a2">FP_EMULATION_ERROR1</a> (<span class="stringliteral">"fp_emulate () Internal Error: \</span>
02021 <span class="stringliteral">instruction opcode %Lx not recognized\n"</span>, OpCode);
02022           <span class="keywordflow">return</span> (<a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a2">FP_EMUL_ERROR</a>);
02023 <span class="preprocessor">#endif</span>
02024 <span class="preprocessor"></span>      }
02025 
02026       <span class="keywordflow">if</span> ((ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o8">state_MERCED_RTL</a> &gt;&gt; 16) &amp; 0x0ffff) <span class="keywordflow">goto</span> new_exception;
02027 
02028       <span class="comment">// successful emulation</span>
02029       <span class="comment">// set the destination floating-point reg value</span>
02030 <span class="preprocessor">#ifdef DEBUG_UNIX</span>
02031 <span class="preprocessor"></span>printf (<span class="stringliteral">"DEBUG AFTER F8 SWA FAULT: ps-&gt;state_FR[lf1] = %x %x %Lx\n"</span>,
02032   ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o2">sign</a>, ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o1">exponent</a>, 
02033   ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o0">significand</a>);
02034 <span class="preprocessor">#endif</span>
02035 <span class="preprocessor"></span>      <a class="code" href="../../d6/d5/ia64_2getsetrg_8c.html#a9">set_fp_register</a> (f1, <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a85">FPRegToFP128</a>(ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1]), fp_state);
02036       <span class="keywordflow">if</span> (f1 &lt; 32)
02037         *pipsr = *pipsr | (<a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a>)0x10; <span class="comment">// set mfl bit</span>
02038       <span class="keywordflow">else</span>
02039         *pipsr = *pipsr | (<a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a>)0x20; <span class="comment">// set mfh bit</span>
02040 
02041       *pfpsr =  ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o2">state_AR</a>[0].<a class="code" href="../../d9/d0/unionar__union.html#o1">uint_value</a>;
02042       <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02043 
02044     } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((OpCode &amp; <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a65">F10_MIN_MASK</a>) == <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a66">F10_PATTERN</a>) {
02045       <span class="comment">// F10 instruction</span>
02046 
02047       <span class="comment">// extract f2 and f1</span>
02048       f2 = (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)((OpCode &gt;&gt; 13) &amp; <a class="code" href="../../d2/d3/fetypes_8h.html#a3">CONST_FORMAT</a>(0x00000000007F));
02049       <span class="keywordflow">if</span> (f2 &gt;= 32) f2 = 32 + (rrbfr + f2 - 32) % 96;
02050       f1 = (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)((OpCode &gt;&gt;  6) &amp; <a class="code" href="../../d2/d3/fetypes_8h.html#a3">CONST_FORMAT</a>(0x00000000007F));
02051       <span class="keywordflow">if</span> (f1 &gt;= 32) f1 = 32 + (rrbfr + f1 - 32) % 96;
02052 
02053       <span class="comment">// get source floating-point reg value</span>
02054       ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf2] = <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a84">FP128ToFPReg</a> (<a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a86">get_fp_register</a> (f2, fp_state));
02055 <span class="preprocessor">#ifdef DEBUG_UNIX</span>
02056 <span class="preprocessor"></span>printf (<span class="stringliteral">"DEBUG BEFORE F10 SWA FAULT: ps-&gt;state_FR[lf2] = %x %x %Lx\n"</span>,
02057   ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf2].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o2">sign</a>, ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf2].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o1">exponent</a>, ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf2].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o0">significand</a>);
02058 <span class="preprocessor">#endif</span>
02059 <span class="preprocessor"></span>
02060       <span class="keywordflow">switch</span> (OpCode &amp; <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a67">F10_MASK</a>) {
02061 
02062         <span class="keywordflow">case</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a68">FCVT_FX_PATTERN</a>:
02063           SIMD_instruction = 0;
02064           <a class="code" href="../../d6/d2/feproto_8h.html#a16">fcvt_fx</a> (ps, sf, qp, lf1, lf2);
02065           <span class="keywordflow">break</span>;
02066         <span class="keywordflow">case</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a69">FCVT_FXU_PATTERN</a>:
02067           SIMD_instruction = 0;
02068           <a class="code" href="../../d6/d2/feproto_8h.html#a18">fcvt_fxu</a> (ps, sf, qp, lf1, lf2);
02069           <span class="keywordflow">break</span>;
02070         <span class="keywordflow">case</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a70">FCVT_FX_TRUNC_PATTERN</a>:
02071           SIMD_instruction = 0;
02072           <a class="code" href="../../d6/d2/feproto_8h.html#a17">fcvt_fx_trunc</a> (ps, sf, qp, lf1, lf2);
02073           <span class="keywordflow">break</span>;
02074         <span class="keywordflow">case</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a71">FCVT_FXU_TRUNC_PATTERN</a>:
02075           SIMD_instruction = 0;
02076           <a class="code" href="../../d6/d2/feproto_8h.html#a19">fcvt_fxu_trunc</a> (ps, sf, qp, lf1, lf2);
02077           <span class="keywordflow">break</span>;
02078         <span class="keywordflow">case</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a72">FPCVT_FX_PATTERN</a>:
02079           SIMD_instruction = 1;
02080           <a class="code" href="../../d6/d2/feproto_8h.html#a22">fpcvt_fx</a> (ps, sf, qp, lf1, lf2);
02081           <span class="keywordflow">break</span>;
02082         <span class="keywordflow">case</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a73">FPCVT_FXU_PATTERN</a>:
02083           SIMD_instruction = 1;
02084           <a class="code" href="../../d6/d2/feproto_8h.html#a21">fpcvt_fxu</a> (ps, sf, qp, lf1, lf2);
02085           <span class="keywordflow">break</span>;
02086         <span class="keywordflow">case</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a74">FPCVT_FX_TRUNC_PATTERN</a>:
02087           SIMD_instruction = 1;
02088           <a class="code" href="../../d6/d2/feproto_8h.html#a23">fpcvt_fx_trunc</a> (ps, sf, qp, lf1, lf2);
02089           <span class="keywordflow">break</span>;
02090         <span class="keywordflow">case</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a75">FPCVT_FXU_TRUNC_PATTERN</a>:
02091           SIMD_instruction = 1;
02092           <a class="code" href="../../d6/d2/feproto_8h.html#a20">fpcvt_fxu_trunc</a> (ps, sf, qp, lf1, lf2);
02093           <span class="keywordflow">break</span>;
02094         <span class="keywordflow">default</span>:
02095           <span class="comment">// unrecognized instruction type</span>
02096 <span class="preprocessor">#ifndef unix</span>
02097 <span class="preprocessor"></span>          <a class="code" href="../../d9/d1/fedefs_8h.html#a2">FP_EMULATION_ERROR1</a> (<span class="stringliteral">"fp_emulate () Internal Error: \</span>
02098 <span class="stringliteral">instruction opcode %8x %8x not recognized\n"</span>, OpCode);
02099 <span class="preprocessor">#else</span>
02100 <span class="preprocessor"></span>          <a class="code" href="../../d9/d1/fedefs_8h.html#a2">FP_EMULATION_ERROR1</a> (<span class="stringliteral">"fp_emulate () Internal Error: \</span>
02101 <span class="stringliteral">instruction opcode %Lx not recognized\n"</span>, OpCode);
02102           <span class="keywordflow">return</span> (<a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a2">FP_EMUL_ERROR</a>);
02103 <span class="preprocessor">#endif</span>
02104 <span class="preprocessor"></span>      }
02105 
02106       <span class="keywordflow">if</span> ((ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o8">state_MERCED_RTL</a> &gt;&gt; 16) &amp; 0x0ffff) <span class="keywordflow">goto</span> new_exception;
02107 
02108       <span class="comment">// successful emulation</span>
02109       <span class="comment">// set the destination floating-point reg value</span>
02110 <span class="preprocessor">#ifdef DEBUG_UNIX</span>
02111 <span class="preprocessor"></span>printf (<span class="stringliteral">"DEBUG AFTER F10 SWA FAULT: ps-&gt;state_FR[lf1] = %x %x %Lx\n"</span>,
02112   ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o2">sign</a>, ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o1">exponent</a>, 
02113   ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o0">significand</a>);
02114 <span class="preprocessor">#endif</span>
02115 <span class="preprocessor"></span>      <a class="code" href="../../d6/d5/ia64_2getsetrg_8c.html#a9">set_fp_register</a> (f1, <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a85">FPRegToFP128</a>(ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1]), fp_state);
02116       <span class="keywordflow">if</span> (f1 &lt; 32)
02117         *pipsr = *pipsr | (<a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a>)0x10; <span class="comment">// set mfl bit</span>
02118       <span class="keywordflow">else</span>
02119         *pipsr = *pipsr | (<a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a>)0x20; <span class="comment">// set mfh bit</span>
02120 
02121       *pfpsr =  ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o2">state_AR</a>[0].<a class="code" href="../../d9/d0/unionar__union.html#o1">uint_value</a>;
02122       <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02123 
02124     } <span class="keywordflow">else</span> {
02125 
02126       <span class="comment">// unrecognized instruction type</span>
02127 <span class="preprocessor">#ifndef unix</span>
02128 <span class="preprocessor"></span>      <a class="code" href="../../d9/d1/fedefs_8h.html#a2">FP_EMULATION_ERROR1</a> (<span class="stringliteral">"fp_emulate () Internal Error: \</span>
02129 <span class="stringliteral">instruction opcode %8x %8x not recognized\n"</span>, OpCode);
02130 <span class="preprocessor">#else</span>
02131 <span class="preprocessor"></span>      <a class="code" href="../../d9/d1/fedefs_8h.html#a2">FP_EMULATION_ERROR1</a> (<span class="stringliteral">"fp_emulate () Internal Error: \</span>
02132 <span class="stringliteral">instruction opcode %Lx not recognized\n"</span>, OpCode);
02133       <span class="keywordflow">return</span> (<a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a2">FP_EMUL_ERROR</a>);
02134 <span class="preprocessor">#endif</span>
02135 <span class="preprocessor"></span>    }
02136 
02137     <span class="comment">// advance instruction pointer in the trap frame</span>
02138 
02139     <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02140 
02141     <span class="comment">// end 'if ((trap_type == FPFLT) &amp;&amp; (ISRlow &amp; 0x0088))'</span>
02142 
02143   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((trap_type == <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a6">FPTRAP</a>) &amp;&amp; <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a83">swa_trap</a> (sf, <a class="code" href="../../d9/d2/festate_8h.html#a0">FPSR</a>, ISRlow)) {
02144 
02145     <span class="comment">// else if this is a SWA trap</span>
02146 
02147     <span class="comment">// this can only happen in one situation for Merced at the present time:</span>
02148     <span class="comment">// for a tiny result (which can occur only for an F1 instruction), when the</span>
02149     <span class="comment">// underflow exceptions are disabled; the IA-64 FP Emulation Library also</span>
02150     <span class="comment">// handles correctly the situations in which a huge result occurs, and the</span>
02151     <span class="comment">// overflow exceptions are disabled, or when an inexact result occurs, and</span>
02152     <span class="comment">// the inexact exceptions are disabled</span>
02153 
02154     <span class="comment">// shortcut the case when the result is inexact, and the inexact exceptions</span>
02155     <span class="comment">// are disabled</span>
02156     <span class="keywordflow">if</span> ((ISRlow &amp; 0x1980) == 0) <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>); <span class="comment">// nothing to do in this case</span>
02157 
02158     <span class="comment">// Note: overflow, which can also be caused only by an F1 instruction</span>
02159     <span class="comment">// (but not on Merced) is included too; </span>
02160 
02161     <span class="comment">// Note that for Merced, if a SWA trap occurs, fp_emulate () is</span>
02162     <span class="comment">// entered with U exceptions disabled and the U flag set in the ISR code;</span>
02163     <span class="comment">// the I flag can be set or not (unlike the U flag in the FPSR in the</span>
02164     <span class="comment">// absence of a trap, which will be set together with the I flag when</span>
02165     <span class="comment">// U traps are disabled [with U traps disabled, the result has to be</span>
02166     <span class="comment">// tiny and inexact for the U flag to be set - the I flag will be set </span>
02167     <span class="comment">// too])</span>
02168 
02169     <span class="comment">// SIMD_instruction unchanged at 2</span>
02170 
02171     <span class="comment">// decode the rest of the instruction</span>
02172     <span class="keywordflow">if</span> ((OpCode &amp; <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a10">F1_MIN_MASK</a>) == <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a11">F1_PATTERN</a>) {
02173       <span class="comment">// F1 instruction</span>
02174 
02175       <span class="comment">// extract f1</span>
02176       f1 = (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)((OpCode &gt;&gt;  6) &amp; <a class="code" href="../../d2/d3/fetypes_8h.html#a3">CONST_FORMAT</a>(0x00000000007F));
02177       <span class="keywordflow">if</span> (f1 &gt;= 32) f1 = 32 + (rrbfr + f1 - 32) % 96;
02178 <span class="preprocessor">#ifdef DEBUG_UNIX</span>
02179 <span class="preprocessor"></span>printf (<span class="stringliteral">"DEBUG BEFORE F1 SWA TRAP: f1 = %x\n"</span>, f1);
02180 <span class="preprocessor">#endif</span>
02181 <span class="preprocessor"></span>
02182       <span class="comment">// no need to get the source floating-point reg values - they </span>
02183       <span class="comment">// might have changed</span>
02184 
02185       <span class="comment">// read the destination reg f1</span>
02186       ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1] = <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a84">FP128ToFPReg</a> (<a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a86">get_fp_register</a> (f1, fp_state));
02187 <span class="preprocessor">#ifdef DEBUG_UNIX</span>
02188 <span class="preprocessor"></span>printf (<span class="stringliteral">"DEBUG BEFORE F1 SWA TRAP: ps-&gt;state_FR[lf1] = %x %x %Lx\n"</span>,
02189   ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o2">sign</a>, ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o1">exponent</a>, 
02190   ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o0">significand</a>);
02191 <span class="preprocessor">#endif</span>
02192 <span class="preprocessor"></span>
02193       <span class="keywordflow">switch</span> (OpCode &amp; <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a12">F1_MASK</a>) {
02194 
02195         <span class="keywordflow">case</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a13">FMA_PATTERN</a>:
02196         <span class="keywordflow">case</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a17">FMS_PATTERN</a>:
02197         <span class="keywordflow">case</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a21">FNMA_PATTERN</a>:
02198           opcode_pc = <a class="code" href="../../d2/d3/fetypes_8h.html#a448a368">pc_sf</a>;
02199           <span class="keywordflow">break</span>;
02200         <span class="keywordflow">case</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a14">FMA_S_PATTERN</a>:
02201         <span class="keywordflow">case</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a18">FMS_S_PATTERN</a>:
02202         <span class="keywordflow">case</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a22">FNMA_S_PATTERN</a>:
02203           opcode_pc = <a class="code" href="../../d2/d3/fetypes_8h.html#a448a366">pc_s</a>;
02204           <span class="keywordflow">break</span>;
02205         <span class="keywordflow">case</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a15">FMA_D_PATTERN</a>:
02206         <span class="keywordflow">case</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a19">FMS_D_PATTERN</a>:
02207         <span class="keywordflow">case</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a23">FNMA_D_PATTERN</a>:
02208           opcode_pc = <a class="code" href="../../d2/d3/fetypes_8h.html#a448a367">pc_d</a>;
02209           <span class="keywordflow">break</span>;
02210         <span class="keywordflow">case</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a16">FPMA_PATTERN</a>:
02211         <span class="keywordflow">case</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a20">FPMS_PATTERN</a>:
02212         <span class="keywordflow">case</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a24">FPNMA_PATTERN</a>:
02213           opcode_pc = <a class="code" href="../../d2/d3/fetypes_8h.html#a448a370">pc_simd</a>;
02214           <span class="keywordflow">break</span>;
02215 
02216         <span class="keywordflow">default</span>:
02217           <span class="comment">// unrecognized instruction type</span>
02218 <span class="preprocessor">#ifndef unix</span>
02219 <span class="preprocessor"></span>          <a class="code" href="../../d9/d1/fedefs_8h.html#a2">FP_EMULATION_ERROR1</a> (<span class="stringliteral">"fp_emulate () Internal Error: \</span>
02220 <span class="stringliteral">instruction opcode %8x %8x not recognized\n"</span>, OpCode);
02221 <span class="preprocessor">#else</span>
02222 <span class="preprocessor"></span>          <a class="code" href="../../d9/d1/fedefs_8h.html#a2">FP_EMULATION_ERROR1</a> (<span class="stringliteral">"fp_emulate () Internal Error: \</span>
02223 <span class="stringliteral">instruction opcode %Lx not recognized\n"</span>, OpCode);
02224           <span class="keywordflow">return</span> (<a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a2">FP_EMUL_ERROR</a>);
02225 <span class="preprocessor">#endif</span>
02226 <span class="preprocessor"></span>      }
02227 
02228       <span class="comment">// SWA trap - software assistance required</span>
02229 
02230       <span class="comment">// implement table 3-5 of EM EAS 2.1</span>
02231       rc = (<a class="code" href="../../d2/d3/fetypes_8h.html#a455">EM_sf_rc_type</a>)((<a class="code" href="../../d9/d2/festate_8h.html#a0">FPSR</a> &gt;&gt; (6 + 4 + 13 * (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)sf)) &amp; 0x03);
02232       pc = (<a class="code" href="../../d2/d3/fetypes_8h.html#a454">EM_sf_pc_type</a>)((<a class="code" href="../../d9/d2/festate_8h.html#a0">FPSR</a> &gt;&gt; (6 + 2 + 13 * (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)sf)) &amp; 0x03);
02233       wre = (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)((<a class="code" href="../../d9/d2/festate_8h.html#a0">FPSR</a> &gt;&gt; (6 + 1 + 13 * (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)sf)) &amp; 0x01);
02234 
02235       <span class="comment">// determine the precision of the result, the size of the exponent,</span>
02236       <span class="comment">// and emin</span>
02237       <span class="keywordflow">if</span> (opcode_pc == <a class="code" href="../../d2/d3/fetypes_8h.html#a448a370">pc_simd</a> || opcode_pc == <a class="code" href="../../d2/d3/fetypes_8h.html#a448a366">pc_s</a> &amp;&amp; wre == 0) {
02238         significand_size = 24;
02239         emin = <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a76">EMIN_08_BITS</a>;
02240       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (opcode_pc == <a class="code" href="../../d2/d3/fetypes_8h.html#a448a367">pc_d</a> &amp;&amp; wre == 0) {
02241         significand_size = 53;
02242         emin = <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a77">EMIN_11_BITS</a>;
02243       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (opcode_pc == <a class="code" href="../../d2/d3/fetypes_8h.html#a448a366">pc_s</a> &amp;&amp; wre == 1) {
02244         significand_size = 24;
02245         emin = <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a79">EMIN_17_BITS</a>;
02246       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (opcode_pc == <a class="code" href="../../d2/d3/fetypes_8h.html#a448a367">pc_d</a> &amp;&amp; wre == 1) {
02247         significand_size = 53;
02248         emin = <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a79">EMIN_17_BITS</a>;
02249       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (opcode_pc == <a class="code" href="../../d2/d3/fetypes_8h.html#a448a368">pc_sf</a>) {
02250         <span class="keywordflow">if</span> (pc == <a class="code" href="../../d2/d3/fetypes_8h.html#a454a408">sf_single</a> &amp;&amp; wre == 0) {
02251           significand_size = 24;
02252           emin = <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a78">EMIN_15_BITS</a>;
02253         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pc == <a class="code" href="../../d2/d3/fetypes_8h.html#a454a410">sf_double</a> &amp;&amp; wre == 0) {
02254           significand_size = 53;
02255           emin = <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a78">EMIN_15_BITS</a>;
02256         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pc == <a class="code" href="../../d2/d3/fetypes_8h.html#a454a411">sf_double_extended</a> &amp;&amp; wre == 0) {
02257           significand_size = 64;
02258           emin = <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a78">EMIN_15_BITS</a>;
02259         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pc == <a class="code" href="../../d2/d3/fetypes_8h.html#a454a408">sf_single</a> &amp;&amp; wre == 1) {
02260           significand_size = 24;
02261           emin = <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a79">EMIN_17_BITS</a>;
02262         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pc == <a class="code" href="../../d2/d3/fetypes_8h.html#a454a410">sf_double</a> &amp;&amp; wre == 1) {
02263           significand_size = 53;
02264           emin = <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a79">EMIN_17_BITS</a>;
02265         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pc == <a class="code" href="../../d2/d3/fetypes_8h.html#a454a411">sf_double_extended</a> &amp;&amp; wre == 1) {
02266           significand_size = 64;
02267           emin = <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a79">EMIN_17_BITS</a>;
02268         } <span class="keywordflow">else</span> {
02269 <span class="preprocessor">#ifndef unix</span>
02270 <span class="preprocessor"></span>          <a class="code" href="../../d9/d1/fedefs_8h.html#a1">FP_EMULATION_ERROR0</a> (<span class="stringliteral">"fp_emulate () internal error in \</span>
02271 <span class="stringliteral">determining the computation model\n"</span>);
02272         }
02273       } <span class="keywordflow">else</span> {
02274         <a class="code" href="../../d9/d1/fedefs_8h.html#a1">FP_EMULATION_ERROR0</a> (<span class="stringliteral">"fp_emulate () internal error in \</span>
02275 <span class="stringliteral">determining the computation model\n"</span>);
02276 <span class="preprocessor">#else</span>
02277 <span class="preprocessor"></span>          <a class="code" href="../../d9/d1/fedefs_8h.html#a1">FP_EMULATION_ERROR0</a> (<span class="stringliteral">"fp_emulate () internal error in \</span>
02278 <span class="stringliteral">determining the computation model\n"</span>);
02279           <span class="keywordflow">return</span> (<a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a2">FP_EMUL_ERROR</a>);
02280         }
02281       } <span class="keywordflow">else</span> {
02282         <a class="code" href="../../d9/d1/fedefs_8h.html#a1">FP_EMULATION_ERROR0</a> (<span class="stringliteral">"fp_emulate () internal error in \</span>
02283 <span class="stringliteral">determining the computation model\n"</span>);
02284         <span class="keywordflow">return</span> (<a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a2">FP_EMUL_ERROR</a>);
02285 <span class="preprocessor">#endif</span>
02286 <span class="preprocessor"></span>      }
02287 
02288       tmp_fp = ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1];
02289 
02290       <span class="comment">// Note: if the cause of the SWA trap is O or U, cannot get here with</span>
02291       <span class="comment">// zero or a denormal in FR[f1]; if U, the result in FR[f1] will have</span>
02292       <span class="comment">// to be denormalized</span>
02293       <span class="keywordflow">if</span> (opcode_pc != <a class="code" href="../../d2/d3/fetypes_8h.html#a448a370">pc_simd</a>) { <span class="comment">// non-SIMD instruction</span>
02294 
02295         fpa = (ISRlow &gt;&gt; 14) &amp; 0x01;
02296         I_exc = (ISRlow &gt;&gt; 13) &amp; 0x01; <span class="comment">// inexact = round OR sticky</span>
02297         U_exc = (ISRlow &gt;&gt; 12) &amp; 0x01; <span class="comment">// underflow</span>
02298         O_exc = (ISRlow &gt;&gt; 11) &amp; 0x01; <span class="comment">// overflow</span>
02299 
02300         sign = tmp_fp.<a class="code" href="../../d0/d0/structfp__reg__struct.html#o2">sign</a>;
02301         exponent = tmp_fp.<a class="code" href="../../d0/d0/structfp__reg__struct.html#o1">exponent</a>;
02302         significand = tmp_fp.<a class="code" href="../../d0/d0/structfp__reg__struct.html#o0">significand</a>;
02303 
02304         <span class="comment">// calculate the true biased exponent, and then the true exponent</span>
02305         <span class="keywordflow">if</span> (U_dis &amp;&amp; U_exc) { <span class="comment">// the result is not zero, and is normal with</span>
02306             <span class="comment">// unbounded exponent (tiny result)</span>
02307 
02308           decr_exp = 0;
02309   
02310           <span class="comment">// extract the number of significand bits specified by the </span>
02311           <span class="comment">// destination precision, and determine the significand, before </span>
02312           <span class="comment">// the rounding performed in hardware (1st IEEE rounding)</span>
02313   
02314           <span class="keywordflow">if</span> (significand_size == 64) {
02315             <span class="keywordflow">if</span> (fpa == 1) {
02316               significand = significand - 1;
02317               <span class="keywordflow">if</span> (significand == <a class="code" href="../../d2/d3/fetypes_8h.html#a3">CONST_FORMAT</a>(0x07fffffffffffffff)) {
02318                 significand = <a class="code" href="../../d2/d3/fetypes_8h.html#a3">CONST_FORMAT</a>(0x0ffffffffffffffff);
02319                 decr_exp = 1;
02320               }
02321             }
02322           } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (significand_size == 53) {
02323             <span class="comment">// the 53 bits are already there, but need to be shifted right</span>
02324             significand = significand &gt;&gt; 11;
02325             <span class="keywordflow">if</span> (fpa == 1) {
02326               significand = significand - 1;
02327               <span class="keywordflow">if</span> (significand == <a class="code" href="../../d2/d3/fetypes_8h.html#a3">CONST_FORMAT</a>(0x0fffffffffffff)) {
02328                 significand = <a class="code" href="../../d2/d3/fetypes_8h.html#a3">CONST_FORMAT</a>(0x01fffffffffffff);
02329                 decr_exp = 1;
02330               }
02331             }
02332           } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (significand_size == 24) {
02333             <span class="comment">// the 24 bits are already there, but need to be shifted right</span>
02334             significand = significand &gt;&gt; 40;
02335             <span class="keywordflow">if</span> (fpa == 1) {
02336               significand = significand - 1;
02337               <span class="keywordflow">if</span> (significand == <a class="code" href="../../d2/d3/fetypes_8h.html#a3">CONST_FORMAT</a>(0x07fffff)) {
02338                 significand = <a class="code" href="../../d2/d3/fetypes_8h.html#a3">CONST_FORMAT</a>(0x0ffffff);
02339                 decr_exp = 1;
02340               }
02341             }
02342           } <span class="keywordflow">else</span> {
02343             <span class="comment">// internal error</span>
02344 <span class="preprocessor">#ifndef unix</span>
02345 <span class="preprocessor"></span>            <a class="code" href="../../d9/d1/fedefs_8h.html#a7">FP_EMULATION_ERROR6</a> (<span class="stringliteral">"fp_emulate (): incorrect \</span>
02346 <span class="stringliteral">  significand size %d for ISRlow = %4.4x and FR[%d] = %1.1x %5.5x %8.8x %8.8x\n"</span>,
02347                 significand_size, ISRlow, f1, tmp_fp.<a class="code" href="../../d0/d0/structfp__reg__struct.html#o2">sign</a>, tmp_fp.<a class="code" href="../../d0/d0/structfp__reg__struct.html#o1">exponent</a>,
02348                 tmp_fp.<a class="code" href="../../d0/d0/structfp__reg__struct.html#o0">significand</a>)
02349 #<span class="keywordflow">else</span>
02350             <a class="code" href="../../d9/d1/fedefs_8h.html#a7">FP_EMULATION_ERROR6</a> (<span class="stringliteral">"fp_emulate (): incorrect \</span>
02351 <span class="stringliteral">  significand size %d for ISRlow = %4.4x and FR[%d] = %1.1x %5.5x %Lx\n"</span>,
02352                 significand_size, ISRlow, f1, tmp_fp.<a class="code" href="../../d0/d0/structfp__reg__struct.html#o2">sign</a>, tmp_fp.<a class="code" href="../../d0/d0/structfp__reg__struct.html#o1">exponent</a>,
02353                 tmp_fp.<a class="code" href="../../d0/d0/structfp__reg__struct.html#o0">significand</a>)
02354                 <span class="keywordflow">return</span> (<a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a2">FP_EMUL_ERROR</a>);
02355 <span class="preprocessor">#endif</span>
02356 <span class="preprocessor"></span>          }
02357 
02358           true_bexp = ((exponent + 0x1007b) &amp; 0x1ffff) - 0x1007b;
02359 
02360           <span class="comment">// true_bexp - 0x0ffff is the true unbiased exponent after the</span>
02361           <span class="comment">// first IEEE rounding; determine whether the result is tiny</span>
02362           <span class="keywordflow">if</span> (true_bexp - 0x0ffff &gt; emin - 1) {
02363 <span class="preprocessor">#ifndef unix</span>
02364 <span class="preprocessor"></span>            <a class="code" href="../../d9/d1/fedefs_8h.html#a1">FP_EMULATION_ERROR0</a> (<span class="stringliteral">"fp_emulate () Internal Error: non-tiny res\n"</span>);
02365 <span class="preprocessor">#else</span>
02366 <span class="preprocessor"></span>            <a class="code" href="../../d9/d1/fedefs_8h.html#a1">FP_EMULATION_ERROR0</a> (<span class="stringliteral">"fp_emulate () Internal Error: non-tiny res\n"</span>);
02367             <span class="keywordflow">return</span> (<a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a2">FP_EMUL_ERROR</a>);
02368 <span class="preprocessor">#endif</span>
02369 <span class="preprocessor"></span>          }
02370 
02371           <span class="comment">// adjust now true_bexp if necessary</span>
02372           <span class="keywordflow">if</span> (decr_exp) true_bexp--;
02373 
02374           <span class="comment">// perform the second IEEE rounding</span>
02375 
02376           shift_cnt = emin - true_bexp + 0x0ffff; <span class="comment">// &gt;= 1</span>
02377 
02378           <span class="keywordflow">if</span> (shift_cnt &lt;= significand_size) {
02379             <span class="comment">// do the actual shift to denormalize the result; the result</span>
02380             <span class="comment">// will be a denormal, or zero</span>
02381             round = I_exc;
02382                 <span class="comment">// this is indicated even for O or U if the result is inexact</span>
02383             sticky = 0;
02384             <span class="keywordflow">for</span> (ind = 0 ; ind &lt; shift_cnt ; ind++) {
02385               sticky = round | sticky;
02386               round = (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)(significand &amp; 0x01);
02387               significand = significand &gt;&gt; 1;
02388             }
02389             true_bexp = true_bexp + shift_cnt; <span class="comment">// e_min + 0xffff</span>
02390           } <span class="keywordflow">else</span> { <span class="comment">// all the significand bits shift out into sticky</span>
02391             significand = 0;
02392             round = 0;
02393             sticky = 1;
02394             true_bexp = true_bexp + shift_cnt; <span class="comment">// e_min + 0xffff</span>
02395           }
02396 
02397           <span class="comment">// perform the rounding; the result is 0, denormal, or </span>
02398           <span class="comment">// 1.0 x 2^emin</span>
02399           <span class="keywordflow">switch</span> (rc) {
02400             <span class="keywordflow">case</span> <a class="code" href="../../d2/d3/fetypes_8h.html#a455a412">rc_rn</a>:
02401               lsb = (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)(significand &amp; 0x01);
02402               fpa = round &amp; (lsb | sticky);
02403               <span class="keywordflow">break</span>;
02404             <span class="keywordflow">case</span> <a class="code" href="../../d2/d3/fetypes_8h.html#a455a413">rc_rm</a>:
02405               fpa = (sign == 0 ? 0 : (round | sticky));
02406               <span class="keywordflow">break</span>;
02407             <span class="keywordflow">case</span> <a class="code" href="../../d2/d3/fetypes_8h.html#a455a414">rc_rp</a>:
02408               fpa = (sign == 1 ? 0 : (round | sticky));
02409               <span class="keywordflow">break</span>;
02410             <span class="keywordflow">case</span> <a class="code" href="../../d2/d3/fetypes_8h.html#a455a415">rc_rz</a>:
02411               fpa = 0;
02412               <span class="keywordflow">break</span>;
02413             <span class="keywordflow">default</span>:
02414 <span class="preprocessor">#ifndef unix</span>
02415 <span class="preprocessor"></span>              <a class="code" href="../../d9/d1/fedefs_8h.html#a2">FP_EMULATION_ERROR1</a> (<span class="stringliteral">"fp_emulate () Internal Error: \</span>
02416 <span class="stringliteral">invalid rc = %d\n"</span>, rc)
02417 #<span class="keywordflow">else</span>
02418               <a class="code" href="../../d9/d1/fedefs_8h.html#a2">FP_EMULATION_ERROR1</a> (<span class="stringliteral">"fp_emulate () Internal Error: \</span>
02419 <span class="stringliteral">invalid rc = %d\n"</span>, rc)
02420               <span class="keywordflow">return</span> (<a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a2">FP_EMUL_ERROR</a>);
02421 <span class="preprocessor">#endif</span>
02422 <span class="preprocessor"></span>          }
02423 
02424 
02425           <span class="comment">// add fpa to the significand if fpa = 1, and fix for the case when </span>
02426           <span class="comment">// there is a carry-out in this addition</span>
02427 
02428           <span class="keywordflow">if</span> (fpa == 1) {
02429 
02430             significand = significand + 1;
02431 
02432             <span class="keywordflow">if</span> (significand_size == 64) {
02433               <span class="keywordflow">if</span> (significand == <a class="code" href="../../d2/d3/fetypes_8h.html#a3">CONST_FORMAT</a>(0x0)) { <span class="comment">// was 0xff....f</span>
02434                 significand = <a class="code" href="../../d2/d3/fetypes_8h.html#a3">CONST_FORMAT</a>(0x08000000000000000);
02435                 true_bexp++; <span class="comment">// e_min + 0xffff + 0x1</span>
02436               }
02437             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (significand_size == 53) {
02438               <span class="keywordflow">if</span> (significand == <a class="code" href="../../d2/d3/fetypes_8h.html#a3">CONST_FORMAT</a>(0x020000000000000)) {
02439                 significand = <a class="code" href="../../d2/d3/fetypes_8h.html#a3">CONST_FORMAT</a>(0x010000000000000);
02440                 true_bexp++; <span class="comment">// e_min + 0xffff + 0x1</span>
02441               }
02442             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (significand_size == 24) {
02443               <span class="keywordflow">if</span> (significand == <a class="code" href="../../d2/d3/fetypes_8h.html#a3">CONST_FORMAT</a>(0x01000000)) {
02444                 significand = <a class="code" href="../../d2/d3/fetypes_8h.html#a3">CONST_FORMAT</a>(0x0800000);
02445                 true_bexp++; <span class="comment">// e_min + 0xffff + 0x1</span>
02446               }
02447             } <span class="keywordflow">else</span> { <span class="comment">// this case not really needed</span>
02448               <span class="comment">// internal error</span>
02449 <span class="preprocessor">#ifndef unix</span>
02450 <span class="preprocessor"></span>              <a class="code" href="../../d9/d1/fedefs_8h.html#a2">FP_EMULATION_ERROR1</a> (
02451                   <span class="stringliteral">"fp_emulate (): incorrect significand size %d\n"</span>,
02452                   significand_size)
02453 #<span class="keywordflow">else</span>
02454               <a class="code" href="../../d9/d1/fedefs_8h.html#a2">FP_EMULATION_ERROR1</a> (
02455                   <span class="stringliteral">"fp_emulate (): incorrect significand size %d\n"</span>,
02456                   significand_size)
02457               <span class="keywordflow">return</span> (<a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a2">FP_EMUL_ERROR</a>);
02458 <span class="preprocessor">#endif</span>
02459 <span class="preprocessor"></span>            }
02460 
02461           }
02462 
02463           <span class="keywordflow">if</span> (significand == 0) {
02464             true_bexp = 0; <span class="comment">// ow it is e_min or e_min + 1</span>
02465           }
02466 
02467           exponent = true_bexp;
02468 
02469           <span class="comment">// determine the new value of I_exc</span>
02470           I_exc = round | sticky;
02471 
02472           <span class="comment">// set the new values for both the FPSR and the ISR code, but the</span>
02473           <span class="comment">// ISR code will only be used if an inexact exception will be</span>
02474           <span class="comment">// raised (for this, the final result generated by </span>
02475           <span class="comment">// fp_emulate () has to be inexact, and the inexact traps have</span>
02476           <span class="comment">// to be enabled</span>
02477 
02478           <span class="keywordflow">if</span> (I_exc) {
02479             <span class="comment">// if tiny and inexact</span>
02480             <span class="comment">/* set U and set I in FPSR */</span>
02481             *pfpsr = *pfpsr |
02482                 ((<a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a>)3 &lt;&lt; (6 + (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)sf * 13 + 11));
02483             <span class="keywordflow">if</span> (!I_dis) { <span class="comment">// update ISR code</span>
02484               <span class="comment">// clear U and set I in ISRlow - will raise an inexact trap</span>
02485               ISRlow = (ISRlow &amp; 0xefff) | 0x2000;
02486               <span class="comment">// update the fpa bit in the ISR code (NOT DONE IN EM_FP82)</span>
02487               <span class="keywordflow">if</span> (fpa)
02488                 ISRlow = ISRlow | 0x4000;
02489               <span class="keywordflow">else</span>
02490                 ISRlow = ISRlow &amp; 0xbfff; 
02491             }
02492           }
02493  
02494           <span class="comment">// shift left the significand if needed</span>
02495           <span class="keywordflow">if</span> (significand_size == 53)
02496             significand = significand &lt;&lt; 11; <span class="comment">// msb explicit</span>
02497           <span class="keywordflow">else</span> <span class="keywordflow">if</span> (significand_size == 24)
02498             significand = significand &lt;&lt; 40; <span class="comment">// msb explicit</span>
02499 
02500           <span class="comment">// if the exponent is 0xc001 and the result is unnormal,</span>
02501           <span class="comment">// modify the exponent to 0x0000</span>
02502           <span class="keywordflow">if</span> (exponent == 0xc001 &amp;&amp; ((significand &amp; 0x8000000000000000) == 0))
02503               exponent = 0x0;
02504 
02505         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (O_dis &amp;&amp; O_exc) { <span class="comment">// the result is not zero, and is normal</span>
02506             <span class="comment">// with unbounded exponent</span>
02507 
02508           <span class="comment">// true_bexp not used in this case, and neither is decr_exp</span>
02509           <span class="comment">// true_bexp = ((exponent - 0x1007f) &amp; 0x1ffff) + 0x1007f; </span>
02510 
02511           <span class="comment">// determine the result, according to the rounding mode</span>
02512           <span class="keywordflow">switch</span> (rc) {
02513             <span class="keywordflow">case</span> <a class="code" href="../../d2/d3/fetypes_8h.html#a455a412">rc_rn</a>: <span class="comment">// +infinity or -infinity</span>
02514               exponent = 0x01ffff;
02515               significand = <a class="code" href="../../d2/d3/fetypes_8h.html#a3">CONST_FORMAT</a>(0x8000000000000000);
02516               <span class="keywordflow">break</span>;
02517             <span class="keywordflow">case</span> <a class="code" href="../../d2/d3/fetypes_8h.html#a455a413">rc_rm</a>: <span class="comment">// +max_fp or -infinity</span>
02518               exponent = (sign == 0 ? 0x01fffe : 0x01ffff);
02519               significand = (sign == 0 ? <a class="code" href="../../d2/d3/fetypes_8h.html#a3">CONST_FORMAT</a>(0x0ffffffffffffffff) : 
02520                   <a class="code" href="../../d2/d3/fetypes_8h.html#a3">CONST_FORMAT</a>(0x8000000000000000));
02521               <span class="keywordflow">break</span>;
02522             <span class="keywordflow">case</span> <a class="code" href="../../d2/d3/fetypes_8h.html#a455a414">rc_rp</a>: <span class="comment">// +infinity or -max_fp</span>
02523               exponent = (sign == 0 ? 0x01ffff : 0x01fffe);
02524               significand = (sign == 0 ? <a class="code" href="../../d2/d3/fetypes_8h.html#a3">CONST_FORMAT</a>(0x8000000000000000) : 
02525                   <a class="code" href="../../d2/d3/fetypes_8h.html#a3">CONST_FORMAT</a>(0x0ffffffffffffffff));
02526               <span class="keywordflow">break</span>;
02527             <span class="keywordflow">case</span> <a class="code" href="../../d2/d3/fetypes_8h.html#a455a415">rc_rz</a>: <span class="comment">// +max_fp or -max_fp</span>
02528               exponent = 0x01fffe;
02529               significand = <a class="code" href="../../d2/d3/fetypes_8h.html#a3">CONST_FORMAT</a>(0x0ffffffffffffffff);
02530               <span class="keywordflow">break</span>;
02531             <span class="keywordflow">default</span>:
02532 <span class="preprocessor">#ifndef unix</span>
02533 <span class="preprocessor"></span>              <a class="code" href="../../d9/d1/fedefs_8h.html#a2">FP_EMULATION_ERROR1</a> (<span class="stringliteral">"fp_emulate () Internal Error:\</span>
02534 <span class="stringliteral"> invalid rc = %d for non-SIMD F1 instruction\n"</span>, rc)
02535 #<span class="keywordflow">else</span>
02536               <a class="code" href="../../d9/d1/fedefs_8h.html#a2">FP_EMULATION_ERROR1</a> (<span class="stringliteral">"fp_emulate () Internal Error:\</span>
02537 <span class="stringliteral"> invalid rc = %d for non-SIMD F1 instruction\n"</span>, rc)
02538               <span class="keywordflow">return</span> (<a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a2">FP_EMUL_ERROR</a>);
02539 <span class="preprocessor">#endif</span>
02540 <span class="preprocessor"></span>          }
02541 
02542           <span class="comment">/* set O and set I in FPSR */</span>
02543           *pfpsr = *pfpsr | ((<a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a>)5 &lt;&lt; (6 + (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)sf * 13 + 10));
02544 
02545           <span class="keywordflow">if</span> (!I_dis) { <span class="comment">// update ISR code - will raise an inexact exception</span>
02546 
02547             <span class="keywordflow">if</span> (exponent == 0x1ffff)
02548               fpa = 1;
02549             <span class="keywordflow">else</span>
02550               fpa = 0;
02551 
02552             <span class="comment">/* clear O and set I in ISRlow - the result is always inexact */</span>
02553             ISRlow = (ISRlow &amp; 0xf7ff) | 0x2000;
02554             <span class="comment">// update the fpa bit in the ISR code (NOT DONE IN EM_FP82)</span>
02555             <span class="keywordflow">if</span> (fpa)
02556               ISRlow = ISRlow | 0x4000;
02557             <span class="keywordflow">else</span>
02558               ISRlow = ISRlow &amp; 0xbfff; 
02559 
02560             <span class="comment">// Note that the exact result cannot be retrieved by the inexact</span>
02561             <span class="comment">// exception trap handler [but this will not occur on Merced]</span>
02562 
02563           }
02564 
02565         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (I_dis &amp;&amp; I_exc) {
02566 
02567           <span class="comment">// redundant - this case was caught before</span>
02568           ; <span class="comment">// nothing to do</span>
02569 
02570         } <span class="keywordflow">else</span> {
02571 
02572           <span class="comment">// internal error</span>
02573 <span class="preprocessor">#ifndef unix</span>
02574 <span class="preprocessor"></span>          <a class="code" href="../../d9/d1/fedefs_8h.html#a2">FP_EMULATION_ERROR1</a> (<span class="stringliteral">"fp_emulate () Internal Error: \</span>
02575 <span class="stringliteral">SWA trap code invoked with F1 instruction, w/o O or U set in ISR.code = %x\n"</span>, 
02576               ISRlow &amp; 0x0ffff)
02577 #<span class="keywordflow">else</span>
02578           <a class="code" href="../../d9/d1/fedefs_8h.html#a2">FP_EMULATION_ERROR1</a> (<span class="stringliteral">"fp_emulate () Internal Error: \</span>
02579 <span class="stringliteral">SWA trap code invoked with F1 instruction, w/o O or U set in ISR.code = %x\n"</span>, 
02580               ISRlow &amp; 0x0ffff)
02581           <span class="keywordflow">return</span> (<a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a2">FP_EMUL_ERROR</a>);
02582 <span class="preprocessor">#endif</span>
02583 <span class="preprocessor"></span>        }
02584 
02585         <span class="comment">// return the result</span>
02586         <span class="comment">// FR[f1].sign is unchanged</span>
02587         ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o1">exponent</a> = exponent;
02588         ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o0">significand</a> = significand;
02589 
02590         <span class="comment">// successful emulation, but might still raise another trap - O, U, or I</span>
02591 
02592         <span class="comment">// set the destination floating-point reg value (this is a trap)</span>
02593         <span class="comment">// [redundant if the cause of the SWA trap was I &amp;&amp; I_dis]</span>
02594 <span class="preprocessor">#ifdef DEBUG_UNIX</span>
02595 <span class="preprocessor"></span>printf (<span class="stringliteral">"DEBUG AFTER F1 SWA TRAP 1: ps-&gt;state_FR[lf1] = %x %x %Lx\n"</span>,
02596   ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o2">sign</a>, ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o1">exponent</a>, 
02597   ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o0">significand</a>);
02598 <span class="preprocessor">#endif</span>
02599 <span class="preprocessor"></span><span class="preprocessor">#ifdef DEBUG_UNIX</span>
02600 <span class="preprocessor"></span>printf (<span class="stringliteral">"DEBUG AFTER F1 SWA TRAP: f1 = %x\n"</span>, f1);
02601 <span class="preprocessor">#endif</span>
02602 <span class="preprocessor"></span>
02603         <a class="code" href="../../d6/d5/ia64_2getsetrg_8c.html#a9">set_fp_register</a> (f1, <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a85">FPRegToFP128</a>(ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1]), fp_state);
02604         <span class="keywordflow">if</span> (f1 &lt; 32)
02605           *pipsr = *pipsr | (<a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a>)0x10; <span class="comment">// set mfl bit</span>
02606         <span class="keywordflow">else</span>
02607           *pipsr = *pipsr | (<a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a>)0x20; <span class="comment">// set mfh bit</span>
02608 
02609         <span class="comment">// return TRUE if no exception has to be raised</span>
02610         <span class="keywordflow">if</span> (I_dis || I_exc == 0) {
02611 
02612           <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
02613 
02614         } <span class="keywordflow">else</span> { 
02615           <span class="comment">// if (inexact &amp;&amp; I traps enabled)</span>
02616           <span class="comment">// ISRlow might have been updated</span>
02617           *pisr = ((*pisr) &amp; 0xffffffffffff0000) | ISRlow;
02618 
02619 <span class="preprocessor">#ifdef DEBUG_UNIX</span>
02620 <span class="preprocessor"></span>printf (<span class="stringliteral">"DEBUG AFTER F1 SWA TRAP 1 A RET FALSE: ps-&gt;state_FR[lf1] = %x %x %Lx\n"</span>,
02621   ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o2">sign</a>, ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o1">exponent</a>, 
02622   ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o0">significand</a>);
02623 <span class="preprocessor">#endif</span>
02624 <span class="preprocessor"></span>          <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>); <span class="comment">// will raise I trap</span>
02625 
02626         }
02627 
02628       } <span class="keywordflow">else</span> { <span class="comment">// SIMD instruction</span>
02629 
02630         <span class="comment">// tmp_fp.exponent = 0x1003e</span>
02631 
02632         fpa_hi = (ISRlow &gt;&gt; 14) &amp; 0x01;
02633         I_exc_hi = (ISRlow &gt;&gt; 13) &amp; 0x01; <span class="comment">// inexact = round OR sticky</span>
02634         U_exc_hi = (ISRlow &gt;&gt; 12) &amp; 0x01; <span class="comment">// underflow</span>
02635         O_exc_hi = (ISRlow &gt;&gt; 11) &amp; 0x01; <span class="comment">// overflow</span>
02636         fpa_lo = (ISRlow &gt;&gt; 10) &amp; 0x01;
02637         I_exc_lo = (ISRlow &gt;&gt; 9) &amp; 0x01; <span class="comment">// inexact = round OR sticky</span>
02638         U_exc_lo = (ISRlow &gt;&gt; 8) &amp; 0x01; <span class="comment">// underflow</span>
02639         O_exc_lo = (ISRlow &gt;&gt; 7) &amp; 0x01; <span class="comment">// overflow</span>
02640 
02641         <span class="keywordflow">if</span> (!U_exc_lo &amp;&amp; !U_exc_hi &amp;&amp; !O_exc_lo &amp;&amp; !O_exc_hi) {
02642 
02643           <span class="comment">// internal error</span>
02644 <span class="preprocessor">#ifndef unix</span>
02645 <span class="preprocessor"></span>          <a class="code" href="../../d9/d1/fedefs_8h.html#a2">FP_EMULATION_ERROR1</a> (<span class="stringliteral">"fp_emulate () Internal Error: \</span>
02646 <span class="stringliteral">SWA trap code invoked with SIMD F1 instruction, w/o O or U set in \</span>
02647 <span class="stringliteral">ISR.code = %x\n"</span>, ISRlow &amp; 0x0ffff)
02648 #<span class="keywordflow">else</span>
02649           <a class="code" href="../../d9/d1/fedefs_8h.html#a2">FP_EMULATION_ERROR1</a> (<span class="stringliteral">"fp_emulate () Internal Error: \</span>
02650 <span class="stringliteral">SWA trap code invoked with SIMD F1 instruction, w/o O or U set in \</span>
02651 <span class="stringliteral">ISR.code = %x\n"</span>, ISRlow &amp; 0x0ffff)
02652           <span class="keywordflow">return</span> (<a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a2">FP_EMUL_ERROR</a>);
02653 <span class="preprocessor">#endif</span>
02654 <span class="preprocessor"></span>
02655         }
02656 
02657         sign_lo = (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)((tmp_fp.<a class="code" href="../../d0/d0/structfp__reg__struct.html#o0">significand</a> &gt;&gt; 31) &amp; 0x01);
02658         exponent_lo = (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)((tmp_fp.<a class="code" href="../../d0/d0/structfp__reg__struct.html#o0">significand</a> &gt;&gt; 23) &amp; 0x0ff);
02659         significand_lo = (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)((tmp_fp.<a class="code" href="../../d0/d0/structfp__reg__struct.html#o0">significand</a>) &amp; 0x07fffff);
02660         <span class="comment">// never get here with a 0 or an unnormal result if a disabled</span>
02661         <span class="comment">// underflow or overflow occurred in the low half; if the low half</span>
02662         <span class="comment">// has neither an underflow nor an overflow, then the assignment</span>
02663         <span class="comment">// below might be incorrect, but significand_lo will be corrected when</span>
02664         <span class="comment">// the result is returned</span>
02665         significand_lo = significand_lo | 0x800000; 
02666 
02667         sign_hi = (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)((tmp_fp.<a class="code" href="../../d0/d0/structfp__reg__struct.html#o0">significand</a> &gt;&gt; 63) &amp; 0x01);
02668         exponent_hi = (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)((tmp_fp.<a class="code" href="../../d0/d0/structfp__reg__struct.html#o0">significand</a> &gt;&gt; 55) &amp; 0x0ff);
02669         significand_hi = (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)((tmp_fp.<a class="code" href="../../d0/d0/structfp__reg__struct.html#o0">significand</a> &gt;&gt; 32) &amp; 0x07fffff);
02670         <span class="comment">// never get here with a 0 or an unnormal result if a disabled</span>
02671         <span class="comment">// underflow or overflow occurred in the high half; if the high half</span>
02672         <span class="comment">// has neither an underflow nor an overflow, then the assignment</span>
02673         <span class="comment">// below might be incorrect, but significand_hi will be corrected when</span>
02674         <span class="comment">// the result is returned</span>
02675         significand_hi = significand_hi | 0x800000; 
02676 
02677         <span class="comment">// if underflow or overflow, calculate the true biased exponent, by </span>
02678         <span class="comment">// possibly adding or subtracting 2^8</span>
02679 
02680         <span class="keywordflow">if</span> (U_dis &amp;&amp; U_exc_lo) { <span class="comment">// the result is not zero, and is normal with</span>
02681             <span class="comment">// unbounded exponent (but tiny)</span>
02682 
02683           decr_exp_lo = 0;
02684           <span class="comment">// if SWA trap in the low half</span>
02685           <span class="keywordflow">if</span> (fpa_lo == 1) {
02686             significand_lo = significand_lo - 1;
02687             <span class="keywordflow">if</span> (significand_lo == 0x07fffff) {
02688               significand_lo = 0x0ffffff;
02689               decr_exp_lo = 1;
02690             }
02691           }
02692 
02693           true_bexp_lo = (exponent_lo == 0 ? exponent_lo : exponent_lo - 0x100);
02694 
02695           <span class="comment">// true_bexp_lo - 0x07f is the true unbiased exponent after the</span>
02696           <span class="comment">// first IEEE rounding; determine whether the result is tiny</span>
02697           <span class="keywordflow">if</span> (true_bexp_lo - 0x07f &gt; emin - 1) {
02698 <span class="preprocessor">#ifndef unix</span>
02699 <span class="preprocessor"></span>            <a class="code" href="../../d9/d1/fedefs_8h.html#a1">FP_EMULATION_ERROR0</a> (<span class="stringliteral">"fp_emulate () Internal Error:non-tiny resL\n"</span>);
02700 <span class="preprocessor">#else</span>
02701 <span class="preprocessor"></span>            <a class="code" href="../../d9/d1/fedefs_8h.html#a1">FP_EMULATION_ERROR0</a> (<span class="stringliteral">"fp_emulate () Internal Error:non-tiny resL\n"</span>);
02702             <span class="keywordflow">return</span> (<a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a2">FP_EMUL_ERROR</a>);
02703 <span class="preprocessor">#endif</span>
02704 <span class="preprocessor"></span>          }
02705 
02706           <span class="comment">// adjust now true_bexp_lo if necessary</span>
02707           <span class="keywordflow">if</span> (decr_exp_lo) true_bexp_lo--;
02708 
02709           <span class="comment">// perform the second IEEE rounding</span>
02710 
02711           shift_cnt_lo = emin - true_bexp_lo + 0x07f; <span class="comment">// &gt;= 1</span>
02712 
02713           <span class="keywordflow">if</span> (shift_cnt_lo &lt;= significand_size) { <span class="comment">// &lt;= 24</span>
02714             <span class="comment">// do the actual shift to denormalize the result; the result</span>
02715             <span class="comment">// will be a denormal, or zero</span>
02716             round_lo = I_exc_lo;
02717                 <span class="comment">// this is indicated even for O or U, if the result inexact</span>
02718             sticky_lo = 0;
02719             <span class="keywordflow">for</span> (ind = 0 ; ind &lt; shift_cnt_lo ; ind++) {
02720               sticky_lo = round_lo | sticky_lo;
02721               round_lo = significand_lo &amp; 0x01;
02722               significand_lo = significand_lo &gt;&gt; 1;
02723             }
02724             true_bexp_lo = true_bexp_lo + shift_cnt_lo; <span class="comment">// e_min + 0x7f</span>
02725           } <span class="keywordflow">else</span> { <span class="comment">// all the significand bits shift out into sticky</span>
02726             significand_lo = 0;
02727             round_lo = 0;
02728             sticky_lo = 1;
02729             true_bexp_lo = true_bexp_lo + shift_cnt_lo; <span class="comment">// e_min + 0x7f</span>
02730           }
02731 
02732           <span class="comment">// perform the rounding; the result is 0, denormal, or </span>
02733           <span class="comment">// 1.0 x 2^emin</span>
02734           <span class="keywordflow">switch</span> (rc) {
02735             <span class="keywordflow">case</span> <a class="code" href="../../d2/d3/fetypes_8h.html#a455a412">rc_rn</a>:
02736               lsb_lo = significand_lo &amp; 0x01;
02737               fpa_lo = round_lo &amp; (lsb_lo | sticky_lo);
02738               <span class="keywordflow">break</span>;
02739             <span class="keywordflow">case</span> <a class="code" href="../../d2/d3/fetypes_8h.html#a455a413">rc_rm</a>:
02740               fpa_lo = (sign_lo == 0 ? 0 : (round_lo | sticky_lo));
02741               <span class="keywordflow">break</span>;
02742             <span class="keywordflow">case</span> <a class="code" href="../../d2/d3/fetypes_8h.html#a455a414">rc_rp</a>:
02743               fpa_lo = (sign_lo == 1 ? 0 : (round_lo | sticky_lo));
02744               <span class="keywordflow">break</span>;
02745             <span class="keywordflow">case</span> <a class="code" href="../../d2/d3/fetypes_8h.html#a455a415">rc_rz</a>:
02746               fpa_lo = 0;
02747               <span class="keywordflow">break</span>;
02748             <span class="keywordflow">default</span>:
02749 <span class="preprocessor">#ifndef unix</span>
02750 <span class="preprocessor"></span>              <a class="code" href="../../d9/d1/fedefs_8h.html#a2">FP_EMULATION_ERROR1</a> (<span class="stringliteral">"fp_emulate () Internal \</span>
02751 <span class="stringliteral">Error: invalid rc = %d for SIMD F1 instruction\n"</span>, rc)
02752 #<span class="keywordflow">else</span>
02753               <a class="code" href="../../d9/d1/fedefs_8h.html#a2">FP_EMULATION_ERROR1</a> (<span class="stringliteral">"fp_emulate () Internal \</span>
02754 <span class="stringliteral">Error: invalid rc = %d for SIMD F1 instruction\n"</span>, rc)
02755               <span class="keywordflow">return</span> (<a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a2">FP_EMUL_ERROR</a>);
02756 <span class="preprocessor">#endif</span>
02757 <span class="preprocessor"></span>          }
02758 
02759 
02760           <span class="comment">// add fpa_lo to the significand if fpa_lo = 1, and fix for the </span>
02761           <span class="comment">// case when there is a carry-out in this addition</span>
02762 
02763           <span class="keywordflow">if</span> (fpa_lo == 1) {
02764             significand_lo = significand_lo + 1;
02765 
02766             <span class="keywordflow">if</span> (significand_lo == 0x01000000) {
02767               significand_lo = 0x0800000;
02768               true_bexp_lo++; <span class="comment">// e_min + 0x7f + 0x001</span>
02769             }
02770           }
02771 
02772           <span class="keywordflow">if</span> (significand_lo == 0) {
02773             true_bexp_lo = 0; <span class="comment">// otherwise it is e_min or e_min + 1</span>
02774           }
02775 
02776           exponent_lo = true_bexp_lo;
02777 
02778           <span class="keywordflow">if</span> ((exponent_lo == 0x01) &amp;&amp; ((significand_lo &amp; 0x0800000) == 0)) {
02779             exponent_lo = 0x0; <span class="comment">// result low is denormal</span>
02780 <span class="preprocessor">#ifdef DEBUG_UNIX</span>
02781 <span class="preprocessor"></span>            printf (<span class="stringliteral">"DEBUG: result low is denormal\n"</span>);
02782 <span class="preprocessor">#endif</span>
02783 <span class="preprocessor"></span>          }
02784 
02785           <span class="comment">// determine the new value of I_exc_lo</span>
02786           I_exc_lo = round_lo | sticky_lo;
02787 
02788           <span class="comment">// the low half could only raise an inexact exception; if it does</span>
02789           <span class="comment">// not, clear U_exc_lo, I_exc_lo, and fpa_lo in ISRlow</span>
02790 
02791           <span class="keywordflow">if</span> (!I_exc_lo) { 
02792 
02793             <span class="comment">// if exact, then no new exception has to be raised for the low</span>
02794             <span class="comment">// half of the instruction; clear U_exc_lo in ISRlow (an exception</span>
02795             <span class="comment">// might be raised by the high half of the instruction) [clearing</span>
02796             <span class="comment">// I is redundant: it could not have been inexact and then become </span>
02797             <span class="comment">// exact after denormalization]</span>
02798 
02799             ISRlow = ISRlow &amp; 0xfeff;
02800                 <span class="comment">// need to clean ISRlow because the other half might raise exc.</span>
02801 
02802             <span class="comment">// FPSR in the trap frame needs no update for the low half: with </span>
02803             <span class="comment">// U traps disabled, the result would have to be tiny and inexact</span>
02804             <span class="comment">// in order to set the U flag; both U and I flags in the FPSR</span>
02805             <span class="comment">// stay unchanged</span>
02806             U_exc_lo = 0;
02807 
02808             <span class="comment">// no exception raised for the low half - clear fpa_lo (an </span>
02809             <span class="comment">// exception might be raised by the high half of the instruction)</span>
02810             ISRlow = ISRlow &amp; 0xfbff; 
02811 
02812           } <span class="keywordflow">else</span> { <span class="comment">// if (I_exc_lo)</span>
02813 
02814             <span class="comment">// if tiny and inexact will set U and I in FPSR, as U_exc_lo = 1</span>
02815             <span class="keywordflow">if</span> (I_dis) { <span class="comment">// the low half will not raise an inexact exception</span>
02816               <span class="comment">// clear I_exc_lo and U_exc_lo in ISRlow (prepare ISRlow</span>
02817               <span class="comment">// because the high half might raise an exception); no exception</span>
02818               <span class="comment">// raised for the low half - clear also fpa_lo</span>
02819               ISRlow = ISRlow &amp; 0xf8ff;
02820             } <span class="keywordflow">else</span> { <span class="comment">// update ISR code - will raise an inexact trap</span>
02821               <span class="comment">// clear U_lo and set I_lo in ISRlow - will raise inexact trap</span>
02822               ISRlow = (ISRlow &amp; 0xfeff) | 0x0200;
02823               <span class="comment">// update the fpa_lo bit in the ISR code (NOT DONE IN EM_FP82)</span>
02824               <span class="keywordflow">if</span> (fpa_lo)
02825                 ISRlow = ISRlow | 0x0400;
02826               <span class="keywordflow">else</span>
02827                 ISRlow = ISRlow &amp; 0xfbff; 
02828 
02829             }
02830 
02831           }
02832 
02833         }
02834 
02835         <span class="keywordflow">if</span> (O_dis &amp;&amp; O_exc_lo) { <span class="comment">// the result is not zero, and is normal with</span>
02836             <span class="comment">// unbounded exponent</span>
02837 
02838           <span class="comment">// true_bexp_lo not used in this case, and neither is decr_exp_lo</span>
02839           <span class="comment">// true_bexp_lo = </span>
02840           <span class="comment">//     (exponent_lo == 0xff ? exponent_lo : exponent_lo + 0x100);</span>
02841 
02842           <span class="comment">// determine the result, according to the rounding mode</span>
02843           <span class="keywordflow">switch</span> (rc) {
02844             <span class="keywordflow">case</span> <a class="code" href="../../d2/d3/fetypes_8h.html#a455a412">rc_rn</a>: <span class="comment">// +infinity or -infinity</span>
02845               exponent_lo = 0x0ff;
02846               significand_lo = 0x0800000;
02847               <span class="keywordflow">break</span>;
02848             <span class="keywordflow">case</span> <a class="code" href="../../d2/d3/fetypes_8h.html#a455a413">rc_rm</a>: <span class="comment">// +max_fp or -infinity</span>
02849               exponent_lo = (sign_lo == 0 ? 0x0fe : 0x0ff);
02850               significand_lo = (sign_lo == 0 ? 0x0ffffff : 0x0800000);
02851               <span class="keywordflow">break</span>;
02852             <span class="keywordflow">case</span> <a class="code" href="../../d2/d3/fetypes_8h.html#a455a414">rc_rp</a>: <span class="comment">// +infinity or -max_fp</span>
02853               exponent_lo = (sign_lo == 0 ? 0x0ff : 0x0fe);
02854               significand_lo = (sign_lo == 0 ? 0x0800000 : 0x0ffffff);
02855               <span class="keywordflow">break</span>;
02856             <span class="keywordflow">case</span> <a class="code" href="../../d2/d3/fetypes_8h.html#a455a415">rc_rz</a>: <span class="comment">// +max_fp or -max_fp</span>
02857               exponent_lo = 0x0fe;
02858               significand_lo = 0x0ffffff;
02859               <span class="keywordflow">break</span>;
02860             <span class="keywordflow">default</span>:
02861 <span class="preprocessor">#ifndef unix</span>
02862 <span class="preprocessor"></span>              <a class="code" href="../../d9/d1/fedefs_8h.html#a2">FP_EMULATION_ERROR1</a> (<span class="stringliteral">"fp_emulate () Internal \</span>
02863 <span class="stringliteral">Error: invalid rc = %d for SIMD F1 instruction\n"</span>, rc)
02864 #<span class="keywordflow">else</span>
02865               <a class="code" href="../../d9/d1/fedefs_8h.html#a2">FP_EMULATION_ERROR1</a> (<span class="stringliteral">"fp_emulate () Internal \</span>
02866 <span class="stringliteral">Error: invalid rc = %d for SIMD F1 instruction\n"</span>, rc)
02867               <span class="keywordflow">return</span> (<a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a2">FP_EMUL_ERROR</a>);
02868 <span class="preprocessor">#endif</span>
02869 <span class="preprocessor"></span>          }
02870 
02871           <span class="keywordflow">if</span> (exponent_lo == 0xff)
02872             fpa_lo = 1;
02873           <span class="keywordflow">else</span>
02874             fpa_lo = 0;
02875 
02876           <span class="comment">// will update FPSR</span>
02877           O_exc_lo = 1; <span class="comment">// must have been so already</span>
02878           I_exc_lo = 1;
02879 
02880           <span class="keywordflow">if</span> (I_dis) {
02881 
02882             <span class="comment">// clear fpa_lo, I_exc_lo and O_exc_lo in ISRlow - an enabled</span>
02883             <span class="comment">// exception might be raised for the high half</span>
02884             ISRlow = ISRlow &amp; 0xf97f;
02885 
02886           } <span class="keywordflow">else</span> { <span class="comment">// if (!I_dis)</span>
02887 
02888             <span class="comment">// update ISR code - will raise an inexact exception for low half;</span>
02889             <span class="comment">// clear O_exc_lo and set I_exc_lo in ISRlow - the result</span>
02890             <span class="comment">// is always inexact</span>
02891             ISRlow = (ISRlow &amp; 0xff7f) | 0x0200;
02892             <span class="comment">// update the fpa_lo bit</span>
02893             <span class="keywordflow">if</span> (fpa_lo)
02894               ISRlow = ISRlow | 0x0400;
02895             <span class="keywordflow">else</span>
02896               ISRlow = ISRlow &amp; 0xfbff;
02897             <span class="comment">// Note that the exact result cannot be retrieved by the inexact</span>
02898             <span class="comment">// exception trap handler [but this will not occur on Merced]</span>
02899 
02900           }
02901 
02902         }
02903 
02904         <span class="keywordflow">if</span> (I_dis &amp;&amp; I_exc_lo) {
02905 
02906           ; <span class="comment">// nothing to do (keep this as a place holder)</span>
02907           <span class="comment">// redundant - this case was caught before</span>
02908 
02909         }
02910 
02911         <span class="keywordflow">if</span> (U_dis &amp;&amp; U_exc_hi) { <span class="comment">// the result is not zero, and is normal with</span>
02912             <span class="comment">// unbounded exponent (but tiny)</span>
02913 
02914           decr_exp_hi = 0;
02915           <span class="comment">// if SWA trap in the high half</span>
02916           <span class="keywordflow">if</span> (fpa_hi == 1) {
02917             significand_hi = significand_hi - 1;
02918             <span class="keywordflow">if</span> (significand_hi == 0x07fffff) {
02919               significand_hi = 0x0ffffff;
02920               decr_exp_hi = 1;
02921             }
02922           }
02923 
02924           true_bexp_hi = (exponent_hi == 0 ? exponent_hi : exponent_hi - 0x100);
02925 
02926           <span class="comment">// true_bexp_hi - 0x07f is the true unbiased exponent after the</span>
02927           <span class="comment">// first IEEE rounding; determine whether the result is tiny</span>
02928           <span class="keywordflow">if</span> (true_bexp_hi - 0x07f &gt; emin - 1) {
02929 <span class="preprocessor">#ifndef unix</span>
02930 <span class="preprocessor"></span>            <a class="code" href="../../d9/d1/fedefs_8h.html#a1">FP_EMULATION_ERROR0</a> (<span class="stringliteral">"fp_emulate () Internal Error:non-tiny resH\n"</span>);
02931 <span class="preprocessor">#else</span>
02932 <span class="preprocessor"></span>            <a class="code" href="../../d9/d1/fedefs_8h.html#a1">FP_EMULATION_ERROR0</a> (<span class="stringliteral">"fp_emulate () Internal Error:non-tiny resH\n"</span>);
02933             <span class="keywordflow">return</span> (<a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a2">FP_EMUL_ERROR</a>);
02934 <span class="preprocessor">#endif</span>
02935 <span class="preprocessor"></span>          }
02936 
02937           <span class="comment">// adjust now true_bexp_hi if necessary</span>
02938           <span class="keywordflow">if</span> (decr_exp_hi) true_bexp_hi--;
02939 
02940           <span class="comment">// perform the second IEEE rounding</span>
02941 
02942           shift_cnt_hi = emin - true_bexp_hi + 0x07f; <span class="comment">// &gt;= 1</span>
02943 
02944           <span class="keywordflow">if</span> (shift_cnt_hi &lt;= significand_size) { <span class="comment">// &lt;= 24</span>
02945             <span class="comment">// do the actual shift to denormalize the result; the result</span>
02946             <span class="comment">// will be a denormal, or zero</span>
02947             round_hi = I_exc_hi;
02948                 <span class="comment">// this is indicated even for O or U, if the result inexact</span>
02949             sticky_hi = 0;
02950             <span class="keywordflow">for</span> (ind = 0 ; ind &lt; shift_cnt_hi ; ind++) {
02951               sticky_hi = round_hi | sticky_hi;
02952               round_hi = significand_hi &amp; 0x01;
02953               significand_hi = significand_hi &gt;&gt; 1;
02954             }
02955             true_bexp_hi = true_bexp_hi + shift_cnt_hi; <span class="comment">// e_min + 0x7f</span>
02956           } <span class="keywordflow">else</span> { <span class="comment">// all the significand bits shift out into sticky</span>
02957             significand_hi = 0;
02958             round_hi = 0;
02959             sticky_hi = 1;
02960             true_bexp_hi = true_bexp_hi + shift_cnt_hi; <span class="comment">// e_min + 0x7f</span>
02961           }
02962 
02963           <span class="comment">// perform the rounding; the result is 0, denormal, or </span>
02964           <span class="comment">// 1.0 x 2^emin</span>
02965           <span class="keywordflow">switch</span> (rc) {
02966             <span class="keywordflow">case</span> <a class="code" href="../../d2/d3/fetypes_8h.html#a455a412">rc_rn</a>:
02967               lsb_hi = significand_hi &amp; 0x01;
02968               fpa_hi = round_hi &amp; (lsb_hi | sticky_hi);
02969               <span class="keywordflow">break</span>;
02970             <span class="keywordflow">case</span> <a class="code" href="../../d2/d3/fetypes_8h.html#a455a413">rc_rm</a>:
02971               fpa_hi = (sign_hi == 0 ? 0 : (round_hi | sticky_hi));
02972               <span class="keywordflow">break</span>;
02973             <span class="keywordflow">case</span> <a class="code" href="../../d2/d3/fetypes_8h.html#a455a414">rc_rp</a>:
02974               fpa_hi = (sign_hi == 1 ? 0 : (round_hi | sticky_hi));
02975               <span class="keywordflow">break</span>;
02976             <span class="keywordflow">case</span> <a class="code" href="../../d2/d3/fetypes_8h.html#a455a415">rc_rz</a>:
02977               fpa_hi = 0;
02978               <span class="keywordflow">break</span>;
02979             <span class="keywordflow">default</span>:
02980 <span class="preprocessor">#ifndef unix</span>
02981 <span class="preprocessor"></span>              <a class="code" href="../../d9/d1/fedefs_8h.html#a2">FP_EMULATION_ERROR1</a> (<span class="stringliteral">"fp_emulate () Internal \</span>
02982 <span class="stringliteral">Error: invalid rc = %d for SIMD F1 instruction\n"</span>, rc)
02983 #<span class="keywordflow">else</span>
02984               <a class="code" href="../../d9/d1/fedefs_8h.html#a2">FP_EMULATION_ERROR1</a> (<span class="stringliteral">"fp_emulate () Internal \</span>
02985 <span class="stringliteral">Error: invalid rc = %d for SIMD F1 instruction\n"</span>, rc)
02986               <span class="keywordflow">return</span> (<a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a2">FP_EMUL_ERROR</a>);
02987 <span class="preprocessor">#endif</span>
02988 <span class="preprocessor"></span>          }
02989 
02990 
02991           <span class="comment">// add fpa_hi to the significand if fpa = 1, and fix for the </span>
02992           <span class="comment">// case when there is a carry-out in this addition</span>
02993 
02994           <span class="keywordflow">if</span> (fpa_hi == 1) {
02995             significand_hi = significand_hi + 1;
02996 
02997             <span class="keywordflow">if</span> (significand_hi == 0x01000000) {
02998               significand_hi = 0x0800000;
02999               true_bexp_hi++; <span class="comment">// e_min + 0x7f + 0x01</span>
03000             }
03001           }
03002 
03003           <span class="keywordflow">if</span> (significand_hi == 0) {
03004             true_bexp_hi = 0; <span class="comment">// otherwise it is e_min or e_min + 1</span>
03005           }
03006 
03007           exponent_hi = true_bexp_hi;
03008 
03009           <span class="keywordflow">if</span> ((exponent_hi == 0x01) &amp;&amp; ((significand_hi &amp; 0x0800000) == 0)) {
03010             exponent_hi = 0x0; <span class="comment">// result high is denormal</span>
03011 <span class="preprocessor">#ifdef DEBUG_UNIX</span>
03012 <span class="preprocessor"></span>            printf (<span class="stringliteral">"DEBUG: result high is denormal\n"</span>);
03013 <span class="preprocessor">#endif</span>
03014 <span class="preprocessor"></span>          }
03015 
03016           <span class="comment">// determine the new value of I_exc_hi</span>
03017           I_exc_hi = round_hi | sticky_hi;
03018 
03019           <span class="comment">// the high half could only raise an inexact exception; if it does</span>
03020           <span class="comment">// not, clear U_exc_hi, I_exc_hi, and fpa_hi in ISRlow</span>
03021 
03022           <span class="keywordflow">if</span> (!I_exc_hi) { 
03023 
03024             <span class="comment">// if exact, then no new exception has to be raised for the high</span>
03025             <span class="comment">// half of the instruction; clear U_exc_hi in ISRlow (an exception</span>
03026             <span class="comment">// might be raised by the high half of the instruction)  [clearing</span>
03027             <span class="comment">// I is redundant: it could not have been inexact and then become</span>
03028             <span class="comment">// exact after denormalization]</span>
03029 
03030             ISRlow = ISRlow &amp; 0xefff;
03031               <span class="comment">// need to clean ISRlow because the other half might raise exc.</span>
03032 
03033             <span class="comment">// FPSR in the trap frame needs no update for the high half: with </span>
03034             <span class="comment">// U traps disabled, the result would have to be tiny and inexact</span>
03035             <span class="comment">// in order to set the U flag; both U and I flags in the FPSR</span>
03036             <span class="comment">// stay unchanged</span>
03037             U_exc_hi = 0;
03038 
03039             <span class="comment">// no exception raised for the high half - clear fpa_hi (an</span>
03040             <span class="comment">// exception might be raised by the low half of the instruction)</span>
03041             ISRlow = ISRlow &amp; 0xbfff;
03042 
03043           } <span class="keywordflow">else</span> { <span class="comment">// if (I_exc_hi)</span>
03044 
03045             <span class="comment">// if tiny and inexact will set U and I in FPSR, as U_exc_hi = 1</span>
03046             <span class="keywordflow">if</span> (I_dis) { <span class="comment">// the high half will not raise an inexact exception</span>
03047               <span class="comment">// clear I_exc_hi and U_exc_hi in ISRlow (prepare ISRlow</span>
03048               <span class="comment">// because the low half might raise an exception); no exception</span>
03049               <span class="comment">// raised for the high half - clear also fpa_hi</span>
03050               ISRlow = ISRlow &amp; 0x8fff;
03051             } <span class="keywordflow">else</span> { <span class="comment">// update ISR code - will raise an inexact trap</span>
03052               <span class="comment">// clear U_hi and set I_hi in ISRlow - will raise inexact trap</span>
03053               ISRlow = (ISRlow &amp; 0xefff) | 0x2000;
03054             <span class="comment">// update the fpa_hi bit in the ISR code (NOT DONE IN EM_FP82)</span>
03055             <span class="keywordflow">if</span> (fpa_hi)
03056               ISRlow = ISRlow | 0x4000;
03057             <span class="keywordflow">else</span>
03058               ISRlow = ISRlow &amp; 0xbfff;
03059             }
03060 
03061           }
03062 
03063         }
03064 
03065         <span class="keywordflow">if</span> (O_dis &amp;&amp; O_exc_hi) { <span class="comment">// the result is not zero, and is normal with</span>
03066             <span class="comment">// unbounded exponent</span>
03067 
03068           <span class="comment">// true_bexp_hi not used in this case, and neither is decr_exp_hi</span>
03069           <span class="comment">// true_bexp_hi = </span>
03070           <span class="comment">//     (exponent_hi == 0xff ? exponent_hi : exponent_hi + 0x100);</span>
03071 
03072           <span class="comment">// determine the result, according to the rounding mode</span>
03073           <span class="keywordflow">switch</span> (rc) {
03074             <span class="keywordflow">case</span> <a class="code" href="../../d2/d3/fetypes_8h.html#a455a412">rc_rn</a>: <span class="comment">// +infinity or -infinity</span>
03075               exponent_hi = 0x0ff;
03076               significand_hi = 0x0800000;
03077               <span class="keywordflow">break</span>;
03078             <span class="keywordflow">case</span> <a class="code" href="../../d2/d3/fetypes_8h.html#a455a413">rc_rm</a>: <span class="comment">// +max_fp or -infinity</span>
03079               exponent_hi = (sign_hi == 0 ? 0x0fe : 0x0ff);
03080               significand_hi = (sign_hi == 0 ? 0x0ffffff : 0x0800000);
03081               <span class="keywordflow">break</span>;
03082             <span class="keywordflow">case</span> <a class="code" href="../../d2/d3/fetypes_8h.html#a455a414">rc_rp</a>: <span class="comment">// +infinity or -max_fp</span>
03083               exponent_hi = (sign_hi == 0 ? 0x0ff : 0x0fe);
03084               significand_hi = (sign_hi == 0 ? 0x0800000 : 0x0ffffff);
03085               <span class="keywordflow">break</span>;
03086             <span class="keywordflow">case</span> <a class="code" href="../../d2/d3/fetypes_8h.html#a455a415">rc_rz</a>: <span class="comment">// +max_fp or -max_fp</span>
03087               exponent_hi = 0x0fe;
03088               significand_hi = 0x0ffffff;
03089               <span class="keywordflow">break</span>;
03090             <span class="keywordflow">default</span>:
03091 <span class="preprocessor">#ifndef unix</span>
03092 <span class="preprocessor"></span>              <a class="code" href="../../d9/d1/fedefs_8h.html#a2">FP_EMULATION_ERROR1</a> (<span class="stringliteral">"fp_emulate () Internal \</span>
03093 <span class="stringliteral">Error: invalid rc = %d for SIMD F1 instruction\n"</span>, rc)
03094 #<span class="keywordflow">else</span>
03095               <a class="code" href="../../d9/d1/fedefs_8h.html#a2">FP_EMULATION_ERROR1</a> (<span class="stringliteral">"fp_emulate () Internal \</span>
03096 <span class="stringliteral">Error: invalid rc = %d for SIMD F1 instruction\n"</span>, rc)
03097               <span class="keywordflow">return</span> (<a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a2">FP_EMUL_ERROR</a>);
03098 <span class="preprocessor">#endif</span>
03099 <span class="preprocessor"></span>          }
03100 
03101           <span class="keywordflow">if</span> (exponent_hi == 0xff)
03102             fpa_hi = 1;
03103           <span class="keywordflow">else</span>
03104             fpa_hi = 0;
03105 
03106           <span class="comment">// will update FPSR</span>
03107           O_exc_hi = 1; <span class="comment">// must have been so already</span>
03108           I_exc_hi = 1;
03109 
03110           <span class="keywordflow">if</span> (I_dis) { 
03111 
03112             <span class="comment">// clear fpa_hi, I_exc_hi and O_exc_hi in ISRlow - an enabled U</span>
03113             <span class="comment">// exception might be raised for the low half</span>
03114             ISRlow = ISRlow &amp; 0x97ff;
03115 
03116           } <span class="keywordflow">else</span> { <span class="comment">// if (!I_dis)</span>
03117 
03118             <span class="comment">// update ISR code - will raise an inexact exception for high half;</span>
03119             <span class="comment">// clear O_exc_hi and set I_exc_hi in ISRlow - the result</span>
03120             <span class="comment">// is always inexact</span>
03121             ISRlow = (ISRlow &amp; 0xf7ff) | 0x2000;
03122             <span class="comment">// update the fpa_hi bit</span>
03123             <span class="keywordflow">if</span> (fpa_hi)
03124               ISRlow = ISRlow | 0x4000;
03125             <span class="keywordflow">else</span>
03126               ISRlow = ISRlow &amp; 0xbfff;
03127             <span class="comment">// Note that the exact result cannot be retrieved by the inexact</span>
03128             <span class="comment">// exception trap handler [but this will not occur on Merced]</span>
03129 
03130           }
03131 
03132         }
03133 
03134         <span class="keywordflow">if</span> (I_dis &amp;&amp; I_exc_hi) {
03135        
03136           ; <span class="comment">// nothing to do (keep this as a place holder)</span>
03137           <span class="comment">// redundant - this case was caught before</span>
03138 
03139         }
03140 
03141         <span class="comment">// return the result</span>
03142         low_half = (sign_lo &lt;&lt; 31) | (exponent_lo &lt;&lt; 23) | 
03143             significand_lo &amp; 0x07fffff;
03144 
03145         high_half = (sign_hi &lt;&lt; 31) | (exponent_hi &lt;&lt; 23) |
03146             significand_hi &amp; 0x07fffff;
03147 
03148         ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o0">significand</a> = high_half &lt;&lt; 32 | low_half; 
03149 
03150         <span class="comment">// Note: the exponent is 0x1003e even for a significand of 0 (ACR 131)</span>
03151 
03152         <span class="comment">// successful emulation</span>
03153 
03154         <span class="comment">// set the destination floating-point register value (this is a trap)</span>
03155 <span class="preprocessor">#ifdef DEBUG_UNIX</span>
03156 <span class="preprocessor"></span>printf (<span class="stringliteral">"DEBUG AFTER F1 SWA TRAP 2: ps-&gt;state_FR[lf1] = %x %x %Lx\n"</span>,
03157   ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o2">sign</a>, ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o1">exponent</a>, 
03158   ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1].<a class="code" href="../../d0/d0/structfp__reg__struct.html#o0">significand</a>);
03159 <span class="preprocessor">#endif</span>
03160 <span class="preprocessor"></span>        <a class="code" href="../../d6/d5/ia64_2getsetrg_8c.html#a9">set_fp_register</a> (f1, <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a85">FPRegToFP128</a>(ps-&gt;<a class="code" href="../../d9/d8/structEM__state__struct.html#o3">state_FR</a>[lf1]), fp_state);
03161         <span class="keywordflow">if</span> (f1 &lt; 32)
03162           *pipsr = *pipsr | (<a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a>)0x10; <span class="comment">// set mfl bit</span>
03163         <span class="keywordflow">else</span>
03164           *pipsr = *pipsr | (<a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a>)0x20; <span class="comment">// set mfh bit</span>
03165 
03166         <span class="comment">// update the FPSR (but will not be able to distinguish lo from hi)</span>
03167         <span class="keywordflow">if</span> (I_exc_lo || I_exc_hi) { <span class="comment">// set I in FPSR</span>
03168           <span class="comment">// I traps must be disabled at this point</span>
03169           *pfpsr = *pfpsr |
03170               ((<a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a>)1 &lt;&lt; (6 + (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)sf * 13 + 12));
03171         } <span class="comment">// else leave unchanged the sticky bit I</span>
03172         <span class="keywordflow">if</span> (U_exc_lo || U_exc_hi) { <span class="comment">// set U in FPSR</span>
03173           <span class="comment">// U traps must be disabled at this point</span>
03174           *pfpsr = *pfpsr |
03175               ((<a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a>)1 &lt;&lt; (6 + (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)sf * 13 + 11));
03176         } <span class="comment">// else leave unchanged the sticky bit U</span>
03177         <span class="keywordflow">if</span> (O_exc_lo || O_exc_hi) { <span class="comment">// set O in FPSR</span>
03178           <span class="comment">// O traps must be disabled at this point</span>
03179           *pfpsr = *pfpsr |
03180               ((<a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a>)1 &lt;&lt; (6 + (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)sf * 13 + 10));
03181         } <span class="comment">// else leave unchanged the sticky bit O</span>
03182 
03183         <span class="comment">// return TRUE if no exception has to be raised</span>
03184         <span class="keywordflow">if</span> ((I_dis || I_exc_lo == 0 &amp;&amp; I_exc_hi == 0) &amp;&amp;
03185             (U_dis || U_exc_lo == 0 &amp;&amp; U_exc_hi == 0) &amp;&amp;
03186             (O_dis || O_exc_lo == 0 &amp;&amp; O_exc_hi == 0)) {
03187 
03188           <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
03189 
03190         } <span class="keywordflow">else</span> {
03191 
03192           <span class="comment">// if ((low inexact || high inexact) &amp;&amp; I traps enabled or</span>
03193           <span class="comment">//     (low underflow || high underflow) &amp;&amp; U traps enabled or</span>
03194           <span class="comment">//     (low overflow || high overflow) &amp;&amp; O traps enabled)</span>
03195 
03196           <span class="comment">// ISRlow might have been updated</span>
03197           *pisr = ((*pisr) &amp; 0xffffffffffff0000) | ISRlow;
03198 
03199           <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> | <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a4">SIMD_INSTRUCTION</a>); <span class="comment">// will raise O, U, or I trap</span>
03200 
03201         }
03202 
03203       }
03204 
03205     } <span class="keywordflow">else</span> {
03206 
03207       <span class="comment">// unrecognized instruction type</span>
03208 <span class="preprocessor">#ifndef unix</span>
03209 <span class="preprocessor"></span>      <a class="code" href="../../d9/d1/fedefs_8h.html#a2">FP_EMULATION_ERROR1</a> (<span class="stringliteral">"fp_emulate () Internal Error: \</span>
03210 <span class="stringliteral">instruction opcode %8x %8x not valid for SWA trap\n"</span>, OpCode)
03211 #<span class="keywordflow">else</span>
03212       <a class="code" href="../../d9/d1/fedefs_8h.html#a2">FP_EMULATION_ERROR1</a> (<span class="stringliteral">"fp_emulate () Internal Error: \</span>
03213 <span class="stringliteral">instruction opcode %Lx not valid for SWA trap\n"</span>, OpCode)
03214       <span class="keywordflow">return</span> (<a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a2">FP_EMUL_ERROR</a>);
03215 <span class="preprocessor">#endif</span>
03216 <span class="preprocessor"></span>
03217     }
03218 
03219     <span class="comment">// end 'else if (trap_type == FPTRAP &amp;&amp; swa_trap (sf, FPSR, ISRlow))'</span>
03220 
03221   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (trap_type == <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a5">FPFLT</a> || trap_type == <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a6">FPTRAP</a>) {
03222 
03223 <span class="preprocessor">#ifdef DEBUG_UNIX</span>
03224 <span class="preprocessor"></span>    printf (<span class="stringliteral">"DEBUG: INSTRUCTION NOT EMULATED\n"</span>);
03225 <span class="preprocessor">#endif</span>
03226 <span class="preprocessor"></span>
03227     <span class="comment">// if we got here, the trapping instruction was not emulated, because it</span>
03228     <span class="comment">// did not raise a SWA fault or trap. This includes the cases when a </span>
03229     <span class="comment">// V or Z fault or an U, O, or I trap occurred, and the exceptions </span>
03230     <span class="comment">// raised were enabled</span>
03231 
03232     <span class="comment">// determine whether this is a non-SIMD, or a SIMD instruction</span>
03233 
03234     <span class="keywordflow">if</span> ((OpCode &amp; <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a10">F1_MIN_MASK</a>) == <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a11">F1_PATTERN</a>) {
03235       <span class="comment">// F1 instruction</span>
03236 
03237       <span class="keywordflow">switch</span> (OpCode &amp; <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a12">F1_MASK</a>) {
03238         <span class="keywordflow">case</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a13">FMA_PATTERN</a>:
03239         <span class="keywordflow">case</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a14">FMA_S_PATTERN</a>:
03240         <span class="keywordflow">case</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a15">FMA_D_PATTERN</a>:
03241         <span class="keywordflow">case</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a17">FMS_PATTERN</a>:
03242         <span class="keywordflow">case</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a18">FMS_S_PATTERN</a>:
03243         <span class="keywordflow">case</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a19">FMS_D_PATTERN</a>:
03244         <span class="keywordflow">case</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a21">FNMA_PATTERN</a>:
03245         <span class="keywordflow">case</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a22">FNMA_S_PATTERN</a>:
03246         <span class="keywordflow">case</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a23">FNMA_D_PATTERN</a>:
03247           SIMD_instruction = 0;
03248           <span class="keywordflow">break</span>;
03249         <span class="keywordflow">case</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a16">FPMA_PATTERN</a>:
03250         <span class="keywordflow">case</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a20">FPMS_PATTERN</a>:
03251         <span class="keywordflow">case</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a24">FPNMA_PATTERN</a>:
03252           SIMD_instruction = 1;
03253           <span class="keywordflow">break</span>;
03254         <span class="keywordflow">default</span>:
03255           <span class="comment">// unrecognized instruction type</span>
03256 <span class="preprocessor">#ifndef unix</span>
03257 <span class="preprocessor"></span>          <a class="code" href="../../d9/d1/fedefs_8h.html#a2">FP_EMULATION_ERROR1</a> (<span class="stringliteral">"fp_emulate () Internal Error: \</span>
03258 <span class="stringliteral">instruction opcode %8x %8x not recognized\n"</span>, OpCode)
03259 #<span class="keywordflow">else</span>
03260           <a class="code" href="../../d9/d1/fedefs_8h.html#a2">FP_EMULATION_ERROR1</a> (<span class="stringliteral">"fp_emulate () Internal Error: \</span>
03261 <span class="stringliteral">instruction opcode %Lx not recognized\n"</span>, OpCode)
03262           return (FP_EMUL_ERROR);
03263 #endif
03264       }
03265 
03266     } else if ((OpCode &amp; F4_MIN_MASK) == F4_PATTERN) {
03267       <span class="comment">// F4 instruction</span>
03268 
03269       <span class="keywordflow">switch</span> (OpCode &amp; <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a27">F4_MASK</a>) {
03270         <span class="keywordflow">case</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a28">FCMP_EQ_PATTERN</a>:
03271         <span class="keywordflow">case</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a29">FCMP_LT_PATTERN</a>:
03272         <span class="keywordflow">case</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a30">FCMP_LE_PATTERN</a>:
03273         <span class="keywordflow">case</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a31">FCMP_UNORD_PATTERN</a>:
03274         <span class="keywordflow">case</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a32">FCMP_EQ_UNC_PATTERN</a>:
03275         <span class="keywordflow">case</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a33">FCMP_LT_UNC_PATTERN</a>:
03276         <span class="keywordflow">case</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a34">FCMP_LE_UNC_PATTERN</a>:
03277         <span class="keywordflow">case</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a35">FCMP_UNORD_UNC_PATTERN</a>:
03278           SIMD_instruction = 0;
03279           <span class="keywordflow">break</span>;
03280         <span class="keywordflow">default</span>:
03281           <span class="comment">// unrecognized instruction type</span>
03282 <span class="preprocessor">#ifndef unix</span>
03283 <span class="preprocessor"></span>          <a class="code" href="../../d9/d1/fedefs_8h.html#a2">FP_EMULATION_ERROR1</a> (<span class="stringliteral">"fp_emulate () Internal Error: \</span>
03284 <span class="stringliteral">instruction opcode %8x %8x not recognized\n"</span>, OpCode)
03285 #<span class="keywordflow">else</span>
03286           <a class="code" href="../../d9/d1/fedefs_8h.html#a2">FP_EMULATION_ERROR1</a> (<span class="stringliteral">"fp_emulate () Internal Error: \</span>
03287 <span class="stringliteral">instruction opcode %Lx not recognized\n"</span>, OpCode)
03288           return (FP_EMUL_ERROR);
03289 #endif
03290       }
03291 
03292     } else if ((OpCode &amp; F6_MIN_MASK) == F6_PATTERN) {
03293       <span class="comment">// F6 instruction</span>
03294 
03295       <span class="keywordflow">switch</span> (OpCode &amp; <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a38">F6_MASK</a>) {
03296         <span class="keywordflow">case</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a39">FRCPA_PATTERN</a>:
03297           SIMD_instruction = 0;
03298           <span class="keywordflow">break</span>;
03299         <span class="keywordflow">case</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a40">FPRCPA_PATTERN</a>:
03300           SIMD_instruction = 1;
03301           <span class="keywordflow">break</span>;
03302         <span class="keywordflow">default</span>:
03303           <span class="comment">// unrecognized instruction type</span>
03304 <span class="preprocessor">#ifndef unix</span>
03305 <span class="preprocessor"></span>          <a class="code" href="../../d9/d1/fedefs_8h.html#a2">FP_EMULATION_ERROR1</a> (<span class="stringliteral">"fp_emulate () Internal Error: \</span>
03306 <span class="stringliteral">instruction opcode %8x %8x not recognized\n"</span>, OpCode)
03307 #<span class="keywordflow">else</span>
03308           <a class="code" href="../../d9/d1/fedefs_8h.html#a2">FP_EMULATION_ERROR1</a> (<span class="stringliteral">"fp_emulate () Internal Error: \</span>
03309 <span class="stringliteral">instruction opcode %Lx not recognized\n"</span>, OpCode)
03310           return (FP_EMUL_ERROR);
03311 #endif
03312       }
03313 
03314     } else if ((OpCode &amp; F7_MIN_MASK) == F7_PATTERN) {
03315       <span class="comment">// F7 instruction</span>
03316 
03317       <span class="keywordflow">switch</span> (OpCode &amp; <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a43">F7_MASK</a>) {
03318         <span class="keywordflow">case</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a44">FRSQRTA_PATTERN</a>:
03319           SIMD_instruction = 0;
03320           <span class="keywordflow">break</span>;
03321         <span class="keywordflow">case</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a45">FPRSQRTA_PATTERN</a>:
03322           SIMD_instruction = 1;
03323           <span class="keywordflow">break</span>;
03324         <span class="keywordflow">default</span>:
03325           <span class="comment">// unrecognized instruction type</span>
03326 <span class="preprocessor">#ifndef unix</span>
03327 <span class="preprocessor"></span>          <a class="code" href="../../d9/d1/fedefs_8h.html#a2">FP_EMULATION_ERROR1</a> (<span class="stringliteral">"fp_emulate () Internal Error: \</span>
03328 <span class="stringliteral">instruction opcode %8x %8x not recognized\n"</span>, OpCode)
03329 #<span class="keywordflow">else</span>
03330           <a class="code" href="../../d9/d1/fedefs_8h.html#a2">FP_EMULATION_ERROR1</a> (<span class="stringliteral">"fp_emulate () Internal Error: \</span>
03331 <span class="stringliteral">instruction opcode %Lx not recognized\n"</span>, OpCode)
03332           return (FP_EMUL_ERROR);
03333 #endif
03334       }
03335 
03336     } else if ((OpCode &amp; F8_MIN_MASK) == F8_PATTERN) {
03337       <span class="comment">// F8 instruction</span>
03338 
03339       <span class="keywordflow">switch</span> (OpCode &amp; <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a48">F8_MASK</a>) {
03340         <span class="keywordflow">case</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a49">FMIN_PATTERN</a>:
03341         <span class="keywordflow">case</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a50">FMAX_PATTERN</a>:
03342         <span class="keywordflow">case</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a51">FAMIN_PATTERN</a>:
03343         <span class="keywordflow">case</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a52">FAMAX_PATTERN</a>:
03344           SIMD_instruction = 0;
03345           <span class="keywordflow">break</span>;
03346         <span class="keywordflow">case</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a53">FPMIN_PATTERN</a>:
03347         <span class="keywordflow">case</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a54">FPMAX_PATTERN</a>:
03348         <span class="keywordflow">case</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a55">FPAMIN_PATTERN</a>:
03349         <span class="keywordflow">case</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a56">FPAMAX_PATTERN</a>:
03350         <span class="keywordflow">case</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a57">FPCMP_EQ_PATTERN</a>:
03351         <span class="keywordflow">case</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a58">FPCMP_LT_PATTERN</a>:
03352         <span class="keywordflow">case</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a59">FPCMP_LE_PATTERN</a>:
03353         <span class="keywordflow">case</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a60">FPCMP_UNORD_PATTERN</a>:
03354         <span class="keywordflow">case</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a61">FPCMP_NEQ_PATTERN</a>:
03355         <span class="keywordflow">case</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a62">FPCMP_NLT_PATTERN</a>:
03356         <span class="keywordflow">case</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a63">FPCMP_NLE_PATTERN</a>:
03357         <span class="keywordflow">case</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a64">FPCMP_ORD_PATTERN</a>:
03358           SIMD_instruction = 1;
03359           <span class="keywordflow">break</span>;
03360         <span class="keywordflow">default</span>:
03361           <span class="comment">// unrecognized instruction type</span>
03362 <span class="preprocessor">#ifndef unix</span>
03363 <span class="preprocessor"></span>          <a class="code" href="../../d9/d1/fedefs_8h.html#a2">FP_EMULATION_ERROR1</a> (<span class="stringliteral">"fp_emulate () Internal Error: \</span>
03364 <span class="stringliteral">instruction opcode %8x %8x not recognized\n"</span>, OpCode)
03365 #<span class="keywordflow">else</span>
03366           <a class="code" href="../../d9/d1/fedefs_8h.html#a2">FP_EMULATION_ERROR1</a> (<span class="stringliteral">"fp_emulate () Internal Error: \</span>
03367 <span class="stringliteral">instruction opcode %Lx not recognized\n"</span>, OpCode)
03368           return (FP_EMUL_ERROR);
03369 #endif
03370       }
03371 
03372     } else if ((OpCode &amp; F10_MIN_MASK) == F10_PATTERN) {
03373       <span class="comment">// F10 instruction</span>
03374 
03375       <span class="keywordflow">switch</span> (OpCode &amp; <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a67">F10_MASK</a>) {
03376         <span class="keywordflow">case</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a68">FCVT_FX_PATTERN</a>:
03377         <span class="keywordflow">case</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a69">FCVT_FXU_PATTERN</a>:
03378         <span class="keywordflow">case</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a70">FCVT_FX_TRUNC_PATTERN</a>:
03379         <span class="keywordflow">case</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a71">FCVT_FXU_TRUNC_PATTERN</a>:
03380           SIMD_instruction = 0;
03381           <span class="keywordflow">break</span>;
03382         <span class="keywordflow">case</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a72">FPCVT_FX_PATTERN</a>:
03383         <span class="keywordflow">case</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a73">FPCVT_FXU_PATTERN</a>:
03384         <span class="keywordflow">case</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a74">FPCVT_FX_TRUNC_PATTERN</a>:
03385         <span class="keywordflow">case</span> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a75">FPCVT_FXU_TRUNC_PATTERN</a>:
03386           SIMD_instruction = 1;
03387           <span class="keywordflow">break</span>;
03388         <span class="keywordflow">default</span>:
03389           <span class="comment">// unrecognized instruction type</span>
03390 <span class="preprocessor">#ifndef unix</span>
03391 <span class="preprocessor"></span>          <a class="code" href="../../d9/d1/fedefs_8h.html#a2">FP_EMULATION_ERROR1</a> (<span class="stringliteral">"fp_emulate () Internal Error: \</span>
03392 <span class="stringliteral">instruction opcode %8x %8x not recognized\n"</span>, OpCode)
03393 #<span class="keywordflow">else</span>
03394           <a class="code" href="../../d9/d1/fedefs_8h.html#a2">FP_EMULATION_ERROR1</a> (<span class="stringliteral">"fp_emulate () Internal Error: \</span>
03395 <span class="stringliteral">instruction opcode %Lx not recognized\n"</span>, OpCode)
03396           return (FP_EMUL_ERROR);
03397 #endif
03398       }
03399 
03400     } else {
03401 
03402       <span class="comment">// unrecognized instruction type</span>
03403 <span class="preprocessor">#ifndef unix</span>
03404 <span class="preprocessor"></span>      <a class="code" href="../../d9/d1/fedefs_8h.html#a2">FP_EMULATION_ERROR1</a> (<span class="stringliteral">"fp_emulate () Internal Error: \</span>
03405 <span class="stringliteral">instruction opcode %8x %8x not recognized\n"</span>, OpCode)
03406 #<span class="keywordflow">else</span>
03407       <a class="code" href="../../d9/d1/fedefs_8h.html#a2">FP_EMULATION_ERROR1</a> (<span class="stringliteral">"fp_emulate () Internal Error: \</span>
03408 <span class="stringliteral">instruction opcode %Lx not recognized\n"</span>, OpCode)
03409       return (FP_EMUL_ERROR);
03410 #endif
03411 
03412     }
03413 
03414 #ifdef DEBUG_UNIX
03415 if ((OpCode &amp; F1_MIN_MASK) == F1_PATTERN) {
03416 printf (<span class="stringliteral">"DEBUG AFTER 'NO EMULATION' RET FALSE: ps-&gt;state_FR[lf1] = %x %x %Lx\n"</span>,
03417   ps-&gt;state_FR[lf1].sign, ps-&gt;state_FR[lf1].exponent, 
03418   ps-&gt;state_FR[lf1].significand);
03419 }
03420 <span class="preprocessor">#endif</span>
03421 <span class="preprocessor"></span>
03422     <span class="comment">// no emulation; ISRlow and AR[0].uint_value (FPSR) have not changed</span>
03423     <span class="keywordflow">if</span> (SIMD_instruction)
03424       <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> | <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a4">SIMD_INSTRUCTION</a>); <span class="comment">// will raise fp exception</span>
03425     <span class="keywordflow">else</span>
03426       <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>); <span class="comment">// will raise fp exception</span>
03427 
03428   } <span class="keywordflow">else</span> {
03429 
03430 <span class="preprocessor">#ifdef DEBUG_UNIX</span>
03431 <span class="preprocessor"></span>    printf (<span class="stringliteral">"DEBUG: STATUS FLOAT ERROR\n"</span>);
03432 <span class="preprocessor">#endif</span>
03433 <span class="preprocessor"></span>
03434     <span class="comment">// fp_emulate () called w/o </span>
03435     <span class="comment">// trap_frame-&gt;type == 0x020 || trap_fram-&gt;type == 0x021 </span>
03436 <span class="preprocessor">#ifndef unix</span>
03437 <span class="preprocessor"></span>    <a class="code" href="../../d9/d1/fedefs_8h.html#a3">FP_EMULATION_ERROR2</a> (<span class="stringliteral">"fp_emulate () Internal Error: \</span>
03438 <span class="stringliteral">fp_emulate () called w/o trap_type FPFLT or FPTRAP \</span>
03439 <span class="stringliteral"> OpCode = %8x %8x, and ISR code = %x\n"</span>, OpCode, ISRlow)
03440 #<span class="keywordflow">else</span>
03441     <a class="code" href="../../d9/d1/fedefs_8h.html#a3">FP_EMULATION_ERROR2</a> (<span class="stringliteral">"fp_emulate () Internal Error: \</span>
03442 <span class="stringliteral">fp_emulate () called w/o trap_type FPFLT or FPTRAP \</span>
03443 <span class="stringliteral"> OpCode = %Lx, and ISR code = %x\n"</span>, OpCode, ISRlow)
03444     return (FP_EMUL_ERROR);
03445 #endif
03446 
03447   }
03448 
03449 new_exception:
03450 
03451   <span class="comment">// can get here only if </span>
03452   <span class="comment">// trap_type == FPFLT, and</span>
03453   <span class="comment">// the emulation generated a new FP exception (e.g. if an fma with</span>
03454   <span class="comment">// denormal input[s] causes an underflow, and the underflow traps are</span>
03455   <span class="comment">// enabled; also [but not only] if an fma has a denormal input, and denormal</span>
03456   <span class="comment">// exceptions are enabled)</span>
03457 
03458   new_trap_type = ps-&gt;trap_type;
03459 
03460   if (new_trap_type == FPFLT) { <span class="comment">// fault</span>
03461 
03462     <span class="comment">// this is a fault - it must be a denormal exception or an invalid</span>
03463     <span class="comment">// exception (the latter only for fcvt.fxu[.trunc] with negative</span>
03464     <span class="comment">// unnormal input)</span>
03465     fault_ISR_code = (ps-&gt;state_MERCED_RTL &gt;&gt; 16) &amp; 0x0ffff;
03466     <span class="keywordflow">if</span> ((fault_ISR_code &amp; 0x077) == 0) { <span class="comment">// SWA fault only</span>
03467 <span class="preprocessor">#ifndef unix</span>
03468 <span class="preprocessor"></span>      <a class="code" href="../../d9/d1/fedefs_8h.html#a1">FP_EMULATION_ERROR0</a> (
03469           <span class="stringliteral">"fp_emulate () Internal Error: SWA fault repeated\n"</span>);
03470 <span class="preprocessor">#else</span>
03471 <span class="preprocessor"></span>      <a class="code" href="../../d9/d1/fedefs_8h.html#a1">FP_EMULATION_ERROR0</a> (
03472           <span class="stringliteral">"fp_emulate () Internal Error: SWA fault repeated\n"</span>);
03473       <span class="keywordflow">return</span> (<a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a2">FP_EMUL_ERROR</a>);
03474 <span class="preprocessor">#endif</span>
03475 <span class="preprocessor"></span>    }
03476 
03477 <span class="preprocessor">#ifdef DEBUG_UNIX</span>
03478 <span class="preprocessor"></span>    printf (<span class="stringliteral">"DEBUG fp_emulate () NEW_EXC fault_ISR_code = %x\n"</span>, fault_ISR_code);
03479 <span class="preprocessor">#endif</span>
03480 <span class="preprocessor"></span>
03481 <span class="preprocessor">#ifdef DEBUG_UNIX</span>
03482 <span class="preprocessor"></span><span class="keywordflow">if</span> ((OpCode &amp; <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a10">F1_MIN_MASK</a>) == <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a11">F1_PATTERN</a>)
03483   printf (<span class="stringliteral">"DEBUG NEW_EXC FAULT PART RET FALSE: ps-&gt;state_FR[lf1] = %x %x %Lx\n"</span>,
03484       ps-&gt;state_FR[lf1].sign, ps-&gt;state_FR[lf1].exponent, 
03485       ps-&gt;state_FR[lf1].significand);
03486 <span class="preprocessor">#endif</span>
03487 <span class="preprocessor"></span>
03488     <span class="comment">// update the ISR code, to pass the new value of ISR.code to the </span>
03489     <span class="comment">// user</span>
03490     *pisr = ((*pisr) &amp; 0xffffffffffff0000) | fault_ISR_code;
03491 
03492     <span class="comment">// the FPSR is unchanged</span>
03493     <span class="keywordflow">if</span> (SIMD_instruction)
03494       <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> | <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a4">SIMD_INSTRUCTION</a>); <span class="comment">// will raise fp exception</span>
03495     <span class="keywordflow">else</span>
03496       <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>); <span class="comment">// will raise fp exception</span>
03497 
03498   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (new_trap_type == <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a6">FPTRAP</a>) { <span class="comment">// trap</span>
03499 
03500     <span class="comment">// this is a trap</span>
03501     trap_ISR_code = (ps-&gt;state_MERCED_RTL &gt;&gt; 16) &amp; 0x0ffff;
03502 
03503 <span class="preprocessor">#ifdef DEBUG_UNIX</span>
03504 <span class="preprocessor"></span>    printf (<span class="stringliteral">"DEBUG fp_emulate () NEW_EXC trap_ISR_code = %4.4x\n"</span>, trap_ISR_code);
03505 <span class="preprocessor">#endif</span>
03506 <span class="preprocessor"></span>
03507     <span class="comment">// set the destination floating-point reg value, as this is a trap</span>
03508 <span class="preprocessor">#ifdef DEBUG_UNIX</span>
03509 <span class="preprocessor"></span>printf (<span class="stringliteral">"DEBUG NEW_EXC TRAP PART RET FALSE: ps-&gt;state_FR[lf1] = %x %x %Lx\n"</span>,
03510   ps-&gt;state_FR[lf1].sign, ps-&gt;state_FR[lf1].exponent, 
03511   ps-&gt;state_FR[lf1].significand);
03512 printf (<span class="stringliteral">"DEBUG NEW_EXC TRAP PART RET FALSE: f1 f2 f3 f4 = %x %x %x %x\n"</span>,
03513   f1, f2, f3, f4);
03514 <span class="preprocessor">#endif</span>
03515 <span class="preprocessor"></span>    <a class="code" href="../../d6/d5/ia64_2getsetrg_8c.html#a9">set_fp_register</a> (f1, <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a85">FPRegToFP128</a>(ps-&gt;state_FR[lf1]), fp_state);
03516     <span class="keywordflow">if</span> (f1 &lt; 32)
03517       *pipsr = *pipsr | (<a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a>)0x10; <span class="comment">// set mfl bit</span>
03518     <span class="keywordflow">else</span>
03519       *pipsr = *pipsr | (<a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a>)0x20; <span class="comment">// set mfh bit</span>
03520 
03521     <span class="comment">// replace trap_ISR_code in the updated ISR code (nothing else changes)</span>
03522     *pisr = ((*pisr) &amp; 0xffffffffffff0000) | trap_ISR_code;
03523 
03524     <span class="comment">// copy ps-&gt;state_AR[0] back into the trap frame FPSR</span>
03525     *pfpsr =  ps-&gt;state_AR[0].uint_value;
03526 
03527     <span class="comment">// caller will advance instruction pointer iip</span>
03528     <span class="keywordflow">if</span> (SIMD_instruction)
03529       <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> | <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a3">FAULT_TO_TRAP</a> | <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a4">SIMD_INSTRUCTION</a>); <span class="comment">// will raise fp exc</span>
03530     <span class="keywordflow">else</span>
03531       <span class="keywordflow">return</span> (<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a> | <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a3">FAULT_TO_TRAP</a>); <span class="comment">// will raise fp exception</span>
03532 
03533   } <span class="keywordflow">else</span> {
03534 <span class="preprocessor">#ifndef unix</span>
03535 <span class="preprocessor"></span>    <a class="code" href="../../d9/d1/fedefs_8h.html#a2">FP_EMULATION_ERROR1</a> (
03536         <span class="stringliteral">"fp_emulate () Internal Error: new_trap_type = %x\n"</span>, new_trap_type)
03537 #<span class="keywordflow">else</span>
03538     <a class="code" href="../../d9/d1/fedefs_8h.html#a2">FP_EMULATION_ERROR1</a> (
03539         <span class="stringliteral">"fp_emulate () Internal Error: new_trap_type = %x\n"</span>, new_trap_type)
03540     return (FP_EMUL_ERROR);
03541 #endif
03542   }
03543 
03544 }
03545 
03546 
03547 
03548 <span class="keywordtype">int</span>
<a name="l03549"></a><a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a83">03549</a> swa_trap (EM_opcode_sf_type sf, EM_uint64_t FPSR, EM_uint_t ISRlow)
03550 
03551 {
03552 
03553   <span class="keywordtype">int</span> IsSWA;
03554   <span class="keywordtype">int</span> U_en, U_exc;
03555   <span class="keywordtype">int</span> O_en, O_exc;
03556 
03557   <span class="comment">// this assumes that for a non-SIMD instruction, the "low" bits in </span>
03558   <span class="comment">// ISRlow are 0</span>
03559 
03560   <span class="comment">// SWA trap for U if </span>
03561   <span class="comment">//     bit 0 in ISR.code is set             [fp trap] [redundant]</span>
03562   <span class="comment">//         and </span>
03563   <span class="comment">//     (bit 8 or bit 12 in ISR.code is set) [U normal, or SIMD low or high]</span>
03564   <span class="comment">//         and</span>
03565   <span class="comment">//     (sfx not 0 and bit 6 in FPSR.sfx set [sfx != 0 and traps disabled in</span>
03566   <span class="comment">//      or bit 4 in FPSR set)                  sfx or U traps disabled]</span>
03567   <span class="comment">//</span>
03568 
03569   IsSWA = (ISRlow &amp; 0x01) &amp;&amp; (ISRlow &amp; 0x100 | ISRlow &amp; 0x1000) &amp;&amp; 
03570       ((<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)sf != 0 &amp;&amp; ((<a class="code" href="../../d9/d2/festate_8h.html#a0">FPSR</a> &gt;&gt; (6 + 6 + 13 * (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)sf)) &amp; 0x01) || 
03571       ((<a class="code" href="../../d9/d2/festate_8h.html#a0">FPSR</a> &gt;&gt; 4) &amp; 0x01));
03572 
03573   <span class="comment">// SWA trap for O if </span>
03574   <span class="comment">//     bit 0 in ISR.code is set             [fp trap] [redundant]</span>
03575   <span class="comment">//         and </span>
03576   <span class="comment">//     (bit 7 or bit 11 in ISR.code is set) [O normal, or SIMD low or high]</span>
03577   <span class="comment">//         and</span>
03578   <span class="comment">//     (sfx not 0 and bit 6 in FPSR.sfx set [traps disabled in sfx]</span>
03579   <span class="comment">//      or bit 3 in FPSR set)                  [O traps disabled]</span>
03580   <span class="comment">//</span>
03581 
03582   IsSWA = IsSWA || 
03583       ((ISRlow &amp; 0x01) &amp;&amp; (ISRlow &amp; 0x080 | ISRlow &amp; 0x0800) &amp;&amp; 
03584       ((<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)sf != 0 &amp;&amp; ((<a class="code" href="../../d9/d2/festate_8h.html#a0">FPSR</a> &gt;&gt; (6 + 6 + 13 * (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)sf)) &amp; 0x01) || 
03585       ((<a class="code" href="../../d9/d2/festate_8h.html#a0">FPSR</a> &gt;&gt; 3) &amp; 0x01)));
03586 
03587 <span class="preprocessor">#ifdef DEBUG_UNIX</span>
03588 <span class="preprocessor"></span>  <span class="keywordflow">if</span> (IsSWA &amp;&amp; ((ISRlow &amp; 0x1980) == 0))
03589     printf (<span class="stringliteral">"DEBUG swa_trap () WARNING: IsSWA and ((ISRlow &amp; 0x1980) == 0)\n"</span>);
03590 <span class="preprocessor">#endif</span>
03591 <span class="preprocessor"></span>
03592   <span class="comment">// U_en = ((EM_uint_t)sf == 0 || td == 0) &amp;&amp; FPSR_4 == 0</span>
03593   U_en = ((<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)sf == 0 || 
03594       !((<a class="code" href="../../d9/d2/festate_8h.html#a0">FPSR</a> &gt;&gt; (6 + 6 + 13 * (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)sf)) &amp; 0x01)) &amp;&amp;
03595       !((<a class="code" href="../../d9/d2/festate_8h.html#a0">FPSR</a> &gt;&gt; 4) &amp; 0x01);
03596   <span class="comment">// U exc if</span>
03597   <span class="comment">//     bit 0 in ISR.code is set             [fp trap] [redundant]</span>
03598   <span class="comment">//         and</span>
03599   <span class="comment">//     (bit 8 or bit 12 in ISR.code is set) [U normal, or SIMD low or high]</span>
03600   <span class="comment">//         and</span>
03601   <span class="comment">//     U traps are enabled</span>
03602   U_exc = (ISRlow &amp; 0x01) &amp;&amp; (ISRlow &amp; 0x100 | ISRlow &amp; 0x1000) &amp;&amp; U_en;
03603 
03604   <span class="comment">// O_en = ((EM_uint_t)sf == 0 || td == 0) &amp;&amp; FPSR_3 == 0</span>
03605   O_en = ((<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)sf == 0 || 
03606       !((<a class="code" href="../../d9/d2/festate_8h.html#a0">FPSR</a> &gt;&gt; (6 + 6 + 13 * (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)sf)) &amp; 0x01)) &amp;&amp; 
03607       !((<a class="code" href="../../d9/d2/festate_8h.html#a0">FPSR</a> &gt;&gt; 3) &amp; 0x01);
03608   <span class="comment">// O exc if</span>
03609   <span class="comment">//     bit 0 in ISR.code is set             [fp trap] [redundant]</span>
03610   <span class="comment">//         and</span>
03611   <span class="comment">//     (bit 7 or bit 11 in ISR.code is set) [O normal, or SIMD low or high]</span>
03612   <span class="comment">//         and</span>
03613   <span class="comment">//     O traps are enabled</span>
03614   O_exc = (ISRlow &amp; 0x01) &amp;&amp; (ISRlow &amp; 0x080 | ISRlow &amp; 0x0800) &amp;&amp; O_en;
03615 
03616   <span class="comment">// if no U exc and no O exc and no SWA trap due to U or O, then check I</span>
03617   <span class="keywordflow">if</span> (!U_exc &amp;&amp; !O_exc &amp;&amp; !IsSWA) {
03618 
03619     <span class="comment">// SWA trap for I if</span>
03620     <span class="comment">//     bit 0 in ISR.code is set             [fp trap] [redundant]</span>
03621     <span class="comment">//         and</span>
03622     <span class="comment">//     (bit 9 or bit 13 in ISR.code is set) [I normal, or SIMD low or high]</span>
03623     <span class="comment">//         and</span>
03624     <span class="comment">//     (sfx not 0 and bit 6 in FPSR.sfx set [sfx != 0 and traps disabled in</span>
03625     <span class="comment">//      or bit 5 in FPSR set)                  sfx or U traps disabled]</span>
03626     <span class="comment">//</span>
03627 
03628     IsSWA = (ISRlow &amp; 0x01) &amp;&amp; (ISRlow &amp; 0x200 | ISRlow &amp; 0x2000) &amp;&amp;
03629         ((<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)sf != 0 &amp;&amp; ((<a class="code" href="../../d9/d2/festate_8h.html#a0">FPSR</a> &gt;&gt; (6 + 6 + 13 * (<a class="code" href="../../d2/d3/fetypes_8h.html#a12">EM_uint_t</a>)sf)) &amp; 0x01)
03630         || ((<a class="code" href="../../d9/d2/festate_8h.html#a0">FPSR</a> &gt;&gt; 5) &amp; 0x01));
03631 
03632   }
03633 
03634   <span class="keywordflow">return</span> (IsSWA);
03635 
03636 }
03637 
03638 
03639 <a class="code" href="../../d0/d0/structfp__reg__struct.html">EM_fp_reg_type</a>
<a name="l03640"></a><a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a84">03640</a> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a84">FP128ToFPReg</a> (FLOAT128_TYPE f128)
03641 
03642 {
03643 
03644   <a class="code" href="../../d0/d0/structfp__reg__struct.html">EM_fp_reg_type</a> freg;
03645   <span class="keywordtype">char</span> *p;
03646   <a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a> *ui64;
03647 
03648 
03649   p = (<span class="keywordtype">char</span> *)(&amp;f128);
03650   ui64 = (<a class="code" href="../../d2/d3/fetypes_8h.html#a17">EM_uint64_t</a> *)(&amp;f128);
03651 
03652   freg.<a class="code" href="../../d0/d0/structfp__reg__struct.html#o2">sign</a> = (p[10] &gt;&gt; 1) &amp; 0x01;
03653   freg.<a class="code" href="../../d0/d0/structfp__reg__struct.html#o1">exponent</a> = ((<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)(p[10] &amp; 0x01) &lt;&lt; 16) |
03654       ((<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)(p[9] &amp; 0xff) &lt;&lt; 8) | ((<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)(p[8] &amp; 0xff));
03655   freg.<a class="code" href="../../d0/d0/structfp__reg__struct.html#o0">significand</a> = *ui64;
03656 
03657   <span class="keywordflow">return</span> (freg);
03658 
03659 }
03660 
03661 
03662 
03663 <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a81">FLOAT128_TYPE</a>
<a name="l03664"></a><a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a85">03664</a> <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a85">FPRegToFP128</a> (<a class="code" href="../../d0/d0/structfp__reg__struct.html">EM_fp_reg_type</a> freg)
03665 
03666 {
03667 
03668   <a class="code" href="../../d2/d4/ia64_2floatem_8c.html#a81">FLOAT128_TYPE</a> f128;
03669 
03670 
03671   f128.loFlt64 = freg.<a class="code" href="../../d0/d0/structfp__reg__struct.html#o0">significand</a>;
03672 
03673   f128.hiFlt64 = ((<span class="keywordtype">long</span>)(freg.<a class="code" href="../../d0/d0/structfp__reg__struct.html#o2">sign</a>) &lt;&lt; 17) | ((<span class="keywordtype">long</span>)freg.<a class="code" href="../../d0/d0/structfp__reg__struct.html#o1">exponent</a>);
03674 
03675   <span class="keywordflow">return</span> (f128);
03676 
03677 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:40:01 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
