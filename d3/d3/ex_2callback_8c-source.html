<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: callback.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>callback.c</h1><a href="../../d2/d4/ex_2callback_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989-1995  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    callback.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">   This module implements the executive callbaqck object. Functions are</span>
00012 <span class="comment">   provided to open, register, unregister , and notify callback objects.</span>
00013 <span class="comment"></span>
00014 <span class="comment">Author:</span>
00015 <span class="comment"></span>
00016 <span class="comment">    Ken Reneris  (kenr) 7-March-1995</span>
00017 <span class="comment"></span>
00018 <span class="comment">Environment:</span>
00019 <span class="comment"></span>
00020 <span class="comment">    Kernel mode only.</span>
00021 <span class="comment"></span>
00022 <span class="comment">Revision History:</span>
00023 <span class="comment"></span>
00024 <span class="comment">--*/</span>
00025 
00026 
00027 <span class="preprocessor">#include "<a class="code" href="../../d4/d0/exp_8h.html">exp.h</a>"</span>
00028 
00029 <span class="comment">//</span>
00030 <span class="comment">// Callback Specific Access Rights.</span>
00031 <span class="comment">//</span>
00032 
<a name="l00033"></a><a class="code" href="../../d2/d4/ex_2callback_8c.html#a0">00033</a> <span class="preprocessor">#define CALLBACK_MODIFY_STATE    0x0001</span>
00034 <span class="preprocessor"></span>
<a name="l00035"></a><a class="code" href="../../d2/d4/ex_2callback_8c.html#a1">00035</a> <span class="preprocessor">#define CALLBACK_ALL_ACCESS (STANDARD_RIGHTS_REQUIRED|SYNCHRONIZE|\</span>
00036 <span class="preprocessor">                             CALLBACK_MODIFY_STATE )</span>
00037 <span class="preprocessor"></span>
00038 
00039 <span class="comment">//</span>
00040 <span class="comment">// Address of callback object type descriptor.</span>
00041 <span class="comment">//</span>
00042 
<a name="l00043"></a><a class="code" href="../../d2/d4/ex_2callback_8c.html#a2">00043</a> <a class="code" href="../../d3/d6/struct__OBJECT__TYPE.html">POBJECT_TYPE</a> <a class="code" href="../../d2/d4/ex_2callback_8c.html#a2">ExCallbackObjectType</a>;
00044 
00045 <span class="comment">//</span>
00046 <span class="comment">// Event to wait for registration to become idle</span>
00047 <span class="comment">//</span>
00048 
<a name="l00049"></a><a class="code" href="../../d2/d4/ex_2callback_8c.html#a3">00049</a> <a class="code" href="../../d2/d6/struct__KEVENT.html">KEVENT</a> <a class="code" href="../../d2/d4/ex_2callback_8c.html#a3">ExpCallbackEvent</a>;
00050 
00051 <span class="comment">//</span>
00052 <span class="comment">// Structure that describes the mapping of generic access rights to object</span>
00053 <span class="comment">// specific access rights for callback objects.</span>
00054 <span class="comment">//</span>
00055 
<a name="l00056"></a><a class="code" href="../../d2/d4/ex_2callback_8c.html#a4">00056</a> GENERIC_MAPPING <a class="code" href="../../d2/d4/ex_2callback_8c.html#a4">ExpCallbackMapping</a> = {
00057     STANDARD_RIGHTS_READ ,
00058     STANDARD_RIGHTS_WRITE | <a class="code" href="../../d2/d4/ex_2callback_8c.html#a0">CALLBACK_MODIFY_STATE</a>,
00059     STANDARD_RIGHTS_EXECUTE | SYNCHRONIZE,
00060     <a class="code" href="../../d2/d4/ex_2callback_8c.html#a1">CALLBACK_ALL_ACCESS</a>
00061 };
00062 
00063 <span class="comment">//</span>
00064 <span class="comment">// Executive callback object structure definition.</span>
00065 <span class="comment">//</span>
00066 
<a name="l00067"></a><a class="code" href="../../d9/d6/struct__CALLBACK__OBJECT.html">00067</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d9/d6/struct__CALLBACK__OBJECT.html">_CALLBACK_OBJECT</a> {
<a name="l00068"></a><a class="code" href="../../d9/d6/struct__CALLBACK__OBJECT.html#o0">00068</a>     ULONG               <a class="code" href="../../d9/d6/struct__CALLBACK__OBJECT.html#o0">Signature</a>;
<a name="l00069"></a><a class="code" href="../../d9/d6/struct__CALLBACK__OBJECT.html#o1">00069</a>     KSPIN_LOCK          <a class="code" href="../../d9/d6/struct__CALLBACK__OBJECT.html#o1">Lock</a>;
<a name="l00070"></a><a class="code" href="../../d9/d6/struct__CALLBACK__OBJECT.html#o2">00070</a>     LIST_ENTRY          <a class="code" href="../../d9/d6/struct__CALLBACK__OBJECT.html#o2">RegisteredCallbacks</a>;
<a name="l00071"></a><a class="code" href="../../d9/d6/struct__CALLBACK__OBJECT.html#o3">00071</a>     BOOLEAN             <a class="code" href="../../d9/d6/struct__CALLBACK__OBJECT.html#o3">AllowMultipleCallbacks</a>;
<a name="l00072"></a><a class="code" href="../../d9/d6/struct__CALLBACK__OBJECT.html#o4">00072</a>     UCHAR               <a class="code" href="../../d9/d6/struct__CALLBACK__OBJECT.html#o4">reserved</a>[3];
00073 } <a class="code" href="../../d9/d6/struct__CALLBACK__OBJECT.html">CALLBACK_OBJECT</a> , *<a class="code" href="../../d9/d6/struct__CALLBACK__OBJECT.html">PCALLBACK_OBJECT</a>;
00074 
00075 <span class="comment">//</span>
00076 <span class="comment">// Executive callback registration structure definition.</span>
00077 <span class="comment">//</span>
00078 
<a name="l00079"></a><a class="code" href="../../d0/d7/struct__CALLBACK__REGISTRATION.html">00079</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="../../d0/d7/struct__CALLBACK__REGISTRATION.html">_CALLBACK_REGISTRATION</a> {
<a name="l00080"></a><a class="code" href="../../d0/d7/struct__CALLBACK__REGISTRATION.html#o0">00080</a>     LIST_ENTRY          <a class="code" href="../../d0/d7/struct__CALLBACK__REGISTRATION.html#o0">Link</a>;
<a name="l00081"></a><a class="code" href="../../d0/d7/struct__CALLBACK__REGISTRATION.html#o1">00081</a>     <a class="code" href="../../d2/d4/ex_2callback_8c.html#a6">PCALLBACK_OBJECT</a>    <a class="code" href="../../d0/d7/struct__CALLBACK__REGISTRATION.html#o1">CallbackObject</a>;
<a name="l00082"></a><a class="code" href="../../d0/d7/struct__CALLBACK__REGISTRATION.html#o2">00082</a>     <a class="code" href="../../d5/d8/ex_8h.html#a157">PCALLBACK_FUNCTION</a>  <a class="code" href="../../d0/d7/struct__CALLBACK__REGISTRATION.html#o2">CallbackFunction</a>;
<a name="l00083"></a><a class="code" href="../../d0/d7/struct__CALLBACK__REGISTRATION.html#o3">00083</a>     PVOID               <a class="code" href="../../d0/d7/struct__CALLBACK__REGISTRATION.html#o3">CallbackContext</a>;
<a name="l00084"></a><a class="code" href="../../d0/d7/struct__CALLBACK__REGISTRATION.html#o4">00084</a>     ULONG               <a class="code" href="../../d0/d7/struct__CALLBACK__REGISTRATION.html#o4">Busy</a>;
<a name="l00085"></a><a class="code" href="../../d0/d7/struct__CALLBACK__REGISTRATION.html#o5">00085</a>     BOOLEAN             <a class="code" href="../../d0/d7/struct__CALLBACK__REGISTRATION.html#o5">UnregisterWaiting</a>;
00086 } <a class="code" href="../../d0/d7/struct__CALLBACK__REGISTRATION.html">CALLBACK_REGISTRATION</a> , *<a class="code" href="../../d0/d7/struct__CALLBACK__REGISTRATION.html">PCALLBACK_REGISTRATION</a>;
00087 
00088 
00089 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00090 <a class="code" href="../../d2/d4/ex_2callback_8c.html#a9">ExpDeleteCallback</a> (
00091     IN PCALLBACK_OBJECT     CallbackObject
00092     );
00093 
00094 <span class="preprocessor">#ifdef ALLOC_PRAGMA</span>
00095 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(INIT, ExpInitializeCallbacks)</span>
00096 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, ExCreateCallback)</span>
00097 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE, ExpDeleteCallback)</span>
00098 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00099 <span class="preprocessor"></span>
00100 BOOLEAN
<a name="l00101"></a><a class="code" href="../../d2/d4/ex_2callback_8c.html#a10">00101</a> <a class="code" href="../../d2/d4/ex_2callback_8c.html#a10">ExpInitializeCallbacks</a> (
00102     )
00103 
00104 <span class="comment">/*++</span>
00105 <span class="comment"></span>
00106 <span class="comment">Routine Description:</span>
00107 <span class="comment"></span>
00108 <span class="comment">    This function creates the callback object type descriptor at system</span>
00109 <span class="comment">    initialization and stores the address of the object type descriptor</span>
00110 <span class="comment">    in local static storage.</span>
00111 <span class="comment"></span>
00112 <span class="comment">Arguments:</span>
00113 <span class="comment"></span>
00114 <span class="comment">    None.</span>
00115 <span class="comment"></span>
00116 <span class="comment">Return Value:</span>
00117 <span class="comment"></span>
00118 <span class="comment">    A value of TRUE is returned if the timer object type descriptor is</span>
00119 <span class="comment">    successfully initialized. Otherwise a value of FALSE is returned.</span>
00120 <span class="comment"></span>
00121 <span class="comment">--*/</span>
00122 
00123 {
00124     <a class="code" href="../../d5/d6/struct__OBJECT__TYPE__INITIALIZER.html">OBJECT_TYPE_INITIALIZER</a> ObjectTypeInitializer;
00125     OBJECT_ATTRIBUTES <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>;
00126     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00127     UNICODE_STRING unicodeString;
00128     ULONG           i;
00129     HANDLE          handle;
00130 
00131     <span class="comment">//</span>
00132     <span class="comment">// Initialize string descriptor.</span>
00133     <span class="comment">//</span>
00134 
00135     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;unicodeString, <a class="code" href="../../d2/d0/aw_8h.html#a3">L</a><span class="stringliteral">"Callback"</span>);
00136 
00137     <span class="comment">//</span>
00138     <span class="comment">// Create timer object type descriptor.</span>
00139     <span class="comment">//</span>
00140 
00141     RtlZeroMemory(&amp;ObjectTypeInitializer, <span class="keyword">sizeof</span>(ObjectTypeInitializer));
00142     ObjectTypeInitializer.Length = <span class="keyword">sizeof</span>(ObjectTypeInitializer);
00143     ObjectTypeInitializer.InvalidAttributes = OBJ_OPENLINK;
00144     ObjectTypeInitializer.GenericMapping = <a class="code" href="../../d2/d4/ex_2callback_8c.html#a4">ExpCallbackMapping</a>;
00145     ObjectTypeInitializer.DeleteProcedure = <a class="code" href="../../d2/d4/ex_2callback_8c.html#a9">ExpDeleteCallback</a>;
00146     ObjectTypeInitializer.PoolType = <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>;
00147     ObjectTypeInitializer.ValidAccessMask = <a class="code" href="../../d2/d4/ex_2callback_8c.html#a1">CALLBACK_ALL_ACCESS</a>;
00148     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d0/d2/obtype_8c.html#a2">ObCreateObjectType</a>(&amp;unicodeString,
00149                                 &amp;ObjectTypeInitializer,
00150                                 (PSECURITY_DESCRIPTOR)<a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00151                                 &amp;<a class="code" href="../../d2/d4/ex_2callback_8c.html#a2">ExCallbackObjectType</a>);
00152 
00153     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00154         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00155     }
00156 
00157     <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>( &amp;unicodeString, <a class="code" href="../../d4/d9/exdata_8c.html#a3">ExpWstrCallback</a> );
00158     InitializeObjectAttributes(
00159         &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00160         &amp;unicodeString,
00161         OBJ_CASE_INSENSITIVE | OBJ_PERMANENT,
00162         <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00163         <a class="code" href="../../d0/d5/se_8h.html#a67">SePublicDefaultSd</a>
00164         );
00165 
00166     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d8/d0/obdir_8c.html#a0">NtCreateDirectoryObject</a>(
00167                 &amp;handle,
00168                 DIRECTORY_ALL_ACCESS,
00169                 &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>
00170             );
00171 
00172     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00173         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00174     }
00175 
00176     <a class="code" href="../../d5/d0/obclose_8c.html#a1">NtClose</a> (handle);
00177 
00178     <span class="comment">//</span>
00179     <span class="comment">// Initialize event to wait on for Unregisters which occur while</span>
00180     <span class="comment">// notifications are in progress</span>
00181     <span class="comment">//</span>
00182 
00183     <a class="code" href="../../d4/d9/ke_8h.html#a20">KeInitializeEvent</a> (&amp;<a class="code" href="../../d2/d4/ex_2callback_8c.html#a3">ExpCallbackEvent</a>, NotificationEvent, 0);
00184 
00185     <span class="comment">//</span>
00186     <span class="comment">// Initialize NT global callbacks</span>
00187     <span class="comment">//</span>
00188 
00189     <span class="keywordflow">for</span> (i=0; <a class="code" href="../../d4/d9/exdata_8c.html#a4">ExpInitializeCallback</a>[i].<a class="code" href="../../d1/d9/structEXP__INITIALIZE__GLOBAL__CALLBACKS.html#o0">CallBackObject</a>; i++) {
00190 
00191         <span class="comment">//</span>
00192         <span class="comment">// Create named calledback</span>
00193         <span class="comment">//</span>
00194 
00195         <a class="code" href="../../d2/d7/string_8c.html#a7">RtlInitUnicodeString</a>(&amp;unicodeString, <a class="code" href="../../d4/d9/exdata_8c.html#a4">ExpInitializeCallback</a>[i].CallbackName);
00196 
00197 
00198         InitializeObjectAttributes(
00199             &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00200             &amp;unicodeString,
00201             OBJ_PERMANENT | OBJ_CASE_INSENSITIVE,
00202             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00203             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00204         );
00205 
00206         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d5/d8/ex_8h.html#a320">ExCreateCallback</a> (
00207                         <a class="code" href="../../d4/d9/exdata_8c.html#a4">ExpInitializeCallback</a>[i].CallBackObject,
00208                         &amp;<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00209                         <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>,
00210                         <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>
00211                         );
00212 
00213         <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00214             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00215         }
00216     }
00217 
00218     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00219 }
00220 
00221 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00222"></a><a class="code" href="../../d5/d8/ex_8h.html#a320">00222</a> <a class="code" href="../../d5/d8/ex_8h.html#a320">ExCreateCallback</a> (
00223     OUT PCALLBACK_OBJECT * CallbackObject,
00224     IN POBJECT_ATTRIBUTES ObjectAttributes,
00225     IN BOOLEAN Create,
00226     IN BOOLEAN AllowMultipleCallbacks
00227     )
00228 
00229 <span class="comment">/*++</span>
00230 <span class="comment"></span>
00231 <span class="comment">Routine Description:</span>
00232 <span class="comment"></span>
00233 <span class="comment">    This function opens a callback object with the specified callback</span>
00234 <span class="comment">    object. If the callback object does not exist or it is a NULL then</span>
00235 <span class="comment">    a callback object will be created if create is TRUE. If a callbackobject</span>
00236 <span class="comment">    is created it will only support mulitiple registered callbacks if</span>
00237 <span class="comment">    AllowMulitipleCallbacks is TRUE.</span>
00238 <span class="comment"></span>
00239 <span class="comment">Arguments:</span>
00240 <span class="comment"></span>
00241 <span class="comment">    CallbackObject - Supplies a pointer to a variable that will receive the</span>
00242 <span class="comment">        Callback object.</span>
00243 <span class="comment"></span>
00244 <span class="comment">    CallbackName  - Supplies a pointer to a object name that will receive the</span>
00245 <span class="comment"></span>
00246 <span class="comment">    Create - Supplies a flag which indicates whether a callback object will</span>
00247 <span class="comment">        be created or not .</span>
00248 <span class="comment"></span>
00249 <span class="comment">    AllowMultipleCallbacks - Supplies a flag which indicates only support</span>
00250 <span class="comment">        mulitiple registered callbacks.</span>
00251 <span class="comment"></span>
00252 <span class="comment">Return Value:</span>
00253 <span class="comment"></span>
00254 <span class="comment">    Returns STATUS_SUCESS unless fali...</span>
00255 <span class="comment"></span>
00256 <span class="comment">--*/</span>
00257 
00258 {
00259     <a class="code" href="../../d2/d4/ex_2callback_8c.html#a6">PCALLBACK_OBJECT</a> cbObject;
00260     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00261     HANDLE <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>;
00262 
00263     <a class="code" href="../../d0/d9/ntosdef_8h.html#a28">PAGED_CODE</a>();
00264 
00265     <span class="comment">//</span>
00266     <span class="comment">// If named callback, open handle to it</span>
00267     <span class="comment">//</span>
00268 
00269     <span class="keywordflow">if</span> (<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>-&gt;ObjectName) {
00270         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a2">ObOpenObjectByName</a>(<a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00271                                     <a class="code" href="../../d2/d4/ex_2callback_8c.html#a2">ExCallbackObjectType</a>,
00272                                     <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
00273                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00274                                     0,   <span class="comment">// DesiredAccess,</span>
00275                                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00276                                     &amp;<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>);
00277     } <span class="keywordflow">else</span> {
00278         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_UNSUCCESSFUL;
00279     }
00280 
00281     <span class="comment">//</span>
00282     <span class="comment">// If not opened, check if callback should be created</span>
00283     <span class="comment">//</span>
00284 
00285     <span class="keywordflow">if</span>(!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>) &amp;&amp; <a class="code" href="../../d4/d5/conimep_8h.html#a111">Create</a> ) {
00286         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d6/d0/obcreate_8c.html#a5">ObCreateObject</a>(<a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
00287                                 <a class="code" href="../../d2/d4/ex_2callback_8c.html#a2">ExCallbackObjectType</a>,
00288                                 <a class="code" href="../../d7/d0/ctlnpqos_8c.html#a4">ObjectAttributes</a>,
00289                                 <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
00290                                 <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00291                                 <span class="keyword">sizeof</span>(<a class="code" href="../../d9/d6/struct__CALLBACK__OBJECT.html">CALLBACK_OBJECT</a>),
00292                                 0,
00293                                 0,
00294                                 (PVOID *)&amp;cbObject );
00295 
00296         <span class="keywordflow">if</span>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)){
00297 
00298             <span class="comment">//</span>
00299             <span class="comment">// Fill in structure signature</span>
00300             <span class="comment">//</span>
00301 
00302             cbObject-&gt;Signature = 'llaC';
00303 
00304             <span class="comment">//</span>
00305             <span class="comment">// It will support multiple registered callbacks if</span>
00306             <span class="comment">// AllowMultipleCallbacks is TRUE.</span>
00307             <span class="comment">//</span>
00308 
00309             cbObject-&gt;AllowMultipleCallbacks = AllowMultipleCallbacks;
00310 
00311             <span class="comment">//</span>
00312             <span class="comment">// Initialize CallbackObject queue.</span>
00313             <span class="comment">//</span>
00314 
00315             InitializeListHead( &amp;cbObject-&gt;RegisteredCallbacks );
00316 
00317             <span class="comment">//</span>
00318             <span class="comment">// Initialize spinlock</span>
00319             <span class="comment">//</span>
00320 
00321             <a class="code" href="../../d4/d9/ke_8h.html#a354">KeInitializeSpinLock</a> (&amp;cbObject-&gt;Lock);
00322 
00323 
00324             <span class="comment">//</span>
00325             <span class="comment">// Put the object in the root directory</span>
00326             <span class="comment">//</span>
00327 
00328             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d1/d1/obinsert_8c.html#a0">ObInsertObject</a> (
00329                      cbObject,
00330                      <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00331                      FILE_READ_DATA,
00332                      0,
00333                      <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>,
00334                      &amp;<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a> );
00335 
00336         }
00337 
00338     }
00339 
00340     <span class="keywordflow">if</span>(<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)){
00341 
00342         <span class="comment">//</span>
00343         <span class="comment">// Add one to callback object reference count</span>
00344         <span class="comment">//</span>
00345 
00346         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d7/d1/obref_8c.html#a4">ObReferenceObjectByHandle</a> (
00347                     <a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>,
00348                     0,          <span class="comment">// DesiredAccess</span>
00349                     <a class="code" href="../../d2/d4/ex_2callback_8c.html#a2">ExCallbackObjectType</a>,
00350                     <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
00351                     &amp;cbObject,
00352                     <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00353                     );
00354 
00355         ZwClose (<a class="code" href="../../d7/d0/cmdat2_8c.html#a19">Handle</a>);
00356     }
00357 
00358     <span class="comment">//</span>
00359     <span class="comment">// If SUCEESS , returns a referenced pointer to the CallbackObject.</span>
00360     <span class="comment">//</span>
00361 
00362     <span class="keywordflow">if</span> (<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>(<a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>)) {
00363         *CallbackObject = cbObject;
00364     }
00365 
00366     <span class="keywordflow">return</span> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00367 }
00368 
00369 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00370"></a><a class="code" href="../../d2/d4/ex_2callback_8c.html#a9">00370</a> <a class="code" href="../../d2/d4/ex_2callback_8c.html#a9">ExpDeleteCallback</a> (
00371     IN PCALLBACK_OBJECT     CallbackObject
00372     )
00373 {
00374     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (IsListEmpty(&amp;CallbackObject-&gt;RegisteredCallbacks));
00375 }
00376 
00377 PVOID
<a name="l00378"></a><a class="code" href="../../d5/d8/ex_8h.html#a321">00378</a> <a class="code" href="../../d5/d8/ex_8h.html#a321">ExRegisterCallback</a> (
00379     IN PCALLBACK_OBJECT   CallbackObject,
00380     IN <a class="code" href="../../d5/d8/ex_8h.html#a157">PCALLBACK_FUNCTION</a> CallbackFunction,
00381     IN PVOID CallbackContext
00382     )
00383 
00384 <span class="comment">/*++</span>
00385 <span class="comment"></span>
00386 <span class="comment">Routine Description:</span>
00387 <span class="comment"></span>
00388 <span class="comment">    This routine allows a caller to register that it would like to have its</span>
00389 <span class="comment">    callback Function invoked when the callback notification call occurs.</span>
00390 <span class="comment"></span>
00391 <span class="comment">Arguments:</span>
00392 <span class="comment"></span>
00393 <span class="comment">    CallbackObject - Supplies a pointer to a CallbackObject.</span>
00394 <span class="comment"></span>
00395 <span class="comment">    CallbackFunction - Supplies a pointer to a function which is to</span>
00396 <span class="comment">        be executed when the Callback notification occures.</span>
00397 <span class="comment"></span>
00398 <span class="comment">    CallbackContext - Supplies a pointer to an arbitrary data structure</span>
00399 <span class="comment">        that will be passed to the function specified by the CallbackFunction</span>
00400 <span class="comment">        parameter.</span>
00401 <span class="comment"></span>
00402 <span class="comment">Return Value:</span>
00403 <span class="comment"></span>
00404 <span class="comment">    Returns handle to callback registration.</span>
00405 <span class="comment"></span>
00406 <span class="comment">--*/</span>
00407 {
00408     <a class="code" href="../../d2/d4/ex_2callback_8c.html#a8">PCALLBACK_REGISTRATION</a>  CallbackRegistration;
00409     BOOLEAN                 Inserted;
00410     KIRQL                   OldIrql;
00411     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>                <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00412 
00413     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (CallbackFunction);
00414     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (KeGetCurrentIrql() &lt; <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>);
00415 
00416     <span class="comment">//</span>
00417     <span class="comment">// Add reference to object</span>
00418     <span class="comment">//</span>
00419 
00420     <a class="code" href="../../d4/d0/ob_8h.html#a15">ObReferenceObject</a> (CallbackObject);
00421 
00422     <span class="comment">//</span>
00423     <span class="comment">// Begin by attempting to allocate storage for the CallbackRegistration.</span>
00424     <span class="comment">// one cannot be allocated, return the error status.</span>
00425     <span class="comment">//</span>
00426 
00427     CallbackRegistration = <a class="code" href="../../d5/d8/ex_8h.html#a4">ExAllocatePoolWithTag</a>(
00428                                 <a class="code" href="../../d5/d8/ex_8h.html#a329a173">NonPagedPool</a>,
00429                                 <span class="keyword">sizeof</span>( <a class="code" href="../../d0/d7/struct__CALLBACK__REGISTRATION.html">CALLBACK_REGISTRATION</a> ),
00430                                 'eRBC'
00431                                 );
00432 
00433 
00434     <span class="keywordflow">if</span>( !CallbackRegistration ) {
00435        <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a> (CallbackObject);
00436        <span class="keywordflow">return</span> <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00437     }
00438 
00439 
00440     <span class="comment">//</span>
00441     <span class="comment">// Initialize the callback packet</span>
00442     <span class="comment">//</span>
00443 
00444     CallbackRegistration-&gt;<a class="code" href="../../d0/d7/struct__CALLBACK__REGISTRATION.html#o1">CallbackObject</a>    = CallbackObject;
00445     CallbackRegistration-&gt;<a class="code" href="../../d0/d7/struct__CALLBACK__REGISTRATION.html#o2">CallbackFunction</a>  = CallbackFunction;
00446     CallbackRegistration-&gt;<a class="code" href="../../d0/d7/struct__CALLBACK__REGISTRATION.html#o3">CallbackContext</a>   = CallbackContext;
00447     CallbackRegistration-&gt;<a class="code" href="../../d0/d7/struct__CALLBACK__REGISTRATION.html#o4">Busy</a>              = 0;
00448     CallbackRegistration-&gt;<a class="code" href="../../d0/d7/struct__CALLBACK__REGISTRATION.html#o5">UnregisterWaiting</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00449 
00450 
00451     Inserted = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00452     <a class="code" href="../../d4/d9/ke_8h.html#a37">KeAcquireSpinLock</a> (&amp;CallbackObject-&gt;Lock, &amp;OldIrql);
00453 
00454     <span class="keywordflow">if</span>( CallbackObject-&gt;AllowMultipleCallbacks ||
00455         IsListEmpty( &amp;CallbackObject-&gt;RegisteredCallbacks ) ) {
00456 
00457        <span class="comment">//</span>
00458        <span class="comment">// add CallbackRegistration to tail</span>
00459        <span class="comment">//</span>
00460 
00461 
00462        Inserted = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00463        InsertTailList( &amp;CallbackObject-&gt;RegisteredCallbacks,
00464                        &amp;CallbackRegistration-&gt;<a class="code" href="../../d0/d7/struct__CALLBACK__REGISTRATION.html#o0">Link</a> )
00465     }
00466 
00467     <a class="code" href="../../d9/d5/verifier_8c.html#a119">KeReleaseSpinLock</a> (&amp;CallbackObject-&gt;Lock, OldIrql);
00468 
00469     <span class="keywordflow">if</span> (!Inserted) {
00470        <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (CallbackRegistration);
00471        CallbackRegistration = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
00472     }
00473 
00474     <span class="keywordflow">return</span> (PVOID) CallbackRegistration;
00475 }
00476 
00477 
00478 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00479"></a><a class="code" href="../../d5/d8/ex_8h.html#a322">00479</a> <a class="code" href="../../d5/d8/ex_8h.html#a322">ExUnregisterCallback</a> (
00480     IN PVOID CbRegistration
00481     )
00482 
00483 <span class="comment">/*++</span>
00484 <span class="comment"></span>
00485 <span class="comment">Routine Description:</span>
00486 <span class="comment"></span>
00487 <span class="comment">    This function removes the callback registration for the callbacks</span>
00488 <span class="comment">    from the list of callback object .</span>
00489 <span class="comment"></span>
00490 <span class="comment">Arguments:</span>
00491 <span class="comment"></span>
00492 <span class="comment">    CallbackRegistration - Pointer to device object for the file system.</span>
00493 <span class="comment"></span>
00494 <span class="comment">Return Value:</span>
00495 <span class="comment"></span>
00496 <span class="comment">    None.</span>
00497 <span class="comment"></span>
00498 <span class="comment">--*/</span>
00499 
00500 {
00501     <a class="code" href="../../d2/d4/ex_2callback_8c.html#a8">PCALLBACK_REGISTRATION</a>  CallbackRegistration;
00502     <a class="code" href="../../d2/d4/ex_2callback_8c.html#a6">PCALLBACK_OBJECT</a>        CallbackObject;
00503     KIRQL                   OldIrql;
00504 
00505     <a class="code" href="../../d6/d5/ntgdi_2icm_2inc_2debug_8h.html#a7">ASSERT</a> (KeGetCurrentIrql() &lt; <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>);
00506 
00507     CallbackRegistration = (<a class="code" href="../../d2/d4/ex_2callback_8c.html#a8">PCALLBACK_REGISTRATION</a>) CbRegistration;
00508     CallbackObject = CallbackRegistration-&gt;<a class="code" href="../../d0/d7/struct__CALLBACK__REGISTRATION.html#o1">CallbackObject</a>;
00509 
00510     <a class="code" href="../../d4/d9/ke_8h.html#a37">KeAcquireSpinLock</a> (&amp;CallbackObject-&gt;<a class="code" href="../../d9/d6/struct__CALLBACK__OBJECT.html#o1">Lock</a>, &amp;OldIrql);
00511 
00512     <span class="comment">//</span>
00513     <span class="comment">// Wait for registration</span>
00514     <span class="comment">//</span>
00515 
00516     <span class="keywordflow">while</span> (CallbackRegistration-&gt;<a class="code" href="../../d0/d7/struct__CALLBACK__REGISTRATION.html#o4">Busy</a>) {
00517 
00518         <span class="comment">//</span>
00519         <span class="comment">// Set waiting flag, then wait.  (not performance critical - use</span>
00520         <span class="comment">// single global event to wait for any and all unregister waits)</span>
00521         <span class="comment">//</span>
00522 
00523         CallbackRegistration-&gt;<a class="code" href="../../d0/d7/struct__CALLBACK__REGISTRATION.html#o5">UnregisterWaiting</a> = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
00524         <a class="code" href="../../d4/d9/ke_8h.html#a21">KeClearEvent</a> (&amp;<a class="code" href="../../d2/d4/ex_2callback_8c.html#a3">ExpCallbackEvent</a>);
00525         <a class="code" href="../../d9/d5/verifier_8c.html#a119">KeReleaseSpinLock</a> (&amp;CallbackObject-&gt;<a class="code" href="../../d9/d6/struct__CALLBACK__OBJECT.html#o1">Lock</a>, OldIrql);
00526 
00527         <a class="code" href="../../d1/d7/wait_8c.html#a4">KeWaitForSingleObject</a> (
00528             &amp;<a class="code" href="../../d2/d4/ex_2callback_8c.html#a3">ExpCallbackEvent</a>,
00529             <a class="code" href="../../d6/d7/halmips_8h.html#a455">Executive</a>,
00530             <a class="code" href="../../d6/d7/halmips_8h.html#a456">KernelMode</a>,
00531             <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>,
00532             <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>
00533         );
00534 
00535         <span class="comment">//</span>
00536         <span class="comment">// Synchronize with callback object and recheck registration busy</span>
00537         <span class="comment">//</span>
00538 
00539         <a class="code" href="../../d4/d9/ke_8h.html#a37">KeAcquireSpinLock</a> (&amp;CallbackObject-&gt;<a class="code" href="../../d9/d6/struct__CALLBACK__OBJECT.html#o1">Lock</a>, &amp;OldIrql);
00540     }
00541 
00542     <span class="comment">//</span>
00543     <span class="comment">// Registration not busy, remove it from the callback object</span>
00544     <span class="comment">//</span>
00545 
00546     RemoveEntryList (&amp;CallbackRegistration-&gt;<a class="code" href="../../d0/d7/struct__CALLBACK__REGISTRATION.html#o0">Link</a>);
00547     <a class="code" href="../../d9/d5/verifier_8c.html#a119">KeReleaseSpinLock</a> (&amp;CallbackObject-&gt;<a class="code" href="../../d9/d6/struct__CALLBACK__OBJECT.html#o1">Lock</a>, OldIrql);
00548 
00549     <span class="comment">//</span>
00550     <span class="comment">// Free memory used for CallbackRegistration</span>
00551     <span class="comment">//</span>
00552 
00553     <a class="code" href="../../d5/d8/ex_8h.html#a224">ExFreePool</a> (CallbackRegistration);
00554 
00555     <span class="comment">//</span>
00556     <span class="comment">// Remove reference count on CallbackObject</span>
00557     <span class="comment">//</span>
00558 
00559     <a class="code" href="../../d4/d0/ob_8h.html#a14">ObDereferenceObject</a> (CallbackObject);
00560 }
00561 
00562 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l00563"></a><a class="code" href="../../d2/d4/ex_2callback_8c.html#a14">00563</a> <a class="code" href="../../d5/d8/ex_8h.html#a323">ExNotifyCallback</a> (
00564     IN PCALLBACK_OBJECT     CallbackObject,
00565     IN PVOID                Argument1,
00566     IN PVOID                Argument2
00567     )
00568 
00569 <span class="comment">/*++</span>
00570 <span class="comment"></span>
00571 <span class="comment">Routine Description:</span>
00572 <span class="comment"></span>
00573 <span class="comment">    This function notifies all registered callbacks .</span>
00574 <span class="comment"></span>
00575 <span class="comment">Arguments:</span>
00576 <span class="comment"></span>
00577 <span class="comment">    CallbackObject - supplies a pointer to the callback object should be</span>
00578 <span class="comment">            notified.</span>
00579 <span class="comment"></span>
00580 <span class="comment">    SystemArgument1 - supplies a pointer will be passed to callback function.</span>
00581 <span class="comment"></span>
00582 <span class="comment">    SystemArgument2 - supplies a pointer will be passed to callback function.</span>
00583 <span class="comment"></span>
00584 <span class="comment">Return Value:</span>
00585 <span class="comment"></span>
00586 <span class="comment">    None.</span>
00587 <span class="comment"></span>
00588 <span class="comment">--*/</span>
00589 
00590 {
00591     PLIST_ENTRY             Link;
00592     <a class="code" href="../../d2/d4/ex_2callback_8c.html#a8">PCALLBACK_REGISTRATION</a>  CallbackRegistration;
00593     KIRQL                   OldIrql;
00594 
00595     <span class="keywordflow">if</span> (CallbackObject == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00596         <span class="keywordflow">return</span> ;
00597     }
00598 
00599     <span class="comment">//</span>
00600     <span class="comment">// Synchronize with callback object</span>
00601     <span class="comment">//</span>
00602 
00603     <a class="code" href="../../d4/d9/ke_8h.html#a37">KeAcquireSpinLock</a> (&amp;CallbackObject-&gt;Lock, &amp;OldIrql);
00604 
00605     <span class="comment">//</span>
00606     <span class="comment">// call registered callbacks at callers IRQL level</span>
00607     <span class="comment">// ( done if FIFO order of registration )</span>
00608     <span class="comment">//</span>
00609 
00610     <span class="keywordflow">if</span> (OldIrql == <a class="code" href="../../d6/d7/halmips_8h.html#a53">DISPATCH_LEVEL</a>) {
00611 
00612         <span class="comment">//</span>
00613         <span class="comment">// OldIrql is DISPATCH_LEVEL, just invoke all callbacks without</span>
00614         <span class="comment">// releasing the lock</span>
00615         <span class="comment">//</span>
00616 
00617         <span class="keywordflow">for</span> (Link = CallbackObject-&gt;RegisteredCallbacks.Flink;
00618              Link != &amp;CallbackObject-&gt;RegisteredCallbacks;
00619              Link = Link-&gt;Flink) {
00620 
00621             <span class="comment">//</span>
00622             <span class="comment">// Get current registration to notify</span>
00623             <span class="comment">//</span>
00624 
00625             CallbackRegistration = CONTAINING_RECORD (Link,
00626                                                       <a class="code" href="../../d0/d7/struct__CALLBACK__REGISTRATION.html">CALLBACK_REGISTRATION</a>,
00627                                                       Link);
00628 
00629             <span class="comment">//</span>
00630             <span class="comment">// Notify reigstration</span>
00631             <span class="comment">//</span>
00632 
00633             CallbackRegistration-&gt;<a class="code" href="../../d0/d7/struct__CALLBACK__REGISTRATION.html#o2">CallbackFunction</a>(
00634                        CallbackRegistration-&gt;<a class="code" href="../../d0/d7/struct__CALLBACK__REGISTRATION.html#o3">CallbackContext</a>,
00635                        Argument1,
00636                        Argument2
00637                        );
00638 
00639         }   <span class="comment">// next registration</span>
00640 
00641     } <span class="keywordflow">else</span> {
00642 
00643         <span class="comment">//</span>
00644         <span class="comment">// OldIrql is &lt; DISPATCH_LEVEL, the code being called may be pagable</span>
00645         <span class="comment">// and the callback object spinlock needs to be released around</span>
00646         <span class="comment">// each registration callback.</span>
00647         <span class="comment">//</span>
00648 
00649         <span class="keywordflow">for</span> (Link = CallbackObject-&gt;RegisteredCallbacks.Flink;
00650              Link != &amp;CallbackObject-&gt;RegisteredCallbacks;
00651              Link = Link-&gt;Flink ) {
00652 
00653             <span class="comment">//</span>
00654             <span class="comment">// Get current registration to notify</span>
00655             <span class="comment">//</span>
00656 
00657             CallbackRegistration = CONTAINING_RECORD (Link,
00658                                                       <a class="code" href="../../d0/d7/struct__CALLBACK__REGISTRATION.html">CALLBACK_REGISTRATION</a>,
00659                                                       Link);
00660 
00661             <span class="comment">//</span>
00662             <span class="comment">// If registration is being removed, don't bothing calling it</span>
00663             <span class="comment">//</span>
00664 
00665             <span class="keywordflow">if</span> (!CallbackRegistration-&gt;<a class="code" href="../../d0/d7/struct__CALLBACK__REGISTRATION.html#o5">UnregisterWaiting</a>) {
00666 
00667                 <span class="comment">//</span>
00668                 <span class="comment">// Set registration busy</span>
00669                 <span class="comment">//</span>
00670 
00671                 CallbackRegistration-&gt;<a class="code" href="../../d0/d7/struct__CALLBACK__REGISTRATION.html#o4">Busy</a> += 1;
00672 
00673                 <span class="comment">//</span>
00674                 <span class="comment">// Release SpinLock and notify this callback</span>
00675                 <span class="comment">//</span>
00676 
00677                 <a class="code" href="../../d9/d5/verifier_8c.html#a119">KeReleaseSpinLock</a> (&amp;CallbackObject-&gt;Lock, OldIrql);
00678 
00679                 CallbackRegistration-&gt;<a class="code" href="../../d0/d7/struct__CALLBACK__REGISTRATION.html#o2">CallbackFunction</a>(
00680                            CallbackRegistration-&gt;<a class="code" href="../../d0/d7/struct__CALLBACK__REGISTRATION.html#o3">CallbackContext</a>,
00681                            Argument1,
00682                            Argument2
00683                            );
00684 
00685                 <span class="comment">//</span>
00686                 <span class="comment">// Synchronize with CallbackObject</span>
00687                 <span class="comment">//</span>
00688 
00689                 <a class="code" href="../../d4/d9/ke_8h.html#a37">KeAcquireSpinLock</a> (&amp;CallbackObject-&gt;Lock, &amp;OldIrql);
00690 
00691                 <span class="comment">//</span>
00692                 <span class="comment">// Remove our busy count</span>
00693                 <span class="comment">//</span>
00694 
00695                 CallbackRegistration-&gt;<a class="code" href="../../d0/d7/struct__CALLBACK__REGISTRATION.html#o4">Busy</a> -= 1;
00696 
00697                 <span class="comment">//</span>
00698                 <span class="comment">// If the registriation removal is pending, kick global</span>
00699                 <span class="comment">// event let unregister conitnue</span>
00700                 <span class="comment">//</span>
00701 
00702                 <span class="keywordflow">if</span> (CallbackRegistration-&gt;<a class="code" href="../../d0/d7/struct__CALLBACK__REGISTRATION.html#o5">UnregisterWaiting</a>  &amp;&amp;
00703                     CallbackRegistration-&gt;<a class="code" href="../../d0/d7/struct__CALLBACK__REGISTRATION.html#o4">Busy</a> == 0) {
00704                     <a class="code" href="../../d2/d8/eventobj_8c.html#a8">KeSetEvent</a> (&amp;<a class="code" href="../../d2/d4/ex_2callback_8c.html#a3">ExpCallbackEvent</a>, 0, <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00705                 }
00706             }
00707         }
00708     }
00709 
00710 
00711     <span class="comment">//</span>
00712     <span class="comment">// Release callback</span>
00713     <span class="comment">//</span>
00714 
00715     <a class="code" href="../../d9/d5/verifier_8c.html#a119">KeReleaseSpinLock</a> (&amp;CallbackObject-&gt;Lock, OldIrql);
00716 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:20 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
