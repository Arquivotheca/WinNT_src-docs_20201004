<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>test: acledit.c Source File</title>
<link href="../../doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.7 -->
<div class="qindex"><a class="qindex" href="../../main.html">Main&nbsp;Page</a> | <a class="qindex" href="../../hierarchy.html">Class&nbsp;Hierarchy</a> | <a class="qindex" href="../../annotated.html">Class&nbsp;List</a> | <a class="qindex" href="../../files.html">File&nbsp;List</a> | <a class="qindex" href="../../functions.html">Class&nbsp;Members</a> | <a class="qindex" href="../../globals.html">File&nbsp;Members</a></div>
<h1>acledit.c</h1><a href="../../d2/d4/acledit_8c.html">Go to the documentation of this file.</a><pre class="fragment"><div>00001 <span class="comment">/*++</span>
00002 <span class="comment"></span>
00003 <span class="comment">Copyright (c) 1989  Microsoft Corporation</span>
00004 <span class="comment"></span>
00005 <span class="comment">Module Name:</span>
00006 <span class="comment"></span>
00007 <span class="comment">    Acledit.c</span>
00008 <span class="comment"></span>
00009 <span class="comment">Abstract:</span>
00010 <span class="comment"></span>
00011 <span class="comment">    This Module implements the Acl rtl editing functions that are defined in</span>
00012 <span class="comment">    ntseapi.h</span>
00013 <span class="comment"></span>
00014 <span class="comment">Author:</span>
00015 <span class="comment"></span>
00016 <span class="comment">    Gary Kimura     (GaryKi)    9-Nov-1989</span>
00017 <span class="comment"></span>
00018 <span class="comment">Environment:</span>
00019 <span class="comment"></span>
00020 <span class="comment">    Pure Runtime Library Routine</span>
00021 <span class="comment"></span>
00022 <span class="comment">Revision History:</span>
00023 <span class="comment"></span>
00024 <span class="comment">--*/</span>
00025 
00026 <span class="preprocessor">#include &lt;<a class="code" href="../../d5/d9/ntrtlp_8h.html">ntrtlp.h</a>&gt;</span>
00027 <span class="preprocessor">#include &lt;seopaque.h&gt;</span>
00028 
00029 <span class="comment">//</span>
00030 <span class="comment">//  Define the local macros and procedure for this module</span>
00031 <span class="comment">//</span>
00032 
00033 <span class="comment">//</span>
00034 <span class="comment">//  Return a pointer to the first Ace in an Acl (even if the Acl is empty).</span>
00035 <span class="comment">//</span>
00036 <span class="comment">//      PACE_HEADER</span>
00037 <span class="comment">//      FirstAce (</span>
00038 <span class="comment">//          IN PACL Acl</span>
00039 <span class="comment">//          );</span>
00040 <span class="comment">//</span>
00041 
<a name="l00042"></a><a class="code" href="../../d2/d4/acledit_8c.html#a0">00042</a> <span class="preprocessor">#define FirstAce(Acl) ((PVOID)((PUCHAR)(Acl) + sizeof(ACL)))</span>
00043 <span class="preprocessor"></span>
00044 <span class="comment">//</span>
00045 <span class="comment">//  Return a pointer to the next Ace in a sequence (even if the input</span>
00046 <span class="comment">//  Ace is the one in the sequence).</span>
00047 <span class="comment">//</span>
00048 <span class="comment">//      PACE_HEADER</span>
00049 <span class="comment">//      NextAce (</span>
00050 <span class="comment">//          IN PACE_HEADER Ace</span>
00051 <span class="comment">//          );</span>
00052 <span class="comment">//</span>
00053 
<a name="l00054"></a><a class="code" href="../../d2/d4/acledit_8c.html#a1">00054</a> <span class="preprocessor">#define NextAce(Ace) ((PVOID)((PUCHAR)(Ace) + ((PACE_HEADER)(Ace))-&gt;AceSize))</span>
00055 <span class="preprocessor"></span>
<a name="l00056"></a><a class="code" href="../../d2/d4/acledit_8c.html#a2">00056</a> <span class="preprocessor">#define LongAligned( ptr )  (LongAlign(ptr) == ((PVOID)(ptr)))</span>
<a name="l00057"></a><a class="code" href="../../d2/d4/acledit_8c.html#a3">00057</a> <span class="preprocessor"></span><span class="preprocessor">#define WordAligned( ptr )  (WordAlign(ptr) == ((PVOID)(ptr)))</span>
00058 <span class="preprocessor"></span>
00059 
00060     <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00061 <a class="code" href="../../d2/d4/acledit_8c.html#a4">RtlpAddData</a> (
00062     IN PVOID From,
00063     IN ULONG FromSize,
00064     IN PVOID To,
00065     IN ULONG ToSize
00066     );
00067 
00068 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
00069 <a class="code" href="../../d2/d4/acledit_8c.html#a5">RtlpDeleteData</a> (
00070     IN PVOID Data,
00071     IN ULONG RemoveSize,
00072     IN ULONG TotalSize
00073     );
00074 
00075 <span class="preprocessor">#if defined(ALLOC_PRAGMA) &amp;&amp; defined(NTOS_KERNEL_RUNTIME)</span>
00076 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,RtlpAddData)</span>
00077 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,RtlpDeleteData)</span>
00078 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,RtlCreateAcl)</span>
00079 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,RtlValidAcl)</span>
00080 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,RtlQueryInformationAcl)</span>
00081 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,RtlSetInformationAcl)</span>
00082 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,RtlAddAce)</span>
00083 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,RtlDeleteAce)</span>
00084 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,RtlGetAce)</span>
00085 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,RtlAddAccessAllowedAce)</span>
00086 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,RtlAddAccessAllowedAceEx)</span>
00087 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,RtlAddAccessAllowedObjectAce)</span>
00088 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,RtlAddAccessDeniedAce)</span>
00089 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,RtlAddAccessDeniedAceEx)</span>
00090 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,RtlAddAccessDeniedObjectAce)</span>
00091 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,RtlAddAuditAccessAce)</span>
00092 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,RtlAddAuditAccessAceEx)</span>
00093 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,RtlAddAuditAccessObjectAce)</span>
00094 <span class="preprocessor"></span><span class="preprocessor">#pragma alloc_text(PAGE,RtlFirstFreeAce)</span>
00095 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00096 <span class="preprocessor"></span>
00097 
00098 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00099"></a><a class="code" href="../../d2/d4/acledit_8c.html#a6">00099</a> <a class="code" href="../../d2/d4/acledit_8c.html#a6">RtlCreateAcl</a> (
00100     IN PACL Acl,
00101     IN ULONG AclLength,
00102     IN ULONG AclRevision
00103     )
00104 
00105 <span class="comment">/*++</span>
00106 <span class="comment"></span>
00107 <span class="comment">Routine Description:</span>
00108 <span class="comment"></span>
00109 <span class="comment">    This routine initializes an ACL data structure.  After initialization</span>
00110 <span class="comment">    it is an ACL with no ACE (i.e., a deny all access type ACL)</span>
00111 <span class="comment"></span>
00112 <span class="comment">Arguments:</span>
00113 <span class="comment"></span>
00114 <span class="comment">    Acl - Supplies the buffer containing the ACL being initialized</span>
00115 <span class="comment"></span>
00116 <span class="comment">    AclLength - Supplies the length of the ace buffer in bytes</span>
00117 <span class="comment"></span>
00118 <span class="comment">    AclRevision - Supplies the revision for this Acl</span>
00119 <span class="comment"></span>
00120 <span class="comment">Return Value:</span>
00121 <span class="comment"></span>
00122 <span class="comment">    NTSTATUS - STATUS_SUCCESS if successful</span>
00123 <span class="comment"></span>
00124 <span class="comment">               STATUS_BUFFER_TOO_SMALL if the AclLength is too small,</span>
00125 <span class="comment"></span>
00126 <span class="comment">               STATUS_INVALID_PARAMETER if the revision is out of range</span>
00127 <span class="comment"></span>
00128 <span class="comment">--*/</span>
00129 
00130 {
00131     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
00132 
00133     <span class="comment">//</span>
00134     <span class="comment">//  Check to see the size of the buffer is large enough to hold at</span>
00135     <span class="comment">//  least the ACL header</span>
00136     <span class="comment">//</span>
00137 
00138     <span class="keywordflow">if</span> (AclLength &lt; <span class="keyword">sizeof</span>(ACL)) {
00139 
00140         <span class="comment">//</span>
00141         <span class="comment">//  Buffer to small even for the ACL header</span>
00142         <span class="comment">//</span>
00143 
00144         <span class="keywordflow">return</span> STATUS_BUFFER_TOO_SMALL;
00145 
00146     }
00147 
00148     <span class="comment">//</span>
00149     <span class="comment">//  Check to see if the revision is currently valid.  Later versions</span>
00150     <span class="comment">//  of this procedure might accept more revision levels</span>
00151     <span class="comment">//</span>
00152 
00153     <span class="keywordflow">if</span> (AclRevision &lt; MIN_ACL_REVISION || AclRevision &gt; MAX_ACL_REVISION) {
00154 
00155         <span class="comment">//</span>
00156         <span class="comment">//  Revision not current</span>
00157         <span class="comment">//</span>
00158 
00159         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00160 
00161     }
00162 
00163     <span class="keywordflow">if</span> ( AclLength &gt; MAXUSHORT ) {
00164 
00165         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00166     }
00167 
00168     <span class="comment">//</span>
00169     <span class="comment">//  Initialize the ACL</span>
00170     <span class="comment">//</span>
00171 
00172     Acl-&gt;AclRevision = (UCHAR)AclRevision;  <span class="comment">// Used to hardwire ACL_REVISION2 here</span>
00173     Acl-&gt;Sbz1 = 0;
00174     Acl-&gt;AclSize = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>) (AclLength &amp; 0xfffc);
00175     Acl-&gt;AceCount = 0;
00176     Acl-&gt;Sbz2 = 0;
00177 
00178     <span class="comment">//</span>
00179     <span class="comment">//  And return to our caller</span>
00180     <span class="comment">//</span>
00181 
00182     <span class="keywordflow">return</span> STATUS_SUCCESS;
00183 }
00184 
00185 
00186 BOOLEAN
<a name="l00187"></a><a class="code" href="../../d2/d4/acledit_8c.html#a7">00187</a> <a class="code" href="../../d2/d4/acledit_8c.html#a7">RtlValidAcl</a> (
00188     IN PACL Acl
00189     )
00190 
00191 <span class="comment">/*++</span>
00192 <span class="comment"></span>
00193 <span class="comment">Routine Description:</span>
00194 <span class="comment"></span>
00195 <span class="comment">    This procedure validates an ACL.</span>
00196 <span class="comment"></span>
00197 <span class="comment">    This involves validating the revision level of the ACL and ensuring</span>
00198 <span class="comment">    that the number of ACEs specified in the AceCount fit in the space</span>
00199 <span class="comment">    specified by the AclSize field of the ACL header.</span>
00200 <span class="comment"></span>
00201 <span class="comment">Arguments:</span>
00202 <span class="comment"></span>
00203 <span class="comment">    Acl - Pointer to the ACL structure to validate.</span>
00204 <span class="comment"></span>
00205 <span class="comment">Return Value:</span>
00206 <span class="comment"></span>
00207 <span class="comment">    BOOLEAN - TRUE if the structure of Acl is valid.</span>
00208 <span class="comment"></span>
00209 <span class="comment">--*/</span>
00210 
00211 {
00212     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
00213 
00214     <span class="keywordflow">try</span> {
00215         PACE_HEADER Ace;
00216         PISID Sid;
00217         PISID Sid2;
00218         ULONG i;
00219         UCHAR AclRevision = ACL_REVISION2;
00220 
00221 
00222         <span class="comment">//</span>
00223         <span class="comment">//  Check the ACL revision level</span>
00224         <span class="comment">//</span>
00225         <span class="keywordflow">if</span> (!ValidAclRevision(Acl)) {
00226             <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00227         }
00228 
00229 
00230         <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d4/acledit_8c.html#a3">WordAligned</a>(&amp;Acl-&gt;AclSize)) {
00231             <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00232         }
00233 
00234         <span class="keywordflow">if</span> (Acl-&gt;AclSize &lt; <span class="keyword">sizeof</span>(ACL)) {
00235             <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00236         }
00237         <span class="comment">//</span>
00238         <span class="comment">// Validate all of the ACEs.</span>
00239         <span class="comment">//</span>
00240 
00241         Ace = ((PVOID)((PUCHAR)(Acl) + <span class="keyword">sizeof</span>(ACL)));
00242 
00243         <span class="keywordflow">for</span> (i = 0; i &lt; Acl-&gt;AceCount; i++) {
00244 
00245             <span class="comment">//</span>
00246             <span class="comment">//  Check to make sure we haven't overrun the Acl buffer</span>
00247             <span class="comment">//  with our ace pointer.  Make sure the ACE_HEADER is in</span>
00248             <span class="comment">//  the ACL also.</span>
00249             <span class="comment">//</span>
00250 
00251             <span class="keywordflow">if</span> ((PUCHAR)Ace + <span class="keyword">sizeof</span>(ACE_HEADER) &gt;= ((PUCHAR)Acl + Acl-&gt;AclSize)) {
00252                 <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00253             }
00254 
00255             <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d4/acledit_8c.html#a3">WordAligned</a>(&amp;Ace-&gt;AceSize)) {
00256                 <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00257             }
00258 
00259             <span class="keywordflow">if</span> ((PUCHAR)Ace + Ace-&gt;AceSize &gt; ((PUCHAR)Acl + Acl-&gt;AclSize)) {
00260                 <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00261             }
00262 
00263             <span class="comment">//</span>
00264             <span class="comment">// It is now safe to reference fields in the ACE header.</span>
00265             <span class="comment">//</span>
00266 
00267             <span class="comment">//</span>
00268             <span class="comment">// The ACE header fits into the ACL, if this is a known type of ACE,</span>
00269             <span class="comment">// make sure the SID is within the bounds of the ACE</span>
00270             <span class="comment">//</span>
00271 
00272             <span class="keywordflow">if</span> (IsKnownAceType(Ace)) {
00273 
00274                 <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d4/acledit_8c.html#a2">LongAligned</a>(Ace-&gt;AceSize)) {
00275                     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00276                 }
00277 
00278                 <span class="keywordflow">if</span> (Ace-&gt;AceSize &lt; <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d7/struct__KNOWN__ACE.html">KNOWN_ACE</a>) - <span class="keyword">sizeof</span>(ULONG) + <span class="keyword">sizeof</span>(SID) - <span class="keyword">sizeof</span>(ULONG)) {
00279                     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00280                 }
00281 
00282                 <span class="comment">//</span>
00283                 <span class="comment">// It's now safe to reference the parts of the SID structure, though</span>
00284                 <span class="comment">// not the SID itself.</span>
00285                 <span class="comment">//</span>
00286 
00287                 Sid = (PISID) &amp; (((<a class="code" href="../../d4/d7/struct__KNOWN__ACE.html">PKNOWN_ACE</a>)Ace)-&gt;SidStart);
00288 
00289                 <span class="keywordflow">if</span> (Sid-&gt;Revision != SID_REVISION) {
00290                     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00291                 }
00292 
00293                 <span class="keywordflow">if</span> (Sid-&gt;SubAuthorityCount &gt; SID_MAX_SUB_AUTHORITIES) {
00294                     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00295                 }
00296 
00297                 <span class="comment">//</span>
00298                 <span class="comment">// SeLengthSid computes the size of the SID based on the subauthority count,</span>
00299                 <span class="comment">// so it is safe to use even though we don't know that the body of the SID</span>
00300                 <span class="comment">// is safe to reference.</span>
00301                 <span class="comment">//</span>
00302 
00303                 <span class="keywordflow">if</span> (Ace-&gt;AceSize &lt; <span class="keyword">sizeof</span>(<a class="code" href="../../d4/d7/struct__KNOWN__ACE.html">KNOWN_ACE</a>) - <span class="keyword">sizeof</span>(ULONG) + <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( Sid )) {
00304                     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00305                 }
00306 
00307 
00308             <span class="comment">//</span>
00309             <span class="comment">// If it's a compound ACE, then perform roughly the same set of tests, but</span>
00310             <span class="comment">// check the validity of both SIDs.</span>
00311             <span class="comment">//</span>
00312 
00313             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (IsCompoundAceType(Ace)) {
00314 
00315                 <span class="comment">//</span>
00316                 <span class="comment">// Compound ACEs became valid in revision 3</span>
00317                 <span class="comment">//</span>
00318                 <span class="keywordflow">if</span> ( Acl-&gt;AclRevision &lt; ACL_REVISION3 ) {
00319                     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00320                 }
00321 
00322                 <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d4/acledit_8c.html#a2">LongAligned</a>(Ace-&gt;AceSize)) {
00323                     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00324                 }
00325 
00326                 <span class="keywordflow">if</span> (Ace-&gt;AceSize &lt; <span class="keyword">sizeof</span>(KNOWN_COMPOUND_ACE) - <span class="keyword">sizeof</span>(ULONG) + <span class="keyword">sizeof</span>(SID)) {
00327                     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00328                 }
00329 
00330                 <span class="comment">//</span>
00331                 <span class="comment">// The only currently defined Compound ACE is an Impersonation ACE.</span>
00332                 <span class="comment">//</span>
00333 
00334                 <span class="keywordflow">if</span> (((PKNOWN_COMPOUND_ACE)Ace)-&gt;CompoundAceType != COMPOUND_ACE_IMPERSONATION) {
00335                     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00336                 }
00337 
00338                 <span class="comment">//</span>
00339                 <span class="comment">// Examine the first SID and make sure it's structurally valid,</span>
00340                 <span class="comment">// and it lies within the boundaries of the ACE.</span>
00341                 <span class="comment">//</span>
00342 
00343                 Sid = (PISID) &amp; (((PKNOWN_COMPOUND_ACE)Ace)-&gt;SidStart);
00344 
00345                 <span class="keywordflow">if</span> (Sid-&gt;Revision != SID_REVISION) {
00346                     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00347                 }
00348 
00349                 <span class="keywordflow">if</span> (Sid-&gt;SubAuthorityCount &gt; SID_MAX_SUB_AUTHORITIES) {
00350                     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00351                 }
00352 
00353                 <span class="comment">//</span>
00354                 <span class="comment">// Compound ACEs contain two SIDs.  Make sure this ACE is large enough to contain</span>
00355                 <span class="comment">// not only the first SID, but the body of the 2nd.</span>
00356                 <span class="comment">//</span>
00357 
00358                 <span class="keywordflow">if</span> (Ace-&gt;AceSize &lt; <span class="keyword">sizeof</span>(KNOWN_COMPOUND_ACE) - <span class="keyword">sizeof</span>(ULONG) + <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( Sid ) + <span class="keyword">sizeof</span>(SID)) {
00359                     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00360                 }
00361 
00362                 <span class="comment">//</span>
00363                 <span class="comment">// It is safe to reference the interior of the 2nd SID.</span>
00364                 <span class="comment">//</span>
00365 
00366                 Sid2 = (PISID) ((PUCHAR)Sid + <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( Sid ));
00367 
00368                 <span class="keywordflow">if</span> (Sid2-&gt;Revision != SID_REVISION) {
00369                     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00370                 }
00371 
00372                 <span class="keywordflow">if</span> (Sid2-&gt;SubAuthorityCount &gt; SID_MAX_SUB_AUTHORITIES) {
00373                     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00374                 }
00375 
00376                 <span class="keywordflow">if</span> (Ace-&gt;AceSize &lt; <span class="keyword">sizeof</span>(KNOWN_COMPOUND_ACE) - <span class="keyword">sizeof</span>(ULONG) + <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( Sid ) + <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( Sid2 )) {
00377                     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00378                 }
00379 
00380 
00381             <span class="comment">//</span>
00382             <span class="comment">// If it's an object ACE, then perform roughly the same set of tests.</span>
00383             <span class="comment">//</span>
00384 
00385             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (IsObjectAceType(Ace)) {
00386                 ULONG GuidSize=0;
00387 
00388                 <span class="comment">//</span>
00389                 <span class="comment">// Object ACEs became valid in revision 4</span>
00390                 <span class="comment">//</span>
00391                 <span class="keywordflow">if</span> ( Acl-&gt;AclRevision &lt; ACL_REVISION4 ) {
00392                     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00393                 }
00394 
00395                 <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d4/acledit_8c.html#a2">LongAligned</a>(Ace-&gt;AceSize)) {
00396                     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00397                 }
00398 
00399                 <span class="comment">//</span>
00400                 <span class="comment">// Ensure there is room for the ACE header.</span>
00401                 <span class="comment">//</span>
00402                 <span class="keywordflow">if</span> (Ace-&gt;AceSize &lt; <span class="keyword">sizeof</span>(KNOWN_OBJECT_ACE) - <span class="keyword">sizeof</span>(ULONG)) {
00403                     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00404                 }
00405 
00406 
00407                 <span class="comment">//</span>
00408                 <span class="comment">// Ensure there is room for the GUIDs and SID header</span>
00409                 <span class="comment">//</span>
00410                 <span class="keywordflow">if</span> ( RtlObjectAceObjectTypePresent( Ace ) ) {
00411                     GuidSize += <span class="keyword">sizeof</span>(GUID);
00412                 }
00413 
00414                 <span class="keywordflow">if</span> ( RtlObjectAceInheritedObjectTypePresent( Ace ) ) {
00415                     GuidSize += <span class="keyword">sizeof</span>(GUID);
00416                 }
00417 
00418                 <span class="keywordflow">if</span> (Ace-&gt;AceSize &lt; <span class="keyword">sizeof</span>(KNOWN_OBJECT_ACE) - <span class="keyword">sizeof</span>(ULONG) + GuidSize + <span class="keyword">sizeof</span>(SID)) {
00419                     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00420                 }
00421 
00422                 <span class="comment">//</span>
00423                 <span class="comment">// It's now safe to reference the parts of the SID structure, though</span>
00424                 <span class="comment">// not the SID itself.</span>
00425                 <span class="comment">//</span>
00426 
00427                 Sid = (PISID) RtlObjectAceSid( Ace );
00428 
00429                 <span class="keywordflow">if</span> (Sid-&gt;Revision != SID_REVISION) {
00430                     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00431                 }
00432 
00433                 <span class="keywordflow">if</span> (Sid-&gt;SubAuthorityCount &gt; SID_MAX_SUB_AUTHORITIES) {
00434                     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00435                 }
00436 
00437                 <span class="keywordflow">if</span> (Ace-&gt;AceSize &lt; <span class="keyword">sizeof</span>(KNOWN_OBJECT_ACE) - <span class="keyword">sizeof</span>(ULONG) + GuidSize + <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( Sid ) ) {
00438                     <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>);
00439                 }
00440             }
00441 
00442             <span class="comment">//</span>
00443             <span class="comment">//  And move Ace to the next ace position</span>
00444             <span class="comment">//</span>
00445 
00446             Ace = ((PVOID)((PUCHAR)(Ace) + ((PACE_HEADER)(Ace))-&gt;AceSize));
00447         }
00448 
00449         <span class="keywordflow">return</span>(<a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>);
00450 
00451     } except(<a class="code" href="../../d6/d7/halmips_8h.html#a33">EXCEPTION_EXECUTE_HANDLER</a>) {
00452 
00453         <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
00454     }
00455 
00456 }
00457 
00458 
00459 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00460"></a><a class="code" href="../../d2/d4/acledit_8c.html#a8">00460</a> <a class="code" href="../../d2/d4/acledit_8c.html#a8">RtlQueryInformationAcl</a> (
00461     IN PACL Acl,
00462     OUT PVOID AclInformation,
00463     IN ULONG AclInformationLength,
00464     IN ACL_INFORMATION_CLASS AclInformationClass
00465     )
00466 
00467 <span class="comment">/*++</span>
00468 <span class="comment"></span>
00469 <span class="comment">Routine Description:</span>
00470 <span class="comment"></span>
00471 <span class="comment">    This routine returns to the caller information about an ACL.  The requested</span>
00472 <span class="comment">    information can be AclRevisionInformation, or AclSizeInformation.</span>
00473 <span class="comment"></span>
00474 <span class="comment">Arguments:</span>
00475 <span class="comment"></span>
00476 <span class="comment">    Acl - Supplies the Acl being examined</span>
00477 <span class="comment"></span>
00478 <span class="comment">    AclInformation - Supplies the buffer to receive the information being</span>
00479 <span class="comment">        requested</span>
00480 <span class="comment"></span>
00481 <span class="comment">    AclInformationLength - Supplies the length of the AclInformation buffer</span>
00482 <span class="comment">        in bytes</span>
00483 <span class="comment"></span>
00484 <span class="comment">    AclInformationClass - Supplies the type of information being requested</span>
00485 <span class="comment"></span>
00486 <span class="comment">Return Value:</span>
00487 <span class="comment"></span>
00488 <span class="comment">    NTSTATUS - STATUS_SUCCESS if successful and an appropriate error</span>
00489 <span class="comment">        status otherwise</span>
00490 <span class="comment"></span>
00491 <span class="comment">--*/</span>
00492 
00493 {
00494     PACL_REVISION_INFORMATION RevisionInfo;
00495     PACL_SIZE_INFORMATION SizeInfo;
00496 
00497 
00498     PVOID FirstFree;
00499     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
00500 
00501     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
00502 
00503     <span class="comment">//</span>
00504     <span class="comment">//  Check the ACL revision level</span>
00505     <span class="comment">//</span>
00506 
00507     <span class="keywordflow">if</span> (!ValidAclRevision( Acl )) {
00508 
00509         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00510 
00511     }
00512 
00513     <span class="comment">//</span>
00514     <span class="comment">//  Case on the information class being requested</span>
00515     <span class="comment">//</span>
00516 
00517     <span class="keywordflow">switch</span> (AclInformationClass) {
00518 
00519     <span class="keywordflow">case</span> AclRevisionInformation:
00520 
00521         <span class="comment">//</span>
00522         <span class="comment">//  Make sure the buffer size is correct</span>
00523         <span class="comment">//</span>
00524 
00525         <span class="keywordflow">if</span> (AclInformationLength &lt; <span class="keyword">sizeof</span>(ACL_REVISION_INFORMATION)) {
00526 
00527             <span class="keywordflow">return</span> STATUS_BUFFER_TOO_SMALL;
00528 
00529         }
00530 
00531         <span class="comment">//</span>
00532         <span class="comment">//  Get the Acl revision and return</span>
00533         <span class="comment">//</span>
00534 
00535         RevisionInfo = (PACL_REVISION_INFORMATION)AclInformation;
00536         RevisionInfo-&gt;AclRevision = Acl-&gt;AclRevision;
00537 
00538         <span class="keywordflow">break</span>;
00539 
00540     <span class="keywordflow">case</span> AclSizeInformation:
00541 
00542         <span class="comment">//</span>
00543         <span class="comment">//  Make sure the buffer size is correct</span>
00544         <span class="comment">//</span>
00545 
00546         <span class="keywordflow">if</span> (AclInformationLength &lt; <span class="keyword">sizeof</span>(ACL_SIZE_INFORMATION)) {
00547 
00548             <span class="keywordflow">return</span> STATUS_BUFFER_TOO_SMALL;
00549 
00550         }
00551 
00552         <span class="comment">//</span>
00553         <span class="comment">//  Locate the first free spot in the Acl</span>
00554         <span class="comment">//</span>
00555 
00556         <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d4/acledit_8c.html#a25">RtlFirstFreeAce</a>( Acl, &amp;FirstFree )) {
00557 
00558             <span class="comment">//</span>
00559             <span class="comment">//  The input Acl is ill-formed</span>
00560             <span class="comment">//</span>
00561 
00562             <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00563 
00564         }
00565 
00566         <span class="comment">//</span>
00567         <span class="comment">//  Given a pointer to the first free spot we can now easily compute</span>
00568         <span class="comment">//  the number of free bytes and used bytes in the Acl.</span>
00569         <span class="comment">//</span>
00570 
00571         SizeInfo = (PACL_SIZE_INFORMATION)AclInformation;
00572         SizeInfo-&gt;AceCount = Acl-&gt;AceCount;
00573 
00574         <span class="keywordflow">if</span> (FirstFree == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>) {
00575 
00576             <span class="comment">//</span>
00577             <span class="comment">//  With a null first free we don't have any free space in the Acl</span>
00578             <span class="comment">//</span>
00579 
00580             SizeInfo-&gt;AclBytesInUse = Acl-&gt;AclSize;
00581 
00582             SizeInfo-&gt;AclBytesFree = 0;
00583 
00584         } <span class="keywordflow">else</span> {
00585 
00586             <span class="comment">//</span>
00587             <span class="comment">//  The first free is not null so we have some free room left in</span>
00588             <span class="comment">//  the acl</span>
00589             <span class="comment">//</span>
00590 
00591             SizeInfo-&gt;AclBytesInUse = (ULONG)((PUCHAR)FirstFree - (PUCHAR)Acl);
00592 
00593             SizeInfo-&gt;AclBytesFree = Acl-&gt;AclSize - SizeInfo-&gt;AclBytesInUse;
00594 
00595         }
00596 
00597         <span class="keywordflow">break</span>;
00598 
00599     <span class="keywordflow">default</span>:
00600 
00601         <span class="keywordflow">return</span> STATUS_INVALID_INFO_CLASS;
00602 
00603     }
00604 
00605     <span class="comment">//</span>
00606     <span class="comment">//  and return to our caller</span>
00607     <span class="comment">//</span>
00608 
00609     <span class="keywordflow">return</span> STATUS_SUCCESS;
00610 }
00611 
00612 
00613 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00614"></a><a class="code" href="../../d2/d4/acledit_8c.html#a9">00614</a> <a class="code" href="../../d2/d4/acledit_8c.html#a9">RtlSetInformationAcl</a> (
00615     IN PACL Acl,
00616     IN PVOID AclInformation,
00617     IN ULONG AclInformationLength,
00618     IN ACL_INFORMATION_CLASS AclInformationClass
00619     )
00620 
00621 <span class="comment">/*++</span>
00622 <span class="comment"></span>
00623 <span class="comment">Routine Description:</span>
00624 <span class="comment"></span>
00625 <span class="comment">    This routine sets the state of an ACL.  For now only the revision</span>
00626 <span class="comment">    level can be set and for now only a revision level of 1 is accepted</span>
00627 <span class="comment">    so this procedure is rather simple</span>
00628 <span class="comment"></span>
00629 <span class="comment">Arguments:</span>
00630 <span class="comment"></span>
00631 <span class="comment">    Acl - Supplies the Acl being altered</span>
00632 <span class="comment"></span>
00633 <span class="comment">    AclInformation - Supplies the buffer containing the information being</span>
00634 <span class="comment">        set</span>
00635 <span class="comment"></span>
00636 <span class="comment">    AclInformationLength - Supplies the length of the Acl information buffer</span>
00637 <span class="comment"></span>
00638 <span class="comment">    AclInformationClass - Supplies the type of information begin set</span>
00639 <span class="comment"></span>
00640 <span class="comment">Return Value:</span>
00641 <span class="comment"></span>
00642 <span class="comment">    NTSTATUS - STATUS_SUCCESS if successful and an appropriate error</span>
00643 <span class="comment">        status otherwise</span>
00644 <span class="comment"></span>
00645 <span class="comment">--*/</span>
00646 
00647 {
00648     PACL_REVISION_INFORMATION RevisionInfo;
00649 
00650     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
00651 
00652     <span class="comment">//</span>
00653     <span class="comment">//  Check the ACL revision level</span>
00654     <span class="comment">//</span>
00655 
00656     <span class="keywordflow">if</span> (!ValidAclRevision( Acl )) {
00657 
00658         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00659 
00660     }
00661 
00662     <span class="comment">//</span>
00663     <span class="comment">//  Case on the information class being requested</span>
00664     <span class="comment">//</span>
00665 
00666     <span class="keywordflow">switch</span> (AclInformationClass) {
00667 
00668     <span class="keywordflow">case</span> AclRevisionInformation:
00669 
00670         <span class="comment">//</span>
00671         <span class="comment">//  Make sure the buffer size is correct</span>
00672         <span class="comment">//</span>
00673 
00674         <span class="keywordflow">if</span> (AclInformationLength &lt; <span class="keyword">sizeof</span>(ACL_REVISION_INFORMATION)) {
00675 
00676             <span class="keywordflow">return</span> STATUS_BUFFER_TOO_SMALL;
00677 
00678         }
00679 
00680         <span class="comment">//</span>
00681         <span class="comment">//  Get the Acl requested ACL revision level</span>
00682         <span class="comment">//</span>
00683 
00684         RevisionInfo = (PACL_REVISION_INFORMATION)AclInformation;
00685 
00686         <span class="comment">//</span>
00687         <span class="comment">//  Don't let them lower the revision of an ACL.</span>
00688         <span class="comment">//</span>
00689 
00690         <span class="keywordflow">if</span> (RevisionInfo-&gt;AclRevision &lt; Acl-&gt;AclRevision ) {
00691 
00692             <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00693         }
00694 
00695         <span class="comment">//</span>
00696         <span class="comment">// Assign the new revision.</span>
00697         <span class="comment">//</span>
00698 
00699         Acl-&gt;AclRevision = (UCHAR)RevisionInfo-&gt;AclRevision;
00700 
00701         <span class="keywordflow">break</span>;
00702 
00703     <span class="keywordflow">default</span>:
00704 
00705         <span class="keywordflow">return</span> STATUS_INVALID_INFO_CLASS;
00706 
00707     }
00708 
00709     <span class="comment">//</span>
00710     <span class="comment">//  and return to our caller</span>
00711     <span class="comment">//</span>
00712 
00713     <span class="keywordflow">return</span> STATUS_SUCCESS;
00714 }
00715 
00716 
00717 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00718"></a><a class="code" href="../../d2/d4/acledit_8c.html#a10">00718</a> <a class="code" href="../../d2/d4/acledit_8c.html#a10">RtlAddAce</a> (
00719     IN OUT PACL Acl,
00720     IN ULONG AceRevision,
00721     IN ULONG StartingAceIndex,
00722     IN PVOID AceList,
00723     IN ULONG AceListLength
00724     )
00725 
00726 <span class="comment">/*++</span>
00727 <span class="comment"></span>
00728 <span class="comment">Routine Description:</span>
00729 <span class="comment"></span>
00730 <span class="comment">    This routine adds a string of ACEs to an ACL.</span>
00731 <span class="comment"></span>
00732 <span class="comment">Arguments:</span>
00733 <span class="comment"></span>
00734 <span class="comment">    Acl - Supplies the Acl being modified</span>
00735 <span class="comment"></span>
00736 <span class="comment">    AceRevision - Supplies the Acl/Ace revision of the ACE being added</span>
00737 <span class="comment"></span>
00738 <span class="comment">    StartingAceIndex - Supplies the ACE index which will be the index of</span>
00739 <span class="comment">        the first ace inserted in the acl. 0 for the beginning of the list</span>
00740 <span class="comment">        and MAXULONG for the end of the list.</span>
00741 <span class="comment"></span>
00742 <span class="comment">    AceList - Supplies the list of Aces to be added to the Acl</span>
00743 <span class="comment"></span>
00744 <span class="comment">    AceListLength - Supplies the size, in bytes, of the AceList buffer</span>
00745 <span class="comment"></span>
00746 <span class="comment">Return Value:</span>
00747 <span class="comment"></span>
00748 <span class="comment">    NTSTATUS - STATUS_SUCCESS if successful, and an appropriate error</span>
00749 <span class="comment">        status otherwise</span>
00750 <span class="comment"></span>
00751 <span class="comment">--*/</span>
00752 
00753 {
00754     PVOID FirstFree;
00755 
00756     PACE_HEADER Ace;
00757     ULONG NewAceCount;
00758 
00759     PVOID AcePosition;
00760     ULONG i;
00761     UCHAR NewRevision;
00762 
00763     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
00764 
00765     <span class="comment">//</span>
00766     <span class="comment">//  Check the ACL structure</span>
00767     <span class="comment">//</span>
00768 
00769     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d4/acledit_8c.html#a7">RtlValidAcl</a>(Acl)) {
00770 
00771         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00772 
00773     }
00774 
00775     <span class="comment">//</span>
00776     <span class="comment">//  Locate the first free ace and check to see that the Acl is</span>
00777     <span class="comment">//  well formed.</span>
00778     <span class="comment">//</span>
00779 
00780     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d4/acledit_8c.html#a25">RtlFirstFreeAce</a>( Acl, &amp;FirstFree )) {
00781 
00782         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00783 
00784     }
00785 
00786     <span class="comment">//</span>
00787     <span class="comment">// If the AceRevision is greater than the ACL revision, then we want to</span>
00788     <span class="comment">// increase the ACL revision to be the same as the new ACE revision.</span>
00789     <span class="comment">// We can do this because our previously defined ACE types ( 0 -&gt; 3 ) have</span>
00790     <span class="comment">// not changed structure nor been discontinued in the new revision.  So</span>
00791     <span class="comment">// we can bump the revision and the older types will not be misinterpreted.</span>
00792     <span class="comment">//</span>
00793     <span class="comment">// Compute what the final revision of the ACL is going to be, and save it</span>
00794     <span class="comment">// for later so we can update it once we know we're going to succeed.</span>
00795     <span class="comment">//</span>
00796 
00797     NewRevision = (UCHAR)AceRevision &gt; Acl-&gt;AclRevision ? (UCHAR)AceRevision : Acl-&gt;AclRevision;
00798 
00799     <span class="comment">//</span>
00800     <span class="comment">// Check that the AceList is well formed, we do this by simply zooming</span>
00801     <span class="comment">// down the Ace list until we're equal to or have exceeded the ace list</span>
00802     <span class="comment">// length.  If we are equal to the length then we're well formed otherwise</span>
00803     <span class="comment">// we're ill-formed.  We'll also calculate how many Ace's there are</span>
00804     <span class="comment">// in the AceList</span>
00805     <span class="comment">//</span>
00806     <span class="comment">// In addition, now we have to make sure that we haven't been handed an</span>
00807     <span class="comment">// ACE type that is inappropriate for the AceRevision that was passed</span>
00808     <span class="comment">// in.</span>
00809     <span class="comment">//</span>
00810 
00811     <span class="keywordflow">for</span> (Ace = AceList, NewAceCount = 0;
00812          Ace &lt; (PACE_HEADER)((PUCHAR)AceList + AceListLength);
00813          Ace = <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a2">NextAce</a>( Ace ), NewAceCount++) {
00814 
00815         <span class="comment">//</span>
00816         <span class="comment">// Ensure the ACL revision allows this ACE type.</span>
00817         <span class="comment">//</span>
00818 
00819         <span class="keywordflow">if</span> ( Ace-&gt;AceType &lt;= ACCESS_MAX_MS_V2_ACE_TYPE ) {
00820             <span class="comment">// V2 ACE are always valid.</span>
00821         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( Ace-&gt;AceType &lt;= ACCESS_MAX_MS_V3_ACE_TYPE ) {
00822             <span class="keywordflow">if</span> ( AceRevision &lt; ACL_REVISION3 ) {
00823                 <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00824             }
00825         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( Ace-&gt;AceType &lt;= ACCESS_MAX_MS_V4_ACE_TYPE ) {
00826             <span class="keywordflow">if</span> ( AceRevision &lt; ACL_REVISION4 ) {
00827                 <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00828             }
00829         }
00830     }
00831 
00832     <span class="comment">//</span>
00833     <span class="comment">//  Check to see if we've exceeded the ace list length</span>
00834     <span class="comment">//</span>
00835 
00836     <span class="keywordflow">if</span> (Ace &gt; (PACE_HEADER)((PUCHAR)AceList + AceListLength)) {
00837 
00838         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00839 
00840     }
00841 
00842     <span class="comment">//</span>
00843     <span class="comment">//  Check to see if there is enough room in the Acl to store the additional</span>
00844     <span class="comment">//  Ace list</span>
00845     <span class="comment">//</span>
00846 
00847     <span class="keywordflow">if</span> (FirstFree == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ||
00848         (PUCHAR)FirstFree + AceListLength &gt; (PUCHAR)Acl + Acl-&gt;AclSize) {
00849 
00850         <span class="keywordflow">return</span> STATUS_BUFFER_TOO_SMALL;
00851 
00852     }
00853 
00854     <span class="comment">//</span>
00855     <span class="comment">//  All of the input has checked okay, we now need to locate the position</span>
00856     <span class="comment">//  where to insert the new ace list.  We won't check the acl for</span>
00857     <span class="comment">//  validity because we did earlier when got the first free ace position.</span>
00858     <span class="comment">//</span>
00859 
00860     AcePosition = <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a1">FirstAce</a>( Acl );
00861 
00862     <span class="keywordflow">for</span> (i = 0; i &lt; StartingAceIndex &amp;&amp; i &lt; Acl-&gt;AceCount; i++) {
00863 
00864         AcePosition = <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a2">NextAce</a>( AcePosition );
00865 
00866     }
00867 
00868     <span class="comment">//</span>
00869     <span class="comment">//  Now Ace points to where we want to insert the ace list,  We do the</span>
00870     <span class="comment">//  insertion by adding ace list to the acl and shoving over the remainder</span>
00871     <span class="comment">//  of the list down the acl.  We know this will work because we earlier</span>
00872     <span class="comment">//  check to make sure the new acl list will fit in the acl size</span>
00873     <span class="comment">//</span>
00874 
00875     <a class="code" href="../../d2/d4/acledit_8c.html#a4">RtlpAddData</a>( AceList, AceListLength,
00876              AcePosition, (ULONG) ((PUCHAR)FirstFree - (PUCHAR)AcePosition));
00877 
00878     <span class="comment">//</span>
00879     <span class="comment">//  Update the Acl Header</span>
00880     <span class="comment">//</span>
00881 
00882     Acl-&gt;AceCount = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(Acl-&gt;AceCount + NewAceCount);
00883 
00884     Acl-&gt;AclRevision = NewRevision;
00885 
00886     <span class="comment">//</span>
00887     <span class="comment">//  And return to our caller</span>
00888     <span class="comment">//</span>
00889 
00890     <span class="keywordflow">return</span> STATUS_SUCCESS;
00891 }
00892 
00893 
00894 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00895"></a><a class="code" href="../../d2/d4/acledit_8c.html#a11">00895</a> <a class="code" href="../../d2/d4/acledit_8c.html#a11">RtlDeleteAce</a> (
00896     IN OUT PACL Acl,
00897     IN ULONG AceIndex
00898     )
00899 
00900 <span class="comment">/*++</span>
00901 <span class="comment"></span>
00902 <span class="comment">Routine Description:</span>
00903 <span class="comment"></span>
00904 <span class="comment">    This routine deletes one ACE from an ACL.</span>
00905 <span class="comment"></span>
00906 <span class="comment">Arguments:</span>
00907 <span class="comment"></span>
00908 <span class="comment">    Acl - Supplies the Acl being modified</span>
00909 <span class="comment"></span>
00910 <span class="comment">    AceIndex - Supplies the index of the Ace to delete.</span>
00911 <span class="comment"></span>
00912 <span class="comment">Return Value:</span>
00913 <span class="comment"></span>
00914 <span class="comment">    NTSTATUS - STATUS_SUCCESS if successful and an appropriate error</span>
00915 <span class="comment">        status otherwise</span>
00916 <span class="comment"></span>
00917 <span class="comment">--*/</span>
00918 
00919 {
00920     PVOID FirstFree;
00921 
00922     PACE_HEADER Ace;
00923     ULONG i;
00924 
00925     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
00926 
00927     <span class="comment">//</span>
00928     <span class="comment">//  Check the ACL structure</span>
00929     <span class="comment">//</span>
00930 
00931     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d4/acledit_8c.html#a7">RtlValidAcl</a>(Acl)) {
00932 
00933         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00934 
00935     }
00936 
00937     <span class="comment">//</span>
00938     <span class="comment">//  Make sure the AceIndex is within proper range, it's ulong so we know</span>
00939     <span class="comment">//  it can't be negative</span>
00940     <span class="comment">//</span>
00941 
00942     <span class="keywordflow">if</span> (AceIndex &gt;= Acl-&gt;AceCount) {
00943 
00944         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00945 
00946     }
00947 
00948     <span class="comment">//</span>
00949     <span class="comment">//  Locate the first free spot, this will tell us how much data</span>
00950     <span class="comment">//  we'll need to colapse.  If the results is false then the acl is</span>
00951     <span class="comment">//  ill-formed</span>
00952     <span class="comment">//</span>
00953 
00954     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d4/acledit_8c.html#a25">RtlFirstFreeAce</a>( Acl, &amp;FirstFree )) {
00955 
00956         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
00957 
00958     }
00959 
00960     <span class="comment">//</span>
00961     <span class="comment">//  Now locate the ace that we're going to delete.  This loop</span>
00962     <span class="comment">//  doesn't need to check the acl for being well formed.</span>
00963     <span class="comment">//</span>
00964 
00965     Ace = <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a1">FirstAce</a>( Acl );
00966 
00967     <span class="keywordflow">for</span> (i = 0; i &lt; AceIndex; i++) {
00968 
00969         Ace = <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a2">NextAce</a>( Ace );
00970 
00971     }
00972 
00973     <span class="comment">//</span>
00974     <span class="comment">//  We've found the ace to delete to simply copy over the rest of</span>
00975     <span class="comment">//  the acl over this ace.  The delete data procedure also deletes</span>
00976     <span class="comment">//  rest of the string that it's moving over so we don't have to</span>
00977     <span class="comment">//</span>
00978 
00979     <a class="code" href="../../d2/d4/acledit_8c.html#a5">RtlpDeleteData</a>( Ace, Ace-&gt;AceSize, (ULONG) ((PUCHAR)FirstFree - (PUCHAR)Ace));
00980 
00981     <span class="comment">//</span>
00982     <span class="comment">//  Update the Acl header</span>
00983     <span class="comment">//</span>
00984 
00985     Acl-&gt;AceCount--;
00986 
00987     <span class="comment">//</span>
00988     <span class="comment">//  And return to our caller</span>
00989     <span class="comment">//</span>
00990 
00991     <span class="keywordflow">return</span> STATUS_SUCCESS;
00992 }
00993 
00994 
00995 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l00996"></a><a class="code" href="../../d2/d4/acledit_8c.html#a12">00996</a> <a class="code" href="../../d2/d4/acledit_8c.html#a12">RtlGetAce</a> (
00997     IN PACL Acl,
00998     ULONG AceIndex,
00999     OUT PVOID *Ace
01000     )
01001 
01002 <span class="comment">/*++</span>
01003 <span class="comment"></span>
01004 <span class="comment">Routine Description:</span>
01005 <span class="comment"></span>
01006 <span class="comment">    This routine returns a pointer to an ACE in an ACl referenced by</span>
01007 <span class="comment">    ACE index</span>
01008 <span class="comment"></span>
01009 <span class="comment">Arguments:</span>
01010 <span class="comment"></span>
01011 <span class="comment">    Acl - Supplies the ACL being queried</span>
01012 <span class="comment"></span>
01013 <span class="comment">    AceIndex - Supplies the Ace index to locate</span>
01014 <span class="comment"></span>
01015 <span class="comment">    Ace - Receives the address of the ACE within the ACL</span>
01016 <span class="comment"></span>
01017 <span class="comment">Return Value:</span>
01018 <span class="comment"></span>
01019 <span class="comment">    NTSTATUS - STATUS_SUCCESS if successful and an appropriate error</span>
01020 <span class="comment">        status otherwise</span>
01021 <span class="comment"></span>
01022 <span class="comment">--*/</span>
01023 
01024 {
01025     ULONG i;
01026 
01027     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
01028 
01029     <span class="comment">//</span>
01030     <span class="comment">//  Check the ACL revision level</span>
01031     <span class="comment">//</span>
01032 
01033     <span class="keywordflow">if</span> (!ValidAclRevision(Acl)) {
01034 
01035         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
01036 
01037     }
01038 
01039     <span class="comment">//</span>
01040     <span class="comment">//  Check the AceIndex against the Ace count of the Acl, it's ulong so</span>
01041     <span class="comment">//  we know it can't be negative</span>
01042     <span class="comment">//</span>
01043 
01044     <span class="keywordflow">if</span> (AceIndex &gt;= Acl-&gt;AceCount) {
01045 
01046         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
01047 
01048     }
01049 
01050     <span class="comment">//</span>
01051     <span class="comment">//  To find the Ace requested by zooming down the Ace List.</span>
01052     <span class="comment">//</span>
01053 
01054     *Ace = <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a1">FirstAce</a>( Acl );
01055 
01056     <span class="keywordflow">for</span> (i = 0; i &lt; AceIndex; i++) {
01057 
01058         <span class="comment">//</span>
01059         <span class="comment">//  Check to make sure we haven't overrun the Acl buffer</span>
01060         <span class="comment">//  with our ace pointer.  If we have then our input is bogus</span>
01061         <span class="comment">//</span>
01062 
01063         <span class="keywordflow">if</span> (*Ace &gt;= (PVOID)((PUCHAR)Acl + Acl-&gt;AclSize)) {
01064 
01065             <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
01066 
01067         }
01068 
01069         <span class="comment">//</span>
01070         <span class="comment">//  And move Ace to the next ace position</span>
01071         <span class="comment">//</span>
01072 
01073         *Ace = <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a2">NextAce</a>( *Ace );
01074 
01075     }
01076 
01077     <span class="comment">//</span>
01078     <span class="comment">//  Now Ace points to the Ace we're after, but make sure we aren't</span>
01079     <span class="comment">//  beyond the Acl.</span>
01080     <span class="comment">//</span>
01081 
01082     <span class="keywordflow">if</span> (*Ace &gt;= (PVOID)((PUCHAR)Acl + Acl-&gt;AclSize)) {
01083 
01084         <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
01085 
01086     }
01087 
01088     <span class="comment">//</span>
01089     <span class="comment">//  The Ace is still within the Acl so return success to our caller</span>
01090     <span class="comment">//</span>
01091 
01092     <span class="keywordflow">return</span> STATUS_SUCCESS;
01093 
01094 }
01095 
01096 
01097 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01098"></a><a class="code" href="../../d2/d4/acledit_8c.html#a13">01098</a> <a class="code" href="../../d2/d4/acledit_8c.html#a13">RtlAddCompoundAce</a> (
01099     IN PACL Acl,
01100     IN ULONG AceRevision,
01101     IN UCHAR CompoundAceType,
01102     IN ACCESS_MASK AccessMask,
01103     IN PSID ServerSid,
01104     IN PSID ClientSid
01105     )
01106 
01107 <span class="comment">/*++</span>
01108 <span class="comment"></span>
01109 <span class="comment">Routine Description:</span>
01110 <span class="comment"></span>
01111 <span class="comment">    This routine adds a KNOWN_COMPOUND_ACE to an ACL.  This is</span>
01112 <span class="comment">    expected to be a common form of ACL modification.</span>
01113 <span class="comment"></span>
01114 <span class="comment">Arguments:</span>
01115 <span class="comment"></span>
01116 <span class="comment">    Acl - Supplies the Acl being modified</span>
01117 <span class="comment"></span>
01118 <span class="comment">    AceRevision - Supplies the Acl/Ace revision of the ACE being added</span>
01119 <span class="comment"></span>
01120 <span class="comment">    CompoundAceType - Supplies the type of compound ACE being added.</span>
01121 <span class="comment">        Currently the only defined type is COMPOUND_ACE_IMPERSONATION.</span>
01122 <span class="comment"></span>
01123 <span class="comment">    AccessMask - The mask of accesses to be granted to the specified SID pair.</span>
01124 <span class="comment"></span>
01125 <span class="comment">    ServerSid - Pointer to the Server SID to be placed in the ACE.</span>
01126 <span class="comment"></span>
01127 <span class="comment">    ClientSid - Pointer to the Client SID to be placed in the ACE.</span>
01128 <span class="comment"></span>
01129 <span class="comment">Return Value:</span>
01130 <span class="comment"></span>
01131 <span class="comment">    NTSTATUS - STATUS_SUCCESS if successful and an appropriate error</span>
01132 <span class="comment">        status otherwise</span>
01133 <span class="comment"></span>
01134 <span class="comment">    STATUS_INVALID_PARAMETER - The AceFlags parameter was invalid.</span>
01135 <span class="comment"></span>
01136 <span class="comment">--*/</span>
01137 
01138 
01139 
01140 
01141 {
01142     PVOID FirstFree;
01143     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> AceSize;
01144     PKNOWN_COMPOUND_ACE GrantAce;
01145     UCHAR NewRevision;
01146 
01147     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
01148 
01149     <span class="comment">//</span>
01150     <span class="comment">// Validate the structure of the SID</span>
01151     <span class="comment">//</span>
01152 
01153     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d6/sertl_8c.html#a35">RtlValidSid</a>(ServerSid) || !<a class="code" href="../../d8/d6/sertl_8c.html#a35">RtlValidSid</a>(ClientSid)) {
01154         <span class="keywordflow">return</span> STATUS_INVALID_SID;
01155     }
01156 
01157     <span class="comment">//</span>
01158     <span class="comment">//  Check the ACL &amp; ACE revision levels</span>
01159     <span class="comment">// Compund ACEs become valid in version 3.</span>
01160     <span class="comment">//</span>
01161 
01162     <span class="keywordflow">if</span> ( Acl-&gt;AclRevision &gt; ACL_REVISION4 ||
01163          AceRevision &lt; ACL_REVISION3 ||
01164          AceRevision &gt; ACL_REVISION4 ) {
01165         <span class="keywordflow">return</span> STATUS_REVISION_MISMATCH;
01166     }
01167 
01168     <span class="comment">//</span>
01169     <span class="comment">// Calculate the new revision of the ACL.  The new revision is the maximum</span>
01170     <span class="comment">// of the old revision and and new ACE's revision.  This is possible because</span>
01171     <span class="comment">// the format of previously defined ACEs did not change across revisions.</span>
01172     <span class="comment">//</span>
01173 
01174     NewRevision = Acl-&gt;AclRevision &gt; (UCHAR)AceRevision ? Acl-&gt;AclRevision : (UCHAR)AceRevision;
01175 
01176     <span class="comment">//</span>
01177     <span class="comment">//  Locate the first free ace and check to see that the Acl is</span>
01178     <span class="comment">//  well formed.</span>
01179     <span class="comment">//</span>
01180 
01181     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d4/acledit_8c.html#a7">RtlValidAcl</a>( Acl )) {
01182         <span class="keywordflow">return</span> STATUS_INVALID_ACL;
01183     }
01184 
01185     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d4/acledit_8c.html#a25">RtlFirstFreeAce</a>( Acl, &amp;FirstFree )) {
01186 
01187         <span class="keywordflow">return</span> STATUS_INVALID_ACL;
01188     }
01189 
01190     <span class="comment">//</span>
01191     <span class="comment">//  Check to see if there is enough room in the Acl to store the new</span>
01192     <span class="comment">//  ACE</span>
01193     <span class="comment">//</span>
01194 
01195     AceSize = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(<span class="keyword">sizeof</span>(KNOWN_COMPOUND_ACE) -
01196                        <span class="keyword">sizeof</span>(ULONG)              +
01197                        <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>(ClientSid)    +
01198                        <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>(ServerSid)
01199                        );
01200 
01201     <span class="keywordflow">if</span> (  FirstFree == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ||
01202           ((PUCHAR)FirstFree + AceSize &gt; ((PUCHAR)Acl + Acl-&gt;AclSize))
01203        ) {
01204 
01205         <span class="keywordflow">return</span> STATUS_ALLOTTED_SPACE_EXCEEDED;
01206     }
01207 
01208     <span class="comment">//</span>
01209     <span class="comment">// Add the ACE to the end of the ACL</span>
01210     <span class="comment">//</span>
01211 
01212     GrantAce = (PKNOWN_COMPOUND_ACE)FirstFree;
01213     GrantAce-&gt;Header.AceFlags = 0;
01214     GrantAce-&gt;Header.AceType = ACCESS_ALLOWED_COMPOUND_ACE_TYPE;
01215     GrantAce-&gt;Header.AceSize = AceSize;
01216     GrantAce-&gt;Mask = AccessMask;
01217     GrantAce-&gt;CompoundAceType = CompoundAceType;
01218     <a class="code" href="../../d8/d6/sertl_8c.html#a46">RtlCopySid</a>( <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>(ServerSid), (PSID)(&amp;GrantAce-&gt;SidStart), ServerSid );
01219     <a class="code" href="../../d8/d6/sertl_8c.html#a46">RtlCopySid</a>( <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>(ClientSid), (PSID)(((PCHAR)&amp;GrantAce-&gt;SidStart) + <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>(ServerSid)), ClientSid );
01220 
01221     <span class="comment">//</span>
01222     <span class="comment">// Increment the number of ACEs by 1.</span>
01223     <span class="comment">//</span>
01224 
01225     Acl-&gt;AceCount += 1;
01226 
01227     <span class="comment">//</span>
01228     <span class="comment">// Adjust the Acl revision, if necessary</span>
01229     <span class="comment">//</span>
01230 
01231     Acl-&gt;AclRevision = NewRevision;
01232 
01233     <span class="comment">//</span>
01234     <span class="comment">//  And return to our caller</span>
01235     <span class="comment">//</span>
01236 
01237     <span class="keywordflow">return</span> STATUS_SUCCESS;
01238 }
01239 
01240 
01241 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01242"></a><a class="code" href="../../d2/d4/acledit_8c.html#a14">01242</a> <a class="code" href="../../d2/d4/acledit_8c.html#a14">RtlpAddKnownAce</a> (
01243     IN OUT PACL Acl,
01244     IN ULONG AceRevision,
01245     IN ULONG AceFlags,
01246     IN ACCESS_MASK AccessMask,
01247     IN PSID Sid,
01248     IN UCHAR NewType
01249     )
01250 
01251 <span class="comment">/*++</span>
01252 <span class="comment"></span>
01253 <span class="comment">Routine Description:</span>
01254 <span class="comment"></span>
01255 <span class="comment">    This routine adds KNOWN_ACE to an ACL.  This is</span>
01256 <span class="comment">    expected to be a common form of ACL modification.</span>
01257 <span class="comment"></span>
01258 <span class="comment">    A very bland ACE header is placed in the ACE.  It provides no</span>
01259 <span class="comment">    inheritance and no ACE flags.  The type is specified by the caller.</span>
01260 <span class="comment"></span>
01261 <span class="comment">Arguments:</span>
01262 <span class="comment"></span>
01263 <span class="comment">    Acl - Supplies the Acl being modified</span>
01264 <span class="comment"></span>
01265 <span class="comment">    AceRevision - Supplies the Acl/Ace revision of the ACE being added</span>
01266 <span class="comment"></span>
01267 <span class="comment">    AceFlags - Supplies the inherit flags for the ACE.</span>
01268 <span class="comment"></span>
01269 <span class="comment">    AccessMask - The mask of accesses to be denied to the specified SID.</span>
01270 <span class="comment"></span>
01271 <span class="comment">    Sid - Pointer to the SID being denied access.</span>
01272 <span class="comment"></span>
01273 <span class="comment">    NewType - Type of ACE to be added.</span>
01274 <span class="comment"></span>
01275 <span class="comment">Return Value:</span>
01276 <span class="comment"></span>
01277 <span class="comment">    STATUS_SUCCESS - The ACE was successfully added.</span>
01278 <span class="comment"></span>
01279 <span class="comment">    STATUS_INVALID_ACL - The specified ACL is not properly formed.</span>
01280 <span class="comment"></span>
01281 <span class="comment">    STATUS_REVISION_MISMATCH - The specified revision is not known</span>
01282 <span class="comment">        or is incompatible with that of the ACL.</span>
01283 <span class="comment"></span>
01284 <span class="comment">    STATUS_ALLOTTED_SPACE_EXCEEDED - The new ACE does not fit into the</span>
01285 <span class="comment">        ACL.  A larger ACL buffer is required.</span>
01286 <span class="comment"></span>
01287 <span class="comment">    STATUS_INVALID_SID - The provided SID is not a structurally valid</span>
01288 <span class="comment">        SID.</span>
01289 <span class="comment"></span>
01290 <span class="comment">    STATUS_INVALID_PARAMETER - The AceFlags parameter was invalid.</span>
01291 <span class="comment"></span>
01292 <span class="comment">--*/</span>
01293 
01294 {
01295     PVOID FirstFree;
01296     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> AceSize;
01297     <a class="code" href="../../d4/d7/struct__KNOWN__ACE.html">PKNOWN_ACE</a> GrantAce;
01298     UCHAR NewRevision;
01299     ULONG TestedAceFlags;
01300 
01301     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
01302 
01303     <span class="comment">//</span>
01304     <span class="comment">// Validate the structure of the SID</span>
01305     <span class="comment">//</span>
01306 
01307     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d6/sertl_8c.html#a35">RtlValidSid</a>(Sid)) {
01308         <span class="keywordflow">return</span> STATUS_INVALID_SID;
01309     }
01310 
01311     <span class="comment">//</span>
01312     <span class="comment">//  Check the ACL &amp; ACE revision levels</span>
01313     <span class="comment">//</span>
01314 
01315     <span class="keywordflow">if</span> ( Acl-&gt;AclRevision &gt; ACL_REVISION4 || AceRevision &gt; ACL_REVISION4 ) {
01316 
01317         <span class="keywordflow">return</span> STATUS_REVISION_MISMATCH;
01318     }
01319 
01320     <span class="comment">//</span>
01321     <span class="comment">// Calculate the new revision of the ACL.  The new revision is the maximum</span>
01322     <span class="comment">// of the old revision and and new ACE's revision.  This is possible because</span>
01323     <span class="comment">// the format of previously defined ACEs did not change across revisions.</span>
01324     <span class="comment">//</span>
01325 
01326     NewRevision = Acl-&gt;AclRevision &gt; (UCHAR)AceRevision ? Acl-&gt;AclRevision : (UCHAR)AceRevision;
01327 
01328     <span class="comment">//</span>
01329     <span class="comment">// Validate the AceFlags.</span>
01330     <span class="comment">//</span>
01331 
01332     TestedAceFlags = AceFlags &amp; ~VALID_INHERIT_FLAGS;
01333     <span class="keywordflow">if</span> ( TestedAceFlags != 0 ) {
01334 
01335         <span class="keywordflow">if</span> ( NewType == SYSTEM_AUDIT_ACE_TYPE ) {
01336             TestedAceFlags &amp;=
01337                 ~(SUCCESSFUL_ACCESS_ACE_FLAG|FAILED_ACCESS_ACE_FLAG);
01338         }
01339 
01340         <span class="keywordflow">if</span> ( TestedAceFlags != 0 ) {
01341             <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
01342         }
01343     }
01344 
01345     <span class="comment">//</span>
01346     <span class="comment">//  Locate the first free ace and check to see that the Acl is</span>
01347     <span class="comment">//  well formed.</span>
01348     <span class="comment">//</span>
01349 
01350     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d4/acledit_8c.html#a7">RtlValidAcl</a>( Acl )) {
01351         <span class="keywordflow">return</span> STATUS_INVALID_ACL;
01352     }
01353     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d4/acledit_8c.html#a25">RtlFirstFreeAce</a>( Acl, &amp;FirstFree )) {
01354 
01355         <span class="keywordflow">return</span> STATUS_INVALID_ACL;
01356     }
01357 
01358     <span class="comment">//</span>
01359     <span class="comment">//  Check to see if there is enough room in the Acl to store the new</span>
01360     <span class="comment">//  ACE</span>
01361     <span class="comment">//</span>
01362 
01363     AceSize = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(<span class="keyword">sizeof</span>(ACE_HEADER) +
01364                       <span class="keyword">sizeof</span>(ACCESS_MASK) +
01365                       <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>(Sid));
01366 
01367     <span class="keywordflow">if</span> (  FirstFree == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ||
01368           ((PUCHAR)FirstFree + AceSize &gt; ((PUCHAR)Acl + Acl-&gt;AclSize))
01369        ) {
01370 
01371         <span class="keywordflow">return</span> STATUS_ALLOTTED_SPACE_EXCEEDED;
01372     }
01373 
01374     <span class="comment">//</span>
01375     <span class="comment">// Add the ACE to the end of the ACL</span>
01376     <span class="comment">//</span>
01377 
01378     GrantAce = (<a class="code" href="../../d4/d7/struct__KNOWN__ACE.html">PKNOWN_ACE</a>)FirstFree;
01379     GrantAce-&gt;<a class="code" href="../../d4/d7/struct__KNOWN__ACE.html#o0">Header</a>.AceFlags = (UCHAR)AceFlags;
01380     GrantAce-&gt;<a class="code" href="../../d4/d7/struct__KNOWN__ACE.html#o0">Header</a>.AceType = NewType;
01381     GrantAce-&gt;<a class="code" href="../../d4/d7/struct__KNOWN__ACE.html#o0">Header</a>.AceSize = AceSize;
01382     GrantAce-&gt;<a class="code" href="../../d4/d7/struct__KNOWN__ACE.html#o1">Mask</a> = AccessMask;
01383     <a class="code" href="../../d8/d6/sertl_8c.html#a46">RtlCopySid</a>( <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>(Sid), (PSID)(&amp;GrantAce-&gt;<a class="code" href="../../d4/d7/struct__KNOWN__ACE.html#o2">SidStart</a>), Sid );
01384 
01385     <span class="comment">//</span>
01386     <span class="comment">// Increment the number of ACEs by 1.</span>
01387     <span class="comment">//</span>
01388 
01389     Acl-&gt;AceCount += 1;
01390 
01391     <span class="comment">//</span>
01392     <span class="comment">// Adjust the Acl revision, if necessary</span>
01393     <span class="comment">//</span>
01394 
01395     Acl-&gt;AclRevision = NewRevision;
01396 
01397     <span class="comment">//</span>
01398     <span class="comment">//  And return to our caller</span>
01399     <span class="comment">//</span>
01400 
01401     <span class="keywordflow">return</span> STATUS_SUCCESS;
01402 }
01403 
01404 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01405"></a><a class="code" href="../../d2/d4/acledit_8c.html#a15">01405</a> <a class="code" href="../../d2/d4/acledit_8c.html#a15">RtlpAddKnownObjectAce</a> (
01406     IN OUT PACL Acl,
01407     IN ULONG AceRevision,
01408     IN ULONG AceFlags,
01409     IN ACCESS_MASK AccessMask,
01410     IN GUID *ObjectTypeGuid OPTIONAL,
01411     IN GUID *InheritedObjectTypeGuid OPTIONAL,
01412     IN PSID Sid,
01413     IN UCHAR NewType
01414     )
01415 
01416 <span class="comment">/*++</span>
01417 <span class="comment"></span>
01418 <span class="comment">Routine Description:</span>
01419 <span class="comment"></span>
01420 <span class="comment">    This routine adds KNOWN_ACE to an ACL.  This is</span>
01421 <span class="comment">    expected to be a common form of ACL modification.</span>
01422 <span class="comment"></span>
01423 <span class="comment">    A very bland ACE header is placed in the ACE.  It provides no</span>
01424 <span class="comment">    inheritance and no ACE flags.  The type is specified by the caller.</span>
01425 <span class="comment"></span>
01426 <span class="comment">Arguments:</span>
01427 <span class="comment"></span>
01428 <span class="comment">    Acl - Supplies the Acl being modified</span>
01429 <span class="comment"></span>
01430 <span class="comment">    AceRevision - Supplies the Acl/Ace revision of the ACE being added</span>
01431 <span class="comment"></span>
01432 <span class="comment">    AceFlags - Supplies the inherit flags for the ACE.</span>
01433 <span class="comment"></span>
01434 <span class="comment">    AccessMask - The mask of accesses to be denied to the specified SID.</span>
01435 <span class="comment"></span>
01436 <span class="comment">    ObjectTypeGuid - Supplies the GUID of the object this ACE applies to.</span>
01437 <span class="comment">        If NULL, no object type GUID is placed in the ACE.</span>
01438 <span class="comment"></span>
01439 <span class="comment">    InheritedObjectTypeGuid - Supplies the GUID of the object type that will</span>
01440 <span class="comment">        inherit this ACE.  If NULL, no inherited object type GUID is placed in</span>
01441 <span class="comment">        the ACE.</span>
01442 <span class="comment"></span>
01443 <span class="comment">    Sid - Pointer to the SID being denied access.</span>
01444 <span class="comment"></span>
01445 <span class="comment">    NewType - Type of ACE to be added.</span>
01446 <span class="comment"></span>
01447 <span class="comment">Return Value:</span>
01448 <span class="comment"></span>
01449 <span class="comment">    STATUS_SUCCESS - The ACE was successfully added.</span>
01450 <span class="comment"></span>
01451 <span class="comment">    STATUS_INVALID_ACL - The specified ACL is not properly formed.</span>
01452 <span class="comment"></span>
01453 <span class="comment">    STATUS_REVISION_MISMATCH - The specified revision is not known</span>
01454 <span class="comment">        or is incompatible with that of the ACL.</span>
01455 <span class="comment"></span>
01456 <span class="comment">    STATUS_ALLOTTED_SPACE_EXCEEDED - The new ACE does not fit into the</span>
01457 <span class="comment">        ACL.  A larger ACL buffer is required.</span>
01458 <span class="comment"></span>
01459 <span class="comment">    STATUS_INVALID_SID - The provided SID is not a structurally valid</span>
01460 <span class="comment">        SID.</span>
01461 <span class="comment"></span>
01462 <span class="comment">    STATUS_INVALID_PARAMETER - The AceFlags parameter was invalid.</span>
01463 <span class="comment"></span>
01464 <span class="comment">--*/</span>
01465 
01466 {
01467     PVOID FirstFree;
01468     <a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a> AceSize;
01469     PKNOWN_OBJECT_ACE GrantAce;
01470     UCHAR NewRevision;
01471     ULONG TestedAceFlags;
01472     ULONG AceObjectFlags = 0;
01473     ULONG SidSize;
01474     PCHAR Where;
01475 
01476     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
01477 
01478     <span class="comment">//</span>
01479     <span class="comment">// Validate the structure of the SID</span>
01480     <span class="comment">//</span>
01481 
01482     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d6/sertl_8c.html#a35">RtlValidSid</a>(Sid)) {
01483         <span class="keywordflow">return</span> STATUS_INVALID_SID;
01484     }
01485 
01486     <span class="comment">//</span>
01487     <span class="comment">//  Check the ACL &amp; ACE revision levels</span>
01488     <span class="comment">// Object ACEs became valid in version 4.</span>
01489     <span class="comment">//</span>
01490 
01491     <span class="keywordflow">if</span> ( Acl-&gt;AclRevision &gt; ACL_REVISION4 || AceRevision != ACL_REVISION4 ) {
01492 
01493         <span class="keywordflow">return</span> STATUS_REVISION_MISMATCH;
01494     }
01495 
01496     <span class="comment">//</span>
01497     <span class="comment">// Calculate the new revision of the ACL.  The new revision is the maximum</span>
01498     <span class="comment">// of the old revision and and new ACE's revision.  This is possible because</span>
01499     <span class="comment">// the format of previously defined ACEs did not change across revisions.</span>
01500     <span class="comment">//</span>
01501 
01502     NewRevision = Acl-&gt;AclRevision &gt; (UCHAR)AceRevision ? Acl-&gt;AclRevision : (UCHAR)AceRevision;
01503 
01504     <span class="comment">//</span>
01505     <span class="comment">// Validate the AceFlags.</span>
01506     <span class="comment">//</span>
01507 
01508 
01509     TestedAceFlags = AceFlags &amp; ~VALID_INHERIT_FLAGS;
01510     <span class="keywordflow">if</span> ( TestedAceFlags != 0 ) {
01511 
01512         <span class="keywordflow">if</span> ( NewType == SYSTEM_AUDIT_ACE_TYPE ||
01513              NewType == SYSTEM_AUDIT_OBJECT_ACE_TYPE ) {
01514             TestedAceFlags &amp;=
01515                 ~(SUCCESSFUL_ACCESS_ACE_FLAG|FAILED_ACCESS_ACE_FLAG);
01516         }
01517 
01518         <span class="keywordflow">if</span> ( TestedAceFlags != 0 ) {
01519             <span class="keywordflow">return</span> STATUS_INVALID_PARAMETER;
01520         }
01521     }
01522 
01523     <span class="comment">//</span>
01524     <span class="comment">//  Locate the first free ace and check to see that the Acl is</span>
01525     <span class="comment">//  well formed.</span>
01526     <span class="comment">//</span>
01527 
01528     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d4/acledit_8c.html#a7">RtlValidAcl</a>( Acl )) {
01529         <span class="keywordflow">return</span> STATUS_INVALID_ACL;
01530     }
01531     <span class="keywordflow">if</span> (!<a class="code" href="../../d2/d4/acledit_8c.html#a25">RtlFirstFreeAce</a>( Acl, &amp;FirstFree )) {
01532 
01533         <span class="keywordflow">return</span> STATUS_INVALID_ACL;
01534     }
01535 
01536     <span class="comment">//</span>
01537     <span class="comment">//  Check to see if there is enough room in the Acl to store the new</span>
01538     <span class="comment">//  ACE</span>
01539     <span class="comment">//</span>
01540 
01541     SidSize = <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>(Sid);
01542     AceSize = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(<span class="keyword">sizeof</span>(ACE_HEADER) +
01543                       <span class="keyword">sizeof</span>(ACCESS_MASK) +
01544                       <span class="keyword">sizeof</span>(ULONG) +
01545                       SidSize);
01546 
01547     <span class="keywordflow">if</span> ( ARGUMENT_PRESENT(ObjectTypeGuid) ) {
01548         AceObjectFlags |= ACE_OBJECT_TYPE_PRESENT;
01549         AceSize += <span class="keyword">sizeof</span>(GUID);
01550     }
01551 
01552     <span class="keywordflow">if</span> ( ARGUMENT_PRESENT(InheritedObjectTypeGuid) ) {
01553         AceObjectFlags |= ACE_INHERITED_OBJECT_TYPE_PRESENT;
01554         AceSize += <span class="keyword">sizeof</span>(GUID);
01555     }
01556 
01557     <span class="keywordflow">if</span> (  FirstFree == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ||
01558           ((PUCHAR)FirstFree + AceSize &gt; ((PUCHAR)Acl + Acl-&gt;AclSize))
01559        ) {
01560 
01561         <span class="keywordflow">return</span> STATUS_ALLOTTED_SPACE_EXCEEDED;
01562     }
01563 
01564     <span class="comment">//</span>
01565     <span class="comment">// Add the ACE to the end of the ACL</span>
01566     <span class="comment">//</span>
01567 
01568     GrantAce = (PKNOWN_OBJECT_ACE)FirstFree;
01569     GrantAce-&gt;Header.AceFlags = (UCHAR) AceFlags;
01570     GrantAce-&gt;Header.AceType = NewType;
01571     GrantAce-&gt;Header.AceSize = AceSize;
01572     GrantAce-&gt;Mask = AccessMask;
01573     GrantAce-&gt;Flags = AceObjectFlags;
01574     Where = (PCHAR) (&amp;GrantAce-&gt;SidStart);
01575     <span class="keywordflow">if</span> ( ARGUMENT_PRESENT(ObjectTypeGuid) ) {
01576         RtlCopyMemory( Where, ObjectTypeGuid, <span class="keyword">sizeof</span>(GUID) );
01577         Where += <span class="keyword">sizeof</span>(GUID);
01578     }
01579     <span class="keywordflow">if</span> ( ARGUMENT_PRESENT(InheritedObjectTypeGuid) ) {
01580         RtlCopyMemory( Where, InheritedObjectTypeGuid, <span class="keyword">sizeof</span>(GUID) );
01581         Where += <span class="keyword">sizeof</span>(GUID);
01582     }
01583     <a class="code" href="../../d8/d6/sertl_8c.html#a46">RtlCopySid</a>( SidSize, (PSID)Where, Sid );
01584     Where += SidSize;
01585 
01586     <span class="comment">//</span>
01587     <span class="comment">// Increment the number of ACEs by 1.</span>
01588     <span class="comment">//</span>
01589 
01590     Acl-&gt;AceCount += 1;
01591 
01592     <span class="comment">//</span>
01593     <span class="comment">// Adjust the Acl revision, if necessary</span>
01594     <span class="comment">//</span>
01595 
01596     Acl-&gt;AclRevision = NewRevision;
01597 
01598     <span class="comment">//</span>
01599     <span class="comment">//  And return to our caller</span>
01600     <span class="comment">//</span>
01601 
01602     <span class="keywordflow">return</span> STATUS_SUCCESS;
01603 }
01604 
01605 
01606 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01607"></a><a class="code" href="../../d2/d4/acledit_8c.html#a16">01607</a> <a class="code" href="../../d2/d4/acledit_8c.html#a16">RtlAddAccessAllowedAce</a> (
01608     IN OUT PACL Acl,
01609     IN ULONG AceRevision,
01610     IN ACCESS_MASK AccessMask,
01611     IN PSID Sid
01612     )
01613 
01614 <span class="comment">/*++</span>
01615 <span class="comment"></span>
01616 <span class="comment">Routine Description:</span>
01617 <span class="comment"></span>
01618 <span class="comment">    This routine adds an ACCESS_ALLOWED ACE to an ACL.  This is</span>
01619 <span class="comment">    expected to be a common form of ACL modification.</span>
01620 <span class="comment"></span>
01621 <span class="comment">    A very bland ACE header is placed in the ACE.  It provides no</span>
01622 <span class="comment">    inheritance and no ACE flags.</span>
01623 <span class="comment"></span>
01624 <span class="comment">Arguments:</span>
01625 <span class="comment"></span>
01626 <span class="comment">    Acl - Supplies the Acl being modified</span>
01627 <span class="comment"></span>
01628 <span class="comment">    AceRevision - Supplies the Acl/Ace revision of the ACE being added</span>
01629 <span class="comment"></span>
01630 <span class="comment">    AccessMask - The mask of accesses to be granted to the specified SID.</span>
01631 <span class="comment"></span>
01632 <span class="comment">    Sid - Pointer to the SID being granted access.</span>
01633 <span class="comment"></span>
01634 <span class="comment">Return Value:</span>
01635 <span class="comment"></span>
01636 <span class="comment">    STATUS_SUCCESS - The ACE was successfully added.</span>
01637 <span class="comment"></span>
01638 <span class="comment">    STATUS_INVALID_ACL - The specified ACL is not properly formed.</span>
01639 <span class="comment"></span>
01640 <span class="comment">    STATUS_REVISION_MISMATCH - The specified revision is not known</span>
01641 <span class="comment">        or is incompatible with that of the ACL.</span>
01642 <span class="comment"></span>
01643 <span class="comment">    STATUS_ALLOTTED_SPACE_EXCEEDED - The new ACE does not fit into the</span>
01644 <span class="comment">        ACL.  A larger ACL buffer is required.</span>
01645 <span class="comment"></span>
01646 <span class="comment">    STATUS_INVALID_SID - The provided SID is not a structurally valid</span>
01647 <span class="comment">        SID.</span>
01648 <span class="comment"></span>
01649 <span class="comment">--*/</span>
01650 
01651 {
01652     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
01653 
01654     <span class="keywordflow">return</span> <a class="code" href="../../d2/d4/acledit_8c.html#a14">RtlpAddKnownAce</a> (
01655                Acl,
01656                AceRevision,
01657                0,   <span class="comment">// No inherit flags</span>
01658                AccessMask,
01659                Sid,
01660                ACCESS_ALLOWED_ACE_TYPE
01661                );
01662 }
01663 
01664 
01665 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01666"></a><a class="code" href="../../d2/d4/acledit_8c.html#a17">01666</a> <a class="code" href="../../d2/d4/acledit_8c.html#a17">RtlAddAccessAllowedAceEx</a> (
01667     IN OUT PACL Acl,
01668     IN ULONG AceRevision,
01669     IN ULONG AceFlags,
01670     IN ACCESS_MASK AccessMask,
01671     IN PSID Sid
01672     )
01673 
01674 <span class="comment">/*++</span>
01675 <span class="comment"></span>
01676 <span class="comment">Routine Description:</span>
01677 <span class="comment"></span>
01678 <span class="comment">    This routine adds an ACCESS_ALLOWED ACE to an ACL.  This is</span>
01679 <span class="comment">    expected to be a common form of ACL modification.</span>
01680 <span class="comment"></span>
01681 <span class="comment">Arguments:</span>
01682 <span class="comment"></span>
01683 <span class="comment">    Acl - Supplies the Acl being modified</span>
01684 <span class="comment"></span>
01685 <span class="comment">    AceRevision - Supplies the Acl/Ace revision of the ACE being added</span>
01686 <span class="comment"></span>
01687 <span class="comment">    AceFlags - Supplies the inherit flags for the ACE.</span>
01688 <span class="comment"></span>
01689 <span class="comment">    AccessMask - The mask of accesses to be granted to the specified SID.</span>
01690 <span class="comment"></span>
01691 <span class="comment">    Sid - Pointer to the SID being granted access.</span>
01692 <span class="comment"></span>
01693 <span class="comment">Return Value:</span>
01694 <span class="comment"></span>
01695 <span class="comment">    STATUS_SUCCESS - The ACE was successfully added.</span>
01696 <span class="comment"></span>
01697 <span class="comment">    STATUS_INVALID_ACL - The specified ACL is not properly formed.</span>
01698 <span class="comment"></span>
01699 <span class="comment">    STATUS_REVISION_MISMATCH - The specified revision is not known</span>
01700 <span class="comment">        or is incompatible with that of the ACL.</span>
01701 <span class="comment"></span>
01702 <span class="comment">    STATUS_ALLOTTED_SPACE_EXCEEDED - The new ACE does not fit into the</span>
01703 <span class="comment">        ACL.  A larger ACL buffer is required.</span>
01704 <span class="comment"></span>
01705 <span class="comment">    STATUS_INVALID_SID - The provided SID is not a structurally valid</span>
01706 <span class="comment">        SID.</span>
01707 <span class="comment"></span>
01708 <span class="comment">    STATUS_INVALID_PARAMETER - The AceFlags parameter was invalid.</span>
01709 <span class="comment"></span>
01710 <span class="comment">--*/</span>
01711 
01712 {
01713     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
01714 
01715     <span class="keywordflow">return</span> <a class="code" href="../../d2/d4/acledit_8c.html#a14">RtlpAddKnownAce</a> (
01716                Acl,
01717                AceRevision,
01718                AceFlags,
01719                AccessMask,
01720                Sid,
01721                ACCESS_ALLOWED_ACE_TYPE
01722                );
01723 }
01724 
01725 
01726 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01727"></a><a class="code" href="../../d2/d4/acledit_8c.html#a18">01727</a> <a class="code" href="../../d2/d4/acledit_8c.html#a18">RtlAddAccessDeniedAce</a> (
01728     IN OUT PACL Acl,
01729     IN ULONG AceRevision,
01730     IN ACCESS_MASK AccessMask,
01731     IN PSID Sid
01732     )
01733 
01734 <span class="comment">/*++</span>
01735 <span class="comment"></span>
01736 <span class="comment">Routine Description:</span>
01737 <span class="comment"></span>
01738 <span class="comment">    This routine adds an ACCESS_DENIED ACE to an ACL.  This is</span>
01739 <span class="comment">    expected to be a common form of ACL modification.</span>
01740 <span class="comment"></span>
01741 <span class="comment">    A very bland ACE header is placed in the ACE.  It provides no</span>
01742 <span class="comment">    inheritance and no ACE flags.</span>
01743 <span class="comment"></span>
01744 <span class="comment">Arguments:</span>
01745 <span class="comment"></span>
01746 <span class="comment">    Acl - Supplies the Acl being modified</span>
01747 <span class="comment"></span>
01748 <span class="comment">    AceRevision - Supplies the Acl/Ace revision of the ACE being added</span>
01749 <span class="comment"></span>
01750 <span class="comment">    AccessMask - The mask of accesses to be denied to the specified SID.</span>
01751 <span class="comment"></span>
01752 <span class="comment">    Sid - Pointer to the SID being denied access.</span>
01753 <span class="comment"></span>
01754 <span class="comment">Return Value:</span>
01755 <span class="comment"></span>
01756 <span class="comment">    STATUS_SUCCESS - The ACE was successfully added.</span>
01757 <span class="comment"></span>
01758 <span class="comment">    STATUS_INVALID_ACL - The specified ACL is not properly formed.</span>
01759 <span class="comment"></span>
01760 <span class="comment">    STATUS_REVISION_MISMATCH - The specified revision is not known</span>
01761 <span class="comment">        or is incompatible with that of the ACL.</span>
01762 <span class="comment"></span>
01763 <span class="comment">    STATUS_ALLOTTED_SPACE_EXCEEDED - The new ACE does not fit into the</span>
01764 <span class="comment">        ACL.  A larger ACL buffer is required.</span>
01765 <span class="comment"></span>
01766 <span class="comment">    STATUS_INVALID_SID - The provided SID is not a structurally valid</span>
01767 <span class="comment">        SID.</span>
01768 <span class="comment"></span>
01769 <span class="comment">--*/</span>
01770 
01771 {
01772     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
01773 
01774     <span class="keywordflow">return</span> <a class="code" href="../../d2/d4/acledit_8c.html#a14">RtlpAddKnownAce</a> (
01775                Acl,
01776                AceRevision,
01777                0,   <span class="comment">// No inherit flags</span>
01778                AccessMask,
01779                Sid,
01780                ACCESS_DENIED_ACE_TYPE
01781                );
01782 
01783 }
01784 
01785 
01786 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01787"></a><a class="code" href="../../d2/d4/acledit_8c.html#a19">01787</a> <a class="code" href="../../d2/d4/acledit_8c.html#a19">RtlAddAccessDeniedAceEx</a> (
01788     IN OUT PACL Acl,
01789     IN ULONG AceRevision,
01790     IN ULONG AceFlags,
01791     IN ACCESS_MASK AccessMask,
01792     IN PSID Sid
01793     )
01794 
01795 <span class="comment">/*++</span>
01796 <span class="comment"></span>
01797 <span class="comment">Routine Description:</span>
01798 <span class="comment"></span>
01799 <span class="comment">    This routine adds an ACCESS_DENIED ACE to an ACL.  This is</span>
01800 <span class="comment">    expected to be a common form of ACL modification.</span>
01801 <span class="comment"></span>
01802 <span class="comment">Arguments:</span>
01803 <span class="comment"></span>
01804 <span class="comment">    Acl - Supplies the Acl being modified</span>
01805 <span class="comment"></span>
01806 <span class="comment">    AceRevision - Supplies the Acl/Ace revision of the ACE being added</span>
01807 <span class="comment"></span>
01808 <span class="comment">    AceFlags - Supplies the inherit flags for the ACE.</span>
01809 <span class="comment"></span>
01810 <span class="comment">    AccessMask - The mask of accesses to be denied to the specified SID.</span>
01811 <span class="comment"></span>
01812 <span class="comment">    Sid - Pointer to the SID being denied access.</span>
01813 <span class="comment"></span>
01814 <span class="comment">Return Value:</span>
01815 <span class="comment"></span>
01816 <span class="comment">    STATUS_SUCCESS - The ACE was successfully added.</span>
01817 <span class="comment"></span>
01818 <span class="comment">    STATUS_INVALID_ACL - The specified ACL is not properly formed.</span>
01819 <span class="comment"></span>
01820 <span class="comment">    STATUS_REVISION_MISMATCH - The specified revision is not known</span>
01821 <span class="comment">        or is incompatible with that of the ACL.</span>
01822 <span class="comment"></span>
01823 <span class="comment">    STATUS_ALLOTTED_SPACE_EXCEEDED - The new ACE does not fit into the</span>
01824 <span class="comment">        ACL.  A larger ACL buffer is required.</span>
01825 <span class="comment"></span>
01826 <span class="comment">    STATUS_INVALID_SID - The provided SID is not a structurally valid</span>
01827 <span class="comment">        SID.</span>
01828 <span class="comment"></span>
01829 <span class="comment">    STATUS_INVALID_PARAMETER - The AceFlags parameter was invalid.</span>
01830 <span class="comment"></span>
01831 <span class="comment">--*/</span>
01832 
01833 {
01834     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
01835 
01836     <span class="keywordflow">return</span> <a class="code" href="../../d2/d4/acledit_8c.html#a14">RtlpAddKnownAce</a> (
01837                Acl,
01838                AceRevision,
01839                AceFlags,
01840                AccessMask,
01841                Sid,
01842                ACCESS_DENIED_ACE_TYPE
01843                );
01844 
01845 }
01846 
01847 
01848 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01849"></a><a class="code" href="../../d2/d4/acledit_8c.html#a20">01849</a> <a class="code" href="../../d2/d4/acledit_8c.html#a20">RtlAddAuditAccessAce</a> (
01850     IN OUT PACL Acl,
01851     IN ULONG AceRevision,
01852     IN ACCESS_MASK AccessMask,
01853     IN PSID Sid,
01854     IN BOOLEAN AuditSuccess,
01855     IN BOOLEAN AuditFailure
01856     )
01857 
01858 <span class="comment">/*++</span>
01859 <span class="comment"></span>
01860 <span class="comment">Routine Description:</span>
01861 <span class="comment"></span>
01862 <span class="comment">    This routine adds a SYSTEM_AUDIT ACE to an ACL.  This is</span>
01863 <span class="comment">    expected to be a common form of ACL modification.</span>
01864 <span class="comment"></span>
01865 <span class="comment">    A very bland ACE header is placed in the ACE.  It provides no</span>
01866 <span class="comment">    inheritance.</span>
01867 <span class="comment"></span>
01868 <span class="comment">    Parameters are used to indicate whether auditing is to be performed</span>
01869 <span class="comment">    on success, failure, or both.</span>
01870 <span class="comment"></span>
01871 <span class="comment">Arguments:</span>
01872 <span class="comment"></span>
01873 <span class="comment">    Acl - Supplies the Acl being modified</span>
01874 <span class="comment"></span>
01875 <span class="comment">    AceRevision - Supplies the Acl/Ace revision of the ACE being added</span>
01876 <span class="comment"></span>
01877 <span class="comment">    AccessMask - The mask of accesses to be denied to the specified SID.</span>
01878 <span class="comment"></span>
01879 <span class="comment">    Sid - Pointer to the SID to be audited.</span>
01880 <span class="comment"></span>
01881 <span class="comment">    AuditSuccess - If TRUE, indicates successful access attempts are to be</span>
01882 <span class="comment">        audited.</span>
01883 <span class="comment"></span>
01884 <span class="comment">    AuditFailure - If TRUE, indicated failed access attempts are to be</span>
01885 <span class="comment">        audited.</span>
01886 <span class="comment"></span>
01887 <span class="comment">Return Value:</span>
01888 <span class="comment"></span>
01889 <span class="comment">    STATUS_SUCCESS - The ACE was successfully added.</span>
01890 <span class="comment"></span>
01891 <span class="comment">    STATUS_INVALID_ACL - The specified ACL is not properly formed.</span>
01892 <span class="comment"></span>
01893 <span class="comment">    STATUS_REVISION_MISMATCH - The specified revision is not known</span>
01894 <span class="comment">        or is incompatible with that of the ACL.</span>
01895 <span class="comment"></span>
01896 <span class="comment">    STATUS_ALLOTTED_SPACE_EXCEEDED - The new ACE does not fit into the</span>
01897 <span class="comment">        ACL.  A larger ACL buffer is required.</span>
01898 <span class="comment"></span>
01899 <span class="comment">    STATUS_INVALID_SID - The provided SID is not a structurally valid</span>
01900 <span class="comment">        SID.</span>
01901 <span class="comment"></span>
01902 <span class="comment">--*/</span>
01903 
01904 {
01905     ULONG AceFlags = 0;
01906     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
01907 
01908     <span class="keywordflow">if</span> (AuditSuccess) {
01909         AceFlags |= SUCCESSFUL_ACCESS_ACE_FLAG;
01910     }
01911     <span class="keywordflow">if</span> (AuditFailure) {
01912         AceFlags |= FAILED_ACCESS_ACE_FLAG;
01913     }
01914 
01915     <span class="keywordflow">return</span> <a class="code" href="../../d2/d4/acledit_8c.html#a14">RtlpAddKnownAce</a> (
01916                 Acl,
01917                 AceRevision,
01918                 AceFlags,
01919                 AccessMask,
01920                 Sid,
01921                 SYSTEM_AUDIT_ACE_TYPE );
01922 
01923 }
01924 
01925 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l01926"></a><a class="code" href="../../d2/d4/acledit_8c.html#a21">01926</a> <a class="code" href="../../d2/d4/acledit_8c.html#a21">RtlAddAuditAccessAceEx</a> (
01927     IN OUT PACL Acl,
01928     IN ULONG AceRevision,
01929     IN ULONG AceFlags,
01930     IN ACCESS_MASK AccessMask,
01931     IN PSID Sid,
01932     IN BOOLEAN AuditSuccess,
01933     IN BOOLEAN AuditFailure
01934     )
01935 
01936 <span class="comment">/*++</span>
01937 <span class="comment"></span>
01938 <span class="comment">Routine Description:</span>
01939 <span class="comment"></span>
01940 <span class="comment">    This routine adds a SYSTEM_AUDIT ACE to an ACL.  This is</span>
01941 <span class="comment">    expected to be a common form of ACL modification.</span>
01942 <span class="comment"></span>
01943 <span class="comment">    A very bland ACE header is placed in the ACE.  It provides no</span>
01944 <span class="comment">    inheritance.</span>
01945 <span class="comment"></span>
01946 <span class="comment">    Parameters are used to indicate whether auditing is to be performed</span>
01947 <span class="comment">    on success, failure, or both.</span>
01948 <span class="comment"></span>
01949 <span class="comment">Arguments:</span>
01950 <span class="comment"></span>
01951 <span class="comment">    Acl - Supplies the Acl being modified</span>
01952 <span class="comment"></span>
01953 <span class="comment">    AceRevision - Supplies the Acl/Ace revision of the ACE being added</span>
01954 <span class="comment"></span>
01955 <span class="comment">    AceFlags - Supplies the inherit flags for the ACE.</span>
01956 <span class="comment"></span>
01957 <span class="comment">    AccessMask - The mask of accesses to be denied to the specified SID.</span>
01958 <span class="comment"></span>
01959 <span class="comment">    Sid - Pointer to the SID to be audited.</span>
01960 <span class="comment"></span>
01961 <span class="comment">    AuditSuccess - If TRUE, indicates successful access attempts are to be</span>
01962 <span class="comment">        audited.</span>
01963 <span class="comment"></span>
01964 <span class="comment">    AuditFailure - If TRUE, indicated failed access attempts are to be</span>
01965 <span class="comment">        audited.</span>
01966 <span class="comment"></span>
01967 <span class="comment">Return Value:</span>
01968 <span class="comment"></span>
01969 <span class="comment">    STATUS_SUCCESS - The ACE was successfully added.</span>
01970 <span class="comment"></span>
01971 <span class="comment">    STATUS_INVALID_ACL - The specified ACL is not properly formed.</span>
01972 <span class="comment"></span>
01973 <span class="comment">    STATUS_REVISION_MISMATCH - The specified revision is not known</span>
01974 <span class="comment">        or is incompatible with that of the ACL.</span>
01975 <span class="comment"></span>
01976 <span class="comment">    STATUS_ALLOTTED_SPACE_EXCEEDED - The new ACE does not fit into the</span>
01977 <span class="comment">        ACL.  A larger ACL buffer is required.</span>
01978 <span class="comment"></span>
01979 <span class="comment">    STATUS_INVALID_SID - The provided SID is not a structurally valid</span>
01980 <span class="comment">        SID.</span>
01981 <span class="comment"></span>
01982 <span class="comment">    STATUS_INVALID_PARAMETER - The AceFlags parameter was invalid.</span>
01983 <span class="comment"></span>
01984 <span class="comment">--*/</span>
01985 
01986 {
01987     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
01988 
01989     <span class="keywordflow">if</span> (AuditSuccess) {
01990         AceFlags |= SUCCESSFUL_ACCESS_ACE_FLAG;
01991     }
01992     <span class="keywordflow">if</span> (AuditFailure) {
01993         AceFlags |= FAILED_ACCESS_ACE_FLAG;
01994     }
01995 
01996     <span class="keywordflow">return</span> <a class="code" href="../../d2/d4/acledit_8c.html#a14">RtlpAddKnownAce</a> (
01997                 Acl,
01998                 AceRevision,
01999                 AceFlags,
02000                 AccessMask,
02001                 Sid,
02002                 SYSTEM_AUDIT_ACE_TYPE );
02003 
02004 }
02005 
02006 
02007 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l02008"></a><a class="code" href="../../d2/d4/acledit_8c.html#a22">02008</a> <a class="code" href="../../d2/d4/acledit_8c.html#a22">RtlAddAccessAllowedObjectAce</a> (
02009     IN OUT PACL Acl,
02010     IN ULONG AceRevision,
02011     IN ULONG AceFlags,
02012     IN ACCESS_MASK AccessMask,
02013     IN GUID *ObjectTypeGuid OPTIONAL,
02014     IN GUID *InheritedObjectTypeGuid OPTIONAL,
02015     IN PSID Sid
02016     )
02017 
02018 <span class="comment">/*++</span>
02019 <span class="comment"></span>
02020 <span class="comment">Routine Description:</span>
02021 <span class="comment"></span>
02022 <span class="comment">    This routine adds an object specific ACCESS_ALLOWED ACE to an ACL.  This is</span>
02023 <span class="comment">    expected to be a common form of ACL modification.</span>
02024 <span class="comment"></span>
02025 <span class="comment">Arguments:</span>
02026 <span class="comment"></span>
02027 <span class="comment">    Acl - Supplies the Acl being modified</span>
02028 <span class="comment"></span>
02029 <span class="comment">    AceRevision - Supplies the Acl/Ace revision of the ACE being added</span>
02030 <span class="comment"></span>
02031 <span class="comment">    AceFlags - Supplies the inherit flags for the ACE.</span>
02032 <span class="comment"></span>
02033 <span class="comment">    AccessMask - The mask of accesses to be granted to the specified SID.</span>
02034 <span class="comment"></span>
02035 <span class="comment">    ObjectTypeGuid - Supplies the GUID of the object this ACE applies to.</span>
02036 <span class="comment">        If NULL, no object type GUID is placed in the ACE.</span>
02037 <span class="comment"></span>
02038 <span class="comment">    InheritedObjectTypeGuid - Supplies the GUID of the object type that will</span>
02039 <span class="comment">        inherit this ACE.  If NULL, no inherited object type GUID is placed in</span>
02040 <span class="comment">        the ACE.</span>
02041 <span class="comment"></span>
02042 <span class="comment">    Sid - Pointer to the SID being granted access.</span>
02043 <span class="comment"></span>
02044 <span class="comment">Return Value:</span>
02045 <span class="comment"></span>
02046 <span class="comment">    STATUS_SUCCESS - The ACE was successfully added.</span>
02047 <span class="comment"></span>
02048 <span class="comment">    STATUS_INVALID_ACL - The specified ACL is not properly formed.</span>
02049 <span class="comment"></span>
02050 <span class="comment">    STATUS_REVISION_MISMATCH - The specified revision is not known</span>
02051 <span class="comment">        or is incompatible with that of the ACL.</span>
02052 <span class="comment"></span>
02053 <span class="comment">    STATUS_ALLOTTED_SPACE_EXCEEDED - The new ACE does not fit into the</span>
02054 <span class="comment">        ACL.  A larger ACL buffer is required.</span>
02055 <span class="comment"></span>
02056 <span class="comment">    STATUS_INVALID_SID - The provided SID is not a structurally valid</span>
02057 <span class="comment">        SID.</span>
02058 <span class="comment"></span>
02059 <span class="comment">    STATUS_INVALID_PARAMETER - The AceFlags parameter was invalid.</span>
02060 <span class="comment"></span>
02061 <span class="comment">--*/</span>
02062 
02063 {
02064     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
02065 
02066     <span class="comment">//</span>
02067     <span class="comment">// If no object types are specified,</span>
02068     <span class="comment">//  build a non-object ACE.</span>
02069     <span class="comment">//</span>
02070     <span class="keywordflow">if</span> (ObjectTypeGuid == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; InheritedObjectTypeGuid == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
02071         <span class="keywordflow">return</span> <a class="code" href="../../d2/d4/acledit_8c.html#a14">RtlpAddKnownAce</a> (
02072                    Acl,
02073                    AceRevision,
02074                    AceFlags,
02075                    AccessMask,
02076                    Sid,
02077                    ACCESS_ALLOWED_ACE_TYPE
02078                    );
02079     }
02080 
02081     <span class="keywordflow">return</span> <a class="code" href="../../d2/d4/acledit_8c.html#a15">RtlpAddKnownObjectAce</a> (
02082                Acl,
02083                AceRevision,
02084                AceFlags,
02085                AccessMask,
02086                ObjectTypeGuid,
02087                InheritedObjectTypeGuid,
02088                Sid,
02089                ACCESS_ALLOWED_OBJECT_ACE_TYPE
02090                );
02091 }
02092 
02093 
02094 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l02095"></a><a class="code" href="../../d2/d4/acledit_8c.html#a23">02095</a> <a class="code" href="../../d2/d4/acledit_8c.html#a23">RtlAddAccessDeniedObjectAce</a> (
02096     IN OUT PACL Acl,
02097     IN ULONG AceRevision,
02098     IN ULONG AceFlags,
02099     IN ACCESS_MASK AccessMask,
02100     IN GUID *ObjectTypeGuid OPTIONAL,
02101     IN GUID *InheritedObjectTypeGuid OPTIONAL,
02102     IN PSID Sid
02103     )
02104 
02105 <span class="comment">/*++</span>
02106 <span class="comment"></span>
02107 <span class="comment">Routine Description:</span>
02108 <span class="comment"></span>
02109 <span class="comment">    This routine adds an object specific ACCESS_DENIED ACE to an ACL.  This is</span>
02110 <span class="comment">    expected to be a common form of ACL modification.</span>
02111 <span class="comment"></span>
02112 <span class="comment">Arguments:</span>
02113 <span class="comment"></span>
02114 <span class="comment">    Acl - Supplies the Acl being modified</span>
02115 <span class="comment"></span>
02116 <span class="comment">    AceRevision - Supplies the Acl/Ace revision of the ACE being added</span>
02117 <span class="comment"></span>
02118 <span class="comment">    AceFlags - Supplies the inherit flags for the ACE.</span>
02119 <span class="comment"></span>
02120 <span class="comment">    AccessMask - The mask of accesses to be granted to the specified SID.</span>
02121 <span class="comment"></span>
02122 <span class="comment">    ObjectTypeGuid - Supplies the GUID of the object this ACE applies to.</span>
02123 <span class="comment">        If NULL, no object type GUID is placed in the ACE.</span>
02124 <span class="comment"></span>
02125 <span class="comment">    InheritedObjectTypeGuid - Supplies the GUID of the object type that will</span>
02126 <span class="comment">        inherit this ACE.  If NULL, no inherited object type GUID is placed in</span>
02127 <span class="comment">        the ACE.</span>
02128 <span class="comment"></span>
02129 <span class="comment">    Sid - Pointer to the SID being denied access.</span>
02130 <span class="comment"></span>
02131 <span class="comment">Return Value:</span>
02132 <span class="comment"></span>
02133 <span class="comment">    STATUS_SUCCESS - The ACE was successfully added.</span>
02134 <span class="comment"></span>
02135 <span class="comment">    STATUS_INVALID_ACL - The specified ACL is not properly formed.</span>
02136 <span class="comment"></span>
02137 <span class="comment">    STATUS_REVISION_MISMATCH - The specified revision is not known</span>
02138 <span class="comment">        or is incompatible with that of the ACL.</span>
02139 <span class="comment"></span>
02140 <span class="comment">    STATUS_ALLOTTED_SPACE_EXCEEDED - The new ACE does not fit into the</span>
02141 <span class="comment">        ACL.  A larger ACL buffer is required.</span>
02142 <span class="comment"></span>
02143 <span class="comment">    STATUS_INVALID_SID - The provided SID is not a structurally valid</span>
02144 <span class="comment">        SID.</span>
02145 <span class="comment"></span>
02146 <span class="comment">    STATUS_INVALID_PARAMETER - The AceFlags parameter was invalid.</span>
02147 <span class="comment"></span>
02148 <span class="comment">--*/</span>
02149 
02150 {
02151     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
02152 
02153     <span class="comment">//</span>
02154     <span class="comment">// If no object types are specified,</span>
02155     <span class="comment">//  build a non-object ACE.</span>
02156     <span class="comment">//</span>
02157     <span class="keywordflow">if</span> (ObjectTypeGuid == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; InheritedObjectTypeGuid == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
02158         <span class="keywordflow">return</span> <a class="code" href="../../d2/d4/acledit_8c.html#a14">RtlpAddKnownAce</a> (
02159                    Acl,
02160                    AceRevision,
02161                    AceFlags,
02162                    AccessMask,
02163                    Sid,
02164                    ACCESS_DENIED_ACE_TYPE
02165                    );
02166     }
02167 
02168     <span class="keywordflow">return</span> <a class="code" href="../../d2/d4/acledit_8c.html#a15">RtlpAddKnownObjectAce</a> (
02169                Acl,
02170                AceRevision,
02171                AceFlags,
02172                AccessMask,
02173                ObjectTypeGuid,
02174                InheritedObjectTypeGuid,
02175                Sid,
02176                ACCESS_DENIED_OBJECT_ACE_TYPE
02177                );
02178 }
02179 
02180 
02181 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
<a name="l02182"></a><a class="code" href="../../d2/d4/acledit_8c.html#a24">02182</a> <a class="code" href="../../d2/d4/acledit_8c.html#a24">RtlAddAuditAccessObjectAce</a> (
02183     IN OUT PACL Acl,
02184     IN ULONG AceRevision,
02185     IN ULONG AceFlags,
02186     IN ACCESS_MASK AccessMask,
02187     IN GUID *ObjectTypeGuid OPTIONAL,
02188     IN GUID *InheritedObjectTypeGuid OPTIONAL,
02189     IN PSID Sid,
02190     IN BOOLEAN AuditSuccess,
02191     IN BOOLEAN AuditFailure
02192     )
02193 
02194 <span class="comment">/*++</span>
02195 <span class="comment"></span>
02196 <span class="comment">Routine Description:</span>
02197 <span class="comment"></span>
02198 <span class="comment">    This routine adds an object specific ACCESS_DENIED ACE to an ACL.  This is</span>
02199 <span class="comment">    expected to be a common form of ACL modification.</span>
02200 <span class="comment"></span>
02201 <span class="comment">Arguments:</span>
02202 <span class="comment"></span>
02203 <span class="comment">    Acl - Supplies the Acl being modified</span>
02204 <span class="comment"></span>
02205 <span class="comment">    AceRevision - Supplies the Acl/Ace revision of the ACE being added</span>
02206 <span class="comment"></span>
02207 <span class="comment">    AceFlags - Supplies the inherit flags for the ACE.</span>
02208 <span class="comment"></span>
02209 <span class="comment">    AccessMask - The mask of accesses to be granted to the specified SID.</span>
02210 <span class="comment"></span>
02211 <span class="comment">    ObjectTypeGuid - Supplies the GUID of the object this ACE applies to.</span>
02212 <span class="comment">        If NULL, no object type GUID is placed in the ACE.</span>
02213 <span class="comment"></span>
02214 <span class="comment">    InheritedObjectTypeGuid - Supplies the GUID of the object type that will</span>
02215 <span class="comment">        inherit this ACE.  If NULL, no inherited object type GUID is placed in</span>
02216 <span class="comment">        the ACE.</span>
02217 <span class="comment"></span>
02218 <span class="comment">    Sid - Pointer to the SID to be audited.</span>
02219 <span class="comment"></span>
02220 <span class="comment">    AuditSuccess - If TRUE, indicates successful access attempts are to be</span>
02221 <span class="comment">        audited.</span>
02222 <span class="comment"></span>
02223 <span class="comment">    AuditFailure - If TRUE, indicated failed access attempts are to be</span>
02224 <span class="comment">        audited.</span>
02225 <span class="comment"></span>
02226 <span class="comment">Return Value:</span>
02227 <span class="comment"></span>
02228 <span class="comment">    STATUS_SUCCESS - The ACE was successfully added.</span>
02229 <span class="comment"></span>
02230 <span class="comment">    STATUS_INVALID_ACL - The specified ACL is not properly formed.</span>
02231 <span class="comment"></span>
02232 <span class="comment">    STATUS_REVISION_MISMATCH - The specified revision is not known</span>
02233 <span class="comment">        or is incompatible with that of the ACL.</span>
02234 <span class="comment"></span>
02235 <span class="comment">    STATUS_ALLOTTED_SPACE_EXCEEDED - The new ACE does not fit into the</span>
02236 <span class="comment">        ACL.  A larger ACL buffer is required.</span>
02237 <span class="comment"></span>
02238 <span class="comment">    STATUS_INVALID_SID - The provided SID is not a structurally valid</span>
02239 <span class="comment">        SID.</span>
02240 <span class="comment"></span>
02241 <span class="comment">    STATUS_INVALID_PARAMETER - The AceFlags parameter was invalid.</span>
02242 <span class="comment"></span>
02243 <span class="comment">--*/</span>
02244 
02245 {
02246     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
02247 
02248     <span class="keywordflow">if</span> (AuditSuccess) {
02249         AceFlags |= SUCCESSFUL_ACCESS_ACE_FLAG;
02250     }
02251     <span class="keywordflow">if</span> (AuditFailure) {
02252         AceFlags |= FAILED_ACCESS_ACE_FLAG;
02253     }
02254 
02255     <span class="comment">//</span>
02256     <span class="comment">// If no object types are specified,</span>
02257     <span class="comment">//  build a non-object ACE.</span>
02258     <span class="comment">//</span>
02259     <span class="keywordflow">if</span> (ObjectTypeGuid == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> &amp;&amp; InheritedObjectTypeGuid == <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a> ) {
02260         <span class="keywordflow">return</span> <a class="code" href="../../d2/d4/acledit_8c.html#a14">RtlpAddKnownAce</a> (
02261                    Acl,
02262                    AceRevision,
02263                    AceFlags,
02264                    AccessMask,
02265                    Sid,
02266                    SYSTEM_AUDIT_ACE_TYPE
02267                    );
02268     }
02269 
02270     <span class="keywordflow">return</span> <a class="code" href="../../d2/d4/acledit_8c.html#a15">RtlpAddKnownObjectAce</a> (
02271                Acl,
02272                AceRevision,
02273                AceFlags,
02274                AccessMask,
02275                ObjectTypeGuid,
02276                InheritedObjectTypeGuid,
02277                Sid,
02278                SYSTEM_AUDIT_OBJECT_ACE_TYPE
02279                );
02280 }
02281 
02282 <span class="preprocessor">#if 0</span>
02283 <span class="preprocessor"></span>
02284 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
02285 RtlMakePosixAcl(
02286     IN ULONG AclRevision,
02287     IN PSID UserSid,
02288     IN PSID GroupSid,
02289     IN ACCESS_MASK UserAccess,
02290     IN ACCESS_MASK GroupAccess,
02291     IN ACCESS_MASK OtherAccess,
02292     IN ULONG AclLength,
02293     OUT PACL Acl,
02294     OUT PULONG ReturnLength
02295     )
02296 <span class="comment">/*++</span>
02297 <span class="comment"></span>
02298 <span class="comment">Routine Description:</span>
02299 <span class="comment"></span>
02300 <span class="comment">    NOTE: THIS ROUTINE IS STILL BEING SPEC'D.</span>
02301 <span class="comment"></span>
02302 <span class="comment">    Make an ACL representing Posix protection from AccessMask and</span>
02303 <span class="comment">    security account ID (SID) information.</span>
02304 <span class="comment"></span>
02305 <span class="comment">Arguments:</span>
02306 <span class="comment"></span>
02307 <span class="comment">    AclRevision - Indicates the ACL revision level of the access masks</span>
02308 <span class="comment">        provided.  The ACL generated will be revision compatible with this</span>
02309 <span class="comment">        value and will not be a higher revision than this value.</span>
02310 <span class="comment"></span>
02311 <span class="comment">    UserSid - Provides the SID of the user (owner).</span>
02312 <span class="comment"></span>
02313 <span class="comment">    GroupSid - Provides the SID of the primary group.</span>
02314 <span class="comment"></span>
02315 <span class="comment">    UserAccess - Specifies the accesses to be given to the user (owner).</span>
02316 <span class="comment"></span>
02317 <span class="comment">    GroupAccess - Specifies the accesses to be given to the primary group.</span>
02318 <span class="comment"></span>
02319 <span class="comment">    OtherAccess - Specifies the accesses to be given to others (WORLD).</span>
02320 <span class="comment"></span>
02321 <span class="comment">    AclLength - Provides the length (in bytes) of the Acl buffer.</span>
02322 <span class="comment"></span>
02323 <span class="comment">    Acl - Points to a buffer to receive the generated ACL.</span>
02324 <span class="comment"></span>
02325 <span class="comment">    ReturnLength - Returns the actual length needed to store the resultant</span>
02326 <span class="comment">        ACL.  If this length is greater than that specified in AclLength,</span>
02327 <span class="comment">        then STATUS_BUFFER_TOO_SMALL is returned and no ACL is generated.</span>
02328 <span class="comment"></span>
02329 <span class="comment">Return Values:</span>
02330 <span class="comment"></span>
02331 <span class="comment">    STATUS_SUCCESS - The service completed successfully.</span>
02332 <span class="comment"></span>
02333 <span class="comment">    STATUS_UNKNOWN_REVISION - The revision level specified is not supported</span>
02334 <span class="comment">        by this service.</span>
02335 <span class="comment"></span>
02336 <span class="comment">    STATUS_BUFFER_TOO_SMALL - Indicates the length of the output buffer</span>
02337 <span class="comment">        wasn't large enough to hold the generated ACL.  The length needed</span>
02338 <span class="comment">        is returned via the ReturnLength parameter.</span>
02339 <span class="comment"></span>
02340 <span class="comment">--*/</span>
02341 
02342 {
02343 
02344     SID_IDENTIFIER_AUTHORITY WorldSidAuthority = SECURITY_WORLD_SID_AUTHORITY;
02345 
02346     ULONG UserSidLength;
02347     ULONG GroupSidLength;
02348     ULONG WorldSidLength;
02349     ULONG RequiredAclSize;
02350     ULONG AceSize;
02351     ULONG CurrentAce;
02352     PACCESS_ALLOWED_ACE Ace;
02353     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a>;
02354 
02355     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
02356 
02357     <span class="keywordflow">if</span> (!<a class="code" href="../../d8/d6/sertl_8c.html#a35">RtlValidSid</a>( UserSid ) || !<a class="code" href="../../d8/d6/sertl_8c.html#a35">RtlValidSid</a>( GroupSid )) {
02358         <span class="keywordflow">return</span>( STATUS_INVALID_SID );
02359     }
02360 
02361     UserSidLength = <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( UserSid );
02362     GroupSidLength = <a class="code" href="../../d0/d5/se_8h.html#a10">SeLengthSid</a>( GroupSid );
02363     WorldSidLength = <a class="code" href="../../d8/d6/sertl_8c.html#a38">RtlLengthRequiredSid</a>( 1 );
02364 
02365     <span class="comment">//</span>
02366     <span class="comment">// Figure out how much room we need for an ACL and three</span>
02367     <span class="comment">// ACCESS_ALLOWED Ace's</span>
02368     <span class="comment">//</span>
02369 
02370     RequiredAclSize = <span class="keyword">sizeof</span>( ACL );
02371 
02372     AceSize = <span class="keyword">sizeof</span>( ACCESS_ALLOWED_ACE ) - <span class="keyword">sizeof</span>( ULONG );
02373 
02374     RequiredAclSize += (AceSize * 3)  +
02375                        UserSidLength  +
02376                        GroupSidLength +
02377                        WorldSidLength ;
02378 
02379     <span class="keywordflow">if</span> (RequiredAclSize &gt; AclLength) {
02380         *ReturnLength = RequiredAclSize;
02381         <span class="keywordflow">return</span>( STATUS_BUFFER_TOO_SMALL );
02382     }
02383 
02384     <span class="comment">//</span>
02385     <span class="comment">// The passed buffer is big enough, build the ACL in it.</span>
02386     <span class="comment">//</span>
02387 
02388     <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = <a class="code" href="../../d2/d4/acledit_8c.html#a6">RtlCreateAcl</a>(
02389                  Acl,
02390                  RequiredAclSize,
02391                  AclRevision
02392                  );
02393 
02394     <span class="keywordflow">if</span> (!<a class="code" href="../../d5/d6/stierr_8h.html#a0">NT_SUCCESS</a>( Status )) {
02395         <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
02396     }
02397 
02398     CurrentAce = (ULONG)Acl + <span class="keyword">sizeof</span>( ACL );
02399     Ace = (PACCESS_ALLOWED_ACE)CurrentAce;
02400 
02401     <span class="comment">//</span>
02402     <span class="comment">// Build the user (owner) ACE</span>
02403     <span class="comment">//</span>
02404 
02405     Ace-&gt;Header.AceType = ACCESS_ALLOWED_ACE_TYPE;
02406     Ace-&gt;Header.AceSize = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(UserSidLength + AceSize);
02407     Ace-&gt;Header.AceFlags = 0;
02408 
02409     Ace-&gt;Mask = UserAccess;
02410 
02411     RtlMoveMemory(
02412         (PVOID)(Ace-&gt;SidStart),
02413         UserSid,
02414         UserSidLength
02415         );
02416 
02417     CurrentAce += (ULONG)(Ace-&gt;Header.AceSize);
02418     Ace = (PACCESS_ALLOWED_ACE)CurrentAce;
02419 
02420     <span class="comment">//</span>
02421     <span class="comment">// Build the group ACE</span>
02422     <span class="comment">//</span>
02423 
02424     Ace-&gt;Header.AceType = ACCESS_ALLOWED_ACE_TYPE;
02425     Ace-&gt;Header.AceSize = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(GroupSidLength + AceSize);
02426     Ace-&gt;Header.AceFlags = 0;
02427 
02428     Ace-&gt;Mask = GroupAccess;
02429 
02430     RtlMoveMemory(
02431         (PVOID)(Ace-&gt;SidStart),
02432         GroupSid,
02433         GroupSidLength
02434         );
02435 
02436     CurrentAce += (ULONG)(Ace-&gt;Header.AceSize);
02437     Ace = (PACCESS_ALLOWED_ACE)CurrentAce;
02438 
02439     <span class="comment">//</span>
02440     <span class="comment">// Build the World ACE</span>
02441     <span class="comment">//</span>
02442 
02443     Ace-&gt;Header.AceType = ACCESS_ALLOWED_ACE_TYPE;
02444     Ace-&gt;Header.AceSize = (<a class="code" href="../../d4/d5/aug98_2dll32_2icc__i386_8h.html#a14">USHORT</a>)(GroupSidLength + AceSize);
02445     Ace-&gt;Header.AceFlags = 0;
02446 
02447     Ace-&gt;Mask = OtherAccess;
02448 
02449     <a class="code" href="../../d8/d6/sertl_8c.html#a40">RtlInitializeSid</a>(
02450         (PSID)(Ace-&gt;SidStart),
02451         &amp;WorldSidAuthority,
02452         1
02453         );
02454 
02455     *(<a class="code" href="../../d8/d6/sertl_8c.html#a43">RtlSubAuthoritySid</a>((PSID)(Ace-&gt;SidStart), 0 )) = SECURITY_WORLD_RID;
02456 
02457     <span class="keywordflow">return</span>( STATUS_SUCCESS );
02458 
02459 }
02460 
02461 <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a>
02462 RtlInterpretPosixAcl(
02463     IN ULONG AclRevision,
02464     IN PSID UserSid,
02465     IN PSID GroupSid,
02466     IN PACL Acl,
02467     OUT PACCESS_MASK UserAccess,
02468     OUT PACCESS_MASK GroupAccess,
02469     OUT PACCESS_MASK OtherAccess
02470     )
02471 <span class="comment">/*++</span>
02472 <span class="comment"></span>
02473 <span class="comment">Routine Description:</span>
02474 <span class="comment"></span>
02475 <span class="comment">    NOTE: THIS ROUTINE IS STILL BEING SPEC'D.</span>
02476 <span class="comment"></span>
02477 <span class="comment">    Interpret an ACL representing Posix protection, returning AccessMasks.</span>
02478 <span class="comment">    Use security account IDs (SIDs) for object owner and primary group</span>
02479 <span class="comment">    identification.</span>
02480 <span class="comment"></span>
02481 <span class="comment">    This algorithm will pick up the first match of a given SID and ignore</span>
02482 <span class="comment">    all further matches of that SID.  The first unrecognized SID becomes</span>
02483 <span class="comment">    the "other" SID.</span>
02484 <span class="comment"></span>
02485 <span class="comment">Arguments:</span>
02486 <span class="comment"></span>
02487 <span class="comment">    AclRevision - Indicates the ACL revision level of the access masks to</span>
02488 <span class="comment">        be returned.</span>
02489 <span class="comment"></span>
02490 <span class="comment">    UserSid - Provides the SID of the user (owner).</span>
02491 <span class="comment"></span>
02492 <span class="comment">    GroupSid - Provides the SID of the primary group.</span>
02493 <span class="comment"></span>
02494 <span class="comment">    Acl - Points to a buffer containing the ACL to interpret.</span>
02495 <span class="comment"></span>
02496 <span class="comment">    UserAccess - Receives the accesses allowed for the user (owner).</span>
02497 <span class="comment"></span>
02498 <span class="comment">    GroupAccess - Receives the accesses allowed for the primary group.</span>
02499 <span class="comment"></span>
02500 <span class="comment">    OtherAccess - Receives the accesses allowed for others (WORLD).</span>
02501 <span class="comment"></span>
02502 <span class="comment">Return Values:</span>
02503 <span class="comment"></span>
02504 <span class="comment">    STATUS_SUCCESS - The service completed successfully.</span>
02505 <span class="comment"></span>
02506 <span class="comment">    STATUS_UNKNOWN_REVISION - The revision level specified is not supported</span>
02507 <span class="comment">        by this service.</span>
02508 <span class="comment"></span>
02509 <span class="comment">    STATUS_EXTRENEOUS_INFORMATION - This warning status value indicates the</span>
02510 <span class="comment">        ACL contained protection or other information unrelated to Posix</span>
02511 <span class="comment">        style protection.  This is a warning only.  The interpretation was</span>
02512 <span class="comment">        otherwise successful and all access masks were returned.</span>
02513 <span class="comment"></span>
02514 <span class="comment">    STATUS_COULD_NOT_INTERPRET - Indicates the ACL does not contain</span>
02515 <span class="comment">        sufficient Posix style (user/group) protection information.  The</span>
02516 <span class="comment">        ACL could not be interpreted.</span>
02517 <span class="comment"></span>
02518 <span class="comment">--*/</span>
02519 {
02520     <a class="code" href="../../d0/d6/iop_8h.html#a144">NTSTATUS</a> <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_SUCCESS;
02521     BOOLEAN UserFound = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02522     BOOLEAN GroupFound = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02523     BOOLEAN OtherFound = <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02524     ULONG i;
02525     <a class="code" href="../../d4/d7/struct__KNOWN__ACE.html">PKNOWN_ACE</a> Ace;
02526 
02527     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
02528 
02529     <span class="keywordflow">if</span> (AclRevision != ACL_REVISION2) {
02530         <span class="keywordflow">return</span>( STATUS_UNKNOWN_REVISION );
02531     }
02532 
02533     <span class="keywordflow">if</span> (Acl-&gt;AceCount &gt; 3) {
02534         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_EXTRANEOUS_INFORMATION;
02535     }
02536 
02537     <span class="keywordflow">for</span> (i=0, Ace = <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a1">FirstAce</a>( Acl );
02538         (i &lt; Acl-&gt;AceCount) &amp;&amp; (!UserFound || !GroupFound || !OtherFound);
02539         i++, Ace = <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a2">NextAce</a>( Ace )) {
02540 
02541         <span class="keywordflow">if</span> (Ace-&gt;Header.AceType != ACCESS_ALLOWED_ACE_TYPE) {
02542             <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_EXTRANEOUS_INFORMATION;
02543             <span class="keywordflow">continue</span>;
02544         }
02545 
02546         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>(
02547                (PSID)(Ace-&gt;SidStart),
02548                UserSid
02549                ) &amp;&amp; !UserFound) {
02550 
02551             *UserAccess = Ace-&gt;Mask;
02552             UserFound = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02553             <span class="keywordflow">continue</span>;
02554         }
02555 
02556         <span class="keywordflow">if</span> (<a class="code" href="../../d8/d6/sertl_8c.html#a36">RtlEqualSid</a>(
02557                (PSID)(Ace-&gt;SidStart),
02558                GroupSid
02559                ) &amp;&amp; !GroupFound) {
02560 
02561             *GroupAccess = Ace-&gt;Mask;
02562             GroupFound = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02563             <span class="keywordflow">continue</span>;
02564         }
02565 
02566         <span class="comment">//</span>
02567         <span class="comment">// It isn't the user, and it isn't the group, pick it up</span>
02568         <span class="comment">// as "other"</span>
02569         <span class="comment">//</span>
02570 
02571         <span class="keywordflow">if</span> (!OtherFound) {
02572             *OtherAccess = Ace-&gt;Mask;
02573             OtherFound = <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02574             <span class="keywordflow">continue</span>;
02575         }
02576 
02577     }
02578 
02579     <span class="comment">//</span>
02580     <span class="comment">// Make sure we got everything we need, error otherwise</span>
02581     <span class="comment">//</span>
02582 
02583     <span class="keywordflow">if</span> (!UserFound || !GroupFound || !OtherFound) {
02584         <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> = STATUS_COULD_NOT_INTERPRET;
02585     }
02586 
02587     <span class="keywordflow">return</span>( <a class="code" href="../../d1/d0/cmchek_8c.html#a4">Status</a> );
02588 
02589 }
02590 
02591 <span class="preprocessor">#endif // 0</span>
02592 <span class="preprocessor"></span>
02593 
02594 <span class="comment">//</span>
02595 <span class="comment">//  Internal support routine</span>
02596 <span class="comment">//</span>
02597 
02598 BOOLEAN
<a name="l02599"></a><a class="code" href="../../d2/d4/acledit_8c.html#a25">02599</a> <a class="code" href="../../d2/d4/acledit_8c.html#a25">RtlFirstFreeAce</a> (
02600     IN PACL Acl,
02601     OUT PVOID *FirstFree
02602     )
02603 
02604 <span class="comment">/*++</span>
02605 <span class="comment"></span>
02606 <span class="comment">Routine Description:</span>
02607 <span class="comment"></span>
02608 <span class="comment">    This routine returns a pointer to the first free byte in an Acl</span>
02609 <span class="comment">    or NULL if the acl is ill-formed.  If the Acl is full then the</span>
02610 <span class="comment">    return pointer is to the byte immediately following the acl, and</span>
02611 <span class="comment">    TRUE will be returned.</span>
02612 <span class="comment"></span>
02613 <span class="comment">Arguments:</span>
02614 <span class="comment"></span>
02615 <span class="comment">    Acl - Supplies a pointer to the Acl to examine</span>
02616 <span class="comment"></span>
02617 <span class="comment">    FirstFree - Receives a pointer to the first free position in the Acl</span>
02618 <span class="comment"></span>
02619 <span class="comment">Return Value:</span>
02620 <span class="comment"></span>
02621 <span class="comment">    BOOLEAN - TRUE if the Acl is well formed and FALSE otherwise</span>
02622 <span class="comment"></span>
02623 <span class="comment">--*/</span>
02624 
02625 {
02626     PACE_HEADER Ace;
02627     ULONG i;
02628 
02629     <a class="code" href="../../d5/d9/ntrtlp_8h.html#a12">RTL_PAGED_CODE</a>();
02630 
02631     <span class="comment">//</span>
02632     <span class="comment">//  To find the first free spot in the Acl we need to search for</span>
02633     <span class="comment">//  the last ace.  We do this by zooming down the list until</span>
02634     <span class="comment">//  we've exhausted the ace count or the ace size (which ever comes</span>
02635     <span class="comment">//  first).  In the following loop Ace points to the next spot</span>
02636     <span class="comment">//  for an Ace and I is the ace index</span>
02637     <span class="comment">//</span>
02638 
02639     *FirstFree = <a class="code" href="../../d4/d6/lh__open_2pi__basic_8h.html#a3">NULL</a>;
02640 
02641     <span class="keywordflow">for</span> ( i=0, Ace = <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a1">FirstAce</a>( Acl );
02642           i &lt; Acl-&gt;AceCount;
02643           i++, Ace = <a class="code" href="../../d4/d1/rtdmpsec_8c.html#a2">NextAce</a>( Ace )) {
02644 
02645         <span class="comment">//</span>
02646         <span class="comment">//  Check to make sure we haven't overrun the Acl buffer</span>
02647         <span class="comment">//  with our Ace pointer.  If we have then our input is bogus.</span>
02648         <span class="comment">//</span>
02649 
02650         <span class="keywordflow">if</span> (Ace &gt;= (PACE_HEADER)((PUCHAR)Acl + Acl-&gt;AclSize)) {
02651 
02652             <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a457">FALSE</a>;
02653 
02654         }
02655 
02656     }
02657 
02658     <span class="comment">//</span>
02659     <span class="comment">//  Now Ace points to the first free spot in the Acl so set the</span>
02660     <span class="comment">//  output variable and check to make sure it is still in the Acl</span>
02661     <span class="comment">//  or just one beyond the end of the acl (i.e., the acl is full).</span>
02662     <span class="comment">//</span>
02663 
02664     <span class="keywordflow">if</span> (Ace &lt;= (PACE_HEADER)((PUCHAR)Acl + Acl-&gt;AclSize)) {
02665 
02666         *FirstFree = Ace;
02667     }
02668 
02669     <span class="comment">//</span>
02670     <span class="comment">//  The Acl is well formed so return the first free spot we've found</span>
02671     <span class="comment">//  (or NULL if there is no free space for another ACE)</span>
02672     <span class="comment">//</span>
02673 
02674     <span class="keywordflow">return</span> <a class="code" href="../../d6/d7/halmips_8h.html#a458">TRUE</a>;
02675 
02676 }
02677 
02678 
02679 <span class="comment">//</span>
02680 <span class="comment">//  Internal support routine</span>
02681 <span class="comment">//</span>
02682 
02683 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02684"></a><a class="code" href="../../d2/d4/acledit_8c.html#a4">02684</a> <a class="code" href="../../d2/d4/acledit_8c.html#a4">RtlpAddData</a> (
02685     IN PVOID From,
02686     IN ULONG FromSize,
02687     IN PVOID To,
02688     IN ULONG ToSize
02689     )
02690 
02691 <span class="comment">/*++</span>
02692 <span class="comment"></span>
02693 <span class="comment">Routine Description:</span>
02694 <span class="comment"></span>
02695 <span class="comment">    This routine copies data to a string of bytes.  It does this by moving</span>
02696 <span class="comment">    over data in the to string so that the from string will fit.  It also</span>
02697 <span class="comment">    assumes that the checks that the data will fit in memory have already</span>
02698 <span class="comment">    been done.  Pictorally the results are as follows.</span>
02699 <span class="comment"></span>
02700 <span class="comment">    Before:</span>
02701 <span class="comment"></span>
02702 <span class="comment">        From -&gt; ffffffffff</span>
02703 <span class="comment"></span>
02704 <span class="comment">        To   -&gt; tttttttttttttttt</span>
02705 <span class="comment"></span>
02706 <span class="comment">    After:</span>
02707 <span class="comment"></span>
02708 <span class="comment">        From -&gt; ffffffffff</span>
02709 <span class="comment"></span>
02710 <span class="comment">        To   -&gt; fffffffffftttttttttttttttt</span>
02711 <span class="comment"></span>
02712 <span class="comment">Arguments:</span>
02713 <span class="comment"></span>
02714 <span class="comment">    From - Supplies a pointer to the source buffer</span>
02715 <span class="comment"></span>
02716 <span class="comment">    FromSize - Supplies the size of the from buffer in bytes</span>
02717 <span class="comment"></span>
02718 <span class="comment">    To - Supplies a pointer to the destination buffer</span>
02719 <span class="comment"></span>
02720 <span class="comment">    ToSize - Supplies the size of the to buffer in bytes</span>
02721 <span class="comment"></span>
02722 <span class="comment">Return Value:</span>
02723 <span class="comment"></span>
02724 <span class="comment">    None</span>
02725 <span class="comment"></span>
02726 <span class="comment">--*/</span>
02727 
02728 {
02729     LONG i;
02730 
02731     <span class="comment">//</span>
02732     <span class="comment">//  Shift over the To buffer enough to fit in the From buffer</span>
02733     <span class="comment">//</span>
02734 
02735     <span class="keywordflow">for</span> (i = ToSize - 1; i &gt;= 0; i--) {
02736 
02737         ((PUCHAR)To)[i+FromSize] = ((PUCHAR)To)[i];
02738     }
02739 
02740     <span class="comment">//</span>
02741     <span class="comment">//  Now copy over the From buffer</span>
02742     <span class="comment">//</span>
02743 
02744     <span class="keywordflow">for</span> (i = 0; (ULONG)i &lt; FromSize; i += 1) {
02745 
02746         ((PUCHAR)To)[i] = ((PUCHAR)From)[i];
02747 
02748     }
02749 
02750     <span class="comment">//</span>
02751     <span class="comment">//  and return to our caller</span>
02752     <span class="comment">//</span>
02753 
02754     <span class="keywordflow">return</span>;
02755 
02756 }
02757 
02758 
02759 <span class="comment">//</span>
02760 <span class="comment">//  Internal support routine</span>
02761 <span class="comment">//</span>
02762 
02763 <a class="code" href="../../d2/d7/hal_8h.html#a212">VOID</a>
<a name="l02764"></a><a class="code" href="../../d2/d4/acledit_8c.html#a5">02764</a> <a class="code" href="../../d2/d4/acledit_8c.html#a5">RtlpDeleteData</a> (
02765     IN PVOID Data,
02766     IN ULONG RemoveSize,
02767     IN ULONG TotalSize
02768     )
02769 
02770 <span class="comment">/*++</span>
02771 <span class="comment"></span>
02772 <span class="comment">Routine Description:</span>
02773 <span class="comment"></span>
02774 <span class="comment">    This routine deletes a string of bytes from the front of a data buffer</span>
02775 <span class="comment">    and compresses the data.  It also zeros out the part of the string</span>
02776 <span class="comment">    that is no longer in use.  Pictorially the results are as follows</span>
02777 <span class="comment"></span>
02778 <span class="comment">    Before:</span>
02779 <span class="comment"></span>
02780 <span class="comment">        Data       = DDDDDddddd</span>
02781 <span class="comment">        RemoveSize = 5</span>
02782 <span class="comment">        TotalSize  = 10</span>
02783 <span class="comment"></span>
02784 <span class="comment">    After:</span>
02785 <span class="comment"></span>
02786 <span class="comment">        Data      = ddddd00000</span>
02787 <span class="comment"></span>
02788 <span class="comment">Arguments:</span>
02789 <span class="comment"></span>
02790 <span class="comment">    Data - Supplies a pointer to the data being altered</span>
02791 <span class="comment"></span>
02792 <span class="comment">    RemoveSize - Supplies the number of bytes to delete from the front</span>
02793 <span class="comment">        of the data buffer</span>
02794 <span class="comment"></span>
02795 <span class="comment">    TotalSize - Supplies the total number of bytes in the data buffer</span>
02796 <span class="comment">        before the delete operation</span>
02797 <span class="comment"></span>
02798 <span class="comment">Return Value:</span>
02799 <span class="comment"></span>
02800 <span class="comment">    None</span>
02801 <span class="comment"></span>
02802 <span class="comment">--*/</span>
02803 
02804 {
02805     ULONG i;
02806 
02807     <span class="comment">//</span>
02808     <span class="comment">//  Shift over the buffer to remove the amount</span>
02809     <span class="comment">//</span>
02810 
02811     <span class="keywordflow">for</span> (i = RemoveSize; i &lt; TotalSize; i++) {
02812 
02813         ((PUCHAR)Data)[i-RemoveSize] = ((PUCHAR)Data)[i];
02814 
02815     }
02816 
02817     <span class="comment">//</span>
02818     <span class="comment">//  Now as a safety precaution we'll zero out the rest of the string</span>
02819     <span class="comment">//</span>
02820 
02821     <span class="keywordflow">for</span> (i = TotalSize - RemoveSize; i &lt; TotalSize; i++) {
02822 
02823         ((PUCHAR)Data)[i] = 0;
02824     }
02825 
02826     <span class="comment">//</span>
02827     <span class="comment">//  And return to our caller</span>
02828     <span class="comment">//</span>
02829 
02830     <span class="keywordflow">return</span>;
02831 
02832 }
</div></pre><hr size="1"><address style="align: right;"><small>Generated on Sat May 15 19:39:13 2004 for test by
<a href="http://www.doxygen.org/index.html">
<img src="../../doxygen.png" alt="doxygen" align="middle" border=0 ></a> 1.3.7 </small></address>
</body>
</html>
